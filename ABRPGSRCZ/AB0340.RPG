     F*****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas AB Internal funding deals input')                *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Dealing Module                                       *
     F*                                                               *
     F*  AB0340 - INTERNAL FUNDING DEALS INPUT                        *
     F*                                                               *
     F*  Function: This program allows the Insertion, Amendment,      *
     F*   (I/C)    Deletion, and Enquiry of Internal Funding          *
     F*            Deals.                                             *
     F*                                                               *
     F*  Called By: ABC0340 - Internal Funding Maintenance            *
     F*                                                               *
     F*  Calls: MM0078 - Update Front Office files                    *
     F*         MM0082 - Update Midas Files                           *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. CDL099             Date 06Oct17               *
      *  Prev Amend No. CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 CRE073             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 04Jul06               *
      *                 CSD027             Date 09Dec05               *
      *                 237063             Date 20Nov05               *
      *                 CDL038             Date 10May05               *
      *                 BUG7411            Date 01Jun05               *
      *                 CDL028             Date 07Feb05               *
      *                 CSW037A            Date 02May05               *
      *                 229544             Date 15Sep04               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 227875             Date 18Jun04               *
      *                 CLE025             Date 20Oct03               *
      *                 CDL022             Date 03Feb04               *
      *                 CDL020             Date 03Feb04               *
      *                 CDL019             Date 03Feb04               *
      *                 CDL018             Date 03Feb04               *
      *                 CDL017             Date 03Feb04               *
      *                 CDL016             Date 03Feb04               *
      *                 CGL029             Date 01Sep03               *
      *                 222727             Date 05Nov03               *
      *                 CAAA02             Date 16Jul03               *
      *                 CAS005             Date 16Dec02               *
      *                 CDL010             Date 02Aug02               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 208955             Date 20Sep02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 189757             Date 25Sep01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 169143             Date 28Apr01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 23May01               *
      * Midas DBA 3.03 -----------------------------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 149499             Date 02Dec98               *
     F*                 120827             Date 06Jul97               *
     F*                 110978             Date 20FEB97               *
     F*                 S01408             DATE 22OCT96               *
     F*                 CAC001             Date 01FEB96               *
     F*                 099483             DATE 12FEB96               *
     F*                 095040             DATE 29OCT95               *
     F*                 093795             DATE  4OCT95               *
     F*                 066308             DATE 21MAR94               *
     F*                 S01453             DATE 13DEC93               *
     F*                 S01444             DATE 24SEP93               *
     F*                 047114             DATE 16NOV92               *
     F*                 S01393             DATE 23SEP92               *
     F*                 S01354             DATE 07JAN92               *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance Receive Settlement Instructions             *
      *           (Recompiled)                                        *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus (Recompile)                              *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  237063 - EU Tax fixes upgrade to MP build 103 (Recompile).   *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  BUG7411- CDL028 fields missing from DLGHISPD (Recompile)     *
      *  CDL028 - Automatic Rate Interpolations (Recompile)           *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  229544 - Recompiled due to inserted fields in DLCHISPD.      *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
     F*  227875 - Include interest frequency 'N'                      *
      *  CLE025 - Credit Lines                                        *
      *  CDL022 - Deal Amendment Changes (Recompile)                  *
      *  CDL020 - Apply Base Rate at Value Date (Recompile)           *
      *  CDL019 - Allow Base Rate Changes on Fixed Deposits/Loans     *
      *           (Recompile)                                         *
      *  CDL018 - Multiple Settlement Accounts on Loans/Deposits      *
      *           (Recompile)                                         *
      *  CDL017 - Penalty Fee & Early Maturity of Fixed Term Loan/Dep *
      *           (Recompile)                                         *
      *  CDL016 - Automatic rollover of Fixed Term Loans/Deposits     *
      *           (Recompile)                                         *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  CAAA02 - Remove use of INVITE keyword to enable WebFacing    *
      *           to process screens. Recompile only.                 *
      *  CAS005 - Enhancements to CAS001, CAS002 and CAS004           *
      *           (Recompile)                                         *
      *  CDL010 - Prevent last user that actioned the trade from      *
      *           authorising it.Recompile due to changes in FXDEALPP.*
      *           ,MMDEAMPP,MMDELDPP, MMDENBPP AND MMDENSPP.          *
      *  208955 - Initialise value of timestamp field of PF/MMDELDPP. *
      *  189757 - Unable to change Maturity date due to deal date     *
      *           is less than the backvalue period.                  *
      *  169143 - Base Ccy Rate did not accept more than 4 digits.    *
     F*  CSD006 - Use long DS with SDBSRTPD.                          *
     F*  149499 - CEU015 extended MMDEAULL but did not recompile      *
     F*           this program. As a result this program falls over   *
     F*           when run - Recompile.                               *
     F*  120827 - Profit Centre Accounting defaulting                 *
     F*  110978 - Deal Date is not control with back value period.    *
     F*  CAC001 - Profit Centre Accounting Development:               *
     F*           Recompiled due to file changes.                     *
     F*  S01408 - Core hook AB0340CCP1 added
     F*  099483 - Pgm dumps trying to output succesful completion     *
     F*           message because PUTOVR and OVERLAY keywords not     *
     F*           specified correctly - recompile over amended DSPF.  *
     F*  095040 - Add the AutoRollover parmeter for call to MM0083    *
     F*           and correct the parmeters sequence for call to      *
     F*           MM0078 and MM0083.                                  *
     F*  093795 - Incorporation of 082738 - Rewrite of projected A/C  *
     F*           movements.                                          *
     F*  066308 - Output message to confirm sucessful input of deal   *
     F*  S01453 - Margin and FX Positions/Points and Base currency    *
     F*           Positions/Points added to FX input (Recompiled)     *
     F*  S01444 - Recompiled. (LF/DEALSALL - amended to include       *
     F*           historic deals files)                               *
     F*  047114 - Call to MM0082 failed due to non exsitence of       *
     F*           new RACD parameter.                                 *
     F*  S01393 - Upgrade Strategic Risk Management to R10.           *
     F*           Amendment for linked enquiry from Risk Management.  *
     F*           When the program is called as a linked enquiry the  *
     F*           deal number is passed in as a parameter, input      *
     F*           screen is suppressed and a return parameter is      *
     F*           passed back to the calling program.                 *
     F*                                                               *
      *****************************************************************
      /EJECT
     N*****************************************************************
     N*  NOTES
     N*  ~~~~~
     N*  Screen formats used :
     N*
     N*  #SFL1  - Subfile Deal Selection
     N*  #SFC1  - Subfile Control for #SFL1
     N*  #NDAT  - 'No Data' constant for #SFL1
     N*  #CMD1  - Command Keys for Deal Selection
     N*  #DETL  - Main screen for Insert/Delete/Enquire
     N*  #CMD2  - Command Keys for normal status of #DETL
     N*  #CMD3  - Command Keys for Confirm Delete on #DETL
     N*  #CMD4  - Command Keys for Confirm Insert on #DETL
     N*  #SFLM  - Subfile for messages on line 24
     N*  #SFCM  - Subfile Control for #DETL
     N*
     N********************************************************************
      /EJECT
     N********************************************************************
     N*  Indicators used in Screen formats :
     N*
     N*   18    - Booking Branches Used
     N*   19    - Originating Branch Used
     N*   20    - Profit Centres Used
     N*   60    - Mode = AMEND           (Input only protected)
     N*   61    - Mode = INSERT/AMEND    (Insert fields input-cap      able)
     N*  N61    - Mode = ENQUIRY/DELETE  (No fields input-capable      )
     N*   62    - Confirm of Insert required
     N*   63    - Currently displayed Deal is a Deleted Deal
     N*   64    - Confirm of Delete required
     N*   65    - Confirm of Amend required
     N*   66    - Position Cursor to Deal Number
     N*   68    - Mode = LINKED ENQUIRY  (No fields input-capable)        S01393
     N*
     N*   71    - #SFC1 Subfile Clear
     N*  N71    - #SFC1 Display Subfile + Display Control
     N*   72    - Display #NDAT format instead of Subfile #SFL1
     N*  N72    - Display Subfile #SFL1
     N*   73    - End of Message Subfile
     N*   74    - #DETL Written
     N*
     N*  Error Indicators conditioning fields in Screen formats :
     N*
     N*   23    - ##DADN Deal Number 2
     N*   24    - ##ACCD Action code
     N*   25    - ##ORBR Originating Branch  1
     N*   26    - ##BRC1 Branch 1
     N*   27    - ##BRC2 Branch 2
     N*   28    - ##PRF1 Profit Centre 1
     N*   29    - ##PRF2 Profit centre 2
     N*   30    - ##DLNO Deal Number 1
     N*   31    - ##NTCE Notice Days
     N*   32    - ##STP1 Deal Sub-type 1
     N*   33    - ##BOK1 Book Code 1
     N*   34    - ##LNKR Linked Deal Ref.
     N*   35    - ##STP2 Deal Sub-type 2
     N*   36    - ##BOK2 Book Code 2
     N*   37    - ##DDAT Deal Date
     N*   38    - ##VDAT Value Date
     N*   39    - ##MDAT Maturity Date
     N*   40    - ##CCY  Currency
     N*   41    - ##AMNP Amount
     N*   42    - ##BCXR Base Ccy Rate
     N*   43    - ##BRTT Base Rate
     N*   44    - ##RTSP Spread/Rate
     N*   45    - ##ICBS Calc Method
     N*   46    - ##IPFR Frequency
     N*   47    - ##NIDT Next Interest Date
     N*   48    - ##TOTI Total Interest
     N*   49    - ##INTF Int Freq Day in Month
     N*   50    - ##CPTI Capitalise Interest
     N*
     N*  Indicators returned from Screen formats    Fn.Keys
     N*  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    ~~~~~~~
     N*   03            - #SFC1/#DETL: Exit             F3
     N*   02            - #DETL: Previous screen        F12
     N*   08 (N64N62N65)- #DETL: Next record            F7
     N*   09 (N64N62N65)- #DETL: Previous record        F8
     N*   15 (N64N62N65)- #DETL: Select from Subfile    F15
     N*   05 (64)       - #DETL: Confirm Delete         F10
     N*
     N********************************************************************
      /EJECT
     N********************************************************************
     N*
     N*  Warning indicators conditioning messages:
     N*
     N*   52    - Exchange rate Differs by more than 20%
     N*   53    - Maturity Date is a Holiday
     N*   54    - Value Date is a Holiday
     N*   55    - Maturity date earlier than Notice Period
     N*   56    - Value Date is before Base Interest Rate Change Date
     N*   57    - Value Date is before Next Interest Date
     N*   58    - Spare
     N*
     N*  Other indicators used in program :
     N*
     N*   51    - '?' Entered, Redisplay Selection
     N*   80-99 - Work indicators
     N*   U7    - Database error switch
     N*   U8    - Database error switch
     N*   LR    - Free program on return to Caller
     N*            (NB: This indicator is not set on if an error was
     N*            notified from a called program. This is to ensure
     N*            that the setting of the LDA and U7/U8 switches in
     N*            the called program is communicated correctly back
     N*            to the controlling CL program. "Reclaim Resource"
     N*            must be used in the control program to close open
     N*            files and free this and other programs, making it
     N*            certain that the Job's PAG is clean).
     N*
     N*  Note that some indicators detailed above may be used for more
     N*  than one purpose.  Where this is the case, the current values
     N*  of the indicators will be saved, and restored after execution
     N*  of the routine which uses them for their secondary purpose.
     N*
     N*  This note does not apply to work indicators, which are always
     N*  assumed to be available for use.
     N*
      *                Unused indicators
      *                -----------------
      *       01  ..  ..  04  ..  06  07  ..  ..  10
      *       11  12  13  14  ..  16  17  ..  ..  ..
      *       21  22  ..  ..  ..  ..  ..  ..  ..  ..
      *       ..  ..  ..  ..  ..  ..  ..  ..  ..  ..
      *       ..  ..  ..  ..  ..  ..  ..  ..  ..  ..
      *       ..  ..  ..  ..  ..  ..  ..  ..  59  ..
      *       ..  ..  ..  ..  ..  ..  67  ..  69  70                      S01393
      *       ..  ..  ..  ..  75  76  77  78  79  ..
      *       ..  ..  ..  84  85  86  87  88  89  ..
      *       ..  ..  93  ..  ..  ..  ..  ..  ..
     N********************************************************************
      /EJECT
     N********************************************************************
     N* 3. Calculation Routines and Subroutines :
     N*
     N*  *MAIN -  Detail calculations
     N*
     N*  Main loop of program is in Mainline, where #DETL is
     N*  displayed. CASE handles all options from screen and
     N*  passes control to the relevant subroutines.
     N*
     N*  Level A subroutines (called from *MAINLINE) :
     N*  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     N*  AASLCT -  Select from Subfile.  A subfile of all the
     N*            Internal Funding deals is prepared.  User
     N*            will either select a deal,  or return with
     N*            F3.  If a deal is selected it is copied to
     N*            the #DETL display.
     N*
     N*  ABVFYI -  Verify Insert. If Action code is 'I',  the
     N*            fields from #DETL will be checked. If they
     N*            are OK, the User will be asked  to confirm
     N*            the operation with ENTER, or abort it with
     N*            F12 (messages are sent).
     N*
     N*  ACVFYD -  Verify Amend/Delete. If Action code is 'A'
     N*            or 'D' the deal number is checked.  If the
     N*            deal exists,   and changes are  valid  for
     N*            Amendment the  User is  asked  to  confirm
     N*            Deleletions  with F10,  or abort using the
     N*            ENTER or F3 keys,    and  Amendments  with
     N*            ENTER or abort it with F12.
     N*
     N*  ADVFYE -  Verify Enquiry. If Action code is 'E', the
     N*            Deal numbers entered will be checked. If a
     N*            deal exists, its details will be copied to
     N*            the #DETL screen.
     N*            LINKED ENQUIRY - Action code is set to 'E',            S01393
     N*            Deal number is passed in as a parameter and            S01393
     N*            its details are displayed                              S01393
     N*
     N*  AENEXT -  Get next record. Called if F7 key used.
     N*
     N*  AFPREV -  Get previous record. Called if F8 used.
     N*
     N*  AGPREV -  Previous screen requested by F12 - Exit if
     N*            already on the default display or reset to
     N*            default values.
     N*
     N*  AHCNFI -  Action confirmed;  order data and Update
     N*            the MIDAS Deals files.
     N*
     N*  AICNFD -  Delete confirmed by F10  -  Deal Nos. will
     N*            be checked to ensure they haven't changed.
     N*            If no change, the deals will be flagged for
     N*            deletion.
     N*
     N*  AJCNFA -  Amend  confirmed by Enter -  Deal No. will
     N*            be checked to ensure they haven't changed.
     N*            If no change, the deals will be amended.
     N*
     N********************************************************************
      /EJECT
     N********************************************************************
     N*
     N*  Level B subroutines (called from Level A) :
     N*  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     N*  BAALCD - Allocate Deal numbers
     N*
     N*  BBCVDL - Convert I/F Deal to Standard Deal format
     N*
     N*  BCRSET - Reset fields and indicators to default values
     N*
     N*  BDFTOS - Move data from files to screen
     N*
     N*  BHCINT - Calculate Interest
     N*
     N*  BICINT - Calculate Interest days
     N*
     N*  BJEDIT - Edit numeric to alpha
     N*
     N*  ZA0840 - Convert alpha to numeric
     N*
     N********************************************************************
      /EJECT
     N********************************************************************
     N*
     N*  Control subroutines :
     N*  ~~~~~~~~~~~~~~~~~~~~~
     N*  ZZINIT -  Initialise program
     N*
     N*  *PSSR  -  Receives control if an  error occurs which
     N*            cannot be handled by program logic. A dump
     N*            is forced, and the program terminates.
     N*            If program has been called as a linked                 S01393
     N*            enquiry an exit parameter of 'E' is passed             S01393
     N*            back to the calling program.                           S01393
     N*
     N*  INFSR  -  Receives control if an  error occurs While
     N*            Writing/Updating the MMDELULL file. A dump
     N*            is forced, and the program terminates.
     N*            If program has been called as a linked                 S01393
     N*            enquiry an exit parameter of 'E' is passed             S01393
     N*            back to the calling program.                           S01393
     N*
     N********************************************************************
     N*
      /EJECT
     H*HSTART
      ************************************************************
     H        1
      ************************************************************
      /SPACE 3
     F*FSTART
      ************************************************************
     FAB0340DFCF  E                    WORKSTN      KINFSR *PSSR
     F                                        ##SFRCKSFILE #SFL1
      * I/O - Display file
      *...........................................................
     FINDEALS IF  E           K        DISK         KINFSR *PSSR      UC
      ** IN  - Internal funding Deals Logical
      *...........................................................
     FCADLFALLUF  E                    DISK         KINFSR *PSSR      UC
     F                                              KCOMIT
      ** IN  - CA Deal No. allocation
      *...........................................................
     FMMDEAULLUF  E           K        DISK         KINFSR INFSR A    UC
     F                                              KINFDS INFDU
     F            MMDELDP0                          KRENAMEMMDLDUP0
     F            MMDENSP0                          KIGNORE
     F            MMDENBP0                          KIGNORE
     F                                              KCOMIT
      ** ADD - MM Deal No.
      *...........................................................
     FFDDLNMLLIF  E                    DISK         KINFSR *PSSR      UC
      ** IN  - FD Deal Number Ranges
      *...........................................................
     FCAMIDNLLIF  E           K        DISK         KINFSR *PSSR
      ** IN  - CA All Deals except RECI 'N'
      *...........................................................
     FDEALSH  IF  E           K        DISK         KINFSR *PSSR
      ** IN  - Matured Deals
     F            DEALSDBF                          KRENAME#DAB           BH1059
      *...........................................................
     FMMLVDMLLIF  E           K        DISK         KINFSR *PSSR
      ** IN  - Deal Amendments
      *...........................................................
     FFDMNTHLLIF  E                    DISK         KINFSR *PSSR      UC
      ** IN  - Month Short Names
      *...........................................................
      ************************************************************
      /EJECT
     E*ESTART
      ***************************************************
     E                    CPY@    1   1 80               Copyright
     E                    @SF     1  10 10 0             Scaling Factors
     E                    @YD     4   4  5 0A            Cum.Days in year
     E                    @MD    13  13  5 0A            Cum.Days in mth.
     E                    @CY        50  3               Currencies
     E                    @Z         16  1  A            BJEDIT Amt.char.
     E                    @Q         15  1 0             BJEDIT Amt.num.
     E                    @D         15  1               ZA0770 Amt
     E                    @E         21  1               ZA0770 Disp Amt
     E                    @C         21  1               ZA0770 Work array
     E                    @F         16  1               ZA0840 Integer wk.
     E                    @G         16  1               ZA0840 Output data
     E                    @H      1  15 15 0             ZA0840 Powers of Ten
     E                    @MN        12  3               Month short names
      *
      /COPY ZSRSRC,ZHOLE
      ***************************************************
      /EJECT
     I*ISTART
      ********************************************************************
     IFDMNTHP0
     I*
     I** Rename the Month name fields from file FDMNTHLL
     I              MNNM1                           @MN,1
     I              MNNM2                           @MN,2
     I              MNNM3                           @MN,3
     I              MNNM4                           @MN,4
     I              MNNM5                           @MN,5
     I              MNNM6                           @MN,6
     I              MNNM7                           @MN,7
     I              MNNM8                           @MN,8
     I              MNNM9                           @MN,9
     I              MNNM10                          @MN,10
     I              MNNM11                          @MN,11
     I              MNNM12                          @MN,12
0328 I*
     IPGMDS      SDS
      ** Program Status data structure
     I                                        1  10 PGNAME
     I                                       37  390PGPARM                S01393
     I                                       81  90 PGLIBR
     I                                      244 253 PGJBNM
     I                                      254 263 PGUSER
     I                                      264 2690PGJBNO
     I/COPY WNCPYSRC,AB0340I002
      *
     ILDA       E DSLDA
      ** LDA Database Error Reporting data structure
      *
     IZ#BSTS    E DSZ#BST                                                 093795
     IZ#ASTS    E DSZ#AST                                                 093795
     IZ#WSTS    E DSZ#WST                                                 093795
      *
     I@STDL     E DSINDEALS
      ** Deals Format data structure
      *
     I                                        1 150 W@INS1
     I                                      151 290 W@INS2
     I                                      306 324 W@INS3
     I*
     I@SLDS     E DSMMSTDLPP
     I**  Data structure of the Loans/Deposits format.
     I*
     I                                        1 150 W@SLD1
     I                                      151 290 W@SLD2
     I*
     I@SBDS     E DSMMSTDBPP
     I**  Data structure of the standard deal, NA's bought format.
     I              QQDORI                          QQDOR1                                    CGL029
     I              QQMORI                          QQMOR1                                    CGL029
     I              QQDOPI                          QQDOP1                                    CGL029
     I              QQMOPI                          QQMOP1                                    CGL029
     I              QQBORI                          QQBOR1                                    CGL029
     I              QQBOPI                          QQBOP1                                    CGL029
     I              QQRONS                          QQRON1                                    CGL029
     I              QQPONS                          QQPON1                                    CGL029
     I*
     I@SSDS     E DSMMSTDSPP
     I**  Data structure of the standard deal, NA's sold format.
     I              QQDORI                          QQDOR2                                    CGL029
     I              QQMORI                          QQMOR2                                    CGL029
     I              QQBORI                          QQBOR2                                    CGL029
     I              QQBOPI                          QQBOP2                                    CGL029
     I              QQRORI                          QQROR2                                    CGL029
     I              QQROPI                          QQROP2                                    CGL029
     I              QQRONS                          QQRON2                                    CGL029
     I              QQPONS                          QQPON2                                    CGL029
     I*
     I@SADS     E DSMMSTDAPP
     I**  Data structure of the standard deal, Deams format.
     I              QQDORI                          QQDOR3                                    CGL029
     I              QQMORI                          QQMOR3                                    CGL029
     I              QQDOPI                          QQDOP3                                    CGL029
     I              QQMOPI                          QQMOP3                                    CGL029
     I              QQBORI                          QQBOR3                                    CGL029
     I              QQBOPI                          QQBOP3                                    CGL029
     I              QQRORI                          QQROR3                                    CGL029
     I              QQROPI                          QQROP3                                    CGL029
     I              QQRONS                          QQRON3                                    CGL029
     I              QQPONS                          QQPON3                                    CGL029
     I*
     I*
     I@DLDS     E DSMMDELDPP
     I**  Data structure of the MM deal format
     I              QQDORI                          QQDOR4                                    CGL029
     I              QQMORI                          QQMOR4                                    CGL029
     I              QQDOPI                          QQDOP4                                    CGL029
     I              QQMOPI                          QQMOP4                                    CGL029
     I              QQRONS                          QQRON4                                    CGL029
     I              QQPONS                          QQPON4                                    CGL029
     I              QQINSA                          QQINS4                                    CGL029
     I*
     ISDBANK    E DSSDBANKPD
      ** BANK DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDTRAD    E DSSDTRADPD
      ** TRADING DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDBOOK    E DSSDBOOKPD
      ** BOOK CODE DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDBRCH    E DSSDBRCHPD
      ** BRANCH DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDCURR    E DSSDCURRPD
      ** CURRENCY DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDBSRT    E DSSDBSRTPD
      ** BASE RATE DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDCUST    E DSSDCUSTPD
      ** CUSTOMER DETAILS ACCESSED VIA ACCESS PROGRAM
     I              QQDFAC                          DFACQQ                                    CGL029
      *
     ISDDLST    E DSSDDLSTPD
      ** DEAL SUB-TYPE DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDGELR    E DSSDGELRPD
      ** GEN. LEDGER DETAILS ACCESSED VIA ACCESS PROGRAM
     I              QQACCD                          ACCDQQ                                    CGL029
      *
     ISDPRFC    E DSSDPRFCPD
      ** PROFIT CENTRE DETAILS ACCESSED VIA ACCESS PROGRAM
      *
     ISDLOCN    E DSSDLOCNPD
      ** LOCATION DETAILS ACCESSED VIA ACCESS PROGRAM
     I/COPY WNCPYSRC,AB0340I003
      *
     IDSFDY     E DSDSFDY
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE
     I*
     IDSSDY     E DSDSSDY
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE
      *
     IDSLDY     E DSDSLDY                                                 CSD025
     I* THIRD DS FOR ACCESS PROGRAMS, VERY LONG DATA STRUCTURE            CSD025
      *                                                                   CSD025
     ISCSARD    E DSSCSARDPD                                              CSD025
     I** MIDAS Switchable Features Accessed Via Access Program            CSD025
     I*                                                                   CSD025
     ICPYR@#      DS
      * Copyright data structure
     I                                        1  80 CPY@
     I*
     IINFDU       DS
     I**  Data structure for file status of MM deals update file.
     I                                     *STATUS  STATUS
     I*
     I@@AMDS      DS                             15
     I**  Data structure to convert @@IAMT decimal field to alpha.
     I                                        1  150@@IAMT
     I*
     I@#CCY       DS                         51
      * Internal Ccy Data Data structure
     I                                        1  138W@SPRT
     I                                       14  140W@DECP
     I                                       15  15 W@MDIN
     I                                       16  160W@SCEX
     I                                       17  17 W@ICBS
      *
     I@#DLA       DS
      * Internal Deal display format data structure
      *
     I                                        1   6 ##DLNO
     I                                        7   9 ##BRC1
     I                                       10  11 ##STP1
     I                                       12  13 ##BOK1
     I                                       14  17 ##PRF1
     I                                       18  23 ##DADN
     I                                       24  26 ##BRC2
     I                                       27  28 ##STP2
     I                                       29  30 ##BOK2
     I                                       31  34 ##PRF2
     I                                       35  40 ##LNKR
     I                                       41  46 ##DDAT
     I                                       41  420#D101
     I                                       43  440#D102
     I                                       45  460#D103
     I                                       47  52 ##VDAT
     I                                       47  480#V101
     I                                       49  500#V102
     I                                       51  520#V103
     I                                       53  58 ##MDAT
     I                                       53  540#M101
     I                                       55  560#M102
     I                                       57  580#M103
     I                                       59  61 ##NTCE
     I                                       62  64 ##CCY
     I                                       65  80 ##AMNP
     I                                       81  96 ##BCXR
     I                                       97  98 ##BRTT
     I                                       99 110 ##RTSP
     I                                      111 111 ##ICBS
     I                                      112 112 ##IPFR
     I                                      113 118 ##NIDT
     I                                      113 1140#N101
     I                                      115 1160#N102
     I                                      117 1180#N103
     I                                      119 134 ##TOTI
     I                                      135 136 ##INTF
     I                                      138 138 ##CPTI
     I                                      139 141 ##ORBR
     I                                      142 171 ##PCD1
     I                                      172 201 ##PCD2
     I                                      202 208 ##STAT
     I*
     I@#DLB       DS                            208
      * Display format data structure for last read/validated record
     I                                        1   6 @DLNO
     I                                        7   9 @BRC1
     I                                       10  11 @STP1
     I                                       12  13 @BOK1
     I                                       14  17 @PRF1
     I                                       18  23 @DADN
     I                                       24  26 @BRC2
     I                                       27  28 @STP2
     I                                       29  30 @BOK2
     I                                       31  34 @PRF2
     I                                       35  40 @LNKR
     I                                       41  46 @DDAT
     I                                       47  52 @VDAT
     I                                       53  58 @MDAT
     I                                       59  61 @NTCE
     I                                       62  64 @CCY
     I                                       65  80 @AMNP
     I                                       81  96 @BCXR
     I                                       97  98 @BRTT
     I                                       99 110 @RTSP
     I                                      111 111 @ICBS
     I                                      112 112 @IPFR
     I                                      113 118 @NIDT
     I                                      119 134 @TOTI
     I                                      135 136 @INTF
     I                                      138 138 @CPTI
     I                                      139 141 @ORBR
     I                                      142 171 @PCD1
     I                                      172 201 @PCD2
     I                                      202 208 @STAT
     I*
     I@#DLC       DS                            208
      * Internal Deal Copy display format data structure
     I                                        1   6 DUMMY
      *
     I            DS
      * Data structure over MIDAS RUN DATE
     I                                        1   7 MRUNDT
     I                                        1   20@DLUP
     I                                        3   5 @MLUP
     I                                        6   70@YLUP
      *
     I            DS
      * ZA0710 Data structure over @@VLDT
     I                                        1   80@@VLDT
     I                                        1   40@@Z71Y
     I                                        5   60@@Z71M
     I                                        7   80@@Z71D
      *
     I            DS
      * BJEDIT Array/field data structure; edited amount with/without sign
     I                                        1  16 @Z
     I                                        2  16 @@MAMT
     I                                        1  16 @@AMTP
     I                                        1  17 @@AMTD
      *
     I            DS
      * BJEDIT Array/field data structure; amount to be edited
     I                                        1  150@Q
     I                                        1  150@@AMTW
     I            DS
      * Subfile Data structure: Value Date
     I                                        1   7 S#VDAT
     I                                        1   20S#S101
     I                                        3   5 S#S102
     I                                        6   70S#S103
     I            DS
      * Subfile Data structure: Maturity Date
     I                                        1   7 S#MDAT
     I                                        1   20S#M101
     I                                        3   5 S#M102
     I                                        6   70S#M103
     I            DS
      * Date input Data structure
     I                                        1   80@@DTIN
     I                                        1   40@@YYYY
     I                                        1   20@@CC
     I                                        3   40@@YY
     I                                        5   60@@MTH
     I                                        7   80@@DAY
      *
     I            DS                              8
     I**  Data structure to change format to MMDDYY/DDMMYY
     I                                        1   6 @@DTOU
     I                                        1   20@@DAT1
     I                                        3   40@@DAT2
     I                                        5   60@@YYY
      *
     I            DS                              8
     I**  Data structure to hold start interest date
     I                                        1   80@@DATA
     I                                        1   40@@YY1
     I                                        5   60@@MM1
     I                                        7   80@@DD1
      *
     I            DS                              8
     I**  Data structure to hold end interest date
     I                                        1   80@@DATB
     I                                        1   40@@YY2
     I                                        5   60@@MM2
     I                                        7   80@@DD2
      *
     I            DS
      * Run date data structure (YYYY/MM/DD)
     I                                        1   80W@RYMD
     I                                        1   40W@RUCY
     I                                        1   20W@RUNC
     I                                        3   40W@RUNY
     I                                        5   60W@RUNM
     I                                        7   80W@RUND
      *
     I@DATA       DS                             45
     I**  Data structure to hold the data for screen messages.
     I                                        1  25 @DATA1
     I                                       26  45 @DATA2
     I*
     IZMUSER      DS                             17
     I                                       11  13 BRC
     I                                       14  16 DEPT
     I*
     IRUNDAT      DS
     I                                       13  13 @MBIN
      *
     I/COPY WNCPYSRC,AB0340I001
      /COPY ZSRSRC,ZHOLI
      *
      ********************************************************************
      /EJECT
     C*CSTART
      *****************************************************
     C           *ENTRY    PLIST
     C                     PARM           P@TERM  1        B:Termination
     C                     PARM           PPDLNO  60                      S01393
     C           @DEAMK    KLIST
     C                     KFLD           @DEAMN  60
     C                     KFLD           @VDYY   40
     C                     KFLD           @VDMM   20
     C                     KFLD           @VDDD   20
     C                     KFLD           @DEAMS  30
     C           @DEAMC    KLIST
     C                     KFLD           @DEAMN
      *****************************************************
      *MAIN
     C                     EXSR ZZINIT                     P02: Initialise
      *                                                                   S01393
      * When program is called with parameters as a linked enquiry the    S01393
      * action code is set to 'E' and the deal number is passed in as     S01393
      * a parameter; Indicator IN68 is used to condition the code         S01393
      * functionality and the screen display                              S01393
      *                                                                   S01393
     C           PGPARM    IFEQ 2                          B1             S01393
     C                     MOVE 'E'       ##ACCD           *1             S01393
     C                     MOVE PPDLNO    ##DLNO           *1             S01393
     C                     SETON                     68    *1             S01393
     C                     END                             E1             S01393
      *                                                                   S01393
      * When called as a linked enquiry the initial prompt screen is      S01393
      * bypassed and the deal details are acquired and displayed          S01393
      * The original functionality is fully maintained                    S01393
      *                                                                   S01393
     C           *IN68     IFEQ '0'                                       S01393
     C                     WRITE#SFCM
     C                     WRITE#CMD2
     C                     WRITE#DETL
     C                     END                                            S01393
     C                     MOVE '1'       *IN74
      *
     C           W@OPEN    IFNE 'Y'
     C                     MOVE 'Y'       W@OPEN  1
     C                     OPEN INDEALS
     C                     OPEN MMDEAULL
     C                     OPEN CADLFALL
     C                     END
      *
      * Process: P03 Main processing
      *
     C           *IN03     DOUEQ'1'                        DO TO EOJ
     C           *IN74     IFEQ '0'
     C/COPY WNCPYSRC,AB0340C002
     C** Write Messages
     C************IN68     IFEQ '0'                                       S01393
     C                     WRITE#SFCM
     C***********          END                                            S01393
     C** Cmd Confirm Delete
     C           *IN64     IFEQ '1'
     C                     WRITE#CMD3
     C                     ELSE
     C** Cmd Confirm Insert
     C           *IN62     IFEQ '1'
     C                     WRITE#CMD4
     C                     ELSE
     C** Cmd Confirm Amend
     C           *IN65     IFEQ '1'
     C                     WRITE#CMD5
     C                     ELSE
     C** Cmd Normal
     C                     WRITE#CMD2
     C                     END
     C                     END
     C                     END
     C** Write Detail Screen
     C                     WRITE#DETL
     C/COPY WNCPYSRC,AB0340C003
     C                     END
     C** Save Display modes before read
     C                     MOVEA*IN,60    W@IN2B  2
     C** Read Detail Screen
      * When called as a linked enquiry the initial read is bypassed      S01393
      * since the deal number is passed in as a parameter. When the       S01393
      * deal details have been displayed the screen format is read        S01393
      * for F12-Previous (indicator 02) or F3-Exit (indicator 03)         S01393
      * both force return to calling program through termination          S01393
      * processing. The original functionality is fully maintained        S01393
      * for non-linked enquiry processing.                                S01393
      *                                                                   S01393
     C           *IN68     IFEQ '1'                                       S01393
     C           WWFRST    IFEQ 'N'                                       S01393
     C                     READ #DETL                    90  Obtain data  S01393
     C           *IN02     IFEQ '1'                                       S01393
     C                     SETON                     03                   S01393
     C                     END                                            S01393
     C                     END                                            S01393
     C                     MOVE 'N'       WWFRST  1                       S01393
     C                     ELSE                                           S01393
     C                     READ #DETL                    90  Obtain data
     C/COPY WNCPYSRC,AB0340C004
     C                     END                                            S01393
     C/COPY WNCPYSRC,AB0340C022
     C** Re-enable Screen Processing
     C                     MOVE '0'       *IN74
     C** Default Action Code to Enquire
     C           ##ACCD    IFEQ ' '
     C                     MOVE 'E'       ##ACCD
     C                     END
     C/COPY WNCPYSRC,AB0340C005
     C*
     C** Protect/Underline input fields
     C           ##ACCD    IFEQ 'D'
     C           ##ACCD    OREQ 'E'
     C           *IN63     OREQ '1'
     C           ##ACCD    ANDNE'I'
     C           *IN64     OREQ '1'
     C                     MOVEA'00'      *IN,60
     C                     ELSE
     C                     MOVE '1'       *IN61
     C           ##ACCD    IFEQ 'A'
     C                     MOVE '1'       *IN60
     C                     ELSE
     C                     MOVE '0'       *IN60
     C                     END
     C                     END
     C* Save Display modes After read
     C                     MOVEA*IN,60    W@IN2A  2
     C*
     C                     CALL 'ZA0250'                     <CLEAR MSGS>
     C           *IN03     IFEQ '0'                        NOT EOJ
     C                     MOVEAW@OF28    *IN,23             Error inds.
     C                     MOVEAW@OF08    *IN,51             Info. inds.
     C*
     C** Ignore Change Confirmation if screen has Changed
     C*
     C           @#DLA     IFNE @#DLB
     C                     MOVEA'0000'    *IN,62
     C                     END
     C*
     C           *IN62     CASEQ'1'       AHCNFI           CAS 1 Conf.Ins.
     C           *IN64     CASEQ'1'       AICNFD               2 Conf.Del.
     C           *IN65     CASEQ'1'       AJCNFA               2 Conf.Amd.
     C           *IN15     CASEQ'1'       AASLCT               3 Select
     C           *IN02     CASEQ'1'       AGPREV               4 Previous
     C           *IN08     CASEQ'1'       AENEXT               5 Next Rec.
     C           *IN09     CASEQ'1'       AFPREV               6 Prev.Rec.
     C           ##ACCD    CASEQ'I'       ABVFYI               7 Insert
     C           ##ACCD    CASEQ'A'       ACVFYD               8 Amend
     C           ##ACCD    CASEQ'D'       ACVFYD               9 Delete
     C           ##ACCD    CASEQ'E'       ADVFYE              10 Enquire
     C                     END
     C/COPY WNCPYSRC,AB0340C006
     C*
     C** Validate Action Code
     C*
     C           ##ACCD    IFNE 'I'
     C           ##ACCD    ANDNE'E'
     C           ##ACCD    ANDNE'D'
     C           ##ACCD    ANDNE'A'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0161' P@MGID
     C                     MOVE '1'       *IN24
     C                     MOVE '0'       *IN66
     C                     MOVEA'00'      *IN,60
     C                     END
     C/COPY WNCPYSRC,AB0340C019
     C                     END
     C                     END
      *
      * Process: P04 Termination processing
      * When called as a linked enquiry an exit parameter is passed       S01393
      * back to the calling program: This is set to 'U' if Function       S01393
      * Key 12 has been pressed (*IN02 set on); 'Q' if Function Key 3     S01393
      * has been pressed or 'E' if a database error has occurred          S01393
      * (SR/*PSSR)                                                        S01393
      *                                                                   S01393
     C           *IN68     IFEQ '1'                                       S01393
     C           *IN02     IFEQ '1'                                       S01393
     C                     MOVE 'U'       P@TERM                          S01393
     C                     ELSE                                           S01393
     C                     MOVE 'Q'       P@TERM                          S01393
     C                     END                                            S01393
     C                     END                                            S01393
      *
     C                     SETON                       LR  EOJ
      *****************************************************
      *ENDMAIN
      /EJECT
     CSR         AASLCT    BEGSR
      *==================================================== Called from:
      * Process: P23 Select Screen initial processing       *MAIN
      *          P24 Selection of records processing
      *          P25 Selected record handling processing
      *          P26 Select Screen termination processing
      *----------------------------------------------------
      *
      ** If multibranching indicator is NO
     C           @MBIN     IFEQ 'N'
     C                     CALL 'ZVACTU'
     C                     PARM 'E'       ZACTN
     C                     PARM           ERR
     C           ERR       IFEQ 1
      * This action code invalid for user
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0292' P@MGID 10
     C                     GOTO AAEXIT
     C                     END
     C                     END
      *
     C                     MOVEA'11'      *IN,71            Clear
     C                     WRITE#SFC1                       S'file
     C                     MOVEA'00'      *IN,71           
     C                     MOVEA'0000'    *IN,62            Clear Inds
      *
     C                     MOVE *BLANK    S#SEL1           Clear selector
     C                     Z-ADD*ZERO     ##SFRC           Reset S'file
     C                     Z-ADD*ZERO     W@SFRC           Position Cursor
     C           51        OCUR @#CCY
      *
     C           *LOVAL    SETLLINDEALSF             9090    Set file
      *
      * Fill the Subfile with all records from Deals file :
      *
     C           *IN90     DOUEQ'1'
     C                     READ INDEALSF                 90  Read file
     C           *IN90     IFEQ '0'
     C           IFDLTF    ANDEQ*BLANK                     and not Deleted
     C           IFDSTS    ANDEQ'A'                        and Authorised
      *
      ** Must also check for user authority to branch in mb system
     C*
     C                     Z-ADD*ZERO     ERR
     C*
     C           @MBIN     IFEQ 'Y'
      ** check booking branch, always use action code of 'E'
     C                     CALL 'ZVACTBU'
     C                     PARM 'E'       ZACTN
     C                     PARM IFBRC1    ZBRCD
     C                     PARM           ERR
     C                     END
      *
     C           ERR       IFNE 0
     C                     CALL 'ZVACTBU'
     C                     PARM 'E'       ZACTN
     C                     PARM IFBRC2    ZBRCD
     C                     PARM           ERR
     C                     END
      *
     C**  Check Originating branch if used in system
     C*
     C           ERR       IFEQ *ZERO
     C           BKOBUV    ANDEQ'Y'
     C                     CALL 'ZVOBU'
     C                     PARM IFORBR    ZBRCD
     C                     PARM           ERR
     C                     END
     C*
     C           ERR       IFEQ *ZERO
     C                     MOVE IFDLNO    S#DLNO             Deal No.
     C                     MOVE IFDTP1    S#DTP1             Deal Type.
     C                     MOVE IFSTP1    S#STP1             Deal Sub-type 1
     C                     MOVE IFBRC1    S#BRC1             Branch code 1
     C                     MOVE IFPRF1    S#PRF1             Profit centre 1
     C                     MOVE IFBOK1    S#BOK1             Book Code 1
      *
     C                     Z-ADDIFVDMM    W       20
     C                     MOVE IFVDDD    S#S101             Value Day
     C                     MOVE @MN,W     S#S102             Value Month
     C                     MOVE IFVDYY    S#S103             Value Year
      *
     C                     MOVE *BLANK    S#MDAT
     C           IFMDMM    IFEQ *ZEROS
     C           IFNTCE    IFEQ *ZERO
     C                     MOVEL'CALL'    S#MDAT             Call Deal
     C                     ELSE
     C                     Z-ADD0         @@IDP                           E20636
     C                     Z-ADD3         @@IINT                          E20636
     C                     MOVE IFNTCE    @@ALPH
     C                     EXSR ZA0840
     C                     MOVE @@ALPH    S#MDAT             Notice Deal
     C                     END
     C                     ELSE
     C                     Z-ADDIFMDMM    W
     C                     MOVE IFMDDD    S#M101             Mat. Day
     C                     MOVE @MN,W     S#M102             Mat. Month
     C                     MOVE IFMDYY    S#M103             Mat. Year
     C                     END
     C*
     C                     MOVE IFCCY     S#CCY              currency
     C                     Z-ADDIFCYDP    W@DECP             Curr. Dec.Pls
     C           IFPCPL    IFLT 0
     C                     Z-SUBIFPCPL    @@AMTW             I:Amount
     C                     ELSE
     C                     Z-ADDIFPCPL    @@AMTW             I:Amount
     C                     END
     C*
     C                     Z-ADD@@AMTW    @@IAMT             I:Amount
     C                     Z-ADD17        @@CRET
     C                     Z-ADDIFCYDP    @@CDP
     C                     EXSR ZA1020                       <Convert>
     C                     MOVE @@ADSP    S#SAMN             O:To display
     C                     MOVE IFDDLT    S#STAT             Status Del
     C                     ADD  1         ##SFRC             Incr.S'file
     C                     WRITE#SFL1                        Write S'file
      *
     C** Store Sub-file rec. no. of last ##DLNO
      *
     C           ##DLNO    IFEQ *BLANKS
     C                     MOVE W@DLNO    ##DLNO
     C                     END
      *
     C           ##DLNO    IFLE S#DLNO
     C           W@SFRC    ANDEQ*ZERO
     C                     Z-ADD##SFRC    W@SFRC
     C                     END
      *
     C                     END
     C                     END
     C                     END
      *
      * Set the Subfile record pointer, or 'No data' ind.:
      *
     C           ##SFRC    IFEQ *ZERO
     C                     MOVE '1'       *IN72              No data
     C                     ELSE
     C           W@SFRC    IFNE *ZERO
     C                     Z-ADDW@SFRC    ##SFRC             Position Cursor
     C                     END
     C                     END
      *
      * Display Subfile and receive User's selection or Cmd.Key :
      *
     C           *IN03     DOUEQ'1'
     C           *IN02     OREQ '1'
     C                     WRITE#SFCM                        Messages
     C                     WRITE#CMD1                        Command keys
     C   72                WRITE#NDAT                        No data
     C                     EXFMT#SFC1                        S'File
     C                     CALL 'ZA0250'                     <CLEAR MSGS>
     C           *IN72     IFEQ '0'
     C           *IN03     ANDEQ'0'
     C           *IN02     ANDEQ'0'
     C                     READC#SFL1                    90  Read S'File
     C           *IN90     IFEQ '0'
     C                     MOVE S#DLNO    W@DLNO             Selected Deal
     C                     MOVE '1'       *IN02              Exit loop
      *
     C           S#SEL1    IFEQ 'D'
     C           S#SEL1    OREQ 'A'
     C           S#SEL1    OREQ 'E'
     C           S#SEL1    OREQ 'I'
     C                     MOVE S#SEL1    ##ACCD
     C                     MOVE '1'       *IN66            Posn to DLNO
     C                     ELSE
     C                     MOVE 'E'       ##ACCD
     C                     MOVE '0'       *IN66            Posn to Actn
     C                     END
     C                     END
     C*
     C** Get selected/previous Deal record
     C*
     C           W@DLNO    CHAININDEALSF             90      Get record
     C*
     C           IFDTP1    IFEQ 'ID'
     C                     MOVE IFDADN    W@DADN
     C           W@DADN    CHAININDEALSF             90      Get Loan
     C                     END
     C*
     C** Convert File to Screen format
     C                     EXSR BDFTOS
     C                     END
     C                     END
      *
      *----------------------------------------------------
      *
      *====================================================
     CSR         AAEXIT    ENDSR
      /EJECT
     CSR         ABVFYI    BEGSR
      *==================================================== Called from:
      * Verify Insert/Amend                                 *MAIN
      *----------------------------------------------------
      * Define Work fields (used in subroutines) :
      *
     C           *LIKE     DEFN BBCUST    W@CUS1           Cust.no.1
     C           *LIKE     DEFN BBCUST    W@CUS2           Cust.no.2
     C           *LIKE     DEFN BBACOC    W@ACO1           A/c Off.1
     C           *LIKE     DEFN BBACOC    W@ACO2           A/c Off.2
     C           *LIKE     DEFN A8LCCD    W@LOC1           Brch Loc.1
     C           *LIKE     DEFN A8LCCD    W@LOC2           Brch Loc.2
     C           *LIKE     DEFN DVLDCY    W@LCC1           Brch Loc.1 Ccy
     C           *LIKE     DEFN DVLDCY    W@LCC2           Brch Loc.2 Ccy
     C           *LIKE     DEFN IFDLNO    W@DLNO           Numeric Deal No
     C           *LIKE     DEFN IFINTF    W@INTF           Int fq day in Mth
     C           *LIKE     DEFN BACBSR    W@RATE           Base Int. Rate
     C           *LIKE     DEFN IFRTSP    W@RTSP           Rate/Spread
     C           *LIKE     DEFN IFLCD     W@NIDT           Next interest Dte
     C           *LIKE     DEFN IFLCD     @DDYNO           Deal date day no
     C           *LIKE     DEFN IFLCD     @VDYNO           Value date day no
     C           *LIKE     DEFN IFLCD     @MDYNO           Maturity day no
     C           *LIKE     DEFN IFLCD     @NDYNO           Next Int Day no
     C           *LIKE     DEFN IFNTCE    W@NTCE           Notice Days
     C           *LIKE     DEFN IFDTP1    ##DTP1           First Deal Type
     C           *LIKE     DEFN IFDTP1    ##DTP2           Second Deal Type
     C           *LIKE     DEFN TOTI      W@TOTI           Total interest
     C           *LIKE     DEFN PCPL      W@PCPL           Principle
     C           *LIKE     DEFN IFDLNO    W@DADN           Assoc ref no.
     C           *LIKE     DEFN IFBCXR    W@BCXR           Exchange rate
     C           *LIKE     DEFN IFTLUP    W@TIME           Update Time
     C           *LIKE     DEFN ##SFRC    W@SFRC           Sub-file rec.no
      *---------------------------------------------------- Continuation
      /EJECT
      *---------------------------------------------------- Continued...
      *
      ** Position Cursor to Deal Number
      *
     C                     MOVE '1'       *IN66
      *
      ** Validate action codes for Single Branch User
      *
     C           @MBIN     IFEQ 'N'
     C                     CALL 'ZVACTU'
     C                     PARM ##ACCD    ZACTN
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
      * This action code invalid for user
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0292' P@MGID
     C                     MOVE '00'      W@IN2B
     C                     MOVE '0'       *IN66
     C                     END
     C                     END
      *
      * Check Display Mode/Single branch Authority:
      *
     C           W@IN2A    CABNEW@IN2B    ABEXIT
     C           *IN61     CABNE'1'       ABEXIT
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      ** Check for '?' and Substitute Selected Values
      *
      ** Booking Branch 1
      *
     C           ##BRC1    IFEQ '?'
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BRC1    @A8KEY  3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C                     MOVE A8BRCD    ##BRC1
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Booking Branch 2
      *
     C           ##BRC2    IFEQ '?'
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BRC2    @A8KEY  3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C                     MOVE A8BRCD    ##BRC2
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Deal Sub-type 1:
      *
     C           ##STP1    IFEQ '?'
     C                     CALL 'AODLSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY'    @OPTN   7
     C                     PARM ##STP1    @ASKEY  2
     C           SDDLST    PARM SDDLST    DSFDY
     C                     MOVE ASDSTC    ##STP1
     C                     MOVE '1'       *IN51
     C                     END
     C*
      ** Deal Sub-type 2:
      *
     C           ##STP2    IFEQ '?'
     C                     CALL 'AODLSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY'    @OPTN   7
     C                     PARM ##STP2    @ASKEY  2
     C           SDDLST    PARM SDDLST    DSFDY
     C                     MOVE ASDSTC    ##STP2
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Book Code 1
      *
     C           ##BOK1    IFEQ '?'
     C                     CALL 'AOBOOKR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BOK1    @BDKEY  2
     C           SDBOOK    PARM SDBOOK    DSFDY
     C                     MOVE BDBKCD    ##BOK1
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Book Code 2
      *
     C           ##BOK2    IFEQ '?'
     C                     CALL 'AOBOOKR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BOK2    @BDKEY  2
     C           SDBOOK    PARM SDBOOK    DSFDY
     C                     MOVE BDBKCD    ##BOK2
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Profit Centre 1
      *
     C           ##PRF1    IFEQ '?'
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##PRF1    @DSKEY  4
     C           SDPRFC    PARM SDPRFC    DSFDY
     C                     MOVE DSPCCD    ##PRF1
     C                     MOVELDSPCDS    ##PCD1
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Profit Centre 2
      *
     C           ##PRF2    IFEQ '?'
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##PRF2    @DSKEY  4
     C           SDPRFC    PARM SDPRFC    DSFDY
     C                     MOVE DSPCCD    ##PRF2
     C                     MOVELDSPCDS    ##PCD2
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Currency
      *
     C           ##CCY     IFEQ '?'
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY'    @OPTN
     C                     PARM ##CCY     @A6KEY  3
     C           SDCURR    PARM SDCURR    DSSDY
     C                     MOVE A6CYCD    ##CCY
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Base Rate Code
      *
     C           ##BRTT    IFEQ '?'
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM ##CCY     @AJCD   3
     C                     PARM ##BRTT    @DWND   2
     C********** SDBSRT    PARM SDBSRT    DSFDY                                 CSD006
     C           SDBSRT    PARM SDBSRT    DSSDY                                 CSD006
     C                     MOVE BABSRC    ##BRTT
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Originating Branch
      *
     C           ##ORBR    IFEQ '?'
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##ORBR    @A8KEY
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C                     MOVE A8BRCD    ##ORBR
     C                     MOVE '1'       *IN51
     C                     END
      *
      ** Redisplay Selections before Validating the screen
      *
     C           *IN51     CABEQ'1'       ABEXIT
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*30/##DLNO) Check Deal number :
      *              Errors: a) Not in range
      *                      b) Deal already exists
      *
     C**  Validate that deal number is numeric or blank.
     C/COPY WNCPYSRC,AB0340C021
     C*
     C                     TESTN          ##DLNO     95
     C                     MOVE ##DLNO    @TEST   1
     C                     TESTZ          @TEST          94
     C*
     C           ##DLNO    IFNE *BLANKS
     C           *IN95     ANDEQ'0'
     C           ##DLNO    ORNE *BLANKS
     C           *IN94     ANDEQ'0'
     C                     MOVE '1'       *IN30
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0162' P@MGID
     C                     ELSE
     C*
     C**  Set up the deal number as a numeric field.
     C                     MOVE ##DLNO    W@DLNO
     C*
     C           ##ACCD    IFEQ 'I'
     C**  If the deal number is within Range
     C           W@DLNO    IFEQ *ZERO
     C                     MOVE *BLANKS   ##DLNO
     C                     ELSE
     C           W@DLNO    IFEQ 999999
     C           W@DLNO    ORLT NORDLN
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0164' P@MGID
     C                     MOVE '1'       *IN30
     C                     ELSE
     C*
     C** Check existance of Deal number
     C*
     C           W@DLNO    SETLLCAMIDNLL                 90
     C           *IN90     IFEQ '0'
     C           W@DLNO    SETLLDEALSH                   90
     C                     END
     ** If Exists, Error
     C           *IN90     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0163' P@MGID
     C                     MOVE '1'       *IN30
     C                     ELSE
     C                     Z-ADDW@DLNO    IFDLNO
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*23/##DADN) Check Associated Deal Number
      *              Errors: a) Not in range
      *                      b) Deal already exists
      *
     C**  Validate that deal number is numeric or blank.
     C*
     C                     TESTN          ##DADN     95
     C                     MOVE ##DADN    @TEST   1
     C                     TESTZ          @TEST          94
     C*
     C           ##DADN    IFNE *BLANKS
     C           *IN95     ANDEQ'0'
     C           ##DADN    ORNE *BLANKS
     C           *IN94     ANDEQ'0'
     C                     MOVE '1'       *IN23
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0162' P@MGID
     C                     ELSE
     C*
     C**  Set up the deal number as a numeric field.
     C                     MOVE ##DADN    W@DADN
     C*
     C           ##ACCD    IFEQ 'I'
     C**  If the deal number is within Range
     C           W@DADN    IFEQ *ZERO
     C                     MOVE *BLANKS   ##DADN
     C                     ELSE
     C           W@DADN    IFEQ 999999
     C           W@DADN    ORLT NORDLN
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0164' P@MGID
     C                     MOVE '1'       *IN23
     C                     ELSE
     C*
     C** Check existance of Deal number
     C*
     C           W@DADN    SETLLCAMIDNLL                 90
     C           *IN90     IFEQ '0'
     C           W@DADN    SETLLDEALSH                   90
     C                     END
     ** If Exists, Error
     C           *IN90     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0163' P@MGID
     C                     MOVE '1'       *IN23
     C                     ELSE
     C                     MOVE W@DADN    IFDADN
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*32/##STP1) Check Deal Sub-type 1:
      *              Errors: a) Not on File
      *
     C                     CALL 'AODLSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY'    @OPTN   7
     C                     PARM ##STP1    @ASKEY  2
     C           SDDLST    PARM SDDLST    DSFDY
      *  if no record found, deal sub type is not valid
     C           @RTCD     IFNE *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0118' P@MGID             I:Not on File
     C                     MOVE '1'       *IN32
     C                     ELSE
     C                     MOVE ##STP1    IFSTP1             Sub-type
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*35/##STP2) Check Deal Sub-type 2:
      *              Errors: a) Not on File
      *
     C                     CALL 'AODLSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY'    @OPTN   7
     C                     PARM ##STP2    @ASKEY  2
     C           SDDLST    PARM SDDLST    DSFDY
      *  if no record found, deal sub type is not valid
     C           @RTCD     IFNE *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0118' P@MGID             I:Not on File
     C                     MOVE '1'       *IN35
     C                     ELSE
     C                     MOVE ##STP2    IFSTP2             Sub-type
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*37/##DDAT) Check Deal date :
      *              Errors: a) Date incorrect format
      *                      b) Date greater than Run date
      *
     C           ##DDAT    IFEQ *BLANKS
      * Default to run date
      *
     C           BJDFIN    IFEQ 'M'
     C                     MOVE W@RUNM    #D101              Deal Month
     C                     MOVE W@RUND    #D102              Deal Day
     C                     MOVE W@RUNY    #D103              Deal Year
     C                     ELSE
     C                     MOVE W@RUND    #D101              Deal Day
     C                     MOVE W@RUNM    #D102              Deal Month
     C                     MOVE W@RUNY    #D103              Deal Year
     C                     END
     C                     END
     C*
     C**  Validate that the deal date is a valid date.
     C                     TESTN          ##DDAT     9595
     C                     MOVE ##DDAT    @TEST
     C                     TESTZ          @TEST          94
     C           *IN95     IFEQ '1'
     C           *IN94     ANDEQ'1'
     C                     MOVE ##DDAT    @@DATE  60
     C                     CALL 'ZA0270'
     C                     PARM           @@DATE
     C                     PARM BJDFIN    @@DFMT
     C                     PARM           @@RTCD
     C                     PARM           @DDYNO
     C                     END
     C*
     C**  If the return code is 1 then the input date is invalid or
     C**  non-numeric.
     C           @@RTCD    IFEQ '1'
     C           *IN94     OREQ '0'
     C           *IN95     OREQ '0'
     C                     MOVE '1'       *IN37
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0124' P@MGID
     C*
     C**  If the date is valid, carry out further validation.
     C                     ELSE
     C*
     C**  The deal date must not be greater than the run date
     C           @DDYNO    IFGT BJRDNB
     C                     MOVE '1'       *IN37
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0249' P@MGID
     C                     ELSE
     C*                                                                   110978
     C** THE DEAL DATE CAN NOT BE LOWER THAN THE BACK VALUE LIMIT         110978
     C           @DDYNO    IFLT BACKVA                                    110978
     C           ##ACCD    ANDEQ'I'                                                           189757
     C                     MOVE '1'       *IN37                           110978
     C                     CALL 'ZA0240'                                  110978
     C                     PARM 'MMM0203' P@MGID                          110978
     C                     ELSE                                           110978
     C*
     C** Store date in YYYYMMDD Format
     C                     Z-ADD#D103     @@YY               Year
     C           BJDFIN    IFEQ 'M'
     C                     Z-ADD#D101     @@MTH              Month
     C                     Z-ADD#D102     @@DAY              Day
     C                     ELSE
     C                     Z-ADD#D101     @@DAY              Day
     C                     Z-ADD#D102     @@MTH              Month
     C                     END
     C           @@YY      IFLT 71
     C                     Z-ADD20        @@CC               21st.Century
     C                     ELSE
     C                     Z-ADD19        @@CC
     C                     END
     C                     Z-ADD@@YYYY    IFDDYY
     C                     Z-ADD@@MTH     IFDDMM
     C                     Z-ADD@@DAY     IFDDDD
     C*
     C                     ENDIF                                          110978
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      *
      *---------------------------------------------------- Continuation
      * (*38/##VDAT) Check Value date :
      *              Errors: a) Date is zero
      *                      b) Date in invalid format
      *
     C           ##VDAT    IFEQ *BLANKS
      * Default to run date
      *
     C           BJDFIN    IFEQ 'M'
     C                     MOVE W@RUNM    #V101              Value Month
     C                     MOVE W@RUND    #V102              Value Day
     C                     MOVE W@RUNY    #V103              Value Year
     C                     ELSE
     C                     MOVE W@RUND    #V101              Value Day
     C                     MOVE W@RUNM    #V102              Value Month
     C                     MOVE W@RUNY    #V103              Value Year
     C                     END
     C                     END
     C*
     C**  Validate that the value date is a valid date.
     C                     TESTN          ##VDAT     9595
     C                     MOVE ##VDAT    @TEST
     C                     TESTZ          @TEST          94
     C           *IN95     IFEQ '1'
     C           *IN94     ANDEQ'1'
     C                     MOVE ##VDAT    @@DATE
     C                     CALL 'ZA0270'
     C                     PARM           @@DATE
     C                     PARM BJDFIN    @@DFMT
     C                     PARM           @@RTCD
     C                     PARM           @VDYNO
     C                     END
     C*
     C**  If the return code is 1 then the input date is invalid or
     C**  non-numeric.
     C*
     C           @@RTCD    IFEQ '1'
     C           *IN94     OREQ '0'
     C           *IN95     OREQ '0'
     C                     MOVE '1'       *IN38
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0125' P@MGID
     C*
     C**  The deal date must less than the value date.
     C                     ELSE
     C*
     C           @DDYNO    IFGT @VDYNO
     C                     MOVE '1'       *IN37
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0250' P@MGID
     C                     ELSE
     C*
     C                     MOVE BJLCCY    ZCCY
     C                     Z-ADD@VDYNO    ZDAYNO
     C                     MOVE BJSLCD    ZLOC
     C                     EXSR ZCHKH
      *
      ** if ZIND = 'H' then the date is a holiday
     C           ZIND      IFEQ 'H'
     C                     MOVE '1'       *IN54
     C                     END
      *
     C** Store date in YYYYMMDD Format
     C*
     C                     Z-ADD#V103     @@YY               Year
     C           BJDFIN    IFEQ 'M'
     C                     Z-ADD#V101     @@MTH              Month
     C                     Z-ADD#V102     @@DAY              Day
     C                     ELSE
     C                     Z-ADD#V101     @@DAY              Day
     C                     Z-ADD#V102     @@MTH              Month
     C                     END
     C           @@YY      IFLT 71
     C                     Z-ADD20        @@CC               21st.Century
     C                     ELSE
     C                     Z-ADD19        @@CC               20th.Century
     C                     END
     C                     Z-ADD@@YYYY    IFVDYY
     C                     Z-ADD@@MTH     IFVDMM
     C                     Z-ADD@@DAY     IFVDDD
     C*
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      *---------------------------------------------------- Continuation
      * (*39/##MDAT) Check Maturity date:
      *              Errors: a) Date in invalid format
      *
     C           ##ACCD    IFEQ 'A'
     C*
     C** Concatinate date into @@DATA Data structure
     C*
     C                     Z-ADDIFDTYY    @@YY1
     C                     Z-ADDIFDTMM    @@MM1
     C                     Z-ADDIFDTDD    @@DD1
     C*
     C** Check date is amended after EOD
     C*
     C           W@RYMD    IFLE @@DATA
     C           ##MDAT    ANDNE@MDAT
     C                     MOVE '1'       *IN39
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0583' P@MGID
     C*
     C                     ELSE
     C*
     C           @MDAT     IFNE *BLANKS
     C           ##MDAT    ANDEQ*BLANKS
     C                     MOVE @MDAT     ##MDAT
     C                     MOVE '1'       *IN39
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0126' P@MGID
     C                     END
     C                     END
     C                     END
     C*
     C           ##MDAT    IFNE *BLANKS
     C           *IN39     ANDEQ'0'
     C*
     C**  Validate that the date is a valid date.
     C                     TESTN          ##MDAT     9595
     C                     MOVE ##MDAT    @TEST
     C                     TESTZ          @TEST          94
     C           *IN95     IFEQ '1'
     C           *IN94     ANDEQ'1'
     C                     MOVE ##MDAT    @@DATE
     C                     CALL 'ZA0270'
     C                     PARM           @@DATE
     C                     PARM BJDFIN    @@DFMT
     C                     PARM           @@RTCD
     C                     PARM           @MDYNO
     C                     END
     C*
     C**  If the return code is 1 then the input date is invalid or
     C**  non-numeric.
     C*
     C           @@RTCD    IFEQ '1'
     C           *IN94     OREQ '0'
     C           *IN95     OREQ '0'
     C                     MOVE '1'       *IN39
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0128' P@MGID
     C*
     C**  The Maturity date must Not be less than the value date.
     C                     ELSE
     C*
     C           @MDYNO    IFLE @VDYNO
     C                     MOVE '1'       *IN39
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0130' P@MGID
     C                     ELSE
     C*
     C                     MOVE BJLCCY    ZCCY
     C                     Z-ADD@MDYNO    ZDAYNO
     C                     MOVE BJSLCD    ZLOC
     C                     EXSR ZCHKH
      *
      ** if ZIND = 'H' then the date is a holiday
     C           ZIND      IFEQ 'H'
     C                     MOVE '1'       *IN53
     C                     END
      *
     C** Store date in YYYYMMDD Format in @@DTIN Data structure
     C*
     C                     Z-ADD#M103     @@YY               Year
     C           BJDFIN    IFEQ 'M'
     C                     Z-ADD#M101     @@MTH              Month
     C                     Z-ADD#M102     @@DAY              Day
     C                     ELSE
     C                     Z-ADD#M101     @@DAY              Day
     C                     Z-ADD#M102     @@MTH              Month
     C                     END
     C           @@YY      IFLT 71
     C                     Z-ADD20        @@CC               21st.Century
     C                     ELSE
     C                     Z-ADD19        @@CC               20th.Century
     C                     END
     C*
     C**  If the action code is 'A' the maturity date must be after the
     C**  last interest date and the interest accrual control date.
     C           ##ACCD    IFEQ 'A'
     C*
     C** Concatinate dates into @@DATA and @@DATB Data structures
     C*
     C                     Z-ADDIFIAYY    @@YY1
     C                     Z-ADDIFIAMM    @@MM1
     C                     Z-ADDIFIADD    @@DD1
     C                     Z-ADDIFSLYY    @@YY2
     C                     Z-ADDIFSLMM    @@MM2
     C                     Z-ADDIFSLDD    @@DD2
      *
     C           @@DTIN    IFLE @@DATA
     C           @@DTIN    ORLE @@DATB
     C                     MOVE '1'       *IN39
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0133' P@MGID
     C                     ELSE
     C*
     C**  If the action code is 'A', access the deal amendments file
     C**  for the last amendment to the deal being processed.
     C**  Set value for key of file to be greater than value required.
     C                     MOVE ##DLNO    @DEAMN
     C                     MOVE '9999'    @VDYY
     C                     MOVE '99'      @VDMM
     C                     MOVE '99'      @VDDD
     C                     MOVE '999'     @DEAMS
     C           @DEAMK    SETGTMMLVDMLL
     C*
     C**  Read the previous record on file.  (Should be the latest deal
     C**  amendment.)
     C                     READPMMLVDMLL                 90
     C                     MOVE HNDA38    @DA38   6
     C* Fill @@DATA data structure
     C                     Z-ADDHNVDYY    @@YY1
     C                     Z-ADDHNVDMM    @@MM1
     C                     Z-ADDHNVDDD    @@DD1
     C*
     C**  If a record is found with the correct deal number
     C**  and the maturity date is not later than the value date, it is
     C**  an error.
     C           *IN90     IFEQ '0'
     C           @DA38     ANDEQ##DLNO
     C           @@DTIN    ANDLE@@DATA
     C                     MOVE '1'       *IN39
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0136' P@MGID
     C                     END
     C                     END
     C                     END
     C*
     C           *IN39     IFEQ '0'
     C                     Z-ADD@@YYYY    IFMDYY
     C                     Z-ADD@@MTH     IFMDMM
     C                     Z-ADD@@DAY     IFMDDD
     C                     END
     C*
     C                     END
     C                     END
     C** Maturity Date is Blank
     C*
     C                     ELSE
     C           *IN39     IFEQ '0'
     C                     Z-ADD*ZERO     @MDYNO
     C                     Z-ADD*ZERO     IFMDYY
     C                     Z-ADD*ZERO     IFMDMM
     C                     Z-ADD*ZERO     IFMDDD
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*31/##NTCE) Check Notice Days:
      *
      **  Only Validate if Maturity Date Valid
      *
     C           *IN39     IFEQ '0'
     C*
     C**  If the notice days have not been input, it is invalid unless
     C**  the maturity date has been input.
      *
     C           ##NTCE    IFEQ *BLANKS
     C           ##MDAT    ANDEQ*BLANKS
     C                     MOVE '1'       *IN31
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0587' P@MGID
     C                     ELSE
      *
     C**  Validate that Notice days are numeric or blank.
     C*
     C                     MOVE *BLANKS   @@ALPH
     C                     MOVE *ZERO     @@AMT
     C                     Z-SUB999       W@NTCE
     C                     MOVE *BLANK    IFCNTI
     C*
     C**  Notice days have been entered
     C*
     C           ##NTCE    IFNE *BLANKS
     C                     Z-ADD0         @@IDP
     C                     Z-ADD3         @@IINT
     C                     MOVE ##NTCE    @@ALPH
     C                     EXSR ZA0840
     C** Invalid Number
     C           @@ERCD    IFNE 0
     C                     MOVE '1'       *IN31
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0139' P@MGID
     C                     ELSE
     C*
     C** Otherwise, Notice Days valid
     C*
     C                     MOVE @@AMT     W@NTCE
     C                     MOVE @@ALPH    ##NTCE
     C*
     C** If Amending, Check Maturity date entered is less than the
     C** Transaction Date plus notice days, otherwise Warning Message
     C*
     C           ##ACCD    IFEQ 'A'
     C*
     C           ##MDAT    IFNE *BLANKS
     C           W@NTCE    ADD  BJRDNB    YIWRK   50
     C                     Z-SUB999       W@NTCE
     C*
     C           YIWRK     IFGT @MDYNO
     C                     MOVE '1'       *IN55
     C                     ELSE
     C*
     C**  Else, Blank Notice days if No Warning issued
     C                     MOVE *BLANK    ##NTCE
     C                     END
     C                     END
     C*
     C                     ELSE
     C*
     C**  Otherwise Inserting, and If the maturity date and
     C**  Notice days have been entered, this is Invalid
     C*
     C           ##MDAT    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN31
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0586' P@MGID
     C*
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C**  If No Errors Detected, Store input
     C*
     C           *IN31     IFEQ '0'
     C                     Z-ADDW@NTCE    IFNTCE
     C*
     C**  Notice days have been entered, set Call/Notice Indicator
     C*
     C           W@NTCE    IFEQ *ZERO
     C                     MOVE 'C'       IFCNTI
     C                     ELSE
     C           W@NTCE    IFGT *ZERO
     C                     MOVE 'N'       IFCNTI
     C                     END
     C                     END
     C                     END
     C*
     C                     END
     C                     END
      *
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*26/##BRC1) Check Booking Branch code :
      *              Errors: a) Not on File
      *                      b) Customer not on file
      *                      c) Branch location not on file
      *                      d) Deal date Holiday in local Currency
      *
     C           @MBIN     IFEQ 'N'
      ** Set up the booking branch code field with default value
     C*
     C                     MOVE BJSBRC    ##BRC1
     C                     MOVE BJSBRC    IFBRC1
     C                     MOVE BJSBRC    IFDBRC
     C                     MOVE BJSLCD    W@LOC1
     C                     MOVE BJLCCY    W@LCC1
     C                     MOVE BJCUST    W@CUS2
     C                     MOVE BJCUST    IFCUS2
     C*
     C                     ELSE
      *
      ** Set up the booking branch code field with default value
     C           ##BRC1    IFEQ *BLANKS
     C                     MOVE BRC       ##BRC1
     C                     END
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BRC1    @A8KEY  3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0013' P@MGID
     C                     MOVE '1'       *IN26
      *
     C                     ELSE
     C                     MOVE ##BRC1    IFBRC1
     C                     MOVE ##BRC1    IFDBRC
     C                     MOVE A8LCCD    W@LOC1
     C                     MOVE A8BICN    W@CUS2
     C                     MOVE A8BICN    IFCUS2
      *
     C                     END
      *
      ** then check user authority to action/branch
     C                     CALL 'ZVACTBU'
     C                     PARM ##ACCD    ZACTN   1
     C                     PARM ##BRC1    ZBRCD   3
     C                     PARM           ERR     10
      *
     C           ERR       IFNE 0
     C                     MOVE '1'       *IN26
     C           ERR       IFEQ 1
      * no valid action codes for user/branch combination
     C                     MOVEL'FXM0290' P@MGID
     C                     ELSE
      * this action code invalid for user/branch combination
     C                     MOVEL'FXM0291' P@MGID
     C                     END
     C                     CALL 'ZA0240'
     C                     PARM           P@MGID
     C                     END
      *
      * Get Dealing currency of Branch Location
      *
     C           *IN26     IFEQ '0'
      *
     C* If no Location code get Global Default
      *
     C           W@LOC1    IFEQ *BLANKS
     C                     MOVE '***'     @DVKEY  3
     C                     ELSE
     C                     MOVE W@LOC1    @DVKEY
     C                     END
     C*
     C                     CALL 'AOLOCNR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @DVKEY
     C           SDLOCN    PARM SDLOCN    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN26
     C                     CALL 'ZA0240'
     C                     PARM 'FDM0459' P@MGID
     C                     ELSE
     C                     MOVE DVLDCY    W@LCC1
     C                     END
     C                     END
     C                     END
      *
      * Get Customer details for later Use
      *
     C           *IN26     IFEQ '0'
     C*****                CALL 'AOCUSTR0'                                CSD025
     C                     CALL 'AOCUSTR1'                                CSD025
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM W@CUS2    @BBKEY 10
     C                     PARM *BLANKS   @BBKY2  7
     C*****      SDCUST    PARM SDCUST    DSSDY                           CSD025
     C           SDCUST    PARM SDCUST    DSLDY                           CSD025
      *
     C           @RTCD     IFNE *BLANKS
     C           @BBKY2    OREQ 'ERROR  '
     C                     MOVE '1'       *IN26
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0205' P@MGID
     C                     ELSE
     C                     MOVE BBACOC    W@ACO2
     C                     MOVE BBCSSN    IFCSN2
      *
      ** for multibranching on, the deal date must not be a holiday
      ** in the local currency for the booking branch location
      *
      ** for Single branching, the deal date must not be a holiday
      ** in local currency for the system
     C                     MOVE W@LCC1    ZCCY
     C                     Z-ADD@DDYNO    ZDAYNO
     C                     MOVE W@LOC1    ZLOC
     C                     EXSR ZCHKH
      *
      ** if ZIND = 'H' then the date is a holiday
     C           ZIND      IFEQ 'H'
     C                     MOVE '1'       *IN37
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0251' P@MGID
     C                     END
      *                                                                   CSD025
      ** if De-Activate, the customer number is invalid                   CSD025
     C           CSD025    IFEQ 'Y'                                       CSD025
     C           BBDEAC    ANDEQ'Y'                                       CSD025
     C           ##ACCD    ANDEQ'I'                                       CSD025
     C                     MOVE '1'       *IN26                           CSD025
     C                     CALL 'ZA0240'                                  CSD025
     C                     PARM 'ABM0028' P@MGID                          CSD025
     C                     ENDIF                                          CSD025
      *                                                                   CSD025
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*27/##BRC2) Check Booking Branch code :
      *              Errors: a) Not on File
      *                      b) Customer not on file
      *                      c) Branch location not on file
      *                      d) Deal date Holiday in local Currency
      *
     C           @MBIN     IFEQ 'N'
      ** Set up the booking branch code field with default value
     C*
     C                     MOVE BJSBRC    ##BRC2
     C                     MOVE BJSBRC    IFBRC2
     C                     MOVE BJSLCD    W@LOC2
     C                     MOVE BJLCCY    W@LCC2
     C                     MOVE BJCUST    W@CUS1
     C                     MOVE BJCUST    IFCUS1
     C*
     C                     ELSE
      *
      ** Set up the booking branch code field with default value
     C           ##BRC2    IFEQ *BLANKS
     C                     MOVE BRC       ##BRC2
     C                     END
     C*
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BRC2    @A8KEY
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0013' P@MGID
     C                     MOVE '1'       *IN27
      *
     C                     ELSE
     C                     MOVE ##BRC2    IFBRC2
     C                     MOVE A8LCCD    W@LOC2
     C                     MOVE A8BICN    W@CUS1
     C                     MOVE A8BICN    IFCUS1
     C                     END
      *
      ** then check user authority to action/branch
     C                     CALL 'ZVACTBU'
     C                     PARM ##ACCD    ZACTN   1
     C                     PARM ##BRC2    ZBRCD   3
     C                     PARM           ERR     10
      *
     C           ERR       IFNE 0
     C                     MOVE '1'       *IN27
     C           ERR       IFEQ 1
      * no valid action codes for user/branch combination
     C                     MOVEL'FXM0290' P@MGID
     C                     ELSE
      * this action code invalid for user/branch combination
     C                     MOVEL'FXM0291' P@MGID
     C                     END
     C                     CALL 'ZA0240'
     C                     PARM           P@MGID
     C                     END
      *
      * set up Dealing currency of Branch Location
     C           *IN27     IFEQ '0'
      *
     C* If no Location code get Global Default
      *
     C           W@LOC2    IFEQ *BLANKS
     C                     MOVE '***'     @DVKEY
     C                     ELSE
     C                     MOVE W@LOC2    @DVKEY
     C                     END
     C*
     C                     CALL 'AOLOCNR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @DVKEY
     C           SDLOCN    PARM SDLOCN    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN27
     C                     CALL 'ZA0240'
     C                     PARM 'FDM0459' P@MGID
     C                     ELSE
     C                     MOVE DVLDCY    W@LCC2
     C                     END
     C                     END
     C                     END
      *
      * Get Customer details for later Use
      *
     C           *IN27     IFEQ '0'
     C*****                CALL 'AOCUSTR0'                                CSD025
     C                     CALL 'AOCUSTR1'                                CSD025
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM W@CUS1    @BBKEY 10
     C                     PARM *BLANKS   @BBKY2  7
     C*****      SDCUST    PARM SDCUST    DSSDY                           CSD025
     C           SDCUST    PARM SDCUST    DSLDY                           CSD025
      *
     C           @RTCD     IFNE *BLANKS
     C           @BBKY2    OREQ 'ERROR  '
     C                     MOVE '1'       *IN27
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0205' P@MGID
     C                     ELSE
     C                     MOVE BBACOC    W@ACO1
     C                     MOVE BBCSSN    IFCSN1
      *
      ** for multibranching on, the deal date must not be a holiday
      ** in the local currency for the booking branch location
      *
      ** for Single branching, the deal date must not be a holiday
      ** in local currency for the system
     C                     MOVE W@LCC2    ZCCY
     C                     Z-ADD@DDYNO    ZDAYNO
     C                     MOVE W@LOC2    ZLOC
     C                     EXSR ZCHKH
      *
      ** if ZIND = 'H' then the date is a holiday
     C           ZIND      IFEQ 'H'
     C                     MOVE '1'       *IN37
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0251' P@MGID
     C                     END
      *                                                                   CSD025
      ** if De-Activate, the customer number is invalid                   CSD025
     C           CSD025    IFEQ 'Y'                                       CSD025
     C           BBDEAC    ANDEQ'Y'                                       CSD025
     C           ##ACCD    ANDEQ'I'                                       CSD025
     C                     MOVE '1'       *IN27                           CSD025
     C                     CALL 'ZA0240'                                  CSD025
     C                     PARM 'ABM0028' P@MGID                          CSD025
     C                     ENDIF                                          CSD025
      *                                                                   CSD025
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*33/##BOK1) Check Book Code 1:
      *              Errors: a) Not on File
      *
      ** field is Mandatory
      *
     C           ##BOK1    IFEQ *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'FXM1037' P@MGID
     C                     MOVE '1'       *IN33
      *
     C                     ELSE
     C*
     C                     CALL 'AOBOOKR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BOK1    @BDKEY  2
     C           SDBOOK    PARM SDBOOK    DSFDY
     C           @RTCD     IFNE *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'FXM1038' P@MGID
     C                     MOVE '1'       *IN33               Highlight
     C                     ELSE
      ** store valid book code in standard deal
     C                     MOVE ##BOK1    IFBOK1
     C                     END
     C                     END
      *
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*36/##BOK2) Check Book Code 2:
      *              Errors: a) Not on File
      *
      ** field is Mandatory
      *
     C           ##BOK2    IFEQ *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'FXM1037' P@MGID
     C                     MOVE '1'       *IN36               Highlight
      *
     C                     ELSE
     C*
     C                     CALL 'AOBOOKR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##BOK2    @BDKEY
     C           SDBOOK    PARM SDBOOK    DSFDY
     C           @RTCD     IFNE *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'FXM1038' P@MGID
     C                     MOVE '1'       *IN36               Highlight
     C                     ELSE
      ** store valid book code
     C                     MOVE ##BOK2    IFBOK2
     C                     END
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*34/##LNKR) Check Link Reference Number
      *              Errors: a) Not numeric or Blank
      *
     C**  Validate that ref. number is numeric or blank.
     C*
     C                     MOVE *BLANKS   @@ALPH                          E20636
     C                     Z-ADD0         @@IDP                           E20636
     C                     Z-ADD6         @@IINT                          E20636
     C                     MOVE ##LNKR    @@ALPH                          E20636
     C                     MOVE 'N'       @@MTID                          E20636
     C                     EXSR ZA0840                                    E20636
     C*
     C           @@ERCD    IFNE *ZERO                                     E20636
     C           ##LNKR    ANDNE*BLANKS
     C           ##LNKR    OREQ *ZEROS
     C                     MOVE '1'       *IN34
     C                     CALL 'ZA0240'
     C                     PARM 'FXM1039' P@MGID
     C                     ELSE
     C*
     C**  Set up the deal number as a numeric field.
     C                     MOVE ##LNKR    IFLNKR
     C*
     C**  Re-display Reference number justified/Zero filled
     C           IFLNKR    IFNE *ZEROS
     C                     MOVE IFLNKR    ##LNKR
     C                     END
     C*
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*40/##CCY) Check Deal Currency on SDCURRPD:
      *              Errors: a) Currency code is blank
      *                      b) Currency not on File
      *
      ** field is Mandatory
      *
     C           ##CCY     IFEQ *BLANK
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0142' P@MGID
     C                     MOVE '1'       *IN40
     C                     ELSE
      *
     C                     Z-ADD1         Z       20
     C           ##CCY     LOKUP@CY,Z                    92
     C           *IN92     IFEQ '0'
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY'    @OPTN
     C                     PARM ##CCY     @A6KEY  3
     C           SDCURR    PARM SDCURR    DSSDY
     C           @RTCD     IFNE *BLANKS
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0202' P@MGID
     C                     MOVE '1'       *IN40
     C                     ELSE
      *
     C                     Z-ADD1         Z       20
     C           ##CCY     LOKUP@CY,Z                    92
      *
     C           *IN92     IFEQ '0'
     C           '   '     LOKUP@CY,Z                    92
     C           *IN92     IFEQ '0'
     C                     Z-ADD50        Z
     C                     END
      *
     C           Z         OCUR @#CCY
     C                     MOVE A6CYCD    @CY,Z
     C                     Z-ADDA6NBDP    W@DECP             Dec.places
     C                     Z-ADDA6SPRT    W@SPRT             Spot rate
     C                     MOVE A6MDIN    W@MDIN             Mult/Div.ind.
     C                     MOVE A6SCEX    W@SCEX             Scaling Expo.
     C                     MOVE A6DICB    W@ICBS             Int.Calc.Mth.
     C                     END
     C                     END
     C                     END
      *
     C           Z         OCUR @#CCY
     C                     MOVE ##CCY     IFCCY              Currency
     C                     MOVE W@DECP    IFCYDP             Curr Dec. Pls
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*41/##AMNP) Check Amount, if currency OK :
      *              Errors: a) Amount is zero
      *                      b) Invalid amount
      *
      *
      ** field is Mandatory if currency is OK
      *
     C           *IN40     IFEQ '0'
      *
     C           ##AMNP    IFEQ *BLANKS
     C                     MOVE '1'       *IN41
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0143' P@MGID
     C*
     C**  Verify that the amount entered is valid numeric.
     C                     ELSE
     C                     Z-ADDW@DECP    @@IDP                           S01194
     C           13        SUB  W@DECP    @@IINT                          S01194
     C                     MOVE *BLANKS   @@ALPH
     C                     MOVE ##AMNP    @@ALPH
     C                     MOVE 'Y'       @@MTID
     C                     EXSR ZA0840
     C           @@ERCD    IFNE *ZERO
     C                     MOVE '1'       *IN41
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0144' P@MGID
     C                     ELSE
     C           @@AMT     IFEQ *ZERO
     C           ##ACCD    ANDEQ'I'
     C                     MOVE '1'       *IN41
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0143' P@MGID
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C** If Amount is valid format for output to screen
     C*
     C           *IN40     IFEQ '0'
     C           *IN41     ANDEQ'0'
     C                     Z-ADD@@AMT     W@PCPL
     C                     MOVE @@ALPH    ##AMNP
     C                     END
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*42/##BCXR) Check Rate, if currency OK :
      *              Errors: a) Rate is GE 10000
      *                      b) Invalid amount
      *                      C) Outside range (warning)
     C*
     C**  If the deal ccy is valid, validate the rate.
     C           *IN40     IFEQ '0'
     C*
     C** Scale the rate for display.
     C           W@SCEX    ADD  1         IN1     20
     C*
     C**  Default screen rate to the rate held on the
     C**  currency file for the deal currency.
     C**
     C           W@SPRT    MULT @SF,IN1   W@SCRT 158
     C           W@SPRT    MULT @SF,IN1   @@AMTW
     C*
     C**  If the work fields are greater than 9999.99999999, set to
     C**  9999.99999999
     C*
     C********** @@AMTW    IFGE 10000                                     169143
     C           @@AMTW    IFGE 100000                                    169143
     C********** 10000     SUB  .00000001 W@SCRT                          169143
     C           100000    SUB  .00000001 W@SCRT                          169143
     C                     END
     C           W@SCRT    MULT 100000000 @@AMTW
     C*
     C** SET Occurrance to Dummy Currency
     C*
     C           51        OCUR @#CCY
     C                     Z-ADD8         W@DECP
     C*
     C**  If Rate Entered override and check against the Spot Rate
     C**  of the Dealt Currency
     C*
     C           ##BCXR    IFNE *BLANKS
     C*
     C**  Check it is a valid figure with 8 decimal places max.
     C                     Z-ADDW@DECP    @@IDP
     C**********           Z-ADD4         @@IINT                          169143
     C                     Z-ADD5         @@IINT                          169143
     C                     MOVE *BLANKS   @@ALPH
     C                     MOVE ##BCXR    @@ALPH
     C                     MOVE 'N'       @@MTID
     C                     EXSR ZA0840
     C**  Check field size
     C                     MOVE @@AMT     W@BCXR
     C                     Z-ADD*ZERO     @LLIM
     C                     MOVE W@BCXR    @LLIM
     C*
     C           @@ERCD    IFNE 0
     C           @@AMT     ORNE @LLIM
     C                     MOVE '1'       *IN42
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0413' P@MGID
     C                     ELSE
     C*
     C**  Calculate the upper and lower limits for the exchange rate.
     C           @@AMTW    MULT .8        @LLIM  150H
     C           @@AMTW    MULT 1.2       @ULIM  150H
     C*
     C** If Deal currency equals the base currency and the base currency
     C** rate is not equal to spot rate.
     C           ##CCY     IFEQ BJCYCD
     C           @@AMT     ANDNE@@AMTW
     C                     MOVE '1'       *IN42
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0412' P@MGID
     C                     ELSE
     C*
     C**  If the rate is less than the lower limit, or greater than the
     C**  the upper limit , this is an error.
     C**  If there is a difference in the input and calculated interest
     C**  amounts, output it in a message
     C           @@AMT     IFLT @LLIM
     C           @@AMT     ORGT @ULIM
     C                     MOVE '1'       *IN52
     C                     EXSR BJEDIT
     C                     MOVE *BLANKS   M@MGD2
     C                     MOVEL@@AMTP    M@MGD2
     C                     END
     C                     END
     C                     END
     C                     Z-ADD@@AMT     @@AMTW
     C                     END
     C*
     C** If Amount is valid format for output to screen
     C*
     C           *IN42     IFEQ '0'
     C                     EXSR BJEDIT
     C                     MOVE @@AMTP    ##BCXR
     C                     MOVE @@AMTW    W@SCRT
     C           W@SCRT    DIV  @SF,IN1   IFBCXR
     C                     END
     C*
     C** Reset Occurrance to Dealt Currency
     C*
     C           Z         OCUR @#CCY
     C                     MOVE W@MDIN    IFMMDI
     C                     END
     C*
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*25/##ORBR) Check Originating Branch code :
      *
     C           @MBIN     IFEQ 'N'
      * default to single branch field
     C                     MOVE BJSBRC    IFORBR
      *
     C                     ELSE
      *
     C           BKOBRU    IFNE 'Y'
      *
      * ORBR not used so default to booking branch field
     C                     MOVE ##BRC1    IFORBR
     C                     ELSE
      ** default blank originating branch to validated booking branch
     C           ##ORBR    IFEQ *BLANKS
     C           *IN26     ANDEQ'0'
     C                     MOVE ##BRC1    ##ORBR
     C                     END
      *
      ** Check that orig. branch code exists on SDBRCHPD
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##ORBR    @A8KEY
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN25
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0289' P@MGID
     C                     ELSE
     C                     MOVE ##ORBR    IFORBR
     C                     END
      *
     C** Orig. Branch User validation required?
      *
     C           BKOBUV    IFEQ 'Y'
     C           *IN25     ANDNE'1'
     C                     CALL 'ZVOBU'
     C                     PARM ##ORBR    ZOBRCD  3
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
     C           ERR       IFEQ 1
      * no valid origination branches for this user
     C                     MOVEL'FXM0287' P@MGID
     C                     ELSE
      * this originating branch invalid for user
     C                     MOVEL'FXM0288' P@MGID
     C                     END
     C                     CALL 'ZA0240'
     C                     PARM           P@MGID
     C                     END
     C                     END
     C                     END
     C                     END
      *
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      ** (*28/##PRF1) Profit Centre code 1 validation.
      *
     C           BKPRCU    IFEQ 'Y'
     C                     MOVE *BLANKS   ##PCD1
     C***********          MOVE '0'       @RTCD                           120827
     C                     MOVE '0'       WRTCD   1                       120827
      *
     C           ##PRF1    IFEQ *BLANKS
      *
      **  If field left blank only set to default if Profit-centre-
      **  default-used flag (BKPCDU) is YES. Else leave blank.
     C           BKPCDU    IFEQ 'Y'
      *
     C                     MOVE ##BOK1    @BOKCI  2
     C                     MOVE 'IL'      @DLTPI  5
     C                     MOVE ##STP1    @DLSTI  2
     C                     MOVE ##BRC1    @BRCDI  3
     C                     MOVE DEPT      @DEPTI  3
     C                     MOVE PGUSER    @USERI 10
     C                     MOVE W@ACO1    @ACOFI  2
     C                     MOVE W@CUS1    @CUSTI  6
     C                     CALL 'AOPRFMR0'
     C***********          PARM           @RTCD                           120827
     C                     PARM           WRTCD                           120827
     C                     PARM           @BOKCI
     C                     PARM           @DLTPI
     C                     PARM           @DLSTI
     C                     PARM           @BRCDI
     C                     PARM           @DEPTI
     C                     PARM           @USERI
     C                     PARM           @ACOFI
     C                     PARM           @CUSTI
     C                     PARM           @PRFCO  4
      *
     C***********@RTCD     IFEQ '2'                                       120827
     C           WRTCD     IFEQ '2'                                       120827
     C                     MOVE '1'       *IN28
     C                     CALL 'ZA0240'
     C                     PARM 'FXM4001' P@MGID
     C                     ELSE
     C                     MOVE @PRFCO    ##PRF1
     C                     END
      *
     C                     END
     C                     END
     C/COPY WNCPYSRC,AB0340C035
      *
     C           ##PRF1    IFNE *BLANKS
      *
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##PRF1    @DSKEY  4
     C           SDPRFC    PARM SDPRFC    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN28
     C                     CALL 'ZA0240'
     C                     PARM 'FXM4001' P@MGID
     C                     ELSE
     C                     MOVE ##PRF1    IFPRF1
     C                     MOVELDSPCDS    ##PCD1
     C                     END
     C                     END
      *
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      ** (*29/##PRF2) Profit Centre code 2 validation.
      *
     C           BKPRCU    IFEQ 'Y'
     C                     MOVE *BLANKS   ##PCD2
     C***********          MOVE '0'       @RTCD                           120827
     C                     MOVE '0'       WRTCD                           120827
      *
     C           ##PRF2    IFEQ *BLANKS
      *
      **  If field left blank only set to default if Profit-centre-
      **  default-used flag (BKPCDU) is YES. Else leave blank.
     C           BKPCDU    IFEQ 'Y'
      *
      ** MUST SET UP SOME FIELDS
     C                     MOVE ##BOK2    @BOKCI
     C                     MOVE 'ID'      @DLTPI
     C                     MOVE ##STP2    @DLSTI
     C                     MOVE ##BRC2    @BRCDI
     C                     MOVE DEPT      @DEPTI
     C                     MOVE PGUSER    @USERI
     C                     MOVE W@ACO2    @ACOFI
     C                     MOVE W@CUS2    @CUSTI
     C                     CALL 'AOPRFMR0'
     C***********          PARM           @RTCD                           120827
     C                     PARM           WRTCD                           120827
     C                     PARM           @BOKCI
     C                     PARM           @DLTPI
     C                     PARM           @DLSTI
     C                     PARM           @BRCDI
     C                     PARM           @DEPTI
     C                     PARM           @USERI
     C                     PARM           @ACOFI
     C                     PARM           @CUSTI
     C                     PARM           @PRFCO
      *
     C***********@RTCD     IFEQ '2'                                       120827
     C           WRTCD     IFEQ '2'                                       120827
     C                     MOVE '1'       *IN29
     C                     CALL 'ZA0240'
     C                     PARM 'FXM4001' P@MGID
     C                     ELSE
     C                     MOVE @PRFCO    ##PRF2
     C                     MOVE ##PRF2    IFPRF2
     C                     END
     C                     END
     C/COPY WNCPYSRC,AB0340C036
      *
     C                     END
      *
     C           ##PRF2    IFNE *BLANKS
     C*
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##PRF2    @DSKEY  4
     C           SDPRFC    PARM SDPRFC    DSFDY
     C           @RTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN29
     C                     CALL 'ZA0240'
     C                     PARM 'FXM4001' P@MGID
     C                     ELSE
     C                     MOVE ##PRF2    IFPRF2
     C                     MOVELDSPCDS    ##PCD2
     C                     END
     C                     END
      *
     C                     END
      *
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*43/##BRTT) Check Base Rate Code
     C*
     C**  If the base rate code facility indicator is not 'Y', and the
     C**  base rate code is non-blank, it is an error.
     C           BLBRCF    IFNE 'Y'
     C           ##BRTT    ANDNE*BLANKS
     C                     MOVE '1'       *IN43
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0416' P@MGID
     C                     END
     C*
     C**  If the base rate code, deal currency and deal value date are
     C**  all valid and non-blank, further validate the base rate code.
     C           *IN43     IFEQ '0'
     C           *IN40     ANDEQ'0'
     C           ##BRTT    ANDNE*BLANKS
     C*
     C**  Access the base rates file to ascertain whether the base rate
     C**  code is valid.
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM ##CCY     @AJCD   3
     C                     PARM ##BRTT    @DWND   2
     C********** SDBSRT    PARM SDBSRT    DSFDY                                 CSD006
     C           SDBSRT    PARM SDBSRT    DSSDY                                 CSD006
     C*
     C**  If no valid record is found, it is an error.
     C           @RTCD     IFNE *BLANK
     C           *IN38     ANDEQ'0'
     C                     MOVE '1'       *IN43
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0417' P@MGID
     C*
     C**  If a valid record has been found, find the base rate to use.
     C                     ELSE
     C                     MOVE ##BRTT    IFBRTT
     C*
     C**  If the deal value date is less than value date of new rate
     C**  change, use the previous base rate.
     C           @VDYNO    IFLT BAVDNR
     C                     Z-ADDBACBSR    W@RATE
     C*
     C** Display a warning message if the user is in Insert mode
     C*
     C           ##ACCD    IFEQ 'I'
     C                     MOVE '1'       *IN56
     C                     END
     C*
     C**  If the deal value date is greater than value date of new rate
     C**  change, use the next base rate.
     C                     ELSE
     C                     Z-ADDBANBRT    W@RATE
     C                     END
     C*
     C**  set up the base rate Short name on the Deal Format
     C*
     C                     MOVE BABSRS    IFDBSR
     C                     END
     C** ELSE, Base rate blank or invalid Currency/value date
     C                     ELSE
     C                     MOVE *BLANKS   IFDBSR
     C                     MOVE ##BRTT    IFBRTT
     C                     END
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*44/##RTSP) Check Interest Rate/Spread
     C*
     C**  If the spread/rate is blank, this is an error.
     C**  Unless base rate code is entered
      *
     C           ##RTSP    IFEQ *BLANKS
     C           ##BRTT    ANDEQ*BLANKS
     C           ##ACCD    IFEQ 'I'
     C                     MOVE '1'       *IN44
     C                     ELSE
     C                     MOVE '1'       *IN43
     C                     END
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0419' P@MGID
     C*
     C**  Check it is a valid figure with 7 decimal places max.
     C                     ELSE
     C                     Z-ADD7         @@IDP
     C                     Z-ADD4         @@IINT
     C                     MOVE *BLANKS   @@ALPH
     C                     Z-ADD*ZERO     @@AMT
     C           ##RTSP    IFNE *BLANKS
     C                     MOVE ##RTSP    @@ALPH
     C                     MOVE 'N'       @@MTID
     C                     EXSR ZA0840
     C*
     C           @@ERCD    IFNE 0
     C                     MOVE '1'       *IN44
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0422' P@MGID
     C                     END
     C*
     C                     END
     C                     END
     C*
     C**  If the spread/rate is valid, determine the effective rate and
     C**  place it in the Deal format.
     C           *IN43     IFEQ '0'
     C           *IN44     ANDEQ'0'
     C                     MOVE @@AMT     W@RTSP
     C                     MOVE @@ALPH    ##RTSP
     C           ##BRTT    IFNE *BLANKS
     C           W@RTSP    ADD  W@RATE    IFINTR
     C                     Z-ADDW@RTSP    IFRTSP
     C                     Z-ADD*ZERO     IFIIRT
     C                     ELSE
     C                     Z-ADDW@RTSP    IFINTR
     C                     Z-ADDW@RTSP    IFIIRT
     C                     Z-ADD*ZERO     IFRTSP
     C                     END
     C                     END
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*45/##ICBS) Check Interest Calculation Method :
     C*
     C** Default Method if blank
     C*
     C           ##ICBS    IFEQ *BLANK
     C           *IN40     ANDEQ'0'                             Valid Ccy
     C                     MOVE W@ICBS    ##ICBS
     C                     END
     C*
     C**  If the method is not 1,2,3,4,5 or 6 this is an error.
     C           ##ICBS    IFLT '1'
     C           ##ICBS    ORGT '6'
     C                     MOVE '1'       *IN45              Highlight
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0428' P@MGID
     C                     ELSE
     C                     MOVE ##ICBS    IFICBS             Calc.method
     C                     END
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*46/##IPFR) Check Interest Payment Frequency :
     C*
     C**  If the next interest date is blank and the interest frequency
     C**  is not, this is an error.
     C           ##NIDT    IFEQ *BLANKS
     C           ##IPFR    ANDNE*BLANKS
     C                     MOVE '1'       *IN46
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0434' P@MGID
     C                     ELSE
     C*
     C**  If the interest frequency is not M,Q,X,Y or blank it is an
     C**  error.
     C           ##IPFR    IFNE *BLANK
     C           ##IPFR    ANDNE'M'
     C           ##IPFR    ANDNE'N'                                                           227875
     C           ##IPFR    ANDNE'Q'
     C           ##IPFR    ANDNE'X'
     C           ##IPFR    ANDNE'Y'
     C                     MOVE '1'       *IN46
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0436' P@MGID
     C                     ELSE
     C                     MOVE ##IPFR    IFIPFR
     C                     END
     C                     END
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*47/##NIDT) Check Next Interest Payment Date:
     C*
     C** The Next interest payment date may only be amended when the
     C** Run date is after the deal input date and the next interest
     C** date is not zero
     C*
     C           ##ACCD    IFEQ 'A'
     C           ##NIDT    ANDNE@NIDT
     C*
     C** Concatinate date into @@DATA Data structure
     C*
     C                     Z-ADDIFDTYY    @@YY1
     C                     Z-ADDIFDTMM    @@MM1
     C                     Z-ADDIFDTDD    @@DD1
     C*
     C           IFNIYY    IFNE *ZERO                                     E24405
     C           W@RYMD    ANDLE@@DATA
     C                     MOVE '1'       *IN47
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0481' P@MGID
     C                     END
     C                     END
     C*
     C           ##NIDT    IFNE *BLANKS
     C           *IN47     ANDEQ'0'
     C*
     C**  Validate that the date is valid as a date.
     C                     TESTN          ##DDAT     9595
     C                     MOVE ##NIDT    @TEST
     C                     TESTZ          @TEST          94
     C*
     C           *IN95     IFEQ '1'
     C           *IN94     ANDEQ'1'
     C                     MOVE ##NIDT    @@DATE             I:Date
     C                     CALL 'ZA0270'               90  <CONVERT DATE>
     C                     PARM           @@DATE             I:Date
     C                     PARM BJDFIN    @@DFMT  1          I:Date fmt.
     C                     PARM           @@RTCD  1          O:Return code
     C                     PARM           @NDYNO             O:Day number
     C*
     C           @@RTCD    IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0438' P@MGID             I:Inval.date
     C                     MOVE '1'       *IN47
     C                     ELSE
      *
     C**  Check that the next interest date is after the value date.
     C**  (If the value date has been entered and is valid.)
     C           @VDYNO    IFNE *ZEROS
     C           *IN38     ANDEQ'0'
     C           @NDYNO    ANDLE@VDYNO
     C                     MOVE '1'       *IN47
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0440' P@MGID
     C                     END
     C*
     C**  Check that the next interest date is before the mat. date.
     C**  (If the maturity date has been entered and is valid.)
     C           @MDYNO    IFNE *ZEROS
     C           *IN39     ANDEQ'0'
     C           @NDYNO    ANDGE@MDYNO
     C                     MOVE '1'       *IN47
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0441' P@MGID
     C                     END
     C*
     C**  Find whether the date is a holiday in the local currency.
     C                     Z-ADD@NDYNO    ZDAYNO
     C                     MOVE BJLCCY    ZCCY
     C                     MOVE BJSLCD    ZLOC
     C                     EXSR ZCHKH
     C*
     C**  If ZIND = 'H' then the date is a holiday.
     C           ZIND      IFEQ 'H'
     C                     MOVE '1'       *IN57
     C                     END
     C** Store date in YYYYMMDD Format
     C*
     C                     Z-ADD#N103     @@YY
     C           BJDFIN    IFEQ 'M'
     C                     Z-ADD#N101     @@MTH              Month
     C                     Z-ADD#N102     @@DAY              Day
     C                     ELSE
     C                     Z-ADD#N101     @@DAY              Day
     C                     Z-ADD#N102     @@MTH              Month
     C                     END
     C           @@YY      IFLT 71
     C                     Z-ADD20        @@CC
     C                     ELSE
     C                     Z-ADD19        @@CC
     C                     END
     C*
     C** If Action code is 'A' check the next interest date is after
     C** Last interest date and Interest accrual control date
     C*
     C           ##ACCD    IFEQ 'A'
     C*
     C** Concatinate dates into @@DATA and @@DATB Data structures
     C*
     C                     Z-ADDIFIAYY    @@YY1
     C                     Z-ADDIFIAMM    @@MM1
     C                     Z-ADDIFIADD    @@DD1
     C                     Z-ADDIFSLYY    @@YY2
     C                     Z-ADDIFSLMM    @@MM2
     C                     Z-ADDIFSLDD    @@DD2
     C*
     C           @@DTIN    IFLE @@DATA
     C                     MOVE '1'       *IN47
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0443' P@MGID
     C                     END
     C*
     C           @@DTIN    IFLE @@DATB
     C                     MOVE '1'       *IN47
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0442' P@MGID
     C                     END
     C                     END
     C*
     C           *IN47     IFEQ '0'
     C                     Z-ADD@@YYYY    IFNIYY
     C                     Z-ADD@@MTH     IFNIMM
     C                     Z-ADD@@DAY     IFNIDD
     C                     END
     C*
     C                     END
     C                     END
     C*
     C** Next interest Date is Blank
     C*
     C                     ELSE
     C           *IN47     IFEQ '0'
     C                     Z-ADD*ZERO     @NDYNO             Day Number
     C                     Z-ADD*ZERO     IFNIYY
     C                     Z-ADD*ZERO     IFNIMM
     C                     Z-ADD*ZERO     IFNIDD
     C                     END
     C                     END
     C*
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*48/##TOTI) Check Total Interest Amount:
     C*
     C*
     C**  Check that the input amount is a valid number.
     C           *IN40     IFEQ '0'
     C           Z         OCUR @#CCY
     C                     Z-ADDW@DECP    @@IDP                           S01194
     C           13        SUB  @@IDP     @@IINT                          S01194
     C                     MOVE *BLANKS   @@ALPH
     C                     MOVE ##TOTI    @@ALPH
     C                     MOVE 'N'       @@MTID
     C                     EXSR ZA0840
     C           @@ERCD    IFNE 0
     C                     MOVE '1'       *IN48
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0452' P@MGID
     C                     END
     C                     END
     C*
     C**  If the amount is a valid number, cross validate the actual
     C**  amount. (Only if all the fields used are valid.)
     C           *IN31     IFEQ '0'
     C           *IN38     ANDEQ'0'
     C           *IN39     ANDEQ'0'
     C           *IN40     ANDEQ'0'
     C           *IN41     ANDEQ'0'
     C           *IN43     ANDEQ'0'
     C           *IN44     ANDEQ'0'
     C           *IN45     ANDEQ'0'
     C           *IN48     ANDEQ'0'
     C           ##ACCD    ANDEQ'I'
     C*
     C                     Z-ADD@VDYNO    @@BEG   50
     C*
     C** Find End date for interest Calculation
     C*
     C           ##MDAT    IFEQ *BLANKS
     C*
     C           W@NTCE    IFEQ *ZERO
     C           @@BEG     ADD  1         @@END
     C                     ELSE
     C           @@BEG     ADD  W@NTCE    @@END
     C                     END
     C*
     C                     ELSE
     C                     Z-ADD@MDYNO    @@END   50
     C                     END
     C*
     C** Calculate Total Interest
     C*
     C                     Z-ADD@@AMT     W@TOTI
     C                     Z-ADDW@PCPL    @@AMTW
     C                     Z-ADDIFINTR    @@RATE
     C                     MOVE IFICBS    @@CALC
     C                     EXSR BHCINT
     C*
     C** Default Total Interest to Calculated if blank
     C*
     C           ##TOTI    IFEQ *BLANKS
     C                     Z-ADD@@INTR    W@TOTI
     C                     END
     C*
     C**  Find the difference between the input and calculated interest
     C**  - if the difference is greater than 1 currency unit, this is
     C**    an error.
     C           W@TOTI    SUB  @@INTR    @DIFI  150
     C*
     C           @DIFI     IFLT 0
     C                     Z-SUB@DIFI     @DIFI
     C                     END
     C*
     C**  If there is a difference in the input and calculated interest
     C**  amounts, format the calculated figure and output it in a message
     C           @DIFI     IFGT 0
     C                     MOVE '1'       *IN48
     C                     Z-ADD@@INTR    @@AMTW
     C                     EXSR BJEDIT
     C                     MOVE *BLANKS   @DATA
     C                     MOVEL@@MAMT    @DATA
     C                     CALL 'ZA0440'
     C                     PARM 'MMM0453' P@MGID
     C                     PARM           @DATA
     C                     END
     C*
     C**  If the amount is valid, set up the numeric amount on the
     C**  Deal format.
     C                     Z-ADDW@TOTI    @@AMTW
     C                     EXSR BJEDIT
     C                     MOVE @@AMTD    ##TOTI
     C                     END
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*49/##INTF) Check Interest Frequency:
     C*
     C*
     C**  If the interest frequency day in month is not blank, and is
     C**  not an integer between 00 and 31 it is an error.
     C           ##INTF    IFNE *BLANKS
     C                     TESTN          ##INTF     9595
     C                     MOVE ##INTF    @TEST
     C                     TESTZ          @TEST          94
     C*
     C           *IN95     IFEQ '1'
     C           *IN94     ANDEQ'1'
     C                     MOVE ##INTF    W@INTF
     C           W@INTF    IFLT 0
     C           W@INTF    ORGT 31
     C                     Z-ADD*ZERO     W@INTF
     C                     MOVE '1'       *IN49
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0455' P@MGID
     C                     END
     C*
     C                     ELSE
     C                     Z-ADD*ZERO     W@INTF
     C                     MOVE '1'       *IN49
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0455' P@MGID
     C                     END
     C                     ELSE
     C                     Z-ADD*ZERO     W@INTF
     C                     END
     C*
     C**  If the interest frequency day in month is not blank, and the
     C**  interest frequency is *blank, this is an error.
     C           W@INTF    IFNE *ZERO
     C           ##IPFR    ANDEQ*BLANKS
     C                     MOVE '1'       *IN49
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0456' P@MGID
     C                     ELSE
     C*
     C**  If the next interest date is valid and not blank, and
     C**  the value and Maturity dates are valid, and the interest
     C**  payment day in month is Zero, set the day in month
     C**  to the days part of the value date
     C           ##NIDT    IFNE *BLANK
     C           *IN38     ANDEQ'0'
     C           *IN39     ANDEQ'0'
     C           *IN47     ANDEQ'0'
     C           *IN49     ANDEQ'0'
     C*
     C           W@INTF    IFEQ *ZEROS
     C           ##IPFR    ANDNE*BLANK
     C                     MOVE ##VDAT    @@DTOU
     C*
     C           BJDFIN    IFEQ 'D'
     C                     MOVE @@DAT1    W@INTF
     C                     ELSE
     C                     MOVE @@DAT2    W@INTF
     C                     END
     C                     END
     C                     END
     C*
     C                     MOVE W@INTF    IFINTF
     C*
     C                     END
     C*
      *---------------------------------------------------- Continued...
      /EJECT
      *---------------------------------------------------- Continuation
      * (*50/##CPTI) Check Capitalisation Indicator:
     C*
     C**  If the interest capitalisation indicator is not blank, or
     C**  'Y',it is an error.
     C*
     C           ##CPTI    IFNE *BLANKS
     C           ##CPTI    ANDNE'Y'
     C                     MOVE '1'       *IN50
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0465' P@MGID
     C                     ELSE
     C                     MOVE ##CPTI    IFCPTI
     C                     END
     C*
      *----------------------------------------------------
      * Check error inds;  if any are on, redisplay screen with
      * highlights set. Send outstanding messages and check for
      * information-only messages :
      *
     C                     MOVEA*IN,23    W@IN28 28
     C                     MOVEA*IN,51    W@IN08  8
     C                     MOVEA'0000'    *IN,62
      *
      *** IF No Errors,
      *
     C           W@IN28    IFEQ W@OF28                     B1
      *
      *** Set Action Awaiting Confirmation
      *
     C                     MOVE '1'       *IN62
     C                     MOVE '1'       *IN66
     C                     MOVE *BLANKS   @DATA
     C           ##ACCD    IFEQ 'I'                        B2
     C                     MOVEL'Insert'  @DATA
     C                     ELSE                            X2
     C                     MOVEL'Amend'   @DATA
     C                     END                             E2
      *
      *
     C           W@IN08    IFNE W@OF08                     B2
      *** ONLY WARNINGS EXIST
     C                     CALL 'ZA0440'
     C                     PARM 'MMM1039' P@MGID
     C                     PARM           @DATA
     C                     MOVE '0'       *IN66
     C                     END                             E2
      *
      * Copy Deal screen format for later checking if no errors
      *
     C                     MOVEL@#DLA     @#DLB
      *
     C                     ELSE                            X1
      *
      *** Errors found:
      *
     C                     MOVE '0'       *IN66
     C           W@IN08    IFEQ W@OF08                     B2
      ** Errors found, without Warnings - 'End of Error messages'
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0199' P@MGID
     C                     ELSE                            X2
      ** Errors found with Warnings - 'Info Messages follow'
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0198' P@MGID
     C                     END                             E2
     C                     END
      *
      **Display Informational messages :
      *
      ** Exchange rate Differs by more than 20%
      *
     C           *IN52     IFEQ '1'
     C                     CALL 'ZA0440'
     C                     PARM 'MMM0414' P@MGID
     C                     PARM           M@MGD2 45
     C                     END
      *
      ** Maturity date is a holiday in Local Currency
      *
     C           *IN53     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0135' P@MGID
     C                     END
      *
      ** Value date is a holiday in Local Currency
      *
     C           *IN54     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0131' P@MGID
     C                     END
      *
      ** Maturity Date Earlier than Notice Days
      *
     C           *IN55     IFEQ '1'
     C                     MOVE '1'       *IN53
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0584' P@MGID
     C                     END
      *
      ** Value date is before Base Interest Rate Change date
      *
     C           *IN56     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM1045' P@MGID
     C                     END
      *
      ** Value date is before Next Interest date
      *
     C           *IN57     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0445' P@MGID
     C                     END
     C*
      *====================================================
     CSR         ABEXIT    ENDSR
      /EJECT
     CSR         ACVFYD    BEGSR
      *==================================================== Called from:
      * Verify Amend/Delete                                 *MAIN
      *----------------------------------------------------
      *
     C** Check Current display for Deal number Changes
     C** or wrong display mode
     C*
     C           @DLNO     IFNE ##DLNO
     C           ##ACCD    OREQ 'A'
     C           W@IN2A    ANDNEW@IN2B
     C*
     C** Enquire upon new deal.
     C/COPY WNCPYSRC,AB0340C023
     C                     EXSR ADVFYE
     C/COPY WNCPYSRC,AB0340C007
     C                     GOTO ACEXIT
     C/COPY WNCPYSRC,AB0340C008
     C                     END
     C*
     C           W@DLNO    IFEQ *ZERO
      *
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0111' P@MGID           *1I:No Deal Nos
     C                     MOVE '1'       *IN30
     C                     GOTO ACEXIT
     C                     END
     C*
      ** Booking branch code validation only when MULTI-BRANCHING
      ** indicator is on.
     C           @MBIN     IFEQ 'Y'
      *
     C                     CALL 'ZVACTBU'
     C                     PARM ##ACCD    ZACTN
     C                     PARM ##BRC1    ZBRCD
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
     C                     MOVE '1'       *IN26
     C                     END
      *
     C           ERR       IFEQ 0
     C                     CALL 'ZVACTBU'
     C                     PARM ##ACCD    ZACTN
     C                     PARM ##BRC2    ZBRCD
     C                     PARM           ERR
     C           ERR       IFNE 0
     C                     MOVE '1'       *IN27
     C                     END
     C                     END
      *
     C           ERR       IFNE 0
     C           ERR       IFEQ 1
      * no valid booking branches found for user/action code
     C                     MOVEL'FXM0290' P@MGID
     C                     ELSE
      * this action code invalid for user/branch combination
     C                     MOVEL'FXM0291' P@MGID
     C                     END
     C                     CALL 'ZA0240'
     C                     PARM           P@MGID
     C                     END
      *
     C** Orig. Branch User validation required?
      *
     C           BKOBUV    IFEQ 'Y'
      *
     C                     CALL 'ZVOBU'
     C                     PARM           IFORBR
     C                     PARM           ERR
     C           ERR       IFNE 0
     C           ERR       IFEQ 1
      * no valid origination branches for this user
     C                     MOVEL'FXM0287' P@MGID
     C                     ELSE
      * this originating branch invalid for user
     C                     MOVEL'FXM0288' P@MGID
     C                     END
     C                     CALL 'ZA0240'
     C                     PARM           P@MGID
     C                     MOVE '1'       *IN25
     C                     GOTO ACEXIT
     C                     END
     C                     END
     C                     ELSE
      *
      ** validate action codes for Single Branch User
     C                     CALL 'ZVACTU'
     C                     PARM ##ACCD    ZACTN
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
      * This action code invalid for user
     C                     MOVE '1'       *IN24
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0292' P@MGID
     C                     END
      *
     C                     END
      *
     C           IFDDLT    IFEQ 'D'
     C           IFDLTF    ORNE *BLANK
     C                     MOVE '1'       *IN24
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0172' P@MGID             I:Deleted Deal
     C                     END
     C*
     C**  The deal status must be A
     C           IFDSTS    IFNE 'A'
     C                     MOVE '1'       *IN24
     C           ##ACCD    IFEQ 'D'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0169' P@MGID
     C                     ELSE
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0166' P@MGID
     C                     END
     C                     END
     C*
     C** Check for errors
     C*
     C                     MOVEA*IN,24    W@IN4   4
     C           W@IN4     IFEQ '0000'
     C*
     C** Set Pending Action IF NO ERRORS
     C*
     C           ##ACCD    IFEQ 'D'
     C*
     C**  If the action code is 'D', access the deal amendments file
     C**  for amendments to the deal being processed.
     C*
     C                     MOVE ##DLNO    @DEAMN
     C*
     C           @DEAMC    SETLLMMLVDMLL
     C*
     C           @DEAMC    READEMMLVDMLL                 90
     C*
     C**  If a record is found with the correct deal number
     C**  it is an error.
     C           *IN90     IFEQ '0'
     C                     MOVE '1'       *IN30
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0170' P@MGID
     C*
     C                     ELSE
     C                     MOVE '1'       *IN64              Del.pending
     C                     END
     C*
     C                     ELSE
     C                     EXSR ABVFYI                       Validate input
     C/COPY WNCPYSRC,AB0340C009
     C           *IN62     IFEQ '1'
     C                     MOVE '0'       *IN62              Clr Ins. Pendg
     C           @#DLA     IFNE @#DLC
     C/COPY WNCPYSRC,AB0340C024
     C                     MOVE '1'       *IN65              Amd Pending
     C                     END
     C                     END
     C/COPY WNCPYSRC,AB0340C010
     C                     END
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         ACEXIT    ENDSR
      /EJECT
     CSR         ADVFYE    BEGSR
      *==================================================== Called from:
      * Verify Enquiry                                      *MAIN
      *----------------------------------------------------
      *
     C                     MOVE ##DLNO    W@DLNO            Store Deal No.
     C                     EXSR BCRSET                      <Reset screen>
     C                     MOVE W@DLNO    ##DLNO            Restore Dl.No.
      *
     C           W@DLNO    IFEQ *ZERO
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0111' P@MGID
     C                     MOVE '1'       *IN30
     C                     ELSE
      *
     C           W@DLNO    CHAININDEALSF             90      Internal deals
     C           *IN90     IFEQ '0'                        If Found
      *
      **  If Internal Deposit Found, get Loan
      *
     C           IFDTP1    IFEQ 'ID'
     C                     MOVE IFDADN    W@DADN
     C           W@DADN    CHAININDEALSF             90      Internal deals
     C                     END
      *
     C                     ELSE
      *
      **  If No Internal Deal Found, Look for any Deal
      *
     C                     MOVE '1'       *IN30              Deal no. Error
     C           W@DLNO    SETLLCAMIDNLL                 90  Check All Deals
     C           *IN90     IFEQ '0'                        If Not Found
     C           W@DLNO    SETLLDEALSH                   90
     C                     END
      **  If other Deal Type Found, Send Wrong Deal type message
      *
     C           *IN90     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'BBM0149' P@MGID
     C                     MOVE '0'       *IN90
     C                     ELSE
      **  Otherwise, Deal does not exist
      *
     C                     MOVE '1'       *IN90
     C                     END
     C                     END
      *
     C           *IN90     IFEQ '0'                        IF Found
     C           *IN30     ANDEQ'0'                        and No errors
     C           IFDLTF    ANDEQ*BLANK
      *
      ** if system is multibranched check branch/user authorities
      ** for each deal which may be displayed
      ** Must also check for user authority to branch in mb system
     C           @MBIN     IFEQ 'Y'
      ** DO NOT VALIDATE IF LINKED ENQUIRY                                S01393
     C           PGPARM    IFNE 2                                         S01393
      ** check booking branch, always use action code of 'E'
     C                     CALL 'ZVACTBU'
     C                     PARM ##ACCD    ZACTN
     C                     PARM IFBRC1    ZBRCD
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
     C                     CALL 'ZVACTBU'
     C                     PARM ##ACCD    ZACTN
     C                     PARM IFBRC2    ZBRCD
     C                     PARM           ERR
     C                     END
     C** Orig. Branch User validation required?
      *
     C           BKOBUV    IFEQ 'Y'
     C           ERR       ANDEQ0
     C                     CALL 'ZVOBU'
     C                     PARM           IFORBR
     C                     PARM           ERR
     C                     END
      *
     C           ERR       IFNE 0
     C                     MOVE '1'       *IN30
     C                     END
      *
     C                     END                                            S01393
      *
      ** ELSE, validate action codes for Single Branch User
      *
     C                     ELSE
     C           PGPARM    IFNE 2                                         S01393
      ** check booking branch, always use action code of 'E'
     C                     CALL 'ZVACTU'
     C                     PARM ##ACCD    ZACTN
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
      * This action code invalid for user
     C                     MOVE '1'       *IN24
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0292' P@MGID
     C                     END
     C                     END
     C                     END                                            S01393
     C*
     C** If Valid, Format Screen Output
     C*
     C           ERR       IFEQ 0
     C           *IN30     ANDEQ'0'
     C                     EXSR BDFTOS
     C                     END
     C/COPY WNCPYSRC,AB0340C025
     C*
     C** ELSE, If file Error or Deleted
     C*
     C                     ELSE
     C*
     C           IFDLTF    IFNE *BLANK
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0140' P@MGID
     C                     END
     C*
     C           *IN90     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0125' P@MGID
     C                     END
     C                     END
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         ADEXIT    ENDSR
      /EJECT
     CSR         AENEXT    BEGSR
      *==================================================== Called from:
      * Get next record                                     *MAIN
      * Process: P08 Get next record
      *----------------------------------------------------
     C*
      *
      ** Set Deals file to First record if Deal number not entered
      *
     C           ##DLNO    IFEQ *BLANKS
     C                     Z-ADD*LOVAL    W@DLNO
     C                     MOVE *LOVAL    @DLNO
     C                     END
      *
      ** Access New Deal if deal number changed
      *
     C           ##DLNO    IFNE @DLNO
     C           W@DLNO    SETLLINDEALSF
     C                     END
      *
     C                     Z-ADD1         ERR
     C                     MOVE '0'       *IN90
     C                     MOVE '1'       *IN66
      *
      **  Read records until valid record found.
     C           *IN90     DOUEQ'1'
     C           IFDLTF    OREQ *BLANKS
     C           ERR       ANDEQ*ZERO
     C           IFDTP1    ANDEQ'IL'
     C                     READ INDEALSF               9090
      ** Must also check for user authority to branch in mb
     C           @MBIN     IFEQ 'Y'
      *
      ** check booking branch, always use action code of 'E'
     C                     CALL 'ZVACTBU'
     C                     PARM 'E'       ZACTN
     C                     PARM IFBRC1    ZBRCD
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
     C                     CALL 'ZVACTBU'
     C                     PARM 'E'       ZACTN
     C                     PARM IFBRC2    ZBRCD
     C                     PARM           ERR
     C                     END
     C** Orig. Branch User validation required?
      *
     C           BKOBUV    IFEQ 'Y'
     C           ERR       ANDEQ0
     C                     CALL 'ZVOBU'
     C                     PARM           IFORBR
     C                     PARM           ERR
     C                     END
      *
     C                     ELSE
      *
      ** validate action codes for Single Branch User
     C                     CALL 'ZVACTU'
     C                     PARM 'E'       ZACTN
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
      * This action code invalid for user
     C                     MOVE '1'       *IN90
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0292' P@MGID
     C                     END
     C                     END
      *
     C                     END
      *
     C           *IN90     IFEQ '0'
     C           IFDLTF    ANDEQ*BLANKS
     C           ERR       ANDEQ*ZERO
     C                     EXSR BDFTOS                       <File->Scrn>
     C                     ELSE
     C           *HIVAL    SETGTINDEALSF                     Reset file
     C                     CALL 'ZA0240'
     C                     PARM 'MMM1002' P@MGID             I:End of file
     C                     EXSR BCRSET
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         AEEXIT    ENDSR
      /EJECT
     CSR         AFPREV    BEGSR
      *==================================================== Called from:
      * Get previous record                                 *MAIN
      * Process: P09 Get previous record
      *----------------------------------------------------
      *
      ** Set Deals file to Last record if Deal number not entered
      *
     C           ##DLNO    IFEQ *BLANK
     C                     Z-ADD*HIVAL    W@DLNO
     C                     MOVE *HIVAL    @DLNO
     C                     END
      *
      ** Access New Deal if deal number changed
      *
     C           ##DLNO    IFNE @DLNO
     C           W@DLNO    SETGTINDEALSF
     C                     END
      *
     C                     Z-ADD1         ERR
     C                     MOVE '0'       *IN90
     C                     MOVE '1'       *IN66
      *
      **  Read records until valid record found.
     C           *IN90     DOUEQ'1'
     C           IFDLTF    OREQ *BLANKS
     C           ERR       ANDEQ*ZERO
     C           IFDTP1    ANDEQ'IL'
     C                     READPINDEALSF               9090
      ** Must also check for user authority to branch in mb
     C           @MBIN     IFEQ 'Y'
      *
      ** check booking branch, always use action code of 'E'
     C                     CALL 'ZVACTBU'
     C                     PARM 'E'       ZACTN
     C                     PARM IFBRC1    ZBRCD
     C                     PARM           ERR
      *
     C           ERR       IFEQ 1
     C                     CALL 'ZVACTBU'
     C                     PARM 'E'       ZACTN
     C                     PARM IFBRC2    ZBRCD
     C                     PARM           ERR
     C                     END
     C** Orig. Branch User validation required?
      *
     C           BKOBUV    IFEQ 'Y'
     C           ERR       ANDEQ0
     C                     CALL 'ZVOBU'
     C                     PARM           IFORBR
     C                     PARM           ERR
     C                     END
      *
     C                     ELSE
      *
      ** validate action codes for Single Branch User
     C                     CALL 'ZVACTU'
     C                     PARM 'E'       ZACTN
     C                     PARM           ERR
      *
     C           ERR       IFNE 0
      * This action code invalid for user
     C                     MOVE '1'       *IN90
     C                     CALL 'ZA0240'
     C                     PARM 'FXM0292' P@MGID
     C                     END
     C                     END
      *
     C                     END
      *
     C           *IN90     IFEQ '0'
     C           IFDLTF    ANDEQ*BLANKS
     C           ERR       ANDEQ*ZERO
     C                     EXSR BDFTOS
     C                     ELSE
     C           *LOVAL    SETLLINDEALS
     C                     CALL 'ZA0240'
     C                     PARM 'MMM1003' P@MGID
     C                     EXSR BCRSET
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         AFEXIT    ENDSR
      /EJECT
     CSR         AGPREV    BEGSR
      *==================================================== Called from:
      * Process: P07 Exit or reset to default values        *MAIN
      *----------------------------------------------------
     C*
     C**  EXIT program, if screen blank
     C/COPY WNCPYSRC,AB0340C026
     C*
     C           @#DLA     IFNE *BLANKS
     C*
     C**  Clear screen if Insert or No changes
     C*
     C           @#DLA     IFEQ @#DLB
     C           @#DLA     ANDEQ@#DLC
     C           ##ACCD    OREQ 'I'
     C           @#DLA     ANDEQ@#DLB
     C                     CLEAR@#DLB
     C                     ELSE
     C**  Else, Re-read file
     C           @#DLA     IFEQ @#DLB
     C/COPY WNCPYSRC,AB0340C027
     C                     EXSR ADVFYE
     C                     END
     C                     END
      *
     C                     MOVEL@#DLB     @#DLA
     C                     MOVE '1'       *IN66            Cursor to deal
      *
     C                     ELSE
     C                     MOVE '1'       *IN03
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         AGEXIT    ENDSR
      /EJECT
     CSR         AHCNFI    BEGSR
      *==================================================== Called from:
      * Insert confirmed - insert record                *62 *MAIN
      *----------------------------------------------------
      *
     C                     MOVE '0'       *IN62            Reset ind.
     C                     MOVE 'Y'       @MAN                            066308
      *
      *
      ** If Action Confirmed and Screen Changed
     C/COPY WNCPYSRC,AB0340C011
      *
     C           *IN02     IFEQ '0'
      *
     C           ##ACCD    IFNE 'I'
     C           @#DLA     ORNE @#DLB
     C/COPY WNCPYSRC,AB0340C012
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0129' P@MGID
     C                     MOVE '1'       *IN30
      *
     C                     ELSE
      *
      ** Get Next available deal number
     C           ##DLNO    IFEQ *BLANK
     C                     EXSR BAALCD                       <Allocate>
     C                     MOVE P@DLNO    ##DLNO             Copy Dl.No.
     C                     MOVE P@DLNO    DDSIMG  60         Copy Dl.No.  066308
     C                     MOVE 'N'       @MAN    1                       066308
     C                     ELSE                                           066308
     C                     MOVE ##DLNO    DDSIMG             Copy Dl.No.  066308
     C                     END
     C                     MOVE ##DLNO    @DLNO
     C                     MOVE ##DLNO    IFDLNO
     C                     MOVE ##DLNO    HKDN38
     C/COPY WNCPYSRC,AB0340C028
      *
      ** Get Next available deal number
     C           ##DADN    IFEQ *BLANK
     C                     EXSR BAALCD                       <Allocate>
     C                     MOVE P@DLNO    ##DADN             Copy Dl.No.
     C                     MOVE P@DLNO    DDSIM2  60         Copy Dl.No.  066308
     C                     MOVE 'N'       @MAN                          1 066308
     C                     ELSE                                           066308
     C                     MOVE ##DADN    DDSIM2             Copy Dl.No.  066308
     C                     END
      *
     C                     MOVE ##DADN    @DADN
     C                     MOVE ##DADN    IFDADN
     C                     MOVE ##DADN    HKDADN
     C/COPY WNCPYSRC,AB0340C029
      *
     C** Write dummy Deals
     C                     MOVE ##DLNO    W@DLNO
     C                     MOVE ##DLNO    HKPCDN
     C                     MOVE TSTAMP    HKTMST                                              208955
     C                     Z-ADD0         HKBCAM                                              CLE025
     C                     WRITEMMDLDUP0                     Dummy record
     C                     MOVE *BLANKS   @DLNO
     C*
     C                     MOVE HKDADN    HKDN38
     C                     MOVE IFDLNO    HKDADN
     C                     MOVE ##DADN    W@DLNO
     C                     MOVE ##DADN    HKPCDN
     C                     WRITEMMDLDUP0                     Dummy record
     C                     MOVE *BLANKS   @DADN
     C/COPY WNCPYSRC,AB0340C030
     C*
     C* Write Screen for new input
     C*
     C                     MOVE ##DLNO    W@DLNO
     C                     CLEAR@#DLB
     C                     MOVE @#DLB     @#DLA
     C                     MOVE @#DLB     @#DLC
     C                     WRITE#SFCM
     C                     WRITE#CMD2
     C                     WRITE#DETL
     C                     MOVE '1'       *IN74
     C*
     C* Complete Deal Format:
     C*
     C                     MOVE 'IL'      IFDTP1
     C                     MOVE 'ID'      IFDTP2
     C                     Z-SUBW@PCPL    IFPCPL           - Principle
     C                     Z-ADDW@TOTI    IFTOTI           - Total Interest
     C                     Z-ADDW@TOTI    IFIMAT           Interest at Mat.
     C                     MOVE IFDTP1    IFTYPE           Deal Type
     C                     MOVE ' '       IFRBSI           Rollover Ind
     C                     MOVE ' '       IFNGVI           Normal Interest
     C/COPY WNCPYSRC,AB0340C037
     C                     MOVE 'N'       IFMTAX           Tax Indicator
     C/COPY WNCPYSRC,AB0340C038
     C                     Z-ADD1         IFACSQ           Account Seq. No.
     C                     MOVE *BLANK    IFDLTF           Delete flag
     C                     Z-ADD*ZERO     IFPCTN           PC Trans no.
     C                     MOVE 'A'       IFDSTS           Deal Status
     C                     MOVE *BLANK    IFDDLT           Deal Deleted
     C                     MOVELPGUSER    IFDUSC           Deal User code
     C                     MOVELPGUSER    IFLUID           Update User id
     C                     MOVELPGUSER    IFAOFR           Auth. officer
     C                     MOVE 'I'       IFLACT           Last action
     C                     Z-ADDW@RYMD    IFLDAT           Last Act.Date
     C                     MOVE 'PHON'    IFBKCD           Broker Code
     C                     MOVE *ALL'9'   IFBRKG           Broker Amt
     C                     TIME           IFTIME           Deal entry time
     C                     MOVE 'I'       IKMACT           MIDAS action
     C                     MOVE UDATE     IKMCHD
     C                     Z-ADDBJRDNB    IKDLAD
     C* Set up Transaction Date
     C                     Z-ADDW@RUCY    IFDTYY
     C                     Z-ADDW@RUNM    IFDTMM
     C                     Z-ADDW@RUND    IFDTDD
     C* Set up Interest Start/Last Date
     C                     Z-ADDIFVDYY    IFSLYY
     C                     Z-ADDIFVDMM    IFSLMM
     C                     Z-ADDIFVDDD    IFSLDD
     C* Set up Interest Accrual Control Date
     C                     Z-ADDIFVDYY    IFIAYY
     C                     Z-ADDIFVDMM    IFIAMM
     C                     Z-ADDIFVDDD    IFIADD
      *
     C                     MOVE 'HK'      IFRECI           Rec id
     C                     Z-ADDBJRDNB    IFLCD            Last change date
     C                     MOVE IFORBR    IKORBR
     C                     MOVE IFPRF1    IKPRFC
     C                     MOVE IFBOK1    IKBOKC
     C                     MOVE IFLNKR    IKLNKN
     C                     MOVE IFBRC2    IKPOBR
     C                     MOVE IFBRC2    IKROBR
     C*
     C**  Write First Deal
     C*
     C                     EXSR BBCVDL                     <Convert Deal>
     C*
     C** Write Dummy Linked Deal if no Errors
     C*
     C           W@ERCD    IFEQ *ZERO
     C*
     C** Write Second Deal
     C*
     C                     MOVE IFDLNO    IKDADN
     C                     MOVE IFPRF2    IKPRFC
     C                     MOVE IFBOK2    IKBOKC
     C                     MOVE IFBRC1    IKPOBR
     C                     MOVE IFBRC1    IKROBR
     C                     Z-SUBIFPCPL    IFPCPL
     C                     Z-SUBIFTOTI    IFTOTI
     C                     Z-SUBIFIMAT    IFIMAT
     C                     MOVE IFDADN    IFDLNO
     C                     MOVE IKDADN    IFDADN
     C                     MOVE IFBRC2    IFBRC1
     C                     MOVE IFBRC2    IFDBRC
     C                     MOVE IFCUS2    IFCUS1
     C                     MOVE IFCSN2    IFCSN1
     C                     MOVE IFDTP2    IFDTP1
     C                     MOVE IFDTP2    IFTYPE
     C                     MOVE IFSTP2    IFSTP1
     C*
     C                     EXSR BBCVDL                     <Convert Deal>
     C*
     C           W@ERCD    IFEQ *ZERO
     C                     COMIT
     C*                                                                   066308
     C**  Set up successful insertion message.                            066308
     C*                                                                   066308
     C           @MAN      IFNE 'Y'                                       066308
     C                     MOVE '1'       *IN59                           066308
     C                     WRITE#MSG                                      066308
     C                     MOVE '0'       *IN59                           066308
      *                                                                   066308
     C                     END                                            066308
      *                                                                   066308
     C                     EXSR BCRSET
      *
     C                     ELSE
     C                     ROLBK                             Roll Back
     C                     RETRN                             Exit
     C                     END
      *
     C                     ELSE
     C                     ROLBK                             Roll Back
     C                     RETRN                             Exit
     C                     END
      *
     C                     END
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         AHEXIT    ENDSR
      /EJECT
     CSR         AICNFD    BEGSR
      *==================================================== Called from:
      * Delete confirmed - delete record                *64 *MAIN
      *----------------------------------------------------
      *
     C                     MOVE '0'       *IN64            Reset ind.
      *
      ** If Action Not Confirmed or Changed
      *
     C           *IN05     IFEQ '0'                        NO CONFIRM
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0112' P@MGID           I:Unconfirmed
     C/COPY WNCPYSRC,AB0340C013
     C*
     C                     ELSE                            OK
      *
      ** If Screen changed before confirmation
      *
     C           ##ACCD    IFNE 'D'                        ACTION<>"D"
     C           @#DLA     ORNE @#DLC
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0128' P@MGID             I:Message ID
     C                     MOVE '1'       *IN30
     C                     ELSE                             NO CHANGE
      *
      ** Set up Fixed data for Deletion
      *
     C                     MOVE 'D'       IFDDLT           Last Change type
     C                     MOVE 'D'       IFLACT           Last action
     C                     MOVELPGUSER    IFLUID           Last User code
     C*
     C                     Z-ADDBJRDNB    IKDLAD           Last Change date
     C                     MOVE UDATE     IKMCHD
     C                     MOVE 'R'       IKMACT           MIDAS action
      *
      * Lock Deal for Update
      *
     C                     MOVE ##DLNO    W@DLNO
     C           W@DLNO    CHAINMMDEAULL             9796  Internal deals
     C*
     C** No record Found
     C*
     C           *IN97     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0167' P@MGID
     C                     MOVE '1'       *IN30
     C                     ELSE
      *
     C**  If *IN96 is on then the record is locked.
      *
     C           *IN96     IFEQ '1'
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DLNO    @DATA2
     C                     MOVE '1'       *IN30
     C                     CALL 'ZA0440'
     C                     PARM 'MMM1011' P@MGID
     C                     PARM           @DATA
     C                     ELSE
      *
     C**  If any of the date and time fields have changed since
     C**  the file was initially read, then the record has been
     C**  updated by another workstation.
     C           IFDLUP    IFNE HKDLUP
     C           IFMLUP    ORNE HKMLUP
     C           IFYLUP    ORNE HKYLUP
     C           IFTLUP    ORNE HKTLUP
     C*
     C**  - If last change type is A update was an amendment.
     C           HKLACT    IFEQ 'A'
     C                     MOVEL'MMM1013' P@MGID
     C                     END
     C*
     C**  - If last change type is D update was an deletion.
     C           HKLACT    IFEQ 'D'
     C                     MOVEL'MMM1014' P@MGID
     C                     END
     C*
     C**  Set up error output to screen.
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DLNO    @DATA2
     C                     CALL 'ZA0440'
     C                     PARM           P@MGID
     C                     PARM           @DATA
     C                     MOVE '1'       *IN30
     C*
     C**  Release locked record
     C                     EXCPT@RLSFL
     C**  Re-Enquire upon Updated record
     C/COPY WNCPYSRC,AB0340C031
     C                     EXSR ADVFYE
     C                     ELSE
     C**  Update First Deal
     C                     MOVE IFORBR    IKORBR
     C                     MOVE IFPRF1    IKPRFC
     C                     MOVE IFBOK1    IKBOKC
     C                     MOVE IFLNKR    IKLNKN
     C                     MOVE IFBRC2    IKPOBR
     C                     MOVE IFBRC2    IKROBR
     C*
     C                     EXSR BBCVDL                     <Convert Deal>
     C*
     C**  Check Second deal if no errors
     C*
     C           W@ERCD    IFEQ *ZERO
     C*
      ** Lock Linked Deal for Update
      *
     C                     MOVE ##DADN    W@DADN
     C           W@DADN    CHAINMMDEAULL             9796  Internal deals
     C*
     C** No record Found
     C*
     C           *IN97     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0167' P@MGID
     C                     MOVE '1'       *IN34
     C                     ELSE
      *
     C**  If *IN96 is on then the record is locked.
      *
     C           *IN96     IFEQ '1'
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DADN    @DATA2
     C                     MOVE '1'       *IN34
     C                     CALL 'ZA0440'
     C                     PARM 'MMM1011' P@MGID
     C                     PARM           @DATA
     C                     ELSE
      *
     C**  If any of the date and time fields have changed since
     C**  the file was initially read, then the record has been
     C**  updated by another workstation.
     C           IFDLUP    IFNE HKDLUP
     C           IFMLUP    ORNE HKMLUP
     C           IFYLUP    ORNE HKYLUP
     C           IFTLU2    ORNE HKTLUP
     C*
     C**  - If last change type is A update was an amendment.
     C           HKLACT    IFEQ 'A'
     C                     MOVEL'MMM1013' P@MGID
     C                     END
     C*
     C**  - If last change type is D update was a deletion.
     C           HKLACT    IFEQ 'D'
     C                     MOVEL'MMM1014' P@MGID
     C                     END
     C*
     C**  Set up error output to screen.
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DADN    @DATA2
     C                     CALL 'ZA0440'
     C                     PARM           P@MGID
     C                     PARM           @DATA
     C                     MOVE '1'       *IN34
     C*
     C**  Release locked record
     C*
     C                     EXCPT@RLSFL
     C                     ELSE
     C**  Update Second Deal
     C*
     C                     MOVE IFDLNO    IKDADN
     C                     MOVE IFPRF2    IKPRFC
     C                     MOVE IFBOK2    IKBOKC
     C                     MOVE IFBRC1    IKPOBR
     C                     MOVE IFBRC1    IKROBR
     C                     MOVE IFDADN    IFDLNO
     C                     MOVE IKDADN    IFDADN
     C                     MOVE IFBRC2    IFBRC1
     C                     MOVE IFBRC2    IFDBRC
     C                     MOVE IFCUS2    IFCUS1
     C                     MOVE IFCSN2    IFCSN1
     C                     MOVE IFDTP2    IFTYPE
     C                     MOVE IFDTP2    IFDTP1
     C                     MOVE IFSTP2    IFSTP1
     C                     Z-SUBIFPCPL    IFPCPL
     C                     Z-SUBIFTOTI    IFTOTI
     C                     Z-SUBIFIMAT    IFIMAT
     C*
     C                     EXSR BBCVDL                     <Convert Deal>
      * Comit if no errors
     C           W@ERCD    IFEQ *ZERO
     C                     COMIT
      *
      **  Set up successful Deletion message.
      *
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DLNO    @DATA2
     C                     CALL 'ZA0440'                     <SEND MSG.>
     C                     PARM 'MMM1017' P@MGID             I:Deleted
     C                     PARM           @DATA
     C                     MOVEL##DADN    @DATA2
     C                     CALL 'ZA0440'                     <SEND MSG.>
     C                     PARM 'MMM1017' P@MGID             I:Deleted
     C                     PARM           @DATA
      *
     C**  Re-Enquire upon Deleted record
     C                     EXSR ADVFYE
      *
     C                     ELSE
     C                     ROLBK
     C                     RETRN
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ELSE
     C                     ROLBK
     C                     RETRN
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         AIEXIT    ENDSR
      /EJECT
     CSR         AJCNFA    BEGSR
      *==================================================== Called from:
      * Amend confirmed - Amend record                  *64 *MAIN
      *----------------------------------------------------
      *
     C                     MOVE '0'       *IN65                Reset ind.
      ** If Action Confirmed and Screen Changed
     C/COPY WNCPYSRC,AB0340C020
      *
     C           *IN02     IFEQ '0'                         CONFIRMED
     C*
     C           ##ACCD    IFNE 'A'                         ACTION<>"A"
     C           @#DLA     ORNE @#DLB                         CHANGED
     C                     CALL 'ZA0240'
     C                     PARM 'ABM0129' P@MGID
     C/COPY WNCPYSRC,AB0340C014
     C                     ELSE
     C*
      * Complete Deal Format:
      *
     C                     MOVE 'A'       IFLACT           Last action
     C                     MOVELPGUSER    IFLUID           Last User code
     C                     MOVELPGUSER    IFAOFR           Auth. officer
     C*
     C                     Z-ADDBJRDNB    IKDLAD           Last Change date
     C                     MOVE UDATE     IKMCHD
     C                     MOVE 'A'       IKMACT           MIDAS action
     C*
     C** Lock first Deal Number for Update
     C*
     C                     MOVE ##DLNO    W@DLNO
     C           W@DLNO    CHAINMMDEAULL             9796    Loan Deal
     C*
     C** No record Found
     C*
     C           *IN97     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0167' P@MGID
     C                     MOVE '1'       *IN30
     C                     ELSE
      *
     C**  If *IN79 is on then the record is locked.
      *
     C           *IN96     IFEQ '1'
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DLNO    @DATA2
     C                     MOVE '1'       *IN30
     C                     CALL 'ZA0440'
     C                     PARM 'MMM1011' P@MGID
     C                     PARM           @DATA
     C                     ELSE
      *
     C**  If any of the date and time fields have changed since
     C**  the file was initially read, then the record has been
     C**  updated by another workstation.
     C           IFDLUP    IFNE HKDLUP
     C           IFMLUP    ORNE HKMLUP
     C           IFYLUP    ORNE HKYLUP
     C           IFTLUP    ORNE HKTLUP
     C*
     C**  - If last change type is A update was an amendment.
     C           HKLACT    IFEQ 'A'
     C                     MOVEL'MMM1013' P@MGID
     C                     END
     C*
     C**  - If last change type is D update was an deletion.
     C           HKLACT    IFEQ 'D'
     C                     MOVEL'MMM1014' P@MGID
     C                     END
     C*
     C**  Set up error output to screen.
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DLNO    @DATA2
     C                     CALL 'ZA0440'
     C                     PARM           P@MGID
     C                     PARM           @DATA
     C                     MOVE '1'       *IN30
     C*
     C**  Release locked record
     C                     EXCPT@RLSFL
     C*
     C**  Re-Enquire upon Updated record
     C/COPY WNCPYSRC,AB0340C032
     C                     EXSR ADVFYE
     C*
     C                     ELSE
     C**  Update First Deal
     C                     MOVE IFORBR    IKORBR
     C                     MOVE IFPRF1    IKPRFC
     C                     MOVE IFBOK1    IKBOKC
     C                     MOVE IFLNKR    IKLNKN
     C                     MOVE IFBRC2    IKPOBR
     C                     MOVE IFBRC2    IKROBR
     C*
     C                     EXSR BBCVDL
     C*
     C**  Check Second deal if no errors
     C*
     C           W@ERCD    IFEQ *ZERO
     C*
     C** Lock Linked deal Number for Update
     C*
     C                     MOVE ##DADN    W@DLNO
     C           W@DLNO    CHAINMMDEAULL             9796    Link Deal
     C*
     C** No record Found
     C*
     C           *IN97     IFEQ '1'
     C                     CALL 'ZA0240'
     C                     PARM 'MMM0167' P@MGID
     C                     MOVE '1'       *IN34
     C                     ELSE
      *
     C**  If *IN79 is on then the record is locked.
      *
     C           *IN96     IFEQ '1'
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DADN    @DATA2
     C                     MOVE '1'       *IN34
     C                     CALL 'ZA0440'
     C                     PARM 'MMM1011' P@MGID
     C                     PARM           @DATA
     C                     ELSE
      *
     C**  If any of the date and time fields have changed since
     C**  the file was initially read, then the record has been
     C**  updated by another workstation.
     C           IFDLUP    IFNE HKDLUP
     C           IFMLUP    ORNE HKMLUP
     C           IFYLUP    ORNE HKYLUP
     C           IFTLU2    ORNE HKTLUP
     C*
     C**  - If last change type is A update was an amendment.
     C           HKLACT    IFEQ 'A'
     C                     MOVEL'MMM1013' P@MGID
     C                     END
     C*
     C**  - If last change type is D update was an deletion.
     C           HKLACT    IFEQ 'D'
     C                     MOVEL'MMM1014' P@MGID
     C                     END
     C*
     C**  Set up error output to screen.
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DADN    @DATA2
     C                     CALL 'ZA0440'
     C                     PARM           P@MGID
     C                     PARM           @DATA
     C                     MOVE '1'       *IN34
     C*
     C**  Release locked record
     C                     EXCPT@RLSFL
     C**
     C                     ELSE
     C** Convert and Update files
     C*
     C                     MOVE IFDLNO    IKDADN
     C                     MOVE IFPRF2    IKPRFC
     C                     MOVE IFBOK2    IKBOKC
     C                     MOVE IFBRC1    IKPOBR
     C                     MOVE IFBRC1    IKROBR
     C                     MOVE IFDADN    IFDLNO
     C                     MOVE IKDADN    IFDADN
     C                     MOVE IFBRC2    IFBRC1
     C                     MOVE IFBRC2    IFDBRC
     C                     MOVE IFCUS2    IFCUS1
     C                     MOVE IFCSN2    IFCSN1
     C                     MOVE IFDTP2    IFTYPE
     C                     MOVE IFDTP2    IFDTP1
     C                     MOVE IFSTP2    IFSTP1
     C                     Z-SUBIFPCPL    IFPCPL
     C                     Z-SUBIFTOTI    IFTOTI
     C                     Z-SUBIFIMAT    IFIMAT
     C*
     C                     EXSR BBCVDL
     C*
      * Commit if no errors
     C           W@ERCD    IFEQ *ZERO
     C                     COMIT
     C/COPY WNCPYSRC,AB0340C033
      *
      **  Set up successful Amend message.
      *
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVEL##DLNO    @DATA2
     C                     CALL 'ZA0440'                     <SEND MSG.>
     C                     PARM 'MMM1016' P@MGID             I:Amended
     C                     PARM           @DATA
     C                     MOVEL##DADN    @DATA2
     C                     CALL 'ZA0440'                     <SEND MSG.>
     C                     PARM 'MMM1016' P@MGID             I:Amended
     C                     PARM           @DATA
     C/COPY WNCPYSRC,AB0340C015
      *
     C**  Re-Enquire upon Updated record
     C                     EXSR ADVFYE
     C/COPY WNCPYSRC,AB0340C016
      *
     C                     ELSE
     C                     ROLBK
     C                     RETRN
     C**
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ELSE
     C                     ROLBK
     C                     RETRN
     C**
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         AJEXIT    ENDSR
      /EJECT
     CSR         BAALCD    BEGSR
      *==================================================== Called from:
      * Process: P32 Allocate Deal numbers                  AHCNFI
      *
      * Output : P@DLNO 6,0   Deal number
      *----------------------------------------------------
      *
     C           *IN90     DOUEQ'0'
     C           1         SETLLCADLFALL                     Close file
     C                     READ CADLFALL                 90  Read  file
     C           *IN90     IFEQ '0'                        DLNO FOUND
     C                     Z-ADDFKDN38    P@DLNO  60         Deal number
     C                     DELETCADLFAP0               90    Delete rec.
     C                     ELSE                            NO DEAL NO.
     C                     CALL 'CA0040'               91    <REGENERATE>
     C                     PARM           @@TERM  1          O:Return code
     C           *IN91     IFEQ '1'                        CALL ERROR
     C           @@TERM    OREQ 'E'                         OR PGM.ERROR
     C                     ROLBK                                          E19346
     C                     RETRN                             Exit program
     C                     END
     C                     END
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         BAEXIT    ENDSR
      /EJECT
     CSR         BBCVDL    BEGSR
      *==================================================== Called from:
      * Process: P20 File Update processing                 AHCNFI AICNFD
      *          P21 File Write processing                  AJCNFA
      *----------------------------------------------------
      * Move IF deal format to Standard Deal format :
      *
     C                     MOVE W@INS1    W@SLD1
     C                     MOVE W@INS2    W@SLD2
      *
     C                     MOVE 'IK'      IKRCID
     C                     MOVE IFDLNO    IKPCDN
     C                     Z-ADD*ZERO     W@ERCD  10
     C                     Z-ADDW@RYMD    IKLDAT           Last Act.Date
     C                     Z-ADD@DLUP     IKDLUP
     C                     MOVE @MLUP     IKMLUP
     C                     Z-ADD@YLUP     IKYLUP
     C                     TIME           IKTLUP           Deal entry time
     C*
      * Update the Databases for the Loan
     C*
     C**  Update the front office files for Deal.
     C                     CALL 'MM0078'                 90
     C                     PARM           @TERM   1
     C                     PARM 'L'       @TDIN   1
     C                     PARM           @SLDS
     C**********           PARM           @SSDS                           095040
     C                     PARM           @SBDS
     C                     PARM           @SSDS                           095040
     C                     PARM           @SADS
     C                     PARM           Z#BSTS                          093795
     C                     PARM           Z#ASTS                          093795
     C                     PARM           Z#WSTS                          093795
      *
     C           *IN90     IFEQ '1'
     C           @TERM     ORNE *BLANK
     C                     Z-ADD1         W@ERCD             Error
     C                     GOTO BBEXIT                       Exit--->
     C                     END
      *
     C/COPY WNCPYSRC,AB0340C001
     C**  Call the program to update the MIDAS files for Deal.
     C*******              CALL 'MM0082'                                  093795
     C                     CALL 'MM0083'                                  093795
     C                     PARM           @TERM
     C                     PARM 'L'       @TDIN                           S01319
     C                     PARM           @SLDS                           S01319
     C************         PARM           @SSDS                     S01319095040
     C                     PARM           @SBDS                           S01319
     C                     PARM           @SSDS                           095040
     C                     PARM           @SADS                           S01319
     C                     PARM           @RACD   1                       047114
     C                     PARM           Z#BSTS                          093795
     C                     PARM           Z#ASTS                          093795
     C                     PARM           Z#WSTS                          093795
     C                     PARM *BLANK    @@AURO  1                       095040
     C/COPY WNCPYSRC,AB0340CCP1                                           S01408
      *
     C           *IN90     IFEQ '1'
     C           @TERM     ORNE *BLANK
     C                     Z-ADD1         W@ERCD
     C                     END
      *====================================================
     CSR         BBEXIT    ENDSR
      /EJECT
     CSR         BCRSET    BEGSR
      *==================================================== Called from:
      * Process: P14 Abort Transaction processing           AGPREV ZZINIT
      *          Reset volatile fields and indicators
      *----------------------------------------------------
      *
     C           *IN74     IFEQ '0'
     C                     CLEAR@#DLB
     C                     MOVE @#DLB     @#DLA
     C                     MOVE @#DLB     @#DLC
     C                     END
     C                     CLEAR@SLDS
     C                     CLEAR@STDL
     C                     CLEAR@DLDS
     C                     Z-ADD*ZERO     @DDYNO
     C                     Z-ADD*ZERO     @VDYNO
     C                     Z-ADD*ZERO     @MDYNO
     C                     Z-ADD*ZERO     @NDYNO
     C                     Z-ADD*ZERO     @@MDNO
      *
      * Reset the 'Deleted Deal' message indicator :
      *
     C                     MOVEA'00000'   *IN,62           Reset ind.
     C/COPY WNCPYSRC,AB0340C017
      *
      *----------------------------------------------------
      *====================================================
     CSR         BCEXIT    ENDSR
      /EJECT
     CSR         BDFTOS    BEGSR
      *==================================================== Called from:
      * Move Fields from Database file to Screen            AASLCT ACVFYD
      *                                                     ADVFYE AENEXT
      *                                                     AFPREV
      *----------------------------------------------------
      *
     C                     MOVE IFDTP1    ##DTP1           Deal type 1
     C                     MOVE IFDTP2    ##DTP2           Deal type 2
     C                     MOVE IFSTP1    ##STP1           Sub-type 1
     C                     MOVE IFSTP2    ##STP2           Sub-type 2
     C                     MOVE IFBRC1    ##BRC1           Branch code1
     C                     MOVE IFBRC2    ##BRC2           Branch code2
     C                     MOVE IFORBR    ##ORBR           OriginatingBrch
      *
     C                     MOVE IFPRF1    ##PRF1           Profit Centre 1
     C                     MOVE IFPRF2    ##PRF2           Profit Centre 2
     C                     MOVE IFBOK1    ##BOK1           Book Code 1
     C                     MOVE IFBOK2    ##BOK2           Book Code 1
      *
     C                     MOVE IFDADN    ##DADN           Assoc Deal No.
     C                     MOVE IFDLNO    ##DLNO           1st.Deal No.
     C                     MOVE IFBRTT    ##BRTT           Base Rate Code
     C                     MOVE IFICBS    ##ICBS           Int Cala Basis
     C                     MOVE IFIPFR    ##IPFR           Int P.Freq code
     C                     MOVE IFCPTI    ##CPTI           Int Capitalise?
     C           IFINTF    IFNE *ZERO
     C                     MOVE IFINTF    ##INTF           Int Freq Day
     C                     ELSE
     C                     MOVE *BLANKS   ##INTF           Int Freq Day
     C                     END
      *
      * Convert Dates to DD/MM/YY format
      *
     C                     Z-ADDIFDDYY    #D103              Deal Date Year
     C                     Z-ADDIFVDYY    #V103              Value Date Year
     C                     Z-ADDIFMDYY    #M103              Mat. Date Year
     C                     Z-ADDIFNIYY    #N103              Int. Date Year
     C                     Z-ADDIFNIYY    #N103              Int. Date Year
      *
     C           BJDFIN    IFEQ 'M'
      *
     C                     Z-ADDIFDDDD    #D102              Deal Day
     C                     Z-ADDIFVDDD    #V102              Value Day
     C                     Z-ADDIFMDDD    #M102              Mat. Day
     C                     Z-ADDIFNIDD    #N102              Int. Day
     C                     Z-ADDIFDDMM    #D101              Deal Month
     C                     Z-ADDIFVDMM    #V101              Value Month
     C                     Z-ADDIFMDMM    #M101              Mat. Month
     C                     Z-ADDIFNIMM    #N101              Int. Month
     C                     ELSE
     C                     Z-ADDIFDDDD    #D101              Deal Day
     C                     Z-ADDIFVDDD    #V101              Value Day
     C                     Z-ADDIFMDDD    #M101              Mat. Day
     C                     Z-ADDIFNIDD    #N101              Int. Day
     C                     Z-ADDIFDDMM    #D102              Deal Month
     C                     Z-ADDIFVDMM    #V102              Value Month
     C                     Z-ADDIFMDMM    #M102              Mat. Month
     C                     Z-ADDIFNIMM    #N102              Int. Month
     C                     END
      *
      * Edit Call/Notice Days
      *
     C           51        OCUR @#CCY
     C                     Z-ADD*ZERO     W@DECP
     C                     Z-ADDIFNTCE    @@AMTW
     C                     EXSR BJEDIT
     C                     MOVE @@AMTP    ##NTCE
     C           IFNTCE    IFEQ *ZERO
     C                     MOVE '0'       ##NTCE
     C                     END
     C           IFNTCE    IFEQ -999
     C                     MOVE *BLANK    ##NTCE
     C                     END
      *
      * Check Currency
      *
     C                     Z-ADD1         Z
     C           IFCCY     LOKUP@CY,Z                    92
      *
     C           *IN92     IFEQ '0'
     C           '   '     LOKUP@CY,Z                    92
     C           *IN92     IFEQ '0'
     C                     Z-ADD50        Z                  set to last
     C                     END
      *
      * Obtain Currency decimal places :
      ** Access Currencies file via access program
     C                     CALL 'AOCURRR0'
     C                     PARM '*DBERR ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM IFCCY     @A6KEY
     C           SDCURR    PARM SDCURR    DSSDY
     C           @RTCD     IFNE *BLANKS
     C                     MOVEL'SDCURRPD'DBFILE
     C                     MOVE '011'     DBASE               reporting
     C                     MOVELIFCCY     DBKEY
     C                     SETON                     U7U8LR  Switches
     C                     RETRN                             Exit program
     C                     END
      *
     C           Z         OCUR @#CCY
     C                     MOVE A6CYCD    @CY,Z              Currency
     C                     Z-ADDA6NBDP    W@DECP             Dec.places
     C                     Z-ADDA6SPRT    W@SPRT             Spot rate
     C                     MOVE A6MDIN    W@MDIN             Mult/Div.ind.
     C                     MOVE A6SCEX    W@SCEX             Scaling Expo
     C                     MOVE A6DICB    W@ICBS             Int.Calc.Mth.
     C                     END
      *
     C           Z         OCUR @#CCY
     C                     MOVE IFCCY     ##CCY              currency
      *
     C           IFPCPL    IFLT 0
     C                     Z-SUBIFPCPL    @@AMTW           Amount
     C                     ELSE
     C                     Z-ADDIFPCPL    @@AMTW           Amount
     C                     END
     C                     EXSR BJEDIT                     <Convert>
     C                     MOVE @@AMTP    ##AMNP           To display
      *
     C           IFTOTI    IFLT 0
     C                     Z-SUBIFTOTI    @@AMTW           Amount
     C                     ELSE
     C                     Z-ADDIFTOTI    @@AMTW           Amount
     C                     END
     C                     EXSR BJEDIT                     <Convert>
     C                     MOVE @@AMTP    ##TOTI           To display
     C*
     C** Scale the Exchange rate for display.
     C           W@SCEX    ADD  1         IN1
     C*
     C           IFBCXR    MULT @SF,IN1   W@SCRT
     C*
     C** Change Dec. places to 8 for Rates
     C           51        OCUR @#CCY
      *
     C                     Z-ADD8         W@DECP
     C                     Z-ADD*ZERO     @@AMTW           Amount
     C                     MOVE W@SCRT    @@AMTW           Amount
     C                     EXSR BJEDIT                     <Convert>
     C                     MOVE @@AMTP    ##BCXR           To display
      *
     C                     Z-ADD*ZERO     @@AMTW           Amount
     C           IFBRTT    IFEQ *BLANKS
     C                     MOVE IFIIRT    @@AMTW           Interest Rate
     C                     ELSE                              or
     C                     MOVE IFRTSP    @@AMTW           Spread
     C                     END
     C                     Z-ADD7         W@DECP
     C           @@AMTW    IFEQ *ZERO
     C                     MOVE *BLANK    ##RTSP
     C                     ELSE
     C                     EXSR BJEDIT                     <Convert>
     C                     MOVE @@AMTP    ##RTSP           To display
     C                     END
     C*
     C** Restore Dec. places Dealt currency
     C*
     C           Z         OCUR @#CCY
      *
     C** Blank Zero Dates
     C           ##MDAT    IFEQ '000000'
     C                     MOVE *BLANKS   ##MDAT
     C                     END
     C           ##NIDT    IFEQ '000000'
     C                     MOVE *BLANKS   ##NIDT
     C                     END
      *
     C** Blank Zero Linked Deal Ref.
     C           IFLNKR    IFEQ *ZERO
     C                     MOVE *BLANKS   ##LNKR
     C                     ELSE
     C                     MOVE IFLNKR    ##LNKR
     C                     END
      *
      * Get Profit centre Descriptions, if used
      *
     C           BKPRCU    IFEQ 'Y'
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##PRF1    @DSKEY  4
     C           SDPRFC    PARM SDPRFC    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE *BLANK    ##PCD1
     C                     ELSE
     C                     MOVELDSPCDS    ##PCD1
     C                     END
      *
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM ##PRF2    @DSKEY  4
     C           SDPRFC    PARM SDPRFC    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE *BLANK    ##PCD2
     C                     ELSE
     C                     MOVELDSPCDS    ##PCD2
     C                     END
     C                     END
      *
      * Set 'Deleted/Matured' STATUS:
      *
     C                     MOVEA'0000'    *IN,62
      *
     C           IFDSTS    IFNE 'A'
     C                     MOVE 'MATURED' ##STAT
     C                     MOVE '1'       *IN63            63=Del/Mat
     C                     END
     C           IFDDLT    IFEQ 'D'
     C                     MOVE 'DELETED' ##STAT
     C                     MOVE '1'       *IN63            63=Del/Mat
     C                     END
      *
      * Set Action indicators:
      *
     C           ##ACCD    IFEQ 'D'
     C           ##ACCD    OREQ 'E'
     C           *IN63     OREQ '1'
     C           ##ACCD    ANDNE'I'
     C                     MOVEA'00'      *IN,60
     C                     ELSE
     C                     MOVE '1'       *IN61
     C           ##ACCD    IFEQ 'A'
     C                     MOVE '1'       *IN60
     C                     END
     C                     END
      *
     C* Store Deal number and screen for later checking
     C                     MOVE ##DLNO    W@DLNO
     C                     MOVE ##DADN    W@DADN
     C                     MOVEL@#DLA     @#DLB
     C                     MOVEL@#DLA     @#DLC
     C                     MOVEAW@OF28    *IN,23
     C                     MOVEAW@OF08    *IN,51
      *
      *----------------------------------------------------
      *====================================================
     CSR         BDEXIT    ENDSR
      /EJECT
     CSR         BHCINT    BEGSR
      *==================================================== Called from:
      * Calculate Interest                                  ABVFYI
      *
      * Input  : @@AMTW 15,0  Principal Amount
      *          @@CALC 1     Interest Calculation method
      *          @@RATE 11,7  Interest Rate
      * Output : @@INTR 15,0  Interest 15,0
      *
      * Interest Calculation Methods :
      *
      *    1 - Actual Days / 365
      *    2 - Actual Days / 360
      *    3 - 360 Day Year (30 Day Month) / 360
      *    4 - Actual Days (excluding Feb.29th.) / 365
      *    5 - Actual Days (excluding Feb.29th.) / 360
      *    6 - Actual Days / 366
      *----------------------------------------------------
      *
     C           *LIKE     DEFN IFINTR    @@RATE            Define
     C           *LIKE     DEFN IFICBS    @@CALC            fields
      *
     C                     EXSR BICIND                     <Calc.Int.days>
      *
     C           @@CALC    IFEQ '2'                        IF  METHOD 2
     C           @@CALC    OREQ '3'                         OR    "   3
     C           @@CALC    OREQ '5'                         OR    "   5
     C           @@AMTW    DIV  36000     @@WDIV 155
     C                     Z-ADD36000     @@YEAR  50
     C                     END
      *
     C           @@CALC    IFEQ '1'                        IF  METHOD 1
     C           @@CALC    OREQ '4'                         OR    "   4
     C           @@AMTW    DIV  36500     @@WDIV
     C                     Z-ADD36500     @@YEAR
     C                     END
      *
     C           @@CALC    IFEQ '6'                        IF  METHOD 6
     C           @@AMTW    DIV  36600     @@WDIV
     C                     Z-ADD36600     @@YEAR
     C                     END
      *
     C           @@WDIV    MULT @@RATE    @@W155 155
     C*
     C**  MULTIPLY @@WDIV BY @@YEAR TO GET ORIGINAL AMOUNT. THE RESULT
     C**  COULD DIFFER FROM THE ORIGINAL DUE TO ROUNDING ERROR ON
     C**  DIVISION.
     C           @@WDIV    MULT @@YEAR    @@AMTR 151
     C*
     C**  CALCULATE THE ERROR AND DO SAME ARITHMETICAL OPERATIONS AS ON
     C**  @@AMT ABOVE.
     C           @@AMTW    SUB  @@AMTR    @@ERR  159
     C                     MULT @@RATE    @@ERR
     C                     DIV  @@YEAR    @@ERR
     C*
     C**  ADD RESULT FROM ERROR CALCULATIONS BACK TO THE RESULT FROM
     C**  CALCULATIONS ON PRINCIPAL AMOUNT.
     C                     ADD  @@ERR     @@W155
     C*
     C**  MULTIPLY BY THE PERIOD TO OBTAIN THE INTEREST.
     C           @@W155    MULT @@INDY    @@INTR 150H
     C*
      *----------------------------------------------------
      *====================================================
     CSR         BHEXIT    ENDSR
      /EJECT
     CSR         BICIND    BEGSR
      *==================================================== Called from:
      * Calculate the number of interest days               BHCINT
      *
      * Input  : @@BEG  5,0   Start date of period
      *          @@YY1  4,0     "   year
      *          @@MM1  2,0     "   month
      *          @@DD1  2,0     "   day
      *          @@END  5,0   End date of period
      *          @@YY2  4,0     "   year
      *          @@MM2  2,0     "   month
      *          @@DD2  2,0     "   day
      *          @@CALC 1     Interest Calculation method
      * Output : @@INDY 5,0   Number of Interest Days
      *====================================================
      *
     C                     Z-ADD*ZEROS    @@INDY
     C                     Z-ADD*ZEROS    @@LPNM
      *
      * Actual days - no special processing :
      *
     C           @@CALC    IFEQ '1'                        IF  METHOD 1
     C           @@CALC    OREQ '2'                         OR    "   2
     C           @@CALC    OREQ '6'                         OR    "   6
     C           @@END     SUB  @@BEG     @@INDY  50         Actual Days
     C                     GOTO BIEXIT                       Exit Subr--->
     C                     END
      *
     C           @@END     SUB  @@BEG     @@WDAT  50         Actual Days
     C*
     C                     Z-ADD@@BEG     @@MDNO  50
     C                     EXSR ZA0710
     C                     Z-ADD@@VLDT    @@DATA
     C*
     C                     Z-ADD@@END     @@MDNO
     C                     EXSR ZA0710
     C                     Z-ADD@@VLDT    @@DATB
     C*
     C*  IF IN SAME MONTH
     C           @@YY1     IFEQ @@YY2
     C           @@MM1     IFEQ @@MM2
     C           @@DD2     SUB  @@DD1     @@INDY
     C                     GOTO BIEXIT
     C                     END
     C                     END
     C*
     C           @@CALC    IFEQ '3'
     C*  CALC NO. DAYS IN FIRST MONTH
     C           30        SUB  @@DD1     @@P1    50   90
     C*  IF < 0, INITIALISE TO 0
     C   90                Z-ADD*ZEROS    @@P1
     C*
     C*  CALC. NO. DAYS IN LAST MONTH
     C           @@DD2     IFLE 30
     C                     Z-ADD@@DD2     @@P2    50
     C                     ELSE
      *                    ****
     C                     Z-ADD30        @@P2
     C                     END
     C*  CALC NO. DAYS IN INTERVENING MONTHS
     C           @@YY2     IFEQ @@YY1
     C           @@MM2     SUB  @@MM1     @@P3    50
     C                     SUB  1         @@P3
     C                     MULT 30        @@P3
     C                     ELSE
     C*                    ****
     C           @@YY2     SUB  @@YY1     @@P3
     C                     SUB  1         @@P3
     C                     MULT 360       @@P3
     C*
     C* FIND NO. OF MONTHS FOR THE TWO PARTIAL YEARS
     C           12        SUB  @@MM1     @@WN5A  50
     C                     MULT 30        @@WN5A
     C*
     C           @@MM2     SUB  1         @@WN5
     C           @@WN5     MULT 30        @@WN5
     C*  ACCUMULATE
     C           @@WN5A    ADD  @@WN5     @@WN5A
     C           @@P3      ADD  @@WN5A    @@P3
     C                     END
     C*  FINAL SUM
     C*
     C           @@P1      ADD  @@P2      @@INDY
     C                     ADD  @@P3      @@INDY
     C                     END
     C*  FOR METHODS 4 AND 5
     C*
     C           @@CALC    IFEQ '4'
     C           @@CALC    OREQ '5'
     C*   CALCULATE NUMBER OF LEAP YEARS BETWEEN START AND END DATES
     C           @@MM1     IFLE 2
     C           @@YY1     DIV  4         @@WN5   50
     C                     MVR            @@WN5          90
     C*  ADD 1 IF LEAP YEAR
     C   90                ADD  1         @@LPNM  50
     C                     END
     C*  BYPASS IF YEARS ARE THE SAME
     C           @@YY1     IFEQ @@YY2
     C           @@WDAT    SUB  @@LPNM    @@INDY
     C                     GOTO BIEXIT                     ---------->
     C                     END
     C*  LOOP TO CALCULATE NO. LEAP YEARS
     C           @@YY1     DOWNE@@YY2
     C*  INCREMENT START YEAR
     C                     ADD  1         @@YY1
     C*
     C           @@YY1     IFEQ @@YY2
     C           @@MM2     IFGT 2
     C           @@YY2     DIV  4         @@WN5
     C                     MVR            @@WN5          90
     C*  INCREMENT IF LEAP YEAR
     C   90                ADD  1         @@LPNM
     C                     END
     C           @@WDAT    SUB  @@LPNM    @@INDY
     C                     END
     C           @@YY1     IFNE @@YY2
     C           @@YY1     DIV  4         @@WN5
     C                     MVR            @@WN5          90
     C*  ADD 1 IF LEAP YEAR
     C   90                ADD  1         @@LPNM
     C                     END
     C                     END
     C                     END
     C*
      *----------------------------------------------------
      *====================================================
     CSR         BIEXIT    ENDSR
      /EJECT
     CSR         BJEDIT    BEGSR
      *==================================================== Called from:
      * Convert numeric amount to edited alpha              AASLCT ABVFYI
      * This is a reworking of ZA0920, altered to allow the BCRSET BDFTOS
      * editing of maximum-length and negative fields.      BEBCE1 BFBCE2
      *
      * Input  :  @@AMTW 15,0  Amount
      *           W@DECP 1,0   Decimal places
      * Output :  @@AMTD 17    Edited amount (signed)
      *     or :  @@AMTP 16    Edited amount (unsigned)
      *----------------------------------------------------
      *
     C                     MOVE *BLANK    @@AMTD           Init.O'put
     C                     SETOF                       91  Init.Inds.
      *
     C           W@DECP    IFEQ *ZERO                      IF NO DEC.POS.
     C                     Z-ADD2         P1      20         Start pos.
     C                     Z-ADD*ZERO     @@QECW  30         Start decimal
     C                     ELSE                             DEC.PLACES
     C                     Z-ADD1         P1                 Start pos.
     C           16        SUB  W@DECP    @@QECW             Start decimal
     C                     END
      *
     C           @@AMTW    IFLT *ZERO                      IF NEGATIVE
     C           *ZERO     SUB  @@AMTW    @@AMTW             Make positive
     C                     MOVE '-'       @@AMTD             Negative
     C                     END
      *
     C           1         DO   15        P2      20       DO EDIT
      *                    |
     C           W@DECP    IFNE *ZERO                      IF    DECIMAL
     C           P1        ANDEQ@@QECW                     AND   POSITION
     C                     MOVE '.'       @Z,P1              Decimal point
     C                     ADD  1         P1         91      Incr.ptr.Z
     C                     END
      *                    |
     C           *IN91     IFEQ '0'                        IF    LEADING
     C           @Q,P2     ANDEQ*ZERO                       AND  ZERO
     C                     MOVE *BLANK    @Z,P1              Blank
     C                     ELSE                            IN NUMBER
     C                     MOVE @Q,P2     @Z,P1              Valid data
     C                     SETON                     91      In number
     C                     END
      *                    |
     C                     ADD  1         P1                 Incr.ptr.Z
      *                    |
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         BJEXIT    ENDSR
      /EJECT
     CSR         ZA0840    BEGSR
      *==================================================== Called from:
      * Convert Alpha to Numeric                            ABVFYI BEBCE1
      *                                                     BFBCE2
     C*           This subroutine will take as input a 16A field      *
     C*           a 1N number of integers and a 1N number of decimal  *
     C*           places. Ignoring the leading and trailing blanks    *
     C*           it will ensure that the field contains only numeric *
     C*           characters and a decimal point, and that it has no  *
     C*           embedded blanks, or more than one decimal point.    *
     C*           It will also check that the number of figures before*
     C*           and after the decimal point do not exceed the input *
     C*           parameters. The subroutine will output the number as*
     C*           a 16A field and a 15N field, along with an error    *
     C*           code. The alpha field will be right aligned with    *
     C*           the leading zeros blanked, and trailing blanks zero *
     C*           filled. The number returned will be 15 long with 0  *
     C*           decimal places. The error code will contain 0 if    *
     C*           there was no error, 1 if there was a non-numeric    *
     C*           character found, and 2 if the number of decimal     *
     C*           places are wrong.                                   *
     C*                                                               *
     C*  Input  : @@ALPH - 16A field containing the field to validate *
     C*           @@IDP  - number of decimal places                   *
     C*           @@IINT - number of integers                         *
      *           @@MTID - Millions/Thousands id (Y = function on)    *
     C*                                                               *
     C*  Output : @@ALPH - 16A field for display                      *
     C*           @@AMT  - 15N field for calculation                  *
     C*           @@ERCD - 1N error code                              *
     C*                                                               *
     C*  Uses   : @F     - array of 16 elements 1 character long      *
     C*           @G     - array of 16 elements 1 character long      *
     C*           @@CADP - calculated number of decimal places        *
     C*           @@CINT - calculated number of integers              *
     C*           @@PIDP - position of dp in input array              *
     C*           @@PODP - position of dp in output array             *
     C*           @@C    - index for array @F                         *
     C*           @@D    - index for array @G                         *
     C*           @@WK7  - workfield used for converting array element*
     C*                    to a 1N number.                            *
     C*           @H     - array containing powers of 10              *
     C*           @@E    - index to array @H                          *
     C*           @@WK5  - work field                                 *
     C*           @@ALP1 - feild used to right align 0 decimal places *
      *           @@MIEA - maximum input elements allowed             *
      *           @@FEL  - first integer element of array @F          *
      *           @@MTF  - millions or thousands (M or T) flag        *
      *           @@S    - counter                                    *
      *           @@S1   - number of decimals after the decimal place *
      *           @@S2   - counter                                    *
      *           @@MRTS - tests decimal elements for M or T          *
     C*****************************************************************
     C*
     C** initialize the fields and the arrays
     C                     MOVE '0'       *IN81
     C                     MOVE '0'       *IN82
     C                     MOVE 'N'       @@MTF   1
     C                     MOVE 'N'       @@MRT   1
     C                     MOVE ' '       @@MRTS  1
     C                     Z-ADD0         @@ERCD  10
     C                     Z-ADD0         @@AMT  150
     C                     MOVEA*BLANKS   @G
     C                     MOVEA@@ALPH    @F
     C                     MOVE *BLANKS   @@ALPH 16
     C                     Z-ADD0         @@WK7   10
     C                     Z-ADD0         @@CADP  30
     C                     Z-ADD0         @@CINT  30
     C                     Z-ADD0         @@PIDP  30
     C                     Z-ADD0         @@PODP  30
     C                     Z-ADD0         @@C     20
     C                     Z-ADD0         @@D     20
     C                     Z-ADD0         @@E     20
     C                     Z-ADD0         @@K     20
     C                     MOVE @@MTID    @@MTID  1
     C*
     C** define the input fields
     C           *LIKE     DEFN @@CADP    @@IDP
     C           *LIKE     DEFN @@CINT    @@IINT
     C*
     C** first check that the number input will not produce a number
     C** output with more than 15 figures.
     C           @@IDP     ADD  @@IINT    @@WK2   20
     C           @@WK2     IFGT 15                         B1
     C                     Z-ADD2         @@ERCD           *1
     C                     GOTO ZA0849                     *1
     C                     END                             E1
     C*
     C** work through input array, ignoring leading zeros and blanks,
     C** also blanking the leading zeros in the input array.
     C                     MOVE '0'       *IN83
     C                     ADD  1         @@C
     C           @@C       DOWLE16                         B1
     C           *IN83     ANDEQ'0'                        *1
     C           @F,@@C    IFNE ' '                        B*2
     C           @F,@@C    ANDNE'0'                        **2
     C                     MOVE '1'       *IN83            **2
     C                     SUB  1         @@C              **2
     C                     END                             E*2
     C                     ADD  1         @@C              **2
     C                     END                             E1
      * Following code removed. As the code above ignores 0 then @@C
      * currently contains the first non-zero element.
      * If first integer is a zero subtract 1 from @@C to provide
      * correct first integer element of the array.
     C           @@C       IFNE 1
     C                     SUB  1         @@C
     C           @F,@@C    IFNE '0'
     C                     ADD  1         @@C
     C                     END
     C                     END
     C                     Z-ADD@@C       @@FEL   20
     C*
     C** check the integer part of the number for valid characters.
     C           @@C       DOWLE16                         B1
     C           @F,@@C    ANDNE'.'                        *1
     C           @F,@@C    ANDNE' '                        *1
     C*
     C** check for non numeric characters
      ** If @@MTID = Y ,allow M or T - for millions and thousands
      ** processing.
     C           @F,@@C    IFGT '9'                        B*2
     C           @F,@@C    ORLT '0'                        **2
     C           @F,@@C    IFEQ 'M'                        **2
     C           @@MTID    ANDNE'Y'
     C           @F,@@C    OREQ 'T'                        **2
     C           @@MTID    ANDNE'Y'
     C           @F,@@C    ORNE 'M'                        **2
     C           @F,@@C    ANDNE'T'
     C                     Z-ADD0         @@AMT            **2
     C                     Z-ADD1         @@ERCD           **2
     C                     GOTO ZA0849                     **2
     C                     END
     C*
     C                     ELSE                            X*2
     C*
     C           @F,@@C    IFNE 'M'
     C           @F,@@C    ANDNE'T'
     C                     ADD  1         @@CINT           **2
     C                     END
     C*
     C** check number of integers is not greater than that required
     C           @@CINT    IFGT @@IINT                     B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD2         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C** multiply the output amount by 10 then add the number in
     C** the input array element being processed.
     C           @F,@@C    IFNE 'M'
     C           @F,@@C    ANDNE'T'
     C           @@AMT     MULT 10        @@AMT            **2
     C                     MOVE @F,@@C    @@WK7            **2
     C           @@AMT     ADD  @@WK7     @@AMT            **2
     C                     END
     C                     END                             E*2
      *
      ** MT or TM etc not allowed.
      *
     C           @@MTF     IFEQ 'Y'
     C           @F,@@C    IFEQ 'M'
     C           @F,@@C    OREQ 'T'
     C                     Z-ADD0         @@AMT
     C                     Z-ADD1         @@ERCD
     C                     GOTO ZA0849
     C                     END
     C                     END
      *
     C           @F,@@C    IFEQ 'M'
     C                     MOVE 'Y'       @@MTF
     C           @@C       SUB  1         @@K
      * If M entered alone add 1 @@amt.
     C           @@AMT     IFEQ 0
     C           @F,@@K    ANDNE'0'
     C                     Z-ADD1         @@AMT
     C                     END
     C           @@AMT     MULT 1000000   @@AMT
     C                     Z-ADD6         @@MIEA  20
     C                     END
      *
     C           @F,@@C    IFEQ 'T'
     C                     MOVE 'Y'       @@MTF
     C           @@C       SUB  1         @@K
      * If T entered alone add 1 @@amt.
     C           @@AMT     IFEQ 0
     C           @F,@@K    ANDNE'0'
     C                     Z-ADD1         @@AMT
     C                     END
     C           @@AMT     MULT 1000      @@AMT
     C                     Z-ADD3         @@MIEA
     C                     END
     C*
     C** increase array index
     C                     ADD  1         @@C              *1
     C                     END                             E1
     C*
     C** set up position of decimal point in input array
     C                     Z-ADD@@C       @@PIDP
     C*
     C** if the character pointed to is a decimal point add 1 to the
     C** index
     C           @@C       IFLE 16                         B1
     C           @F,@@C    ANDEQ'.'                        *1
     C                     ADD  1         @@C              *1
     C                     MOVE '1'       *IN82            *1
     C                     END                             E1
      * Set Maximum input elements allowed to the correct figure.
     C           @@MTF     IFEQ 'Y'
     C           @@C       SUB  @@FEL     @@FEL
     C           @@FEL     ADD  @@MIEA    @@MIEA
     C                     ELSE
     C           @@C       SUB  @@FEL     @@MIEA
     C                     END
      *
      ** Read through array checking to see if there is an M or T.
     C                     Z-ADD@@C       @@S     20
     C                     Z-ADD@@C       @@S1    20
     C           @@S       DOWLE16
     C           @F,@@S    IFEQ 'M'
     C           @F,@@S    OREQ 'T'
     C                     MOVEA@F,@@S    @@MRTS
     C                     MOVE 'Y'       @@MRT
     C                     Z-ADD@@S       @@S2    20
     C                     END
     C                     ADD  1         @@S
     C                     END
      * Calculate the number of decimals after the decimal point.
     C           @@S2      SUB  @@S1      @@S1
      * In thousands - only 3 decimal places allowed.
     C           @@MRTS    IFEQ 'T'
     C           @@S1      IFGT 3
     C                     Z-ADD0         @@AMT
     C                     Z-ADD1         @@ERCD
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C                     END                             E**3
      * In millions  - only 6 decimal places allowed.
     C           @@MRTS    IFEQ 'M'
     C           @@S1      IFGT 6
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD1         @@ERCD
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C                     END                             E**3
     C*
     C** now validate the decimal part of the number
     C           @@C       DOWLE16                         B1
     C*
     C** if a blank is found set on the blank input indicator
     C           @F,@@C    IFEQ ' '                        B*2
     C                     MOVE '1'       *IN81            **2
     C                     END                             E*2
     C*
     C** if the figure is numeric, check that the number of decimal
     C** places does not exceed that specified, and that no blanks
     C** have been entered.
     C           @F,@@C    IFGE '0'                        B*2
     C           @F,@@C    ANDLE'9'                        **2
     C           @F,@@C    OREQ 'T'                        **2
     C           @@MTID    ANDEQ'Y'
     C           @F,@@C    OREQ 'M'                        **2
     C           @@MTID    ANDEQ'Y'
      *
     C           @@MRT     IFNE 'Y'
     C                     ADD  1         @@CADP           **2
     C                     END
     C*
     C           @@CADP    IFGT @@IDP                      B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD2         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C           *IN81     IFEQ '1'                        B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD1         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C** update output amount
     C           @F,@@C    IFNE 'M'
     C           @F,@@C    ANDNE'T'
     C           @@AMT     MULT 10        @@AMT            **2
     C                     MOVE @F,@@C    @@WK7            **2
     C                     ADD  @@WK7     @@AMT            **2
     C                     END
      * MT or TM etc not allowed.
     C           @@MTF     IFEQ 'Y'
     C           @F,@@C    IFEQ 'M'
     C           @F,@@C    OREQ 'T'
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD1         @@ERCD
     C                     GOTO ZA0849
     C                     END
     C                     END
      *
     C           @F,@@C    IFEQ 'M'
     C                     MOVE 'Y'       @@MTF
      * Multiply @@amt by the correct factor and add the number
      * digits to @@MIEA.
     C           @@S1      IFEQ 1
     C           @@AMT     MULT 1000000   @@AMT
     C                     ADD  6         @@MIEA
     C                     END
     C           @@S1      IFEQ 2
     C           @@AMT     MULT 100000    @@AMT
     C                     ADD  5         @@MIEA
     C                     END
     C           @@S1      IFEQ 3
     C           @@AMT     MULT 10000     @@AMT
     C                     ADD  4         @@MIEA
     C                     END
     C           @@S1      IFEQ 4
     C           @@AMT     MULT 1000      @@AMT
     C                     ADD  3         @@MIEA
     C                     END
     C           @@S1      IFEQ 5
     C           @@AMT     MULT 100       @@AMT
     C                     ADD  2         @@MIEA
     C                     END
     C           @@S1      IFEQ 6
     C           @@AMT     MULT 10        @@AMT
     C                     ADD  1         @@MIEA
     C                     END
      *
     C                     END
      *
     C           @F,@@C    IFEQ 'T'
     C                     MOVE 'Y'       @@MTF
      * Multiply @@amt by the correct factor and add the number
      * digits to @@MIEA.
     C           @@S1      IFEQ 1
     C           @@AMT     MULT 1000      @@AMT
     C                     ADD  3         @@MIEA
     C                     END
     C           @@S1      IFEQ 2
     C           @@AMT     MULT 100       @@AMT
     C                     ADD  2         @@MIEA
     C                     END
     C           @@S1      IFEQ 3
     C           @@AMT     MULT 10        @@AMT
     C                     ADD  1         @@MIEA
     C                     END
      *
     C                     END
     C*
     C                     ELSE                            X*2
     C*
     C** if the character is not numeric and not a blank then it is
     C** invalid
     C           @F,@@C    IFNE ' '                        B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD1         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C                     END                             E*2
     C*
     C** increase index
     C                     ADD  1         @@C              *1
     C*
     C                     END                             E1
      * Check that the number of elements input does not exceed allowed
     C           @@MIEA    ADD  @@IDP     @@MIEA
     C           @@MIEA    IFGT 14                         B1
     C                     Z-ADD2         @@ERCD           *1
     C                     GOTO ZA0849                     *1
     C                     END                             E1
     C*
     C** correct the output number for any decimal places not input
     C** in the alpha field.
     C           @@IDP     SUB  @@CADP    @@E
     C*
     C** increase the index by one to get correct array entry
      ** If @@IDP = 0 add 1 to @@E to prevent array index error.
     C           @@MRT     IFEQ 'N'
     C           @@IDP     OREQ 0
     C                     ADD  1         @@E
     C                     END
     C           @@AMT     MULT @H,@@E    @@AMT
      *
     C           @@MRT     IFEQ 'Y'
     C           @@IDP     ANDEQ0
     C           @@AMT     DIV  10        @@AMT
     C                     END
     C*
     C** now format the output alpha field, first calculate where
     C** the decimal point goes
     C           16        SUB  @@IDP     @@PODP
     C           @@PODP    SUB  1         @@PIDP
     C*
     C** if there are no decimal points set the position to 17
     C           @@IDP     IFEQ 0                          B1
     C                     Z-ADD17        @@PODP           *1
     C                     END                             E1
     C*
     C** move the output number into the input array
     C                     MOVEA*BLANKS   @F
     C                     MOVE @@AMT     @@AMTA 15
     C                     MOVEA@@AMTA    @F
     C*
     C** set up indexes
     C                     Z-ADD1         @@C
     C                     Z-ADD1         @@D
     C                     MOVE '0'       *IN80
     C*
     C** now fill up the output array
     C           @@D       DOWLE16                         B1
     C*
     C** insert decimal point if the position is found
     C           @@D       IFEQ @@PODP                     B*2
     C                     MOVE '.'       @G,@@D           **2
     C                     ADD  1         @@D              **2
     C                     END                             E*2
     C*
     C** insert the zero before the decimal point
     C           *IN80     IFEQ '0'                        B*2
     C           @@D       ANDEQ@@PIDP                     **2
     C           @F,@@C    ANDEQ'0'                        **2
     C                     MOVE '1'       *IN80            **2
     C                     MOVE '0'       @G,@@D           **2
     C                     END                             E*2
     C*
     C** blank leading zeros
     C           *IN80     IFEQ '0'                        B*2
     C           @F,@@C    ANDEQ'0'                        **2
     C                     MOVE ' '       @G,@@D           **2
     C                     END                             E*2
     C*
     C** move a normal character
     C           @F,@@C    IFGE '1'                        B*2
     C           @F,@@C    ANDLE'9'                        **2
     C                     MOVE @F,@@C    @G,@@D           **2
     C                     MOVE '1'       *IN80            **2
     C                     END                             E*2
     C*
     C** non blanked zero
     C           @F,@@C    IFEQ '0'                        B*2
     C           *IN80     ANDEQ'1'                        **2
     C                     MOVE '0'       @G,@@D           **2
     C                     END                             E*2
     C*
     C                     ADD  1         @@C              *1
     C                     ADD  1         @@D              *1
     C                     END                             E1
     C*
     C*
     C** put output array into output amount
     C                     MOVEA@G        @@ALPH
     C*
     C** align figure with zero decimal places.
     C           @@IDP     IFEQ 0                          B1
     C                     MOVE *BLANKS   @@ALP1 17        *1
     C                     MOVE @@ALPH    @@ALP1           *1
     C                     MOVEL@@ALP1    @@ALPH           *1
     C                     END                             E1
     C*                                                               *
      *----------------------------------------------------
      *====================================================
     C           ZA0849    ENDSR                           ZA0849 TAG
      /EJECT
     CSR         ZA0710    BEGSR
      *==================================================== Called from:
      * Convert MIDAS Day Number to date (YYYYMMDD)         ZZINIT
      *
      * Input  : @@MDNO 5,0   MIDAS Day number
      * Output : @@VLDT 8,0   Full date (YYYY/MM/DD format)
      *----------------------------------------------------
      *
     C                     Z-ADD*ZERO     @@VLDT
     C                     Z-ADD1         P1
      *
     C           @@MDNO    CABLT1         ZA0719           Inval.Dayno--->
      *
     C           @@MDNO    DIV  1461      @@Z71Y           4-Year periods
     C                     MVR            @@RDAY  50       Years remaining
      *
     C           @@Z71Y    MULT 4         @@Z71Y           Years in period
     C                     ADD  1972      @@Z71Y           Add offset
      *
     C           @@RDAY    LOKUP@YD,P1                 9090 Remaining Yrs.
      *
     C           *IN90     IFEQ '1'                        IF NOT LEAP
     C           @@RDAY    SUB  @YD,P1    @@RDAY             Adjust rem'dr
     C                     ADD  P1        @@Z71Y             Adjust year
     C                     ELSE                            EL LEAP YEAR
     C           @@RDAY    IFEQ 60                         IF 29TH.FEB.
     C                     Z-ADD29        @@Z71D             Day=29th.
     C                     Z-ADD2         @@Z71M             Month=Feb.
     C                     GOTO ZA0719                       Exit--->
     C                     END
     C           @@RDAY    IFGT 60                         IF AFTER FEB.
     C                     SUB  1         @@RDAY             Adj.Leap day
     C                     END
     C                     END
      *
     C           @@RDAY    IFEQ *ZERO                      IF NO REMAINDER
     C                     Z-ADD31        @@Z71D             Day=31st.
     C                     Z-ADD12        @@Z71M             Month=Dec.
     C                     SUB  1         @@Z71Y             Prev.Year
     C                     ELSE                            REMAINDER
     C           @@RDAY    LOKUP@MD,P1                 90    Find month
     C                     Z-ADDP1        @@Z71M             To O'put
     C           @@RDAY    SUB  @MD,P1    @@Z71D             Adjust days
     C                     END
      *
      *----------------------------------------------------
      *====================================================
     CSR         ZA0719    ENDSR
      /EJECT
     CSR         ZA1020    BEGSR
      *==================================================== Called from:
      * Convert Amount to display                           *AASLCT
      *----------------------------------------------------
     C*
     C**  Define and initialise fields used.
     C                     Z-ADD@@IAMT    @@IAMT 150
     C                     Z-ADD@@CRET    @@CRET  20
     C                     Z-ADD@@CDP     @@CDP   10
     C                     MOVE *BLANKS   @@ADSP 21
     C*
     C                     Z-ADD*ZEROS    @@C     20
     C                     Z-ADD*ZEROS    @@D     20
     C                     Z-ADD*ZEROS    @@E     20
     C                     Z-ADD*ZEROS    @@F     20
     C                     Z-ADD*ZEROS    @@G     20
     C                     Z-ADD*ZEROS    @@H     20
     C                     Z-ADD*ZEROS    @@MAX   20
     C                     Z-ADD*ZEROS    @@CNT1  20
     C                     Z-ADD*ZEROS    @@CNT2  20
     C                     Z-ADD*ZEROS    @@RES   20
     C                     Z-ADD*ZEROS    @@CMOV  20
     C                     Z-ADD*ZEROS    @@DIFF  20
     C                     Z-ADD*ZEROS    @@REMD  10
     C                     Z-ADD*ZEROS    @@MRET  20
     C*
     C**  Initialise arrays.
     C                     MOVEA*BLANKS   @C
     C                     MOVEA*BLANKS   @D
     C                     MOVEA*BLANKS   @E
     C*
     C**  Take modulus of input amount.
     C           @@IAMT    IFLT *ZERO
     C                     Z-SUB@@IAMT    @@IAMT
     C                     END
     C*
     C**  Move input amount to @D.
     C                     MOVEA@@AMDS    @D
     C*
     C**  Move decimal portion of amount to @E.
     C                     Z-ADD15        @@C
     C                     Z-ADD21        @@D
     C*
     C           21        SUB  @@CDP     @@MAX
     C           @@D       DOWGT@@MAX
     C                     MOVE @D,@@C    @E,@@D
     C                     SUB  1         @@C
     C                     SUB  1         @@D
     C                     END
     C*
     C**  Move decimal separator to @E.
     C           @@CDP     IFNE 0
     C                     MOVE '.'       @E,@@D
     C                     SUB  1         @@D
     C                     END
     C*
     C**  Find position of last character to be moved.
     C                     Z-ADD1         @@E
     C*
     C           @@E       DOWLT15
     C           @D,@@E    ANDEQ'0'
     C                     ADD  1         @@E
     C                     END
     C*
     C**  Move integer portion of amount to @E.
     C                     Z-ADD0         @@CNT1
     C                     Z-ADD0         @@CNT2
     C*
     C           @@C       DOWGT@@E
     C                     MOVE @D,@@C    @E,@@D
     C                     ADD  1         @@CNT1
     C                     SUB  1         @@C
     C                     SUB  1         @@D
     C*
     C**  Insert thousand separators.
     C           @@CNT1    DIV  3         @@RES
     C                     MVR            @@REMD
     C           @@REMD    IFEQ 0
     C           @@CNT2    ANDLT5
     C                     MOVE ','       @E,@@D
     C                     ADD  1         @@CNT2
     C                     Z-ADD@@D       @@F
     C                     SUB  1         @@D
     C                     END
     C                     END
     C*
     C**  Move last character.
     C                     MOVE @D,@@C    @E,@@D
     C*
     C**  Calculate the number of characters that must be returned.
     C           22        SUB  @@D       @@CMOV
     C           @@CMOV    SUB  @@CNT2    @@MRET
     C*
     C**  If number of characters to be returned is greater than the
     C**  number that must be returned.
     C           @@MRET    IFGT @@CRET
     C*
     C**  Output the required no. of characters, but all '*'.
     C           22        SUB  @@CRET    @@G
     C                     MOVEA*BLANKS   @E
     C                     MOVEA*ALL'*'   @E,@@G
     C                     GOTO ZA1028
     C                     END
     C*
     C**  If number of characters moved is greater than number to be
     C**  returned, drop thousand separators until satisfied.
     C           @@CMOV    SUB  @@CRET    @@DIFF
     C           @@DIFF    IFGT 0
     C                     DO   @@DIFF
     C                     Z-ADD1         @@G
     C                     Z-ADD2         @@H
     C           @@G       DOWLE21
     C                     MOVE @E,@@G    @C,@@H
     C                     ADD  1         @@G
     C                     ADD  1         @@H
     C           @@G       IFEQ @@F
     C                     ADD  1         @@G
     C                     END
     C                     END
     C                     MOVEA@C        @E
     C                     ADD  4         @@F
     C                     END
     C                     END
     C*
     C**  Tag ZA1028.
     C           ZA1028    TAG                             **ZA1028**
     C*
     C**  Move @E to display field.
     C                     MOVEA@E        @@ADSP
     C*
      *----------------------------------------------------
      *====================================================
     C           ZA1029    ENDSR                           **ZA1029**
      /EJECT
     CSR         ZZINIT    BEGSR
      *==================================================== Called from:
      * Process: P02 Initial processing                     *MAIN
      *----------------------------------------------------
      *
      * statement to avoid compilation error, exercise designed to
      * include copyright statement within the object code generated
     C                     MOVEACPY@      BIS@   80
     C**
     C**  GET ZMUSER to access default branch.
     C**
     C           *NAMVAR   DEFN           ZMUSER
     C                     IN   ZMUSER
     C                     UNLCKZMUSER
     C**
     C**  GET RUNDAT to access MULTI-BRANCHING flag.
     C**
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
     C           @MBIN     IFEQ 'Y'
     C                     SETON                     18
     C                     END
      *
     C                     SETON                     73    Msg.S'File ind.
     C                     MOVE PGNAME    DBPGM            For DB Error
      *
      * Access Bank Installation Control Data :
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*DBERR ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDBANK    PARM SDBANK    DSFDY
     C           @RTCD     IFNE *BLANKS
     C                     MOVEL'SDBANKPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     MOVEL@OPTN     DBOPTN  7
     C                     MOVE '006'     DBASE                        g
     C                     SETON                     U7U8LR
     C                     RETRN                                       am
     C                     END
      *
     C                     MOVE 'I'       ##ACCD
     C                     MOVEA'01'      *IN,60
     C           '(I,A,D'  CAT  ',E)':0   ##LIST
      *
      ** Access SDGELRPD
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS
     C                     MOVE '1'       *INKC                        ***
     C                     MOVEL'SDGELRPD'DBFILE                         *
     C                     MOVEL@OPTN     DBKEY
     C                     MOVEL@OPTN     DBOPTN
     C                     MOVE '009'     DBASE
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
      *
      * Access  SDTRADPD Installation Data :
      *
     C                     CALL 'AOTRADR0'
     C                     PARM '*DBERR ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDTRAD    PARM SDTRAD    DSFDY
     C           @RTCD     IFNE *BLANKS
     C                     MOVEL'SDTRADPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     MOVEL@OPTN     DBOPTN
     C                     MOVE '008'     DBASE                        g
     C                     SETON                     U7U8LR
     C                     RETRN                                       am
     C                     END
     C/COPY WNCPYSRC,AB0340C034
      *
      * Read LF/FDDLNMLL Deal Number Ranges :
      *
     C                     OPEN FDDLNMLL
     C                     READ FDDLNMLL               9090
     C                     CLOSEFDDLNMLL
      *
     C           *IN90     IFEQ '1'                        IF NRF/ERR
     C                     MOVEL'FDDLNMLL'DBFILE              DB Error
     C                     MOVE '010'     DBASE                        g
     C                     SETON                     U7U8LR
     C                     RETRN                             Exit program
     C                     END
      *
      * Read LF/FDMNTHLL Month names:
      *
     C                     OPEN FDMNTHLL
     C                     READ FDMNTHLL               9090
     C                     CLOSEFDMNTHLL
      *
     C           *IN90     IFEQ '1'                        IF NRF/ERR
     C                     MOVEL'FDMNTHLL'DBFILE
     C                     MOVE '007'     DBASE                        g
     C                     SETON                     U7U8LR
     C                     RETRN                             Exit program
     C                     END
      *
      * Set defaults for first time :
      *
     C                     MOVE *ALL'0'   W@OF28 28        Ind.reset field
     C                     MOVE *ALL'0'   W@OF08  8        Ind.reset field
     C                     MOVEAW@OF28    *IN,23             Error inds.
     C                     MOVEAW@OF08    *IN,51             Error inds.
     C           @MBIN     IFEQ 'Y'
     C           BKOBRU    ANDEQ'Y'
     C                     MOVE '1'       *IN19
     C                     ELSE
     C                     END
     C           BKPRCU    IFEQ 'Y'
     C                     MOVE '1'       *IN20
     C                     END
     C                     MOVE BJMRDT    ##RDAT           Screen Run date
     C                     MOVE BJMRDT    MRUNDT           Last Update
     C                     Z-ADDBJRDNB    @@MDNO           Run Day no.
     C                     EXSR ZA0710                     <Convert>
     C                     Z-ADD@@VLDT    W@RYMD           Run YYYYMMDD
     C                     EXSR BCRSET                     <Reset screen>
     C*                                                                   110978
     C** CALCULATE DATE VERSUS BACK VALUE LIMIT                           110978
     C*                                                                   110978
     C           *LIKE     DEFN BJRDNB    BACKVA                          110978
     C           BJRDNB    SUB  BJBVPD    BACKVA                          110978
      *                                                                   CSD025
      ** Check if enhancement CSD025 is installed                         CSD025
      *                                                                   CSD025
     C                     CALL 'AOSARDR0'                                CSD025
     C                     PARM *BLANKS   PRTCD   7                       CSD025
     C                     PARM '*VERIFY' POPTN   7                       CSD025
     C                     PARM 'CSD025'  PSARD   6                       CSD025
     C           SCSARD    PARM SCSARD    DSSDY                           CSD025
      *                                                                   CSD025
     C           PRTCD     IFNE *BLANKS                                   CSD025
     C           PRTCD     ANDNE'*NRF   '                                 CSD025
     C                     MOVEL'CSD025'  DBKEY                           CSD025
     C                     MOVEL'SCSARDPD'DBFILE                          CSD025
     C                     MOVEL@OPTN     DBOPTN                          CSD025
     C                     Z-ADD5         DBASE                           CSD025
     C                     SETON                     U7U8LR               CSD025
     C                     RETRN                                          CSD025
     C                     ENDIF                                          CSD025
      *                                                                   CSD025
     C           PRTCD     IFEQ *BLANKS                                   CSD025
     C                     MOVE 'Y'       CSD025                          CSD025
     C                     ELSE                                           CSD025
     C                     MOVE 'N'       CSD025  1                       CSD025
     C                     ENDIF                                          CSD025
      *
     C/COPY ZSRSRC,DFTTSTAMPC                                                                 208955
      *----------------------------------------------------
      *====================================================
     CSR         ZZEXIT    ENDSR
     C/EJECT
     CSR         INFSR     BEGSR
      *==================================================== Called from:
      * Error reporting for write to deals file             *ERROR
      *----------------------------------------------------
     C*
     C           STATUS    IFEQ 01021
     C*
     C**  Chain to the file using the key, to see if it already exists.
     C**  - *IN97 set on if the record is not found.
     C*
     C           W@DLNO    CHAINMMDEAULL             9796
     C*
     C**  If *IN97 is OFF, a valid record exist on file
     C*
     C           *IN97     IFEQ '0'
     C*
     C**  Clear program message queue.
     C                     CALL 'ZA0250'
     C                     ROLBK
     C*
     C** Send message - 'Record inserted by another workstation.'
     C                     MOVE *BLANKS   @DATA
     C           'Deal'    CAT  'Number':1@DATA1
     C                     MOVELHKDN38    @DATA2
     C                     CALL 'ZA0440'
     C                     PARM 'MMM1015' P@MGID
     C                     PARM           @DATA
     C*
     C**  Set up screen and work fields with entered values (i.e.
     C**  from chain to update file).
     C                     MOVE @#DLB     @#DLA
     C                     MOVE 'E'       ##ACCD
     C                     Z-ADD01021     STATUS
     C                     MOVE '*DETC '  EXTTAG
     C                     ELSE
     C                     MOVE '*CANCL'  EXTTAG  6
     C                     DUMP
     C                     END
     C                     ELSE
     C                     MOVE '*CANCL'  EXTTAG
     C                     DUMP
     C                     END
     C*
     C* If control is from linked enqiury, return code is set to          S01393
     C* 'E'                                                               S01393
     C           *IN68     IFEQ '1'                                       S01393
     C                     MOVE 'E'       P@TERM                          S01393
     C                     END                                            S01393
      *
      *----------------------------------------------------
      *====================================================
     CSR         INFSR9    ENDSREXTTAG
     C*
     CSR         *PSSR     BEGSR
      *==================================================== Called from:
      * Error reporting                                     *ERROR
      *----------------------------------------------------
      *
     C           @DUMP     IFEQ *BLANKS
     C                     MOVE 'Y'       @DUMP   1
     C                     DUMP                            Dump program
     C                     END
     C                     ROLBK                           Roll Back
     C                     SETON                     LRU8  Set switches
     C*                                                                   S01393
     C* If control is from linked enqiury, return code is set to          S01393
     C* 'E'                                                               S01393
     C           *IN68     IFEQ '1'                                       S01393
     C                     MOVE 'E'       P@TERM                          S01393
     C                     END                                            S01393
     C                     RETRN                           Exit program
      *
      *----------------------------------------------------
      *====================================================
     CSR         PSEXIT    ENDSR
      *
      /COPY ZSRSRC,ZACCH
      *
      /COPY ZSRSRC,ZCHKH
     C/COPY WNCPYSRC,AB0340C018
     OMMDLDUP0E                @RLSFL
** CPY@ Copyright statement
(c) Misys International Banking Systems Ltd. 2001
** @SF Scaling Factors array
0000000001
0000000010
0000000100
0000001000
0000010000
0000100000
0001000000
0010000000
0100000000
1000000000
** @YD Cumulative days in years over 4-year span
00366007310109601461
** @MD Cumulative days in months through year
00000000310005900090001200015100181002120024300273003040033400365
** array of powers of 10 from 0 to 8  @@H
000000000000001
000000000000010
000000000000100
000000000001000
000000000010000
000000000100000
000000001000000
000000010000000
000000100000000
000001000000000
000010000000000
000100000000000
001000000000000
010000000000000
100000000000000
