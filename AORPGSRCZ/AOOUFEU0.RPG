     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas AO On-line update of LE position files')         *
      *****************************************************************
      *                                                               *
      *  Midas - Access Objects Module                                *
      *                                                               *
      *  AOOUFEU0 - On-line Update of LE Positions files              *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. MD041443           Date 19Sep16               *
      *  Prev Amend No. CLE154             Date 06Aug12               *
      *                 AR868380           Date 10Jun13               *
      *                 AR996895           Date 25Nov12               *
      *                 AR1022006          Date 01Aug12               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CER049             Date 06Dec10               *
      *                 AR787620           Date 10Jun11               *
      *                 CLE139             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CLE073             Date 12May08               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      *                 CER047             Date 19May08               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 CAP205             Date 03Mar10               *
      *                 CAP204             Date 09Feb10               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246141             Date 26Mar07               *
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 BUG8628            Date 20Sep05               *
      *                 BUG8460            Date 03Sep05               *
      *                 BUG8567            Date 02Sep05               *
      *                 CLE038             Date 04Jun04               *
      *                 CIR013             Date 25Apr05               *
      *                 CLE025             Date 20Oct03               *
      *                 CRE020             Date 20Jan04               *
      *                 CSC022             Date 24Feb04               *
      *                 CGL029             Date 01Sep03               *
      *                 223922             Date 22Dec03               *
      *                 222373             Date 30Oct03               *
      *                 220257             Date 31Jul03               *
      *                 219608             Date 16Jul03               *
      *                 218992             Date 27Jun03               *
      *                 218782             Date 18Jun03               *
      *                 218338             Date 29May03               *
      *                 CLE035             Date 23May03               *
      *                 CLE034             Date 23May03               *
      *                 CLE033             Date 26Mar03               *
      *                 CLE031             Date 05Feb03               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 205328             Date 10Jun02               *
      *                 205222             Date 10Jun02               *
      *                 204452             Date 03May02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CLE013             Date 06Nov00               *
      * Midas DBA 3.04 -----------------------------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 163486             Date 14Oct99               *
      *                 CLE009             Date 26Apr99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 134284             Date  3Mar99               *
      *                 CEU004             Date 02Feb98               *
      *                 128565             Date 07Jan98               *
      *                 CLE005 *Create     Date 22May97               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD041443 - CBC022001 failed due to invalid character in file *
      *             text description (Recompile)                      *
      *  CLE154 - Loan Repayment Schedule Enhancement (Recompile)     *
      *  AR868380 - APISERVER on LCKW status. Return *RECLCK to       *
      *             calling program if file locking occurred on       *
      *             online position files. (Child: AR868381)          *
      *  AR996895 - Incorrect accrual interest calculation            *
      *             (Child: AR996897) (Recompile)                     *
      *  AR1022006 - COB Performance Optimisation                     *
      *  CLE134 - Past Due Call Loan Processing                       *
      *  CLE148 - Alpha Loan Reference                                *
      *  CER049 - Stamp Tax                                           *
      *  AR787620 - Hooks Incorporation                               *
      *             WNCPYSRC,AOH00001                                 *
      *  CLE139 - Lending Fee Capitalisation (Recompile)              *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CLE073 - Calculated Loan Based Fees                          *
      *           Applied core fix 220961 (if calc method 6 then      *
      *           INT6DY contains the number of days from ZINTDY).    *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *            to Midas Plus (Recompile)                          *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *                    (Recompile)                                *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  CAP204 - Teller Related APIs - Account Transfer              *
      *  246141 - Recompiled due to changes in ZINTDYZ2               *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type                              *
      *  BUG8628 - Loan fee amount is posted in the wrong account     *
      *  BUG8460- Incorrect commitment fee posted to LEHOSTPD         *
      *  BUG8567- Reverse action posted in LEHOSTPD during authorise  *
      *           transaction                                         *
      *  CLE038 - Lending Enhancement for Nordea: Allocation by Amount*
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over ZINTDY.                              *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CRE020 - Midas Plus Online Printing of Advices (GE7)         *
      *  CSC022 - Commitment Control Changes for MidasPlus            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  223922 - Shadow Postings were not updated when amending the  *
      *           Advice/Confirm indicator of the fee.                *
      *  222373 - Correct parameters on program calls                 *
      *  220257 - Negative amounts should be converted to positive on *
      *           LEHOSTPD and the Pay/Receive indicator changed      *
      *  219608 - Amendment of Settlement Allocations needs a 'Before'*
      *           image to ensure the right allocations are reversed. *
      *  218992 - For non nostro settlement methods, currency is not  *
      *           set up correctly when accessing account. This will  *
      *           mean that the account will not get updated          *
      *  218782 - Add Program ref, Sequence Number & Status fields to *
      *           LEHOSTPD. Check system value Settlement09Postings to*
      *           decide whether to use Settlement or Transaction Ccy.*
      *  218338 - Clear Transaction Type and Event Description fields.*
      *  CAP035 - Conversion of Midas inputs to modular API           *
      *           structure - Include new fields in file.             *
      *  CLE034 - Lending Enhancements for Phase 1 Priority 1A.       *
      *  CLE033 - Settlement method 09                                *
      *  CLE031 - Lending Enhancements.                               *
      *  205328 - Move loan no. or facility type/no. to ##TRN instead *
      *           of the fee transaction no.  ##VDAT should be the    *
      *           fee settlement date, not the fee start date.        *
      *  205222 - Also compute for the fee amount if last change type *
      *           is X (authorise).                                   *
      *  204452 - Recompiled due to changed PF/LEFEED.                *
      *  CLE013 - Customer Lending Fees Enhancements - Phase I        *
      *  163486 - Recompiled due to changes in LVENTL3 & LVENTL4.     *
      *  CLE009 - LE I/C Swift Message Generation for Fees            *
      *           Recompiled due to changes in LEFEED                 *
      *  134284 - Do not rollback lending updates in batch mode.      *
      *  CEU004 - LE Settlement Ccy Conversion Upgrade to DBA R2.0    *
      *  128565 - LDA is being incorrectly locked                     *
      *  CLE005 - New program for redesign of update to PRONO, MEMOS, *
      *           OLPOS & RSACMTPD.                                   *
      *                                                               *
      *****************************************************************
     FFCLTY   IF  E           K        DISK
     F            FCLTYHHF                          KIGNORE
     F            FCLTYZZF                          KIGNORE
     FRSACMTL1IF  E           K        DISK
     F            APOSTPDF                          KIGNORE
     FLVENTL3 IF  E           K        DISK
     F            LVENTELF                          KRENAMELVENTLF3
     FLVENTL4 IF  E           K        DISK
     F            LVENTELF                          KRENAMELVENTLF4
     FSDCURRPDIF  E                    DISK
     FLEHOSTPDO   E                    DISK                               CLE033
     F                                              KCOMIT                CLE033
      *  Subroutine stack
     F/COPY WNCPYSRC,AOOUFEU0F1
      *                                                                                       CLE073
     FCLOAN   IF  E           K        DISK                                                   CLE073
     F            CLOANHHF                          KIGNORE                                   CLE073
     F            CLOANCKF                          KIGNORE                                   CLE073
     F            CLOANZ1F                          KIGNORE                                   CLE073
     FCLOANK  IF  E           K        DISK                                                   CLE073
     F            CLOANCKF                          KRENAMECLOANCKK                           CLE073
     FLEHISTLAIF  E           K        DISK                                                   CLE073
     FLEHISTLBIF  E           K        DISK                                                   CLE073
      *                                                                                       CLE073
     E                    @STK       20 10
      *
      **  Copyright array.
     E                    ##CPY   1   1 80
     E                    TABCAL  6   6  1   TABCBS  5 0 CALC.BASES
     E                    POWER   1   7  7 3             POWER ARRAY
     E                    TABNOS  5   5  2               NOSTRO SETL TYPES
     E/COPY ZSRSRC,ZDATE9Z1                                               CLE013
     E                    FEEM        5 11 0A            FEE AMOUNTS
     E                    FAM         5 15 0A            FEE AMOUNTS
     E                    FRT         5  7 5A            FEE RATES
     E                    FPC         5  6 3A            FEE PERCENTAGE
     E                    RUN        10  5 0A            FUTURE DATES
     E                    OAM        10 13 0             FUTURE TOTAL DRAW
     E                    FFAM       10 13 0             FUTURE FACILITY A
     E                    CURR      150  3               ALL CCYS
     E                    CSPT      150 13 8             SPOT RATES/CCY
     E                    MTDV      150  1               M/D INDICATOR/CCY
     E                    CCDP      150  1 0             DEC PLACES/CCY
     E*                                                                   CLE033
     E**  System values array                                             CLE033
     E**********          SVAL    1   3 20                                             CLE033 218782
     E                    SVAL    1   4 20                                                    218782
      *                                                                                       CSC022
      ** Array for job name                                                                   CSC022
      *                                                                                       CSC022
     E                    JBNAM      10 10                                                    CSC022
     E/COPY WNCPYSRC,AOH00031
     E*                                                                   CLE033
     I/SPACE 5
      *                                                                                       CLE073
      *                                                                                       CLE073
     ICLOANCLF                                                                                CLE073
      ** Rename fields                                                                        CLE073
     I              RECI                            RECIL                                     CLE073
     I              LNRF                            LNRFL                                     CLE073
     I              CNUM                            CNUML                                     CLE073
     I              CPAM                            CPAML                                     CLE073
     I              ACOF                            ACOFL                                     CLE073
     I              RCSI                            RCSIL                                     CLE073
     I              CCY                             CCYL                                      CLE073
     I              BRCA                            BRCAL                                     CLE073
      *                                                                                       CLE073
     ICLOANCKK                                                                                CLE073
      ** Rename fields                                                                        CLE073
     I              RECI                            RECIK                                     CLE073
     I              LNRF                            LNRFK                                     CLE073
     I              OPAM                            OPAMK                                     CLE073
     I              ABLC                            ABLCK                                     CLE073
      *                                                                                       CLE073
     IHISTSHPF                                                                                CLE073
      ** Rename fields                                                                        CLE073
     I              RECI                            RECIP                                     CLE073
     I              RCDT                            RCDTP                                     CLE073
     I              BRCA                            BRCAP                                     CLE073
     I              CNUM                            CNUMP                                     CLE073
     I              LNRF                            LNRFP                                     CLE073
     I              VDAT                            VDATP                                     CLE073
     I              PRSQ                            PRSQP                                     CLE073
     I              LASN                            LASNP                                     CLE073
     I              CCY                             CCYP                                      CLE073
     I              AMTP                            AMTPP                                     CLE073
     I              PRAM                            PRAMP                                     CLE073
     I              LCD                             LCDP                                      CLE073
     I              CPAM                            CPAMP                                     CLE073
      *                                                                                       CLE073
     IHISTSHMF                                                                                CLE073
      ** Rename fields                                                                        CLE073
     I              RECI                            RECIM                                     CLE073
     I              RCDT                            RCDTM                                     CLE073
     I              BRCA                            BRCAM                                     CLE073
     I              CNUM                            CNUMM                                     CLE073
     I              LNRF                            LNRFM                                     CLE073
     I              VDAT                            VDATM                                     CLE073
     I              PRSQ                            PRSQM                                     CLE073
     I              LASN                            LASNM                                     CLE073
     I              CCY                             CCYM                                      CLE073
     I              AMTP                            AMTPM                                     CLE073
     I              PRAM                            PRAMM                                     CLE073
     I              LCD                             LCDM                                      CLE073
     I              CPAM                            CPAMM                                     CLE073
      *                                                                                       CLE073
     I/COPY WNCPYSRC,AOH00008
      *
     IZ#BSTS    E DSZ#BST
     IZ#ASTS    E DSZ#AST
     IZ#WSTS    E DSZ#WST
      *
     ILFEED     E DSLEFEED
     I              OMDB                            FEOMDB
     I              OSDB                            FEOSDB
     I              PONS                            FEPONS
     I              PONSQQ                          QQPONS                                    CGL029
     I              PSTM                            FEPSTM
     I              PTFI                            FEPTFI
     I              RONS                            FERONS
     I              RONSQQ                          QQRONS                                    CGL029
     I              RSTM                            FERSTM
     I              RIBN                            FERIBN                CLE033
     I              RIBA                            FERIBA                CLE033
     I              ROBN                            FEROBN                CLE033
     I              ROCN                            FEROCN                CLE033
     I              PIBN                            FEPIBN                CLE033
     I              PIBA                            FEPIBA                CLE033
     I              POBN                            FEPOBN                CLE033
     I              POCN                            FEPOCN                CLE033
     I              RCRN                            FERCRN                CLE033
     I              RCRA                            FERCRA                CLE033
     I              RVNO                            FERVNO                CLE033
     I              AWBN                            FEAWBN                CLE033
     I              AWBA                            FEAWBA                CLE033
     I              BENN                            FEBENN                CLE033
     I              BENA                            FEBENA                CLE033
     I              DTP1                            FEDTP1                CLE033
     I              DTP2                            FEDTP2                CLE033
     I              DTP3                            FEDTP3                CLE033
     I              DTP4                            FEDTP4                CLE033
     I              DCHG                            FEDCHG                CLE033
     I              BTB1                            FEBTB1                CLE033
     I              BTB2                            FEBTB2                CLE033
     I              BTB3                            FEBTB3                CLE033
     I              BTB4                            FEBTB4                CLE033
     I              BTB5                            FEBTB5                CLE033
     I              BTB6                            FEBTB6                CLE033
     I              CVMR                            FECVMR                CLE033
     I                                    P  72  915FRT
     I                                    P  92 1210FEEM
     ISVLFEE      DS                            990                                           CLE034
      *
     I/COPY WNCPYSRC,AOH00032
     I            DS
      ** On line positions settlement details to be posted
     I                                        1   2 STNOS
     I**********                              1  10 STANM                                     CGL029
     I                                        1  16 STANM                                     CGL029
     I                                        1   6 STCUS
     I**********                              7  10 STACD                                     CGL029
     I**********                             11  12 STSQN                                     CGL029
     I**********                              1  12 POSTB                                     CGL029
     I**********                             13  15 STCCY                                     CGL029
     I**********                             16  18 STBRC                                     CGL029
     I**********                             19  20 STSET                                     CGL029
     I                                        7  16 STACD                                     CGL029
     I                                       17  18 STSQN                                     CGL029
     I                                        1  18 POSTB                                     CGL029
     I                                       19  21 STCCY                                     CGL029
     I                                       22  24 STBRC                                     CGL029
     I                                       25  26 STSET                                     CGL029
      *
     I            DS
      ** On line positions account key
     I                                        1   6 ACCUS
     I**********                              1   60NCCUS                                     CSD027
     I                                        1   6 NCCUS                                     CSD027
     I**********                              7  10 ACACD                                     CGL029
     I**********                              7  100NCACD                                     CGL029
     I**********                             11  12 ACSQN                                     CGL029
     I**********                             11  120NCSQN                                     CGL029
     I**********                             13  15 ACBRC                                     CGL029
     I**********                             16  18 ACCCY                                     CGL029
     I**********                              1  18 ACCKEY                                    CGL029
     I                                        7  16 ACACD                                     CGL029
     I                                        7  160NCACD                                     CGL029
     I                                       17  18 ACSQN                                     CGL029
     I                                       17  180NCSQN                                     CGL029
     I                                       19  21 ACBRC                                     CGL029
     I                                       22  24 ACCCY                                     CGL029
     I                                        1  24 ACCKEY                                    CGL029
      *
     I            DS
      *** Availability Date data structure
     I                                    P   1  300RUN
     I                                    P   1   30RUN0
     I                                    P   4   60RUN1
     I                                    P   7   90RUN2
     I                                    P  10  120RUN3
     I                                    P  13  150RUN4
     I                                    P  16  180RUN5
     I                                    P  19  210RUN6
     I                                    P  22  240RUN7
     I                                    P  25  270RUN8
     I                                    P  28  300RUN9
      *
     I            DS
      *** Outstanding Amount data structure
     I                                    P   1  700OAM
     I                                    P   1   70OAM1
     I                                    P   8  140OAM2
     I                                    P  15  210OAM3
     I                                    P  22  280OAM4
     I                                    P  29  350OAM5
     I                                    P  36  420OAM6
     I                                    P  43  490OAM7
     I                                    P  50  560OAM8
     I                                    P  57  630OAM9
     I                                    P  64  700OA10
      *                                                                   CLE013
     IWDSJB       DS                            256                                           CSC022
     I                                        1   30COMMTN                                    CSC022
     I                                        4 103 COMMTJ                                    CSC022
      ** Commitment Control dataarea                                                          CSC022
      *                                                                                       CSC022
      *                                                                                       CLE031
     ISDCURR    E DSSDCURRPD                                                                  CLE031
      ** Currency details                                                                     CLE031
      *                                                                                       CLE031
     **                                                                                       CLE034
     ILESTAL    E DSLESTALPD                                                                  CLE034
      **  EXTERNAL DS FOR SETTLEMENT ALLOCATION DETAILS                                       CLE034
     I              RECI                            STRECI                                    CLE034
     I              LNRF                            STLNRF                                    CLE034
     I              CNUM                            STCNUM                                    CLE034
     I              PCRF                            STPCRF                                    CLE034
     I              VDAT                            STVDAT                                    CLE034
     I              LASQ                            STLASQ                                    CLE034
     I              PSTM                            STPSTM                                    CLE034
     I              PONS                            STPONS                                    CLE034
     I              POBR                            STPOBR                                    CLE034
     I              RSTM                            STRSTM                                    CLE034
     I              RONS                            STRONS                                    CLE034
     I              ROBR                            STROBR                                    CLE034
     I              RSCY                            STRSCY                                    CLE034
     I              TMST                            STTMST                                    CLE034
     I              REXR                            STREXR                                    CLE034
     I              REXI                            STREXI                                    CLE034
     I              PEXR                            STPEXR                                    CLE034
     I              PEXI                            STPEXI                                    CLE034
     I              PSCY                            STPSCY                                    CLE034
     I              SEQ                             STSEQ                                     CLE034
     I              PYBA                            STPYBA                                    CLE038
     I              PYAM                            STPYAM                                    CLE038
     I              RCBA                            STRCBA                                    CLE038
     I              RCAM                            STRCAM                                    CLE038
     I              CCY                             STLCCY                                    CLE038
     **                                                                                       CLE034
     I/COPY ZSRSRC,ZINTDYZ1                                               CLE013
     I/COPY ZSRSRC,ZDATE9Z2                                               CLE013
     I/COPY ZSRSRC,ZDAT10Z1                                               CLE013
      *
     I##PAYD      DS
     I                                        1   1 ##PAY
     I                                        2   3 ##PAYM
     I**********                              4  15 ##PAYA                                    CGL029
     I**********                             16  18 ##PAYB                                    CGL029
     I                                        4  21 ##PAYA                                    CGL029
     I                                       22  24 ##PAYB                                    CGL029
     I##RECD      DS
     I                                        1   1 ##REC
     I                                        2   3 ##RECM
     I**********                              4  15 ##RECA                                    CGL029
     I**********                             16  18 ##RECB                                    CGL029
     I                                        4  21 ##RECA                                    CGL029
     I                                       22  24 ##RECB                                    CGL029
     I##INTS      DS
     I                                        1   1 ##INPR
     I                                        2   3 ##INTM
     I**********                              4  15 ##INTA                                    CGL029
     I**********                             16  18 ##INTB                                    CGL029
     I                                        4  21 ##INTA                                    CGL029
     I                                       22  24 ##INTB                                    CGL029
     I##SETD      DS
      * pay/receive (P/R)
     I                                        1   1 ##PYRC
      * settlement method
     I                                        2   3 ##SETM
      * settlement account
     I**********                              4  15 ##SETA                                    CGL029
     I                                        4  21 ##SETA                                    CGL029
     I                                        4   5 ##NOSN
     I                                        4  13 ##ACNO
     I                                        4   9 ##CNUM
     I**********                             10  13 ##ACOD                                    CGL029
     I**********                             14  15 ##ACSQ                                    CGL029
     I                                       10  19 ##ACOD                                    CGL029
     I                                       20  21 ##ACSQ                                    CGL029
      * settlement branch
     I**********                             16  18 ##BRCA                                    CGL029
     I                                       22  24 ##BRCA                                    CGL029
      *
      *  Calling parameter data structure for AOSPOSU0
      *
     IC#DTA       DS                            256
      *  Account type N=nostro nbr F=Full nostro G=General Ledger
      *               P=Partial Ledger R= Retail Number  X= no settlement
     I                                        1   1 C#ATYP
      *               Full General Ledger - CNUM/CCY/ACOD/ACSQ
     I                                        2  19 C#ACCT
     I**********                              2   70C#CNU1                                    CSD027
     I                                        2   7 C#CNU1                                    CSD027
     I                                        8  10 C#CCY1
     I**********                             11  140C#ACO1                                    CGL029
     I                                       15  160C#ACS1
     I                                       17  19 C#BRC1
      *               Nostro number
     I                                        2   30C#NOSN
      *               Full Nostro - CCY/NOSN
     I                                        2   6 C#NOS
      *               Retail Number
     I                                        2  110C#ACNO
      *               Partial Account - CNUM/ACOD/ACSQ
     I**********                              2   70C#CNUM                                    CSD027
     I                                        2   7 C#CNUM                                    CSD027
     I**********                              8  110C#ACOD                                    CGL029
     I                                       12  130C#ACSQ
      *               Branch of account if Partial                      '
     I                                       14  16 C#BRCA
      *               OLPOS Incoming/Outgoing Indicator 'I' or 'O' or ' '
      *                     ' ' no OLPOS update
     I                                       24  24 C#IO
      *               Currency of transaction
     I                                       25  27 C#CCY
      *               Transaction Type
     I                                       28  29 C#TRYP
      *               Transaction Narrative
     I                                       30  59 C#NARR
      *               Cheque Number
     I                                       60  670C#CHQN
      *               FT transaction reference
     I                                       68  82 C#PREF
      *               DL/LE/GL/RE transaction reference
     I                                       83  88 C#TRN
      *               Movement amount
     I                                    P  89  960C#AMT
      *               Processing indicators Not blank = no update
      *                                     ' ' = Update
      *               Prono update indicator
     I                                       97  97 C#PRON
      *               Olpos update indicator
     I                                       98  98 C#OLPS
      *               Memos update indicator
     I                                       99  99 C#MEMS
      *               Rsacmtpd write indicator
     I                                      100 100 C#RSAC
      *               Module
     I                                      101 102 C#MOD
      *               Olpos record number to update
      *                     '02' for Interest movements
      *                     '03' for loans
     I                                      103 104 C#OLRC
      *               FT Memos ledger balance override
      *                        'Y' update ledger balance irrespective of
      *                        posting date
     I                                      105 105 C#FTOV
      *               Value date and posting date
     I                                    P 106 1080C#VDAT
     I                                    P 109 1110C#PSTD
      *               Override posting date correction
      *                        for forward valued items
      *                        'Y' prevents date being changed
     I                                      112 112 C#PSTO
      *               Indicator to show if removal allowed Y, N or " "
     I                                      113 113 C#RPST
      *               Removal set number
     I                                      114 1160C#RPNB
      *               Removal type "C" = Credit entries
      *                            "D" = Debit entries
     I                                      117 117 C#RTYP
      *               Booking branch
     I                                      118 120 C#BBRN
      *                                                                                       CGL029
      ** Account code for full general ledger                                                 CGL029
      *                                                                                       CGL029
     I                                      121 1300C#ACO1                                    CGL029
      *                                                                                       CGL029
      ** Account code for partial account                                                     CGL029
      *                                                                                       CGL029
     I                                      131 1400C#ACOD                                    CGL029
      *                                                                                       CAP204
      ** Other Transaction Reference                                                          CAP204
      *                                                                                       CAP204
     I                                      141 160 C#OTR1                                    CAP204
      *                                                                                       CAP205
      ** Movement type                                                                        CAP205
      *                                                                                       CAP205
     I                                      161 161 C#MTYP                                    CAP205
     I/COPY WNCPYSRC,AOH00002
      *                                                                                       CLE134
      ** Exception Reference Id/Number                                                        CLE134
      *                                                                                       CLE134
     I                                      162 164 C#XRFI                                    CLE134
     I                                      165 1740C#XRFN                                    CLE134
      *
     I##NARR      DS                             30
      ** Narrative, composed of fee sequence and fee code desc
     I                                        1   2 ##NSEQ
     I                                        3  28 ##NDES
      *
     I            DS
     I                                        1  30 NRTD
     I                                        1   2 NSEQ
     I                                        3  28 NDES
      ***********                                                         128565
     I***LDA*****   UDS                            256                    128565
     I***********                           134 141 DBFILE                128565
     I***********                           142 170 DBKEY                 128565
     I***********                           181 1830DBASE                 128565
     ILDA       E DSLDA                                                                       CSC022
     I*** Local data area for database error details                                          CSC022
      *
     ICPYR        DS
      ** Data Structure for Compilation - Copyright Insertion
     I                                        1  80 ##CPY
      *                                                                   CLE005
      *** SAR Details                                                     CLE005
      *                                                                   CLE005
     ISCSARD    E DSSCSARDPD                                              CLE005
     I              LCD                             LLCD                  CLE005
      *
     ISDBANK    E DSSDBANKPD
      ** External DS for Bank Details
      *
     I*                                                                   CLE033
     I*SDSVAL***E*DSSDSVALPD*                                                          CLE033 222373
      ****EXTERNAL*DS*FOR*SYSTEM*VALUES*                                               CLE033 222373
     ISDFEE     E DSSDFEEPD
      ** Fee Codes detail
      *
     ISDNOST    E DSSDNOSTPD
      ** External DS for Nostro Details
      *
     ISDMMOD    E DSSDMMODPD
      ** External DS with Midas Module Details
     I              BGRTBN                          RETF
      *
     ISDRETL    E DSSDRETLPD
     I              QQACCD                          QQACC1                                    CGL029
      ** External DS for Retail Details
      *
     IDWACCT    E DSACCNTAB
     I              FRNT                            @@RECI                                    CAP035
     I              AFRT                            @@AFRT                                    CAP035
     I              REPA                            @@REPA                                    CAP035
      ** External DS with General Ledger Account Details
      *
     ISDSTPD    E DSSDSTPDPD                                                                  CER049
      *                                                                                       CER049
     ILEFEQD    E DSLESTMPPD                                                                  CER049
      *                                                                                       CER049
     IDSFDY     E DSDSFDY
      ** Short data structure for access object
      *
     IDSSDY     E DSDSSDY
      ** Second DS for access programs, long data structure
      *
     IPSDS       SDS                                                                          CSC022
     I                                     *PROGRAM WDSPGM                                    CSC022
     I                                      244 253 WDSJOB                                    CSC022
     C/EJECT
      *****************************************************************
      * Process     :  MAINLINE                                       *
      * Function    :  Mainline processing                            *
      *                                                               *
      * Called by   :  None                                           *
      * Calls       :  SRINIT - Initial Processing - On First Call    *
      *                SRMAIN - Main Processing                       *
      *****************************************************************
      *
      ** Parameter list for current program invocation.
      *
     C           *ENTRY    PLIST
     C                     PARM           ##RTCD  7
     C                     PARM           Z#BSTS
     C                     PARM           Z#ASTS
     C                     PARM           Z#WSTS
     C                     PARM           LEFEQD                                              CER049
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'MAIN'    @STK,Q
      *
      *................................................................
      *
      ** Initial processing - Once Only
      *
     C           ##INIT    IFEQ *BLANK
     C                     EXSR SRINIT
     C                     MOVE 'Y'       ##INIT  1
     C                     ENDIF
      *
      ** Main processing
      *
     C                     EXSR SRMAIN
      *
      *................................................................
      *
      ** Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
     C/COPY WNCPYSRC,AOOUFEU0C4
      *
      ** Terminate program
      *
     C                     RETRN
      *****************************************************************
     C/EJECT
      *****************************************************************
      * Subroutine  :  SRMAIN                                         *
      * Function    :  Main processing                                *
      *                                                               *
      * Called by   :  Mainline                                       *
      * Calls       :  SRCLR  - Clear all postings in store           *
      *                SRFEED - Fees Input detail                     *
      *****************************************************************
     C           SRMAIN    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q       50
     C                     MOVEL'SRMAIN'  @STK,Q
      *
      *................................................................
      *
      ** Clear down all shadow postings in store (within AOSPOSU0)
      *
     C                     EXSR SRCLR
      *                                                                                      BUG8567
     C                     MOVE *BLANKS   #HPOST  1                                          BUG8567
      *
     C                     MOVELZ#BSTS    #BRCID  2
     C                     MOVELZ#ASTS    #ARCID  2
      *
      *-------------------------------------------------------------------
      *
      ** GENERATE 'BEFORE STATUS' ACCOUNT MOVEMENTS
      ** (if not insertion, when __RCID will be blank)
      *
     C           #BRCID    IFNE *BLANK
      *
     C                     MOVEL'YES'     ##REVI  3
      *
      ** Fees input detail
      *
     C                     MOVELZ#BSTS    LFEED
      *                                                                   CLE033
      * TNLU in reversals must be the new one, to match the loan status   CLE033
      *                                                                   CLE033
     C           CLE033    IFEQ 'Y'                                       CLE033
      *                                                                   CLE033
     C                     MOVELZ#ASTS    LFEED                           CLE033
     C                     Z-ADD0         W0TNLU  50                      CLE033
      *                                                                   CLE033
     C           FELCHT    IFEQ 'D'                                       CLE033
     C                     Z-ADDFETNLU    W0TNLU                          CLE033
     C                     ENDIF                                          CLE033
      *                                                                                      BUG8567
     C           FELCHT    IFEQ 'X'                                                          BUG8567
     C                     MOVE 'N'       #HPOST                                             BUG8567
     C                     ENDIF                                                             BUG8567
      *                                                                   CLE033
     C                     MOVELZ#BSTS    LFEED                           CLE033
      *                                                                   CLE033
     C           W0TNLU    IFNE 0                                         CLE033
     C                     Z-ADDW0TNLU    FETNLU                          CLE033
     C                     ENDIF                                          CLE033
      *                                                                   CLE033
     C                     ENDIF                                          CLE033
      *                                                                   CLE033
     C           FEAUTO    IFEQ 'Y'                                                           223922
      *                                                                                       CLE134
      ** FEAUTO = 'C' fee subject to funds check                                              CLE134
      *                                                                                       CLE134
     C           FEAUTO    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                                       CLE134
     C           FEAUT2    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C                     EXSR SRFEED
     C                     ENDIF                                                              223922
      *                                                                   CLE033
     C                     MOVE ##SETM    WBSETM  2                       CLE033
      *
     C                     ENDIF                           * Z#BSTS
      *-------------------------------------------------------------------
      *
      ** GENERATE 'AFTER STATUS' ACCOUNT MOVEMENTS
      ** (if not deletion, when __CHTP will be 'R')
      *
     C                     MOVEL*BLANK    ##REVI
      *
      ** Fees input detail
      *
     C                     MOVELZ#ASTS    LFEED
     C           FELCHT    IFNE 'D'
     C           FEAUTO    ANDEQ'Y'                                                           223922
      *                                                                                       CLE134
      ** FEAUTO/FEAUT2 = 'C', fee subject to funds check                                      CLE134
      *                                                                                       CLE134
     C           FELCHT    ORNE 'D'                                                           CLE134
     C           FEAUTO    ANDEQ'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                                       CLE134
     C           FELCHT    ORNE 'D'                                                           CLE134
     C           FEAUT2    ANDEQ'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C                     EXSR SRFEED
     C                     ENDIF
      *
      ** Update database with shadow postings in store (within AOSPOSU0)
      *
     C                     EXSR SRUPD
      *
      *................................................................
      *
     C           EXMAIN    TAG
      *
      ** Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
     C*****************************************************************
     C/EJECT
      *****************************************************************
      * Subroutine  :  SRFEED                                         *
      * Function    :  Fees Input Processing                          *
      *                                                               *
      * Called by   :  Mainline                                       *
      * Calls       :  AOSPOSU0 - On-line Positions Update            *
      *                SRCAMT - Calculated Amount                     *
      *****************************************************************
     C           SRFEED    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q       50
     C                     MOVEL'SRFEED'  @STK,Q
      *
      *................................................................
      *
      ** Store pay and receive settlement methods, accounts & branches
      *
      ** For fees with blank participant fee indicator
      ** format receive settlement
      *
     C           FEPTFI    IFEQ *BLANK
     C                     MOVE *BLANKS   ##PAYM           * pay method
     C                     MOVE *BLANKS   ##PAYA           * pay account
     C                     MOVE *BLANKS   ##PAYB           * pay branch
     C                     MOVELFERSTM    ##RECM           * rec method
     C                     MOVELFERONS    ##RECA           * rec account
     C                     MOVELFEOSDB    ##RECB           * rec branch
     C                     ELSE
      *
      ** For fee with participant fee indicator 'P'
      ** format pay settlement
      *
     C                     MOVELFEPSTM    ##PAYM           * pay method
     C                     MOVELFEPONS    ##PAYA           * pay account
     C                     MOVELFEOMDB    ##PAYB           * pay branch
     C                     MOVE *BLANKS   ##RECM           * rec method
     C                     MOVE *BLANKS   ##RECA           * rec account
     C                     MOVE *BLANKS   ##RECB           * rec branch
     C                     ENDIF
      *
      ** Store basic fee details
      *
     C                     Z-ADDFEFAMT    ##FAMT 150       * fee amount
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           CLE031    ANDNE'Y'                                                           CLE031
     C           FESCCY    ANDNE*BLANKS                                   CEU004
     C                     MOVE FESCCY    ##CCY   3        * currency
     C                     ELSE
     C                     MOVE FEFCCY    ##CCY   3        * currency
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
      ** If Lending Enhancements is on.                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
      *                                                                                       CLE031
     C                     MOVEL*BLANKS   SVSCCY                                             BUG8628
     C                     MOVEL*BLANKS   SVPSCY                                             BUG8628
      ** Store receipt settlement currency                                                    CLE031
     C           FESCCY    IFNE *BLANK                                                        CLE031
     C                     MOVELFESCCY    SVSCCY  3                                           CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
      * Store pay settlement currency                                                         CLE031
     C           FEPSCY    IFNE *BLANK                                                        CLE031
     C                     MOVELFEPSCY    SVPSCY  3                                           CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ENDIF                           End If CLE031                      CLE031
      *                                                                                       CLE031
      ** Use loan no. or facility type/no.                                                    205328
      *                                                                                       205328
     C**********           MOVE FETNLU    ##TRN   6        * transact no.                     205328
     C                     MOVE FEBRCA    ##BBRN  3        * branch
      *
     C********** FELOAN    IFNE *ZERO                                                         CLE148
     C           FELOAN    IFNE *BLANKS                                                       CLE148
     C                     MOVE 'F1'      ##TRYP  2        * trans type
     C                     MOVE FELOAN    ##TRN   6        * transact #                       205328
     C                     ELSE
     C                     MOVE 'F2'      ##TRYP  2        * trans type
     C                     MOVE FEFACL    ##TRN            * transact #                       205328
     C                     ENDIF
      *
      ** Initialize work fields
      *
     C                     Z-ADD*ZERO     ##VDAT  50       * event value dte
     C                     Z-ADD*ZERO     ##AMT  150       * amount
     C                     MOVEL*BLANK    ##NARR           * narrative
      *
      ** Generate VALUE DATE account movement
      ** ====================================
      *
      ** Value date should be settlement date                                                 205328
      *                                                                                       205328
     C           FEPYON    IFEQ ' '                                                           205328
     C           FEPYON    OREQ 'S'                                                           205328
     C                     Z-ADDFEPSTD    ##VDAT             Midas day no.
     C                     ELSE                                                               205328
      *                                                                                       205328
     C           FENPYD    IFGT 0                                                             205328
     C                     Z-ADDFENPYD    ##VDAT                                              205328
     C                     ELSE                                                               205328
     C                     Z-ADDFEPEND    ##VDAT                                              205328
     C                     ENDIF                                                              205328
     C                     ENDIF                                                              205328
      *                                                                                       205328
     C                     Z-ADD##FAMT    ##AMT            * fee amount
     C/COPY WNCPYSRC,AOH00009
      *                                                                                       CLE073
     C           CLE073    IFEQ 'Y'                                                           CLE073
     C           FECALT    ANDEQ'99'                                                          CLE073
     C           FENPYD    ANDEQBJRDNB                                                        CLE073
     C           FEDDAT    ANDNE0                                                             CLE073
     C                     ADD  FEAMTP    ##AMT                                               CLE073
     C                     ENDIF                                                              CLE073
     C           CLE073    IFEQ 'Y'                                                           CLE073
     C           FECALT    ANDEQ'99'                                                          CLE073
     C           FELPDT    ANDEQBJRDNB                                                        CLE073
     C                     Z-ADDFEAMTP    ##AMT                                               CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      *
      ** Pass movement to write program (with appropriate instructions)
      *
     C           FEPTFI    IFEQ *BLANK
     C                     MOVEL##RECD    ##SETD           * Rec details
     C                     ELSE
     C                     MOVEL##PAYD    ##SETD           * Pay details
     C                     ENDIF
      *
      ** Get fee code description from Fee Codes File
      *
     C                     MOVE FEFCOD    O#FCD
     C                     CALL 'AOFEER0'              9090
     C                     PARM *BLANKS   O#RTN
     C                     PARM '*KEY   ' O#OPT   8
     C                     PARM           O#FCD   2
     C           SDFEE     PARM SDFEE     DSFDY
     C           O#RTN     IFNE *BLANKS
     C                     MOVEL'AOFEER0 'W0FILE
     C                     MOVELO#FCD     W0KEY
     C                     Z-ADD905       W0ERNB
     C                     EXSR SRERR
     C                     ENDIF
      *
     C                     Z-ADD001       ##RPNB  30       * 1=value date
      *
      ** Set up narrative as fee sequence and fee code description
      *
     C                     MOVE FEFSEQ    ##NSEQ
     C                     MOVE AUFENV    ##NDES
      *
      ** Get amount for Calculated amount
      *
     C           FEAUTO    IFEQ 'Y'
     C           FEFAMT    ANDEQ0
      *                                                                                       CLE134
      ** FEAUTO = 'C' fee subject to funds check                                              CLE134
      *                                                                                       CLE134
     C           FEAUTO    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           FEFAMT    ANDEQ0                                                             CLE134
     C           FEAUT2    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           FEFAMT    ANDEQ0                                                             CLE134
      *                                                                                       CLE134
     C                     EXSR SRCAMT
     C                     ENDIF
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           FESTAL    ANDEQ'Y'                                                           CLE034
     C                     EXSR SR34A                                                         CLE034
     C                     ELSE                                                               CLE034
     C                     MOVE 'Y'       WRKFLD  1                                           CLE034
     C                     MOVE '*EOF   ' STALCD                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C           WRKFLD    DOWEQ'Y'                                                           CLE034
     C           STALCD    OREQ *BLANKS                                                       CLE034
      *
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           FESTAL    ANDEQ'Y'                                                           CLE034
     C                     EXSR SR34B                                                         CLE034
     C                     ENDIF                                                              CLE034
      *
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVEL'F'       ##MTYP  1                                           CAP205
     C                     ENDIF                                                              CAP205
     C                     EXSR SRMOVE
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           FESTAL    ANDEQ'Y'                                                           CLE034
     C                     EXSR SR34C                                                         CLE034
     C                     ELSE                                                               CLE034
     C                     MOVE *BLANK    WRKFLD                                              CLE034
     C                     ENDIF                                                              CLE034
     C                     ENDDO                                                              CLE034
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           FESTAL    ANDEQ'Y'                                                           CLE034
     C                     EXSR SR34E                                                         CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CER049
      ** Call AOSPOSU0 when CER049 is ON                                                      CER049
      *                                                                                       CER049
     C           CER049    IFEQ 'Y'                                                           CER049
     C           ##AMT     ANDNE*ZEROS                                                        CER049
     C                     EXSR SRSTAX                                                        CER049
     C                     ENDIF                                                              CER049
      *................................................................
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * Subroutine  :  SRCAMT                                         *
      * Function    :  Subroutine for Calculated Amount               *
      *                                                               *
      * Called by   :  SRFEED - Fees Input Details                    *
      * Calls       :  SRACCT - Check account if retail or nostro     *
      *             :  CALFEO - Calculate old fee to be backed out    *
      *             :  CALFEN - Calculate new fee to be applied       *
      *****************************************************************
     C           SRCAMT    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'SRCAMT'  @STK,Q
      *
     C                     Z-ADD*ZEROS    WFEEA  150
     C                     Z-ADD*ZEROS    WPAYD   50
      *
     C                     MOVELFEOURS    POSTB            OLD Settlt
     C                     MOVE FEOSBR    STBRC            OLD branch
     C                     MOVE FEFCCY    STCCY            OLD ccy
     C                     MOVE FESTTL    STSET            OLD type
     C                     EXSR SRACCT                     Setup A/C
      *
      ***For*action*Amend*and*Delete***                                                       205222
      ** For action Amend, Delete and Authorise                                               205222
      *
     C           FEAUTO    IFEQ 'Y'                        Auto settle
      *                                                                                       CLE134
     C           FEAUTO    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           FEAUT2    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                                       CLE134
     C           FELCHT    IFEQ 'A'                        AMEND
     C           FELCHT    OREQ 'D'                        DELETE
     C           FELCHT    OREQ 'X'                        Authorise                          205222
      *
     C           *IN47     IFEQ '1'
     C           *IN48     OREQ '1'
     C           STSET     OREQ '09'                                                          218992
     C                     EXSR CALFEO
     C                     Z-ADDWFEEA     ##AMT            OLD amount
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      ***For*action*Amend*and*Insert***                                                       205222
      ** For action Amend, Insert and Authorise                                               205222
      *
     C           FEAUTO    IFEQ 'Y'                        Auto settle
      *                                                                                       CLE134
     C           FEAUTO    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           FEAUT2    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                                       CLE134
     C           FELCHT    IFEQ 'A'                        AMEND
     C           FELCHT    OREQ 'I'                        INSERT
     C           FELCHT    OREQ 'X'                        Authorise                          205222
      *
     C           *IN47     IFEQ '1'
     C           *IN48     OREQ '1'
     C           STSET     OREQ '09'                                                          218992
     C                     EXSR CALFEN
     C                     Z-ADDWFEEA     ##AMT            OLD amount
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  SRACCT                                         *
      * Function    :  Check account if retail or nostro              *
      *                                                               *
      * Called by   :  SRCAMT - Subroutine for calculated amount      *
      * Calls       :  None                                           *
      *****************************************************************
     C           SRACCT    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'SRACCT'  @STK,Q
      *
     C                     SETOF                     47    Nostro A/c
     C                     SETOF                     48    Retail A/c
      *
      * Accounts Master file key parameters
      *
     C           PLISTA    PLIST
     C                     PARM '*BLANKS' WRTCD   7        B:Return Cd
     C                     PARM '*KEY   ' WOPTN   7        B:Option
     C                     PARM           ACANM  10        I:Account Ident
     C                     PARM           ACCUS            I:Customer Numb
     C                     PARM           ACCCY            I:Currency Code
     C                     PARM           ACACD            I:Account Code
     C                     PARM           ACSQN            I:Account Seque
     C                     PARM           ACBRC            I:Branch code
     C           DWACCT    PARM *BLANK    DSSDY            O:Format
      *
      ** Nostro file key paramters
      *
     C           PLISTN    PLIST
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           @KEYA   6                     A
     C                     PARM           @KEYB   3                     B
     C**********           PARM           @KEYC   4                     C                     CGL029
     C                     PARM           @KEYC  10                                           CGL029
     C                     PARM           @KEYD   2                     D
     C                     PARM           @KEYE   2                     E
     C                     PARM           @KEYF   3                     F
     C                     PARM           @KEYG  10                     G
     C                     PARM           @KEYH   1                     H
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **   CHECK IF SETTLTMENT IS THROUGH A NOSTRO
      *
     C           STSET     LOKUPTABNOS                   65
      *
     C           *IN65     IFEQ '1'
      *                                                                                       CLE031
      ** If CLE031 is on then use correct currency in call to AONOSTR0                        CLE031
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE ##CCY     STCCY                                               CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C**   GET NOSTRO DETAILS
     C                     MOVE STCCY     @KEYB
     C                     MOVE STNOS     @KEYE
     C                     CALL 'AONOSTR0'PLISTN
     C                     MOVE A7CUST    ACCUS
     C                     MOVE A7CYCD    ACCCY
     C                     MOVE A7ACCD    ACACD
     C                     MOVE A7ACSN    ACSQN
     C                     MOVE A7BRCD    ACBRC
      ** Access Account Details file
     C                     CALL 'AOACCTR0'PLISTA
      *
     C           RECI      IFEQ 'D'
     C           WRTCD     ANDEQ*BLANKS
      *
      **   SETON 47    IF SETTLEMENT IS THROUGH A NOSTRO ACCOUNT.
     C**
     C                     SETON                     47
     C*
     C**   CHECK FOR RETAIL ACCOUNT
     C*
     C           ATYP      IFEQ 'R'
     C                     SETON                     48    RETAIL A/C
     C                     END
     C                     END
     C*
     C                     ELSE                            NOT A NOSTRO
     C*
     C                     MOVE FEFCCY    ACCCY                                               218992
     C           STSET     IFEQ '05'                       SETTL 05
     C*
     C           STSQN     IFEQ '  '
     C           STSQN     OREQ '00'
     C                     MOVE '01'      ACSQN
     C                     ELSE
     C                     MOVE STSQN     ACSQN
     C                     END
     C*
     C                     MOVE STACD     ACACD
     C                     MOVE STCUS     ACCUS
     C                     MOVE STBRC     ACBRC
     C                     END
     C**
     C*    Set up account for SETTLEMENT TYPE 04 (default A/c No)
     C*
     C/COPY WNCPYSRC,AOOUFEU0C1
     C           CLE033    IFEQ 'Y'                        SETTLE 09      CLE033
     C           STSET     ANDEQ'09'                                      CLE033
     C                     MOVELP@VL01    ACCUS                           CLE033
     C                     MOVELP@VL02    ACACD                           CLE033
     C                     MOVEL'01'      ACSQN                           CLE033
     C                     MOVELSTBRC     ACBRC                           CLE033
     C                     ENDIF                                          CLE033
      *                                                                   CLE033
     C           STSET     IFEQ '04'                       SETTLE 04
     C                     MOVE STCUS     ACCUS
     C                     MOVE BMACCD    ACACD            CURRENT A/C
     C                     MOVE '01'      ACSQN
     C                     MOVE STBRC     ACBRC
     C                     END
     C**
     C*    GET ACCNT KEY FROM ACNUM FOR SETTLEMENT TYPE 14.
     C**
     C           STSET     IFEQ '14'                       SETTLE 14
     C                     MOVE *BLANKS   ACCKEY
     C                     MOVE STANM     ACANM
      ** Access Account Details for retail account number
     C                     CALL 'AOACCTR0'PLISTA
     C                     MOVE *BLANKS   ACANM
     C                     MOVE CNUM      ACCUS
     C                     MOVE CCY       ACCCY
     C                     MOVE ACOD      ACACD
     C                     MOVE ACSQ      ACSQN
     C                     MOVE BRCA      ACBRC
     C                     ELSE
     C*
      ** Access Account Details file
     C                     CALL 'AOACCTR0'PLISTA
     C*
     C                     END
      *
     C**   CHECK FOR RETAIL ACCOUNT
     C           RECI      IFEQ 'D'
     C           WRTCD     ANDEQ*BLANKS
     C           ATYP      ANDEQ'R'
     C**
     C                     SETON                     48    RETAIL A/C
     C                     END
     C*
     C                     END                             NOSTRO SETL
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  CALFEO                                         *
      * Function    :  Calculate od fee to be backed out              *
      *                                                               *
      * Called by   :  SRCAMT - Subroutine for calculated amount      *
      * Calls       :  None                                           *
      *****************************************************************
     C           CALFEO    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'CALFEO'  @STK,Q
      *
     C                     Z-ADD*ZEROS    WFEEA
      *
      * If the fee was NOT entered today
      *    The fee to be removed can be obtained from the events file
      *
     C           FELCHD    IFNE BJRDNB
      *
      * Access the events file to obtain the fee amount
     C                     MOVE FECNUM    WCNUM
     C                     MOVE FECNUM    WCNUMA
     C                     MOVE FELOAN    WLOAN
     C                     MOVELFEFACL    WFAC03
     C                     MOVE FEFACL    WFAC02
     C                     Z-ADDFEFSEQ    WFSEQ3
     C           KEYEV3    SETLLLVENTL3
     C           KEYEV3    READELVENTLF3                 65
     C           *IN65     IFEQ '0'
     C                     Z-ADDEAMT      WFEEA
     C                     Z-ADDEDAT      WPAYD
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C                     Z-ADD0         WFEEA                                               CLE034
     C           *IN65     DOWEQ'0'                                                           CLE034
     C           WFEEA     ADD  EAMT      WFEEA                                               CLE034
     C           KEYEV3    READELVENTLF3                 65                                   CLE034
     C                     ENDDO                                                              CLE034
     C                     ENDIF                                                              CLE034
     C                     ENDIF
      *
      * If the fee was entered today
      *    The fee to be removed can be obtained from the postings file
      *
     C                     ELSE
      *
     C********** FELOAN    IFNE *ZERO                                                         CLE148
     C           FELOAN    IFNE *BLANKS                                                       CLE148
     C                     MOVE FELOAN    WTNMR   6
     C                     ELSE
     C                     MOVE FEFACL    WTNMR
     C                     ENDIF
      *
      **  Obtain payment date
      *
     C                     Z-ADDFENPYD    WPAYD            PAY Date
      *
      **  fee settled on start date
      *
     C           FEPYON    IFEQ *BLANKS
     C           FEPYON    OREQ 'S'
     C                     Z-ADDFEPSTD    WPAYD
     C                     ELSE
      *
      ***     fee settled on end date
      *
     C           FEPYON    IFEQ 'E'
     C           FENPYD    OREQ *ZEROS
     C                     Z-ADDFEPEND    WPAYD
     C                     END
     C                     END
      *
     C                     MOVE FEFSEQ    WFSEQ   2
     C           KEYRSA    SETLLRSACMTL1
     C           KEYRSA    READERSACMTL1                 65
     C           *IN65     DOWEQ'0'
     C           TNMR      ANDNEWTNMR
     C           *IN65     OREQ '0'
     C           NSEQ      ANDNEWFSEQ
     C           KEYRSA    READERSACMTL1                 65
     C                     ENDDO
      *
     C           *IN65     IFEQ '0'
     C********** TNMR      ANDEQTNMR                                                          CLE034
     C           TNMR      ANDEQWTNMR                                                         CLE034
     C           NSEQ      ANDEQWFSEQ
     C                     Z-ADDMVAM      WFEEA
     C                     ENDIF
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           KEYRSA    READERSACMTL1                 65                                   CLE034
     C           *IN65     DOWEQ'0'                                                           CLE034
     C           TNMR      IFEQ WTNMR                                                         CLE034
     C           NSEQ      ANDEQWFSEQ                                                         CLE034
     C           WFEEA     ADD  MVAM      WFEEA                                               CLE034
     C                     ENDIF                                                              CLE034
     C           KEYRSA    READERSACMTL1                 65                                   CLE034
     C                     ENDDO                                                              CLE034
     C                     ENDIF                                                              CLE034
      *
     C                     ENDIF
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  CALFEN                                         *
      * Function    :  Calculate new fee to be applied                *
      *                                                               *
      * Called by   :  SRCAMT - Subroutine for calculated amount      *
      * Calls       :  None                                           *
      *****************************************************************
     C           CALFEN    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'CALFEN'  @STK,Q
      *
     C                     Z-ADD0         WFEEA            NEW fee
     C                     MOVE FECNUM    WCNUM
     C                     MOVE FECNUM    WCNUMA
     C                     MOVE FELOAN    WLOAN
     C                     MOVELFEFACL    WFAC03
     C                     MOVE FEFACL    WFAC02
     C                     Z-ADDFEFSEQ    WFSEQ3
      *
      ***  Obtain payment date
      *
     C                     Z-ADDFENPYD    WPAYD            PAY Date
      *
      ***     fee settled on start date
      *
     C           FEPYON    IFEQ *BLANKS
     C           FEPYON    OREQ 'S'
     C                     Z-ADDFEPSTD    WPAYD
     C                     ELSE
      *
      ***     fee settled on end date
      *
     C           FEPYON    IFEQ 'E'
     C           FENPYD    OREQ *ZEROS
     C                     Z-ADDFEPEND    WPAYD
     C                     ENDIF
      *
     C                     ENDIF
      *
      ********************************************
      ***  Processing for non-calculated  fees ***
      ********************************************
      *
     C********** FELOAN    IFEQ *ZERO                                                         CLE148
     C           FELOAN    IFEQ *BLANKS                                                       CLE148
     C           FECALT    ANDEQ*BLANKS
     C********** FELOAN    ORNE *ZERO                                                         CLE148
     C           FELOAN    ORNE *BLANKS                                                       CLE148
     C/COPY WNCPYSRC,AOH00010
      *                                                                                       CLE073
     C           CLE073    ANDNE'Y'                                                           CLE073
     C********** FELOAN    ORNE *ZERO                                                  CLE073 CLE148
     C           FELOAN    ORNE *BLANKS                                                       CLE148
     C           CLE073    ANDEQ'Y'                                                           CLE073
     C           FECALT    ANDNE'97'                                                          CLE073
     C           FECALT    ANDNE'98'                                                          CLE073
     C           FECALT    ANDNE'99'                                                          CLE073
      *                                                                                       CLE073
      *
     C           FEFAMT    SUB  FEAMTS    WFEEA
      *
     C                     ENDIF
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C           FEPYON    ANDEQ'N'                                                           CLE031
     C                     Z-ADDFEFAMT    WFEEA                                               CLE031
     C                     ENDIF                                                              CLE031
      *
      ************************************************
      ***  Processing for calculated facility fees ***
      ************************************************
      *
     C********** FELOAN    IFEQ *ZERO                                                         CLE148
     C           FELOAN    IFEQ *BLANKS                                                       CLE148
     C           FECALT    ANDNE*BLANKS
     C/COPY WNCPYSRC,AOH00011
      *                                                                                       CLE073
     C********** FELOAN    ORNE *ZERO                                                  CLE073 CLE148
     C           FELOAN    ORNE *BLANKS                                                       CLE148
     C           CLE073    ANDEQ'Y'                                                           CLE073
     C           FECALT    ANDEQ'97'                                                          CLE073
     C********** FELOAN    ORNE *ZERO                                                  CLE073 CLE148
     C           FELOAN    ORNE *BLANKS                                                       CLE148
     C           CLE073    ANDEQ'Y'                                                           CLE073
     C           FECALT    ANDEQ'98'                                                          CLE073
      *                                                                                       CLE073
     C                     EXSR CALFEE
     C                     ENDIF
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  CALFEE                                         *
      * Function    :  Check if calculated facility fees are due      *
      *                this run                                       *
      *                                                               *
      * Called by   :  CALFEN - Calculated new fee to be applied      *
      * Calls       :  CALSRC - Calculation Processing                *
      *                ACCRUE - Calculate Accrual Amount              *
      *****************************************************************
     C           CALFEE    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'CALFEE'  @STK,Q
      *
     C                     Z-ADD0         WAMT   150
     C                     Z-ADD0         WPCT    63
      *
      **  Set up work start date:
      *
      * IF PAST DUE JUST USE PAST DUE AMOUNT
     C           FEDDAT    IFNE 0
     C/COPY WNCPYSRC,AOH00012
      *                                                                                       CLE073
     C           CLE073    IFNE 'Y'                                                           CLE073
     C           CLE073    OREQ 'Y'                                                           CLE073
     C           FECALT    ANDNE'97'                                                          CLE073
     C           FECALT    ANDNE'98'                                                          CLE073
     C           FECALT    ANDNE'99'                                                          CLE073
      *                                                                                       CLE073
     C                     MOVE FEAMTP    WFEEA
     C/COPY WNCPYSRC,AOH00013
      *                                                                                       CLE073
     C                     ELSE                                                               CLE073
     C                     EXSR DUEFEL                                                        CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     ELSE
     C           FELPDT    IFNE 0
     C                     Z-ADDFELPDT    WSTART  50
     C                     ELSE
     C                     Z-ADDFEPSTD    WSTART
     C                     END
      *
      ***  Set up end date:
      *
     C                     Z-ADDWPAYD     WEND    50
      *
      ***  Use start & end dates to obtain number of days in whole
      ***  calculation period.
      *
     C***********WEND      SUB  WSTART    WDAYS   50                      CLE013
     C                     Z-ADDWSTART    ZZBEG                           CLE013
     C                     Z-ADDWEND      ZZEND                           CLE013
     C                     MOVE FECALC    ZZCALC                          CLE013
     C                     EXSR ZINTDY                                    CLE013
      *                                                                                       CLE073
     C           FECALC    IFEQ 6                                                             CLE073
     C                     Z-ADDINT6DY    WDAYS                                               CLE073
     C                     ELSE                                                               CLE073
      *                                                                                       CLE073
     C                     Z-ADDZZINDY    WDAYS   50                      CLE013
      *                                                                                       CLE073
     C                     ENDIF                                                              CLE073
     C/COPY WNCPYSRC,AOH00014
      *                                                                                       CLE073
     C           FECALT    IFEQ '97'                                                          CLE073
     C           CLE073    ANDEQ'Y'                                                           CLE073
     C           FECALT    OREQ '98'                                                          CLE073
     C           CLE073    ANDEQ'Y'                                                           CLE073
     C                     EXSR CALFEL                                                        CLE073
     C                     ELSE                                                               CLE073
      *                                                                                       CLE073
      ***  Calculate future fee amounts.  As this amount depends
      ***  on the value of the facility for each day, check for
      ***  a change in value within period.
      *
     C           KEY001    CHAINFCLTY                72
      *
     C                     Z-ADDFAMT      FFAM
     C           KEYFCB    CHAINFCLTY                72
     C           RVCR      IFNE 'Y'
     C                     EXSR FEVNTS                     Facil events
     C                     ENDIF
      *
     C                     Z-ADDFAMT      WFACAM 130
     C                     Z-ADDOAM,1     WDRAWN 130
     C                     Z-ADD1         V       20
     C           WSTART    LOKUPRUN,V                  6565
     C           *IN65     IFNE '1'
     C                     Z-ADD1         V
     C                     ENDIF
      *
      **************************************************************
      ***  Set up amount for accrual for actual amount type fees ***
      **************************************************************
      *
     C                     Z-ADDFFAM,V    CFAMT  130
      *
      ** Set up fields for next search of arrays for any changes.
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '02'
     C           FECALT    OREQ '03'
     C           FECALT    OREQ '04'
     C           FECALT    OREQ '05'
     C           FECALT    OREQ '06'
     C           FFAM,V    SUB  OAM,V     AAMT   130
     C                     ENDIF
      *
     C           FECALT    IFEQ '11'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '14'
     C           FECALT    OREQ '15'
     C           FECALT    OREQ '16'
     C                     Z-ADDOAM,V     AAMT
     C                     ENDIF
      *
     C           FECALT    IFEQ '21'
     C           FECALT    OREQ '22'
     C                     Z-ADDFFAM,V    AAMT
     C                     ENDIF
      *
      ***  Arrays go  9 working days into the future, but calculations
      ***  should stop once end date reached
      *
     C           V         DOWLE9
     C           RUN,V     ANDLEWEND
      *
      ***  Work through each value of total drawn, and facility amount
      ***  (the latter only if not a revolving credit), looking for a
      ***  change from the previous value, but stopping at the end date
      *
     C           OAM,V     IFNE WDRAWN
     C           RUN,V     ANDLEWEND
     C           FFAM,V    ORNE WFACAM
     C           RUN,V     ANDLEWEND
     C           RVCR      ANDNE'Y'
     C           RUN,V     OREQ WEND
      *
      **************************************************************
      ***  Set up amount for accrual for actual amount type fees ***
      **************************************************************
      *
     C                     Z-ADDFFAM,V    CFAMT
     C***********RUN,V     SUB  WSTART    NDAYS   50                      CLE013
     C                     Z-ADDWSTART    ZZBEG                           CLE013
     C                     Z-ADDRUN,V     ZZEND                           CLE013
     C                     MOVE FECALC    ZZCALC                          CLE013
     C                     EXSR ZINTDY                                    CLE013
      *                                                                                       CLE073
     C           FECALC    IFEQ 6                                                             CLE073
     C                     Z-ADDINT6DY    NDAYS                                               CLE073
     C                     ELSE                                                               CLE073
      *                                                                                       CLE073
     C                     Z-ADDZZINDY    NDAYS   50                      CLE013
      *                                                                                       CLE073
     C                     END                                                                CLE073
      *                                                                                       CLE073
     C           NDAYS     IFGT 0
     C                     EXSR CALCSR
     C                     Z-ADDRUN,V     WSTART
     C                     ENDIF
      *
      *** Set up fields for next search of arrays for any changes.
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '02'
     C           FECALT    OREQ '03'
     C           FECALT    OREQ '04'
     C           FECALT    OREQ '05'
     C           FECALT    OREQ '06'
     C           FFAM,V    SUB  OAM,V     AAMT
     C                     ENDIF
      *
     C           FECALT    IFEQ '11'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '14'
     C           FECALT    OREQ '15'
     C           FECALT    OREQ '16'
     C                     Z-ADDOAM,V     AAMT
     C                     ENDIF
      *
     C           FECALT    IFEQ '21'
     C           FECALT    OREQ '22'
     C                     Z-ADDFFAM,V    AAMT
     C                     ENDIF
      *
     C                     Z-ADDOAM,V     WDRAWN
     C                     Z-ADDFFAM,V    WFACAM
      *
     C                     ENDIF
      *
     C                     ADD  1         V
      *
      ** End of V DOWLE 9 loop
     C                     ENDDO
      *
      **************************************************************
      ***  Do final period processing                            ***
      ***     from RUN ,9 up to End if necessary                 ***
      **************************************************************
      *
     C           WEND      IFGT WSTART
     C                     Z-ADDFFAM,V    CFAMT
     C***********WEND      SUB  WSTART    NDAYS                           CLE013
     C                     Z-ADDWSTART    ZZBEG                           CLE013
     C                     Z-ADDWEND      ZZEND                           CLE013
     C                     MOVE FECALC    ZZCALC                          CLE013
     C                     EXSR ZINTDY                                    CLE013
      *                                                                                       CLE073
     C           FECALC    IFEQ 6                                                             CLE073
     C                     Z-ADDINT6DY    NDAYS                                               CLE073
     C                     ELSE                                                               CLE073
      *                                                                                       CLE073
     C                     Z-ADDZZINDY    NDAYS                           CLE013
      *                                                                                       CLE073
     C                     END                                                                CLE073
      *                                                                                       CLE073
     C                     EXSR CALCSR
     C                     ENDIF
      *
      **************************************************************
      ***  Set up amount for average type fees which are accrued ***
      ***  over the whole period.                                ***
      **************************************************************
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '02'
     C           FECALT    OREQ '03'
     C           FECALT    OREQ '11'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '21'
     C                     EXSR ACCRUE
     C                     ADD  WTOT      WFEEA
     C                     ENDIF
      *
     C                     ENDIF
     C/COPY WNCPYSRC,AOH00015
      *                                                                                       CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  CALCSR                                         *
      * Function    :  Calculation Processing                         *
      *                                                               *
      * Called by   :  CALFEE - Check if calculated facility fees     *
      *                         are due this run                      *
      * Calls       :  ACCRUE - Calculate Accrual Amount              *
      *****************************************************************
     C           CALCSR    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'CALCSR'  @STK,Q
      *
      ** If average amount type fees calculate proportion of AAMT
      ** applicable to NDAYS (WDAYS is whole period,) and add into
      ** total amount (WAMT)
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '02'
     C           FECALT    OREQ '03'
     C           FECALT    OREQ '11'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '21'
      *
     C                     MULT NDAYS     AAMT
     C                     DIV  WDAYS     AAMT      H
     C                     ADD  AAMT      WAMT
      *
     C                     ENDIF
      *
      *** Actual amount fees
      *
     C           FECALT    IFEQ '04'
     C           FECALT    OREQ '05'
     C           FECALT    OREQ '06'
     C           FECALT    OREQ '14'
     C           FECALT    OREQ '15'
     C           FECALT    OREQ '16'
     C           FECALT    OREQ '22'
      *
     C                     Z-ADDNDAYS     WDAYS
     C                     Z-ADDAAMT      WAMT
     C                     EXSR ACCRUE
     C                     ADD  WTOT      WFEEA  150
      *
     C                     ENDIF
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  ACCRUE                                         *
      * Function    :  Calculate Accrual Amount                       *
      *                                                               *
      * Called by   :  CALFEE - Check if calculated facility fees     *
      *                         are due this run                      *
      *                CALCSR - Calculation Processing                *
      * Calls       :  CONV   - Convert Event amounts into facility   *
      *                         currency                              *
      *                LSTART - Subroutine called if look up of FAM   *
      *                         or FPC array for values greater than  *
      *                         or equal to LOKUP factor fails        *
      *****************************************************************
     C           ACCRUE    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'ACCRUE'  @STK,Q
      *
     C                     Z-ADD0         WTOT   150
      *
      ** Calculate percentage if required.
      *
     C           FEPIND    IFNE 'A'
      *
      ** For average amount type fees calculate what % WAMT is of the
      ** original facility amount
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '02'
     C********** FECALT    OREQ '03'                                                         BUG8460
     C           FECALT    OREQ '11'
     C           FECALT    OREQ '12'
     C********** FECALT    OREQ '13'                                                         BUG8460
     C********** FECALT    OREQ '21'                                                         BUG8460
      *
     C           WAMT      DIV  FAMT      WRK155 155H
     C           WRK155    MULT 100       WPCT
     C                     Z-ADDFAMT      WAMT
      *
     C                     ENDIF
      *
      ***  Actual amount type fees calculate what percentage
      ***  WAMT is of the current facility amount
      *
     C           FECALT    IFEQ '04'
     C           FECALT    OREQ '05'
     C********** FECALT    OREQ '06'                                                         BUG8460
     C           FECALT    OREQ '14'
     C           FECALT    OREQ '15'
     C********** FECALT    OREQ '16'                                                         BUG8460
     C********** FECALT    OREQ '22'                                                         BUG8460
     C           WAMT      DIV  CFAMT     WRK155    H
     C           WRK155    MULT 100       WPCT
     C                     Z-ADDCFAMT     WAMT
     C                     ENDIF
      *
      ***  If percentage is > 100 then reset
      *
     C           WPCT      IFGT 100
     C                     Z-ADD100       WPCT
     C                     ENDIF
      *
     C                     ENDIF
      *
      *** Fee customer bills/telexes are output in fee currency so
      *** convert if required.
      *
     C                     MOVE FCCY      INCCY
     C                     MOVE FEFCCY    OUTCCY
     C                     Z-ADDWAMT      WEAMT
     C                     EXSR CONV
     C                     Z-ADDWEAMT     WAMT
      *
      ** Retrieve calculation basis
      *
     C                     MOVE FECALC    WCALC   1
      *
     C           WCALC     LOKUPTABCAL    TABCBS         65
     C           *IN65     IFEQ '1'
     C                     Z-ADDTABCBS    WCBS    50
     C                     ENDIF
      *
      **************************
      *** TIERED CALCULATION ***
      **************************
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '04'
     C           FECALT    OREQ '11'
     C           FECALT    OREQ '14'
      *
      *** Amount type calculation (not percentage)
      *
     C           FEPIND    IFEQ 'A'
      *
      *** Use power array to multiply each tier amount by the
      *** element four on from the number of decimal places of the
      *** currency (i.e., if 0 dec. places use element 4; etc)
      *** and place in separate array (FAM)
      *
     C                     Z-ADD1         W
     C           FEFCCY    LOKUPCURR,W                   65
      *
     C           CCDP,W    ADD  4         P       20
     C           FEEM      MULT POWER,P   FAM
      *
     C                     Z-ADD0         WFAM   150
     C                     Z-ADDWAMT      WOAMT  150
     C                     Z-ADD1         X
      *
     C           WAMT      DOWGT0
     C           X         ANDLT6
      *
      ***  If the original amount is less than the current tier being
      ***  processed or the tier is zero multiply WAMT by the
      ***  corresponding fee rate for the tier and put in workfield.
      *
     C           WOAMT     IFLT FAM,X
     C           FAM,X     OREQ 0
     C           WAMT      MULT FRT,X     WRK15  150
     C                     ENDIF
      *
      ***  If the original amount is greater than or equal to the
      ***  current tier, and the tier is not zero subtract WFAM from
      ***  the tier.  Multiply the resultant work field by the
      ***  corresponding fee rate for the tier.
      *
     C           WOAMT     IFGE FAM,X
     C           FAM,X     ANDNE0
     C           FAM,X     SUB  WFAM      WRK15
     C                     MULT FRT,X     WRK15
     C                     ENDIF
      *
     C                     ADD  WRK15     WTOT
     C                     SUB  FAM,X     WAMT
     C                     ADD  WFAM      WAMT
     C                     Z-ADDFAM,X     WFAM
      *
     C                     ADD  1         X
     C                     ENDDO
      *
     C                     ENDIF
      *
      *** Percentage type processing
      *
      ***  If percentage required divide each tier amount by 1000 &
      ***  store result in array FPC (fee percentage).
      *
     C           FEPIND    IFNE 'A'
      *
     C           FEEM      DIV  1000      FPC
     C                     Z-ADD0         WFPC    63
     C                     Z-ADDWPCT      WOPCT   63
     C                     Z-ADD1         X
      *
     C           WPCT      DOWGT0
     C           X         ANDLT6
      *
      ***  If original percentage (WOPCT) is less than current element
      ***  of fee percentage array or if fee percentage is zero.
      *
     C           WOPCT     IFLT FPC,X
     C           FPC,X     OREQ 0
     C           WAMT      MULT WPCT      WRK15
     C                     ENDIF
      *
      ***  If original percentage (WOPCT) is greater than or equal to
      ***  fee percentage from array, and fee percentage not zero.
      *
     C           WOPCT     IFGE FPC,X
     C           FPC,X     ANDNE0
     C           FPC,X     SUB  WFPC      WRK63   63
     C           WAMT      MULT WRK63     WRK15
     C                     ENDIF
      *
     C                     MULT FRT,X     WRK15
     C                     DIV  100       WRK15     H
     C                     ADD  WRK15     WTOT
     C                     SUB  FPC,X     WPCT
     C                     ADD  WFPC      WPCT
     C                     Z-ADDFPC,X     WFPC
      *
     C                     ADD  1         X
     C                     ENDDO
      *
     C                     ENDIF
      *
      ** Calculate final accrual amount.
      *
     C                     MULT WDAYS     WTOT
     C                     DIV  WCBS      WTOT      H
      *
     C                     ENDIF
      *
      *
      *****************************
      *** THRESHOLD CALCULATION ***
      *****************************
      *
     C           FECALT    IFEQ '02'
     C           FECALT    OREQ '05'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '15'
      *
      *** Amount type processing
      *
     C           FEPIND    IFEQ 'A'
      *
      *** Use power array to multiply each threshold amount by the
      *** element four on from the number of decimal places of the
      *** currency (i.e., if 0 dec. places use element 4; etc)
      *** and place in separate array (FAM)
      *
     C                     Z-ADD1         W
     C           FEFCCY    LOKUPCURR,W                   65
      *
     C           CCDP,W    ADD  4         P
     C           FEEM      MULT POWER,P   FAM
      *
      *** Look up FAM array for amount greater than or equal to work
      *** amount (difference in field lengths so put WAMT in workfield
      *** to carry out LOKUP)
      *
     C                     Z-ADD1         X
     C           WAMT      LOKUPFAM,X                65  65
      *
      ***  If none found perform last rate processing
      *
     C           *IN65     IFEQ '0'
     C                     EXSR LSTRAT
     C                     ENDIF
      *
     C           *IN65     IFEQ '0'
     C           Y         ANDEQ0
      *
      ***  If none found and appropriate amount & rate combination
      ***  from LSTRAT subroutine not found zeroise work amount.
     C                     MULT 0         WAMT
     C                     ELSE
      *
     C                     MULT FRT,X     WAMT
     C                     ENDIF
      *
     C                     ENDIF
      *
      *** Percentage type processing
      *
     C           FEPIND    IFNE 'A'
      *
      *** Divide each threshold amount by 1000 & store in array
      *
     C           FEEM      DIV  1000      FPC
      *
      *** Search percentage array to find value larger than or equal
      *** to WPCT
      *
     C                     Z-ADD1         X
     C           WPCT      LOKUPFPC,X                65  65
      *
      *** If none found perform last rate processing
      *
     C           *IN65     IFEQ '0'
     C                     EXSR LSTRAT
     C                     ENDIF
      *
     C                     MULT WPCT      WAMT
      *
     C           *IN65     IFEQ '0'
     C           Y         ANDEQ0
     C                     MULT 0         WAMT
     C                     ELSE
      *
     C                     MULT FRT,X     WAMT
     C                     ENDIF
      *
     C                     DIV  100       WAMT
      *
     C                     ENDIF
      *
     C           WAMT      MULT WDAYS     WTOT
     C                     DIV  WCBS      WTOT      H
      *
     C                     ENDIF
      *
      ***************************
      *** SINGLE CALCULATION: ***
      ***************************
      *
     C           FECALT    IFEQ '03'
     C           FECALT    OREQ '06'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '16'
     C           FECALT    OREQ '21'
     C           FECALT    OREQ '22'
      *
     C           WAMT      MULT FRT,1     WTOT
     C                     MULT WDAYS     WTOT
     C                     DIV  WCBS      WTOT      H
      *
     C                     ENDIF
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT                                                                                  CLE073
      *****************************************************************                       CLE073
      * Subroutine  :  DUEFEL                                         *                       CLE073
      * Function    :  Calculate amount for loan calculated fees      *                       CLE073
      *                and add due amount                             *                       CLE073
      *****************************************************************                       CLE073
     C           DUEFEL    BEGSR                                                              CLE073
      *                                                                                       CLE073
     C           FELPDT    IFNE 0                                                             CLE073
     C                     Z-ADDFELPDT    WSTART  50                                          CLE073
     C                     ELSE                                                               CLE073
     C                     Z-ADDFEPSTD    WSTART                                              CLE073
     C                     END                                                                CLE073
      *                                                                                       CLE073
      ** Set up end date:                                                                     CLE073
      *                                                                                       CLE073
     C                     Z-ADDWPAYD     WEND    50                                          CLE073
      *                                                                                       CLE073
      ** Use start & end dates to obtain number of days in whole                              CLE073
      ** calculation period.                                                                  CLE073
      *                                                                                       CLE073
     C                     Z-ADDWSTART    ZZBEG                                               CLE073
     C                     Z-ADDWEND      ZZEND                                               CLE073
     C                     MOVE FECALC    ZZCALC                                              CLE073
     C                     EXSR ZINTDY                                                        CLE073
     C           FECALC    IFEQ 6                                                             CLE073
     C                     Z-ADDINT6DY    WDAYS                                               CLE073
     C                     ELSE                                                               CLE073
     C                     Z-ADDZZINDY    WDAYS   50                                          CLE073
     C                     END                                                                CLE073
     C           FECALT    IFEQ '97'                                                          CLE073
     C           FECALT    OREQ '98'                                                          CLE073
     C                     EXSR CALFEL                                                        CLE073
     C                     END                                                                CLE073
      *                                                                                       CLE073
     C           FENPYD    IFEQ BJRDNB                                                        CLE073
     C                     ADD  FEAMTP    WFEEA                                               CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     ENDSR                                                              CLE073
      *                                                                                       CLE073
      *****************************************************************                       CLE073
      /EJECT                                                                                  CLE073
      *****************************************************************                       CLE073
      * Subroutine  :  CALFEL                                         *                       CLE073
      * Function    :  Calculate amount for loan calculated fees      *                       CLE073
      *                                                               *                       CLE073
      *****************************************************************                       CLE073
     C           CALFEL    BEGSR                                                              CLE073
      *                                                                                       CLE073
     C                     MOVE FEBRCA    WBRCA                                               CLE073
     C           WLOAN     CHAINCLOANCKK             79                                       CLE073
     C           KEYPHS    CHAINLEHISTLB             80                                       CLE073
     C           *IN80     IFEQ *OFF                                                          CLE073
     C                     Z-ADDPRAMM     OPAMK                                               CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Type 98: Loan Original Amount                                                        CLE073
      *                                                                                       CLE073
     C           FECALT    IFEQ '98'                                                          CLE073
     C           *IN79     IFNE *ON                                                           CLE073
     C           *IN80     OREQ *OFF                                                          CLE073
     C                     Z-ADDOPAMK     AAMT                                                CLE073
     C                     Z-ADDOPAMK     WAMT                                                CLE073
     C                     ENDIF                                                              CLE073
     C                     ENDIF                                                              CLE073
     C                     MOVE 'A'       WCLRT                                               CLE073
     C           KEY005    CHAINCLOAN                79                                       CLE073
      *                                                                                       CLE073
     C           FECALT    IFEQ '97'                                                          CLE073
     C                     EXSR CALT97                                                        CLE073
      *                                                                                       CLE073
     C                     ELSE                                                               CLE073
      *                                                                                       CLE073
      ** Process accrual                                                                      CLE073
      *                                                                                       CLE073
     C                     EXSR ACCRUL                                                        CLE073
     C                     Z-ADDWTOT      WFEEA                                               CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     ENDSR                                                              CLE073
      /EJECT                                                                                  CLE073
      *****************************************************************                       CLE073
      * Subroutine  :  ACCRUL                                         *                       CLE073
      * Function    :  Calculate accrual amount                       *                       CLE073
      *                                                               *                       CLE073
      *****************************************************************                       CLE073
     C           ACCRUL    BEGSR                                                              CLE073
      *                                                                                       CLE073
     C                     Z-ADD0         WTOT                                                CLE073
     C                     Z-ADD0         WRK15                                               CLE073
     C           WAMT      IFNE 0                                                             CLE073
      *                                                                                       CLE073
     C                     Z-ADDWAMT      WEAMT                                               CLE073
     C                     MOVE CCYL      INCCY                                               CLE073
     C                     MOVE FEFCCY    OUTCCY                                              CLE073
     C                     EXSR CONV                                                          CLE073
     C                     Z-ADDWEAMT     WAMT                                                CLE073
      *                                                                                       CLE073
      ** Retrieve calculation basis                                                           CLE073
      *                                                                                       CLE073
     C                     MOVE FECALC    WCALC   1                                           CLE073
      *                                                                                       CLE073
     C           WCALC     LOKUPTABCAL    TABCBS         65                                   CLE073
     C           *IN65     IFEQ '1'                                                           CLE073
     C                     Z-ADDTABCBS    WCBS    50                                          CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Apply rate                                                                           CLE073
      *                                                                                       CLE073
     C           FECALT    IFEQ '97'                                                          CLE073
     C           FECALT    OREQ '98'                                                          CLE073
     C                     Z-ADD1         X                                                   CLE073
     C           WAMT      IFGT 0                                                             CLE073
     C           FRT,X     ANDGT0                                                             CLE073
     C           WAMT      MULT FRT,X     WRK15                                               CLE073
     C                     ADD  WRK15     WTOT                                                CLE073
     C                     ENDIF                                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Calculate final accrual amount.                                                      CLE073
      *                                                                                       CLE073
     C                     MULT WDAYS     WTOT                                                CLE073
      *                                                                                       CLE073
     C           WTOT      IFNE 0                                                             CLE073
     C                     DIV  WCBS      WTOT      H                                         CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     ENDSR                                                              CLE073
      /EJECT                                                                                  CLE073
      *****************************************************************                       CLE073
      * Subroutine  :  CALT97                                         *                       CLE073
      * Function    :  Calculate amount for calculation type 97       *                       CLE073
      *                                                               *                       CLE073
      *****************************************************************                       CLE073
     C           CALT97    BEGSR                                                              CLE073
      *                                                                                       CLE073
      ** Initialise work fields                                                               CLE073
      *                                                                                       CLE073
     C                     Z-ADD0         WFEEA                                               CLE073
     C                     Z-ADD0         WAMT                                                CLE073
     C                     Z-ADD0         AAMT                                                CLE073
     C                     Z-ADDWSTART    WVDAT                                               CLE073
     C                     Z-ADDWSTART    STDATE  50                                          CLE073
     C                     MOVE FEBRCA    WBRCA   3                                           CLE073
      *                                                                                       CLE073
     C                     MOVE 'A'       WCLRT                                               CLE073
     C           KEY005    CHAINCLOAN                79                                       CLE073
      *                                                                                       CLE073
     C                     Z-ADDOPAMK     AAMT                                                CLE073
     C                     Z-ADD999       WLASN                                               CLE073
      *                                                                                       CLE073
      ** Get amount from loan history file                                                    CLE073
      *                                                                                       CLE073
     C           KEYHST    SETGTLEHISTLA                                                      CLE073
     C           KEYPHS    REDPELEHISTLA                 18                                   CLE073
     C           *IN18     IFEQ *OFF                                                          CLE073
     C                     Z-ADDCPAMP     AAMT                                                CLE073
     C                     ELSE                                                               CLE073
     C                     Z-ADD001       WLASN                                               CLE073
     C           KEYHST    SETLLLEHISTLA                 18                                   CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Read file until date read is greater than date of end of                             CLE073
      ** this accrual period.                                                                 CLE073
      ** NDAYS is the number of days in this accrual.                                         CLE073
      *                                                                                       CLE073
     C                     MOVE '0'       *IN18                                               CLE073
     C           *IN18     DOWEQ'0'                                                           CLE073
     C           KEYPHS    READELEHISTLA                 18                                   CLE073
      *                                                                                       CLE073
     C           *IN18     IFEQ '1'                                                           CLE073
     C           VDATP     ORGT WEND                                                          CLE073
     C                     Z-ADDWEND      VDATP                                               CLE073
     C                     MOVE '1'       *IN18                                               CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     Z-ADDSTDATE    ZZBEG                                               CLE073
     C           VDATP     IFGT STDATE                                                        CLE073
     C                     Z-ADDVDATP     ZZEND                                               CLE073
     C                     ELSE                                                               CLE073
     C                     Z-ADDSTDATE    ZZEND                                               CLE073
     C                     ENDIF                                                              CLE073
     C                     MOVE FECALC    ZZCALC                                              CLE073
     C                     EXSR ZINTDY                                                        CLE073
     C           FECALC    IFEQ 6                                                             CLE073
     C                     Z-ADDINT6DY    NDAYS                                               CLE073
     C                     ELSE                                                               CLE073
     C                     Z-ADDZZINDY    NDAYS   50                                          CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C           NDAYS     IFGT 0                                                             CLE073
     C                     Z-ADDAAMT      WAMT                                                CLE073
     C                     Z-ADDNDAYS     WDAYS                                               CLE073
     C                     EXSR ACCRUL                                                        CLE073
     C                     ADD  WTOT      WFEEA                                               CLE073
     C                     ENDIF                                                              CLE073
     C           VDATP     IFGT STDATE                                                        CLE073
     C                     Z-ADDVDATP     STDATE                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Reset amount to accrue - comes from next record on amount                            CLE073
      ** file.                                                                                CLE073
      *                                                                                       CLE073
     C           *IN18     IFNE '1'                                                           CLE073
     C                     Z-ADDCPAMP     AAMT                                                CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     ENDDO                                                              CLE073
      *                                                                                       CLE073
     C                     ENDSR                                                              CLE073
     C/COPY WNCPYSRC,AOH00016
      *****************************************************************                       CLE073
      /EJECT
      *****************************************************************
      * Subroutine  :  FEVNTS                                         *
      * Function    :  Subroutine to process event records            *
      *                                                               *
      * Called by   :  CALFEE - Check calculated facility fees are    *
      *                         due this run                          *
      * Calls       :  CONV - Convert event amount into facility ccy  *
      *****************************************************************
     C           FEVNTS    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'FEVNTS'  @STK,Q
      *
      ***  Obtain all event details for the facility being processed.
      *
     C                     MOVE WCNUM     WCNUMA
     C                     MOVELFEFACL    WFAC03
     C                     MOVE FEFACL    WFAC02
      *
     C           KEYEV4    SETLLLVENTL4
     C           KEYEV4    READELVENTLF4                 72
      *
     C           *IN72     DOWEQ'0'
     C                     MOVELETYP      PTP     2
     C           PTP       IFNE '66'                       Part Sold
     C           PTP       ANDNE'67'                       Part Sold
      *                                                                   CLE005
      ***  Check if processing type is part sold                          CLE005
      ***  New processing types 69 and 72                                 CLE005
      ***  No need to condition as this is a new pgm for CLE005           128565
      *                                                                   CLE005
     C***********CLE005    IFEQ 'Y'                                       128565
     C           PTP       ANDNE'69'                       Part Sold      CLE005
     C           PTP       ANDNE'72'                       Part Sold      CLE005
     C***********CLE005    OREQ 'N'                                       128565
      *
      ***  Availability increased for the following events
      *
     C                     Z-ADD1         X       20
     C           EDAT      LOKUPRUN,X                65  65
     C           *IN65     IFEQ '1'
      ***  Changes to exposure or availability must be done in
      ***  the facility currency so if event currency different
      ***  the event amount needs to be converted.
      *
     C                     MOVE ECCY      INCCY   3
     C                     MOVE FCCY      OUTCCY  3
     C                     Z-ADDEAMT      WEAMT  130
     C                     EXSR CONV
      *
     C           X         DOWLT10
     C                     SUB  WEAMT     FFAM,X
     C                     ADD  1         X
     C                     ENDDO
      *
     C                     ENDIF
     C***********          ENDIF                                          128565
     C                     ENDIF
      *
     C           KEYEV4    READELVENTLF4                 72
     C                     ENDDO
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  LSTRAT                                         *
      * Function    :  Perform last rate processing if LOKUP failed   *
      *                                                               *
      * Called by   :  ACCRUE - Calculate accrual amount              *
      * Calls       :                                                 *
      *****************************************************************
     C           LSTRAT    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'LSTRAT'  @STK,Q
      *
     C                     Z-ADD5         Y       20
     C           Y         DOWGT0
      *
      ***  If current fee amount being processed is zero and its
      ***  corresponding fee rate on FRT array is not zero, set
      ***  array element count (in SR/ACCRUE) to the value of Y and
      ***  zeroise afterwards.
      *
     C           FEEM,Y    IFEQ 0
     C           FRT,Y     ANDNE0
     C                     Z-ADDY         X
     C                     Z-ADD0         Y
     C                     ENDIF
     C                     SUB  1         Y
     C                     ENDDO
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  CONV                                           *
      * Function    :  Convert event amounts into facility currency   *
      *                                                               *
      * Called by   :  FEVNTS - Process event records                 *
      *                ACCRUE - Calculate accrual amount              *
      * Calls       :                                                 *
      *****************************************************************
     C           CONV      BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'CONV  '  @STK,Q
      *
      ***  If currencies are the same retrieve relevant currency
      ***  details, but if currencies are different it is necessary
      ***  to first obtain the cross exchange rate between the two
      ***  currencies and use this to convert to appropriate
      ***  currency.
      *
     C           INCCY     IFEQ OUTCCY
     C                     Z-ADD1         W
     C           INCCY     LOKUPCURR,W                   65
     C           *IN65     IFEQ '1'
     C                     MOVE MTDV,W    ZMDI1   1
     C                     Z-ADDCSPT,W    ZRATE1 138
     C                     Z-ADDCCDP,W    ZNBDP1  10
     C                     ELSE
     C                     EXSR SRERR
     C                     ENDIF
     C                     ENDIF
      *
     C           INCCY     IFNE OUTCCY
     C                     Z-ADD1         W
     C           INCCY     LOKUPCURR,W                   65
     C           *IN65     IFEQ '1'
     C                     MOVE MTDV,W    ZMDI1   1
     C                     Z-ADDCSPT,W    ZRATE1 138
     C                     Z-ADDCCDP,W    ZNBDP1  10
     C                     ELSE
     C                     EXSR SRERR
     C                     ENDIF
      *
     C                     Z-ADD1         W
     C           OUTCCY    LOKUPCURR,W                   65
     C           *IN65     IFEQ '1'
     C                     MOVE MTDV,W    ZMDI2   1
     C                     Z-ADDCSPT,W    ZRATE2 138
     C                     Z-ADDCCDP,W    ZNBDP2  10
     C                     ELSE
     C                     EXSR SRERR
     C                     ENDIF
      *
      ***  Obtain cross exchange rate & cross multiply/divide indicator
      *
     C                     EXSR ZXRATE
      *
      ***  Set up input fields for conversion SR
      *
     C                     Z-ADDZRATEX    ZEXCH  138
     C                     MOVE ZMDIX     ZMD     1
     C                     Z-ADDWEAMT     ZAMTCI 150
     C                     MOVE INCCY     ZCCYI   3
     C                     MOVE OUTCCY    ZCCYO   3
     C                     Z-ADDZNBDP1    ZCDPI   10
     C                     Z-ADDZNBDP2    ZCDPO   10
      *
     C                     EXSR ZCONV
      *
     C                     Z-ADDZAMTCO    WEAMT
      *
     C                     ENDIF
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * Subroutine  :  SRMOVE                                         *
      * Function    :  Pass Movement To Write Program                 *
      *                                                               *
      * Called by   :  Various                                        *
      * Calls       :  None                                           *
      *****************************************************************
     C           SRMOVE    BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'SRMOVE'  @STK,Q
      *
      *................................................................
      *
      ** Bypass if no amount to post
      *
     C           ##AMT     CABEQ*ZERO     EXMOVE
      *
      ** Determine account movement settlement details
      *
      ** If Lending Enhancements for is on.                                                   CLE031
      ** Check whether a settlement currency has been used:                                   CLE031
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
      *                                                                                       CLE031
     C           ##PYRC    IFEQ 'R'                                                           CLE031
     C           SVSCCY    ANDNE*BLANK                                                        CLE031
      *                                                                                       218782
     C           CLE033    IFNE 'Y'                                                           218782
     C           SET09     ORNE 'T'                                                           218782
     C           ##RECM    ORNE '09'                                                          218782
      * Store receipt settlement details                                                      CLE031
     C                     MOVELSVSCCY    ##CCY   3                                           CLE031
     C                     ENDIF                                                              218782
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C           ##PYRC    IFEQ 'P'                                                           CLE031
     C           SVPSCY    ANDNE*BLANK                                                        CLE031
      *                                                                                       218782
     C           CLE033    IFNE 'Y'                                                           218782
     C           SET09     ORNE 'T'                                                           218782
     C           ##PAYM    ORNE '09'                                                          218782
      * Store pay settlement details                                                          CLE031
     C                     MOVELSVPSCY    ##CCY   3                                           CLE031
     C                     ENDIF                                                              218782
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     CLEARC#DTA
     C/COPY WNCPYSRC,AOOUFEU0C2
     C           CLE033    IFEQ 'Y'                                       CLE033
     C           ##SETM    ANDEQ'09'                                      CLE033
      *                                                                   CLE033
     C                     MOVE 'P'       C#ATYP                          CLE033
     C                     MOVELP@VL01    C#CNUM                          CLE033
     C                     MOVELP@VL02    C#ACOD                          CLE033
     C                     MOVEL'01'      C#ACSQ                          CLE033
     C                     MOVELFEBRCA    C#BRCA                          CLE033
     C*********************MOVEL##BRCA    C#BRCA                          CLE033
      *                                                                   CLE033
     C                     ENDIF                                          CLE033
      *
     C           ##SETM    IFEQ '01'
     C           ##SETM    OREQ '02'
     C           ##SETM    OREQ '07'
     C           ##SETM    OREQ '08'
     C           ##SETM    OREQ '12'
     C                     MOVEL'N'       C#ATYP
     C                     MOVEL##NOSN    C#NOSN
     C                     ELSE
     C           ##SETM    IFEQ '14'
     C                     MOVEL'R'       C#ATYP
     C                     MOVEL##ACNO    C#ACNO
     C                     ELSE
     C           ##SETM    IFEQ '04'
     C           ##SETM    OREQ '05'
     C                     MOVEL'P'       C#ATYP
     C                     MOVEL##CNUM    C#CNUM
     C                     MOVEL##ACOD    C#ACOD
     C                     MOVEL##ACSQ    C#ACSQ
     C                     MOVEL##BRCA    C#BRCA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** OLPOS Incoming/Outgoing Indicator 'I' or 'O'
      *
     C           ##PYRC    IFEQ 'P'
     C                     MOVEL'O'       C#IO             * outgoing
     C                     ELSE
     C                     MOVEL'I'       C#IO             * incoming
     C                     END
      *
      ** Currency of transaction
      *
     C                     MOVEL##CCY     C#CCY
      *
      ** Transaction type
      *
     C                     MOVEL##TRYP    C#TRYP
      *
      ** Transaction Narrative
      *
     C/COPY WNCPYSRC,AOH00033
     C                     MOVEL##NARR    C#NARR
     C/COPY WNCPYSRC,AOH00034
      *
      ** LE transaction reference
      *
     C                     MOVEL##TRN     C#TRN
     C/COPY WNCPYSRC,AOH00003
      *                                                                                       CRE020
     C           CRE020    IFEQ 'Y'                                                           CRE020
     C           ##REVI    IFEQ 'YES'                                                         CRE020
     C                     MOVE '*'       C#NARR                                              CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
     C           C#TRYP    IFEQ 'F2'                                                          CRE020
     C                     MOVELFECNUM    C#PREF                                              CRE020
     C                     ENDIF                                                              CRE020
     C                     ENDIF                                                              CRE020
      *
      ** Movement amount
      *                                                                                       CLE031
      *                                                                                       CER049
      ** If CLE031 - Lending Enhancements                                                     CLE031
      ** or CEU004 (EMU Settlement Ccy Conversion) is installed,                              CLE031
      ** check for settlement currency.                                                       CLE031
      *                                                                                       CLE031
     C                     MOVE 'N'       WRKEMU                                              CLE031
      * If CLE033 is on and settlement method is 09, postings can be                          218782
      * left in transaction ccy instead, if System Value = 'T'.                               218782
      *                                                                                       218782
     C           CLE033    IFNE 'Y'                                                           218782
     C           SET09     ORNE 'T'                                                           218782
     C           ##PAYM    ORNE '09'                                                          218782
     C           ##PYRC    ANDEQ'P'                                                           218782
     C           ##RECM    ORNE '09'                                                          218782
     C           ##PYRC    ANDEQ'R'                                                           218782
      *
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           FESCCY    ANDNE*BLANKS                                   CEU004
     C           FESCCY    ANDNEFEFCCY                                    CEU004
     C           CLE031    ANDNE'Y'                                                           CLE031
     C           CLE031    OREQ 'Y'                                                           CLE031
     C           ##PYRC    ANDEQ'R'                                                           CLE031
     C           FESCCY    ANDNE*BLANK                                                        CLE031
     C           FESCCY    ANDNEFEFCCY                                                        CLE031
     C           CLE031    OREQ 'Y'                                                           CLE031
     C           ##PYRC    ANDEQ'P'                                                           CLE031
     C           FEPSCY    ANDNE*BLANK                                                        CLE031
     C           FEPSCY    ANDNEFEFCCY                                                        CLE031
      *                                                                                       CLE031
      * Determine which settlement ccy to use:                                                CLE031
     C           CLE031    IFNE 'Y'                        CEU004 set. ccy                    CLE031
     C           CLE031    OREQ 'Y'                                                           CLE031
     C           ##PYRC    ANDEQ'R'                                                           CLE031
     C                     MOVE FESCCY    SETCCY  3                                           CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE FEPSCY    SETCCY                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
      * Check if movement currency is 'In' or 'EUR'.                                          CLE031
     C                     MOVELFEFCCY    WCCY    3                                           CLE031
     C                     EXSR SRCURR                                                        CLE031
     C                     MOVE A6NBDP    CCYDP   10                                          CLE031
     C                     Z-ADDA6SPRT    CCYSPT 138                                          CLE031
     C                     MOVE A6MDIN    CCYMDI  1                                           CLE031
     C           A6INCY    IFEQ 'Y'                                                           CLE031
     C                     MOVE 'Y'       WRKEMU  1                                           CLE031
     C                     ENDIF                                                              CLE031
      * Check if settlement currency is 'In' or 'EUR'.                                        CLE031
      * If EUR movement, settled in an 'In' ccy, use EU0200.                                  CLE031
     C                     MOVE SETCCY    WCCY                                                CLE031
     C                     EXSR SRCURR                                                        CLE031
     C                     MOVE A6NBDP    SETDP   10                                          CLE031
     C                     MOVE A6SPRT    SETSPT 138                                          CLE031
     C                     MOVE A6MDIN    SETMDI  1                                           CLE031
      *                                                                                       CLE031
      * If EUR movement, settled in an 'In' ccy, use EU0200.                                  CLE031
     C           A6INCY    IFEQ 'Y'                                                           CLE031
     C                     MOVE 'Y'       WRKEMU                                              CLE031
     C                     ENDIF                                                              CLE031
      * If amount needs to be converted between EUR and                                       CLE031
      * an In currency, use EU0200.                                                           CLE031
     C           WRKEMU    IFEQ 'Y'                                                           CLE031
     C                     MOVE *BLANKS   PRTCD                           CEU004
     C                     Z-ADD##AMT     PFRAM                           CEU004
     C                     MOVE FEFCCY    PFRCY                           CEU004
     C**********           MOVE FESCCY    PTOCY                                        CEU004 CLE031
     C                     MOVE SETCCY    PTOCY                                               CLE031
     C                     Z-ADD0         POUTA                           CEU004
     C                     Z-ADD0         PINTA                           CEU004
     C                     Z-ADD0         PEXRT                           CEU004
     C                     MOVE *BLANKS   PMDIN                           CEU004
      *                                                                   CEU004
     C                     CALL 'EU0200'                                  CEU004
     C                     PARM           PRTCD   7                       CEU004
     C                     PARM           PFRAM  183                      CEU004
     C                     PARM           PFRCY   3                       CEU004
     C                     PARM           PTOCY   3                       CEU004
     C                     PARM           POUTA  150                      CEU004
     C                     PARM           PINTA  183                      CEU004
     C                     PARM           PEXRT  159                      CEU004
     C                     PARM           PMDIN   1                       CEU004
      *                                                                   CEU004
     C           PRTCD     IFEQ *BLANKS                                   CEU004
     C                     Z-ADDPOUTA     ##AMT                           CEU004
     C                     ELSE                                           CEU004
     C                     MOVEL'*CALL   'W0FILE                          CEU004
     C                     MOVEL'EU0200  'W0KEY                           CEU004
     C                     Z-ADD904       W0ERNB                          CEU004
     C                     EXSR SRERR                                     CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C                     ELSE                                                               CLE031
      * Else, convert using settlement exchange rate.                                         CLE031
      * Determine which rate to use:                                                          CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C           ##PYRC    ANDEQ'R'                                                           CLE031
     C                     Z-ADDFEREXR    ZEXCH                                               CLE031
     C                     MOVE FEREXI    ZMD                                                 CLE031
     C                     ELSE                                                               CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C           ##PYRC    ANDEQ'P'                                                           CLE031
     C                     Z-ADDFEPEXR    ZEXCH                                               CLE031
     C                     MOVE FEPEXI    ZMD                                                 CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     Z-ADD##AMT     ZAMTCI                                              CLE031
     C                     MOVE FEFCCY    ZCCYI                                               CLE031
     C                     MOVE SETCCY    ZCCYO                                               CLE031
     C                     Z-ADDCCYDP     ZCDPI                                               CLE031
     C                     Z-ADDSETDP     ZCDPO                                               CLE031
     C                     EXSR ZCONV                                                         CLE031
     C                     Z-ADDZAMTCO    ##AMT                                               CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
     C                     ENDIF                                                              218782
      *                                                                                       218782
     C           ##PYRC    IFEQ 'P'
     C           ##REVI    ANDNE'YES'
     C           ##PYRC    OREQ 'R'
     C           ##REVI    ANDEQ'YES'
     C                     Z-SUB##AMT     C#AMT            * pay ie credit
     C                     ELSE
     C                     Z-ADD##AMT     C#AMT            * rec ie debit
     C                     END
      *
      ** Module
      *
     C                     MOVEL'LE'      C#MOD
      *
      ** Olpos record number to update
      ** '01' for FX (not used here)
      ** '02' for Interest movements
      ** '03' for Loans and deposits
      *
     C           ##RPNB    IFEQ 2
     C                     MOVE '02'      C#OLRC
     C                     ELSE
     C                     MOVE '03'      C#OLRC
     C                     END
      *
      ** Value date and posting date
      *
     C                     Z-ADD##VDAT    C#VDAT
     C                     Z-ADD##VDAT    C#PSTD
      *
      ** Indicator to show if removal allowed Y, N or " "
      *
     C                     MOVEL'Y'       C#RPST
      *
      ** Removal set number
      *
     C                     Z-ADD##RPNB    C#RPNB
      *
      ** Removal type "C" = Credit entries
      **              "D" = Debit entries
      *
     C                     MOVEL'C'       C#RTYP
      *
      ** Booking branch
      *
     C                     MOVEL##BBRN    C#BBRN
      *                                                                                       CLE134
      ** Extension Reference Id/Number.                                                       CLE134
      *                                                                                       CLE134
     C                     MOVELFEXRFI    C#XRFI                                              CLE134
     C                     MOVELFEXRFN    C#XRFN                                              CLE134
      *
      ** If settlement details are present
      ** AOSPOSU0 will be called to update PRONO, MEMOS, RSACMTPD, OLPOS
      **
      ** OTHERWISE
      **
      ** If no settlement details are present
      ** AOSPOSU0 will be called to only update OLPOS
      *
     C           C#ATYP    IFEQ *BLANK
      *
      ** Set account type indicator to signify no settlement
      *
     C                     MOVEL'X'       C#ATYP
      *
      ** Set update indicators for no update
      *
     C                     MOVE 'N'       C#PRON
     C                     MOVE 'N'       C#MEMS
     C                     MOVE 'N'       C#RSAC
     C                     ENDIF
      *                                                                   CLE033
      * CLE033 LEHOSTPD postings                                          CLE033
     C           #HPOST    IFEQ *BLANKS                                                      BUG8567
     C           ##VDAT    IFLT BJDNWD                                    CLE033
     C           CLE033    ANDEQ'Y'                                       CLE033
     C           ##SETM    ANDEQ'09'                                      CLE033
     C                     EXSR HPOST                                     CLE033
     C                     ENDIF                                          CLE033
     C                     ENDIF                                                             BUG8567
      *                                                                                    AR1022006
      ** Set C#OTR1                                                                        AR1022006
      *                                                                                    AR1022006
     C                     MOVE *BLANKS   C#OTR1                                           AR1022006
     C           CLE134    IFEQ 'Y'                                                        AR1022006
     C                     MOVE FEFSEQ    WSEQ    2                                        AR1022006
     C           FELOAN    IFNE *BLANKS                                                    AR1022006
     C           FECNUM    CAT  FELOAN    OTR112 12                                        AR1022006
     C           OTR112    CAT  WSEQ      C#OTR1                                           AR1022006
     C                     ELSE                                                            AR1022006
     C           FEFACL    IFNE 0                                                          AR1022006
     C                     MOVE FEFACL    WFACL   5                                        AR1022006
     C           FECNUM    CAT  WFACL     OTR111 11                                        AR1022006
     C           OTR111    CAT  WSEQ      C#OTR1                                           AR1022006
     C                     ENDIF                                                           AR1022006
     C                     ENDIF                                                           AR1022006
     C                     ENDIF                                                           AR1022006
      *                                                                   CLE033
      *                                                                                       CAP205
      ** Set C#MTYP to ##MTYP                                                                 CAP205
      *                                                                                       CAP205
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVEL##MTYP    C#MTYP                                              CAP205
     C                     ENDIF                                                              CAP205
      *
      ** Call AOSPOSU0
      *
     C                     CALL 'AOSPOSU0'             9090
     C***********R#RTN     PARM *BLANKS   O#RTN   7                       134284
     C           R#RTN     PARM ##RTCD    O#RTN   7                       134284
     C                     PARM '*ADD    'W0ACT   8
     C                     PARM C#DTA     O#DTA 256
      *
     C           *IN90     IFEQ '1'
     C***********R#RTN     ORNE *BLANKS                                   134284
     C           R#RTN     OREQ '*ERROR*'                                 134284
     C                     MOVEL'*CALL   'W0FILE  8
     C                     MOVEL'AOSPOSU0'W0KEY  29
     C                     Z-ADD902       W0ERNB  30
     C                     EXSR SRERR
     C                     END
      *
      *................................................................
      *
     C           EXMOVE    TAG
      *
      **  Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************   CLE033
      *                                                               *   CLE033
      *  HPOST    : Write record to host file                         *   CLE033
      *                                                               *   CLE033
      *  CALLED BY: Various                                           *   CLE033
      *                                                               *   CLE033
      *  CALLS    : N/A                                               *   CLE033
      *                                                               *   CLE033
      *****************************************************************   CLE033
     C           HPOST     BEGSR                                          CLE033
      *                                                                   CLE033
      * Only if Autosettle is on                                          CLE033
     C           FEAUTO    IFEQ 'Y'                                       CLE033
     C           FEAUTO    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           FEAUT2    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                   CLE033
     C                     SELEC                                          CLE033
     C           FELCHT    WHEQ 'I'                                       CLE033
     C           ##REVI    ANDNE'YES'                                     CLE033
     C           FELCHT    OREQ 'A'                                       CLE033
     C           WBSETM    ANDNE'09'                                      CLE033
     C           ##SETM    ANDEQ'09'                                      CLE033
     C           #BRCID    ANDNE*BLANKS                                   CLE033
     C           ##REVI    ANDNE'YES'                                     CLE033
     C                     MOVEL'Insert  'HOACTN                          CLE033
     C           FELCHT    WHEQ 'A'                                       CLE033
     C           ##REVI    ANDNE'YES'                                     CLE033
     C                     MOVEL'Amend   'HOACTN                          CLE033
     C           FELCHT    WHEQ 'R'                                       CLE033
     C           ##REVI    OREQ 'YES'                                     CLE033
     C                     MOVEL'Reverse 'HOACTN                          CLE033
     C                     ENDSL                                          CLE033
      *                                                                   CLE033
     C                     MOVE *BLANKS   HOTRYP                                              218338
     C                     MOVE *BLANKS   HOETYD                                              218338
     C           ##TRYP    IFEQ 'F1'                                      CLE033
     C                     MOVEL'Loan Fee'HOTRYP                          CLE033
     C                     MOVEL'71F1'    HOETYP                          CLE033
     C           'Fee '    CAT  'Payment' HOETYD                          CLE033
     C                     ELSE                                           CLE033
     C           'Facility'CAT  ' Fee'    HOTRYP                          CLE033
     C                     MOVEL'71F2'    HOETYP                          CLE033
     C           'Facility'CAT  ' Fee'    HOETYD                          CLE033
     C                     ENDIF                                          CLE033
      *                                                                   CLE033
     C**********           Z-ADDFECNUM    HOCNUM                                       CLE033 CSD027
     C                     MOVE FECNUM    HOCNUM                                              CSD027
     C**********           Z-ADDFELOAN    HOLNRF                                       CLE033 CLE148
     C                     MOVELFELOAN    HOLNRF                                              CLE148
     C                     Z-ADD0         HOLASN                          CLE033
      *                                                                   CLE033
     C                     MOVE FEFACL    W0FACL  5                       CLE033
     C                     MOVELW0FACL    HOFTYP                          CLE033
     C                     MOVE W0FACL    HOFSEQ                          CLE033
      *                                                                   CLE033
     C                     Z-ADDFEFSEQ    HOFESQ                          CLE033
     C                     MOVE FEBRCA    HOBRCA                          CLE033
      *                                                                   CLE033
     C           ##TRYP    IFEQ 'F1'                                      CLE033
     C                     MOVE FELTYP    HOLTYP                          CLE033
     C                     MOVE FESUTP    HOSUTP                          CLE033
     C                     MOVE FECLAS    HOCLAS                          CLE042
     C                     ELSE                                           CLE033
     C                     MOVE *BLANKS   HOLTYP                          CLE033
     C                     MOVE *BLANKS   HOSUTP                          CLE033
     C                     MOVE *BLANKS   HOCLAS                          CLE042
     C/COPY WNCPYSRC,AOH00001
     C                     ENDIF                                          CLE033
      *                                                                   CLE033
     C                     Z-ADDBJRDNB    HOPSTD                          CLE033
     C                     Z-ADD##VDAT    HOVALD                          CLE033
     C                     MOVE FEFCCY    HOCCY                           CLE033
      *                                                                   CLE033
     C                     Z-ADD##AMT     HOPSTA                          CLE033
      *                                                                   CLE033
     C                     MOVEL##NARR    HOPNAR                          CLE033
     C                     MOVE FEAUTO    HOAUTO                          CLE033
      *                                                                   CLE033
     C           ##REVI    IFEQ 'YES'                                     CLE033
     C           ##PYRC    IFEQ 'P'                                       CLE033
     C                     MOVE 'R'       HOTLXY                          CLE033
     C                     ELSE                                           CLE033
     C                     MOVE 'P'       HOTLXY                          CLE033
     C                     ENDIF                                          CLE033
     C                     ELSE                                           CLE033
     C                     MOVE ##PYRC    HOTLXY                          CLE033
     C                     ENDIF                                          CLE033
      *                                                                                       220257
      * If posting amount is negative, convert to a positive amount                           220257
      * and change the debit/credit indicator                                                 220257
      *                                                                                       220257
     C           ##AMT     IFLT 0                                                             220257
     C                     Z-SUB##AMT     HOPSTA                                              220257
     C           HOTLXY    IFEQ 'P'                                                           220257
     C                     MOVE 'R'       HOTLXY                                              220257
     C                     ELSE                                                               220257
     C                     MOVE 'P'       HOTLXY                                              220257
     C                     ENDIF                                                              220257
     C                     ENDIF                                                              220257
      *                                                                   CLE033
     C                     Z-ADD0         HOINTR                          CLE033
     C                     MOVE *BLANKS   HOBRTT                          CLE033
     C                     Z-ADD0         HOBRTE                          CLE033
     C                     Z-ADD0         HORTSP                          CLE033
     C                     MOVE *BLANKS   HOSPIN                          CLE033
     C                     Z-ADD0         HOMARG                          CLE033
     C                     MOVE FESCCY    HOSCCY                          CLE033
     C                     Z-ADDFEREXR    HOREXR                          CLE033
     C                     MOVE FEREXI    HOREXI                          CLE033
     C                     MOVE ##RECB    HORHBR                          CLE033
     C                     MOVE ##RECA    HORHAC                          CLE033
     C**********           Z-ADDFEROBN    HOROBN                                       CLE033 CSD027
     C**********           Z-ADDFEROCN    HOROCN                                       CLE033 CSD027
     C                     MOVE FEROBN    HOROBN                                              CSD027
     C                     MOVE FEROCN    HOROCN                                              CSD027
     C                     MOVE FERIBN    HORIBN                          CLE033
     C                     MOVE FERIBA    HORIBA                          CLE033
     C                     MOVE FEPSCY    HOPSCY                          CLE033
     C                     Z-ADDFEPEXR    HOPEXR                          CLE033
     C                     MOVE FEPEXI    HOPEXI                          CLE033
     C                     MOVE ##PAYB    HOPHBR                          CLE033
     C                     MOVE ##PAYA    HOPHAC                          CLE033
     C**********           Z-ADDFEPOBN    HOPOBN                                       CLE033 CSD027
     C**********           Z-ADDFEPOCN    HOPOCN                                       CLE033 CSD027
     C                     MOVE FEPOBN    HOPOBN                                              CSD027
     C                     MOVE FEPOCN    HOPOCN                                              CSD027
     C                     MOVE FEPIBA    HOPIBA                          CLE033
     C                     MOVE FERVNO    HORVNO                          CLE033
     C                     MOVE FECVMR    HOCVMR                          CLE033
     C                     MOVE FERCRN    HORCRN                          CLE033
     C                     MOVE FERCRA    HORCRA                          CLE033
     C                     MOVE FEAWBN    HOAWBN                          CLE033
     C                     MOVE FEAWBA    HOAWBA                          CLE033
     C                     MOVE FEBENN    HOBENN                          CLE033
     C                     MOVE FEBENA    HOBENA                          CLE033
     C                     MOVE FEDTP1    HODTP1                          CLE033
     C                     MOVE FEDTP2    HODTP2                          CLE033
     C                     MOVE FEDTP3    HODTP3                          CLE033
     C                     MOVE FEDTP4    HODTP4                          CLE033
     C                     MOVE FEDCHG    HODCHG                          CLE033
     C                     MOVE FEBTB1    HOBTB1                          CLE033
     C                     MOVE FEBTB2    HOBTB2                          CLE033
     C                     MOVE FEBTB3    HOBTB3                          CLE033
     C                     MOVE FEBTB4    HOBTB4                          CLE033
     C                     MOVE FEBTB5    HOBTB5                          CLE033
     C                     MOVE FEBTB6    HOBTB6                          CLE033
     C                     Z-ADDFETNLU    HOTNLU                          CLE033
     C                     MOVE *BLANKS   HOPROG                                              218782
     C                     MOVEL'AOOUFEU0'HOPROG                                              218782
     C                     Z-ADD0         HOSEQN                                              218782
     C                     MOVE *BLANKS   HOSTAT                                              218782
      *                                                                   CLE033
     C                     WRITELEHOSTD0                                  CLE033
      *                                                                   CLE033
     C           P@VL03    IFNE *BLANKS                                   CLE033
     C                     CALL P@VL03                                    CLE033
     C/COPY WNCPYSRC,AOOUFEU0C9                                           CLE033
     C                     ENDIF                                          CLE033
      *                                                                   CLE033
     C                     ENDIF                                          CLE033
      *                                                                   CLE033
     C                     ENDSR                                          CLE033
      *****************************************************************   CLE033
     C/EJECT                                                              CLE033
      *****************************************************************
      *                                                               *
      *  SRUPD    : Update database with shadow postings in store     *
      *                                                               *
      *  CALLED BY: Various                                           *
      *                                                               *
      *  CALLS    : SRERR - Report errors                             *
      *                                                               *
      *****************************************************************
     C           SRUPD     BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'SRUPD'   @STK,Q
      *
      *................................................................
      *
      ** Call AOSPOSU0 to update database
      *
     C                     CALL 'AOSPOSU0'             9090
     C***********R#RTN     PARM *BLANKS   O#RTN   7                       134284
     C           R#RTN     PARM ##RTCD    O#RTN                           134284
     C                     PARM '*UPDATE 'W0ACT   8
     C                     PARM C#DTA     O#DTA 256
      *
     C           *IN90     IFEQ '1'
     C***********R#RTN     ORNE *BLANKS                                   134284
     C           R#RTN     OREQ '*ERROR*'                                 134284
     C                     MOVEL'*CALL   'W0FILE
     C                     MOVEL'AOSPOSU0'W0KEY
     C                     Z-ADD903       W0ERNB
     C                     EXSR SRERR
     C                     ENDIF
      *
      *................................................................
      *
      ** Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *  SRCLR    : Clear all postings in store                       *
      *                                                               *
      *  CALLED BY: Mainline                                          *
      *             UPDATE - Update database                          *
      *                                                               *
      *  CALLS    : SRERR - Report errors                             *
      *                                                               *
      *****************************************************************
     C           SRCLR     BEGSR
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'SRCLR'   @STK,Q
      *
      *................................................................
      *
      ** Clear arrays in AOSPOSU0
      *
     C                     CLEARC#DTA
     C                     CALL 'AOSPOSU0'             9090
     C***********R#RTN     PARM *BLANKS   O#RTN   7                       134284
     C           R#RTN     PARM ##RTCD    O#RTN                           134284
     C                     PARM '*CLEAR  'W0ACT   8
     C                     PARM C#DTA     O#DTA 256
      *
     C           *IN90     IFEQ '1'
     C***********R#RTN     ORNE *BLANKS                                   134284
     C           R#RTN     OREQ '*ERROR*'                                 134284
     C                     MOVEL'*CALL   'W0FILE
     C                     MOVEL'AOSPOSU0'W0KEY
     C                     Z-ADD901       W0ERNB
     C                     EXSR SRERR
     C                     ENDIF
      *
      *................................................................
      *
      ** Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
      *................................................................                       CSC022
     C                     MOVE 'N'       CSC022                                              CSC022
      *                                                                                       CSC022
      ** Access SAR details file to determine if CSC022 switchable feature                    CSC022
      ** is switched on                                                                       CSC022
      *                                                                                       CSC022
     C                     CALL 'AOSARDR0'                                                    CSC022
     C                     PARM *BLANKS   @RTCD   7                                           CSC022
     C                     PARM '*VERIFY' @OPTN   7                                           CSC022
     C                     PARM 'CSC022'  @SARD                                               CSC022
     C           SCSARD    PARM SCSARD    DSFDY                                               CSC022
      *                                                                                       CSC022
     C           @RTCD     IFEQ *BLANKS                                                       CSC022
     C                     MOVE 'Y'       CSC022  1                                           CSC022
     C                     MOVE 'N'       WCMT01  1                                           CSC022
      *                                                                                       CSC022
      * SCCMTJOB data area                                                                    CSC022
     C           *NAMVAR   DEFN SCCMTJOB  WDSJB                                               CSC022
     C                     IN   WDSJB                                                         CSC022
      *                                                                                       CSC022
      * Move data area to commitment array                                                    CSC022
     C           COMMTN    IFGT 0                                                             CSC022
     C                     MOVEACOMMTJ    JBNAM                                               CSC022
     C                     Z-ADD1         WCNT@@  20                                          CSC022
      *                                                                                       CSC022
     C           WDSJOB    LOKUPJBNAM                    17                                   CSC022
     C           *IN17     IFEQ *ON                                                           CSC022
     C                     MOVE 'Y'       WCMT01                                              CSC022
     C                     ENDIF                                                              CSC022
     C                     ENDIF                                                              CSC022
      *                                                                                       CSC022
     C                     ELSE                                                               CSC022
      * @rtcd not found                                                                       CSC022
     C           @RTCD     IFNE '*NRF'                                                        CSC022
     C           *NAMVAR   DEFN           LDA                                                 CSC022
     C           *LOCK     IN   LDA                                                           CSC022
     C                     MOVEL'CSC022'  DBKEY                                               CSC022
     C                     MOVEL'AOOUFEU0'DBFILE                                              CSC022
     C                     MOVEL'SCSARDPD'DBFILE                                              CSC022
     C                     Z-ADD2         DBASE                                               CSC022
     C                     OUT  LDA                                                           CSC022
     C                     EXSR SRERR                                                         CSC022
     C                     ENDIF                                                              CSC022
      *                                                                                       CSC022
     C                     ENDIF                                                              CSC022
      *                                                                                       CSC022
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *  SRERR    : Report error and close down program               *
      *                                                               *
      *  CALLED BY: Various                                           *
      *  CALLS    : *NONE                                             *
      *                                                               *
      *****************************************************************
     C           SRERR     BEGSR
      *
      ** Dump program
      *
     C           O#RTN     IFEQ '*RECLCK'                                                   AR868380
     C           R#RTN     OREQ '*RECLCK'                                                   AR868380
     C                     ROLBK                                                            AR868380
     C                     SETON                     LR                                     AR868380
     C                     MOVEL'*RECLCK' ##RTCD                                            AR868380
     C                     ELSE                                                             AR868380
     C                     DUMP
     C           ##RTCD    IFNE '*LEBTCH'                                 134284
     C           CSC022    IFEQ 'N'                                                           CSC022
     C                     ROLBK
     C                     ELSE                                                               CSC022
     C           WCMT01    IFNE 'Y'                                                           CSC022
     C                     ROLBK                                                              CSC022
     C                     ELSE                                                               CSC022
     C                     SETON                       U7U8                                   CSC022
     C                     ENDIF                                                              CSC022
     C                     ENDIF                                                              CSC022
     C                     ENDIF                                          134284
      *
      ** Close down program
      *
     C                     SETON                     LR
     C                     MOVEL'*ERROR*' ##RTCD
      *                                                                                     AR868380
     C                     ENDIF                                                            AR868380
      *                                                                                     AR868380
     C                     RETRN
      *
     C           EXERR     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * Subroutine  :  SRINIT                                         *
      * Function    :  Initial processing - First Call Only           *
      *                                                               *
      * Called by   :  Mainline                                       *
      * Calls       :  None                                           *
      *****************************************************************
     C           SRINIT    BEGSR
      ***********                                                         128565
      ***Determine*if*Customer*Lending*Enhancements*-*Syndication*********128565
      ***feature*is*installed*********************************************128565
      ***********                                                         128565
     C***********          CALL 'AOSARDR0'                                128565
     C***********          PARM *BLANKS   WRTCD                           128565
     C***********          PARM '*KEY    'WOPTN                           128565
     C***********          PARM 'CLE005  '@SARD   6                       128565
     C***********SCSARD    PARM SCSARD    DSFDY                           128565
     C***********@RTCD     IFEQ *BLANKS                                   128565
     C***********          MOVE 'Y'       CLE005  1                       128565
     C***********          ELSE                                           128565
     C***********          MOVE 'N'       CLE005                          128565
     C***********@RTCD     IFNE '*NRF    '                                128565
     C***********          MOVEL'SCSARDPD'DBFILE           ************   128565
     C***********          Z-ADD1         DBASE            * DBERR 01 *   128565
     C***********          MOVEL'CLE005'  DBKEY            ************   128565
     C***********          SETON                     U7U8LR               128565
     C***********          EXSR SRERR                                     128565
     C***********          ENDIF                                          128565
     C***********          ENDIF                                          128565
      *
      ** Determine if EMU LE Settlement Ccy Coversion Upgrade             CEU004
      ** feature is Installed                                             CEU004
      *                                                                   CEU004
     C                     CALL 'AOSARDR0'                                CEU004
     C                     PARM *BLANKS   WRTCD                           CEU004
     C                     PARM '*KEY    'WOPTN                           CEU004
     C                     PARM 'CEU004  '@SARD   6                       CEU004
     C           SCSARD    PARM SCSARD    DSFDY                           CEU004
     C           WRTCD     IFEQ *BLANKS                                   CEU004
     C                     MOVE 'Y'       CEU004  1                       CEU004
     C                     ELSE                                           CEU004
     C                     MOVE 'N'       CEU004                          CEU004
     C           WRTCD     IFNE '*NRF    '                                CEU004
     C                     MOVEL'SCSARDPD'W0FILE           ************   CEU004
     C                     Z-ADD1         W0ERNB           * DBERR 01 *   CEU004
     C                     MOVEL'CEU004'  W0KEY            ************   CEU004
     C                     SETON                     U7U8LR               CEU004
     C                     EXSR SRERR                                     CEU004
     C                     ENDIF                                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
      **  Check if CLE031 - Lending Enhancements is on                                        CLE031
     C                     CALL 'AOSARDR0'                                                    CLE031
     C                     PARM *BLANKS   WRTCD   7                                           CLE031
     C                     PARM '*KEY   ' WOPTN   7                                           CLE031
     C                     PARM 'CLE031'  @SARD   6                                           CLE031
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE031
      *                                                                                       CLE031
      ** If feature is on, set up SAR work flag                                               CLE031
      *                                                                                       CLE031
     C           WRTCD     IFEQ *BLANKS                                                       CLE031
     C                     MOVE 'Y'       CLE031                                              CLE031
     C                     ELSE                                                               CLE031
      *                                                                                       CLE031
      ** else, database error if return code other than *NRF.                                 CLE031
      *                                                                                       CLE031
     C                     MOVE 'N'       CLE031  1                                           CLE031
     C           WRTCD     IFNE '*NRF   '                                                     CLE031
     C                     MOVEL'AOOUFEUO'W0PGM   8                                           CLE031
     C                     MOVEL'SCSARDPD'W0FILE           ************                       CLE031
     C                     Z-ADD2         W0ERNB           * DBERR 02 *                       CLE031
     C                     MOVEL'CLE031'  W0KEY            ************                       CLE031
     C                     EXSR SRERR                                                         CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ENDIF                                                              CLE031
     C*                                                                   CLE033
     C**  Read switchable features file SCSARDPD using access object      CLE033
     C**  to determine if switchable feature (CLE033) is switched ON      CLE033
     C*                                                                   CLE033
     C                     MOVE 'N'       CLE033  1                       CLE033
     C*                                                                   CLE033
     C                     CALL 'AOSARDR0'                                CLE033
     C                     PARM *BLANKS   W0RTCD  7                       CLE033
     C                     PARM '*VERIFY' W0OPTN  7                       CLE033
     C                     PARM 'CLE033'  W0SARD  6                       CLE033
     C           SCSARD    PARM SCSARD    DSFDY                           CLE033
     C*                                                                   CLE033
     C**  If feature is on, set up CLE033 variable                        CLE033
     C*                                                                   CLE033
     C           W0RTCD    IFEQ *BLANKS                                   CLE033
      *                                                                   CLE033
     C                     MOVE 'Y'       CLE033                          CLE033
      *                                                                   CLE033
     C                     CALL 'AOSVALR0'                                CLE033
     C                     PARM *BLANKS   W0RTCD                          CLE033
     C                     PARM SVAL,1    P@OP01 20                       CLE033
     C                     PARM *BLANKS   P@VL01200                       CLE033
     C                     PARM SVAL,2    P@OP02 20                       CLE033
     C                     PARM *BLANKS   P@VL02200                       CLE033
     C                     PARM SVAL,3    P@OP03 20                       CLE033
     C                     PARM *BLANKS   P@VL03200                       CLE033
     C**********           PARM *BLANKS   P@OP04 20                                    CLE033 218782
     C                     PARM SVAL,4    P@OP04 20                                           218782
     C                     PARM *BLANKS   P@VL04200                       CLE033
     C                     PARM *BLANKS   P@OP05 20                       CLE033
     C                     PARM *BLANKS   P@VL05200                       CLE033
     C                     PARM *BLANKS   P@OP06 20                       CLE033
     C                     PARM *BLANKS   P@VL06200                       CLE033
     C                     PARM *BLANKS   P@OP07 20                       CLE033
     C                     PARM *BLANKS   P@VL07200                       CLE033
     C                     PARM *BLANKS   P@OP08 20                       CLE033
     C                     PARM *BLANKS   P@VL08200                       CLE033
     C                     PARM *BLANKS   P@OP09 20                       CLE033
     C                     PARM *BLANKS   P@VL09200                       CLE033
     C                     PARM *BLANKS   P@OP10 20                       CLE033
     C                     PARM *BLANKS   P@VL10200                       CLE033
     C***********SDSVAL    PARM SDSVAL    DSSDY                           CLE033              222373
      *                                                                   CLE033
     C           W0RTCD    IFNE *BLANKS                                   CLE033
     C                     MOVEL'AOOUFEUO'W0PGM   8                       CLE033
     C                     MOVEL'SDSVALPD'W0FILE                          CLE033
     C                     MOVEL'*FIRST ' W0KEY                           CLE033
     C                     Z-ADD906       W0ERNB                          CLE033
     C                     EXSR SRERR                                     CLE033
     C                     ENDIF                                          CLE033
      *                                                                                       218782
      ** Save value of Settlement09Postings in a one character field                          218782
     C                     MOVELP@VL04    SET09   1                                           218782
      *                                                                   CLE033
     C                     ELSE                                           CLE033
     C*                                                                   CLE033
     C** else, database error (return code other than *NRF)               CLE033
     C*                                                                   CLE033
     C           W0RTCD    IFNE '*NRF   '                                 CLE033
     C                     MOVEL'AOOUFEUO'W0PGM                           CLE033
     C                     MOVEL'SCSARDPD'W0FILE                          CLE033
     C                     MOVEL'*VERIFY' W0KEY                           CLE033
     C                     Z-ADD907       W0ERNB                          CLE033
     C                     EXSR SRERR                                     CLE033
     C                     ENDIF                                          CLE033
     C*                                                                   CLE033
     C                     ENDIF                                          CLE033
     C*                                                                   CLE033
     C*                                                                                       CLE034
     C**  Read switchable features file SCSARDPD using access object                          CLE034
     C**  to determine if switchable feature (CLE034) is switched ON                          CLE034
     C*                                                                                       CLE034
     C                     CALL 'AOSARDR0'                                                    CLE034
     C                     PARM *BLANKS   W0RTCD  7                                           CLE034
     C                     PARM '*VERIFY' W0OPTN  7                                           CLE034
     C                     PARM 'CLE034'  W0SARD  6                                           CLE034
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE034
     C                     MOVE '0'       *IN10                                               CLE034
     C*                                                                                       CLE034
     C**  If feature is on, set up CLE034 indicator                                           CLE034
     C*                                                                                       CLE034
     C           W0RTCD    IFEQ *BLANKS                                                       CLE034
     C                     MOVE 'Y'       CLE034  1                                           CLE034
     C                     ELSE                                                               CLE034
     C                     MOVE 'N'       CLE034                                              CLE034
     C*                                                                                       CLE034
     C** else, database error (if return code other than *NRF)                                CLE034
     C*                                                                                       CLE034
     C           W0RTCD    IFNE '*NRF   '                                                     CLE034
     C                     MOVEL'AOOUFEU0'W0PGM                                               CLE034
     C                     MOVEL'SCSARDPD'W0FILE           ************                       CLE034
     C                     MOVEL'*VERIFY' W0KEY            * DBERR 909*                       CLE034
     C                     Z-ADD909       W0ERNB           ************                       CLE034
     C                     ENDIF                                                              CLE034
     C                     ENDIF                                                              CLE034
     C*                                                                                       CLE034
     C                     CALL 'AOSARDR0'                                                    CRE020
     C                     PARM *BLANKS   WRTCD                                               CRE020
     C                     PARM '*KEY    'WOPTN                                               CRE020
     C                     PARM 'CRE020  '@SARD                                               CRE020
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE020
     C                     MOVE 'N'       CRE020                                              CRE020
      *                                                                                       CRE020
     C           WRTCD     IFEQ *BLANKS                                                       CRE020
     C                     MOVE 'Y'       CRE020  1                                           CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CAP205
      ** Check if CAP205 is installed                                                         CAP205
      *                                                                                       CAP205
     C                     CALL 'AOSARDR0'                                                    CAP205
     C                     PARM *BLANKS   W0RTCD                                              CAP205
     C                     PARM '*VERIFY' W0OPTN                                              CAP205
     C                     PARM 'CAP205'  W0SARD                                              CAP205
     C           SCSARD    PARM SCSARD    DSFDY                                               CAP205
      *                                                                                       CAP205
      **  If feature is on, set up CAP205 indicator                                           CAP205
      *                                                                                       CAP205
     C           W0RTCD    IFEQ *BLANKS                                                       CAP205
     C                     MOVE 'Y'       CAP205  1                                           CAP205
     C                     ELSE                                                               CAP205
     C                     MOVE 'N'       CAP205                                              CAP205
      *                                                                                       CAP205
      ** else, database error (if return code other than *NRF)                                CAP205
      *                                                                                       CAP205
     C           W0RTCD    IFNE '*NRF   '                                                     CAP205
     C                     MOVEL'AOOUFEU0'W0PGM                                               CAP205
     C                     MOVEL'SCSARDPD'W0FILE                                              CAP205
     C                     MOVEL'CAP205'  W0KEY                                               CAP205
     C                     Z-ADD911       W0ERNB                                              CAP205
     C                     ENDIF                                                              CAP205
     C                     ENDIF                                                              CAP205
     C/COPY WNCPYSRC,AOOUFEU0C3
      *                                                                                       CLE073
      *                                                                                       CLE073
      ** Determine if CLE073 is installed                                                     CLE073
      *                                                                                       CLE073
     C                     CALL 'AOSARDR0'                                                    CLE073
     C                     PARM '       ' WRTCD                                               CLE073
     C                     PARM '*VERIFY' WOPTN                                               CLE073
     C                     PARM 'CLE073'  @SARD                                               CLE073
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE073
      *                                                                                       CLE073
     C           WRTCD     IFEQ *BLANKS                                                       CLE073
     C                     MOVE 'Y'       CLE073  1                                           CLE073
     C                     ELSE                                                               CLE073
     C                     MOVE 'N'       CLE073                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Determine if CER049 enhancement is installed                                         CER049
      *                                                                                       CER049
     C                     CALL 'AOSARDR0'                                                    CER049
     C                     PARM *BLANKS   W0RTCD                                              CER049
     C                     PARM '*VERIFY' W0OPTN                                              CER049
     C                     PARM 'CER049'  W0SARD                                              CER049
     C           SCSARD    PARM SCSARD    DSFDY                                               CER049
      *                                                                                       CER049
      ** If feature is on, set up SAR work flag                                               CER049
      *                                                                                       CER049
     C           W0RTCD    IFEQ *BLANKS                                                       CER049
     C                     MOVE 'Y'       CER049                                              CER049
     C                     ELSE                                                               CER049
     C                     MOVE 'N'       CER049  1                                           CER049
     C                     ENDIF                                                              CER049
      *                                                                                       CLE134
      ** Check if CLE034 - Past Due Call Loans                                                CLE134
      *                                                                                       CLE134
     C                     MOVE 'N'       CLE134  1                                           CLE134
     C                     CALL 'AOSARDR0'                                                    CLE134
     C                     PARM *BLANKS   WRTCD   7                                           CLE134
     C                     PARM '*KEY   ' WOPTN   7                                           CLE134
     C                     PARM 'CLE134'  @SARD   6                                           CLE134
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE134
      *                                                                                       CLE134
      ** If feature is on, set up SAR work flag                                               CLE134
      *                                                                                       CLE134
     C           WRTCD     IFEQ *BLANKS                                                       CLE134
     C                     MOVE 'Y'       CLE134                                              CLE134
     C                     ENDIF                                                              CLE134
      *
      ** Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'SRINIT'  @STK,Q
      *
      *................................................................
      *
      ** Initialise work fields
      *
     C                     MOVEL'P'       ##PAY
     C                     MOVEL'R'       ##REC
     C                     MOVEL*BLANKS   R#RTN   7
     C                     MOVE '0'       *IN98
      *
      ** Access bank details
     C                     CALL 'AOBANKR0'
     C                     PARM '*DBERR ' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** Access Midas module details
     C                     CALL 'AOMMODR0'
     C                     PARM '*DBERR ' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
      ** Read SDRETLPD record if retail module on.
      *
     C           RETF      IFEQ 'Y'                        ***B001
     C                     CALL 'AORETLR0'
     C                     PARM '*DBERR ' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDRETL    PARM SDRETL    DSFDY
     C                     END                             ***E001
      *
      ** KLIST for file FCLTY
      *
     C           KEY001    KLIST
     C**********           KFLD           WCNUM   60                                          CSD027
     C                     KFLD           WCNUM   6                                           CSD027
     C                     KFLD           WFAC03
     C                     KFLD           WFAC02
     C                     KFLD           WRCDT
      *
     C                     MOVE 'A'       WRCDT   1
      *
      ** KLIST for file EVENTS : fee events
      *
     C           KEYEV3    KLIST
     C                     KFLD           WCNUMA  6
     C**********           KFLD           WLOAN   60                                          CLE148
     C                     KFLD           WLOAN   6                                           CLE148
     C                     KFLD           WFAC03  30
     C                     KFLD           WFAC02  20
     C                     KFLD           WFSEQ3  30
      *
      ** KLIST for file EVENTS : facility events
      *
     C           KEYEV4    KLIST
     C                     KFLD           WCNUMA
     C                     KFLD           WFAC03
     C                     KFLD           WFAC02
      *
      ** KLIST for file FCLTY FN FORMAT
      *
     C           KEYFCB    KLIST
     C                     KFLD           WCNUM
     C                     KFLD           WFAC03
     C                     KFLD           WFAC02
     C                     KFLD           WRCDTB
      *
     C                     MOVE 'B'       WRCDTB  1
      *
      ** KLIST for file RSACMT : projected postings
     C           KEYRSA    KLIST
     C                     KFLD           ACBRC
     C                     KFLD           NCCUS
     C                     KFLD           ACCCY
     C                     KFLD           NCACD
     C                     KFLD           NCSQN
     C                     KFLD           WPAYD
      *                                                                                       CLE073
      *                                                                                       CLE073
      ** Key to access HISTSHP                                                                CLE073
      *                                                                                       CLE073
     C           KEYHST    KLIST                                                              CLE073
     C                     KFLD           WBRCA                                               CLE073
     C                     KFLD           WCNUM                                               CLE073
     C                     KFLD           WLOAN                                               CLE073
     C                     KFLD           WVDAT   50                                          CLE073
     C                     KFLD           WLASN   30                                          CLE073
     C                     Z-ADD999       WLASN   30                                          CLE073
      *                                                                                       CLE073
      ** Partial Key to process HISTSHP                                                       CLE073
      *                                                                                       CLE073
     C           KEYPHS    KLIST                                                              CLE073
     C                     KFLD           WBRCA                                               CLE073
     C                     KFLD           WCNUM                                               CLE073
     C                     KFLD           WLOAN                                               CLE073
     C           KEY005    KLIST                                                              CLE073
     C                     KFLD           WLOAN                                               CLE073
     C                     KFLD           WCLRT   1                                           CLE073
      *                                                                                       CLE073
      *
      ***  Set up currency array
      *
     C                     Z-ADD0         W       30
     C                     READ SDCURRPD                 72
      *
     C           *IN72     DOWEQ'0'
      *
     C           W         IFLE 150
     C           W         ADD  1         W
     C                     MOVE A6CYCD    CURR,W
     C                     Z-ADDA6SPRT    CSPT,W
     C                     MOVELA6MDIN    MTDV,W
     C                     Z-ADDA6NBDP    CCDP,W
     C                     ENDIF
      *
     C                     READ SDCURRPD                 72
      *
     C                     ENDDO
      *
      ** Copyright
      *
     C                     MOVEA##CPY     ##BIS  80
      *
      *................................................................
      *
     C           EXINIT    TAG
      *
      ** Unwind subroutine stack name
      *
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     C                     ENDSR
      *****************************************************************
      ** Subroutine  :  SRCURR                                        *                       CLE031
      ** Function    :  Check currency details                        *                       CLE031
      ** Calls       :  AOCURRR0                                      *                       CLE031
      **                                                              *                       CLE031
      *****************************************************************                       CLE031
      *                                                                                       CLE031
     C           SRCURR    BEGSR                                                              CLE031
      *                                                                                       CLE031
     C                     CALL 'AOCURRR0'                                                    CLE031
     C                     PARM *BLANKS   @RTCD                                               CLE031
     C                     PARM '*KEY    '@OPTN                                               CLE031
     C                     PARM WCCY      @CURR   3                                           CLE031
     C           SDCURR    PARM SDCURR    DSSDY                                               CLE031
      *                                                                                       CLE031
      ** Handle Database Error.                                                               CLE031
      *                                                                                       CLE031
     C           @RTCD     IFNE *BLANKS                                                       CLE031
     C                     MOVEL'AOCURRR0'W0PGM   8                                           CLE031
     C                     MOVEL'SDCURRPD'W0FILE                                              CLE031
     C                     MOVEL'WCCY   ' W0KEY                                               CLE031
     C                     Z-ADD906       W0ERNB                                              CLE031
     C                     EXSR SRERR                                                         CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
      *                                                                                       CLE031
     C                     ENDSR                                                              CLE031
      *****************************************************************                       CLE031
      *                                                                                       CLE031
      ** Subroutine  :  SR34A                                         *                       CLE034
      ** Function    :  Initial set up for CLE034 processing          *                       CLE034
      ** Called by   :  SRFEED                                        *                       CLE034
      ***Calls*******:**AOSTALR2***************************************                CLE034 219608
      ** Calls       :  AOSTALR2 AOBSTLR0                             *                       219608
      *                                                                                       CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
     C           SR34A     BEGSR                                                              CLE034
      *                                                                                       CLE034
     C                     Z-ADD0         TOTAMT 130                                          CLE034
     C                     Z-ADD0         WRKAMT 130                                          CLE034
     C                     MOVE *BLANK    WRKFLD  1                                           CLE034
     C                     Z-ADD##AMT     SAVAMT 130                                          CLE034
     C                     MOVE LFEED     SVLFEE                                              CLE034
     C                     MOVE ##RECM    W#RECM  20                                          CLE034
     C**********           MOVE ##RECA    W#RECA 12                                    CLE034 CGL029
     C                     MOVE ##RECA    W#RECA 18                                           CGL029
     C                     MOVE ##RECB    W#RECB  3                                           CLE034
     C                     MOVE ##PAYM    W#PAYM  20                                          CLE034
     C**********           MOVE ##PAYA    W#PAYA 12                                    CLE034 CGL029
     C                     MOVE ##PAYA    W#PAYA 18                                           CGL029
     C                     MOVE ##PAYB    W#PAYB  3                                           CLE034
     C                     MOVE ##CCY     W#CCY   3                                           CLE034
     C                     MOVE SVSCCY    W#SVCY  3                                           CLE034
     C                     MOVE SVPSCY    W#PSCY  3                                           CLE034
      *                                                                                       CLE034
     C           FEPTFI    IFEQ *BLANK                                                        CLE034
     C                     MOVE 'R'       W#PYRC  1                                           CLE034
     C                     ELSE                                                               CLE034
     C                     MOVE 'P'       W#PYRC                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C                     MOVE FELOAN    PLNRF                                               CLE034
     C                     MOVE FECNUM    PCNUM                                               CLE034
     C                     MOVE FEFACL    PFACL                                               CLE034
     C                     MOVE FEFSEQ    PFSEQ                                               CLE034
      *                                                                                       CLE034
      ** If reversing existing allocations, call AOBSTLR0 to                                  219608
      ** access the 'before' image from LEBSTLPD:                                             219608
     C           ##REVI    IFEQ 'YES'                                                         219608
     C                     CALL 'AOBSTLR0'                                                    219608
     C                     PARM *BLANKS   STALCD  7                                           219608
     C                     PARM '*FIRST ' POPTN   7                                           219608
     C                     PARM 'FEES'    PTYPE   4                                           219608
     C                     PARM           PLNRF   6                                           219608
     C                     PARM *BLANKS   PVDAT   5                                           219608
     C                     PARM *BLANKS   PLASN   3                                           219608
     C                     PARM           PCNUM   6                                           219608
     C                     PARM           PFACL   5                                           219608
     C                     PARM           PFSEQ   2                                           219608
     C                     PARM W#PYRC    PPYRC   1                                           219608
     C           LESTAL    PARM *BLANKS   DSSDY                                               219608
     C                     MOVEL*BLANKS   BEFORE  1                                           219608
      *                                                                                       219608
     C           STALCD    IFNE *BLANKS                                                       219608
      ** If could not find any, use the normal AOSTALR2 to                                    219608
      ** access the existing image                                                            219608
     C                     MOVEL'N'       BEFORE                                              219608
     C                     CALL 'AOSTALR2'                                                    219608
     C                     PARM *BLANKS   STALCD                                              219608
     C                     PARM '*FIRST ' POPTN                                               219608
     C                     PARM 'FEES'    PTYPE                                               219608
     C                     PARM           PLNRF                                               219608
     C                     PARM *BLANKS   PVDAT                                               219608
     C                     PARM *BLANKS   PLASN                                               219608
     C                     PARM           PCNUM                                               219608
     C                     PARM           PFACL                                               219608
     C                     PARM           PFSEQ                                               219608
     C                     PARM W#PYRC    PPYRC                                               219608
     C           LESTAL    PARM *BLANKS   DSSDY                                               219608
      *                                                                                       219608
     C           STALCD    IFNE *BLANKS                                                       219608
     C                     MOVEL'AOOUFEU0'W0PGM                                               219608
     C                     MOVEL'LEBSTLPD'W0FILE                                              219608
     C                     Z-ADD910       W0ERNB                                              219608
     C                     MOVELPOPTN     W0KEY                                               219608
     C                     EXSR SRERR                                                         219608
     C                     ENDIF                                                              219608
     C                     ENDIF                                                              219608
      ** Else, inserting new allocations, so call AOSTALR2                                    219608
      ** to access the 'after' image of LESTALPD:                                             219608
     C                     ELSE                            ##REVI not YES                     219608
      *                                                                                       219608
     C                     CALL 'AOSTALR2'                                                    CLE034
     C                     PARM *BLANKS   STALCD  7                                           CLE034
     C                     PARM '*FIRST ' POPTN   7                                           CLE034
     C                     PARM 'FEES'    PTYPE   4                                           CLE034
     C                     PARM           PLNRF   6                                           CLE034
     C                     PARM *BLANKS   PVDAT   5                                           CLE034
     C                     PARM *BLANKS   PLASN   3                                           CLE034
     C                     PARM           PCNUM   6                                           CLE034
     C                     PARM           PFACL   5                                           CLE034
     C                     PARM           PFSEQ   2                                           CLE034
     C                     PARM W#PYRC    PPYRC   1                                           CLE034
     C           LESTAL    PARM *BLANKS   DSSDY                                               CLE034
      *                                                                                       CLE034
     C           STALCD    IFNE *BLANKS                                                       CLE034
     C                     MOVEL'AOOUFEU0'W0PGM                                               CLE034
     C                     MOVEL'LESTALPD'W0FILE                                              CLE034
     C                     Z-ADD908       W0ERNB                                              CLE034
     C                     MOVELPOPTN     W0KEY                                               CLE034
     C                     EXSR SRERR                                                         CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       219608
     C                     ENDIF                           End ##REVI chk                     219608
      *                                                                                       CLE034
     C                     ENDSR                           END SR34A                          CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
      ** Subroutine  :  SR34B                                         *                       CLE034
      ** Function    :  Calculate amount for Settlement Allocation    *                       CLE034
      ** Called by   :  SRFEED                                        *                       CLE034
      ** Calls       :                                                *                       CLE034
      *                                                                                       CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
     C           SR34B     BEGSR                                                              CLE034
      *                                                                                       CLE034
     C           W#PYRC    IFEQ 'P'                                                           CLE034
     C           PYPC      DIV  100       W#PYPC 139                                          CLE034
     C           SAVAMT    MULT W#PYPC    WRKAMT    H                                         CLE034
     C                     ELSE                                                               CLE034
     C           RCPC      DIV  100       W#RCPC 139                                          CLE034
     C           SAVAMT    MULT W#RCPC    WRKAMT    H                                         CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C           TOTAMT    ADD  WRKAMT    TOTAMT                                              CLE034
      *                                                                                       CLE034
      * If WRKFLD = 'Y' (Last allocation being processed)                                     CLE034
      * check for any rounding errors, and add any difference                                 CLE034
      * to this posting, as this will be the largest allocation.                              CLE034
     C           WRKFLD    IFEQ 'Y'                                                           CLE034
     C           SAVAMT    ANDNETOTAMT                                                        CLE034
     C           SAVAMT    SUB  TOTAMT    W#DIFF 130                                          CLE034
     C           WRKAMT    ADD  W#DIFF    WRKAMT                                              CLE034
     C                     ENDIF                                                              CLE034
     C                     Z-ADDWRKAMT    ##AMT                                               CLE034
      *                                                                                       CLE034
     C                     EXSR SR34D                                                         CLE034
      *                                                                                       CLE034
     C                     ENDSR                           END SR34B                          CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
      ** Subroutine  :  SR34C                                         *                       CLE034
      ** Function    :  Processing to get next settlement allocation  *                       CLE034
      ** Called by   :  SRFEED                                        *                       CLE034
      ***Calls*******:**AOSTALR2***************************************                CLE034 219608
      ** Calls       :  AOSTALR2 AOBSTLR0                             *                       219608
      *                                                                                       CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
     C           SR34C     BEGSR                                                              CLE034
      *                                                                                       CLE034
     C           WRKFLD    IFEQ 'Y'                                                           CLE034
     C                     MOVE *BLANK    WRKFLD                                              CLE034
     C                     ELSE                                                               CLE034
      *                                                                                       CLE034
     C                     MOVE FELOAN    PLNRF                                               CLE034
     C                     MOVE FECNUM    PCNUM                                               CLE034
     C                     MOVE FEFACL    PFACL                                               CLE034
     C                     MOVE FEFSEQ    PFSEQ                                               CLE034
      *                                                                                       CLE034
      ** If reversing existing allocations, call AOBSTLR0 to                                  219608
      ** access the 'before' image from LEBSTLPD:                                             219608
     C           ##REVI    IFEQ 'YES'                                                         219608
     C           BEFORE    ANDEQ*BLANKS                                                       219608
     C                     CALL 'AOBSTLR0'                                                    219608
     C                     PARM *BLANKS   STALCD  7                                           219608
     C                     PARM '*NEXT  ' POPTN   7                                           219608
     C                     PARM 'FEES'    PTYPE                                               219608
     C                     PARM           PLNRF                                               219608
     C                     PARM *BLANKS   PVDAT                                               219608
     C                     PARM *BLANKS   PLASN                                               219608
     C                     PARM           PCNUM                                               219608
     C                     PARM           PFACL                                               219608
     C                     PARM           PFSEQ                                               219608
     C                     PARM W#PYRC    PPYRC                                               219608
     C           LESTAL    PARM *BLANKS   DSSDY                                               219608
      *                                                                                       219608
      ** Else, inserting new allocations, so call AOSTALR2                                    219608
      ** to access the 'after' image of LESTALPD:                                             219608
     C                     ELSE                            ##REVI not YES                     219608
      *                                                                                       219608
     C                     CALL 'AOSTALR2'                                                    CLE034
     C                     PARM *BLANKS   STALCD  7                                           CLE034
     C                     PARM '*NEXT  ' POPTN   7                                           CLE034
     C                     PARM 'FEES'    PTYPE                                               CLE034
     C                     PARM           PLNRF                                               CLE034
     C                     PARM *BLANKS   PVDAT                                               CLE034
     C                     PARM *BLANKS   PLASN                                               CLE034
     C                     PARM           PCNUM                                               CLE034
     C                     PARM           PFACL                                               CLE034
     C                     PARM           PFSEQ                                               CLE034
     C                     PARM W#PYRC    PPYRC                                               CLE034
     C           LESTAL    PARM *BLANKS   DSSDY                                               CLE034
      *                                                                                       219608
     C                     ENDIF                           End ##REVI chk                     219608
      *                                                                                       CLE034
     C           STALCD    IFEQ '*EOF'                                                        CLE034
     C                     MOVE 'Y'       WRKFLD                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C                     ENDSR                           END SR34C                          CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
      ** Subroutine  :  SR34D                                         *                       CLE034
      ** Function    :  Set up fields from settlement allocation      *                       CLE034
      ** Called by   :  SR34B                                         *                       CLE034
      ** Calls       :                                                *                       CLE034
      *                                                                                       CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
     C           SR34D     BEGSR                                                              CLE034
      *                                                                                       CLE034
     C           W#PYRC    IFEQ 'P'                                                           CLE034
     C                     MOVE STPSTM    FESTTL                                              CLE034
     C                     MOVE STPONS    FEOURS                                              CLE034
     C                     MOVE STPOBR    FEOSBR                                              CLE034
     C                     ELSE                                                               CLE034
     C                     MOVE STRSTM    FESTTL                                              CLE034
     C                     MOVE STRONS    FEOURS                                              CLE034
     C                     MOVE STROBR    FEOSBR                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C                     MOVE STRSTM    ##RECM                                              CLE034
     C                     MOVE STRONS    ##RECA                                              CLE034
     C                     MOVE STROBR    ##RECB                                              CLE034
     C                     MOVE STPSTM    ##PAYM                                              CLE034
     C                     MOVE STPONS    ##PAYA                                              CLE034
     C                     MOVE STPOBR    ##PAYB                                              CLE034
     C                     MOVE STRSCY    FESCCY                                              CLE034
     C                     Z-ADDSTREXR    FEREXR                                              CLE034
     C                     MOVE STREXI    FEREXI                                              CLE034
     C                     MOVE ROBN      FEROBN                                              CLE034
     C                     MOVE ROCN      FEROCN                                              CLE034
     C                     MOVE RIBN      FERIBN                                              CLE034
     C                     MOVE RIBA      FERIBA                                              CLE034
     C                     MOVE STPSCY    FEPSCY                                              CLE034
     C                     Z-ADDSTPEXR    FEPEXR                                              CLE034
     C                     MOVE STPEXI    FEPEXI                                              CLE034
     C                     MOVE POBN      FEPOBN                                              CLE034
     C                     MOVE POCN      FEPOCN                                              CLE034
     C                     MOVE PIBN      FEPIBN                                              CLE034
     C                     MOVE PIBA      FEPIBA                                              CLE034
     C                     MOVE RVNO      FERVNO                                              CLE034
     C                     MOVE CVMR      FECVMR                                              CLE034
     C                     MOVE RCRN      FERCRN                                              CLE034
     C                     MOVE RCRA      FERCRA                                              CLE034
     C                     MOVE AWBN      FEAWBN                                              CLE034
     C                     MOVE AWBA      FEAWBA                                              CLE034
     C                     MOVE BENN      FEBENN                                              CLE034
     C                     MOVE BENA      FEBENA                                              CLE034
     C                     MOVE DTP1      FEDTP1                                              CLE034
     C                     MOVE DTP2      FEDTP2                                              CLE034
     C                     MOVE DTP3      FEDTP3                                              CLE034
     C                     MOVE DTP4      FEDTP4                                              CLE034
     C                     MOVE DCHG      FEDCHG                                              CLE034
     C                     MOVE BTB1      FEBTB1                                              CLE034
     C                     MOVE BTB2      FEBTB2                                              CLE034
     C                     MOVE BTB3      FEBTB3                                              CLE034
     C                     MOVE BTB4      FEBTB4                                              CLE034
     C                     MOVE BTB5      FEBTB5                                              CLE034
     C                     MOVE BTB6      FEBTB6                                              CLE034
      *                                                                                       CLE034
     C           CEU004    IFEQ 'Y'                                                           CLE034
     C           CLE031    ANDNE'Y'                                                           CLE034
     C           FESCCY    ANDNE*BLANKS                                                       CLE034
     C                     MOVE FESCCY    ##CCY                                               CLE034
     C                     ELSE                                                               CLE034
     C                     MOVE FEFCCY    ##CCY                                               CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C           CLE031    IFEQ 'Y'                                                           CLE034
      *                                                                                       CLE034
     C           FESCCY    IFNE *BLANKS                                                       CLE034
     C                     MOVE FESCCY    SVSCCY                                              CLE034
     C                     ENDIF                                                              CLE034
     C           FEPSCY    IFNE *BLANKS                                                       CLE034
     C                     MOVE FEPSCY    SVPSCY                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C           FEPTFI    IFEQ *BLANK                                                        CLE034
     C                     MOVE ##RECD    ##SETD                                              CLE034
     C                     ELSE                                                               CLE034
     C                     MOVE ##PAYD    ##SETD                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C                     ENDSR                           END SR34D                          CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
      ** Subroutine  :  SR34E                                         *                       CLE034
      ** Function    :  Restore original fields                       *                       CLE034
      ** Called by   :  SRFEED                                        *                       CLE034
      ** Calls       :                                                *                       CLE034
      *                                                                                       CLE034
      *****************************************************************                       CLE034
      *                                                                                       CLE034
     C           SR34E     BEGSR                                                              CLE034
      *                                                                                       CLE034
     C                     MOVE W#RECM    ##RECM                                              CLE034
     C                     MOVE W#RECA    ##RECA                                              CLE034
     C                     MOVE W#RECB    ##RECB                                              CLE034
     C                     MOVE W#PAYM    ##PAYM                                              CLE034
     C                     MOVE W#PAYA    ##PAYA                                              CLE034
     C                     MOVE W#PAYB    ##PAYB                                              CLE034
     C                     MOVE W#CCY     ##CCY                                               CLE034
     C                     MOVE W#SVCY    SVSCCY                                              CLE034
     C                     MOVE W#PSCY    SVPSCY                                              CLE034
     C                     MOVE SVLFEE    LFEED                                               CLE034
      *                                                                                       CLE034
     C                     ENDSR                           END SR34E                          CLE034
      *****************************************************************                       CLE034
      *                                                               *                       CER049
      *  SRSTAX - Generate Stamp tax shadow posting                   *                       CER049
      *                                                               *                       CER049
      *****************************************************************                       CER049
     C           SRSTAX    BEGSR                                                              CER049
      *                                                                                       CER049
      ** Check for retail account                                                             CER049
      *                                                                                       CER049
     C                     MOVE DDDCST    ACCUS                                               CER049
     C                     MOVE DDDACD    ACACD                                               CER049
     C                     MOVE DDDASC    ACSQN                                               CER049
     C                     MOVE DDDBRC    ACBRC                                               CER049
     C                     MOVE DDDCCY    ACCCY                                               CER049
     C                     CALL 'AOACCTR0'PLISTA                                              CER049
      *                                                                                       CER049
     C           DDTAX     IFEQ 'Y'                                                           CER049
     C           RECI      ANDEQ'D'                                                           CER049
     C           WRTCD     ANDEQ*BLANKS                                                       CER049
     C           ATYP      ANDEQ'R'                                                           CER049
      *                                                                                       CER049
     C                     MOVE ACNO      C#ACNO                                              CER049
     C                     MOVE 'R'       C#ATYP                                              CER049
     C                     MOVE *BLANKS   C#MEMS                                              CER049
     C                     MOVE *BLANKS   C#RSAC                                              CER049
     C                     MOVE DDDCCY    C#CCY                                               CER049
     C                     MOVE ##AMT     WSTAX  150                                          CER049
      *                                                                                       CER049
     C** Get Stamp tax rate                                                                   CER049
      *                                                                                       CER049
     C                     MOVE FEFCOD    ##TYPE                                              CER049
     C                     CALL 'SD008141'                                                    CER049
     C                     PARM BJRDNB    U#DATE  50                                          CER049
     C                     PARM 'FEE'     U#ORGN 10                                           CER049
     C                     PARM           ##TYPE  4                                           CER049
     C                     PARM           U#CTAX 138                                          CER049
     C                     PARM           U#MTAX 138                                          CER049
     C                     PARM           U#CCCY  3                                           CER049
     C                     PARM           U#MCCY  3                                           CER049
     C                     PARM           U#CSCC  2                                           CER049
     C                     PARM           U#MSCC  2                                           CER049
     C                     PARM           U#TXTY  1                                           CER049
     C                     PARM           SDSTPD                                              CER049
      *                                                                                       CER049
      ** If there is a default for the Module use this tax rate and ccy                       CER049
      ** otherwise use the ICD Control defaults.                                              CER049
      *                                                                                       CER049
     C           U#MTAX    IFNE *ZEROS                                                        CER049
     C                     Z-ADDU#MTAX    U#TAXR 138                                          CER049
     C                     ELSE                                                               CER049
     C                     Z-ADDU#CTAX    U#TAXR                                              CER049
     C                     ENDIF                                                              CER049
      *                                                                                       CER049
     C           FESCCY    IFNE DDDCCY                                                        CER049
      *                                                                                       CER049
      ** Access stamp tax currency for decimal places                                         CER049
      *                                                                                       CER049
     C                     MOVE DDDCCY    WCCY                                                CER049
     C                     EXSR SRCURR                                                        CER049
     C                     MOVE A6NBDP    NDP     10                                          CER049
     C                     MOVELA6SPRT    ZRATE1 138                                          CER049
     C                     MOVELA6MDIN    ZMDI1   1                                           CER049
      *                                                                                       CER049
      ** Access transaction currency for decimal places                                       CER049
      *                                                                                       CER049
     C                     MOVE FEFCCY    WCCY                                                CER049
     C                     EXSR SRCURR                                                        CER049
     C                     MOVELA6SPRT    ZRATE2 138                                          CER049
     C                     MOVELA6MDIN    ZMDI2   1                                           CER049
      *                                                                                       CER049
      ** Get exchange rate                                                                    CER049
      *                                                                                       CER049
     C                     EXSR RTZXRT                                                        CER049
      *                                                                                       CER049
     C                     Z-ADDZRATEX    ZEXCH                                               CER049
     C                     MOVE ZMDI1     ZMD                                                 CER049
     C                     Z-ADDWSTAX     ZAMTCI                                              CER049
     C                     Z-ADDA6NBDP    ZCDPI                                               CER049
     C                     Z-ADDNDP       ZCDPO                                               CER049
     C                     EXSR ZCONV                                                         CER049
     C                     Z-ADDZAMTCO    WSTAX                                               CER049
     C                     ENDIF                                                              CER049
      *                                                                                       CER049
     C           WSTAX     MULT U#TAXR    C#AMT                                               CER049
      *                                                                                       CER049
     C           C#AMT     IFLT 0                                                             CER049
     C                     MULT -1        C#AMT                                               CER049
     C                     ENDIF                                                              CER049
      *                                                                                       CER049
     C           ##REVI    IFNE *BLANKS                                                       CER049
     C                     Z-SUBC#AMT     C#AMT                                               CER049
     C                     ENDIF                                                              CER049
      *                                                                                       CER049
      *                                                                                       CER049
     C                     CALL 'AOSPOSU0'             9090                                   CER049
     C           R#RTN     PARM ##RTCD    O#RTN                                               CER049
     C                     PARM '*ADD    'W0ACT                                               CER049
     C                     PARM C#DTA     O#DTA                                               CER049
      *                                                                                       CER049
     C           *IN90     IFEQ '1'                                                           CER049
     C           R#RTN     OREQ '*ERROR*'                                                     CER049
     C                     MOVEL'*CALL   'W0FILE                                              CER049
     C                     MOVEL'AOSPOSU0'W0KEY                                               CER049
     C                     Z-ADD903       W0ERNB                                              CER049
     C                     EXSR SRERR                                                         CER049
     C                     ENDIF                                                              CER049
     C                     ENDIF                                                              CER049
      *                                                                                       CER049
     C                     ENDSR                                                              CER049
      *****************************************************************                       CER049
     C/COPY WNCPYSRC,AOH00035
      /TITLE SR/ZXRATEZ1
     C/COPY ZSRSRC,ZXRATEZ1
      /TITLE SR/ZCONV
     C/COPY ZSRSRC,ZCONVZ1
      /TITLE SR/ZINTDY                                                    CLE013
     C/COPY ZSRSRC,ZINTDYZ2                                               CLE013
      /TITLE SR/ZDATE9                                                    CLE013
     C/COPY ZSRSRC,ZDATE9Z3                                               CLE013
      /TITLE SR/ZDAT10                                                    CLE013
     C/COPY ZSRSRC,ZDAT10Z2                                               CLE013
     C/COPY ZSRSRC,RTZXRTC1                                                                   CER049
      *****************************************************************
     C/SPACE 5
** CPY@     : Copyright notice for inclusion in all programs
(c) Misys International Banking Systems Ltd. 2001
**   TABCAL/TABCBS - CALCULATION BASES.
136500236000336000436500536000636600
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  TABNOS **      SETTLEMENT TYPES FOR NOSTRO CODES
0102070812
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN    CLE013
00366007310109601461                                                      CLE013
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR       CLE013
00000000310005900090001200015100181002120024300273003040033400365         CLE013
**   SVAL  -  SYSTEM VALUES ARRAY                                                             CLE033
Settlement09Customer                                                                          CLE033
Settlement09AccCode                                                                           CLE033
Settlement09Hostpgm                                                                           CLE033
Settlement09Postings                                                                          218782
