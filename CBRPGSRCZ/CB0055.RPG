     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas CB COB report submission')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Close Of Business Processing                         *
     F*                                                               *
     F*  CB0055 - CALL ALL CLOSE OF BUSINESS ON REQUEST REPORTS       *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. 247203             Date 25Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD027             Date 09Dec05               *
      *                 BUG10349           Date 06Feb06               *
      *                 BUG2989            Date 15Jun04               *
      *                 107700             Date 24Jul03               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 197767             Date 28Jun02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CCB009             Date 23Jun00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 098640             Date 28Jan98               *
     F*                    101930           Date 08Jul96              *
     F*                    081912           DATE 18JAN95              *
     F*                    064115           DATE 18FEB94              *
     F*                    E38634           DATE 24APR92              *
     F*                    E36396           DATE 28FEB92              *
     F*                    LN0989           DATE 12DEC90              *
     F*                    LN0545           DATE 20JUL90              *
     F*                    LN0486           DATE 13JUL90              *
     F*                    LN0278           DATE 13JUL90              *
     F*                    LN0497           DATE  9JUL90              *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  247203 - Set Halt After status to 'H' once halt is in        *
      *           progress so that Halt After message is correct.     *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG10349 - Wrong record retrieved from FCRREQL8              *
      *  BUG2989 - Check CBCOBRL0 before issue of DBERROR for COB on  *
      *            request components not existing on FCRREQL8.      *
      *  107700 - Update the Stream Number field on CBCOMSPD with     *
      *           the stream in which the component is running.       *
      *           - Reintroduction of lost change.                    *
      *  197767 - CB0300 shows for failed components incorrect time   *
      *           duration containing alphabets and brackets. Ensure  *
      *           that fields DHCETI and DHCEDE in file CBCOMSPD are  *
      *           updated with values from CBTIME if component failed.*
     F*  CCB009 - Journal files throughout the close of business.     *
     F*           Write a record to CBAUDTL1 when component starts.   *
     F*  098640 - If CBCOMSPD record is locked (RPG1218 received),    *
     F*           continue reading CBCOMSL0 until record is available,*
     F*           instead of terminating abnormally.                  *
     F*  101930 - Apply Autocall changes to CBC0055 (for On Request   *
     F*           reports) as well as CBC0050 (Mandatory reports)     *
     F*  081912 - Correct concatenation of command string. Allow      *
     F*           256 characters                                      *
     F*  064115 - PROCESS REPORT COMPONENTS WHICH EXIST ON            *
     F*           SWITCHABLE FEATURES BY REPORT COMPONENTS FILE.      *
     F*           REPLACE LF/FCRCOML3 WITH JLF/FCRCOMJ3               *
     F*     E38634  -  Add an extra chain to CBCOMSPD if an error has   *
     F*                occurred when accessing one of the RCF files.    *
     F*                This is to prevent 'UPDAT without prior READ/    *
     F*                CHAIN' error occurring during the DBERR          *
     F*                subroutine.                                      *
     F*     E36396  -  WHEN REQUEST REPORT FAILED, RUN TIME FIELD IN    *
     F*                CB0300 PRINTS OUT RUBBISH: DHCEDE IS BEING       *
     F*                UPDATED INSTEAD OF CEDE FOR END DATE IN FILE     *
     F*                CBAUDTPD WHICH RESULTS IN 0 END DATE BEING       *
     F*                PROCESSED FOR FAILED COMPONENTS IN CB0300.       *
     F*     LN0989  -  PROVIDE ADDITIONAL COB ERROR INFORMATION         *
     F*     LN0545  -  RE-TRY THE LOCK OF CBSTAT TO AVOID POTENTIAL     *
     F*                COB CRASH AS A NUMBER OF PROGRAMS PERFORM THE    *
     F*                *LOCK TO UPDATE THE DATA AREA                    *
     F*     LN0486  -  CORRECT DATABASE ERROR PROCESSING -              *
     F*                PROGRAM MUST ALWAYS ATTEMPT TO UPDATE            *
     F*                FAILED COMPONENT STATUS IN CASE OF ERROR         *
     F*     LN0278  -  USE NEW PROGRAM CBTIME TO ACCESS TIME AND        *
     F*                DATE IN CORRECT FORMAT FOR CALCULATIONS          *
     F*                AND REMOVE ZDATE1 SUBROUTINE                     *
     F*     LN0497  -  CHANGED SPECIFICATION OF LENGTH OF FIELD SENT    *
     F*                TO CBDTQA TO P(5,0) AS ERROR WAS OCCURRING IN    *
     F*                QSNDDTAQ COMMAND.                                *
     F*                LENGTH OF CBDTQA IS 16.                          *
     F*                LDA HANDLING ALTERED.                            *
     F*                SPECIFICATION OF LENGTH OF CBSTAT ELSE PROGRAM   *
     F*                CANNOT ACCESS THE EXTERNAL DATA AREA.            *
     F********************************************************************
     FCBCOMSL0UF  E           K        DISK
     F                                              KINFDS COMDS          098640
     FFCRREQL8IF  E           K        DISK
     FFCPARDL1IF  E           K        DISK
     F***FCRCOML3IF  E           K        DISK                            064115
     FFCRCOMJ3IF  E           K        DISK                               064115
     FCBCOBRL0IF  E           K        DISK                                                  BUG2989
     F*CBAUDTPDO**E***                 DISK                           UC  CCB009
     FCBAUDTL1UF  E           K        DISK                      A    UC  CCB009
     F/COPY WNCPYSRC,CB0055F001
     F********************************************************************
     F*
     F*        FUNCTION OF INDICATORS
     F*
     F*  30    CHAIN FAIL
     F*  31    SETLL FINDS NO RECORDS
     F*  32    END OF RECORDS ON FCRREQL8
     F*  36    No record in audit file - CBAUDTL1                         CCB009
     F*  70    RE-TRY LOCK OF DATA AREA                                   LN0545
     F*
     F********************************************************************
     E                    CPY@    1   1 80
     E**********          ARR     1   1 20                                LN0497
     E                    ARR     1   1 16                                LN0497
     E****/COPY ZSRSRC,ZDATE1Z1                                           LN0278
     I*
     I*CBSTAT***** DS                                                     LN0497
     ICOMDS       DS                            366                       098640
     I                                     *STATUS  FSTAT                 098640
     ICBSTAT      DS                             50                       LN0497
     I*
     I** CLOSE OF BUSINESS HALT INDICATOR
     I*
     I                                       20  20 HALT
     I*
     IRUNDAT      DS
     I*
     I** RUN DATE, DATE FORMAT, MULTIBRANCH INDICATOR AND SET UP FLAG
     I*
     I                                        1   7 RUNA
     I                                        8  100RUND
     I                                       11  11 SSF
     I***********                            12  12 DATF                  LN0278
     I                                       13  13 MBIN
     I*                                                                   101930
     IACCOBT      DS                             10                       101930
     I                                        1   1 ACCBTP                101930
     I** AUTOCALL DATA AREA TO DEFINE COB TYPE                            101930
     I*
     IRCOMK       DS
     I*
     I** DATASTRUCTURE FOR REPORT REQUESTS KEY
     I*
     I                                        1  10 D3COTT
     I                                       11  15 D3CSEQ
     I*
     IRREQK       DS
     I*
     I** DATASTRUCTURE FOR REPORT REQUESTS KEY
     I*
     I                                        1  10 D5RNAM
     I                                       11  20 D5COTT
     I                                       21  25 D5CSEQ
     I*
     ICOMSK       DS
     I*
     I** DATASTRUCTURE FOR REPORT REQUESTS KEY
     I*
     I                                        1  10 DHCOTT
     I                                       11  15 DHCSEQ
     I*                                                                   CCB009
     IAUDKDS      DS                                                      CCB009
     I*                                                                   CCB009
     I** DATA STRUCTURE FOR KEY FIELD AUDKEY TO BE MOVED INTO DBKEY FIELD CCB009
     I*                                                                   CCB009
     I                                        1  10 CCOTX                 CCB009
     I                                       11  15 CSEQX                 CCB009
     I                                       16  20 CSDEX                 CCB009
     I                                       21  26 CSTIX                 CCB009
     I*
     I*
     ILDA         DS                            256
     I*
     I** LOCAL DATA AREA FOR DATABASE ERROR STORE
     I*
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*
     IEPPDS      SDS                                                      LN0989
     I                                      244 253 JOJOB                 LN0989
     I                                      254 263 JOUSER                LN0989
     I                                      264 2690JONBR                 LN0989
     I**  PROGRAM STATUS DATA STRUCTURE                                   LN0989
     I**  INFORMATION USED BY ERROR PROCESSING                            LN0989
     I*                                                                   LN0989
     C                     MOVEACPY@      BIS@   80
     C*
      ** ENTRY PARAMETERS
     C*
     C           *ENTRY    PLIST
     C                     PARM           COTT
     C                     PARM           CSEQA   5
     C                     PARM           STS     1
     C                     PARM           CMEDT   60                      101930
     C                     PARM           STREAM  8                                           107700
      *
     C           *LIKE     DEFN DHCOTT    COTT
     C*
      ** KEY LISTS
     C*
     C           RREQ      KLIST
     C                     KFLD           D5RNAM
     C                     KFLD           D5COTT
     C                     KFLD           D5CSEQ                                             BUG2989
      *                                                                                      BUG2989
     C           RREQ2     KLIST                                                             BUG2989
     C                     KFLD           D5COTT                                             BUG2989
     C                     KFLD           D5CSEQ
     C*
     C           PARD      KLIST
     C                     KFLD           D7RNAM
     C                     KFLD           D7RQSQ
     C*
     C           RCOM      KLIST
     C                     KFLD           D3COTT
     C                     KFLD           D3CSEQ
     C*
     C           COMS      KLIST
     C                     KFLD           DHCOTT
     C                     KFLD           DHCSEQ
     C*                                                                   CCB009
     C** Key to chain to CBAUDTL1                                         CCB009
     C*                                                                   CCB009
     C           AUDKEY    KLIST                                          CCB009
     C                     KFLD           CCOT                            CCB009
     C                     KFLD           CSEQ                            CCB009
     C                     KFLD           CSDE                            CCB009
     C                     KFLD           CSTI                            CCB009
     C*
      ***SET*DATE*FORMAT*FLAG*FOR*ZDATE*ROUTINES                          LN0278
     C*
     C*****      *NAMVAR   DEFN           RUNDAT                          LN0278
     C*****                IN   RUNDAT                                    LN0278
     C*****      DATF      COMP 'M'                      98               LN0278
      *                                                                   LN0497
      * IF QSNDDTAQ FAILS THERE IS NOTHING TO SUGGEST IT HAPPENED IN      LN0497
      * THIS PROGRAM.                                                     LN0497
     C           *NAMVAR   DEFN           LDA                             LN0497
     C           *LOCK     IN   LDA                                       LN0497
     C                     MOVEL'CB0055'  DBPGM                           LN0497
     C                     OUT  LDA                                       LN0497
      *                                                                   CCB009
      ** Set flag to show whether Audit file has been written             CCB009
     C                     MOVE 'N'       WAUDT   1                       CCB009
      *                                                                   101930
      ** Access Switchable features file to check if Autocall in ON       101930
      *                                                                   101930
     C                     MOVE 'N'       S01491  1                       101930
     C                     CALL 'AOSARDR0'                                101930
     C                     PARM '       ' @RTCD   7                       101930
     C                     PARM '*VERIFY' @OPTN   7                       101930
     C                     PARM 'S01491 ' @SARD   6                       101930
     C           @RTCD     IFEQ *BLANKS                                   101930
     C                     MOVE 'Y'       S01491                          101930
     C                     END                                            101930
     C/COPY WNCPYSRC,CB0055C001
      *
      ** Access Close of Business Components file for this component/seq
      *
     C                     MOVE CSEQA     CSEQ
     C                     MOVE COTT      DHCOTT
     C                     MOVE CSEQ      DHCSEQ
     C***********COMS      CHAINCBCOMSL0             30                   098640
      * LOOP IF RECORD IS TEMPORARILLY LOCKED                             098640
     C           *IN35     DOUEQ'0'                                       098640
     C           COMS      CHAINCBCOMSL0             3035                 098640
     C           *IN35     IFEQ '1'                                       098640
     C           FSTAT     ANDNE1218                                      098640
     C                     EXSR *PSSR                                     098640
     C                     END                                            098640
     C                     END                                            098640
      *
      ** If no record is found
      **      Database error
      *
     C           *IN30     IFEQ '1'
     C********** *NAMVAR   DEFN           LDA                             LN0497
     C           *LOCK     IN   LDA
     C                     MOVE COMSK     DBKEY            ***************
     C                     MOVE 'CBCOMSL0'DBFILE           * DB ERR  001 *
     C                     Z-ADD1         DBASE            ***************
     C                     MOVEL'CB0055'  DBPGM
     C                     OUT  LDA
     C                     EXSR DBERR
     C                     END
      *
      ** Update Close of Business Components with start date/time
      *
     C********             TIME           TIMDAT 120                      LN0278
     C*                                                                   LN0278
     C** ACCESS DATE, TIME AND DATE FORMAT USING PROGRAM CBTIME           LN0278
     C*                                                                   LN0278
     C                     CALL 'CBTIME'                                  LN0278
     C                     PARM           DAYNOA  5                       LN0278
     C                     PARM           STIME   6                       LN0278
     C                     PARM           DFMT    1                       LN0278
     C******               MOVELTIMDAT    DHCSTI                          LN0278
      *                                                                                       197767
      ** Change time to greater than 00:00:00 as the system                                   197767
      ** may fail to change the date until 00:00:01.                                          197767
      *                                                                                       197767
     C                     MOVE STIME     ST2     60                                          197767
     C           ST2       IFEQ 0                                                             197767
     C                     EXSR TIMSR                                                         197767
     C                     ENDIF                                                              197767
      *                                                                                       197767
     C                     MOVE STIME     DHCSTI                          LN0278
     C******               MOVE TIMDAT    ZDATE                           LN0278
     C******               EXSR ZDATE1                                    LN0278
     C******               Z-ADDZDAYNO    DHCSDE                          LN0278
     C                     MOVE DAYNOA    DHCSDE                          LN0278
     C                     MOVE 'P'       DHCSTS
     C                     MOVE STREAM    DHCBSN                                              107700
      *                                                                   101930
      ** If Autocall is ON, pick up the estimated time for the given      101930
      ** component.                                                       101930
      *                                                                   101930
     C                     Z-ADD0         CMEDT   60                      101930
     C           S01491    IFEQ 'Y'                                       101930
     C                     EXSR ACSR1                                     101930
     C                     END                                            101930
      *                                                                   101930
     C                     UPDAT@DHREGG
      *                                                                   101930
      ** If Autocall is ON, call AC0001 to calculate the end time for the 101930
      ** given component                                                  101930
      *                                                                   101930
     C           S01491    IFEQ 'Y'                                       101930
     C                     EXSR ACSR2                                     101930
     C                     END                                            101930
     C*                                                                   CCB009
     C** Open failed details file CBAUDTL1.                               CCB009
     C*                                                                   CCB009
     C                     OPEN CBAUDTL1                                  CCB009
     C*                                                                   CCB009
     C** Set up component name and sequence number to write out           CCB009
     C** to LF/CBAUDTL1.                                                  CCB009
     C*                                                                   CCB009
     C                     MOVE DHCOTT    CCOT                            CCB009
     C                     MOVE DHCSEQ    CSEQ                            CCB009
     C*                                                                   CCB009
     C** Set component end date and time to zero.                         CCB009
     C*                                                                   CCB009
     C                     Z-ADD0         CETI                            CCB009
     C                     Z-ADD0         CEDE                            CCB009
     C*                                                                   CCB009
     C** Retrieve component start time and date from work fields.         CCB009
     C*                                                                   CCB009
     C                     MOVE DHCSTI    CSTI                            CCB009
     C                     MOVE DHCSDE    CSDE                            CCB009
     C*                                                                   CCB009
     C** Write record to failed details file.                             CCB009
     C*                                                                   CCB009
     C                     WRITECBAUDTP0                                  CCB009
     C*                                                                   CCB009
      ** Set flag to show whether Audit file has been written             CCB009
     C                     MOVE 'Y'       WAUDT                           CCB009
     C*                                                                   CCB009
     C** Close failed details file.                                       CCB009
     C*                                                                   CCB009
     C                     CLOSECBAUDTL1                                  CCB009
      *
      ** Access Report Components file with component/seq to get report name
      *
     C                     MOVE COTT      D3COTT
     C                     MOVE CSEQ      D3CSEQ
     C***********RCOM      CHAINFCRCOML3             30                   064115
     C           RCOM      CHAINFCRCOMJ3             30                   064115
      *
      ** If no record found
      **     Database error
      *
     C           *IN30     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE RCOMK     DBKEY            ***************
     C*********************MOVE 'FCRCOML3'DBFILE           * DB ERR  002 *064115
     C                     MOVE 'FCRCOMJ3'DBFILE           * DB ERR  002 *064115
     C                     Z-ADD2         DBASE            ***************
     C                     MOVEL'CB0055'  DBPGM
     C                     OUT  LDA
     C                     EXSR DBERR
     C                     END
      *
      ** Set Lower Limits on Report Requests for the report name
      *
     C                     MOVE D3RNAM    D5RNAM
     C                     MOVE COTT      D5COTT
     C                     MOVE CSEQ      D5CSEQ
     C           RREQ      SETLLFCRREQL8                 31
      *
      ** If no records exist for the report name
      **     Database error
      *
     C                     MOVE *BLANK    WNTFND  1                                         BUG10349
     C           *IN31     IFEQ '0'
      *                                                                                     BUG10349
      ** If record not found on FCRREQPD, blank out parameter being passed to               BUG10349
      ** CBC0056                                                                            BUG10349
      *                                                                                     BUG10349
     C                     MOVE *BLANK    D5RQSQ                                            BUG10349
     C                     MOVE *BLANK    D5LVL                                             BUG10349
     C                     MOVE *BLANK    D5ETTY                                            BUG10349
     C                     MOVE 'Y'       WNTFND                                            BUG10349
      *                                                                                      BUG2989
      ** If not found FCRREQL8, search for it in CBCOBRL0                                    BUG2989
      *                                                                                      BUG2989
     C           RREQ2     SETLLCBCOBRL0                 31                                  BUG2989
      *                                                                                      BUG2989
      ** if still not found then issue DBERROR                                               BUG2989
      *                                                                                      BUG2989
     C           *IN31     IFEQ '0'                                                          BUG2989
     C           *LOCK     IN   LDA
     C                     MOVELRREQK     DBKEY            ***************
     C                     MOVE 'FCRREQL8'DBFILE           * DB ERR  003 *
     C                     Z-ADD3         DBASE            ***************
     C                     MOVEL'CB0055'  DBPGM
     C                     OUT  LDA
     C                     EXSR DBERR
     C                     END
     C                     ENDIF                                                             BUG2989
      *
      ** Access first request for this report
      *
     C           WNTFND    IFEQ *BLANK                                                      BUG10349
     C                     READ FCRREQL8                 32
     C                     ENDIF                                                            BUG10349
     C                     EXSR PROCRQ
      *
      ** Access Component record
      *
     C***********RCOM      CHAINFCRCOML3             30                   064115
     C           RCOM      CHAINFCRCOMJ3             30                   064115
      *
      ** If no record found
      **     Database error
      *
     C           *IN30     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE RCOMK     DBKEY            ***************
     C*********************MOVE 'FCRCOML3'DBFILE           * DB ERR  004 *064115
     C                     MOVE 'FCRCOMJ3'DBFILE           * DB ERR  004 *064115
     C                     Z-ADD4         DBASE            ***************
     C                     MOVEL'CB0055'  DBPGM
     C                     OUT  LDA
     C                     EXSR DBERR
     C                     END
      *
     C***********COMS      CHAINCBCOMSL0             30                   098640
      * LOOP IF RECORD IS TEMPORARILLY LOCKED                             098640
     C           *IN35     DOUEQ'0'                                       098640
     C           COMS      CHAINCBCOMSL0             3035                 098640
     C           *IN35     IFEQ '1'                                       098640
     C           FSTAT     ANDNE1218                                      098640
     C                     EXSR *PSSR                                     098640
     C                     END                                            098640
     C                     END                                            098640
      *
      ** If no record is found
      **      Database error
      *
     C           *IN30     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE COMSK     DBKEY            ***************
     C                     MOVE 'CBCOMSL0'DBFILE           * DB ERR  005 *
     C                     Z-ADD5         DBASE            ***************
     C                     MOVEL'CB0055'  DBPGM
     C                     OUT  LDA
     C                     EXSR DBERR
     C                     END
      *
      ** Update Component record to completed
      *
     C                     MOVE 'C'       DHCSTS
     C********             TIME           TIMDAT 120                      LN0278
     C*                                                                   LN0278
     C** ACCESS DATE, TIME AND DATE FORMAT USING PROGRAM CBTIME           LN0278
     C*                                                                   LN0278
     C                     CALL 'CBTIME'                                  LN0278
     C                     PARM           DAYNOA                          LN0278
     C                     PARM           STIME                           LN0278
     C                     PARM           DFMT                            LN0278
      *                                                                                       197767
      ** Apply time fix as above.                                                             197767
      *                                                                                       197767
     C                     MOVE STIME     ST2                                                 197767
     C           ST2       IFEQ 0                                                             197767
     C                     EXSR TIMSR                                                         197767
     C                     ENDIF                                                              197767
      *                                                                                       197767
     C******               MOVE TIMDAT    ZDATE                           LN0278
     C******               EXSR ZDATE1                                    LN0278
     C******               Z-ADDZDAYNO    DHCEDE                          LN0278
     C                     MOVE DAYNOA    DHCEDE                          LN0278
     C******               MOVELTIMDAT    DHCETI                          LN0278
     C                     MOVE STIME     DHCETI                          LN0278
     C*                                                                                       247203
     C           DHCHTA    IFEQ 'Y'                                                           247203
     C                     MOVE 'H'       DHCHTA                                              247203
     C                     ENDIF                                                              247203
      *
     C                     UPDAT@DHREGG
      *
      ** Set parameter status to completed
      *
     C                     MOVE 'C'       STS
      *
      ** If halt after component field from component record is 'Y'
      ** AND no halt is currently outstanding (CBSTAT position 20)
      **     Send message to halt to CBDTQA
      **     Update CBSTAT to 'R' (Halt in progress)
      *
     C***********DHCHTA    IFEQ 'Y'                                                           247203
     C           DHCHTA    IFEQ 'H'                                                           247203
     C           *NAMVAR   DEFN           CBSTAT
     C           *IN70     DOUEQ'0'                                       LN0545
     C************LOCK     IN   CBSTAT                                    LN0545
     C           *LOCK     IN   CBSTAT                 70                 LN0545
     C                     END                                            LN0545
      *
     C           HALT      IFEQ 'N'
     C                     CALL 'QSNDDTAQ'
     C                     PARM 'CBDTQA'  QUEUE  10
     C                     PARM '*LIBL'   LIB    10
     C**********           PARM 20        LEN    150                      LN0497
     C                     PARM 16        LEN     50                      LN0497
     C**********           PARM ARR,1     MSG    20                       LN0497
     C                     PARM ARR,1     MSG    16                       LN0497
     C                     MOVE 'R'       HALT
     C                     END
      *
     C                     OUT  CBSTAT
     C                     END
      *
     C                     EXSR END
      ********************************************************************
      *            INDEX OF SUBROUTINES
      **     PROCRQ - PROCESS FCRREQL8 RECORDS
      **     DBERR - PROCESS DATABASE ERROR
      **     ERROR - WRITE ERROR RECORD
      **     END - TERMINATE PROGRAM
      **     ZDATE1 - STANDARD MIDAS SUBROUTINE DATE > DAY NUMBER
      **     ACSR1  - AUTOCALL SR. TO PICK UP 'TIME TAKEN' FOR COMPONENT. 101930
      **     ACSR2  - AUTOCALL SR. TO CALCULATE END TIME FOR COMPONENT.   101930
     C**     *PSSR -  TERMINATES PROGRAM IF EXCEPTION ERROR OCCURS
      **     TIMSR -  SR to correct error when time = 0.                                      197767
      ********************************************************************
      /EJECT
      ********************************************************************
      ** S/R PROCRQ - PROCESS FCRREQL8 RECORDS
      ** CALLED FROM MAIN PROCESSING
      ** CALLS ERROR DBERR
      ********************************************************************
      *
     C           PROCRQ    BEGSR
      *
      ** DOWHILE Requests remain for this report
      *
     C***********          MOVE DHCPRM    PMHOLD100                       081912
     C                     MOVEL*BLANKS   PMHOLD256                       081912
     C                     MOVELDHCPRM    PMHOLD                          081912
     C           *IN32     DOWEQ'0'
      *
      **     Access Report Parameters for this report/seq
      *
     C                     MOVE D5RNAM    D7RNAM
     C                     MOVE D5RQSQ    D7RQSQ
      *
     C           PARD      CHAINFCPARDL1             30
      *
      **     If no record is found
      **          Set parameter fields to blank
      *
     C           *IN30     IFEQ '1'
     C                     MOVE *BLANK    D7PARM
     C                     END
     C/COPY WNCPYSRC,CB0055C002
      *
      **     Call Parameter concatenation program
      *
     C                     MOVEL*BLANKS   O#CPRM                          081912
     C                     MOVELDHCPRM    O#CPRM                          081912
      *                                                                   081912
     C                     CALL 'CBC0056'
     C**********           PARM           DHCPRM                          081912
     C                     PARM           O#CPRM256                       081912
     C                     PARM           D5RQSQ
     C                     PARM           D5LVL
     C                     PARM           D5ETTY
     C                     PARM           D7PARM
     C/COPY WNCPYSRC,CB0055C003
      *
      **     Call Close of Business component submission program
      *
     C                     CALL 'CBC0051'
     C                     PARM           DHCOTT
     C**********           PARM           DHCPRM                          081912
     C                     PARM           O#CPRM                          081912
     C                     PARM '0'       INU7    1
     C                     PARM '0'       INU8    1
     C                     PARM           ERR     1
      *
      **     Set indicators as returned
      *
     C                     MOVE INU7      *INU7
     C                     MOVE INU8      *INU8
      *
      **     If U7 is on
      **     OR U8 is on and FCOOB is not 'Y' for the component
      **     OR 'ERROR' is '1'
      **          Access Component record
      *
     C           *INU7     IFEQ '1'
     C           *INU8     OREQ '1'
     C           DHCFOB    ANDNE'Y'
     C           ERR       OREQ '1'
     C***********COMS      CHAINCBCOMSL0             30                   098640
      * LOOP IF RECORD IS TEMPORARILLY LOCKED                             098640
     C           *IN35     DOUEQ'0'                                       098640
     C           COMS      CHAINCBCOMSL0             3035                 098640
     C           *IN35     IFEQ '1'                                       098640
     C           FSTAT     ANDNE1218                                      098640
     C                     EXSR *PSSR                                     098640
     C                     END                                            098640
     C                     END                                            098640
      *
      **          If no record found
      **               Database error
      *
     C           *IN30     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE COMSK     DBKEY            ***************
     C                     MOVE 'CBCOMSL0'DBFILE           * DB ERR  006 *
     C                     Z-ADD6         DBASE            ***************
     C                     MOVEL'CB0055'  DBPGM
     C                     OUT  LDA
     C                     EXSR DBERR
     C                     END
      *
      *********** Update*Component*to*failed*status                       LN0486
      *
     C******               MOVE 'A'       DHCSTS                          LN0486
     C******               MOVE 'Y'       DHCFAL                          LN0486
     C******               UPDAT@DHREGG                                   LN0486
      *
      **          Write audit record
      **          Set status to 'A' for return
      *
     C                     EXSR ERROR
      *
      **          Terminate Program
      *
     C                     EXSR END
      *
     C                     END
      *
     C           RREQ      READEFCRREQL8                 32
      *
     C                     MOVE *BLANK    DHCPRM
     C**********           MOVE PMHOLD    DHCPRM                          081912
     C                     MOVELPMHOLD    DHCPRM                          081912
      *
     C                     END
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      ** S/R DBERR - PROCESS DATABASE ERROR
      ** CALLED FROM MAIN PROCESSING, PROCRC
      ** CALLS END
      ********************************************************************
      *
     C           DBERR     BEGSR
      *
     C                     SETON                     U7U8
      *
      **  If the error has occurred in an access to one of the RCF
      **  files then do a further 'CHAIN' into CBCOMSPD to prevent
      **  IBM error message appearing
      *
     C           DBASE     IFEQ 2
     C           DBASE     OREQ 3
     C           DBASE     OREQ 4
     C*
     C***********COMS      CHAINCBCOMSL0             30                   098640
      * LOOP IF RECORD IS TEMPORARILLY LOCKED                             098640
     C           *IN35     DOUEQ'0'                                       098640
     C           COMS      CHAINCBCOMSL0             3035                 098640
     C           *IN35     IFEQ '1'                                       098640
     C           FSTAT     ANDNE1218                                      098640
     C                     EXSR *PSSR                                     098640
     C                     END                                            098640
     C                     END                                            098640
     C*
     C                     END
      *
      **               Write audit record
      **               Set status to 'A' for return
      *
     C                     EXSR ERROR
      *
      **          Terminate Program
      *
     C                     EXSR END
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      ** S/R ERROR - WRITE ERROR RECORD & UPDATE ERROR DETAILS ON         LN0486
      **             COMPONENTS FILE                                      LN0486
      ** CALLED FROM MAIN PROCESSING, PROCRC
      ** CALLS NO OTHER SUBROUTINES
      ********************************************************************
      *
     C           ERROR     BEGSR
      *
      *                                                                   LN0486
      *           Update Component to failed status                       LN0486
      *                                                                   LN0486
     C                     MOVE 'A'       DHCSTS                          LN0486
     C                     MOVE 'Y'       DHCFAL                          LN0486
      *                                                                                       197767
      ** Update of CBCMOMSL0 should be after the issue of CBTIME.                             197767
      *                                                                                       197767
     C**********           UPDAT@DHREGG                                                LN0486 197767
      *                                                                   LN0486
      **          Set status to 'A' for return
      *
     C                     MOVE 'A'       STS
      *
     C***********          OPEN CBAUDTPD                                  CCB009
     C                     OPEN CBAUDTL1                                  CCB009
      *
      **          Write audit record
      ** or Update audit record if already written                        CCB009
      *
     C           WAUDT     IFEQ 'N'                                       CCB009
      *                                                                   CCB009
     C                     MOVE DHCOTT    CCOT
     C                     MOVE DHCSEQ    CSEQ
     C*****                MOVE TIMDAT    CSDE                            LN0278
     C                     MOVE DAYNOA    CSDE                            LN0278
     C******               MOVELTIMDAT    CSTI                            LN0278
     C                     MOVELSTIME     CSTI                            LN0278
     C********             TIME           TIMDAT                          LN0278
      *                                                                   CCB009
     C                     ELSE                                           CCB009
      *                                                                   CCB009
      ** Chain to component start record on LF/CBAUDTL1.                  CCB009
      *                                                                   CCB009
     C           AUDKEY    CHAINCBAUDTL1             36                   CCB009
      *                                                                   CCB009
      ** If no record found on CBAUDTL1, set                              CCB009
      ** component status parameter to 'A'                                CCB009
      *                                                                   CCB009
     C           *IN36     IFEQ '1'                                       CCB009
     C                     MOVE 'A'       STS                             CCB009
     C           *LOCK     IN   LDA                                       CCB009
     C                     MOVE CCOT      CCOTX                           CCB009
     C                     MOVE CSEQ      CSEQX                           CCB009
     C                     MOVE CSDE      CSDEX                           CCB009
     C                     MOVE CSTI      CSTIX                           CCB009
     C                     MOVELAUDKDS    DBKEY            ***************CCB009
     C                     MOVEL'CBAUDTL1'DBFILE           * DB ERROR 08 *CCB009
     C                     Z-ADD8         DBASE            ***************CCB009
     C                     ENDIF                                          CCB009
      *                                                                   CCB009
     C                     ENDIF                                          CCB009
     C*                                                                   LN0278
     C** ACCESS DATE, TIME AND DATE FORMAT USING PROGRAM CBTIME           LN0278
     C*                                                                   LN0278
     C                     CALL 'CBTIME'                                  LN0278
     C                     PARM           DAYNOA  5                       LN0278
     C                     PARM           STIME   6                       LN0278
     C                     PARM           DFMT    1                       LN0278
     C******               MOVE TIMDAT    ZDATE                           LN0278
     C******               EXSR ZDATE1                                    LN0278
     C******               Z-ADDZDAYNO    DHCEDE                          LN0278
     C***********          MOVE DAYNOA    DHCEDE                    LN0278E36396
      *                                                                                       197767
      ** Apply time fix as above.                                                             197767
      *                                                                                       197767
     C                     MOVE STIME     ST2                                                 197767
     C           ST2       IFEQ 0                                                             197767
     C                     EXSR TIMSR                                                         197767
     C                     ENDIF                                                              197767
      *                                                                                       197767
     C                     MOVE DAYNOA    CEDE                            E36396
     C******               MOVELTIMDAT    CETI                            LN0278
     C                     MOVE STIME     CETI                            LN0278
      *
     C           WAUDT     IFEQ 'N'                                       CCB009
     C                     WRITECBAUDTP0
     C                     ELSE                                           CCB009
     C                     UPDATCBAUDTP0                                  CCB009
     C                     ENDIF                                          CCB009
      *                                                                   CCB009
     C                     CLOSECBAUDTL1                                  CCB009
      *                                                                                       197767
      ** If component fails, also update fields DHCETI and DHCEDE of                          197767
      ** CBCOMSPD to avoid end time/date = 0.                                                 197767
      *                                                                                       197767
     C                     MOVE DAYNOA    DHCEDE                                              197767
     C                     MOVE STIME     DHCETI                                              197767
     C                     UPDAT@DHREGG                                                       197767
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      ** S/R END - TERMINATE PROGRAM
      ** CALLED FROM MAIN PROCESSING, PROCRC, DBERR
      ** CALLS NO OTHER SUBROUTINES
      ********************************************************************
      *
     C           END       BEGSR
     C                     SETON                     LR
     C                     RETRN
     C                     ENDSR
      ********************************************************************
      /EJECT
     E*****/COPY ZSRSRC,ZDATE1Z2                                          LN0278
      /EJECT                                                              101930
      ********************************************************************101930
      *                                                                   101930
      *  Subroutine ACSR1  - Find the 'time taken' for component          101930
      *                                                                   101930
      *  Called by: Main processing, if Autocall (S01491) is ON           101930
      *                                                                   101930
      ********************************************************************101930
      *                                                                   101930
     C           ACSR1     BEGSR                                          101930
      *                                                                   101930
     C           *NAMVAR   DEFN           ACCOBT                          101930
     C                     IN   ACCOBT                                    101930
      *                                                                   101930
     C           ACCBTP    IFEQ 'Y'                                       101930
     C                     Z-ADDDHEOYT    CMEDT                           101930
     C                     END                                            101930
      *                                                                   101930
     C           ACCBTP    IFEQ 'B'                                       101930
     C                     Z-ADDDHBOMT    CMEDT                           101930
     C                     END                                            101930
      *                                                                   101930
     C           ACCBTP    IFEQ 'M'                                       101930
     C                     Z-ADDDHEOMT    CMEDT                           101930
     C                     END                                            101930
      *                                                                   101930
     C           ACCBTP    IFEQ 'D'                                       101930
     C                     Z-ADDDHEODT    CMEDT                           101930
     C                     END                                            101930
      *                                                                   101930
     C           ACSR19    ENDSR                                          101930
      *                                                                   101930
      ********************************************************************101930
      /EJECT                                                              101930
      ********************************************************************101930
      *                                                                   101930
      *  Subroutine ACSR2  - Calculate the 'end time' for component       101930
      *                                                                   101930
      *  Called by: Main processing, if Autocall (S01491) is ON           101930
      *                                                                   101930
      ********************************************************************101930
      *                                                                   101930
     C           ACSR2     BEGSR                                          101930
      *                                                                   101930
     C                     CALL 'AC0001'                                  101930
     C                     PARM           COTT                            101930
     C                     PARM           CSEQA                           101930
     C                     PARM           CMEDT                           101930
     C                     PARM 'A'       MODE    1                       101930
      *                                                                   101930
     C           ACSR29    ENDSR                                          101930
      *                                                                   101930
      ********************************************************************101930
      /EJECT
     C********************************************************************
     C**                                                                 *
     C**   *PSSR SR. -  Database Error Handling : Terminates program;    *
     C**   ~~~~~~~~~                                                     *
     C**                                                                 *
     C**
     C           *PSSR     BEGSR
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
     C                     SETON                     U7U8LR
     C**
     C**  Write out component in error details
     C**
     C***********COMS      CHAINCBCOMSL0             30                   098640
      * LOOP IF RECORD IS TEMPORARILLY LOCKED                             098640
     C           *IN35     DOUEQ'0'                                       098640
     C           COMS      CHAINCBCOMSL0             3035                 098640
     C                     END                                            098640
      *
      **          If no record found update LDA
      **            with database error values
      *
     C           *IN30     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE COMSK     DBKEY            ***************
     C                     MOVE 'CBCOMSL0'DBFILE           * DB ERR  007 *
     C                     Z-ADD7         DBASE            ***************
     C                     MOVEL'CB0055'  DBPGM
     C                     OUT  LDA
     C**********           ELSE                                           LN0486
      *
      ************Update*Component*to*failed*status                       LN0486
      *
     C**********           MOVE 'A'       DHCSTS                          LN0486
     C**********           MOVE 'Y'       DHCFAL                          LN0486
     C**********           UPDAT@DHREGG                                   LN0486
     C                     END
      *
     C                     EXSR ERROR
     C                     DUMP
     C                     END
     C                     RETRN
     C                     ENDSR
      ****************************************************************
      *  TIMSR - Correct errors caused when time = 0.                 *                       197767
      *                                                               *                       197767
      *  Called by: Activated when time = 0.                          *                       197767
      *                                                               *                       197767
      *****************************************************************                       197767
     C           TIMSR     BEGSR                                                              197767
      *                                                                                       197767
     C           ST2       DOUGT0                                                             197767
     C                     CALL 'CBTIME'                                                      197767
     C                     PARM           DAYNOA                                              197767
     C                     PARM           STIME                                               197767
     C                     PARM           DFMT                                                197767
     C                     MOVE STIME     ST2                                                 197767
     C                     ENDDO                                                              197767
      *                                                                                       197767
     C                     ENDSR                                                              197767
      ****************************************************************                        197767
** CPY@
(c) Finastra International Limited 2001
** MSG
AFTER          H
