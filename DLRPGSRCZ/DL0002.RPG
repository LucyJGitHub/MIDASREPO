     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas DL Cityd LE, FT, RE & NT trans. extract')        *
      *****************************************************************
      *                                                               *
      *  Midas - Dealing Module                                       *
      *                                                               *
      *  DL0002 - Midas/Citydealer LE, FT, RE, & NT Trans. Extract    *
      *                                                               *
      *  Function:  This program will be executed as the 'EXIT' prog- *
      *  ( I/C )    ram from within a RCVJRNE command on journal      *
      *             ICJRN from within DLC0002.  This will monitor for *
      *             any transactions which may affect cashflow and    *
      *             exposure from within LE, RE, FT and NT.  Details  *
      *             of these transactions will be extracted for trans-*
      *             mission to Citydealer.                            *
      *                                                               *
      *  Called By: DLC0002 - LE, FT, RE & NT Transactions Extract    *
      *                       Control                                 *
      *                                                               *
      *  Calls    : BUDEALR0- Background Update of Citydealer Dealing *
      *                       ICD                                     *
      *             QSNDDTAQ- Send a message to Dataqueue/DLCDDTAQ    *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. CSD103             Date 10Aug20               *
      *  Prev Amend No. MD055733           Date 03Jul20               *
      *                 MD051643           Date 23Jul19               *
      *                 MD053295           Date 13Apr19               *
      *                 MD050139           Date 23Mar18               *
      *                 CLE071             Date 18Jul18               *
      *                 MD046248           Date 27Oct17               *
      *                 MD047993           Date 23Sep17               *
      *                 MD035545           Date 11Sep15               *
      *                 CGL184             Date 07Dec16               *
      *                 AR996895           Date 25Nov12               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CRE075             Date 06Dec10               *
      *                 CLE064             Date 06Dec10               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      *                 CER047             Date 19May08               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 CAP205             Date 08Mar10               *
      *                 CAP204             Date 09Feb10               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246141             Date 26Mar07               *
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 BUG11679           Date 05Jul06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CIR013             Date 25Apr05               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 15May01               *
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CIR004             Date 20Jan00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CPB001             Date 18Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CEU003             Date 28Mar98               *
     F*                 126017             DATE 28MAR98               *
     F*                 121768             DATE 19FEB98               *
      *                 099849             DATE 21FEB96               *
      *                 099621             DATE 14FEB96               *
      *                 096429             DATE 27NOV95               *
      *                 095961             DATE 17NOV95               *
      *                 095960             DATE 17NOV95               *
      *                 095959             DATE 15NOV95               *
      *                 095869             DATE 13NOV95               *
      *                 095763             DATE 09NOV95               *
      *                 095638             DATE 08NOV95               *
      *                 095465             DATE 06NOV95               *
      *                 095443             DATE 06NOV95               *
      *                 095399             DATE 03NOV95               *
      *                 095340             DATE 02NOV95               *
      *                 095306             DATE 01NOV95               *
      *                 CCM002 *CREATE     DATE 04SEP95               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CSD103 - LIBOR Deregulation - Common Layer/Standing Data     *
      *  MD055733 - COB: Multiple UTCHOBJEX calls in LEC06A           *
      *             components.                                       *
      *           - Redeliver of MD050139.                            *
      *  MD051643 - DLC0002 job does not auto start after COB.        *
      *             Amend DS/RSACDS to correct position for RSACMTPD. *
      *  MD053295 - Lending loan with Interest Calculation Basis      *
      *             method 3 (30/360) has wrong interest payment      *
      *             amount for month of March (Recompile)             *
      *  MD050139- AOSARDR0 called every time causing performance     *
      *            issue. Recompile due to changes in /COPY           *
      *            ZFREQ/ZFRQ*.                                       *
      *  CLE071 - Value Dating of Rate Changes to Fees (Recompile)    *
      *  MD046248 - Finastra Rebranding                               *
      *  MD047993 - Modified MD035545. Removed dependency on Accrue   *
      *             on Last Day indicator.                            *
      *  MD035545 - LE: Interest Calculation in Leap year. Consider   *
      *             Accrue on Last Day Indicator for method 6.        *
      *  CGL184 - New Frequencies for Account Statements (Recompile)  *
      *  AR996895 - Incorrect accrual interest calculation            *
      *             (Child: AR996897) (Recompile)                     *
      *  CLE134 - Past Due Call Loan Processing                       *
      *  CLE148 - Alpha Loan Reference                                *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CLE064 - Enhancement of Lending Frequencies (Recompile)      *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *            to Midas Plus (Recompile)                          *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus                                          *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  CAP204 - Teller Related APIs - Account Transfer              *
      *  246141 - Recompiled due to changes in ZINTDYZ2               *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG11679 - Additional Conversion of Customer Number to Alpha *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over GLINTC and ZINTDY.                   *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CSD006 - Use long DS with SDBSRTPD.                          *
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
      *  CIR004 - Dealing Calculation Method Change.                  *
      *         - Recompiled due to GLINTC and ZINTDY changes         *
      *  CPB001 - 'Private Banking' Module                            *
     F*  CEU003 - EMU Dealing Settlement Ccy conversion               *
     F*  126017 - Correction to interest calculation for calculation  *
     F*           basis 6 in SR/GLINTC. Add SR/ZDAT10                 *
     F*  121768 - Recompile over changed GLINTCZ1                     *
      *  099849 - Citydealer interface not initiated correctly. If    *
      *           the COB finished late in the evening, then the last *
      *           transmission time will always be greater than the   *
      *           current transmission period, so job is not called.  *
      *  099621 - Start date events are extracted with date set to    *
      *           '99999' because VDAT is being overwritten by Loan   *
      *           amendments file trailer if no loan amendments on    *
      *           file.                                               *
      *  096429 - Rollover events are extracted against the wrong     *
      *           accounts and reversed in COB.                       *
      *  095961 - Reversals are not extracted correctly. Amounts are  *
      *           being reversed twice, both for Before and After     *
      *           journal images.                                     *
      *  095960 - Repayments Scheduled are not extracted correctly.   *
      *  095959 - Manual Repayments are not extracted correctly.      *
      *  095869 - Fees based on threshold percentage method are always*
      *           being set to zero.                                  *
      *  095763 - Account movements are being picked up from RSACMTPD *
      *           even if not for Retail or Nostro accounts.          *
      *           Also, correct Database Error numbering.             *
      *  095638 - Additional messages are processed from journal      *
      *           images for RSACMTPD which are incorrect.            *
      *  095465 - Access object AOACCTR0 is called with the wrong set *
      *           of parameters causing it to crash.                  *
      *  095443 - Program loops when processing an interest repayment *
      *           event for a Non-Autosettle loan.                    *
      *  095399 - Access to base rate fails even though the base rate *
      *           does exist on file.                                 *
      *  095340 - Uncommitted changes remain when job is terminated.  *
      *  095306 - Recompiled due to printer file change.              *
      *  CCM002 - Midas/Citydealer Interface (Phases V and VI)        *
      *                                                               *
      *****************************************************************
     FCLOAN   IF  E           K        DISK
     FLOAMS   IF  E           K        DISK
     F            LOAMSDHF                          KIGNORE               099621
     F            LOAMSZ1F                          KIGNORE               099621
     FFCLTY   IF  E           K        DISK
     FDLCDJNPDUF  E                    DISK         KCOMIT
     FDL0002AUO   E                    PRINTER                        UC
      /TITLE FUNCTION OF INDICATORS
     F*****************************************************************
     F*                                                               *
     F*  F U N  C T I O N    O F    I N D I C A T O R S               *
     F*                                                               *
     F*  16         LOKUP of FPC array                                *
     F*  17         LOKUP of FPC array                                *
     F*  40         Failed CHAIN to LF/CLOAN                          *
     F*  41         Failed CHAIN to LF/FCLTY                          *
     F*  42         Error on update to PF/DLCDJNPD                    *
     F*  56         End of file on LF/LOAMS                           *
     F*  57         End of file on PF/DLCDJNPD                        *
     F*  58         Bit '1' of ACEI is Off                            *
     F*  59         Stop Accruals is not active                       *
     F*  60         Work indicator for COMP op code                   *
     F*  61         Bit '4' of BITS is Off                            *
     F*  97         SHUT DOWN                                         *
     F*  98         Date Format Indicator                             *
     F*  U7         Database Error                                    *
     F*  U8         Database Error                                    *
     F*  LR         Exit program                                      *
     F*                                                               *
     F*****************************************************************
      /TITLE SUBROUTINE INDEX
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E    I N D E X                             *
     F*                                                               *
     F*  Main routine                                                 *
     F*  #LINIT  -  Initial Screen Processing                         *
     F*  #LLLAC  -  Processing for Loan and Loan Amendment Changes    *
     F*  #LPLAC  -  Processing for Loan Amendment Changes             *
     F*  #LPFCC  -  Processing for Facility Changes                   *
     F*  #LPFFC  -  Processing for Facility Fee Changes               *
     F*  #LPACM  -  Processing for Account Movement Changes           *
     F*  #LCJIP  -  Check if Journal Image to be Processed            *
     F*  #LDMTT  -  Determine Module/Type of the Transaction          *
     F*  #LCSEM  -  Create Start Date Event Messages                  *
     F*  #LCAEM  -  Create Amendment Date Event Messages              *
     F*  #LCIEM  -  Create Interest Date Event Messages               *
     F*  #LCREM  -  Create Repayment Date Event Messages              *
     F*  #LCOEM  -  Create Rollover Date Event Messages               *
     F*  #LCMEM  -  Create Maturity Date Event Messages               *
     F*  #LDTNA  -  Determine if transaction is across a Nostro A/C   *
     F*  #LDTRA  -  Determine if transaction is across a Retail A/C   *   095763
     F*  #LDTDP  -  Determine if transmission delay period has elapsed*
     F*  #LSMDQ  -  Send a message to the DTAQ/DLCDDTAQ               *
     F*  #LULTD  -  Update Last Transmission details on Dealing ICD   *
     F*  #LPINC  -  Perform Interest Calculation                      *
     F*  #LCNER  -  Calculate New Effective Rate                      *
     F*  #LDFDD  -  Determine Facility Due Date                       *
     F*  #LDNCF  -  Determine Non-calculated Fees                     *
     F*  #LDNCF  -  Determine Calculated Fees                         *
     F*  #LLRTP  -  Perform Last Rate Processing                      *
     F*  GLINTC  -  Calculate Interest Between Two Dates              *
     F*  ZFREQB  -  Calculate Next Payment/Statement Date             *
     F*  ZFWDT   -  Find nth Working Day Forward from a Given Date    *
     F*  ZASNMS  -  Send Message to Program Message Queue             *
     F*  *PSSR   -  Error Subroutine                                  *
     F*                                                               *
     F*****************************************************************
     E/EJECT
      *****************************************************************
     E                    CPY@    1   1 80
     E*
     E** Array containing Copyright statement
     E*
     E                    POWER   1   7  7 3             Power Array
      /COPY ZSRSRC,ZDATE2Z1
      /COPY ZSRSRC,ZFREQBZ1
      /COPY ZSRSRC,ZHOLE
      /COPY ZSRSRC,ZDATE9Z1
     E                    FEEM        5 11 0A            Fee Amounts
     E                    FAM         5 15 0A            Fee Amounts
     E                    FRT         5  7 5A            Fee Rates
     E                    FPC         5  6 3A            Fee Percentage
      /SPACE 3
     ICLOANCLF
     I              BRCA                            BRCACL
      *
      ** Rename NLRA field in CLOANCK to distinuish it from similarly     126017
      ** named field defined in LOAMSZ1                                   126017
      *                                                                   126017
     ICLOANCKF                                                            126017
     I              NLRA                            NLRACK                126017
      *                                                                   126017
      ** Rename LOAMSDK fields to distinguish from CLOANCL fields
      *
     ILOAMSDKF
     I              RECI                            RECILA
     I              LNRF                            LNRFLA
     I              VDAT                            VDATLA
     I              LTYP                            LTYPLA
     I              SUTP                            SUTPLA
     I              PTYP                            PTYPLA
     I              BRTT                            BRTTLA
     I              RTSP                            RTSPLA
     I              CCY                             CCYLA
     I              BRCA                            BRCALA
     I              CNUM                            CNUMLA
     I              REPT                            REPTLA
     I              FACO                            FACOLA
     I              AUTO                            AUTOLA
     I              WTIN                            WTINLA
     I              FCUS                            FCUSLA
     I              FTYP                            FTYPLA
     I              FSEQ                            FSEQLA
     I              CHTP                            CHTPLA
     I              PSTM                            PSTMLA
     I              PONS                            PONSLA
     I              RSTM                            RSTMLA
     I              RONS                            RONSLA
     I              MRIN                            MRINLA
     I              PIBA                            PIBALA
     I              PIBN                            PIBNLA
     I              POBN                            POBNLA
     I              POCN                            POCNLA
     I              RCRN                            RCRNLA
     I              RIBA                            RIBALA
     I              RIBN                            RIBNLA
     I              ROBN                            ROBNLA
     I              ROCN                            ROCNLA
     I              SCCY                            STCYLA                CEU003
      *
     ILDA       E DSLDA                         256
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
      **                                    134 141 DBFILE
      **       Defines:                     142 170 DBKEY
      **                                    171 180 DBPGM
      **                                    181 1830DBASE
      *
     I***********JRNENT      DS                            760            CEU003
     I***JRNENT*     DS                           1223                                 CEU003 CGL029
     IJRNENT      DS                           1586                                           CGL029
     I                                        6  150JRNSQ
     I                                       17  18 JOENTT
     I                                       57  66 JOPGM
     I                                       87  96 JFILE
      *
      **    CLOANCL -  CUSTOMER LOANS
      *
     I***********LOANCL      DS                            760            CEU003
     I***LOANCL*     DS                           1223                                 CEU003 CGL029
     I***LOANCL*     DS                           1586                                 CGL029 CER020
     ILOANCL      DS                           1782                                           CER020
     I                                      126 126 RECI
     I**********                            127 1320LNRF                                      CLE148
     I                                      127 132 LNRF                                      CLE148
     I                                      133 133 RCDT
     I                                      134 1340MRIN
     I                                      135 1360PTYP
     I**********                            137 1420CNUM                                      CSD027
     I                                      137 142 CNUM                                      CSD027
     I                                      143 145 BRCACL
     I                                      146 147 LTYP
     I                                      148 149 SUTP
     I                                    P 150 1520DDAT
     I                                    P 153 1550VDAT
     I                                    P 156 1580MDAT
     I                                      159 1600LASQ
     I**********                            161 1660FCUS                                      CSD027
     I                                      161 166 FCUS                                      CSD027
     I                                      167 1690FTYP
     I                                      170 1710FSEQ
     I                                      172 174 CCY
     I                                    P 175 1810CPAM
     I                                      182 182 INTC
     I                                    P 183 1887INTR
     I**********                            189 1900BRTT                                      CSD103
     I                                      189 190 BRTT                                      CSD103
     I                                    P 191 1967BRTE
     I                                    P 197 2027RTSP
     I                                    P 203 2065MARG
     I                                      207 207 SPIN
     I                                      208 208 CHIN
     I                                    P 209 2147WTRT
     I                                      215 215 WTIN
     I                                      216 2160REPT
     I                                    P 217 2230RAMT
     I                                    P 224 2260NRPD
     I                                      227 227 RFRQ
     I                                      228 2290RDYN
     I                                      230 232 FCCYCL
     I                                      233 2350LIND
     I                                      236 237 CRSK
     I                                      238 239 ACOF
     I                                      240 240 NACD
     I                                      241 241 RELI
     I                                      242 242 AUTO
     I                                    P 243 2490PSAM
     I                                    P 250 2568BCXR
     I                                    P 257 2638FCXR
     I                                      264 2650SDST
     I**********                            266 277 OSDA                                      CGL029
     I                                      266 277 OSDAQQ                                    CGL029
     I                                      278 287 TSTN
     I                                      288 2890MDST
     I**********                            290 301 OMDA                                      CGL029
     I                                      290 301 OMDAQQ                                    CGL029
     I                                      302 311 TMAN
     I                                      312 321 FACO
     I                                    P 322 3240RLDT
     I                                    P 325 3270NROD
     I                                      328 328 RLFQ
     I                                      329 3300RLDY
     I                                      331 331 RDFC
     I**********                            332 3330NBRA                                      CSD103
     I                                      332 333 NBRA                                      CSD103
     I                                    P 334 3397NRTS
     I                                      340 340 NSIN
     I                                      341 3410NCAS
     I                                    P 342 3480AWTP
     I                                    P 349 3550WTRD
     I                                    P 356 3620WTWD
     I                                    P 363 3690IWOD
     I                                    P 370 3760PWOD
     I                                      377 377 BMDI
     I                                      378 378 FMDI
     I                                    P 379 3850PDIN
     I                                    P 386 3870LSWC
     I                                    P 388 3890LSWS
     I                                      390 392 OSDB
     I                                      393 395 OMDB
     I                                      396 398 ORBR
     I                                      399 402 PRFC
     I                                      403 405 FCLB
     I**********                            406 4110MLNR                                      CLE148
     I                                      406 411 MLNR                                      CLE148
     I                                      412 412 BTIN
     I                                      413 4140BLDY
     I**********                            415 4200OLNO                                      CSD027
     I                                      415 420 OLNO                                      CSD027
     I                                      421 421 RCSI
     I                                      422 4220ICBS
     I                                      423 423 IPFR
     I                                    P 424 4300TOTI
     I                                    P 431 4330NIDT
     I                                    P 434 4360IBDT
     I                                    P 437 4390SLID
     I                                    P 440 4460AIPD
     I                                    P 447 4490DLRC
     I                                    P 450 4520IACD
     I                                    P 453 4590AITC
     I                                    P 460 4660TFEP
     I                                    P 467 4730AIAP
     I                                    P 474 4800IPRD
     I                                    P 481 4870IPRM
     I                                    P 488 4940ICTD
     I                                    P 495 5010AIMN
     I                                    P 502 5040RBDT
     I                                    P 505 5060NOPS
     I                                      507 507 NCHI
     I                                      508 508 FLR1
     I                                      509 5100IFDY
     I                                      511 511 LONI
     I                                      512 512 CNFI
     I                                      513 513 ACEI
     I                                      514 514 TLXI
     I                                      515 515 CBLI
     I                                    P 516 5180ORED
     I                                    P 519 5210LCD
     I                                      522 522 CHTP
     I                                    P 523 5250TNLU
     I                                      526 526 ADDI
     I                                    P 527 5290ORMD
     I                                    P 530 5360ORTI
     I                                      537 559 FLR2
     I                                      560 561 BOKC
     I**********                            562 5670COCU                                      CSD027
     I**********                            568 5730RECE                                      CSD027
     I                                      562 567 COCU                                      CSD027
     I                                      568 573 RECE                                      CSD027
     I                                    P 574 5760OMDT
     I                                    P 577 5790NIPD
     I                                    P 580 5820NMDT
     I                                      583 583 APMI
     I                                      584 5850RSTM
     I**********                            586 597 RONS                                      CGL029
     I                                      586 597 RONSQQ                                    CGL029
     I                                      598 605 RIBN
     I                                      606 640 RIBA
     I**********                            641 6460ROBN                                      CSD027
     I**********                            647 6520ROCN                                      CSD027
     I                                      641 646 ROBN                                      CSD027
     I                                      647 652 ROCN                                      CSD027
     I                                      653 6540PSTM
     I**********                            655 666 PONS                                      CGL029
     I                                      655 666 PONSQQ                                    CGL029
     I                                      667 674 PIBN
     I                                      675 709 PIBA
     I**********                            710 7150POBN                                      CSD027
     I**********                            716 7210POCN                                      CSD027
     I                                      710 715 POBN                                      CSD027
     I                                      716 721 POCN                                      CSD027
     I                                      722 729 RCRN
     I                                     12181220 SCCY                  CEU003
     I                                     15151532 OSDA                                      CGL029
     I                                     15331550 OMDA                                      CGL029
     I                                     15511568 RONS                                      CGL029
     I                                     15691586 PONS                                      CGL029
     I                                     17801782 LOIC                                      CER020
      *
      **    LOAMSDK - CUSTOMER LENDING LOAN AMENDMENTS
      *
     I***********LOAMDK      DS                            625            CEU003
     I***LOAMDK*     DS                           1080                                 CEU003 CGL029
     ILOAMDK      DS                           1254                                           CGL029
     I                                      126 126 RECIDK
     I**********                            127 1320LNRFDK                                    CLE148
     I                                      127 132 LNRFDK                                    CLE148
     I                                      133 1370VDATDK
     I                                      138 1400LASNDK
     I                                      141 1410MRINDK
     I                                      142 143 LTYPDK
     I                                      144 145 SUTPDK
     I                                      146 1470PTYPDK
     I                                      148 149 AMTPDK
     I                                      150 151 PRSQDK
     I**********                            152 1530BRTTDK                                    CSD103
     I                                      152 153 BRTTDK                                    CSD103
     I                                    P 154 1597RTSPDK
     I                                      160 162 CCYDK
     I                                    P 163 1690PRAMDK
     I                                    P 170 1760INTADK
     I                                    P 177 1830WTXADK
     I                                    P 184 1900FEAMDK
     I                                    P 191 1970TAMTDK
     I                                      198 200 BRCADK
     I**********                            201 2060CNUMDK                                    CSD027
     I                                      201 206 CNUMDK                                    CSD027
     I                                      207 2070REPTDK
     I                                      208 208 AUTODK
     I                                      209 209 STAIDK
     I                                      210 2110SETPDK
     I**********                            212 223 OSACDK                                    CGL029
     I                                      212 223 OSACQQ                                    CGL029
     I                                      224 233 TSENDK
     I                                      234 243 FACODK
     I                                      244 273 SPI1DK
     I                                      274 303 SPI2DK
     I                                      304 333 SPI3DK
     I                                      334 334 LAINDK
     I                                    P 335 3407BRTEDK
     I                                      341 341 SPINDK
     I                                      342 3420CALCDK
     I                                      343 343 WTINDK
     I                                      344 344 LLAGDK
     I                                      345 345 LWOIDK
     I                                      346 3500XAVDDK
     I                                      351 3530XASQDK
     I**********                            354 3590FCUSDK                                  BUG11679
     I                                      354 359 FCUSDK                                  BUG11679
     I                                      360 3620FTYPDK
     I                                      363 3640FSEQDK
     I**********                            365 3700RLONDK                                    CSD027
     I                                      365 370 RLONDK                                    CSD027
     I                                      371 3720FECDDK
     I                                      373 373 PONIDK
     I                                      374 374 ACTIDK
     I                                      375 375 CNFYDK
     I                                      376 376 TLXYDK
     I                                      377 377 CBLYDK
     I                                      378 378 INTCDK
     I                                      379 379 NACDDK
     I                                      380 380 ACBIDK
     I                                      381 381 FLR1DK
     I                                    P 382 3830LSWCCD
     I                                    P 384 3850LSWSCD
     I                                      386 388 OSBRDK
     I                                      389 391 FCLBDK
     I                                    P 392 3940LSMDDK
     I                                    P 395 4010REBTDK
     I                                      402 435 FLR2DK
     I                                    P 436 4380OREDDK
     I                                    P 439 4410LCDDK
     I                                      442 442 CHTPDK
     I                                    P 443 4450TNLUDK
     I                                      446 4470RSTMDK
     I**********                            448 459 RONSDK                                    CGL029
     I                                      448 459 ROQQDK                                    CGL029
     I                                      460 467 RIBNDK
     I                                      468 502 RIBADK
     I**********                            503 5080ROBNDK                                    CSD027
     I**********                            509 5140ROCNDK                                    CSD027
     I                                      503 508 ROBNDK                                    CSD027
     I                                      509 514 ROCNDK                                    CSD027
     I                                      515 5160PSTMDK
     I**********                            517 528 PONSDK                                    CGL029
     I                                      517 528 POQQDK                                    CGL029
     I                                      529 536 PIBNDK
     I                                      537 571 PIBADK
     I**********                            572 5770POBNDK                                    CSD027
     I**********                            578 5830POCNDK                                    CSD027
     I                                      572 577 POBNDK                                    CSD027
     I                                      578 583 POCNDK                                    CSD027
     I                                      584 591 RCRNDK
     I                                     10751077 STCYDK                CEU003
     I                                     12011218 OSACDK                                    CGL029
     I                                     12191236 RONSDK                                    CGL029
     I                                     12371254 PONSDK                                    CGL029
      *
      **      FCLTYFM  - CUSTOMER LENDING FACILITY
      *
     IFCLTDS      DS                            625
     I                                      126 126 RECIFC
     I**********                            127 1320CNUMFC                                    CSD027
     I                                      127 132 CNUMFC                                    CSD027
     I                                      133 1350FACTFC
     I                                      136 1370FCNOFC
     I                                      138 138 RCTPFC
     I                                      139 141 BRCAFC
     I                                      143 145 FCCY
     I                                    P 146 1520FAMT
     I                                    P 156 1580DTAP
     I                                    P 159 1610DTEX
     I                                      378 378 CHTPFC
      *
      **      LEFEED  - CUSTOMER LENDING FACILITY FEES
      *
     I***LEFEDS*     DS                            625                                        CGL029
     I********LEFEDS      DS                           1113                            CGL029 CLE134
     ILEFEDS      DS                           1342                                           CLE134
     I                                      126 126 FERECI
     I                                      127 129 FEBRCA
     I**********                            130 1350FECNUM                                    CSD027
     I                                      130 135 FECNUM                                    CSD027
     I                                      136 1400FEFACL
     I                                      139 1400FEFCNO
     I**********                            141 1460FELOAN                                    CLE148
     I                                      141 146 FELOAN                                    CLE148
     I                                      147 1480FEFSEQ
     I                                      149 1500FEFCOD
     I                                      151 152 FEACOF
     I                                      153 155 FEFCCY
     I                                    P 156 1620FEFAMT
     I                                    P 163 1650FEPSTD
     I                                    P 166 1680FEPEND
     I                                      169 169 FEPYON
     I                                      170 170 FEAUTO
     I                                      171 1720FESTTL
     I**********                            173 184 FEOURS                                    CGL029
     I                                      173 184 QQOURS                                    CGL029
     I                                      185 194 FETHER
     I                                      195 196 FECALT
     I                                    P 197 2165FRT
     I                                    P 197 2005FEFRT1
     I                                    P 201 2045FEFRT2
     I                                    P 205 2085FEFRT3
     I                                    P 209 2125FEFRT4
     I                                    P 213 2165FEFRT5
     I                                    P 217 2460FEEM
     I                                    P 217 2220FEAMT1
     I                                    P 223 2280FEAMT2
     I                                    P 229 2340FEAMT3
     I                                    P 235 2400FEAMT4
     I                                    P 241 2460FEAMT5
     I                                      247 247 FECALC
     I                                    P 248 2548FEERAT
     I                                      255 255 FEMDIN
     I                                    P 256 2580FENPYD
     I                                      259 259 FEFREQ
     I                                      260 2610FEDYIM
     I                                      262 262 FEPIND
     I                                      263 263 FEDIND
     I                                    P 264 2700FEAMTP
     I                                    P 271 2770FEAMTA
     I                                    P 278 2840FEAMTS
     I                                    P 285 2870FESDAT
     I                                    P 288 2900FELPDT
     I                                    P 291 2930FELADT
     I                                    P 294 3000FEADAT
     I                                    P 301 3030FEDDAT
     I                                    P 304 3100FEAMTO
     I                                      311 312 FELTYP
     I                                      313 314 FESUTP
     I                                    P 315 3170FEORED
     I                                    P 318 3200FEPLPD
     I                                      321 321 FESPTI
     I                                      322 322 FEPPTI
     I                                      323 323 FEEPTI
     I                                      324 324 FESBTI
     I                                      325 325 FEPBTI
     I                                      326 326 FEEBTI
     I                                      327 327 FELCHT
     I                                    P 328 3300FELCHD
     I                                    P 331 3330FETNLU
     I                                      334 336 FEOSBR
     I                                    P 337 3430FELPAM
     I                                     10961113 FEOURS                                    CGL029
     I                                     13421342 FEAUT2                                    CLE134
      *
      **      RSACMTPD - ACCOUNT MOVEMENTS
      *
     IRSACDS      DS                            625
     I**********                            126 1310CUSN                                      CSD027
     I                                      126 131 CUSN                                      CSD027
     I                                      132 134 CCYD
     I**********                            135 1380ACDE                                      CGL029
     I                                      135 1380ACDEQQ                                    CGL029
     I                                      139 1400ASNC
     I                                      141 143 BRCARS
     I                                      126 143 WACCT                 095763
     I                                    P 144 1460PTDT
     I                                    P 147 1490VUDT
     I                                      150 151 TRYP
     I                                      152 153 NRTC
     I                                      154 183 NRTD
     I                                      184 189 TNMR
     I                                      190 1970CQNR
     I                                    P 198 2040MVAM
     I                                      205 2050DORC
     I                                      206 220 FUND
     I                                      221 2230TBID
     I                                      224 224 APBI
     I                                      225 226 PASS
     I**********                            227 2360ACDE                             CGL029 MD051643
     I                                      240 2490ACDE                                    MD051643
     I                                      271 291 OTR1                                      CAP204
     I                                      292 293 CMOD                                      CAP205
     I                                      294 297 ETYP                                      CAP205
     I                                      298 298 MTYP                                      CAP205
      *
      ** Data Structure for Message Data to be sent to the dataqueue
      *
     I            DS
     I                                        1  32 PMSGD
     I                                        1   2 WMODTP
     I                                        3   5 WBRCA
     I                                        6   8 WCCY
     I                                        9  130WVDAT
     I                                       14  150WNOST
     I                                       16  300WAMT
     I                                       31  31 WSTRF
     I                                       32  32 WXMIT
     I              'LECalcBasis6LeapYear'C         WPARML                                  MD035545
     I/COPY ZSRSRC,ZHOLI
     I/COPY ZSRSRC,ZINTDYZ1
     I/COPY ZSRSRC,ZDATE9Z2
     I/COPY ZSRSRC,ZDAT10Z1                                               126017
     I/COPY ZSRSRC,ZHOLDS
     I/COPY ZSRSRC,ZAOZ2
     I*
     ISDBANK    E DSSDBANKPD
      ** Bank Details
      *
     ISDMMOD    E DSSDMMODPD
      ** Module Setting Details
      *
     ISDCLND    E DSSDCLNDPD
      ** Customer Lending ICD Details
      *
     ISDDEAL    E DSSDDEALPD
     I              QQACCD                          QQACC1                                    CGL029
      ** Deal Details
      *
     ISDBSRT    E DSSDBSRTPD
      ** Base Rate Details
      *
     ISDCURR    E DSSDCURRPD
      ** Currency Details
      *
     ISDNOST    E DSSDNOSTPD
     I              QQACCD                          QQACC2                                    CGL029
      ** Nostro Details
      *
     ISDACCT    E DSACCNTAB
     I              RECI                            SDRECI
     I              CNUM                            SDCNUM
     I              CCY                             SDCCY
     I              ACOD                            SDACOD
     I              ACSQ                            SDACSQ
     I              PRFC                            SDPRFC
     I              ORED                            SDORED
     I              LCD                             SDLCD
     I              CHTP                            SDCHTP
     I              TNLU                            SDTNLU
      ** Account Details
      *
     IDSFDY     E DSDSFDY
      ** Short Data Structure
      *
     C*****************************************************************
     C**                   MAIN CYCLE PROCESSING                      *
     C*****************************************************************
      *
      ** Set up copyright parameter
      *
     C                     MOVEACPY@      BIS@   80
      *
      ** Entry parameters from EXITPGM of RCVJRNE command
      *
     C           *ENTRY    PLIST
     C                     PARM           JRNENT
     C                     PARM           CALLCD  1
      *
      **  Initial Processing
      *
     C                     EXSR #LINIT
      *
     C           CALLCD    IFEQ '1'                        B1
      *
     C           JFILE     IFEQ 'CLOANCL'                  B2
     C           JFILE     OREQ 'LOAMSDK'
      *
      ** Perform process for Loan and Loan Amendment Changes
      *
     C                     EXSR #LLLAC
      *
     C           JFILE     IFEQ 'LOAMSDK'                  B3
      *
      ** Perform process for Loan Amendment Changes
      *
     C                     EXSR #LPLAC
     C                     END                             E3
     C                     END                             E2
      *
     C           JFILE     IFEQ 'FCLTYFM'                  B2
      *
      ** Perform process for Facility Changes
      *
     C                     EXSR #LPFCC
     C                     END                             E2
      *
     C           JFILE     IFEQ 'LEFEED'                   B2
      *
      ** Perform process for Facility Fee Changes
      *
     C                     EXSR #LPFFC
     C                     END                             E2
      *
     C           JFILE     IFEQ 'RSACMTPD'                 B2
      *
      ** Perform process for Account Movement
      *
     C                     EXSR #LPACM
     C                     END                             E2
      *
     C           JOENTT    IFEQ 'XJ'                       B2
      *
      ** Set on the external User switch U6 and the LR indicator
      *
     C                     MOVE '1'       *INU6
     C                     MOVE '1'       *INLR
     C                     MOVEL'9'       CALLCD
     C                     END                             E2
      *
     C           JOENTT    IFEQ 'XE'                       B2
      *
      ** Set on the LR indicator
      *
     C                     MOVE '1'       *INLR
     C                     MOVEL'9'       CALLCD
     C                     END                             E2
      *
      ** Read the Citydealer Extracted Journal Info file
      *
     C           1         SETLLDLCDJND0                 57
     C                     READ DLCDJND0                 57
      *
     C           *IN57     IFEQ '1'                        B2
     C           *LOCK     IN   LDA
     C                     Z-ADD008       DBASE            ***************
     C                     MOVEL'DLCDJNPD'DBFILE           *DB ERROR 008 *
     C                     MOVEL'*FIRST'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
      *
      ** Update the record on PF/DLCDJNPD
      *
     C                     MOVELJRNSQ     JOSEQN
     C                     UPDATDLCDJND0               42
      *
     C************IN42     IFEQ '1'                        B2             095340
     C           *IN42     IFEQ '0'                        B2             095340
     C                     COMIT
     C                     END                             E2
      *
     C                     END                             E1
      *
      ** Determine if program is going to shut down
      *
     C                     SHTDN                     97
     C           *IN97     IFEQ '1'                        B1
     C                     MOVE '1'       *INLR
     C                     MOVEL'9'       CALLCD
     C                     END                             E1
      *
     C                     RETRN
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LLLAC - Processing for Loan and Loan Amendment Changes      *
      *                                                               *
      *  Called by  : MAIN   - Main Processing Routine                *
      *               #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *                                                               *
      *  Calls      : #LCJIP - Check if Journal Image to be Processed *
      *               #LDMTT - Determine Mod/Type of the Transaction  *
      *               #LCSEM - Create Start Date Event Messages       *
      *               #LCAEM - Create Amendment Date Event Messages   *
      *               #LCIEM - Create Interest Date Event Messages    *
      *               #LCREM - Create Repayment Date Event Messages   *
      *               #LCOEM - Create Rollover Date Event Messages    *
      *               #LCMEM - Create Maturity Date Event Messages    *
      *               ZFWDT  - Find nth Working Day Forward from a    *
      *                        Given Date                             *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LLLAC    BEGSR
      *
     C           JFILE     IFEQ 'CLOANCL'                  B1
     C                     MOVELJRNENT    LOANCL
     C                     END                             E1
      *
     C           JFILE     IFEQ 'LOAMSDK'                  B1
     C                     MOVELJRNENT    LOAMDK
      *
     C                     Z-ADDVDATDK    ULVDAT  50
     C                     Z-ADDLASNDK    ULLASN  30
      *
     C           W2PASS    IFEQ 'Y'                        B2
     C**********           Z-ADDLNRFSV    LNRFDK                                              CLE148
     C                     MOVELLNRFSV    LNRFDK                                              CLE148
     C                     Z-ADDVDATSV    VDATDK
     C                     Z-ADDLASNSV    LASNDK
     C                     MOVELCHTPSV    CHTPDK                          095961
     C                     END                             E2
     C                     MOVEL'N'       W2PASS
      *
     C                     MOVE LNRFDK    LNRFK
     C                     MOVE 'A'       RCDTK
      *
     C           CLONKY    CHAINCLOAN                40
     C           *IN40     IFEQ '1'                        B2
     C           *LOCK     IN   LDA
     C                     Z-ADD004       DBASE            ***************
     C                     MOVEL'CLOAN   'DBFILE           *DB ERROR 004 *
     C                     MOVELLNRFDK    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
      *
     C                     END                             E1
      *
      ** Perform check to see whether Journal Image should be processed
      *
     C                     EXSR #LCJIP
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
     C           MDAT      IFEQ 0                          B2
      *
     C           BLDY      IFEQ 0                          B3
     C                     Z-ADD1         BLDY
     C                     END                             E3
      *
     C                     Z-ADDBJRDNB    ZDAYNO
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           SCCY      ANDNE*BLANKS                                   CEU003
     C                     MOVELSCCY      ZCCY                            CEU003
     C                     ELSE                                           CEU003
     C                     MOVELCCY       ZCCY
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
     C                     Z-ADDBLDY      ZNRDYS
     C                     EXSR ZFWDT
     C                     Z-ADDZDYNBR    ULMDAT  50
      *
     C           VDAT      IFGE ULMDAT                     B3
     C                     MOVEL'N'       WPRCSS
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
     C           MDAT      IFLT BJRDNB                     B3
     C                     MOVEL'N'       WPRCSS
     C                     END                             E3
     C                     END                             E2
      *
     C                     END                             E1
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
      ** Initialise work fields for this loan
      *
     C           AITC      ADD  AIAP      ULTOTI 130       Tot. Accr. Int.
     C           ULTOTI    ADD  AIMN      ULTOTI
     C                     Z-ADDCPAM      ULCPAM 130       Current Prin.
     C           IPRD      ADD  ICTD      ULIPRD 130
     C           ULIPRD    ADD  IWOD      ULIPRD           Int. Pd. Prior
     C                     Z-ADD0         ULINTP 130       Int. Pd. This Run
     C                     Z-ADDBRTE      ULBRTE 117       Base Rate
     C                     Z-ADDRTSP      ULRTSP 117       Rate/Spread
     C                     MOVELSPIN      ULSPIN  1        Spread Ind.
     C                     Z-ADDICBS      ULICBS  10       Calc. Basis
     C                     Z-ADDINTR      ULINTR 117       Interest Rate
     C                     Z-ADDIBDT      ULIBDT  50       Int. Base Date
     C                     Z-ADDRBDT      ULRBDT  50       Repay. Base Date
     C                     Z-ADDIACD      ULIACD  50       Last Event Date
      *
     C           LMSSET    SETLLLOAMS
     C                     READ LOAMS                    56
      *
     C           *IN56     IFEQ '0'                        B2
     C           LNRFLA    ANDEQLNRF
      *
     C                     MOVEL'Y'       WLOAMF  1
      *
     C           RECILA    IFEQ 'D'                        B3
     C           AMTP      IFEQ 'PD'                       B4
     C           BJRDNB    SUB  VDATDK    WDAYS   50
     C           WDAYS     IFGE 3                          B5
     C                     MOVEL'N'       WPRCSS
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
      *
     C                     ELSE                            X2
     C                     MOVEL'N'       WLOAMF
     C                     END                             E2
      *
     C                     END                             E1
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
      ** Determine the module/type of the transaction
      *
     C                     EXSR #LDMTT
      *
      ** Set Events Flag
      *
     C                     MOVEL'Y'       WAMDER  1
     C                     MOVEL'Y'       WINTER  1
     C                     MOVEL'Y'       WRPYER  1
     C                     MOVEL'Y'       WMATER  1
     C                     MOVEL'Y'       WINTCR  1
      *
      ** If Portfolio Management module is ON and PTFR not blanks
      *
     C           BGPFMG    IFEQ 'Y'                        B2
     C           PTFR      ANDNE*BLANKS
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C           PTFR      ANDNE*BLANKS                                   CPB001
     C                     MOVEL'Y'       WPORT   1
     C                     ELSE                            X2
     C                     MOVEL'N'       WPORT
     C                     END                             E2
      *
     C           RLDT      IFEQ 0                          B2
     C           BJRDNB    ADD  30        WCDAT2  50
     C                     ELSE                            X2
     C                     Z-ADDRLDT      WCDAT2
     C                     END                             E2
      *
     C           MDAT      IFEQ 0                          B2
     C                     Z-ADDULMDAT    WMATPD  50
     C                     ELSE                            X2
     C                     Z-ADDMDAT      WMATPD
     C                     END                             E2
      *
      ** If Events to End of Book Flag from Lending ICD is not 'Y'
      *
     C           BPGEEB    IFNE 'Y'                        B2
     C           WPORT     ANDNE'Y'
      *
     C           WCDAT1    IFGT WMATPD                     B3
     C                     Z-ADDWMATPD    WCDAT2
     C                     ELSE                            X3
     C                     MOVEL'N'       WMATER
     C                     END                             E3
     C                     END                             E2
      *
     C           WLOAMF    IFEQ 'N'                        B2
     C                     Z-ADD99999     WLAMPD  50
     C                     ELSE                            X2
     C                     Z-ADDVDATLA    WLAMPD
     C                     END                             E2
      *
     C           BPGEEB    IFNE 'Y'                        B2
     C           WPORT     ANDNE'Y'
      *
     C           WLAMPD    IFGT WCDAT2                     B3
     C                     MOVEL'N'       WAMDER
     C                     END                             E3
     C                     END                             E2
      *
     C           NIDT      IFEQ 0                          B2
     C                     Z-ADD99999     WLIPDT  50
     C                     ELSE                            X2
     C                     Z-ADDNIDT      WLIPDT
     C                     END                             E2
      *
     C           BPGEEB    IFNE 'Y'                        B2
     C           WPORT     ANDNE'Y'
      *
     C           WLIPDT    IFGT WCDAT2                     B3
     C                     MOVEL'N'       WINTER
     C                     END                             E3
     C                     END                             E2
      *
     C           RBDT      IFEQ 0                          B2
     C                     Z-ADD99999     WLRPDT  50
     C                     ELSE                            X2
     C                     Z-ADDRBDT      WLRPDT
     C                     END                             E2
      *
     C           BPGEEB    IFNE 'Y'                        B2
     C           WPORT     ANDNE'Y'
      *
     C           WLRPDT    IFGT WCDAT2                     B3
     C                     MOVEL'N'       WRPYER
     C                     END                             E3
     C                     END                             E2
      *
     C           RLDT      IFEQ 0                          B2
     C                     Z-ADD99999     WLRLPD  50
     C                     ELSE                            X2
     C                     Z-ADDRLDT      WLRLPD
     C                     END                             E2
      *
     C           MDAT      IFNE 0                          B2
     C           PTYP      ANDEQ63
     C           NROD      ANDNE0
     C                     Z-ADDNROD      WMATPD
     C                     MOVEL'N'       WINTCR  1
     C                     END                             E2
      *
     C                     TESTB'1'       ACEI           58
      *
      ** If Loans has not started, create start date event messages
      *
     C           *IN58     IFEQ '0'                        B2
     C                     EXSR #LCSEM
     C                     END                             E2
      *
     C                     MOVEL'Y'       WAMDES  1
     C                     MOVEL'Y'       WINTES  1
     C                     MOVEL'Y'       WRPYES  1
     C                     MOVEL'Y'       WROLES  1
      *
     C           WROLES    DOWEQ'Y'                        B2
     C           WRPYES    DOWEQ'Y'                        B3
     C           WINTES    DOWEQ'Y'                        B4
     C           WAMDES    DOWEQ'Y'                        B5
      *
     C           WAMDER    IFEQ 'Y'                        B6
     C           WLAMPD    ANDLEWLIPDT
     C           WLAMPD    ANDLEWLRPDT
     C           WLAMPD    ANDLEWLRLPD
      *
     C           WPORT     IFEQ 'Y'                        B7
     C           WLAMPD    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDEQ'Y'
     C           WLAMPD    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDNE'Y'
     C           WLAMPD    ANDLEWCDAT2
      *
      ** Create Amendment Date Event Messages
      *
     C                     EXSR #LCAEM
      *
     C                     ELSE                            X7
     C                     MOVEL'N'       WAMDES
     C                     END                             E7
      *
     C                     ELSE                            X6
     C                     MOVEL'N'       WAMDES
     C                     END                             E6
     C                     END                             E5
      *
     C           WINTER    IFEQ 'Y'                        B5
     C           WLIPDT    ANDLEWLRPDT
     C           WLIPDT    ANDLEWLRLPD
      *
     C           WPORT     IFEQ 'Y'                        B6
     C           WLIPDT    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDEQ'Y'
     C           WLIPDT    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDNE'Y'
     C           WLIPDT    ANDLEWCDAT2
      *
      ** Create Interest Date Event Messages
      *
     C                     EXSR #LCIEM
     C                     ELSE                            X6
     C                     MOVEL'N'       WINTES
     C                     END                             E6
      *
     C                     ELSE                            X5
     C                     MOVEL'N'       WINTES
     C                     END                             E5
     C                     END                             E4
      *
     C           WRPYER    IFEQ 'Y'                        B4
     C           WLRPDT    ANDLEWLRLPD
      *
     C           WPORT     IFEQ 'Y'                        B5
     C           WLRPDT    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDEQ'Y'
     C           WLRPDT    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDNE'Y'
     C           WLRPDT    ANDLEWCDAT2
      *
      ** Create Repayment Date Event Messages
      *
     C                     MOVEL'N'       WLOAM   1                       095959
     C                     EXSR #LCREM
      *
     C                     ELSE                            X5
     C                     MOVEL'N'       WRPYES
     C                     END                             E5
      *
     C                     ELSE                            X4
     C                     MOVEL'N'       WRPYES
     C                     END                             E4
     C                     END                             E3
      *
     C           WPORT     IFEQ 'Y'                        B3
     C           WLRLPD    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDEQ'Y'
     C           WLRLPD    ANDLEWMATPD
     C           WPORT     ORNE 'Y'
     C           BPGEEB    ANDNE'Y'
     C           WLRLPD    ANDLEWCDAT2
      *
      ** Create Rollover Date Event Messages
      *
     C                     EXSR #LCOEM
      *
     C                     ELSE                            X3
     C                     MOVEL'N'       WROLES
     C                     END                             E3
     C                     END                             E2
      *
     C           WMATER    IFEQ 'Y'                        B2
      *
      ** Create Maturity Date Event Messages
      *
     C                     EXSR #LCMEM
     C                     END                             E2
      *
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LPLAC - Processing for Loan Amendment Changes               *
      *                                                               *
      *  Called by  : MAIN   - Main Processing Routine                *
      *                                                               *
      *  Calls      : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *                                                               *
     C*****************************************************************
     C           #LPLAC    BEGSR
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
     C           JOENTT    IFEQ 'PT'                       B2
     C           JOENTT    OREQ 'DR'
      *
      ** Set parm-Journal-Entry "LOAMSDK" fields to a Null record except
      ** for Loan Amendment Loan Reference Number, Loan Amendment Value
      ** date and Loan Amendment Sequence Number
      *
     C**********           Z-ADDLNRFDK    LNRFSV  60                                          CLE148
     C                     MOVELLNRFDK    LNRFSV  6                                           CLE148
     C                     Z-ADDVDATDK    VDATSV  50
     C                     Z-ADDLASNDK    LASNSV  30
     C                     MOVELCHTPDK    CHTPSV  1                       095961
     C                     Z-ADDJRNSQ     JRNSSV 100
     C                     MOVELJOENTT    JOENSV  2
     C                     MOVELJOPGM     JOPGSV 10
     C                     MOVELJFILE     JFILSV 10
     C                     MOVEL*BLANKS   JRNENT
     C                     Z-ADDJRNSSV    JRNSQ
     C                     MOVELJOENSV    JOENTT
     C                     MOVELJOPGSV    JOPGM
     C                     MOVELJFILSV    JFILE
     C                     MOVEL'Y'       W2PASS  1
      *
     C           JOENTT    IFEQ 'PT'                       B3
     C                     MOVEL'DR'      JOENTT
     C                     ELSE                            X3
     C                     MOVEL'PT'      JOENTT
     C                     END                             E3
      *
      ** Perform process for Loan and Loan Amendment Changes
      *
     C                     EXSR #LLLAC
      *
     C                     END                             E2
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LPFCC - Processing for Facility Changes                     *
      *                                                               *
      *  Called by  : MAIN   - Main Processing Routine                *
      *                                                               *
      *  Calls      : #LCJIP - Check if Journal Image to be Processed *
      *               #LDMTT - Determine Module/Type of Transaction   *
      *               #LDFDD - Determine Facility Due Date            *
      *               #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *               GLINTC - Calculate Interest Between two dates   *
      *               ZFREQB - Calculate Next Payment/Statement Date  *
      *               ZFWDT  - Find nth Working Day Forward from a Gi-*
      *                        ven date                               *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LPFCC    BEGSR
      *
      ** Move the parm-Journal-Entry into a data structure defining all the
      ** individual PF/FCLTYFM fields
      *
     C                     MOVELJRNENT    FCLTDS
      *
      ** Perform check to see whether Journal Image should be processed
      *
     C                     EXSR #LCJIP
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
     C                     MOVE 'B'       RCTP
     C                     MOVELFACTFC    WFCLTK  5
     C                     MOVE FCNOFC    WFCLTK
      *
     C           FCLTYK    CHAINFCLTY                41
     C           *IN41     IFEQ '1'                        B2
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD014       DBASE            ***************
     C                     MOVEL'FCLTY   'DBFILE           *DB ERROR 014 *
     C                     MOVELCNUMFC    DBKEY            ***************
     C                     MOVE WFCLTK    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
      *
      ** Check if the Facility Fee Bearing End Date has not been
      ** reached
      *
     C                     TESTB'4'       BITS           61
      *
     C           RECIFC    IFNE 'E'                        B2
     C           RECIFC    ANDNE'C'
     C           CMFT      ANDNE*BLANKS
     C           *IN61     ANDEQ'0'
      *
      ** Calculate the 15th working day forward from the system rundate
      ** for the currency of the facility
      *
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     MOVELFCCY      ZCCY
     C                     Z-ADD15        ZNRDYS
     C                     EXSR ZFWDT
     C                     Z-ADDZDYNBR    WEXDAT  50
     C           BJRDNB    ADD  BLDN      WBLDAT  50
      *
     C           WBLDAT    IFGT WEXDAT                     B3
     C                     Z-ADDWBLDAT    WEXDAT
     C                     END                             E3
      *
     C           BRAT      ADD  SPRD      WINTR  117
      *
      ** Determine Facility Due Date
      *
     C                     EXSR #LDFDD
     C                     ELSE                            X2
      *
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
     C                     END                             E1
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
      ** Determine the module/type of the transaction
      *
     C                     EXSR #LDMTT
      *
     C                     MOVELBRCAFC    WBRCA
     C                     MOVELFCCY      WCCY
     C                     MOVEL'CF'      WSSETT
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
     C                     END                             E1
      *
     C           WPRCSS    DOWEQ'Y'                        B1
      *
     C                     Z-ADDACCD      ZIBEG
     C                     Z-ADDWVDAT     ZIEND
      *
     C           CMFT      IFEQ 'U'                        B2
     C           FAMT      SUB  TOTD      ZIAMT
     C                     ELSE                            X2
     C                     Z-ADDFAMT      ZIAMT
     C                     END                             E2
     C                     Z-ADDCALC      ZICALC
     C                     Z-ADDWINTR     ZIRATE
      *
     C           ZIAMT     IFNE 0                          B2
     C                     EXSR GLINTC
     C                     Z-ADDZINTR     WFAMT
     C                     ELSE                            X2
     C                     Z-ADD0         WFAMT
     C                     END                             E2
      *
      ** Add W-Fee-Amount to the Total Fees Accrued to Date and Not
      ** Posted
      *
     C           ADNP      ADD  WFAMT     ADNP
      *
      ** Set W-Fee-Amount to the Total Fees Accrued to Date and Not
      ** Posted plus Adjustments posted plus Adjustments Not Posted
      ** less Fees Paid to Date
      *
     C           ADNP      ADD  ADJP      WFAMT  130H
     C           WFAMT     ADD  ADJN      WFAMT
     C           WFAMT     SUB  PDTD      WFAMT
      *
      ** Add W-Fee-Amount to the Fees Paid to Date
      *
     C                     ADD  WFAMT     PDTD
     C                     Z-ADD0         WAMT
      *
     C           WINSRT    IFEQ 'Y'                        B2
     C                     ADD  WFAMT     WAMT
     C                     ELSE                            X2
     C                     SUB  WFAMT     WAMT
     C                     END                             E2
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
      ** Set Facility Accrual Control Date equal W-Value-Date
      *
     C                     Z-ADDWVDAT     ACCD
      *
     C           WVDAT     IFNE EDDT                       B2
      *
     C           BLFR      IFEQ *BLANKS                    B3
     C                     Z-ADD0         DUDT
      *
      ** Determine Facility Due Date
      *
     C                     EXSR #LDFDD
     C                     ELSE                            X3
      *
     C                     MOVE BLFR      ZFREQ
     C                     Z-ADDWVDAT     ZDAYNO
     C                     Z-ADDBLDN      ZMDAY
     C                     MOVE FCCY      ZCCY
      *
      ** Calculate Next Facility Due Date
      *
     C                     EXSR ZFREQB
      *
     C           *IN99     IFEQ '1'                        B4
     C           *LOCK     IN   LDA
     C                     Z-ADD009       DBASE            ***************
     C                     MOVEL'ZFREQB  'DBFILE           *DB ERROR 009 *
     C                     MOVEL'*ERROR'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E4
      *
     C                     Z-ADD*ZERO     ZNRDYS
      *
      ** Calculate the first working day forward
      *
     C                     EXSR ZFWDT
     C                     Z-ADDZDYNBR    DUDT
      *
     C           DUDT      IFGE EDDT                       B4
     C                     Z-ADD0         DUDT
     C                     END                             E4
      *
      ** Determine Facility Due Date
      *
     C                     EXSR #LDFDD
     C                     END                             E3
      *
     C                     ELSE                            X2
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
      *
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LPFFC - Processing for Facility Fee Changes                 *
      *                                                               *
      *  Called by  : MAIN   - Main Processing Routine                *
      *                                                               *
      *  Calls      : #LCJIP - Check if Journal Image to be Processed *
      *               #LDCFS - Determine Calculated Fees              *
      *               #LDNFC - Determine Non-Calculated Fees          *
      *               #LDMTT - Determine Module/Type of Transaction   *
      *               #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *               ZFWDT  - Find nth Working Day Forward from a Gi-*
      *                        ven date                               *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LPFFC    BEGSR
      *
      ** Move the parm-Journal-Entry into a data structure defining all the
      ** individual PF/LEFEED fields
      *
     C                     MOVELJRNENT    LEFEDS
      *
      ** Perform check to see whether Journal Image should be processed
      *
     C                     EXSR #LCJIP
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
      ** Facility Fee Facility Number not equal zero
      *
     C           FEFCNO    IFNE 0                          B2
      *
     C                     MOVELFECNUM    CNUMFC
     C                     MOVELFEFACL    FACTFC
     C                     MOVE FEFACL    FCNOFC
     C                     MOVE 'A'       RCTP
      *
     C           FCLTYK    CHAINFCLTY                41
     C           *IN41     IFEQ '1'                        B3
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD015       DBASE            ***************
     C                     MOVEL'FCLTY   'DBFILE           *DB ERROR 015 *
     C                     MOVELFECNUM    DBKEY            ***************
     C                     MOVE FEFACL    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
      *
     C                     MOVELFECNUM    CNUMFC
     C                     MOVELFEFACL    FACTFC
     C                     MOVE FEFACL    FCNOFC
     C                     MOVE 'B'       RCTP
      *
     C           FCLTYK    CHAINFCLTY                41
     C           *IN41     IFEQ '1'                        B3
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD016       DBASE            ***************
     C                     MOVEL'FCLTY   'DBFILE           *DB ERROR 016 *
     C                     MOVELFECNUM    DBKEY            ***************
     C                     MOVE FEFACL    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
      *
      ** If facility has not expired and is not closed
      *
     C           FERECI    IFNE 'E'                        B3
     C           FERECI    ANDNE'C'
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     MOVELFCCY      ZCCY
     C                     Z-ADD15        ZNRDYS
     C                     EXSR ZFWDT
      *
      ** Set Extract Date and Billing Date
      *
     C                     Z-ADDZDYNBR    WEXDAT
     C           BJRDNB    ADD  BLDN      WBLDAT
      *
     C           WBLDAT    IFGT WEXDAT                     B4
     C                     Z-ADDWBLDAT    WEXDAT
     C                     END                             E4
      *
     C           FELPDT    IFGT BJRDNB                     B4
     C                     Z-ADDFELPDT    WVDAT
     C                     ELSE                            X4
     C                     Z-ADDFENPYD    WVDAT
     C                     END                             E4
      *
     C           FEPYON    IFEQ 'E'                        B4
     C                     Z-ADDFEPEND    WVDAT
     C                     END                             E4
      *
     C                     ELSE                            X3
      *
     C                     MOVEL'N'       WPRCSS
     C                     END                             E3
      *
     C           WPRCSS    IFEQ 'Y'                        B3
      *
     C********** FELOAN    IFEQ 0                          B4                                 CLE148
     C           FELOAN    IFEQ *BLANK                                                        CLE148
     C           FECALT    ANDEQ*BLANKS
      *
      ** Determine Non-Calculated Fees
      *
     C                     EXSR #LDNCF
     C                     END                             E4
      *
     C********** FELOAN    IFEQ 0                          B4                                 CLE148
     C           FELOAN    IFEQ *BLANK                                                        CLE148
     C           FECALT    ANDNE*BLANKS
      *
     C           WVDAT     IFGE BJRDNB                     B5
     C           WVDAT     ANDLEWEXDAT
      *
      ** Determine Calculated Fees
      *
     C                     EXSR #LDCFS
      *
     C                     ELSE                            X5
     C                     MOVEL'N'       WPRCSS
     C                     END                             E5
      *
     C                     END                             E4
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
      ** Determine Non-Calculated Fees
      *
     C                     EXSR #LDNCF
      *
     C                     END                             E2
     C                     END                             E1
      *
     C           WPRCSS    IFEQ 'Y'                        B1
     C           FEAUTO    ANDEQ'Y'
      *                                                                                       CLE134
      * Past Due Call Loan                                                                    CLE134
     C           WPRCSS    OREQ 'Y'                        B1                                 CLE134
     C           FEAUTO    ANDEQ'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           WPRCSS    OREQ 'Y'                        B1                                 CLE134
     C           FEAUT2    ANDEQ'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *
      ** Determine the module/type of the transaction
      *
     C                     EXSR #LDMTT
      *
     C                     MOVELFEBRCA    WBRCA
     C                     MOVELFEFCCY    WCCY
     C                     MOVEL'FE'      WSSETT
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
     C                     Z-ADD0         WAMT
      *
     C           WINSRT    IFEQ 'Y'                        B2
     C                     ADD  WFAMT     WAMT
     C                     ELSE                            X2
     C                     SUB  WFAMT     WAMT
     C                     END                             E2
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LPACM - Processing for Account Movement Changes             *
      *                                                               *
      *  Called by  : MAIN   - Main Processing Routine                *
      *                                                               *
      *  Calls      : #LCJIP - Check if Journal Image to be Processed *
      *               #LDMTT - Determine Module/Type of Transaction   *
      *               #LDTNA - Determine if Transaction is across     *
      *                        Nostro Account                         *
      *               #LDTRA - Determine if Transaction is across     *   095763
      *                        Retail Account                         *   095763
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *                                                               *
     C*****************************************************************
     C           #LPACM    BEGSR
      *
      ** Move the parm-Journal-Entry into a data structure defining all the
      ** individual PF/RSACMTPD fields
      *
     C                     MOVELJRNENT    RSACDS
      *
      ** Perform check to see whether Journal Image should be processed
      *
     C                     EXSR #LCJIP
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
     C                     MOVELJOPGM     WFUNC
      *
     C           WFUNC     IFEQ 'FX'                       B2
     C           WFUNC     OREQ 'MM'
     C           WFUNC     OREQ 'FF'
     C           WFUNC     OREQ 'SE'
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
     C                     END                             E1
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
     C           WFUNC     IFEQ 'DL'                       B2
     C           JOPGM     ANDNE'DL0035'
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
      *
     C           WFUNC     IFEQ 'LE'                       B2
     C           JOPGM     ANDNE'LER120'
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
      *
     C           WFUNC     IFEQ 'AO'                       B2
     C           JOPGM     OREQ 'RE0671'                                  095638
     C           JOPGM     OREQ 'RE0672'                                  095638
      *
     C           FUND      IFEQ *BLANKS                    B3
      *
     C           TRYP      IFNE 'AA'                       B4
     C           TRYP      ANDNE'CE'
     C           TRYP      ANDNE'F2'
     C           TRYP      ANDNE'ME'
     C           TRYP      ANDNE'NX'
     C           TRYP      ANDNE'SO'
     C                     MOVEL'N'       WPRCSS
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
      *
     C                     END                             E1
      *
     C           WPRCSS    IFEQ 'Y'                        B1
      *
      ** Determine the module/type of the transaction
      *
     C                     EXSR #LDMTT
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *                                                                   095763
      ** If not Nostro, determine if transaction is across                095763
      ** a Retail account.                                                095763
      *                                                                   095763
     C           WNOST     IFEQ 0                          B2             095763
     C                     EXSR #LDTRA                                    095763
     C                     END                             E2             095763
      *                                                                   095763
     C           WPRCSS    IFEQ 'Y'                        B2             095763
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
     C                     MOVELBRCARS    WBRCA
     C                     MOVELCCYD      WCCY
     C                     Z-ADDVUDT      WVDAT
     C                     Z-ADD0         WAMT
      *
     C           WINSRT    IFEQ 'Y'                        B2             095961
     C           DORC      IFEQ 0                          B3
     C                     ADD  MVAM      WAMT
     C                     ELSE                            X3
     C                     SUB  MVAM      WAMT
     C                     END                             E3
     C                     ELSE                            X2             095961
     C           DORC      IFEQ 0                          B3             095961
     C                     SUB  MVAM      WAMT                            095961
     C                     ELSE                            X3             095961
     C                     ADD  MVAM      WAMT                            095961
     C                     END                             E3             095961
     C                     END                             E2             095961
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     END                             E2             095763
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCSEM - Create Start Date Event Messages                    *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *                                                               *
      *  Calls      : #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *                                                               *
     C*****************************************************************
     C           #LCSEM    BEGSR
      *
     C           PTYP      IFNE 70                         B1
      *
     C                     MOVELBRCACL    WBRCA
     C                     MOVELCCY       WCCY
     C                     MOVELVDAT      WVDAT
     C                     Z-ADD0         WAMT
      *
     C           PTYP      IFEQ 66                         B2
     C           PTYP      OREQ 67
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     ADD  ULCPAM    WAMT
     C                     ELSE                            X3
     C                     SUB  ULCPAM    WAMT
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     SUB  ULCPAM    WAMT
     C                     ELSE                            X3
     C                     ADD  ULCPAM    WAMT
     C                     END                             E3
     C                     END                             E2
      *
     C                     MOVEL'SL'      WSSETT  2
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     Z-ADD0         WAMT
      *
     C           PTYP      IFEQ 63                         B2
     C           PTYP      OREQ 65
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     ADD  TOTI      WAMT
     C                     ELSE                            X3
     C                     SUB  TOTI      WAMT
     C                     END                             E3
     C                     END                             E2
      *
     C           PTYP      IFEQ 67                         B2
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     SUB  TOTI      WAMT
     C                     ELSE                            X3
     C                     ADD  TOTI      WAMT
     C                     END                             E3
     C                     END                             E2
      *
     C           PTYP      IFEQ 63                         B2
     C           PTYP      OREQ 65
     C           PTYP      OREQ 67
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
     C                     END                             E2
      *
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCAEM - Create Amendment Date Event Messages                *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *                                                               *
      *  Calls      : #LPINC - Perform Interest Calculation           *
      *               #LCNER - Calculate New Effective Interest Rate  *
      *               #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *               #LCREM - Create Repayment Date Event Messages   *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LCAEM    BEGSR
      *
     C           JFILE     IFEQ 'LOAMSDK'                  B1
      *
     C           ULVDAT    IFEQ VDATLA                     B2
     C           ULLASN    ANDEQLASN
      *
      ** Set all the individual Loan Amendment file fields (from LF/LOAMS)
      ** = individual PF/LOAMSDK data structure fields defined using parm-
      ** Journal-Entry
      ** Certain fields appended 'LA' to distinguish from S/CLOAN fields
      *
     C**********           Z-ADDLNRFDK    LNRFLA                                              CLE148
     C                     MOVELLNRFDK    LNRFLA                                              CLE148
     C                     Z-ADDVDATDK    VDATLA
     C                     Z-ADDLASNDK    LASN
     C                     Z-ADDMRINDK    MRINLA
     C                     MOVELLTYPDK    LTYPLA
     C                     MOVELSUTPDK    SUTPLA
     C                     Z-ADDPTYPDK    PTYPLA
     C                     MOVELAMTPDK    AMTP
     C                     MOVELPRSQDK    PRSQ
     C**********           Z-ADDBRTTDK    BRTTLA                                              CSD103
     C                     MOVE BRTTDK    BRTTLA                                              CSD103
     C                     Z-ADDRTSPDK    RTSPLA
     C                     MOVELCCYDK     CCYLA
     C                     Z-ADDPRAMDK    PRAM
     C                     Z-ADDINTADK    INTA
     C                     Z-ADDWTXADK    WTXA
     C                     Z-ADDFEAMDK    FEAM
     C                     Z-ADDTAMTDK    TAMT
     C                     MOVELBRCADK    BRCALA
     C**********           Z-ADDCNUMDK    CNUMLA                                              CSD027
     C                     MOVE CNUMDK    CNUMLA                                              CSD027
     C                     Z-ADDREPTDK    REPTLA
     C                     MOVELAUTODK    AUTOLA
     C                     MOVELSTAIDK    STAI
     C                     Z-ADDSETPDK    SETP
     C                     MOVELOSACDK    OSAC
     C                     MOVELTSENDK    TSEN
     C                     MOVELFACODK    FACOLA
     C                     Z-ADDBRTEDK    BRTE
     C                     MOVELSPINDK    SPIN
     C                     Z-ADDCALCDK    CALC
     C                     MOVELWTINDK    WTINLA
     C**********           Z-ADDRLONDK    RLON                                                CSD027
     C                     MOVELRLONDK    RLON                                                CSD027
     C                     Z-ADDFECDDK    FECD
     C                     MOVELPONIDK    PONI
     C                     MOVELACTIDK    ACTI
     C                     MOVELCNFYDK    CNFY
     C                     MOVELTLXYDK    TLXY
     C                     MOVELCBLYDK    CBLY
     C                     MOVELINTCDK    INTC
     C                     MOVELOSBRDK    OSBR
     C                     Z-ADDLSMDDK    LSMD
     C                     Z-ADDOREDDK    ORED
     C                     Z-ADDLCDDK     LCD
     C                     MOVELCHTPDK    CHTPLA
     C                     Z-ADDTNLUDK    TNLU
     C                     Z-ADDRSTMDK    RSTMLA
     C                     MOVELRONSDK    RONSLA
     C                     MOVELRIBNDK    RIBNLA
     C                     MOVELRIBADK    RIBALA
     C**********           Z-ADDROBNDK    ROBNLA                                              CSD027
     C**********           Z-ADDROCNDK    ROCNLA                                              CSD027
     C                     MOVE ROBNDK    ROBNLA                                              CSD027
     C                     MOVE ROCNDK    ROCNLA                                              CSD027
     C                     Z-ADDPSTMDK    PSTMLA
     C                     MOVELPONSDK    PONSLA
     C                     MOVELPIBNDK    PIBNLA
     C                     MOVELPIBADK    PIBALA
     C**********           Z-ADDPOBNDK    POBNLA                                              CSD027
     C**********           Z-ADDPOCNDK    POCNLA                                              CSD027
     C                     MOVE POBNDK    POBNLA                                              CSD027
     C                     MOVE POCNDK    POCNLA                                              CSD027
     C                     MOVELRCRNDK    RCRNLA
     C                     MOVELSTCYDK    STCYLA                          CEU003
     C                     END                             E2
     C                     END                             E1
      *
     C           AMTP      IFNE 'PD'                       B1
     C           AMTP      ANDNE*BLANKS
      *
     C                     Z-ADDWLAMPD    WVDAT
      *
      ** Perform Interest Calculation
      *
     C                     EXSR #LPINC
     C                     END                             E1
      *
     C           AMTP      IFEQ 'BC'                       B1
      *
     C********** BRTTLA    IFGT 0                          B2                                 CSD103
     C           BRTTLA    IFNE *BLANKS                    B2                                 CSD103
      *
      ** Access the new base rate details
      *
     C                     MOVE BRTTLA    BSRTA   2                       095399
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM CCYLA     @CCY    3
     C***********          PARM BRTTLA    @BRTT   20                      095399
     C                     PARM BSRTA     @BRTT   2                       095399
     C********** SDBSRT    PARM SDBSRT    DSFDY                           CSD006
     C           SDBSRT    PARM SDBSRT    DSSDY                           CSD006
      *
     C           @RTCD     IFNE *BLANKS                    B3
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD010       DBASE            ***************
     C                     MOVEL'SDBSRTPD'DBFILE           *DB ERROR 010 *
     C                     MOVELCCYLA     WKEY    5        ***************
     C                     MOVE BRTTLA    WKEY
     C                     MOVELWKEY      DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
      *
     C                     Z-ADDBACBSR    ULBRTE
      *
     C                     ELSE                            X2
     C                     Z-ADD0         ULBRTE
     C                     END                             E2
      *
      ** Calculate New Effective Interest Rate
      *
     C                     EXSR #LCNER
      *
     C                     END                             E1
      *
     C           AMTP      IFEQ 'SC'                       B1
      *
     C                     Z-ADDRTSPLA    ULRTSP
      *
      ** Calculate New Effective Interest Rate
      *
     C                     EXSR #LCNER
      *
     C                     END                             E1
      *
     C           AMTP      IFEQ 'PI'                       B1
     C           PTYPLA    ANDNE70
      *
     C                     MOVELBRCALA    WBRCA
     C                     MOVELCCYLA     WCCY
     C                     Z-ADDVDATLA    WVDAT
     C                     Z-ADD0         WAMT
      *
     C           PTYPLA    IFEQ 66                         B2
     C           PTYPLA    OREQ 67
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     ADD  PRAM      WAMT
     C                     ELSE                            X3
     C                     SUB  PRAM      WAMT
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     SUB  PRAM      WAMT
     C                     ELSE                            X3
     C                     ADD  PRAM      WAMT
     C                     END                             E3
     C                     END                             E2
      *
     C                     MOVEL'SA'      WSSETT
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     ADD  PRAM      ULCPAM
      *
     C                     END                             E1
      *
     C           AMTP      IFEQ 'RE'                       B1
     C           AMTP      OREQ 'MR'
      *
      ** Create Repayment Date Event Messages
      *
     C                     MOVEL'Y'       WLOAM                           095959
     C                     EXSR #LCREM
      *
     C                     END                             E1
      *
      ** Read a record from the Loan Amendments file
      *
     C                     READ LOAMS                    56
      *
     C           *IN56     IFEQ '0'                        B1
     C           LNRFLA    ANDEQLNRF
     C                     Z-ADDVDATLA    WLAMPD
     C                     ELSE
     C                     Z-ADD99999     WLAMPD
     C                     END                             E1
      *
     C                     MOVEL'Y'       WAMDES
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCIEM - Create Interest Date Event Messages                 *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *                                                               *
      *  Calls      : #LPINC - Perform Interest Calculation           *
      *               #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *               ZFWDT  - Find nth Working Day Forward from a Gi-*
      *                        ven date                               *
      *               ZFREQB - Calculate Next Payment/Statement Date  *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LCIEM    BEGSR
      *
     C           AUTO      IFEQ 'Y'                        B1
     C           AUTO      OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *
     C                     Z-ADDWLIPDT    WVDAT
      *
      ** Perform Interest Calculation
      *
     C                     EXSR #LPINC
     C                     MOVELBRCACL    WBRCA
     C                     MOVELCCY       WCCY
     C                     Z-ADD0         WAMT
      *
     C           PTYP      IFEQ 66                         B2
     C           PTYP      OREQ 67
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     SUB  WINTDU    WAMT
     C                     ELSE                            X3
     C                     ADD  WINTDU    WAMT
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     ADD  WINTDU    WAMT
     C                     ELSE                            X3
     C                     SUB  WINTDU    WAMT
     C                     END                             E3
     C                     END                             E2
      *
     C                     MOVEL'ML'      WSSETT
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C           INTC      IFEQ 'Y'                        B2
     C                     ADD  WINTDU    ULCPAM
     C                     END                             E2
      *
     C                     ADD  WINTDU    ULINTP
      *
     C           IPFR      IFEQ *BLANKS                    B2
     C                     Z-ADD99999     WLIPDT
     C                     ELSE                            X2
      *
     C                     MOVE IPFR      ZFREQ
     C                     Z-ADDULIBDT    ZDAYNO
     C                     Z-ADDIFDY      ZMDAY
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           SCCY      ANDNE*BLANKS                                   CEU003
     C                     MOVELSCCY      ZCCY                            CEU003
     C                     ELSE                                           CEU003
     C                     MOVE CCY       ZCCY
     C                     ENDIF                                          CEU003
      *
      ** Calculate Next Interest Payment Date
      *
     C                     EXSR ZFREQB
      *
     C           *IN99     IFEQ '1'                        B3
     C           *LOCK     IN   LDA
     C***********          Z-ADD009       DBASE            ***************095763
     C***********          MOVEL'ZFREQB  'DBFILE           *DB*ERROR*010**095763
     C                     Z-ADD017       DBASE            ***************095763
     C                     MOVEL'ZFREQB  'DBFILE           *DB ERROR 017 *095763
     C                     MOVEL'*ERROR'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
      *
     C                     Z-ADD*ZERO     ZNRDYS
      *
      ** Calculate the first working day forward
      *
     C                     EXSR ZFWDT
      *
     C                     Z-ADDZDAYNO    ULIBDT
     C                     Z-ADDZDYNBR    WLIPDT
     C                     END                             E2
      *
     C***********          MOVEL'Y'       WAMDES                          095960
     C***********          MOVEL'Y'       WINTES                          095960
      *                                                                   095443
     C                     ELSE                            X1             095443
     C                     Z-ADD99999     WLIPDT                          095443
     C                     END                             E1
      *
     C                     MOVEL'Y'       WAMDES                          095960
     C                     MOVEL'Y'       WINTES                          095960
      *                                                                   095960
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCREM - Create Repayment Date Event Messages                *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *               #LCAEM - Create Amendment Date Event Messages   *
      *                                                               *
      *  Calls      : #LPINC - Perform Interest Calculation           *
      *               #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *               ZFWDT  - Find nth Working Day Forward from a Gi-*
      *                        ven date                               *
      *               ZFREQB - Calculate Next Payment/Statement Date  *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LCREM    BEGSR
      *
      ** If Repayment Derived from Loan Amendment
      *
     C***********AMTP      IFEQ 'RE'                       B1             095959
     C           WLOAM     IFEQ 'Y'                        B1             095959
      *                                                                   095959
      ** Manual Repayments are repayments which have been received and    095959
      ** so should always be processed.                                   095959
      *                                                                   095959
     C           AMTP      IFEQ 'MR'                       B2             095959
     C                     MOVE 'Y'       AUTOLA                          095959
     C                     END                             E2             095959
      *
     C***********AUTO      IFEQ 'Y'                        B2             095959
     C           AUTOLA    IFEQ 'Y'                        B2             095959
      *
     C                     Z-ADDWLAMPD    WVDAT
      *
     C           REPT      IFEQ 1                          B3
     C                     Z-ADDPRAM      WPRAMT 130
     C                     Z-ADDWINTDU    WIRAMT 130
     C                     END                             E3
      *
     C           REPT      IFEQ 2                          B3
     C                     Z-ADDTAMT      WPRAMT
     C                     Z-ADD0         WIRAMT
     C                     END                             E3
      *
     C           REPT      IFEQ 3                          B3
     C           WINTDU    IFLE TAMT                       B4
     C                     Z-ADDWINTDU    WIRAMT
     C           TAMT      SUB  WINTDU    WPRAMT
     C                     ELSE                            X4
     C                     Z-ADDTAMT      WIRAMT
     C                     Z-ADD0         WPRAMT
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
      *
     C                     ELSE                            X1
      *
      ** Repayment Derived from Loan
      *
     C           AUTO      IFEQ 'Y'                        B2
     C           AUTO      OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *
     C                     Z-ADDWLRPDT    WVDAT
      *
      ** Perform Interest Calculation
      *
     C                     EXSR #LPINC
      *
     C           REPT      IFEQ 1                          B3
     C                     Z-ADDRAMT      WPRAMT
     C                     Z-ADDWINTDU    WIRAMT
     C                     END                             E3
      *
     C           REPT      IFEQ 2                          B3
     C                     Z-ADDRAMT      WPRAMT
     C           WPRAMT    IFGT ULCPAM                     B4
     C                     Z-ADDULCPAM    WPRAMT
     C                     END                             E4
     C                     Z-ADD0         WIRAMT
     C                     END                             E3
      *
     C           REPT      IFEQ 3                          B3
     C           WINTDU    IFLE RAMT                       B4
     C                     Z-ADDWINTDU    WIRAMT
     C           RAMT      SUB  WINTDU    WPRAMT
     C                     ELSE                            X4
     C                     Z-ADDRAMT      WIRAMT
     C                     Z-ADD0         WPRAMT
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
      *
      ** If Repayment Derived from Loan or Loan Amendment
      *
     C           AUTO      IFEQ 'Y'                        B1
     C           WLOAM     ANDEQ'N'                                       095959
      *                                                                                       CLE134
     C           AUTO      OREQ 'C'                                                           CLE134
     C           WLOAM     ANDEQ'N'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                                       CLE134
     C           AUTOLA    OREQ 'Y'                                       095959
     C           WLOAM     ANDEQ'Y'                                       095959
      *
     C           REPT      IFEQ 1                          B2
     C           REPT      OREQ 2
      *
     C           ULCPAM    IFLE WPRAMT                     B3
     C                     Z-ADDULCPAM    WPRAMT
      *
      ** If Repayment Derived from Loan
      *
     C***********AMTP      IFNE 'RE'                       B4             095959
     C           WLOAM     IFEQ 'N'                        B4             095959
     C                     Z-ADD99999     WLRPDT
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
      *
     C                     MOVELBRCACL    WBRCA
     C                     MOVELCCY       WCCY
     C                     Z-ADD0         WAMT
      *
     C           PTYP      IFEQ 66                         B2
     C           PTYP      OREQ 67
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     SUB  WPRAMT    WAMT
     C                     ELSE                            X3
     C                     ADD  WPRAMT    WAMT
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
     C           WINSRT    IFEQ 'Y'                        B3
     C                     ADD  WPRAMT    WAMT
     C                     ELSE                            X3
     C                     SUB  WPRAMT    WAMT
     C                     END                             E3
     C                     END                             E2
      *
      ** If Repayment Derived from Loan
      *
     C***********AMTP      IFNE 'RE'                       B2             095959
     C           WLOAM     IFEQ 'N'                        B2             095959
     C                     MOVEL'ML'      WSSETT
     C                     ELSE                            X2
     C                     MOVEL'MA'      WSSETT
     C                     END                             E2
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C           REPT      IFEQ 1                          B2
     C           REPT      OREQ 3
     C                     Z-ADD0         WAMT
      *
     C           PTYP      IFEQ 66                         B3
     C           PTYP      OREQ 67
      *
     C           WINSRT    IFEQ 'Y'                        B4
     C                     SUB  WIRAMT    WAMT
     C                     ELSE                            X4
     C                     ADD  WIRAMT    WAMT
     C                     END                             E4
      *
     C                     ELSE                            X3
      *
     C           WINSRT    IFEQ 'Y'                        B4
     C                     ADD  WIRAMT    WAMT
     C                     ELSE                            X4
     C                     SUB  WIRAMT    WAMT
     C                     END                             E4
     C                     END                             E3
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     END                             E2
      *
     C                     ADD  WIRAMT    ULINTP
     C                     SUB  WPRAMT    ULCPAM
      *
      ** If Repayment Derived from Loan
      *
     C***********AMTP      IFNE 'RE'                       B2             095959
     C           WLOAM     IFEQ 'N'                        B2             095959
      *
     C           RFRQ      IFEQ *BLANKS                    B3
     C           ULCPAM    OREQ 0
     C                     Z-ADD99999     WLRPDT
     C                     END                             E3
      *
     C           WLRPDT    IFNE 99999                      B3
      *
     C                     MOVE RFRQ      ZFREQ
     C                     Z-ADDULRBDT    ZDAYNO
     C                     Z-ADDRDYN      ZMDAY
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           SCCY      ANDNE*BLANKS                                   CEU003
     C                     MOVELSCCY      ZCCY                            CEU003
     C                     ELSE                                           CEU003
     C                     MOVE CCY       ZCCY
     C                     ENDIF                                          CEU003
      *
      ** Calculate Next Repayment Date
      *
     C                     EXSR ZFREQB
      *
     C           *IN99     IFEQ '1'                        B4
     C           *LOCK     IN   LDA
     C                     Z-ADD0011      DBASE            ***************
     C                     MOVEL'ZFREQB  'DBFILE           *DB ERROR 011 *
     C                     MOVEL'*ERROR'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E4
      *
     C                     Z-ADD*ZERO     ZNRDYS
      *
      ** Calculate the first working day forward
      *
     C                     EXSR ZFWDT
     C                     Z-ADDZDAYNO    ULRBDT
     C                     Z-ADDZDYNBR    WLRPDT
      *
     C                     END                             E3
     C                     END                             E2
      *
     C***********          MOVEL'Y'       WAMDES                          095960
     C***********          MOVEL'Y'       WINTES                          095960
     C***********          MOVEL'Y'       WRPYES                          095960
      *
     C                     END                             E1
      *                                                                   095443
      ** If Repayment Derived from Loan and Non-Autosettle                095443
      *                                                                   095443
     C           AUTO      IFNE 'Y'                        B1             095443
     C***********AMTP      ANDNE'RE'                               095443 095959
     C           WLOAM     ANDEQ'N'                                       095959
      *                                                                                       CLE134
     C           AUTO      ORNE 'Y'                                                           CLE134
     C           AUTO      ANDNE'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           WLOAM     ANDEQ'N'                                                           CLE134
      *                                                                                       CLE134
     C                     Z-ADD99999     WLRPDT                          095443
     C                     END                             E1             095443
      *
     C                     MOVEL'Y'       WAMDES                          095960
     C                     MOVEL'Y'       WINTES                          095960
     C                     MOVEL'Y'       WRPYES                          095960
      *                                                                   095960
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCOEM - Create Rollover Date Event Messages                 *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *                                                               *
      *  Calls      : #LPINC - Perform Interest Calculation           *
      *               #LCNER - Calculate New Effective Interest Rate  *
      *               #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LCOEM    BEGSR
      *
     C                     Z-ADDWLRLPD    WVDAT
     C                     MOVELBRCACL    WBRCA
     C                     MOVELCCY       WCCY
      *
     C           WINTCR    IFEQ 'N'                        B1
      *
     C                     MOVE LNRF      LNRFK
     C                     MOVE 'B'       RCDTK
      *
     C           CLONKY    CHAINCLOAN                40
     C           *IN40     IFEQ '1'                        B2
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD012       DBASE            ***************
     C                     MOVEL'CLOAN   'DBFILE           *DB ERROR 012 *
     C                     MOVELLNRF      DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
      *
     C                     Z-ADD0         WAMT
      *
     C           WINSRT    IFEQ 'Y'                        B2
     C                     ADD  NDAM      WAMT
     C                     ELSE                            X2
     C                     SUB  NDAM      WAMT
     C                     END                             E2
      *
     C***********          MOVEL'SL'      WSSETT                          096429
     C                     MOVEL'RL'      WSSETT                          096429
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     Z-ADD0         WAMT
      *
     C           WINSRT    IFEQ 'Y'                        B2
     C                     ADD  ULCPAM    WAMT
     C                     ELSE                            X2
     C                     SUB  ULCPAM    WAMT
     C                     END                             E2
      *
     C***********          MOVEL'ML'      WSSETT                          096429
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     Z-ADD0         WAMT
      *
     C           WINSRT    IFEQ 'Y'                        B2
     C                     SUB  NPRAM     WAMT
     C                     ELSE                            X2
     C                     ADD  NPRAM     WAMT
     C                     END                             E2
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     ELSE                            X1
      *
      ** Perform Interest Calculation
      *
     C                     EXSR #LPINC
      *
     C                     END                             E1
      *
      ** Loan new base rate applicable
      *
     C           CHIN      IFEQ 'R'                        B1
     C********** NBRA      ORGT 0                                                             CSD103
     C           NBRA      ORNE *BLANKS                                                       CSD103
      *
     C********** NBRA      IFGT 0                          B2                                 CSD103
     C           NBRA      IFNE *BLANKS                    B2                                 CSD103
      *
      ** Access the new base rate details using loan currency and loan
      ** new base rate code
      *
     C                     MOVE NBRA      WKEY2   5
     C                     MOVE NBRA      BSRTA                           095399
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM CCY       @CCY    3
     C***********          PARM NBRA      @BRTT   20                      095399
     C                     PARM BSRTA     @BRTT                           095399
     C********** SDBSRT    PARM SDBSRT    DSFDY                           CSD006
     C           SDBSRT    PARM SDBSRT    DSSDY                           CSD006
      *
     C                     ELSE                            X2
      *
      ** Access the new base rate details using loan currency and loan
      ** current base rate code
      *
     C                     MOVE BRTT      WKEY2
     C                     MOVE BRTT      BSRTA                           095399
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM CCY       @CCY    3
     C***********          PARM BRTT      @BRTT   20                      095399
     C                     PARM BSRTA     @BRTT                           095399
     C********** SDBSRT    PARM SDBSRT    DSFDY                           CSD006
     C           SDBSRT    PARM SDBSRT    DSSDY                           CSD006
     C                     END                             E2
      *
     C           @RTCD     IFNE *BLANKS                    B2
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD013       DBASE            ***************
     C                     MOVEL'SDBSRTPD'DBFILE           *DB ERROR 013 *
     C                     MOVELCCY       WKEY2            ***************
     C                     MOVELWKEY2     DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
      *
     C           BAVDNR    IFEQ 0                          B2
     C                     Z-ADDBANBRT    ULBRTE
     C                     END                             E2
      *
     C                     END                             E1
      *
      ** Loan New Rollover details are present
      *
     C           NCAS      IFGT 0                          B1
     C                     Z-ADDNRTS      ULRTSP
     C                     MOVE NSIN      ULSPIN
     C                     MOVE NCAS      ULICBS
     C                     END                             E1
      *
      ** Calculate New Effective Interest Rate
      *
     C                     EXSR #LCNER
      *
     C                     Z-ADD99999     WLRLPD
     C                     MOVEL'Y'       WAMDES
     C                     MOVEL'Y'       WINTES
     C                     MOVEL'Y'       WRPYES
     C                     MOVEL'Y'       WROLES
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCMEM - Create Maturity Date Event Messages                 *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *                                                               *
      *  Calls      : #LPINC - Perform Interest Calculation           *
      *               #LDTNA - Determine if Transaction is accross    *
      *                        Nostro Account                         *
      *               #LDTDP - Determine if transmission delay period *
      *                        has elapsed                            *
      *               #LSMDQ - Send a message to the DTAQ/DLCDDTAQ    *
      *               #LULTD - Update Last Transmission details on    *
      *                        dealing ICD                            *
      *                                                               *
     C*****************************************************************
     C           #LCMEM    BEGSR
      *
     C           AUTO      IFEQ 'Y'                        B1
     C           AUTO      OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *
     C                     MOVELBRCACL    WBRCA
     C                     MOVELCCY       WCCY
     C                     MOVEL'ML'      WSSETT
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
     C                     Z-ADDWMATPD    WVDAT
      *
      ** Perform Interest Calculation
      *
     C                     EXSR #LPINC
      *
     C           WINTCR    IFEQ 'Y'                        B2
     C           MDAT      IFGT 0                          B3
     C                     Z-ADDMDAT      WVDAT
     C                     ELSE                            X3
     C                     MOVEL'LP'      WMODTP
     C                     END                             E3
     C                     END                             E2
      *
     C           PTYP      IFNE 70                         B2
      *
     C                     Z-ADD0         WAMT
      *
     C           WINTCR    IFEQ 'Y'                        B3
      *
     C           PTYP      IFEQ 66                         B4
     C           PTYP      OREQ 67
      *
     C           WINSRT    IFEQ 'Y'                        B5
     C                     SUB  ULCPAM    WAMT
     C                     ELSE                            X5
     C                     ADD  ULCPAM    WAMT
     C                     END                             E5
      *
     C                     ELSE                            X4
      *
     C           WINSRT    IFEQ 'Y'                        B5
     C                     ADD  ULCPAM    WAMT
     C                     ELSE                            X5
     C                     SUB  ULCPAM    WAMT
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
      *
     C           WINTCR    IFEQ 'N'                        B3
      *
     C           WINSRT    IFEQ 'Y'                        B4
     C                     ADD  NPRAM     WAMT
     C                     ELSE                            X4
     C                     SUB  NPRAM     WAMT
     C                     END                             E4
     C                     END                             E3
      *
     C           PTYP      IFEQ 63                         B3
     C           ORMD      ANDGT0
      *
     C           WINSRT    IFEQ 'Y'                        B4
     C           ULCPAM    SUB  ORTI      WAMT
     C           WAMT      ADD  TOTI      WAMT
     C                     ELSE                            X4
     C           ORTI      SUB  ULCPAM    WAMT
     C           WAMT      SUB  TOTI      WAMT
     C                     END                             E4
     C                     END                             E3
      *
      ** Determine if the transaction is across a Nostro account
      *
     C                     EXSR #LDTNA
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
     C                     END                             E2
      *
     C           PTYP      IFNE 63                         B2
     C           PTYP      ANDNE65
     C           PTYP      ANDNE67
      *
     C                     Z-ADD0         WAMT
      *
     C           PTYP      IFEQ 66                         B3
      *
     C           WINSRT    IFEQ 'Y'                        B4
     C                     SUB  WINTDU    WAMT
     C                     ELSE                            X4
     C                     ADD  WINTDU    WAMT
     C                     END                             E4
      *
     C                     ELSE                            X3
      *
     C           WINSRT    IFEQ 'Y'                        B4
     C                     ADD  WINTDU    WAMT
     C                     ELSE                            X4
     C                     SUB  WINTDU    WAMT
     C                     END                             E4
     C                     END                             E3
      *
      ** Determine if the transmission delay period has elapsed
      *
     C                     EXSR #LDTDP
      *
      ** Send a message to the DTAQ/DLCDDTAQ
      *
     C                     EXSR #LSMDQ
      *
      ** Update the Last Transmission details on the Dealing ICD
      *
     C                     EXSR #LULTD
      *
     C                     END                             E2
      *
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCJIP - Check if Journal Image to be Processed              *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *               #LPFCC - Processing for Facility Changes        *
      *               #LPFFC - Processing for Facility Fee Changes    *
      *               #LPACM - Processing for Account Movement Changes*
      *                                                               *
      *  Calls      : None                                            *
      *                                                               *
     C*****************************************************************
     C           #LCJIP    BEGSR
      *
     C                     MOVEL'N'       WPRCSS  1
     C                     MOVEL'N'       WINSRT  1
      *
     C           JFILE     IFEQ 'LOAMSDK'                  B1
     C                     MOVELCHTPDK    CHTP
     C                     END                             E1
      *
     C           JFILE     IFEQ 'FCLTYFM'                  B1
     C                     MOVELCHTPFC    CHTP
     C                     END                             E1
      *
     C           JFILE     IFEQ 'LEFEED'                   B1
     C                     MOVELFELCHT    CHTP
     C                     END                             E1
      *
     C           JOENTT    IFEQ 'PT'                       B1
     C           JOENTT    OREQ 'UR'
     C           JOENTT    OREQ 'DR'
     C           JOENTT    OREQ 'UB'
     C           JOENTT    OREQ 'UP'
     C           JOENTT    OREQ 'BR'
     C                     MOVEL'Y'       WPRCSS
     C                     END                             E1
      *
     C***********JOENTT    IFEQ 'UB'                       B1             095961
      *
     C           CHTP      IFNE 'A'                        B2
     C           CHTP      ANDNE'I'
     C***********JFILE     ANDNE'LOAMSDK'                                 095961
     C           JFILE     ANDNE'RSACMTPD'
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
      *
     C***********          ELSE                            X1             095961
      ***********                                                         095961
     C***********CHTP      IFEQ 'A'                        B2             095961
     C***********CHTP      OREQ 'I'                                       095961
     C***********JFILE     ANDNE'RSACMTPD'                                095961
      ***********                                                         095961
     C***********JOENTT    IFEQ 'UP'                       B3             095961
     C***********          MOVEL'Y'       WINSRT                          095961
     C***********          END                             E3             095961
     C***********          END                             E2             095961
      *
     C           JOENTT    IFEQ 'PT'                       B2
     C           JOENTT    OREQ 'UR'
     C           JOENTT    OREQ 'UP'                                      095961
     C                     MOVEL'Y'       WINSRT
     C                     END                             E2
      *
     C***********          END                             E1             095961
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LDMTT - Determine the Module/Type of the Transaction        *
      *                                                               *
      *  Called by  : #LLLAC - Processing for Loan and Loan Amendment *
      *                        Changes                                *
      *               #LPFCC - Processing for Facility Changes        *
      *               #LPFFC - Processing for Facility Fee Changes    *
      *               #LPACM - Processing for Account Movement Changes*
      *                                                               *
      *  Calls      : None                                            *
      *                                                               *
     C*****************************************************************
     C           #LDMTT    BEGSR
      *
     C                     MOVELJOPGM     WFUNC   2
      *
     C           WFUNC     IFEQ 'LE'                       B1
     C                     MOVEL'LE'      WMODTP  2
     C                     END                             E1
      *
     C           WFUNC     IFEQ 'DL'                       B1
     C                     MOVEL'NT'      WMODTP
     C                     END                             E1
      *
     C           WFUNC     IFEQ 'FT'                       B1
     C           JOPGM     IFEQ 'FT0100'                   B2
     C                     MOVEL'NT'      WMODTP
     C                     ELSE                            X2
     C                     MOVEL'FT'      WMODTP
     C                     END                             E2
     C                     END                             E1
      *
     C           WFUNC     IFEQ 'AO'                       B1
     C           JOPGM     OREQ 'RE0671'                                  095638
     C           JOPGM     OREQ 'RE0672'                                  095638
      *
     C           FUND      IFNE *BLANKS                    B2
      *
     C           TRYP      IFEQ 'NT'                       B3
     C                     MOVEL'NT'      WMODTP
     C                     ELSE                            X3
     C                     MOVEL'FT'      WMODTP
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
     C           TRYP      IFEQ 'AA'                       B3
     C           TRYP      OREQ 'CE'
     C           TRYP      OREQ 'ME'
     C           TRYP      OREQ 'SO'
     C                     MOVEL'RE'      WMODTP
     C                     END                             E3
      *
     C           TRYP      IFEQ 'NX'                       B3
     C                     MOVEL'NT'      WMODTP
     C                     END                             E3
      *
     C           TRYP      IFEQ 'F2'                       B3
     C                     MOVEL'LE'      WMODTP
     C                     END                             E3
     C                     END                             E2
      *
     C                     END                             E1
      *
     C           WFUNC     IFNE 'LE'                       B1
     C           WFUNC     ANDNE'DL'
     C           WFUNC     ANDNE'FT'
     C           WFUNC     ANDNE'AO'
     C           JOPGM     ANDNE'RE0671'                                  095638
     C           JOPGM     ANDNE'RE0672'                                  095638
     C                     MOVEL'RE'      WMODTP
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LDTNA - Determine if Transaction is across a Nostro Account *
      *                                                               *
      *  Called by  : #LCSEM - Create Start Date Event Messages       *
      *               #LCAEM - Create Amendment Date Event Messages   *
      *               #LCIEM - Create Interest Date Event Messages    *
      *               #LCREM - Create Repayment Date Event Messages   *
      *               #LCOEM - Create Rollover Date Event Messages    *
      *               #LCMEM - Create Maturity Date Event Messages    *
      *               #LPFCC - Processing for Facility Changes        *
      *               #LPFFC - Processing for Facility Fee Changes    *
      *               #LPACM - Processing for Account Movement Changes*
      *                                                               *
      *  Calls      : *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LDTNA    BEGSR
      *
     C           JFILE     IFEQ 'RSACMTPD'                 B1
      *
      ** Access Nostro details
      *
     C                     MOVELCUSN      @CUST
     C                     MOVELACDE      @ACCD
     C                     MOVELASNC      @ACSN
     C                     CALL 'AONOSTR0'
     C                     PARM 'BLANKS ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @CUST   6
     C                     PARM CCYD      @CCY    3
     C**********           PARM           @ACCD   4                                           CGL029
     C                     PARM           @ACCD  10                                           CGL029
     C                     PARM           @ACSN   2
     C                     PARM *BLANKS   @NOST   2
     C                     PARM BRCARS    @BRCA   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
     C           @RTCD     IFNE *BLANKS                    B2
     C                     Z-ADD0         WNOST
     C                     ELSE                            X2
     C                     MOVELA7NONB    WNOST
     C                     END                             E2
      *
     C                     END                             E1
      *
     C           JFILE     IFEQ 'CLOANCL'                  B1
     C           JFILE     OREQ 'LOAMSDK'
     C           JFILE     OREQ 'FCLTYFM'
     C           JFILE     OREQ 'LEFEED '
      *
     C           WSSETT    IFEQ 'SL'                       B2
     C                     Z-ADDSDST      WSETTP  20
     C**********           MOVELOSDA      WSETAC 12                                           CGL029
     C                     MOVELOSDA      WSETAC 18                                           CGL029
     C                     END                             E2
      *
     C           WSSETT    IFEQ 'ML'                       B2
     C                     Z-ADDMDST      WSETTP
     C                     MOVELOMDA      WSETAC
     C                     END                             E2
      *                                                                   096429
     C           WSSETT    IFEQ 'RL'                       B2             096429
     C                     Z-ADDRDST      WSETTP                          096429
     C                     MOVELORVD      WSETAC                          096429
     C                     END                             E2             096429
      *
     C           WSSETT    IFEQ 'SA'                       B2
     C                     Z-ADDPSTMLA    WSETTP
     C                     MOVELPONSLA    WSETAC
     C                     END                             E2
      *
     C           WSSETT    IFEQ 'MA'                       B2
     C                     Z-ADDRSTMLA    WSETTP
     C                     MOVELRONSLA    WSETAC
     C                     END                             E2
      *
     C           WSSETT    IFEQ 'CF'                       B2
     C                     Z-ADDSETT      WSETTP
     C                     MOVELOBAC      WSETAC
     C                     END                             E2
      *
     C           WSSETT    IFEQ 'FE'                       B2
     C                     Z-ADDFESTTL    WSETTP
     C                     MOVELFEOURS    WSETAC
     C                     END                             E2
      *
     C           WSETTP    IFEQ 01                         B2
     C           WSETTP    OREQ 02
     C           WSETTP    OREQ 07
     C           WSETTP    OREQ 08
     C           WSETTP    OREQ 12
     C                     MOVELWSETAC    WNOST
     C                     END                             E2
      *
     C           WSETTP    IFEQ 04                         B2
     C           WSETTP    OREQ 05
     C                     MOVELWSETAC    WCUST   6
     C**********           MOVE WSETAC    WACCDT  6                                           CGL029
     C                     MOVE WSETAC    WACCDT 12                                           CGL029
      *                                                                   CEU003
      ** Access nostro details with settlement currency if EMU            CEU003
      ** switchable feature present and account is derived from           CEU003
      ** a loan or loan amendment.                                        CEU003
      *                                                                   CEU003
     C                     SELEC                                          CEU003
     C           CEU003    WHEQ 'Y'                                       CEU003
     C           JFILE     ANDEQ'CLOANCL'                                 CEU003
     C           SCCY      ANDNE*BLANKS                                   CEU003
     C                     MOVELSCCY      @CCY                            CEU003
      *                                                                   CEU003
     C           CEU003    WHEQ 'Y'                                       CEU003
     C           JFILE     ANDEQ'LOAMSDK'                                 CEU003
     C           STCYLA    ANDNE*BLANKS                                   CEU003
     C                     MOVELSTCYLA    @CCY                            CEU003
      *                                                                   CEU003
      ** Otherwise access nostro details with currency.                   CEU003
      *                                                                   CEU003
     C                     OTHER                                          CEU003
     C                     MOVELCCY       @CCY                            CEU003
     C                     ENDSL                                          CEU003
      *                                                                   CEU003
     C**********           MOVELWACCDT    WACCD   4                                           CGL029
     C                     MOVELWACCDT    WACCD  10                                           CGL029
      *
     C           WSETTP    IFEQ 04                         B3
     C                     MOVEL'01'      WACSQ   2
     C                     ELSE                            X3
     C                     MOVE WSETAC    WPOSI   2
     C           WPOSI     IFEQ *BLANKS                    B4
     C                     MOVEL'01'      WACSQ
     C                     ELSE                            X4
     C                     MOVE WSETAC    WACSQ
     C                     END                             E4
     C                     END                             E3
      *
      ** Access Nostro details
      *
     C                     CALL 'AONOSTR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM WCUST     @CUST   6
     C***********          PARM CCY       @CCY    3                       CEU003
     C                     PARM           @CCY    3                       CEU003
     C**********           PARM WACCD     @ACCD   4                                           CGL029
     C                     PARM WACCD     @ACCD  10                                           CGL029
     C                     PARM WACSQ     @ACSN   2
     C                     PARM *BLANKS   @NOST   2
     C                     PARM BRCACL    @BRCA   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
     C           @RTCD     IFNE *BLANKS                    B3
     C                     Z-ADD0         WNOST
     C                     ELSE
     C                     MOVELA7NONB    WNOST
     C                     END                             E3
      *
     C                     END                             E2
      *
     C           WSETTP    IFEQ 14                         B2
      *
     C                     MOVELWSETAC    WRETL  10
      *
      ** Access Account details
      *
     C                     CALL 'AOACCTR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM WRETL     @RETL  10
     C                     PARM *BLANKS   @CNUM   6
     C                     PARM *BLANKS   @CUCD   3
     C**********           PARM *BLANKS   @ACCD   4                                           CGL029
     C                     PARM *BLANKS   @ACCD  10                                           CGL029
     C                     PARM *BLANKS   @ACSQ   2
     C                     PARM *BLANKS   @BRCA   3                       095465
     C           SDACCT    PARM SDACCT    DSSDY
      *
     C           @RTCD     IFNE *BLANKS                    B3
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD005       DBASE            ***************
     C                     MOVEL'ACCNTAB 'DBFILE           *DB ERROR 005 *
     C                     MOVELWRETL     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
      *
      ** Access Nostro details
      *
     C                     MOVELSDCNUM    @CUST
     C                     MOVELSDACOD    @ACCD
     C                     MOVELSDACSQ    @ACSN
      *
     C                     CALL 'AONOSTR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @CUST   6
     C                     PARM SDCCY     @CCY    3
     C**********           PARM           @ACCD   4                                           CGL029
     C                     PARM           @ACCD  10                                           CGL029
     C                     PARM           @ACSN   2
     C                     PARM *BLANKS   @NOST   2
     C                     PARM BRCACL    @BRCA   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
     C           @RTCD     IFNE *BLANKS                    B3
     C                     Z-ADD0         WNOST
     C                     ELSE                            X3
     C                     MOVELA7NONB    WNOST
     C                     END                             E3
      *
     C                     END                             E2
      *
     C           WSETTP    IFEQ 0                          B2
     C                     Z-ADD0         WNOST
     C                     END                             E2
      *
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************   095763
      *                                                               *   095763
      *  #LDTRA - Determine if Transaction is across a Retail Account *   095763
      *                                                               *   095763
      *  Called by  : #LPACM - Processing for Account Movement Changes*   095763
      *                                                               *   095763
      *  Calls      : *PSSR  - Database Error Processing              *   095763
      *                                                               *   095763
      *****************************************************************   095763
     C           #LDTRA    BEGSR                                          095763
      *                                                                   095763
      ** Access Account details                                           095763
      *                                                                   095763
     C                     MOVE CUSN      @CNUM                           095763
     C                     MOVE ACDE      @ACCD                           095763
     C                     MOVE ASNC      @ACSQ                           095763
      *                                                                   095763
     C                     CALL 'AOACCTR0'                                095763
     C                     PARM '*BLANKS' @RTCD                           095763
     C                     PARM '*KEY   ' @OPTN                           095763
     C                     PARM *BLANKS   @RETL                           095763
     C                     PARM           @CNUM                           095763
     C                     PARM CCYD      @CUCD                           095763
     C                     PARM           @ACCD                           095763
     C                     PARM           @ACSQ                           095763
     C                     PARM BRCARS    @BRCA                           095763
     C           SDACCT    PARM SDACCT    DSSDY                           095763
      *                                                                   095763
     C           @RTCD     IFNE *BLANKS                    B1             095763
     C           *LOCK     IN   LDA                                       095763
     C                     MOVEL'9'       CALLCD                          095763
     C                     Z-ADD020       DBASE            ***************095763
     C                     MOVEL'ACCNTAB 'DBFILE           *DB ERROR 020 *095763
     C                     MOVELWACCT     DBKEY            ***************095763
     C                     OUT  LDA                                       095763
     C                     EXSR *PSSR                                     095763
     C                     ENDIF                           E1             095763
      *                                                                   095763
     C           ATYP      IFNE 'R'                        B1             095763
     C                     MOVE 'N'       WPRCSS                          095763
     C                     ENDIF                           E1             095763
      *                                                                   095763
     C                     ENDSR                                          095763
     C/EJECT                                                              095763
      *****************************************************************
      *                                                               *
      *  #LDTDP - Determine if Transmission Delay Period has Elapsed  *
      *                                                               *
      *  Called by  : #LCSEM - Create Start Date Event Messages       *
      *               #LCAEM - Create Amendment Date Event Messages   *
      *               #LCIEM - Create Interest Date Event Messages    *
      *               #LCREM - Create Repayment Date Event Messages   *
      *               #LCOEM - Create Rollover Date Event Messages    *
      *               #LCMEM - Create Maturity Date Event Messages    *
      *               #LPFCC - Processing for Facility Changes        *
      *               #LPFFC - Processing for Facility Fee Changes    *
      *               #LPACM - Processing for Account Movement Changes*
      *                                                               *
      *  Calls      : *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LDTDP    BEGSR
      *
     C                     MOVEL'N'       WXMIT
      *
      ** Access the Dealing ICD Details.
      *
     C**********           CALL 'AODEALR0'                                                    CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C********** SDDEAL    PARM SDDEAL    DSFDY                                               CGL029
     C           SDDEAL    PARM SDDEAL    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS                    B1
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD006       DBASE            ***************
     C                     MOVEL'SDDEALPD'DBFILE           *DB ERROR 006 *
     C                     MOVEL'*FIRST'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E1
      *
      ** Convert the Citydealer Transmission Delay Period
      *
     C                     Z-ADD0         WHOUR   20
      *
      ** Get the Citydealer Transmission Delay Period.
      *
     C                     Z-ADDBNDLYP    WMIN    30
      *
     C           WMIN      DOWGE60                         B1
     C                     ADD  1         WHOUR
     C                     SUB  60        WMIN
     C                     END                             E1
      *
      ** Add the minutes portion of the Last Transmission Time.
      *
     C                     MOVELBNLTMT    WTMP1   4
     C                     MOVE WTMP1     WTMP2   20
     C                     ADD  WTMP2     WMIN
     C*
     C           WMIN      IFGE 60                         B1
     C                     ADD  1         WHOUR
     C                     SUB  60        WMIN
     C                     END                             E1
      *
      ** Add the hours portion of the Last Transmission Time.
      *
     C                     MOVELWTMP1     WTMP3   20
     C                     ADD  WTMP3     WHOUR
     C*
     C           WHOUR     IFGE 24                         B1
     C                     ADD  1         BNLTMD
     C                     SUB  24        WHOUR
     C                     END                             E1
      *
      ** Compute the total time.
      *
     C                     MOVE BNLTMT    WTIME   60
     C                     MOVE WMIN      WTEMP1  4
     C                     MOVELWHOUR     WTEMP1
     C                     MOVELWTEMP1    WTIME
      *
      ** Check the Last Transmission Date with the System Run Date.
      *
     C           BNLTMD    IFLT BJRDNB                     B1
     C                     MOVE 'Y'       WXMIT
     C***********          END                             E1             099849
      *
     C***********BNLTMD    IFEQ BJRDNB                     B1             099849
     C                     ELSE                            X1             099849
     C                     TIME           WCURRT  60
     C           WCURRT    IFGE WTIME                      B2
     C           WCURRT    ORLT BNLTMT                                    099849
     C                     MOVE 'Y'       WXMIT
     C                     END                             E2
     C                     END                             E1
     C*
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LSMDQ - Send a message to the DTAQ/DLCDDTAQ                 *
      *                                                               *
      *  Called by  : #LCSEM - Create Start Date Event Messages       *
      *               #LCAEM - Create Amendment Date Event Messages   *
      *               #LCIEM - Create Interest Date Event Messages    *
      *               #LCREM - Create Repayment Date Event Messages   *
      *               #LCOEM - Create Rollover Date Event Messages    *
      *               #LCMEM - Create Maturity Date Event Messages    *
      *               #LPFCC - Processing for Facility Changes        *
      *               #LPFFC - Processing for Facility Fee Changes    *
      *               #LPACM - Processing for Account Movement Changes*
      *                                                               *
      *  Calls      : QSNDDTAQ - Send message to DTAQ/DLCDDTAQ        *
      *                                                               *
     C*****************************************************************
     C           #LSMDQ    BEGSR
      *
     C                     MOVEL'N'       WSTRF
     C                     CALL 'QSNDDTAQ'
     C                     PARM 'DLCDDTAQ'PDTAQ  10
     C                     PARM '*LIBL'   PLIB   10
     C                     PARM 32        PLEN    50
     C                     PARM           PMSGD  32
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LULTD - Update Last Transmission details                    *
      *                                                               *
      *  Called by  : #LCSEM - Create Start Date Event Messages       *
      *               #LCAEM - Create Amendment Date Event Messages   *
      *               #LCIEM - Create Interest Date Event Messages    *
      *               #LCREM - Create Repayment Date Event Messages   *
      *               #LCOEM - Create Rollover Date Event Messages    *
      *               #LCMEM - Create Maturity Date Event Messages    *
      *               #LPFCC - Processing for Facility Changes        *
      *               #LPFFC - Processing for Facility Fee Changes    *
      *               #LPACM - Processing for Account Movement Changes*
      *                                                               *
      *  Calls      : *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LULTD    BEGSR
      *
     C           WXMIT     IFEQ 'Y'                        B1
      *
     C                     CALL 'BUDEALR0'
      *
     C           *INU7     IFEQ '1'                        B2
     C           *INU8     OREQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD007       DBASE            ***************
     C                     MOVEL'BUDEALR0'DBFILE           *DB ERROR 007 *
     C                     MOVEL'*CALL '  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LPINC - Calculate Interest                                  *
      *                                                               *
      *  Called by  : #LCAEM - Create Amendment Date Event Messages   *
      *               #LCIEM - Create Interest Date Event Messages    *
      *               #LCREM - Create Repayment Date Event Messages   *
      *               #LCOEM - Create Rollover Date Event Messages    *
      *               #LCMEM - Create Maturity Date Event Messages    *
      *                                                               *
      *  Calls      : GLINTC - Calculate Interest Between two dates   *
      *                                                               *
     C*****************************************************************
     C           #LPINC    BEGSR
      *
     C                     Z-ADDULIACD    ZIBEG
     C                     Z-ADDWVDAT     ZIEND
      *
     C           ADDI      IFEQ 'B'                        B1
     C           ZIBEG     ANDEQVDAT
     C                     ADD  1         ZIEND
     C                     END                             E1
      *
     C                     Z-ADDULCPAM    ZIAMT
     C                     Z-ADDULICBS    ZICALC
     C                     Z-ADDULINTR    ZIRATE
      *
      ** Determine if Stop Accruals ON
      *
     C                     TESTB'3'       LONI           59
      *
     C           ZIAMT     IFGT 0                          B1
     C           *IN59     ANDEQ'0'
     C                     EXSR GLINTC
     C                     ELSE                            X1
     C                     Z-ADD0         ZINTR
     C                     END                             E1
      *
      ** Check for Round Down facility
      *
     C           RDFC      IFEQ 'Y'
     C           ULTOTI    ADD  ZINTR     ULTOTI
     C                     ELSE
     C           ULTOTI    ADD  ZINTR     ULTOTI    H
     C                     END
      *
      ** Determine Interest Due
      *
     C           ULTOTI    SUB  ULIPRD    WINTDU 130
     C           WINTDU    SUB  ULINTP    WINTDU
      *
      ** If interest due has a different sign to interest rate
      *
     C           ULINTR    COMP 0                    60
     C           *IN60     IFEQ '1'                        B1
     C           WINTDU    COMP 0                      60
     C           *IN60     IFEQ '1'                        B2
     C                     Z-ADD0         WINTDU
     C                     END                             E2
     C                     END                             E1
      *
     C           ULINTR    COMP 0                      60
     C           *IN60     IFEQ '1'                        B1
     C           WINTDU    COMP 0                    60
     C           *IN60     IFEQ '1'                        B2
     C                     Z-ADD0         WINTDU
     C                     END                             E2
     C                     END                             E1
      *
      ** Update last event date
      *
     C                     Z-ADDWVDAT     ULIACD
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LCNER - Calculate New Effective Rate                        *
      *                                                               *
      *  Called by  : #LCAEM - Create Amendment Date Event Messages   *
      *                                                               *
      *  Calls      : None                                            *
      *                                                               *
     C*****************************************************************
     C           #LCNER    BEGSR
      *
     C           ULSPIN    IFEQ 'A'
     C           ULBRTE    ADD  ULRTSP    ULINTR
     C                     END
      *
     C           ULSPIN    IFEQ 'S'
     C           ULBRTE    SUB  ULRTSP    ULINTR
     C                     END
      *
     C           ULSPIN    IFEQ 'P'
     C           ULBRTE    MULT ULRTSP    WTMP   119
     C           WTMP      DIV  100       ULINTR    H
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LDFDD - Determine Facility Due Date                         *
      *                                                               *
      *  Called by  : #LPFCC - Processing for Facility Changes        *
      *                                                               *
      *  Calls      : None                                            *
      *                                                               *
     C*****************************************************************
     C           #LDFDD    BEGSR
      *
     C           DUDT      IFEQ 0                          B1
      *
     C           EDDT      IFNE 0                          B2
      *
     C           EDDT      IFLE WEXDAT                     B3
     C                     Z-ADDEDDT      WVDAT
     C                     ELSE                            X3
     C                     MOVEL'N'       WPRCSS
     C                     END                             E3
      *
     C                     ELSE                            X2
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
      *
     C                     ELSE                            X1
      *
     C           DUDT      IFLE WEXDAT                     B2
     C                     Z-ADDDUDT      WVDAT
     C                     ELSE                            X2
     C                     MOVEL'N'       WPRCSS
     C                     END                             E2
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LDNCF - Determine Non-Calculated Fees                       *
      *                                                               *
      *  Called by  : #LPFCC - Processing for Facility Fee Changes    *
      *                                                               *
      *  Calls      : None                                            *
      *                                                               *
     C*****************************************************************
     C           #LDNCF    BEGSR
      *
      ** Check Events to End of Book
      *
     C           BPGEEB    IFEQ 'Y'                        B1
      *
     C                     Z-ADDFEPEND    WEXDAT
      *
     C           FEPEND    IFEQ 0                          B2
     C           FEPYON    ANDEQ*BLANKS
     C                     Z-ADDFEPSTD    WEXDAT
     C                     END                             E2
      *
     C                     ELSE                            X1
     C           BJRDNB    ADD  30        WEXDAT
     C                     END                             E1
      *
     C           WBLDAT    IFGT WEXDAT                     B1
     C                     Z-ADDWBLDAT    WEXDAT
     C                     END                             E1
      *
     C           FEPYON    IFEQ *BLANK                     B1
     C           FEPSTD    ANDGEBJRDNB
     C           FEPSTD    ANDLEWEXDAT
     C           FEPYON    OREQ 'S'
     C           FEPSTD    ANDGEBJRDNB
     C           FEPSTD    ANDLEWEXDAT
     C           FEPYON    OREQ 'E'
     C           FEPEND    ANDGEBJRDNB
     C           FEPEND    ANDLEWEXDAT
      *
     C           FEFAMT    SUB  FEAMTS    WFAMT
      *
     C           FEPYON    IFEQ *BLANK                     B2
     C           FEPSTD    ANDGEBJRDNB
     C           FEPSTD    ANDLEWEXDAT
     C           FEPYON    OREQ 'S'
     C           FEPSTD    ANDGEBJRDNB
     C           FEPSTD    ANDLEWEXDAT
     C                     Z-ADDFEPSTD    WVDAT
     C                     ELSE                            X2
     C                     Z-ADDFEPEND    WVDAT
     C                     END                             E2
      *
     C                     ELSE                            X1
     C                     MOVEL'N'       WPRCSS
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LDCFS - Determine Calculated Fees                           *
      *                                                               *
      *  Called by  : #LPFCC - Processing for Facility Fee Changes    *
      *                                                               *
      *  Calls      : #LLRTP - Perform Last Rate Processing           *
      *               *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LDCFS    BEGSR
      *
     C           FEPLPD    IFNE 0                          B1
     C                     Z-ADDFEPLPD    WSTRDT  50
     C                     ELSE                            X1
     C                     Z-ADDFEPSTD    WSTRDT
     C                     END                             E1
      *
     C           WVDAT     IFEQ 0                          B1
     C                     Z-ADDFEPEND    WVDAT
     C                     END                             E1
      *
     C           WVDAT     SUB  WSTRDT    WNDAYS  50
      *
      ** Set Calculation Amount
      *
     C           FECALT    IFEQ '01'                       B1
     C           FECALT    OREQ '02'
     C           FECALT    OREQ '03'
     C           FECALT    OREQ '04'
     C           FECALT    OREQ '05'
     C           FECALT    OREQ '06'
      *
     C           FAMT      SUB  TOTD      WCAMT  130
     C                     END                             E1
      *
     C           FECALT    IFEQ '11'                       B1
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '14'
     C           FECALT    OREQ '15'
     C           FECALT    OREQ '16'
      *
     C                     Z-ADDTOTD      WCAMT
     C                     END                             E1
      *
     C           FECALT    IFEQ '21'                       B1
     C           FECALT    OREQ '22'
     C                     Z-ADDFAMT      WCAMT
     C                     END                             E1
      *
     C                     MOVE FECALT    W2NDCH  1
      *
      ** Set Calculation Basis
      *
     C           W2NDCH    IFEQ '1'                        B1
     C           W2NDCH    OREQ '4'
     C                     Z-ADD36500     WCALCB  50
     C                     END                             E1
      *
     C           W2NDCH    IFEQ '2'                        B1
     C           W2NDCH    OREQ '3'
     C           W2NDCH    OREQ '5'
     C                     Z-ADD36000     WCALCB
     C                     END                             E1
      *
     C           W2NDCH    IFEQ '6'                        B1
     C                     Z-ADD36600     WCALCB
     C                     END                             E1
      *
      ** Set Calculation Percentage
      *
     C           WCAMT     DIV  FAMT      WCPCT   63H
     C                     MULT 100       WCPCT     H
      *
     C           FECALT    IFEQ '01'                       B1
     C           FECALT    OREQ '04'
     C           FECALT    OREQ '11'
     C           FECALT    OREQ '14'
      *
     C           FEPIND    IFEQ 'A'                        B2
      *
      ** Access Facility Fee Currency Details
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM FEFCCY    @AJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANKS                    B3
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C***********          Z-ADD015       DBASE            ***************095763
     C***********          MOVEL'SDCURRPD'DBFILE           *DB*ERROR*015**095763
     C                     Z-ADD018       DBASE            ***************095763
     C                     MOVEL'SDCURRPD'DBFILE           *DB ERROR 018 *095763
     C                     MOVELFEFCCY    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
      *
      ** Adjust the 5 Facility Fee Amounts for currency decimal places
      ** and store the results in an array
      *
     C           A6NBDP    ADD  4         P       20
      *
     C           FEEM      MULT POWER,P   FAM
      *
     C                     Z-ADD0         WFAM   150
     C                     Z-ADDWCAMT     WOAMT  150
     C                     Z-ADD1         X       20
      *
     C           WCAMT     DOWGT0                          B3
     C           X         ANDLT6
      *
      ***  If the original amount is less than the current tier being
      ***  processed or the tier is zero multiply WCAMT by the
      ***  corresponding fee rate for the tier and put in workfield.
      *
     C           WOAMT     IFLT FAM,X                      B4
     C           FAM,X     OREQ 0
     C           WCAMT     MULT FRT,X     WRK15  150
     C                     END                             E4
      *
      ***  If the original amount is greater than or equal to the
      ***  current tier, and the tier is not zero subtract WFAM from
      ***  the tier.  Multiply the resultant work field by the
      ***  corresponding fee rate for the tier.
      *
     C           WOAMT     IFGE FAM,X                      B4
     C           FAM,X     ANDNE0
     C           FAM,X     SUB  WFAM      WRK15
     C                     MULT FRT,X     WRK15
     C                     END                             E4
      *
     C                     ADD  WRK15     WFAMT
      *
     C                     SUB  FAM,X     WCAMT
      *
     C                     ADD  WFAM      WAMT
     C                     Z-ADDFAM,X     WFAM
      *
     C                     ADD  1         X
      *
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
     C           FEEM      DIV  1000      FPC
     C                     Z-ADD0         WFPC    63
     C                     Z-ADDWCPCT     WOPCT   63
     C                     Z-ADD1         X
      *
     C           WCPCT     DOWGT0                          B3
     C           X         ANDLT6
      *
      ***  If original percentage (WOPCT) is less than current element
      ***  of fee percentage array or if fee percentage is zero.
      *
     C           WOPCT     IFLT FPC,X                      B4
     C           FPC,X     OREQ 0
     C           WCAMT     MULT WCPCT     WRK15
     C                     END                             E4
      *
      ***  If original percentage (WOPCT) is greater than or equal to
      ***  fee percentage from array, and fee percentage not zero.
      *
     C           WOPCT     IFGE FPC,X                      B4
     C           FPC,X     ANDNE0
     C           FPC,X     SUB  WFPC      WRK63   63
     C           WCAMT     MULT WRK63     WRK15
     C                     END                             E4
      *
     C                     MULT FRT,X     WRK15
     C                     DIV  100       WRK15     H
     C                     ADD  WRK15     WFAMT
     C                     SUB  FPC,X     WCPCT
     C                     ADD  WFPC      WCPCT
     C                     Z-ADDFPC,X     WFPC
      *
     C                     ADD  1         X
      *
     C                     END                             E3
      *
     C                     END                             E2
     C                     END                             E1
      *
     C           FECALT    IFEQ '02'                       B1
     C           FECALT    OREQ '05'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '15'
      *
     C           FEPIND    IFEQ 'A'                        B2
      *
      ** Access Facility Fee Currency Details
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM FEFCCY    @AJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANKS                    B3
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C***********          Z-ADD016       DBASE            ***************095763
     C***********          MOVEL'SDCURRPD'DBFILE           *DB*ERROR*016**095763
     C                     Z-ADD019       DBASE            ***************095763
     C                     MOVEL'SDCURRPD'DBFILE           *DB ERROR 019 *095763
     C                     MOVELFEFCCY    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
      *
      ** Adjust the 5 Facility Fee Amounts for currency decimal places
      ** and store the results in an array
      *
     C           A6NBDP    ADD  4         P       20
      *
     C           FEEM      MULT POWER,P   FAM
      *
      *** Look up FAM array for amount greater than or equal to work
      *** amount (difference in field lengths so put WAMT in workfield
      *** to carry out LOKUP)
      *
     C                     Z-ADD1         X
     C                     MOVE '0'       *IN16
     C           WAMT      LOKUPFAM,X                16  16
      *
      ***  If none found perform last rate processing
      *
     C           *IN16     IFEQ '0'                        B3
     C                     EXSR #LLRTP
     C                     END                             E3
      *
      ***  If none found and appropriate amount & rate combination
      ***  from #LLRTP subroutine not found zeroise work amount.
      *
     C           *IN16     IFEQ '0'                        B3
     C           Y         ANDEQ0
     C                     MULT 0         WFAMT
     C                     END                             E3
      *
      ***  If none found but appropriate amount & rate combination
      ***  is found, or else if a FAM element > or = to work amount.
      *
     C           *IN16     IFEQ '0'                        B3
     C           Y         ANDLT0
     C           *IN16     OREQ '1'
     C***********          MULT FRT,X     WFAMT                           095869
     C           WCAMT     MULT FRT,X     WFAMT                           095869
     C                     END                             E3
      *
     C                     ELSE                            X2
      *
      *** Divide each threshold amount by 1000 & store in array
      *
     C           FEEM      DIV  1000      FPC
      *
      *** Search percentage array to find value larger than or equal
      *** to WCPCT
      *
     C                     Z-ADD1         X
     C                     MOVE '0'       *IN17
     C           WCPCT     LOKUPFPC,X                17  17
      *
      *** If none found perform last rate processing
      *
     C           *IN17     IFEQ '0'                        B3
     C                     EXSR #LLRTP
     C                     END                             E3
      *
     C***********          MULT WCPCT     WFAMT                           095869
     C           WCAMT     MULT WCPCT     WFAMT                           095869
      *
     C           *IN17     IFEQ '0'                        B3
     C           Y         ANDLT0
     C                     MULT 0         WFAMT
     C                     END                             E3
      *
     C           *IN17     IFEQ '0'                        B3
     C           Y         ANDEQ1
     C           *IN17     OREQ '1'
     C                     MULT FRT,X     WFAMT
     C                     END                             E3
      *
     C                     DIV  100       WFAMT     H
      *
     C                     END                             E2
     C                     END                             E1
      *
     C           FECALT    IFEQ '03'                       B1
     C           FECALT    OREQ '06'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '16'
     C           FECALT    OREQ '21'
     C           FECALT    OREQ '22'
     C           WCAMT     MULT FRT,1     WFAMT
     C                     END                             E1
      *
      ** Compute Fee Amount
      *
     C                     MULT WNDAYS    WFAMT
     C                     DIV  WCALCB    WFAMT     H
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LLRTP - Last Rate Processing                                *
      *                                                               *
      *  Called by  : #LDCFS - Determine Calculated Fees              *
      *                                                               *
      *  Calls      : None                                            *
      *                                                               *
     C*****************************************************************
      *
     C           #LLRTP    BEGSR
      *
     C                     Z-ADD5         Y       20
     C           Y         DOWGT0                          B1
      *
      ***  If current fee amount being processed is zero and its
      ***  corresponding fee rate on FRT array is not zero, set
      ***  array element count (in SR/ACCRUE) to the value of Y and
      ***  zeroise afterwards.
      *
     C           FEEM,Y    IFEQ 0                          B2
     C           FRT,Y     ANDNE0
     C                     Z-ADDY         X
     C                     Z-ADD0         Y
     C                     END                             E2
     C                     SUB  1         Y
     C                     END                             E1
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      *  #LINIT - Initial Processing                                  *
      *                                                               *
      *  Called by  : MAIN   - Main Processing Routine                *
      *                                                               *
      *  Calls      : *PSSR  - Database Error Processing              *
      *                                                               *
     C*****************************************************************
     C           #LINIT    BEGSR
      *
      ** Read in Installation Data
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVEL'DL0002'  DBPGM
     C                     OUT  LDA
      *
      ** Key for CHAIN to 'A' or 'B' record from LF/LOAMS
      *
     C           CLONKY    KLIST
     C**********           KFLD           LNRFK   60                                          CLE148
     C                     KFLD           LNRFK   6                                           CLE148
     C                     KFLD           RCDTK   1
      *
      ** Key for SETLL to LF/LOAMS
      *
     C           LMSSET    KLIST
     C                     KFLD           LNRF
     C                     KFLD           VDATK   50
     C                     KFLD           LASNK   30
      *
      ** Key for CHAIN to LF/FCLTY
      *
     C           FCLTYK    KLIST
     C                     KFLD           CNUMFC
     C                     KFLD           FACTFC
     C                     KFLD           FCNOFC
     C                     KFLD           RCTP
      *
      ** Initialise work fields
      *
     C                     Z-ADD0         VDATK
     C                     Z-ADD0         LASNK
     C                     MOVEL*BLANKS   WFCYL   1
      *
      ** If First Cycle
      *
     C           WFCYL     IFEQ *BLANKS                    B1
      *
      ** Access the Bank Details.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           @RTCD     IFNE *BLANKS                    B2
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD001       DBASE            ***************
     C                     MOVEL'SDBANKPD'DBFILE           *DB ERROR 001 *
     C                     MOVEL'*FIRST'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
      *
      ** Access Module Setting Details
      *
     C                     CALL 'AOMMODR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
     C           @RTCD     IFNE *BLANKS                    B2
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD002       DBASE            ***************
     C                     MOVEL'SDMMODPD'DBFILE           *DB ERROR 002 *
     C                     MOVEL'*FIRST'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E2
      *
      ** Check if Customer Lending module used within the system
      *
     C           BGCSLN    IFEQ 'Y'                        B2
      *
      ** Access Customer Lending Details
      *
     C                     CALL 'AOCLNDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C********** SDCLND    PARM SDCLND    DSFDY                                               CLE134
     C           SDCLND    PARM SDCLND    DSSDY                                               CLE134
      *
     C           @RTCD     IFNE *BLANKS                    B3
     C           *LOCK     IN   LDA
     C                     MOVEL'9'       CALLCD
     C                     Z-ADD003       DBASE            ***************
     C                     MOVEL'SDCLNDPD'DBFILE           *DB ERROR 003 *
     C                     MOVEL'*FIRST'  DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E3
     C                     END                             E2
      *
      **  Access SAR details file to see if EMU switchable feature is     CEU003
      **  installed.                                                      CEU003
      *                                                                   CEU003
     C                     CALL 'AOSARDR0'                                CEU003
     C                     PARM *BLANKS   @RTCD   7                       CEU003
     C                     PARM '*VERIFY' @OPTN   7                       CEU003
     C                     PARM 'CEU003'  @SARD   6                       CEU003
      *                                                                   CEU003
     C           @RTCD     IFEQ *BLANK                                    CEU003
     C                     MOVE 'Y'       CEU003  1                       CEU003
     C                     ELSE                                           CEU003
     C                     MOVE 'N'       CEU003                          CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
      *
     C           BJRDNB    ADD  30        WCDAT1  50
     C                     MOVEL'Y'       WFCYL
      *
     C                     END                             E1
      *
      ***  Check System Date Format, DDMMYY (*IN98 off)
      ***                            MMDDYY (*IN98 on).
      *
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL'1'       *IN98
     C                     END
      *                                                                                       CLE134
      * Past Due Call Loans                                                                   CLE134
     C                     CALL 'AOSARDR0'                                                    CLE134
     C                     PARM *BLANKS   @RTCD   7                                           CLE134
     C                     PARM '*VERIFY' @OPTN   7                                           CLE134
     C                     PARM 'CLE134'  @SARD   6                                           CLE134
      *                                                                                       CLE134
     C           @RTCD     IFEQ *BLANK                                                        CLE134
     C                     MOVE 'Y'       CLE134  1                                           CLE134
     C                     ELSE                                                               CLE134
     C                     MOVE 'N'       CLE134                                              CLE134
     C                     ENDIF                                                              CLE134
      *                                                                                       CLE134
      ***Call*access*program*for*General*Ledger*details.***************            MD035545 MD047993
      *****************************************************************            MD035545 MD047993
     C**********           CALL 'AOGELRR1'                                         MD035545 MD047993
     C**********           PARM '*MSG   ' @RTCD   7                                MD035545 MD047993
     C**********           PARM '*FIRST ' @OPTN   7                                MD035545 MD047993
     C********** SDGELR    PARM SDGELR    DSSDY                                    MD035545 MD047993
      *                                                                                     MD035545
     C********** @RTCD     IFNE *BLANK                                             MD035545 MD047993
     C**********           MOVEL'SDGELRPD'DBFILE                                   MD035545 MD047993
     C**********           MOVEL'062'     DBASE                                    MD035545 MD047993
     C**********           MOVEL@OPTN     DBKEY                                    MD035545 MD047993
     C**********           EXSR *PSSR                                              MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
      *                                                                                     MD035545
      ** Retrieve system value setting                                                      MD035545
      *                                                                                     MD035545
     C                     MOVELWPARML    P@OP01                                            MD035545
     C                     CALL 'AOSVALR0'                                                  MD035545
     C                     PARM *BLANKS   W0RTCD  7                                         MD035545
     C                     PARM           P@OP01 20                                         MD035545
     C                     PARM           P@VL01200                                         MD035545
     C                     PARM           P@OP02 20                                         MD035545
     C                     PARM           P@VL02200                                         MD035545
     C                     PARM           P@OP03 20                                         MD035545
     C                     PARM           P@VL03200                                         MD035545
     C                     PARM           P@OP04 20                                         MD035545
     C                     PARM           P@VL04200                                         MD035545
     C                     PARM           P@OP05 20                                         MD035545
     C                     PARM           P@VL05200                                         MD035545
     C                     PARM           P@OP06 20                                         MD035545
     C                     PARM           P@VL06200                                         MD035545
     C                     PARM           P@OP07 20                                         MD035545
     C                     PARM           P@VL07200                                         MD035545
     C                     PARM           P@OP08 20                                         MD035545
     C                     PARM           P@VL08200                                         MD035545
     C                     PARM           P@OP09 20                                         MD035545
     C                     PARM           P@VL09200                                         MD035545
     C                     PARM           P@OP10 20                                         MD035545
     C                     PARM           P@VL10200                                         MD035545
      *                                                                                     MD035545
      ** If system value is not found then default value to 'N'                             MD035545
      *                                                                                     MD035545
     C           W0RTCD    IFNE '       '                                                   MD035545
     C                     MOVE 'N'       WCALC6                                            MD035545
     C                     ELSE                                                             MD035545
     C                     MOVELP@VL01    WCALC6                                            MD035545
     C********** WCALC6    IFEQ 'Y'                                                MD035545 MD047993
     C********** BKALDI    ANDEQ'Y'                                                MD035545 MD047993
     C**********           MOVE 'Y'       WCALC6                                   MD035545 MD047993
     C**********           ELSE                                                    MD035545 MD047993
     C**********           MOVE 'N'       WCALC6                                   MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
     C                     ENDIF                                                            MD035545
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      * Called by: (**calling routines**)                             *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR
     C*
     C                     OPEN DL0002AU
     C                     WRITEHEADAU
     C                     WRITEDBERROR
     C                     CLOSEDL0002AU
      *
     C                     DUMP
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      /EJECT
     C/COPY ZSRSRC,ZFWDT
      /EJECT
     C/COPY ZSRSRC,ZACCH
      /EJECT
     C/COPY ZSRSRC,GLINTCZ1
      /EJECT
     C/COPY ZSRSRC,ZDAT10Z2                                               126017
     C/EJECT                                                              126017
     C/COPY ZSRSRC,ZSAVEZ1
      /EJECT
     C/COPY ZSRSRC,ZRSTORZ1
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z4
      /EJECT
     C/COPY ZSRSRC,ZFREQBZ2
      /EJECT
     C/COPY ZSRSRC,ZINTDYZ2
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZCHKH
      /EJECT
     C/COPY ZSRSRC,ZDATE9Z3
      /EJECT
      ********************************************************************
**  CPY@
(c) Finastra International Limited 2001
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ZFMD  -  NUMBER OF DAYS IN THE MONTH
312831303130313130313031
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
