     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas DL FRA/IRS rate fixing and rate re-fixing')      *
      *****************************************************************
      *                                                               *
      *  Midas - Dealing Module                                       *
      *                                                               *
      *  DL1924 - FRA/IRS Rate Fixing & Rate Re-fixing                *
      *                                                               *
      *  Function: This program will run instead of DL1922 if the     *
      *   (I/C)    feature 'CSW005' is switched on. Like DL1992, it   *
      *            runs in two mode, fixing and re-fixing and will    *
      *            process only those deals flagged for fixing and    *
      *            re-fixing and settlement for swaps will only be    *
      *            performed for those paying interest up-front.      *
      *                                                               *
      *  Called By: DLC1921  - Zero Rate Fix Control - 2              *
      *                                                               *
      *  Calls    : DLZFRS   - FRA Settlement Amount Calculation      *
      *             AOOUFRU0 - On-Line Update of FRA Positions File   *
      *             DL2900 - IRS Determine Activity for On-Line Update*
      *             AOOUSWU0 - AO On-Line Update Of IRS Position Files*
      *             ZSFILE   - FC Set up Spool File Numbers           *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. MD045010           Date 05Apr17               *
      *                 CGL184             Date 07Dec16               *
      *                 CIR018             Date 12Aug14               *
      *                 CIR017             Date 10Apr14               *
      *                 CLE064             Date 06Dec10               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 237750             Date 24Nov06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 BUG11267           Date 04May06               *
      *                 CSD031             Date 10Apr06               *
      *                 227642             Date 24Aug04               *
      *                 226723             Date 02Mar06               *
      *                 CSD027             Date 09Dec05               *
      *                 CDL038             Date 10May05               *
      *                 CSW037A            Date 02May05               *
      *                 CDL028             Date 07Feb05               *
      *                 CAS008             Date 16Jun04               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 TDA101             Date 02Apr04               *
      *                 CGL029             Date 01Sep03               *
      *                 CAS006             Date 21Jan03               *
      *                 CAS005             Date 16Dec02               *
      *                 217684             Date 12May03               *
      *                 215359             Date 27Mar03               *
      *                 CAS004             Date 26Jun02               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 205411             Date 14May02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CIR008             Date 13Mar02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CIR007             Date 11May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 15May01               *
      *                 CIR003             Date 12Sep00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 180466             Date 27Jun00               *
      *                 177837             Date 05Jun00               *
      *                 CIR005             Date 21Jan00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSW097             Date 02Dec99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CSW005  *CREATE    Date 01Aug96               *
      *                                                               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  MD045010 - Component LEC06A 10008 looping during COB caused  *
      *             by CGL184. Recompile due to changes in ZFRQB3.    *
      *  CGL184 - New Frequencies for Account Statements (Recompile)  *
      *  CIR018 - Daily Rate Change Frequency on SIRS                 *
      *  CIR017 - SIRS Business Day Conventions for both legs         *
      *  CLE064 - Enhancement of Lending Frequencies (Recompile)      *
      *  237750 - Update Effective Interest Rate in DEALSDG if for    *
      *           the first period (i.e. rate fixing for value date). *
      *  BUG11267 - Back-valued IRS deals do not correctly generate   *
      *             MT362 for the current interest period.            *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  227642 - Show short term rate if it was amended or back-     *
      *           valued deal newly inserted.  New values for RFIN:   *
      *           'A' when short term rate amended and base rate not  *
      *           yet picked up.  'B' when base rate fixed then short *
      *           term rate was amended.  'C' when base rate fixed,   *
      *           then short term rate amended and rate fixing taken. *
      *  226723 - Correctly print negative rates.                     *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CDL028 - Automatic Rate Interpolations (Recompile)           *
      *  CAS008 - IAS 39 Enhancements (Recompile)                     *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  TDA101 - After and Before image data structure (Z#AST        *
      *           and Z#BST) used in program is short FRA/IRS         *
      *           transaction.  (Recompile)                           *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  CAS005 - Enhancements to CAS001, CAS002 and CAS004           *
      *           (Recompile)                                         *
      *  217684 - Authorisation User Malfunction (Recompile)          *
      *  215359 - Rate refixing not picking up new rate.  Ensure that *
      *           the new base rate is picked up during rerun.        *
      *  CAS004 - Hedge Accounting Phase A (Recompile)                *
      *  205411 - Value Date is not being passed to AOOUFRUO          *
      *           causing a blank Value date in RSACMTPD.             *
      *  CIR008 - FRA/IRS Deals Authorisation                         *
      *  CIR007 - Overnight Index Swaps                               *
      *  CSD006 - Use long DS with SDBSRTPD and SDCURRPD.             *
      *  CIR003 - Principal Exchange on Cross Currencies IRS          *
      *  180466 - Change in program DLZFRQ. Additional parameter      *
      *           ZFRZBD inserted for DLZFRQ.                         *
      *  177837 - Identify properly the rate to be fixed.             *
      *  CIR005 - FRA/IRS Business Day Conventions                    *
      *  CSW097 - SWIFT97 changes to MT340s and MT360s.               *
      *  CSW005 - MG34n and MG36n message generation                  *
      *                                                               *
      *****************************************************************
      /EJECT
     FDLDLDGLJUF  E           K        DISK         KCOMIT
     FDLOLCFL1IF  E           K        DISK
     FDLDTSCPDIF  E           K        DISK
     FMGOREFL0IF  E           K        DISK
     FMGOMSGLXIF  E           K        DISK
     FDLINDHH O   E                    DISK
     FDLINDDM O   E                    DISK
     FDLINDZX O   E                    DISK
     FDL1924P1O   E                    PRINTER      KINFDS SPOOL1     UC
     FDL1924AUO   E                    PRINTER      KINFDS SPOOLU     UC
      *
     F/TITLE FUNCTION OF INDICATORS
      *****************************************************************
      *                                                               *
      *  F U N C T I O N    O F   I N D I C A T O R S                 *
      *                                                               *
      *   24  -  Used in LOKUP operation                              *
      *   25  -  Set on if CIR008 is on                               *                       CIR008
      *   40  -  Test Bit '0' of our non-static indicator (on if '0') *
      *   41  -  Test Bit '0' of their non-static indicator(on if '0')*
      *   42  -  Test Bit '1' of accounting entries indicator(on if 0)*
      *   50  -  Lokup on array COMB                                  *
      *   51  -  Record not found on MGOMSGLX                         *
      *   75  -  End of file DLDLDGLJ                                 *
      *   76  -  End of file DLOLCFL1                                 *
      *   77  -  End of file MGOREFL0                                 *
      *   98  -  Date Format: DDMMYY (off); MMDDYY (on)               *
      *                                                               *
      *                                                               *
      *****************************************************************
      /EJECT
      /TITLE Subroutine Index
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *                                                               *
      *   SRINLZ  -  Program Initialisation                           *
      *   SRBRCH  -  Access Branch Details                            *
      *   SRCUST  -  Access Customer Details                          *
      *   SRRFIX  -  Set Up our Base Rate Details                     *
      *   SRTFIX  -  Set Up Their Base Rate Details                   *
      *   SRCPFR  -  Calculate and Post FRA Settlement Amount         *
      *   SRCPSX  -  Calculate and Post IRS Settlement Amount         *
      *   SRCALC  -  Calculate Rate to Fix                            *
      *   SRPRTX  -  Pay/receivce Telex                               *
      *   SRSETL  -  Settlement Advice                                *
      *   SRFRDM  -  Rate Fix Advice                                  *
      *   SRUFRI  -  Check if forced refix is necessary               *
      *   SRUPDT  -  Subroutine to update DLDLDGLJ                    *
      *   SRUPDT  -  Check if force refixing necessary                *
      *   SRWRPT  -  FRA/IRS Rate Fix and Settlement Report           *
      *   SRWRTH  -  Write Report Heading                             *
      *   TLXNOT  -  Telex notice days processing                     *
      *   ZACCH   -  Access holiday for a ccy & (optionally) location *
      *   ZBKDT   -  Calculate nth working day back from a given start*
      *              date for a ccy and (optional) location           *
      *   ZEDIT   -  Insert dec. point and into numeric field and     *
      *              blank out leading zeroes                         *
      *   ZF2C    -  Calculate a number of working days forward in    *
      *              currencies                                       *
      *   ZFRPED  -  Insert decimal point and sign into a numeric     *
      *              field, blank out leading zeroes and (optionally) *
      *              to insert commas                                 *
      *   ZFWDT   -  Calculate a number of working days forward in a  *
      *              currency and (optional) location                 *
      *****************************************************************
      * ARRAYS CN AND TNDA CAN COPE WITH 450 CCY/NOSTRO ELEMENTS
      * IN THE UNLIKELY EVENT PGM CRASHES BECAUSE A BANK TRADES WITH
      * LOTS OF CCY'S OR NOSTROS THEN ENLARGE THIS ARRAY.
     E                    CN        450  5               * CCY/NOSTRO
     E                    TNDA      450  5 0             * TX NOTICE DATE
     E                    CPY@    1   1 80
      *
      ** Array containing Copyright statement
      *
     E                    COMB    1  10  9   FRFX    1
      *
      *  Message Event Type Combinations
      *
     E/COPY ZSRSRC,ZFRPEDZ1
     E/COPY ZSRSRC,ZEDITZ1
     E/COPY ZSRSRC,ZHOLE
     E/COPY ZSRSRC,ZF2CE
     E/COPY ZSRSRC,ZDATE2Z1                                               CIR005
     E/COPY ZSRSRC,ZFRQB2Z1                                               CIR005
      /SPACE 3
     IDEALSDGF
     I              RCDT                            DRCDT
     I              VDAT                            DVDAT
     I              TNLU                            DTNLU
     IDLDTSCD0
     I              DLNO                            DDLNO
     ILDA       E DSLDA                         256
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
      **                                    134 141 DBFILE
      **       Defines:                     142 170 DBKEY
      **                                    171 180 DBPGM
      **                                    181 1830DBASE
      *
     I              SPARE                           SPARE1
     IPSDS       SDS
      *
      ** Program Status Data Structure
      *
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
     ISPOOL1      DS
      *
      **   File Information Data Structure for DL1924P1.
      *
     I                                       83  92 SFILE1
     I                                    B 123 1240SFNUM1
     I                                    B 188 1890OFLLN1
     I                                    B 367 3680PRTLN1
      *
     ISPOOLU      DS
      *
      **  File Information Data Structure for DL1924AU.
      *
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
      ** Setup External Data Structure
      *
     ISDBANK    E DSSDBANKPD
      *
      ** SD Bank Details
      *
     ISDGELR    E DSSDGELRPD
      *
      ** SD General Ledger Details
      *
     ISCSARD    E DSSCSARDPD
      *
      ** SC Switchable Features Details
      *
     ISDBRCH    E DSSDBRCHPD
      *
      ** SD Branch Details
      *
     ISDCUST    E DSSDCUSTPD
     I              QQDFAC                          QQDFA1                                    CGL029
      *
      ** SD Customer Details
      *
     ISDBSRT    E DSSDBSRTPD
      *
      ** SD Base Rate Details
      *
     ISDCURR    E DSSDCURRPD
      *
      ** SD Currency Details
      *
     ISDNOST    E DSSDNOSTPD
     I              QQACCD                          QQACC1                                    CGL029
      *
      ** SD Nostro Details
      *
     IDSFDY     E DSDSFDY
      *
      ** Short Data Structure (1 - 200 char)
      *
     IDSSDY     E DSDSSDY
      *
      ** Long Data Structure  (201 - up char)
      *
     IIRDEAL    E DSDEALSDG
     I              LCD                             LCD1
     I              VDAT                            DVDAT                                     205411
     I                                     20632092 WCCYD1                CIR005
     I                                     21272156 WCCYD2                CIR005
      *
      ** FRA/IRS Deals Details
      *
     IZ#BSTS    E DSZ#BST
      *
      ** Projected Account Movement Details - Before Image
      *
     IZ#ASTS    E DSZ#AST
      *
     IZ#WSTS    E DSZ#WST                                                 CIR003
      ** holds 'before' status of value date settlement instructions      CIR003
      *                                                                   CIR003
     IZ#XSTS    E DSZ#XST                                                 CIR003
      ** holds 'before' status of maturity date settlement instructions   CIR003
      *                                                                   CIR003
     IZ#YSTS    E DSZ#YST                                                 CIR003
      ** holds 'after' status of value date settlement instructions       CIR003
      *                                                                   CIR003
     IZ#ZSTS    E DSZ#ZST                                                 CIR003
      ** holds 'after' status of maturity date settlement instructions    CIR003
      *                                                                   CIR003
     I            DS
     I                                        1  16 K#TRNO
     I                                        1   2 K#MODI
     I                                        3   80K#DLNO
     I                                        9  110K#SEQN
     I            DS
     I                                        1  16 TRNO
     I                                        3   80F#DLNO
     I            DS
     I                                        1  50 MFLD
     I                                        3  18 XTRNO
     IEVENT       DS                              9
     I                                        1   2 WEVTP1
     I                                        3   3 WMGSG1
     I                                        4   5 WEVTP2
     I                                        6   6 WMGSG2
     I                                        7   8 WEVTP3
     I                                        9   9 WMGSG3
      *
      ** Projected Account Movement Details - After Image
      *
     I              'Single Currency Swap'C         IRS
     I              'Cross Currency Swap 'C         IRX
      *
      ** Constant for Report Heading
      *
      /COPY ZSRSRC,ZFRPEDZ2
     I/COPY ZSRSRC,ZHOLI
     I/COPY ZSRSRC,ZF2CI
      *
      /EJECT
      /TITLE Main Processing
      *****************************************************************
      * P R O G R A M    S T A R T
      *****************************************************************
      *
      ** Accept Program Parameter
      *
     C           *ENTRY    PLIST
     C                     PARM           RERUN   1
      *
      ** Perform initial processing
      *
     C                     EXSR SRINLZ
      *
      ** Process all record in LF/DLDLDGLJ
      ** (All records in PF/DEALSDG with URFIN/TRFIN = 'P' or 'R')
      ** (or 'A' or 'B' )                                                                     227642
      *
     C                     READ DLDLDGLJ                 75
     C           *IN75     DOWEQ'0'
      *                                                                                       CIR008
      ** If deal status is not 'A'uthorised.  Add 1 to Unauthorised count field.              CIR008
      ** do not process the record.  Do this if CIR008 enhancement is on.                     CIR008
      *                                                                                       CIR008
     C           CIR008    IFEQ 'Y'                                                           CIR008
     C           FIDSTS    ANDNE'A'                                                           CIR008
     C                     ADD  1         UNRECD                                              CIR008
     C                     GOTO ULOIS                                                         CIR008
     C                     ENDIF                                                              CIR008
      *
     C/COPY WNCPYSRC,DL1924C001
      *                                                                                       CIR007
      ** If Deal is an OIS then do not do standard Input cycle                                CIR007
      ** settlement for FRA and IRS deals.                                                    CIR007
      *                                                                                       CIR007
     C           UICFR     IFEQ 'O'                                                           CIR007
     C           UNIPD     IFEQ BJRDNB                                                        CIR007
     C           MDAT      OREQ BJRDNB                                                        CIR007
     C                     GOTO ULOIS                                                         CIR007
     C                     ENDIF                                                              CIR007
     C                     ENDIF                                                              CIR007
      *                                                                                       CIR007
     C           TICFR     IFEQ 'O'                                                           CIR007
     C           TNIPD     IFEQ BJRDNB                                                        CIR007
     C           MDAT      OREQ BJRDNB                                                        CIR007
     C                     GOTO ULOIS                                                         CIR007
     C                     ENDIF                                                              CIR007
     C                     ENDIF                                                              CIR007
      *                                                                                       CIR007
     C                     MOVE 'Y'       NWBRCH  1
     C                     MOVE BRCA      SVBRCA  3
      *
      ** Access branch details and open new report file (DL1924P1)
      ** for this branch
      *
     C                     EXSR SRBRCH
      *
     C           SVBRCA    DOWEQBRCA
     C           *IN75     ANDEQ'0'
      *
      ** Set up saved fields
      *
     C                     EXSR SRSFLD
      *
      ** On Rerun and side processed is interest up-front and other side
      ** is forced-refixed, check further if forced-refixing is needed
      ** to avoid unnecessary messages from being created.
      *
     C           WUINPM    IFEQ 'DY'
     C           WTINPM    ANDEQ'DY'
      *
     C           RERUN     IFEQ 'Y'
     C           URFIN     ANDEQ'R'
     C           TFRRF     ANDEQ'Y'
      *
     C           RERUN     OREQ 'Y'
     C           TRFIN     ANDEQ'R'
     C           UFRRF     ANDEQ'Y'
      *
     C           RERUN     OREQ 'Y'
     C           DTYP      ANDEQ'RS'
     C           URFIN     ANDEQ'R'
     C           TRFIN     ANDEQ'R'
     C           UNIPD     ANDEQTNIPD
      *
     C                     EXSR SRUFRI
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Access Customer Details
      *
     C                     EXSR SRCUST
      *
      ** Set up workfield for our side fixing
      *
     C           WUSIDE    IFEQ 'Y'
     C                     EXSR SRRFIX
     C                     ENDIF
      *
      ** Set workfield for their side fixing
      *
     C           WTSIDE    IFEQ 'Y'
     C                     EXSR SRTFIX
     C                     ENDIF
      *
      ** Calculate and Post FRA settlement amount
      ** and Output Rate Fixing Record to PF/DLINDDM
      ** and Output Record to PRTF/DL1924P1
      *
     C           DTYP      IFEQ 'FR'
     C                     EXSR SRCPFR
     C                     EXSR SRRFDM
     C                     EXSR SRWRPT
     C                     ENDIF
      *
      ** Calculate and Post IRS settlement amount
      ** and Output Rate Fixing Record to PF/DLINDDM
      ** and Output Record to PRTF/DL1924P1
      *
     C           DTYP      IFEQ 'RS'
     C           DTYP      OREQ 'RX'
     C                     EXSR SRCPSX
     C                     EXSR SRRFDM
     C                     EXSR SRWRPT
     C                     ENDIF
      *
      **  Update rate fix indicator to 'F'
      *
     C                     EXSR SRURFI
      *
     C/COPY WNCPYSRC,DL1924C002
      *                                                                                       CIR007
      ** If Deal is an OIS, then do not do standard Input cycle                               CIR007
      ** settlement for FRA and IRS deals.                                                    CIR007
     C           ULOIS     TAG                                                                CIR007
      *                                                                                       CIR007
     C                     READ DLDLDGLJ                 75
      *
     C           DTYP      IFNE SVDTYP
     C                     MOVE 'Y'       NWDTYP  1
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** Output '*** END OF REPORT ***' for each branch
      *
     C           P1OPEN    IFEQ 'Y'
     C           RECCNT    ANDGT2
      *
     C           PRTLN1    IFGT 55
     C                     EXSR SRWRTH
     C                     ENDIF
     C                     WRITEENDRPT
      *
     C                     ENDIF
     C                     ENDDO
      *
      ** Write Record to Trailer File
      *
     C                     MOVE 'T'       RECI
     C                     Z-ADDRECCNT    NORE
     C                     WRITEDTRIEZZF
      *
     C                     COMIT
      *
     C           P1OPEN    IFEQ 'Y'
     C                     CLOSEDL1924P1
     C                     ENDIF
      *
      ** Output Audit Report and Terminate Program
      *
     C                     EXSR AUDIT
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRINLZ - Initial Processing                                   *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRINLZ    BEGSR
      *
      ** Set up copyright parameter
      *
     C                     MOVEACPY@      CPY2   80
      *
     C                     SETOF                     U7
      *
      **  Set up Local Data Area (LDA)
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVEL'DL1924'  DBPGM     P
     C                     MOVE *BLANKS   DBASE
     C                     OUT  LDA
      *
      ** Access Bank Details
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD001       DBASE            ***************
     C                     MOVEL'SDBANKPD'DBFILE           *DB ERROR 001 *
     C                     MOVEL'*FIRST  'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      **  Set on *IN98 according to date format
      *
     C           BJDFIN    IFEQ 'D'
     C                     MOVE *OFF      *IN98
     C                     ELSE
     C                     MOVE *ON       *IN98
     C                     ENDIF
      *
      ** Access General Ledger details
      *
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST  '@OPTN   7
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD002       DBASE            ***************
     C                     MOVEL'SDGELRPD'DBFILE           *DB ERROR 002 *
     C                     MOVEL'*FIRST  'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      **   RCF Processing for Audit File.
      *
     C                     EXSR RCFAU
      *
      ** Access switchable feature details
      *
     C                     MOVE 'N'       CIR001  1
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY '@OPTN   7
     C                     PARM 'CIR001'  @SRAD   6
     C           SCSARD    PARM SCSARD    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           @RTCD     ANDNE'*NRF'
     C           *LOCK     IN   LDA
     C                     Z-ADD003       DBASE            ***************
     C                     MOVEL'SCSARDPD'DBFILE           *DB ERROR 003 *
     C                     MOVEL'CIR001  'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           @RTCD     IFEQ *BLANK
     C                     MOVE 'Y'       CIR001
     C                     ENDIF
     C/COPY WNCPYSRC,DL1924C003
      *                                                                   CSW097
     C                     MOVE 'N'       CSW005  1                       CSW097
      *                                                                   CSW097
     C                     CALL 'AOSARDR0'                                CSW097
     C                     PARM *BLANKS   @RTCD   7                       CSW097
     C                     PARM '*VERIFY '@OPTN   7                       CSW097
     C                     PARM 'CSW005'  @SRAD   6                       CSW097
     C           SCSARD    PARM SCSARD    DSFDY                           CSW097
      *                                                                   CSW097
     C           @RTCD     IFNE *BLANK                                    CSW097
     C           @RTCD     ANDNE'*NRF'                                    CSW097
     C           *LOCK     IN   LDA                                       CSW097
     C                     Z-ADD003       DBASE            ***************CSW097
     C                     MOVEL'SCSARDPD'DBFILE           *DB ERROR 003 *CSW097
     C                     MOVEL'CSW005  'DBKEY            ***************CSW097
     C                     OUT  LDA                                       CSW097
     C                     EXSR *PSSR                                     CSW097
     C                     ENDIF                                          CSW097
      *                                                                   CSW097
     C           @RTCD     IFEQ *BLANK                                    CSW097
     C                     MOVE 'Y'       CSW005                          CSW097
     C                     ENDIF                                          CSW097
      *                                                                   CIR005
      ** Access Switchable Features if CIR005 is installed                CIR005
      *                                                                   CIR005
     C                     MOVE 'N'       CIR005  1                       CIR005
     C                     CALL 'AOSARDR0'                                CIR005
     C                     PARM *BLANKS   PRTCD   7                       CIR005
     C                     PARM '*VERIFY 'POPTN   7                       CIR005
     C                     PARM 'CIR005'  PSARD   6                       CIR005
     C           SCSARD    PARM SCSARD    DSFDY                           CIR005
      *                                                                   CIR005
     C           PRTCD     IFNE *BLANK                                    CIR005
     C           PRTCD     ANDNE'*NRF'                                    CIR005
     C           *LOCK     IN   LDA                                       CIR005
     C                     Z-ADD25        DBASE            ***************CIR005
     C                     MOVEL'SCSARDPD'DBFILE           *DB ERROR 025 *CIR005
     C                     MOVEL'CIR005  'DBKEY            ***************CIR005
     C                     OUT  LDA                                       CIR005
     C                     EXSR *PSSR                                     CIR005
     C                     ENDIF                                          CIR005
      *                                                                   CIR005
     C           PRTCD     IFEQ *BLANK                                    CIR005
     C                     MOVE 'Y'       CIR005                          CIR005
     C                     ENDIF                                          CIR005
      *                                                                                       CIR008
      ** Access Switchable Features if CIR008 is installed                                    CIR008
      *                                                                                       CIR008
     C                     MOVE 'N'       CIR008  1                                           CIR008
     C                     MOVE '0'       *IN25                                               CIR008
     C                     CALL 'AOSARDR0'                                                    CIR008
     C                     PARM *BLANKS   PRTCD                                               CIR008
     C                     PARM '*VERIFY 'POPTN                                               CIR008
     C                     PARM 'CIR008'  PSARD                                               CIR008
     C           SCSARD    PARM SCSARD    DSFDY                                               CIR008
      *                                                                                       CIR008
     C           PRTCD     IFNE *BLANK                                                        CIR008
     C           PRTCD     ANDNE'*NRF'                                                        CIR008
     C           *LOCK     IN   LDA                                                           CIR008
     C                     Z-ADD26        DBASE                                               CIR008
     C                     MOVEL'SCSARDPD'DBFILE                                              CIR008
     C                     MOVEL'CIR008  'DBKEY                                               CIR008
     C                     OUT  LDA                                                           CIR008
     C                     EXSR *PSSR                                                         CIR008
     C                     ENDIF                                                              CIR008
      *                                                                                       CIR008
     C           PRTCD     IFEQ *BLANK                                                        CIR008
     C                     MOVE 'Y'       CIR008                                              CIR008
     C                     MOVE '1'       *IN25                                               CIR008
     C                     ENDIF                                                              CIR008
      *
      ** Check if CIR017 - Separate Business Day Convention for SIRS                          CIR017
     C                     CALL 'AOSARDR0'                                                    CIR017
     C                     PARM *BLANKS   PRTCD                                               CIR017
     C                     PARM '*VERIFY' POPTN                                               CIR017
     C                     PARM 'CIR017'  PSARD                                               CIR017
     C           SCSARD    PARM SCSARD    DSFDY                                               CIR017
      **                                                                                      CIR017
     C           PRTCD     IFEQ *BLANKS                                                       CIR017
     C                     MOVE 'Y'       CIR017  1                                           CIR017
     C                     ELSE                                                               CIR017
     C                     MOVE 'N'       CIR017                                              CIR017
     C                     ENDIF                                                              CIR017
      *                                                                                       CIR017
      ** Check if CIR018 - Daily Rate Change Frequency on SIRS                                CIR018
     C                     CALL 'AOSARDR0'                                                    CIR018
     C                     PARM *BLANKS   PRTCD                                               CIR018
     C                     PARM '*VERIFY' POPTN                                               CIR018
     C                     PARM 'CIR018'  PSARD                                               CIR018
     C           SCSARD    PARM SCSARD    DSFDY                                               CIR018
      **                                                                                      CIR018
     C           PRTCD     IFEQ *BLANKS                                                       CIR018
     C                     MOVE 'Y'       CIR018  1                                           CIR018
     C                     ELSE                                                               CIR018
     C                     MOVE 'N'       CIR018                                              CIR018
     C                     ENDIF                                                              CIR018
      *                                                                                       CIR018
      ** Workfields Definition (used by SRCALC)
      *
     C           *LIKE     DEFN UBRTT     WBRTT
     C           *LIKE     DEFN UCUCY     WCUCY
     C           *LIKE     DEFN UINFD     WINFD
     C           *LIKE     DEFN USPIN     WSPIN
     C           *LIKE     DEFN URTSP     WRTSP
     C           *LIKE     DEFN URTSP     WFXRT
     C           *LIKE     DEFN URTSP     WBSRT
     C           *LIKE     DEFN UEINR     WEINR                           CSW097
      *
     C           *LIKE     DEFN URTSP     WUFXRT
     C           *LIKE     DEFN UBRTE     WUBRTE
     C           *LIKE     DEFN URTSP     WTFXRT
     C           *LIKE     DEFN TBRTE     WTBRTE
     C                     MOVE *BLANK    WPRIN   1
      *
     C                     MOVE *BLANK    WUSIDE  1
     C                     MOVE *BLANK    WTSIDE  1
     C                     MOVE *BLANK    VLDDTA  1
     C                     MOVE *BLANK    P1OPEN  1
      *
     C           @KOLCF    KLIST
     C                     KFLD           BEAFIN  1
     C                     KFLD           DLNO
     C                     KFLD           @KOTIN  1
      *                                                                   CSW097
     C           KOLCFD    KLIST                                          CSW097
     C                     KFLD           BEAFIN  1                       CSW097
     C                     KFLD           DLNO                            CSW097
     C                     KFLD           @KOTIN  1                       CSW097
     C                     KFLD           CFPYDT                          CSW097
      *
     C           @KEYDG    KLIST
     C                     KFLD           BRCA
     C                     KFLD           DTYP
     C                     KFLD           DLNO
      *
     C           KIRSTL    KLIST
     C                     KFLD           DLNO
     C                     KFLD           OTIN
     C                     KFLD           RCIP
     C                     KFLD           PRDT
      *
     C           KIRSTP    KLIST
     C                     KFLD           DLNO
     C                     KFLD           OTIN
     C                     KFLD           RCIP
      *
      ** Write record to header file (DLINDHH)
      *
     C                     MOVE 'H'       RECI
     C                     MOVE *ZERO     DLNO
     C                     WRITEDTRIEHHF
      *
      ** Initialise work field for trailer file (DLINDZX)
      *
     C                     Z-ADD2         RECCNT  50
      *                                                                                       CIR008
      ** Initialise work field for unauthorised record count                                  CIR008
      *                                                                                       CIR008
     C                     Z-ADD0         UNRECD  50                                          CIR008
      *
      ** SET UP VARIABLES USED BY SR/TLXNOT
     C                     Z-ADD1         Y       30
     C                     MOVE BJLCCY    ZCCY2
     C                     MOVE BJSLCD    ZLOC2
     C*
      ** OBTAIN TELEX NOTICE DATE FOR LOCAL CCY/SYSTEM LOCATION
      ** (CANNOT USE SR/TLXNOT B'COS IT IS FOR 2 CCYS/LOCNS)
     C                     MOVE BJLCCY    ZCCY
     C                     MOVE BJSLCD    ZLOC
     C                     Z-ADDBJRDNB    ZDAYNO
      *
      ** read currencies file for telex notice days
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           ZCCY
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** if database error
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD023       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           *DB ERROR 023 *
     C                     MOVELZCCY      DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVE A6TXND    ZNRDYS
      *
     C                     EXSR ZFWDT
      *
      ** STORE RESULT
     C                     Z-ADDZDYNBR    TNDAL   50
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRSFLD - Store input field to save field                      *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRSFLD    BEGSR
      *
     C                     MOVE *BLANKS   NOFREF  1
     C                     MOVE *BLANKS   WSPRT   1
     C                     MOVE *BLANKS   WUSIDE  1
     C                     MOVE *BLANKS   WTSIDE  1
     C                     MOVE *BLANKS   WUINPM  2
     C                     MOVE *BLANKS   WTINPM  2
     C                     MOVE *BLANKS   WPRIN
     C                     MOVE *BLANKS   WPRIN1
      *
     C           URFIN     IFEQ 'P'
     C           RERUN     ANDNE'Y'
     C           URFIN     OREQ 'R'
     C           RERUN     ANDEQ'Y'
     C           URFIN     OREQ 'A'                                                           227642
     C           RERUN     ANDEQ'Y'                                                           227642
     C           URFIN     OREQ 'B'                                                           227642
     C           RERUN     ANDEQ'Y'                                                           227642
     C                     MOVE 'Y'       WUSIDE
     C                     ENDIF
      *
     C           TRFIN     IFEQ 'P'
     C           RERUN     ANDNE'Y'
     C           TRFIN     OREQ 'R'
     C           RERUN     ANDEQ'Y'
     C           TRFIN     OREQ 'A'                                                           227642
     C           RERUN     ANDEQ'Y'                                                           227642
     C           TRFIN     OREQ 'B'                                                           227642
     C           RERUN     ANDEQ'Y'                                                           227642
     C                     MOVE 'Y'       WTSIDE
     C                     ENDIF
      *
     C           UINPM     IFEQ 'D'
     C           UINPM     OREQ 'Y'
     C                     MOVE 'DY'      WUINPM
     C                     ENDIF
      *
     C           TINPM     IFEQ 'D'
     C           TINPM     OREQ 'Y'
     C                     MOVE 'DY'      WTINPM
     C                     ENDIF
      *
     C                     TESTB'0'       UDNSI      40
     C                     TESTB'0'       TDNSI      41
     C                     TESTB'1'       ACEI       42
     C                     TESTB'2'       UDNSI          46                                   227642
     C                     TESTB'2'       TDNSI          47                                   227642
      *
      ** Note: Indicators 40, 41 & 42 is *ON
      **       if the bit being tested is *OFF
      *
     C                     MOVE URFIN     SVRFIN  1
     C                     MOVE TRFIN     SVTFIN  1
     C                     MOVE DTYP      SVDTYP  2
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRBRCH - Access Branch Details                                *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: *PSSR                                                  *
      *                                                               *
      *****************************************************************
     C           SRBRCH    BEGSR
      *
      ** Access Branch Details
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY    '@OPTN   7
     C                     PARM           SVBRCA
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD004       DBASE            ***************
     C                     MOVEL'SDBRCHPD'DBFILE           *DB ERROR 004 *
     C                     MOVELSVBRCA    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Open and Close DL1924P1 to generate new report for each branch
      *
     C           P1OPEN    IFEQ 'Y'
     C                     CLOSEDL1924P1
     C                     MOVE 'N'       P1OPEN
     C                     ENDIF
      *
     C           P1OPEN    IFNE 'Y'
     C                     OPEN DL1924P1
     C                     MOVE 'Y'       P1OPEN
     C                     ENDIF
      *
      ***  Ensure Report Spool File is recorded by RCF.
      *
     C                     Z-ADDSFNUM1    ZSNUM   60
      *
     C                     CALL 'ZSFILE'
     C                     PARM *BLANKS   SEQ     5
     C                     PARM SVBRCA    SENTY   3
     C                     PARM           SFILE1
     C                     PARM           ZSNUM
     C                     PARM           ZSERR   1
      *
      ** If Error occurs during ZSFILE processing, then return to the
      ** Calling Program.
      *
     C           ZSERR     IFEQ 'Y'
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRCUST - Access Customer Details                              *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: *PSSR                                                  *
      *                                                               *
      *****************************************************************
     C           SRCUST    BEGSR
      *
     C                     MOVE CNUM      CNUMA   6
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY    '@OPTN   7
     C                     PARM CNUMA     @KEY1   6
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD005       DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           *DB ERROR 005 *
     C                     MOVELCNUMA     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRRFIX - Set up our base rate details                         *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: SRCALC                                                 *
      *                                                               *
      *****************************************************************
     C           SRRFIX    BEGSR
      *
      ** Workfields Initialisation
      *
     C                     Z-ADDUBRTT     WBRTT
     C                     MOVE UCUCY     WCUCY
     C                     Z-ADDUINFD     WINFD
     C                     MOVE USPIN     WSPIN
     C                     Z-ADDURTSP     WRTSP
     C                     Z-ADD*ZERO     WFXRT
     C                     Z-ADD*ZERO     WBSRT
     C                     Z-ADDUEINR     WEINR                           CSW097
     C                     MOVE UDNSI     WDNSI   1                       CSW097
     C                     MOVE URFIN     WRFIN   1                                           227642
      *
      ** Calculate rate to fix
      *
     C                     EXSR SRCALC
      *
     C                     Z-ADDWFXRT     WUFXRT
     C                     Z-ADDWBSRT     WUBRTE
      *
     C           TFRRF     IFEQ 'Y'
      *
     C                     Z-ADDTBRTE     WBSRT
     C                     MOVE TSPIN     WSPIN
     C                     Z-ADDTRTSP     WRTSP
     C                     MOVE TRFIN     WRFIN                                               227642
     C                     EXSR SRCALC
     C                     Z-ADDWFXRT     WTFXRT
      *
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRTFIX - Set up their base rate details                       *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: SRCALC                                                 *
      *                                                               *
      *****************************************************************
     C           SRTFIX    BEGSR
      *
      ** Workfields Initialisation
      *
     C                     Z-ADDTBRTT     WBRTT
     C                     MOVE TCUCY     WCUCY
     C                     Z-ADDTINFD     WINFD
     C                     MOVE TSPIN     WSPIN
     C                     Z-ADDTRTSP     WRTSP
     C                     Z-ADD*ZERO     WFXRT
     C                     Z-ADD*ZERO     WBSRT
     C                     Z-ADDTEINR     WEINR                           CSW097
     C                     MOVE TDNSI     WDNSI                           CSW097
     C                     MOVE TRFIN     WRFIN                                               227642
      *
      ** Calculate rate to fix
      *
     C                     EXSR SRCALC
      *
     C                     Z-ADDWFXRT     WTFXRT
     C                     Z-ADDWBSRT     WTBRTE
      *
     C           UFRRF     IFEQ 'Y'
      *
     C                     Z-ADDUBRTE     WBSRT
     C                     MOVE USPIN     WSPIN
     C                     Z-ADDURTSP     WRTSP
     C                     MOVE URFIN     WRFIN                                               227642
     C                     EXSR SRCALC
     C                     Z-ADDWFXRT     WUFXRT
      *
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRCPFR - Calculate and Post FRA Settlement Amount             *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: DLZFRS                                                 *
      *        AOOUFRU0                                               *
      *        SRPRTX                                                 *
      *        SRSETL                                                 *
      *        SRUPDT                                                 *
      *                                                               *
      *****************************************************************
     C           SRCPFR    BEGSR
      *
     C           RERUN     IFEQ 'Y'
     C                     MOVELIRDEAL    Z#BSTS    P
     C                     ELSE
     C                     MOVEL*BLANKS   Z#BSTS    P
     C                     ENDIF
      *
     C                     Z-ADD*ZERO     STAMTB 130
      *
      ** Set up parameters for DLZFRS to determine settlement amount
      *
     C                     Z-ADDDVDAT     P#VDAT  50
     C                     Z-ADDMDAT      P#MDAT  50
     C                     MOVE SETF      P#SETF  1
     C                     MOVE TAXI      P#TAXI  1
      *
     C           BYSL      IFEQ 'B'
     C           UEINR     IFGT WTFXRT
     C           UAIAN     SUB  TAIAN     P#IANP 130
     C                     MOVE 'P'       P#PYIN  1
     C                     ELSE
     C           TAIAN     SUB  UAIAN     P#IANP
     C                     MOVE 'R'       P#PYIN
     C                     ENDIF
     C                     ELSE
     C           TEINR     IFGT WUFXRT
     C           TAIAN     SUB  UAIAN     P#IANP
     C                     MOVE 'R'       P#PYIN
     C                     ELSE
     C           UAIAN     SUB  TAIAN     P#IANP
     C                     MOVE 'P'       P#PYIN
     C                     ENDIF
     C                     ENDIF
      *
     C           UBRTT     IFNE *ZERO
     C                     Z-ADDUPAMT     P#PAMT 130
     C                     Z-ADDUICBS     P#ICBS  10
     C                     Z-ADDWUFXRT    P#RFLT 117
     C                     Z-ADDTEINR     P#RFIX 117
     C                     ELSE
     C                     Z-ADDTPAMT     P#PAMT
     C                     Z-ADDTICBS     P#ICBS
     C                     Z-ADDWTFXRT    P#RFLT
     C                     Z-ADDUEINR     P#RFIX
     C                     ENDIF
      *
     C                     CALL 'DLZFRS'
     C                     PARM           P#VDAT  50
     C                     PARM           P#MDAT  50
     C                     PARM           P#PAMT 130
     C                     PARM           P#IANP 130
     C                     PARM           P#ICBS  10
     C                     PARM           P#SETF  1
     C                     PARM           P#RFLT 117
     C                     PARM           P#RFIX 117
     C                     PARM           P#PYIN  1
     C                     PARM           P#TAXI  1
     C                     PARM           O#NETA 130
     C                     PARM           O#TAXA 130
     C                     PARM           O#RETC  7
      *
      ** If error occurs in DLZFRS
      *
     C           O#RETC    IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD017       DBASE            ***************
     C                     MOVEL'DLZFRS  'DBFILE           *DB ERROR 017 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           O#NETA    IFEQ *ZERO
     C                     MOVE *BLANK    WPRIN   1
     C                     ELSE
     C                     MOVE P#PYIN    WPRIN   1
     C                     ENDIF
      *
     C           WPRIN     IFEQ 'P'
     C                     Z-ADDO#NETA    WUSAMT 130
     C                     Z-ADD*ZERO     WTSAMT 130
     C                     Z-ADDO#TAXA    WTAXAP 130
     C                     ENDIF
      *
     C           WPRIN     IFEQ 'R'
     C                     Z-ADD*ZERO     WUSAMT
     C                     Z-ADDO#NETA    WTSAMT
     C                     Z-ADD*ZERO     WTAXAP
     C                     ENDIF
      *
     C           RERUN     IFNE 'Y'
     C           URFIN     ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           URFIN     ANDEQ'R'
     C                     Z-ADDWUFXRT    UEINR
     C                     Z-ADDWUBRTE    UBRTE
     C                     MOVE 'F'       URFIN
     C                     ENDIF
      *
     C           RERUN     IFNE 'Y'
     C           TRFIN     ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           TRFIN     ANDEQ'R'
     C                     Z-ADDWTFXRT    TEINR
     C                     Z-ADDWTBRTE    TBRTE
     C                     MOVE 'F'       TRFIN
     C                     ENDIF
      *
      ** Set up parameters for AOOUFRU0
      *
     C                     MOVELIRDEAL    Z#ASTS
     C                     Z-ADD*ZERO     STAMTB 130
     C                     Z-ADDO#NETA    STAMTA 130
      *
     C                     CALL 'AOOUFRU0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM           Z#BSTS
     C                     PARM           Z#ASTS
     C                     PARM           STAMTB
     C                     PARM           STAMTA
      *
      ** If error occurs in DLZFRS
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD018       DBASE            ***************
     C                     MOVEL'AOOUFRU0'DBFILE           *DB ERROR 018 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C/COPY WNCPYSRC,DL1924C004
      *
      ** Output Pay/Recieve Telex and Settlement record to
      ** PF/DLINDDM only if Pay/Receive Indicator Workfield
      ** is not blank.
      *
     C           WPRIN     IFNE *BLANK
     C                     EXSR SRPRTX
     C                     EXSR SRSETL
     C                     ENDIF
      *
      ** Update record in DEALSDG
      *
     C                     EXSR SRUPDT
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRCPSX - Calculate and post IRS settlement amount             *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: DL2900                                                 *
      *        AOOUSWU0                                               *
      *        SRPRTX                                                 *
      *        SRSETL                                                 *
      *        SRUPDT                                                 *
      *****************************************************************
     C           SRCPSX    BEGSR
      *
     C                     Z-ADD*ZERO     WTSAMT 130
     C                     Z-ADD*ZERO     WUSAMT 130
     C                     Z-ADD*ZERO     WUPEIR 117
     C                     Z-ADD*ZERO     WTPEIR 117
     C                     Z-ADD*ZERO     WUNRCD  50
     C                     Z-ADD*ZERO     WTNRCD  50
      *
      ** If settling interest up-front, create before image of cash
      ** flow details (Our/Their Int. Processing Method = 'D' or 'Y')
      *
     C           CIR001    IFEQ 'Y'
     C           WUSIDE    ANDEQ'Y'
     C           WUINPM    ANDEQ'DY'
      *
     C           CIR001    OREQ 'Y'
     C           WTSIDE    ANDEQ'Y'
     C           WTINPM    ANDEQ'DY'
      *
     C                     MOVELIRDEAL    Z#BSTS
     C                     MOVE *BLANKS   PRTCD   7
     C                     MOVE DLNO      PDLNO   6
     C                     MOVE 'B'       PBEAF   1
     C                     CALL 'DL2900'
     C                     PARM           PRTCD
     C                     PARM           PDLNO
     C                     PARM           PBEAF
      *
      ** If error occurs in DL2900
      *
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD019       DBASE            ***************
     C                     MOVEL'DL2900  'DBFILE           *DB ERROR 019 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Set up PF/DEALSDG fields (Our Side) for later update
      *
     C           WUSIDE    IFEQ 'Y'
     C           WUINPM    ANDEQ'DY'
      *
     C                     Z-ADDWUBRTE    UBRTE
     C                     Z-ADDUEINR     WUPEIR
      *
     C           UFRFD     IFEQ *ZERO
     C           DVDAT     ORGE BJRDNB
     C                     Z-ADDWUFXRT    UEINR
     C                     ENDIF
      *
     C           *IN40     IFEQ '1'
     C                     Z-ADDWUBRTE    UOBRT
     C                     BITON'0'       UDNSI
     C                     ENDIF
      *
     C                     BITON'4'       CNFI
      *
      **  If Value date has not  been processed yet...
      *
     C           CIR001    IFEQ 'Y'
     C           WUINPM    ANDEQ'DY'
     C           *IN42     ANDEQ'1'
     C*
     C                     Z-ADDDVDAT     WUNRCD
     C*
     C**  Find the next rate change date if before rundate
     C*
     C           WUNRCD    IFLE BJRDNB
     C                     MOVEL'U'       OTIN
     C                     MOVEL'R'       RCIP
     C                     Z-ADDWUNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WUNRCD
     C*
     C** Go on while not after run date
     C*
     C           WUNRCD    DOWLEBJRDNB
     C                     Z-ADDWUNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WUNRCD
     C                     ENDDO
     C*
     C                     ENDIF
     C*
     C                     ELSE
     C                     Z-ADDUNICD     WUNRCD  50
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Set up PF/DEALSDG fields (Their Side) for later update
      *
     C           WTSIDE    IFEQ 'Y'
     C           WTINPM    ANDEQ'DY'
      *
     C                     Z-ADDWTBRTE    TBRTE
     C                     Z-ADDTEINR     WTPEIR
     C           TFRFD     IFEQ *ZERO
     C           DVDAT     ORGE BJRDNB
     C                     Z-ADDWTFXRT    TEINR
     C                     ENDIF
      *
     C           *IN41     IFEQ '1'
     C                     Z-ADDWTBRTE    TOBRT
     C                     BITON'0'       TDNSI
     C                     ENDIF
      *
     C                     BITON'5'       CNFI
      *
     C           CIR001    IFEQ 'Y'
     C           WTINPM    ANDEQ'DY'
     C           *IN42     ANDEQ'1'
     C*
     C                     Z-ADDDVDAT     WTNRCD
     C*
     C                     MOVEL'T'       OTIN
     C                     MOVEL'R'       RCIP
     C                     Z-ADDWTNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WTNRCD
     C*
     C** Go on while not after run date
     C*
     C           WTNRCD    DOWLEBJRDNB
     C                     Z-ADDWTNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WTNRCD
     C                     END
     C*
     C                     ELSE
     C                     Z-ADDTNICD     WTNRCD
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     MOVE *BLANK    WPRIN
      *
      ** Update PF/DEALSDG
      *
     C                     UPDATDEALSDGF
      *
      ** If settling interest up-front, create after image of cash
      ** flow details (Our/Their Int. Processing Method = 'D' or 'Y')
      *
     C                     MOVELIRDEAL    Z#ASTS
      *
     C                     MOVE DLNO      PDLNO   6
     C                     CALL 'DL2900'
     C                     PARM *BLANKS   PRTCD
     C                     PARM           PDLNO
     C                     PARM 'A'       PBEAF
      *
      ** If error occurs in DL2900
      *
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD020       DBASE            ***************
     C                     MOVEL'DL2900  'DBFILE           *DB ERROR 020 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Update IRS position file
      *
     C                     CALL 'AOOUSWU0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM           Z#BSTS
     C                     PARM           Z#ASTS
     C                     PARM           Z#WSTS                          CIR003
     C                     PARM           Z#XSTS                          CIR003
     C                     PARM           Z#YSTS                          CIR003
     C                     PARM           Z#ZSTS                          CIR003
      *
      ** If error occurs in AOOUSWU0
      *
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD021       DBASE            ***************
     C                     MOVEL'AOOUSWU0'DBFILE           *DB ERROR 021 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C/COPY WNCPYSRC,DL1924C005
      *
      ** Retrieve 'OUR' details from just created 'after image' on
      ** line cash flow activity
      *
     C                     Z-ADD*ZERO     WUPYDT  50
     C                     Z-ADD*ZERO     WTAXAP 130
     C                     Z-ADD*ZERO     WTPYDT  50                      CSW097
      *
     C           WUSIDE    IFEQ 'Y'
     C           WUINPM    ANDEQ'DY'
      *
     C           RERUN     OREQ 'Y'
     C           WUINPM    ANDEQ'DY'
     C           UFRRF     ANDEQ'Y'
      *
     C***********UBRTT     OREQ 0                                         CSW097
     C***********DTYP      ANDEQ'RS'                                      CSW097
     C***********WTNRCD    ANDEQVDAT                                      CSW097
     C***********UBRTT     OREQ 0                                         CSW097
     C***********DTYP      ANDEQ'RS'                                      CSW097
     C***********WTNRCD    ANDNEVDAT                                      CSW097
     C***********TNIPD     ANDEQUNIPD                                     CSW097
      *
     C                     MOVE 'A'       BEAFIN
     C                     MOVE 'U'       @KOTIN
     C           @KOLCF    CHAINDLOLCFL1             76
     C           *IN76     DOWEQ'0'
     C           CFPYDT    ANDLTBJRDNB
     C           @KOLCF    READEDLOLCFL1                 76
     C                     END
     C           *IN76     IFEQ '0'
     C           CFAMNT    ANDNE*ZERO
     C                     Z-ADDCFPYDT    WUPYDT
     C                     Z-ADDCFAMNT    WUSAMT
     C                     Z-ADDCFTAXA    WTAXAP
     C** For the other side, check for existing payments for the same     CSW097
     C** date.                                                            CSW097
     C           TBRTT     IFEQ 0                                         CSW097
     C                     MOVE 'T'       @KOTIN                          CSW097
     C           KOLCFD    CHAINDLOLCFL1             76                   CSW097
     C           *IN76     IFEQ *OFF                                      CSW097
     C                     Z-ADDCFPYDT    WTPYDT                          CSW097
     C                     Z-ADDCFAMNT    WTSAMT                          CSW097
     C                     ENDIF                                          CSW097
     C                     ENDIF                                          CSW097
     C                     ENDIF
     C                     ENDIF
      *
      ** Retrieve 'THEIR' details from just created 'after image' on
      ** line cash flow activity
      *
     C***********          Z-ADD*ZERO     WTPYDT  50                      CSW097
      *
     C           WTSIDE    IFEQ 'Y'
     C           WTINPM    ANDEQ'DY'
      *
     C           RERUN     OREQ 'Y'
     C           WTINPM    ANDEQ'DY'
     C           TFRRF     ANDEQ'Y'
      *
     C***********TBRTT     OREQ 0                                         CSW097
     C***********DTYP      ANDEQ'RS'                                      CSW097
     C***********WUNRCD    ANDEQVDAT                                      CSW097
     C***********TBRTT     OREQ 0                                         CSW097
     C***********DTYP      ANDEQ'RS'                                      CSW097
     C***********WUNRCD    ANDNEVDAT                                      CSW097
     C***********UNIPD     ANDEQTNIPD                                     CSW097
      *
     C                     MOVE 'A'       BEAFIN
     C                     MOVE 'T'       @KOTIN
     C           @KOLCF    CHAINDLOLCFL1             76
     C           *IN76     DOWEQ'0'
     C           CFPYDT    ANDLTBJRDNB
     C           @KOLCF    READEDLOLCFL1                 76
     C                     END
     C           *IN76     IFEQ '0'
     C           CFAMNT    ANDNE*ZERO
     C                     Z-ADDCFPYDT    WTPYDT
     C                     Z-ADDCFAMNT    WTSAMT
     C** For the other side, check for existing payments for the same     CSW097
     C** date.                                                            CSW097
     C           UBRTT     IFEQ 0                                         CSW097
     C                     MOVE 'U'       @KOTIN                          CSW097
     C           KOLCFD    CHAINDLOLCFL1             76                   CSW097
     C           *IN76     IFEQ *OFF                                      CSW097
     C                     Z-ADDCFPYDT    WUPYDT                          CSW097
     C                     Z-ADDCFAMNT    WUSAMT                          CSW097
     C                     Z-ADDCFTAXA    WTAXAP                          CSW097
     C                     ENDIF                                          CSW097
     C                     ENDIF                                          CSW097
     C                     ENDIF
     C                     ENDIF
      *
      ** Update 'Our Side'
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           SVTFIN    ANDNE'P'
     C           WUPYDT    ANDNE*ZERO
     C           WUINPM    ANDEQ'DY'
      *
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           SVTFIN    ANDNE'R'
     C           WUPYDT    ANDNE*ZERO
     C           WUINPM    ANDEQ'DY'
      *
     C           RERUN     ORNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           SVTFIN    ANDEQ'P'
     C           WUPYDT    ANDNE*ZERO
     C           WUINPM    ANDEQ'DY'
     C           WTINPM    ANDNE'DY'
      *
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           SVTFIN    ANDEQ'R'
     C           WUPYDT    ANDNE*ZERO
     C           WUINPM    ANDEQ'DY'
     C           WTINPM    ANDNE'DY'
      *
     C           TFRRF     IFEQ 'Y'
     C           WUPYDT    ANDEQWTPYDT
      *
     C***********DTYP      OREQ 'RS'                                      CSW097
     C***********TBRTT     ANDEQ0                                         CSW097
     C           TBRTT     OREQ 0                                         CSW097
     C           WUPYDT    ANDEQWTPYDT
     C                     MOVE 'B'       WPRIN
     C                     ELSE
     C                     MOVE 'P'       WPRIN
     C                     ENDIF
      *
      ** 1. Output record to PF/DLINDDM
      **    a. Pay/Receive Telex (SRPRTX)
      **    b. Settlement (SRSETL)
      ** 2. Update PF/DEALSDG (SRUPDT)
      *
     C           WPRIN     IFNE *BLANK
     C                     EXSR SRPRTX
     C                     EXSR SRSETL
     C                     ENDIF
      *
     C                     EXSR SRUPDT
      *
     C                     ENDIF
      *
      ** Update 'Their Side'
      *
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           SVRFIN    ANDNE'P'
     C           WTPYDT    ANDNE*ZERO
     C           WTINPM    ANDEQ'DY'
      *
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C           SVRFIN    ANDNE'R'
     C           WTPYDT    ANDNE*ZERO
     C           WTINPM    ANDEQ'DY'
      *
     C           RERUN     ORNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           SVRFIN    ANDEQ'P'
     C           WTPYDT    ANDNE*ZERO
     C           WTINPM    ANDEQ'DY'
     C           WUINPM    ANDNE'DY'
      *
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C           SVRFIN    ANDEQ'R'
     C           WTPYDT    ANDNE*ZERO
     C           WTINPM    ANDEQ'DY'
     C           WUINPM    ANDNE'DY'
      *
     C           UFRRF     IFEQ 'Y'
     C           WTPYDT    ANDEQWUPYDT
      *
     C***********DTYP      OREQ 'RS'                                      CSW097
     C***********UBRTT     ANDEQ0                                         CSW097
     C           UBRTT     OREQ 0                                         CSW097
     C           WTPYDT    ANDEQWUPYDT
     C                     MOVE 'B'       WPRIN
     C                     ELSE
     C                     MOVE 'R'       WPRIN
     C                     ENDIF
      *
      ** 1. Output record to PF/DLINDDM
      **    a. Pay/Receive Telex (SRPRTX)
      **    b. Settlement (SRSETL)
      ** 2. Update PF/DEALSDG (SRUPDT)
      *
     C           WPRIN     IFNE *BLANK
     C                     EXSR SRPRTX
     C                     EXSR SRSETL
     C                     ENDIF
      *
     C                     EXSR SRUPDT
      *
     C                     ENDIF
      *
      ** Update 'Both Sides'
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           SVTFIN    ANDEQ'P'
     C           WUINPM    ANDEQ'DY'
     C           WTINPM    ANDEQ'DY'
     C           WUPYDT    ANDNE*ZERO
     C           WTPYDT    ANDNE*ZERO
      *
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           SVTFIN    ANDEQ'R'
     C           WUINPM    ANDEQ'DY'
     C           WTINPM    ANDEQ'DY'
     C           WUPYDT    ANDNE*ZERO
     C           WTPYDT    ANDNE*ZERO
      *
      ** 1. Output record to PF/DLINDDM
      **    a. Pay/Receive Telex (SRPRTX)
      **    b. Settlement (SRSETL)
      ** 2. Update PF/DEALSDG (SRUPDT)
      *
     C           WTPYDT    IFEQ WUPYDT
     C           WSPRT     ANDNE'Y'
      *
     C                     MOVE 'B'       WPRIN
     C                     EXSR SRPRTX
     C                     EXSR SRSETL
     C                     EXSR SRUPDT
      *
     C                     ELSE
      *
     C                     MOVE 'P'       WPRIN
     C                     EXSR SRPRTX
     C                     EXSR SRSETL
     C                     EXSR SRUPDT
      *
     C                     MOVE 'R'       WPRIN
     C                     EXSR SRPRTX
     C                     EXSR SRSETL
     C                     EXSR SRUPDT
      *
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      **  If settling interest in arrears,
      *
     C           WUSIDE    IFEQ 'Y'
     C           WUINPM    ANDNE'DY'
      *
     C           WTSIDE    OREQ 'Y'
     C           WTINPM    ANDNE'DY'
      *
     C           RERUN     OREQ 'Y'
     C           UFRRF     ANDEQ'Y'
     C           WUINPM    ANDNE'DY'
      *
     C           RERUN     OREQ 'Y'
     C           TFRRF     ANDEQ'Y'
     C           WTINPM    ANDNE'DY'
      *
     C                     EXSR SRDRIA
      *
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRDRIA - Determine rate details for interest in arrears       *
      *                                                               *
      * Called by: SRCPSX                                             *
      *                                                               *
      * Calls: DL2900                                                 *
      *        AOOUSWU0                                               *
      *****************************************************************
     C           SRDRIA    BEGSR
      *
     C           @KEYDG    CHAINDEALSDGF             75
      *
     C           *IN75     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD006       DBASE            ***************
     C                     MOVEL'DEALSDG 'DBFILE           *DB ERROR 006 *
     C                     MOVEL'*KEY    'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Create before image of cash flow details
      *
     C                     MOVELIRDEAL    Z#BSTS
     C                     MOVE *BLANKS   PRTCD   7
     C                     MOVE DLNO      PDLNO   6
     C                     MOVE 'B'       PBEAF   1
     C                     CALL 'DL2900'
     C                     PARM           PRTCD
     C                     PARM           PDLNO
     C                     PARM           PBEAF
      *
      ** If error occurs in DL2900
      *
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD022       DBASE            ***************
     C                     MOVEL'DL2900  'DBFILE           *DB ERROR 022 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Set up PF/DEALSDG fields (Our Side) for later update
      *
     C           WUSIDE    IFEQ 'Y'
     C           WUINPM    ANDNE'DY'
      *
     C                     Z-ADDWUBRTE    UBRTE
     C                     Z-ADDUEINR     WUPEIR
      *
     C           UFRFD     IFEQ *ZERO
     C                     Z-ADDWUFXRT    UEINR
     C                     ENDIF
      *
     C           *IN40     IFEQ '1'
     C                     Z-ADDWUBRTE    UOBRT
     C                     ENDIF
      *
     C                     BITON'4'       CNFI
      *                                                                                       227642
      ** If short term rate was amended, use USLIP as event date                              227642
      *                                                                                       227642
     C           *IN46     IFEQ '1'                                                           227642
     C           URFIN     ANDNE'A'                                                           227642
     C                     Z-ADDUSLIP     WUNRCD                                              227642
     C                     ELSE                                                               227642
      *
      ** If Value date has not been processed yet...
      *
     C           *IN42     IFEQ '1'
      *
     C***********          Z-ADDVDAT      WUNRCD                          CIR005
     C                     Z-ADDDVDAT     WUNRCD                          CIR005
      *
      ** If value date is before rundate and rate change date frequency
      ** is 'Z', determine next rate change date from the date schedule file.
      *
     C           UICFR     IFEQ 'Z'
     C           WUNRCD    ANDLEBJRDNB
     C                     MOVEL'U'       OTIN
     C                     MOVEL'R'       RCIP
     C                     Z-ADDWUNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WUNRCD  50
      *
      ** Go on while not after run date
      *
     C           WUNRCD    DOWLEBJRDNB
     C                     Z-ADDWUNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WUNRCD
     C                     ENDDO
     C                     ENDIF
      *
      ** If value date is before rundate and frequency is not 'Z',
      ** determine next rate change date according to frequency.
      *
     C           UICFR     IFNE 'Z'
      *
     C           WUNRCD    DOWLEBJRDNB
      *                                                                   CIR005
      ** If Daily Rate Change Frequency then simply add 1 to next                             CIR018
      ** change date                                                                          CIR018
     C           CIR018    IFEQ 'Y'                                                           CIR018
     C           UICFR     ANDEQ'D'                                                           CIR018
     C           WUNRCD    ADD  1         ZFRNXD                                              CIR018
     C                     ELSE                                                               CIR018
      *                                                                                       CIR018
     C           CIR005    IFEQ 'Y'                                       CIR005
     C           L1CYP1    ANDNE*BLANKS                                   CIR005
     C           UICFR     IFEQ ' '                                       CIR005
     C                     Z-ADDMDAT      ZFRNXD                          CIR005
     C                     ELSE                                           CIR005
     C                     Z-ADDWUNRCD    ZDAYNO                          CIR005
     C                     Z-ADDUICFD     ZMDAY                           CIR005
     C                     MOVELUICFR     ZFREQ                           CIR005
     C                     MOVELBJSLCD    ZLOC                            CIR005
     C                     EXSR ZFRQB3                                    CIR005
      *                                                                   CIR005
     C                     MOVELWCCYD1    PCURR                           CIR005
     C                     MOVELL1PDCN    PPDCN                           CIR005
      *                                                                   CIR005
     C                     CALL 'DLZIRP'                                  CIR005
     C                     PARM           ZDAYNO                          CIR005
     C                     PARM           PCURR  30                       CIR005
     C                     PARM           PPDCN   2                       CIR005
     C                     PARM           ZLOC                            CIR005
     C                     PARM           BJDFIN                          CIR005
     C                     PARM *ZEROS    PAJDT   50                      CIR005
     C                     PARM *ZEROS    PBSDT   50                      CIR005
     C                     Z-ADDPAJDT     ZFRNXD                          CIR005
      *                                                                   CIR005
     C           WUNRCD    IFGE ZFRNXD                                    CIR005
     C                     Z-ADDPBSDT     ZFRNXD                          CIR005
     C                     ENDIF                                          CIR005
     C           ZFRNXD    IFGT MDAT                                      CIR005
     C                     Z-ADDMDAT      ZFRNXD                          CIR005
     C                     ENDIF                                          CIR005
     C                     ENDIF                                          CIR005
     C                     ELSE                                           CIR005
      *                                                                   CIR005
     C                     CALL 'DLZFRQ'
     C                     PARM *BLANK    ZFRRTC  5
     C                     PARM WUNRCD    ZFRDAT  50       * DATE
     C                     PARM UICFR     ZFRFRQ  1        * FREQUENCY
     C                     PARM UICFD     ZFRBAS  20       * BASE DAY
     C                     PARM PSETM     ZFRSET  20       * SETT.METH.
     C                     PARM UCUCY     ZFRCCY  3        * CURRENCY
     C                     PARM PSCY      ZSTCY   3        * Settl Ccy    CSW097
     C                     PARM 'R'       ZRCIP   1        * 'R' or 'P'   CSW097
     C                     PARM UPACC     ZFRNOS  2        * NOSTRO
     C                     PARM MDAT      ZFRMDT  50       * MAT.DATE
     C                     PARM           BKAPDT
     C                     PARM           BJSLCD
     C                     PARM           BJLCCY
     C                     PARM *ZERO     ZFRZBD  50       * BASE DATE    180466
     C                     PARM *ZERO     ZFRNXD  50       * NEXT DATE
     C           ZFRRTC    IFEQ '*ERR*'
     C           *LOCK     IN   LDA
     C                     Z-ADD0007      DBASE            * * * * * * * *
     C                     MOVELZFRRTC    DBKEY            * DB ERROR 07 *
     C                     MOVEL'DLZFRQ'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF                                          CIR005
      *                                                                                       CIR018
     C                     ENDIF                                                              CIR018
      **  New rate change date
     C                     Z-ADDZFRNXD    WUNRCD
     C                     ENDDO
      *
     C                     ENDIF
     C*
     C                     ELSE
     C*
     C                     Z-ADDUNICD     WUNRCD
      *
     C                     ENDIF
      *                                                                                       227642
     C                     ENDIF                                                              227642
      *
     C                     ENDIF
      *
      ** Set up PF/DEALSDG fields (Their Side) for later update
      *
     C           WTSIDE    IFEQ 'Y'
     C           WTINPM    ANDNE'DY'
      *
     C                     Z-ADDWTBRTE    TBRTE
     C                     Z-ADDTEINR     WTPEIR
      *
     C           TFRFD     IFEQ *ZERO
     C                     Z-ADDWTFXRT    TEINR
     C                     ENDIF
      *
     C           *IN40     IFEQ '1'
     C                     Z-ADDWTBRTE    TOBRT
     C                     ENDIF
      *
     C                     BITON'5'       CNFI
      *
      ** If short term rate was amended, use TSLIP as event date                              227642
      *                                                                                       227642
     C           *IN47     IFEQ '1'                                                           227642
     C           TRFIN     ANDNE'A'                                                           227642
     C                     Z-ADDTSLIP     WTNRCD                                              227642
     C                     ELSE                                                               227642
      *
      ** If Value date has not been processed yet...
     C           *IN42     IFEQ '1'
     C***********          Z-ADDVDAT      WTNRCD                          CIR005
     C                     Z-ADDDVDAT     WTNRCD                          CIR005
      *
      ** If value date is before rundate and rate change date frequency
      ** is 'Z', determine next rate change date from the date schedule file.
      *
     C           TICFR     IFEQ 'Z'
     C           WTNRCD    ANDLEBJRDNB
     C                     MOVEL'T'       OTIN
     C                     MOVEL'R'       RCIP
     C                     Z-ADDWTNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WTNRCD
      *
      ** Go on while not after run date
      *
     C           WTNRCD    DOWLEBJRDNB
     C                     Z-ADDWTNRCD    ZDAYNO
     C                     EXSR SRDETN
     C                     Z-ADDZDAYNO    WTNRCD
     C                     ENDDO
     C                     ENDIF
      *
      ** If value date is before rundate and frequency is not 'Z',
      ** determine next rate change date according to frequency.
      *
     C           TICFR     IFNE 'Z'
      *
     C           WTNRCD    DOWLEBJRDNB
      *                                                                                       CIR018
      ** If Daily Rate Change Frequency then simply add 1 to next                             CIR018
      ** change date                                                                          CIR018
     C           CIR018    IFEQ 'Y'                                                           CIR018
     C           TICFR     ANDEQ'D'                                                           CIR018
     C           WUNRCD    ADD  1         ZFRNXD                                              CIR018
     C                     ELSE                                                               CIR018
      *                                                                   CIR005
     C           CIR005    IFEQ 'Y'                                       CIR005
     C           L1CYP1    ANDNE*BLANKS                                   CIR005
     C           TICFR     IFEQ ' '                                       CIR005
     C                     Z-ADDMDAT      ZFRNXD                          CIR005
     C                     ELSE                                           CIR005
      *                                                                   CIR005
     C                     Z-ADDWTNRCD    ZDAYNO                          CIR005
     C                     Z-ADDTICFD     ZMDAY                           CIR005
     C                     MOVELTICFR     ZFREQ                           CIR005
     C                     MOVELBJSLCD    ZLOC                            CIR005
     C                     EXSR ZFRQB3                                    CIR005
      *                                                                   CIR005
     C           DTYP      IFEQ 'RX'                                      CIR005
     C                     MOVELWCCYD2    PCURR                           CIR005
     C                     MOVELL2PDCN    PPDCN                           CIR005
     C                     ELSE                                           CIR005
     C                     MOVELWCCYD1    PCURR                           CIR005
     C                     MOVELL1PDCN    PPDCN                           CIR005
     C                     ENDIF                                          CIR005
      **
     C           CIR017    IFEQ 'Y'                                                           CIR017
     C           DTYP      ANDEQ'RS'                                                          CIR017
     C                     MOVELL2PDCN    PPDCN                                               CIR017
     C                     ENDIF                                                              CIR017
      *                                                                   CIR005
     C                     CALL 'DLZIRP'                                  CIR005
     C                     PARM           ZDAYNO                          CIR005
     C                     PARM           PCURR  30                       CIR005
     C                     PARM           PPDCN   2                       CIR005
     C                     PARM           ZLOC                            CIR005
     C                     PARM           BJDFIN                          CIR005
     C                     PARM *ZEROS    PAJDT   50                      CIR005
     C                     PARM *ZEROS    PBSDT   50                      CIR005
     C                     Z-ADDPAJDT     ZFRNXD                          CIR005
      *                                                                   CIR005
     C           WTNRCD    IFGE ZFRNXD                                    CIR005
     C                     Z-ADDPBSDT     ZFRNXD                          CIR005
     C                     ENDIF                                          CIR005
     C           ZFRNXD    IFGT MDAT                                      CIR005
     C                     Z-ADDMDAT      ZFRNXD                          CIR005
     C                     ENDIF                                          CIR005
     C                     ENDIF                                          CIR005
     C                     ELSE                                           CIR005
      *                                                                   CIR005
     C                     CALL 'DLZFRQ'
     C                     PARM *BLANK    ZFRRTC  5
     C                     PARM WTNRCD    ZFRDAT  50       * DATE
     C                     PARM TICFR     ZFRFRQ  1        * FREQUENCY
     C                     PARM TICFD     ZFRBAS  20       * BASE DAY
     C                     PARM RSETM     ZFRSET  20       * SETT.METH.
     C                     PARM TCUCY     ZFRCCY  3        * CURRENCY
     C                     PARM RSCY      ZSTCY   3        * Settl Ccy    CSW097
     C                     PARM 'R'       ZRCIP   1        * 'R' or 'P'   CSW097
     C                     PARM URACC     ZFRNOS  2        * NOSTRO
     C                     PARM MDAT      ZFRMDT  50       * MAT.DATE
     C                     PARM           BKAPDT
     C                     PARM           BJSLCD
     C                     PARM           BJLCCY
     C                     PARM *ZERO     ZFRZBD  50       * BASE DATE    180466
     C                     PARM *ZERO     ZFRNXD  50       * NEXT DATE
     C           ZFRRTC    IFEQ '*ERR*'
     C           *LOCK     IN   LDA
     C                     Z-ADD0008      DBASE            * * * * * * * *
     C                     MOVELZFRRTC    DBKEY            * DB ERROR 08 *
     C                     MOVEL'DLZFRQ'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF                                          CIR005
      *                                                                                       CIR018
     C                     ENDIF                                                              CIR018
      **  New rate change date
     C                     Z-ADDZFRNXD    WTNRCD
     C                     ENDDO
     C                     ENDIF
      *
     C                     ELSE
      *
     C                     Z-ADDTNICD     WTNRCD  50
      *
     C                     ENDIF
      *                                                                                       227642
     C                     ENDIF                                                              227642
      *
     C                     ENDIF
      *
      ** Update PF/DEALSDG
      *
     C                     EXSR SRUPDT
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRCALC - Calcualte rate to fix                                *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: *PSSR                                                  *
      *                                                               *
      *****************************************************************
     C           SRCALC    BEGSR
      *
     C                     Z-ADD0         WFXRT
     C                     MOVE WBRTT     BRTTWA  2
      *                                                                   CSW097
     C                     TESTB'1'       ACEI           43               CSW097
     C                     TESTB'0'       WDNSI          44               CSW097
     C                     TESTB'2'       WDNSI          45                                   227642
      *                                                                   CSW097
     C           WBSRT     IFEQ 0
      *                                                                   CSW097
     C********** *IN43     IFEQ '0'                        NOT YET VALUDTE             CSW097 215359
     C********** *IN44     ANDEQ'1'                        EFF INT RTE SET             CSW097 215359
     C********** DVDAT     ANDGEBJRDNB                                                 177837 215359
      ***use*initial*rate*(short*term*rate)****************************                CSW097 215359
     C**********           Z-ADDWEINR     WFXRT                                        CSW097 215359
      *****************************************************************                CSW097 215359
     C********** WSPIN     IFEQ 'A'                                                    CSW097 215359
     C********** WSPIN     OREQ ' '                                                    CSW097 215359
     C********** WEINR     SUB  WRTSP     WBSRT                                        CSW097 215359
     C**********           ENDIF                                                       CSW097 215359
      *****************************************************************                CSW097 215359
     C********** WSPIN     IFEQ 'S'                                                    CSW097 215359
     C********** WEINR     ADD  WRTSP     WBSRT                                        CSW097 215359
     C**********           ENDIF                                                       CSW097 215359
      *****************************************************************                CSW097 215359
     C********** WSPIN     IFEQ 'P'                                                    CSW097 215359
     C********** WRTSP     DIV  100       WRTSPQ                                       CSW097 215359
     C**********           ADD  1         WRTSPQ                                       CSW097 215359
     C********** WEINR     DIV  WRTSPQ    WBSRT                                        CSW097 215359
     C**********           ENDIF                                                       CSW097 215359
      *****************************************************************                CSW097 215359
     C**********           ELSE                                                        CSW097 215359
     C           WRFIN     IFEQ 'P'                        Rate fixing                        227642
     C           *IN43     ANDEQ'0'                        Vdat not yet proc                  227642
     C           *IN44     ANDEQ'1'                        Eff int rate set                   227642
     C           DVDAT     ANDGEBJRDNB                                                        227642
      *                                                                                       227642
     C           *IN45     OREQ '1'                        STR amended                        227642
     C           WRFIN     ANDNE'A'                                                           227642
      *                                                                                       227642
      ** Use short term rate                                                                  227642
     C                     Z-ADDWEINR     WFXRT                                               227642
     C                     Z-ADDWEINR     WBSRT                                               227642
      *                                                                                       227642
     C                     ELSE                                                               227642
      *                                                                                       227642
      *  use current rate                                                 CSW097
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           WCUCY
     C                     PARM           BRTTWA
     C********** SDBSRT    PARM SDBSRT    DSFDY                                 CSD006
     C           SDBSRT    PARM SDBSRT    DSSDY                                 CSD006
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD009       DBASE            ***************
     C                     MOVEL'SDBSRTPD'DBFILE           *DB ERROR 009 *
     C                     MOVEL'*KEY    'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           BAVDNR    IFLE WINFD
     C                     Z-ADDBANBRT    WBSRT
     C                     ELSE
     C                     Z-ADDBACBSR    WBSRT
     C                     ENDIF
      *
     C***********          ENDIF                                          CSW097
      *
     C                     Z-ADDWBSRT     WFXRT
      *
     C           WSPIN     IFEQ 'A'
     C           WSPIN     OREQ ' '
     C                     ADD  WRTSP     WFXRT
     C                     ENDIF
      *
     C           WSPIN     IFEQ 'S'
     C                     SUB  WRTSP     WFXRT
     C                     ENDIF
      *
     C           WSPIN     IFEQ 'P'
     C           WRTSP     DIV  100       WRTSPQ 117
     C                     ADD  1         WRTSPQ 117
     C           WRTSPQ    MULT WBSRT     WFXRT
     C                     ENDIF                                          CSW097
      *                                                                   CSW097
     C**********           ENDIF                                                       CSW097 215359
     C                     ENDIF                                                              227642
      *                                                                   CSW097
     C                     ELSE                                           CSW097
      *                                                                   CSW097
      **  FORCED REFIXING                                                 CSW097
     C                     Z-ADDWBSRT     WFXRT                           CSW097
      *                                                                   CSW097
     C           WSPIN     IFEQ 'A'                                       CSW097
     C           WSPIN     OREQ ' '                                       CSW097
     C                     ADD  WRTSP     WFXRT                           CSW097
     C                     ENDIF                                          CSW097
      *                                                                   CSW097
     C           WSPIN     IFEQ 'S'                                       CSW097
     C                     SUB  WRTSP     WFXRT                           CSW097
     C                     ENDIF                                          CSW097
      *                                                                   CSW097
     C           WSPIN     IFEQ 'P'                                       CSW097
     C           WRTSP     DIV  100       WRTSPQ 117                      CSW097
     C                     ADD  1         WRTSPQ 117                      CSW097
     C           WRTSPQ    MULT WBSRT     WFXRT                           CSW097
     C                     ENDIF                                          CSW097
      *                                                                   CSW097
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRPRTX - O/P pay/receive telex record to PF/DLINDDM           *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRPRTX    BEGSR
      *
     C                     MOVE WPRIN     WPRIN1  1
      *
      * check for telex notice days and skip further processing if not
      *   yet time for pay/receive production
      *
      ** If settlement by nostro use ccy/nostro location to determine
      ** telex notice date
      *  receipt -
     C           WPRIN1    IFEQ 'R'
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WTSAMT    ANDGTWUSAMT
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RX'
     C                     Z-ADDRSTM      WSTM    20
     C           DTYP      IFEQ 'RX'
     C                     MOVELTCUCY     TCYN1   5
     C                     ELSE
     C                     MOVELUCUCY     TCYN1
     C                     ENDIF
     C                     MOVELRONS      SNOS1   2
      *
     C                     EXSR TLXNOT
      *
      **   Compare event date to fwd date
     C           DTYP      IFEQ 'FR'
     C           DVDAT     ORGT BJRDNB
     C           DVDAT     IFGT TLXCMP
     C                     MOVE *BLANKS   WPRIN1
     C                     ENDIF
     C                     ELSE
     C           WPRIN1    IFEQ 'R'
     C           TNIPD     IFNE 0
     C           TNIPD     IFGT TLXCMP
     C                     MOVE *BLANKS   WPRIN1
     C                     ENDIF
     C                     ELSE
     C           MDAT      IFGT TLXCMP
     C                     MOVE *BLANKS   WPRIN1
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
     C           TNIPD     IFNE 0
     C           TNIPD     IFGT TLXCMP
     C                     MOVE 'P'       WPRIN1
     C                     ENDIF
     C                     ELSE
     C           MDAT      IFGT TLXCMP
     C                     MOVE 'P'       WPRIN1
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  Pay -
     C           WPRIN1    IFEQ 'P'
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WUSAMT    ANDGTWTSAMT
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RX'
     C                     Z-ADDPSTM      WSTM    20
     C                     MOVELUCUCY     TCYN1
     C                     MOVELPONS      SNOS1
      *
     C                     EXSR TLXNOT
      *
      **   Compare event date to fwd date
     C           DTYP      IFEQ 'FR'
     C           DVDAT     ORGT BJRDNB
     C           DVDAT     IFGT TLXCMP
     C                     MOVE *BLANKS   WPRIN1
     C                     ENDIF
     C                     ELSE
     C           WPRIN1    IFEQ 'P'
     C           UNIPD     IFNE 0
     C           UNIPD     IFGT TLXCMP
     C                     MOVE *BLANKS   WPRIN1
     C                     ENDIF
     C                     ELSE
     C           MDAT      IFGT TLXCMP
     C                     MOVE *BLANKS   WPRIN1
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
     C           UNIPD     IFNE 0
     C           UNIPD     IFGT TLXCMP
     C                     MOVE 'R'       WPRIN1
     C                     ENDIF
     C                     ELSE
     C           MDAT      IFGT TLXCMP
     C                     MOVE 'R'       WPRIN1
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           WPRIN1    IFNE *BLANKS
     C                     MOVE 'D'       RECI
     C                     MOVE 'D'       RCDT
     C                     Z-ADD*ZERO     VDAT
     C                     Z-ADD*ZERO     DASN
      *
     C           RERUN     IFNE 'Y'
     C                     MOVE 'I'       CHTP
     C                     ELSE
     C                     MOVE 'A'       CHTP
     C                     ENDIF
      *
     C                     MOVE *BLANK    CNRQ
     C                     MOVE *BLANK    CNPR
     C                     MOVE *BLANK    REPR
     C                     Z-ADD*ZERO     RRLA
     C                     MOVE *BLANK    DADI
      *
      ** Update 'Pay/Receive Indicator 1 (PRI1)' field
      *
     C           WPRIN1    IFEQ 'R'
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WTSAMT    ANDGTWUSAMT
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RX'
     C                     Z-ADD1         PRI1
     C                     ELSE
     C                     Z-ADD*ZERO     PRI1
     C                     ENDIF
      *
     C                     Z-ADD*ZERO     PRI2
      *
      ** Update 'Pay/Receive Indicator 3 (PRI3)' field
      *
     C           WPRIN1    IFEQ 'P'
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WUSAMT    ANDGTWTSAMT
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RX'
     C                     Z-ADD1         PRI3
     C                     ELSE
     C                     Z-ADD*ZERO     PRI3
     C                     ENDIF
      *
     C                     MOVE *BLANK    ZZ004
     C                     Z-ADD*ZERO     ICIN
     C                     Z-ADD*ZERO     RRNT
     C                     Z-ADD*ZERO     TNLU
      *
      ** Update 'Payment Interest Amount (PIAMT' field
      *
     C                     Z-ADD*ZEROS    PIAMT
      *
     C           WPRIN1    IFEQ 'P'
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RX'
     C                     Z-ADDWUSAMT    PIAMT
     C                     ENDIF
      *
     C           WPRIN1    IFEQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WUSAMT    ANDGTWTSAMT
     C                     Z-ADDWUSAMT    PIAMT
     C                     SUB  WTSAMT    PIAMT
     C                     ENDIF
      *
      ** Update 'Receive Interest Amount (RIAMT)' field
      *
     C                     Z-ADD*ZEROS    RIAMT
      *
     C           WPRIN1    IFEQ 'R'
     C           WPRIN1    OREQ 'B'
     C           DTYP      ANDEQ'RX'
     C                     Z-ADDWTSAMT    RIAMT
     C                     ENDIF
      *
     C           WPRIN1    IFEQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WTSAMT    ANDGTWUSAMT
     C                     Z-ADDWTSAMT    RIAMT
     C                     SUB  WUSAMT    RIAMT
     C                     ENDIF
      *
     C                     Z-ADD*ZERO     UFIR
     C                     Z-ADD*ZERO     TFIR
      *
      ** Update 'Event Date (EVDAT)' field
      *
     C           DTYP      IFEQ 'FR'
     C                     Z-ADDDVDAT     EVDAT
     C                     ELSE
     C           WPRIN1    IFEQ 'P'
     C           WPRIN1    OREQ 'B'
     C                     Z-ADDWUPYDT    EVDAT
     C                     ELSE
     C                     Z-ADDWTPYDT    EVDAT
     C                     ENDIF
     C                     ENDIF
      *
     C                     Z-ADDWTAXAP    TAXPY
     C                     MOVE *BLANKS   ZZ022
      *
     C                     ADD  1         RECCNT
      *
      ** Write record to PF/DLINDDM
      *
     C                     WRITEDTRIEPHF
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRSETL - Output Settlement record to PF/DLINDDM               *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRSETL    BEGSR
      *
     C                     MOVE 'D'       RECI
     C                     MOVE 'D'       RCDT
     C                     Z-ADD*ZERO     VDAT
     C                     Z-ADD*ZERO     DASN
      *
     C           RERUN     IFNE 'Y'
     C                     MOVE 'I'       CHTP
     C                     ELSE
     C                     MOVE 'A'       CHTP
     C                     ENDIF
      *
      ** Update 'Confirmation requested (CNRQ)' field
      *
     C           WPRIN     IFEQ 'P'
     C           WPRIN     OREQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WUSAMT    ANDGTWTSAMT
     C                     MOVE 'E'       CNRQ
     C                     ENDIF
      *
     C           WPRIN     IFEQ 'R'
     C           WPRIN     OREQ 'B'
     C           DTYP      ANDEQ'RS'
     C           WTSAMT    ANDGTWUSAMT
     C                     MOVE 'G'       CNRQ
     C                     ENDIF
      *
     C           WPRIN     IFEQ 'B'
     C           DTYP      ANDEQ'RX'
     C                     MOVE 'J'       CNRQ
     C                     ENDIF
      *
     C                     MOVE *BLANK    CNPR
     C                     MOVE *BLANK    REPR
     C                     Z-ADD*ZERO     RRLA
     C                     MOVE *BLANK    DADI
     C                     Z-ADD*ZERO     PRI1
     C                     Z-ADD*ZERO     PRI2
     C                     Z-ADD*ZERO     PRI3
     C                     MOVE *BLANK    ZZ004
     C                     Z-ADD*ZERO     ICIN
     C                     Z-ADD*ZERO     RRNT
     C                     Z-ADD*ZERO     TNLU
      *
     C           WPRIN     IFEQ 'P'
     C           WPRIN     OREQ 'B'
     C           UFRRF     OREQ 'Y'
     C                     Z-ADDWUSAMT    PIAMT
     C                     ELSE
     C                     Z-ADD*ZERO     PIAMT
     C                     ENDIF
      *
     C           WPRIN     IFEQ 'R'
     C           WPRIN     OREQ 'B'
     C           TFRRF     OREQ 'Y'
     C                     Z-ADDWTSAMT    RIAMT
     C                     ELSE
     C                     Z-ADD*ZERO     RIAMT
     C                     ENDIF
      *
     C                     Z-ADDUEINR     UFIR
     C                     Z-ADDTEINR     TFIR
      *
     C           DTYP      IFEQ 'FR'
     C                     Z-ADDDVDAT     EVDAT
     C                     ELSE
     C           WPRIN     IFEQ 'P'
     C           WPRIN     OREQ 'B'
     C                     Z-ADDWUPYDT    EVDAT
     C                     ELSE
     C                     Z-ADDWTPYDT    EVDAT
     C                     ENDIF
     C                     ENDIF
      *
     C                     Z-ADDWTAXAP    TAXPY
     C                     MOVE *BLANKS   ZZ022
      *
     C                     ADD  1         RECCNT
      *
      ** Write record to PF/DLINDDM
      *
     C                     WRITEDTRIEPHF
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      * SRRFDM - O/P rate fixing record to PF/DLINDDM                 *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRRFDM    BEGSR
      *
     C                     MOVE 'D'       RECI
     C                     MOVE 'D'       RCDT
     C                     Z-ADD*ZERO     VDAT
     C                     Z-ADD*ZERO     DASN
     C           RERUN     IFNE 'Y'
     C                     MOVE 'I'       CHTP
     C                     ELSE
     C                     MOVE 'A'       CHTP
     C                     ENDIF
      *                                                                                     BUG11267
      ** Output an additional record in DLINDDM if the IRS is                               BUG11267
      ** back-valued to correctly generate MT362 for the                                    BUG11267
      ** current period.                                                                    BUG11267
      *                                                                                     BUG11267
     C           ORED      IFEQ BJRDNB                                                      BUG11267
     C           DVDAT     ANDLTBJRDNB                                                      BUG11267
     C           RERUN     ANDNE'Y'                                                         BUG11267
      *                                                                                     BUG11267
     C           DTYP      IFEQ 'RS'                                                        BUG11267
     C           DTYP      OREQ 'RX'                                                        BUG11267
     C                     EXSR SRBACK                                                      BUG11267
     C                     ENDIF                                                            BUG11267
      *                                                                                     BUG11267
     C                     ENDIF                                                            BUG11267
      *
      ** Determine value for Confirmation Requested field (CNRQ)
      *
      ** 1. Case OUR SIDE has been fixed during input cycle
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           SVTFIN    ANDNE'P'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           SVTFIN    ANDNE'R'
     C           TFRRF     ANDNE'Y'
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'A'                                                           227642
     C           SVTFIN    ANDNE'A'                                                           227642
     C           TFRRF     ANDNE'Y'                                                           227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'B'                                                           227642
     C           SVTFIN    ANDNE'B'                                                           227642
     C           TFRRF     ANDNE'Y'                                                           227642
     C                     MOVE 'D'       CNRQ
     C                     ENDIF
      *
      ** 2. Case THEIR SIDE has been fixed during input cycle
      *
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           SVRFIN    ANDNE'P'
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C           SVRFIN    ANDNE'R'
     C           UFRRF     ANDNE'Y'
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'A'                                                           227642
     C           SVRFIN    ANDNE'A'                                                           227642
     C           UFRRF     ANDNE'Y'                                                           227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'B'                                                           227642
     C           SVRFIN    ANDNE'B'                                                           227642
     C           UFRRF     ANDNE'Y'                                                           227642
     C                     MOVE 'F'       CNRQ
     C                     ENDIF
      *
      ** 3. Case BOTH SIDES have been fixed during input cycle for same rate
      *     change date
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           SVTFIN    ANDEQ'P'
     C           WSPRT     ANDNE'Y'
     C           UNICD     ANDEQTNICD
      *
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           SVTFIN    ANDEQ'R'
     C           WSPRT     ANDNE'Y'
     C           UNICD     ANDEQTNICD
      *
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           TFRRF     ANDEQ'Y'
     C           UNICD     ANDEQTNICD
      *
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C           UFRRF     ANDEQ'Y'
     C           UNICD     ANDEQTNICD
      *                                                                                       227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'A'                                                           227642
     C           SVTFIN    ANDEQ'A'                                                           227642
     C           WSPRT     ANDNE'Y'                                                           227642
     C           UNICD     ANDEQTNICD                                                         227642
      *                                                                                       227642
      *                                                                                       227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'B'                                                           227642
     C           SVTFIN    ANDEQ'B'                                                           227642
     C           WSPRT     ANDNE'Y'                                                           227642
     C           UNICD     ANDEQTNICD                                                         227642
      *                                                                                       227642
     C                     MOVE 'H'       CNRQ
     C                     ENDIF
      *
      ** 4. Case BOTH SIDES have been fixed during input cycle for different
      *     rate change dates, so output one for our  side and one for
      *     theirs (this is not necessary from MT362 message point of view
      *     but is essential to process refixes in Midas correctly in all
      *     circumstances)
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           SVTFIN    ANDEQ'P'
     C           UNICD     ANDNETNICD
      *
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           SVTFIN    ANDEQ'R'
     C           UNICD     ANDNETNICD
      *
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           SVTFIN    ANDEQ'R'
     C           WSPRT     ANDEQ'Y'
      *
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'A'                                                           227642
     C           SVTFIN    ANDEQ'A'                                                           227642
     C           UNICD     ANDNETNICD                                                         227642
      *                                                                                       227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'B'                                                           227642
     C           SVTFIN    ANDEQ'B'                                                           227642
     C           UNICD     ANDNETNICD                                                         227642
      *                                                                                       227642
     C                     MOVE 'D'       CNRQ
     C                     Z-ADDWUSAMT    PIAMT
     C                     Z-ADDWUFXRT    UFIR
     C                     Z-ADDWUNRCD    EVDAT
      *
     C                     MOVE *BLANK    CNPR
     C                     MOVE *BLANK    REPR
     C                     Z-ADD*ZERO     RRLA
     C                     MOVE *BLANK    DADI
     C                     Z-ADD*ZERO     PRI1
     C                     Z-ADD*ZERO     PRI2
     C                     Z-ADD*ZERO     PRI3
     C                     MOVE *BLANK    ZZ004
     C                     Z-ADD*ZERO     ICIN
     C                     Z-ADD*ZERO     RRNT
     C                     Z-ADD*ZERO     TNLU
     C                     Z-ADD*ZERO     TAXPY
     C                     MOVE *BLANKS   ZZ022
      *
     C                     ADD  1         RECCNT
      *                                                                   CSW097
     C           CSW005    IFEQ 'Y'                                       CSW097
     C           DTYP      ANDEQ'FR'                                      CSW097
     C           WPRIN     IFEQ 'P'                                       CSW097
     C           WPRIN     OREQ 'B'                                       CSW097
     C           UFRRF     OREQ 'Y'                                       CSW097
     C                     Z-ADDWUSAMT    PIAMT                           CSW097
     C                     ELSE                                           CSW097
     C                     Z-ADD0         PIAMT                           CSW097
     C                     ENDIF                                          CSW097
      *                                                                   CSW097
     C           WPRIN     IFEQ 'R'                                       CSW097
     C           WPRIN     OREQ 'B'                                       CSW097
     C           TFRRF     OREQ 'Y'                                       CSW097
     C                     Z-ADDWTSAMT    RIAMT                           CSW097
     C                     ELSE                                           CSW097
     C                     Z-ADD0         RIAMT                           CSW097
     C                     ENDIF                                          CSW097
     C                     ENDIF                                          CSW097
      *
     C                     WRITEDTRIEPHF
      *
      * set up their side indicator
     C                     MOVE 'F'       CNRQ
      *
     C                     ENDIF
      *
     C                     MOVE *BLANK    CNPR
     C                     MOVE *BLANK    REPR
     C                     Z-ADD*ZERO     RRLA
     C                     MOVE *BLANK    DADI
     C                     Z-ADD*ZERO     PRI1
     C                     Z-ADD*ZERO     PRI2
     C                     Z-ADD*ZERO     PRI3
     C                     MOVE *BLANK    ZZ004
     C                     Z-ADD*ZERO     ICIN
     C                     Z-ADD*ZERO     RRNT
     C                     Z-ADD*ZERO     TNLU
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'A'                                                           227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'B'                                                           227642
     C           UFRRF     OREQ 'Y'
     C           CNRQ      IFNE 'F'
     C                     Z-ADDWUSAMT    PIAMT
     C                     Z-ADDWUFXRT    UFIR
     C                     ELSE
     C                     Z-ADD*ZERO     PIAMT
     C                     Z-ADD*ZERO     UFIR
     C                     ENDIF
     C                     ELSE
     C                     Z-ADD*ZERO     PIAMT
     C                     Z-ADD*ZERO     UFIR
     C                     ENDIF
      *
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'A'                                                           227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'B'                                                           227642
     C           TFRRF     OREQ 'Y'
     C                     Z-ADDWTSAMT    RIAMT
     C                     Z-ADDWTFXRT    TFIR
     C                     ELSE
     C                     Z-ADD*ZERO     RIAMT
     C                     Z-ADD*ZERO     TFIR
     C                     ENDIF
      *
     C           DTYP      IFEQ 'FR'
     C                     Z-ADDDVDAT     EVDAT
     C                     ELSE
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'A'                                                           227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'B'                                                           227642
     C                     Z-ADDWUNRCD    EVDAT
     C                     ELSE
     C                     Z-ADDWTNRCD    EVDAT
     C                     ENDIF
     C                     ENDIF
      *
     C                     Z-ADD*ZERO     TAXPY
     C                     MOVE *BLANKS   ZZ022
      *
     C                     ADD  1         RECCNT
      *                                                                   CSW097
     C           CSW005    IFEQ 'Y'                                       CSW097
     C           DTYP      ANDEQ'FR'                                      CSW097
      *                                                                   CSW097
     C           WPRIN     IFEQ 'P'                                       CSW097
     C           WPRIN     OREQ 'B'                                       CSW097
     C           UFRRF     OREQ 'Y'                                       CSW097
     C                     Z-ADDWUSAMT    PIAMT                           CSW097
     C                     ELSE                                           CSW097
     C                     Z-ADD0         PIAMT                           CSW097
     C                     ENDIF                                          CSW097
      *                                                                   CSW097
     C           WPRIN     IFEQ 'R'                                       CSW097
     C           WPRIN     OREQ 'B'                                       CSW097
     C           TFRRF     OREQ 'Y'                                       CSW097
     C                     Z-ADDWTSAMT    RIAMT                           CSW097
     C                     ELSE                                           CSW097
     C                     Z-ADD0         RIAMT                           CSW097
     C                     ENDIF                                          CSW097
     C                     ENDIF                                          CSW097
      *
      ** Write record to PF/DLINDDM
      *
     C                     WRITEDTRIEPHF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRUPDT - Update LF/DLDLDGLJ                                   *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRUPDT    BEGSR
      *
     C           @KEYDG    CHAINDEALSDGF             75
      *
     C           *IN75     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD011       DBASE            ***************
     C                     MOVEL'DEALSDG 'DBFILE           *DB ERROR 011 *
     C                     MOVEL'*KEY    'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Update 'Our Base Rate (UBRTE)' field
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C                     Z-ADDWUBRTE    UBRTE
     C                     ENDIF
      *
      ** Update 'Our Effective Interest Rate (UEINR)' field
      *
     C           DTYP      IFEQ 'FR'
     C           RERUN     ANDNE'Y'
     C           SVRFIN    ANDEQ'P'
      *
     C           DTYP      OREQ 'FR'
     C           RERUN     ANDEQ'Y'
     C           SVRFIN    ANDEQ'R'
     C                     Z-ADDWUFXRT    UEINR
     C                     ENDIF
      *
      * Restore previous value as UEINR already updated, if interest in arrears
      * or before rate change date
     C           DTYP      IFEQ 'RS'
     C           RERUN     ANDNE'Y'
     C           SVRFIN    ANDEQ'P'
      *
     C           DTYP      OREQ 'RX'
     C           RERUN     ANDNE'Y'
     C           SVRFIN    ANDEQ'P'
      *
     C           DTYP      OREQ 'RS'
     C           RERUN     ANDEQ'Y'
     C           SVRFIN    ANDEQ'R'
      *
     C           DTYP      OREQ 'RX'
     C           RERUN     ANDEQ'Y'
     C           SVRFIN    ANDEQ'R'
      *
     C***********BJRDNB    IFLT VDAT                                      CIR005
     C***********BJRDNB    ORGT VDAT                                      CIR005
     C********** BJRDNB    IFLT DVDAT                                                  CIR005 237750
     C********** BJRDNB    ORGT DVDAT                                                  CIR005 237750
     C           BJRDNB    IFGT DVDAT                                                         237750
     C           BJRDNB    ANDLTUNICD
     C           WUINPM    ORNE 'DY'
     C                     Z-ADDWUPEIR    UEINR
     C                     ENDIF
      *                                                                                       237750
      ** Set effective interest rate for the first rating fixing                              237750
      ** I.e. Value date today or in the future                                               237750
      *                                                                                       237750
     C           BJRDNB    IFLE DVDAT                                                         237750
     C                     Z-ADDWUFXRT    UEINR                                               237750
     C                     ENDIF                                                              237750
      *                                                                                       237750
     C                     ENDIF
      *
      ** Update 'Their Base Rate (TBRTE)' field
      *
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C                     Z-ADDWTBRTE    TBRTE
     C                     ENDIF
      *
      ** Update 'Their Effective Interest Rate (TEINR)' field
      *
     C           DTYP      IFEQ 'FR'
     C           RERUN     ANDNE'Y'
     C           SVTFIN    ANDEQ'P'
      *
     C           DTYP      OREQ 'FR'
     C           RERUN     ANDEQ'Y'
     C           SVTFIN    ANDEQ'R'
     C                     Z-ADDWTFXRT    TEINR
     C                     ENDIF
      *
      * Restore previous value as TEINR already updated, if interest in arrears
      * or before rate change date
     C           DTYP      IFEQ 'RS'
     C           RERUN     ANDNE'Y'
     C           SVTFIN    ANDEQ'P'
      *
     C           DTYP      OREQ 'RX'
     C           RERUN     ANDNE'Y'
     C           SVTFIN    ANDEQ'P'
      *
     C           DTYP      OREQ 'RS'
     C           RERUN     ANDEQ'Y'
     C           SVTFIN    ANDEQ'R'
      *
     C           DTYP      OREQ 'RX'
     C           RERUN     ANDEQ'Y'
     C           SVTFIN    ANDEQ'R'
      *
     C***********BJRDNB    IFLT VDAT                                      CIR005
     C***********BJRDNB    ORGT VDAT                                      CIR005
     C********** BJRDNB    IFLT DVDAT                                                  CIR005 237750
     C********** BJRDNB    ORGT DVDAT                                                  CIR005 237750
     C           BJRDNB    IFGT DVDAT                                                         237750
     C           BJRDNB    ANDLTTNICD
     C           WTINPM    ORNE 'DY'
     C                     Z-ADDWTPEIR    TEINR
     C                     ENDIF
      *                                                                                       237750
      ** Set effective interest rate for the first rating fixing                              237750
      ** I.e. Value date today or in the future                                               237750
      *                                                                                       237750
     C           BJRDNB    IFLE DVDAT                                                         237750
     C                     Z-ADDWTFXRT    TEINR                                               237750
     C                     ENDIF                                                              237750
      *                                                                                       237750
     C                     ENDIF
      *
      ** Update 'Our Non-Static Indicators (UDNSI)' field
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C                     BITON'0'       UDNSI
     C                     BITOF'3'       UDNSI
     C                     ENDIF
      *
      ** Update 'Their Non-Static Indicators (TDNSI)' field
      *
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C                     BITON'0'       TDNSI
     C                     BITOF'3'       TDNSI
     C                     ENDIF
      *
      ** Update 'Confirmations Indicator (CNFI)' field
      *
     C           WPRIN     IFEQ 'P'
     C           WPRIN     OREQ 'B'
     C                     BITON'2'       CNFI
     C                     ENDIF
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'A'                                                           227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'B'                                                           227642
     C                     BITON'4'       CNFI
     C                     ENDIF
      *
     C           WPRIN     IFEQ 'R'
     C           WPRIN     OREQ 'B'
     C                     BITON'3'       CNFI
     C                     ENDIF
      *
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'A'                                                           227642
     C           RERUN     OREQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'B'                                                           227642
     C                     BITON'5'       CNFI
     C                     ENDIF
      *
      **  Update 'Telex Indicators (TLXI)' field
      *
     C           WPRIN1    IFEQ 'P'
     C           WPRIN1    OREQ 'B'
     C                     BITON'3'       TLXI
     C                     ENDIF
      *
     C           WPRIN1    IFEQ 'R'
     C           WPRIN1    OREQ 'B'
     C                     BITON'4'       TLXI
     C                     ENDIF
      *
      ** Update 'Our Original Base Rate (UOBRT)' field
      *
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           *IN40     ANDEQ'1'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C           *IN40     ANDEQ'1'
     C                     Z-ADDWUBRTE    UOBRT
     C                     ENDIF
      *
      ** Update 'Their Original Base Rate (TOBRT)' field
      *
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           *IN41     ANDEQ'1'
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C           *IN41     ANDEQ'1'
     C                     Z-ADDWTBRTE    TOBRT
     C                     ENDIF
      *
      ** Update PF/DEALSDG
      *
     C                     UPDATDEALSDGF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRURFI - Update LF/DLDLDGLJ with the new rate fix indicator   *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRURFI    BEGSR
      *
     C           @KEYDG    CHAINDEALSDGF             75
      *
     C           *IN75     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD010       DBASE            ***************
     C                     MOVEL'DEALSDG 'DBFILE           *DB ERROR 010 *
     C                     MOVEL'*KEY    'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Update 'Our Rate Fixing Indicator (URFIN) field
      *
     C           DTYP      IFEQ 'RS'                                                          227642
     C           DTYP      OREQ 'RX'                                                          227642
      *                                                                                       227642
     C           RERUN     IFEQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'A'                                                           227642
     C                     MOVE 'F'       URFIN                                               227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C           RERUN     IFEQ 'Y'                                                           227642
     C           SVRFIN    ANDEQ'B'                                                           227642
     C                     MOVE 'C'       URFIN                                               227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C           RERUN     IFNE 'Y'
     C           SVRFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVRFIN    ANDEQ'R'
     C                     MOVE 'F'       URFIN
      *                                                                                       227642
      ** If INFD is not for initial rate fix date before value date, and STR                  227642
      ** amended, base rate should be picked up in COB.  Set URFIN to 'A'.                    227642
      *                                                                                       227642
     C           DTYP      IFEQ 'RS'                                                          227642
     C           DTYP      OREQ 'RX'                                                          227642
     C           *IN46     IFEQ '1'                                                           227642
     C           UINFD     ANDGTVDAT                                                          227642
     C                     MOVE 'A'       URFIN                                               227642
     C                     ENDIF                                                              227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C                     ENDIF
      *
      ** Update 'Their Rate Fixing Indicator (TRFIN)' field
      *
     C           DTYP      IFEQ 'RS'                                                          227642
     C           DTYP      OREQ 'RX'                                                          227642
      *                                                                                       227642
     C           RERUN     IFEQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'A'                                                           227642
     C                     MOVE 'F'       TRFIN                                               227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C           RERUN     IFEQ 'Y'                                                           227642
     C           SVTFIN    ANDEQ'B'                                                           227642
     C                     MOVE 'C'       TRFIN                                               227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C           RERUN     IFNE 'Y'
     C           SVTFIN    ANDEQ'P'
     C           RERUN     OREQ 'Y'
     C           SVTFIN    ANDEQ'R'
     C                     MOVE 'F'       TRFIN
      *                                                                                       227642
      ** If INFD is not for initial rate fix date before value date, and STR                  227642
      ** amended, base rate should be picked up in COB.  Set TRFIN to 'A'.                    227642
      *                                                                                       227642
     C           DTYP      IFEQ 'RS'                                                          227642
     C           DTYP      OREQ 'RX'                                                          227642
     C           *IN47     IFEQ '1'                                                           227642
     C           TINFD     ANDGTVDAT                                                          227642
     C                     MOVE 'A'       TRFIN                                               227642
     C                     ENDIF                                                              227642
     C                     ENDIF                                                              227642
      *                                                                                       227642
     C                     ENDIF
      *
     C                     UPDATDEALSDGF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRUFRI - If one side is forced-refixed, determine if          *
      *          still needed to avoid creating unnecessary           *
      *          messages                                             *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
      *
     C           SRUFRI    BEGSR
      *
      ** Get outstanding messages from MGOREFL0
      *
     C                     MOVE 'FI'      K#MODI
     C                     MOVE DLNO      K#DLNO
     C                     MOVE *HIVAL    K#SEQN
      *
     C                     MOVE *BLANKS   XTRNO  16
     C                     MOVE *BLANKS   WEVTP1  2
     C                     MOVE *BLANKS   WTRNO1 16
     C                     MOVE *BLANKS   WLSCC1  8
     C                     MOVE *BLANKS   WMGSG1  1
     C                     MOVE *BLANKS   WEVTP2  2
     C                     MOVE *BLANKS   WTRNO2 16
     C                     MOVE *BLANKS   WLSCC2  8
     C                     MOVE *BLANKS   WMGSG2  1
     C                     MOVE *BLANKS   WEVTP3  2
     C                     MOVE *BLANKS   WTRNO3 16
     C                     MOVE *BLANKS   WLSCC3  8
     C                     MOVE *BLANKS   WMGSG3  1
      *
     C           K#TRNO    SETGTMGOREFD0               77
     C                     READPMGOREFD0                 77
      *
     C           *IN77     DOWEQ'0'
     C           F#DLNO    ANDEQDLNO
      *
     C           MGST      IFNE 'DLTD'
      *
     C           EVTP      IFEQ 'SU'
     C           EVTP      OREQ 'ST'
     C           EVTP      OREQ 'SB'
     C                     SELEC
     C           WEVTP1    WHEQ *BLANKS
     C                     MOVELEVTP      WEVTP1
     C                     MOVELTRNO      WTRNO1
     C                     MOVELLSCC      WLSCC1
     C           MGSG      IFEQ '2'
     C           MGSG      OREQ '3'
     C                     MOVEL'R'       WMGSG1
     C                     ENDIF
     C           WEVTP2    WHEQ *BLANKS
     C                     MOVELEVTP      WEVTP2
     C                     MOVELTRNO      WTRNO2
     C                     MOVELLSCC      WLSCC2
     C           MGSG      IFEQ '2'
     C           MGSG      OREQ '3'
     C                     MOVEL'R'       WMGSG2
     C                     ENDIF
     C           WEVTP3    WHEQ *BLANKS
     C                     MOVELEVTP      WEVTP3
     C                     MOVELTRNO      WTRNO3
     C                     MOVELLSCC      WLSCC3
     C           MGSG      IFEQ '2'
     C           MGSG      OREQ '3'
     C                     MOVEL'R'       WMGSG3
     C                     ENDIF
     C                     ENDSL
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     READPMGOREFD0                 77
      *
     C                     ENDDO
      *
     C           WEVTP1    IFNE *BLANKS
     C           WEVTP1    ANDNE'SB'
     C           WEVTP2    ANDNE'SB'
     C           WEVTP3    ANDNE'SB'
      *
     C           DTYP      IFEQ 'RS'
     C           URFIN     ANDEQ'R'
     C           TRFIN     ANDEQ'R'
     C           UNIPD     ANDEQTNIPD
      *
     C           WMGSG1    IFEQ '2'
     C           WMGSG1    OREQ '3'
     C           WMGSG2    OREQ '2'
     C           WMGSG2    OREQ '3'
     C                     MOVEL'Y'       WSPRT
     C                     ENDIF
      *
     C                     ELSE
      *
      ** Look up to combinations array to find out if  forced-refixing
      ** necessary.
      *
     C                     Z-ADD1         X
     C           EVENT     LOKUPCOMB,X                   50
      *
      ** Check if last record amends previous record.
      *
     C           *IN50     IFEQ *ON
      *
     C           WLSCC1    IFEQ 'AMEND   '
     C           FRFX,X    ANDEQ'Y'
      *
     C           WEVTP3    IFNE *BLANKS
     C                     MOVELWTRNO2    KTRNO  16
     C                     ELSE
     C                     MOVELWTRNO1    KTRNO
     C                     ENDIF
      *
     C           KTRNO     CHAINMGOMSGD0             51
      *
     C           *IN51     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     Z-ADD024       DBASE            ***************
     C                     MOVEL'MGOMSGPD'DBFILE           *DB ERROR 024 *
     C                     MOVELWTRNO1    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           WTRNO3    IFNE *BLANKS
     C           WTRNO3    ANDNEXTRNO
     C           WTRNO2    ORNE *BLANKS
     C           WTRNO2    ANDNEXTRNO
     C                     MOVEL'Y'       NOFREF
     C                     ENDIF
      *
     C                     ELSE
     C                     MOVEL'Y'       NOFREF
     C                     ENDIF
      *
     C           NOFREF    IFEQ 'Y'
     C                     MOVEL*BLANKS   UFRRF
     C                     MOVEL*BLANKS   TFRRF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRWRPT - Write record to report                               *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: AOCURRR0                                               *
      *        ZFRPED                                                 *
      *                                                               *
      *****************************************************************
     C           SRWRPT    BEGSR
      *
      ** Write Page Heading if there's a change in Branch or Deal Type
      ** or the current line exceeds 55
      *
     C           NWBRCH    IFEQ 'Y'
     C           NWDTYP    OREQ 'Y'
     C           PRTLN1    ORGT 55
     C                     EXSR SRWRTH
     C                     MOVE 'N'       NWBRCH
     C                     MOVE 'N'       NWDTYP
     C                     ENDIF
      *
     C                     MOVE DLNO      RDLNO
     C                     MOVE BBCSSN    RCPTY
     C                     MOVE BBCRNM    RCPTYN
      *
     C                     SELEC
      *
      ** Forward Rate Agreement
      *
     C           RDTYP     WHEQ 'FR'
      *
     C           WUSIDE    IFEQ 'Y'
     C                     MOVE UCUCY     RCCY
     C                     ENDIF
      *
     C           WTSIDE    IFEQ 'Y'
     C                     MOVE TCUCY     RCCY
     C                     ENDIF
      *
      ** Determine Number of Decimal Places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY    '@OPTN   7
     C                     PARM           RCCY
     C***********SDCURR    PARM SDCURR    DSFDY                                               CSD006
     C           SDCURR    PARM SDCURR    DSSDY                                               CSD006
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD012       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           *DB ERROR 012 *
     C                     MOVELRCCY      DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADDA6NBDP    ZDECS   10
      *
      ** Format Principal Amount
      *
     C                     Z-ADDUPAMT     ZFLD15 150
     C                     MOVE 'J'       ZECODE  1
     C                     EXSR ZFRPED
     C           20        SUBSTZOUT22:1  NOSIGN 20
     C                     MOVE NOSIGN    RPAMT
      *
      ** Buy and Sell Indicator
      *
     C           BYSL      IFEQ 'S'
     C                     MOVEL'Sell'    RBSIN
     C                     ELSE
     C           BYSL      IFEQ 'B'
     C                     MOVEL'Buy '    RBSIN
     C                     ENDIF
     C                     ENDIF
      *
      ** Format Reference Rate
      *
     C           BYSL      IFEQ 'S'
     C                     MOVE TRTSP     ZFIELD 16
     C                     ELSE
     C           BYSL      IFEQ 'B'
     C                     MOVE URTSP     ZFIELD 16
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RRRTE
      *
     C           WUSIDE    IFEQ 'Y'
     C                     MOVE UBRTT     RBRTC
     C                     ENDIF
      *
     C           WTSIDE    IFEQ 'Y'
     C                     MOVE TBRTT     RBRTC
     C                     ENDIF
      *
      ** Format Base Rate
      *
     C           WUSIDE    IFEQ 'Y'
     C                     MOVE WUBRTE    ZFIELD 16
     C                     ENDIF
     C           WUBRTE    IFLT 0                                                             226723
     C                     MOVE '-'       RBSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RBSGN                                               226723
     C                     ENDIF                                                              226723
      *
     C           WTSIDE    IFEQ 'Y'
     C                     MOVE WTBRTE    ZFIELD 16
     C           WTBRTE    IFLT 0                                                             226723
     C                     MOVE '-'       RBSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RBSGN                                               226723
     C                     ENDIF                                                              226723
      *                                                                                       226723
     C                     ENDIF
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RBRTE
      *
      ** Format Settlement Amount
      *
     C           WPRIN     IFEQ 'P'
     C                     Z-ADDWUSAMT    ZFLD15 150
     C                     ENDIF
      *
     C           WPRIN     IFEQ 'R'
     C                     Z-ADDWTSAMT    ZFLD15 150
     C                     ENDIF
     C                     MOVE 'J'       ZECODE  1
      *
     C                     EXSR ZFRPED
      *
     C           20        SUBSTZOUT22:1  NOSIGN 20
     C                     MOVE NOSIGN    RSAMT
      *
      ** Write FRA Detail to report
      *
     C                     WRITEFRADTL
      *
      ** Interest Rate Swap (IRS)
      *
     C           RDTYP     WHEQ 'RS'
     C           RDTYP     OREQ 'RX'
      *
     C           WUSIDE    IFEQ 'Y'
      *
      ** Condition 'Interest Settlement Amount'
      *
     C           UINPM     IFEQ 'Y'
     C           UINPM     OREQ 'D'
     C                     MOVE '1'       *IN77
     C                     ELSE
     C                     MOVE '0'       *IN77
     C                     ENDIF
      *
     C                     MOVE UCUCY     RCCY
      *
      ** Obtain number of decimal places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY    '@OPTN   7
     C                     PARM           UCUCY
     C***********SDCURR    PARM SDCURR    DSFDY                                               CSD006
     C           SDCURR    PARM SDCURR    DSSDY                                               CSD006
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD013       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           *DB ERROR 013 *
     C                     MOVELUCUCY     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADDA6NBDP    ZDECS   10
     C                     Z-ADDUPAMT     ZFLD15 150
     C                     MOVE 'J'       ZECODE  1
      *
      ** Format Principal Amount
      *
     C                     EXSR ZFRPED
      *
     C           20        SUBSTZOUT22:1  NOSIGN 20
     C                     MOVE NOSIGN    RPAMT
      *
     C                     MOVEL'Our'     ROT       P
     C                     MOVE UBRTT     RBRTC
      *
      ** Format Spread Rate
      *
     C                     MOVE URTSP     ZFIELD 16
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RSPRD
      *
     C                     SELEC
     C           USPIN     WHEQ 'P'
     C                     MOVE '%'       RSIGN
     C           USPIN     WHEQ 'S'
     C                     MOVE '-'       RSIGN
     C                     OTHER
     C                     MOVE *BLANK    RSIGN
     C                     ENDSL
      *
      ** Format Previous Effective Rate
      *
     C                     MOVE WUPEIR    ZFIELD 16
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RPERTE
     C           WUPEIR    IFLT 0                                                             226723
     C                     MOVE '-'       RPSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RPSGN                                               226723
     C                     ENDIF                                                              226723
      *
      ** Format Base Rate
      *
     C                     MOVE WUBRTE    ZFIELD 16
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RBRTE
     C           WUBRTE    IFLT 0                                                             226723
     C                     MOVE '-'       RBSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RBSGN                                               226723
     C                     ENDIF                                                              226723
      *
      ** Format New Effective Rate
      *
     C                     MOVE WUFXRT    ZFIELD 16
     C                     Z-ADD7         ZADEC
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RNERTE
     C           WUFXRT    IFLT 0                                                             226723
     C                     MOVE '-'       RNSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RNSGN                                               226723
     C                     ENDIF                                                              226723
      *
      ** If interest up front then format 'Interest Settlement Amount'
      *
     C           *IN77     IFEQ '1'
     C                     Z-ADDWUSAMT    ZFLD15 150
     C                     MOVE 'J'       ZECODE  1
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    RSAMT
     C                     ENDIF
      *
      ** Write IRS Detail to report
      *
     C                     WRITEIRSDTL
      *
     C                     ENDIF
      *
     C           WTSIDE    IFEQ 'Y'
      *
      ** Condition 'Interest Settlement Amount'
      *
     C           TINPM     IFEQ 'Y'
     C           TINPM     OREQ 'D'
     C                     MOVE '1'       *IN77
     C                     ELSE
     C                     MOVE '0'       *IN77
     C                     ENDIF
      *
     C                     MOVE TCUCY     RCCY
      *
      ** Obtain number of decimal places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY    '@OPTN   7
     C                     PARM           TCUCY
     C***********SDCURR    PARM SDCURR    DSFDY                                               CSD006
     C           SDCURR    PARM SDCURR    DSSDY                                               CSD006
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD014       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           *DB ERROR 014 *
     C                     MOVELTCUCY     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADDA6NBDP    ZDECS   10
     C                     Z-ADDTPAMT     ZFLD15 150
     C                     MOVE 'J'       ZECODE  1
      *
      ** Format Principal Amount
      *
     C                     EXSR ZFRPED
      *
     C           20        SUBSTZOUT22:1  NOSIGN 20
     C                     MOVE NOSIGN    RPAMT
      *
     C                     MOVEL'Their'   ROT       P
     C                     MOVE TBRTT     RBRTC
      *
      ** Format Spread Rate
      *
     C                     MOVE TRTSP     ZFIELD 16
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RSPRD
      *
     C                     SELEC
     C           TSPIN     WHEQ 'P'
     C                     MOVE '%'       RSIGN
     C           TSPIN     WHEQ 'S'
     C                     MOVE '-'       RSIGN
     C                     OTHER
     C                     MOVE *BLANK    RSIGN
     C                     ENDSL
      *
      ** Format Previous Effective Rate
      *
     C                     MOVE WTPEIR    ZFIELD 16
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RPERTE
      *                                                                                       226723
     C           WTPEIR    IFLT 0                                                             226723
     C                     MOVE '-'       RPSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RPSGN                                               226723
     C                     ENDIF                                                              226723
      *
      ** Format Base Rate
      *
     C                     MOVE WTBRTE    ZFIELD 16
     C                     Z-ADD7         ZADEC   10
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RBRTE
      *                                                                                       226723
     C           WTBRTE    IFLT 0                                                             226723
     C                     MOVE '-'       RBSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RBSGN                                               226723
     C                     ENDIF                                                              226723
      *
      ** Format New Effective Rate
      *
     C                     MOVE WTFXRT    ZFIELD 16
     C                     Z-ADD7         ZADEC
     C                     EXSR ZEDIT
     C           14        SUBSTZFIELD:1  ZFLD5  14
     C                     MOVE ZFLD5     RNERTE
     C           WTFXRT    IFLT 0                                                             226723
     C                     MOVE '-'       RNSGN                                               226723
     C                     ELSE                                                               226723
     C                     MOVE ' '       RNSGN                                               226723
     C                     ENDIF                                                              226723
      *
      ** If Interest up front then format Interest Settlement Amount
      *
     C           *IN77     IFEQ '1'
     C                     Z-ADDWTSAMT    ZFLD15 150
     C                     MOVE 'J'       ZECODE  1
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    RSAMT
     C                     ENDIF
      *
      ** Write IRS Detail to report
      *
     C                     WRITEIRSDTL
      *
     C                     ENDIF
      *
     C                     ENDSL
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRWRTH - Write Report Heading                                 *
      *                                                               *
      * Called by: Main Routine                                       *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRWRTH    BEGSR
      *
     C                     MOVE '0'       *IN50
     C                     MOVE BJURPT    RTITLE
     C                     MOVE BJMRDT    RDATE
     C           RERUN     IFEQ 'Y'
     C                     MOVE '1'       *IN50
     C                     ENDIF
     C                     MOVE BRCA      RBRCA
     C                     MOVE A8BRNM    RBRNM
     C                     MOVE DTYP      RDTYP
     C           RDTYP     IFEQ 'RS'
     C                     MOVE IRS       RDTYPT
     C                     ENDIF
     C           RDTYP     IFEQ 'RX'
     C                     MOVE IRX       RDTYPT
     C                     ENDIF
      *
     C                     WRITEPGHEAD
      *
     C           RDTYP     IFEQ 'FR'
     C                     WRITEFRAHEAD
     C                     ENDIF
      *
     C           RDTYP     IFEQ 'RS'
     C           RDTYP     OREQ 'RX'
     C                     WRITEIRSHEAD
     C                     ENDIF
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *                                                               *
      * SRDETN - Determine next change date                           *
      *                                                               *
      * Called by: SRCPSX                                             *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
     C           SRDETN    BEGSR
     C                     Z-ADDZDAYNO    PRDT
     C           KIRSTL    SETGTDLDTSCPD
     C           KIRSTP    READEDLDTSCPD                 99*
     C           *IN99     IFEQ '0'
     C                     Z-ADDPRDT      ZDAYNO  50
     C                     ELSE
     C                     Z-ADDMDAT      ZDAYNO
     C                     END
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *
      * SR/TLXNOT  -  To calculate telex notice date for a ccy/nostro
      *               and add to array.
      *               Saves calculating telex notice dates for all
      *               possible ccy/location combinations during first
      *               cycle processing. Stored by nostro for convenience
      *
      * Input:     ZCCY1 - currency
      *            ZNOS1 - nostro (may be blank if not entered)
      *            ZCCY2 - local currency (set up in 1st cycle)
      *            ZLOC2 - system location (set up in 1st cycle)
      *
      * Called by: Main Processing
      *
      * Calls    : ZF2C - calculate common working date
      *
      *****************************************************************
     C           TLXNOT    BEGSR                           ** TLXNOT **
      *
     C           WSTM      IFEQ 01
     C           WSTM      OREQ 07
     C           WSTM      OREQ 08
      *
      ** Set up ccy/nostro ready to obtain telex notice days
     C                     Z-ADD1         X       30
     C           TCYN1     LOKUPCN,X                     24
      *
      ** If element for ccy/nostro not found, set it up
      ** This will also setup the index, X.
     C           *IN24     IFEQ '0'
     C                     MOVELTCYN1     ZCCY1
     C                     MOVE SNOS1     ZNOS1
      *
      ** increment array index
     C                     ADD  1         Y
      *
      ** set up today's date for SR/ZF2C
     C                     Z-ADDBJRDNB    ZDAYNO
      *
      ** read currencies file for telex notice days
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           ZCCY1
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** if database error
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD015       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           *DB ERROR 015 *
     C                     MOVELZCCY1     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *
     C           ZNOS1     IFNE *BLANKS
     C           ZNOS1     ANDNE'00'
      *
      ** read nostros file to obtain location
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM *BLANKS   @KEY3   6
     C                     PARM           ZCCY1
     C**********           PARM *BLANKS   @KEY4   4                                           CGL029
     C                     PARM *BLANKS   @KEY4  10                                           CGL029
     C                     PARM *BLANKS   @KEY2   2
     C                     PARM           ZNOS1   2
     C                     PARM *BLANKS   @KEYF   3
     C                     PARM *BLANKS   @KEYG  10
     C                     PARM *BLANKS   @KEYH   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      ** if database error
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD016       DBASE            ***************
     C                     MOVEL'SDNOSTPD'DBFILE           *DB ERROR 016 *
     C                     MOVELZCCY1     DBKEY            ***************
     C                     MOVE ZNOS1     DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      ** obtain location code (last 3 chars of shortname)
     C                     MOVE A7NOSN    ZLOC1
      *
     C                     ELSE
      ** unallocated nostro - set location to blanks
     C                     MOVE *BLANKS   ZLOC1
     C                     END
      *
     C                     Z-ADDA6TXND    ZNRDYS
     C           ZNRDYS    IFEQ 0
     C                     Z-ADDBJRDNB    TNDA,Y
     C                     ELSE
     C                     EXSR ZF2C
     C                     Z-ADDZDYNBR    TNDA,Y
     C                     END
     C                     MOVELZCCY1     CN,Y
     C                     MOVE ZNOS1     CN,Y
     C                     Z-ADDY         X
      *
     C                     ENDIF
      *
     C                     Z-ADDTNDA,X    TLXCMP  50
      *
     C                     ELSE
     C                     Z-ADDTNDAL     TLXCMP
     C                     ENDIF
      *
     C           TLXEND    ENDSR                           ** TLXEND **
      *
     C/EJECT
      *****************************************************************                     BUG11267
      *                                                               *                     BUG11267
      *  SRBACK - Generate additional record in DLINDDM for deals     *                     BUG11267
      *           that are backvalued, to ensure MT362 for current    *                     BUG11267
      *           period is correct.                                  *                     BUG11267
      *                                                               *                     BUG11267
      *  Called By: SRRFDN                                            *                     BUG11267
      *  Calls: None.                                                 *                     BUG11267
      *                                                               *                     BUG11267
      *****************************************************************                     BUG11267
      *                                                                                     BUG11267
     C           SRBACK    BEGSR                                                            BUG11267
      *                                                                                     BUG11267
     C                     MOVE *BLANK    CNPR                                              BUG11267
     C                     MOVE *BLANK    REPR                                              BUG11267
     C                     Z-ADD*ZERO     RRLA                                              BUG11267
     C                     MOVE *BLANK    DADI                                              BUG11267
     C                     Z-ADD*ZERO     PRI1                                              BUG11267
     C                     Z-ADD*ZERO     PRI2                                              BUG11267
     C                     Z-ADD*ZERO     PRI3                                              BUG11267
     C                     MOVE *BLANK    ZZ004                                             BUG11267
     C                     Z-ADD*ZERO     ICIN                                              BUG11267
     C                     Z-ADD*ZERO     RRNT                                              BUG11267
     C                     Z-ADD*ZERO     TNLU                                              BUG11267
     C                     Z-ADD*ZERO     PIAMT                                             BUG11267
     C                     Z-ADD*ZERO     RIAMT                                             BUG11267
      *                                                                                     BUG11267
     C                     TESTB'0'       UDNSI          21                                 BUG11267
     C                     TESTB'0'       TDNSI          22                                 BUG11267
      *                                                                                     BUG11267
     C           UINFD     IFLE BJRDNB                                                      BUG11267
     C           SVRFIN    ANDEQ'P'                                                         BUG11267
     C           SVTFIN    ANDNE'P'                                                         BUG11267
     C           *IN21     ANDEQ'1'                                                         BUG11267
     C                     MOVE 'D'       CNRQ                                              BUG11267
     C                     Z-ADDUEINR     UFIR                                              BUG11267
     C                     Z-ADDUSLIP     EVDAT                                             BUG11267
     C                     ADD  1         RECCNT                                            BUG11267
     C                     WRITEDTRIEPHF                                                    BUG11267
     C                     ENDIF                                                            BUG11267
      *                                                                                     BUG11267
     C           TINFD     IFLE BJRDNB                                                      BUG11267
     C           SVTFIN    ANDEQ'P'                                                         BUG11267
     C           SVRFIN    ANDNE'P'                                                         BUG11267
     C           *IN22     ANDEQ'1'                                                         BUG11267
     C                     MOVE 'F'       CNRQ                                              BUG11267
     C                     Z-ADDTEINR     TFIR                                              BUG11267
     C                     Z-ADDTSLIP     EVDAT                                             BUG11267
     C                     ADD  1         RECCNT                                            BUG11267
     C                     WRITEDTRIEPHF                                                    BUG11267
     C                     ENDIF                                                            BUG11267
      *                                                                                     BUG11267
     C           TINFD     IFLE BJRDNB                                                      BUG11267
     C           UINFD     ANDLEBJRDNB                                                      BUG11267
     C           SVTFIN    ANDEQ'P'                                                         BUG11267
     C           SVRFIN    ANDEQ'P'                                                         BUG11267
     C           WSPRT     ANDNE'Y'                                                         BUG11267
     C           UNICD     ANDEQTNICD                                                       BUG11267
     C           *IN21     ANDEQ'1'                                                         BUG11267
     C           *IN22     ANDEQ'1'                                                         BUG11267
     C                     MOVE 'H'       CNRQ                                              BUG11267
     C                     Z-ADDUEINR     UFIR                                              BUG11267
     C                     Z-ADDTEINR     TFIR                                              BUG11267
     C                     Z-ADDUSLIP     EVDAT                                             BUG11267
     C                     ADD  1         RECCNT                                            BUG11267
     C                     WRITEDTRIEPHF                                                    BUG11267
     C                     ENDIF                                                            BUG11267
      *                                                                                     BUG11267
     C           UINFD     IFLE BJRDNB                                                      BUG11267
     C           SVTFIN    ANDEQ'P'                                                         BUG11267
     C           SVRFIN    ANDEQ'P'                                                         BUG11267
     C           UNICD     ANDNETNICD                                                       BUG11267
     C           *IN21     ANDEQ'1'                                                         BUG11267
     C                     MOVE 'D'       CNRQ                                              BUG11267
     C                     Z-ADDUEINR     UFIR                                              BUG11267
     C                     Z-ADDUSLIP     EVDAT                                             BUG11267
     C                     ADD  1         RECCNT                                            BUG11267
     C                     WRITEDTRIEPHF                                                    BUG11267
     C                     ENDIF                                                            BUG11267
      *                                                                                     BUG11267
     C           TINFD     IFLE BJRDNB                                                      BUG11267
     C           SVTFIN    ANDEQ'P'                                                         BUG11267
     C           SVRFIN    ANDEQ'P'                                                         BUG11267
     C           UNICD     ANDNETNICD                                                       BUG11267
     C           *IN22     ANDEQ'1'                                                         BUG11267
     C                     MOVE 'F'       CNRQ                                              BUG11267
     C                     Z-ADDTEINR     TFIR                                              BUG11267
     C                     Z-ADDTSLIP     EVDAT                                             BUG11267
     C                     ADD  1         RECCNT                                            BUG11267
     C                     WRITEDTRIEPHF                                                    BUG11267
     C                     ENDIF                                                            BUG11267
      *                                                                                     BUG11267
     C                     ENDSR                                                            BUG11267
      *                                                                                     BUG11267
     C/EJECT                                                                                BUG11267
      *****************************************************************
      *                                                               *
      *  AUDIT  - Subroutine to Output Audit report and End Program.  *
      *                                                               *
      *  Called By: Main Processing, *PSSR                            *
      *  Calls: None.                                                 *
      *                                                               *
      *****************************************************************
      *
     C           AUDIT     BEGSR
      *
     C           RECCNT    SUB  2         RCOUNT
     C                     Z-ADDUNRECD    UNRCNT                                              CIR008
      *
      ***  Output Report Header
      *
     C                     WRITEHEADAU
      *
      ***  If there is a DB Error, Output the DB Error Information.
      *
     C           *INU7     IFEQ *ON
     C                     WRITEDBERROR
     C                     ENDIF
      *
      ***  Or, if no records read, Output "No Details" message.
      *
     C           RECCNT    IFEQ 2
     C           *INU7     ANDEQ*OFF
     C           UNRECD    OREQ 0                                                             CIR008
     C           *INU7     ANDEQ*OFF                                                          CIR008
     C           CIR008    ANDEQ'Y'                                                           CIR008
     C                     WRITENODTLS
     C                     ELSE
     C           RECCNT    IFGT 2
     C           UNRECD    ORGT 0                                                             CIR008
     C           CIR008    ANDEQ'Y'                                                           CIR008
     C                     WRITECONTROL
     C                     ENDIF
     C                     ENDIF
      *
     C           AUOPEN    IFEQ 'Y'
     C                     CLOSEDL1924AU
     C                     ENDIF
      *
      ***  End program and return to control calling program
      *
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *                                                               *
      *  RCFAU  - Subroutine to register the AU Printer File via RCF. *
      *                                                               *
      *****************************************************************
      *
     C           RCFAU     BEGSR
      *
      ***  Ensure Audit Spool File recorded by RCF.
      *
     C           AUOPEN    IFNE 'Y'
     C                     OPEN DL1924AU
     C                     MOVE 'Y'       AUOPEN  1
     C                     ENDIF
      *
     C                     Z-ADDSFNUMU    ZSNUMU  60
      *
     C                     CALL 'ZSFILE'
     C                     PARM *BLANKS   SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILEU
     C                     PARM           ZSNUMU
     C                     PARM           ZSERR   1
      *
      ***  If Error occurs during ZSFILE processing, then return to the
      ***  Calling Program.
      *
     C           ZSERR     IFEQ 'Y'
     C                     EXSR *PSSR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      *
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C                     SETON                     U7U8LR
     C                     EXSR AUDIT
     C                     ENDIF
      *
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
     C/COPY ZSRSRC,ZFRPEDZ3
      /EJECT
     C/COPY ZSRSRC,ZEDITZ2
      /EJECT
     C/COPY ZSRSRC,ZF2C
      /EJECT
     C/COPY ZSRSRC,ZFWDT
      /EJECT
     C/COPY ZSRSRC,ZBKDT
      /EJECT
     C/COPY ZSRSRC,ZACCH
      /EJECT                                                              CIR005
     C/COPY ZSRSRC,ZFRQB3                                                 CIR005
      /EJECT                                                              CIR005
     C/COPY ZSRSRC,ZCHKH                                                  CIR005
      /EJECT                                                              CIR005
     C/COPY ZSRSRC,ZDATE1Z2                                               CIR005
      /EJECT                                                              CIR005
     C/COPY ZSRSRC,ZDATE2Z2                                               CIR005
**  CPY@ - Object Copyright
(c) Finastra International Limited 2001
**  COMB/FRFX
STRSUR   Y
SURSTR   Y
SU STRSURY
ST SURSTRY
AABAABAABC
AABAABAABC
AABAABAABC
AABAABAABC
AABAABAABC
AABAABAABC
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN                      CIR005
0366073110961461                                                          CIR005
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR                        CIR005
000031059090120151181212243273304334365                                   CIR005
**   ZMNM - MONTHS SHORT NAMES                                            CIR005
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC                                      CIR005
**   ZFMD  -  NUMBER OF DAYS IN THE MONTH                                 CIR005
312831303130313130313031                                                  CIR005
