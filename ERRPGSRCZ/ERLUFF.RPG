     H        1                           F
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas ER - CSSF FF Extract')
      *****************************************************************
      *                                                               *
      *  Midas - European Reporting (CSSF)                            *
      *                                                               *
      *  ERLUFF - FF Extract for CSSF Reporting                       *
      *                                                               *
      *  Function:  This program will read TRANS7 MBR to select       *
      *  (phase(s)) trades to be reported at CSSF. These are written  *
      *             in ERLUCBPP flat file.                            *
      *                                                               *
      *  Called  in : COB automatically  (Rundat)                     *
      *             : I/C by menu (Choosen date)                      *
      *                                                               *
      *  Called By: ERC0650 - CCSF Reporting                          *
      *                                                               *
      *  (c) Finastra International Limited 2005                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Prev Amend No. CSD027A            Date 11May06               *
      *                 CER001             Date 25Apr05               *
      *                 ULX042             DATE 14Apr03               *
      *                 UPG402             DATE 04Oct04               *
      *                 186797             DATE 07MAR01               *
      *                 ULX008             Date 25Jul00               *
      *                 180013             Date 29Jun00               *
      *                 180013             Date 29Jun00               *
      *                 ULX008             Date 17Apr00               *
      *                 ULX008             Date 21Feb00               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CSD027A- Conversion of cust. no. to alpha (post 103 build)   *
      *  CER001 - LUX Upgrade to MidasPlus                            *
      *  ULX042 - Change Control D to ULX008 (TAF Reporting)          *
      *  UPG402 - Recompile due to R4.02 upgrade                      *
      *  186797 - "Succursales" should also be reported to CSSF.      *
      *  ULX008 - CSSF Statutory Reporting : Change Control C         *
      *  180013 - Delete trades are reported as input trades          *
      *  180219 - Confusion between Beneficiary and Counterparty      *
      *           on Depot Movements                                  *
      *  ULX008 - "Commissariat aux Bourses" - Change control B       *
      *  ULX008 - CSSF Statutory Reporting : Commissariat aux Bourses *
      *                                                               *
      *****************************************************************
     FTRANS7  IF  E           K        DISK         KINFSR *PSSR
      ***  FF Trades details - Rtvidx
      *
     FERLUICL1IF  E           K        DISK         KINFSR *PSSR
      ***  LU I.C.D.
      *
     F***SDBRCHY6IF  E           K        DISK         KINFSR *PSSR                           CER001
     FSDBRX2L0IF  E           K        DISK         KINFSR *PSSR                              CER001
      ***  Branch Codes - Ext Details
      *
     F******INVTPDY6IF  E           K        DISK         KINFSR *PSSR    ULX008
      ***  Investment Type - Ext Details
      *
     F******INTYPDY6IF  E           K        DISK         KINFSR *PSSR    ULX008
      ***  Instrument Type - Ext Details
      *
     F******SEMKCDY6IF  E           K        DISK         KINFSR *PSSR    ULX008
      ***  Market Centre - Ext Details
      *
     F***SDCUSTY6IF  E           K        DISK         KINFSR *PSSR                           CER001
     FSDCUX2L0IF  E           K        DISK         KINFSR *PSSR                              CER001
      ***  Customer - Ext Details
      *
     F***TRANSDY6UF  E           K        DISK         KINFSR *PSSR                           CER001
     FFFTRX2L0UF  E           K        DISK         KINFSR *PSSR                              CER001
      ***  FF Trades Ext. details - Rtvidx
      *
     F******SECTYDY6IF  E           K        DISK         KINFSR *PSSR    ULX008
      ***  SE Security ext. Details
      *
     FINTYP   IF  E           K        DISK         KINFSR *PSSR
      ***  SE Instrument type details
      *
     F******SECTY   IF  E           K        DISK         KINFSR *PSSR    ULX008
      ***  SE Security details
      *
     FTRSET   IF  E           K        DISK         KINFSR *PSSR
      ***  FF Transaction Settlement Details
      *
     F***MARKTDY6IF  E           K        DISK         KINFSR *PSSR                    ULX008 CER001
     FFFMCX1L0IF  E           K        DISK         KINFSR *PSSR                              CER001
      ***  FF Market Centre - Ext Details                                 ULX008
      *                                                                   ULX008
     FERLUCBPPO   E                    DISK         KINFSR *PSSR
      ***  ER LU - CSSF Flat File
      *
      /EJECT
      ******/COPY ZSRSRC,ZSDESCZ1                                         ULX008
      /COPY ZSRSRC,ZDATE2Z1
      /COPY ZSRSRC,ZDATE9Z1
     E                    CPY@    1   1 80
      ***  Array containing Copyright statement
      *
      /SPACE 3
     ITRANSDF                                                             180013
      ***  Rename CHTP of TRANS7                                          180013
     I              CHTP                            LASTCH                180013
      *                                                                   180013
     ILDA       E DSLDA                         256
      ***  Local data area for database error details
      *
     IRUNDAT    E DSRUNDAT
      ***  Data Area giving Installation Control Details
      *
     IPSDS       SDS
      ***  Program Status Data Structure
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
     ISDSTRD    E DSSDSTRDPD
      ***  SD Securities Trading I.C.D.
      *
     ISDBRCH    E DSSDBRCHPD
     I              QQDFAC                          XXDFAC                                    CER001
      ***  SD Branch Details
      *
     ISDSECS    E DSSDSECSPD
      ***  SD Customer for Sec. Trading
      *
     ISDCUST    E DSSDCUSTPD
      ***  SD Customer Details
      *
     ISDCURR    E DSSDCURRPD
      ***  SD Currency Details
      *
     ISDBANK    E DSSDBANKPD                                                                  CER001
      ** Bank Details                                                                         CER001
      *                                                                                       CER001
     IDSFDY     E DSDSFDY                                                                     CER001
      ***  Short DS for Access Objects Programs                                               CER001
      *                                                                                       CER001
     IDSSDY     E DSDSSDY
      ***  Long DS for Access Objects Programs
      *
      ******/COPY ZSRSRC,ZSDESCZ2                                         ULX008
      /COPY ZSRSRC,ZDATE9Z2
      /EJECT
      *****************************************************************
      *                       M A I N L I N E S                       *
      *****************************************************************
      *
      ***  Read Records with LCD = date to work with
      *
     C           *LOVAL    SETLLTRANS7                     First Record
     C                     READ TRANSDF                  35
      *
      ***  While record exist for this date,
      *
     C           *IN35     DOWEQ*OFF
      *
      ***  Verify that the record is eligible to be reported to CSSF
      *
     C                     MOVE 'N'       WKDOIT  1        FLAG
      *
      ***  When branch Break, read branch details
      *
     C           BRCA      IFNE WKBRCA
     C                     MOVE BRCA      WKBRCA  3        Read BRCA details
      *
     C                     CALL 'AOBRCHR0'
     C                     PARM *BLANKS   PRTCD   7
     C                     PARM '*KEY   ' POPTN   7
     C                     PARM           WKBRCA
     C           SDBRCH    PARM SDBRCH    DSSDY
      *
     C           PRTCD     IFNE *BLANKS                    Error or not found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD5         DBASE            * DBERROR 005 *
     C                     MOVEL'SDBRCHPD'DBFILE    P      ***************
     C                     MOVELBRCA      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ****Access*LF/SDBRCHY6*to*retrieve*flag*"Include*data*for********                       CER001
      ** Access LF/SDBRX2L0 to retrieve flag "Include data for                                CER001
      **  Reporting"
     C********** BRCA      CHAINSDBRCHY6             99                                       CER001
     C           BRCA      CHAINSDBRX2L0             99                                       CER001
     C           *IN99     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD6         DBASE            * DBERROR 006 *
     C**********           MOVEL'SDBRCHY6'DBFILE    P      ***************                    CER001
     C                     MOVEL'SDBRX2L0'DBFILE    P      ***************                    CER001
     C                     MOVELBRCA      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF                           Branch break
      *
     C           VEINCL    IFNE 'Y'
     C           BRCA      SETGTTRANS7                     Next Branch
     C                     ELSE
     C                     MOVE 'Y'       WKDOIT  1        Branch to treat
     C                     ENDIF
      *
      ***  Only records with "Exclude from CAB Reporting" flag set to
      ***  'N' should be treated
      *
     C           WKDOIT    IFEQ 'Y'
     C********** TNBR      CHAINTRANSDY6            N99                                       CER001
     C           TNBR      CHAINFFTRX2L0            N99                                       CER001
      *
     C           *IN99     IFEQ *ON                        Not found
     C           *IN99     OREQ *OFF                       or Excluded
     C           FFCABR    ANDNE'N'
     C                     MOVE 'N'       WKDOIT           Bypass
     C                     ENDIF
      *
     C                     ENDIF                           WKDOIT
      *
     C           WKDOIT    IFEQ 'Y'
     C                     EXSR #CHKP                      Check to process
     C                     ENDIF
      *
      ***  Create Record into Flat File ERLUCBPP
      *
     C           WKDOIT    IFEQ 'Y'
     C                     EXSR #PROC
     C                     ENDIF
      *
      ***  Read next record
      *
     C                     READ TRANSDF                  35
     C                     ENDDO
      *****************************************************************
      *               E N D    O F    M A I N L I N E S               *
      *****************************************************************
      *
     C                     MOVE *ON       *INLR
     C                     RETRN
      /EJECT
      *****************************************************************
      *  #CHKP  - This routine is used to verify that record is to be *
      *  ------   processed                                           *
      *  Called by : Mainlines                                        *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #CHKP     BEGSR
      *
     C                     MOVE 'N'       WKDOIT  1        FLAG
      *
      ***  Trades will be processed
      ***       if they are cancelled this WKDATE
      ***       or if they are input this WKDATE
      ***       or if trasnaction date is this WKDATE
      *
     C*********  CHTP      IFEQ 'D'                        Deleted        180013
     C           LASTCH    IFEQ 'D'                        Deleted        180013
     C           LCD       ANDEQWKDATE                     At Working Date
     C*********  CHTP      OREQ 'I'                        or Inserted    180013
     C           LASTCH    OREQ 'I'                        or Inserted    180013
     C           LCD       ANDEQWKDATE                     At Working Date
     C           TRSD      OREQ WKDATE                     transaction date is WKDATE
      *
     C                     MOVE 'Y'       WKDOIT           Rec. to process
      *
      ***  Excluded trades which doesn't correspond to following criteria
      *
      ***  1) Trades with "Extracted Flag" to D
      ***      OR trades with "Extracted Flag" to I but
      ***      last change type not D
      *
     C********** TNBR      CHAINTRANSDY6            N99                                       CER001
     C           TNBR      CHAINFFTRX2L0            N99                                       CER001
     C           *IN99     IFEQ *ON                        Not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD17        DBASE            * DBERROR 017 *
     C**********           MOVEL'TRANSDY6'DBFILE    P      ***************                    CER001
     C                     MOVEL'FFTRX2L0'DBFILE    P      ***************                    CER001
     C                     MOVELTNBR      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           FFEXFL    IFEQ 'D'                        Reported as deleted
     C                     MOVE 'N'       WKDOIT
     C                     ENDIF
      *
     C           FFEXFL    IFEQ 'I'                        already reported as inserted
     C********** CHTP      ANDNE'D'                        Except for dele180013
     C           LASTCH    ANDNE'D'                        Except for dele180013
     C                     MOVE 'N'       WKDOIT
     C                     ENDIF
      *
      ***  1A) Trades deleted at transaction date and not yet reported
      *
     C           WKDOIT    IFEQ 'Y'                        if to be reported
     C***********CHTP******IFEQ 'D'                        when deleted   180013
     C           LASTCH    IFEQ 'D'                        when deleted   180013
     C           TRSD      ANDEQWKDATE                      at Transaction Date
     C           FFEXFL    ANDEQ' '                         and not yet reported
     C                     MOVE 'N'       WKDOIT              don't reported it
     C                     ENDIF
     C                     ENDIF
      *
      ***  2) If Customer and Broker are filled together
      *
     C           WKDOIT    IFEQ 'Y'                        to be processed
     C********** CUSC      IFNE 0                          Customer                          CSD027A
     C********** BOCO      ANDNE0                          Broker                            CSD027A
     C           CUSC      IFNE *BLANKS                    Customer                          CSD027A
     C           BOCO      ANDNE*BLANKS                    Broker                            CSD027A
     C                     MOVE 'N'       WKDOIT
     C                     ENDIF
     C                     ENDIF
      *
      ***  3) If Involved Customer Number of Contract is 0, Bypass
      *
     C           WKDOIT    IFEQ 'Y'                        to be processed
     C********** CUSC      IFNE 0                          Customer                          CSD027A
     C           CUSC      IFNE *BLANKS                    Customer                          CSD027A
     C           NOCO      ANDEQ0                           with 0 contract
     C                     MOVE 'N'       WKDOIT
     C                     ENDIF
     C                     ENDIF                           WKDOIT = 'Y'
      *
      ***  4) If Involved Broker Number of Contract is 0, Bypass
      *
     C           WKDOIT    IFEQ 'Y'                        to be processed
     C********** BOCO      IFNE 0                          Broker                            CSD027A
     C           BOCO      IFNE *BLANKS                    Broker                            CSD027A
     C           NOBO      ANDEQ0                           with 0 contract
     C                     MOVE 'N'       WKDOIT
     C                     ENDIF
     C                     ENDIF
      *
      ***  5) instrument processing type must be 3 or 6
      ***     Instrument inidicator should not be Y (OTC)                 ULX008
      *
     C           WKDOIT    IFEQ 'Y'                        to be processed
     C           ISTT      CHAININTYP                99
     C           *IN99     IFEQ *ON                        Not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD10        DBASE            * DBERROR 010 *
     C                     MOVEL'INTYP'   DBFILE    P      ***************
     C                     MOVELISTT      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           ISPT      IFNE 3                          Instrument
     C           ISPT      ANDNE6                          Processing Type
     C           ISTI      OREQ 'Y'                                       ULX008
     C                     MOVE 'N'       WKDOIT
     C                     ENDIF
      *
     C                     ENDIF                           WKDOIT='Y'
      *
      ***  6) If the "EEE Regulqted Market Centre" indicator from         ULX008
      ********LF/MARKTDY6*is*different*from*'Y',*then*bypass***********                ULX008 CER001
      ** LF/FFMCX1L0 is different from 'Y', then bypass                                       CER001
      *                                                                   ULX008
     C           WKDOIT    IFEQ 'Y'                        to be processedULX008
     C                     MOVELISTT      WMRKT   2                       ULX008
     C********** WMRKT     CHAINMARKTDY6             99                                ULX008 CER001
     C           WMRKT     CHAINFFMCX1L0             99                                       CER001
     C           *IN99     IFEQ *ON                        Not Found      ULX008
     C           *LOCK     IN   LDA                                       ULX008
     C                     MOVELPGM       DBPGM            ***************ULX008
     C                     Z-ADD17        DBASE            * DBERROR 017 *ULX008
     C**********           MOVEL'MARKTDY6'DBFILE    P      ***************             ULX008 CER001
     C                     MOVEL'FFMCX1L0'DBFILE    P      ***************                    CER001
     C                     MOVELWMRKT     DBKEY     P                     ULX008
     C                     OUT  LDA                                       ULX008
     C                     EXSR *PSSR                                     ULX008
     C                     ENDIF                                          ULX008
      *                                                                   ULX008
     C           MMEEEM    IFNE 'Y'                                       ULX008
     C                     MOVE 'N'       WKDOIT                          ULX008
     C                     ENDIF                                          ULX008
     C                     ENDIF                                          ULX008
      *                                                                   ULX008
      *****6)*If*Sec.*Shortname From Ext.*Details*of*Instrument*Type*is*BlULX008
      ******                                                              ULX008
      ******                                                              ULX008
     C******     WKDOIT    IFEQ 'Y'                        to be processedULX008
     C******     ISTT      CHAININTYPDY6             99                   ULX008
     C******     *IN99     IFEQ *ON                        Not Found      ULX008
     C******     *LOCK     IN   LDA                                       ULX008
     C******               MOVELPGM       DBPGM            ***************ULX008
     C******               Z-ADD11        DBASE            * DBERROR 011 *ULX008
     C******               MOVEL'INTYPDY6'DBFILE    P      ***************ULX008
     C******               MOVELISTT      DBKEY     P                     ULX008
     C******               OUT  LDA                                       ULX008
     C******               EXSR *PSSR                                     ULX008
     C******               ENDIF                                          ULX008
      ******                                                              ULX008
     C******     CBSESN    IFEQ *BLANKS                                   ULX008
     C******               MOVE 'N'       WKDOIT                          ULX008
     C******               ENDIF                                          ULX008
      ******                                                              ULX008
     C******               ENDIF                           WKDOIT = 'Y'   ULX008
      ******                                                              ULX008
      *****7)*check*if*Security*is*to*be included in CAB reporting        ULX008
      ********(Depending*of*Investment*type for Security Nominal Currency)ULX008
      ******                                                              ULX008
     C******     WKDOIT    IFEQ 'Y'                        to be processedULX008
      ******                                                              ULX008
     C******     CBSESN    CHAINSECTY                99                   ULX008
     C******     *IN99     IFEQ *ON                        Not Found      ULX008
     C******     *LOCK     IN   LDA                                       ULX008
     C******               MOVELPGM       DBPGM            ***************ULX008
     C******               Z-ADD12        DBASE            * DBERROR 012 *ULX008
     C******               MOVEL'SECTY'   DBFILE    P      ***************ULX008
     C******               MOVELCBSESN    DBKEY     P                     ULX008
     C******               OUT  LDA                                       ULX008
     C******               EXSR *PSSR                                     ULX008
     C******               ENDIF                            And I have NMCULX008
      ******                                                              ULX008
      *****Access investment type extended details using NMCY/SITP        ULX008
      ******                                                              ULX008
     C******               MOVE NMCY      KCCYI                           ULX008
     C******               MOVE SITP      KINVS                           ULX008
      ******                                                              ULX008
     C******     KINVT     CHAININVTPDY6             99                   ULX008
     C******     *IN99     IFEQ *ON                        Not Found      ULX008
     C******     *LOCK     IN   LDA                                       ULX008
     C******               MOVELPGM       DBPGM            ***************ULX008
     C******               Z-ADD13        DBASE            * DBERROR 013 *ULX008
     C******               MOVEL'INVTPDY6'DBFILE    P      ***************ULX008
     C******     KCCYI     CAT  KINVS:1   DBKEY     P                     ULX008
     C******               OUT  LDA                                       ULX008
     C******               EXSR *PSSR                                     ULX008
     C******               ENDIF                                          ULX008
      ******                                                              ULX008
      *****If*not*included*in*CAB*reporting,*Bypass                       ULX008
      ******                                                              ULX008
     C******     VUCABR    IFNE 'Y'                                       ULX008
     C******               MOVE 'N'       WKDOIT                          ULX008
     C******               ENDIF                                          ULX008
      ******                                                              ULX008
     C******               ENDIF                           WKDOIT = 'Y'   ULX008
      ******                                                              ULX008
      *****8)*If*Market*Indicator*is*not*'S'econdary,*Bypass              ULX008
      ******                                                              ULX008
     C******     WKDOIT    IFEQ 'Y'                        to be processedULX008
     C******     MKTI      IFNE 'S'                                       ULX008
     C******               MOVE 'N'       WKDOIT                          ULX008
     C******               ENDIF                                          ULX008
     C******               ENDIF                           WKDOIT = 'Y'   ULX008
      ******                                                              ULX008
      *****9)*If*Security*Product*Code*isn't*ACT*or*WAR,*Bypass           ULX008
      ******                                                              ULX008
     C******     WKDOIT    IFEQ 'Y'                        to be processedULX008
     C******     VUPRCD    IFNE 'ACT'                      Equities       ULX008
     C******     VUPRCD    ANDNE'WAR'                      Warrants       ULX008
     C******               MOVE 'N'       WKDOIT                          ULX008
     C******               ENDIF                                          ULX008
     C******               ENDIF                           WKDOIT = 'Y'   ULX008
      ******                                                              ULX008
      ****10)*If*not*market*centre*is*specifed,*The*trade*is*ignored      ULX008
      ******                                                              ULX008
     C******     WKDOIT    IFEQ 'Y'                        to be processedULX008
     C******     SMCC      IFEQ *BLANK                                    ULX008
     C******               MOVE 'N'       WKDOIT                          ULX008
     C******               ENDIF                                          ULX008
     C******               ENDIF                           WKDOIT = 'Y'   ULX008
      ******                                                              ULX008
      *****11)*Access*Market*centre*ext.*details*to*check*EEE*Regulated*MaULX008
      *********centre*flag*(must be set to 'Y')                           ULX008
      ******                                                              ULX008
     C******     WKDOIT    IFEQ 'Y'                        to be processedULX008
     C******     SMCC      CHAINSEMKCDY6             99                   ULX008
     C******     *IN99     IFEQ *ON                        Not Found      ULX008
     C******     *LOCK     IN   LDA                                       ULX008
     C******               MOVELPGM       DBPGM            ***************ULX008
     C******               Z-ADD14        DBASE            * DBERROR 014 *ULX008
     C******               MOVEL'SEMKCDY6'DBFILE    P      ***************ULX008
     C******               MOVELSMCC      DBKEY     P                     ULX008
     C******               OUT  LDA                                       ULX008
     C******               EXSR *PSSR                                     ULX008
     C******               ENDIF                                          ULX008
      ******                                                              ULX008
     C******     X8ERMC    IFNE 'Y'                                       ULX008
     C******               MOVE 'N'       WKDOIT                          ULX008
     C******               ENDIF                                          ULX008
     C******               ENDIF                           WKDOIT = 'Y'   ULX008
      *
      ***  12) if Counterparty Company Code is Blanks and
      ***         Counterparty Citizenship is 'LU', Bypass
      *
     C           WKDOIT    IFEQ 'Y'                        to be processed
      *
     C********** CUSC      IFNE 0                          Customer involved                 CSD027A
     C           CUSC      IFNE *BLANKS                    Customer involved                 CSD027A
     C                     MOVE CUSC      WKCUST  6        ALPHA 06
     C                     ENDIF
      *
     C********** BOCO      IFNE 0                          or Broker involved                CSD027A
     C           BOCO      IFNE *BLANKS                    or Broker involved                CSD027A
     C                     MOVE BOCO      WKCUST  6        ALPHA 06
     C                     ENDIF
      *
      ***  Access customer details
      *
     C                     MOVELWKCUST    WWCUST 10
      *
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM           WWCUST
     C                     PARM *BLANKS   DUMMY   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD15        DBASE            * DBERROR 015 *
     C                     MOVEL'SDCUSTPD'DBFILE    P      ***************
     C                     MOVELWWCUST    DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Access Customer Ext. details
      *
     C********** WKCUST    CHAINSDCUSTY6             99                                       CER001
     C           WKCUST    CHAINSDCUX2L0             99                                       CER001
     C           *IN99     IFEQ *ON                        Not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD16        DBASE            * DBERROR 016 *
     C**********           MOVEL'SDCUSTY6'DBFILE    P      ***************                    CER001
     C                     MOVEL'SDCUX2L0'DBFILE    P      ***************                    CER001
     C                     MOVELALPH06    DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *****If*Investment*Company*code*is*Blank*and*Customer*Citizenship*is180219
      *****Then*Bypass*************************************************** 180219
      ******                                                              180219
     C******     VFICCD    IFEQ *BLANKS                                   180219
     C******     BBCNCZ    ANDEQ'LU'                                      180219
     C******               MOVE 'N'       WKDOIT                          180219
     C******               ENDIF                                          180219
      *
     C                     ENDIF                           WKDOIT = 'N'
      *
     C                     ENDIF                           Select
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *  #PROC  - This routine will fill in ERLUCBD0 record Fields    *
      *  ------   and write it out                                    *
      *  Called by : Mainlines                                        *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           #PROC     BEGSR
      *
      ***  Reset Record Format
      *
     C                     CLEARERLUCBD0
      *
      *** C072 : Transaction Reference (External Identification)
      *
     C                     MOVE TNBR      ALPH06  6        6 alpha
     C           'FF'      CAT  ALPH06:0  LUC072    P
     C***********CHTP******IFEQ 'D'                        Deletion       180013
     C           LASTCH    IFEQ 'D'                        Deletion       180013
     C           LUC072    CAT  'D':0     LUC072            Transaction Ref.
      *
      ***  C009 : Cancellation indicator
      *
     C                     MOVEL'O'       LUC009            Cancellation Flag
     C                     ELSE
     C           LUC072    CAT  'I':0     LUC072           Insertion
     C                     MOVEL'N'       LUC009            Cancellation Flag
     C                     ENDIF
      *
      ***  C011 : Date of Transaction
      *
     C                     Z-ADDTRSD      @@DAYN  50
     C                     EXSR ZDATE9
      *
     C           @@RTN     IFEQ '1'                        Error flag
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD20        DBASE            * DBERROR 020 *
     C           'TRADE DA'CAT  'TE'      DBFILE    P      ***************
     C                     MOVELTRSD      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADD@@VDT     LUC011            Trade Date
      *
      ***  C012 : time of Transaction
      *
     C********** TNBR      CHAINTRANSDY6             99                                       CER001
     C           TNBR      CHAINFFTRX2L0             99                                       CER001
     C           *IN99     IFEQ *ON                         Not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD21        DBASE            * DBERROR 021 *
     C**********           MOVEL'TRANSDY6'DBFILE    P      ***************                    CER001
     C                     MOVEL'FFTRX2L0'DBFILE    P      ***************                    CER001
     C                     MOVELTNBR      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           FFTIME    MULT 1000      LUC012            Time of Trans.
      *
      ***  C013 : Ext. ID of Cancelled Transaction
      *
     C           LUC009    IFEQ 'O'                        Cancelled trade ?
     C           'FF'      CAT  ALPH06:0  LUC013
     C           LUC013    CAT  'I':0     LUC013            Ext. ID of Cancel. Trans.
     C                     ENDIF
      *
      ***  C014 : Reference of Investment Company
      *
     C           LUC009    IFEQ 'N'
     C                     MOVELLUC072    LUC014            Ref of Invst. Company
     C                     ENDIF
      *
      ***  C015 : ID of Investment Company
      *
     C                     MOVELVPINCC    LUC015            ID of Invst. Company
      *
      ***  C016 : Identification of Customer Account
      *
     C********** CUSC      IFNE 0                                                            CSD027A
     C           CUSC      IFNE *BLANKS                                                      CSD027A
     C                     MOVE 'O'       LUC016            Id of Cust. Account
     C                     ELSE
     C                     MOVE 'N'       LUC016            Id of Cust. Account
     C                     ENDIF
      *
      ***  C017 : Type of counterparty
      *
     C           BBCNCZ    IFEQ 'LU'
     C           BBCOLC    OREQ 'LU'                                      186797
     C           VFICCD    ANDEQ*BLANKS                                   186797
     C                     MOVEL'LUX'     LUC017            Type of Counterparty
     C                     ELSE
     C                     MOVEL'ETR'     LUC017            Type of Counterparty
     C                     ENDIF
      *
      ***  C018 : Counterpart (Lux)
      ***  If the retrieved Investment Company Code is blank when C017    180219
      ***  is equal to 'LUX, C018 must be set to C015 (= VPINCC)          180219
      *                                                                   180219
      ***  C019 : Counterpart (Not Lux)
      *
     C           LUC017    IFEQ 'LUX'
     C           VFICCD    IFNE *BLANKS                                   180219
     C                     MOVELVFICCD    LUC018            Counterpart (Lux)
     C                     ELSE
     C                     MOVELVPINCC    LUC018                          180219
     C                     ENDIF                                          180219
     C                     ENDIF                                          ULX008
      *                                                                   180219
     C           LUC017    IFEQ 'ETR'                                     ULX008
     C           VPCTLN    IFEQ 'N'                                       ULX008
     C                     MOVEL*BLANKS   LUC019                          ULX008
     C                     ELSE                                           ULX008
     C                     MOVELBBCRNM    LUC019            Counterpart (Not Lux)
     C                     ENDIF
     C                     ENDIF                                          ULX008
      *
      ***  C020 : ISIN Code
      *
     C******               MOVELISIN      LUC020
     C                     MOVEL*BLANKS   LUC020
      *
      ***  C021 : Security code
      ***  C022 : Security Code Type
      *
     C******     LUC020    IFEQ *BLANKS                                   ULX008
      ******                                                              ULX008
      *****Access*Security*extended*details                               ULX008
      ******                                                              ULX008
     C******     CBSESN    CHAINSECTYDY6             99                   ULX008
     C******     *IN99     IFEQ *ON                        Not Found      ULX008
     C******     *LOCK     IN   LDA                                       ULX008
     C******               MOVELPGM       DBPGM            ***************ULX008
     C******               Z-ADD22        DBASE            * DBERROR 022 *ULX008
     C******               MOVEL'SECTYDY6'DBFILE    P      ***************ULX008
     C******               MOVELCBSESN    DBKEY     P                     ULX008
     C******               OUT  LDA                                       ULX008
     C******               EXSR *PSSR                                     ULX008
     C******               ENDIF                                          ULX008
      *
     C******               MOVELVVSECD    LUC021            Security Code ULX008
     C******               MOVELVVSNCD    LUC022   Security National Code ULX008
     C                     MOVEL*BLANKS   LUC021            Security Code ULX008
     C                     MOVEL*BLANKS   LUC022            Security National Code ULX008
     C******               ENDIF                                          ULX008
      *
      *****C023*:*Security*description*(using ZSDESC)
      ***  C023 : Security description
      *
      *****Input*Fields
      *
     C******               MOVELSRPN      ZSRPN            Sec. Report NamULX008
     C******               MOVELSFN1      ZSFN1                 Full name ULX008
     C******               MOVELSFN2      ZSFN2                 Full name ULX008
     C*                    Z-ADDCPNR      CPNR             Coupon rate
     C*                    Z-ADDMATY      MATY             Maturity date
     C*                    Z-ADDSCPP      SCPP             Redemption Price
     C*                    Z-ADDSCPD      SCPD             1st Redemption Price
     C******               MOVELBVRIDF    ZRSFD            Redemp. in Sec.ULX008
     C*                    MOVELSCPI      SCPI             Put/Call ind.
      *
     C******               EXSR ZSDESC
      *
     C******               MOVELZRNME     LUC023    P       Sec. DescriptiULX008
     C                     MOVELISTN      LUC023    P       Sec. Description ULX008
      *
      ***  C024 : Quantity
      *
     C********** CUSC      IFNE 0                           Customer                         CSD027A
     C           CUSC      IFNE *BLANKS                     Customer                         CSD027A
     C           CTAM      MULT NOCO      LUC024            opened contracts
     C                     ELSE                             Borrower
     C           CTAM      MULT NOBO      LUC024            opened Contracts
     C                     ENDIF
      *
      ***  Access Istrument Currency to Retrieve Decimal places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           ISCY
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           PRTCD     IFNE *BLANKS                    Error or Not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD23        DBASE            * DBERROR 023 *
     C                     MOVEL'SDCURRPD'DBFILE    P      ***************
     C                     MOVELISCY      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Amount taken into Account instrument CCY dec. places
      *
      *
     C                     Z-ADDA6NBDP    #I      10       (0 to 4)
     C                     DO   #I
     C           LUC024    DIV  10        LUC024            Quantity
     C                     ENDDO
      *
      ***  C025 : Amount = 0
      *
     C                     Z-ADD0         LUC025            Amount
      *
      ***  C026 : Transaction Price
      *
     C           ISPT      IFEQ 3                           Future's Price
     C                     Z-ADDCOPR      LUC026            Trans. Price
     C                     ENDIF
      *
     C           ISPT      IFEQ 6                           Option's Price
      *
      ***  For options set transaction price to premium paid
      ***  instead of Strike price
      *
     C******               Z-ADDSTRP      LUC026            Trans. Price
      *
     C           TNBR      CHAINTRSET                99
     C           *IN99     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD26        DBASE            * DBERROR 026 *
     C                     MOVEL'TRSET'   DBFILE    P      ***************
     C                     MOVE TNBR      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADDPRMP      LUC026            Trans. Price
     C                     Z-ADDA6NBDP    #I      10       (0 to 3)       ULX008
     C                     DO   #I                                        ULX008
     C           LUC026    DIV  10        LUC026            Trans. Price  ULX008
     C                     ENDDO                                          ULX008
     C                     ENDIF
      *
      ***  C027 : Flag Exchange Traded / OTC
      *
     C******     ISTI      IFEQ 'N'                                       ULX008
     C                     MOVE 'O'       LUC027            Exchange Traded / OTC
     C******               ELSE                                           ULX008
     C******               MOVE 'N'       LUC027            Exchange Traded / OTC ULX008
     C******               ENDIF                                          ULX008
      *
      ***  C028 : Aggregation Flag
      *
     C                     MOVE 'N'       LUC028            No Aggregation
      *
      ***  C029 : Product Code of the Security
      *
     C           ISPT      IFEQ 3                          Future
     C                     MOVE 'FUT'     LUC029            Product Code
     C                     ENDIF
      *
     C           ISPT      IFEQ 6                          Option
     C                     MOVE 'OPT'     LUC029            Product Code
     C                     ENDIF
      *
      *****C007*:*ISO*country*Code*of*NMCY                                ULX008
      ***  C007 : ISO country Code of ISCY                                ULX008
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C******               PARM           NMCY                            ULX008
     C                     PARM           ISCY                            ULX008
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           PRTCD     IFNE *BLANKS                    Error or Not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD24        DBASE            * DBERROR 024 *
     C                     MOVEL'SDCURRPD'DBFILE    P      ***************
     C******               MOVELNMCY      DBKEY     P                     ULX008
     C                     MOVELISCY      DBKEY     P                     ULX008
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     MOVELA6SWCY    LUC007            ISO Currency
      *
      ***  C030 : Purchase/Sale Code
      *
     C           LUC016    IFEQ 'N'                                       ULX042
     C           TRTY      IFEQ 'P'
     C                     MOVE 'A'       LUC030            Purchase
     C                     ELSE
     C                     MOVE 'V'       LUC030            Sale
     C                     ENDIF
     C                     ENDIF                                          ULX042
      *                                                                   ULX042
     C           LUC016    IFEQ 'O'                                       ULX042
     C           TRTY      IFEQ 'P'                                       ULX042
     C                     MOVE 'V'       LUC030            Purchase      ULX042
     C                     ELSE                                           ULX042
     C                     MOVE 'A'       LUC030            Sale          ULX042
     C                     ENDIF                                          ULX042
     C                     ENDIF                                          ULX042
      *
      ***  Additional Fields for Audit Report
      *
     C******               MOVELSESN      LUSSHN            Sec. ShortnameULX008
     C                     MOVEL*BLANKS   LUSSHN            Sec. ShortnameULX008
     C                     MOVELWKCUST    LUCNUM            Counterparty
     C                     MOVELBBCNCZ    LUCOCZ            Country of Citizenship
     C                     MOVELBRCA      LUBKBR            Booking Branch
      *
      ***  Write out Record
      *
     C                     WRITEERLUCBD0
      *
      *****Update*LF/TRANSDY6,*Extracted Flag to setup*****************                       CER001
      ** Update LF/FFTRX2L0, Extracted Flag to setup                                          CER001
      ***  Trades Cancelled : Flag = D
      ***  Others           : Flag = I
      *
     C********** TNBR      CHAINTRANSDY6             99                                       CER001
     C           TNBR      CHAINFFTRX2L0             99                                       CER001
     C           *IN99     IFEQ *ON                        Not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD25        DBASE            * DBERROR 025 *
     C**********           MOVEL'TRANSDY6'DBFILE    P      ***************                    CER001
     C                     MOVEL'FFTRX2L0'DBFILE    P      ***************                    CER001
     C                     MOVELTNBR      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C***********CHTP******IFEQ 'D'                                       180013
     C           LASTCH    IFEQ 'D'                                       180013
     C                     MOVE 'D'       FFEXFL
     C                     ELSE
     C                     MOVE 'I'       FFEXFL
     C                     ENDIF
     C                     UPDATTRANSDD6
      *
     C                     ENDSR
      /EJECT
      ******/COPY ZSRSRC,ZSDESCZ3                                         ULX008
      /COPY ZSRSRC,ZDATE2Z2
      /COPY ZSRSRC,ZDATE9Z3
      /EJECT
      *****************************************************************
      *  *INZSR - Innitial subroutine : automatically called at start *
      *  ------                                                       *
      *  Called by : at pgm start                                     *
      *  Calls     : *PSSR                                            *
      *****************************************************************
      *
     C           *INZSR    BEGSR
      *
      ***  Set up copyright parameter
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ***  Read in Installation Data
      *
     C           *NAMVAR   DEFN           RUNDAT
     C           *NAMVAR   DEFN           LDA
     C                     IN   RUNDAT
      *
      ***  Set Date Format Indicator *IN98  on if date format is MMDDYY
      *
     C           AGDFF     IFEQ 'M'
     C                     SETON                     98
     C                     ENDIF
      *
     C           *ENTRY    PLIST
     C                     PARM           PDATE   5        5 ALPHA
      *
      ***  If eqal to Zero, take midas rundate
      *
     C           PDATE     IFEQ '00000'
     C                     Z-ADDAGRDNB    WKDATE  50       Midas Run date
     C                     ELSE
     C                     MOVE PDATE     WKDATE  50
     C                     ENDIF
      *
      ***  Validate date as correct using ZDATE2
      *
     C                     Z-ADDWKDATE    ZDAYNO
     C                     EXSR ZDATE2
     C           *IN99     IFEQ *ON
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD1         DBASE            * DBERROR 001 *
     C                     MOVEL'*NONE'   DBFILE           ***************
     C           'WRONG '  CAT  'DATE'    DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                                       CER001
      ***  Access Bank Details                                                                CER001
      *                                                                                       CER001
     C                     CALL 'AOBANKR0'                                                    CER001
     C                     PARM *BLANKS   PRTCD                                               CER001
     C                     PARM '*FIRST ' POPTN                                               CER001
     C           SDBANK    PARM SDBANK    DSFDY                                               CER001
      *                                                                                       CER001
     C           PRTCD     IFNE *BLANKS                                                       CER001
     C           *LOCK     IN   LDA                                                           CER001
     C                     MOVELPGM       DBPGM                                               CER001
     C                     Z-ADD4         DBASE                                               CER001
     C                     MOVEL'SDBANKPD'DBFILE                                              CER001
     C                     MOVEL'*FIRST'  DBKEY                                               CER001
     C                     OUT  LDA                                                           CER001
     C                     EXSR *PSSR                                                         CER001
     C                     ENDIF                                                              CER001
      *
      ***  Read LU ICD
      *
     C           'LU'      CHAINERLUICL1             99
     C           *IN99     IFEQ *ON                        not Found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD2         DBASE            * DBERROR 002 *
     C                     MOVEL'ERLUICL1'DBFILE           ***************
     C                     MOVEL'LU'      DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Read SDSTRDPD details
      *
     C                     CALL 'AOSTRDR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*FIRST ' POPTN
     C           SDSTRD    PARM SDSTRD    DSSDY
      *
     C           PRTCD     IFNE *BLANKS                    Error or not found
     C           *LOCK     IN   LDA
     C                     MOVELPGM       DBPGM            ***************
     C                     Z-ADD3         DBASE            * DBERROR 003 *
     C                     MOVEL'SDSTRDPD'DBFILE           ***************
     C                     MOVEL'*FIRST'  DBKEY     P
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Key list for INVTYPX6
      *
     C           KINVT     KLIST
     C                     KFLD           KCCYI   3        Currency code
     C                     KFLD           KINVS   3        investment type
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *  *PSSR  - Program exception error routine                     *
      *  ------   Called automatically if a program error occurs,     *
      *           or directly by the program code using EXSR.         *
      *           This subroutine DUMPs the program just once.        *
      *  Called by :                                                  *
      *  Calls     :                                                  *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C                     END
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *
      ********************************************************************
** FILE TRANS. ERLUCBPP FILE TO REMOVE ALL NON STANDARD CHARACTERS
*EQUATE ERLUCBPP
*EQUATE C144504EC551C552C554C956C164C368406A406FC571C572C5744079407A407D407E407F
*EQUATE C181C282C383C484C585C686C787C888C989D191D292D393D494D595D696D797D898D999
*EQUATE E2A2E3A3E4A4E5A5E6A6E7A7E8A8E9A940E0E4FE409D4B6B4B9D
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
**  CPY@
(c) Finastra International Limited 2005
