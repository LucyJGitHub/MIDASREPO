     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas EU Account closure request')                     *
      *****************************************************************
      *                                                               *
      *  Midas - EMU Retail Utilities                                 *
      *                                                               *
      *  EU0160 - Bulk Retail Account Maintenance - Close 'In' Ccy    *
      *           Accounts - Submitted Job                            *
      *                                                               *
      *  Function: Closes 'In' currency accounts after mapping to     *
      *            Euro accounts is complete.                         *
      *                                                               *
      *  Called By: EUC0120                                           *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CRE073             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER047             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD027             Date 09Dec05               *
      *                 CLE025             Date 20Oct03               *
      *                 CRE008             Date 19Feb02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 134920             Date 08May98               *
      *                 CEU022  *CREATE    Date 16Jan98               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CRE008 - Cash Management                                     *
      *  134920 - No trailer processing performed when accounts       *
      *           closed                                              *
      *  CEU022 - EMU Retail Utilities                                *
      *                                                               *
      *****************************************************************
      *                                                               *
      *    F U N C T I O N   O F   I N D I C A T O R S                *
      *                                                               *
      *    80 & 81 Used for CHAIN and READ                            *
      *    98      Date format indicator                              *
      *                                                               *
      *****************************************************************
      *                   Index to subroutines                        *
      *                   ~~~~~~~~~~~~~~~~~~~~                        *
      *  INIT    -  Initial processing                                *
      *  END     -  Exits program                                     *
      *  PRCLOS  -  Processes 'In' currency account closure           *
      *  *PSSR   -  Exception error handling                          *
      *****************************************************************
      ** EMU Mapping List
     FEUACMLL0UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      *
      ** EMU Mapping Details Header
     FEUMDHDL0UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      *
      ** GL Account Master Detail
     FACCBR   UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      *                                                                   134920
      ** GL Account Master Trailer                                        134920
     FACCNTAC UF  E                    DISK                               134920
     F                                              KCOMIT                134920
     F                                              KINFSR *PSSR          134920
      *
     F/COPY WNCPYSRC,EUH00007
      *-----------------------------------------------------------------
      *E-Specifications
      *-----------------------------------------------------------------
     E                    CPY@    1   1 80
      *
      ** Array containing Copyright statement
      *
     E/COPY WNCPYSRC,EUH00018
      /SPACE 3
      *
      *-----------------------------------------------------------------
      *I-Specifications
      *-----------------------------------------------------------------
     E/COPY WNCPYSRC,EUH00008
      *                                                                -
     ILDA       E DSLDA                         256
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
     **                                     134 141 DBFILE
     **                                     142 170 DBKEY
     **                                     171 180 DBPGM
     **                                     181 1830DBASE
      *
      ** Midas SD Rundate
     IRUNDAT    E DSRUNDAT
      *
      ** External DS for bank details
     ISDBANK    E DSSDBANKPD
      *
      *  First DS for access program, short Data Structure
     IDSFDY     E DSDSFDY
      *
      * Second DS for access programs, long Data Structure
     IDSSDY     E DSDSSDY
      *
      * Midas lock up/release/update next transaction number
     I/COPY ZSRSRC,ZTNLU1Z1
      *
      * ===============================================================
      *  C - Specifications
      * ===============================================================
     C           *ENTRY    PLIST
     C                     PARM           P#MAPN  6
      *
      ** Read in Installation Data
      *
     C           *NAMVAR   DEFN           RUNDAT
     C           *NAMVAR   DEFN           LDA
     C                     IN   RUNDAT
      *
     C                     MOVEACPY@      MKI@   80
      *
      * ===============================================================
      *                     DEFINITIONS
      * ===============================================================
      *                                                                -
      ** Define Key Lists
      ** ~~~~~~~~~~~~~~~~
     C           K#KY01    KLIST
     C                     KFLD           BRCA
     C                     KFLD           CNUM
     C                     KFLD           CCY
     C                     KFLD           ACOD
     C                     KFLD           ACSQ
      *                                                                -
      ** Define Fields
      ** ~~~~~~~~~~~~~
     C           *LIKE     DEFN EUMAPN    W#MAPN
     C           *LIKE     DEFN BJRDNB    W#RUND
      *                                                                -
      * ===============================================================
      *                M A I N        P R O C E S S I N G
      * ===============================================================
      *
     C                     MOVE P#MAPN    W#MAPN
      *
     C                     EXSR INIT
      *
     C           W#MAPN    CHAINEUACMLL0             81
      *
      **  Main Loop
     C           *IN81     DOWEQ*OFF
      *
      **  Process account closure
     C                     EXSR PRCLOS
      *
     C           W#MAPN    READEEUACMLL0                 81
      *
     C                     ENDDO
      *
      **  Locate Map Number to be updated on EUMDHDL0
     C           W#MAPN    CHAINEUMDHDL0             80
      *
      **  Set 'In' currency account closure indicator to 'Y'
     C                     MOVE 'Y'       EUCLSE
      *
      **  Update Mapping Details Header file, commit changes
     C                     UPDATEUMDHDPF
     C                     COMIT
      *
      **  Close down processing
     C                     EXSR END
      *
      *
      *****************************************************************
      * INIT   : Initial Processing                                   *
      *****************************************************************
     C           INIT      BEGSR
      *
      **  Access Bank Details
     C                     CALL 'AOBANKR0'
     C                     PARM '*DBERR ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD01        DBASE
     C                     MOVEL'AOBANKR0'DBFILE
     C                     MOVEL'*FIRST  'DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      **  Check system date format, DDMMYY(98 off) or MMDDYY(98 on)
     C           BJDFIN    IFEQ 'M'
     C                     MOVE *ON       *IN98
     C                     ENDIF
      *
      ** Move Midas Run Date into work field
     C                     MOVE BJRDNB    W#RUND
      *
      **
     C           W#MAPN    CHAINEUMDHDL0             80
     C/COPY WNCPYSRC,EUH00009
      *
     C                     ENDSR
      *
      *
      *****************************************************************
      * PRCLOS : Processes 'In' currency account closure              *
      *****************************************************************
     C           PRCLOS    BEGSR
      *
     C                     MOVE EUIBRC    BRCA
     C                     MOVE EUICNM    CNUM
     C                     MOVE EUICCY    CCY
     C                     MOVE EUIACD    ACOD
     C                     MOVE EUISQN    ACSQ
      *
      ** Search for 'In' account on GL account master file
     C           K#KY01    CHAINACCBR                80
      *
      ** If account not found or already closed
     C           *IN80     IFEQ *ON
     C           RECI      OREQ 'C'                                       CRE008
     C***********ACST      OREQ 'C'                                       CRE008
      *
     C                     MOVE 'Y'       EUACLO
      *
      ** Update Mapping Details file
     C                     UPDATEUACMLPF
      *
     C                     ELSE
     C           ACST      IFEQ ' '                                       CRE008
     C           DACC      ANDEQ0                                         CRE008
      *                                                                   134920
      ** Save LCD and CHTP                                                134920
     C                     MOVELCHTP      PCHTP   1                       134920
     C                     Z-ADDLCD       PLCD    50                      134920
     C/COPY WNCPYSRC,EUH00010
      *
     C                     MOVE 'C'       ACST
     C                     MOVE W#RUND    LCD
     C                     MOVE W#RUND    DACC
     C                     MOVE 'C'       CHTP
      *
      ** Prevent update by multiple users
     C                     EXSR ZTNLU1
     C                     MOVE NATN      TNLU
      *
      ** Update GL Account Master file
     C                     UPDATACCNTABF
      *                                                                   134920
      ** Access ACCNTAC                                                   134920
     C           1         SETLLACCNTAC                                   134920
      *                                                                   134920
     C                     READ ACCNTAC                  80               134920
      *                                                                   134920
     C           *IN80     IFEQ '0'                                       134920
     C           NOCL      ADD  1         NOCL                            134920
     C           NOAU      SUB  1         NOAU                            134920
      *                                                                   134920
     C           PLCD      IFEQ W#RUND                                    134920
     C           PCHTP     ANDEQ'I'                                       134920
     C                     ADD  1         NORE                            134920
     C                     SUB  1         NINU                            134920
     C                     END                                            134920
      *                                                                   134920
     C           PLCD      IFEQ W#RUND                                    134920
     C           PCHTP     ANDEQ'A'                                       134920
     C                     SUB  1         NOAM                            134920
     C                     END                                            134920
      *                                                                   134920
      ** Force rundate in LCD                                             134920
     C                     Z-ADDW#RUND    LCD                             134920
     C                     Z-ADDNATN      TNLU                            134920
     C                     UPDATACCNTACF                                  134920
     C                     ENDIF                                          134920
     C/COPY WNCPYSRC,EUH00011
      *
     C                     ENDIF                                          CRE008
     C                     ENDIF
      *
     C                     ENDSR
      *
      *
      *****************************************************************
      * END    : Closedown                                            *
      *****************************************************************
     C           END       BEGSR
      *
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR                           ** *PSSR SR **
      *
     C           @RUN      IFEQ *BLANK
      *
     C                     MOVE 'Y'       @RUN    1
      *
     C                     DUMP
      *
     C                     ROLBK
      *
     C                     MOVE 'N'       EUCLSE
     C                     UPDATEUMDHDPF
     C                     COMIT
      *
     C                     ENDIF
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
      ********************************************************************
     C/COPY WNCPYSRC,EUH00012
**  CPY@
(c) Finastra International Limited 2001
