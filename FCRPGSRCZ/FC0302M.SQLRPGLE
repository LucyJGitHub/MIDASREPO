     H DATEDIT(*YMD)
      *****************************************************************
/**** *  RPGBASE                                                      *                     MD055265
/*STD *  RPGSQLBND                                                    *                     MD055265
/*EXI *  TEXT('Midas FC Edit report components')
     H/TITLE Edit Report Components    Edit file
     F* CRTRPGPGM
      *
     H* SYNOPSIS :
     H*  - Maintain database file using subfile display.
     H*  - Existing records may be updated or deleted,
     H*  - Key changes are not allowed.
     H*  - Program operates in two modes: *CHANGE and *ADD
     H*  - Multiple new records may be added by changing to add mode
     H* Generated by  : Synon/2  Version:  8646
     H* Function type : Edit file  Version:   0.1
      *
     H* Company    : Report Control Facility Model
     H* System     : Report Control Facility Model
     H* User name  : F6875SY
     H* Date       : 05/04/90 time: 18:18:46
      *  (c) Finastra International Limited 2001                      *
     H*
      *================================================================
     F* Maintenance   :
      *================================================================
     F*****************************************************************
     F*                                                               *
      *  Last Amend No. MD055265           Date 10Feb20               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD027             Date 09Dec05               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 S01407             Date 26Jan93               *
     F*                 LN1272             Date  20MAY91              *
     F*                     LN1190       DATE  29APR91                *
     F*                     LN1146       DATE  19APR91                *
     F*                     S01314       DATE  24APR91                *
     F*                     LN0828       DATE  05OCT90                *
     F*                     LN0521       DATE  19SEP90                *
     F*                     LN0685       DATE  04SEP90                *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  MD055265 - Deliverable Data Split for Report Control Facility*
      *  MD046248 - Finastra Rebranding                               *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
     F*      S01407 - SWITCHABILITY ENHANCEMENTS                      *
     F*      LN1272 - DISPLAY ALL ERROR MESSAGES AT ONCE IN CORRECT   *
     F*               ORDER.CHANGE SCREEN VALIDATION.                 *
     F*               REPLACE ALL 'Y2' MESSAGES WITH 'RCF' MESSAGES.  *
     F*      LN1190 - REMOVE 'USR' MESSAGES AND REPLACE WITH 'RCF'    *
     F*               MESSAGES.                                       *
     F*      LN1146 - 'DELETE' OPTION SHOULD BE SPECIFIED AT BOTTOM OF*
     F*               SCREEN AND RECORD SHOULD BE DELETED WHEN ACTION *
     F*               CODE IS DELETE AND ENTER PRESSED                *
     F*      S01314 - Changes made during PTF incorporation.          *
     F*               Multilanguage subfile message tags changed      *
     F*      LN0828 - SHOULD PRESS ENTER INSTEAD OF F12 TO GET PAST   *
     F*               2ND AND 3RD SCREENS                             *
     F*      LN0521 - VALIDATION AND '?' PROCESSING FOR BRANCH TYPE   *
     F*      LN0685 - STANDARDISE SCREEN APPEARANCE AND VALIDATION    *
     F*                                                               *
     F*****************************************************************
     F*Edit Report Components   Initialise Program F-Spec
     F/COPY WNCPYSRC,FC0302MFPG
     FFC0302M#  CF   E             WORKSTN
     F                                     SFILE(#SFLRCD:##RR)
     F                                     INFDS(INFDS#)
      * DSP: Edit Report Components    Edit file
      *
     F***********FCRCOML1IF  E           K        DISK                    S01407
     F*FCRCOMJ1* IF   E           K DISK                                         S01407     MD055265
     F**********                           INFDS(INFDS1)                                    MD055265
      * RTV: Report Components         Retrieval index
      *
     F***********FCREPTL1IF  E           K        DISK                    S01407
     F*FCREPTJ0* IF   E           K DISK                                         S01407     MD055265
      * RTV: Report Descriptions       Retrieval index
      *
     F*FCREPTL0* UF   E           K DISK                                                    MD055265
      * UPD: Report Descriptions       Update index
      *
     FFCRPDSL0  UF   E           K DISK
      * UPD: Report Descriptions Audit Update index
      *
     F*FCRCOML0* UF A E           K DISK                                                    MD055265
      * UPD: Report Components         Update index
      *
     FSCSARML2  UF   E           K DISK                                         S01407
      * UPD: Switchable Features Report Component                         S01407
      *                                                                   S01407
     D AEMQ            S             78    DIM(2) CTDATA PERRCD(1)
      *
     D CPY@            S             80    DIM(1) CTDATA PERRCD(1)
     D*Edit Report Components   Initialise Program E-Spec
     D/COPY WNCPYSRC,FC0302MEPG
     D @CN             S             25    DIM(11) CTDATA PERRCD(1)             Long constants.
     D*Edit Report Components   Initialise Program I-Spec
     D/COPY WNCPYSRC,FC0302MIPG
      /EJECT
      * Data structures:-
     D PGMDS         ESDS                  EXTNAME(Y2PGDSP)
      * Program data structure.
     D JBDTTM          DS
      * Job date/time.
     D  ##JDT                  1      6  0
     D  ##JYY                  1      2  0
     D  ##JMM                  3      4  0
     D  ##JDD                  5      6  0
     D  ##JTM                  7     12  0
     D  ##JHH                  7      8  0
     D  ##JNN                  9     10  0
     D  ##JSS                 11     12  0
     D INFDS#        E DS                  EXTNAME(Y2I#DSP)
      * Display file data structure.
      *
     D INFDS1        E DS                  EXTNAME(Y2I1DSP)
      * File information data structure.
      *
     D*@1DBRC***     E DS                  EXTNAME(FCRCOML0)                                MD055265
     D @1DBRC        E DS                  EXTNAME(FCRCOJW0)                                MD055265
     D                                     PREFIX(@)                                        MD055265
      * Current/previous master file format fields for change control.
      *
     D FCREPT        E DS                  EXTNAME(FCREPJW1)                                MD055265
     D FCREPTL       E DS                  EXTNAME(FCREPJW0)                                MD055265
     D                                     PREFIX(L)                                        MD055265
     D NullInds2       s              5i 0 dim(19)                                          MD055265
                                                                                            MD055265
     D RUNDAT          DS
     D  RUNA                   1      7
     D  RUND                   8     10P 0
     D  SSF                   11     11
     D  DATF                  12     12
     D  MBIN                  13     13
      /EJECT
      * Parameter declarations.
     D P1PARM          DS            25
      * KEY: Report Components         Retrieval index
      * I:RST Report name
     D  P1RNAM                 1     10
     D P2PARM          DS
      * I:    Action Code
     D  P2JTST                 1      1
     D*                                                                   S01407
     D PRCMSQ          DS            15                                         S01407
     D*                                                                   S01407
     D** PREVIOUS REPORT COMPONENT/SEQUENCE COMBINATION                   S01407
     D*                                                                   S01407
     D  ##COTT                 1     10                                         S01407
     D  ##CSEQ                11     15                                         S01407
     D*                                                                   S01407
     D CUCMSQ          DS            15                                         S01407
     D*                                                                   S01407
     D** CURRENT REPORT COMPONENT/SEQUENCE COMBINATION                    S01407
     D*                                                                   S01407
     D  J1COTT                 1     10                                         S01407
     D  J1CSEQ                11     15                                         S01407
     D FCRCOM        E DS                  EXTNAME(FCRCOJW1)                                MD055265
     D  XSARD        E                     EXTFLD(SARD)                                     MD055265
     D FCRCOML       E DS                  EXTNAME(FCRCOJW0)                                MD055265
     D                                     PREFIX(L)                                        MD055265
     D NullInds        s              5i 0 dim(12)                                          MD055265
      /EJECT
     C********************************************************************S01314
      *                                                                   S01314
      ** Call SDRTVTXT pgm to access appropriate text                     S01314
      ** for a field used in a SFL                                        S01314
      *                                                                   S01314
     C                   MOVEL     'ZZGBMSGF'    MSGNM                                         S0131
     C                   MOVEL     'ZZM1345'     MSGDNB                                        S0131
     C                   CALL      'SDRTVTXT'                                                  S0131
     C                   PARM                    MSGDNB            7                           S0131
     C                   PARM                    MSGNM            10                           S0131
     C                   PARM                    MSGTXT           80                           S0131
     C                   MOVEL     MSGTXT        ZZM002                                        S0131
      *                                                                   S01314
     C                   MOVEL     'ZZM0361'     MSGDNB                                        S0131
     C                   CALL      'SDRTVTXT'                                                  S0131
     C                   PARM                    MSGDNB            7                           S0131
     C                   PARM                    MSGNM            10                           S0131
     C                   PARM                    MSGTXT           80                           S0131
     C                   MOVEL     MSGTXT        ZZM003                                        S0131
      *                                                                   S01314
      *****************************************************************
     C     *ENTRY        PLIST                                                  Entry parameter
     C                   PARM                    P0RTN             7            Return code
     C                   PARM                    P1PARM                         KEY: Report Com
     C     P2JTST        PARM                    WP0001            1            Action Code
      *****************************************************************
      * Initialise
     C                   EXSR      ZZINIT
      *
     C                   DO        *HIVAL
     C                   MOVE      *BLANK        PRCMSQ                                        S0140
      * Initialise and load subfile page.
     C                   EXSR      BAIZSF
     C                   MOVEL     'N'           W0RSF             1
      * Display screen until reload requested:
     C     W0RSF         DOWEQ     'N'
      * Display screen.
     C                   EXSR      CAEXFM
      * Process response:
      * Exit request: Cancel & exit program.
     C   03              CAS                     ZXEXPG
      **HOME:*Request*subfile*reload.***
     C***05******          CAS            FBRQRL
      *   Display next SFL page.
     C   27              CAS                     BBLDSF
      * Process screen input.
     C                   CAS                     DAPR##
     C                   END
      *
     C                   END                                                    OD W0RSF
     C                   END                                                    OD *HIVAL
      *****************************************************************
      /EJECT
     CSR   BAIZSF        BEGSR
      *================================================================
      * Initialise & Load subfile page.
      *================================================================
      * Clear subfile.
     C                   SETON                                        80
     C                   WRITE     #SFLCTL
     C                   SETOFF                                       80
      * Reset no of records in subfile.
     C                   Z-ADD     *ZERO         ##RRMX            5 081         SETOF 81
      * USER: Initialise subfile header
     C                   MOVEL     *BLANK        #CAETX                         Screen report d
      * Screen report description
      * Get report description - Report Descriptions  *
     C                   EXSR      SARVGN
      * 00/copy member XX0302MISH - Report Components  *
     C*Edit Report Components   Initialise Subfile Header
     C/COPY WNCPYSRC,FC0302MISH
      * If CHANGE mode, then position file:
     C     W0PMD         IFNE      'ADD'
     C     *LIKE         DEFINE    #2COTT        WZCOTT
     C                   MOVEL     #2COTT        WZCOTT                         Component Name
     C     *LIKE         DEFINE    #2CSEQ        WZCSEQ
     C                   MOVEL     #2CSEQ        WZCSEQ                         Component Seque
     C     KPOS          KLIST
     C                   KFLD                    D3RNAM                         Report name
     C                   KFLD                    D3COTT                         Component Name
     C                   KFLD                    D3CSEQ                         Component Seque
      * Setup key.
     C                   MOVEL     #2RNAM        D3RNAM                         Report name
     C                   MOVEL     #2COTT        D3COTT                         Component Name
     C                   MOVEL     #2CSEQ        D3CSEQ                         Component Seque
     C***********KPOS      SETLL@D3REI5              82    *82=EOF        S01407
     C*****KPOS*         SETLL     FCRCOMD0                           82        *82=EOS0140 MD055265
     C     KRST          KLIST
     C                   KFLD                    D3RNAM                         Report name
      * Setup key.
     C                   MOVEL     #2RNAM        D3RNAM                         Report name
     C**N82******KRST      READE@D3REI5                9182*82=EOF        S01407
     C**N82KRST*         READE     FCRCOMD0                             9182    *82=EOS0140 MD055265
     C/EXEC SQL                                                                             MD055265
     C+ declare ACursor insensitive scroll cursor for                                       MD055265
     C+ select * from FCRCOJW1                                                              MD055265
     C+ where D3RNAM = :D3RNAM and D3COTT >= :D3COTT and D3CSEQ >= :D3CSEQ                  MD055265
     C+ order by D3RNAM, D3COTT, D3CSEQ                                                     MD055265
     C/END-EXEC                                                                             MD055265
                                                                                            MD055265
     C/EXEC SQL                                                                             MD055265
     C+ close ACursor                                                                       MD055265
     C/END-EXEC                                                                             MD055265
                                                                                            MD055265
     C/EXEC SQL                                                                             MD055265
     C+ open ACursor                                                                        MD055265
     C/END-EXEC                                                                             MD055265
                                                                                            MD055265
     C/EXEC SQL                                                                             MD055265
     C+ fetch next from ACursor into :FCRCOM :NullInds                                      MD055265
     C/END-EXEC                                                                             MD055265
     C                   If        SQLCODE = 100                                            MD055265
     C                   SETON                                        82                    MD055265
     C                   ELSE                                                               MD055265
     C                   SETOFF                                       82                    MD055265
     C                   ENDIF                                                              MD055265
                                                                                            MD055265
     C                   ELSE
     C                   SETOFF                                       82        *
     C                   END
      * Load subfile page.
     C                   EXSR      BBLDSF
      * If no records, switch to add mode and load again.
     C     W0APM         IFEQ      'Y'                                          First time
     C     ##RR          ANDEQ     *ZERO                                        No records
     C                   MOVEL     'ADD'         W0PMD
     C                   SETOFF                                       82        * Not EOF
     C                   EXSR      BBLDSF
     C                   END                                                    FI W0APM
     C                   MOVEL     'N'           W0APM             1            Not first time
      *................................................................
      * If no records found, display error message.
     C   82##RR          IFEQ      *ZERO                                        IF
      * Send message '*No data to display'
     C**********           MOVEL'Y2U0008' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1086'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
     C                   END                                                    FI ##RR = *ZERO
      *
      *================================================================
     CSR   BAEXIT        ENDSR
      /EJECT
     CSR   BBLDSF        BEGSR
      *================================================================
      * Load subfile page (write empty page if add mode).
      *================================================================
     C                   SETOFF                                       84        No SFLNXTCHG
      * Re-establish fields in read-ahead record.
     C   27W0PMD         IFNE      'ADD'
     C**N82******          READP@D3REI5                  90*              S01407
     C**N82******          READ @D3REI5                  90*              S01407
     C**N82*****         READP     FCRCOMD0                               90    *     S0140 MD055265
     C**N82*****         READ      FCRCOMD0                               90    *     S0140 MD055265
     C                   If        *IN82 = '0'                                              MD055265
     C/EXEC SQL                                                                             MD055265
     C+ fetch prior from ACursor into :FCRCOM :NullInds                                     MD055265
     C/END-EXEC                                                                             MD055265
     C/EXEC SQL                                                                             MD055265
     C+ fetch next from ACursor into :FCRCOM :NullInds                                      MD055265
     C/END-EXEC                                                                             MD055265
     C                   Endif                                                              MD055265
     C                   END
      *
      * Setof record error indicators.
     C                   MOVE      *ALL'0'       WKIND0            9
     C                   MOVE      *ALL'1'       WKIND1            9
      * Start at previous highest SFL record reached.
     C                   Z-ADD     ##RRMX        ##RR              5 0
     C                   Z-ADD     *ZERO         ##RROK            5 0
      *................................................................
      * Load next page of SFL:
     C**N82##RROK        DOWLT     ##SFPG                                       DO          MD055265
     C                   DOW       *IN82 = '0' and ##RROK < ##SFPG              DO          MD055265
     C                   MOVEA     WKIND0        *IN(33)
     C                   SETOFF                                       87        *
      * Clear SFL fields.
     C                   EXSR      MAIZ#1
      * If change mode, load SFL fields.
     C     W0PMD         IFNE      'ADD'
     C*                                                                   S01407
     C** IGNORE THIS RECORD IF IT IS FOR THE SAME COMPONENT NAME/         S01407
     C** SEQUENCE COMBINATION AS THE PREVIOUS RECORD                      S01407
     C*                                                                   S01407
     C                   MOVE      D3COTT        J1COTT                                        S0140
     C                   MOVE      D3CSEQ        J1CSEQ                                        S0140
     C     CUCMSQ        CABEQ     PRCMSQ        BB020                                         S0140
     C*                                                                   S01407
     C                   EXSR      MBFL#1
      * Calculate function fields.
     C                   EXSR      DG#2FN
      * Record will be selected unless overridden.
     C                   MOVEL     'Y'           W0RSL             1
      * USER: Initialise subfile record (existing record)
      * split parms for screen - Report Components  *
     C*
     C** SPLIT PARAMETERS FOR SCREEN
     C*
     C                   MOVEL     #1CLPM        #RALNA
     C                   MOVE      #1CLPM        #RAMNA
      *CASE:     PGM.*Program mode is *CHANGE
     C     W0PMD         IFEQ      @CN(01)                                      *IF
     C                   MOVEL     @CN(02)       WUJTST                         Action Code
     C                   END                                                    *FI
      * Set up EDTFIL screen - standard functions  *
     C     WUJTST        IFEQ      'I'
     C                   MOVEA     AEMQ(1)       ##AENA
     C                   ELSE
     C                   MOVEA     AEMQ(2)       ##AENA
     C                   END
      *
      * 00/copy member XX0302MIRE - Report Components  *
     C*Edit Report Components   Initialise Exist Record
     C/COPY WNCPYSRC,FC0302MIRE
      * If record dropped...
     C     W0RSL         CABNE     'Y'           BB020
      * Validate subfile record and calculate derived fields.
     C                   EXSR      DFV2RC
     C                   ELSE
      * USER: Initialise subfile record (new record)
     C                   MOVEL     @CN(03)       #1BRTP                         Branch Type
     C                   MOVEL     P1RNAM        #1RNAM                         Report name
      *CASE:     PGM.*Program mode is *ADD
     C     W0PMD         IFEQ      @CN(04)                                      *IF
     C                   MOVEL     @CN(05)       WUJTST                         Action Code
     C                   END                                                    *FI
      * Set up EDTFIL screen - standard functions  *
     C     WUJTST        IFEQ      'I'
     C                   MOVEA     AEMQ(1)       ##AENA
     C                   ELSE
     C                   MOVEA     AEMQ(2)       ##AENA
     C                   END
      * 00/copy member XX0302MIRN - Report Components  *
     C*Edit Report Components   Initialise New Record
     C/COPY WNCPYSRC,FC0302MIRN
     C                   END
      * Output to subfile.
     C                   ADD       1             ##RR                 81        *
     C                   ADD       1             ##RROK
      * Set screen conditioning indicators.
     C                   EXSR      GADSA1
     C                   WRITE     #SFLRCD
     C     BB020         TAG
     C     W0PMD         IFNE      'ADD'
     C                   MOVE      CUCMSQ        PRCMSQ                                        S0140
     C***********KRST      READE@D3REI5                  82*82=EOF        S01407
     C*****KRST*         READE     FCRCOMD0                               82    *82=EOS0140 MD055265
     C/EXEC SQL                                                                             MD055265
     C+ fetch next from ACursor into :FCRCOM :NullInds                                      MD055265
     C/END-EXEC                                                                             MD055265
     C                   IF        SQLCODE = 100                                            MD055265
     C                   SETON                                        82                    MD055265
     C                   ENDIF                                                              MD055265
     C                   END
     C  N82              END                                                    OD 1 - #SFPG
      *................................................................
      * Save highest SFL rec, so load can continue at end point.
     C     ##RR          IFGT      ##RRMX
     C     ##RRMX        ADD       1             ##SFRC
     C                   Z-ADD     ##RR          ##RRMX
     C                   END
      *================================================================
     CSR   BBEXIT        ENDSR
      /EJECT
     CSR   CAEXFM        BEGSR
      *================================================================
      * Display screen and process HELP requests.
      *================================================================
      * Set screen conditioning indicators.
     C                   EXSR      GBDSA2
      * Update screen time.
     C                   TIME                    ##TME                          Screen time.
     C     W0HLP         DOUEQ     'N'
      * PUTOVR unless conditioned fields change.
     C                   SETON                                        86
     C     *IN89         IFNE      CAIN89
     C     *IN81         ORNE      CAIN81
     C                   SETOFF                                       86
     C                   END
     C                   MOVE      *IN89         CAIN89            1
     C                   MOVE      *IN81         CAIN81            1
     C                   WRITE     #MSGCTL
     C                   WRITE     #CMDTXT1
     C                   EXFMT     #SFLCTL
     C                   MOVEL     'N'           W0HLP             1            Reset help requ
      * If help requested, display help text.
     C   25              EXSR      ZHHPKY                                       Display help te
     C                   END
      * Update job time.
     C                   TIME                    ##JTM                          Job time.
      * Clear messages from program message queue.
     C                   CALL      'Y2CLMSC'
     C                   PARM      ##PGM         ZAPGM            10
     C                   PARM      '*SAME'       ZAPGRL            5
      **Reset*first*message*only*flag.********                            LN1272
     C**********           MOVEL'Y'       ZAFSMS  1      99*              LN1272
      *================================================================
     CSR   CAEXIT        ENDSR
      /EJECT
     CSR   DAPR##        BEGSR
      *================================================================
      * Process screen input.
      *================================================================
      * Maintain subfile position where possible.
     C     @#SFRC        IFGT      *ZERO
     C                   Z-ADD     @#SFRC        ##SFRC
     C                   END
      *
      * CALC: Subfile control function fields
     C                   MOVEL     *BLANK        #CAETX                         Screen report d
     C*                                                                   LN0828
     C** SET UP VARIABLE TO INDICATE WHETHER SFLRCD HAS BEEN CHANGED      LN0828
     C*                                                                   LN0828
     C                   MOVE      'N'           SFCHGD            1                           LN082
     C*                                                                   LN0828
      * Screen report description
      * Get report description - Report Descriptions  *
     C                   EXSR      SBRVGN
      *CASE:     PGM.*Program mode is *ADD
     C     W0PMD         IFEQ      @CN(04)                                      *IF
     C                   MOVEL     @CN(05)       WUJTST                         Action Code
     C                   END                                                    *FI
      *CASE:     PGM.*Program mode is *CHANGE
     C     W0PMD         IFEQ      @CN(01)                                      *IF
     C                   MOVEL     @CN(02)       WUJTST                         Action Code
     C                   END                                                    *FI
      * Set up EDTFIL screen - standard functions  *
     C     WUJTST        IFEQ      'I'
     C                   MOVEA     AEMQ(1)       ##AENA
     C                   ELSE
     C                   MOVEA     AEMQ(2)       ##AENA
     C                   END
      * 00/copy member XX0302MSFF - Report Components  *
     C*Edit Report Components   Calculate Control Funct
     C/COPY WNCPYSRC,FC0302MSFF
     C     W0PMD         IFNE      'ADD'
      * Change of position specified?
     C     WZCOTT        CASNE     #2COTT        FBRQRL                         Component Name
     C     WZCSEQ        CASNE     #2CSEQ        FBRQRL                         Component Seque
     C                   END
     C                   END
      * USER: Validate subfile control
      * 00/copy member XX0302MVSC - Report Components  *
     C*Edit Report Components   Validate Control
     C/COPY WNCPYSRC,FC0302MVSC
      * Quit if reload requested.
     C     W0RSF         CABEQ     'Y'           DAEXIT
      *
     C   81              DO
      * No data entered as yet.
     C                   MOVEL     'N'           WKIPIN            1
      * Confirm/update is not defered.
     C                   MOVEL     'N'           W0DCF             1
      * Process subfile records.
     C                   EXSR      DBPRSF
      * If error, exit:
     C     *IN99         CABEQ     '1'           DAEXIT
      * Defer confirm/update requested:
     C     W0DCF         CABEQ     'Y'           DAEXIT
      * If data entered.
     C     WKIPIN        IFEQ      'Y'
      * Update DBF from subfile.
     C                   EXSR      EAPRSF
      * If error during update, exit:
     C     *IN99         CABEQ     '1'           DAEXIT
     C                   END                                                    WKIPIN
     C                   END                                                    OD 81
      *=====Process function keys=====
      * Switch between *ADD/*CHANGE modes.
     C   09              EXSR      FACHMD
      * USER: Process command keys
      * 00/copy member XX0302MPCK - Report Components  *
     C*Edit Report Components   Process Command Keys
     C/COPY WNCPYSRC,FC0302MPCK
      *CASE:     CTL.*CMD key is *Key screen
     C************IN12*****IFEQ '1'                        *IF            LN0828
     C     *IN12         IFEQ      '0'                                          *IF            LN082
      * Check components exist - Report Components  *
     C                   EXSR      SCRVGN
      *CASE:     PGM.*Return code is *Record does not exist
     C     W0RTN         IFEQ      @CN(06)                                      *IF
      * Send message 'Report component must ext'
     C                   MOVEL     'RCF0051'     ZAMSID                         Message id.
     C                   EXSR      ZASNMS                                       Send message
     C                   SETON                                        99        *
      *
     C                   ELSE
      *CASE:     WRK.Update Made is Update Made
     C     WUAZST        IFEQ      @CN(07)                                      *IF
      * Set last change date/type - Report Descriptions  *
     C                   EXSR      SDRVGN
     C                   MOVEL     *BLANK        P0RTN                          *Return code
     C                   EXSR      ZYEXPG
     C                   END                                                                   LN082
     C                   END                                                                   LN082
     C                   ELSE
      *CASE:     *OTHERWISE
     C*********************MOVEL*BLANK    P0RTN            *Return code   LN0828
     C                   MOVEL     @CN(09)       P0RTN                                         LN082
     C                   EXSR      ZYEXPG
     C                   END                                                    *FI
     C*********************END                             *FI
     C*********************END                             *FI            LN0828
      *================================================================
     CSR   DAEXIT        ENDSR
      /EJECT
     CSR   DBPRSF        BEGSR
      *================================================================
      * Process modified subfile records.
      *================================================================
     C                   READC     #SFLRCD                                92    *
     C     *IN92         DOWEQ     '0'
     C                   EXSR      DCPRSR
     C                   SETOFF                                       87        *
      * Set screen conditioning indicators.
     C                   EXSR      GADSA1
     C                   UPDATE    #SFLRCD
     C                   READC     #SFLRCD                                92    *
     C                   END
     C*                                                                   LN0828
     C** ALLOW EXIT IF SFLRCD HAS NOT BEEN CHANGED                        LN0828
     C*                                                                   LN0828
     C     SFCHGD        IFEQ      'N'                                                         LN082
     C     *IN12         ANDEQ     '0'                                                         LN082
     C     *IN09         ANDEQ     '0'                                                         LN082
     C*                                                                   LN0828
      * Check components exist - Report Components  *                     LN0828
     C                   EXSR      SCRVGN                                                      LN082
      *CASE:     PGM.*Return code is *Record does not exist               LN0828
     C     W0RTN         IFEQ      @CN(06)                                      *IF            LN082
      * Send message 'Report component must ext'                          LN0828
     C                   MOVEL     'RCF0051'     ZAMSID                         Message id.    LN082
     C                   EXSR      ZASNMS                                       Send message   LN082
     C                   SETON                                        99        *              LN082
     C                   ELSE                                                                  LN082
     C                   MOVEL     *BLANK        P0RTN                                         LN082
     C                   EXSR      ZYEXPG                                                      LN082
     C                   END                                                                   LN082
     C*                                                                   LN0828
     C                   END                                                                   LN082
     C*                                                                   LN0828
      *================================================================
     CSR   DBEXIT        ENDSR
      /EJECT
     CSR   DCPRSR        BEGSR
      *================================================================
      * Process subfile record.
      *================================================================
      * Setoff error indicators.
     C                   MOVEA     WKIND0        *IN(33)
     C                   SETOFF                                       98        No errors
     C                   SETOFF                                       84        NO SFLNXTCHG
     C     W0PMD         IFEQ      'ADD'
      * Check for null record.
     C                   EXSR      DDNLRC
     C     W0NLR         IFEQ      'Y'
     C                   GOTO      DCEXIT
     C                   END
      * If not null record, continue.
     C                   END
     C                   MOVEL     'Y'           WKIPIN                         Data entered
     C                   SETON                                        84        *SFLNXTCHG
      * If delete request, bypass validation.
     C     #1SEL         IFEQ      'D'
      * CHANGE VARIABLE TO 'Y' AS SFLRCD HAS BEEN CHANGED                 LN1146
     C                   MOVE      'Y'           SFCHGD                                        LN114
     C                   GOTO      DCEXIT
     C                   END
      * Validate subfile record.
     C                   EXSR      DEV1RC
      * If SFLRCD invalid, note the fact.
     C   98
     CANN99              Z-ADD     ##RR          ##SFRC               99        Invalid SFLRCD
      *================================================================
     CSR   DCEXIT        ENDSR
      /EJECT
     CSR   DDNLRC        BEGSR
      *================================================================
      * Check for null record.
      *================================================================
     C                   MOVEL     'N'           W0NLR             1
     C     #1COTT        CABNE     *BLANK        DDEXIT                         Component Name
     C     #1CSEQ        CABNE     *BLANK        DDEXIT                         Component Seque
     C     #1MORQ        CABNE     *BLANK        DDEXIT                         Mandatory/On Re
     C     #1PRPG        CABNE     *BLANK        DDEXIT                         Prompt Program
     C     #1ADTX        CABNE     *BLANK        DDEXIT                         Additional Repo
     C     #1BRTP        CABNE     *BLANK        DDEXIT                         Branch Type
     C     #RALNA        CABNE     *BLANK        DDEXIT                         Parameters part
     C     #RAMNA        CABNE     *BLANK        DDEXIT                         Parameters part
     C                   MOVEL     'Y'           W0NLR
      *================================================================
     CSR   DDEXIT        ENDSR
      /EJECT
     CSR   DEV1RC        BEGSR
      *================================================================
      * Validate subfile record.
      *================================================================
      * Validate Mandatory/On Request
      * Name search required ?
     C                   MOVEL     #1MORQ        W0NSRQ            1            Mandatory/On Re
     C     W0NSRQ        IFEQ      '?'                                          Search required
     C                   CALL      'FCVLLSR'                            90      *
     C                   PARM                    W0RTN             7            Return code
     C                   PARM      1100220       Y2LSNO            7 0          List number.
     C     #1MORQ        PARM      #1MORQ        W0EXVL           20            Mandatory/On Re
     C                   MOVEL     'Y'           W0DCF             1            Defer confirm
     C                   END
      * USER: Validate subfile record fields
      * concatenate screen parms - Report Components  *
     C*                                                                   LN0828
     C** CHANGE VARIABLE TO 'Y' IF SFLRCD HAS BEEN CHANGED                LN0828
     C*                                                                   LN0828
     C                   MOVE      'Y'           SFCHGD                                        LN082
     C*
     C** CONCATENATE SCREEN PARAMETERS FOR FILE
     C*
     C                   MOVEL     #RALNA        #1CLPM
     C                   MOVE      #RAMNA        #1CLPM
      * Component Name required.                                          LN1272
     C     #1COTT        IFEQ      *BLANK                                       IF             LN127
     C                   SETON                                        9834      *              LN127
      * Send message '*Value required'                                    LN1272
     C                   MOVEL     'RCF1074'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message   LN127
     C                   END                                                    FI             LN127
      * Component Sequence Number required.                               LN1272
     C     #1CSEQ        IFEQ      *BLANK                                       IF             LN127
     C                   SETON                                        9835      *              LN127
      * Send message '*Value required'                                    LN1272
     C                   MOVEL     'RCF1074'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message   LN127
     C                   END                                                    FI             LN127
     C*                                                                   LN0685
     C** Mandatory/On Request can only be 'M' or 'R'                      LN0685
     C*                                                                   LN0685
     C     #1MORQ        IFNE      'M'                                                         LN068
     C     #1MORQ        ANDNE     'R'                                                         LN068
     C                   MOVEL     'RCF0054'     ZAMSID                                        LN068
     C                   SETON                                        9936                     LN068
     C                   EXSR      ZASNMS                                                      LN068
     C                   END                                                                   LN068
     C*                                                                   LN0521
     C* '?' Processing for Branch Type                                    LN0521
     C*                                                                   LN0521
     C     #1BRTP        IFEQ      '?'                                                         LN052
     C                   CALL      'FCVLLSR'                            90                     LN052
     C                   PARM                    W0RTN                                         LN052
     C                   PARM      1100215       Y2LSNO                                        LN052
     C     #1BRTP        PARM      #1BRTP        W0EXVL                                        LN052
     C                   MOVEL     'Y'           W0DCF                                         LN052
     C                   END                                                                   LN052
     C*                                                                   LN0521
     C** Branch Type can only be 'B' or 'O'                               LN0521
     C*                                                                   LN0521
     C     #1BRTP        IFNE      'B'                                                         LN052
     C     #1BRTP        ANDNE     'O'                                                         LN052
     C                   MOVEL     'RCF0068'     ZAMSID                                        LN052
     C                   SETON                                        9939                     LN052
     C                   EXSR      ZASNMS                                                      LN052
     C                   END                                                                   LN052
     C*                                                                   LN0521
      * 00/Copy member XX0302MVSU - Report Components  *
     C/COPY WNCPYSRC,FC0302MVSU
      * Validate subfile record relations.
     C                   EXSR      DFV2RC
      **Component*Name*required.***********                               LN1272
     C********** #1COTT    IFEQ *BLANK                     IF             LN1272
     C**********           SETON                     9834  *              LN1272
      **Send*message*'*Value required'*****                               LN1272
     C**********           MOVEL'Y2U0001' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C**********           EXSR ZASNMS                     Send message   LN1272
     C**********           END                             FI             LN1272
      **Component*Sequence*Number*required.**********                     LN1272
     C********** #1CSEQ    IFEQ *BLANK                     IF             LN1272
     C**********           SETON                     9835  *              LN1272
      **Send*message*'*Value required'********                            LN1272
     C**********           MOVEL'Y2U0001' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C**********           EXSR ZASNMS                     Send message   LN1272
     C**********           END                             FI             LN1272
      **Mandatory/On*Request*required.***                                 LN1272
     C********** #1MORQ    IFEQ *BLANK                     IF             LN1272
     C**********           SETON                     9836  *              LN1272
      **Send*message*'*Value*required'*                                   LN1272
     C**********           MOVEL'Y2U0001' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C**********           EXSR ZASNMS                     Send message   LN1272
     C**********           END                             FI             LN1272
      **Branch*Type*required.******                                       LN1272
     C********** #1BRTP    IFEQ *BLANK                     IF             LN1272
     C**********           SETON                     9839  *              LN1272
      **Send*message*'*Value*required'***                                 LN1272
     C**********           MOVEL'Y2U0001' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C**********           EXSR ZASNMS                     Send message   LN1272
     C**********           END                             FI             LN1272
      *================================================================
     CSR   DEEXIT        ENDSR
      /EJECT
     CSR   DFV2RC        BEGSR
      *================================================================
      * Validate subfile record relations.
      *================================================================
      * Calculate function fields.
     C                   EXSR      DG#2FN
      * USER: Validate subfile record relations
      * 00/copy member XX0302MVRR - Report Components  *
     C*Edit Report Components   Validate Record Relations
     C/COPY WNCPYSRC,FC0302MVRR
      *================================================================
     CSR   DFEXIT        ENDSR
      /EJECT
     CSR   DG#2FN        BEGSR
      *================================================================
      * Calculate subfile record fucntion fields.
      *================================================================
      * CALC: Subfile record function fields
      * 00/copy member XX0302MRFF - Report Components  *
     C*Edit Report Components   Calculate Record Funct
     C/COPY WNCPYSRC,FC0302MRFF
      *================================================================
     CSR   DGEXIT        ENDSR
      /EJECT
     CSR   EAPRSF        BEGSR
      *================================================================
      * Update DBF from subfile records.
      *================================================================
      * Initialise subfile reload flag.
     C     W0PMD         IFEQ      'ADD'
     C                   MOVEL     'Y'           W0RSF
     C                   ELSE
     C                   MOVEL     'N'           W0RSF
     C                   END
      * Process all modified subfile records.
     C                   READC     #SFLRCD                                92    *
     C     *IN92         DOWEQ     '0'
      * Process modified subfile record.
     C                   EXSR      EBPRSR
     C                   MOVEL     *BLANK        #1SEL
      * Set screen conditioning indicators.
     C                   EXSR      GADSA1
     C                   UPDATE    #SFLRCD
     C                   READC     #SFLRCD                                92    *
     C                   END
      * If any errors, cancel reload.
     C     *IN99         IFEQ      '1'
     C                   MOVEL     'N'           W0RSF             1
     C                   END
      *================================================================
     CSR   EAEXIT        ENDSR
      /EJECT
     CSR   EBPRSR        BEGSR
      *================================================================
      * Process modified subfile record.
      *================================================================
      * Set off error indicators.
     C                   MOVEA     WKIND0        *IN(33)                        Clear errors
     C                   SETOFF                                       98        No errors
      *
     C     W0PMD         IFEQ      'ADD'
      * Process add request.
     C     #1SEL         IFNE      'D'
     C                   EXSR      DDNLRC
     C     W0NLR         IFNE      'Y'
     C                   EXSR      ECADRQ
     C                   END
     C                   END
     C                   ELSE
     C     #1SEL         IFEQ      'D'
      * Process delete request.
     C                   EXSR      EDDLRQ
     C                   ELSE
      * Process change request.
     C                   EXSR      EECHRQ
     C                   END
     C                   END
      * If error occurred on update, note the fact.
     C     *IN98         IFEQ      '1'
     C     *IN99         IFEQ      '0'
     C                   Z-ADD     ##RR          ##SFRC               99        Error on update
     C                   END
     C                   ELSE
      * USER: Extra processing after DBF update
     C                   MOVEL     @CN(07)       WUAZST                         Update Made
     C                   MOVEL     @CN(07)       W0RSF                          *Reload subfile
      * 00/Copy member XX0302MEPA - Report Components  *
     C*Report Components edit   Extra Processing Aft Upd
     C/COPY WNCPYSRC,FC0302MEPA
     C                   END
      *================================================================
     CSR   EBEXIT        ENDSR
      /EJECT
     CSR   ECADRQ        BEGSR
      *================================================================
      * Process add request.
      *================================================================
      * USER: Create DBF record
      * Create Report Components - Report Components  *
     C                   EXSR      SGCRRC
     C     W0RTN         IFNE      *BLANK
      * Write error detected.
     C                   MOVEA     WKIND1        *IN(33)                        Screen errors
     C                   SETON                                        98        Format Error
     C                   SETOFF                                       87        Enable entry
     C                   SETON                                        84        SFLNXTCHG
     C                   ELSE
      * DBF Write successful.
     C                   SETON                                        87        Disable entry
     C                   SETOFF                                       84        No SFLNXTCHG
     C                   END
      *================================================================
     CSR   ECEXIT        ENDSR
      /EJECT
     CSR   EDDLRQ        BEGSR
      *================================================================
      * Process delete request.
      *================================================================
      * USER: Delete DBF record
      * Delete Report Components - Report Components  *
     C                   EXSR      SHDLRC
     C     W0RTN         IFNE      *BLANK
      * Delete unsuccessful.
     C                   MOVEA     WKIND1        *IN(33)                        Screen errors
     C                   SETON                                        98        Format Error
     C                   SETOFF                                       87        Enable entry
     C                   SETON                                        84        SFLNXTCHG
      * If record altered, reset subfile record.
     C     W0RTN         CASEQ     'Y2U0007'     MBFL#1                         IF
     C                   END
     C                   ELSE
      * DBF Delete successful.
      * Blank out record and protect from entry.
     C                   EXSR      MAIZ#1
     C                   SETON                                        87        Disable entry
     C                   SETOFF                                       84        No SFLNXTCHG
     C                   MOVEL     'Y'           W0RSF             1            Reload subfile
     C                   END                                                    FI W0RTCD
      *================================================================
     CSR   EDEXIT        ENDSR
      /EJECT
     CSR   EECHRQ        BEGSR
      *================================================================
      * Process update request.
      *================================================================
      * USER: Change DBF record
      * Change Report Components - Report Components  *
     C                   EXSR      SICHRC
     C     W0RTN         IFNE      *BLANK
      * DBF Update error detected.
     C                   MOVEA     WKIND1        *IN(33)                        Screen errors
     C                   SETON                                        98        Format Error
     C                   SETOFF                                       87        Enable entry
     C                   SETON                                        84        SFLNXTCHG
      * Reset subfile record if changed record.
     C     W0RTN         CASEQ     'Y2U0007'     MBFL#1                         IF
     C                   END
     C                   ELSE
      * DBF Update successful.
     C                   SETOFF                                       87        Enable entry
     C                   SETOFF                                       84        No SFLNXTCHG
     C                   END                                                    FI W0RTCD
      *================================================================
     CSR   EEEXIT        ENDSR
      /EJECT
     CSR   FACHMD        BEGSR
      *================================================================
      * Flip between *ADD and *CHANGE modes.
      *================================================================
     C     W0PMD         IFNE      'ADD'
     C                   MOVEL     'ADD'         W0PMD
     C                   ELSE
     C                   MOVEL     'CHG'         W0PMD
     C                   END
     C                   EXSR      FBRQRL
      *================================================================
     CSR   FAEXIT        ENDSR
      /EJECT
     CSR   FBRQRL        BEGSR
      *================================================================
      * Request subfile reload.
      *================================================================
     C                   MOVEL     'Y'           W0RSF
      *================================================================
     CSR   FBEXIT        ENDSR
      /EJECT
     CSR   GADSA1        BEGSR
      *================================================================
      * Set display attributes for Subfile record.
      *================================================================
     C     W0PMD         COMP      'ADD'                                  89    *
      * Protect keys if change mode or updated record.
     C                   SETON                                        88        *
     C   89
     CANN87              SETOFF                                       88        *
     C                   MOVEL     *IN87         *IN79
     C     W0PMD         IFEQ      @CN(04)                                      *IF
     C                   MOVEL     '1'           *IN79
     C                   END                                                    *FI
     C                   MOVEL     *IN87         *IN78
     C     WUMBIN        IFEQ      @CN(11)                                      *IF
     C                   MOVEL     '1'           *IN78
     C                   END                                                    *FI
      *================================================================
     CSR   GAEXIT        ENDSR
      /EJECT
     CSR   GBDSA2        BEGSR
      *================================================================
      * Set display attributes for Subfile control.
      *================================================================
     C     W0PMD         COMP      'ADD'                                  89    *
      *================================================================
     CSR   GBEXIT        ENDSR
      /EJECT
     CSR   MAIZ#1        BEGSR
      *================================================================
      * Initialise subfile record.
      *================================================================
     C                   MOVEL     *BLANK        #1DBRC                         Previous values
     C                   MOVEL     P1RNAM        #1RNAM                         Report name
     C                   MOVEL     *BLANK        #1CLPM                         Calling Paramet
     C                   MOVEL     *BLANK        #1SEL                          *SFLSEL
     C                   MOVEL     *BLANK        #1COTT                         Component Name
     C                   MOVEL     *BLANK        #1CSEQ                         Component Seque
     C                   MOVEL     *BLANK        #1MORQ                         Mandatory/On Re
     C                   MOVEL     *BLANK        #1PRPG                         Prompt Program
     C                   MOVEL     *BLANK        #1ADTX                         Additional Repo
     C                   MOVEL     *BLANK        #1BRTP                         Branch Type
     C                   MOVEL     *BLANK        #RALNA                         Parameters part
     C                   MOVEL     *BLANK        #RAMNA                         Parameters part
      *================================================================
     CSR   MAEXIT        ENDSR
      /EJECT
     CSR   MBFL#1        BEGSR
      *================================================================
      **Move*@D3REI5*fields*to*subfile.                                   S01407
      * Move FCRCOMD0 fields to subfile.                                  S01407
      *================================================================
     C                   MOVEL     D3RNAM        #1RNAM                         Report name
     C                   MOVEL     D3CLPM        #1CLPM                         Calling Paramet
     C                   MOVEL     D3COTT        #1COTT                         Component Name
     C                   MOVEL     D3CSEQ        #1CSEQ                         Component Seque
     C                   MOVEL     D3MORQ        #1MORQ                         Mandatory/On Re
     C                   MOVEL     D3PRPG        #1PRPG                         Prompt Program
     C                   MOVEL     D3ADTX        #1ADTX                         Additional Repo
     C                   MOVEL     D3BRTP        #1BRTP                         Branch Type
      * Hold current record image for change detection.
     C                   eval      @D3RNAM = D3RNAM                                         MD055265
     C                   eval      @D3COTT = D3COTT                                         MD055265
     C                   eval      @D3CSEQ = D3CSEQ                                         MD055265
     C                   eval      @D3MORQ = D3MORQ                                         MD055265
     C                   eval      @D3CLPM = D3CLPM                                         MD055265
     C                   eval      @D3PRPG = D3PRPG                                         MD055265
     C                   eval      @D3ADTX = D3ADTX                                         MD055265
     C                   eval      @D3BRTP = D3BRTP                                         MD055265
     C                   eval      @D3MODE = D3MODE                                         MD055265
     C                   MOVEL     @1DBRC        #1DBRC
      *================================================================
     CSR   MBEXIT        ENDSR
      /EJECT
     CSR   MEIZ#2        BEGSR
      *================================================================
      * Initialise subfile control.
      *================================================================
     C                   MOVEL     P1RNAM        #2RNAM                         Report name
     C                   MOVEL     *BLANK        #CAETX                         Screen report d
     C                   MOVEL     *BLANK        #2COTT                         Component Name
     C                   MOVEL     *BLANK        #2CSEQ                         Component Seque
      * Check restriction within Report Descriptions.
     C                   EXSR      VACKRL
      *================================================================
     CSR   MEEXIT        ENDSR
      /EJECT
     CSR   SARVGN        BEGSR
      *================================================================
      * Get report description - Report Descriptions  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Define Keylist.
     C     KRSSA         KLIST
     C                   KFLD                    DXRNAM                         Report name
      * Move fields to key list.
     C                   MOVEL     P1RNAM        DXRNAM                         Report name
     C***********KRSSA     CHAIN@DXREIK              90    *              S01407
     C*****KRSSA         CHAIN     FCREPTD0                           90        *     S0140 MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCREPT :NullInds2                                                             MD055265
     C+ from FCREPJW1                                                                       MD055265
     C+ where DXRNAM = :P1RNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C                   SETOFF                                       90                    MD055265
     C                   IF        SQLCODE = 100                                            MD055265
     C                   SETON                                        90                    MD055265
     C                   ENDIF                                                              MD055265
      * DBF Record not found.
     C***90*****           MOVEL'USR0712' W0RTN   7                       LN1190
     C   90              MOVEL     'RCF0712'     W0RTN             7                           LN119
     C     *IN90         IFEQ      '0'
      * USER: Process DBF record
      * PAR = DB1 By name
     C                   MOVEL     DXRDSC        #CAETX                         Report Descript
     C                   END
      *================================================================
     CSR   SAEXIT        ENDSR
      /EJECT
     CSR   SBRVGN        BEGSR
      *================================================================
      * Get report description - Report Descriptions  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Define Keylist.
     C     KRSSB         KLIST
     C                   KFLD                    DXRNAM                         Report name
      * Move fields to key list.
     C                   MOVEL     P1RNAM        DXRNAM                         Report name
     C***********KRSSB     CHAIN@DXREIK              90    *              S01407
     C*****KRSSB         CHAIN     FCREPTD0                           90        *     S0140 MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCREPT :NullInds2                                                             MD055265
     C+ from FCREPJW1                                                                       MD055265
     C+ where DXRNAM = :P1RNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C                   SETOFF                                       90                    MD055265
     C                   IF        SQLCODE = 100                                            MD055265
     C                   SETON                                        90                    MD055265
     C                   ENDIF                                                              MD055265
      * DBF Record not found.
     C***90*****           MOVEL'USR0712' W0RTN   7                       LN1190
     C   90              MOVEL     'RCF0712'     W0RTN             7                           LN119
     C     *IN90         IFEQ      '0'
      * USER: Process DBF record
      * PAR = DB1 By name
     C                   MOVEL     DXRDSC        #CAETX                         Report Descript
     C                   END
      *================================================================
     CSR   SBEXIT        ENDSR
      /EJECT
     CSR   SCRVGN        BEGSR
      *================================================================
      * Check components exist - Report Components  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Declare restrictor key work fields.
     C     *LIKE         DEFINE    D3RNAM        WQSC01                         Report name
      * Define Keylist.
     C     KPSSC         KLIST
     C                   KFLD                    WQSC01                         Report name
     C                   KFLD                    D3COTT                         Component Name
     C                   KFLD                    D3CSEQ                         Component Seque
      * Define Keylist.
     C     KRSSC         KLIST
     C                   KFLD                    WQSC01                         Report name
      * Move fields to key list.
     C                   MOVEL     P1RNAM        WQSC01                         Report name
     C                   MOVEL     *BLANK        D3COTT                         Component Name
     C                   MOVEL     *BLANK        D3CSEQ                         Component Seque
     C***********KPSSC     SETLL@D3REI5                    *              S01407
     C***********KRSSC     READE@D3REI5                  90*              S01407
     C*****KPSSC         SETLL     FCRCOMD0                                     *    S0140  MD055265
     C*****KRSSC         READE     FCRCOMD0                               90    *    S0140  MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCRCOML                                                                       MD055265
     C+ from FCRCOJW0                                                                       MD055265
     C+ where D3RNAM = :WQSC01                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C******IN90         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE = 100                                            MD055265
      * DBF Record not found.
     C**********           MOVEL'USR0724' W0RTN   7                       LN1190
     C                   MOVEL     'RCF0724'     W0RTN             7                           LN119
      * USER: Processing if DBF record not found
     C                   MOVEL     @CN(06)       W0RTN                          *Return code
     C                   GOTO      SCEXIT
     C                   END
      *
      *================================================================
     CSR   SCEXIT        ENDSR
      /EJECT
     CSR   SDRVGN        BEGSR
      *================================================================
      * Set last change date/type - Report Descriptions  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Define Keylist.
     C     KRSSD         KLIST
     C                   KFLD                    DXRNAM                         Report name
      * Move fields to key list.
     C                   MOVEL     P1RNAM        DXRNAM                         Report name
     C***********KRSSD     CHAIN@DXREIK              90    *              S01407
     C*****KRSSD         CHAIN     FCREPTD0                           90        *     S0140 MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCREPT :NullInds2                                                             MD055265
     C+ from FCREPJW1                                                                       MD055265
     C+ where DXRNAM = :P1RNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C                   SETOFF                                       90                    MD055265
     C                   IF        SQLCODE = 100                                            MD055265
     C                   SETON                                        90                    MD055265
     C                   ENDIF                                                              MD055265
      * DBF Record not found.
     C***90*****           MOVEL'USR0712' W0RTN   7                       LN1190
     C   90              MOVEL     'RCF0712'     W0RTN             7                           LN119
     C     *IN90         IFEQ      '0'
      * USER: Process DBF record
     C                   MOVEL     @CN(02)       WUJTST                         Action Code
      * Change Report Description - Report Descriptions  *
     C                   EXSR      SECHRC
     C                   END
      *================================================================
     CSR   SDEXIT        ENDSR
      /EJECT
     CSR   SECHRC        BEGSR
      *================================================================
      * Change Report Description - Report Descriptions  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * USER: Processing before DBF read
     C*Edit Report Descriptions Processing Before Update
     C/COPY WNCPYSRC,FC0303MBDU
      *CASE:     PGM.*Return code is *User QUIT requested
     C     W0RTN         IFEQ      @CN(08)                                      *IF
     C                   MOVEL     @CN(08)       P0RTN                          *Return code
     C                   EXSR      ZYEXPG
     C                   END                                                    *FI
      *CASE:     PGM.*Return code is *Previous Screen
     C     W0RTN         IFEQ      @CN(09)                                      *IF
     C                   GOTO      SEEXIT                                       *QUIT
     C                   END                                                    *FI
      *
     C     KLCHSE        KLIST
     C                   KFLD                    DXRNAM                         Report name
     C                   MOVEL     DXRNAM        KKRNAM           10            Report name MD055265
     C*****KLCHSE        CHAIN     @DXREIJ                            9091      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCREPTL                                                                       MD055265
     C+ from FCREPJW0                                                                       MD055265
     C+ where DXRNAM = :KKRNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C                   SETOFF                                       90                    MD055265
     C                   IF        SQLCODE = 100                                            MD055265
     C                   SETON                                        90                    MD055265
     C                   ENDIF                                                              MD055265
      *
     C     *IN90         IFEQ      '1'
      * Record not found.
     C                   MOVEL     'Y2U0009'     W0RTN             7
      * Send message '*Record no longer on file'
     C**********           MOVEL'Y2U0009' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1084'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
     C                   GOTO      SEEXIT
     C                   END
      *
     C     *IN91         IFEQ      '1'
      * Record locked.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   GOTO      SEEXIT
     C                   END
      *
      * Move Non-key fields to @DXREIJ
     C                   Z-ADD     WURUND        DXLCD                          Last Change Dat
     C                   MOVEL     @CN(02)       DXCHTP                         Type of Last Ch
      *
     C**********         UPDATE    @DXREIJ                              91      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ update FCREPXTD                                                                     MD055265
     C+  SET DXCHTP = :DXCHTP                                                               MD055265
     C+ , DXLCD = :DXLCD                                                                    MD055265
     C+ WHERE DXRNAM = :KKRNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
                                                                                            MD055265
     C                   If        (SQLCODE <> 0)                                           MD055265
     C******IN91         IFEQ      '1'                                                      MD055265
      * Change error detected.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   ELSE
      * DBF Change successful.
      * USER: Processing after DBF update
     C                   Z-ADD     *ZERO         WUNORC                         No. of Records
     C                   Z-ADD     *ZERO         WUNOIN                         No. of Inserts
     C                   Z-ADD     *ZERO         WUNODL                         No. of Deletes
     C                   Z-ADD     1             WUNOAM                         No. of Amends
      * Change Report Description - Report Descriptions Audit  *
     C                   EXSR      SFCHRC
     C*Edit Report Descriptions Processing After Update
     C/COPY WNCPYSRC,FC0303MADU
     C                   END
      *================================================================
     CSR   SEEXIT        ENDSR
      /EJECT
     CSR   SFCHRC        BEGSR
      *================================================================
      * Change Report Description - Report Descriptions Audit  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Move key fields to @ADREBB
     C                   MOVEL     @CN(10)       ADFLNM                         Filename
      *
     C     KLCHSF        KLIST
     C                   KFLD                    ADFLNM                         Filename
     C     KLCHSF        CHAIN     @ADREBB                            9091      *
      *
     C     *IN90         IFEQ      '1'
      * Record not found.
     C                   MOVEL     'Y2U0009'     W0RTN             7
      * Send message '*Record no longer on file'
     C**********           MOVEL'Y2U0009' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1084'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
     C                   GOTO      SFEXIT
     C                   END
      *
     C     *IN91         IFEQ      '1'
      * Record locked.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   GOTO      SFEXIT
     C                   END
      *
      * USER: Processing after DBF read
     C                   ADD       ADNORC        WUNORC                         No. of Records
     C                   ADD       ADNOIN        WUNOIN                         No. of Inserts
     C                   ADD       ADNOAM        WUNOAM                         No. of Amends
     C                   ADD       ADNODL        WUNODL                         No. of Deletes
      * Move Non-key fields to @ADREBB
     C                   Z-ADD     WUNORC        ADNORC                         No. of Records
     C                   Z-ADD     WUNOIN        ADNOIN                         No. of Inserts
     C                   Z-ADD     WUNOAM        ADNOAM                         No. of Amends
     C                   Z-ADD     WUNODL        ADNODL                         No. of Deletes
      *
     C                   UPDATE    @ADREBB                              91      *
     C     *IN91         IFEQ      '1'
      * Change error detected.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   ELSE
      * DBF Change successful.
      * Move @ADREBB fields back.
     C                   Z-ADD     ADNORC        WUNORC                         No. of Records
     C                   Z-ADD     ADNOIN        WUNOIN                         No. of Inserts
     C                   Z-ADD     ADNOAM        WUNOAM                         No. of Amends
     C                   Z-ADD     ADNODL        WUNODL                         No. of Deletes
     C                   END
      *================================================================
     CSR   SFEXIT        ENDSR
      /EJECT
     CSR   SGCRRC        BEGSR
      *================================================================
      * Create Report Components - Report Components  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Move all fields to @D3REI4
     C                   MOVEL     #1RNAM        D3RNAM                         Report name
     C                   MOVEL     #1COTT        D3COTT                         Component Name
     C                   MOVEL     #1CSEQ        D3CSEQ                         Component Seque
     C                   MOVEL     #1MORQ        D3MORQ                         Mandatory/On Re
     C                   MOVEL     #1CLPM        D3CLPM                         Calling Paramet
     C                   MOVEL     #1PRPG        D3PRPG                         Prompt Program
     C                   MOVEL     #1ADTX        D3ADTX                         Additional Repo
     C                   MOVEL     #1BRTP        D3BRTP                         Branch Type
      *
      * USER: Processing before DBF update
      * 00/copy member XX0302MCBU - Report Components  *
     C/COPY WNCPYSRC,FC0302MCBU
     C*
     C** REPORT COMPONENTS PROCESSING BEFORE ADD
     C     KLCRSG        KLIST
     C                   KFLD                    D3RNAM                         Report name
     C                   KFLD                    D3COTT                         Component Name
     C                   KFLD                    D3CSEQ                         Component Seque
      * Check for duplicate primary key.
     C*****KLCRSG        SETLL     @D3REI4                                90    *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCRCOML                                                                       MD055265
     C+ from FCRCOJW0                                                                       MD055265
     C+ where D3RNAM = :D3RNAM and D3COTT = :D3COTT and D3CSEQ = :D3CSEQ                    MD055265
     C/END-EXEC                                                                             MD055265
     C******IN90         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE = 0                                              MD055265
     C**********           MOVEL'USR0725' W0RTN   7                       LN1190
     C                   MOVEL     'RCF0725'     W0RTN             7                           LN119
      * Send message 'Report Components      EX'
     C**********           MOVEL'USR0725' ZAMSID           Message id.    LN1190
     C                   MOVEL     'RCF0725'     ZAMSID                         Message id.    LN119
     C                   EXSR      ZASNMS                                       Send message
     C                   GOTO      SGEXIT
     C                   END
      *
     C**********         WRITE     @D3REI4                              91      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ insert into FCRCOBTD                                                                MD055265
     C+ (                                                                                   MD055265
     C+   D3RNAM                                                                            MD055265
     C+ , D3COTT                                                                            MD055265
     C+ , D3CSEQ                                                                            MD055265
     C+ , D3MORQ                                                                            MD055265
     C+ , D3CLPM                                                                            MD055265
     C+ , D3PRPG                                                                            MD055265
     C+ , D3ADTX                                                                            MD055265
     C+ , D3BRTP                                                                            MD055265
     C+ , D3MODE                                                                            MD055265
     C+ )                                                                                   MD055265
     C+ Values                                                                              MD055265
     C+ (                                                                                   MD055265
     C+   :D3RNAM                                                                           MD055265
     C+ , :D3COTT                                                                           MD055265
     C+ , :D3CSEQ                                                                           MD055265
     C+ , :D3MORQ                                                                           MD055265
     C+ , :D3CLPM                                                                           MD055265
     C+ , :D3PRPG                                                                           MD055265
     C+ , :D3ADTX                                                                           MD055265
     C+ , :D3BRTP                                                                           MD055265
     C+ , 'B'                                                                               MD055265
     C+ )                                                                                   MD055265
     C/END-EXEC                                                                             MD055265
     C/EXEC SQL                                                                             MD055265
     C+ insert into FCRCOXTD                                                                MD055265
     C+ (                                                                                   MD055265
     C+   D3RNAM                                                                            MD055265
     C+ , D3COTT                                                                            MD055265
     C+ , D3CSEQ                                                                            MD055265
     C+ , D3MODE                                                                            MD055265
     C+ )                                                                                   MD055265
     C+ Values                                                                              MD055265
     C+ (                                                                                   MD055265
     C+   :D3RNAM                                                                           MD055265
     C+ , :D3COTT                                                                           MD055265
     C+ , :D3CSEQ                                                                           MD055265
     C+ , 'B'                                                                               MD055265
     C+ )                                                                                   MD055265
     C/END-EXEC                                                                             MD055265
      *
     C******IN91         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE <> 0                                             MD055265
      * Write error detected.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   ELSE
      * DBF Write successful.
      * USER: Processing after DBF update
      * 00/copy member XX0302MCAU - Report Components  *
     C*
     C** EDIT REPORT COMPONENTS PROCESSING AFTER ADD
     C/COPY WNCPYSRC,FC0302MCAU
     C                   END
      *================================================================
     CSR   SGEXIT        ENDSR
      /EJECT
     CSR   SHDLRC        BEGSR
      *================================================================
      * Delete Report Components - Report Components  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * USER: Processing before DBF update
      * 00/copy member XX0302MDBU - Report Components  *
     C/COPY WNCPYSRC,FC0302MDBU
      *                                                                   S01407
      * Move key fields to @SARML2                                        S01407
     C                   MOVEL     #1RNAM        KRNAM            10                           S0140
     C                   MOVEL     #1COTT        KCOTT            10                           S0140
     C                   MOVEL     #1CSEQ        KCSEQ             5                           S0140
      *                                                                   S01407
     C     KSARM         KLIST                                                                 S0140
     C                   KFLD                    KRNAM                                         S0140
     C                   KFLD                    KCOTT                                         S0140
     C                   KFLD                    KCSEQ                                         S0140
      *                                                                   S01407
      * Move key fields to @D3REI4
     C                   MOVEL     #1RNAM        D3RNAM                         Report name
     C                   MOVEL     #1COTT        D3COTT                         Component Name
     C                   MOVEL     #1CSEQ        D3CSEQ                         Component Seque
      *
     C     KLDLSH        KLIST
     C                   KFLD                    D3RNAM                         Report name
     C                   KFLD                    D3COTT                         Component Name
     C                   KFLD                    D3CSEQ                         Component Seque
     C*****KLDLSH        CHAIN     @D3REI4                            9091      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCRCOML                                                                       MD055265
     C+ from FCRCOJW0                                                                       MD055265
     C+ where D3RNAM = :D3RNAM and D3COTT = :D3COTT and D3CSEQ = :D3CSEQ                    MD055265
     C/END-EXEC                                                                             MD055265
     C******IN90         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE = 100                                            MD055265
      * Record already deleted.
     C                   MOVEL     'Y2U0009'     W0RTN             7
      * Send message '*Record no longer on file'
     C**********           MOVEL'Y2U0009' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1084'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
     C                   GOTO      SHEXIT
     C                   END
      *
     C******IN91         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE <> 0  and SQLCODE <> 100                         MD055265
      * Record locked.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   GOTO      SHEXIT
     C                   END
      *
      * Check for changed record.
     C                   eval      @1DBRC = FCRCOML                                         MD055265
     C     #1DBRC        IFNE      @1DBRC                                       IF
     C                   MOVEL     'Y2U0007'     W0RTN             7
      * Send message '*Update not accepted'
     C**********           MOVEL'Y2U0007' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1085'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
      * Use SETLL to release record lock.
     C*****KLDLSH        SETLL     @D3REI4                            9091      *           MD055265
     C                   GOTO      SHEXIT
     C                   END                                                    FI #1DBRC
      * Do not allow deletion of core record                                                MD055265
     C     LD3MODE       IFEQ      'C'                                                      MD055265
     C                   MOVEL     'RCF0500'     ZAMSID                                     MD055265
     C                   MOVEL     'RCF0500'     W0RTN                                      MD055265
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                                     MD055265
     C                   EXSR      ZASNMS                                                   MD055265
     C                   GOTO      SHEXIT                                                   MD055265
     C                   ENDIF                                                              MD055265
                                                                                            MD055265
      *................................................................
     C**********         DELETE    @D3REI4                              91      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ delete from FCRCOBTD                                                                MD055265
     C+ where D3RNAM = :D3RNAM and D3COTT = :D3COTT and D3CSEQ = :D3CSEQ                    MD055265
     C/END-EXEC                                                                             MD055265
     C/EXEC SQL                                                                             MD055265
     C+ delete from FCRCOXTD                                                                MD055265
     C+ where D3RNAM = :D3RNAM and D3COTT = :D3COTT and D3CSEQ = :D3CSEQ                    MD055265
     C/END-EXEC                                                                             MD055265
     C******IN91         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE <> 0                                             MD055265
      * Delete error detected.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   ELSE
      * DBF Delete successful.
      *                                                                   S01407
      * If Report Component is related to a switchable feature, delete    S01407
      * records from Switchable Features Report Component file            S01407
      *                                                                   S01407
     C     AESARN        IFNE      *BLANKS                                                     S0140
     C     KSARM         SETLL     SCSARML2                           8585                     S0140
     C     KSARM         READE     SCSARML2                               85                   S0140
      *                                                                   S01407
     C     *IN85         DOWEQ     '0'                                                         S0140
     C                   DELETE    @SARML2                                                     S0140
     C     KSARM         READE     SCSARML2                               85                   S0140
     C                   END                                                                   S0140
      *                                                                   S01407
     C                   END                                                                   S0140
      * USER: Processing after DBF update
      * 00/copy member XX0302MDAU - Report Components  *
     C/COPY WNCPYSRC,FC0302MDAU
     C                   END
      *================================================================
     CSR   SHEXIT        ENDSR
      /EJECT
     CSR   SICHRC        BEGSR
      *================================================================
      * Change Report Components - Report Components  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * USER: Processing before DBF read
      * 00/copy member XX0302MBDU - Report Components  *
     C*
     C** REPORT COMPONENTS PROCESSING BEFORE UPDATE
     C/COPY WNCPYSRC,FC0302MBDU
      * Move key fields to @D3REI4
     C                   MOVEL     #1RNAM        D3RNAM                         Report name
     C                   MOVEL     #1COTT        D3COTT                         Component Name
     C                   MOVEL     #1CSEQ        D3CSEQ                         Component Seque
      *
     C     KLCHSI        KLIST
     C                   KFLD                    D3RNAM                         Report name
     C                   KFLD                    D3COTT                         Component Name
     C                   KFLD                    D3CSEQ                         Component Seque
     C*****KLCHSI        CHAIN     @D3REI4                            9091      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCRCOML                                                                       MD055265
     C+ from FCRCOJW0                                                                       MD055265
     C+ where D3RNAM = :D3RNAM and D3COTT = :D3COTT and D3CSEQ = :D3CSEQ                    MD055265
     C/END-EXEC                                                                             MD055265
     C******IN90         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE = 100                                            MD055265
      *
      * Record not found.
     C                   MOVEL     'Y2U0009'     W0RTN             7
      * Send message '*Record no longer on file'
     C**********           MOVEL'Y2U0009' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1084'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
     C                   GOTO      SIEXIT
     C                   END
      *
     C******IN91         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE <> 0  and SQLCODE <> 100                         MD055265
      * Record locked.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   GOTO      SIEXIT
     C                   END
      *
      * Do not allow amend of core record                                                   MD055265
     C     LD3MODE       IFEQ      'C'                                                      MD055265
     C                   MOVEL     'RCF0503'     ZAMSID                                     MD055265
     C                   MOVEL     'RCF0503'     W0RTN                                      MD055265
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                                     MD055265
     C                   EXSR      ZASNMS                                                   MD055265
     C                   GOTO      SIEXIT                                                   MD055265
     C                   ENDIF                                                              MD055265
                                                                                            MD055265
      * Check for changed record.
     C                   eval      @1DBRC = FCRCOML                                         MD055265
     C     #1DBRC        IFNE      @1DBRC                                       IF
     C                   MOVEL     'Y2U0007'     W0RTN             7
      * Send message '*Update not accepted'
     C**********           MOVEL'Y2U0007' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1085'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
      * Use SETLL to release record lock.
     C*****KLCHSI        SETLL     @D3REI4                            9091      *           MD055265
     C                   GOTO      SIEXIT
     C                   END                                                    FI #1DBRC
      * Move Non-key fields to @D3REI4
     C                   MOVEL     #1MORQ        D3MORQ                         Mandatory/On Re
     C                   MOVEL     #1CLPM        D3CLPM                         Calling Paramet
     C                   MOVEL     #1PRPG        D3PRPG                         Prompt Program
     C                   MOVEL     #1ADTX        D3ADTX                         Additional Repo
     C                   MOVEL     #1BRTP        D3BRTP                         Branch Type
      *
     C**********         UPDATE    @D3REI4                              91      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ update FCRCOBTD set                                                                 MD055265
     C+   D3MORQ = :D3MORQ                                                                  MD055265
     C+ , D3CLPM = :D3CLPM                                                                  MD055265
     C+ , D3PRPG = :D3PRPG                                                                  MD055265
     C+ , D3ADTX = :D3ADTX                                                                  MD055265
     C+ , D3BRTP = :D3BRTP                                                                  MD055265
     C+ where D3RNAM = :D3RNAM and D3COTT = :D3COTT and D3CSEQ = :D3CSEQ                    MD055265
     C/END-EXEC                                                                             MD055265
     C******IN91         IFEQ      '1'                                                      MD055265
     C                   IF        SQLCODE <> 0                                             MD055265
      * Change error detected.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   ELSE
      * DBF Change successful.
      * Update saved record image.
     C                   eval      @D3RNAM = D3RNAM                                         MD055265
     C                   eval      @D3COTT = D3COTT                                         MD055265
     C                   eval      @D3CSEQ = D3CSEQ                                         MD055265
     C                   eval      @D3MORQ = D3MORQ                                         MD055265
     C                   eval      @D3CLPM = D3CLPM                                         MD055265
     C                   eval      @D3PRPG = D3PRPG                                         MD055265
     C                   eval      @D3ADTX = D3ADTX                                         MD055265
     C                   eval      @D3BRTP = D3BRTP                                         MD055265
     C                   eval      @D3MODE = D3MODE                                         MD055265
     C                   MOVEL     @1DBRC        #1DBRC
      * USER: Processing after DBF update
      * 00/copy member XX0302MADU - Report Components  *
     C*
     C** EDIT REPORT COMPONENTS PROCESSING AFTER CHANGE
     C/COPY WNCPYSRC,FC0302MADU
     C                   END
      *================================================================
     CSR   SIEXIT        ENDSR
      /EJECT
     CSR   SJRVGN        BEGSR
      *================================================================
      * Set last change date/type - Report Descriptions  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Define Keylist.
     C     KRSSJ         KLIST
     C                   KFLD                    DXRNAM                         Report name
      * Move fields to key list.
     C                   MOVEL     P1RNAM        DXRNAM                         Report name
     C***********KRSSJ     CHAIN@DXREIK              90    *              S01407
     C*****KRSSJ         CHAIN     FCREPTD0                           90        *     S0140 MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCREPT :NullInds2                                                             MD055265
     C+ from FCREPJW1                                                                       MD055265
     C+ where DXRNAM = :P1RNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C                   SETOFF                                       90                    MD055265
     C                   IF        SQLCODE = 100                                            MD055265
     C                   SETON                                        90                    MD055265
     C                   ENDIF                                                              MD055265
      * DBF Record not found.
     C***90*****           MOVEL'USR0712' W0RTN   7                       LN1190
     C   90              MOVEL     'RCF0712'     W0RTN             7                           LN119
     C     *IN90         IFEQ      '0'
      * USER: Process DBF record
     C                   MOVEL     @CN(02)       WUJTST                         Action Code
      * Change Report Description - Report Descriptions  *
     C                   EXSR      SKCHRC
     C                   END
      *================================================================
     CSR   SJEXIT        ENDSR
      /EJECT
     CSR   SKCHRC        BEGSR
      *================================================================
      * Change Report Description - Report Descriptions  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * USER: Processing before DBF read
     C*Edit Report Descriptions Processing Before Update
     C/COPY WNCPYSRC,FC0303MBDU
      *CASE:     PGM.*Return code is *User QUIT requested
     C     W0RTN         IFEQ      @CN(08)                                      *IF
     C                   MOVEL     @CN(08)       P0RTN                          *Return code
     C                   EXSR      ZYEXPG
     C                   END                                                    *FI
      *CASE:     PGM.*Return code is *Previous Screen
     C     W0RTN         IFEQ      @CN(09)                                      *IF
     C                   GOTO      SKEXIT                                       *QUIT
     C                   END                                                    *FI
      *
     C     KLCHSK        KLIST
     C                   KFLD                    DXRNAM                         Report name
     C                   MOVEL     DXRNAM        KKRNAM                                     MD055265
     C*****KLCHSK        CHAIN     @DXREIJ                            9091      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCREPTL                                                                       MD055265
     C+ from FCREPJW0                                                                       MD055265
     C+ where DXRNAM = :KKRNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C                   IF        SQLCODE = 100                                            MD055265
      *
     C******IN90         IFEQ      '1'                                                      MD055265
      * Record not found.
     C                   MOVEL     'Y2U0009'     W0RTN             7
      * Send message '*Record no longer on file'
     C**********           MOVEL'Y2U0009' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1084'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
     C                   GOTO      SKEXIT
     C                   END
      *
     C     *IN91         IFEQ      '1'
      * Record locked.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   GOTO      SKEXIT
     C                   END
      *
      * Move Non-key fields to @DXREIJ
     C                   Z-ADD     WURUND        DXLCD                          Last Change Dat
     C                   MOVEL     @CN(02)       DXCHTP                         Type of Last Ch
      *
     C**********         UPDATE    @DXREIJ                              91      *           MD055265
     C/EXEC SQL                                                                             MD055265
     C+ update FCREPXTD                                                                     MD055265
     C+  SET DXCHTP = :DXCHTP                                                               MD055265
     C+ , DXLCD = :DXLCD                                                                    MD055265
     C+ WHERE DXRNAM = :KKRNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
                                                                                            MD055265
     C                   If        (SQLCODE <> 0)                                           MD055265
     C******IN91         IFEQ      '1'                                                      MD055265
      * Change error detected.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   ELSE
      * DBF Change successful.
      * USER: Processing after DBF update
     C                   Z-ADD     *ZERO         WUNORC                         No. of Records
     C                   Z-ADD     *ZERO         WUNOIN                         No. of Inserts
     C                   Z-ADD     *ZERO         WUNODL                         No. of Deletes
     C                   Z-ADD     1             WUNOAM                         No. of Amends
      * Change Report Description - Report Descriptions Audit  *
     C                   EXSR      SLCHRC
     C*Edit Report Descriptions Processing After Update
     C/COPY WNCPYSRC,FC0303MADU
     C                   END
      *================================================================
     CSR   SKEXIT        ENDSR
      /EJECT
     CSR   SLCHRC        BEGSR
      *================================================================
      * Change Report Description - Report Descriptions Audit  *
      *================================================================
     C                   MOVEL     *BLANK        W0RTN             7
      * Move key fields to @ADREBB
     C                   MOVEL     @CN(10)       ADFLNM                         Filename
      *
     C     KLCHSL        KLIST
     C                   KFLD                    ADFLNM                         Filename
     C     KLCHSL        CHAIN     @ADREBB                            9091      *
      *
     C     *IN90         IFEQ      '1'
      * Record not found.
     C                   MOVEL     'Y2U0009'     W0RTN             7
      * Send message '*Record no longer on file'
     C**********           MOVEL'Y2U0009' ZAMSID           Message id.    LN1272
     C**********           MOVEL'Y2USRMSG'ZAMSGF           Message file.  LN1272
     C                   MOVEL     'RCF1084'     ZAMSID                         Message id.    LN127
     C                   MOVEL     'FCUSRMSG'    ZAMSGF                         Message file.  LN127
     C                   EXSR      ZASNMS                                       Send message
     C                   GOTO      SLEXIT
     C                   END
      *
     C     *IN91         IFEQ      '1'
      * Record locked.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   GOTO      SLEXIT
     C                   END
      *
      * USER: Processing after DBF read
     C                   ADD       ADNORC        WUNORC                         No. of Records
     C                   ADD       ADNOIN        WUNOIN                         No. of Inserts
     C                   ADD       ADNOAM        WUNOAM                         No. of Amends
     C                   ADD       ADNODL        WUNODL                         No. of Deletes
      * Move Non-key fields to @ADREBB
     C                   Z-ADD     WUNORC        ADNORC                         No. of Records
     C                   Z-ADD     WUNOIN        ADNOIN                         No. of Inserts
     C                   Z-ADD     WUNOAM        ADNOAM                         No. of Amends
     C                   Z-ADD     WUNODL        ADNODL                         No. of Deletes
      *
     C                   UPDATE    @ADREBB                              91      *
     C     *IN91         IFEQ      '1'
      * Change error detected.
     C                   MOVEL     'Y2U0004'     W0RTN             7
     C                   ELSE
      * DBF Change successful.
      * Move @ADREBB fields back.
     C                   Z-ADD     ADNORC        WUNORC                         No. of Records
     C                   Z-ADD     ADNOIN        WUNOIN                         No. of Inserts
     C                   Z-ADD     ADNOAM        WUNOAM                         No. of Amends
     C                   Z-ADD     ADNODL        WUNODL                         No. of Deletes
     C                   END
      *================================================================
     CSR   SLEXIT        ENDSR
      /EJECT
     CSR   VACKRL        BEGSR
      *================================================================
      * Check restriction within Report Descriptions.
      *================================================================
      * Name search required ?
     C                   MOVEL     #2RNAM        WK1X01            1            Report name
     C     WK1X01        IFEQ      '?'                                          Report name
     C                   CALL      'FC0300S'                            90      *
     C                   PARM                    W0RTN             7            Return code
     C     #2RNAM        PARM      #2RNAM        WQ0001           10            Report name
     C     *IN90         IFEQ      '1'
      * Call to program ended in error.
     C                   MOVEL     'Y2U0021'     W0RTN             7
     C                   END
     C                   MOVEL     'Y'           W0DCF             1            Defer confirm
      * No value selected exit.
     C     W0RTN         CABNE     *BLANK        VA999
     C                   END
      *................................................................
      *
     C     KLVADX        KLIST
     C                   KFLD                    DXRNAM                         Report name
      * Setup key.
     C                   MOVEL     #2RNAM        DXRNAM                         Report name
     C***********KLVADX    CHAIN@DXREIK              9091  *              S01407
     C*****KLVADX        CHAIN     FCREPTD0                           9091      *     S0140 MD055265
     C/EXEC SQL                                                                             MD055265
     C+ SELECT *                                                                            MD055265
     C+ into :FCREPT :NullInds2                                                             MD055265
     C+ from FCREPJW1                                                                       MD055265
     C+ where DXRNAM = :#2RNAM                                                              MD055265
     C/END-EXEC                                                                             MD055265
     C                   SETOFF                                       90                    MD055265
     C                   IF        SQLCODE = 100                                            MD055265
     C                   SETON                                        90                    MD055265
     C                   ENDIF                                                              MD055265
     C     *IN90         IFEQ      '0'
      * Record found - move back any virtuals.
     C                   GOTO      VAEXIT
     C                   END
     C     VA999         TAG
      * Restrictor relation not satisfied
      * Send message 'Report Descriptions    NF'
     C**********           MOVEL'USR0712' ZAMSID           Message id.    LN1190
     C                   MOVEL     'RCF0712'     ZAMSID                         Message id.    LN119
     C                   MOVEL     '*PRV '       ZAPGRL                         Pgmq rel.
     C                   EXSR      ZASNMS                                       Send message
     C**********           MOVEL'USR0712' P0RTN                           LN1190
     C                   MOVEL     'RCF0712'     P0RTN                                         LN119
     C                   EXSR      ZYEXPG
      *================================================================
     CSR   VAEXIT        ENDSR
      /EJECT
     CSR   ZASNMS        BEGSR
      *================================================================
      * Send message to program's message queue.
      *================================================================
      **Send*if*first*error*message*or*not*an*error*message.***           LN1272
     C***********ZAMSTP    IFNE *BLANK                                    LN1272
     C***********ZAFSMS    ORNE 'N'                                       LN1272
     C***********ZAMSTP    IFEQ *BLANK                                    LN1272
      **Signal*first*error*message*sent.***                               LN1272
     C***********          MOVEL'N'       ZAFSMS                          LN1272
     C***********          END                                            LN1272
     C     ZAPGM         IFEQ      *BLANK
     C                   MOVEL     ##PGM         ZAPGM
     C                   END
      * If no message file specified use default.
     C     ZAMSGF        IFEQ      *BLANK
     C                   MOVEL     ZADFMF        ZAMSGF
     C                   END
     C                   CALL      'Y2SNMGC'
     C                   PARM                    ZAPGM            10            Program queue
     C                   PARM                    ZAPGRL            5            Rel queue
     C                   PARM                    ZAMSID            7            Message Id.
     C                   PARM                    ZAMSGF           10            Message file.
     C                   PARM                    ZAMSDA          132            Message data.
     C                   PARM                    ZAMSTP            7            Message type.
     C***********          END                                            LN1272
      * Clear all fields for default mechanism next time.
     C                   MOVEL     *BLANK        ZAPGM                          Program queue
     C                   MOVEL     *BLANK        ZAPGRL                         Rel queue
     C                   MOVEL     *BLANK        ZAMSID                         Message Id.
     C                   MOVEL     *BLANK        ZAMSGF                         Message file.
     C                   MOVEL     *BLANK        ZAMSDA                         Message data.
     C                   MOVEL     *BLANK        ZAMSTP                         Message type.
      *================================================================
     CSR   ZAEXIT        ENDSR
      /EJECT
     CSR   ZHHPKY        BEGSR
      *================================================================
      * Display HELP text.
      *================================================================
     C                   MOVEL     'Y'           W0HLP             1            Signal help req
     C                   CALL      'YDDSHPR'
     C                   PARM      ##PGM         W0HPMB           10            Member name.
     C                   PARM      *BLANK        YYHPFL           10            *DFT text file.
     C                   PARM      *BLANK        YYHPLB           10            Help text lib.
     C                   PARM                    W0RTN             7            Return Code.
      *================================================================
     CSR   ZHEXIT        ENDSR
      /EJECT
     CSR   ZXEXPG        BEGSR
      *================================================================
      * Exit program: Normal.
      *================================================================
      * USER: Exit program processing
      *CASE:     CTL.*CMD key is *Exit
     C     *IN03         IFEQ      '1'                                          *IF
      *CASE:     WRK.Update Made is Update Made
     C     WUAZST        IFEQ      @CN(07)                                      *IF
      * Set last change date/type - Report Descriptions  *
     C                   EXSR      SJRVGN
     C                   END                                                    *FI
     C                   MOVEL     @CN(08)       P0RTN                          *Return code
     C                   EXSR      ZYEXPG
     C                   END                                                    *FI
      * 00/copy member XX0302MEPP - Report Components  *
     C*Edit Report Components   Exit Program Processing
     C/COPY WNCPYSRC,FC0302MEPP
     C                   MOVEL     *BLANK        P0RTN
     C                   EXSR      ZYEXPG
      *================================================================
     CSR   ZXEXIT        ENDSR
      /EJECT
     CSR   ZYEXPG        BEGSR
      *================================================================
      * Exit program: Direct.
      *================================================================
      * Terminate program.
     C                   SETON                                        LR
      *
     C/EXEC SQL                                                                             MD055265
     C+ close ACursor                                                                       MD055265
     C/END-EXEC                                                                             MD055265
                                                                                            MD055265
      * Exit program.
     C                   RETURN
      *
      *================================================================
     CSR   ZYEXIT        ENDSR
      /EJECT
     CSR   ZZINIT        BEGSR
      *================================================================
      * Initialisation.
      *================================================================
     C                   MOVE      *BLANK        P0RTN
     C                   MOVE      *BLANK        W0RTN             7
      * Setup job date/time.
     C                   Z-ADD     UDATE         ##JDT                          Job date.
     C                   TIME                    ##JTM                          Job time.
     C                   TIME                    ##TME             6 0          Screen time.
      * Define work field Action Code
     C                   MOVEL     *BLANK        WUJTST            1
      * Obtain default message file.
     C     *DTAARA       DEFINE    FCMGFLA       ZADFMF           10
     C                   IN        ZADFMF
      * Define work field Update Made
     C                   MOVEL     *BLANK        WUAZST            1
      * Define work field run day number
     C                   Z-ADD     *ZERO         WURUND            5 0
      * Define work field No. of Records
     C                   Z-ADD     *ZERO         WUNORC            5 0
      * Define work field No. of Inserts
     C                   Z-ADD     *ZERO         WUNOIN            5 0
      * Define work field No. of Deletes
     C                   Z-ADD     *ZERO         WUNODL            5 0
      * Define work field No. of Amends
     C                   Z-ADD     *ZERO         WUNOAM            5 0
      * Define work field Multi-branching Indicator
     C                   MOVEL     *BLANK        WUMBIN            1
      * Define work field midas rundate
     C                   MOVEL     *BLANK        WURUNA            7
      * Define work field Set Up Complete
     C                   MOVEL     *BLANK        WUSSF             1
      * Define work field date format flag
     C                   MOVEL     *BLANK        WUDATF            1
      **Signal*first*error*message*outstanding.*****                      LN1272
     C**********           MOVEL'Y'       ZAFSMS  1                       LN1272
      *
     C                   Z-ADD     03            ##SFPG            3 0          SFLPAG
     C                   Z-ADD     1             ##SFRC
     C                   Z-ADD     *ZERO         ##RRMX                         MAX RECNO
      *................................................................
      * Set to *CHANGE mode.
     C                   MOVEL     'CHG'         W0PMD             3            Change mode
     C                   MOVEL     'Y'           W0APM             1            First time
      * USER: Initialise program
      * Last Amd Hdr Box fc0302m - Report Components  *
      * Initialise EDTFIL program
      * get rundate - rundate  *
     C     *DTAARA       DEFINE                  RUNDAT
     C                   IN        RUNDAT
     C                   MOVE      RUNA          ##RUNA
     C                   MOVE      RUNA          WURUNA
     C                   MOVE      RUND          WURUND
     C                   MOVE      SSF           WUSSF
     C                   MOVE      DATF          WUDATF
     C                   MOVE      MBIN          WUMBIN
      * Standard RPG Creation PAR - standard functions  *
      *  C R E A T I O N     P A R A M E T E R S
      *
      *
      ********************************************************************
      * Copyright Statement - standard functions  *
     C                   MOVEA     CPY@          BIS@             80
      * Set up EDTFIL screen - standard functions  *
     C     WUJTST        IFEQ      'I'
     C                   MOVEA     AEMQ(1)       ##AENA
     C                   ELSE
     C                   MOVEA     AEMQ(2)       ##AENA
     C                   END
      * 00/copy member XX0302MCPG - Report Components  *
     C*Edit Report Components   Initialise Program C-Spec
     C/COPY WNCPYSRC,FC0302MCPG
      * 00/copy member XX0302MIPG - Report Components  *
      * 00/copy member XX0302MEPG - Report Components  *
      * 00/copy member XX0302MFPG - Report Components  *
      * 00/copy member XX0302MOPG - Report Components  *
      * Initialise subfile control.
     C                   EXSR      MEIZ#2
      *================================================================
     CSR   ZZEXIT        ENDSR
     O*Edit Report Components   Initialise Program O-Spec
     O/COPY WNCPYSRC,FC0302MOPG
*******F3=Main Menu   F9=Go To 'Add' Mode   F12=Previous                  LN1146
**
F3=Main Menu   F9=Go To 'Change' Mode   F12=Previous
D=Delete   F3=Main Menu   F9=Go To 'Add' Mode   F12=Previous
** CPY@
(c) Finastra International Limited 2001
** @CN Long constants used in program.
CHG
A
B
ADD
I
Y2U0005
Y
Y2U9999
RCF0790
FCREPTPD
N
