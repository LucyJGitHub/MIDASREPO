     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FF Exercise an option (main)')                   *
/*OVRF*: OVRDBF TRANSIN TRANS                                       : *
/*OVRF*: OVRDBF TRSETIN TRSET                                       : *
     F*****************************************************************
     F*                                                               *
     F*  Midas  -  Futures and Options Module                         *
     F*                                                               *
     F*  FF0040  -  EXERCISE AN OPTION INPUT (MAIN DETAIL PROGRAM)    *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. AR746662           Date 03May11               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. 246526             Date 21Mar07               *
      *                 247517             Date 09May07               *
      *                 CPK027             Date 16Apr07               *
      *                 243826A            Date 25Jan07               *
      *                 241147A            Date 07Nov06               *
      *                 241147             Date 26Oct06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CAAA03             Date 28Apr04               *
      *                 CRE020             Date 20Jan04               *
      *                 CGL029             Date 01Sep03               *
      *                 215528             Date 21Mar03               *
      *                 CSD015             Date 14Oct02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun02               *
      *                 CAS002             Date 14Jan02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 185846             Date 10Jul01               *
      *                 192969             Date 09Jul01               *
      *                 CFF007             Date 13Feb01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CFF006             Date 28Nov00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 126117             Date 20Apr00               *
      *                 140017             Date 20Apr00               *
     F*                 140455             Date 20Apr00               *
     F*                 136056             Date 13Apr00               *
     F*                 150367             Date 07Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
     F*                 CPB001             Date 18Jun99               *
      * Midas DBA 3.01 Patch E ---------------------------------------*
      *                 171172             Date 25Nov99               *
      *                 170520             Date 19Nov99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 CPL002             Date 08MAR99               *
      *                 CAP003             Date 30Jul98               *
     F*                 CFF003             Date 19Dec96               *
     F*                 CAC003             Date 25Feb97               *
     F*                 CFF004             Date 13Sep96               *
     F*                 S01408             Date 14Aug96               *
     F*                 CPM003             DATE 07DEC95               *
     F*                 S71062             DATE 07DEC95               *
     F*                 077485             DATE 17NOV95               *
     F*                 059770             DATE 17NOV95               *
     F*                 S01408             DATE 13MAR95               *
     F*                 046303             DATE 13JAN94               *
     F*                 S01457             DATE 29DEC93               *
     F*                 S01455             DATE 05NOV93               *
     F*                 S04662             DATE 12JUL93               *
     F*                 S01411             DATE 05JUL93               *
     F*                 054174             DATE 21APR93               *
     F*                 E30419             DATE 02MAR93               *
     F*                 E30416             DATE 02MAR93               *
     F*                 E03643             DATE 19FEB93               *
     F*                 E30422             DATE 15FEB93               *
     F*                 E27760             DATE 15FEB93               *
     F*                 S01393             DATE 30OCT92               *
     F*                 E44985             DATE 25SEP92               *
     F*                  FUJI-FF0011        DATE 10AUG92              *
     F*                  E38323             DATE 30JUL92              *
     F*                  AUS022             DATE 06AUG92              *
     F*                  FO0025             DATE 21JAN91                 *
     F*                  FO0017             DATE 19DEC90                 *
     F*                  HK0000             DATE 17MAY90                 *
     F*                  S01195             DATE 20APR90                 *
     F*                  S01117             DATE 27FEB90                 *
     F*                  S01199             DATE 27FEB90                 *
     F*                  S01240             DATE 03JAN90                 *
     F*                  E17745             DATE 19/05/89                *
     F*                                                                  *
     F*---------------------------------------------------------------*
      *                                                               *
      *  AR746662 - Discrepancy in premium amount in Currency OTC     *
      *             screen and Projected Available Balance Enquiry    *
      *             Applied fix 249171. (Recompile)                   *
      *             (Child: Artf746663)                               *
      *  246526 - Recompiled due to change in FFSETLZ4.               *
      *  247517 - Reversed fix 241147.                                *
      *  CPK027 - Errors in compiling MP1_3_TTTS - recompile over     *
      *           changed FFTVCLZ2.                                   *
      *  243826A- Recompiled due to changes in FFPRCSZ2, FFPRCSZ3,    *
      *           FFPRVLZ2 and FFPRVLZ3.                              *
      *  241147A - Recompile.                                         *
      *  241147 - Recompile.                                          *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CAAA03 - Webfacing Changes (recompile)                       *
      *  CRE020 - Midas Plus Online Printing of Advices (GE7)         *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  215528 - System is associating a wrong premium amount.       *
      *           Recompiled only.                                    *
      *  CSD015 - Midas Compliance Watch - Watch List Checking        *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed FFYTOPZ1.                    *
      *  CAS002 - Hedge Strategy/Linkage (Recompile)                  *
      *  185846 - Setup correctly field NCCP 'Number of contingent    *
      *           contracts posted' in TRSETD                         *
     F*  192969 - Cannot exercise Option on OTC when transaction      *
     F*           date is not equal to settlement date. Use the final *
     F*           transaction date, neither before nor after.         *
      *  CFF007 - Futures and Options Enhancement for Private Banking *
      *  CFF006 - Fractional Ticks Enhancement.  (Recompiled)         *
     F*  126117 - Recompiled due to changes to FFYTOPZ1.              *
     F*  140017 - Recompiled due to changes to FFPMCLZ1.              *
     F*  140455 - Recompiled due to changes to FFPMCLZ1.              *
      *  136056 - Calculate Australian option premiums correctly.     *
      *           Recompiled due to changes in FFYTOPZ1               *
      *  150367 - Recompile over changed /copy FFSTDPZ4.              *
     F*  CPB001 - 'Private Banking' Module                            *
     F*  171172 - Recompile over changed POSTNCD/POSTNKD             *
      *  170520 - Recompile over changed TRANSD file                  *
     F*  CPL002 - Midas-Plato Interface (Recompiled)                  *
      *  CAP003 - Conversion of Midas inputs to modular API structure *
      *           Phase 2.  Program recompiled over changed files.    *
     F*  CFF003 - ENHANCED OTC PROCESSING - PHASE II                  *
     F*           UPGRADE FROM BLI LBL001                             *
     F*  CAC003 - Profit Centre Accounting Development Phase 3.       *
     F*  CFF004 - Increase in size of Price Fields                    *
     F*  S01408 - Core hook FF0040CP33 added                          *
     F*         - Core hook FF0040CP32 added                          *
     F*         - Core hook FF0040CP31 added                          *
     F*         - Core hook FF0040CP30 added                          *
     F*         - Core hook FF0040CP29 added                          *
     F*         - Core hook FF0040CP28 added                          *
     F*         - Core hook FF0040CP27 added                          *
     F*         - Core hook FF0040CP26 added                          *
     F*         - Core hook FF0040CP25 added                          *
     F*         - Core hook FF0040CP24 added                          *
     F*         - Core hook FF0040CP23 added                          *
     F*         - Core hook FF0040CP22 added                          *
     F*         - Core hook FF0040CP21 added                          *
     F*         - Core hook FF0040CP20 added                          *
     F*         - Core hook FF0040CP19 added                          *
     F*         - Core hook FF0040CP18 added                          *
     F*         - Core hook FF0040CP17 added                          *
     F*         - Core hook FF0040CP16 added                          *
     F*         - Core hook FF0040CP15 added                          *
     F*         - Core hook FF0040CP14 added                          *
     F*         - Core hook FF0040CP13 added                          *
     F*         - Core hook FF0040CP12 added                          *
     F*         - Core hook FF0040CP11 added                          *
     F*         - Core hook FF0040CP10 added                          *
     F*         - Core hook FF0040CCP9 added                          *
     F*         - Core hook FF0040CCP8 added                          *
     F*         - Core hook FF0040CCP7 added                          *
     F*         - Core hook FF0040CCP6 added                          *
     F*         - Core hook FF0040CCP5 added                          *
     F*         - Core hook FF0040CCP4 added                          *
     F*         - Core hook FF0040CCP3 added                          *
     F*         - Core hook FF0040CCP2 added                          *
     F*         - Core hook FF0040CCP1 added                          *
     F*         - Core hook FF0040IIP8 added                          *
     F*         - Core hook FF0040IIP7 added                          *
     F*         - Core hook FF0040IIP6 added                          *
     F*         - Core hook FF0040IIP5 added                          *
     F*         - Core hook FF0040IIP4 added                          *
     F*         - Core hook FF0040IIP3 added                          *
     F*         - Core hook FF0040IIP2 added                          *
     F*         - Core hook FF0040IIP1 added                          *
     F*         - Core hook FF0040FFP1 added                          *
     F*  CPM003 - FF PM Interface Upgrade to R10.                     *
     F*  S71062   FF/PM Interface - Exercise option                   *
     F*           (Remove error code "086" in order to allow to work  *
     F*           with S71062 enhancement).                           *
     F*  077485 - FF/PM INTERFACE : MATURE FLAT POSITIONS NOT         *
     F*           EXTRACTED FOR FF TRADES                             *
     F*  059770 - PORTFOLIO REFERENCE FROM ACCNT WRITTEN IN TRANSD    *
     F*  S01408 - Core hook FF0040IIPG added                          *
     F*         - Core hook FF0040CCPG added                          *
     F*         - Core hook FF0040CVSF added                          *
     F*         - Core hook FF0040CVS1 added                          *
     F*         - Core hook FF0040CVS2 added                          *
     F*  046303 - /COPY source subr. ZFWDT amended to prevent array   *
     F*           error if no holiday record found - fixed by S01434. *
     F*           Program recompiled.                                 *
     F*  S01457 - Enable Brokers to deal with OTC's.                  *
     F*  S01455 - 'FF' ACCOUNT KEY ENHANCEMENTS.                      *
     F*           Recompiled due to changes in PF/TABTB80.            *
     F*  S04662 - Switchable Feature for Init Margins for Futures;    *
     F*           Deposit and Spread Margin Rate added to DEFLTD.     *
     F*           Recompile only.                                     *
     F*  S01411 - 'ORIGINAL ENTRY DATE' field added to PF/TRANSD      *  *
     F*  054174 - Premium Calculation introduced by E30422            *
     F*           should only apply to processing type 8              *
     F*  E30419 - Recompiled due to amendments on subroutine FFPLCL   *
     F*           due to rounding errors and incorrect sign of        *
     F*           profit/loss.                                        *
     F*  E30416 - Recompiled due to amendments on subroutines         *
     F*           FFPLCL and FFYTOP                                   *
     F*  E03643 - Commissions, though calculated correctly on         *
     F*         - a trade basis for accounting purposes are not       *
     F*         - reported correctly by individual closeout.          *
     F*  E30422 - Premium calculations appear to be incorrect on      *
     F*           options purchased. To fix the error, the strike     *
     F*           price is used in the tick value computations        *
     F*           instead of the contract price.                      *
     F*  E27760 - Cannot enquire on a deleted future and options      *
     F*           trade.  Error message indicates that an enquiry     *
     F*           should be possible                                  *
     F*   S01393  -  RECOMPILED FOR STRATEGIC RISK MANAGEMENT            *
     F*   E44985  -  ZYIELD requires 3 new parameters. Recompile only    *
     F* FUJI-FF0011 - The system does not differentiate between          *
     F*               american and european option on exercise           *
     F*               validation and OTC confirmation wording.           *
     F*   E38323  -  Recompilation of the program done due to a          *
     F*              change in copy source ZFWDT subroutine              *
     F*   AUS022  -  AUSTRALIAN CHANGE : Introduction of Processing      *
     F*              Types 7 and 8.                                      *
     F*   FO0025  -  IF NOSTRO IS ZERO THEN SETTL.DETAILS ARE BLANK      *
     F*   FO0017  -  ADD BRCA ON UPDATE OF ACCOUNT MOVEMENTS FILE        *
     F*   S01195  -  HOLIDAY PROCESSING AMENDMENT                        *
     F*   S01117  -  MULTIBRANCHING                                      *
     F*   S01199  -  HELP SYSTEM                                     *
     F*   S01240  -  ADDITION OF REAL-TIME STATEMENTS                    *
     F*   HK0000  -  AMEND TO AVOID REPORTING DB ERROR 15 WHEN ENQUIRY   *
     F*              ON A DELETED OTC RECORD                             *
     F*------------------------------------------------------------------*
     F*     CREATION REQUIREMENTS                                        *
     F*                                                                  *
     F*     IGNDECERR(*YES)                                              *
     F*     OVRDBF   FILE(TRANSIN) TOFILE(TRANS)                         *
     F*     OVRDBF   FILE(TRSETIN) TOFILE(TRSET)                         *
     F*                                                                  *
     F********************************************************************
     FTRANSA  UF  E                    DISK         KCOMIT            UC
     FPOSTNC  UF  E           K        DISK         KCOMIT            UC
     FPOSTNK  UF  E           K        DISK         KCOMIT            UC
     FMEMOSM  UF  E           K        DISK         KCOMIT       A    UC
     FPRONOM  UF  E           K        DISK         KCOMIT       A    UC
     FFFACMVD O   E           K        DISK         KCOMIT       A    UC  S01240
     FCLOST   UF  E           K        DISK         KCOMIT       A    UC
     FCLOST2  UF  E           K        DISK         KCOMIT       A    UC
     FTRSET   UF  E           K        DISK         KCOMIT       A    UC
     FTRANS   UF  E           K        DISK         KCOMIT       A    UC
     F                                              KINFDS INFDS
     F                                              KINFSR INFSR
     FACCNT   IF  E           K        DISK
     F            ACCNTAAF                          KIGNORE
     F            ACCNTACF                          KIGNORE
     FACNUM   IF  E           K        DISK
     F            ACCNTABF                          KRENAMEACNUMABF
     FCLINT   IF  E           K        DISK
     F            CLINTCAF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     FSNAME   IF  E           K        DISK
     F            CLINTCBF                          KRENAMESNAMECBF
     FCHGCM   IF  E           K        DISK
     FFOCLT   IF  E           K        DISK
     FDEFLT   IF  E           K        DISK
     FINTYP2  IF  E           K        DISK
     F            INTYPDF                           KRENAMEINTYP2DF
     FINTYP   IF  E           K        DISK
     FTRSETIN IF  E           K        DISK                           UC
     F            TRSETDF                           KRENAMETRSETINF
     FTRANSIN IF  E           K        DISK                           UC
     F            TRANSDF                           KRENAMETRANSINF
     FTRANS2  IF  E           K        DISK
     F            TRANSDF                           KRENAMETRANS2DF
     FTABFF   IF  E           K        DISK                           UC
     F            TABTB10F                          KIGNORE
     F* ICD 2     TABTB11F                          KIGNORE
     F            TABTB11F                          KIGNORE               S01117
     F* ICD 3     TABTB20F                          KIGNORE
     F* ICD 5     TABTB40F                          KIGNORE
     F* ICD-FF    TABTB80F                          KIGNORE
     F* A/C 1     TABTE10F                          KIGNORE
     F* CCY 1     TABTG10F                          KIGNORE
     F            TABLETHF                          KIGNORE
     F* NOSTROS   TABLETLF                          KIGNORE
     F* BRANCH    TABLETRF                          KIGNORE
     F            TABLETRF                          KIGNORE               S01117
     F* CPTY NOS  TABLET2F                          KIGNORE
     F*ABLETJ*IF* E           K        DISK                               S01195
     FFF0030DFCF  E                    WORKSTN
     F*                                                                   S01408
     F/COPY WNCPYSRC,FF0040FFP1                                           S01408
     F*                                                                   S01408
      ** Compliance Watch Hit List by Function Type, Identifier, Branch                       CSD015
     FSDCWHTL1IF  E           K        DISK                                                   CSD015
     F*
     FREADVCL1UF  E           K        DISK         KCOMIT       A    UC                      CRE020
      ** MIDAS RE Settled Transaction Index file                                              CRE020
      *                                                                                       CRE020
     F********************************************************************
     F/EJECT
     F********************************************************************
     F*
     F*                  FUNCTION OF INDICATORS
     F*                 ************************
     F* ID F  C  H  L
     F*
     F*      01        'HELP' key
     F*      02        Insert
     F*      03        Amend
     F*      04        Delete
     F*      05        Enquire
     F*      06        DSPF/FF0030DF - Read fail
     F*      07        INVITE enabled
     F*      10        Valid exit Indicator
     F*      11        Record Updated by Another Workstation
     F*     11+12      Related Record Updated by Another Workstation
     F*     11+16      Related Record Deleted by Another Workstation
     F*
     F*      13        Insert/Amend main screen
     F*      14        Broker was present for requested transaction
     F*      15        Customer was present for requested transaction
     F*
     F*      18        General Error Indicator
     F*
     F*      19        Counterparty nostro numeric
     F*
     F*    Field Error Indicators
     F*   ~~~~~~~~~~~~~~~~~~~~~~~~
     F*      20        Action Code   (in FF0030)
     F*      21        Market Centre (in FF0030)
     F*
     F*      22        Transaction Reference
     F*      29        Value Date (NON-DISPLAY)                           CFF003
     F*      30        Exercise Price
     F*      31        Transaction Date
     F*      32        Broker
     F*      33        Customer
     F*      34        Book
     F*      35        Number of Contracts to exercise
     F*      36        No selection in user query facility of Customer    S01117
     F*      37        No selection in user query facility of Broker      S01117
     F*      38        Closure Reference
     F*      39        Value Date                                         CFF003
     F*
     F*    Broker Settlement details
     F*   ~~~~~~~~~~~~~~~~~~~~~~~~
     F*      40        Commission Code (Standard)
     F*      41        Commission Code (Same Day)
     F*      42        Commission Amount
     F*      43        Charge Code
     F*      44        Charge Amount
     F*      45        Settlement Branch                                  S01117
     F*      46        Settlement Type
     F*      47        Settlement Account
     F*      48        For Account Of
     F*      49        Counterparty Nostro
     F*
     F*    Customer Settlement details
     F*   ~~~~~~~~~~~~~~~~~~~~~~~~
     F*      50        Commission Code (Standard)
     F*      51        Commission Code (Same Day)
     F*      52        Commission Amount
     F*      53        Charge Code
     F*      54        Charge Amount
     F*      55        Settlement Branch                                  S01117
     F*      56        Settlement Type
     F*      57        Settlement Account
     F*      58        For Account Of
     F*      59        Counterparty Nostro
     F*
     F*    General Settlement details
     F*   ~~~~~~~~~~~~~~~~~~~~~~~~
     F*      60        Settlement Type (SLTVL SR.)
     F*      61        Settlement Account (SLAVL SR.)
     F*      62        For Account Of (FAOVL SR.)
     F*      63        Counterparty Nostro (CPNVL SR.)
     F*      64        Multi-Branch Ind. 'N'
     F*      65        EOC Processed Ind. 'N'
     F*      66        Don't execute SLAVL, FAOVL & CPNVL SR's
     F*
     F*      67        Settlement Branch (SLAVL SR.)                      S01117
     F*      69        Counterparty nostro field contains customer
     F*                shortname
     F*      70        LF/TABFF - ICD record - Read/Chain fail
     F*      71        Other files - Read/Chain fail
     F*      72        Enquiry on a deleted record
     F*      73        Account Type is R (Retail)
     F*      74        Work indicator
     F*      75        Subroutine is called from CUSTVL SR.
     F*      76        Subroutine is called from BROKVL SR.
     F*      77        Write to LF/TRANS fails
     F*      78        Transaction dates of Trade and Exercise are same
     F*      79        Final Contracts on a Trade are being exercised
     F*
     F*    80-89       Reserved for Standard FF Subroutines
     F*    90-99       Reserved for Standard MIDAS Subroutines
     F*
     F*      KC        F3 - exit program
     F*      KL        F12 - return to previous screen
     F*                    also set on after valid detail screen entry
     F*      KJ        F10 - Delete (only valid for PACTN = 'D')
     F*      KI        F9  - Return to initial screen (ACTION/MARKET)     E17745
     F*
     F*      U2        Retail module is active in system
     F*   U7+U8        Database Errors
     F*
     F********************************************************************
     F/EJECT
     F********************************************************************
     E                    CPY@    1   1 80
     E*    Error Codes
     E                    ERR        40  4
     E*    Error Messages
     E                    MSG     1   4 76
     E*    Used in SR. FFPRCS/FFPRVL
     E/COPY ZSRSRC,FFPRVLZ2
     E*    - Currencies / Currency decimal places
     E/COPY ZSRSRC,FFSTDPZ1
     E*    Used in SR. FFDATE
     E/COPY ZSRSRC,FFDATEZ1
     E*    Used in SR. ZALIGN/ZEDIT
     E*    - Input + Output arrays
     E/COPY ZSRSRC,ZALIGNZ1
     E*    Used in SR. ZDATE1/ZDATE2 :
     E*    - Years in days, cumulative 4-year span
     E*    - Months in days, cumulative through year
     E*    - Months, Shortnames
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZHOLE                                                  S01195
     E*****Used*in*SR.*ZDATE3*********************************************S01195
     E*COPY*ZSRSRC,ZDATE3Z1                                               S01195
     E*COPY*ZSRSRC,ZDATE5Z1                                               S01195
     E/COPY WNCPYSRC,FF0040E001
     E                    RNG         9  5 0             RANGES           CFF007
     E                    AMT         9 13 0             AMOUNTS          CFF007
      *                                                                                       CSD015
      ** Arrays used for Midas Compliance Watch                                               CSD015
      ** XML Opening Tags for the Compliance Engine                                           CSD015
     E                    XOT     1   6 27                                                    CSD015
      *                                                                                       CSD015
      ** XML Closing Tags for the Compliance Engine                                           CSD015
     E                    XCT     1   6 28                                                    CSD015
      *                                                                                       CSD015
      ** Watch List Fields Array                                                              CSD015
     E                    WLF         6 35                                                    CSD015
      *                                                                                       CSD015
     E*
     E********************************************************************
     E/EJECT
     I********************************************************************
      *                                                                                       CRE020
      ** CRE020 System Value Constant                                                         CRE020
      *                                                                                       CRE020
     I              'ExerciseanOption'    C         SYSVAL                                    CRE020
      *                                                                                       CRE020
     IINTYPDF                                                             AUS022
     I*                                                                   AUS022
     I**   Selected Instrument Type details                               AUS022
     I*                                                                   AUS022
     I              CTAM                            FFCTAM                AUS022
     I              CNTT                            FFCNTT                AUS022
     IINTYP2DF
     I*
     I**   Selected Instrument Type details
     I*
     I              RECI                            RECI2
     I              ISTT                            ISTT2
     I              ISTI                            ISTI2
     I              ISPT                            ISPT2
     I              ISCY                            ISCY2
     I              QOTC                            QOTC2
     I              TKDM                            TKDM2
     I              MNPF                            MNPF2
     I              TKVL                            TKVL2
     I              OTHC                            OTHC2
     IACCNTABF                                                            S01117
     I*                                                                   S01117
     I**   Account Master details                                         S01117
     I*                                                                   S01117
     I              PRFC                            PRFCA                 S01117
     I              PTFR                            PTFRA                 059770
     IACNUMABF                                                            059770
     I              PTFR                            PTFRA                 059770
     ICHGCMDF                                                             CAC003
     I              PRFC                            PRFCC                 CAC003
     I*COPY*ZSRSRC,ZDATE3Z2                                               S01195
     I*COPY*ZSRSRC,ZDATE3Z3                                               S01195
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     I*
     I**   Key for Counterparty Nostros Table file
     I*
     IFCNKY       DS                             12
     I                                        1   2 FCNKY1
     I                                        5  12 FCPNS
     I*
     I*****Key*for*Branch*Codes*Table*file********************************S01117
     I***********                                                         S01117
     I*FBKY****** DS                             12                       S01117
     I***********                             1   2 FFBKY1                S01117
     I***********                            10  120FFBRCD                S01117
     I/COPY ZSRSRC,FFSTDPZ2
     I/COPY ZSRSRC,FFSETLZ1
     I*
     I**   Work field Data Structure for Settlement Account (Screen)
     I*
     I***SWSLA**     DS                             12                                        CGL029
     ISWSLA       DS                             18                                           CGL029
     I                                        1   2 WSLA1
     I                                        1   6 WSLA6
     I                                        1  10 WSLA10
     I                                        3  18 WSLA12                                    CGL029
     I                                        7  18 WSLA                                      CGL029
     I                                        7  16 WSLA4                                     CGL029
     I                                       17  18 WSLA2                                     CGL029
     I**********                              3  12 WSLA12                                    CGL029
     I**********                              7  12 WSLA                                      CGL029
     I**********                              7  10 WSLA4                                     CGL029
     I**********                             11  12 WSLA2                                     CGL029
     I*
     I**   Work field Data Structure for Settlement Account (File)
     I*
     I*FSLA****** DS                             12                       S01117
     I***WFSAC**     DS                             15                                 S01117 CGL029
     I**********                              1  12 WFSLA                              S01117 CGL029
     IWFSAC       DS                             21                                           CGL029
     I                                        1  18 WFSLA                                     CGL029
     I**********                              1   60FFCNUM                                    CSD027
     I                                        1   6 FFCNUM                                    CSD027
     I                                        7  160FFACD2                                    CGL029
     I                                       17  180FFACSQ                                    CGL029
     I                                       19  21 FFBRC2                                    CGL029
     I**********                              7  100FFACD2                                    CGL029
     I**********                             11  120FFACSQ                                    CGL029
     I**********                             13  15 FFBRC2                             S01117 CGL029
     I/COPY ZSRSRC,FFDATEZ2
     I**   File Format of Price
     I/COPY ZSRSRC,FFSRDSZ1
     I**   Screen Format of Price
     I**   Minimum Price Fluctuation
     I/COPY ZSRSRC,FFPRCSZ3
     I*
     I**  Key to LF/POSTNC
     I*
     I*PSTNCK**** DS                             30                       CFF004
     I/COPY WNCPYSRC,FF0040I002
     IPSTNCK      DS                             34                       CFF004
     I***********                             1   30KBRCDC                S01117
     I                                        1   3 KBRCAC                S01117
     I**********                              4   90KCBCDC                                    CSD027
     I                                        4   9 KCBCDC                                    CSD027
     I                                       10  14 KISTTC
     I                                       15  160KYRNOC
     I                                       17  180KMTHNC
     I                                       19  19 KPCALC
     I/COPY WNCPYSRC,FF0040I003
     I***********                            20  307KSTRPC                CFF004
     I                                       20  348KSTRPC                CFF004
     I*
     I**  Key to LF/POSTNK
     I*
     I*PSTNKK**** DS                             26                       CFF004
     I/COPY WNCPYSRC,FF0040I004
     IPSTNKK      DS                             30                       CFF004
     I***********                             1   30KBRCDK                S01117
     I                                        1   3 KBRCAK                S01117
     I                                        4   5 KBOKCK
     I                                        6  10 KISTTK
     I                                       11  120KYRNOK
     I                                       13  140KMTHNK
     I                                       15  15 KPCALK
     I/COPY WNCPYSRC,FF0040I005
     I***********                            16  267KSTRPK                CFF004
     I/COPY WNCPYSRC,FF0040I006
     I                                       16  308KSTRPK                CFF004
     I*
     I**   Screen - Action Code / Market Name
     I*
     ISAMKDS      DS                             21
     I                                        1   1 SACTN
     I                                        2  21 SMKTN
     I*
     I**   Main screen details
     I*
     I*MIODS***** DS                            260                       S01117
     I*MIODS***** DS                            266                S01117 S71062
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP1                                           S01408
     I            DS                                                      CFF007
     I**********                              1  15 STTA                               CFF007 CGL029
     I                                        1  21 STTA                                      CGL029
     I                                        1   6 WCNUM                 CFF007
     I                                        7   9 WCCY                  CFF007
     I                                       10  19 WACOD                                     CGL029
     I                                       20  21 WACSQ                                     CGL029
     I**********                             10  13 WACOD                 CFF007       CFF007 CGL029
     I**********                             14  15 WACSQ                 CFF007       CFF007 CGL029
     I*                                                                   S01408
     I*SMIODS**** DS                            270                 S71062CFF004
     I*SMIODS**** DS                            302                 CFF004CFF003
     I***SMIODS*     DS                            308                                 CFF003 CGL029
     ISMIODS      DS                            320                                           CGL029
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP2                                           S01408
     I*                                                                   S01408
     I                                        1   6 STNBR
     I                                        7  12 SCLSR
     I                                       13  14 SMRKT
     I                                       15  17 SISTC
     I                                       18  20 SMTHN
     I                                       21  22 SYRNO
     I                                       23  23 SPCAL
     I/COPY WNCPYSRC,FF0040I007
     I***********                            24  35 SSTRP                 CFF004
     I/COPY WNCPYSRC,FF0040I008
     I*******                                36  36 STRTY                 S71062
     I*******                                37  41 SNUCO                 S71062
     I*******                                42  46 SNOCO                 S71062
     I*******                                47  56 SBOCO                 S71062
     I*******                                47  47 SBOCO1                S71062
     I*******                                48  56 SBOCO9                S71062
     I*******                                57  66 SCUSC                 S71062
     I*******                                67  68 SBOKC                 S71062
     I***********                            69  71 SBRCD                 S01117
     I*******                                69  71 SBRCA     S01117      S71062
     I*******                                72  76 SNCTE                 S71062
     I*******                                77  88 SEXPR                 S71062
     I*******                                89  94 STRSD                 S71062
     I*******                                95 119 STNAR                 S71062
     I*******                               120 123 SBCM                  S71062
     I*******                               120 121 SBCMC                 S71062
     I*******                               122 123 SBCMS                 S71062
     I*******                               124 127 SCCM                  S71062
     I*******                               124 125 SCCMC                 S71062
     I*******                               126 127 SCCMS                 S71062
     I*******                               128 141 SBCMA                 S71062
     I*******                               128 128 SBCMA1                S71062
     I*******                               129 141 SBCMA2                S71062
     I*******                               142 155 SCCMA                 S71062
     I*******                               142 142 SCCMA1                S71062
     I*******                               143 155 SCCMA2                S71062
     I*******                               156 157 SBCHC                 S71062
     I*******                               158 171 SBCHA                 S71062
     I*******                               172 173 SCCHC                 S71062
     I*******                               174 187 SCCHA                 S71062
     I*******                               188 189 SBSLT                 S71062
     I*******                               190 191 SCSLT                 S71062
     I*******                               192 203 SBSLA                 S71062
     I*******                               204 215 SCSLA                 S71062
     I***********                           216 225 SBCPN                 S01117
     I***********                           226 235 SCCPN                 S01117
     I***********                           236 245 SBFAO                 S01117
     I***********                           246 255 SCFAO                 S01117
     I***********                           256 260 SISTT                 S01117
     I*******                               216 218 SBSBR          S01117 S71062
     I*******                               219 221 SCSBR          S01117 S71062
     I*******                               222 231 SBCPN          S01117 S71062
     I*******                               232 241 SCCPN          S01117 S71062
     I*******                               242 251 SBFAO          S01117 S71062
     I*******                               252 261 SCFAO          S01117 S71062
     I*******                               262 266 SISTT          S01117 S71062
     I                                       36  39 SPTFR                 S71062
     I                                       40  40 STRTY                 S71062
     I                                       41  45 SNUCO                 S71062
     I                                       46  50 SNOCO                 S71062
     I                                       51  60 SBOCO                 S71062
     I                                       51  51 SBOCO1                S71062
     I                                       52  60 SBOCO9                S71062
     I                                       61  70 SCUSC                 S71062
     I                                       71  72 SBOKC                 S71062
     I                                       73  75 SBRCA                 S71062
     I                                       76  80 SNCTE                 S71062
     I/COPY WNCPYSRC,FF0040I009
     I***********                            81  92 SEXPR           S71062CFF004
     I/COPY WNCPYSRC,FF0040I010
     I                                       93  98 STRSD                 S71062
     I                                       99 123 STNAR                 S71062
     I                                      124 127 SBCM                  S71062
     I                                      124 125 SBCMC                 S71062
     I                                      126 127 SBCMS                 S71062
     I                                      128 131 SCCM                  S71062
     I                                      128 129 SCCMC                 S71062
     I                                      130 131 SCCMS                 S71062
     I                                      132 145 SBCMA                 S71062
     I                                      132 132 SBCMA1                S71062
     I                                      133 145 SBCMA2                S71062
     I                                      146 159 SCCMA                 S71062
     I                                      146 146 SCCMA1                S71062
     I                                      147 159 SCCMA2                S71062
     I                                      160 161 SBCHC                 S71062
     I                                      162 175 SBCHA                 S71062
     I                                      176 177 SCCHC                 S71062
     I                                      178 191 SCCHA                 S71062
     I                                      192 193 SBSLT                 S71062
     I                                      194 195 SCSLT                 S71062
     I                                      196 213 SBSLA                                     CGL029
     I                                      214 231 SCSLA                                     CGL029
     I                                      232 234 SBSBR                                     CGL029
     I                                      235 237 SCSBR                                     CGL029
     I                                      238 247 SBCPN                                     CGL029
     I                                      248 257 SCCPN                                     CGL029
     I                                      258 267 SBFAO                                     CGL029
     I                                      268 277 SCFAO                                     CGL029
     I                                      278 282 SISTT                                     CGL029
     I                                      283 298 SSTRP                                     CGL029
     I                                      299 314 SEXPR                                     CGL029
     I                                      315 320 SVALD                                     CGL029
     I**********                            196 207 SBSLA                              S71062 CGL029
     I**********                            208 219 SCSLA                              S71062 CGL029
     I**********                            220 222 SBSBR                              S71062 CGL029
     I**********                            223 225 SCSBR                              S71062 CGL029
     I**********                            226 235 SBCPN                              S71062 CGL029
     I**********                            236 245 SCCPN                              S71062 CGL029
     I**********                            246 255 SBFAO                              S71062 CGL029
     I**********                            256 265 SCFAO                              S71062 CGL029
     I**********                            266 270 SISTT                              S71062 CGL029
     I**********                            271 286 SSTRP                              CFF004 CGL029
     I**********                            287 302 SEXPR                              CFF004 CGL029
     I**********                            303 308 SVALD                              CFF003 CGL029
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP3                                           S01408
     I*                                                                   S01408
     I*
     I**   Display Error Codes/Messages
     I*
     IERRDS       DS                            160
     I                                        1 160 ERR
     I                                        1  77 SERCD1
     I                                       77 153 SERCD2
     I*
     I**   Program Status data structure
     I*
     IPSDS       SDS
     I/COPY WNCPYSRC,FF0040I013
     I                                      244 246 WSID
     I                                      245 246 WSID2
     I                                      254 263 USRID
     I*
     I**   Key for ICD records
     I*
     IICDK        DS                             12
     I                                        1   2 KICD1
     I                                       11  12 KICD2
     I*
     I**  Key to LF/INTYP. Also, to redefine Instrument Type into
     I**  Market Centre and Instrument Code.
     I*
     IISTTK       DS                              5
     I                                        1   5 KISTT
     I                                        1   2 KMRKT
     I                                        3   5 KISTC
     I*
     I**   Local Data Area for Database Error Details
     I*
     ILDA         DS                            256
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
     I                                      134 141 DBFILE                S01117
     I/COPY WNCPYSRC,FF0040I011
     I***********                           142 170 DBKEY           S01117CFF004
     I***********                           171 180 DBPGM           S01117CFF004
     I***********                           181 1830DBASE           S01117CFF004
     I/COPY WNCPYSRC,FF0040I012
     I**********                            142 175 DBKEY          CFF004 CFF007
     I**********                            176 185 DBPGM          CFF004 CFF007
     I**********                            186 1880DBASE          CFF004 CFF007
     I                                      142 170 DBKEY                 CFF007
     I                                      171 180 DBPGM                 CFF007
     I                                      181 1830DBASE                 CFF007
     I*    DTAARA/MNATN
     I/COPY ZSRSRC,ZTNLU1Z1
     I*
     I**  Next available Close-out Number
     I*
     INACON       DS                              6
     I                                        1   60NCON
     I*
     I**   For File Exception/Error Handling on LF/TRANS
     I*
     IINFDS       DS
     I                                     *STATUS  STATUS
     I*
     I**   To provide Text on COMIT Entry in journal
     I*
     I*MTTXT***** DS                            332                       S01117
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP4                                           S01408
     I*                                                                   S01408
     I*CMTTXT**** DS                            338                 S01117CFF004
     I*CMTTXT**** DS                            373                 CFF004CFF003
     I***CMTTXT*     DS                            379                                 CFF003 CGL029
     ICMTTXT      DS                            391                                           CGL029
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP5                                           S01408
     I*                                                                   S01408
     I                                        1   50NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  25 SACTNX
     I                                       26  35 USRIDX
     I                                       51  71 SAMK
     I                                       72 327 SMIOL
     I***********                           328 331 SMIOR                 S01117
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP6                                           S01408
     I*                                                                   S01408
     I***********                           328 337 SMIOR           S01117CFF004
     I***********                           328 373 SMIOR           CFF004CFF003
     I**********                            328 379 SMIOR                              CFF003 CGL029
     I                                      328 391 SMIOR                                     CGL029
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP7                                           S01408
     I*                                                                   S01408
      *                                                                   S01117
     ISDBANK    E DSSDBANKPD                                              S01117
      **  EXTERNAL DS FOR BANK DETAILS                                    S01117
     I              BJLCCY                          LOCY                  S01195
     I              BJBVPD                          BVLP                  S01117
      *                                                                   S01117
     ISDGELR    E DSSDGELRPD                                              S01117
      **  EXTERNAL DS FOR GENERAL LEDGER DETAILS                          S01117
      *                                                                   S01117
     ISDBRCH    E DSSDBRCHPD                                              S01117
      **  EXTERNAL DS FOR BRANCHES DETAILS                                S01117
      *                                                                   S01117
     ISDBOOK    E DSSDBOOKPD                                              S01117
      **  EXTERNAL DS FOR BOOK CODES DETAILS                              S01117
      *                                                                   S01117
     ISDCUST    E DSSDCUSTPD                                              S01117
      **  EXTERNAL DS FOR CLIENT DETAILS                                  S01117
     I              BBCUST                          CNUMS                 S01117
     I              QQDFAC                          QQDFA1                                    CGL029
      *                                                                                       CSD015
      ** Watch List Transaction Details                                                       CSD015
     ISDWLTO    E DSSDWLTOPD                                                                  CSD015
      *                                                                                       CSD015
      ** Watch List Checking Details                                                          CSD015
     ISDWLCC    E DSSDWLCCPD                                                                  CSD015
      *                                                                                       CSD015
      ** SD data area                                                                         CSD015
     ISDSTAT    E DSSDSTAT                                                                    CSD015
      *                                                                                       CSD015
      ** 24X7 status data area                                                                CSD015
     ISC24X7    E DSSC24X7                                                                    CSD015
      *                                                                                       CSD015
      ** Compliance Watch Configuration Data File                                             CSD015
     ISDCWCD    E DSSDCWCDPD                                                                  CSD015
      *                                                                                       CSD015
      ** DS for 2nd parameter of Compliance Engine                                            CSD015
     IPXML        DS                           9999                                           CSD015
      *                                                                                       CSD015
     ISDPORT    E DSSDPORTPD                                              S71062
     I**  EXTERNAL DS for Portfolio ICD                                   S71062
     ISDMMOD    E DSSDMMODPD                                              S71062
     I**  EXTERNAL DS for Portfolio ICD                                   S71062
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIPG                                           S01408
     ISDFOCS    E DSSDFOCSPD                                              CFF007
      ** FF Customer/Broker Details                                       CFF007
     ISDNOST    E DSSDNOSTPD                                              CFF007
      ** Nostro details                                                   CFF007
     I              QQACCD                          QQACC1                                    CGL029
      *                                                                                       CGL029
     ISDACOD    E DSSDACODPD                                                                  CGL029
      ** Account Code Details                                                                 CGL029
     I              QQACCD                          QQACC2                                    CGL029
      *                                                                                       CGL029
     ISCSARD    E DSSCSARDPD                                              CFF007
      ** External DS for SAR Details                                      CFF007
     I*                                                                   S01408
      *                                                                   S01117
     I@DSFDY    E DSDSFDY                                                 S01117
      **  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE              S01117
     IDSLDY     E DSDSLDY                                                 CFF007
      ** DS for access programs, very long data structure                 CFF007
      *                                                                   S01117
     I/COPY ZSRSRC,ZHOLDS                                                 S01195
     I********************************************************************
     I/EJECT
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I/COPY ZSRSRC,ZYLDZ1                                                 AUS022
     I*                                                                   S01408
     I/COPY WNCPYSRC,FF0040IIP8                                           S01408
      *                                                                   CFF007
     IWRNG        DS                             45                       CFF007
      ** Data structure to store all chrg/coms lower range limit          CFF007
     I                                        1  450RNG                   CFF007
     I                                        1   50LR01                  CFF007
     I                                        6  100LR02                  CFF007
     I                                       11  150LR03                  CFF007
     I                                       16  200LR04                  CFF007
     I                                       21  250LR05                  CFF007
     I                                       26  300LR06                  CFF007
     I                                       31  350LR07                  CFF007
     I                                       36  400LR08                  CFF007
     I                                       41  450LR09                  CFF007
      *                                                                   CFF007
     IWAMT        DS                            117                       CFF007
      ** Data structure to store all chrg/coms amount                     CFF007
     I                                        1 1170AMT                   CFF007
     I                                        1  130CA01                  CFF007
     I                                       14  260CA02                  CFF007
     I                                       27  390CA03                  CFF007
     I                                       40  520CA04                  CFF007
     I                                       53  650CA05                  CFF007
     I                                       66  780CA06                  CFF007
     I                                       79  910CA07                  CFF007
     I                                       92 1040CA08                  CFF007
     I                                      105 1170CA09                  CFF007
     I*                                                                   S01408
     C********************************************************************
     C*                                                                  *
     C**      K   E   Y        L   I   S   T   S                         *
     C*                                                                  *
     C********************************************************************
     C*
     C**   LF/DEFLT
     C*
     C           KDEFLT    KLIST
     C**********           KFLD           KCBCD   60                                          CSD027
     C                     KFLD           KCBCD   6                                           CSD027
     C                     KFLD           KMRKT   2
     C                     KFLD           KISTC   3
     C*
     C**   LF/CHGCM
     C*
     C           KCHGCM    KLIST
     C                     KFLD           KCCY    3
     C                     KFLD           KCGCM   20
     C*
     C**   LF/CLINT
     C*
     C           KCLINT    KLIST
     C**********           KFLD           KCNUM   60                                          CSD027
     C                     KFLD           KCNUM   6                                           CSD027
     C                     KFLD           KRCDT   1
     C*
     I/COPY ZSRSRC,FFSETLZ2
      *                                                                                       CGL029
     C*
     C**   LF/CLOST2
     C*
     C           KCLST2    KLIST
     C                     KFLD           KTNBR   60
     C                     KFLD           KCLON   60
     C*                                                                   S01117
     C**   LF/MEMOSM                                                      S01117
     C*                                                                   S01117
     C           KMEMOS    KLIST                                          S01117
     C                     KFLD           FFBRCB                          S01117
     C                     KFLD           FFCNUM                          S01117
     C                     KFLD           FFCCY                           S01117
     C                     KFLD           FFACOD                          S01117
     C                     KFLD           FFACSQ                          S01117
     C*
     C**   LF/PRONOM
     C*
     C           KPRONO    KLIST
     C                     KFLD           KCCY
     C                     KFLD           KNOSNP  20
     C*
     C**   LF/POSTNC
     C*
     C           KPSTNC    KLIST
     C***********          KFLD           KBRCDC  30                      S01117
     C                     KFLD           KBRCAC  3                       S01117
     C**********           KFLD           KCBCDC  60                                          CSD027
     C                     KFLD           KCBCDC  6                                           CSD027
     C                     KFLD           KISTTC  5
     C                     KFLD           KYRNOC  20
     C                     KFLD           KMTHNC  20
     C                     KFLD           KPCALC  1
     C/COPY WNCPYSRC,FF0040C001
     C***********          KFLD           KSTRPC 117                      CFF004
     C/COPY WNCPYSRC,FF0040C002
     C                     KFLD           KSTRPC                          CFF004
     C*
     C**   LF/POSTNK
     C*
     C           KPSTNK    KLIST
     C***********          KFLD           KBRCDK  30                      S01117
     C                     KFLD           KBRCAK  3                       S01117
     C                     KFLD           KBOKCK  2
     C                     KFLD           KISTTK  5
     C                     KFLD           KYRNOK  20
     C                     KFLD           KMTHNK  20
     C                     KFLD           KPCALK  1
     C/COPY WNCPYSRC,FF0040C003
     C***********          KFLD           KSTRPK 117                      CFF004
     C                     KFLD           KSTRPK                          CFF004
      *                                                                                       CSD015
      **   Key List for LF/SDCWHTL1                                                           CSD015
      *                                                                                       CSD015
     C           KCWHTL    KLIST                                                              CSD015
     C                     KFLD           KFUNT   8                                           CSD015
     C                     KFLD           KIDEN  40                                           CSD015
     C                     KFLD           KBRCH   3                                           CSD015
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP1                                           S01408
     C*                                                                   S01408
     C*
     C********************************************************************
     C**                                                                 *
     C**      M  A  I  N     P  R  O  C  E  S  S  I  N  G                *
     C**                                                                 *
     C********************************************************************
     C*
     C**   Receive/Pass  Parameters
     C*
     C           *ENTRY    PLIST
     C                     PARM           PACTN   1
     C                     PARM           PMRKT   2
     C                     PARM           PMKTN  20
     C                     PARM           PRUNA   7
     C                     PARM           PRUND   50
     C                     PARM           PDATF   1
     C                     PARM           PMBIN   1                       S01117
     C                     PARM           PBUSD   50
     C                     PARM           PMKLC   3
     C                     PARM           PMLOC   3                       S01195
     C*
     C**   Open the overridden files.
     C*
     C                     OPEN TRANS
     C                     OPEN TRSET
     C                     OPEN TRANSIN
     C                     OPEN TRSETIN
     C                     OPEN MEMOSM
     C                     OPEN PRONOM
     C                     OPEN FFACMVD                                   S01240
     C                     OPEN POSTNC
     C                     OPEN POSTNK
     C                     OPEN CLOST
     C                     OPEN CLOST2
     C                     OPEN TRANSA
     C*                                                                   S01457
      *** Check the switchable features file to see if S01457 is on.      S01457
      *                                                                   S01457
     C                     MOVE *BLANKS   S0CUST  8                       S01457
     C                     MOVE *BLANKS   S1CUST 12                       S01457
     C                     CALL 'AOSARDR0'                                S01457
     C                     PARM '       ' @RTCD   7                       S01457
     C                     PARM '*VERIFY' @OPTN   7                       S01457
     C                     PARM 'S01457 ' @SARD   6                       S01457
      *                                                                   S01457
     C           @RTCD     IFEQ *BLANKS                                   S01457
     C                     MOVEL'C''   '  S0CUST                          S01457
     C                     MOVE 'party '  S0CUST                          S01457
     C                     MOVEL'COUNTER' S1CUST                          S01457
     C                     MOVE 'PARTY'   S1CUST                          S01457
     C                     ELSE                                           S01457
     C                     MOVEL'Cust'    S0CUST                          S01457
     C                     MOVE 'omer'    S0CUST                          S01457
     C                     MOVEL'CUSTO'   S1CUST                          S01457
     C                     MOVE 'MER    ' S1CUST                          S01457
     C                     ENDIF                                          S01457
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP2                                           S01408
     C*                                                                   S01408
      *                                                                   S01457
     C*                                                                   CFF003
     C** Check switchable features file to see if Enhanced OTC            CFF003
     C** Processing (Phase II) CFF003 is on.                              CFF003
     C*                                                                   CFF003
     C                     CALL 'AOSARDR0'                                CFF003
     C                     PARM '       ' @RTCD                           CFF003
     C                     PARM '*VERIFY' @OPTN                           CFF003
     C                     PARM 'CFF003'  @SARD                           CFF003
     C           @RTCD     IFNE *BLANK                                    CFF003
     C           @RTCD     ANDNE'*NRF   '                                 CFF003
     C           *LOCK     IN   LDA                                       CFF003
     C                     Z-ADD32        DBASE                           CFF003
     C                     MOVE 'SCSARDPD'DBFILE                          CFF003
     C                     MOVEL@OPTN     DBKEY                           CFF003
     C                     MOVEL@OPTN     DBOPTN                          CFF003
     C                     EXSR DBERR                                     CFF003
     C                     ENDIF                                          CFF003
     C           @RTCD     IFEQ *BLANK                                    CFF003
     C                     MOVEL'Y'       CFF003  1                       CFF003
     C                     MOVE *ON       *IN29                           CFF003
     C                     ELSE                                           CFF003
     C                     MOVEL'N'       CFF003                          CFF003
     C                     MOVE *OFF      *IN29                           CFF003
     C                     ENDIF                                          CFF003
     C*                                                                   CFF003
      ** Check if Online Printing of Advices (GE7) is on                                      CRE020
      *                                                                                       CRE020
     C                     MOVE 'N'       CRE020  1                                           CRE020
     C                     CALL 'AOSARDR0'                                                    CRE020
     C                     PARM *BLANKS   PRTCD                                               CRE020
     C                     PARM '*VERIFY' POPTN                                               CRE020
     C                     PARM 'CRE020'  PSARD                                               CRE020
     C           SCSARD    PARM SCSARD    @DSFDY                                              CRE020
      *                                                                                       CRE020
     C           PRTCD     IFEQ *BLANKS                                                       CRE020
     C                     MOVE 'Y'       CRE020                                              CRE020
     C                     MOVEL'FFC1001' RPRGMN                                              CRE020
     C                     MOVELRPRGMN    KPRGMN                                              CRE020
      *                                                                                       CRE020
      ** Call AOSVALR0 to check system values                                                 CRE020
      *                                                                                       CRE020
     C                     MOVELSYSVAL    PSVOPT 20                                           CRE020
      *                                                                                       CRE020
     C                     MOVE *BLANKS   PBLNK1 20                                           CRE020
     C                     MOVE *BLANKS   PBLNK2200                                           CRE020
      *                                                                                       CRE020
     C                     CALL 'AOSVALR0'                                                    CRE020
     C                     PARM *BLANKS   @RTCD                                               CRE020
     C                     PARM           PSVOPT                                              CRE020
     C                     PARM           PSVAL 200                                           CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
     C                     PARM           PBLNK1                                              CRE020
     C                     PARM           PBLNK2                                              CRE020
      *                                                                                       CRE020
     C           @RTCD     IFNE '*NRF   '                                                     CRE020
     C           @RTCD     ANDNE*BLANKS                                                       CRE020
     C           *LOCK     IN   LDA                                                           CRE020
     C                     Z-ADD34        DBASE                                               CRE020
     C                     MOVEL'FF0040'  DBPGM                                               CRE020
     C                     MOVEL'SDSVALPD'DBFILE                                              CRE020
     C                     MOVELPSVOPT    DBKEY                                               CRE020
     C                     OUT  LDA                                                           CRE020
     C                     MOVE *ON       *INU7                                               CRE020
     C                     MOVE *ON       *INU8                                               CRE020
     C                     MOVE *ON       *INLR                                               CRE020
     C                     DUMP                                                               CRE020
     C                     RETRN                                                              CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
     C                     ELSE                                                               CRE020
      *                                                                                       CRE020
     C           PRTCD     IFNE '*NRF   '                                                     CRE020
     C           *LOCK     IN   LDA                                                           CRE020
     C                     Z-ADD33        DBASE                                               CRE020
     C                     MOVEL'FF0040'  DBPGM                                               CRE020
     C                     MOVEL'SCSARDPD'DBFILE                                              CRE020
     C                     MOVEL'CRE020'  DBKEY                                               CRE020
     C                     OUT  LDA                                                           CRE020
     C                     MOVE *ON       *INU7                                               CRE020
     C                     MOVE *ON       *INU8                                               CRE020
     C                     MOVE *ON       *INLR                                               CRE020
     C                     DUMP                                                               CRE020
     C                     RETRN                                                              CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
      ** Key List for Midas RE Settled Transaction Index File                                 CRE020
      *                                                                                       CRE020
     C           KADVC     KLIST                                                              CRE020
     C                     KFLD           KREFNO 30                                           CRE020
     C                     KFLD           KPRGMN 10                                           CRE020
     C*
     C**   Initial Processing
     C*
     C                     EXSR INITL
     C*
     C**   Select screen to process, - Insert
     C*
     C           PACTN     IFEQ 'I'
     C                     EXSR INSCTL
     C*
     C**   Amend, Delete or Enquire
     C*
     C                     ELSE
     C                     EXSR ADECTL
     C                     END
     C*
     C**   If F9 taken, blank out screen fields and also the              E17745
     C**   action code parameter (used in FFC0211).
     C*
     C************INKL     IFEQ '1'                                       E17745
     C           *INKI     IFEQ '1'                                       E17745
     C                     MOVE *BLANKS   PACTN
     C                     MOVE *BLANKS   SACTN
     C                     MOVE *BLANKS   SMRKT
     C                     MOVE *BLANKS   SMIODS
     C*
     C**   Close the overridden files.
     C*
     C                     CLOSETABFF
     C                     CLOSETRANS
     C                     CLOSETRSET
     C                     CLOSETRANSIN
     C                     CLOSETRSETIN
     C                     CLOSEMEMOSM
     C                     CLOSEPRONOM
     C                     CLOSEFFACMVD                                   S01240
     C                     CLOSEPOSTNC
     C                     CLOSEPOSTNK
     C                     CLOSECLOST
     C                     CLOSECLOST2
     C                     CLOSETRANSA
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP3                                           S01408
     C*                                                                   S01408
     C*
     C**   Write Initial screen (to be processed by FF0030)
     C*
     C                     SETON                     07
     C                     SETOF                     182238
     C                     WRITEFF0030F1
     C                     SETOF                     07
     C*
     C**   Otherwise (ie: F3 taken), Set on LR and end program
     C*
     C                     ELSE
     C                     SETON                     LR
     C                     END
     C                     RETRN
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*       S   U   B   R   O   U   T   I   N   E   S                  *
     C*                                                                  *
     C********************************************************************
     C*
     C*                  SUMMARY  OF  SUBROUTINES
     C*                 **************************
     C*
     C*     INITL       Initial Processing  (inc. ICD access)
     C*     DBERR       Database Error Handling : Terminates program
     C*     INFSR       File Exception/Error Handling : Cancels program
     C*
     C*     INSCTL      Insert secondary screen control
     C*     INSDET      Insert detail screen control
     C*     INSMKI      Insert Market Instrument details processing
     C*     INSOTC      Insert Over the counter details processing
     C*
     C*     ADECTL      Amd/Del/Enq Secondary screen control
     C*     ADEMKI      Amd/Del/Enq Market Instrument details processing
     C*     ADEOTC      Amd/Del/Enq Over the counter details processing
     C*
     C*     SCRNF2      To Write/Read Insert secondary screen
     C*                  + handle 'Help'
     C*     SCRNF3      To Write/Read Amd/Del/Enq secondary screen
     C*                  handle 'Help'
     C*     SCRNF4      To Write/Read Market Instrument details screen
     C*                  + handle 'Help'
     C*     SCRNF5      To Write/Read Over the counter details screen
     C*                  + handle 'Help'
     C*     SCRNF6      To Write/Read 'Record updated by another
     C*                  workstation screen' + handle 'Help'
     C*
     C*     BRDFLT      Initialise Broker Settlement Defaults (Insert)
     C*     CUDFLT      Initialise Customer Settlement Defaults (Insert)
     C*
     C*     MKIINT      Initialise Mkt Inst. detail screen fields
     C*     MADEIN      Initialise Mkt Inst. detail screen fields (A/D/E)
     C*     OTCINT      Initialise O.T.C. detail screen fields
     C*     OADEIN      Initialise O.T.C. detail screen fields (A/D/E)
     C*
     C*     INSVL1      Validate Insert secondary screen
     C*     ADEVL1      Validate Amd/Del/Enq secondary screen
     C*     INSVL2      Validate Insert main detail screen
     C*     CUSTVL      Validate Customer Settlement instructions
     C*     BROKVL      Validate Broker Settlement instructions
     C*     SLTVL       Validate Settlement type
     C*     SLAVL       Validate Settlement account
     C*     FAOVL       Validate 'For Account of'
     C*     CPNVL       Validate Counterparty Nostro
     C*
     C*     UPDINS      Insert update control
     C*     UPDAMD      Amend update control
     C*     UPDDEL      Delete update control
     C*     ICOMIT      Initialise CMTTXT
     C*     WTRANS      Write record to LF/TRANS
     C*     WTRSET      Write record to LF/TRSET
     C*     UTRANS      Update LF/TRANS Exercise record
     C*     UTRSET      Update LF/TRSET Exercise record
     C*     ABRCPT      Access Broker settlement defaults for amend
     C*     ACUCPT      Access Customer settlement defaults for amend
     C*     UTTRAN      Update LF/TRANS Trade record
     C*     UTTRST      Update LF/TRSET Trade record
     C*     WCLST       Write record to LF/CLOST
     C*     WCLST2      Write records to LF/CLOST2
     C*     UCLST       Update record in LF/CLOST
     C*     UAMEMS      Write/Update record in LF/MEMOSM - apply
     C*     URMEMS      Write/Update record in LF/MEMOSM - reverse out
     C*     UAPRON      Write/Update record in LF/PRONOM - apply
     C*     URPRON      Write/Update record in LF/PRONOM - reverse out
     C*     WACMVD      Write record to PF/FFACMVD                        S01240
     C*     UPSTNC      Update LF/POSTNC record (Customer)
     C*     UPSTNB      Update LF/POSTNC record (Broker)
     C*     UPSTNK      Update LF/POSTNK record (Book)
     C*     UTRNSA      Update PF/TRANSA
     C*     RUDBAW      Record Updated by another workstation
     C*
     C*     FFPMCL      Calculate Premium Paid
     C*     FFPLCL      Calculate Profit/Loss
     C*     FFTVCL      Calculate Transaction Value
     C*     FFSTDP      Calculate currency decimal places
     C*     FFPRCS      Format Prices for screen display
     C*     FFDATE etc  Convert date formula to a MIDAS day number
     C*     ZDATE1      Validate a Date and convert to MIDAS day number
     C*     ZDATE2      Convert MIDAS day number to a date
     C******ZDATE3******Discover*next*working*day*************************S01195
     C******ZDATE5******Check*if*a*given*day*is*a*holiday*****************S01195
     C*     ZACCH       Access the holiday file                           S01195
     C*     ZFWDT       Determine the nth working day forward from        S01195
     C*                 the given date                                    S01195
     C*     ZBKDT       Determine the nth working day back from the       S01195
     C*                 given date                                        S01195
     C*     ZCHKH       Determine if the given date is a holiday          S01195
     C*     ZEDIT       Format amounts for output
     C*     ZALIGN      Validate and Right-align numeric fields
     C*     ZTNLU1      Discover Transaction Number of Last Update
      *                                                                                       CSD015
      *     SRWTCH      Sends transaction details to compliance engine                        CSD015
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INITL SR. -  Initial Processing, including                    *
     C**   ~~~~~~~~~      access 'Installation Control Data' Records     *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       Main Processing              SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           INITL     BEGSR                           ** INITL SR  **
     C*
     C**   Reset LDA
     C*
     C           *NAMVAR   DEFN           LDA
     C           *NAMVAR   DEFN           NACON
     C           *LOCK     IN   LDA
     C***********          MOVE *BLANKS   DBLOT                           S01117
     C                     MOVE *BLANKS   DBFILE                          S01117
     C                     MOVE *BLANKS   DBKEY                           S01117
     C                     MOVE *BLANKS   DBPGM                           S01117
     C                     Z-ADD*ZEROS    DBASE                           S01117
     C                     MOVE 'FF0040  'DBPGM
     C                     OUT  LDA
     C*
     C*****NB.*TABTB10*data*is*passed*in*as*parameters********************S01117
     C**   NB. RUNDAT data is passed in as parameters                     S01117
     C*
     C           PDATF     COMP 'M'                      98
     C           PMBIN     IFNE 'Y'                                       S01117
     C                     SETON                         64               S01117
     C                     END                                            S01117
     C*
     C*****Read*TABTB11*record********************************************S01117
     C*
     C                     OPEN TABFF
     C***********          READ TABTB11F                 70               S01117
     C**N70******RECI      COMP 'D'                  7070                 S01117
     C***********                                                         S01117
     C************IN70     IFEQ '0'                                       S01117
     C***********MBIN      COMP 'N'                      64               S01117
     C***********                                                         S01117
     C***********          ELSE                                           S01117
     C************LOCK     IN   LDA                                       S01117
     C***********          MOVE '01'      DBASE            ***************S01117
     C***********          MOVE 'TABFF'   DBFILE           * DB ERROR 01 *S01117
     C***********          MOVE '01'      KICD1            ***************S01117
     C***********          MOVE '11'      KICD2                           S01117
     C***********          MOVELICDK      DBKEY                           S01117
     C***********          EXSR DBERR                                     S01117
     C***********          END                                            S01117
     C*                                                                   S01117
     C**   ACCESS BANK DETAILS                                            S01117
     C*                                                                   S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    @DSFDY                          S01117
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBANKPD'DBFILE                          S01117
     C                     MOVEL@OPTN     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7        * DB ERROR 01 *S01117
     C                     Z-ADD1         DBASE            ***************S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C**   ACCESS GENERAL LEDGER DETAILS                                  S01117
     C*                                                                   S01117
     C**********           CALL 'AOGELRR0'                                             S01117 CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C********** SDGELR    PARM SDGELR    @DSFDY                                       S01117 CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDGELRPD'DBFILE                          S01117
     C                     MOVEL@OPTN     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7        * DB ERROR 31 *S01117
     C                     Z-ADD31        DBASE            ***************S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C*
     C**   Read TABTB20 record
     C*
     C                     READ TABTB20F                 70
     C  N70      RECI      COMP 'D'                  7070
     C*
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '02'      DBASE            ***************S01117
     C                     Z-ADD2         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 02 *
     C                     MOVE '01'      KICD1            ***************
     C                     MOVE '20'      KICD2
     C                     MOVELICDK      DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C**   Read TABTB40 record
     C*
     C                     READ TABTB40F                 70
     C  N70      RECI      COMP 'D'                  7070
     C*
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '03'      DBASE            ***************S01117
     C                     Z-ADD3         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 03 *
     C                     MOVE '01'      KICD1            ***************
     C                     MOVE '40'      KICD2
     C                     MOVELICDK      DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C**   Read TABTB80 record (Financial Futures + Options ICD)
     C*
     C                     READ TABTB80F                 70
     C  N70      RECI      COMP 'D'                  7070
     C*
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '04'      DBASE            ***************S01117
     C                     Z-ADD4         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 04 *
     C                     MOVE '01'      KICD1            ***************
     C                     MOVE '80'      KICD2
     C                     MOVELICDK      DBKEY
     C                     EXSR DBERR
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP4                                           S01408
     C*                                                                   S01408
     C*
     C**   Set Up Processing
     C**
     C**   Determine Current Trading Date
     C**
     C**   - Mkt Instr (= Market Business date)
     C*
     C           PMRKT     IFNE '  '
     C                     Z-ADDPBUSD     CTDATE  50
     C*
     C**   - O.T.C. (= Run date)
     C*
     C                     ELSE
     C                     Z-ADDPRUND     CTDATE
     C                     END
     C*
     C**   Determine start of Historical Data Period
     C*
     C           CTDATE    SUB  HISP      STHDP   50
     C*
     C**   Screen fields (constant)
     C*
     C                     MOVE PACTN     SACTN
     C                     MOVE PMRKT     SMRKT
     C                     MOVE PMKTN     SMKTN
     C                     MOVE PRUNA     SRUNA
     C                     MOVE WSID      SWSID
     C*
     C**   - Action Code inds
     C*
     C           PACTN     COMP 'I'                      02
     C           PACTN     COMP 'A'                      03
     C           PACTN     COMP 'D'                      04
     C           PACTN     COMP 'E'                      05
     C                     SETOF                     13
     C*
     C**   - TESTN work fields
     C*
     C                     MOVE *BLANK    WTSTN7  7
     C                     MOVE '0'       WTSTN7
     C*
     C**   Initialise broker shortname needed and customer
     C**   shortname needed flags
     C                     Z-ADD0         BSNAME  10
     C                     Z-ADD0         CSNAME  10
     C/COPY ZSRSRC,FFSTDPZ3
     C                     MOVEA*BLANKS   FCY
     C*
     C**   - Constant Table file key fields
     C*
     C***********          MOVE '10'      FFBKY1                          S01117
     C                     MOVE '71'      FCNKY1
     C/COPY ZSRSRC,FFSETLZ3
     C*
     C**   Access SDMMODPD to verify if Portfolio Management is present   S71062
     C*                                                                   S71062
     C                     CALL 'AOMMODR0'                                S71062
     C                     PARM *BLANKS   @RTCD   7                       CPM003
     C                     PARM '*FIRST ' @OPTN   7                       CPM003
     C           SDMMOD    PARM SDMMOD    @DSFDY                          CPM003
     C           @RTCD     IFNE *BLANKS                                   CPM003
     C           *LOCK     IN   LDA                                       S71062
     C                     Z-ADD31        DBASE            ***************S71062
     C                     MOVE 'SDMMODPD'DBFILE           * DB ERROR 31 *S71062
     C                     MOVE *BLANKS   DBKEY            ***************S71062
     C                     OUT  LDA                                       S71062
     C                     EXSR DBERR                                     S71062
     C                     END                                            S71062
     C*                                                                   CPB001
     C           BGN4ST    IFEQ 'Y'                                       CPB001
     C                     MOVE *ON       *IN23                           CPB001
     C                     ENDIF                                          CPB001
     C*                                                                   S71062
     C**   If Portfolio Management is present, access Portfolio ICD to    S71062
     C**   retrieve "the reference attached to 9997 portfolio"            S71062
     C*                                                                   S71062
     C           BGPFMG    IFEQ 'Y'                                       S71062
     C*                                                                   S71062
     C**   Display narrative on screen                                    S71062
     C                     MOVE *ON       *IN23                           S71062
     C                     CALL 'AOPORTR0'                                CPM003
     C                     PARM *BLANKS   @RTCD                           CPM003
     C                     PARM '*FIRST ' @OPTN                           CPM003
     C           SDPORT    PARM SDPORT    @DSFDY                          CPM003
     C           @RTCD     IFNE *BLANKS                                   CPM003
     C           *LOCK     IN   LDA                                       S71062
     C                     Z-ADD32        DBASE            ***************S71062
     C                     MOVE 'SDPORTPD'DBFILE           * DB ERROR 32 *S71062
     C                     MOVE *BLANKS   DBKEY            ***************S71062
     C                     OUT  LDA                                       S71062
     C                     EXSR DBERR                                     S71062
     C                     END                                            S71062
     C*                                                                   S71062
     C                     END                                            S71062
     C*                                                                   S71062
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCPG                                           S01408
     C*                                                                   S01408
      ** Check if switchable feature CFF007 is installed                  CFF007
      *                                                                   CFF007
     C                     CALL 'AOSARDR0'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*VERIFY' POPTN                           CFF007
     C                     PARM 'CFF007'  PSARD   6                       CFF007
     C           SCSARD    PARM SCSARD    @DSFDY                          CFF007
      *                                                                   CFF007
     C           PRTCD     IFEQ *BLANKS                                   CFF007
     C                     MOVE 'Y'       CFF007  1                       CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CFF007                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                                       CSD015
      ** Define dataara SDSTAT and SC24X7                                                     CSD015
      *                                                                                       CSD015
     C           *NAMVAR   DEFN           SC24X7                                              CSD015
     C           *NAMVAR   DEFN           SDSTAT                                              CSD015
     C                     IN   SDSTAT                                                        CSD015
      *                                                                                       CSD015
      ** Check if 24x7 Midas Availability is installed                                        CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*VERIFY' @OPTN                                               CSD015
     C                     PARM 'CSC011'  @SARD                                               CSD015
     C           SCSARD    PARM SCSARD    @DSFDY                                              CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           @RTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE 'SCSARDPD'DBFILE                                              CSD015
     C                     MOVE 'CSC011'  DBKEY                                               CSD015
     C                     Z-ADD40        DBASE                                               CSD015
     C                     EXSR DBERR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           @RTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSC011  1                                           CSD015
     C                     IN   SC24X7                                                        CSD015
     C                     ELSE                                                               CSD015
     C                     MOVE 'N'       CSC011                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if Compliance Watch Enhancement (CSD015) is installed                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*VERIFY' @OPTN                                               CSD015
     C                     PARM 'CSD015'  @SARD                                               CSD015
     C           SCSARD    PARM SCSARD    @DSFDY                                              CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           @RTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE 'SCSARDPD'DBFILE                                              CSD015
     C                     MOVE 'CSD015'  DBKEY                                               CSD015
     C                     Z-ADD41        DBASE                                               CSD015
     C                     EXSR DBERR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           @RTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSD015  1                                           CSD015
     C                     ELSE                                                               CSD015
     C                     MOVE 'N'       CSD015                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if switchable feature CCF001 is installed                                      CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*VERIFY' @OPTN                                               CSD015
     C                     PARM 'CCF001'  @SARD                                               CSD015
     C           SCSARD    PARM SCSARD    @DSFDY                                              CSD015
      *                                                                                       CSD015
      ** If return code not blank or *NRF, then issue database error.                         CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           @RTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE 'SCSARDPD'DBFILE                                              CSD015
     C                     MOVE 'CCF001'  DBKEY                                               CSD015
     C                     Z-ADD44        DBASE                                               CSD015
     C                     EXSR DBERR                                                         CSD015
     C                     END                                                                CSD015
      *                                                                                       CSD015
     C           @RTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CCF001  1                                           CSD015
     C                     ELSE                                                               CSD015
     C                     MOVE 'N'       CCF001                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if function code is being monitored by compliance watch                        CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C                     CALL 'AOWLCCR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*KEY   ' @OPTN                                               CSD015
     C                     PARM 'FUTURES 'PFUNC   8                                           CSD015
     C           SDWLCC    PARM SDWLCC    @DSFDY                                              CSD015
      *                                                                                       CSD015
      ** If return code not blank or *NRF, then issue database error                          CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           @RTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE 'FUTURES 'DBKEY                                               CSD015
     C                     MOVE 'SCWLCCPD'DBFILE                                              CSD015
     C                     Z-ADD42        DBASE                                               CSD015
     C                     EXSR DBERR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Access compliance watch configuration.                                               CSD015
      *                                                                                       CSD015
     C                     CALL 'AOCWCDR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*FIRST ' @OPTN                                               CSD015
     C           SDCWCD    PARM SDCWCD    DSSDY                                               CSD015
      *                                                                                       CSD015
      ** If return code not blank, then issue database error.                                 CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE @OPTN     DBKEY                                               CSD015
     C                     MOVE 'SDCWCDPD'DBFILE                                              CSD015
     C                     Z-ADD43        DBASE                                               CSD015
     C                     EXSR DBERR                                                         CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   DBERR SR. - Database Error Handling : Terminates program      *
     C**   ~~~~~~~~~                                                     *
     C**      Called From      DB Err No.    File                        *
     C*********SR.*INITL************01*******TABFF*(TABTB11)**************S01117
     C**       SR. INITL            01       SDBANKPD                    *S01117
     C**                            02       TABFF (TABTB20)             *
     C**                            03       TABFF (TABTB40)             *
     C**                            04       TABFF (TABTB80 FF)          *
     C**                            31       SDGELRPD                    *S01117
     C*********SR.*INSCTL***********05*******TABFF*(TABLETR)**************S01117
     C*********SR.*ADECTL***********06*******TABFF*(TABLETR)**************S01117
     C**       SR. INSCTL           05       SDBRCHPD                    *S01117
     C**       SR. ADECTL           06       SDBRCHPD                    *S01117
     C**       SR. INSDET           07       INTYP                       *
     C**       SR. BRDFLT           08       FOCLT                       *
     C**       SR. CUDFLT           09       FOCLT                       *
     C**       SR. MKIINT           10       TABFF (TABTG10)             *
     C**                            11       INTYP2                      *
     C**       SR. MADEIN           12       TRSETIN                     *
     C**                            13       TRANSIN                     *
     C**       SR. OTCINT           14       TABFF (TABTG10)             *
     C**       SR. OADEIN           15       TRSETIN                     *
     C**                            16       TRANSIN                     *
     C**       SR. ADEVL1           17       INTYP                       *
     C**       SR. UPDINS           18       TRANS                       *
     C**       SR. UPDAMD           19       TRANS                       *
     C**       SR. UPDDEL           20       TRANS                       *
     C**                            21       TRANS                       *
     C**                            22       FOCLT                       *
     C**       SR. UTRSET           23       TRSET                       *
     C**       SR. UTTRST           24       TRSET                       *
     C**       SR. UCLST            25       CLOST2                      *
     C**                            26       CLOST                       *
     C**       SR. UPSTNC           27       POSTNC                      *
     C**       SR. UPSTNB           28       POSTNC                      *
     C**       SR. UPSTNK           29       POSTNK                      *
     C**       SR. UTRNSA           30       TRANSA                      *
     C**                            32       SCSARDPD                    *CFF003
     C**                                                                 *
     C********************************************************************
     C*
     C           DBERR     BEGSR                           ** DBERR SR **
     C*
     C                     OUT  LDA
     C*
     C                     CLOSETABFF
     C                     CLOSETRANS
     C                     CLOSETRSET
     C                     CLOSETRANSIN
     C                     CLOSETRSETIN
     C                     CLOSECLOST
     C                     CLOSECLOST2
     C                     CLOSEPOSTNC
     C                     CLOSEPOSTNK
     C                     CLOSEMEMOSM
     C                     CLOSEPRONOM
     C                     CLOSEFFACMVD                                   S01240
     C                     CLOSETRANSA
     C*
     C                     SETON                     U7U8LR
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     RETRN
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INFSR SR. -  File Exception/Error Handling : Cancels program  *
     C**   ~~~~~~~~~                                                     *
     C**      Called From    File      Reason                            *
     C**       SR. UPDINS     TRANS     Write fail (not dup. key error)  *
     C**       SR. RUDBAW     TRANS     Chain fail                       *
     C**                                                                 *
     C********************************************************************
     C*
     C           INFSR     BEGSR                           *** INFSR SR **
     C*
     C                     MOVE '*CANCL'  EXTTAG  6
     C*
     C                     ENDSREXTTAG
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INSCTL SR. -  Insert Secondary screen control                 *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       Main Processing              SR. INSVL1                   *
     C**                                    SR. INSDET                   *
     C**                                    SR. SCRNF2                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           INSCTL    BEGSR                           ** INSCTL SR **
     C*
     C**   Read secondary screen
     C*
     C                     READ FF0030F2                 06
     C*
     C**   Allow 'HELP'
     C*
     C********** *IN01     DOWEQ'1'                                       S01199
     C**********           MOVE 'FF0040  'HBPGM   8                       S01199
     C**********           MOVEAERR       HERCD 160                       S01199
     C**********           CALL 'MHELP'                                   S01199
     C**********           PARM           HBPGM                           S01199
     C**********           PARM           HERCD                           S01199
     C**********           READ FF0030F2                 06               S01199
     C**********           END                                            S01199
     C*
     C**   Continue until F3 or F9 taken                                  E17745
     C*
     C           *INKC     DOWNE'1'
     C************INKL     ANDNE'1'                                       E17745
     C           *INKI     ANDNE'1'                                       E17745
     C*
     C*****Validate*Input,*If*valid*determine*Account*sequence************S01117
     C**   Validate Input                                                 S01117
     C*
     C                     EXSR INSVL1
     C*
     C           *IN18     IFEQ '0'
     C*
     C*****Account sequence*is*'01'*if*no*multibranching******************S01117
     C***********                                                         S01117
     C************IN64     IFEQ '1'                                       S01117
     C***********          MOVE '01'      FFDASQ                          S01117
     C***********                                                         S01117
     C*****Access*PF/TABLETR*for*sequence*if*multibranching***************S01117
     C***********                                                         S01117
     C***********          ELSE                                           S01117
     C***********          MOVE BRCD      FFBRCD                          S01117
     C***********FFBKY     CHAINTABFF                71                   S01117
     C**N71******RECI      COMP 'D'                  7171                 S01117
     C***********                                                         S01117
     C*****Database*error*if*not*found************************************S01117
     C***********                                                         S01117
     C************IN71     IFEQ '1'                                       S01117
     C************LOCK     IN   LDA                                       S01117
     C***********          MOVE '05'      DBASE            ***************S01117
     C***********          MOVE 'TABFF'   DBFILE           * DB ERROR 05 *S01117
     C***********          MOVELFFBKY     DBKEY            ***************S01117
     C***********          EXSR DBERR                                     S01117
     C***********                                                         S01117
     C*****Otherwise*set*up*field*for*later*chain*to*LF/ACCNT*************S01117
     C***********                                                         S01117
     C***********          ELSE                                           S01117
     C***********          MOVE NSACS     FFDASQ                          S01117
     C***********          END                                            S01117
     C***********                                                         S01117
     C***********          END                                            S01117
     C*                                                                   S01117
     C**   Access branch details for the branch internal customer         S01117
     C**   of the transaction branch                                      S01117
     C*                                                                   S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM BRCA      @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    @DSFDY                                       S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD5         DBASE            ***************S01117
     C                     MOVEL'SDBRCHPD'DBFILE           * DB ERROR 05 *S01117
     C                     MOVEL@DSNB     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN                          S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C           *LIKE     DEFN A8BICN    BICN                            S01117
     C                     MOVE A8BICN    BICN                            S01117
     C           *LIKE     DEFN A8LCCD    BLOC                            S01195
     C                     MOVE A8LCCD    BLOC                            S01195
     C*
     C**   Output and process Detail screen
     C*
     C                     SETON                     13
     C                     EXSR INSDET
     C*
     C**   If F12 taken or valid entry on main screen, blank fields
     C*
     C           *INKL     IFEQ '1'
     C                     MOVE *BLANKS   STNBR
     C                     MOVE *BLANKS   SCLSR
     C                     MOVE *BLANKS   SMIODS
     C                     SETOF                     18
     C                     END
     C*
     C                     END
     C*
     C**   Redisplay screen, check for Cmd keys on later screen
     C*
     C           *INKC     IFNE '1'
     C           *INKI     ANDNE'1'                                       E17745
     C************INKL     ANDNE'1'                                       E17745
     C                     EXSR SCRNF2
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   ADECTL SR. - (Amend/Delete/Enquire) Secondary screen control  *
     C**   ~~~~~~~~~~                                                    *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       Main Processing              SR. ADEVL1                   *
     C**                                    SR. ADEMKI                   *
     C**                                    SR. ADEOTC                   *
     C**                                    SR. SCRNF3                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           ADECTL    BEGSR                           ** ADECTL SR **
     C*
     C**   Read secondary screen
     C*
     C                     READ FF0030F3                 06
     C*
     C**   Allow 'HELP'
     C*
     C********** *IN01     DOWEQ'1'                                       S01199
     C**********           MOVE 'FF0040  'HBPGM   8                       S01199
     C**********           MOVEAERR       HERCD 160                       S01199
     C**********           CALL 'MHELP'                                   S01199
     C**********           PARM           HBPGM                           S01199
     C**********           PARM           HERCD                           S01199
     C**********           READ FF0030F3                 06               S01199
     C**********           END                                            S01199
     C*
     C**   Continue until F3 or F9 taken                                  E17745
     C*
     C           *INKC     DOWNE'1'
     C           *INKI     ANDNE'1'                                       E17745
     C************INKL     ANDNE'1'                                       E17745
     C*
     C*****Validate*Input,*if*valid*determine*Account*sequence************S01117
     C**   Validate Input                                                 S01117
     C*
     C                     EXSR ADEVL1
     C*
     C           *IN18     IFEQ '0'
     C*
     C*****Account*sequence*is*'01'*if*no*multibranching******************S01117
     C***********                                                         S01117
     C************IN64     IFEQ '1'                                       S01117
     C***********          MOVE '01'      FFDASQ                          S01117
     C***********                                                         S01117
     C*****Access*PF/TABLETR*for*sequence*if*multibranching***************S01117
     C***********                                                         S01117
     C***********          ELSE                                           S01117
     C***********          MOVE BRCD      FFBRCD                          S01117
     C***********FFBKY     CHAINTABFF                71                   S01117
     C**N71******RECI      COMP 'D'                  7171                 S01117
     C***********                                                         S01117
     C*****Database*error*if*not*found************************************S01117
     C***********                                                         S01117
     C************IN71     IFEQ '1'                                       S01117
     C************LOCK     IN   LDA                                       S01117
     C***********          MOVE '06'      DBASE            ***************S01117
     C***********          MOVE 'TABFF'   DBFILE           * DB ERROR 06 *S01117
     C***********          MOVELFFBKY     DBKEY            ***************S01117
     C***********          EXSR DBERR                                     S01117
     C***********                                                         S01117
     C*****Otherwise*set*up*field*for*later*chain*to*LF/ACCNT*************S01117
     C***********                                                         S01117
     C***********          ELSE                                           S01117
     C***********          MOVE NSACS     FFDASQ                          S01117
     C***********          END                                            S01117
     C***********                                                         S01117
     C***********          END                                            S01117
     C*                                                                   S01117
     C**   Access branch details for the branch internal customer         S01117
     C**   of the transaction branch                                      S01117
     C*                                                                   S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM BRCA      @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    @DSFDY                                       S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD6         DBASE            ***************S01117
     C                     MOVEL'SDBRCHPD'DBFILE           * DB ERROR 06 *S01117
     C                     MOVEL@DSNB     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN                          S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     MOVE A8BICN    BICN                            S01117
     C                     MOVE A8LCCD    BLOC                            S01195
     C*
     C**   Proceed to full details screen
     C*
     C                     SETOF                     3865
     C                     SETOF                     3637                 S01117
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP5                                           S01408
     C*                                                                   S01408
     C           CFF003    IFEQ 'Y'                                       CFF003
     C                     SETOF                     39                   CFF003
     C                     ENDIF                                          CFF003
     C*                                                                   CFF003
     C                     MOVEA'000000'  *IN,30
     C                     MOVEA'00000'   *IN,40
     C***********          MOVEA'0000'    *IN,46                          S01117
     C                     MOVEA'00000'   *IN,45                          S01117
     C                     MOVEA'00000'   *IN,50
     C***********          MOVEA'0000'    *IN,56                          S01117
     C                     MOVEA'00000'   *IN,55                          S01117
     C*
     C           PACTN     IFEQ 'A'
     C                     SETON                     13
     C                     END
     C*
     C           PMRKT     IFNE '  '
     C                     EXSR ADEMKI
     C*
     C                     ELSE
     C                     EXSR ADEOTC
     C                     END
     C*
     C**   If F12 taken or valid entry on main screen, blank fields
     C*
     C           *INKL     IFEQ '1'
     C                     MOVE *BLANKS   STNBR
     C                     MOVE *BLANKS   SMIODS
     C                     SETOF                     18
     C                     END
     C*
     C                     END
     C*
     C**   Redisplay screen, check for Cmd keys on later screen
     C*
     C           *INKC     IFNE '1'
     C           *INKI     ANDNE'1'                                       E17745
     C************INKL     ANDNE'1'                                       E17745
     C                     EXSR SCRNF3
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INSDET SR. -  Insert Detail screen control                    *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSCTL                   SR. BRDFLT                   *
     C**                                    SR. CUDFLT                   *
     C**                                    SR. INSMKI                   *
     C**                                    SR. INSOTC                   *
     C**                                    SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           INSDET    BEGSR                           ** INSDET SR **
     C*
     C**   Access LF/INTYP record
     C*
     C                     MOVE ISTT      KISTT
     C           KISTT     CHAININTYP                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '07'      DBASE            ***************S01117
     C                     Z-ADD7         DBASE            ***************S01117
     C                     MOVE 'INTYP'   DBFILE           * DB ERROR 07 *
     C                     MOVELKISTT     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Initialise Broker Settlement Defaults where relevant
     C*
     C                     SETOF                     1415
     C********** BOCO      IFNE *ZEROS                                                        CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     SETON                     14
     C                     EXSR BRDFLT
     C                     END
     C*
     C**   Initialise Customer Settlement Defaults where relevant
     C*
     C********** CUSC      IFNE *ZEROS                                                        CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     SETON                     15
     C                     EXSR CUDFLT
     C                     END
     C*
     C**   Display and process screen
     C*
     C***********          SETOF                     38                   S01117
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP6                                           S01408
     C*                                                                   S01408
     C           CFF003    IFEQ 'Y'                                       CFF003
     C                     MOVEA'0000'    *IN,36                          CFF003
     C                     ELSE                                           CFF003
     C                     MOVEA'000'     *IN,36                          S01117
     C                     ENDIF                                          CFF003
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP7                                           S01408
     C*                                                                   S01408
     C                     MOVEA'000000'  *IN,30
     C                     MOVEA'00000'   *IN,40
     C***********          MOVEA'0000'    *IN,46                          S01117
     C                     MOVEA'00000'   *IN,45                          S01117
     C                     MOVEA'00000'   *IN,50
     C***********          MOVEA'0000'    *IN,56                          S01117
     C                     MOVEA'00000'   *IN,55                          S01117
     C*
     C**   - Market instrument
     C*
     C           PMRKT     IFNE '  '
     C                     EXSR INSMKI
     C*
     C**   - Over the counter
     C*
     C                     ELSE
     C                     EXSR INSOTC
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INSMKI SR. -  Insert Market Instrument details processing     *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSDET                   SR. INSVL2                   *
     C**                                    SR. UPDINS                   *
     C**                                    SR. SCRNF4                   *
     C**                                    SR. SCRNF6                   *
     C**                                    SR. MKIINT                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           INSMKI    BEGSR                           ** INSMKI SR **
     C*
     C**   Initialise screen fields then Write/Read detail screen
     C*
     C                     EXSR MKIINT
     C                     EXSR SCRNF4
     C*
     C**   Continue until F3, F9 or F12 taken, or valid exit.             E17745
     C*
     C           *INKC     DOWNE'1'
     C           *INKI     ANDNE'1'                                       E17745
     C           *INKL     ANDNE'1'
     C*
     C**   Validate Input
     C*
     C***********          SETOF                     38                   S01117
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP8                                           S01408
     C*                                                                   S01408
     C           CFF003    IFEQ 'Y'                                       CFF003
     C                     MOVEA'0000'    *IN,36                          CFF003
     C                     ELSE                                           CFF003
     C                     MOVEA'000'     *IN,36                          S01117
     C                     ENDIF                                          CFF003
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CCP9                                           S01408
     C*                                                                   S01408
     C                     MOVEA'000000'  *IN,30
     C                     MOVEA'00000'   *IN,40
     C***********          MOVEA'0000'    *IN,46                          S01117
     C                     MOVEA'00000'   *IN,45                          S01117
     C                     MOVEA'00000'   *IN,50
     C***********          MOVEA'0000'    *IN,56                          S01117
     C                     MOVEA'00000'   *IN,55                          S01117
     C                     EXSR INSVL2
     C*
     C**   If valid attempt file updates
     C*
     C           *IN18     IFEQ '0'
     C/COPY WNCPYSRC,FF0040C019
     C                     MOVE '1'       *INKL
     C                     EXSR UPDINS
     C*
     C**   If Record/Related Record updated by another workstation
     C**   - display screen, protected, with updated details
     C*
     C           *IN11     IFEQ '1'
     C                     WRITEFF0030F4
     C                     EXSR SCRNF6
     C                     MOVE '1'       *INKL
     C                     SETOF                     111216
     C                     END
     C*
     C**   If invalid redisplay screen with error codes
     C*
     C                     ELSE
     C                     EXSR SCRNF4
     C/COPY WNCPYSRC,FF0040C020
     C*
     C                     END
     C*
     C                     END
     C*
     C/COPY WNCPYSRC,FF0040C021
     C                     ENDSR
     C/COPY WNCPYSRC,FF0040C022
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INSOTC SR. -  Insert Over the counter details processing      *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSDET                   SR. INSVL2                   *
     C**                                    SR. UPDINS                   *
     C**                                    SR. SCRNF5                   *
     C**                                    SR. SCRNF6                   *
     C**                                    SR. OTCINT                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           INSOTC    BEGSR                           ** INSOTC SR **
     C*
     C**   Initialise screen fields then Write/Read detail screen
     C*
     C                     EXSR OTCINT
     C                     EXSR SCRNF5
     C*
     C**   Continue until F3, F9 or F12 taken, or valid exit.             E17745
     C*
     C           *INKC     DOWNE'1'
     C           *INKI     ANDNE'1'                                       E17745
     C           *INKL     ANDNE'1'
     C*
     C**   Validate Input
     C*
     C***********          SETOF                     38                   S01117
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP10                                           S01408
     C*                                                                   S01408
     C           CFF003    IFEQ 'Y'                                       CFF003
     C                     MOVEA'0000'    *IN,36                          CFF003
     C                     ELSE                                           CFF003
     C                     MOVEA'000'     *IN,36                          S01117
     C                     ENDIF                                          CFF003
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP11                                           S01408
     C*                                                                   S01408
     C                     MOVEA'000000'  *IN,30
     C                     MOVEA'00000'   *IN,40
     C***********          MOVEA'0000'    *IN,46                          S01117
     C                     MOVEA'00000'   *IN,45                          S01117
     C                     MOVEA'00000'   *IN,50
     C***********          MOVEA'0000'    *IN,56                          S01117
     C                     MOVEA'00000'   *IN,55                          S01117
     C                     EXSR INSVL2
     C*
     C**   If valid attempt file updates
     C*
     C           *IN18     IFEQ '0'
     C/COPY WNCPYSRC,FF0040C023
     C                     MOVE '1'       *INKL
     C                     EXSR UPDINS
     C*
     C**   If Record/Related Record updated by another workstation
     C**   - display screen, protected, with updated details
     C*
     C           *IN11     IFEQ '1'
     C                     WRITEFF0030F5
     C                     EXSR SCRNF6
     C                     MOVE '1'       *INKL
     C                     SETOF                     111216
     C                     END
     C*
     C**   If invalid redisplay screen with error codes
     C*
     C                     ELSE
     C                     EXSR SCRNF5
     C/COPY WNCPYSRC,FF0040C024
     C*
     C                     END
     C*
     C                     END
     C*
     C/COPY WNCPYSRC,FF0040C025
     C                     ENDSR
     C/COPY WNCPYSRC,FF0040C026
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   ADEMKI SR. -  Amd/Del/Enq Market Instrument Control           *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. ADECTL                   SR. CUSTVL                   *
     C**                                    SR. BROKVL                   *
     C**                                    SR. UPDAMD                   *
     C**                                    SR. UPDDEL                   *
     C**                                    SR. SCRNF4                   *
     C**                                    SR. SCRNF6                   *
     C**                                    SR. MKIINT                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           ADEMKI    BEGSR                           ** ADEMKI SR **
     C*
     C**   Initialise screen fields then Write/Read detail screen
     C*
     C                     EXSR MKIINT
     C/COPY WNCPYSRC,FF0040C027
     C                     EXSR SCRNF4
     C*
     C**   No validation necessary if action is Enquire
     C*
     C           PACTN     IFEQ 'E'
     C/COPY WNCPYSRC,FF0040C028
     C                     MOVE *BLANKS   STNBR
     C*
     C**   Continue until F3, F9 or F12 taken, or valid exit.             E17745
     C*
     C                     ELSE
     C           *INKC     DOWNE'1'
     C           *INKI     ANDNE'1'                                       E17745
     C           *INKL     ANDNE'1'
     C*
     C**   Validate Input if action is Amend and End of Centre
     C**   processing has not been carried out for the trade.
     C*
     C           PACTN     IFEQ 'A'
     C                     MOVEA'00000'   *IN,40
     C***********          MOVEA'0000'    *IN,46                          S01117
     C                     MOVEA'00000'   *IN,45                          S01117
     C                     MOVEA'00000'   *IN,50
     C***********          MOVEA'0000'    *IN,56                          S01117
     C                     MOVEA'00000'   *IN,55                          S01117
     C                     SETOF                     18
     C                     Z-ADD0         E
     C                     MOVE *BLANK    ERR
     C*
     C           *IN65     IFEQ '1'
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           BGN4ST    ANDEQ'Y'                                       CFF007
     C           CSD015    OREQ 'Y'                                                           CSD015
     C                     MOVELCUSC      WWKY10                          CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*KEY   ' POPTN                           CFF007
     C                     PARM           WWKY10 10                       CFF007
     C                     PARM           @KYST                           CFF007
     C           SDCUST    PARM SDCUST    DSLDY                           CFF007
      *                                                                   CFF007
     C           PRTCD     IFNE *BLANKS                                   CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     MOVEL'SDCUSTPD'DBFILE           ************   CFF007
     C                     MOVELCUSC      DBKEY            * DBERR 34 *   CFF007
     C                     MOVEL*BLANKS   DBOPTN           ************   CFF007
     C                     Z-ADD34        DBASE                           CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C                     MOVELBBPRBA    WPCFLG  1                       CFF007
     C                     MOVELBBCRPC    WLCRPC                                              CSD015
     C                     MOVELBBLICD    WLLICD                                              CSD015
     C                     MOVELBBCRNM    WLCRNM                                              CSD015
     C                     MOVELBBCRTN    WLCRTN                                              CSD015
     C                     MOVELCNUMS     WLCUST                                              CSD015
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C/COPY WNCPYSRC,FF0040C040
     C                     EXSR CUSTVL
     C                     END
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           BGN4ST    ANDEQ'Y'                                       CFF007
     C                     MOVELBOCO      WWKY10                          CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*KEY   ' POPTN                           CFF007
     C                     PARM           WWKY10 10                       CFF007
     C                     PARM           @KYST                           CFF007
     C           SDCUST    PARM SDCUST    DSLDY                           CFF007
      *                                                                   CFF007
     C           PRTCD     IFNE *BLANKS                                   CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     MOVEL'SDCUSTPD'DBFILE           ************   CFF007
     C                     MOVELBOCO      DBKEY            * DBERR 38 *   CFF007
     C                     MOVEL*BLANKS   DBOPTN           ************   CFF007
     C                     Z-ADD38        DBASE                           CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C                     MOVELBBPRBA    WPBFLG  1                       CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     EXSR BROKVL
     C                     END
     C*
     C                     END
     C*
     C**   Otherwise (ie - Delete), test for F10
     C*
     C                     ELSE
     C*
     C                     SETOF                     18
     C           *INKJ     IFNE '1'
     C                     SETON                     18
     C                     MOVEAMSG,1     SERCD2
     C                     END
     C*
     C                     END
     C*
     C**   If entry is valid, attempt file updates
     C*
     C           *IN18     IFEQ '0'
     C/COPY WNCPYSRC,FF0040C029
     C                     MOVE '1'       *INKL
     C*
     C           PACTN     IFEQ 'A'
     C                     EXSR UPDAMD
     C                     ELSE
     C                     EXSR UPDDEL
     C                     END
     C*
     C**   If Record/Related Record updated by another workstation
     C**   - display screen, protected with updated details
     C*
     C           *IN11     IFEQ '1'
     C                     WRITEFF0030F4
     C                     EXSR SCRNF6
     C                     MOVE '1'       *INKL
     C                     SETOF                     111216
     C                     END
     C*
     C**   If invalid, redisplay screen with error codes
     C*
     C                     ELSE
     C                     EXSR SCRNF4
     C/COPY WNCPYSRC,FF0040C030
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C/COPY WNCPYSRC,FF0040C031
     C                     ENDSR
     C/COPY WNCPYSRC,FF0040C032
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   ADEOTC SR. -  Amd/Del/Enq Over the counter Control            *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. ADECTL                   SR. CUSTVL                   *
     C**                                    SR. UPDAMD                   *
     C**                                    SR. UPDDEL                   *
     C**                                    SR. SCRNF5                   *
     C**                                    SR. SCRNF6                   *
     C**                                    SR. OTCINT                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           ADEOTC    BEGSR                           ** ADEOTC SR **
     C*
     C**   Initialise screen fields then Write/Read detail screen
     C*
     C                     EXSR OTCINT
     C/COPY WNCPYSRC,FF0040C033
     C                     EXSR SCRNF5
     C*
     C**   No validation necessary if action is Enquire
     C*
     C           PACTN     IFEQ 'E'
     C/COPY WNCPYSRC,FF0040C034
     C                     MOVE *BLANKS   STNBR
     C*
     C**   Continue until F3, F9 or F12 taken, or valid exit.             E17745
     C*
     C                     ELSE
     C           *INKC     DOWNE'1'
     C           *INKI     ANDNE'1'                                       E17745
     C           *INKL     ANDNE'1'
     C*
     C**   Validate Input if action is Amend and End of Centre
     C**   processing has not been carried out for the trade.
     C*
     C           PACTN     IFEQ 'A'
     C                     MOVEA'00000'   *IN,40
     C***********          MOVEA'0000'    *IN,46                          S01117
     C                     MOVEA'00000'   *IN,45                          S01117
     C                     MOVEA'00000'   *IN,50
     C***********          MOVEA'0000'    *IN,56                          S01117
     C                     MOVEA'00000'   *IN,55                          S01117
     C                     SETOF                     18
     C                     Z-ADD0         E
     C                     MOVE *BLANK    ERR
     C*
     C           *IN65     IFEQ '1'
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           BGN4ST    ANDEQ'Y'                                       CFF007
     C********** CUSC      ANDNE*ZEROS                                                 CFF007 CSD027
     C           CUSC      ANDNE*BLANKS                                                       CSD027
     C           CSD015    OREQ 'Y'                                                           CSD015
     C********** CUSC      ANDNE*ZEROS                                                 CSD015 CSD027
     C           CUSC      ANDNE*BLANKS                                                       CSD027
     C                     MOVELCUSC      WWKY10                          CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*KEY   ' POPTN                           CFF007
     C                     PARM           WWKY10 10                       CFF007
     C                     PARM           @KYST                           CFF007
     C           SDCUST    PARM SDCUST    DSLDY                           CFF007
      *                                                                   CFF007
     C           PRTCD     IFNE *BLANKS                                   CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     MOVEL'SDCUSTPD'DBFILE           ************   CFF007
     C                     MOVELCUSC      DBKEY            * DBERR 35 *   CFF007
     C                     MOVEL*BLANKS   DBOPTN           ************   CFF007
     C                     Z-ADD35        DBASE                           CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C                     MOVELBBPRBA    WPCFLG                          CFF007
     C                     MOVELBBCRPC    WLCRPC                                              CSD015
     C                     MOVELBBLICD    WLLICD                                              CSD015
     C                     MOVELBBCRNM    WLCRNM                                              CSD015
     C                     MOVELBBCRTN    WLCRTN                                              CSD015
     C                     MOVELCNUMS     WLCUST                                              CSD015
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C/COPY WNCPYSRC,FF0040C041
     C                     EXSR CUSTVL
     C                     END
     C*
     C**   Otherwise (ie - Delete), test for F10
     C*
     C                     ELSE
     C*
     C                     SETOF                     18
     C           *INKJ     IFNE '1'
     C                     SETON                     18
     C                     MOVEAMSG,1     SERCD2
     C                     END
     C*
     C                     END
     C*
     C**   If entry is valid, attempt file updates
     C*
     C           *IN18     IFEQ '0'
     C/COPY WNCPYSRC,FF0040C035
     C                     MOVE '1'       *INKL
     C*
     C           PACTN     IFEQ 'A'
     C                     EXSR UPDAMD
     C                     ELSE
     C                     EXSR UPDDEL
     C                     END
     C*
     C**   If Record/Related Record updated by another workstation
     C**   - display screen, protected with updated details
     C*
     C           *IN11     IFEQ '1'
     C                     WRITEFF0030F5
     C                     EXSR SCRNF6
     C                     MOVE '1'       *INKL
     C                     SETOF                     111216
     C                     END
     C*
     C**   If Invalid, redisplay screen with error codes
     C*
     C                     ELSE
     C                     EXSR SCRNF5
     C/COPY WNCPYSRC,FF0040C036
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C/COPY WNCPYSRC,FF0040C037
     C                     ENDSR
     C/COPY WNCPYSRC,FF0040C038
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   SCRNF2 SR. -  To Write/Read Secondary Insert Screen           *
     C**   ~~~~~~~~~~     + handle 'HELP'                                *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       SR. INSCTL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           SCRNF2    BEGSR                           ** SCRNF2 SR **
     C*
     C                     EXFMTFF0030F2
     C*
     C**   Allow 'HELP'
     C*
     C********** *IN01     DOWEQ'1'                                       S01199
     C*
     C**********           MOVE 'FF0040  'HBPGM   8                       S01199
     C**********           MOVEAERR       HERCD 160                       S01199
     C**********           CALL 'MHELP'                                   S01199
     C**********           PARM           HBPGM                           S01199
     C**********           PARM           HERCD                           S01199
     C**********           READ FF0030F2                 06               S01199
     C**********           END                                            S01199
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   SCRNF3 SR. -  To Write/Read Secondary Amd/Del/Enq screen      *
     C**   ~~~~~~~~~~     + handle 'HELP'                                *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       SR. ADECTL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           SCRNF3    BEGSR                           ** SCRNF3 SR **
     C*
     C                     EXFMTFF0030F3
     C*
     C**   Allow 'HELP'
     C*
     C********** *IN01     DOWEQ'1'                                       S01199
     C*
     C**********           MOVE 'FF0040  'HBPGM   8                       S01199
     C**********           MOVEAERR       HERCD 160                       S01199
     C**********           CALL 'MHELP'                                   S01199
     C**********           PARM           HBPGM                           S01199
     C**********           PARM           HERCD                           S01199
     C*
     C**********           READ FF0030F3                 06               S01199
     C**********           END                                            S01199
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   SCRNF4 SR. -  To Write/Read Market Instrument details screen  *
     C**   ~~~~~~~~~~     + handle 'HELP'                                *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       SR. INSMKI                                                *
     C**       SR. ADEMKI                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           SCRNF4    BEGSR                           ** SCRNF4 SR **
     C/COPY WNCPYSRC,FF0040C076
     C           *IN18     IFEQ '1'                                       CFF007
     C           E         ANDEQ*ZEROS                                    CFF007
     C                     MOVE '0'       *IN18                           CFF007
     C                     ENDIF                                          CFF007
     C*
     C                     EXFMTFF0030F4
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP12                                           S01408
     C*                                                                   S01408
     C*
     C**   Allow 'HELP'
     C*
     C********** *IN01     DOWEQ'1'                                       S01199
     C*
     C**********           MOVE 'FF0040  'HBPGM   8                       S01199
     C**********           MOVEAERR       HERCD 160                       S01199
     C**********           CALL 'MHELP'                                   S01199
     C**********           PARM           HBPGM                           S01199
     C**********           PARM           HERCD                           S01199
     C*
     C**********           READ FF0030F4                 06               S01199
     C**********           END                                            S01199
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   SCRNF5 SR. -  To Write/Read Over the counter details screen   *
     C**   ~~~~~~~~~~     + handle 'HELP'                                *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       SR. INSOTC                                                *
     C**       SR. ADEOTC                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           SCRNF5    BEGSR                           ** SCRNF5 SR **
     C/COPY WNCPYSRC,FF0040C077
     C*
     C           *IN18     IFEQ '1'                                       CFF007
     C           E         ANDEQ*ZEROS                                    CFF007
     C                     MOVE '0'       *IN18                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     EXFMTFF0030F5
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP13                                           S01408
     C*                                                                   S01408
     C*
     C**   Allow 'HELP'
     C*
     C********** *IN01     DOWEQ'1'                                       S01199
     C*
     C**********           MOVE 'FF0040  'HBPGM   8                       S01199
     C**********           MOVEAERR       HERCD 160                       S01199
     C**********           CALL 'MHELP'                                   S01199
     C**********           PARM           HBPGM                           S01199
     C**********           PARM           HERCD                           S01199
     C*
     C*                    READ FF0030F5                 06               S01199
     C*                    END                                            S01199
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   SCRNF6 SR. -  To Write/Read 'Record/Related Record Updated    *
     C**   ~~~~~~~~~~   by another Workstation' screen, + handle 'HELP'  *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       SR. INSMKI                                                *
     C**       SR. INSOTC                                                *
     C**       SR. ADEMKI                                                *
     C**       SR. ADEOTC                                                *
     C**                                                                 *
     C********************************************************************
     C**
     C           SCRNF6    BEGSR                           ** SCRNF6 SR **
     C**
     C                     EXFMTFF0030F6
     C**   Allow 'HELP'
     C**
     C********** *IN01     DOWEQ'1'                                       S01199
     C**
     C**********           MOVE 'FF0040  'HBPGM   8                       S01199
     C**********           MOVEAERR       HERCD 160                       S01199
     C**********           CALL 'MHELP'                                   S01199
     C**********           PARM           HBPGM                           S01199
     C**********           PARM           HERCD                           S01199
     C**
     C**********           READ FF0030F6                 06               S01199
     C**********           END                                            S01199
     C**
     C                     ENDSR
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   BRDFLT SR. - Initialise Broker Defaults                       *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSDET                   SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           BRDFLT    BEGSR                           ** BRDFLT SR **
     C*
     C**   Access Settlement defaults from LF/FOCLT
     C*
     C                     MOVELBOCO      KCBCD
     C           KCBCD     CHAINFOCLT                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '08'      DBASE            ***************S01117
     C                     Z-ADD8         DBASE            ***************S01117
     C                     MOVE 'FOCLT'   DBFILE           * DB ERROR 08 *
     C                     MOVELKCBCD     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C                     MOVE PSCI      PSCIS   1
     C                     MOVE SETP      SETPS   20
     C**********           MOVE SETA      SETAS  12                                           CGL029
     C                     MOVE SETA      SETAS  18                                           CGL029
     C                     MOVE SEBR      SEBRS   3                       S01117
     C                     MOVE FACO      FACOS  10
     C                     MOVE CNOS      CNOSS   8
     C*
     C**   Access Broker defaults from LF/DEFLT
     C*
     C                     MOVE ISTT      ISTTK
     C           KDEFLT    CHAINDEFLT                71
     C  N71      RECI      COMP 'D'                  7171
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP14                                           S01408
     C*                                                                   S01408
     C*
     C**   If LF/DEFLT record doesn't exist get Charge/Commission
     C**   codes from LF/INTYP
     C*
     C           *IN71     IFEQ '1'
     C                     MOVE BCPT      WBCPT   1
     C*
     C           BCPT      IFNE ' '
     C                     MOVE BCMC      SBCMC
     C                     MOVE BCMS      SBCMS
     C                     END
     C*
     C           TRTY      IFEQ 'P'
     C           BCGP      IFNE 00
     C                     MOVE BCGP      SBCHC
     C                     END
     C*
     C                     ELSE
     C           BCGS      IFNE 00
     C                     MOVE BCGS      SBCHC
     C                     END
     C*
     C                     END
     C*
     C**   If LF/DEFLT record exists
     C*
     C**    Commission details - (from LF/DEFLT)
     C*
     C                     ELSE
     C           CPAT      IFNE ' '
     C                     MOVE CPAT      WBCPT
     C                     MOVE CMCD      SBCMC
     C                     MOVE CMSD      SBCMS
     C*
     C**    (from LF/INTYP)
     C*
     C                     ELSE
     C                     MOVE BCPT      WBCPT
     C           BCPT      IFNE ' '
     C                     MOVE BCMC      SBCMC
     C                     MOVE BCMS      SBCMS
     C                     END
     C*
     C                     END
     C*
     C**   - 2. Charge code (Purchase)
     C*
     C           TRTY      IFEQ 'P'
     C*
     C**    (from LF/DEFLT)
     C*
     C           CGEP      IFNE 00
     C                     MOVE CGEP      SBCHC
     C*
     C**    (from LF/INTYP)
     C*
     C                     ELSE
     C           BCGP      IFNE 00
     C                     MOVE BCGP      SBCHC
     C                     END
     C*
     C                     END
     C*
     C**   - 3. Charge code (Sale)
     C*
     C**    (from LF/DEFLT)
     C*
     C                     ELSE
     C           CGES      IFNE 00
     C                     MOVE CGES      SBCHC
     C*
     C**    (from LF/INTYP)
     C*
     C                     ELSE
     C           BCGS      IFNE 00
     C                     MOVE BCGS      SBCHC
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP15                                           S01408
     C*                                                                   S01408
     C*
     C**   Settlement Defaults
     C*
     C           *IN71     IFEQ '0'
     C           SETP      ANDNE00
     C*
     C**   - from LF/DEFLT
     C*
     C                     MOVE SETP      SBSLT
     C                     MOVE SETA      SBSLA
     C           PMBIN     IFEQ 'Y'                                       S01117
     C                     MOVE SEBR      SBSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE *BLANK    SBSBR                           S01117
     C                     END                                            S01117
     C                     MOVE FACO      SBFAO
     C                     MOVELCNOS      SBCPN
     C*
     C**   - from LF/FOCLT
     C*
     C                     ELSE
     C                     MOVE SETPS     SBSLT
     C                     MOVE SETAS     SBSLA
     C           PMBIN     IFEQ 'Y'                                       S01117
     C                     MOVE SEBRS     SBSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE *BLANK    SBSBR                           S01117
     C                     END                                            S01117
     C                     MOVE FACOS     SBFAO
     C                     MOVELCNOSS     SBCPN
     C                     END
     C*
     C***********SBSLT     IFEQ '05'                                      S01117
     C************IN64     ANDEQ'0'                                       S01117
     C***********          MOVE NSACS     SBSLA                           S01117
     C***********          END                                            S01117
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   CUDFLT SR. -  Initialise  Customer Defaults                   *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSDET                   SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           CUDFLT    BEGSR                           ** CUDFLT SR **
     C*
     C**   Access Settlement defaults from LF/FOCLT
     C*
     C                     MOVELCUSC      KCBCD
     C           KCBCD     CHAINFOCLT                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '09'      DBASE            ***************S01117
     C                     Z-ADD9         DBASE            ***************S01117
     C                     MOVE 'FOCLT'   DBFILE           * DB ERROR 09 *
     C                     MOVELKCBCD     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C                     MOVE SETP      SETPS   20
     C**********           MOVE SETA      SETAS  12                                           CGL029
     C                     MOVE SETA      SETAS                                               CGL029
     C                     MOVE SEBR      SEBRS   3                       S01117
     C                     MOVE FACO      FACOS  10
     C                     MOVE CNOS      CNOSS   8
     C*
     C**   Access Customer defaults from LF/DEFLT
     C**   - no defaults exist for O.T.C.'s
     C*
     C                     MOVE ISTT      ISTTK
     C           PMRKT     IFNE '  '
     C           KDEFLT    CHAINDEFLT                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C                     ELSE
     C                     SETON                     71
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP16                                           S01408
     C*                                                                   S01408
     C*
     C**   If LF/DEFLT record doesn't exist get Charge/Commission
     C**   codes from LF/INTYP
     C*
     C           *IN71     IFEQ '1'
     C                     MOVE CCPT      WCCPT   1
     C*
     C           CCPT      IFNE ' '
     C                     MOVE CCMC      SCCMC
     C                     MOVE CCMS      SCCMS
     C                     END
     C*
     C           TRTY      IFEQ 'P'
     C           CCGP      IFNE 00
     C                     MOVE CCGP      SCCHC
     C                     END
     C*
     C                     ELSE
     C           CCGS      IFNE 00
     C                     MOVE CCGS      SCCHC
     C                     END
     C*
     C                     END
     C*
     C**   If LF/DEFLT record exists
     C*
     C**    Commission details - (from LF/DEFLT)
     C*
     C                     ELSE
     C           CPAT      IFNE ' '
     C                     MOVE CPAT      WCCPT
     C                     MOVE CMCD      SCCMC
     C                     MOVE CMSD      SCCMS
     C*
     C**    (from LF/INTYP)
     C*
     C                     ELSE
     C                     MOVE CCPT      WCCPT
     C           CCPT      IFNE ' '
     C                     MOVE CCMC      SCCMC
     C                     MOVE CCMS      SCCMS
     C                     END
     C*
     C                     END
     C*
     C**   - 2. Charge code (Purchase)
     C*
     C           TRTY      IFEQ 'P'
     C*
     C**    (from LF/DEFLT)
     C*
     C           CGEP      IFNE 00
     C                     MOVE CGEP      SCCHC
     C*
     C**    (from LF/INTYP)
     C*
     C                     ELSE
     C           CCGP      IFNE 00
     C                     MOVE CCGP      SCCHC
     C                     END
     C*
     C                     END
     C*
     C**   - 3. Charge code (Sale)
     C*
     C**    (from LF/DEFLT)
     C*
     C                     ELSE
     C           CGES      IFNE 00
     C                     MOVE CGES      SCCHC
     C*
     C**    (from LF/INTYP)
     C*
     C                     ELSE
     C           CCGS      IFNE 00
     C                     MOVE CCGS      SCCHC
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP17                                           S01408
     C*                                                                   S01408
     C*
     C**   Settlement Defaults
     C*
     C           *IN71     IFEQ '0'
     C           SETP      ANDNE00
     C*
     C**   - from LF/DEFLT
     C*
     C                     MOVE SETP      SCSLT
     C                     MOVE SETA      SCSLA
     C           PMBIN     IFEQ 'Y'                                       S01117
     C                     MOVE SEBR      SCSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE *BLANK    SCSBR                           S01117
     C                     END                                            S01117
     C                     MOVE FACO      SCFAO
     C                     MOVELCNOS      SCCPN
     C*
     C**   - from LF/FOCLT
     C*
     C                     ELSE
     C                     MOVE SETPS     SCSLT
     C                     MOVE SETAS     SCSLA
     C           PMBIN     IFEQ 'Y'                                       S01117
     C                     MOVE SEBRS     SCSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE *BLANK    SCSBR                           S01117
     C                     END                                            S01117
     C                     MOVE FACOS     SCFAO
     C                     MOVELCNOSS     SCCPN
     C                     END
     C*
     C***********SCSLT     IFEQ '05'                                      S01117
     C************IN64     ANDEQ'0'                                       S01117
     C***********          MOVE NSACS     SCSLA                           S01117
     C***********          END                                            S01117
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   MKIINT SR. - Initialise Screen details  (Market Inst.)        *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSMKI                   SR. FFPRCS                   *
     C**       SR. ADEMKI                   SR. FFSTDP                   *
     C**       SR. RUDBAW                   SR. MADEIN                   *
     C**                                    SR. ZEDIT                    *
     C**                                    SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           MKIINT    BEGSR                           ** MKIINT SR **
     C*
     C**   Determine Instrument Currency dec. places
     C*
     C                     MOVE ISCY      FFCCY   3
     C                     EXSR FFSTDP
     C*
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C***********          MOVE '10'      DBASE            * DB ERROR 10 *S01117
     C                     Z-ADD10        DBASE            * DB ERROR 10 *S01117
     C                     MOVE 'TABFF'   DBFILE           ***************
     C                     MOVELFFCKY     DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C**   Access underlying Instrument to discover MNPF and TKDM
     C*
     C                     MOVE FTRF      KISTC
     C           KISTT     CHAININTYP2               71
     C  N71      RECI2     COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '11'      DBASE            ***************S01117
     C                     Z-ADD11        DBASE            ***************S01117
     C                     MOVE 'INTYP'   DBFILE           * DB ERROR 11 *
     C                     MOVELKISTT     DBKEY            ***************
     C                     EXSR DBERR
     C*
     C**   Save fields for later Price validation
     C*
     C                     ELSE
     C                     Z-ADDTKDM2     TKDMX   30
     C                     Z-ADDTKVL2     TKVLX  115
     C/COPY WNCPYSRC,FF0040C004
     C***********          Z-ADDMNPF2     MNPFX  117                      CFF004
     C/COPY WNCPYSRC,FF0040C005
     C           *LIKE     DEFN MNPF      MNPFX                           CFF004
     C                     Z-ADDMNPF2     MNPFX                           CFF004
     C                     MOVE ISTT      KISTC
     C                     END
     C*
     C**   Set up fields for display for Amend/Delete/Enquire or Record
     C**   Updated by another workstation.
     C*
     C           *IN02     IFEQ '0'
     C           *IN11     OREQ '1'
     C                     EXSR MADEIN
     C                     END
     C*
     C**   Copy fields from LF/TRANS for all action codes
     C*
     C                     MOVE PMRKT     SMRKT
     C                     MOVE ISTT      SISTC
     C                     MOVE ZMNM,MTHN SMTHN
     C                     MOVE YRNO      SYRNO
     C                     MOVE PCAL      SPCAL
     C                     MOVE TRTY      STRTY
     C*
     C                     Z-ADD5         ZADIG
     C                     Z-ADD0         ZADEC
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE NUCO      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNUCO
     C*
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE NOCO      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNOCO
     C*
     C***********          MOVE BRCD      SBRCD                           S01117
     C                     MOVE BRCA      SBRCA                           S01117
     C/COPY WNCPYSRC,FF0040C006
     C***********          Z-ADDCOPR      COPRS  117                      CFF004
     C           *LIKE     DEFN COPR      COPRS                           CFF004
     C                     Z-ADDCOPR      COPRS                           CFF004
     C*
     C**   Strike Price must be formatted via FFPRCS SR.
     C*
     C***********          Z-ADDSTRP      WSTRP  117                      CFF004
     C/COPY WNCPYSRC,FF0040C007
     C           *LIKE     DEFN STRP      WSTRP                           CFF004
     C                     Z-ADDSTRP      WSTRP                           CFF004
     C                     Z-ADDSTRP      FFPRIC
     C                     Z-ADDTKDMX     FFTKDM
     C                     Z-ADDMNPFX     FFMNPF
     C                     EXSR FFPRCS
     C                     MOVE FFSPRC    SSTRP
     C/COPY WNCPYSRC,FF0040C008
     C***********          Z-ADDSTRP      STRPS  117                      CFF004
     C/COPY WNCPYSRC,FF0040C009
     C           *LIKE     DEFN STRP      STRPS                           CFF004
     C                     Z-ADDSTRP      STRPS                           CFF004
     C**   Portfolio management module is installed                       S71062
     C**   Or Private Banking Module is installed                         CPB001
     C*                                                                   S71062
     C           BGPFMG    IFEQ 'Y'                        *B1            S71062
     C*                                                                   CPM003
     C** If Bank Portfolios are supported, treat as if PM off             CPM003
     C*                                                                   CPM003
     C           FCPORS    ANDNE'B'                                       CPM003
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S71062
     C**   Portfolio reference is not equal blanks                        S71062
     C           PTFR      IFNE *BLANKS                    **B2           S71062
     C*                                                                   S71062
     C           PTFR      IFNE '9997'                     ***B3          S71062
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVELPTFR      SPTFR                           S71062
     C                     ELSE                            ***X3          S71062
     C                     MOVELFCR997    SPTFR                           S71062
     C                     END                             ***E3          S71062
     C*                                                                   S71062
     C                     ELSE                            **X2           S71062
     C                     MOVEL*BLANKS   SPTFR                           S71062
     C                     END                             **E2           S71062
     C*                                                                   S71062
     C                     END                             *E1            S71062
     C*                                                                   S71062
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   MADEIN SR. - Initialise Screen details                        *
     C**   ~~~~~~~~~~   (Mkt Inst. - A/D/E/Rec Upd by another Wkstn)     *
     C**                                                                 *
     C**      Called From                  Calls                         *
     C**       SR. MKIINT                   SR. FFPRCS                   *
     C**                                    SR. ZDATE2                   *
     C**                                    SR. ZEDIT                    *
     C**                                    SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           MADEIN    BEGSR                           ** MADEIN SR **
     C*
     C**   Discover if 'End of Centre Processed ind.' = 'N'
     C*
     C           ECPI      IFEQ 'N'
     C                     SETON                     65
     C                     END
     C*
     C**   Set up fields which come from the LF/TRANS record for the
     C**   exercise, this record has already been accessed.
     C*
     C                     Z-ADD5         ZADIG
     C                     Z-ADD0         ZADEC
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE NUCO      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNCTE
     C*
     C                     MOVE NUCO      WNCTE
     C                     MOVE TRSD      OTRSD
     C                     MOVE TRSD      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     STRSD
     C                     MOVE TNAR      STNAR
     C*
     C**   Exercise Price must be formatted via FFPRCS SR.
     C*
     C                     Z-ADDCOPR      FFPRIC
     C                     Z-ADDTKDMX     FFTKDM
     C                     Z-ADDMNPFX     FFMNPF
     C                     EXSR FFPRCS
     C                     MOVE FFSPRC    SEXPR
     C                     MOVE CLSR      SCLSR
     C*
     C**   Access TRSET record
     C*
     C           KTNBR     CHAINTRSETIN              71
     C  N71N72   RECI      COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '12'      DBASE            ***************S01117
     C                     Z-ADD12        DBASE            ***************S01117
     C                     MOVE 'TRSET'   DBFILE           * DB ERROR 12 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Initialise Broker Settlement Details
     C*
     C                     Z-ADDFFCDP     ZADEC   10
     C           13        SUB  FFCDP     ZADIG   20
     C*
     C           *IN14     IFEQ '1'
     C*
     C**   Commission codes are taken from file if non-zero
     C*
     C           BCMC      IFNE 0
     C                     MOVE BCMC      SBCMC
     C                     END
     C*
     C           BCMS      IFNE 0
     C                     MOVE BCMS      SBCMS
     C                     END
     C*
     C**   Commission amount is taken from file if non-zero
     C*
     C           BCMA      IFEQ 0
     C*
     C**   If it is zero and Commission pattern is 'A', amount is 'A'
     C*
     C           BCPT      IFEQ 'A'
     C                     MOVEL'A'       SBCMA
     C                     END
     C*
     C                     ELSE
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE BCMA      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SBCMA
     C                     END
     C*
     C**   Charge code is taken from file if non-zero
     C*
     C           BCHC      IFNE 0
     C                     MOVE BCHC      SBCHC
     C                     END
     C*
     C**   Charge amount is taken from file if non-zero
     C*
     C           BCHA      IFNE 0
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE BCHA      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SBCHA
     C                     END
     C*
     C**   Settlement type is taken from the file
     C*
     C                     MOVE BSLT      SBSLT
     C                     MOVE BSLT      BSLTS   20
     C**********           MOVE BSLA      BSLAS  12                                           CGL029
     C                     MOVE BSLA      BSLAS  18                                           CGL029
     C                     MOVE BSBR      BSBRS   3                       S01117
     C*
     C**   Settlement account is taken from the file unless settlement
     C**   type is 04,06 or 15. In these cases it is blank
     C*
     C           BSLT      IFEQ 04
     C           BSLT      OREQ 06
     C           BSLT      OREQ 15
     C                     MOVE *BLANK    SBSLA
     C                     ELSE
     C                     MOVE BSLA      SBSLA
     C                     END
     C*                                                                   S01117
     C**   Settlement branch are taken from the file unless settlement    S01117
     C**   type is 04, 06, 15 or is not multibranch.  In these cases      S01117
     C**   it is blank                                                    S01117
     C*                                                                   S01117
     C           PMBIN     IFNE 'Y'                                       S01117
     C           BSLT      OREQ 04                                        S01117
     C           BSLT      OREQ 06                                        S01117
     C           BSLT      OREQ 15                                        S01117
     C                     MOVE *BLANK    SBSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE BSBR      SBSBR                           S01117
     C                     END                                            S01117
     C*
     C**   For Account of and Counterparty come from file
     C*
     C                     MOVE BFAO      SBFAO
     C                     MOVELBCPN      SBCPN
     C                     END
     C*
     C**   Initialise Customer Settlement Details
     C*
     C           *IN15     IFEQ '1'
     C*
     C**   Commission codes are taken from file if non-zero
     C*
     C           CCMC      IFNE 0
     C                     MOVE CCMC      SCCMC
     C                     END
     C*
     C           CCMS      IFNE 0
     C                     MOVE CCMS      SCCMS
     C                     END
     C*
     C**   Commission amount is taken from file if non-zero
     C*
     C           CCMA      IFEQ 0
     C*
     C**   If it is zero and Commission pattern is 'A', amount is 'A'
     C*
     C           CCPT      IFEQ 'A'
     C                     MOVEL'A'       SCCMA
     C                     END
     C*
     C                     ELSE
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE CCMA      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SCCMA
     C                     END
     C*
     C**   Charge code is taken from file if non-zero
     C*
     C           CCHC      IFNE 0
     C                     MOVE CCHC      SCCHC
     C                     END
     C*
     C**   Charge amount is taken from file if non-zero
     C*
     C           CCHA      IFNE 0
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE CCHA      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SCCHA
     C                     END
     C*
     C**   Settlement type is taken from the file
     C*
     C                     MOVE CSLT      SCSLT
     C                     MOVE CSLT      CSLTS   20
     C**********           MOVE CSLA      CSLAS  12                                           CGL029
     C                     MOVE CSLA      CSLAS  18                                           CGL029
     C                     MOVE BRSC      BRSCS   3                       S01117
     C*
     C**   Settlement account is taken from the file unless settlement
     C**   type is 04,06 or 15. In these cases it is blank
     C*
     C           CSLT      IFEQ 04
     C           CSLT      OREQ 06
     C           CSLT      OREQ 15
     C                     MOVE *BLANK    SCSLA
     C                     ELSE
     C                     MOVE CSLA      SCSLA
     C                     END
     C*                                                                   S01117
     C**   Settlement branch are taken from the file unless settlement    S01117
     C**   type is 04, 06, 15 or is not multibranch.  In these cases      S01117
     C**   it is blank                                                    S01117
     C*                                                                   S01117
     C           PMBIN     IFNE 'Y'                                       S01117
     C           CSLT      OREQ 04                                        S01117
     C           CSLT      OREQ 06                                        S01117
     C           CSLT      OREQ 15                                        S01117
     C                     MOVE *BLANK    SCSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE BRSC      SCSBR                           S01117
     C                     END                                            S01117
     C*
     C**   For Account of and Counterparty come from file
     C*
     C                     MOVE CFAO      SCFAO
     C                     MOVELCCPN      SCCPN
     C                     END
     C*
     C**   Access LF/TRANS record for Trade, using closure reference
     C**   from exercise record.
     C*
     C           *IN11     IFEQ '0'
     C           CLSR      ORNE *ZEROS
     C                     MOVE CLSR      KTNBR
     C           KTNBR     CHAINTRANSIN              71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '13'      DBASE            ***************S01117
     C                     Z-ADD13        DBASE            ***************S01117
     C                     MOVE 'TRANS'   DBFILE           * DB ERROR 13 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C                     END
     C*
     C**   Broker, Customer and Book
     C*
     C                     MOVELBOCO      SBOCO
     C********** BOCO      IFEQ *ZEROS                                                        CSD027
     C           BOCO      IFEQ *BLANKS                                                       CSD027
     C                     MOVE *BLANKS   SBOCO
     C                     END
     C*
     C                     MOVELCUSC      SCUSC
     C********** CUSC      IFEQ *ZEROS                                                        CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE *BLANKS   SCUSC
     C                     END
     C                     MOVE BOKC      SBOKC
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   OTCINT SR. - Initialise Screen details (O.T.C.)               *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSOTC                   SR. FFPRCS                   *
     C**       SR. ADEOTC                   SR. FFSTDP                   *
     C**       SR. RUDBAW                   SR. OADEIN                   *
     C**                                    SR. ZEDIT                    *
     C**                                    SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           OTCINT    BEGSR                           ** OTCINT SR **
     C*
     C**   Determine Instrument Currency dec. places
     C*
     C                     MOVE ISCY      FFCCY   3
     C                     EXSR FFSTDP
     C*
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C***********          MOVE '14'      DBASE            * DB ERROR 14 *S01117
     C                     Z-ADD14        DBASE            * DB ERROR 14 *S01117
     C                     MOVE 'TABFF'   DBFILE           ***************
     C                     MOVELFFCKY     DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C**   Save fields for later Price validation
     C*
     C                     Z-ADDTKDM      TKDMX   30
     C                     Z-ADDTKVL      TKVLX  115
     C/COPY WNCPYSRC,FF0040C010
     C***********          Z-ADDMNPF      MNPFX  117                      CFF004
     C/COPY WNCPYSRC,FF0040C011
     C** MNPFX Previously Defined.                                        CFF004
     C                     Z-ADDMNPF      MNPFX                           CFF004
     C*
     C**   Set up fields for display for Amend/Delete/Enquire or Record
     C**   Updated by another workstation.
     C*
     C           *IN02     IFEQ '0'
     C           *IN11     OREQ '1'
     C                     EXSR OADEIN
     C                     END
     C*
     C**   Copy fields from LF/TRANS for all action codes
     C*
     C                     MOVE ISTT      SISTT
     C                     MOVE PCAL      SPCAL
     C                     MOVE TRTY      STRTY
     C*
     C                     Z-ADD5         ZADIG
     C                     Z-ADD0         ZADEC
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE NUCO      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNUCO
     C*
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE NOCO      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNOCO
     C*
     C***********          MOVE BRCD      SBRCD                           S01117
     C                     MOVE BRCA      SBRCA                           S01117
     C                     Z-ADDCOPR      COPRS
     C*
     C**   Strike Price must be formatted via FFPRCS SR.
     C*
     C                     Z-ADDSTRP      WSTRP
     C                     Z-ADDSTRP      FFPRIC
     C                     Z-ADDTKDMX     FFTKDM
     C                     Z-ADDMNPFX     FFMNPF
     C                     EXSR FFPRCS
     C                     MOVE FFSPRC    SSTRP
     C/COPY WNCPYSRC,FF0040C012
     C***********          Z-ADDSTRP      STRPS  117                      CFF004
     C/COPY WNCPYSRC,FF0040C013
     C                     Z-ADDSTRP      STRPS                           CFF004
     C**   Portfolio management module is installed                       S71062
     C**   Or Private Banking Module is installed                         CPB001
     C*                                                                   S71062
     C           BGPFMG    IFEQ 'Y'                        *B1            S71062
     C           FCPORS    ANDNE'B'                                       CPM003
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S71062
     C**   Portfolio reference is not equal blanks                        S71062
     C           PTFR      IFNE *BLANKS                    **B2           S71062
     C*                                                                   S71062
     C           PTFR      IFNE '9997'                     ***B3          S71062
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVELPTFR      SPTFR                           S71062
     C                     ELSE                            ***X3          S71062
     C                     MOVELFCR997    SPTFR                           S71062
     C                     END                             ***E3          S71062
     C*                                                                   S71062
     C                     ELSE                            **X2           S71062
     C                     MOVEL*BLANKS   SPTFR                           S71062
     C                     END                             **E2           S71062
     C*                                                                   S71062
     C                     END                             *E1            S71062
     C*                                                                   S71062
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   OADEIN SR. - Initialise Screen details                        *
     C**   ~~~~~~~~~~   (O.T.C. - A/D/E/Rec Upd by another Wkstn)        *
     C**      Called From                  Calls                         *
     C**       SR. OTCINT                   SR. FFPRCS                   *
     C**                                    SR. ZDATE2                   *
     C**                                    SR. ZEDIT                    *
     C**                                    SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           OADEIN    BEGSR                           ** OADEIN SR **
     C*
     C**   Discover if 'End of Centre Processed ind.' = 'N'
     C*
     C           ECPI      IFEQ 'N'
     C                     SETON                     65
     C                     END
     C*
     C**   Set up fields which come from the LF/TRANS record for the
     C**   exercise, this record has already been accessed.
     C*
     C                     Z-ADD5         ZADIG
     C                     Z-ADD0         ZADEC
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE NUCO      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNCTE
     C*
     C                     MOVE NUCO      WNCTE
     C                     MOVE TRSD      OTRSD
     C                     MOVE TRSD      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     STRSD
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP18                                           S01408
     C*                                                                   S01408
     C           CFF003    IFEQ 'Y'                                       CFF003
     C                     MOVE VALD      OVALD                           CFF003
     C                     MOVE VALD      ZDAYNO                          CFF003
     C                     EXSR ZDATE2                                    CFF003
     C                     MOVE ZDATE     SVALD                           CFF003
     C                     ENDIF                                          CFF003
     C*                                                                   CFF003
     C                     MOVE TNAR      STNAR
     C*
     C**   Exercise Price must be formatted via FFPRCS SR.
     C*
     C                     Z-ADDCOPR      FFPRIC
     C                     Z-ADDTKDMX     FFTKDM
     C                     Z-ADDMNPFX     FFMNPF
     C                     EXSR FFPRCS
     C                     MOVE FFSPRC    SEXPR
     C                     MOVE CLSR      SCLSR
     C*
     C**   Access TRSET record
     C*
     C           KTNBR     CHAINTRSETIN              71
     C**N71******RECI      COMP 'D'                  7171                 HK0000
     C  N71N72   RECI      COMP 'D'                  7171                 HK0000
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '15'      DBASE            ***************S01117
     C                     Z-ADD15        DBASE            ***************S01117
     C                     MOVE 'TRSET'   DBFILE           * DB ERROR 15 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Initialise Customer Settlement Details
     C*
     C                     Z-ADDFFCDP     ZADEC   10
     C           13        SUB  FFCDP     ZADIG   20
     C*
     C**   Commission codes are taken from file if non-zero
     C*
     C           CCMC      IFNE 0
     C                     MOVE CCMC      SCCMC
     C                     END
     C*
     C           CCMS      IFNE 0
     C                     MOVE CCMS      SCCMS
     C                     END
     C*
     C**   Commission amount is taken from file if non-zero
     C*
     C           CCMA      IFEQ 0
     C*
     C**   If it is zero and Commission pattern is 'A', amount is 'A'
     C*
     C           CCPT      IFEQ 'A'
     C                     MOVEL'A'       SCCMA
     C                     END
     C*
     C                     ELSE
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE CCMA      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SCCMA
     C                     END
     C*
     C**   Charge code is taken from file if non-zero
     C*
     C           CCHC      IFNE 0
     C                     MOVE CCHC      SCCHC
     C                     END
     C*
     C**   Charge amount is taken from file if non-zero
     C*
     C           CCHA      IFNE 0
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE CCHA      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SCCHA
     C                     END
     C*
     C**   Settlement type is taken from the file
     C*
     C                     MOVE CSLT      SCSLT
     C                     MOVE CSLT      CSLTS
     C                     MOVE CSLA      CSLAS
     C                     MOVE BRSC      BRSCS                           S01117
     C*
     C**   Settlement account is taken from the file unless settlement
     C**   type is 04,06 or 15. In these cases it is blank
     C*
     C           CSLT      IFEQ 04
     C           CSLT      OREQ 06
     C           CSLT      OREQ 15
     C                     MOVE *BLANK    SCSLA
     C                     ELSE
     C                     MOVE CSLA      SCSLA
     C                     END
     C*                                                                   S01117
     C**   Settlement branch are taken from the file unless settlement    S01117
     C**   type is 04, 06, 15 or is not multibranch.  In these cases      S01117
     C**   it is blank                                                    S01117
     C*                                                                   S01117
     C           PMBIN     IFNE 'Y'                                       S01117
     C           CSLT      OREQ 04                                        S01117
     C           CSLT      OREQ 06                                        S01117
     C           CSLT      OREQ 15                                        S01117
     C                     MOVE *BLANK    SCSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE BRSC      SCSBR                           S01117
     C                     END                                            S01117
     C*
     C**   For Account of and Counterparty come from file
     C*
     C                     MOVE CFAO      SCFAO
     C                     MOVELCCPN      SCCPN
     C*
     C**   Access LF/TRANS record for Trade, using closure reference
     C**   from exercise record.
     C*
     C                     MOVE CLSR      KTNBR
     C           KTNBR     CHAINTRANSIN              71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '16'      DBASE            ***************S01117
     C                     Z-ADD16        DBASE            ***************S01117
     C                     MOVE 'TRANS'   DBFILE           * DB ERROR 16 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Customer and Book
     C*
     C                     MOVELCUSC      SCUSC
     C********** CUSC      IFEQ *ZEROS                                                        CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE *BLANKS   SCUSC
     C                     END
     C                     MOVE BOKC      SBOKC
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INSVL1 SR. -  Validate Insert secondary screen                *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSCTL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           INSVL1    BEGSR                           ** INSVL1 SR **
     C*
     C**   Reset Processing
     C*
     C                     SETOF                     182238
     C                     SETOF                     72
     C                     Z-ADD0         E       20
     C                     MOVE *BLANK    ERR
     C*
     C**   Validate Transaction Reference
     C*
     C                     MOVELSTNBR     WTSTN7
     C                     TESTN          WTSTN7     74
     C*
     C**   Error if not numeric or if equal to zero
     C*
     C           *IN74     IFEQ '0'
     C           STNBR     OREQ '000000'
     C           E         ADD  1         E
     C                     MOVE ' 014'    ERR,E
     C                     SETON                     1822
     C                     ELSE
     C*
     C**   Error if record already exists
     C*
     C                     MOVE STNBR     KTNBR   60
     C           KTNBR     CHAINTRANS2               71
     C*
     C           *IN71     IFEQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 015'    ERR,E
     C                     SETON                     1822
     C                     END
     C*
     C                     END
     C*
     C**   Validate Closure Reference
     C*
     C                     MOVELSCLSR     WTSTN7
     C                     TESTN          WTSTN7     74
     C*
     C**   Error if not numeric or if equal to zero
     C*
     C           *IN74     IFEQ '0'
     C           SCLSR     OREQ '000000'
     C           E         ADD  1         E
     C                     MOVE ' 020'    ERR,E
     C                     SETON                     1838
     C                     ELSE
     C*
     C**   Error if LF/TRANS record doesn't exist or isn't live
     C*
     C                     MOVE SCLSR     KTNBR   60
     C           KTNBR     CHAINTRANSIN              71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C           *IN71     IFEQ '1'
     C           E         ADD  1         E
     C                     MOVE ' 021'    ERR,E
     C                     SETON                     1838
     C*
     C                     ELSE
      *                                                                   S01117
      **   SPF checking on booking branch when MBIN = Y                   S01117
      *                                                                   S01117
     C           PMBIN     IFEQ 'Y'                                       S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM 'I'       @ZACTN  1                       S01117
     C                     PARM BRCA      @ZBR    3                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE 0                                         S01117
     C                     ADD  1         E                               S01117
     C                     MOVE ' 305'    ERR,E                           S01117
     C                     SETON                     1838                 S01117
     C                     ELSE                                           S01117
      *                                                                   S01117
      **  SPF checking on originating branch when MBIN = Y and            S01117
      **  originating branch used and validated = Y                       S01117
      *                                                                   S01117
     C           BKOBRU    IFEQ 'Y'                                       S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM ORBR      @ZBR    3                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE 0                                         S01117
     C                     ADD  1         E                               S01117
     C                     MOVE ' 308'    ERR,E                           S01117
     C                     SETON                     1838                 S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     MOVE TRSD      TRSDS   50
     C*                                                                   S01117
     C**   If no error in SPF checking on Closure Reference               S01117
     C*                                                                   S01117
     C           *IN38     IFEQ '0'                                       S01117
     C*
     C**   Transaction type must be 'P' or 'S'
     C*
     C           TRTY      IFNE 'P'
     C           TRTY      ANDNE'S'
     C           E         ADD  1         E
     C                     MOVE ' 022'    ERR,E
     C                     SETON                     1838
     C                     END
     C*
     C**   Put/Call indicator must be 'P' or 'C'
     C*
     C           PCAL      IFNE 'P'
     C           PCAL      ANDNE'C'
     C           E         ADD  1         E
     C                     MOVE ' 023'    ERR,E
     C                     SETON                     1838
     C                     END
     C*
     C**   Number of open contracts must be greater than zero
     C*
     C           NOCO      IFLE 0
     C           E         ADD  1         E
     C                     MOVE ' 024'    ERR,E
     C                     SETON                     1838
     C                     END
     C*                                                                   S01117
     C                     END                                            S01117
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   ADEVL1 SR. -  Validate Amd/Del/Enq secondary screen           *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. ADECTL                   SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           ADEVL1    BEGSR                           ** ADEVL1 SR **
     C*
     C**   Reset Processing
     C*
     C                     SETOF                     1415
     C                     SETOF                     182272
     C                     Z-ADD0         E       20
     C                     MOVE *BLANK    ERR
     C*
     C**   Validate Transaction Reference
     C*
     C                     MOVELSTNBR     WTSTN7
     C                     TESTN          WTSTN7     74
     C*
     C**   Error if not numeric or if equal to zero
     C*
     C           *IN74     IFEQ '0'
     C           STNBR     OREQ '000000'
     C           E         ADD  1         E
     C                     MOVE ' 014'    ERR,E
     C                     SETON                     1822
     C                     GOTO AVLEND
     C                     END
     C*
     C**   Error if record doesn't exist
     C*
     C                     MOVE STNBR     KTNBR   60
     C           KTNBR     CHAINTRANSIN              71
     C*
     C**   Error if record isn't live unless SACTN = 'E'
     C*
     C           *IN71     IFEQ '0'
     C           SACTN     IFEQ 'E'
     C           RECI      COMP '*'                      72
     C*                                                                   E27760
     C** Check if record ID is 'R' as system changes the record ID        E27760
     C** of a deleted trade to 'R' during COB                             E27760
     C*                                                                   E27660
     C           *IN72     IFEQ '0'                                       E27760
     C           RECI      ANDEQ'R'                                       E27760
     C                     MOVE '1'       *IN72                           E27760
     C                     END                                            E27760
     C                     ELSE
     C           RECI      COMP 'D'                  7171
     C                     END
     C                     END
     C*
     C**   Set up error codes etc.
     C*
     C           *IN71     IFEQ '1'
     C           E         ADD  1         E
     C                     MOVE ' 016'    ERR,E
     C                     SETON                     1822
     C                     GOTO AVLEND
     C                     END
      *                                                                   S01117
      **   SPF checking on booking branch when MBIN = Y                   S01117
      *                                                                   S01117
     C           PMBIN     IFEQ 'Y'                                       S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM SACTN     @ZACTN  1                       S01117
     C                     PARM BRCA      @ZBR    3                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE 0                                         S01117
     C                     ADD  1         E                               S01117
     C                     MOVE ' 304'    ERR,E                           S01117
     C                     SETON                     1822                 S01117
     C                     GOTO AVLEND                                    S01117
     C                     END                                            S01117
      *                                                                   S01117
      **  SPF checking on originating branch when MBIN = Y and            S01117
      **  originating branch used and validated = Y and                   S01117
      **  action not = E                                                  S01117
      *                                                                   S01117
     C           BKOBRU    IFEQ 'Y'                                       S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C           SACTN     ANDNE'E'                                       S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM ORBR      @ZBR    3                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE 0                                         S01117
     C                     ADD  1         E                               S01117
     C                     MOVE ' 307'    ERR,E                           S01117
     C                     SETON                     1822                 S01117
     C                     GOTO AVLEND                                    S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C*
     C**   Save  Date, Type and No. of last change to Exercise
     C*
     C                     Z-ADDLCD       XLCD    50
     C                     MOVE CHTP      XCHTP   1
     C                     Z-ADDTNLU      XTNLU   50
     C*
     C**   Access LF/INTYP record
     C*
     C                     MOVE ISTT      KISTT
     C           KISTT     CHAININTYP                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '17'      DBASE            ***************S01117
     C                     Z-ADD17        DBASE            ***************S01117
     C                     MOVE 'INTYP'   DBFILE           * DB ERROR 17 *
     C                     MOVELKISTT     DBKEY            ***************
     C                     EXSR DBERR
     C*
     C                     ELSE
     C                     MOVE BCPT      BCPTX   1
     C                     MOVE CCPT      CCPTX   1
     C                     END
     C*
     C**   Transaction type must be 'E'
     C*
     C           TRTY      IFNE 'E'
     C           E         ADD  1         E
     C                     MOVE ' 017'    ERR,E
     C                     SETON                     1822
     C                     END
     C*
     C**   Check if Broker and/or Customer present for trade
     C*
     C********** BOCO      IFNE *ZEROS                                                        CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     SETON                     14
     C                     END
     C*
     C********** CUSC      IFNE *ZEROS                                                        CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     SETON                     15
     C                     END
     C*
     C           AVLEND    ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   INSVL2 SR. -  Validate Insert main detail screen              *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. INSMKI                   SR. CUSTVL                   *
     C**       SR. INSOTC                   SR. BROKVL                   *
     C**                                    SR. FFPRCS                   *
     C**                                    SR. FFPRVL                   *
     C**                                    SR. ZALIGN                   *
     C**                                    SR. ZEDIT                    *
     C**                                    SR. ZDATE1                   *
     C**                                    SR. ZDATE2                   *
     C**************************************SR.*ZDATE5********************S01195
     C**                                    SR. ZCHKH                    *S01195
     C**                                                                 *
     C********************************************************************
     C*
     C           INSVL2    BEGSR                           ** INSVL2 SR **
     C*
     C**   Reset processing
     C*
     C                     SETOF                     1874
     C                     Z-ADD0         E
     C                     MOVE *BLANK    ERR
     C*
     C**   Validate Customer code
     C*
     C                     MOVE *BLANKS   WCUSC  10
     C                     MOVE SCUSC     WCUSC
     C*
     C*****Chain*LF/SNAME*in*case*Shortname*has*been*entered**************S01117
     C**   Call AOCUSTR0 in case Shortname has been entered               S01117
     C*
     C           WCUSC     IFNE *BLANKS
     C***********WCUSC     CHAINSNAME                71                   S01117
     C*                                                                   S01117
     C                     CALL 'AOCUSTR0'                                S01117
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM WCUSC     @KEY1  10                       S01117
     C                     PARM           @KYST   7                       S01117
     C           SDCUST    PARM SDCUST    DSSDY                           S01117
     C*
     C**   If record is found, use the customer number from the record
     C*
     C************IN71     IFEQ '0'                                       S01117
     C           @RTCD     IFEQ '*NOSEL'                                  S01117
     C                     SETON                     36                   S01117
     C                     ELSE                                           S01117
     C*                                                                   S01117
     C           @RTCD     IFEQ *BLANK                                    S01117
     C*                                                                   S01117
     C           @KYST     IFEQ '*CNUM'                                   S01117
     C                     MOVE *BLANKS   SCUSC                           S01117
     C                     MOVELCNUMS     SCUSC                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     MOVE *BLANKS   WCUSC
     C***********          MOVELCNUM      WCUSC                           S01117
     C                     MOVELCNUMS     WCUSC                           S01117
     C                     MOVELBBCRPC    WLCRPC  1                                           CSD015
     C                     MOVELBBLICD    WLLICD  3                                           CSD015
     C                     MOVELBBCRNM    WLCRNM 20                                           CSD015
     C                     MOVELBBCRTN    WLCRTN 10                                           CSD015
     C                     MOVELCNUMS     WLCUST  6                                           CSD015
     C*
     C**   Otherwise check that entry is numeric, error if not
     C*
     C                     ELSE
     C                     MOVELWCUSC     WTSTN7
     C                     MOVE '0'       WTSTN7
     C                     MOVE WCUSC     WRK4A   4
     C************         TESTN          WTSTN7     74    *                                  CSD027
     C*
     C************IN74     IFEQ '0'                                                           CSD027
     C***********WRK4A     ORNE *BLANK                                                        CSD027
     C************         SETON                     33                                       CSD027
     C************         END                                                                CSD027
     C           WRK4A     IFNE *BLANKS                                                       CSD027
     C                     SETON                     33                                       CSD027
     C                     END                                                                CSD027
     C*
     C                     END
     C                     END                                            S01117
     C*
     C**   If Customer code entered is blank, zero is assumed
     C*
     C                     ELSE
     C*************        MOVEL'000000'  WCUSC                                               CSD027
     C                     MOVEL*BLANKS   WCUSC                                               CSD027
     C                     END
     C*
     C**   Compare resultant Customer number with CUSC on LF/TRANS
     C*
     C           *IN33     IFEQ '0'
     C           *IN36     ANDEQ'0'                                       S01117
     C**********           MOVELWCUSC     WCUST   60                                          CSD027
     C                     MOVELWCUSC     WCUST   6                                           CSD027
     C*
     C           CUSC      IFNE WCUST
     C                     SETON                     33
     C                     END
     C*
     C                     END
     C*
     C**   If they do not match, set up error code
     C*
     C           *IN33     IFEQ '1'
     C                     SETON                     18
     C                     ADD  1         E
     C                     MOVEL' 041'    ERR,E
     C                     END
     C*                                                                   S01117
     C           *IN36     IFEQ '1'                                       S01117
     C                     SETON                     1833                 S01117
     C                     ADD  1         E                               S01117
     C                     MOVEL' 042'    ERR,E                           S01117
     C                     END                                            S01117
     C*
     C**   Validate Book code
     C*
     C                     CALL 'AOBOOKR0'                                S01117
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM SBOKC     @A1CD  10                       S01117
     C           SDBOOK    PARM SDBOOK    @DSFDY                          S01117
     C*                                                                   S01117
     C           @RTCD     IFEQ '*NOSEL'                                  S01117
     C                     SETON                     1834                 S01117
     C                     ADD  1         E                               S01117
     C                     MOVEL' 052'    ERR,E                           S01117
     C                     ELSE                                           S01117
     C*                                                                   S01117
     C           @RTCD     IFEQ *BLANK                                    S01117
     C                     MOVE BDBKCD    SBOKC                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C           BOKC      IFNE SBOKC
     C                     SETON                     1834
     C                     ADD  1         E
     C                     MOVEL' 051'    ERR,E
     C                     END
     C*                                                                   S01117
     C                     END                                            S01117
     C*
     C**   Validate Number of Contracts to Exercise
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVELSNCTE     ZFIELD
     C                     Z-ADD5         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR ZALIGN
     C*
     C**   Error if it's invalid or if entry was blank or zero
     C*
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C           E         ADD  1         E
     C                     MOVE ' 061'    ERR,E
     C                     SETON                     1835
     C*
     C**   If it's valid, check that it is not greater than the number
     C**   of open contracts for the Trade
     C*
     C                     ELSE
     C                     MOVE ZFIELD    WNCTE   50
     C*
     C           WNCTE     IFGT NOCO
     C           E         ADD  1         E
     C                     MOVE ' 062'    ERR,E
     C                     SETON                     1835
     C*
     C                     ELSE
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNCTE
     C                     END
     C*
     C                     END
     C*
     C**   Validate Exercise Price
     C*
     C**   Set up fields for SR. FFPRVL
     C*
     C                     Z-ADDTKDMX     FFTKDM
     C                     MOVE SEXPR     FFSPRC
     C                     Z-ADDMNPFX     FFMNPF
     C                     EXSR FFPRVL
     C/COPY WNCPYSRC,FF0040C014
     C***********          Z-ADDFFPRIC    WEXPR  117                      CFF004
     C/COPY WNCPYSRC,FF0040C015
     C           *LIKE     DEFN MNPF      WEXPR                           CFF004
     C                     Z-ADDFFPRIC    WEXPR                           CFF004
     C*
     C**   Error if *IN89 is set on in routine
     C*
     C           *IN89     IFEQ '1'
     C           E         ADD  1         E
     C                     MOVE ' 072'    ERR,E
     C                     SETON                     1830
     C                     SETOF                     89
     C*
     C**   Error if output from routine is zero
     C*
     C                     ELSE
     C           WEXPR     IFEQ *ZERO
     C           E         ADD  1         E
     C                     MOVE ' 071'    ERR,E
     C                     SETON                     1830
     C*
     C                     ELSE
     C                     Z-ADDFFPRIC    FFPRIC
     C                     Z-ADDMNPFX     FFMNPF
     C                     Z-ADDTKDMX     FFTKDM
     C                     EXSR FFPRCS
     C                     MOVE FFSPRC    SEXPR
     C                     END
     C*
     C                     END
     C*
     C**   Validate Transaction Date
     C*
     C**   If blank, defaults to today
     C*
     C           STRSD     IFEQ *BLANKS
     C                     MOVE CTDATE    OTRSD
     C                     SETON                     78
     C                     MOVE CTDATE    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     STRSD
     C                     END
     C*
     C**   Check if entry is in valid date format
     C*
     C                     MOVELSTRSD     WTSTN7
     C                     TESTN          WTSTN7     75
     C*
     C           *IN75     IFEQ '1'
     C                     MOVE STRSD     ZDATE
     C                     EXSR ZDATE1
     C                     END
     C*
     C**   Error if entry isn't a valid date
     C*
     C           *IN99     IFEQ '1'
     C           *IN75     OREQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 081'    ERR,E
     C                     SETON                     1831
     C                     END
     C*
     C**   Check that Date entered is not in the future
     C*
     C           *IN31     IFEQ '0'
     C                     MOVE ZDAYNO    OTRSD   50
     C*
     C           OTRSD     IFGT CTDATE
     C           E         ADD  1         E
     C                     MOVE ' 082'    ERR,E
     C                     SETON                     1831
     C                     END
     C*
     C                     END
     C*
     C**   Check that Date entered is not a holiday
     C*
     C           *IN31     IFEQ '0'
     C*
     C           PMRKT     IFNE '  '
     C                     MOVE PMKLC     ZCCY
     C                     MOVE PMLOC     ZLOC                            S01195
     C                     ELSE
     C                     MOVE LOCY      ZCCY
     C                     MOVE BLOC      ZLOC                            S01195
     C                     END
     C*
     C*****Access*LF/TABLE*Holidays*record*via*ZDATE5*********************S01195
     C**   Call SR. ZCHKH to check if Date entered is a holiday           S01195
     C*
     C***********          MOVE 'N'       ZOPT                            S01195
     C***********          EXSR ZDATE5                                    S01195
     C                     EXSR ZCHKH                                     S01195
     C*
     C**   Set up error code if date is a holiday
     C*
     C************IN99     IFEQ '1'                                       S01195
     C           ZIND      IFEQ 'H'                                       S01195
     C           E         ADD  1         E
     C                     MOVE ' 083'    ERR,E
     C                     SETON                     1831
     C                     END
     C*
     C                     END
     C*
     C**   Must not be before start of Historical Data Period
     C*
     C           *IN31     IFEQ '0'
     C*
     C           OTRSD     IFLT STHDP
     C                     SETON                     1831
     C           E         ADD  1         E
     C                     MOVE ' 084'    ERR,E
     C                     END
     C*
     C                     END
     C*
     C**   Check that Date entered is not prior to Transaction date for
     C**   the Trade being exercised
     C*
     C           *IN31     IFEQ '0'
     C           OTRSD     COMP TRSD                   3178
     C*
     C           *IN31     IFEQ '1'
     C                     SETON                     18
     C           E         ADD  1         E
     C                     MOVE ' 085'    ERR,E
     C                     END
     C*
     C                     END
     C*
     C**   If the instrument is an OTC, set final transaction date to
     C**   that on LF/INTYP, otherwise calculate it via FFDATE SR.
     C*
     C           *IN31     IFEQ '0'
     C*
     C           PMRKT     IFEQ '  '
     C                     Z-ADDFTDT      FTDATE  50
     C*
     C                     ELSE
     C                     MOVE FTDF      FFDATC
     C                     MOVE MTHN      FFMTH
     C                     MOVE YRNO      FFYR
     C                     MOVE PMKLC     FFCCY1
     C                     MOVE PMLOC     FFLOC                           S01195
     C                     MOVE ISCY      FFCCY2
     C                     MOVE OTHC      FFCCY3
     C                     EXSR FFDATE
     C                     MOVE FFDAY     FTDATE
     C                     END
     C***********                                                         S71062
     C*****Transaction date must not be after final transaction date      S71062
     C***********                                                         S71062
     C***********OTRSD     IFGT FTDATE                                    S71062
     C***********          SETON                     1831                 S71062
     C***********E         ADD  1         E                               S71062
     C***********          MOVE ' 086'    ERR,E                           S71062
     C***********          END                                            S71062
     C*
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP19                                           S01408
     C*                                                                   S01408
     C** If OTC enhancements are not on                                   CFF003
     C*                                                                   CFF003
     C           CFF003    IFNE 'Y'                                       CFF003
     C*                                                                   FF0011
     C**   If the instrument is an OTC, set the settlement date to        FF0011
     C**   that on LF/INTYP, otherwise calculate it via FFDATE SR.        FF0011
     C*                                                                   FF0011
     C           *IN31     IFEQ '0'                                       FF0011
     C*                                                                   FF0011
     C           PMRKT     IFEQ '  '                                      FF0011
     C                     Z-ADDSETD      STDATE  50                      FF0011
     C*                                                                   FF0011
     C                     ELSE                                           FF0011
     C                     MOVE SEDF      FFDATC                          FF0011
     C                     MOVE MTHN      FFMTH                           FF0011
     C                     MOVE YRNO      FFYR                            FF0011
     C                     MOVE PMKLC     FFCCY1                          FF0011
     C                     MOVE PMLOC     FFLOC                           FF0011
     C                     MOVE ISCY      FFCCY2                          FF0011
     C                     MOVE OTHC      FFCCY3                          FF0011
     C                     EXSR FFDATE                                    FF0011
     C                     MOVE FFDAY     STDATE                          FF0011
     C                     END                                            FF0011
     C*                                                                   S71062
     C**   Transaction date must not be after final transaction date      S71062
     C*                                                                   S71062
     C           OTRSD     IFGT STDATE                                    S71062
     C           ISTI      ANDEQ'N'                                       S71062
     C           OTRSD     ORGT SETD                                      S71062
     C           ISTI      ANDEQ'Y'                                       S71062
     C                     SETON                     1831                 S71062
     C           E         ADD  1         E                               S71062
     C                     MOVE ' 086'    ERR,E                           S71062
     C                     END                                            S71062
     C*                                                                   FF0011
     C**   Transaction date must be equal to the settlement date for      FF0011
     C**   a European style option.                                       FF0011
     C*                                                                   FF0011
     C           AEIN      IFEQ 'E'                                       FF0011
     C********** OTRSD     ANDNESTDATE                             FF0011 192969
     C           OTRSD     ANDNEFTDATE                                    192969
     C                     SETON                     1831                 FF0011
     C           E         ADD  1         E                               FF0011
     C                     MOVE ' 087'    ERR,E                           FF0011
     C                     END                                            FF0011
     C*                                                                   FF0011
     C                     END                                            FF0011
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP20                                           S01408
     C*                                                                   S01408
     C** If OTC enhancements are on                                       CFF003
     C*                                                                   CFF003
     C                     ELSE                                           CFF003
     C*                                                                   CFF003
     C**   Transaction date must be equal to the final transaction date   CFF003
     C**   for a European style option.                                   CFF003
     C*                                                                   CFF003
     C           *IN31     IFEQ '0'                                       CFF003
     C*                                                                   CFF003
     C           AEIN      IFEQ 'E'                                       CFF003
     C           OTRSD     ANDNEFTDATE                                    CFF003
     C                     SETON                     1831                 CFF003
     C           E         ADD  1         E                               CFF003
     C                     MOVE ' 087'    ERR,E                           CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C**   Validate Value Date if OTC and Transaction Date is OK          CFF003
     C*                                                                   CFF003
     C                     Z-ADD*ZERO     OVALD   50                      CFF003
     C*                                                                   CFF003
     C           PMRKT     IFEQ '  '                                      CFF003
     C           *IN31     ANDEQ'0'                                       CFF003
     C*                                                                   CFF003
     C**   If blank, set equal to exercise (transaction) date             CFF003
     C*                                                                   CFF003
     C           SVALD     IFEQ *BLANK                                    CFF003
     C                     MOVELSTRSD     SVALD                           CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C**   Check if entry is in valid date format                         CFF003
     C*                                                                   CFF003
     C                     MOVELSVALD     WTSTN7                          CFF003
     C                     TESTN          WTSTN7     75                   CFF003
     C*                                                                   CFF003
     C           *IN75     IFEQ '1'                                       CFF003
     C                     MOVE SVALD     ZDATE                           CFF003
     C                     EXSR ZDATE1                                    CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C**   Error if entry isn't a valid date                              CFF003
     C*                                                                   CFF003
     C           *IN99     IFEQ '1'                                       CFF003
     C           *IN75     OREQ '0'                                       CFF003
     C           E         ADD  1         E                               CFF003
     C                     MOVE ' 091'    ERR,E                           CFF003
     C                     SETON                     1839                 CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C**   Check that Date entered is not a holiday                       CFF003
     C*                                                                   CFF003
     C           *IN39     IFEQ '0'                                       CFF003
     C*                                                                   CFF003
     C                     MOVE LOCY      ZCCY                            CFF003
     C                     MOVE BLOC      ZLOC                            CFF003
     C*                                                                   CFF003
     C**   Call SR. ZCHKH to check if Date entered is a holiday           CFF003
     C*                                                                   CFF003
     C                     EXSR ZCHKH                                     CFF003
     C*                                                                   CFF003
     C**   Set up error code if date is a holiday                         CFF003
     C*                                                                   CFF003
     C           ZIND      IFEQ 'H'                                       CFF003
     C           E         ADD  1         E                               CFF003
     C                     MOVE ' 092'    ERR,E                           CFF003
     C                     SETON                     1839                 CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C**   Check that Date entered is not prior to Transaction date       CFF003
     C*                                                                   CFF003
     C           *IN39     IFEQ '0'                                       CFF003
     C                     MOVE ZDAYNO    OVALD                           CFF003
     C*                                                                   CFF003
     C           OVALD     IFLT OTRSD                                     CFF003
     C                     SETON                     1839                 CFF003
     C           E         ADD  1         E                               CFF003
     C                     MOVE ' 093'    ERR,E                           CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C**   Value date must not be after the settlement date for           CFF003
     C**   an American style option.                                      CFF003
     C*                                                                   CFF003
     C           *IN39     IFEQ '0'                                       CFF003
     C*                                                                   CFF003
     C           AEIN      IFEQ 'A'                                       CFF003
     C           OVALD     ANDGTSETD                                      CFF003
     C                     SETON                     1839                 CFF003
     C           E         ADD  1         E                               CFF003
     C                     MOVE ' 094'    ERR,E                           CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C**   Value date must be equal to the settlement date for            CFF003
     C**   a European style option.                                       CFF003
     C*                                                                   CFF003
     C           *IN39     IFEQ '0'                                       CFF003
     C*                                                                   CFF003
     C           AEIN      IFEQ 'E'                                       CFF003
     C           OVALD     ANDNESETD                                      CFF003
     C                     SETON                     1839                 CFF003
     C           E         ADD  1         E                               CFF003
     C                     MOVE ' 095'    ERR,E                           CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C                     END                                            CFF003
     C*                                                                   CFF003
     C                     ENDIF                                          CFF003
     C*
     C*
     C**   Validate Customer Settlement Instructions
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           BGN4ST    ANDEQ'Y'                                       CFF007
     C                     MOVELCUSC      WWKY10                          CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*KEY   ' POPTN                           CFF007
     C                     PARM           WWKY10                          CFF007
     C                     PARM           @KYST                           CFF007
     C           SDCUST    PARM SDCUST    DSLDY                           CFF007
      *                                                                   CFF007
     C           PRTCD     IFNE *BLANKS                                   CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     MOVEL'SDCUSTPD'DBFILE           ************   CFF007
     C                     MOVELCUSC      DBKEY            * DBERR 36 *   CFF007
     C                     MOVEL*BLANKS   DBOPTN           ************   CFF007
     C                     Z-ADD36        DBASE                           CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C                     MOVELBBPRBA    WPCFLG                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C/COPY WNCPYSRC,FF0040C042
     C                     EXSR CUSTVL
     C                     END
     C*
     C**   Skip rest of routine for O.T.C's
     C*
     C           PMRKT     IFNE '  '
     C*
     C**   Validate Broker code
     C*
     C                     MOVE *BLANKS   WBOCO  10
     C                     MOVE SBOCO     WBOCO
     C*
     C**   If Broker code entered is blank or *, zero is assumed
     C*
     C           WBOCO     IFEQ *BLANKS
     C           SBOCO1    OREQ '*'
     C           SBOCO9    ANDEQ*BLANKS
     C***********          MOVEL'000000'  WBOCO                                               CSD027
     C                     MOVEL*BLANKS   WBOCO                                               CSD027
     C*
     C*****Chain*LF/SNAME*in*case*Shortname*has*been*entered**************S01117
     C**   Call AOCUSTR0 in case Shortname has been entered               S01117
     C*
     C                     ELSE
     C***********WBOCO     CHAINSNAME                71                   S01117
     C*                                                                   S01117
     C                     CALL 'AOCUSTR0'                                S01117
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM WBOCO     @KEY1  10                       S01117
     C                     PARM           @KYST   7                       S01117
     C           SDCUST    PARM SDCUST    DSSDY                           S01117
     C*
     C**   If record is found, use the customer number from the record
     C*
     C************IN71     IFEQ '0'                                       S01117
     C           @RTCD     IFEQ '*NOSEL'                                  S01117
     C                     SETON                     37                   S01117
     C                     ELSE                                           S01117
     C*                                                                   S01117
     C           @RTCD     IFEQ *BLANK                                    S01117
     C*                                                                   S01117
     C           @KYST     IFEQ '*CNUM'                                   S01117
     C                     MOVE *BLANKS   SBOCO                           S01117
     C                     MOVELCNUMS     SBOCO                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     MOVE *BLANKS   WBOCO
     C***********          MOVELCNUM      WBOCO                           S01117
     C                     MOVELCNUMS     WBOCO                           S01117
     C*
     C**   Otherwise check that entry is numeric, error if not
     C*
     C                     ELSE
     C                     MOVELWBOCO     WTSTN7
     C                     MOVE '0'       WTSTN7
     C                     MOVE WBOCO     WRK4A   4
     C                     TESTN          WTSTN7     74    *
     C*
     C************IN74     IFEQ '0'                                                           CSD027
     C***********WRK4A     ORNE *BLANK                                                        CSD027
     C           WRK4A     IFNE *BLANKS                                                       CSD027
     C                     SETON                     32
     C                     END
     C*
     C                     END
     C                     END                                            S01117
     C*
     C                     END
     C*
     C**   Compare resultant Broker number with BOCO on LF/TRANS
     C*
     C           *IN32     IFEQ '0'
     C           *IN37     ANDEQ'0'                                       S01117
     C**********           MOVELWBOCO     WBROK   60                                          CSD027
     C                     MOVELWBOCO     WBROK   6                                           CSD027
     C*
     C           BOCO      IFNE WBROK
     C                     SETON                     32
     C                     END
     C*
     C                     END
     C*
     C**   If they do not match, set up error code
     C*
     C           *IN32     IFEQ '1'
     C                     SETON                     18
     C                     ADD  1         E
     C                     MOVEL' 031'    ERR,E
     C                     END
     C*                                                                   S01117
     C           *IN37     IFEQ '1'                                       S01117
     C                     SETON                     1832                 S01117
     C                     ADD  1         E                               S01117
     C                     MOVEL' 032'    ERR,E                           S01117
     C                     END                                            S01117
     C*
     C**   Validate Broker Settlement Instructions
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           BGN4ST    ANDEQ'Y'                                       CFF007
     C                     MOVELBOCO      WWKY10                          CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*KEY   ' POPTN                           CFF007
     C                     PARM           WWKY10 10                       CFF007
     C                     PARM           @KYST                           CFF007
     C           SDCUST    PARM SDCUST    DSLDY                           CFF007
      *                                                                   CFF007
     C           PRTCD     IFNE *BLANKS                                   CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     MOVEL'SDCUSTPD'DBFILE           ************   CFF007
     C                     MOVELBOCO      DBKEY            * DBERR 39 *   CFF007
     C                     MOVEL*BLANKS   DBOPTN           ************   CFF007
     C                     Z-ADD39        DBASE                           CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C                     MOVELBBPRBA    WPBFLG                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     EXSR BROKVL
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   CUSTVL SR. -  Validate Customer Settlement Instructions       *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. ADEMKI                   SR. ZEDIT                    *
     C**       SR. ADEOTC                   SR. ZALIGN                   *
     C**       SR. INSVL2                   SR. SLTVL                    *
     C**                                    SR. SLAVL                    *
     C**                                    SR. FAOVL                    *
     C**                                    SR. CPNVL                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           CUSTVL    BEGSR                           ** CUSTVL SR **
     C*
     C**   Reset Processing
     C*
     C                     SETOF                     667174
     C                     Z-ADD0         WCCMA
     C                     Z-ADD0         WCCHA
     C*
     C**   Validate Customer Commission codes
     C*
     C                     MOVE ISCY      KCCY
     C*
     C**   - Standard
     C*
     C           SCCMC     IFNE '  '
     C                     TESTN          SCCMC      74
     C*
     C           *IN74     IFEQ '1'
     C                     MOVE SCCMC     KCGCM
     C           KCHGCM    CHAINCHGCM                71
     C  N71      RECI      COMP 'D'                  7171
     C                     END
     C*
     C**   Error if not found on Charges/Commissions file
     C*
     C           *IN71     IFEQ '1'
     C           *IN74     OREQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 210'    ERR,E
     C                     SETON                     1850
     C                     END
     C*
     C                     END
     C*
     C**   - Same day
     C*
     C                     SETOF                     7174
     C           SCCMS     IFNE '  '
     C                     TESTN          SCCMS      74
     C*
     C           *IN74     IFEQ '1'
     C                     MOVE SCCMS     KCGCM
     C           KCHGCM    CHAINCHGCM                71
     C  N71      RECI      COMP 'D'                  7171
     C                     END
     C*
     C**   Error if not found on Charges/Commissions file
     C*
     C           *IN71     IFEQ '1'
     C           *IN74     OREQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 211'    ERR,E
     C                     SETON                     1851
     C                     END
     C*
     C                     END
     C*
     C**   If one Commission code is entered the other must be entered
     C*
     C           *IN50     IFEQ '0'
     C           *IN51     ANDEQ'0'
     C           SCCM      ANDNE*BLANK
     C*
     C           SCCMC     IFEQ *BLANK
     C           E         ADD  1         E
     C                     MOVE ' 210'    ERR,E
     C                     SETON                     1850
     C                     END
     C*
     C           SCCMS     IFEQ *BLANK
     C           E         ADD  1         E
     C                     MOVE ' 211'    ERR,E
     C                     SETON                     1851
     C                     END
     C*
     C                     END
     C*
     C**   Validate Customer Commission Amount
     C*
     C                     Z-ADDFFCDP     ZADEC
     C           13        SUB  FFCDP     ZADIG
     C*
     C           SCCMA     IFNE *BLANKS
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPCFLG    ANDEQ'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C043
     C*
     C**   If 'A' is entered, rest of field must be blank
     C*
     C           SCCMA1    IFEQ 'A'
     C*
     C           SCCMA2    IFNE *BLANKS
     C           E         ADD  1         E
     C                     MOVE ' 212'    ERR,E
     C                     SETON                     1852
     C*
     C**   If 'A' is entered, Commission codes must not be blank
     C*
     C                     ELSE
     C           SCCM      IFEQ '    '
     C           E         ADD  1         E
     C                     MOVE ' 213'    ERR,E
     C                     SETON                     1852
     C                     END
     C*
     C                     END
     C*
     C**   Error if it's not a valid number
     C*
     C                     ELSE
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SCCMA     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    WCCMA  130
     C*
     C           *IN99     IFEQ '1'
     C           E         ADD  1         E
     C                     MOVE ' 212'    ERR,E
     C                     SETON                     1852
     C                     END
     C/COPY WNCPYSRC,FF0040C044
     C*
     C**   Error if Codes and amount entered unless amount = 'A'
     C*
     C           CFF007    IFNE 'Y'                                       CFF007
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPCFLG    ANDNE'Y'                                       CFF007
     C           SCCM      IFNE '    '
     C           E         ADD  1         E
     C                     MOVE ' 213'    ERR,E
     C                     SETON                     1852
     C                     END
     C*
     C           *IN52     IFEQ '0'
     C*
     C           WCCMA     IFEQ 0
     C                     MOVE *BLANK    SCCMA
     C                     ELSE
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SCCMA
     C/COPY WNCPYSRC,FF0040C045
     C                     END
     C*
     C                     END
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPCFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           SCCM      IFEQ *BLANKS                                   CFF007
     C           SCCMA     ANDNE*BLANKS                                   CFF007
     C           E         ADD  1         E                               CFF007
     C                     MOVE ' 262'    ERR,E                           CFF007
     C                     SETON                     185051               CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           *IN50     IFEQ '0'                                       CFF007
     C           *IN51     ANDEQ'0'                                       CFF007
     C           *IN52     ANDEQ'0'                                       CFF007
      *                                                                   CFF007
     C           SCCM      IFNE *BLANKS                                   CFF007
     C           SCCMC     ANDEQSCCMS                                     CFF007
      *                                                                   CFF007
     C           CCPT      IFEQ 'S'                                       CFF007
     C           CCPT      OREQ 'H'                                       CFF007
     C           CCPT      OREQ 'A'                                       CFF007
      *                                                                   CFF007
     C                     Z-ADDWNCTE     WCONO   50                      CFF007
     C                     MOVE SCCMC     CGCM                            CFF007
     C                     Z-ADD0         WRATA  130                      CFF007
      *                                                                   CFF007
     C           WCONO     IFNE 0                                         CFF007
     C           CGCM      ANDNE0                                         CFF007
     C                     EXSR SRTTFC                                    CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WRATA     IFNE 0                                         CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WRATA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    ZXCMA  14                       CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WCCMA     IFEQ 0                                         CFF007
     C           SCCM      IFNE *BLANKS                                   CFF007
     C           SCCMC     ANDEQSCCMS                                     CFF007
      *                                                                   CFF007
     C                     Z-ADDWRATA     WCCMA                           CFF007
      *                                                                   CFF007
     C           SCCMA     IFEQ *BLANKS                                   CFF007
     C                     SETON                     18                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     MOVE ZXCMA     SCCMA                           CFF007
     C                     MOVE 'A'       CCPT                            CFF007
     C                     MOVE 'Y'       CMCC                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE *BLANK    SCCMA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ELSE                                           CFF007
      *                                                                   CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WCCMA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    SCCMA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Validate Customer Charge code
     C*
     C                     SETOF                     7174
     C           SCCHC     IFNE '  '
     C                     TESTN          SCCHC      74
     C*
     C           *IN74     IFEQ '1'
     C                     MOVE SCCHC     KCGCM
     C           KCHGCM    CHAINCHGCM                71
     C  N71      RECI      COMP 'D'                  7171
     C                     END
     C*
     C**   Error if not found on Charges/Commissions file
     C*
     C           *IN71     IFEQ '1'
     C           *IN74     OREQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 214'    ERR,E
     C                     SETON                     1853
     C                     END
     C*
     C                     END
     C*
     C**   Validate Customer Charge Amount
     C*
     C           SCCHA     IFNE *BLANKS
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPCFLG    ANDEQ'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C046
     C           SCCHA     IFNE *BLANKS                                   CFF007
     C                     MOVE *BLANKS   ZFIELD                          CFF007
     C                     MOVE SCCHA     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    WCCHA  130
     C*
     C**   Error if it's invalid
     C*
     C           *IN99     IFEQ '1'
     C           E         ADD  1         E
     C                     MOVE ' 215'    ERR,E
     C                     SETON                     1854
     C                     END
     C                     ENDIF                                          CFF007
     C*
     C/COPY WNCPYSRC,FF0040C047
     C**   Error if Code and amount entered
     C*
     C           SCCHC     IFNE '  '
     C           CFF007    ANDNE'Y'                                       CFF007
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPCFLG    ANDNE'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C048
     C           E         ADD  1         E
     C                     MOVE ' 216'    ERR,E
     C                     SETON                     1854
     C/COPY WNCPYSRC,FF0040C049
     C                     END
     C*
     C           *IN54     IFEQ '0'
     C           CFF007    ANDNE'Y'                                       CFF007
     C           CFF007    OREQ 'Y'                                       CFF007
     C           *IN54     ANDEQ'0'                                       CFF007
     C           WPCFLG    ANDNE'Y'                                       CFF007
     C*
     C           WCCHA     IFEQ 0
     C                     MOVE *BLANK    SCCHA
     C                     ELSE
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SCCHA
     C/COPY WNCPYSRC,FF0040C050
     C                     END
     C*
     C                     END
      *                                                                   CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPCFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           SCCHC     IFEQ *BLANKS                                   CFF007
     C           SCCHA     ANDNE*BLANKS                                   CFF007
     C           E         ADD  1         E                               CFF007
     C                     MOVE ' 264'    ERR,E                           CFF007
     C                     SETON                     1853                 CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           *IN54     IFEQ '0'                                       CFF007
     C           *IN53     ANDEQ'0'                                       CFF007
      *                                                                   CFF007
     C           SCCHC     IFNE *BLANK                                    CFF007
      *                                                                   CFF007
     C           CCPT      IFEQ 'S'                                       CFF007
     C           CCPT      OREQ 'H'                                       CFF007
     C           CCPT      OREQ 'A'                                       CFF007
      *                                                                   CFF007
     C                     Z-ADDWNCTE     WCONO   50                      CFF007
     C                     MOVE SCCHC     CGCM                            CFF007
     C                     Z-ADD0         WRATA  130                      CFF007
      *                                                                   CFF007
     C           WCONO     IFNE 0                                         CFF007
     C           CGCM      ANDNE0                                         CFF007
     C                     EXSR SRTTFC                                    CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WRATA     IFNE 0                                         CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WRATA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    ZXCMA  14                       CFF007
     C                     ENDIF                                          CFF007
     C**                                                                  CFF007
     C                     ENDIF                                          CFF007
     C**                                                                  CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WCCHA     IFEQ 0                                         CFF007
      *                                                                   CFF007
     C           SCCHC     IFNE *BLANKS                                   CFF007
     C                     Z-ADDWRATA     WCCHA                           CFF007
      *                                                                   CFF007
     C           SCCHA     IFEQ *BLANKS                                   CFF007
     C                     SETON                     18                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     MOVE ZXCMA     SCCHA                           CFF007
     C                     MOVE 'A'       CCPT                            CFF007
     C                     MOVE 'Y'       CHCC                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE *BLANK    SCCHA                           CFF007
     C                     ENDIF                                          CFF007
     C**                                                                  CFF007
     C                     ELSE                                           CFF007
     C**                                                                  CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WCCHA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    SCCHA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C                     END
     C*
     C**   Set up work fields and indicator for lower level SR's
     C*
     C                     MOVE SCSLT     SWSLT   2
     C**********           MOVE SCSLA     SWSLA  12                                           CGL029
     C                     MOVE SCSLA     SWSLA                                               CGL029
     C                     MOVE SCSBR     SWSBR   3                       S01117
     C                     MOVE SCFAO     SWFAO  10
     C                     MOVE SCCPN     SWCPN  10
     C                     SETON                     75
     C                     SETOF                     606162
     C                     SETOF                     637376
     C                     SETOF                     67                   S01117
     C*
     C**   Validate the four remaining fields
     C*
     C/COPY WNCPYSRC,FF0040C051
     C                     MOVELWPCFLG    WTOFC   1                       CFF007
     C                     EXSR SLTVL
     C   60                SETON                     56
     C*
     C           *IN66     IFEQ '0'
     C                     EXSR SLAVL
     C   61                SETON                     57
     C           *IN67     IFEQ '1'                                       S01117
     C                     SETON                     55                   S01117
     C                     END                                            S01117
     C*
     C**   Save fields for update of LF/MEMOSM and LF/PRONOM
     C*
     C                     MOVE XMIND     CMIND   1
     C                     MOVE XPIND     CPIND   1
     C                     MOVE FFNOSN    KNOSNC  20
     C**********           MOVE FFCNUM    KCNUMC  60                                          CSD027
     C                     MOVE FFCNUM    KCNUMC  6                                           CSD027
     C**********           MOVE FFACOD    KACODC  40                                          CGL029
     C                     MOVE FFACOD    KACODC 100                                          CGL029
     C                     MOVE FFACSQ    KACSQC  20
     C                     MOVE FFBRCB    KBRCAC  3                       S01117
     C*
     C**   Set up the account field for output to file
     C*
     C                     MOVE FFBRCB    WCBID   3                       S01117
     C*                                                                   S01117
     C           SWSLT     IFEQ '04'
     C           SWSLT     OREQ '06'
     C           SWSLT     OREQ '15'
     C**********           MOVE WFSLA     WCSLA  12                                           CGL029
     C                     MOVE WFSLA     WCSLA  18                                           CGL029
     C                     MOVE FFBRC2    WCSBR   3                       S01117
     C                     ELSE
     C                     MOVE SCSLA     WCSLA
     C*                                                                   S01117
     C           PMBIN     IFNE 'Y'                                       S01117
     C           SWSLT     ANDEQ'05'                                      S01117
     C                     MOVE FFBRCB    WCSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE SCSBR     WCSBR                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END
     C*
     C                     EXSR FAOVL
     C   62                SETON                     58
     C                     EXSR CPNVL
     C   63                SETON                     59
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   BROKVL SR. -  Validate Broker Settlement Instructions         *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. ADEMKI                   SR. ZEDIT                    *
     C**       SR. INSVL2                   SR. ZALIGN                   *
     C**                                    SR. SLTVL                    *
     C**                                    SR. SLAVL                    *
     C**                                    SR. FAOVL                    *
     C**                                    SR. CPNVL                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           BROKVL    BEGSR                           ** BROKVL SR **
     C*
     C**   Reset Processing
     C*
     C                     SETOF                     667174
     C                     Z-ADD0         WBCMA
     C                     Z-ADD0         WBCHA
     C*
     C**   Validate Broker Commission codes
     C*
     C                     MOVE ISCY      KCCY
     C*
     C**   - Standard
     C*
     C           SBCMC     IFNE '  '
     C                     TESTN          SBCMC      74
     C*
     C           *IN74     IFEQ '1'
     C                     MOVE SBCMC     KCGCM
     C           KCHGCM    CHAINCHGCM                71
     C  N71      RECI      COMP 'D'                  7171
     C                     END
     C*
     C**   Error if not found on Charges/Commissions file
     C*
     C           *IN71     IFEQ '1'
     C           *IN74     OREQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 200'    ERR,E
     C                     SETON                     1840
     C                     END
     C*
     C                     END
     C*
     C**   - Same day
     C*
     C                     SETOF                     7174
     C           SBCMS     IFNE '  '
     C                     TESTN          SBCMS      74
     C*
     C           *IN74     IFEQ '1'
     C                     MOVE SBCMS     KCGCM
     C           KCHGCM    CHAINCHGCM                71
     C  N71      RECI      COMP 'D'                  7171
     C                     END
     C*
     C**   Error if not found on Charges/Commissions file
     C*
     C           *IN71     IFEQ '1'
     C           *IN74     OREQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 201'    ERR,E
     C                     SETON                     1841
     C                     END
     C*
     C                     END
     C*
     C**   If one Commission code is entered the other must be entered
     C*
     C           *IN40     IFEQ '0'
     C           *IN41     ANDEQ'0'
     C           SBCM      ANDNE*BLANK
     C*
     C           SBCMC     IFEQ *BLANK
     C           E         ADD  1         E
     C                     MOVE ' 200'    ERR,E
     C                     SETON                     1840
     C                     END
     C*
     C           SBCMS     IFEQ *BLANK
     C           E         ADD  1         E
     C                     MOVE ' 201'    ERR,E
     C                     SETON                     1841
     C                     END
     C*
     C                     END
     C*
     C**   Validate Broker Commission Amount
     C*
     C                     Z-ADDFFCDP     ZADEC
     C           13        SUB  FFCDP     ZADIG
     C*
     C           SBCMA     IFNE *BLANKS
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPBFLG    ANDEQ'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C052
     C*
     C**   If 'A' is entered, rest of field must be blank
     C*
     C           SBCMA1    IFEQ 'A'
     C*
     C           SBCMA2    IFNE *BLANKS
     C           E         ADD  1         E
     C                     MOVE ' 202'    ERR,E
     C                     SETON                     1842
     C*
     C**   If 'A' is entered, Commission codes must not be blank
     C*
     C                     ELSE
     C           SBCM      IFEQ '    '
     C           E         ADD  1         E
     C                     MOVE ' 203'    ERR,E
     C                     SETON                     1842
     C                     END
     C*
     C                     END
     C*
     C**   Error if it's not a valid number
     C*
     C                     ELSE
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SBCMA     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    WBCMA  130
     C*
     C           *IN99     IFEQ '1'
     C           E         ADD  1         E
     C                     MOVE ' 202'    ERR,E
     C                     SETON                     1842
     C                     END
     C/COPY WNCPYSRC,FF0040C053
     C*
     C**   Error if Codes and amount entered unless amount = 'A'
     C*
     C           CFF007    IFNE 'Y'                                       CFF007
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPBFLG    ANDNE'Y'                                       CFF007
     C           SBCM      IFNE '    '
     C           E         ADD  1         E
     C                     MOVE ' 203'    ERR,E
     C                     SETON                     1842
     C                     END
     C*
     C           *IN42     IFEQ '0'
     C*
     C           WBCMA     IFEQ 0
     C                     MOVE *BLANK    SBCMA
     C                     ELSE
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SBCMA
     C/COPY WNCPYSRC,FF0040C054
     C                     END
     C*
     C                     END
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPBFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           SBCM      IFEQ *BLANKS                                   CFF007
     C           SBCMA     ANDNE*BLANKS                                   CFF007
     C           E         ADD  1         E                               CFF007
     C                     MOVE ' 258'    ERR,E                           CFF007
     C                     SETON                     184041               CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           *IN40     IFEQ '0'                                       CFF007
     C           *IN41     ANDEQ'0'                                       CFF007
     C           *IN42     ANDEQ'0'                                       CFF007
      *                                                                   CFF007
     C           SBCM      IFNE *BLANKS                                   CFF007
     C           SBCMC     ANDEQSBCMS                                     CFF007
      *                                                                   CFF007
     C           BCPT      IFEQ 'S'                                       CFF007
     C           BCPT      OREQ 'H'                                       CFF007
     C           BCPT      OREQ 'A'                                       CFF007
      *                                                                   CFF007
     C                     Z-ADDWNCTE     WCONO   50                      CFF007
     C                     MOVE SBCMC     CGCM                            CFF007
     C                     Z-ADD0         WRATA  130                      CFF007
      *                                                                   CFF007
     C           WCONO     IFNE 0                                         CFF007
     C           CGCM      ANDNE0                                         CFF007
     C                     EXSR SRTTFC                                    CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WRATA     IFNE 0                                         CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WRATA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    ZXCMA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WBCMA     IFEQ 0                                         CFF007
     C           SBCM      IFNE *BLANKS                                   CFF007
     C           SBCMC     ANDEQSBCMS                                     CFF007
      *                                                                   CFF007
     C                     Z-ADDWRATA     WBCMA                           CFF007
      *                                                                   CFF007
     C           SBCMA     IFEQ *BLANKS                                   CFF007
     C                     SETON                     18                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     MOVE ZXCMA     SBCMA                           CFF007
     C                     MOVE 'A'       BCPT                            CFF007
     C                     MOVE 'Y'       CMCB                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE *BLANK    SBCMA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ELSE                                           CFF007
      *                                                                   CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WBCMA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    SBCMA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Validate Broker Charge code
     C*
     C                     SETOF                     7174
     C           SBCHC     IFNE '  '
     C                     TESTN          SBCHC      74
     C*
     C           *IN74     IFEQ '1'
     C                     MOVE SBCHC     KCGCM
     C           KCHGCM    CHAINCHGCM                71
     C  N71      RECI      COMP 'D'                  7171
     C                     END
     C*
     C**   Error if not found on Charges/Commissions file
     C*
     C           *IN71     IFEQ '1'
     C           *IN74     OREQ '0'
     C           E         ADD  1         E
     C                     MOVE ' 204'    ERR,E
     C                     SETON                     1843
     C                     END
     C*
     C                     END
     C*
     C**   Validate Broker Charge Amount
     C*
     C           SBCHA     IFNE *BLANKS
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPBFLG    ANDEQ'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C055
     C           SBCHA     IFNE *BLANKS                                   CFF007
     C                     MOVE *BLANKS   ZFIELD                          CFF007
     C                     MOVE SBCHA     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    WBCHA  130
     C*
     C**   Error if it's invalid
     C*
     C           *IN99     IFEQ '1'
     C           E         ADD  1         E
     C                     MOVE ' 205'    ERR,E
     C                     SETON                     1844
     C                     END
     C                     ENDIF                                          CFF007
     C/COPY WNCPYSRC,FF0040C056
     C*
     C**   Error if Code and amount entered
     C*
     C           SBCHC     IFNE '  '
     C           CFF007    ANDNE'Y'                                       CFF007
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WPBFLG    ANDNE'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C057
     C           E         ADD  1         E
     C                     MOVE ' 206'    ERR,E
     C                     SETON                     1844
     C/COPY WNCPYSRC,FF0040C058
     C                     END
     C*
     C           *IN44     IFEQ '0'
     C           CFF007    ANDNE'Y'                                       CFF007
     C           CFF007    OREQ 'Y'                                       CFF007
     C           *IN44     ANDEQ'0'                                       CFF007
     C           WPBFLG    ANDNE'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C059
     C*
     C           WBCHA     IFEQ 0
     C                     MOVE *BLANK    SBCHA
     C                     ELSE
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SBCHA
     C/COPY WNCPYSRC,FF0040C060
     C                     END
     C*
     C                     END
     C*
     C                     END
      *                                                                   CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPBFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           SBCHC     IFEQ *BLANKS                                   CFF007
     C           SBCHA     ANDNE*BLANKS                                   CFF007
     C           E         ADD  1         E                               CFF007
     C                     MOVE ' 260'    ERR,E                           CFF007
     C                     SETON                     1843                 CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           *IN44     IFEQ '0'                                       CFF007
     C           *IN43     ANDEQ'0'                                       CFF007
      *                                                                   CFF007
     C           SBCHC     IFNE *BLANK                                    CFF007
      *                                                                   CFF007
     C           BCPT      IFEQ 'S'                                       CFF007
     C           BCPT      OREQ 'H'                                       CFF007
     C           BCPT      OREQ 'A'                                       CFF007
      *                                                                   CFF007
     C                     Z-ADDWNCTE     WCONO   50                      CFF007
     C                     MOVE SBCHC     CGCM                            CFF007
     C                     Z-ADD0         WRATA  130                      CFF007
      *                                                                   CFF007
     C           WCONO     IFNE 0                                         CFF007
     C           CGCM      ANDNE0                                         CFF007
     C                     EXSR SRTTFC                                    CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WRATA     IFNE 0                                         CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WRATA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    ZXCMA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           WBCHA     IFEQ 0                                         CFF007
      *                                                                   CFF007
     C           SBCHC     IFNE *BLANKS                                   CFF007
     C                     Z-ADDWRATA     WBCHA                           CFF007
      *                                                                   CFF007
     C           SBCHA     IFEQ *BLANKS                                   CFF007
     C                     SETON                     18                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     MOVE ZXCMA     SBCHA                           CFF007
     C                     MOVE 'A'       BCPT                            CFF007
     C                     MOVE 'Y'       CHCB                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE *BLANK    SBCHA                           CFF007
     C                     ENDIF                                          CFF007
     C**                                                                  CFF007
     C                     ELSE                                           CFF007
     C**                                                                  CFF007
     C                     Z-ADDFFCDP     ZADEC                           CFF007
     C           13        SUB  FFCDP     ZADIG                           CFF007
     C                     MOVEL*BLANK    ZFIELD                          CFF007
     C                     MOVE WBCHA     ZFIELD                          CFF007
     C                     EXSR ZEDIT                                     CFF007
     C                     MOVE ZFIELD    SBCHA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C**   Set up work fields and indicator for lower level SR's
     C*
     C                     MOVE SBSLT     SWSLT
     C                     MOVE SBSLA     SWSLA
     C                     MOVE SBSBR     SWSBR                           S01117
     C                     MOVE SBFAO     SWFAO
     C                     MOVE SBCPN     SWCPN
     C                     SETON                     76
     C                     SETOF                     606162
     C                     SETOF                     637375
     C                     SETOF                     67                   S01117
     C*
     C**   Validate the four remaining fields
     C*
     C/COPY WNCPYSRC,FF0040C061
     C                     MOVELWPBFLG    WTOFC                           CFF007
     C                     EXSR SLTVL
     C   60                SETON                     46
     C*
     C           *IN66     IFEQ '0'
     C                     EXSR SLAVL
     C   61                SETON                     47
     C           *IN67     IFEQ '1'                                       S01117
     C                     SETON                     45                   S01117
     C                     END                                            S01117
     C*
     C**   Save fields for later update of LF/MEMOSM and LF/PRONOM
     C*
     C                     MOVE XMIND     BMIND   1
     C                     MOVE XPIND     BPIND   1
     C                     MOVE FFNOSN    KNOSNB  20
     C**********           MOVE FFCNUM    KCNUMB  60                                          CSD027
     C                     MOVE FFCNUM    KCNUMB  6                                           CSD027
     C**********           MOVE FFACOD    KACODB  40                                          CGL029
     C                     MOVE FFACOD    KACODB 100                                          CGL029
     C                     MOVE FFACSQ    KACSQB  20
     C                     MOVE FFBRCB    KBRCAB  3                       S01117
     C*
     C**   Set up the account field for output to file
     C*
     C                     MOVE FFBRCB    WBBID   3                       S01117
     C*                                                                   S01117
     C           SWSLT     IFEQ '04'
     C           SWSLT     OREQ '06'
     C           SWSLT     OREQ '15'
     C**********           MOVE WFSLA     WBSLA  12                                           CGL029
     C                     MOVE WFSLA     WBSLA  18                                           CGL029
     C                     MOVE FFBRC2    WBSBR   3                       S01117
     C                     ELSE
     C                     MOVE SBSLA     WBSLA
     C*                                                                   S01117
     C           PMBIN     IFNE 'Y'                                       S01117
     C           SWSLT     ANDEQ'05'                                      S01117
     C                     MOVE FFBRCB    WBSBR                           S01117
     C                     ELSE                                           S01117
     C                     MOVE SBSBR     WBSBR                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END
     C*
     C                     EXSR FAOVL
     C   62                SETON                     48
     C                     EXSR CPNVL
     C   63                SETON                     49
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   SLTVL SR. -  Validate settlement type                         *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. CUSTVL                                                *
     C**       SR. BROKVL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           SLTVL     BEGSR                           ** SLTVL SR  **
     C*
     C           SWSLT     IFEQ '  '
     C           CFF007    ANDNE'Y'                                       CFF007
     C           CFF007    OREQ 'Y'                                       CFF007
     C           WTOFC     ANDNE'Y'                                       CFF007
     C           SWSLT     ANDEQ'  '                                      CFF007
     C/COPY WNCPYSRC,FF0040C062
     C                     MOVE '00'      SWSLT
     C*
     C**   Defaults to zero if blank
     C*
     C           *IN75     IFEQ '1'
     C                     MOVE '00'      SCSLT
     C                     ELSE
     C                     MOVE '00'      SBSLT
     C                     END
     C*
     C**   Must be a valid settlement type
     C*
     C                     ELSE
     C/COPY WNCPYSRC,FF0040C063
     C*
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           SWSLT     ANDNE'04'                                      CFF007
     C           SWSLT     ANDNE'05'                                      CFF007
     C           SWSLT     ANDNE'14'                                      CFF007
     C           SWSLT     ANDNE'15'                                      CFF007
     C           WTOFC     ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
      ** Set up error code if invalid                                     CFF007
      *                                                                   CFF007
     C           E         ADD  1         E                               CFF007
     C                     MOVE ' 256'    ERR,E                           CFF007
     C                     SETON                     186066               CFF007
      *                                                                   CFF007
     C                     ELSE                                           CFF007
      *                                                                   CFF007
     C           SWSLT     IFEQ '09'
     C           SWSLT     OREQ '10'
     C           SWSLT     OREQ '11'
     C           SWSLT     OREQ '13'
     C           SWSLT     ORGE '16'
     C           SWSLT     ORLT '00'
     C*
     C**   Set up error code if invalid
     C*
     C           E         ADD  1         E
     C   75                MOVE ' 240'    ERR,E
     C   76                MOVE ' 220'    ERR,E
     C                     SETON                     186066
     C                     END
     C                     ENDIF                                          CFF007
     C/COPY WNCPYSRC,FF0040C064
     C*
     C**   Settlement type can be 04 or 14 only if Retail is set on
     C*
     C           SWSLT     IFEQ '04'
     C           SWSLT     OREQ '14'
     C*
     C           *INU2     IFEQ '0'
     C           E         ADD  1         E
     C   75                MOVE ' 241'    ERR,E
     C   76                MOVE ' 221'    ERR,E
     C                     SETON                     1860
     C                     END
     C*
     C                     END
     C*
     C**   Check that Instrument currency is correct if type is 07
     C*
     C           SWSLT     IFEQ '07'
     C*
     C           ISCY      IFNE USCY
     C           E         ADD  1         E
     C   75                MOVE ' 242'    ERR,E
     C   76                MOVE ' 222'    ERR,E
     C                     SETON                     1860
     C                     END
     C*
     C                     END
     C*
     C**   Check that Retail Account numbers are supported if type is 14
     C*
     C           *IN60     IFEQ '0'
     C           SWSLT     ANDEQ'14'
     C*
     C           RACN      IFNE 'Y'
     C           E         ADD  1         E
     C   75                MOVE ' 243'    ERR,E
     C   76                MOVE ' 223'    ERR,E
     C                     SETON                     1860
     C                     END
     C*
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CVSF                                           S01408
     C*                                                                   S01408
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   SLAVL SR. -  Validate settlement Account                      *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. CUSTVL                                                *
     C**       SR. BROKVL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           SLAVL     BEGSR                           ** SLAVL SR  **
     C*
     C**   Reset processing
     C*
     C                     SETOF                     7174
     C                     MOVE 'N'       XMIND   1
     C                     MOVE 'N'       XPIND   1
     C                     Z-ADD0         FFNOSN
     C**********           Z-ADD0         FFCNUM                                              CSD027
     C                     MOVE *BLANKS   FFCNUM                                              CSD027
     C                     Z-ADD0         FFACOD
     C                     Z-ADD0         FFACSQ
     C                     Z-ADD0         FFACD2                          S01117
     C                     MOVE *BLANKS   FFBRCB                          S01117
     C                     MOVE *BLANKS   FFBRC2                          S01117
     C*
     C           SWSLT     IFEQ '00'
     C           SWSLT     OREQ '04'
     C           SWSLT     OREQ '06'
     C           SWSLT     OREQ '15'
     C*
     C**   Must be blank if Settlement type is 00,04,06,15 or blank
     C*
     C           SWSLA     IFNE *BLANKS
     C           E         ADD  1         E
     C   75                MOVE ' 244'    ERR,E
     C   76                MOVE ' 224'    ERR,E
     C                     SETON                     1861
     C*
     C                     ELSE
     C***********          MOVE FFDASQ    FFACSQ                          S01117
     C                     MOVE SBRCA     FFBRCB                          S01117
     C                     END
     C*
     C                     END
     C*
     C**   Must be a valid Nostro code if type is 01,02,07,08 or 12
     C*
     C           SWSLT     IFEQ '01'
     C           SWSLT     OREQ '02'
     C           SWSLT     OREQ '07'
     C           SWSLT     OREQ '08'
     C           SWSLT     OREQ '12'
     C*
     C                     MOVE 'Y'       XPIND
     C           SWSLA     IFNE *BLANKS
     C                     TESTN          WSLA1      74
     C*
     C           *IN74     IFEQ '1'
     C                     MOVE WSLA1     FFNOSN
     C                     MOVE ISCY      FFNCCY
     C           FFNKY     CHAINTABFF                71
     C  N71      RECI      COMP 'D'                  7171
     C                     END
     C*
     C**   Set up error code if record not found
     C*
     C           *IN71     IFEQ '1'
     C           *IN74     OREQ '0'
     C           WSLA12    ORNE *BLANKS
     C           E         ADD  1         E
     C   75                MOVE ' 245'    ERR,E
     C   76                MOVE ' 225'    ERR,E
     C                     SETON                     1861
     C*
     C**   Set up fields for later chains if record is found
     C*
     C                     ELSE
     C                     MOVE ACOD      FFACOD
     C                     MOVE CNUM      FFCNUM
     C***********          MOVE FFDASQ    FFACSQ                          S01117
     C                     MOVE ACSQ      FFACSQ                          S01117
     C                     MOVE BRCA      FFBRCB                          S01117
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Must be a 6 character numeric field if type is 03
     C*
     C           SWSLT     IFEQ '03'
     C                     TESTN          WSLA6      74
     C*
     C           *IN74     IFEQ '0'
     C           WSLA      ORNE *BLANKS
     C           E         ADD  1         E
     C   75                MOVE ' 246'    ERR,E
     C   76                MOVE ' 226'    ERR,E
     C                     SETON                     1861
     C*
     C                     ELSE
     C                     MOVE CSAC      FFACOD
     C                     MOVE BICN      FFCNUM
     C***********          MOVE FFDASQ    FFACSQ                          S01117
     C                     Z-ADD1         FFACSQ                          S01117
     C                     MOVE SBRCA     FFBRCB                          S01117
     C                     END
     C*
     C                     END
     C*
     C**   Must consist of valid Customer, Account and Sequence if
     C**   Type is 05, therefore it must be numeric.
     C*
     C           SWSLT     IFEQ '05'
     C***********          TESTN          SWSLA      74                                       CSD027
     C***********                                                                             CSD027
     C************IN74     IFEQ '0'                                                           CSD027
     C***********          SETON                     61                                       CSD027
     C***********          END                                                                CSD027
     C*
     C**   Customer (WSLA6) must exist on LF/CLINT
     C*
     C           *IN61     IFEQ '0'
     C                     MOVE WSLA6     FFCNUM
     C                     MOVE WSLA6     KCNUM
     C                     MOVE 'A'       KRCDT
     C           KCLINT    CHAINCLINT                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C           *IN71     IFEQ '1'
     C                     SETON                     61
     C                     END
     C*
     C                     END
     C*
     C*****Account*code*(WSLA4)*must*exist*on*PF/TABTE10***************                       CGL029
      *                                                                                       CGL029
      ** Account Code (WSLA4) must exist on PF/SDACODPD.                                      CGL029
     C*
     C           *IN61     IFEQ '0'
     C                     MOVE WSLA4     FFACOD
     C********** FFAKY     CHAINTABFF                71                                       CGL029
     C**N71***** RECI      COMP 'D'                  7171                                     CGL029
     C                     EXSR SRACOD                                                        CGL029
     C*
     C           *IN71     IFEQ '1'
     C           *IN71     OREQ '0'                                       CFF007
     C********** ATYP      ANDNE'R'                                                    CFF007 CGL029
     C           A5ACTY    ANDNE'R'                                                           CGL029
     C           WTOFC     ANDEQ'Y'                                       CFF007
     C           CFF007    ANDEQ'Y'                                       CFF007
     C/COPY WNCPYSRC,FF0040C065
     C                     SETON                     61
     C*
     C                     ELSE
     C********** ATYP      IFEQ 'R'                                                           CGL029
     C           A5ACTY    IFEQ 'R'                                                           CGL029
     C                     SETON                     73
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Account sequence (WSLA2) must be greater than zero
     C*
     C           *IN61     IFEQ '0'
     C*
     C           WSLA2     IFLE '0'
     C                     SETON                     61
     C                     END
     C*
     C           *IN61     IFEQ '0'
     C                     MOVE WSLA2     FFACSQ
     C                     END
     C*
     C                     END
     C*                                                                   S01117
     C**   Set up Settlement branch for type is 05                        S01117
     C*                                                                   S01117
     C           *IN61     IFEQ '0'                                       S01117
     C*                                                                   S01117
     C           PMBIN     IFEQ 'Y'                                       S01117
     C                     MOVE SWSBR     FFBRCB                          S01117
     C                     ELSE                                           S01117
     C                     MOVE SBRCA     FFBRCB                          S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                                            S01117
     C*
     C**   Set up error code if any error occurred
     C*
     C           *IN61     IFEQ '1'
     C           E         ADD  1         E
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WTOFC     ANDEQ'Y'                                       CFF007
     C           ATYP      ANDNE'R'                                       CFF007
     C                     MOVE ' 257'    ERR,E                           CFF007
     C                     ELSE                                           CFF007
     C/COPY WNCPYSRC,FF0040C066
     C   75                MOVE ' 247'    ERR,E
     C   76                MOVE ' 227'    ERR,E
     C/COPY WNCPYSRC,FF0040C067
     C                     ENDIF                                          CFF007
     C                     SETON                     18
     C                     END
     C*
     C                     END
     C*
     C**   Must consist of valid Retail Account Number if type is 14
     C*
     C           SWSLT     IFEQ '14'
     C                     TESTN          WSLA10     74
     C*
     C**   Invalid if first 10 characters not numeric or rest not blank
     C*
     C           *IN74     IFEQ '0'
     C           WSLA2     ORNE '  '
     C                     SETON                     61
     C                     END
     C*
     C**   Otherwise Account Number must exist on LF/ACNUM
     C*
     C           *IN61     IFEQ '0'
     C                     MOVE WSLA10    KACNO  100
     C           KACNO     CHAINACNUM                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C           *IN71     IFEQ '1'
     C                     SETON                     61
     C                     END
     C*
     C**   If there is no error, set up key fields for later chain
     C*
     C           *IN61     IFEQ '0'
     C                     MOVE ACOD      FFACOD
     C                     MOVE CNUM      FFCNUM
     C                     MOVE ACSQ      FFACSQ
     C                     MOVE BRCA      FFBRCB                          S01117
     C                     END
     C*
     C                     END
     C*
     C**   Account currency must be the same as Instrument currency
     C*
     C           *IN61     IFEQ '0'
     C           CCY       ANDNEISCY
     C                     SETON                     61
     C                     END
     C*
     C**   Set up error code if any error occurred
     C*
     C           *IN61     IFEQ '1'
     C           E         ADD  1         E
     C   75                MOVE ' 248'    ERR,E
     C   76                MOVE ' 228'    ERR,E
     C                     SETON                     18
     C                     END
     C*
     C                     END
     C*                                                                   S01117
     C**   The Settlement branch must be blank if                         S01117
     C**   settlement type not = 05 when MBIN = Y                         S01117
     C*                                                                   S01117
     C           PMBIN     IFEQ 'Y'                                       S01117
     C           SWSLT     IFNE '05'                                      S01117
     C*                                                                   S01117
     C           SWSBR     IFNE *BLANKS                                   S01117
     C                     ADD  1         E                               S01117
     C   75                MOVE ' 301'    ERR,E                           S01117
     C   76                MOVE ' 300'    ERR,E                           S01117
     C                     SETON                     1867                 S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     ELSE                                           S01117
     C*                                                                   S01117
     C**   The Settlement branch must be a valid branch if type is 05     S01117
     C*                                                                   S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM SWSBR     @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    @DSFDY                                       S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     ADD  1         E                               S01117
     C   75                MOVE ' 301'    ERR,E                           S01117
     C   76                MOVE ' 300'    ERR,E                           S01117
     C                     SETON                     1867                 S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C*
     C**   The Account must exist and be open if ATYP = 'R' (Retail)
     C*
     C           *INU2     IFEQ '1'
     C           *IN61     ANDEQ'0'
     C           *IN60     ANDEQ'0'
     C           *IN67     ANDEQ'0'                                       S01117
     C           SWSLT     ANDNE'00'
     C*
     C*****Set*up*key*field*for*access*of*TABTE10**********************                       CGL029
     C*
     C           SWSLT     IFEQ '04'
     C                     Z-ADD1         FFACSQ                          S01117
     C                     MOVE CADC      FFACOD
     C                     MOVE CADC      FFACD2
     C   75                MOVE CUSC      FFCNUM
     C   76                MOVE BOCO      FFCNUM
     C                     MOVE FFBRCB    FFBRC2                          S01117
     C                     END
     C*
     C           SWSLT     IFEQ '06'
     C                     Z-ADD1         FFACSQ                          S01117
     C                     MOVE COMS      FFACOD
     C                     MOVE COMS      FFACD2
     C                     MOVE BICN      FFCNUM
     C                     MOVE FFBRCB    FFBRC2                          S01117
     C                     END
     C*
     C           SWSLT     IFEQ '15'
     C                     Z-ADD1         FFACSQ                          S01117
     C   75                MOVE DFCA      FFACOD
     C   76                MOVE DFBA      FFACOD
     C                     MOVE FFACOD    FFACD2
     C   75                MOVE CUSC      FFCNUM
     C   76                MOVE BOCO      FFCNUM
     C                     MOVE FFBRCB    FFBRC2                          S01117
     C                     END
     C*
     C*****TABTE10*has*already*been*accessed*if*type*=*05**************                       CGL029
      *                                                                                       CGL029
      ** AOACODR0 has already been accessed if type = 05.                                     CGL029
     C*
     C           SWSLT     IFNE '05'
     C********** FFAKY     CHAINTABFF                71                                       CGL029
     C**N71***** RECI      COMP 'D'                  7171                                     CGL029
     C                     EXSR SRACOD                                                        CGL029
     C*
     C**   Check if ATYP = 'R'
     C*
     C           *IN71     IFEQ '0'
     C********** ATYP      ANDEQ'R'                                                           CGL029
     C           A5ACTY    ANDEQ'R'                                                           CGL029
     C                     SETON                     73
     C                     END
     C*
     C                     END
     C*
     C**   Currency is Instrument currency
     C*
     C           *IN73     IFEQ '1'
     C                     MOVE ISCY      FFCCY
     C*
     C**   Chain LF/ACCNT to check that live account exists
     C*
     C           FFACTK    CHAINACCNT                71
     C  N71      RECI      COMP '*'                      71
     C*
     C           *IN71     IFEQ '1'
     C           ACST      OREQ 'C'
     C           E         ADD  1         E
     C   75                MOVE ' 249'    ERR,E
     C   76                MOVE ' 229'    ERR,E
     C                     SETON                     1861
     C           SWSLT     IFEQ '05'                                      S01117
     C                     SETON                     67                   S01117
     C                     END                                            S01117
     C*
     C**   If live account does exist, set on MEMOS update indicator
     C*
     C                     ELSE
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CVS1                                           S01408
     C*                                                                   S01408
     C                     MOVE 'Y'       XMIND
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CVS2                                           S01408
     C*                                                                   S01408
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Transaction date must not be prior to the back value date
     C*
     C**   Calculate business date minus back value period
     C*
     C           XMIND     IFEQ 'Y'
     C           *IN31     ANDEQ'0'
     C           CTDATE    SUB  BVLP      HOLD    50
     C*
     C**   Compare the above result with Date account opened from LF/ACCNT
     C**   and check that Transaction date is not prior to the more recent
     C*
     C           DACO      SUB  HOLD      HOLD2   50   74
     C           *IN74     IFEQ '1'
     C*
     C           HOLD      IFGT OTRSD
     C                     SETON                     61
     C                     END
     C*
     C                     ELSE
     C           DACO      IFGT OTRSD
     C                     SETON                     61
     C                     END
     C*
     C                     END
     C*
     C**   Set up error code if invalid
     C*
     C           *IN61     IFEQ '1'
     C           E         ADD  1         E
     C   75                MOVE ' 250'    ERR,E
     C   76                MOVE ' 230'    ERR,E
     C                     SETON                     18
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   FAOVL SR. -  Validate 'For Account of'                        *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. CUSTVL                                                *
     C**       SR. BROKVL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           FAOVL     BEGSR                           ** FAOVL SR  **
     C*
     C**   Must be blank unless Settlement type is 01,02,07,08 or 12
     C*
     C           SWSLT     IFNE '01'
     C           SWSLT     ANDNE'02'
     C           SWSLT     ANDNE'07'
     C           SWSLT     ANDNE'08'
     C           SWSLT     ANDNE'12'
     C*
     C           SWFAO     IFNE *BLANKS
     C           E         ADD  1         E
     C   75                MOVE ' 251'    ERR,E
     C   76                MOVE ' 231'    ERR,E
     C                     SETON                     1862
     C                     END
     C*
     C                     END
     C*
     C**   Must exist on LF/CLINT or LF/SNAME unless it's blank
     C*
     C           *IN62     IFEQ '0'
     C           SWFAO     ANDNE*BLANKS
     C*
     C**   Chain LF/CLINT if entry is 6 characters numeric
     C*
     C                     MOVELSWFAO     WFAO6   6
     C                     MOVE SWFAO     WFAO4   4
     C***********          TESTN          WFAO6      74                                       CSD027
     C*
     C                     SETON                     71
     C************IN74     IFEQ '1'                                                           CSD027
     C***********WFAO4     ANDEQ*BLANKS                                                       CSD027
     C           WFAO4     IFEQ *BLANKS                                                       CSD027
     C                     MOVE WFAO6     KCNUM
     C                     MOVE 'A'       KRCDT
     C           KCLINT    CHAINCLINT                71
     C**N71******RECI      COMP 'D'                  7171                                     CSD027
     C*
     C**   Set up error code if record not found
     C*
     C           *IN71     IFEQ *OFF                                                          CSD027
     C           RECI      ANDNE'D'                                                           CSD027
     C************IN71     IFEQ '1'                                                           CSD027
     C           E         ADD  1         E
     C   75                MOVE ' 252'    ERR,E
     C   76                MOVE ' 232'    ERR,E
     C                     SETON                     1862
     C                     END
     C                     END
     C*
     C**   Otherwise Chain LF/SNAME
     C*
     C           *IN71     IFEQ *ON                                                           CSD027
     C*************        ELSE                                                               CSD027
     C           SWFAO     CHAINSNAME                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Set up error code if record not found
     C*
     C           *IN71     IFEQ '1'
     C           E         ADD  1         E
     C   75                MOVE ' 252'    ERR,E
     C   76                MOVE ' 232'    ERR,E
     C                     SETON                     1862
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   CPNVL SR. -  Validate Counterparty Nostro                     *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. CUSTVL                                                *
     C**       SR. BROKVL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           CPNVL     BEGSR                           ** CPNVL SR  **
     C*
     C**   Must be blank unless Settlement type is 01,02,07,08 or 12
     C*
     C           SWSLT     IFNE '01'
     C           SWSLT     ANDNE'02'
     C           SWSLT     ANDNE'07'
     C           SWSLT     ANDNE'08'
     C           SWSLT     ANDNE'12'
     C*
     C           SWCPN     IFNE *BLANKS
     C           E         ADD  1         E
     C   75                MOVE ' 254'    ERR,E
     C   76                MOVE ' 234'    ERR,E
     C                     SETON                     1863
     C                     END
     C*
     C                     END
     C*
     C**   Must exist on PF/TABLET2 or on PF/CLINTCB unless it's blank
     C*
     C           *IN63     IFEQ '0'
     C                     MOVELSWCPN     SWCPN6  6
     C*************        TESTN          SWCPN6     19                                       CSD027
     C*
     C**   If counterparty nostro is numeric, access LF/CLINT
     C**   to check that record exists
     C************IN19     IFEQ '1'                                                           CSD027
     C                     MOVE SWCPN6    KCNUM
     C                     MOVE 'A'       KRCDT
     C           KCLINT    CHAINCLINTCBF             71
     C**N71******RECI      COMP 'D'                  7171                                     CSD027
     C*
     C*****Set*up*error*code*if*record not found                                              CSD027
     C*
      * If found but not live                                                                 CSD027
     C           *IN71     IFEQ *OFF                                                          CSD027
     C           RECI      ANDNE'D'                                                           CSD027
     C************IN71     IFEQ '1'                                                           CSD027
     C           E         ADD  1         E
     C   75                MOVE ' 255'    ERR,E
     C   76                MOVE ' 235'    ERR,E
     C                     SETON                     1863
     C                     END
     C*
     C**********           MOVE '0'       *IN19                                               CSD027
     C*
     C**  Else counterparty nostro is non-numeric
     C           *IN71     IFEQ *ON                                                           CSD027
     C***********          ELSE                                                               CSD027
     C*
     C**  If counterparty nostro is not blank, access LF/SNAME to
     C**  check for customer shortname
     C           SWCPN     IFNE *BLANK
     C           SWCPN     CHAINSNAME                69
     C  N69      RECI      COMP 'D'                  6969
     C*
     C**   If record found, store customer number for this customer
     C**   shortname in work field
     C           *IN69     IFEQ '0'
     C*
     C**   If broker counterparty nostro being processed, set on
     C**   broker shortname needed flag
     C           *IN76     IFEQ '1'
     C**********           Z-ADDCNUM      CNUMB   60                                          CSD027
     C                     MOVE CNUM      CNUMB   6                                           CSD027
     C                     Z-ADD1         BSNAME
     C                     END
     C*
     C**   If customer counterparty nostro being processed, set on
     C**   customer shortname needed flag
     C           *IN75     IFEQ '1'
     C**********           Z-ADDCNUM      CNUMC   60                                          CSD027
     C                     MOVE CNUM      CNUMC   6                                           CSD027
     C                     Z-ADD1         CSNAME
     C                     END
     C*
     C**   Else access PF/TABLET2 to check for valid counterparty
     C**   nostro
     C                     ELSE
     C                     MOVE SWCPN     FCPNS
     C           FCNKY     CHAINTABFF                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C**   Set up error code if record not found
     C*
     C           *IN71     IFEQ '1'
     C           E         ADD  1         E
     C   75                MOVE ' 255'    ERR,E
     C   76                MOVE ' 235'    ERR,E
     C                     SETON                     1863
     C                     END
     C                     END
     C                     END
     C*
     C                     END
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UPDINS SR. -  Update Insert Control                           *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. INSMKI                   SR. WTRANS                   *
     C**       SR. INSOTC                   SR. WTRSET                   *
     C**                                    SR. UTTRAN                   *
     C**                                    SR. UTTRST                   *
     C**                                    SR. WCLST                    *
     C**                                    SR. WCLST2                   *
     C**                                    SR. UAMEMS                   *
     C**                                    SR. WACMVD                   *S01240
     C**                                    SR. UAPRON                   *
     C**                                    SR. UPSTNC                   *
     C**                                    SR. UPSTNB                   *
     C**                                    SR. UPSTNK                   *
     C**                                    SR. UTRNSA                   *
     C**                                    SR. FFTVCL                   *
     C**                                    SR. RUDBAW                   *
     C**                                    SR. ICOMIT                   *
     C**                                    SR. INFSR                    *
     C**                                    SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           UPDINS    BEGSR                           ** UPDINS SR **
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP21                                           S01408
     C*                                                                   S01408
     C*
     C                     EXSR ICOMIT
     C*
     C**   Set up and write LF/TRANS Exercise record
     C*
     C                     EXSR WTRANS
     C*
     C**   If write fails - Rollback and discontinue updates
     C*
     C           *IN77     IFEQ '1'
     C*
     C           STATUS    IFEQ 01021
     C                     SETOF                     1415
     C                     EXSR RUDBAW
     C                     Z-ADD0         STATUS  50
     C*
     C                     ELSE
     C                     EXSR INFSR
     C                     END
     C*
     C                     ELSE
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP22                                           S01408
     C*                                                                   S01408
     C** If OTC enhancements are switched on                              CFF003
     C*                                                                   CFF003
     C           CFF003    IFEQ 'Y'                                       CFF003
     C*                                                                   CFF003
     C* WRITE FX DEAL ON EXERCISE OF AN OTC                               CFF003
     C*                                                                   CFF003
     C           PMRKT     IFEQ *BLANK                                    CFF003
     C           ISPT      ANDEQ5                                         CFF003
     C                     CALL 'FF0391'                                  CFF003
     C                     PARM TNBR      ##TNBR  60                      CFF003
     C                     PARM NUCO      ##NUCO  50                      CFF003
     C                     PARM CLSR      ##CLSR  60                      CFF003
     C                     PARM TRSD      ##TRSD  50                      CFF003
     C                     PARM VALD      ##VALD  50                      CFF003
     C                     PARM *BLANK    ##RTCD  7                       CFF003
     C           ##RTCD    IFNE *BLANK                                    CFF003
     C           *LOCK     IN   LDA                                       CFF003
     C                     Z-ADD90        DBASE            ***************CFF003
     C                     MOVE 'FF0391'  DBFILE           * DB ERROR 90 *CFF003
     C                     MOVEL##RTCD    DBKEY            ***************CFF003
     C                     EXSR DBERR                                     CFF003
     C                     END                                            CFF003
     C                     END                                            CFF003
     C                     ENDIF                                          CFF003
     C*
     C**   Set up and write LF/TRSET Exercise record
     C*
     C                     EXSR WTRSET
     C*
     C**   Access LF/TRANS Trade record to prepare for update
     C*
     C                     MOVE SCLSR     KTNBR
     C           KTNBR     CHAINTRANS                71
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '18'      DBASE            ***************S01117
     C                     Z-ADD18        DBASE            ***************S01117
     C                     MOVE 'TRANS'   DBFILE           * DB ERROR 18 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Update LF/TRANS Trade record
     C*
     C                     EXSR UTTRAN
     C*
     C**   - if Trade record changed at another workstation
     C*
     C           *IN12     IFEQ '1'
     C                     SETON                     11
     C                     ROLBK
     C*
     C                     Z-ADD5         ZADIG
     C                     Z-ADD0         ZADEC
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE NOCO      ZFIELD
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SNOCO
     C*
     C                     MOVEAMSG,3     SERCD2
     C                     END
     C*
     C**   - if Trade record deleted at another workstation
     C*
     C           *IN16     IFEQ '1'
     C                     SETON                     11
     C                     ROLBK
     C                     MOVEAMSG,4     SERCD2
     C                     END
     C*
     C**   Set up and update LF/TRSET Trade record
     C*
     C           *IN12     IFEQ '0'
     C           *IN16     ANDEQ'0'
     C                     EXSR UTTRST
     C*
     C**   Set up and write record to LF/CLOST
     C*
     C                     EXSR WCLST
     C*
     C**   Set up and write records to LF/CLOST2
     C*
     C                     EXSR WCLST2
     C*
     C**   Set up and write/update records in LF/MEMOSM
     C*
     C**   - Customer
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CMIND     ANDEQ'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     MOVE KCNUMC    FFCNUM
     C                     MOVE KACODC    FFACOD
     C                     MOVE KACSQC    FFACSQ
     C                     MOVE KBRCAC    FFBRCB                          S01117
     C                     EXSR UAMEMS
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND   1                       S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAC    FOBRCA  3                       FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BMIND     ANDEQ'Y'
     C                     MOVE KCNUMB    FFCNUM
     C                     MOVE KACODB    FFACOD
     C                     MOVE KACSQB    FFACSQ
     C                     MOVE KBRCAB    FFBRCB                          S01117
     C                     EXSR UAMEMS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   Set up and write/update records in LF/PRONOM
     C*
     C**   - Customer
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CPIND     ANDEQ'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     MOVE KNOSNC    KNOSNP
     C                     EXSR UAPRON
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C           CMIND     IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAC    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BPIND     ANDEQ'Y'
     C                     MOVE KNOSNB    KNOSNP
     C                     EXSR UAPRON
     C**                                                                  S01240
     C           BMIND     IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   Set up and write records to LF/POSTNC and LF/POSTNK
     C*
     C**   - Calculate Total Transaction Value
     C*
     C                     Z-ADDWNCTE     FFNOC
     C                     Z-ADDCOPR      FFPRIC
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C*
     C                     EXSR FFTVCL
     C*
     C                     Z-ADDFFTNVL    WTNVL  130
     C*
     C**    LF/POSTNC - Customer
     C*
     C           SCUSC     IFNE *BLANKS
     C                     EXSR UPSTNC
     C                     END
     C*
     C**    - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     EXSR UPSTNB
     C                     END
     C*
     C**    LF/POSTNK - Book
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           SCUSC     ANDEQ*BLANKS
     C********** BOCO      OREQ 0                                                             CSD027
     C           BOCO      OREQ *BLANKS                                                       CSD027
     C           SCUSC     ANDNE*BLANKS
     C                     EXSR UPSTNK
     C                     END
     C*
     C**   Update Transaction Audit file (PF/TRANSA)
     C*
     C                     EXSR UTRNSA
     C*
     C**   End of Commitment Cycle
     C*
     C           CMTTXT    COMIT
     C*
     C                     END
     C*
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP23                                           S01408
     C*                                                                   S01408
     C*
     C                     ENDSR
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UPDAMD SR. -  Update Amend Control                            *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. ADEMKI                   SR. ICOMIT                   *
     C**       SR. ADEOTC                   SR. DBERR                    *
     C**                                    SR. RUDBAW                   *
     C**                                    SR. UTRANS                   *
     C**                                    SR. UTRSET                   *
     C**                                    SR. URMEMS                   *
     C**                                    SR. WACMVD                   *S01240
     C**                                    SR. UAMEMS                   *
     C**                                    SR. URPRON                   *
     C**                                    SR. UAPRON                   *
     C**                                    SR. UTRNSA                   *
     C**                                    SR. FFSETL                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           UPDAMD    BEGSR                           ** UPDAMD SR **
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP24                                           S01408
     C*                                                                   S01408
     C*
     C**   Access LF/TRANS Exercise record
     C*
     C                     MOVE STNBR     KTNBR
     C           KTNBR     CHAINTRANS                71
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '19'      DBASE            ***************S01117
     C                     Z-ADD19        DBASE            ***************S01117
     C                     MOVE 'TRANS'   DBFILE           * DB ERROR 19 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Rec Updated by Another Wkstn ?
     C*
     C           TNLU      IFNE XTNLU
     C*
     C           CHTP      IFEQ 'D'
     C                     SETON                     72
     C                     END
     C*
     C                     EXSR RUDBAW
     C*
     C                     ELSE
     C*
     C**   Initialise 'COMIT' text
     C*
     C                     EXSR ICOMIT
     C*
     C**   Set up and update LF/TRANS Exercise record
     C*
     C                     EXSR UTRANS
     C*
     C**   Set up and update LF/TRSET Exercise record if EOC not processed
     C*
     C           *IN65     IFEQ '1'
     C                     EXSR UTRSET
     C*
     C**   Set up and write/update records in LF/MEMOSM
     C*
     C**   Calculate Realised P & L using standard SR. FFPLCL
     C*
     C                     Z-ADDWNCTE     FFNOC
     C                     Z-ADDTKDMX     FFTKDM
     C                     Z-ADDTKVLX     FFTKVL
     C                     Z-ADDMNPFX     FFMNPF
     C*
     C**   Which Price is which depends on PCAL
     C*
     C           SPCAL     IFEQ 'C'
     C***********          Z-ADDCOPR      FFPRCX                          AUS022
     C***********          Z-ADDSTRPS     FFPRCY                          AUS022
     C/COPY WNCPYSRC,FF0040C016
     C***********          Z-ADDCOPR      FFPRCX 117                AUS022CFF004
     C***********          Z-ADDSTRPS     FFPRCY 117                AUS022CFF004
     C/COPY WNCPYSRC,FF0040C017
     C           *LIKE     DEFN COPR      FFPRCX                          CFF004
     C           *LIKE     DEFN STRP      FFPRCY                          CFF004
     C                     Z-ADDCOPR      FFPRCX                          CFF004
     C                     Z-ADDSTRPS     FFPRCY                          CFF004
     C                     ELSE
     C                     Z-ADDCOPR      FFPRCY
     C                     Z-ADDSTRPS     FFPRCX
     C                     END
     C*
     C                     EXSR FFPLCL
     C                     Z-ADDFFPOL     COPLS
     C*
     C**   Write/update records in LF/MEMOSM for reversed out details
     C*
     C**   - Customer, FFSETL SR to decide if update is required
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C***********          MOVE SBRCD     FFBRCD                          S01117
     C                     MOVE SBRCA     FFBRCA                          S01117
     C**********           Z-ADDCUSC      FFCBCD                                              CSD027
     C                     MOVE CUSC      FFCBCD                                              CSD027
     C                     MOVE 'N'       FFBRKI
     C                     MOVE CSLTS     FFSETP
     C                     MOVE CSLAS     FFSETA
     C                     MOVE BRSCS     FFSETB                          S01117
     C                     EXSR FFSETL
     C                     SETOF                     89
     C                     MOVE FFPIND    CPIND2  1
     C                     MOVE FFNOSN    KNSNC2  20
     C                     MOVE FFMIND    SAVCMN  1                       S01240
     C*
     C**   Update LF/MEMOSM if settlement was across a Retail account
     C*
     C           FFMIND    IFEQ 'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     EXSR URMEMS
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAC    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C                     END
     C*
     C**   - Broker, FFSETL SR to decide if update is required
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C***********          MOVE SBRCD     FFBRCD                          S01117
     C                     MOVE SBRCA     FFBRCA                          S01117
     C**********           Z-ADDBOCO      FFCBCD                                              CSD027
     C                     MOVE BOCO      FFCBCD                                              CSD027
     C                     MOVE 'Y'       FFBRKI
     C                     MOVE BSLTS     FFSETP
     C                     MOVE BSLAS     FFSETA
     C                     MOVE BSBRS     FFSETB                          S01117
     C                     EXSR FFSETL
     C                     SETOF                     89
     C                     MOVE FFPIND    BPIND2  1
     C                     MOVE FFNOSN    KNSNB2  20
     C                     MOVE FFMIND    SAVBMN  1                       S01240
     C*
     C**   Update LF/MEMOSM if settlement was across a Retail account
     C*
     C           FFMIND    IFEQ 'Y'
     C                     EXSR URMEMS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C                     END
     C*
     C**   Write/update records in LF/MEMOSM for new account details
     C*
     C**   - Customer
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CMIND     ANDEQ'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     MOVE KCNUMC    FFCNUM
     C                     MOVE KACODC    FFACOD
     C                     MOVE KACSQC    FFACSQ
     C                     MOVE KBRCAC    FFBRCB                          S01117
     C                     EXSR UAMEMS
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAC    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BMIND     ANDEQ'Y'
     C                     MOVE KCNUMB    FFCNUM
     C                     MOVE KACODB    FFACOD
     C                     MOVE KACSQB    FFACSQ
     C                     MOVE KBRCAB    FFBRCB                          S01117
     C                     EXSR UAMEMS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   Write/update records in LF/PRONOM for reversed out details
     C*
     C**   - Customer
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CPIND2    ANDEQ'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     MOVE KNSNC2    KNOSNP
     C                     EXSR URPRON
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C           SAVCMN    IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAC    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BPIND2    ANDEQ'Y'
     C                     MOVE KNSNB2    KNOSNP
     C                     EXSR URPRON
     C**                                                                  S01240
     C           SAVBMN    IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   Write/update records in LF/PRONOM for new account details
     C*
     C**   - Customer
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CPIND     ANDEQ'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     MOVE KNOSNC    KNOSNP
     C                     EXSR UAPRON
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C           CMIND     IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAC    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BPIND     ANDEQ'Y'
     C                     MOVE KNOSNB    KNOSNP
     C                     EXSR UAPRON
     C**                                                                  S01240
     C           BMIND     IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C                     END
     C*
     C**   Update Transaction Audit file (PF/TRANSA)
     C*
     C                     EXSR UTRNSA
     C*
     C**   End of Commitment Cycle
     C*
     C           CMTTXT    COMIT
     C*
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP25                                           S01408
     C*                                                                   S01408
     C*
     C                     ENDSR
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UPDDEL SR. -  Update Delete Control                           *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. ADEMKI                   SR. UTRANS                   *
     C**       SR. ADEOTC                   SR. UTRSET                   *
     C**                                    SR. UTTRAN                   *
     C**                                    SR. UTTRST                   *
     C**                                    SR. UCLST                    *
     C**                                    SR. URMEMS                   *
     C**                                    SR. WACMVD                   *S01240
     C**                                    SR. URPRON                   *
     C**                                    SR. UPSTNC                   *
     C**                                    SR. UPSTNB                   *
     C**                                    SR. UPSTNK                   *
     C**                                    SR. UTRNSA                   *
     C**                                    SR. FFTVCL                   *
     C**                                    SR. RUDBAW                   *
     C**                                    SR. ICOMIT                   *
     C**                                    SR. DBERR                    *
     C**                                    SR. FFSETL                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           UPDDEL    BEGSR                           ** UPDDEL SR **
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP26                                           S01408
     C*                                                                   S01408
     C*
     C                     MOVE ISCY      KCCY
     C*
     C**   Access LF/TRANS Exercise record
     C*
     C                     MOVE STNBR     KTNBR
     C           KTNBR     CHAINTRANS                71
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '20'      DBASE            ***************S01117
     C                     Z-ADD20        DBASE            ***************S01117
     C                     MOVE 'TRANS'   DBFILE           * DB ERROR 20 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C*
     C                     ELSE
     C                     MOVELCUSC      WCUSC
     C                     MOVELBOCO      WBOCO
     C                     END
     C*
     C**   Rec Upd by Another Wkstn ?
     C*
     C           TNLU      IFNE XTNLU
     C*
     C           CHTP      IFEQ 'D'
     C                     SETON                     72
     C                     END
     C*
     C                     EXSR RUDBAW
     C*
     C                     ELSE
     C*
     C**   Initialise 'COMIT' text
     C*
     C                     EXSR ICOMIT
     C*
     C**   Set up and update LF/TRANS Exercise record
     C*
     C                     EXSR UTRANS
     C*
     C**   Set up and update LF/TRSET Exercise record
     C*
     C                     EXSR UTRSET
     C*
     C**   Access LF/TRANS Trade record to prepare for update
     C*
     C                     MOVE SCLSR     KTNBR
     C           KTNBR     CHAINTRANS                71
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '21'      DBASE            ***************S01117
     C                     Z-ADD21        DBASE            ***************S01117
     C                     MOVE 'TRANS'   DBFILE           * DB ERROR 21 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Access LF/FOCLT record if broker is present
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BOCO      CHAINFOCLT                71
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '22'      DBASE            ***************S01117
     C                     Z-ADD22        DBASE            ***************S01117
     C                     MOVE 'FOCLT'   DBFILE           * DB ERROR 22 *
     C                     MOVELBOCO      DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C                     END
     C*
     C**   Update LF/TRANS Trade record
     C*
     C                     EXSR UTTRAN
     C*
     C**   Set up and update LF/TRSET Trade record
     C*
     C                     EXSR UTTRST
     C*
     C**   Set up and update LF/CLOST record
     C*
     C                     EXSR UCLST
     C*
     C**   Write/update records in LF/MEMOSM for reversed out details
     C*
     C**   - Customer, FFSETL SR to decide if update is required
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C***********          MOVE SBRCD     FFBRCD                          S01117
     C                     MOVE SBRCA     FFBRCA                          S01117
     C**********           Z-ADDCUSC      FFCBCD                                              CSD027
     C                     MOVE CUSC      FFCBCD                                              CSD027
     C                     MOVE 'N'       FFBRKI
     C                     MOVE CSLTS     FFSETP
     C                     MOVE CSLAS     FFSETA
     C                     MOVE BRSCS     FFSETB                          S01117
     C                     EXSR FFSETL
     C                     SETOF                     89
     C                     MOVE FFPIND    CPIND2  1
     C                     MOVE FFNOSN    KNSNC2  20
     C                     MOVE FFMIND    SAVCMN                          S01240
     C*
     C**   Update LF/MEMOSM if settlement was across a Retail account
     C*
     C           FFMIND    IFEQ 'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     EXSR URMEMS
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE FFBRCB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C                     END
     C*
     C**   - Broker, FFSETL SR to decide if update is required
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C***********          MOVE SBRCD     FFBRCD                          S01117
     C                     MOVE SBRCA     FFBRCA                          S01117
     C**********           Z-ADDBOCO      FFCBCD                                              CSD027
     C                     MOVE BOCO      FFCBCD                                              CSD027
     C                     MOVE 'Y'       FFBRKI
     C                     MOVE BSLTS     FFSETP
     C                     MOVE BSLAS     FFSETA
     C                     MOVE BSBRS     FFSETB                          S01117
     C                     EXSR FFSETL
     C                     SETOF                     89
     C                     MOVE FFPIND    BPIND2  1
     C                     MOVE FFNOSN    KNSNB2  20
     C                     MOVE FFMIND    SAVBMN                          S01240
     C*
     C**   Update LF/MEMOSM if settlement was across a Retail account
     C*
     C           FFMIND    IFEQ 'Y'
     C                     EXSR URMEMS
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'M' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE FFBRCB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C**                                                                  S01240
     C                     END
     C*
     C                     END
     C*
     C**   Write/update records in LF/PRONOM for reversed out details
     C*
     C**   - Customer
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CPIND2    ANDEQ'Y'
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C                     MOVE KNSNC2    KNOSNP
     C                     EXSR URPRON
     C   14      PRMPS     MULT -1        PRMPS
     C   14      COPLS     MULT -1        COPLS
     C**                                                                  S01240
     C           SAVCMN    IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAC    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BPIND2    ANDEQ'Y'
     C                     MOVE KNSNB2    KNOSNP
     C                     EXSR URPRON
     C**                                                                  S01240
     C           SAVBMN    IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C**   Set MEMOSM/PRONOM Update Indicator to 'P' (used in             S01240
     C**   SR. WACMVD)                                                    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C**   SET UP BRANCH CODE FOR UPDATE OF PF/FFACMVD.                   FO0017
     C                     MOVE KBRCAB    FOBRCA                          FO0017
     C**                                                                  FO0017
     C**   Write record to PF/FFACMVD                                     S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     END
     C*
     C**   Set up and write records to LF/POSTNC and LF/POSTNK
     C*
     C**   - Calculate Total Transaction Value
     C*
     C                     Z-ADDWNCTE     FFNOC
     C                     Z-ADDCOPR      FFPRIC
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C*
     C                     EXSR FFTVCL
     C*
     C                     Z-ADDFFTNVL    WTNVL  130
     C*
     C**    LF/POSTNC - Customer
     C*
     C           SCUSC     IFNE *BLANKS
     C                     EXSR UPSTNC
     C                     END
     C*
     C**    - Broker
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     EXSR UPSTNB
     C                     END
     C*
     C**    LF/POSTNK - Book
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           SCUSC     ANDEQ*BLANKS
     C********** BOCO      OREQ 0                                                             CSD027
     C           BOCO      OREQ *BLANKS                                                       CSD027
     C           SCUSC     ANDNE*BLANKS
     C                     EXSR UPSTNK
     C                     END
     C**
     C**   Update Transaction Audit file (PF/TRANSA)
     C**
     C                     EXSR UTRNSA
     C**
     C**   End of Commitment Cycle
     C*
     C           CMTTXT    COMIT
     C*
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP27                                           S01408
     C*                                                                   S01408
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   ICOMIT SR. -  Initialise 'COMIT' text                         *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. ZTNLU1                   *
     C**       SR. UPDAMD                                                *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           ICOMIT    BEGSR                           ** ICOMIT SR **
     C*
     C**   Access/Update Next Available Transaction No.
     C*
     C                     EXSR ZTNLU1
     C*
     C**   Setup standard information for COMIT text d.s.
     C*
     C                     MOVE 'FF'      MDID
     C                     MOVEL'FF0040  'PGMN
     C                     MOVE WSID      WSIDX
     C                     TIME           MTIME   60
     C                     MOVE SACTN     SACTNX
     C                     MOVE USRID     USRIDX
     C                     MOVE SAMKDS    SAMK
     C                     MOVELSMIODS    SMIOL
     C                     MOVE SMIODS    SMIOR
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   WTRANS SR. -  Write record to  LF/TRANS                       *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           WTRANS    BEGSR                           ** WTRANS SR **
     C*
     C**   Set up fields for output of record to LF/TRANS
     C*
     C                     MOVE 'D'       RECI
     C                     MOVE STNBR     TNBR
     C***********          MOVE SBRCD     BRCD                            S01117
     C                     MOVE SBRCA     BRCA                            S01117
     C                     MOVELWCUSC     CUSC
     C                     MOVE SBOKC     BOKC
     C                     MOVE ISTT      ISTT
     C                     MOVE SPCAL     PCAL
     C                     Z-ADDWSTRP     STRP
     C                     MOVE 'E'       TRTY
     C                     MOVE STRTY     ULTT
     C                     MOVE OTRSD     TRSD
     C                     Z-ADDWNCTE     NUCO
     C                     Z-ADD0         NOCO
     C                     Z-ADD0         NOBO
     C                     Z-ADDWEXPR     COPR
     C                     MOVE STNAR     TNAR
     C                     MOVE 'N'       TBLO
     C                     Z-ADD0         LNKR
     C                     MOVE SCLSR     CLSR
     C                     MOVE 'N'       ECPI
     C                     MOVE ISCY      ISCY
     C                     MOVE 'N'       CBPI
     C                     Z-ADD0         FCDA
     C                     MOVE 'N'       FCIN
     C                     MOVE ORBR      ORBR                            S01117
     C                     MOVE PRFC      PRFC                            S01117
     C                     Z-ADDCTDATE    LCD
     C                     MOVE 'I'       CHTP
     C                     Z-ADDNATN      TNLU
     C                     MOVE BPRC      BPRC                            CAC003
     C                     MOVE TPRC      TPRC                            CAC003
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP28                                           S01408
     C*                                                                   S01408
     C           CFF003    IFEQ 'Y'                                       CFF003
     C                     Z-ADDOVALD     VALD                            CFF003
     C                     ENDIF                                          CFF003
     C*                                                                   S01411
     C* Move Run date into 'ORIGINAL ENTRY DATE'                          S01411
     C*                                                                   S01411
     C                     Z-ADDPRUND     ORED                            S01411
     C*
     C**   Some fields are output differently for OTC's and Market Inst's
     C*
     C**   - Market instrument
     C*
     C           PMRKT     IFNE '  '
     C                     MOVELWBOCO     BOCO
     C                     MOVE SYRNO     YRNO
     C                     MOVE MTHN      MTHN
     C*
     C**   - O.T.C.
     C*
     C                     ELSE
     C**********           Z-ADD0         BOCO                                                CSD027
     C                     MOVE *BLANKS   BOCO                                                CSD027
     C                     Z-ADD0         YRNO
     C                     Z-ADD0         MTHN
     C                     END
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     MOVE 'N'       FBIN
     C                     ELSE
     C                     MOVE 'Y'       FBIN
     C                     END
     C*                                                                   S71062
     C**   Portfolio management module is installed                       S71062
     C**   Or Private Banking Module  is installed                        CPB001
     C*                                                                   S71062
     C           BGPFMG    IFEQ 'Y'                        *B1            S71062
     C           FCPORS    ANDNE'B'                                       CPM003
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S71062
     C**   If the display field is equal to the "reference attached to    S71062
     C**   9997 portfolio"                                                S71062
     C           SPTFR     IFEQ FCR997                     **B2           S71062
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C           SPTFR     ANDNE*BLANKS                                   CFF007
     C/COPY WNCPYSRC,FF0040C018
     C                     MOVEL'9997'    PTFR                            S71062
     C                     ELSE                            **X2           S71062
     C                     MOVELSPTFR     PTFR                            S71062
     C                     END                             **E2           S71062
     C*                                                                   S71062
     C                     END                             *E1            S71062
     C*                                                                   S71062
     C** SETUP NEW FIELDS ON PF/TRANSD                                    S71062
     C                     MOVE 'N'       ACNI                            S71062
     C                     Z-ADD0         MABK                            S71062
     C                     Z-ADD0         MACU                            S71062
     C                     Z-ADD0         CUUN                            S71062
     C                     Z-ADD0         UNPL                            S71062
     C                     Z-ADD0         UPLS                            S71062
     C**                                                                  077485
     C                     MOVE *BLANKS   MHEX                            077485
     C/COPY WNCPYSRC,FF0040C068
      *                                                                                       CSD015
      ** Perform compliance watch processing before writing new record                        CSD015
      ** if compliance watch is installed and entry watch list checking                       CSD015
      ** is set to 'Y'                                                                        CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           CSD015
      *                                                                                       CSD015
     C           CSC011    IFNE 'Y'                                                           CSD015
     C           CSC011    OREQ 'Y'                                                           CSD015
     C           S1MAIN    ANDEQLIBR                                                          CSD015
      *                                                                                       CSD015
     C                     MOVEA*BLANKS   WLF,1                                               CSD015
      *                                                                                       CSD015
     C           WBSLA     IFNE *BLANKS                                                       CSD015
     C                     MOVELWBSLA     WLF,1                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           WCSLA     IFNE *BLANKS                                                       CSD015
     C                     MOVELWCSLA     WLF,4                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           BSNAME    IFEQ 1                                                             CSD015
     C********** CNUMB     ANDNE0                                                      CSD015 CSD027
     C           CNUMB     ANDNE*BLANKS                                                       CSD027
     C                     MOVELCNUMB     WLF,3                                               CSD015
     C                     ELSE                                                               CSD015
     C           SBCPN     IFNE *BLANKS                                                       CSD015
     C                     MOVELSBCPN     WLF,3                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           CSNAME    IFEQ 1                                                             CSD015
     C********** CNUMC     ANDNE0                                                      CSD015 CSD027
     C           CNUMC     ANDNE*BLANKS                                                       CSD027
     C                     MOVELCNUMC     WLF,6                                               CSD015
     C                     ELSE                                                               CSD015
     C           SCCPN     IFNE *BLANKS                                                       CSD015
     C                     MOVELSCCPN     WLF,6                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           SBFAO     IFNE *BLANKS                                                       CSD015
     C                     MOVELSBFAO     WLF,2                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           SCFAO     IFNE *BLANKS                                                       CSD015
     C                     MOVELSCFAO     WLF,5                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     Z-ADD6         WY      20                                          CSD015
     C                     Z-ADD1         WX      20                                          CSD015
     C                     MOVE 'N'       WCWFLG  1                                           CSD015
      *                                                                                       CSD015
     C           WX        DOUGTWY                                                            CSD015
     C           WCWFLG    OREQ 'Y'                                                           CSD015
     C           WLF,WX    IFNE *BLANKS                                                       CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ADD  1         WX                                                  CSD015
     C                     ENDDO                                                              CSD015
      *                                                                                       CSD015
      ** If watch list fields are not blanks, see also if 24x7 is not                         CSD015
      ** installed. If it is installed, it should be in the main system                       CSD015
      *                                                                                       CSD015
     C           WCWFLG    IFEQ 'Y'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C*
     C**   Write record to LF/TRANS
     C*
     C                     WRITETRANSDF                77
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   WTRSET SR. -  Write record to  LF/TRSET                       *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. FFPMCL                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           WTRSET    BEGSR                           ** WTRSET SR **
     C*
     C**  Set up fields for output to LF/TRSET
     C*
     C                     MOVE 'D'       RECI
     C                     MOVE STNBR     TNBR
     C                     MOVE 'N'       CMCB                            CFF007
     C                     MOVE 'N'       CHCB                            CFF007
     C                     MOVE 'N'       CMCC                            CFF007
     C                     MOVE 'N'       CHCC                            CFF007
     C/COPY WNCPYSRC,FF0040C069
     C                     Z-ADD0         OCSB
     C                     Z-ADD0         OCDB
     C                     Z-ADD0         CPSB
     C                     Z-ADD0         CPDB
     C                     Z-ADD0         OCSC
     C                     Z-ADD0         OCDC
     C                     Z-ADD0         CPSC
     C                     Z-ADD0         CPDC
     C*
     C**   Data output to next four fields depends on Transaction Dates
     C**   of Trade and Exercise and whether Broker/Customer is present
     C*
     C**   - Dates are the same:
     C*
     C           *IN78     IFEQ '1'
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCIS     ANDEQ'N'
     C                     Z-ADD0         CCSB
     C                     Z-ADDWNCTE     CCDB
     C                     ELSE
     C                     Z-ADD0         CCSB
     C                     Z-ADD0         CCDB
     C                     END
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     Z-ADD0         CCSC
     C                     Z-ADDWNCTE     CCDC
     C                     ELSE
     C                     Z-ADD0         CCSC
     C                     Z-ADD0         CCDC
     C                     END
     C*
     C**   - Dates are different:
     C*
     C                     ELSE
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCIS     ANDEQ'N'
     C                     Z-ADD0         CCDB
     C                     Z-ADDWNCTE     CCSB
     C                     ELSE
     C                     Z-ADD0         CCSB
     C                     Z-ADD0         CCDB
     C                     END
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     Z-ADD0         CCDC
     C                     Z-ADDWNCTE     CCSC
     C                     ELSE
     C                     Z-ADD0         CCDC
     C                     Z-ADD0         CCSC
     C                     END
     C*
     C                     END
     C*                                                            185846
     C** Initialise the number of contract posted                  185846
     C*                                                            185846
     C                     Z-ADD0         NCCP                     185846
     C*
     C**   Calculate Premiums Paid
     C*
     C***********          Z-ADDCOPRS     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
     C*                                                                   E30422
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRPS     FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRS     FFPRIC                          054174
     C***********          END                                     054174 136056
     C                     Z-ADDWNCTE     FFNOC
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDTKVL      FFTKVL
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDSTRPS     FFSTRP                          136056
     C                     EXSR FFPMCL
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRS     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDFFPREM    PRMP
     C*
     C           PUPF      IFEQ 'N'
     C                     Z-ADDPRMP      PRMPS  130
     C                     ELSE
     C                     Z-ADD0         PRMPS
     C                     END
     C*
     C**   Broker Settlement details
     C*
     C           SBOCO     IFNE *BLANK
     C           SBOCO     ANDNE'*'
     C*
     C**   If an amount is entered, set pattern to 'A'
     C*
     C           SBCMA     IFEQ 'A'
     C           WBCMA     ORNE 0
     C                     MOVE 'A'       BCPT
     C                     ELSE
     C*
     C**   If codes are entered, use default pattern
     C*
     C           SBCM      IFNE '    '
     C                     MOVE WBCPT     BCPT
     C*
     C**   If default pattern is blank, set pattern to 'A'
     C*
     C           BCPT      IFEQ ' '
     C                     MOVE 'A'       BCPT
     C                     END
     C*
     C**   If neither amount nor codes entered, set pattern to blank
     C*
     C                     ELSE
     C                     MOVE ' '       BCPT
     C                     END
     C*
     C                     END
     C*
     C**   Set up other fields from the screen entries
     C*
     C                     MOVE SBCMC     BCMC
     C                     MOVE SBCMS     BCMS
     C                     Z-ADDWBCMA     BCMA
     C                     MOVE SBCHC     BCHC
     C                     Z-ADDWBCHA     BCHA
     C                     MOVE SBSLT     BSLT
     C                     MOVE WBSLA     BSLA
     C                     MOVE WBSBR     BSBR                            S01117
     C                     MOVE WBBID     BBID                            S01117
     C                     MOVE SBFAO     BFAO
     C*
     C**   If broker shortname needed flag set on, write customer
     C**   number for shortname to file, else write screen field
     C**   to file
     C           BSNAME    IFEQ 1
     C                     MOVELCNUMB     BCPN
     C                     Z-ADD0         BSNAME
     C                     ELSE
     C                     MOVELSBCPN     BCPN
     C                     END
     C/COPY WNCPYSRC,FF0040C070
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPBFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           BCMC      IFNE *ZEROS                                    CFF007
     C           BCMA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CMCB                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CMCB                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           BCHC      IFNE *ZEROS                                    CFF007
     C           BCHA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CHCB                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CHCB                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C**   Blank/zeroise fields if Broker not present
     C*
     C                     ELSE
     C                     MOVE ' '       BCPT
     C                     Z-ADD0         BCMC
     C                     Z-ADD0         BCMS
     C                     Z-ADD0         BCMA
     C                     Z-ADD0         BCHC
     C                     Z-ADD0         BCHA
     C                     Z-ADD0         BSLT
     C                     MOVE *BLANK    BSLA
     C                     MOVE *BLANK    BSBR                            S01117
     C                     MOVE *BLANK    BBID                            S01117
     C                     MOVE *BLANK    BFAO
     C                     MOVE *BLANK    BCPN
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP29                                           S01408
     C*                                                                   S01408
     C                     END
     C*
     C                     Z-ADD0         BMAR
     C                     Z-ADD0         BCHP
     C                     Z-ADD0         BCMP
     C*
     C**   Customer Settlement details
     C*
     C           SCUSC     IFNE *BLANK
     C*
     C**   If an amount is entered, set pattern to 'A'
     C*
     C           SCCMA     IFEQ 'A'
     C           WCCMA     ORNE 0
     C                     MOVE 'A'       CCPT
     C                     ELSE
     C*
     C**   If codes are entered, use default pattern
     C*
     C           SCCM      IFNE '    '
     C                     MOVE WCCPT     CCPT
     C*
     C**   If default pattern is blank, set pattern to 'A'
     C*
     C           CCPT      IFEQ ' '
     C                     MOVE 'A'       CCPT
     C                     END
     C*
     C**   If neither amount nor codes entered, set pattern to blank
     C*
     C                     ELSE
     C                     MOVE ' '       CCPT
     C                     END
     C*
     C                     END
     C*
     C**   Set up other fields from the screen entries
     C*
     C                     MOVE SCCMC     CCMC
     C                     MOVE SCCMS     CCMS
     C                     Z-ADDWCCMA     CCMA
     C                     MOVE SCCHC     CCHC
     C                     Z-ADDWCCHA     CCHA
     C                     MOVE SCSLT     CSLT
     C                     MOVE WCSLA     CSLA
     C                     MOVE WCSBR     BRSC                            S01117
     C                     MOVE WCBID     CBID                            S01117
     C                     MOVE SCFAO     CFAO
     C*
     C**   If customer shortname needed flag set on, write customer
     C**   number for shortname to file, else write screen field
     C**   to file
     C           CSNAME    IFEQ 1
     C                     MOVELCNUMC     CCPN
     C                     Z-ADD0         CSNAME
     C                     ELSE
     C                     MOVELSCCPN     CCPN
     C                     END
     C/COPY WNCPYSRC,FF0040C071
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPCFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           CCMC      IFNE *ZEROS                                    CFF007
     C           CCMA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CMCC                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CMCC                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           CCHC      IFNE *ZEROS                                    CFF007
     C           CCHA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CHCC                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CHCC                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C**   Blank/zeroise fields if Customer not present
     C*
     C                     ELSE
     C                     MOVE ' '       CCPT
     C                     Z-ADD0         CCMC
     C                     Z-ADD0         CCMS
     C                     Z-ADD0         CCMA
     C                     Z-ADD0         CCHC
     C                     Z-ADD0         CCHA
     C                     Z-ADD0         CSLT
     C                     MOVE *BLANK    CSLA
     C                     MOVE *BLANK    BRSC                            S01117
     C                     MOVE *BLANK    CBID                            S01117
     C                     MOVE *BLANK    CFAO
     C                     MOVE *BLANK    CCPN
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP30                                           S01408
     C*                                                                   S01408
     C                     END
     C*
     C                     Z-ADD0         CMAR
     C                     Z-ADD0         CCHP
     C                     Z-ADD0         CCMP
     C*
     C**   Write new record to LF/TRSET
     C*
     C                     WRITETRSETDF
      *                                                                                       CRE020
      ** If CRE020 is Installed, call Settlement Advice Subroutine                            CRE020
      *                                                                                       CRE020
     C           CRE020    IFEQ 'Y'                                                           CRE020
     C           PSVAL     ANDEQ'Y'                                                           CRE020
      *                                                                                       CRE020
     C                     EXSR SRADVC                                                        CRE020
      *                                                                                       CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP31                                           S01408
     C*                                                                   S01408
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UTRANS SR. -  Update LF/TRANS main                            *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDAMD                                                *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UTRANS    BEGSR                           ** UTRANS SR **
     C*
     C**   Amend - Update Narrative and control fields on LF/TRANS
     C*
     C           SACTN     IFEQ 'A'
     C                     MOVE STNAR     TNAR
     C*
     C           XLCD      IFNE CTDATE
     C                     MOVE 'A'       CHTP
     C                     END
     C*
     C**   Delete - Update RECI and control fields on LF/TRANS
     C*
     C                     ELSE
     C                     MOVE '*'       RECI
     C                     MOVE 'D'       CHTP
     C                     END
     C*
     C                     Z-ADDCTDATE    LCD
     C                     Z-ADDNATN      TNLU
      *                                                                                       CSD015
      ** Perform compliance watch processing before updating record                           CSD015
      ** if compliance watch is installed and entry watch list checking                       CSD015
      ** is set to 'Y'                                                                        CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           CSD015
      *                                                                                       CSD015
     C           CSC011    IFNE 'Y'                                                           CSD015
     C           CSC011    OREQ 'Y'                                                           CSD015
     C           S1MAIN    ANDEQLIBR                                                          CSD015
      *                                                                                       CSD015
      ** Set up KLIST fields for accessing compliance watch hit list                          CSD015
      ** to check for hit status.                                                             CSD015
      *                                                                                       CSD015
     C                     MOVEL'TRANSD  'KFUNT                                               CSD015
     C                     MOVELTNBR      KIDEN                                               CSD015
     C                     MOVELBRCA      KBRCH                                               CSD015
      *                                                                                       CSD015
      ** Check status of item in compliance watch hit list                                    CSD015
      *                                                                                       CSD015
     C           KCWHTL    CHAINSDCWHTL1             71                                       CSD015
     C           *IN71     IFEQ '1'                                                           CSD015
     C                     MOVE *BLANKS   W3UNCF                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVEA*BLANKS   WLF,1                                               CSD015
     C                     MOVE 'N'       WCWFLG  1                                           CSD015
      *                                                                                       CSD015
      ** For UNCONFIRMED status, send all watch list fields that are                          CSD015
      ** not blank                                                                            CSD015
      *                                                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
      *                                                                                       CSD015
     C           WBSLA     IFNE *BLANKS                                                       CSD015
     C                     MOVELWBSLA     WLF,1                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           WCSLA     IFNE *BLANKS                                                       CSD015
     C                     MOVELWCSLA     WLF,4                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           BSNAME    IFEQ 1                                                             CSD015
     C********** CNUMB     ANDNE0                                                      CSD015 CSD027
     C           CNUMB     ANDNE*BLANKS                                                       CSD027
     C                     MOVELCNUMB     WLF,3                                               CSD015
     C                     ELSE                                                               CSD015
     C           SBCPN     IFNE *BLANKS                                                       CSD015
     C                     MOVELSBCPN     WLF,3                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           CSNAME    IFEQ 1                                                             CSD015
     C********** CNUMC     ANDNE0                                                      CSD015 CSD027
     C           CNUMC     ANDNE*BLANKS                                                       CSD027
     C                     MOVELCNUMC     WLF,6                                               CSD015
     C                     ELSE                                                               CSD015
     C           SCCPN     IFNE *BLANKS                                                       CSD015
     C                     MOVELSCCPN     WLF,6                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           SBFAO     IFNE *BLANKS                                                       CSD015
     C                     MOVELSBFAO     WLF,2                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           SCFAO     IFNE *BLANKS                                                       CSD015
     C                     MOVELSCFAO     WLF,5                                               CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check that at least one of the watch list fields is not blank                        CSD015
      *                                                                                       CSD015
     C                     Z-ADD6         WY      20                                          CSD015
     C                     Z-ADD1         WX      20                                          CSD015
      *                                                                                       CSD015
     C           WX        DOUGTWY                                                            CSD015
     C           WCWFLG    OREQ 'Y'                                                           CSD015
     C           WLF,WX    IFNE *BLANKS                                                       CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ADD  1         WX                                                  CSD015
     C                     ENDDO                                                              CSD015
      *                                                                                       CSD015
      ** Otherwise, send only watch list fields that have changed and                         CSD015
      ** are not blank.                                                                       CSD015
      *                                                                                       CSD015
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
     C           WBSLA     IFNE BSLA                                                          CSD015
     C           WBSLA     ANDNE*BLANKS                                                       CSD015
     C                     MOVELWBSLA     WLF,1                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           WCSLA     IFNE CSLA                                                          CSD015
     C           WCSLA     ANDNE*BLANKS                                                       CSD015
     C                     MOVELWCSLA     WLF,4                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVELCNUMB     WCNUMB  6                                           CSD015
     C           BSNAME    IFEQ 1                                                             CSD015
     C           WCNUMB    ANDNEBCPN                                                          CSD015
     C           WCNUMB    ANDNE*BLANKS                                                       CSD015
     C                     MOVELCNUMB     WLF,3                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ELSE                                                               CSD015
     C           SBCPN     IFNE BCPN                                                          CSD015
     C           SBCPN     ANDNE*BLANKS                                                       CSD015
     C                     MOVELSBCPN     WLF,3                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVELCNUMC     WCNUMC  6                                           CSD015
     C           CSNAME    IFEQ 1                                                             CSD015
     C           WCNUMC    ANDNECCPN                                                          CSD015
     C           WCNUMC    ANDNE*BLANKS                                                       CSD015
     C                     MOVELCNUMC     WLF,6                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ELSE                                                               CSD015
     C           SCCPN     IFNE CCPN                                                          CSD015
     C           SCCPN     ANDNE*BLANKS                                                       CSD015
     C                     MOVELSCCPN     WLF,6                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     END                                                                CSD015
      *                                                                                       CSD015
     C           SBFAO     IFNE BFAO                                                          CSD015
     C           SBFAO     ANDNE*BLANKS                                                       CSD015
     C                     MOVELSBFAO     WLF,2                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           SCFAO     IFNE CFAO                                                          CSD015
     C           SCFAO     ANDNE*BLANKS                                                       CSD015
     C                     MOVELSCFAO     WLF,5                                               CSD015
     C                     MOVE 'Y'       WCWFLG                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** If conditions above are met, check if 24x7 is not installed.                         CSD015
      ** If it is installed, system should be in the main system                              CSD015
      *                                                                                       CSD015
     C           WCWFLG    IFEQ 'Y'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C*
     C**   Update record
     C*
     C                     EXCPTETRANS
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UTRSET SR. -  Update  LF/TRSET main                           *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDAMD                   SR. DBERR                    *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UTRSET    BEGSR                           ** UTRSET SR **
     C*
     C**   Access LF/TRSET main
     C*
     C           KTNBR     CHAINTRSET                71
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '23'      DBASE            ***************S01117
     C                     Z-ADD23        DBASE            ***************S01117
     C                     MOVE 'TRSET'   DBFILE           * DB ERROR 23 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C                     ELSE
     C*
     C           PUPF      IFEQ 'N'
     C                     Z-ADDPRMP      PRMPS
     C                     ELSE
     C                     Z-ADD0         PRMPS
     C                     END
     C*
     C                     END
     C*
     C**   Delete
     C*
     C           SACTN     IFEQ 'D'
     C                     MOVE '*'       RECI
     C                     EXCPTDTRSET
      *                                                                                       CRE020
      ** If CRE020 is Installed, call Settlement Advice Subroutine                            CRE020
      *                                                                                       CRE020
     C           CRE020    IFEQ 'Y'                                                           CRE020
     C           PSVAL     ANDEQ'Y'                                                           CRE020
      *                                                                                       CRE020
     C                     EXSR SRADVC                                                        CRE020
      *                                                                                       CRE020
     C                     ENDIF                                                              CRE020
     C*
     C**   Amend
     C*
     C                     ELSE
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP32                                           S01408
     C*                                                                   S01408
     C*
     C**   - Broker Settlement details
     C*
     C           SBOCO     IFNE *BLANK
     C*
     C**   If an amount is entered, set pattern to 'A'
     C*
     C           SBCMA     IFEQ 'A'
     C           WBCMA     ORNE 0
     C                     MOVE 'A'       BCPT
     C                     ELSE
     C*
     C**   If codes are entered, use default pattern
     C*
     C           SBCM      IFNE '    '
     C                     EXSR ABRCPT
     C                     MOVE WBCPT     BCPT
     C*
     C**   If default pattern is blank, set pattern to 'A'
     C*
     C           BCPT      IFEQ ' '
     C                     MOVE 'A'       BCPT
     C                     END
     C*
     C**   If neither amount nor codes entered, set pattern to blank
     C*
     C                     ELSE
     C                     MOVE ' '       BCPT
     C                     END
     C*
     C                     END
     C*
     C**   Set up other fields from the screen entries
     C*
     C                     MOVE SBCMC     BCMC
     C                     MOVE SBCMS     BCMS
     C                     Z-ADDWBCMA     BCMA
     C                     MOVE SBCHC     BCHC
     C                     Z-ADDWBCHA     BCHA
     C                     MOVE SBSLT     BSLT
     C                     MOVE WBSLA     BSLA
     C                     MOVE WBSBR     BSBR                            S01117
     C                     MOVE WBBID     BBID                            S01117
     C                     MOVE SBFAO     BFAO
     C*
     C**   If broker shortname needed flag set on, write customer
     C**   number for shortname to file, else write screen field
     C**   to file
     C           BSNAME    IFEQ 1
     C                     MOVELCNUMB     BCPN
     C                     Z-ADD0         BSNAME
     C                     ELSE
     C                     MOVELSBCPN     BCPN
     C                     END
     C/COPY WNCPYSRC,FF0040C072
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPBFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           BCMC      IFNE *ZEROS                                    CFF007
     C           BCMA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CMCB                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CMCB                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           BCHC      IFNE *ZEROS                                    CFF007
     C           BCHA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CHCB                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CHCB                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C                     END
     C*
     C**     - Customer Settlement details
     C*
     C           SCUSC     IFNE *BLANK
     C*
     C**   If an amount is entered, set pattern to 'A'
     C*
     C           SCCMA     IFEQ 'A'
     C           WCCMA     ORNE 0
     C                     MOVE 'A'       CCPT
     C                     ELSE
     C*
     C**   If codes are entered, use default pattern
     C*
     C           SCCM      IFNE '    '
     C                     EXSR ACUCPT
     C                     MOVE WCCPT     CCPT
     C*
     C**   If default pattern is blank, set pattern to 'A'
     C*
     C           CCPT      IFEQ ' '
     C                     MOVE 'A'       CCPT
     C                     END
     C*
     C**   If neither amount nor codes entered, set pattern to blank
     C*
     C                     ELSE
     C                     MOVE ' '       CCPT
     C                     END
     C*
     C                     END
     C*
     C**   Set up other fields from the screen entries
     C*
     C                     MOVE SCCMC     CCMC
     C                     MOVE SCCMS     CCMS
     C                     Z-ADDWCCMA     CCMA
     C                     MOVE SCCHC     CCHC
     C                     Z-ADDWCCHA     CCHA
     C                     MOVE SCSLT     CSLT
     C                     MOVE WCSLA     CSLA
     C                     MOVE WCSBR     BRSC                            S01117
     C                     MOVE WCBID     CBID                            S01117
     C                     MOVE SCFAO     CFAO
     C*
     C**   If customer shortname needed flag set on, write customer
     C**   number for shortname to file, else write screen field
     C**   to file
     C           CSNAME    IFEQ 1
     C                     MOVELCNUMC     CCPN
     C                     Z-ADD0         CSNAME
     C                     ELSE
     C                     MOVELSCCPN     CCPN
     C                     END
     C*
     C/COPY WNCPYSRC,FF0040C073
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           WPCFLG    ANDEQ'Y'                                       CFF007
      *                                                                   CFF007
     C           CCMC      IFNE *ZEROS                                    CFF007
     C           CCMA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CMCC                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CMCC                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           CCHC      IFNE *ZEROS                                    CFF007
     C           CCHA      ANDNE*ZEROS                                    CFF007
     C                     MOVE 'Y'       CHCC                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CHCC                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C                     END
     C*
     C**   Update record
     C*
     C                     UPDATTRSETDF
      *                                                                                       CRE020
      ** If CRE020 is Installed, call Settlement Advice Subroutine                            CRE020
      *                                                                                       CRE020
     C           CRE020    IFEQ 'Y'                                                           CRE020
     C           PSVAL     ANDEQ'Y'                                                           CRE020
      *                                                                                       CRE020
     C                     EXSR SRADVC                                                        CRE020
      *                                                                                       CRE020
     C                     ENDIF                                                              CRE020
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0040CP33                                           S01408
     C*                                                                   S01408
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   ABRCPT SR. - Access Broker Commission Pattern for Amend       *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UTRSET                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           ABRCPT    BEGSR                           ** ABRCPT SR **
     C*
     C**   Access  Broker Defaults from LF/DEFLT
     C*
     C                     MOVELSBOCO     KCBCD
     C*
     C           KDEFLT    CHAINDEFLT                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C           *IN71     IFEQ '0'
     C           CPAT      ANDNE' '
     C*
     C**   - from LF/DEFLT
     C*
     C                     MOVE CPAT      WBCPT
     C                     ELSE
     C*
     C**   - from LF/INTYP
     C*
     C                     MOVE BCPTX     WBCPT
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   ACUCPT SR. - Access Customer Commission Pattern for Amend     *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UTRSET                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           ACUCPT    BEGSR                           ** ACUCPT SR **
     C*
     C**   Access Customer Defaults from LF/DEFLT
     C*
     C                     MOVELSCUSC     KCBCD
     C*
     C           KDEFLT    CHAINDEFLT                71
     C  N71      RECI      COMP 'D'                  7171
     C*
     C           *IN71     IFEQ '0'
     C           CPAT      ANDNE' '
     C*
     C**   - from LF/DEFLT
     C*
     C                     MOVE CPAT      WCCPT
     C                     ELSE
     C*
     C**   - from LF/INTYP
     C*
     C                     MOVE CCPTX     WCCPT
     C                     END
     C**
     C                     ENDSR
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UTTRAN SR. -  Update LF/TRANS Trade record                    *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                                                *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UTTRAN    BEGSR                           ** UTTRAN SR **
     C*
     C**   Calculate number of open contracts
     C*
     C**   - Insert
     C*
     C                     SETOF                     1216
     C           SACTN     IFEQ 'I'
     C           RECI      COMP '*'                      16
     C           NOCO      SUB  WNCTE     WNOCO   50   1279
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCIS     ANDEQ'N'
     C           NOBO      SUB  WNCTE     WNOBO   50
     C                     ELSE
     C                     Z-ADDNOBO      WNOBO
     C                     END
     C*
     C**   - Delete
     C*
     C                     ELSE
     C           OTRSD     COMP TRSD                     78
     C           NOCO      ADD  WNCTE     NOCO
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCI      ANDEQ'N'
     C           NOBO      ADD  WNCTE     NOBO
     C                     END
     C*
     C                     END
     C*
     C**   Update Relevant fields on LF/TRANS Trade record
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     MOVE 'N'       FBIN
     C                     END
     C*
     C                     MOVE 'N'       FCIN
     C                     Z-ADDNATN      TNLU
     C*
     C**   Update record
     C*
     C           *IN12     IFEQ '0'
     C           *IN16     ANDEQ'0'
     C*
     C           SACTN     IFEQ 'I'
     C                     Z-ADDWNOCO     NOCO
     C                     Z-ADDWNOBO     NOBO
     C                     END
     C*
     C                     EXCPTTTRANS
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UTTRST SR. -  Update LF/TRSET Trade record                    *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. DBERR                    *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UTTRST    BEGSR                           ** UTTRST SR **
     C*
     C**   Access LF/TRSET Trade record
     C*
     C           KTNBR     CHAINTRSET                71
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '24'      DBASE            ***************S01117
     C                     Z-ADD24        DBASE            ***************S01117
     C                     MOVE 'TRSET'   DBFILE           * DB ERROR 24 *
     C                     MOVELKTNBR     DBKEY            ***************
     C                     EXSR DBERR
     C*
     C                     ELSE
     C                     Z-ADDBMAR      XBMAR  130
     C                     Z-ADDCMAR      XCMAR  130
     C                     END
     C*
     C**   Insert
     C*
     C           SACTN     IFEQ 'I'
     C*
     C**   Output depends on Transaction Dates of Trade and Exercise
     C**   - and on whether a Customer is present
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C           *IN78     IFEQ '0'
     C           OCSC      ADD  WNCTE     OCSC
     C                     ELSE
     C           OCDC      ADD  WNCTE     OCDC
     C                     END
     C*
     C                     END
     C*
     C**   - and on whether a Broker is present
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCIS     ANDEQ'N'
     C*
     C           *IN78     IFEQ '0'
     C           OCSB      ADD  WNCTE     OCSB
     C                     ELSE
     C           OCDB      ADD  WNCTE     OCDB
     C                     END
     C*
     C                     END
     C*
     C**   If Trade is now fully closed out, zeroise margins unless
     C**   they are negative
     C*
     C           *IN79     IFEQ '1'
     C*
     C           BMAR      IFGT 0
     C                     Z-ADD0         BMAR
     C                     END
     C*
     C           CMAR      IFGT 0
     C                     Z-ADD0         CMAR
     C                     END
     C*
     C                     END
     C*
     C**   Delete
     C*
     C**   Output depends on Transaction Dates of Trade and Exercise
     C*
     C                     ELSE
     C*
     C**   - and on whether a Customer is present
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C           *IN78     IFEQ '0'
     C           OCSC      SUB  WNCTE     OCSC
     C                     ELSE
     C           OCDC      SUB  WNCTE     OCDC
     C                     END
     C*
     C                     END
     C*
     C**   - and on whether a Broker is present
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCI      ANDEQ'N'
     C*
     C           *IN78     IFEQ '0'
     C           OCSB      SUB  WNCTE     OCSB
     C                     ELSE
     C           OCDB      SUB  WNCTE     OCDB
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Update record
     C*
     C                     EXCPTTTRSET
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   WCLST SR. -  Write LF/CLOST record                            *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. FFPLCL                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           WCLST     BEGSR                           ** WCLST SR  **
     C*
     C**   Access DTAARA/NACON Next available Close-out number
     C*
     C           *LOCK     IN   NACON
     C                     Z-ADDNCON      CLON
     C                     ADD  1         NCON
     C                     OUT  NACON
     C*
     C**   Set up fields for output
     C*
     C                     MOVE 'D'       RECI
     C***********          MOVE SBRCD     BRCD                            S01117
     C                     MOVE SBRCA     BRCA                            S01117
     C                     MOVELWCUSC     CUSC
     C                     MOVE SBOKC     BOKC
     C                     MOVE ISTT      ISTT
     C                     MOVE SPCAL     PCAL
     C                     Z-ADDWSTRP     STRP
     C                     MOVE ISCY      ISCY
     C                     Z-ADDCTDATE    CLOD
     C                     MOVE 'E'       CLOT
     C                     MOVE 'N'       CORI
     C                     MOVE 'Y'       SHPI
     C                     MOVE 'N'       ECPI
     C                     Z-ADDCTDATE    LCD
     C                     MOVE 'I'       CHTP
     C                     Z-ADDNATN      TNLU
     C*
     C**   Calculate Realised P & L using standard SR. FFPLCL
     C*
     C                     Z-ADDWNCTE     FFNOC
     C                     Z-ADDTKDMX     FFTKDM
     C                     Z-ADDTKVLX     FFTKVL
     C                     Z-ADDMNPFX     FFMNPF
     C*
     C**   Which Price is which depends on PCAL
     C*
     C           SPCAL     IFEQ 'C'
     C                     Z-ADDWEXPR     FFPRCX
     C                     Z-ADDSTRPS     FFPRCY
     C                     ELSE
     C                     Z-ADDWEXPR     FFPRCY
     C                     Z-ADDSTRPS     FFPRCX
     C                     END
     C*
     C                     EXSR FFPLCL
     C*
     C           STRTY     IFEQ 'P'
     C                     Z-ADDFFPOL     COPL
     C                     ELSE
     C                     Z-SUBFFPOL     COPL
     C                     END
     C*
     C                     Z-ADDFFPOL     COPLS
     C*
     C**   Some fields are output differently for OTC's and Market Inst's
     C*
     C**   - Market instrument
     C*
     C           PMRKT     IFNE '  '
     C                     MOVELWBOCO     BOCO
     C                     MOVE SYRNO     YRNO
     C                     MOVE MTHN      MTHN
     C*
     C**   - O.T.C.
     C*
     C                     ELSE
     C**********           Z-ADD0         BOCO                                                CSD027
     C                     MOVE *BLANKS   BOCO                                                CSD027
     C                     Z-ADD0         YRNO
     C                     Z-ADD0         MTHN
     C                     END
     C/COPY WNCPYSRC,FF0040C074
     C           CFF007    IFEQ 'Y'                                       CFF007
     C                     MOVE *BLANKS   STTA                            CFF007
     C                     MOVE *BLANKS   STTB                            CFF007
     C********** CUSC      IFNE *ZEROS                                                 CFF007 CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*                                                                   CFF007
     C**********           Z-ADDCUSC      KCBCD                                        CFF007 CSD027
     C                     MOVE CUSC      KCBCD                                               CSD027
     C                     MOVE PMKTN     KMRKT                           CFF007
     C                     MOVELISTT      KISTC                           CFF007
     C*                                                                   CFF007
     C           KDEFLT    CHAINDEFLT                10                   CFF007
     C*                                                                   CFF007
     C                     MOVE *BLANKS   WWSETP  2                       CFF007
     C**********           MOVE *BLANKS   WWSTTA 12                                    CFF007 CGL029
     C                     MOVE *BLANKS   WWSTTA 18                                           CGL029
     C                     MOVE *BLANKS   WWSEBR  3                       CFF007
     C                     MOVE *BLANKS   WWSECY  3                       CFF007
     C*                                                                   CFF007
     C           *IN10     IFEQ '1'                                       CFF007
     C           *IN10     OREQ '0'                                       CFF007
     C           SETP      ANDEQ*ZEROS                                    CFF007
     C                     MOVE CUSC      PCUST   6                       CFF007
     C                     CALL 'AOFOCSR0'                                CFF007
     C                     PARM *BLANK    PRTCD   7                       CFF007
     C                     PARM '*KEY   ' POPTN   7                       CFF007
     C                     PARM           PCUST                           CFF007
     C           SDFOCS    PARM SDFOCS    DSSDY                           CFF007
     C*                                                                   CFF007
     C           PRTCD     IFEQ *BLANKS                                   CFF007
     C                     MOVE BHSTTY    WWSETP                          CFF007
     C                     MOVE BHSMAC    WWSTTA                          CFF007
     C                     MOVE BHSEBR    WWSEBR                          CFF007
     C                     MOVE BHCYCD    WWSECY                          CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     ELSE                                           CFF007
     C                     MOVE SETP      WWSETP                          CFF007
     C                     MOVE SETA      WWSTTA                          CFF007
     C                     MOVE SEBR      WWSEBR                          CFF007
     C                     MOVE ISCY      WWSECY                          CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C           WWSETP    IFNE *BLANKS                                   CFF007
      *                                                                   CFF007
      ** 01 - Nostro by Telex                                             CFF007
      ** 07 - Nostro by CHIPS                                             CFF007
      ** 08 - Nostro by SWIFT                                             CFF007
     C           WWSETP    IFEQ '01'                                      CFF007
     C           WWSETP    OREQ '07'                                      CFF007
     C           WWSETP    OREQ '08'                                      CFF007
     C                     MOVELWWSTTA    WWNOSN  2                       CFF007
     C                     CALL 'AONOSTR0'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*KEY    'POPTN                           CFF007
     C                     PARM *BLANKS   P@CUST  6                       CFF007
     C                     PARM ISCY      P@CYCD  3                       CFF007
     C**********           PARM *BLANKS   P@ACCD  4                                    CFF007 CGL029
     C                     PARM *BLANKS   P@ACCD 10                                           CGL029
     C                     PARM *BLANKS   P@ACSN  2                       CFF007
     C                     PARM WWNOSN    P@NONB  2                       CFF007
     C                     PARM *BLANKS   P@BRCD  3                       CFF007
     C                     PARM *BLANKS   P@CSSN 10                       CFF007
     C                     PARM *BLANKS   P@PNOI  1                       CFF007
     C           SDNOST    PARM SDNOST    DSSDY                           CFF007
      *                                                                   CFF007
     C           PRTCD     IFEQ *BLANKS                                   CFF007
     C                     MOVELA7CUST    WSTTA1  9                       CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C**********           MOVELA7ACCD    WSTTA2  6                                    CFF007 CGL029
     C                     MOVELA7ACCD    WSTTA2 12                                           CGL029
     C                     MOVE A7ACSN    WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE A7BRCD    WWSEBR                          CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** 04 - Counterparty's prime retail account                         CFF007
      ** 15 - Counterparty designated account                             CFF007
     C           WWSETP    IFEQ '04'                                      CFF007
     C           WWSETP    OREQ '15'                                      CFF007
     C                     MOVELCUSC      WSTTA1                          CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C           WWSETP    IFEQ '04'                                      CFF007
     C                     MOVELCADC      WSTTA2                          CFF007
     C                     ELSE                                           CFF007
     C                     MOVELDFCA      WSTTA2                          CFF007
     C                     ENDIF                                          CFF007
     C                     MOVE '01'      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
      *                                                                   CFF007
     C                     MOVELCUSC      WWKY10    P                     CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   PRTCD                           CFF007
     C                     PARM '*KEY   ' POPTN                           CFF007
     C                     PARM           WWKY10                          CFF007
     C                     PARM           @KYST                           CFF007
     C           SDCUST    PARM SDCUST    DSLDY                           CFF007
      *                                                                   CFF007
     C                     MOVE BBBRCD    WWSEBR                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** 05 - Any Account                                                 CFF007
     C           WWSETP    IFEQ '05'                                      CFF007
     C**********           MOVELWWSTTA    WSTTA2                                       CFF007 CGL029
     C**********           MOVE WWSTTA    WSTTA1                                       CFF007 CGL029
     C**********           MOVELISCY      WSTTA1                                       CFF007 CGL029
     C**********           MOVELWSTTA2    STTA                                         CFF007 CGL029
     C**********           MOVE WSTTA1    STTA                                         CFF007 CGL029
     C                     MOVELWWSTTA    WSTTA1                                              CGL029
     C                     MOVE ISCY      WSTTA1                                              CGL029
     C                     MOVE WWSTTA    WSTTA2                                              CGL029
     C                     MOVELWSTTA1    STTA                                                CGL029
     C                     MOVE WSTTA2    STTA                                                CGL029
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** 06 - Suspense Account                                            CFF007
     C           WWSETP    IFEQ '06'                                      CFF007
     C                     MOVELBICN      WSTTA1                          CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C                     MOVELCOMS      WSTTA2                          CFF007
     C                     MOVE '01'      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE A8BRCD    WWSEBR                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** 14 - Any Current Account                                         CFF007
     C           WWSETP    IFEQ '14'                                      CFF007
     C                     MOVELWWSTTA    KACNO  100                      CFF007
     C           KACNO     CHAINACNUM                10                   CFF007
     C           *IN10     IFEQ '0'                                       CFF007
     C                     MOVELCNUM      WSTTA1                          CFF007
     C                     MOVE CCY       WSTTA1                          CFF007
     C                     MOVELACOD      WSTTA2                          CFF007
     C                     MOVE ACSQ      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE BRCA      WWSEBR                          CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           STTA      IFEQ *BLANKS                                   CFF007
     C                     MOVELBICN      WSTTA1                          CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C                     MOVELCOMS      WSTTA2                          CFF007
     C                     MOVE '01'      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE A8BRCD    WWSEBR                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           BGPFMG    IFEQ 'Y'                                       CFF007
     C           FCPORS    ANDNE'B'                                       CFF007
     C           BGN4ST    OREQ 'Y'                                       CFF007
      *                                                                   CFF007
      **   If the display field is equal to the "reference attached to    CFF007
      **   9997 portfolio"                                                CFF007
     C           SPTFR     IFEQ FCR997                                    CFF007
     C           SPTFR     ANDNE*BLANKS                                   CFF007
     C           BGN4ST    ANDNE'Y'                                       CFF007
     C                     MOVEL'9997'    PTFR                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVELSPTFR     PTFR                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C           STTA      IFNE *BLANKS                                   CFF007
     C           STTB      ANDEQ*BLANKS                                   CFF007
     C                     MOVE WWSEBR    STTB                            CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     MOVE 'D'       RECI                            CFF007
     C                     Z-ADDCTDATE    LCD                             CFF007
     C                     MOVE 'I'       CHTP                            CFF007
     C                     Z-ADDNATN      TNLU                            CFF007
     C                     ENDIF                                          CFF007
     C*
     C**   Write record to LF/CLOST
     C*
     C                     WRITECLOSTDF
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   WCLST2 SR. -  Write LF/CLOST2 records                         *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           WCLST2    BEGSR                           ** WCLST2 SR **
     C*
     C**   Set up fields for output to both records
     C*
     C                     MOVE 'D'       RECI
     C                     Z-ADDCLON      CLON
     C                     Z-ADDWNCTE     NCCL
     C                     MOVE *BLANK    FCLI
     C*
     C**   Set up fields for output to Exercise record only
     C*
     C                     MOVE STNBR     TNBR
     C                     Z-ADDOTRSD     TRSD
     C                     MOVE 'E'       TRTY
     C*                                                                   E03643
     C********** BOCO      IFNE 0                                                      E03643 CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCIS     ANDEQ'N'                                       E03643
     C                     Z-ADD0         OCOB                            E03643
     C                     Z-ADDWNCTE     CCOB                            E03643
     C                     ELSE                                           E03643
     C                     Z-ADD0         OCOB                            E03643
     C                     Z-ADD0         CCOB                            E03643
     C                     END                                            E03643
     C*                                                                   E03643
     C********** CUSC      IFNE 0                                                      E03643 CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     Z-ADD0         OCOC                            E03643
     C                     Z-ADDWNCTE     CCOC                            E03643
     C                     ELSE                                           E03643
     C                     Z-ADD0         OCOC                            E03643
     C                     Z-ADD0         CCOC                            E03643
     C                     END                                            E03643
     C*
     C**   Write Exercise record to LF/CLOST2
     C*
     C                     WRITECLOSTTF
     C*
     C**   Set up fields for output to Trade record only
     C*
     C                     MOVE SCLSR     TNBR
     C                     Z-ADDTRSDS     TRSD
     C                     MOVE STRTY     TRTY
     C*                                                                   E03643
     C********** CUSC      IFNE 0                                                      E03643 CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*                                                                   E03643
     C                     Z-ADD0         CCOC                            E03643
     C                     Z-ADDWNCTE     OCOC                            E03643
     C*                                                                   E03643
     C                     ELSE                                           E03643
     C*                                                                   E03643
     C                     Z-ADD0         CCOC                            E03643
     C                     Z-ADD0         OCOC                            E03643
     C                     END                                            E03643
     C*                                                                   E03643
     C**   - and on whether a Broker is present                           E03643
     C*                                                                   E03643
     C********** BOCO      IFNE 0                                                      E03643 CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PSCIS     ANDEQ'N'                                       E03643
     C*                                                                   E03643
     C                     Z-ADD0         CCOB                            E03643
     C                     Z-ADDWNCTE     OCOB                            E03643
     C*                                                                   E03643
     C                     ELSE                                           E03643
     C                     Z-ADD0         CCOB                            E03643
     C                     Z-ADD0         OCOB                            E03643
     C*                                                                   E03643
     C                     END                                            E03643
     C*                                                                   E03643
     C*
     C**   Write Trade record to LF/CLOST2
     C*
     C                     WRITECLOSTTF
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UCLST SR. -  Update LF/CLOST record                           *
     C**   ~~~~~~~~~                                                     *
     C**      Called From                  Calls                         *
     C**       SR. UPDDEL                   SR. DBERR                    *
     C**                                                                 *
     C********************************************************************
     C*
     C           UCLST     BEGSR                           ** UCLST SR  **
     C*
     C**   Access LF/CLOST2 record for the deleted exercise
     C*
     C                     MOVE STNBR     KTNBR
     C                     Z-ADD0         KCLON
     C                     MOVELSTNBR     CLST2K 12
     C                     MOVE '000000'  CLST2K
     C           KCLST2    SETLLCLOST2
     C                     READ CLOST2                   71
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           TNBR      ORNE KTNBR
     C           *LOCK     IN   LDA
     C***********          MOVE '25'      DBASE            ***************S01117
     C                     Z-ADD25        DBASE            ***************S01117
     C                     MOVE 'CLST2'   DBFILE           * DB ERROR 25 *
     C                     MOVELCLST2K    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   If it is found, Chain to the related LF/CLOST record for update
     C*
     C           CLON      CHAINCLOST                71
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '26'      DBASE            ***************S01117
     C                     Z-ADD26        DBASE            ***************S01117
     C                     MOVE 'CLOST'   DBFILE           * DB ERROR 26 *
     C                     MOVELCLON      DBKEY            ***************
     C                     EXSR DBERR
     C                     ELSE
     C*
      **   Determine Profit/loss direction for deletion amount
      **    dependent on original purchase/sale
     C*
     C           STRTY     IFEQ 'P'
     C                     Z-ADDCOPL      COPLS
     C                     ELSE
     C                     Z-SUBCOPL      COPLS  130
     C                     END
     C*
     C                     END
     C*
     C**   Set up fields for update
     C*
     C                     MOVE 'Y'       CORI
     C                     Z-ADDCTDATE    LCD
     C                     MOVE 'A'       CHTP
     C                     Z-ADDNATN      TNLU
     C*
     C**   Update record in LF/CLOST
     C*
     C                     EXCPTCLOSTU
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UAMEMS SR. -  Update LF/MEMOSM :                              *
     C**   ~~~~~~~~~~              Apply Retail A/c Shadow Balance       *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                                                *
     C**       SR. UPDAMD                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UAMEMS    BEGSR                           ** UAMEMS SR **
     C*
     C**   Attempt to access LF/MEMOSM
     C*
     C***********FFACTK    CHAINMEMOSM               71                   S01117
     C           KMEMOS    CHAINMEMOSM               71                   S01117
     C*
     C           *IN71     IFEQ '1'
     C                     Z-ADD0         LDBL
     C                     Z-ADD0         CLBL
     C                     END
     C**                                                                  S01240
     C**   Store Ledger Balance in a work field for use in SR. WACMVD     S01240
     C                     Z-ADDLDBL      WLDBL  150                      S01240
     C*
     C**   'Apply' updates due to the new trade
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LDBL      SUB  PRMPS     LDBL
     C           CLBL      SUB  PRMPS     CLBL
     C           LDBL      ADD  COPLS     LDBL
     C           CLBL      ADD  COPLS     CLBL
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LDBL      ADD  PRMPS     LDBL
     C           CLBL      ADD  PRMPS     CLBL
     C           LDBL      SUB  COPLS     LDBL
     C           CLBL      SUB  COPLS     CLBL
     C                     END
     C*
     C**   Update LF/MEMOSM
     C*
     C           *IN71     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     MOVE FFCNUM    CNUM
     C                     MOVE FFCCY     CCY
     C                     MOVE FFACOD    ACOD
     C                     MOVE FFACSQ    ACSQ
     C                     MOVE FFBRCB    BRCA                            S01117
     C                     WRITEMEMOSMEF
     C*
     C                     ELSE
     C                     UPDATMEMOSMEF
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   URMEMS SR. -  Update LF/MEMOSM :                              *
     C**   ~~~~~~~~~~        Reverse out retail A/c Shadow Balance       *
     C**      Called From                  Calls                         *
     C**       SR. UPDAMD                                                *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           URMEMS    BEGSR                           ** URMEMS SR **
     C*
     C**   Attempt to access LF/MEMOSM
     C*
     C***********FFACTK    CHAINMEMOSM               71                   S01117
     C           KMEMOS    CHAINMEMOSM               71                   S01117
     C*
     C           *IN71     IFEQ '1'
     C                     Z-ADD0         LDBL
     C                     Z-ADD0         CLBL
     C                     END
     C**                                                                  S01240
     C**   Store Ledger Balance in a work field for use in SR. WACMVD     S01240
     C                     Z-ADDLDBL      WLDBL                           S01240
     C*
     C**   Reverse out updates due to the amended trade
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LDBL      ADD  PRMPS     LDBL
     C           CLBL      ADD  PRMPS     CLBL
     C           LDBL      SUB  COPLS     LDBL
     C           CLBL      SUB  COPLS     CLBL
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LDBL      SUB  PRMPS     LDBL
     C           CLBL      SUB  PRMPS     CLBL
     C           LDBL      ADD  COPLS     LDBL
     C           CLBL      ADD  COPLS     CLBL
     C                     END
     C*
     C**   Update LF/MEMOSM
     C*
     C           *IN71     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     MOVE FFCNUM    CNUM
     C                     MOVE FFCCY     CCY
     C                     MOVE FFACOD    ACOD
     C                     MOVE FFACSQ    ACSQ
     C                     MOVE FFBRCB    BRCA                            S01117
     C                     WRITEMEMOSMEF
     C*
     C                     ELSE
     C                     UPDATMEMOSMEF
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UAPRON SR. -  Update LF/PRONOM :                              *
     C**   ~~~~~~~~~~              Apply Projected Nostro Balance        *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                                                *
     C**       SR. UPDAMD                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UAPRON    BEGSR                           ** UAPRON SR **
     C*
     C**   Attempt to access LF/PRONOM
     C*
     C           KPRONO    CHAINPRONOM               71
     C*
     C           *IN71     IFEQ '1'
     C                     Z-ADD0         PNBL
     C                     END
     C**                                                                  S01240
     C**   Store Projected Nostro Balance in a work field for use in      S01240
     C**   SR. WACMVD                                                     S01240
     C                     Z-ADDPNBL      WPNBL  150                      S01240
     C*
     C**   'Apply' updates due to the new trade
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           PNBL      SUB  PRMPS     PNBL
     C           PNBL      ADD  COPLS     PNBL
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           PNBL      ADD  PRMPS     PNBL
     C           PNBL      SUB  COPLS     PNBL
     C                     END
     C*
     C**   Update LF/PRONOM
     C*
     C           *IN71     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     MOVE FFCCY     CCY
     C                     MOVE KNOSNP    NOSN
     C                     WRITEPRONOMEF
     C*
     C                     ELSE
     C                     UPDATPRONOMEF
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   URPRON SR. -  Update LF/PRONOM :                              *
     C**   ~~~~~~~~~~              Reverse out Projected Nostro Balance  *
     C**      Called From                  Calls                         *
     C**       SR. UPDAMD                                                *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           URPRON    BEGSR                           ** URPRON SR **
     C*
     C**   Attempt to access LF/PRONOM
     C*
     C           KPRONO    CHAINPRONOM               71
     C*
     C           *IN71     IFEQ '1'
     C                     Z-ADD0         PNBL
     C                     END
     C**                                                                  S01240
     C**   Store Projected Nostro Balance in a work field for use in      S01240
     C**   SR. WACMVD                                                     S01240
     C                     Z-ADDPNBL      WPNBL                           S01240
     C*
     C*
     C**   Reverse out updates due to the amended trade
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           PNBL      ADD  PRMPS     PNBL
     C           PNBL      SUB  COPLS     PNBL
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           PNBL      SUB  PRMPS     PNBL
     C           PNBL      ADD  COPLS     PNBL
     C                     END
     C*
     C**   Update LF/PRONOM
     C*
     C           *IN71     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     MOVE FFCCY     CCY
     C                     MOVE KNOSNP    NOSN
     C                     WRITEPRONOMEF
     C*
     C                     ELSE
     C                     UPDATPRONOMEF
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************S01240
     C**                                                                 *S01240
     C**   WACMVD SR. -  Write record to PF/FFACMVD                      *S01240
     C**   ~~~~~~~~~~                                                    *S01240
     C**      Called From                  Calls                         *S01240
     C**       SR. UPDINS                                                *S01240
     C**       SR. UPDAMD                                                *S01240
     C**       SR. UPDDEL                                                *S01240
     C**                                                                 *S01240
     C********************************************************************S01240
     C**                                                                  S01240
     C           WACMVD    BEGSR                           ** WACMVD SR **S01240
     C**                                                                  S01240
     C**   Set up fields for output to PF/FFACMVD                         S01240
     C**                                                                  S01240
     C**   Branch Code                                                    S01240
     C*************        MOVE *BLANK    BRCA                      S01240FO0017
     C                     MOVE FOBRCA    BRCA                            FO0017
     C**                                                                  S01240
     C**   Customer Number                                                S01240
     C**********           Z-ADDFFCNUM    CUSN                                         S01240 CSD027
     C                     MOVE FFCNUM    CUSN                                                CSD027
     C**                                                                  S01240
     C**   Currency Code                                                  S01240
     C                     MOVE FFCCY     CCYD                            S01240
     C**                                                                  S01240
     C**   Account Code                                                   S01240
     C                     Z-ADDFFACOD    ACDE                            S01240
     C**                                                                  S01240
     C**   Account Sequence                                               S01240
     C                     Z-ADDFFACSQ    ASNC                            S01240
     C**                                                                  S01240
     C**   Posting Date                                                   S01240
     C                     Z-ADDPRUND     PTDT                            S01240
     C**                                                                  S01240
     C**   Value Date                                                     S01240
     C                     Z-ADDPRUND     VUDT                            S01240
     C**                                                                  S01240
     C**   Transaction Type                                               S01240
     C                     MOVE STRTY     TRYP                            S01240
     C**                                                                  S01240
     C**   Narrative Code                                                 S01240
     C                     Z-ADD0         NRTC                            S01240
     C**                                                                  S01240
     C**   Narrative Description                                          S01240
     C                     MOVELISTN      NRTD                            S01240
     C**                                                                  S01240
     C**   Transaction Number                                             S01240
     C           *IN03     IFEQ '1'                                       S01240
     C           *IN04     OREQ '1'                                       S01240
     C                     MOVE SCLSR     TNMR                            S01240
     C                     ELSE                                           S01240
     C                     MOVE TNBR      TNMR                            S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C**   Cheque Number                                                  S01240
     C                     Z-ADD*ZERO     CQNR                            S01240
     C**                                                                  S01240
     C**   Movement Amount = change in Ledger Balance/Projected           S01240
     C**                     Nostro Balance                               S01240
     C           MPIND     IFEQ 'M'                                       S01240
     C           LDBL      SUB  WLDBL     WMVAM  130                      S01240
     C                     Z-ADDWMVAM     MVAM                            S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C           MPIND     IFEQ 'P'                                       S01240
     C           PNBL      SUB  WPNBL     WMVAM                           S01240
     C                     Z-ADDWMVAM     MVAM                            S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C           MVAM      IFNE *ZERO                                     S01240
     C**                                                                  S01240
     C**   Debit or Credit                                                S01240
     C           MPIND     IFEQ 'M'                                       S01240
     C           LDBL      IFGE WLDBL                                     S01240
     C                     Z-ADD0         DORC                            S01240
     C                     ELSE                                           S01240
     C                     Z-SUBMVAM      MVAM                            S01240
     C                     Z-ADD1         DORC                            S01240
     C                     END                                            S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C**  If Nostro Code is Zero then Settlement Instructions are Blank   FO0025
     C**                                                                  FO0025
     C           MPIND     IFEQ 'P'                                       S01240
     C**                                                                  FO0025
     C           NOSN      IFNE 0                                         FO0025
     C**                                                                  S01240
     C**  Access PF/TABLETL for Customer Number, Account Code, Account    S01240
     C**  Sequence                                                        S01240
     C                     MOVE NOSN      FFNOSN                          S01240
     C           FFNKY     CHAINTABFF                71                   S01240
     C  N71      RECI      COMP 'D'                  7171                 S01240
     C           *IN71     IFEQ '1'                                       S01240
     C           *LOCK     IN   LDA                                       S01240
     C                     MOVE '31'      DBASE            ** DBERR  31 **S01240
     C                     MOVE 'TABFF'   DBFILE                          S01240
     C                     MOVELFFNKY     DBKEY                           S01240
     C                     EXSR DBERR                                     S01240
     C                     ELSE                                           S01240
     C*                                                                   FO0017
     C* BRANCH Not moved from TABLE File because it has the same field    FO0017
     C* name as BRANCH on the Account Movements File (ie BRCA to BRCA)    FO0017
     C*                                                                   FO0017
     C                     MOVE CNUM      CUSN                            S01240
     C                     Z-ADDACOD      ACDE                            S01240
     C*************        Z-ADDFFDASQ    ASNC                      S01240FO0017
     C                     Z-ADDACSQ      ASNC                            FO0017
     C                     END                                            S01240
     C**                                                                  FO0025
     C                     ELSE                                           FO0025
     C                     MOVE *BLANKS   BRCA                            FO0025
     C**********           Z-ADD0         CUSN                                         FO0025 CSD027
     C                     MOVE *BLANKS   CUSN                                                CSD027
     C                     Z-ADD0         ACDE                            FO0025
     C                     Z-ADD0         ASNC                            FO0025
     C                     END                                            FO0025
     C**                                                                  FO0025
     C*                                                                   S01240
     C           PNBL      IFGE WPNBL                                     S01240
     C                     Z-ADD0         DORC                            S01240
     C                     ELSE                                           S01240
     C                     Z-SUBMVAM      MVAM                            S01240
     C                     Z-ADD1         DORC                            S01240
     C                     END                                            S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C**  Write record to PF/FFACMVD                                      S01240
     C                     WRITEFFACMVDF                                  S01240
     C**                                                                  S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     ENDSR                                          S01240
     C**                                                                  S01240
     C********************************************************************S01240
     C/EJECT                                                              S01240
     C********************************************************************
     C**                                                                 *
     C**   UPSTNC SR. -  Update LF/POSTNC : Customer Position            *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. DBERR                    *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UPSTNC    BEGSR                           ** UPSTNC SR **
     C*
     C**   Access Customer Position off LF/POSTNC
     C*
     C***********          MOVE SBRCD     KBRCDC                          S01117
     C                     MOVE SBRCA     KBRCAC                          S01117
     C                     MOVELWCUSC     KCBCDC
     C                     MOVE ISTT      KISTTC
     C                     MOVE YRNO      KYRNOC
     C                     MOVE MTHN      KMTHNC
     C                     MOVE SPCAL     KPCALC
     C                     Z-ADDSTRPS     KSTRPC
     C*
     C           KPSTNC    CHAINPOSTNC               71
     C*
     C**   Record must exist and be live, otherwise DB Error
     C*
     C           *IN71     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '27'      DBASE            ***************S01117
     C                     Z-ADD27        DBASE            ***************S01117
     C                     MOVE 'PSTNC'   DBFILE           * DB ERROR 27 *
     C                     MOVELPSTNCK    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Delete - Reverse out updates due to the old trade
     C*
     C           PACTN     IFEQ 'D'
     C*
     C**   - a) Broker involved
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LOPC      ADD  WNCTE     LOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           SOPC      ADD  WNCTE     SOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C                     END
     C*
     C**    Margin
     C*
     C           XCMAR     IFEQ 0
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LOCO      ADD  WNCTE     LOCO
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           SOCO      ADD  WNCTE     SOCO
     C                     END
     C*
     C                     END
     C*
     C**   - b) Broker not involved
     C*
     C                     ELSE
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOPC      ADD  WNCTE     SOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOPC      ADD  WNCTE     LOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C                     END
     C*
     C**    Margin
     C*
     C           XCMAR     IFEQ 0
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOCO      ADD  WNCTE     SOCO
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOCO      ADD  WNCTE     LOCO
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Insert - Apply updates due to the new trade
     C*
     C                     ELSE
     C*
     C**   - a) Broker involved
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LOPC      SUB  WNCTE     LOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           SOPC      SUB  WNCTE     SOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C                     END
     C*
     C**    Margin
     C*
     C           XCMAR     IFEQ 0
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LOCO      SUB  WNCTE     LOCO
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           SOCO      SUB  WNCTE     SOCO
     C                     END
     C*
     C                     ELSE
     C           XCMAR     IFGT 0
     C           *IN79     ANDEQ'1'
     C           TOTM      SUB  XCMAR     TOTM
     C                     END
     C*
     C                     END
     C*
     C**   - b) Broker not involved
     C*
     C                     ELSE
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOPC      SUB  WNCTE     SOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOPC      SUB  WNCTE     LOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C                     END
     C*
     C**    Margin
     C*
     C           XCMAR     IFEQ 0
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOCO      SUB  WNCTE     SOCO
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOCO      SUB  WNCTE     LOCO
     C                     END
     C*
     C                     ELSE
     C           XCMAR     IFGT 0
     C           *IN79     ANDEQ'1'
     C           TOTM      SUB  XCMAR     TOTM
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Update Customer's Instrument Position
     C*
     C                     EXCPTCBPSTN
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UPSTNB SR. -  Update LF/POSTNC : Broker Position              *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. DBERR                    *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UPSTNB    BEGSR                           ** UPSTNB SR **
     C*
     C**   Access Broker Position off LF/POSTNC
     C*
     C***********          MOVE SBRCD     KBRCDC                          S01117
     C                     MOVE SBRCA     KBRCAC                          S01117
     C                     MOVELWBOCO     KCBCDC
     C                     MOVE ISTT      KISTTC
     C                     MOVE SYRNO     KYRNOC
     C                     MOVE MTHN      KMTHNC
     C                     MOVE SPCAL     KPCALC
     C                     Z-ADDSTRPS     KSTRPC
     C*
     C           KPSTNC    CHAINPOSTNC               71
     C*
     C**   1. Record must exist and must be live, otherwise DB Error
     C*
     C           *IN71     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '28'      DBASE            ***************S01117
     C                     Z-ADD28        DBASE            ***************S01117
     C                     MOVE 'PSTNC'   DBFILE           * DB ERROR 28 *
     C                     MOVELPSTNCK    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   Delete - Reverse out updates due to the old trade
     C*
     C           PACTN     IFEQ 'D'
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOPC      ADD  WNCTE     SOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOPC      ADD  WNCTE     LOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C                     END
     C*
     C**    Margin
     C*
     C           XBMAR     IFEQ 0
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOCO      ADD  WNCTE     SOCO
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOCO      ADD  WNCTE     LOCO
     C                     END
     C*
     C                     END
     C*
     C**   Insert - Apply updates due to the new trade
     C*
     C                     ELSE
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOPC      SUB  WNCTE     SOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOPC      SUB  WNCTE     LOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C                     END
     C*
     C**    Margin
     C*
     C           XBMAR     IFEQ 0
     C*
     C**    - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           SOCO      SUB  WNCTE     SOCO
     C*
     C**    - Sale
     C*
     C                     ELSE
     C           LOCO      SUB  WNCTE     LOCO
     C                     END
     C*
     C                     ELSE
     C           XBMAR     IFGT 0
     C           *IN79     ANDEQ'1'
     C           TOTM      SUB  XBMAR     TOTM
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C**   Update Broker's Instrument Position
     C*
     C                     EXCPTCBPSTN
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UPSTNK SR. -  Update LF/POSTNK : Book Position                *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. DBERR                    *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UPSTNK    BEGSR                           ** UPSTNK SR **
     C*
     C**   Access Book Position off LF/POSTNK
     C*
     C***********          MOVE SBRCD     KBRCDK                          S01117
     C                     MOVE SBRCA     KBRCAK                          S01117
     C                     MOVE SBOKC     KBOKCK
     C                     MOVE ISTT      KISTTK
     C                     MOVE YRNO      KYRNOK
     C                     MOVE MTHN      KMTHNK
     C                     MOVE SPCAL     KPCALK
     C                     Z-ADDSTRPS     KSTRPK
     C*
     C           KPSTNK    CHAINPOSTNK               71
     C*
     C**   Live record must exist, otherwise DB Error
     C*
     C           *IN71     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '29'      DBASE            ***************S01117
     C                     Z-ADD29        DBASE            ***************S01117
     C                     MOVE 'PSTNK'   DBFILE           * DB ERROR 29 *
     C                     MOVELPSTNKK    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   1. 'Reverse out' updates due to the old trade
     C*
     C           PACTN     IFEQ 'D'
     C*
     C**   - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LOPC      ADD  WNCTE     LOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C*
     C**   - Sale
     C*
     C                     ELSE
     C           SOPC      ADD  WNCTE     SOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C                     END
     C*
     C**   Insert - Apply updates due to the new trade
     C*
     C                     ELSE
     C*
     C**   - Purchase
     C*
     C           STRTY     IFEQ 'P'
     C           LOPC      SUB  WNCTE     LOPC
     C           CUTV      SUB  WTNVL     CUTV
     C           RPLD      ADD  COPLS     RPLD
     C*
     C**   - Sale
     C*
     C                     ELSE
     C           SOPC      SUB  WNCTE     SOPC
     C           CUTV      ADD  WTNVL     CUTV
     C           RPLD      SUB  COPLS     RPLD
     C                     END
     C*
     C                     END
     C*
     C**   Update Book's Instrument Position
     C*
     C                     EXCPTBKPSTN
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   UTRNSA SR. -  Update Transaction Audit file                   *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. DBERR                    *
     C**       SR. UPDAMD                                                *
     C**       SR. UPDDEL                                                *
     C**                                                                 *
     C********************************************************************
     C*
     C           UTRNSA    BEGSR                           ** UTRNSA SR **
     C*
     C**   Access audit record
     C*
     C           1         CHAINTRANSA               71
     C*
     C**   Database error if not found
     C*
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA
     C***********          MOVE '30'      DBASE            ***************S01117
     C                     Z-ADD30        DBASE            ***************S01117
     C                     MOVE 'TRANS'   DBFILE           * DB ERROR 30 *
     C                     MOVEL'AUDIT'   DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**   If Trade is an insert
     C*
     C           SACTN     IFEQ 'I'
     C                     ADD  1         NORE
     C                     ADD  1         NINS
     C*
     C**   If Trade is an amend
     C*
     C                     ELSE
     C           SACTN     IFEQ 'A'
     C*
     C**   If not previously amended today
     C*
     C           XLCD      IFNE CTDATE
     C                     ADD  1         NAMD
     C                     END
     C*
     C**   If Trade is a delete
     C*
     C                     ELSE
     C                     SUB  1         NORE
     C                     ADD  1         NDEL
     C*
     C**   If previously processed today
     C*
     C           XLCD      IFEQ CTDATE
     C*
     C**   If previously inserted today
     C*
     C           XCHTP     IFEQ 'I'
     C                     SUB  1         NINS
     C                     END
     C*
     C**   If previously amended today
     C*
     C           XCHTP     IFEQ 'A'
     C                     SUB  1         NAMD
     C                     END
     C*
     C                     END
     C*
     C                     END
     C                     END
     C*
     C**   Update audit record
     C*
     C                     UPDATTRANSAF
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   RUDBAW SR. - 'Record Updated By Another Workstation' Control  *
     C**   ~~~~~~~~~~                                                    *
     C**      Called From                  Calls                         *
     C**       SR. UPDINS                   SR. INFSR                    *
     C**       SR. UPDAMD                   SR. MKIINT                   *
     C**       SR. UPDDEL                   SR. OTCINT                   *
     C**                                                                 *
     C********************************************************************
     C*
     C           RUDBAW    BEGSR                           ** RUDBAW SR **
     C*
     C**   Access TRANS record if SR. called due to Write failure
     C*
     C                     ROLBK
     C           SACTN     IFEQ 'I'
     C                     MOVE STNBR     KTNBR
     C           KTNBR     CHAINTRANSIN              71
     C*
     C**   - Cancel if inserted Exercise belongs to another market
     C*
     C           *IN71     IFEQ '1'
     C                     EXSR INFSR
     C                     END
     C*
     C**   Check if Broker and/or Customer present for inserted exercise
     C*
     C********** BOCO      IFNE *ZEROS                                                        CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     SETON                     14
     C                     END
     C*
     C********** CUSC      IFNE *ZEROS                                                        CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     SETON                     15
     C                     END
     C*
     C                     END
     C*
     C**   Reset Processing
     C*
     C                     SETON                     11
     C                     MOVE *BLANK    SMIODS
     C*
     C**   Initialise updated screen details
     C*
     C           PMRKT     IFNE ' '
     C                     EXSR MKIINT
     C                     ELSE
     C                     EXSR OTCINT
     C                     END
     C*
     C                     MOVEAMSG,2     SERCD2
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT                                                              CFF007
      *****************************************************************                       CRE020
      *                                                               *                       CRE020
      *  SRADVC - Update Retail Advice Index File                     *                       CRE020
      *                                                               *                       CRE020
      *****************************************************************                       CRE020
      *                                                                                       CRE020
     C           SRADVC    BEGSR                                                              CRE020
      *                                                                                       CRE020
     C                     MOVE *BLANKS   RREFNO                                              CRE020
     C                     MOVELTNBR      RREFNO                                              CRE020
     C                     MOVELRREFNO    KREFNO                                              CRE020
     C                     MOVELTRTY      RTRTYP                                              CRE020
      *                                                                                       CRE020
     C                     OPEN READVCL1                                                      CRE020
     C           KADVC     CHAINREADVCL1             81                                       CRE020
      *                                                                                       CRE020
     C           *IN81     IFEQ '0'                                                           CRE020
      *                                                                                       CRE020
     C                     SELEC                                                              CRE020
      *                                                                                       CRE020
     C           PACTN     WHEQ 'A'                                                           CRE020
      *                                                                                       CRE020
      ** If the Transaction was just inserted, print an insert advice instead                 CRE020
      ** of an amendment to advice                                                            CRE020
      *                                                                                       CRE020
     C           RCHTYP    IFNE 'I'                                                           CRE020
     C           RSAPIN    ANDNE'N'                                                           CRE020
     C           RCHTYP    OREQ 'I'                                                           CRE020
     C           RSAPIN    ANDEQ'Y'                                                           CRE020
     C                     MOVE 'N'       RSAPIN                                              CRE020
     C                     MOVE 'A'       RCHTYP                                              CRE020
     C                     UPDATREADVCD0                                                      CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
     C           PACTN     WHEQ 'D'                                                           CRE020
      *                                                                                       CRE020
      ** If the Transaction was just deleted before quiting maintenance,                      CRE020
      ** delete record from advice file, else, setup for a delete advice                      CRE020
      *                                                                                       CRE020
     C           RCHTYP    IFEQ 'I'                                                           CRE020
     C           RSAPIN    ANDEQ'N'                                                           CRE020
     C                     MOVE 'Y'       RSAPIN                                              CRE020
     C                     ELSE                                                               CRE020
     C                     MOVE 'N'       RSAPIN                                              CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
     C                     MOVE 'D'       RCHTYP                                              CRE020
     C                     UPDATREADVCD0                                                      CRE020
      *                                                                                       CRE020
     C                     ENDSL                                                              CRE020
      *                                                                                       CRE020
     C                     ELSE                                                               CRE020
      *                                                                                       CRE020
     C                     MOVE 'N'       RSAPIN                                              CRE020
     C                     MOVE 'I'       RCHTYP                                              CRE020
     C                     MOVE 'Y'       RAUTHI                                              CRE020
     C                     MOVE *BLANKS   RSEQNO                                              CRE020
     C                     WRITEREADVCD0                                                      CRE020
      *                                                                                       CRE020
     C                     ENDIF                                                              CRE020
      *                                                                                       CRE020
     C                     CLOSEREADVCL1                                                      CRE020
      *                                                                                       CRE020
     C                     ENDSR                                                              CRE020
      *****************************************************************                       CRE020
     C/EJECT                                                                                  CRE020
      *****************************************************************   CFF007
      *                                                               *   CFF007
      * SRTTFC - Calculate Tier, Threshold or Flat Rate               *   CFF007
      *                                                               *   CFF007
      *****************************************************************   CFF007
      *                                                                   CFF007
     C           SRTTFC    BEGSR                                          CFF007
      *                                                                   CFF007
      ** Access CHGCM for charges and commissions detail                  CFF007
      *                                                                   CFF007
     C                     MOVE ISCY      KCCY                            CFF007
     C                     Z-ADDCGCM      KCGCM                           CFF007
      *                                                                   CFF007
     C           KCHGCM    CHAINCHGCM                10                   CFF007
      ** DB ERROR                                                         CFF007
      *                                                                   CFF007
     C           *IN10     IFEQ *ON                                       CFF007
     C           RECI      ORNE 'D'                                       CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     MOVEL'CHGCM   'DBFILE                          CFF007
     C                     MOVELISCY      CHGCMT  5                       CFF007
     C                     MOVE CGCM      CHGCMT                          CFF007
     C                     MOVELCHGCMT    DBKEY            ************   CFF007
     C                     MOVE *BLANKS   DBOPTN           * DBERR 37 *   CFF007
     C                     Z-ADD37        DBASE            ************   CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** Locate the highest valued charged range lower limit on CHGCM     CFF007
      ** whose value is less than or equal to the contract number         CFF007
      *                                                                   CFF007
     C                     Z-ADD9         Y       10                      CFF007
     C                     MOVE 'N'       WFOUND  1                       CFF007
      *                                                                   CFF007
     C           WFOUND    DOWEQ'N'                                       CFF007
     C           Y         ANDGT1                                         CFF007
      *                                                                   CFF007
     C           RNG,Y     IFNE 0                                         CFF007
     C           RNG,Y     ANDLEWCONO                                     CFF007
     C                     MOVE 'Y'       WFOUND                          CFF007
     C                     ELSE                                           CFF007
     C                     SUB  1         Y                               CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDDO                                          CFF007
      *                                                                   CFF007
      ** If charges are tiered                                            CFF007
      *                                                                   CFF007
     C           TTFI      IFEQ 'T'                                       CFF007
     C           WCONO     SUB  RNG,Y     TCONO   50                      CFF007
     C                     ADD  1         TCONO                           CFF007
     C           TCONO     MULT AMT,Y     WRATA                           CFF007
      *                                                                   CFF007
     C           Y         DOWGE2                                         CFF007
     C           Y         SUB  1         Z       10                      CFF007
     C           RNG,Y     SUB  RNG,Z     TCONO                           CFF007
     C           TCONO     MULT AMT,Z     TRATA  130                      CFF007
     C                     ADD  TRATA     WRATA                           CFF007
     C                     SUB  1         Y                               CFF007
     C                     ENDDO                                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** If charges are threshold                                         CFF007
      *                                                                   CFF007
     C           TTFI      IFEQ 'X'                                       CFF007
     C           WCONO     MULT AMT,Y     WRATA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** If charges are flat                                              CFF007
      *                                                                   CFF007
     C           TTFI      IFEQ 'F'                                       CFF007
     C                     Z-ADDAMT,Y     WRATA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** If rate amount < min charge commission                           CFF007
      *                                                                   CFF007
     C           WRATA     IFLT MINC                                      CFF007
     C           MINC      ANDNE0                                         CFF007
     C                     Z-ADDMINC      WRATA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
      ** If rate amount > max charge commission                           CFF007
      *                                                                   CFF007
     C           WRATA     IFGT MAXC                                      CFF007
     C           MAXC      ANDNE0                                         CFF007
     C                     Z-ADDMAXC      WRATA                           CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDSR                                          CFF007
      *****************************************************************   CFF007
      *                                                               *                       CSD015
      *  SRWTCH - Set-up parameters for compliance engine program and *                       CSD015
      *           sends transaction details by calling SDWLCLOP.      *                       CSD015
      *                                                               *                       CSD015
      *  Called From : WTRANS, UTRANS                                 *                       CSD015
      *  Calls       : SDWLCLOP, SDCWLFMT                             *                       CSD015
      *                                                               *                       CSD015
      *****************************************************************                       CSD015
      *                                                                                       CSD015
     C           SRWTCH    BEGSR                                                              CSD015
      *                                                                                       CSD015
      ** Initialise then set-up 1st parameter for SDWLCLOP                                    CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANKS   SDWLTO                                              CSD015
      *                                                                                       CSD015
     C                     MOVEL'FFEXER'  W4ITEM                                              CSD015
     C                     MOVELTNBR      W4IDEN                                              CSD015
     C                     MOVELBRCA      W4BRCH                                              CSD015
      *                                                                                       CSD015
     C           CSC011    IFEQ 'Y'                                                           CSD015
     C                     MOVELS1MAIN    W4SYSM                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVELLIBR      W4SYSM                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVEL'TRANSD'  W4FUNT                                              CSD015
     C                     Z-ADDTRSD      W4DDAT                                              CSD015
     C                     Z-ADDVALD      W4VDAT                                              CSD015
     C                     Z-ADD0         W4MDAT                                              CSD015
     C                     MOVELISTT      W4DEN1                                              CSD015
     C                     MOVEL*BLANKS   W4DEN2                                              CSD015
     C                     Z-ADDNUCO      W4AMT1                                              CSD015
     C                     Z-ADD0         W4AMT2                                              CSD015
      *                                                                                       CSD015
     C           @RTCD     IFEQ *BLANKS                                                       CSD015
     C           CCF001    IFEQ 'Y'                                                           CSD015
     C           WLCRPC    IFEQ 'Y'                                                           CSD015
     C                     MOVE 'C'       W4CTYP                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVE 'I'       W4CTYP                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ELSE                                                               CSD015
     C           WLLICD    IFNE *BLANKS                                                       CSD015
     C           WLLICD    ANDNEW1IND1                                                        CSD015
     C           WLLICD    ANDNEW1IND2                                                        CSD015
     C           WLLICD    ANDNEW1IND3                                                        CSD015
     C           WLLICD    ANDNEW1IND4                                                        CSD015
     C           WLLICD    ANDNEW1IND5                                                        CSD015
     C                     MOVE 'C'       W4CTYP                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVE 'I'       W4CTYP                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C           WLCRNM    CAT  WLCRTN    W4CUST                                              CSD015
     C                     MOVELWLCUST    W4CNUM                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Initialise then set-up 2nd parameter for SDWLCLOP                                    CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANKS   PXML                                                CSD015
     C                     MOVE *BLANKS   PWLOUT216                                           CSD015
     C                     Z-ADD1         WX                                                  CSD015
     C                     Z-ADD6         WY                                                  CSD015
      *                                                                                       CSD015
     C           WX        DOUGTWY                                                            CSD015
      *                                                                                       CSD015
     C           WLF,WX    IFNE *BLANKS                                                       CSD015
      *                                                                                       CSD015
     C                     CALL 'SDCWLFMT'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM WLF,WX    PWLIN1 35                                           CSD015
     C                     PARM *BLANKS   PWLIN2 35                                           CSD015
     C                     PARM *BLANKS   PWLIN3 35                                           CSD015
     C                     PARM *BLANKS   PWLIN4 35                                           CSD015
     C                     PARM *BLANKS   PWLIN5 35                                           CSD015
     C                     PARM *BLANKS   PWLIN6 35                                           CSD015
     C                     PARM ISCY      PCCY    3                                           CSD015
     C                     PARM           PWLOUT                                              CSD015
     C                     PARM           PWLOP2  6                                           CSD015
      *                                                                                       CSD015
     C           PWLOUT    IFNE *BLANKS                                                       CSD015
     C                     CAT  XOT,WX:0  PXML                                                CSD015
     C                     CAT  PWLOUT:0  PXML                                                CSD015
     C                     CAT  XCT,WX:0  PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANKS   PWLOUT                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ADD  1         WX                                                  CSD015
      *                                                                                       CSD015
     C                     ENDDO                                                              CSD015
      *                                                                                       CSD015
     C           PXML      IFNE *BLANKS                                                       CSD015
     C                     CALL 'SDWLCLOP'                                                    CSD015
     C                     PARM           SDWLTO                                              CSD015
     C                     PARM           PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDSR                                                              CSD015
      *                                                                                       CSD015
      *****************************************************************                       CGL029
      /EJECT                                                                                  CGL029
      *****************************************************************                       CGL029
      *                                                               *                       CGL029
      *  SRACOD - Gets Account Codes via AOACODR0.                    *                       CGL029
      *                                                               *                       CGL029
      *****************************************************************                       CGL029
     C           SRACOD    BEGSR                                                              CGL029
      *                                                                                       CGL029
     C                     MOVE FFACOD    PACCD                                               CGL029
      *                                                                                       CGL029
     C                     CALL 'AOACODR0'                                                    CGL029
     C                     PARM *BLANKS   PRTCD   7                                           CGL029
     C                     PARM '*VERIFY' POPTN   7                                           CGL029
     C                     PARM           PACCD  10                                           CGL029
     C           SDACOD    PARM SDACOD    DSSDY                                               CGL029
      *                                                                                       CGL029
     C                     MOVE *ON       *IN71                                               CGL029
     C           PRTCD     IFEQ *BLANKS                                                       CGL029
     C                     MOVE *OFF      *IN71                                               CGL029
     C                     ELSE                                                               CGL029
     C           PRTCD     IFNE '*NRF'                                                        CGL029
     C           *LOCK     IN   LDA                                                           CGL029
     C                     MOVE 'SDACODPD'DBFILE                                              CGL029
     C                     MOVE PACCD     DBKEY                                               CGL029
     C                     Z-ADD101       DBASE                                               CGL029
     C                     OUT  LDA                                                           CGL029
     C                     EXSR DBERR                                                         CGL029
     C                     ENDIF                                                              CGL029
     C                     ENDIF                                                              CGL029
      *                                                                                       CGL029
     C                     ENDSR                                                              CGL029
      *                                                                                       CGL029
     C*****************************************************************                       CSD015
      /EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
     C/COPY WNCPYSRC,FF0040C075
     C/EJECT
     C/COPY ZSRSRC,FFPMCLZ1
     C/EJECT
     C/COPY ZSRSRC,FFPLCLZ1
     C/EJECT
     C/COPY ZSRSRC,FFTVCLZ2
     C/EJECT
     C/COPY ZSRSRC,FFSTDPZ4
     C/EJECT
     C/COPY ZSRSRC,FFPRCSZ4
     C/EJECT
     C/COPY ZSRSRC,FFDATEZ3
     C/EJECT
     C/COPY ZSRSRC,FFPRVLZ4
     C/EJECT
     C/COPY ZSRSRC,FFSETLZ4
     C/EJECT
     C/COPY ZSRSRC,ZDATE1Z2
     C/EJECT
     C/COPY ZSRSRC,ZDATE2Z2
     C/EJECT
     C*COPY*ZSRSRC,ZDATE3Z4                                               S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
     C/EJECT
     E*COPY*ZSRSRC,ZDATE5Z2                                               S01195
     C/COPY ZSRSRC,ZFWDT                                                  S01195
     C/EJECT                                                              S01195
     C/COPY ZSRSRC,ZBKDT                                                  S01195
     C/EJECT                                                              S01195
     C/COPY ZSRSRC,ZCHKH                                                  S01195
     C/EJECT
     C/COPY ZSRSRC,ZEDITZ2
     C/EJECT
     C/COPY ZSRSRC,ZALIGNZ2
     C/EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
     C/EJECT
     C/COPY ZSRSRC,FFYTOPZ1                                               AUS022
     C/EJECT                                                              AUS022
     C/COPY WNCPYSRC,FF0040C039
     O*****************************************************************
     O*
     OTRANSDF E                ETRANS
     O*    Amend/Delete LF/TRANS (Exercise)
     O                         RECI
     O                         TNAR
     O                         LCD
     O                         CHTP
     O                         TNLU
     O*
     OTRSETDF E                DTRSET
     O*    Delete LF/TRSET (Exercise)
     O                         RECI
     O*
     OTRANSDF E                TTRANS
     O*    Amend LF/TRANS (Trade)
     O                         NOCO
     O                         NOBO
     O                         FCIN
     O                         FBIN
     O                         TNLU
     O*
     OTRSETDF E                TTRSET
     O*    Amend LF/TRSET (Trade)
     O                         OCSB
     O                         OCDB
     O                         OCSC
     O                         OCDC
     O                         BMAR
     O                         CMAR
     O*
     OCLOSTDF E                CLOSTU
     O*    Close Out reversal LF/CLOST
     O                         CORI
     O                         LCD
     O                         CHTP
     O                         TNLU
     O*
     OPOSTNCDFE                CBPSTN
     O*    Customer/Broker Position on LF/POSTNC
     O                         LOPC
     O                         SOPC
     O                         CUTV
     O                         RPLD
     O                         TOTM
     O                         LOCO
     O                         SOCO
     O*
     OPOSTNKDFE                BKPSTN
     O*    Book Position on LF/POSTNK
     O                         LOPC
     O                         SOPC
     O                         CUTV
     O                         RPLD
     O*
     O*****************************************************************
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   MSG - ERROR MESSAGES
 INVALID COMMAND KEY: PRESS F10 TO DELETE
 EXERCISE RECORD HAS BEEN UPDATED BY ANOTHER WORKSTATION
 TRADE RECORD HAS BEEN UPDATED BY ANOTHER WORKSTATION
 TRADE RECORD HAS BEEN DELETED BY ANOTHER WORKSTATION
**   TABDY/TABNO - SHORTNAMES & DAY NUMBERS
F0S1X2M3U4W5T6
**   ZYDY -YEARS IN DAYS CUMULATIVE,FOUR YEAR SPAN
0366073110961461
**   ZMDY -MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** XOT - Array for watch list fields' Opening XML Tags                                        CSD015
<Broker Settlement Account>                                                                   CSD015
<Broker For Account of>                                                                       CSD015
<Broker Counterparty>                                                                         CSD015
<Customer Settlmnt Account>                                                                   CSD015
<Customer For Account of>                                                                     CSD015
<Customer Counterparty>                                                                       CSD015
** XCT - Array for watch list fields' Closing XML Tags                                        CSD015
</Broker Settlement Account>                                                                  CSD015
</Broker For Account of>                                                                      CSD015
</Broker Counterparty>                                                                        CSD015
</Customer Settlmnt Account>                                                                  CSD015
</Customer For Account of>                                                                    CSD015
</Customer Counterparty>                                                                      CSD015
