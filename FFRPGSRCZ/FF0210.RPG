     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FF Input Cycle Revaluation II')                  *
     F********************************************************************
     F*                                                                  *
     F*  Midas  -  Futures and Options Module
     F*                                                                  *
     F*   FF0210  -  INPUT CYCLE REVALUATION II                          *
     F*                                                                  *
      *  (c) Finastra International Limited 2001                      *
     F*                                                                  *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. AR680177           Date 03Dec10               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246526             Date 21Mar07               *
      *                 247517             Date 09May07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 241147A            Date 07Nov06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 06May06               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CFF006             Date 28Nov00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.01 Patch E ---------------------------------------*
      *                 171172             Date 25Nov99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CFF004             Date 13Sep96               *
     F*                  S71062             DATE 19DEC95                 *
     F*                  S01455             DATE 05NOV93                 *
     F*                  S04662             DATE 12JUL93                 *
     F*                  S01393             DATE 30OCT92                 *
     F*                  FUJI-FF0011        DATE 21SEP92                 *
     F*                  AUS022             DATE 06AUG92                 *
     F*                  FO0017             DATE 19DEC90                 *
     F*                  S01117             DATE 09MAR90                 *
     F*                  S01240             DATE 07MAR89                 *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*                                                                  *
      *  MD046248 - Finastra Rebranding                               *
      *  AR680177 - Job RVALOTC is looping on file FOCLT              *
      *  246526 - Recompiled due to change in FFSETLZ4.               *
      *  247517 - Reversed fix 241147.                                *
      *  241147A - Use old processing for computation of p/l.         *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CFF006 - Fractional Ticks Enhancement.                       *
     F*   171172 - Recompile over changed POSTNCD/POSTNKD             *
     F*   CFF004  -  Increase in size of Price Fields,(Recompiled Only)  *
     F*   S71062  -  FF/PM Interface (Just recompiled)                   *
     F*   S01455  -  'FF'ACCOUNT KEY ENHANCEMENTS.                       *
     F*              Recompiled due to changes in file TABFF.            *
     F*   S04662  -  Switchable Feature for Init Margins for Futures;    *
     F*              Deposit and Spread Margin Rate added to DEFLTD.     *
     F*              Recompile only.                                     *
     F*   S01393  -  RECOMPILED FOR STRATEGIC RISK MANAGEMENT            *
     F* FUJI-FF0011 - The system does not differentiate between          *
     F*               american and european option on exercise           *
     F*               validation and OTC confirmation wording.           *
     F*               *** RECOMPILE ONLY ***                             *
     F*   AUS022  -  AUSTRALIAN CHANGE : Introduction of Processing      *
     F*              Types 7 and 8.                                      *
     F*   FO0017  -  ADD BRCA ON UPDATE OF ACCOUNT MOVEMENTS FILE        *
     F*   S01117  -  MULTIBRANCHING                                      *
     F*   S01240  -  ADDITION OF REAL-TIME STATEMENTS                    *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*     CREATION REQUIREMENTS                                        *
     F*                                                                  *
     F*     IGNDECERR(*NO)                                               *
     F*                                                                  *
     F********************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     FACCNT   IF  E           K        DISK
     FACNUM   IF  E           K        DISK
     F            ACCNTABF                          KRENAMEACNUMABF
     FFOCLT   IF  E           K        DISK
     FDEFLT   IF  E           K        DISK
     FINTYP   IF  E           K        DISK
     FWUNRLC  IF  E           K        DISK
     FWUNRLK  IF  E           K        DISK
     FTABFF   IF  E           K        DISK
     F            TABTG10F                          KIGNORE
     F            TABLETHF                          KIGNORE
     F            TABLET2F                          KIGNORE
     FMEMOSM  UF  E           K        DISK         KCOMIT       A
     FPRONOM  UF  E           K        DISK         KCOMIT       A
     FFFACMVD O   E           K        DISK         KCOMIT       A        S01240
     FPOSTNC  UF  E           K        DISK         KCOMIT
     FPOSTNK  UF  E           K        DISK         KCOMIT
     F*
     F/SPACE 2
     F* ID F  C  H  L    FUNCTION OF INDICATORS
     F*
     F*      01         READ LF/POSTNC FAILS
     F*      02         READ LF/POSTNK FAILS
     F*
     F*      03         CHAIN FAIL FOR DEFLT
     F*      04         CHAIN FAIL FOR LF/WUNRLC
     F*      05         CHAIN FAIL FOR LF/WUNRLK
     F*      06         CHAIN FAIL FOR LF/MEMOSM
     F*      07         CHAIN FAIL FOR LF/PRONOM
     F*
     F*      79         CHAIN FAIL FOR LF/TABTB11 OR
     F*                                PF/TABTB10 OR                      S01240
     F*                                LF/TABTB20 OR
     F*                                LF/TABTB40 OR
     F*                                LF/TABTB80 OR
     F*                                LF/TABLETR OR
     F*                                LF/FOCLT   OR
     F*                                LF/INTYP
     F*
     F*     80-89       Reserved for Standard FF Subroutines
     F*
     F*     90-99       Reserved for Standard MIDAS Subroutines
     F*
     F*     U7+U8       Database Errors
     F*
     F/SPACE 2
     E                    CPY@    1   1 80
     I*
     IDEFLTDF
     I              SETP                            DSETP
     I              SETA                            DSETA
     I              SEBR                            DSEBR                 S01117
     I*    Default file
     I*
     IACCNTABF
     I*    Account master details
     I*
     I***********   BRCD                            BRCDX                 S01117
     I              BRCA                            BRCAX                 S01117
     I*
     I/COPY ZSRSRC,FFSETLZ1
     I*
     ILDA         DS                            256
     I*
     I**   Local Data Area for Database Error Details
     I*
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I*
     I**  Set up fields to store data from previous record read
     I*
     I            DS
     I                                        1  14 PBRCBI
     I                                        1   9 PBRCB
     I***********                             1   30PBRCD                 S01117
     I                                        1   3 PBRCA                 S01117
     I**********                              4   90PCBCD                                   AR680177
     I                                        4   9 PCBCD                                   AR680177
     I                                       10  14 PISTT
     I*
     I            DS
     I                                        1  14 BRCBI
     I                                        1   9 BRCB
     I***********                             1   30BRCD                  S01117
     I                                        1   3 BRCA                  S01117
     I**********                              4   90CBCD                                      CSD027
     I                                        4   9 CBCD                                      CSD027
     I                                       10  14 ISTT
     I*
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                   CFF006
      ** External DS for SAR Details                                      CFF006
     ISCSARD    E DSSCSARDPD                                              CFF006
      *                                                                   CFF006
      ** Short Data Structure for Access Programs                         CFF006
     IDSFDY     E DSDSFDY                                                 CFF006
      *                                                                   CFF006
     IDSSDY     E DSDSSDY                                                                     CGL029
      ** Second DS for Access Programs, Long Data Structure                                   CGL029
      *                                                                                       CGL029
     ISDACOD    E DSSDACODPD                                                                  CGL029
      ** External data structure for account code                                             CGL029
      *                                                                                       CGL029
     C/COPY ZSRSRC,FFSETLZ2
     C*
     C**  Set up key for LF/DEFLT
     C*
     C           DEFKEY    KLIST
     C                     KFLD           CBCD
     C                     KFLD           MRKT
     C                     KFLD           ISTC
     C*
     C**  Set up key for LF/WUNKEY
     C*
     C           WUNKYC    KLIST
     C***********          KFLD           BRCD                            S01117
     C                     KFLD           BRCA                            S01117
     C                     KFLD           CBCD
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C*
     C**  Set up key for LF/WUNKEY
     C*
     C           WUNKYK    KLIST
     C***********          KFLD           BRCD                            S01117
     C                     KFLD           BRCA                            S01117
     C                     KFLD           BOKC
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C*
     C**  Set up key for LF/MEMOSM
     C*
     C           MEMKEY    KLIST
     C                     KFLD           FFBRCB                          S01117
     C                     KFLD           FFCNUM
     C                     KFLD           FFCCY
     C                     KFLD           FFACOD
     C                     KFLD           FFACSQ
     C*
     C**  Set up key for LF/PRONOM
     C*
     C           PROKEY    KLIST
     C                     KFLD           FFCCY
     C                     KFLD           FFNOSN
     C*
     C/COPY ZSRSRC,FFSETLZ3
     C*
     C*
     C**  Initialize fields and access icd records
     C*
     C                     EXSR INIT
     C*
     C**  Process customer/broker records
     C*
     C                     EXSR POSTC
     C*
     C**  Process book records
     C*
     C                     EXSR POSTK
     C*
     C**  Program ends normally
     C*
     C                     SETON                     LR
     C                     RETRN
     C/EJECT
     C****************************************************************
     C*                                                              *
     C*                   INDEX TO SUBROUTINES                       *
     C*                                                              *
     C*        1. INIT   - INITIALIZES FIELDS AND ACCESSES ICD       *
     C*        2. POSTC  - PROCESSES CUSTOMER/BOOK POSITIONS         *
     C*        3. UPOSTC - PROCESSES THE UPDATING OF POSTNC RECORDS  *
     C*        4. POSTK  - PROCESSES BOOK POSITIONS                  *
     C*        5. PARAM  - PREPARE PARAMETERS FOR FFSETL             *
     C*        6. FFSETL - DETERMINES FROM INPUT SETTLEMENT DETAILS  *
     C*                    THE SETTLEMENT ACCOUNTAND WHETHER MEMOSM  *
     C*                    OR PRONOM PROCESSING IS REQUIRED          *
     C*        7. DBERR  - DATABASE ERROR HANDLING. TERMINATES PROG. *
     C*        8. UMEMO  - UPDATES LF/MEMOSM                         *
     C*        9. UPRON  - UPDATES LF/PRONOM                         *
     C*       10. WACMVD - WRITES RECORD TO PF/FFACMVD               *    S01240
     C*                                                              *
     C****************************************************************
     C/EJECT
     C****************************************************************
     C**                                                             *
     C**  SR:INIT     - INITIALIZES FIELDS AND ACCESSES ICD RECORDS  *
     C**  CALLED FROM - MAIN PROCESSING                              *
     C**  CALLS       -                                              *
     C**  INPUTS      -                                              *
     C**  OUTPUTS     -                                              *
     C**                                                             *
     C****************************************************************
     C*
     C           INIT      BEGSR
     C*
     C**   Reset LDA
     C*
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C***********          MOVE *BLANKS   DBLOT                           S01117
     C                     MOVE *BLANKS   DBFILE                          S01117
     C                     MOVE *BLANKS   DBKEY                           S01117
     C                     MOVE *BLANKS   DBPGM                           S01117
     C                     Z-ADD*ZEROS    DBASE                           S01117
     C                     MOVE 'FF0210  'DBPGM
     C                     OUT  LDA
     C*                                                                   S01240
     C**  Access PF/TABTB10 for run date                                  S01240
     C*                                                                   S01240
     C                     READ TABTB10F                 79               S01240
     C*                                                                   S01240
     C**  If record not found then database error                         S01240
     C*                                                                   S01240
     C           *IN79     IFEQ '1'                                       S01240
     C           RECI      ORNE 'D'                                       S01240
     C           *LOCK     IN   LDA                                       S01240
     C                     MOVE '09'      DBASE            ***************S01240
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 09 *S01240
     C                     MOVEL'01    '  TABKEY           ***************S01240
     C                     MOVE '    10'  TABKEY                          S01240
     C                     MOVELTABKEY    DBKEY                           S01240
     C                     EXSR DBERR                                     S01240
     C                     END                                            S01240
     C*
     C**  Access PF/TABTB11 for date of next working day
     C*
     C                     READ TABTB11F                 79
     C*
     C**  If record not found then database error
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '01'      DBASE            ***************S01117
     C                     Z-ADD1         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 01 *
     C                     MOVEL'01    '  TABKEY 12        ***************
     C                     MOVE '    11'  TABKEY
     C                     MOVELTABKEY    DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C**  Access PF/TABTB20
     C*
     C                     READ TABTB20F                 79
     C*
     C**  If record not found then database error
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '02'      DBASE            ***************S01117
     C                     Z-ADD2         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 02 *
     C                     MOVEL'01    '  TABKEY           ***************
     C                     MOVE '    20'  TABKEY
     C                     MOVELTABKEY    DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C**  Access PF/TABTB40
     C*
     C                     READ TABTB40F                 79
     C*
     C**  If record not found then database error
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '03'      DBASE            ***************S01117
     C                     Z-ADD3         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 03 *
     C                     MOVEL'01    '  TABKEY           ***************
     C                     MOVE '    40'  TABKEY
     C                     MOVELTABKEY    DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C**  Access PF/TABTB80
     C*
     C                     READ TABTB80F                 79
     C*
     C**  If record not found then database error
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '04'      DBASE            ***************S01117
     C                     Z-ADD4         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 04 *
     C                     MOVEL'01    '  TABKEY           ***************
     C                     MOVE '    80'  TABKEY
     C                     MOVELTABKEY    DBKEY
     C                     EXSR DBERR
     C                     END
      *                                                                   CFF006
      **  Access SAR details file to see if switchable feature            CFF006
      **  CFF006 - Fractional Ticks Enhancement is installed.             CFF006
      *                                                                   CFF006
     C                     CALL 'AOSARDR0'                                CFF006
     C                     PARM *BLANKS   PRTCD   7                       CFF006
     C                     PARM '*VERIFY' POPTN   7                       CFF006
     C                     PARM 'CFF006'  PSARD   6                       CFF006
     C           SCSARD    PARM SCSARD    DSFDY                           CFF006
      *                                                                   CFF006
     C           PRTCD     IFEQ *BLANK                                    CFF006
     C                     MOVE 'Y'       CFF006  1                       CFF006
     C                     ELSE                                           CFF006
     C                     MOVE 'N'       CFF006                          CFF006
     C                     ENDIF                                          CFF006
     C*
     C                     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C**                                                             *
     C**  SR:POSTC    - PROCESSES CUSTOMER/BROKER POSITIONS          *
     C**  CALLED FROM - MAIN PROCESSING                              *
     C**  CALLS       - UPOSTC                                       *
     C**  INPUTS      -                                              *
     C**  OUTPUTS     -                                              *
     C**                                                             *
     C****************************************************************
     C*
     C           POSTC     BEGSR
     C*
     C**  Read each customer/broker position off LF/POSTNC and
     C**  Continue until each record processed
     C*
     C                     READ POSTNC                   01
     C*
     C           *IN01     DOWNE'1'
     C*
     C**  Access branch details on PF/TABLETR if branch code changed
     C**  for BCIN and NSACS to determine whether MEMOSM or PRONOM
     C**  update is required.
     C*
     C                     MOVEL'10'      FFBCDE 12
     C***********          MOVE BRCD      FFBCDE                          S01117
     C                     MOVE BRCA      FFBCDE                          S01117
     C           FFBCDE    CHAINTABLETRF             79
     C*
     C**  Record missing
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '05'      DBASE            ***************S01117
     C                     Z-ADD5         DBASE            ***************S01117
     C                     MOVE 'TABFF'   DBFILE           * DB ERROR 05 *
     C                     MOVELFFBCDE    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C***********          MOVE BRCD      PBRCD                           S01117
     C                     MOVE BRCA      PBRCA                           S01117
     C*
     C**  Process until there is a change in the branch code or is end
     C**  of file
     C           *IN01     DOWNE'1'
     C***********BRCD      ANDEQPBRCD                                     S01117
     C           BRCA      ANDEQPBRCA                                     S01117
     C*
     C**  customer/broker has changed get new details off LF/FOCLT
     C*
     C           CBCD      CHAINFOCLT                79
     C*
     C** If record missing then database error
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '06'      DBASE            ***************S01117
     C                     Z-ADD6         DBASE            ***************S01117
     C                     MOVE 'FOCLT'   DBFILE           * DB ERROR 06 *
     C                     MOVELCBCD      DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C***********          MOVE BRCD      PBRCD                           S01117
     C                     MOVE BRCA      PBRCA                           S01117
     C                     MOVE CBCD      PCBCD
     C*
     C**  Process if the next revaluation date for the broker or
     C**  customer is less than the date of the next working day then
     C*
     C           NRED      IFLT DNWD
     C*
     C**  Process until there is a change in the CBCD or is end of file
     C*
     C           *IN01     DOWNE'1'
     C           BRCB      ANDEQPBRCB
     C*
     C**  Access INTYP for the instrument details
     C*
     C           ISTT      CHAININTYP                79
     C*
     C**  If no record found then database error
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '07'      DBASE            ***************S01117
     C                     Z-ADD7         DBASE            ***************S01117
     C                     MOVE 'INTYP'   DBFILE           * DB ERROR 07 *
     C                     MOVELISTT      DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**  No defaults exist for OTC (ISTI = 'Y')
     C**  Use SETAD, settlement account of DEFLT for PARAM if *in04='0'
     C*
     C**   Split ISTT into market and instrument code
     C**
     C                     MOVELISTT      MRKT
     C                     MOVE ISTT      ISTC
     C                     SETON                     03
     C           ISTI      IFNE 'Y'
     C           DEFKEY    CHAINDEFLT                03
     C*
     C**  Ignore the default if the settlement type on default = 0
     C*
     C           *IN03     IFEQ '0'
     C           DSETP     ANDEQ*ZEROS
     C                     SETON                     03
     C                     END
     C                     END
     C*
     C***********          MOVE BRCD      PBRCD                           S01117
     C                     MOVE BRCA      PBRCA                           S01117
     C                     MOVE CBCD      PCBCD
     C                     MOVE ISTT      PISTT
     C*
     C**  Process until there is a change in the ISTT or is end of file
     C*
     C           *IN01     DOWNE'1'
     C           BRCBI     ANDEQPBRCBI
     C                     EXSR UPOSTC
     C                     END
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C                     READ POSTNC                   01
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C**                                                             *
     C**  SR:UPOSTC   - PROCESSES FOR UPDATING UPOSTC RECORDS        *
     C**  CALLED FROM - POSTC                                        *
     C****CALLS*******-*PARAM,*FFSETL,*UMEMO,*UPRON*******************    S01240
     C**  CALLS       - PARAM, FFSETL, UMEMO, UPRON, WACMVD          *    S01240
     C**  INPUTS      -                                              *
     C**  OUTPUTS     -                                              *
     C**                                                             *
     C****************************************************************
     C*
     C           UPOSTC    BEGSR
     C*
     C**  Access equivalent record off LF/WUNRLC
     C*
     C           WUNKYC    CHAINWUNRLC               04
     C*
     C**  If record exists, convert unrealized p/l off LF/WUNRLC to
     C**  units of instrument currency
     C*
     C           *IN04     IFEQ '0'
     C           ISPT      IFLE 6                                         AUS022
      ****************************************************************                CFF006 241147A
      ***If*enhancement*CFF006*is*installed*and*the*fractional********                CFF006 241147A
      ***ticks*indicator*is*'Y',*then*use*this*new*processing*********                CFF006 241147A
      ***for*computing*the*Unrealised*Profit*and*Loss.****************                CFF006 241147A
      ****************************************************************                CFF006 241147A
     C********** CFF006    IFEQ 'Y'                                                   CFF006 241147A
     C********** FRTK      ANDEQ'Y'                                                   CFF006 241147A
     C********** TKVL      MULT MNPF      ADTV   178                                  CFF006 241147A
     C********** ADTV      MULT ULPL      AULPL     H                                 CFF006 241147A
      *                                                                   CFF006
      ** Otherwise, use the old computation.                              CFF006
      *                                                                   CFF006
     C**********           ELSE                                                       CFF006 241147A
      *                                                                                       247517
      ** If enhancement CFF006 is installed and the fractional                                247517
      ** ticks indicator is 'Y', then use this new processing                                 247517
      ** for computing the Unrealised Profit and Loss.                                        247517
      *                                                                                       247517
     C           CFF006    IFEQ 'Y'                                                           247517
     C           FRTK      ANDEQ'Y'                                                           247517
     C           TKVL      MULT MNPF      ADTV   178                                          247517
     C           ADTV      MULT ULPL      AULPL     H                                         247517
      *                                                                                       247517
      ** Otherwise, use the old computation.                                                  247517
      *                                                                                       247517
     C                     ELSE                                                               247517
     C           ULPL      MULT TKVL      AULPL  130H
     C**********           ENDIF                                                      CFF006 241147A
     C                     ENDIF                                                              247517
      *                                                                   CFF006
     C                     ELSE                                           AUS022
     C*** UNREALISED PROFIT/LOSSES ALREADY IN INSTRUMENT CURRENCY FOR     AUS022
     C*** TYPE = 7,8                                                      AUS022
     C                     Z-ADDULPL      AULPL                           AUS022
     C                     END                                            AUS022
     C                     ELSE
     C**  Zeroize p/l field
     C                     Z-ADD0         AULPL
     C                     END
     C*
     C**  If the instrument is a future
     C*
     C***********ISPT      IFEQ 1                                         AUS022
     C***********ISPT      OREQ 2                                         AUS022
     C***********ISPT      OREQ 3                                         AUS022
     C           ISPT      IFLE 3                                         AUS022
     C           ISPT      OREQ 7                                         AUS022
     C*
     C**  Determine if LF/MEMOSM & LF/PRONOM need updating
     C*
     C                     EXSR PARAM
     C*
     C                     EXSR FFSETL
     C*
     C**  LF/MEMOSM needs updating
     C*
     C           FFMIND    IFEQ 'Y'
     C                     EXSR UMEMO
     C                     END
     C*
     C**  LF/PRONOM needs updating
     C*
     C           FFPIND    IFEQ 'Y'
     C                     EXSR UPRON
     C                     END
     C*                                                                   S01240
     C**  PF/FFACMVD needs updating                                       S01240
     C*                                                                   S01240
     C           FFMIND    IFEQ 'Y'                                       S01240
     C           FFPIND    OREQ 'Y'                                       S01240
     C*                                                                   S01240
     C**  Set MEMOSM/PRONOM Update Indicator to 'M' (used in SR.WACMVD)   S01240
     C*                                                                   S01240
     C           FFMIND    IFEQ 'Y'                                       S01240
     C                     MOVE 'M'       MPIND   1                       S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C**  Set MEMOSM/PRONOM Update Indicator to 'P' (used in SR.WACMVD)   S01240
     C*                                                                   S01240
     C           FFPIND    IFEQ 'Y'                                       S01240
     C                     MOVE 'P'       MPIND                           S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C**  Write record to PF/FFACMVD                                      S01240
     C*                                                                   S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C*
     C                     END
     C*
     C**  Update Customer/broker positions file
     C*
     C                     Z-ADDAULPL     CUPL
     C                     EXCPTPSTNCU
     C*
     C                     COMIT
     C*
     C                     READ POSTNC                   01
     C*
     C                     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C**                                                             *
     C**  SR:POSTK    - PROCESSES BOOK POSITIONS                     *
     C**  CALLED FROM - MAIN PROCESSING                              *
     C**  CALLS       -                                              *
     C**  INPUTS      -                                              *
     C**  OUTPUTS     -                                              *
     C**                                                             *
     C****************************************************************
     C*
     C           POSTK     BEGSR
     C*
     C**  Read each book position off LF/POSTNK and
     C**  Continue until each record processed
     C*
     C                     READ POSTNK                   02
     C*
     C           *IN02     DOWNE'1'
     C*
     C**  Access INTYP for the instrument details
     C*
     C           ISTT      CHAININTYP                79
     C*
     C**  If no record found then database error
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA
     C***********          MOVE '08'      DBASE            ***************S01117
     C                     Z-ADD8         DBASE            ***************S01117
     C                     MOVE 'INTYP'   DBFILE           * DB ERROR 08 *
     C                     MOVELISTT      DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C                     MOVE ISTT      PISTT
     C*
     C**  Process until there is a change in the ISTT or is end of file
     C*
     C           *IN02     DOWNE'1'
     C           ISTT      ANDEQPISTT
     C*
     C**  Access equivalent record off LF/WUNRLK
     C*
     C           WUNKYK    CHAINWUNRLK               05
     C*
     C**  If record found, convert unrealized p/l to units of
     C**  instrument currency
     C*
     C           *IN05     IFEQ '0'
     C           ISPT      IFLE 6                                         AUS022
      *****************************************************************               CFF006 241147A
      ***If*enhancement*CFF006*is*installed*and*the*fractional*********               CFF006 241147A
      ***ticks*indicator*is*'Y',*then*use*this*new*processing**********               CFF006 241147A
      ***for*computing*the*Unrealised*Profit*and*Loss.*****************               CFF006 241147A
      *****************************************************************               CFF006 241147A
     C********** CFF006    IFEQ 'Y'                                                   CFF006 241147A
     C********** FRTK      ANDEQ'Y'                                                   CFF006 241147A
     C********** TKVL      MULT MNPF      ADTV                                        CFF006 241147A
     C********** ADTV      MULT ULPL      AULPL     H                                 CFF006 241147A
      *                                                                   CFF006
      ** Otherwise, use the old computation.                              CFF006
      *                                                                   CFF006
     C**********           ELSE                                                       CFF006 241147A
      *                                                                                       247517
      ** If enhancement CFF006 is installed and the fractional                                247517
      ** ticks indicator is 'Y', then use this new processing                                 247517
      ** for computing the Unrealised Profit and Loss.                                        247517
      *                                                                                       247517
     C           CFF006    IFEQ 'Y'                                                           247517
     C           FRTK      ANDEQ'Y'                                                           247517
     C           TKVL      MULT MNPF      ADTV                                                247517
     C           ADTV      MULT ULPL      AULPL     H                                         247517
      *                                                                                       247517
      ** Otherwise, use the old computation.                                                  247517
      *                                                                                       247517
     C                     ELSE                                                               247517
     C           ULPL      MULT TKVL      AULPL     H
     C**********           ENDIF                                                      CFF006 241147A
     C                     ENDIF                                                              247517
      *                                                                   CFF006
     C                     ELSE                                           AUS022
     C*** UNREALISED PROFIT/LOSSES ALREADY IN INSTRUMENT CURRENCY FOR     AUS022
     C*** TYPE = 7,8                                                      AUS022
     C                     Z-ADDULPL      AULPL                           AUS022
     C                     END                                            AUS022
     C                     ELSE
     C**  Zeroize profit/loss field
     C                     Z-ADD0         AULPL
     C                     END
     C*
     C**  Update book instrument positions file
     C*
     C                     Z-ADDAULPL     CUPL
     C                     EXCPTPSTNKU
     C*
     C                     COMIT
     C*
     C**  Read next POSTNK record
     C*
     C                     READ POSTNK                   02
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C****************************************************************
     C**                                                             *
     C**  SR:PARAM    - PREPARE PARAMETER FOR FFSETL                 *
     C**  CALLED FROM - POSTC                                        *
     C**  CALLS       -                                              *
     C**  INPUTS      -                                              *
     C**  OUTPUTS     -                                              *
     C**                                                             *
     C****************************************************************
     C*
     C           PARAM     BEGSR
     C*
     C***********          Z-ADDBRCD      FFBRCD                          S01117
     C                     MOVE BRCA      FFBRCA                          S01117
     C**********           Z-ADDCBCD      FFCBCD                                              CSD027
     C                     MOVE CBCD      FFCBCD                                              CSD027
     C                     MOVE BRKI      FFBRKI
     C*
     C           *IN03     IFEQ '1'
     C** Use SETP and SETA of FOCLT
     C                     Z-ADDSETP      FFSETP
     C                     MOVE SETA      FFSETA
     C                     MOVE SEBR      FFSETB                          S01117
     C                     ELSE
     C** Use SETP and SETA of DEFLT
     C                     Z-ADDDSETP     FFSETP
     C                     MOVE DSETA     FFSETA
     C                     MOVE DSEBR     FFSETB                          S01117
     C                     END
     C*
     C                     MOVE ISCY      FFCCY
     C*
     C****If*multi-branching*system*the*default*account*sequence**********S01117
     C****is*the*start*sequence*off*PF/TABLETR****************************S01117
     C***********                                                         S01117
     C***********MBIN      IFEQ 'Y'                                       S01117
     C***********          Z-ADDNSACS     FFDASQ                          S01117
     C***********          ELSE                                           S01117
     C***********                                                         S01117
     C****Default*account*sequence*equals*'01'****************************S01117
     C***********                                                         S01117
     C***********          Z-ADD01        FFDASQ                          S01117
     C***********          END                                            S01117
     C*
     C                     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C/COPY ZSRSRC,FFSETLZ4
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**   DBERR SR. - Database Error Handling : Terminates program      *
     C**   ~~~~~~~~~                                                     *
     C**      Called From      DB Err No.    File                        *
     C**                                                                 *
     C********************************************************************
     C*
     C           DBERR     BEGSR                           ** DBERR SR **
     C                     OUT  LDA
     C                     SETON                     U7U8LR
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     RETRN
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C****************************************************************
     C**                                                             *
     C**  SR:UMEMO    - UPDATES LF/MEMOSM                            *
     C**  CALLED FROM - UPOSTC                                       *
     C**  CALLS       -                                              *
     C**  INPUTS      -                                              *
     C**  OUTPUTS     -                                              *
     C**                                                             *
     C****************************************************************
     C*
     C           UMEMO     BEGSR
     C*
     C**  Access record off LF/MEMOSM
     C*
     C           MEMKEY    CHAINMEMOSMEF             06
     C*
     C           *IN06     IFEQ '1'
     C                     Z-ADD0         LDBL
     C                     Z-ADD0         CLBL
     C                     END
     C*                                                                   S01240
     C**  Store Ledger Balance in a work field for use in SR. WACMVD      S01240
     C*                                                                   S01240
     C                     Z-ADDLDBL      WLDBL  150                      S01240
     C*
     C**  Add unrealized p/l off LF/POSTNC to ledger and
     C**  cleared balances
     C*
     C           LDBL      ADD  CUPL      LDBL
     C           CLBL      ADD  CUPL      CLBL
     C*
     C**  Subtract unrealized p/l(converted) off LF/WUNRLC from ledger
     C**  and cleared balances
     C*
     C           LDBL      SUB  AULPL     LDBL
     C           CLBL      SUB  AULPL     CLBL
     C*
     C                     MOVE 'D'       RECI
     C                     MOVE FFCNUM    CNUM
     C                     MOVE FFCCY     CCY
     C                     MOVE FFACOD    FFACOD
     C                     MOVE FFACSQ    ACSQ
     C                     MOVE FFBRCB    BRCA                            S01117
     C*
     C**  If record already existed update it
     C*
     C           *IN06     IFEQ '0'
     C                     EXCPTMEMOSU
     C*
     C                     ELSE
     C*
     C**  Write out new record
     C*
     C                     WRITEMEMOSMEF
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C****************************************************************
     C/EJECT
     C****************************************************************
     C**                                                             *
     C**  SR:UPRON    - UPDATES LF/PRONOM                            *
     C**  CALLED FROM - UPOSTC                                       *
     C**  CALLS       -                                              *
     C**  INPUTS      -                                              *
     C**  OUTPUTS     -                                              *
     C**                                                             *
     C****************************************************************
     C*
     C           UPRON     BEGSR
     C*
     C**  Access record off LF/PRONOM
     C*
     C           PROKEY    CHAINPRONOMEF             07
     C*
     C           *IN07     IFEQ '1'
     C                     Z-ADD0         PNBL
     C                     END
     C*
     C*                                                                   S01240
     C**  Store Projected Nostro Balance in a work field for use in       S01240
     C**  SR. WACMVD                                                      S01240
     C*                                                                   S01240
     C                     Z-ADDPNBL      WPNBL  150                      S01240
     C**  Add unrealized p/l off LF/POSTNC to projected
     C**  nostro balance
     C*
     C           PNBL      ADD  CUPL      PNBL
     C*
     C**  Subtract unrealized p/l off LF/WUNRLC from projected nostro balance
     C*
     C           PNBL      SUB  AULPL     PNBL
     C*
     C                     MOVE 'D'       RECI
     C                     MOVE FFCCY     CCY
     C                     MOVE FFNOSN    NOSN
     C*
     C**  If record already existed update it
     C*
     C           *IN07     IFEQ '0'
     C                     EXCPTPRONOU
     C*
     C                     ELSE
     C*
     C**  Write out new record
     C*
     C                     WRITEPRONOMEF
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C****************************************************************
     C/EJECT                                                              S01240
     C****************************************************************    S01240
     C**                                                             *    S01240
     C**  SR:WACMVD   - WRITES RECORD TO PF/FFACMVD                  *    S01240
     C**  CALLED FROM - UPOSTC                                       *    S01240
     C**  CALLS       -                                              *    S01240
     C**  INPUTS      -                                              *    S01240
     C**  OUTPUTS     -                                              *    S01240
     C**                                                             *    S01240
     C****************************************************************    S01240
     C**                                                                  S01240
     C           WACMVD    BEGSR                                        **S01240
     C*                                                                   S01240
     C**   Set up fields for output to PF/FFACMVD                         S01240
     C*                                                                   S01240
     C**   Branch Code                                                    S01240
     C*************        MOVE *BLANK    BRCA                      S01240FO0017
     C                     MOVE FFBRCB    BRCA                            FO0017
     C*                                                                   S01240
     C**   Customer Number                                                S01240
     C*********            Z-ADDFFCNUM    CUSN                                         S01240 CSD027
     C                     MOVE FFCNUM    CUSN                                                CSD027
     C*                                                                   S01240
     C**   Currency Code                                                  S01240
     C                     MOVE FFCCY     CCYD                            S01240
     C*                                                                   S01240
     C**   Account Code                                                   S01240
     C                     Z-ADDFFACOD    ACDE                            S01240
     C*                                                                   S01240
     C**   Account Sequence                                               S01240
     C                     Z-ADDFFACSQ    ASNC                            S01240
     C*                                                                   S01240
     C**   Posting Date                                                   S01240
     C                     Z-ADDRUND      PTDT                            S01240
     C*                                                                   S01240
     C**   Value Date                                                     S01240
     C                     Z-ADDRUND      VUDT                            S01240
     C*                                                                   S01240
     C**   Transaction Type                                               S01240
     C                     MOVE *BLANK    TRYP                            S01240
     C*                                                                   S01240
     C**   Narrative Code                                                 S01240
     C                     Z-ADD0         NRTC                            S01240
     C*                                                                   S01240
     C**   Narrative Description                                          S01240
     C                     MOVELISTN      NRTD                            S01240
     C*                                                                   S01240
     C**   Transaction Number                                             S01240
     C                     MOVE *BLANK    TNMR                            S01240
     C*                                                                   S01240
     C**   Cheque Number                                                  S01240
     C                     Z-ADD*ZERO     CQNR                            S01240
     C*                                                                   S01240
     C**   Movement Amount = change in Ledger Balance/Projected           S01240
     C**                     Nostro Balance                               S01240
     C           MPIND     IFEQ 'M'                                       S01240
     C           LDBL      SUB  WLDBL     WMVAM  130                      S01240
     C                     Z-ADDWMVAM     MVAM                            S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C           MPIND     IFEQ 'P'                                       S01240
     C           PNBL      SUB  WPNBL     WMVAM                           S01240
     C                     Z-ADDWMVAM     MVAM                            S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C           MVAM      IFNE *ZERO                                     S01240
     C*                                                                   S01240
     C**   Debit or Credit                                                S01240
     C           MPIND     IFEQ 'M'                                       S01240
     C           LDBL      IFGE WLDBL                                     S01240
     C                     Z-ADD0         DORC                            S01240
     C                     ELSE                                           S01240
     C                     Z-SUBMVAM      MVAM                            S01240
     C                     Z-ADD1         DORC                            S01240
     C                     END                                            S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C           MPIND     IFEQ 'P'                                       S01240
     C           PNBL      IFGE WPNBL                                     S01240
     C                     Z-ADD0         DORC                            S01240
     C                     ELSE                                           S01240
     C                     Z-SUBMVAM      MVAM                            S01240
     C                     Z-ADD1         DORC                            S01240
     C                     END                                            S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C**  Write record to PF/FFACMVD                                      S01240
     C                     WRITEFFACMVDF                                  S01240
     C*                                                                   S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C                     ENDSR                                          S01240
     C*                                                                   S01240
     C********************************************************************S01240
     O*
     O** UPDATE POSTNCD
     O*
     OPOSTNCDFE                PSTNCU
     O                         CUPL
     O*
     O** UPDATE POSTNKD
     O*
     OPOSTNKDFE                PSTNKU
     O                         CUPL
     O*
     O** UPDATE MEMOSME
     O*
     OMEMOSMEFE                MEMOSU
     O                         LDBL
     O                         CLBL
     O*
     O** UPDATE PRONOME
     O*
     OPRONOMEFE                PRONOU
     O                         PNBL
**  CPY@
(c) Finastra International Limited 2001
