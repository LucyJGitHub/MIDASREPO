     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FF Exercise generation at maturity')             *
     F*****************************************************************
     F*                                                               *
     F*  Midas FUTURES AND OPTIONS MODULE
     F*                                                               *
     F*  FF0350  -  EXERCISE GENERATION AT MATURITY                   *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. AR746662           Date 03May11               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246526             Date 21Mar07               *
      *                 247517             Date 09May07               *
      *                 247296             Date 25Apr07               *
      *                 CPK027             Date 16Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 245805             Date 19Feb07               *
      *                 241147A            Date 07Nov06               *
      *                 241147             Date 26Oct06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 215528             Date 21Mar03               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 182019             Date 04Jul02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun02               *
      *                 CAS002             Date 14Jan02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CFF007             Date 20Feb01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CFF006             Date 28Nov00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 126117             Date 20Apr00               *
      *                 140017             Date 20Apr00               *
     F*                 140455             Date 20Apr00               *
     F*                 136056             Date 14Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.01 Patch E ---------------------------------------*
     F*                 171172             Date 25Nov99               *
      *                 170520             Date 19Nov99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CPL002             Date 08MAR99               *
      *                 CAP003             Date 30Jul98               *
     F*                 CAC003             Date 25Feb97               *
     F*                 CFF004             DATE 16SEP96               *
     F*                 S01408             DATE 14AUG96               *
     F*                 077485             DATE 17DEC95               *
     F*                 S71062             DATE 11DEC95               *
     F*                 S01408             DATE 06OCT95               *
     F*                 S01456             DATE 08NOV93               *
     F*                 S01455             DATE 05NOV93               *
     F*                 S04662             DATE 12JUL93               *
     F*                 S01411             DATE 05JUL93               *  *
     F*                 054174             DATE 21APR93               *
     F*                 E30419             DATE 02MAR93               *
     F*                 E30416             DATE 02MAR93               *
     F*                 E03643             DATE 19FEB93               *
     F*                 E30422             DATE 15FEB93               *
     F*                 S01393             DATE 30OCT92               *
     F*                 E44985             DATE 25SEP92               *
     F*                  FUJI-FF0011       DATE 21SEP92                  *
     F*                  AUS022            DATE 07AUG92                  *
     F*                  FO0110            DATE 07MAY91                  *
     F*                  FO0017            DATE 03JAN91                  *
     F*                  S01117            DATE 01MAR90                  *
     F*                  S01240            DATE 04/04/89                 *
     F*                                                                  *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  AR746662 - Discrepancy in premium amount in Currency OTC     *
      *             screen and Projected Available Balance Enquiry    *
      *             Applied fix 249171. (Recompile)                   *
      *             (Child: Artf746663)                               *
      *  246526 - Recompiled due to change in FFSETLZ4.               *
      *  247517 - Reversed fix 241147.                                *
      *  247296 -  For Ccy OTC, as MNPF was defaulted to '0.00000001',*
      *            premium must be divided by 100.                    *
      *  CPK027 - Errors in compiling MP1_3_TTTS - recompile over     *
      *           changed FFTVCLZ2.                                   *
      *  245805 - Component FFC0694 failed in pgm FF0592 because of   *
      *           blank Sett. Branch ID (SBID) in file CNFRPD.  Fix   *
      *           is to make BSLT/CSLT = '00' and BSLA/CSLA = *blank  *
      *           before writing to PF/TRSETD, if Sett. Account in    *
      *           PF/FOCLTD is not a valid nostro. Applied fix 232479.*
      *  241147A - Recompile.                                         *
      *  241147 - Recompile.                                          *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  215528 - System is associating a wrong premium amount.       *
      *           Recompiled only.                                    *
      *  182019 - Never takes the corresponding future definition to  *
      *           calculate the P&L or the transaction value.         *
      *  CPK015 - Release 4.01 Packaging:                             *
      *         - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed FFYTOPZ1.                    *
      *         - A default timestamp string is required for WRITE.   *
      *  CAS002 - Hedge Strategy/Linkage (Recompile)                  *
      *  CFF007 - Futures and Options Enhancement for Private Banking *
      *  CFF006 - Fractional Ticks Enhancement.  (Recompiled)         *
     F*  126117 - Recompiled due to changes to FFYTOPZ1.              *
     F*  140017 - Recompiled due to changes to FFPMCLZ1.              *
     F*  140455 - Recompiled due to changes to FFPMCLZ1               *
      *  136056 - Dft accuracy = 9; Australian 3 & 10 TB Future = 8.  *
      *           Calculate Australian option premiums correctly      *
      *           Recompiled due to changes in FFYTOPZ1               *
     F*  171172 - Recompile over changed POSTNCD/POSTNKD             *
      *  170520 - Recompile over changed TRANSD file                  *
     F*  CPL002 - Midas-Plato Interface                               *
     F*           Recompile only to pick up new Spot Rate field.      *
      *  CAP003 - Conversion of Midas inputs to modular API structure *
      *           Phase 2.  Program recompiled over changed files.    *
     F*  CAC003 - Profit Centre Accounting Development Phase 3.       *
     F*  CFF004 - Increase in size of Price Fields                       *
     F*  S01408 - Addition of Core Hooks FF0350CCP3                   *
     F*  077485 - FF/PM Interface : Mature Flat Positions not         *
     F*           extracted for FF trades                             *
     F*  S71062 - FF/PM Interface - Exercise Option                   *
     F*  S01408 - Addition of Core Hooks FF0350FFP1                   *
     F*                                  FF0350CCP1                   *
     F*                                  FF0350CCP2                   *
     F*  S01456 - 'FF' MONTHLY P&L ENHANCEMENTS.                         *
     F*           Recompiled due to change to PF/MKCTLD.                 *
     F*  S01455 - 'FF' ACCOUNT KEY ENHANCEMENTS.                         *
     F*           Recompiled due to changes in PF/TABTB80.               *
     F*  S04662 - Switchable Feature for Init Margins for Futures;       *
     F*           Deposit and Spread Margin Rate added to DEFLTD.        *
     F*           Recompile only.                                        *
     F*  S01411 - 'ORIGINAL ENTRY DATE' field added to PF/TRANSD         *
     F*  054174 - Premium Calculation introduced by E30422               *
     F*           should only apply to processing type 8                 *
     F*  E03643 - Recompile because of change to pf/clostt               *
     F*  E30422 - Premium calculations appear to be incorrect on         *
     F*           options purchased. To fix the error, the strike        *
     F*           price is used in the tick value computations           *
     F*           instead of the contract price.                         *
     F*  E30419 - Recompiled due to amendments on subroutine FFPLCL      *
     F*           due to rounding errors and incorrect sign of           *
     F*           profit/loss.                                           *
     F*  E30416 - Recompiled due to amendments on subroutines FFPLCL     *
     F*           and FFYTOP                                             *
     F*   S01393  -  RECOMPILED FOR STRATEGIC RISK MANAGEMENT            *
     F*   E44985  -  ZYIELD requires 3 new parameters. Recompile only    *
     F* FUJI-FF0011 - The system does not differentiate between          *
     F*               american and european option on exercise           *
     F*               validation and OTC confirmation wording.           *
     F*               *** RECOMPILE ONLY ***                             *
     F*   AUS022  -  AUSTRALIAN CHANGE : Introduction of Processing      *
     F*              Types 7 and 8.                                      *
     F*   FO0110  -  REMOVE DB ERROR 03 PROCESSING                       *
     F*   FO0017  -  UPDATE BRCA WITH SETTLEMENT ACCOUNT BRANCH IN S/R   *
     F*              WACMVD (USED TO ACCESS A/C MOVEMENTS FILE FFACVD).  *
     F*   S01117  -  MULTIBRANCHING                                      *
     F*   S01240  -  ADDITION OF REAL-TIME STATEMENTS                    *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*     CREATION REQUIREMENTS                                        *
     F*     IGNDECERR(*NO)                                               *
     F********************************************************************
     FMKCTL   IF  E           K        DISK                           UC
     FINTYP2  IF  E           K        DISK
     F            INTYPDF                           KRENAMEINTYP2DF
     FINTYP   IF  E           K        DISK
     FFOCLT   IF  E           K        DISK
     FDEFLT   IF  E           K        DISK
     FMATINE  IP  E           K        DISK
     FCLOSTD  O   E                    DISK
     FTRSETD  O   E                    DISK
     FTRANSD  O   E                    DISK
     F/COPY WNCPYSRC,FF0350FFP1                                           S01408
     FPOSTNK  UF  E           K        DISK
     FTRANSA  UF  E                    DISK
     FTRSET   UF  E           K        DISK
     F            TRSETDF                           KRENAMETRSETUF
     FTRANS6  UF  E           K        DISK
     F            TRANSDF                           KRENAMETRANSUF
     FMEMOSM  UF  E           K        DISK                      A    U2
     FPRONOM  UF  E           K        DISK                      A    U6
     FFFACMVD O   E           K        DISK                      A    U6  S01240
     FACCNT   IF  E           K        DISK
     F            ACCNTAAF                          KIGNORE
     F            ACCNTACF                          KIGNORE
     FACNUM   IF  E           K        DISK
     F            ACCNTABF                          KRENAMEACNUMF
     FPOSTNC  UF  E           K        DISK
     FCLOSTT  O   E                    DISK
     FTABFF   IF  E           K        DISK
     F* ICD 1     TABTB10F                          KIGNORE
     F* ICD 2     TABTB11F                          KIGNORE
     F            TABTB10F                          KIGNORE               S01117
     F            TABTB11F                          KIGNORE               S01117
     F* ICD 3     TABTB20F                          KIGNORE
     F* ICD 5     TABTB40F                          KIGNORE
     F* ICD-FF    TABTB80F                          KIGNORE
     F* A/C 1     TABTE10F                          KIGNORE
     F            TABTG10F                          KIGNORE
     F            TABLETHF                          KIGNORE
     F* NOSTROS   TABLETLF                          KIGNORE
     F* BRANCH    TABLETRF                          KIGNORE
     F            TABLETRF                          KIGNORE               S01117
     F            TABLET2F                          KIGNORE
     F*
      /SPACE 2
     F********************************************************************
     F*
     F* ID F  C  H  L    FUNCTION OF INDICATORS
     F*
     F*             L5   Change of Instrument Type
     F*             L4   Change of Year
     F*             L3   Change of Month
     F*             L2   Change of Put/Call
     F*             L1   Change of Strike Price
     F*
     F*       10        Broker present
     F*       11        Customer present
     F*       20        Not first cycle
     F*       50        Record NOT read on LF/TRANS6 corresponding
     F*                                            to that on LF/MATINE
     F*       51        LF/DEFLT record NOT read for customer/broker
     F*       79        Program database error
     F*
     F*     80-89       Reserved for Standard FF Subroutines
     F*     90-99       Reserved for Standard MIDAS Subroutines
     F*
     F*       U2        Retail present in system
     F*       U6        Program run during Midas input cycle
     F*     U7+U8       Database Errors
     F*
     F********************************************************************
      /EJECT
     E                    STAMP   1   1 26                                                    CPK015
      ** Array containing dummy timestamp                                                     CPK015
     E                    CPY@    1   1 80
     E********************************************************************
     E*
     E** Field narratives
     E*
     E                    MSG     1   1 25
     E/COPY WNCPYSRC,FF0350E001
      /EJECT
     I*
     I********************************************************************
     I*                                                                  *
     I**      L  E  V  E  L     B  R  E  A  K  S                         *
     I*                                                                  *
     I********************************************************************
     IMATINDF
     I*
     I** Level break descriptions for Branch, Customer/broker and Currency
     I*
     I                                              ISTT  L5
     I                                              YRNO  L4
     I                                              MTHN  L3
     I                                              PCAL  L2
     I                                              STRP  L1
     I*
     I/SPACE 5
     I*
     I********************************************************************
     I*                                                                  *
     I**      F  I  E  L  D     R  E  N  A  M  E  S                      *
     I*                                                                  *
     I********************************************************************
     IINTYPDF
     I*
     I** Field renames for LF/INTYP
     I*
     I              BCPT                            BCPTI
     I              BCMC                            BCMCI
     I              BCMS                            BCMSI
     I              BCGP                            BCGPI
     I              BCGS                            BCGSI
     I              CCPT                            CCPTI
     I              CCMC                            CCMCI
     I              CCMS                            CCMSI
     I              CCGP                            CCGPI
     I              CCGS                            CCGSI
     I              CTAM                            FFCTAM                AUS022
     I              CNTT                            FFCNTT                AUS022
     IINTYP2DF
     I*
     I** Field renames for LF/INTYP2
     I*
     I              ISTT                            ISTT2
     I              ISTI                            ISTI2
     I              ISPT                            ISPT2
     I              ISCY                            ISCY2
     I              QOTC                            QOTC2
     I              TKDM                            TKDM2
     I              MNPF                            MNPF2
     I              TKVL                            TKVL2
     I              OTHC                            OTHC2
     I/SPACE 2
     IFOCLTDF
     I*
     I** Field renames for FOCLT
     I*
     I              SETP                            SETPF
     I              SETA                            SETAF
     I              SEBR                            SEBRF                 S01117
     I              FACO                            FACOF
     I              CNOS                            CNOSF
     I/SPACE 2
     ITRANSUF
     I*
     I** Field renames for LF/TRANS6 ( Update )
     I**        ( To differentiate from PF/TRANSD )
     I*
     I              TNBR                            TNBRU
     I***********   BRCD                            BRCDU                 S01117
     I              BRCA                            BRCAU                 S01117
     I              BOCO                            BOCOU
     I              CUSC                            CUSCU
     I              BOKC                            BOKCU
     I              ISTT                            ISTTU
     I              YRNO                            YRNOU
     I              MTHN                            MTHNU
     I              PCAL                            PCALU
     I              STRP                            STRPU
     I              TRTY                            TRTYU
     I              ULTT                            ULTTU
     I              TRSD                            TRSDU
     I              NUCO                            NUCOU
     I              NOCO                            NOCOU
     I              NOBO                            NOBOU
     I              COPR                            COPRU
     I              TNAR                            TNARU
     I              TBLO                            TBLOU
     I              LNKR                            LNKRU
     I              CLSR                            CLSRU
     I              ECPI                            ECPIU
     I              CBPI                            CBPIU
     I              ISCY                            ISCYU
     I              FCDA                            FCDAU
     I              FCIN                            FCINU
     I              FBIN                            FBINU
     I              LCD                             LCDU
     I              CHTP                            CHTPU
     I              TNLU                            TNLUU
     I              ORBR                            ORBRU                 S01117
     I              PRFC                            PRFCU                 S01117
     I              PTFR                            PTFRU                 S71062
     I              ACNI                            ACNIU                 S71062
     I              MABK                            MABKU                 S71062
     I              MACU                            MACUU                 S71062
     I              CUUN                            CUUNU                 S71062
     I              UNPL                            UNPLU                 S71062
     I              UPLS                            UPLSU                 S71062
     I              MHEX                            MHEXU                 077485
     I              BPRC                            BPRCU                 CAC003
     I              TPRC                            TPRCU                 CAC003
     I/COPY WNCPYSRC,FF0350I001
     I              COVE                            COVEU                 CFF007
     I              HETR                            HETRU                 CFF007
     I              BLUP                            BLUPU                 CFF007
     I/SPACE 2
     ITRSETUF
     I*
     I** Field renames for LF/TRSET ( Update )
     I**        ( To differentiate from PF/TRSETD )
     I*
     I              TNBR                            TNBRU
     I              OCSB                            OCSBU
     I              OCDB                            OCDBU
     I              CCSB                            CCSBU
     I              CCDB                            CCDBU
     I              OCSC                            OCSCU
     I              OCDC                            OCDCU
     I              CCSC                            CCSCU
     I              CCDC                            CCDCU
     I              NCCP                            NCCPU
     I              PRMP                            PRMPU
     I              BCPT                            BCPTU
     I              BCMC                            BCMCU
     I              BCMS                            BCMSU
     I              BCMA                            BCMAU
     I              BCHC                            BCHCU
     I              BCHA                            BCHAU
     I              BMAR                            BMARU
     I              BSLT                            BSLTU
     I              BSLA                            BSLAU
     I              BSBR                            BSBRU                 S01117
     I              BFAO                            BFAOU
     I              BCPN                            BCPNU
     I              BCHP                            BCHPU
     I              BCMP                            BCMPU
     I              CCPT                            CCPTU
     I              CCMC                            CCMCU
     I              CCMS                            CCMSU
     I              CCMA                            CCMAU
     I              CCHC                            CCHCU
     I              CCHA                            CCHAU
     I              CMAR                            CMARU
     I              CSLT                            CSLTU
     I              CSLA                            CSLAU
     I              BRSC                            BRSCU                 S01117
     I              CFAO                            CFAOU
     I              CCPN                            CCPNU
     I              CCHP                            CCHPU
     I              CCMP                            CCMPU
     I/COPY WNCPYSRC,FF0350I009
     I              CMCB                            CMCBU                 CFF007
     I              CHCB                            CHCBU                 CFF007
     I              CMCC                            CMCCU                 CFF007
     I              CHCC                            CHCCU                 CFF007
     I*
     I/SPACE 5
     I*
     I********************************************************************
     I*                                                                  *
     I**      D  A  T  A     S  T  R  U  C  T  U  R  E  S                *
     I*                                                                  *
     I********************************************************************
     I*
     INACON       DS
     I*
     I**   Data area NACON - Next available close out number
     I*
     I                                        1   60CLONO
     I/SPACE 2
     I*DA********UDS                            256                       S01117
     ILDA         DS                            256                       S01117
     I*
     I**   Local data area for database error details
     I** *LOCK IN LDA immediately before and OUT LDA immediately          S01117
     I** after each database error handling.                              S01117
     I*
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 1770DBASE                 S01117
     I                                      134 141 DBFILE                S01117
     I/COPY WNCPYSRC,FF0350I002
     I***********                           142 170 DBKEY           S01117CFF004
     I***********                           171 180 DBPGM           S01117CFF004
     I***********                           181 1830DBASE           S01117CFF004
     I/COPY WNCPYSRC,FF0350I003
     I                                      142 175 DBKEY                 CFF004
     I                                      176 185 DBPGM                 CFF004
     I                                      186 1880DBASE                 CFF004
     I**                                                                  S01117
     IRUNDT       DS                                                      S01117
     I** DATA AREA RUNDAT                                                 S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
     I/COPY WNCPYSRC,FF0350I010
     I*                                                                   CFF007
     I** DS for Midas Switchable Features Access Object                   CFF007
     I*                                                                   CFF007
     ISCSARD    E DSSCSARDPD                                              CFF007
     I*                                                                   CFF007
     I** DS for Midas Module Access Object                                CFF007
     I*                                                                   CFF007
     ISDMMOD    E DSSDMMODPD                                              CFF007
     I*                                                                   CFF007
     I** DS for Portfolio Management ICD Access Object                    CFF007
     I*                                                                   CFF007
     ISDPORT    E DSSDPORTPD                                              CFF007
     I*                                                                   CFF007
     I** DS for Futures and Options Client Access Object                  CFF007
     I*                                                                   CFF007
     ISDFOCS    E DSSDFOCSPD                                              CFF007
     I*                                                                   CFF007
     I** DS for Nostro Details Access Object                              CFF007
     I*                                                                   CFF007
     ISDNOST    E DSSDNOSTPD                                              CFF007
     I*                                                                   CFF007
     I** DS for Extended Client Details Access Object                     CFF007
     I*                                                                   CFF007
     ISDCUST    E DSSDCUSTPD                                              CFF007
     I*                                                                   CFF007
     I** Long data structure for access objects                           CFF007
     I*                                                                   CFF007
     I@DSSDY    E DSDSSDY                                                 CFF007
     I*                                                                   CFF007
     I** Very long data structure for access objects                      CFF007
     I*                                                                   CFF007
     I@DSLDY    E DSDSLDY                                                 CFF007
     I*                                                                   CFF007
     IPHASE       DS                                                      CFF007
     I*                                                                   CFF007
     I**   Data area MPHAS - Phase of the Day                             CFF007
     I*                                                                   CFF007
     I                                        1   1 PHASED                CFF007
     ISDBANK    E DSSDBANKPD                                              S01117
     I**  EXTERNAL DS FOR BANK DETAILS                                    S01117
     I              BJSBRC                          USRBCH                S01117
     I*                                                                   S01117
     ISDBRCH    E DSSDBRCHPD                                              S01117
     I** Branch Details                                                   S01117
     I              QQDFAC                          DFACQQ                                    CGL029
     I              A8BICN                          BICN                  S01117
      *                                                                                       CGL029
     ISDACOD    E DSSDACODPD                                                                  CGL029
      ** External data structure for account code                                             CGL029
     I              QQACCD                          ACCDQQ                                    CGL029
      *                                                                                       CGL029
     I@DSFDY    E DSDSFDY                                                 S01117
     I*  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE               S01117
      *                                                                                       CGL029
     IDSSDY     E DSDSSDY                                                                     CGL029
      ** Second DS for Access Programs, Long Data Structure                                   CGL029
     I              SDY1                            SDYZ1                                     CGL029
     I              SDY2                            SDYZ2                                     CGL029
     I              SDY3                            SDYZ3                                     CGL029
     I              SDY4                            SDYZ4                                     CGL029
      *                                                                                       CGL029
     I/COPY WNCPYSRC,FF0350I008
     I            DS                                                      CFF007
     I**********                              1  15 STTA                               CFF007 CGL029
     I                                        1  21 STTA                                      CGL029
     I                                        1   6 WCNUM                 CFF007
     I                                        7   9 WCCY                  CFF007
     I**********                             10  13 WACOD                              CFF007 CGL029
     I**********                             14  15 WACSQ                              CFF007 CGL029
     I                                       10  19 WACOD                                     CGL029
     I                                       20  21 WACSQ                                     CGL029
     I*                                                                   CFF007
     I*
     I/SPACE 5
     I*
     I********************************************************************
     I*                                                                  *
     I**      D  A  T  A     S  T  R  U  C  T  U  R  E  S                *
     I*                                         Used for chaining        *
     I********************************************************************
     I*
     I**   Split up Instrument Type for chain to LF/DEFLT
     I*
     IISTT        DS
     I                                        1   2 MKT
     I                                        3   5 ISTC
     I/SPACE 2
     I*
     I**   LF/INTYP2
     I*
     IXINTY2      DS
     I                                        1   2 XMRKT
     I                                        3   5 FTRF
     I/SPACE 2
     I/COPY ZSRSRC,FFSRDSZ1
     I/COPY ZSRSRC,ZYLDZ1                                                 AUS022
     I*
     I**   File Format of Price
     I*
     I/SPACE 2
     I/COPY ZSRSRC,FFSETLZ1
     I*
     I**   Data Structures for use in Standard Routine FFSETL
     I*
     I/SPACE 5
     I*
     I********************************************************************
     I*                                                                  *
     I**      D  A  T  A     S  T  R  U  C  T  U  R  E  S                *
     I*                                         Used for LDA key         *
     I********************************************************************
     I*
     I**   LF/TRANS6
     I*
     IXTRANS      DS
     I                                        1   5 ISTTK1
     I                                        6   70YRNOK1
     I                                        8   90MTHNK1
     I                                       10  10 PCALK1
     I/COPY WNCPYSRC,FF0350I004
     I***********                            11  217STRPK1                CFF004
     I/COPY WNCPYSRC,FF0350I005
     I                                       11  258STRPK1                CFF004
     I/SPACE 2
     IXPSTNC      DS
     I*
     I** DS FOR ERROR HANDLING OF POSTNC FILE KEY  ( CUSTOMER )
     I*
     I***********                             1   30BRCDK2                S01117
     I                                        1   3 BRCAK2                S01117
     I**********                              4   90CUSCK2                                    CSD027
     I                                        4   9 CUSCK2                                    CSD027
     I                                       10  14 ISTTK2
     I                                       15  160YRNOK2
     I                                       17  180MTHNK2
     I                                       19  19 PCALK2
     I/COPY WNCPYSRC,FF0350I006
     I***********                            20  307STRPK2                CFF004
     I/COPY WNCPYSRC,FF0350I007
     I                                       20  348STRPK2                CFF004
     I/SPACE 2
     IXPSTNB      DS
     I*
     I** DS FOR ERROR HANDLING OF POSTNC FILE KEY  ( BROKER )
     I*
     I***********                             1   30BRCDK3                S01117
     I                                        1   3 BRCAK3                S01117
     I**********                              4   90BOCOK3                                    CSD027
     I                                        4   9 BOCOK3                                    CSD027
     I                                       10  14 ISTTK3
     I                                       15  160YRNOK3
     I                                       17  180MTHNK3
     I                                       19  19 PCALK3
     I***********                            20  307STRPK3                CFF004
     I                                       20  348STRPK3                CFF004
     I/SPACE 2
     IXPSTNK      DS
     I*
     I** DS FOR ERROR HANDLING OF POSTNK FILE KEY
     I*
     I***********                             1   30BRCDK4                S01117
     I                                        1   3 BRCAK4                S01117
     I                                        4   5 BOKCK4
     I                                        6  10 ISTTK4
     I                                       11  120YRNOK4
     I                                       13  140MTHNK4
     I                                       15  15 PCALK4
     I***********                            16  267STRPK4                CFF004
     I                                       16  308STRPK4                CFF004
      /EJECT
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I/COPY WNCPYSRC,FF0350I011
     C********************************************************************
     C*                                                                  *
     C**           P  A  R  A  M  E  T  E  R  S                          *
     C*                                                                  *
     C********************************************************************
     C*
     C**   Receive Parameter
     C*
     C**   ( PMRKT = Market Centre Code, blank for OTCs )
     C           *ENTRY    PLIST
     C                     PARM           PMRKT   2
     C/SPACE 5
     C*
     C********************************************************************
     C*                                                                  *
     C**           W   O   R   K        F   I   E   L   D   S            *
     C*                                                                  *
     C********************************************************************
     C/SPACE 5
     C*
     C**  Save results from standard routines
     C*
     C**                    Transaction Value from SR/FFTVCL
     C           *LIKE     DEFN FFTNVL    WTNVL
     C**                    Premium payable from SR/FFPMCL
     C           *LIKE     DEFN FFPREM    WPREM
     C**                    Profit/Loss from FFPLCL
     C           *LIKE     DEFN FFPOL     WPOL
     C/SPACE 2
     C*
     C**  Broker Instrument Defaults
     C*
     C**                    Transaction Broker Charge/Commission Pattern
     C           *LIKE     DEFN BCPT      BCPTW
     C**                    Transaction Broker Commission Code
     C           *LIKE     DEFN BCMC      BCMCW
     C**                    Transaction Broker Same Day Commission
     C           *LIKE     DEFN BCMS      BCMSW
     C**                    Transaction Broker Charge Codes
     C           *LIKE     DEFN BCGPI     BCGPW
     C           *LIKE     DEFN BCGSI     BCGSW
     C**                    Transaction Broker Settlement Type
     C           *LIKE     DEFN BSLT      BSLTW
     C**                    Transaction Broker Settlement Account
     C           *LIKE     DEFN BSLA      BSLAW
     C**                    Transaction Broker Settlement Branch          S01117
     C           *LIKE     DEFN BSBR      BSBRW                           S01117
     C**                    Transaction Broker For Account Of
     C           *LIKE     DEFN BFAO      BFAOW
     C**                    Transaction Broker Counterparty Nostro
     C           *LIKE     DEFN BCPN      BCPNW
     C/SPACE 2
     C*
     C**  Customer Instrument Defaults
     C*
     C**                    Transaction Customer Charge/Commission Pattern
     C           *LIKE     DEFN CCPT      CCPTW
     C**                    Transaction Customer Commission Code
     C           *LIKE     DEFN CCMC      CCMCW
     C**                    Transaction Customer Same Day Commission
     C           *LIKE     DEFN CCMS      CCMSW
     C**                    Transaction Customer Charge Codes
     C           *LIKE     DEFN CCGPI     CCGPW
     C           *LIKE     DEFN CCGSI     CCGSW
     C**                    Transaction Customer Settlement Type
     C           *LIKE     DEFN CSLT      CSLTW
     C**                    Transaction Customer Settlement Account
     C           *LIKE     DEFN CSLA      CSLAW
     C**                    Transaction Customer Settlement Banch         S01117
     C           *LIKE     DEFN BRSC      BRSCW                           S01117
     C**                    Transaction Customer For Account Of
     C           *LIKE     DEFN CFAO      CFAOW
     C**                    Transaction Customer Counterparty Nostro
     C           *LIKE     DEFN CCPN      CCPNW
     C/SPACE 2
     C*
     C**  Work Customer/Broker Instrument Defaults
     C**     ( For use in common routine for calculating
     C**       Customer & Broker Instrument defaults )
     C*
     C**                    Transaction Charge/Commission Pattern
     C           *LIKE     DEFN CCPT      WCPTW
     C**                    Transaction Commission Code
     C           *LIKE     DEFN CCMC      WCMCW
     C**                    Transaction Same Day Commission
     C           *LIKE     DEFN CCMS      WCMSW
     C**                    Transaction Charge Codes
     C           *LIKE     DEFN CCGPI     WCGPW
     C           *LIKE     DEFN CCGSI     WCGSW
     C**                    Transaction Settlement Type
     C           *LIKE     DEFN CSLT      WSLTW
     C**                    Transaction Settlement Account
     C           *LIKE     DEFN CSLA      WSLAW
     C**                    Transaction Settlement Branch                 S01117
     C           *LIKE     DEFN BRSC      WSLBW                           S01117
     C**                    Transaction For Account Of
     C           *LIKE     DEFN CFAO      WFAOW
     C**                    Transaction Counterparty Nostro
     C           *LIKE     DEFN CCPN      WCPNW
     C/SPACE 1
     C*
     C** Common routine mentioned above requires these input fields
     C*
     C/SPACE 1
     C**  Customer/Broker Code ( Work )
     C           *LIKE     DEFN CUSC      WCBCD
     C/SPACE 1
     C*
     C** Work LF/INTYP fields for passing into routine mentioned above
     C*
     C**                    Charge/Commission Pattern
     C           *LIKE     DEFN CCPT      WCPT
     C**                    Commission Code
     C           *LIKE     DEFN CCMC      WCMC
     C**                    Same Day Commission
     C           *LIKE     DEFN CCMS      WCMS
     C**                    Charge Code - Purchases
     C           *LIKE     DEFN CCGPI     WCGP
     C**                    Charge Code - Sales
     C           *LIKE     DEFN CCGSI     WCGS
     C/SPACE 5
     C*
     C**  Work fields to save margin values
     C*
     C           *LIKE     DEFN BMAR      BMARUS
     C           *LIKE     DEFN CMAR      CMARUS
     C/SPACE 2
     C*
     C**  Work field to save field updated on LF/TRANS6 whose
     C**  values is required in subsequent calculations
     C*
     C           *LIKE     DEFN NOCO      NOCOUS
     C           *LIKE     DEFN NOBO      NOBOUS
     C/SPACE 2
     C********************************************************************
     C*                                                                  *
     C**      C   O   N   T   R   O   L        F   I   E   L   D   S     *
     C*                                                                  *
     C********************************************************************
     C*
     C           *LIKE     DEFN BOCO      @BOCO
     C           *LIKE     DEFN CUSC      @CUSC
     C/SPACE 2
     C********************************************************************
     C*                                                                  *
     C**      K   E   Y        L   I   S   T   S                         *
     C*                                                                  *
     C********************************************************************
     C*
     C**   LF/TRANS6
     C*
     C           KTRANS    KLIST
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C/SPACE 1
     C*
     C**   LF/MEMOSM
     C*
     C           KMEMSM    KLIST
     C                     KFLD           FFBRCB                          S01117
     C                     KFLD           FFCNUM
     C                     KFLD           ISCYU
     C                     KFLD           FFACOD
     C                     KFLD           FFACSQ
     C/SPACE 1
     C*
     C**   LF/PRONOM
     C*
     C           KPRONM    KLIST
     C                     KFLD           ISCYU
     C                     KFLD           FFNOSN
     C/SPACE 1
     C*
     C** POSTNC FILE KEY - CUSTOMER
     C*
     C           KPSTNC    KLIST
     C***********          KFLD           BRCDU                           S01117
     C                     KFLD           BRCAU                           S01117
     C                     KFLD           CUSCU
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C/SPACE 1
     C*
     C** POSTNC FILE KEY - BROKER
     C*
     C           KPSTNB    KLIST
     C***********          KFLD           BRCDU                           S01117
     C                     KFLD           BRCAU                           S01117
     C                     KFLD           BOCOU
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C/SPACE 1
     C*
     C** POSTNK FILE KEY - BOOK
     C*
     C           KPSTNK    KLIST
     C***********          KFLD           BRCDU                           S01117
     C                     KFLD           BRCAU                           S01117
     C                     KFLD           BOKCU
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C/SPACE 1
     C*
     C** DEFLT FILE KEY - BROKER/CUSTOMER
     C*
     C           KWDFLT    KLIST
     C                     KFLD           WCBCD
     C                     KFLD           MKT
     C                     KFLD           ISTC
     C/SPACE 2
     C*
     C**   Key Lists for use in Standard Routine FFSETL
     C*
     C/COPY ZSRSRC,FFSETLZ2
     C*
     C/SPACE 5
     C********************************************************************
     C*
     C**             I N I T I A L   P R O C E S S I N G
     C*
     C********************************************************************
     C*
     C** IF first cycle, perform initial processing
     C*
     C           *IN20     IFEQ '0'
     C                     EXSR INIT
     C                     END
     C/SPACE 5
     C********************************************************************
     C*
     C**             M A I N   P R O C E S S I N G
     C*
     C********************************************************************
     C*
     C** IF Indicator L5 is on
     C**           ( ie Change of Instrument type on LF/MATINE )
     C**     Access INTYP for processing type
     C**     IF no record found,
     C**     OR record not live
     C**          Perform Database error processing
     C*
     C           *INL5     IFEQ '1'
     C*
     C           ISTT      CHAININTYP                79
     C**
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'INTYP'   DBFILE
     C                     MOVELISTT      DBKEY            ***************
     C                     Z-ADD1         DBASE            * DB ERROR 01 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C**
     C*
     C**     IF instrument is a market option
     C**        Access INTYP2 for underlying instrument
     C**        IF no record found,
     C**        OR record not live
     C**             Perform Database error processing
     C*
     C**
     C           ISTI      IFEQ 'N'
     C*
     C           XINTY2    CHAININTYP2               79
     C***
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'INTY2'   DBFILE
     C                     MOVELXINTY2    DBKEY            ***************
     C                     Z-ADD2         DBASE            * DB ERROR 02 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C***
     C                     END
     C**
     C                     END
     C/SPACE 2
     C*
     C**  Process all associated LF/TRANS6 records
     C**  Using a key of instrument details from MATINE
     C**   SETLL on TRANS6 to enable access of corresponding trades
     C*****IF*this*results*in*error***************************************FO0110
     C********perform*database*error*processing***************************FO0110
     C*
     C           KTRANS    SETLLTRANS6                   79
     C*
     C**  If no trades found with open positions, then all trades have    FO0110
     C**  already been closed out by program FF0330, and no Exercises     FO0110
     C**  need be generated.                                              FO0110
     C*                                                                   FO0110
     C************IN79     IFEQ '0'                                       FO0110
     C************LOCK     IN   LDA                                 S01117FO0110
     C************         MOVE 'TRANS'   DBFILE                          FO0110
     C************         MOVE ISTT      ISTTK1                          FO0110
     C************         Z-ADDYRNO      YRNOK1                          FO0110
     C************         Z-ADDMTHN      MTHNK1                          FO0110
     C************         MOVE PCAL      PCALK1                          FO0110
     C************         Z-ADDSTRP      STRPK1                          FO0110
     C************         MOVELXTRANS    DBKEY                           FO0110
     C************         Z-ADD3         DBASE            * DB ERROR 03 *FO0110
     C************         OUT  LDA                        *********S01117FO0110
     C************         EXSR DBERR                      ***************FO0110
     C************         END                                            FO0110
     C*                                                                   FO0093
     C           *IN79     IFEQ '1'                                       FO0110
     C*
     C** Initial read of transactions file
     C*
     C           KTRANS    READETRANS6                   50
     C*
     C** Process all TRANS6 records corresponding to that on MATINE
     C*
     C           *IN50     DOWEQ'0'
     C*
     C** On change of broker set up new default values
     C**    OR if new instrument has been read off MATINE.
     C*
     C**
     C           BOCOU     IFNE @BOCO
     C           *INL5     OREQ '1'
     C                     EXSR BOCNO
     C                     END
     C**
     C*
     C** Save new broker code
     C*
     C**********           Z-ADDBOCOU     @BOCO                                               CSD027
     C                     MOVE BOCOU     @BOCO                                               CSD027
     C*
     C** Process transaction records whilst records exist
     C**                                    and broker unchanged
     C*
     C**
     C           *IN50     DOWEQ'0'
     C           BOCOU     ANDEQ@BOCO
     C*
     C** On change of customer set up new default values
     C**    OR if new instrument has been read off MATINE.
     C*
     C***
     C           CUSCU     IFNE @CUSC
     C           *INL5     OREQ '1'
     C                     EXSR CUSNO
     C                     END
     C*
     C** Set *INL5 off to prevent duplication of processing
     C** if no change in Instrument , Customer or Broker.
     C*
     C                     SETOF                     L5
     C*
     C***
     C*
     C** Save new customer code
     C*
     C**********           Z-ADDCUSCU     @CUSC                                               CSD027
     C                     MOVE CUSCU     @CUSC                                               CSD027
     C*
     C** Process transaction records whilst records exist
     C**                                    and broker unchanged
     C**                                    and customer unchanged
     C*
     C***
     C           *IN50     DOWEQ'0'
     C           BOCOU     ANDEQ@BOCO
     C           CUSCU     ANDEQ@CUSC
     C*
     C**  Calculate Transaction Value of the contracts being exercised
     C**  on the trade from LF/TRANS6
     C*
     C                     EXSR CTRANV
     C*
     C**  Calcuate the premium involved
     C*
     C                     EXSR CPREM
     C*
     C**  Calculate the realised profit/loss of this exercise
     C*
     C                     EXSR CRLPL
     C*
     C**  Output an exercise transaction to PF/TRANSD
     C*
     C                     EXSR WTRAND
     C*
     C/COPY WNCPYSRC,FF0350C003
     C**  Output that exercises transaction details to PF/TRSETD
     C*
     C                     EXSR WTRSET
     C*
     C**  Update the trade on LF/TRANS6 now being exercised
     C*
     C                     EXSR UTRANS
     C*
     C**  Update the settlement details of the trade on LF/TRANS6
     C**  now being exercised
     C*
     C                     EXSR UTRSET
     C*
     C**  Write a Close Out Set detail record
     C*
     C                     EXSR WCLSTD
     C*
     C**  Write two Close Out Set transaction records
     C*
     C                     EXSR WCLSTT
     C*
     C**  Access Branch details of the trade for use when determining
     C**  whether MEMOSM / PRONOM updating is required
     C*
     C                     EXSR RDTABR
     C*
     C**  Determine whether MEMOSM/PRONOM updating is required for
     C**  CUSTOMER & shadow post / update nostro balances if required
     C*
     C********** CUSCU     IFNE *ZERO                                                         CSD027
     C           CUSCU     IFNE *BLANKS                                                       CSD027
     C                     EXSR UCPRPL
     C                     END
     C*
     C**  Determine whether MEMOSM/PRONOM updating is required for
     C**  BROKER & shadow post / update nostro balances if required
     C*
     C********** BOCOU     IFNE *ZERO                                                         CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C                     EXSR UBPRPL
     C                     END
     C*
     C**  Update positions files
     C*
     C                     EXSR UPOSTN
     C*
     C**  Update PF/TRANSA
     C*
     C                     EXSR UTRANA
     C*
     C** Driving read of transactions file
     C*
     C           KTRANS    READETRANS6                   50
     C*
     C** End of customer loop
     C*
     C                     END
     C***
     C*
     C** End of broker loop
     C*
     C                     END
     C**
     C** End of corresponding records on transactions file
     C*
     C                     END
     C*
     C** End of check that trades exist for this muturity closeout record FO0110
     C*                                                                   FO0110
     C                     END                                            FO0110
     C*
     C********************************************************************
     C/EJECT
     C*
     C********************************************************************
     C***                                                                *
     C***               S  U  B  R  O  U  T  I  N  E  S                  *
     C***                                                                *
     C********************************************************************
     C**
     C**
     C**        CTRANV - CALCULATE TRANSACTION VALUE
     C**
     C**        CPREM  - CALCULATE PREMIUM
     C**
     C**        CRLPL  - CALCULATE REALISED PROFIT / LOSS
     C**
     C**        WTRAND - FORMAT & WRITE TRANSACTION DETAILS
     C**
     C**        WTRSET - FORMAT & WRITE TRANSACTION SETTLEMENT DETAILS
     C**
     C**        UTRANS - UPDATE TRADE BEING EXERCISED
     C**
     C**        UTRSET - UPDATE TRADE SETTLEMENT DETAILS OF TRADE
     C**                 CURRENTLY BEING EXERCISED
     C**
     C**        WCLSTD - FORMAT & WRITE CLOSE OUT SET DETAILS
     C**
     C**        WCLSTT - FORMAT & WRITE TWO CLOSE OUT SET TRANSACTION
     C**                 RECORDS
     C**
     C**        RDTABR - ACCESS BRANCH DETAILS FOR TRADE
     C**
     C**        UPOSTN - UPDATE POSITIONS FILE FOR BROKER & CUSTOMER
     C**                 & BOOK
     C**
     C**        UTRANA - UPDATES TRANSACTIONS AUDIT RECORD
     C**
     C**        RDMEMO - ACCESS SHADOW BALANCES RECORD
     C**
     C**        UPMEMO - UPDATE/WRITE SHADOW BALANCES RECORD
     C**
     C**        RDPRON - ACCESS PROJECTED NOSTROS RECORD
     C**
     C**        UPPRON - UPDATE/WRITE PROJECTED NOSTROS RECORD
     C**
     C**        WACMVD - WRITE RECORD TO PF/FFACMVD                       S01240
     C**                                                                  S01240
     C**        UCPRPL - DETERMINE IF MEMOS/PRONO UPDATE REQUIRED
     C**                 AND SHADOW POSt / UPDATE NOSTRO BALANCES
     C**                 IF REQUIRED FOR CUSTOMER
     C**
     C**        UBPRPL - DETERMINE IF MEMOS/PRONO UPDATE REQUIRED
     C**                 AND SHADOW POSt / UPDATE NOSTRO BALANCES
     C**                 IF REQUIRED FOR BROKER
     C**
     C**        WDEFLT - INITIALISE BROKER/CUSTOMER DEFAULT VALUES
     C**
     C**        CUSNO  - INITIALISE CUSTOMER DEFAULT VALUES
     C**
     C**        BOCNO  - INITIALISE BROKER DEFAULT VALUES
     C**
     C**        INIT   - PERFORMS FIRST CYCLE OPERATIONS ONLY
     C**
     C**        DBERR  - HANDLES DATA BASE ERRORS
     C**
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**
     C** Calculate Transaction Value
     C**
     C** CALLED FROM
     C**        Main
     C** CALLS:
     C**        FFTVCL - Calculate Transaction Value
     C**
     C********************************************************************
     C*
     C           CTRANV    BEGSR
     C*
     C** Set up Parameters for FFTVCL
     C*
     C** Values from trade to be exercised ( LF/TRANS6 )
     C                     Z-ADDNOCOU     FFNOC
     C                     Z-ADDCOPRU     FFPRIC
     C** Values from instrument type record for the transaction
     C** instrument ( LF/INTYP )
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFTVCL
     C*
     C**  Save resulting value
     C*
     C                     Z-ADDFFTNVL    WTNVL
     C**
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C/COPY ZSRSRC,FFTVCLZ2
     C/EJECT
     C********************************************************************
     C**
     C** CPREM - Calculate Premium Involved
     C**
     C** CALLED FROM
     C**        Main
     C** CALLS:
     C**        FFPMCL - Calculate Premium Payable on a given no.
     C**                 of contracts at a given contract price
     C**
     C********************************************************************
     C*
     C           CPREM     BEGSR
     C*
     C** Set up Parameters for FFPMCL
     C*
     C*
     C** Values from trade to be exercised ( LF/TRANS6 )
     C                     Z-ADDNOCOU     FFNOC
     C***********          Z-ADDCOPRU     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
      *                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRPU     FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRU     FFPRIC                          054174
     C                     Z-ADDSTRPU     FFSTRP                          136056
     C***********          END                                     054174 136056
     C*                                                                   E30422
     C** Values from instrument type record for the transaction
     C** instrument ( LF/INTYP )
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFPMCL
      **                                                                                      247296
      **   for processing type 5 (CCY OTC), divide premium by 100                             247296
     C           ISPT      IFEQ 5                                                             247296
     C           FFPREM    DIV  100       FFPREM                                              247296
     C                     ENDIF                                                              247296
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRU     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*
     C**  Save resulting value
     C*
     C                     Z-ADDFFPREM    WPREM
     C**
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C/COPY ZSRSRC,FFPMCLZ1
     C/EJECT
     C********************************************************************
     C**
     C** CRLPL - Calculate Realised profit/loss on the exercise
     C**
     C** CALLED FROM
     C**        Main
     C** CALLS:
     C**        FFPLCL - Calculate Profit or Loss
     C**
     C********************************************************************
     C*
     C           CRLPL     BEGSR
     C*
     C** Set up Parameters for FFPLCL
     C*
     C** Values from trade to be exercised ( LF/TRANS6 )
     C                     Z-ADDNOCOU     FFNOC
     C*
     C**   Which Price is which depends on whether the trade being
     C**   exercised is a put or call option  ( LF/TRANS6 )
     C**   ( Spot Price from LF/MATINE, Strike Price from LF/TRANS6 )
     C*
     C           PCALU     IFEQ 'C'
     C***********          Z-ADDNSPR      FFPRCX                          AUS022
     C***********          Z-ADDSTRPU     FFPRCY                          AUS022
     C/COPY WNCPYSRC,FF0350C001
     C***********          Z-ADDNSPR      FFPRCX 117                AUS022CFF004
     C***********          Z-ADDSTRPU     FFPRCY 117                AUS022CFF004
     C/COPY WNCPYSRC,FF0350C002
     C           *LIKE     DEFN NSPR      FFPRCX                          CFF004
     C           *LIKE     DEFN STRP      FFPRCY                          CFF004
     C                     Z-ADDNSPR      FFPRCX                          CFF004
     C                     Z-ADDSTRPU     FFPRCY                          CFF004
     C                     ELSE
     C                     Z-ADDSTRPU     FFPRCX
     C                     Z-ADDNSPR      FFPRCY
     C                     END
     C*
     C*****The*Ticks*Denominator,*Minimum*Price*Fluctuation*and           182019
     C*****Tick*Value*depend*on*whether*the*trade*being*exercised         182019
     C*****is*an*OTC*or*a*Market*Instrument                               182019
     C**********                                                          182019
     C********** ISTI      IFEQ 'Y'                                       182019
     C***OTC**(*Instrument*Type*record*for*the*OTC*-*LF/INTYP*)           182019
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDTKVL      FFTKVL
     C                     Z-ADDMNPF      FFMNPF
     C**********           ELSE                                           182019
     C***Market*Instrument*(*Instrument*Type*record*for*the*Underlying    182019
     C**********             Instrument - LF/INTYP2 )                     182019
     C**********           Z-ADDTKDM2     FFTKDM                          182019
     C**********           Z-ADDTKVL2     FFTKVL                          182019
     C**********           Z-ADDMNPF2     FFMNPF                          182019
     C**********           END                                            182019
     C*
     C**   Calculate Realised P & L using standard SR. FFPLCL
     C*
     C                     EXSR FFPLCL
     C*
     C**  Save resulting value
     C*
     C                     Z-ADDFFPOL     WPOL
     C**
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT
     C/COPY ZSRSRC,FFPLCLZ1
     C/EJECT
     C********************************************************************
     C**
     C** S/R WTRAND TO FORMAT AND WRITE TRANSACTION DETAILS
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           WTRAND    BEGSR
     C**
     C                     MOVE 'D'       RECI
     C*
     C**  Take the additive inverse of the transaction number
     C**  of the trade being exercised
     C*
     C                     Z-SUBTNBRU     TNBR
     C*
     C**   Fields from trade currently being exercised
     C*
     C***********          Z-ADDBRCDU     BRCD                            S01117
     C                     MOVE BRCAU     BRCA                            S01117
     C**********           Z-ADDBOCOU     BOCO                                                CSD027
     C**********           Z-ADDCUSCU     CUSC                                                CSD027
     C                     MOVE BOCOU     BOCO                                                CSD027
     C                     MOVE CUSCU     CUSC                                                CSD027
     C                     MOVELPTFRU     PTFR                            S71062
     C                     MOVE BOKCU     BOKC
     C                     MOVE ISTTU     ISTT
     C                     Z-ADDYRNOU     YRNO
     C                     Z-ADDMTHNU     MTHN
     C                     MOVE PCALU     PCAL
     C                     Z-ADDSTRPU     STRP
     C                     MOVE ORBRU     ORBR                            S01117
     C                     MOVE PRFCU     PRFC                            S01117
     C                     MOVE BPRCU     BPRC                            CAC003
     C                     MOVE TPRCU     TPRC                            CAC003
     C/COPY WNCPYSRC,FF0350C005
     C*
     C                     MOVE 'E'       TRTY
     C*
     C**  Underlying Transaction Type set to the transaction type
     C**  of the trade being exercised
     C*
     C                     MOVE TRTYU     ULTT
     C*
     C**  Maturity date from MATINE
     C*
     C                     Z-ADDMDAT      TRSD
     C                     MOVE 'N'       ACNI                            S71062
     C                     Z-ADD*ZEROS    MABK                            S71062
     C                     Z-ADD*ZEROS    MACU                            S71062
     C                     Z-ADD*ZEROS    CUUN                            S71062
     C                     Z-ADD*ZEROS    UNPL                            S71062
     C                     Z-ADD*ZEROS    UPLS                            S71062
     C**                                                                  077485
     C                     MOVE *BLANKS   MHEX                            077485
     C*
     C/COPY WNCPYSRC,FF0350CCP2                                           S01408
     C**  Set number of contracts equal to the number of open contracts
     C**  for customer/book on LF/TRANS6
     C*
     C                     Z-ADDNOCOU     NUCO
     C*
     C                     Z-ADD0         NOCO
     C*
     C                     Z-ADD0         NOBO
     C*
     C**  Spot Price from MATINE
     C*
     C                     Z-ADDNSPR      COPR
     C*
     C**  Transaction Narrative = 'SETTLEMENT EXERCISE'
     C*
     C                     MOVEAMSG,1     TNAR
     C*                                                                   S01408
     C/COPY WNCPYSRC,FF0350CCP3                                           S01408
     C*                                                                   S01408
     C*
     C                     MOVE 'N'       TBLO
     C*
     C                     Z-ADD0         LNKR
     C*
     C**  Closure Reference = Transaction No. of trade being exercised
     C*
     C                     Z-ADDTNBRU     CLSR
     C*
     C                     MOVE 'N'       ECPI
     C*
     C                     MOVE 'Y'       CBPI
     C*
     C**  ( Currency from LF/INTYP )
     C*
     C                     Z-ADD0         FCDA
     C*
     C                     MOVE 'N'       FCIN
     C*
     C**  Broker closure indicator
     C*
     C********** BOCOU     IFNE 0                                                             CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C                     MOVE 'N'       FBIN
     C                     ELSE
     C                     MOVE 'Y'       FBIN
     C                     END
     C*
     C**  Last Change Date
     C*
     C           PMRKT     IFEQ *BLANKS
     C** OTC - RUND from TABTB10
     C                     Z-ADDRUND      LCD
     C                     ELSE
     C** Market - BUSD from MKCTL
     C                     Z-ADDBUSD      LCD
     C                     END
      *                                                                   S01411
      ** Move Run date into 'ORIGINAL ENTRY DATE'                         S01411
      *                                                                   S01411
     C                     Z-ADDRUND      ORED                            S01411
     C*
     C                     MOVE 'I'       CHTP
     C*
     C                     Z-ADD0         TNLU
     C*                                                                   CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C                     MOVE COVEU     COVE                            CFF007
     C                     MOVE HETRU     HETR                            CFF007
     C                     MOVE BLUPU     BLUP                            CFF007
     C                     MOVE *BLANKS   REPI                            CFF007
     C*                                                                   CFF007
     C** IF Private Banking module is installed                           CFF007
     C** AND Cutomer Code is not zero                                     CFF007
     C** AND system is not on input cycle                                 CFF007
     C*                                                                   CFF007
     C           BGN4ST    IFEQ 'Y'                                       CFF007
     C********** CUSC      ANDNE*ZERO                                     CFF007              CSD027
     C           CUSC      ANDNE*BLANKS                                   CFF007              CSD027
     C           PHASED    ANDNE'A'                                       CFF007
     C*                                                                   CFF007
     C** Access Extended Client Details                                   CFF007
     C*                                                                   CFF007
     C                     MOVELCUSC      @KEY1  10 P                     CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   @RTCD                           CFF007
     C                     PARM '*KEY   ' @OPTN                           CFF007
     C                     PARM           @KEY1                           CFF007
     C                     PARM *BLANKS   @KYST   7                       CFF007
     C           SDCUST    PARM SDCUST    @DSLDY                          CFF007
     C*                                                                   CFF007
     C           @RTCD     IFEQ *BLANK                                    CFF007
     C*                                                                   CFF007
     C           BBPRBA    IFEQ 'Y'                                       CFF007
     C                     MOVE 'Y'       REPI                            CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     ELSE                                           CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD21        DBASE              *************CFF007
     C                     MOVE 'SDCUSTPD'DBFILE             * DBERR 021 *CFF007
     C                     MOVEL@KEY1     DBKEY              *************CFF007
     C                     MOVEL@OPTN     DBOPTN                          CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C** Write transactions record
     C*
     C                     MOVEASTAMP,1   TMST             Default Timestamp                  CPK015
     C                     WRITETRANSDF
     C/COPY WNCPYSRC,FF0350C006
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R WTRSET TO FORMAT AND WRITE TRANSACTION SETTLEMENT DETAILS
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           WTRSET    BEGSR
     C**
     C                     MOVE 'D'       RECI
     C*
     C**  Take the additive inverse of the transaction number
     C*
     C                     Z-SUBTNBRU     TNBR
     C*
     C**  Premiums paid
     C*
     C                     Z-ADDWPREM     PRMP
     C*
     C**  If Broker present, set up defaults
     C*
     C********** BOCOU     IFNE 0                                                             CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C*
     C**  Number of Exercise Contracts
     C*
     C           BPSCI     IFEQ 'N'
     C                     Z-ADDNOCOU     CCSB
     C                     ELSE
     C                     Z-ADD0         CCSB
     C                     END
     C*
     C                     MOVE BCPTW     BCPT
     C                     Z-ADDBCMCW     BCMC
     C                     Z-ADDBCMSW     BCMS
     C*
     C           TRTYU     IFEQ 'P'
     C                     Z-ADDBCGPW     BCHC
     C                     ELSE
     C                     Z-ADDBCGSW     BCHC
     C                     END
     C*
     C                     Z-ADDBSLTW     BSLT
     C                     MOVE BSLAW     BSLA
     C                     MOVE BSBRW     BSBR                            S01117
     C                     MOVE BFAOW     BFAO
     C                     MOVE BCPNW     BCPN
     C*                                                                   S01117
     C** Set up parms (search argument)                                   S01117
     C*                                                                   S01117
     C                     MOVE *BLANKS   FFBRCB                          S01117
     C*                                                                   S01117
     C                     MOVE BRCAU     FFBRCA                          S01117
     C**********           Z-ADDBOCOU     FFCBCD                          S01117              CSD027
     C                     MOVE BOCOU     FFCBCD                          S01117              CSD027
     C                     MOVE 'Y'       FFBRKI                          S01117
     C*                                                                   S01117
     C                     MOVE BSLAW     FFSETA                          S01117
     C                     MOVE BSBRW     FFSETB                          S01117
     C                     Z-ADDBSLTW     FFSETP                          S01117
     C                     MOVE ISCY      FFCCY                           S01117
     C*                                                                   S01117
      ** Get branch internal customer no. as it will be used in FFSETL    S01117
     C*                                                                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM FFBRCA    @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    @DSFDY                                       S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBRCHPD'DBFILE                          S01117
     C                     MOVEL@DSNB     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7        * DB ERROR 19 *S01117
     C                     Z-ADD19        DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C** Call standard subroutine to get the broker branch ID             S01117
     C** U6 must be set on                                                S01117
     C*                                                                   S01117
     C                     MOVE *INU6     SINU6   1                       S01117
     C                     MOVE '1'       *INU6                           S01117
     C                     EXSR FFSETL                                    S01117
     C                     MOVE SINU6     *INU6                           S01117
     C*                                                                   S01117
     C** Save result                                                      S01117
     C*                                                                   S01117
     C                     MOVE FFBRCB    BBID                            S01117
     C*                                                                   S01117
     C** If the settlement type is 00, use the branch code as the         S01117
     C**    broker branch ID                                              S01117
     C*                                                                   S01117
     C           BSLTW     IFEQ *ZERO                                     S01117
     C                     MOVE BRCAU     BBID                            S01117
     C                     END                                            S01117
      *                                                                                       245805
      **  If settlement type is 01 and nostro account does not                                245805
      **  exist in TABLETL.                                                                   245805
      *                                                                                       245805
     C           BSLTW     IFEQ 1                                                             245805
     C           FFNOSN    ANDEQ0                                                             245805
     C                     Z-ADD0         BSLT                                                245805
     C                     MOVEL*BLANK    BSLA                                                245805
     C                     MOVE BRCAU     BBID                                                245805
     C                     END                                                                245805
     C*
     C                     ELSE
     C*
     C**  If Broker not present, zeroise/blank defaults
     C*
     C                     Z-ADD0         CCSB
     C*
     C                     MOVE *BLANKS   BCPT
     C                     Z-ADD0         BCMC
     C                     Z-ADD0         BCMS
     C                     Z-ADD0         BCHC
     C                     Z-ADD0         BSLT
     C                     MOVE *BLANKS   BSLA
     C                     MOVE *BLANKS   BSBR                            S01117
     C                     MOVE *BLANKS   BBID                            S01117
     C                     MOVE *BLANKS   BFAO
     C                     MOVE *BLANKS   BCPN
     C*
     C                     END
     C*
     C**  If Customer present, set up defaults
     C*
     C********** CUSCU     IFNE 0                                                             CSD027
     C           CUSCU     IFNE *BLANKS                                                       CSD027
     C*
     C**  Number of Exercise Contracts
     C*
     C                     Z-ADDNOCOU     CCSC
     C*
     C                     MOVE CCPTW     CCPT
     C                     Z-ADDCCMCW     CCMC
     C                     Z-ADDCCMSW     CCMS
     C*
     C           TRTYU     IFEQ 'P'
     C                     Z-ADDCCGPW     CCHC
     C                     ELSE
     C                     Z-ADDCCGSW     CCHC
     C                     END
     C*
     C                     Z-ADDCSLTW     CSLT
     C                     MOVE CSLAW     CSLA
     C                     MOVE BRSCW     BRSC                            S01117
     C                     MOVE CFAOW     CFAO
     C                     MOVE CCPNW     CCPN
     C*                                                                   S01117
     C** Set up parms (search argument)                                   S01117
     C*                                                                   S01117
     C                     MOVE *BLANKS   FFBRCB                          S01117
     C*                                                                   S01117
     C                     MOVE BRCAU     FFBRCA                          S01117
     C**********           Z-ADDCUSCU     FFCBCD                          S01117              CSD027
     C                     MOVE CUSCU     FFCBCD                          S01117              CSD027
     C                     MOVE 'N'       FFBRKI                          S01117
     C*                                                                   S01117
     C                     MOVE CSLAW     FFSETA                          S01117
     C                     MOVE BRSCW     FFSETB                          S01117
     C                     Z-ADDCSLTW     FFSETP                          S01117
     C                     MOVE ISCY      FFCCY                           S01117
     C*                                                                   S01117
      ** Get branch internal customer no. as it will be used in FFSETL    S01117
     C*                                                                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM FFBRCA    @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    @DSFDY                                       S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBRCHPD'DBFILE                          S01117
     C                     MOVEL@DSNB     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7        * DB ERROR 20 *S01117
     C                     Z-ADD20        DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C** Call standard subroutine to get the customer branch ID           S01117
     C** U6 must be set on                                                S01117
     C*                                                                   S01117
     C                     MOVE *INU6     SINU6                           S01117
     C                     MOVE '1'       *INU6                           S01117
     C                     EXSR FFSETL                                    S01117
     C                     MOVE SINU6     *INU6                           S01117
     C*                                                                   S01117
     C** Save result                                                      S01117
     C*                                                                   S01117
     C                     MOVE FFBRCB    CBID                            S01117
     C*                                                                   S01117
     C** If the settlement type is 00, use the branch code as the         S01117
     C**    customer branch ID                                            S01117
     C*                                                                   S01117
     C           CSLTW     IFEQ *ZERO                                     S01117
     C                     MOVE BRCAU     CBID                            S01117
     C                     END                                            S01117
      *                                                                                       245805
      **  If settlement type is 01 and nostro account is does not                             245805
      **  exist in TABLETL, make sett type = '00' and                                         245805
      **  sett account = *blank.                                                              245805
      *                                                                                       245805
     C           CSLTW     IFEQ 1                                                             245805
     C           FFNOSN    ANDEQ0                                                             245805
     C                     Z-ADD0         CSLT                                                245805
     C                     MOVEL*BLANK    CSLA                                                245805
     C                     MOVE BRCAU     CBID                                                245805
     C                     END                                                                245805
     C*
     C                     ELSE
     C*
     C**  If Customer not present, zeroise/blank defaults
     C*
     C                     Z-ADD*ZERO     CCSC
     C*
     C                     MOVE *BLANKS   CCPT
     C                     Z-ADD0         CCMC
     C                     Z-ADD0         CCMS
     C                     Z-ADD0         CCHC
     C                     Z-ADD0         CSLT
     C                     MOVE *BLANKS   CSLA
     C                     MOVE *BLANKS   BRSC                            S01117
     C                     MOVE *BLANKS   CBID                            S01117
     C                     MOVE *BLANKS   CFAO
     C                     MOVE *BLANKS   CCPN
     C*
     C                     END
     C*
     C**  Set remaining fields to blanks/zeros
     C*
     C                     Z-ADD0         NCCP
     C                     Z-ADD0         BCMA
     C                     Z-ADD0         BCHA
     C                     Z-ADD0         BMAR
     C                     Z-ADD0         OCSB
     C                     Z-ADD0         OCDB
     C                     Z-ADD0         CCDB
     C                     Z-ADD0         CPSB
     C                     Z-ADD0         CPDB
     C                     Z-ADD0         BCHP
     C                     Z-ADD0         BCMP
     C*
     C                     Z-ADD0         CCMA
     C                     Z-ADD0         CCHA
     C                     Z-ADD0         CMAR
     C                     Z-ADD0         OCSC
     C                     Z-ADD0         OCDC
     C                     Z-ADD0         CCDC
     C                     Z-ADD0         CPSC
     C                     Z-ADD0         CPDC
     C                     Z-ADD0         CCHP
     C                     Z-ADD0         CCMP
     C/COPY WNCPYSRC,FF0350C007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           BGN4ST    ANDEQ'Y'                                       CFF007
     C                     MOVE 'N'       CMCB                            CFF007
     C                     MOVE 'N'       CHCB                            CFF007
     C                     MOVE 'N'       CMCC                            CFF007
     C                     MOVE 'N'       CHCC                            CFF007
     C                     ENDIF                                          CFF007
     C*
     C** Write settlement details
     C*
     C                     MOVEASTAMP,1   TMST             Default Timestamp                  CPK015
     C                     WRITETRSETDF
     C*
     C                     ENDSR
     C**
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R UTRANS TO UPDATE THE TRADE ON LF/CLOST6 NOW BEING EXERCISED
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           UTRANS    BEGSR
     C**
     C*
     C** First save values that are required in subsequent calculations
     C*
     C                     Z-ADDNOCOU     NOCOUS
     C                     Z-ADDNOBOU     NOBOUS
     C*
     C**   Update Relevant fields on LF/TRANS Trade record
     C*
     C                     Z-ADD0         NOCOU
     C                     Z-ADD0         NOBOU
     C                     MOVE 'N'       FCINU
     C*
     C********** BOCOU     IFNE 0                                                             CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C                     MOVE 'N'       FBINU
     C                     END
     C*
     C                     EXCPTETRANS
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R UTRSET TO UPDATE THE TRADE SETTLEMENT DETAILS OF THE TRADE
     C**            ON LF/TRANS6 NOW BEING EXERCISED
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           UTRSET    BEGSR
     C**
     C*
     C**   Access LF/TRSET Trade record
     C*
     C           TNBRU     CHAINTRSET                79
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRSET'   DBFILE           ***************
     C                     Z-ADD4         DBASE            * DB ERROR 04 *
     C                     MOVELTNBRU     DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C**   Add Number of contracts being exercised
     C*
     C********** BOCOU     IFNE 0                                                             CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C                     ADD  NOBOUS    OCSBU
     C                     END
     C*
     C********** CUSCU     IFNE 0                                                             CSD027
     C           CUSCU     IFNE *BLANKS                                                       CSD027
     C                     ADD  NOCOUS    OCSCU
     C                     END
     C*
     C**   Reset Margins
     C*
     C** First save values of margins for use in positions file updates
     C*
     C                     Z-ADDBMARU     BMARUS
     C                     Z-ADDCMARU     CMARUS
     C*
     C           BMARU     IFGT 0
     C                     Z-ADD0         BMARU
     C                     END
     C*
     C           CMARU     IFGT 0
     C                     Z-ADD0         CMARU
     C                     END
     C*
     C**   Update record
     C*
     C                     EXCPTETRSET
     C*
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R WCLSTD TO WRITE A CLOSE OUT SET DETAIL RECORD
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           WCLSTD    BEGSR
     C**
     C*
     C** Access NACON for next available Close out no.
     C** Update NACON with next available Close out no. + 1
     C** ( NB This value of CLON also used on CLOSTT )
     C*
     C           *NAMVAR   DEFN           NACON
     C           *LOCK     IN   *NAMVAR
     C                     Z-ADDCLONO     CLON
     C                     ADD  1         CLONO
     C                     OUT  *NAMVAR
     C/SPACE 1
     C*
     C** Add a new close out set detail record
     C*
     C*
     C**   Set up fields for output
     C*
     C                     MOVE 'D'       RECI
     C*
     C**   Fields from trade currently being exercised
     C*
     C***********          Z-ADDBRCDU     BRCD                            S01117
     C                     MOVE BRCAU     BRCA                            S01117
     C**********           Z-ADDCUSCU     CUSC                                                CSD027
     C**********           Z-ADDBOCOU     BOCO                                                CSD027
     C                     MOVE BOCOU     BOCO                                                CSD027
     C                     MOVE CUSCU     CUSC                                                CSD027
     C                     MOVE BOKCU     BOKC
     C                     MOVE ISTTU     ISTT
     C                     Z-ADDYRNOU     YRNO
     C                     Z-ADDMTHNU     MTHN
     C                     MOVE PCALU     PCAL
     C                     Z-ADDSTRPU     STRP
     C*
     C**   Realised Profit/Loss from standard routine
     C*
     C           TRTYU     IFEQ 'P'
     C                     Z-ADDWPOL      COPL
     C                     ELSE
     C                     Z-SUBWPOL      COPL
     C                     END
     C*
     C**   ( Instrument Currency from LF/INTYP )
     C*
     C**   Date fields are output differently for OTC's and Market Inst's
     C*
     C           PMRKT     IFEQ *BLANKS
     C**   - O.T.C.  ( Run Date from PF/TABTB10 )
     C                     Z-ADDRUND      CLOD
     C                     Z-ADDRUND      LCD
     C                     ELSE
     C**   - Market instrument  ( Business Date from LF/MKCTL )
     C                     Z-ADDBUSD      CLOD
     C                     Z-ADDBUSD      LCD
     C                     END
     C*
     C                     MOVE 'E'       CLOT
     C                     MOVE 'N'       CORI
     C                     MOVE 'Y'       SHPI
     C                     MOVE 'N'       ECPI
     C                     MOVE 'I'       CHTP
     C                     Z-ADD0         TNLU
     C/COPY WNCPYSRC,FF0350C008
     C*                                                                   CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C*                                                                   CFF007
     C** Key access fields for LF/DEFLT                                   CFF007
     C*                                                                   CFF007
     C           KDEFLT    KLIST                                          CFF007
     C**********           KFLD           KCBCD   60                      CFF007              CSD027
     C                     KFLD           KCBCD   6                       CFF007              CSD027
     C                     KFLD           KMRKT   2                       CFF007
     C                     KFLD           KISTC   3                       CFF007
     C*                                                                   CFF007
     C                     MOVE *BLANKS   STTA                            CFF007
     C                     MOVE *BLANKS   STTB                            CFF007
     C*                                                                   CFF007
     C********** CUSC      IFNE *ZEROS                                    CFF007              CSD027
     C           CUSC      IFNE *BLANKS                                   CFF007              CSD027
     C*                                                                   CFF007
     C** Access LF/DEFLT via key list KDEFLT                              CFF007
     C*                                                                   CFF007
     C**********           Z-ADDCUSC      KCBCD                           CFF007              CSD027
     C                     MOVE CUSC      KCBCD                           CFF007              CSD027
     C                     MOVE PMRKT     KMRKT                           CFF007
     C                     MOVE ISTT      KISTC                           CFF007
     C*                                                                   CFF007
     C           KDEFLT    CHAINDEFLT                5152                 CFF007
     C*                                                                   CFF007
     C                     MOVE *BLANKS   WSETP   2                       CFF007
     C**********           MOVE *BLANKS   WSTTA  12                                    CFF007 CGL029
     C                     MOVE *BLANKS   WSTTA  18                                           CGL029
     C                     MOVE *BLANKS   WSEBR   3                       CFF007
     C                     MOVE *BLANKS   WSECY   3                       CFF007
     C                     MOVE *BLANKS   WSTTA1  9                       CFF007
     C**********           MOVE *BLANKS   WSTTA2  6                                    CFF007 CGL029
     C                     MOVE *BLANKS   WSTTA2 12                                           CGL029
     C*                                                                   CFF007
     C           *IN52     IFEQ *ON                                       CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD14        DBASE            ************   CFF007
     C                     MOVE 'DEFLT   'DBFILE           *DB ERR 014*   CFF007
     C                     MOVELKCBCD     DBKEY            ************   CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C** DEFLT record not found                                           CFF007
     C** OR record found AND settlement type is zero                      CFF007
     C*                                                                   CFF007
     C           *IN51     IFEQ *ON                                       CFF007
     C           *IN51     OREQ *OFF                                      CFF007
     C           SETP      ANDEQ*ZEROS                                    CFF007
     C*                                                                   CFF007
     C** Access Futures and Options Client Details                        CFF007
     C*                                                                   CFF007
     C                     MOVE CUSC      @CUST   6                       CFF007
     C                     CALL 'AOFOCSR0'                                CFF007
     C                     PARM *BLANKS   @RTCD                           CFF007
     C                     PARM '*KEY   ' @OPTN                           CFF007
     C                     PARM @CUST     @CUST                           CFF007
     C           SDFOCS    PARM SDFOCS    @DSFDY                          CFF007
     C*                                                                   CFF007
     C           @RTCD     IFEQ *BLANKS                                   CFF007
     C                     MOVE BHSTTY    WSETP                           CFF007
     C                     MOVE BHSMAC    WSTTA                           CFF007
     C                     MOVE BHSEBR    WSEBR                           CFF007
     C                     MOVE BHCYCD    WSECY                           CFF007
     C*                                                                   CFF007
     C                     ELSE                                           CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD15        DBASE            ************   CFF007
     C                     MOVE 'SDFOCSPD'DBFILE           *DB ERR 015*   CFF007
     C                     MOVEL@CUST     DBKEY            ************   CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C** DEFLT record found AND settlement type is not zero               CFF007
     C*                                                                   CFF007
     C                     ELSE                                           CFF007
     C                     MOVE SETP      WSETP                           CFF007
     C                     MOVE SETA      WSTTA                           CFF007
     C                     MOVE SEBR      WSEBR                           CFF007
     C                     MOVE ISCY      WSECY                           CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C** 01 - Nostro by Telex                                             CFF007
     C** 07 - Nostro by CHIPS                                             CFF007
     C** 08 - Nostro by SWIFT                                             CFF007
     C*                                                                   CFF007
     C                     SELEC                                          CFF007
     C*                                                                   CFF007
     C           WSETP     WHEQ '01'                                      CFF007
     C           WSETP     OREQ '07'                                      CFF007
     C           WSETP     OREQ '08'                                      CFF007
     C*                                                                   CFF007
     C** Access Nostro Details                                            CFF007
     C*                                                                   CFF007
     C                     MOVELWSTTA     WNOSN   2                       CFF007
     C                     CALL 'AONOSTR0'                                CFF007
     C                     PARM *BLANKS   @RTCD                           CFF007
     C                     PARM '*KEY   ' @OPTN                           CFF007
     C                     PARM *BLANKS   @CUST                           CFF007
     C                     PARM ISCY      @CYCD   3                       CFF007
     C**********           PARM *BLANKS   @ACCD   4                                    CFF007 CGL029
     C                     PARM *BLANKS   @ACCD  10                                           CGL029
     C                     PARM *BLANKS   @ACSN   2                       CFF007
     C                     PARM WNOSN     @NONB   2                       CFF007
     C                     PARM *BLANKS   @BRCD   3                       CFF007
     C                     PARM *BLANKS   @CSSN  10                       CFF007
     C                     PARM *BLANKS   @PNOI   1                       CFF007
     C           SDNOST    PARM SDNOST    @DSFDY                          CFF007
     C*                                                                   CFF007
     C           @RTCD     IFEQ *BLANK                                    CFF007
     C                     MOVELA7CUST    WSTTA1                          CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C                     MOVELA7ACCD    WSTTA2                          CFF007
     C                     MOVE A7ACSN    WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE A7BRCD    WSEBR                           CFF007
     C*                                                                   CFF007
     C                     ELSE                                           CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD16        DBASE            ************   CFF007
     C                     MOVE 'SDNOSTPD'DBFILE           *DB ERR 016*   CFF007
     C                     MOVEL@CYCD     DBKEY            ************   CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C** 04 - Counter party's prime retail account                        CFF007
     C** 15 - Counter party designated account                            CFF007
     C*                                                                   CFF007
     C           WSETP     WHEQ '04'                                      CFF007
     C           WSETP     OREQ '15'                                      CFF007
     C                     MOVELCUSC      WSTTA1                          CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C           WSETP     IFEQ '04'                                      CFF007
     C                     MOVELCADC      WSTTA2                          CFF007
     C                     ELSE                                           CFF007
     C                     MOVELDFCA      WSTTA2                          CFF007
     C                     ENDIF                                          CFF007
     C                     MOVE '01'      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C*                                                                   CFF007
     C** Access Extended Client Details                                   CFF007
     C*                                                                   CFF007
     C                     MOVELCUSC      @KEY1  10 P                     CFF007
     C                     CALL 'AOCUSTR1'                                CFF007
     C                     PARM *BLANKS   @RTCD                           CFF007
     C                     PARM '*KEY   ' @OPTN                           CFF007
     C                     PARM           @KEY1                           CFF007
     C                     PARM *BLANKS   @KYST   7                       CFF007
     C           SDCUST    PARM SDCUST    @DSLDY                          CFF007
     C*                                                                   CFF007
     C           @RTCD     IFEQ *BLANK                                    CFF007
     C                     MOVE BBBRCD    WSEBR                           CFF007
     C*                                                                   CFF007
     C                     ELSE                                           CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD17        DBASE            ************   CFF007
     C                     MOVE 'SDCUSTPD'DBFILE           *DB ERR 017*   CFF007
     C                     MOVEL@KEY1     DBKEY            ************   CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C** 05 - Any account                                                 CFF007
     C*                                                                   CFF007
     C           WSETP     WHEQ '05'                                      CFF007
     C                     MOVELWSTTA     WSTTA2                          CFF007
     C                     MOVE WSTTA     WSTTA1                          CFF007
     C                     MOVELISCY      WSTTA1                          CFF007
     C                     MOVELWSTTA2    STTA                            CFF007
     C                     MOVE WSTTA1    STTA                            CFF007
     C*                                                                   CFF007
     C** 06 - Suspense account                                            CFF007
     C*                                                                   CFF007
     C           WSETP     WHEQ '06'                                      CFF007
     C                     MOVELBICN      WSTTA1                          CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C                     MOVELCOMS      WSTTA2                          CFF007
     C                     MOVE '01'      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE A8BRCD    WSEBR                           CFF007
     C*                                                                   CFF007
     C** 14 - Any current account                                         CFF007
     C*                                                                   CFF007
     C           WSETP     WHEQ '14'                                      CFF007
     C                     MOVELWSTTA     KACNO  100                      CFF007
     C*                                                                   CFF007
     C** Access Account Numbers File                                      CFF007
     C*                                                                   CFF007
     C           KACNO     CHAINACNUM                5152                 CFF007
     C*                                                                   CFF007
     C           *IN52     IFEQ *ON                                       CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD18        DBASE            ************   CFF007
     C                     MOVE 'ACNUM   'DBFILE           *DB ERR 018*   CFF007
     C                     MOVELKACNO     DBKEY            ************   CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C           *IN51     IFEQ *OFF                                      CFF007
     C                     MOVELCNUM      WSTTA1                          CFF007
     C                     MOVE CCY       WSTTA1                          CFF007
     C                     MOVELACOD      WSTTA2                          CFF007
     C                     MOVE ACSQ      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE BRCA      WSEBR                           CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     ENDSL                                          CFF007
     C*                                                                   CFF007
     C           WSETP     IFNE *BLANKS                                   CFF007
     C           STTA      ANDEQ*BLANKS                                   CFF007
     C                     MOVELBICN      WSTTA1                          CFF007
     C                     MOVE ISCY      WSTTA1                          CFF007
     C                     MOVELCOMS      WSTTA2                          CFF007
     C                     MOVE '01'      WSTTA2                          CFF007
     C                     MOVELWSTTA1    STTA                            CFF007
     C                     MOVE WSTTA2    STTA                            CFF007
     C                     MOVE A8BRCD    WSEBR                           CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C           BGPFMG    IFEQ 'Y'                                       CFF007
     C           FCPORS    ANDNE'B'                                       CFF007
     C           BGN4ST    OREQ 'Y'                                       CFF007
     C*                                                                   CFF007
     C** If the display field is equal to the "reference attached to      CFF007
     C** 9997 portfolio"                                                  CFF007
     C*                                                                   CFF007
     C           PTFRU     IFEQ FCR997                                    CFF007
     C           PTFRU     ANDNE*BLANKS                                   CFF007
     C           BGN4ST    ANDNE'Y'                                       CFF007
     C                     MOVEL'9997'    PTFR                            CFF007
     C                     ELSE                                           CFF007
     C                     MOVELPTFRU     PTFR                            CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C           STTA      IFNE *BLANKS                                   CFF007
     C           STTB      ANDEQ*BLANKS                                   CFF007
     C                     MOVE WSEBR     STTB                            CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     MOVE 'D'       RECI                            CFF007
     C                     MOVE 'I'       CHTP                            CFF007
     C                     Z-ADD0         TNLU                            CFF007
     C*                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     MOVE *BLANKS   REPI                            CFF007
     C*                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
     C**   Write record to LF/CLOST
     C*
     C                     WRITECLOSTDF
     C/COPY WNCPYSRC,FF0350C009
     C*
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R WCLSTT TO WRITE TWO CLOSE OUT SET TRANSACTION RECORDS
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           WCLSTT    BEGSR
     C**
     C*
     C**   Set up fields for output to both records
     C*
     C                     MOVE 'D'       RECI
     C*
     C**  ( Value of CLON set up for write to CLOSTD )
     C*
     C                     Z-ADDNOCOUS    NCCL
     C                     MOVE *BLANK    FCLI
     C*
     C**  Set up fields for output to EXERCISE transaction record only
     C*
     C                     Z-SUBTNBRU     TNBR
     C                     Z-ADDMDAT      TRSD
     C                     MOVE 'E'       TRTY
     C*
     C**   Write Exercise record to PF/CLOSTT
     C*
     C                     WRITECLOSTTF
     C*
     C**  Set up fields for output to TRADE being exercised record only
     C*
     C                     Z-ADDTNBRU     TNBR
     C                     Z-ADDTRSDU     TRSD
     C                     MOVE TRTYU     TRTY
     C*
     C**   Write Trade record to PF/CLOSTT
     C*
     C                     WRITECLOSTTF
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R RDTABR TO ACCESS BRANCH DETAILS OF THE TRADE
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS SR DBERR
     C**
     C********************************************************************
     C*
     C           RDTABR    BEGSR
     C**
     C***********          MOVE *BLANKS   ZTABKY                          S01117
     C***********                                                         S01117
     C***********          MOVEL'10'      ZTABKY 12                       S01117
     C***********          MOVE BRCDU     ZTABKY                          S01117
     C***********ZTABKY    CHAINTABFF                79                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM BRCAU     @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    @DSFDY                                       S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*
     C** DB Error Handler
     C*
     C************IN79     IFEQ '1'                                       S01117
     C***********RECI      ORNE 'D'                                       S01117
     C***********          MOVEL'TABFF'   DBFILE           ***************S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBRCHPD'DBFILE           ***************S01117
     C                     Z-ADD5         DBASE            * DB ERROR 05 *
     C***********          MOVELZTABKY    DBKEY            ***************S01117
     C                     MOVEL@DSNB     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*                                                                   S01117
     C                     END                                            S01117
     C**
     C                     ENDSR
     C*
     C*****************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R UPOSTN TO UPDATE POSITIONS FILES
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS SR DBERR
     C**
     C********************************************************************
     C*
     C           UPOSTN    BEGSR
     C**
     C*
     C** If the trade involves a customer, access positions file
     C**  for customer instrument position - no record => db-error
     C*
     C********** CUSCU     IFNE 0                                                             CSD027
     C           CUSCU     IFNE *BLANKS                                                       CSD027
     C*
     C           KPSTNC    CHAINPOSTNC               79
     C*
     C           *IN79     IFEQ '1'
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'POSTC'   DBFILE
     C*
     C***********          Z-ADDBRCDU     BRCDK2                          S01117
     C                     MOVE BRCAU     BRCAK2                          S01117
     C**********           Z-ADDCUSCU     CUSCK2                                              CSD027
     C                     MOVE CUSCU     CUSCK2                                              CSD027
     C                     MOVE ISTT      ISTTK2
     C                     Z-ADDYRNO      YRNOK2
     C                     Z-ADDMTHN      MTHNK2
     C                     MOVE PCAL      PCALK2
     C                     Z-ADDSTRP      STRPK2
     C                     MOVELXPSTNC    DBKEY
     C*                                                    ***************
     C                     Z-ADD6         DBASE            * DB ERROR 06 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C*
     C** If this is a customer trade with a broker
     C** Apply updates due to exercise created
     C*
     C********** BOCOU     IFNE 0                                                             CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C*
     C**    Update current position and current total value and
     C**    Adjust Realised Profit/Loss today with Exercise Realised
     C**    Profit/Loss
     C*
     C**    For a purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     SUB  NOCOUS    LOPC
     C                     SUB  WTNVL     CUTV
     C                     ADD  WPOL      RPLD
     C*
     C           CMARUS    IFEQ 0
     C                     SUB  NOCOUS    LOCO
     C                     END
     C*
     C                     ELSE
     C*
     C**    For a Sale
     C*
     C                     SUB  NOCOUS    SOPC
     C                     ADD  WTNVL     CUTV
     C                     SUB  WPOL      RPLD
     C*
     C           CMARUS    IFEQ 0
     C                     SUB  NOCOUS    SOCO
     C                     END
     C*
     C*  End purchase sale
     C                     END
     C*  End broker involvement
     C                     END
     C*
     C** If this is a customer trade with a book
     C*
     C********** BOCOU     IFEQ 0                                                             CSD027
     C           BOCOU     IFEQ *BLANKS                                                       CSD027
     C*
     C**    Update current position and current total value and
     C**    Adjust Realised Profit/Loss today with Exercise Realised
     C**    Profit/Loss
     C*
     C**    For a purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     SUB  NOCOUS    SOPC
     C                     ADD  WTNVL     CUTV
     C                     SUB  WPOL      RPLD
     C*
     C           CMARUS    IFEQ 0
     C                     SUB  NOCOUS    SOCO
     C                     END
     C*
     C                     ELSE
     C*
     C**    For a Sale
     C*
     C                     SUB  NOCOUS    LOPC
     C                     SUB  WTNVL     CUTV
     C                     ADD  WPOL      RPLD
     C*
     C           CMARUS    IFEQ 0
     C                     SUB  NOCOUS    LOCO
     C                     END
     C*
     C*  End purchase sale
     C                     END
     C* End no broker
     C                     END
     C*
     C** Update Total Margin Override
     C*
     C           CMARUS    IFGT 0
     C                     SUB  CMARUS    TOTM
     C                     END
     C*
     C** Update positions file
     C*
     C                     EXCPTEPSTNC
     C* End customer
     C                     END
     C*
     C/SPACE 3
     C*
     C** If the trade involves a broker, access positions file
     C**  for customer/broker - no record => db-error
     C*
     C********** BOCOU     IFNE 0                                                             CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C*
     C           KPSTNB    CHAINPOSTNC               79
     C*
     C           *IN79     IFEQ '1'
     C*
     C***********          Z-ADDBRCDU     BRCDK3                          S01117
     C                     MOVE BRCAU     BRCAK3                          S01117
     C**********           Z-ADDBOCOU     BOCOK3                                              CSD027
     C                     MOVE BOCOU     BOCOK3                                              CSD027
     C                     MOVE ISTT      ISTTK3
     C                     Z-ADDYRNO      YRNOK3
     C                     Z-ADDMTHN      MTHNK3
     C                     MOVE PCAL      PCALK3
     C                     Z-ADDSTRP      STRPK3
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVELXPSTNB    DBKEY
     C*
     C                     MOVE 'POSTC'   DBFILE           ***************
     C                     Z-ADD7         DBASE            * DB ERROR 07 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C*
     C**    Update current position and current total value and
     C**    Adjust Realised Profit/Loss today with Exercise Realised
     C**    Profit/Loss
     C*
     C**    For a purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     SUB  NOCOUS    SOPC
     C                     ADD  WTNVL     CUTV
     C                     SUB  WPOL      RPLD
     C*
     C           BMARUS    IFEQ 0
     C                     SUB  NOCOUS    SOCO
     C                     END
     C*
     C                     ELSE
     C*
     C**    For a sale
     C*
     C                     SUB  NOCOUS    LOPC
     C                     SUB  WTNVL     CUTV
     C                     ADD  WPOL      RPLD
     C*
     C           BMARUS    IFEQ 0
     C                     SUB  NOCOUS    LOCO
     C                     END
     C*
     C*  End purchase sale
     C                     END
     C*
     C** Update Total Margin Override
     C*
     C           BMARUS    IFGT 0
     C                     SUB  BMARUS    TOTM
     C                     END
     C*
     C** Update positions file
     C*
     C                     EXCPTEPSTNC
     C*  End broker
     C                     END
     C/SPACE 3
     C*
     C** If the trade is a book trade,involving either a book and a broker
     C**  or a book and a customer, access POSTNK
     C*
     C********** BOCOU     IFEQ 0                                                             CSD027
     C********** CUSCU     OREQ 0                                                             CSD027
     C           BOCOU     IFEQ *BLANKS                                                       CSD027
     C           CUSCU     OREQ *BLANKS                                                       CSD027
     C*
     C           KPSTNK    CHAINPOSTNK               79
     C*
     C           *IN79     IFEQ '1'
     C*
     C***********          Z-ADDBRCDU     BRCDK4                          S01117
     C                     MOVE BRCAU     BRCAK4                          S01117
     C                     MOVE BOKCU     BOKCK4
     C                     MOVE ISTT      ISTTK4
     C                     Z-ADDYRNO      YRNOK4
     C                     Z-ADDMTHN      MTHNK4
     C                     MOVE PCAL      PCALK4
     C                     Z-ADDSTRP      STRPK4
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVELXPSTNK    DBKEY
     C*
     C                     MOVE 'POSTK'   DBFILE           ***************
     C                     Z-ADD8         DBASE            * DB ERROR 08 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C*
     C**    Update current position and current total value and
     C**    Adjust Realised Profit/Loss today with Exercise Realised
     C**    Profit/Loss
     C*
     C**    For a Purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     SUB  NOCOUS    LOPC
     C                     SUB  WTNVL     CUTV
     C                     ADD  WPOL      RPLD
     C*
     C                     ELSE
     C*
     C**    For a sale
     C*
     C                     SUB  NOCOUS    SOPC
     C                     ADD  WTNVL     CUTV
     C                     SUB  WPOL      RPLD
     C*  End purchase sale
     C                     END
     C*
     C** Update positions file
     C*
     C                     EXCPTEPSTNK
     C*  End book
     C                     END
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R UTRANA TO UPDATE TRANSACTIONS AUDIT FILE
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS SR DBERR
     C**
     C********************************************************************
     C*
     C           UTRANA    BEGSR
     C*
     C** Set lower limits using relative record number and
     C** Access audit file to increment file totals
     C*
     C           1         SETLLTRANSA
     C                     READ TRANSA                   79
     C*
     C           *IN79     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRANS'   DBFILE
     C                     MOVEL'TRANSA'  DBKEY            ***************
     C                     Z-ADD9         DBASE            * DB ERROR 09 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C*
     C** Increment number of records and number of inserts
     C*
     C                     ADD  1         NORE
     C                     ADD  1         NINS
     C*
     C                     EXCPTETRANA
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R RDMEMO TO ACCESS LF/MEMOSM - SHADOW BALANCES
     C**
     C** CALLED FROM SR UCPRPL, SR UBPRPL
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           RDMEMO    BEGSR
     C**
     C                     MOVE 'Y'       MEXIST  1
     C*
     C           KMEMSM    CHAINMEMOSM               79
     C*
     C           *IN79     IFEQ '1'
     C                     MOVE 'N'       MEXIST
     C                     END
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R UPMEMO TO UPDATE/WRITE LF/MEMOSM - SHADOW BALANCES
     C**
     C** CALLED FROM SR UCPRPL, SR UBPRPL
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           UPMEMO    BEGSR
     C**
     C           MEXIST    IFEQ 'Y'
     C                     EXCPTEMEMOS
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE FFBRCB    BRCA                            S01117
     C                     MOVE FFCNUM    CNUM
     C                     MOVE ISCYU     CCY
     C                     MOVE FFACOD    ACOD
     C                     MOVE FFACSQ    ACSQ
     C                     WRITEMEMOSMEF
     C                     END
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R RDPRON TO ACCESS LF/PRONOM - PROJECTED NOSTRO BALANCE
     C**
     C** CALLED FROM SR UCPRPL, SR UBPRPL
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           RDPRON    BEGSR
     C**
     C                     MOVE 'Y'       PEXIST  1
     C*
     C           KPRONM    CHAINPRONOM               79
     C*
     C           *IN79     IFEQ '1'
     C                     MOVE 'N'       PEXIST
     C                     END
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R UPPRON TO UPDATE/WRITE LF/PRONOM - PROJECTED NOSTRO
     C**                                         BALANCES
     C** CALLED FROM SR UCPRPL, SR UBPRPL
     C**
     C** CALLS NONE.
     C**
     C********************************************************************
     C*
     C           UPPRON    BEGSR
     C**
     C           PEXIST    IFEQ 'Y'
     C                     EXCPTEPRONO
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE ISCYU     CCY
     C                     MOVE FFNOSN    NOSN
     C                     WRITEPRONOMEF
     C                     END
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************S01240
     C**                                                                 *S01240
     C**   WACMVD SR. -  Write record to PF/FFACMVD                      *S01240
     C**   ~~~~~~~~~~                                                    *S01240
     C**      Called From                  Calls                         *S01240
     C**       SR. UCPRPL                                                *S01240
     C**       SR. UBPRPL                                                *S01240
     C**                                                                 *S01240
     C********************************************************************S01240
     C**                                                                  S01240
     C           WACMVD    BEGSR                           ** WACMVD SR **S01240
     C**                                                                  S01240
     C**   Set up fields for output to PF/FFACMVD                         S01240
     C**                                                                  S01240
     C**   Branch Code                                                    S01240
     C*************        MOVE *BLANK    BRCA                      S01240FO0017
     C                     MOVE FFBRCB    BRCA                            FO0017
     C**                                                                  S01240
     C**   Customer Number                                                S01240
     C**********           Z-ADDFFCNUM    CUSN                            S01240              CSD027
     C                     MOVE FFCNUM    CUSN                            S01240              CSD027
     C**                                                                  S01240
     C**   Currency Code                                                  S01240
     C                     MOVE FFCCY     CCYD                            S01240
     C**                                                                  S01240
     C**   Account Code                                                   S01240
     C                     Z-ADDFFACOD    ACDE                            S01240
     C**                                                                  S01240
     C**   Account Sequence                                               S01240
     C                     Z-ADDFFACSQ    ASNC                            S01240
     C**                                                                  S01240
     C**   Posting Date                                                   S01240
     C                     Z-ADDRUND      PTDT                            S01240
     C**                                                                  S01240
     C**   Value Date                                                     S01240
     C                     Z-ADDRUND      VUDT                            S01240
     C**                                                                  S01240
     C**   Transaction Type                                               S01240
     C                     MOVE TRTYU     TRYP                            S01240
     C**                                                                  S01240
     C**   Narrative Code                                                 S01240
     C                     Z-ADD0         NRTC                            S01240
     C**                                                                  S01240
     C**   Narrative Description                                          S01240
     C                     MOVELISTN      NRTD                            S01240
     C**                                                                  S01240
     C**   Transaction Number                                             S01240
     C                     MOVE TNBRU     TNMR                            S01240
     C**                                                                  S01240
     C**   Cheque Number                                                  S01240
     C                     Z-ADD*ZERO     CQNR                            S01240
     C**                                                                  S01240
     C**   Movement Amount = change in Ledger Balance/Projected           S01240
     C**                     Nostro Balance                               S01240
     C           MPIND     IFEQ 'M'                                       S01240
     C           LDBL      SUB  WLDBL     WMVAM  130                      S01240
     C                     Z-ADDWMVAM     MVAM                            S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C           MPIND     IFEQ 'P'                                       S01240
     C           PNBL      SUB  WPNBL     WMVAM                           S01240
     C                     Z-ADDWMVAM     MVAM                            S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C           MVAM      IFNE *ZERO                                     S01240
     C**                                                                  S01240
     C**   Debit or Credit                                                S01240
     C           MPIND     IFEQ 'M'                                       S01240
     C           LDBL      IFGE WLDBL                                     S01240
     C                     Z-ADD0         DORC                            S01240
     C                     ELSE                                           S01240
     C                     Z-SUBMVAM      MVAM                            S01240
     C                     Z-ADD1         DORC                            S01240
     C                     END                                            S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C           MPIND     IFEQ 'P'                                       S01240
     C           PNBL      IFGE WPNBL                                     S01240
     C                     Z-ADD0         DORC                            S01240
     C                     ELSE                                           S01240
     C                     Z-SUBMVAM      MVAM                            S01240
     C                     Z-ADD1         DORC                            S01240
     C                     END                                            S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C**  Write record to PF/FFACMVD                                      S01240
     C                     WRITEFFACMVDF                                  S01240
     C**                                                                  S01240
     C                     END                                            S01240
     C**                                                                  S01240
     C                     ENDSR                                          S01240
     C**                                                                  S01240
     C********************************************************************S01240
     C/EJECT                                                              S01240
     C/COPY ZSRSRC,FFSETLZ4
      /EJECT
     C********************************************************************
     C**
     C** S/R UCPRPL TO DETERMINE IF MEMOS/PRONO UPDATE IS REQUIRED
     C**            AND TO SHADOW POST / UPDATE NOSTRO BALANCES FOR
     C**            CUSTOMER IF REQUIRED
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS SR FFSETL, SR RDMEMO, SR UPMEMO, SR RDPRON, SR UPPRON
     C**       SR WACMVD                                                  S01240
     C**
     C********************************************************************
     C*
     C           UCPRPL    BEGSR
     C**
     C*
     C** Set up parms for FFSETL (search argument) for Customer
     C*
     C***********          Z-ADDBRCDU     FFBRCD                          S01117
     C                     MOVE BRCAU     FFBRCA                          S01117
     C**********           Z-ADDCUSCU     FFCBCD                                              CSD027
     C                     MOVE CUSCU     FFCBCD                                              CSD027
     C                     MOVE 'N'       FFBRKI
     C                     MOVE ISCYU     FFCCY
     C                     MOVE CSLTW     FFSETP
     C                     MOVE CSLAW     FFSETA
     C                     MOVE BRSCW     FFSETB                          S01117
     C*
     C***********MBIN      IFEQ 'Y'                                       S01117
     C***********          Z-ADDNSACS     FFDASQ                          S01117
     C***********          ELSE                                           S01117
     C***********          MOVE 01        FFDASQ                          S01117
     C***********          END                                            S01117
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFSETL
     C/SPACE 5
     C*
     C** If settled across a retail account
     C*
     C           FFMIND    IFEQ 'Y'
     C*
     C** Access Retail Account Shadow Balance (LF/MEMOSM)
     C*
     C                     EXSR RDMEMO
     C*
     C** Reset balance fields if record does not exist
     C*
     C           MEXIST    IFEQ 'N'
     C                     MOVE *ZERO     LDBL
     C                     MOVE *ZERO     CLBL
     C                     END
     C**                                                                  S01240
     C** Store Ledger Balance in a work field for use in SR. WACMVD       S01240
     C                     Z-ADDLDBL      WLDBL  150                      S01240
     C*
     C** Update ledger balance and cleared balance with premiums & RL. P/L
     C** due to exercise creation
     C*
     C** Broker involved?
     C*  Yes
     C********** BOCOU     IFNE *ZERO                                                         CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C*
     C** Apply premiums if paid at end
     C*
     C**
     C           PUPF      IFEQ 'N'
     C*
     C** Purchase
     C*
     C***
     C           TRTYU     IFEQ 'P'
     C                     ADD  WPREM     LDBL
     C                     ADD  WPREM     CLBL
     C** Sale
     C                     ELSE
     C                     SUB  WPREM     LDBL
     C                     SUB  WPREM     CLBL
     C                     END
     C***
     C                     END
     C**
     C*
     C** Apply exercise Realised P & L
     C*
     C** Purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     SUB  WPOL      LDBL
     C                     SUB  WPOL      CLBL
     C** Sale
     C                     ELSE
     C                     ADD  WPOL      LDBL
     C                     ADD  WPOL      CLBL
     C                     END
     C*
     C** Broker involved?
     C*  No
     C                     ELSE
     C*
     C** Apply premiums if paid at end
     C*
     C**
     C           PUPF      IFEQ 'N'
     C*
     C** Purchase
     C*
     C***
     C           TRTYU     IFEQ 'P'
     C                     SUB  WPREM     LDBL
     C                     SUB  WPREM     CLBL
     C** Sale
     C                     ELSE
     C                     ADD  WPREM     LDBL
     C                     ADD  WPREM     CLBL
     C                     END
     C***
     C                     END
     C**
     C*
     C** Apply exercise Realised P & L
     C*
     C** Purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     ADD  WPOL      LDBL
     C                     ADD  WPOL      CLBL
     C** Sale
     C                     ELSE
     C                     SUB  WPOL      LDBL
     C                     SUB  WPOL      CLBL
     C                     END
     C*
     C                     END
     C*
     C** If record exists update it, else write a new one
     C*
     C                     EXSR UPMEMO
     C**                                                                  S01240
     C** Set MEMOSM/PRONOM Update Indicator to 'M' (used in SR WACMVD)    S01240
     C                     MOVE 'M'       MPIND   1                       S01240
     C**                                                                  S01240
     C** Write record to PF/FFACMVD                                       S01240
     C                     EXSR WACMVD                                    S01240
     C*
     C                     END
     C*
     C/SPACE 5
     C*
     C** If settled across a nostro account
     C*
     C           FFPIND    IFEQ 'Y'
     C*
     C** Access Projected Nostro Balance (LF/PRONOM)
     C*
     C                     EXSR RDPRON
     C*
     C** Reset balance fields if record does not exist
     C*
     C           PEXIST    IFEQ 'N'
     C                     MOVE *ZERO     PNBL
     C                     END
     C**                                                                  S01240
     C** Store Projected Nostro Balance for use in SR. WACMVD             S01240
     C                     Z-ADDPNBL      WPNBL  150                      S01240
     C*
     C** Update projected nostro balance with premiums & RL.           P/L
     C** due to exercise creation
     C*
     C** Broker involved?
     C*  Yes
     C********** BOCOU     IFNE *ZERO                                                         CSD027
     C           BOCOU     IFNE *BLANKS                                                       CSD027
     C*
     C** Apply premiums if paid at end
     C*
     C**
     C           PUPF      IFEQ 'N'
     C*
     C** Purchase
     C*
     C***
     C           TRTYU     IFEQ 'P'
     C                     ADD  WPREM     PNBL
     C** Sale
     C                     ELSE
     C                     SUB  WPREM     PNBL
     C                     END
     C***
     C                     END
     C**
     C*
     C** Apply exercise Realised P & L
     C*
     C** Purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     SUB  WPOL      PNBL
     C** Sale
     C                     ELSE
     C                     ADD  WPOL      PNBL
     C                     END
     C*
     C** Broker involved?
     C*  No
     C                     ELSE
     C*
     C** Apply premiums if paid at end
     C*
     C**
     C           PUPF      IFEQ 'N'
     C*
     C** Purchase
     C*
     C***
     C           TRTYU     IFEQ 'P'
     C                     SUB  WPREM     PNBL
     C** Sale
     C                     ELSE
     C                     ADD  WPREM     PNBL
     C                     END
     C***
     C                     END
     C**
     C*
     C** Apply exercise Realised P & L
     C*
     C** Purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     ADD  WPOL      PNBL
     C** Sale
     C                     ELSE
     C                     SUB  WPOL      PNBL
     C                     END
     C*
     C                     END
     C*
     C** If record exists update it, else write a new one
     C*
     C                     EXSR UPPRON
     C**                                                                  S01240
     C           FFMIND    IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C** Set MEMOSM/PRONOM Update Indicator to 'P' (used in SR WACMVD)    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C** Write record to PF/FFACMVD                                       S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C*
     C                     END
     C*
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R UBPRPL TO DETERMINE IF MEMOS/PRONO UPDATE IS REQUIRED
     C**            AND TO SHADOW POST / UPDATE NOSTRO BALANCES FOR
     C**            BROKER IF REQUIRED
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS SR FFSETL, SR RDMEMO, SR UPMEMO, SR RDPRON, SR UPPRON
     C**       SR WACMVD                                                  S01240
     C**
     C********************************************************************
     C*
     C           UBPRPL    BEGSR
     C**
     C*
     C** Set up parms for FFSETL (search argument) for Broker
     C*
     C***********          Z-ADDBRCDU     FFBRCD                          S01117
     C                     MOVE BRCAU     FFBRCA                          S01117
     C**********           Z-ADDBOCOU     FFCBCD                                              CSD027
     C                     MOVE BOCOU     FFCBCD                                              CSD027
     C                     MOVE 'Y'       FFBRKI
     C                     MOVE ISCYU     FFCCY
     C                     MOVE BSLTW     FFSETP
     C                     MOVE BSLAW     FFSETA
     C                     MOVE BSBRW     FFSETB                          S01117
     C*
     C***********MBIN      IFEQ 'Y'                                       S01117
     C***********          Z-ADDNSACS     FFDASQ                          S01117
     C***********          ELSE                                           S01117
     C***********          MOVE 01        FFDASQ                          S01117
     C***********          END                                            S01117
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFSETL
     C*
     C** If settled across a retail account
     C*
     C           FFMIND    IFEQ 'Y'
     C*
     C** Access Retail Account Shadow Balance (LF/MEMOSM)
     C*
     C                     EXSR RDMEMO
     C*
     C** Reset balance fields if record does not exist
     C*
     C           MEXIST    IFEQ 'N'
     C                     MOVE *ZERO     LDBL
     C                     MOVE *ZERO     CLBL
     C                     END
     C**                                                                  S01240
     C** Store Ledger Balance in a work field for use in SR. WACMVD       S01240
     C                     Z-ADDLDBL      WLDBL                           S01240
     C*
     C** Update ledger balance and cleared balance with premiums & RL. P/L
     C** due to exercise creation
     C*
     C** Apply premiums if paid at end
     C*
     C**
     C           PUPF      IFEQ 'N'
     C*
     C** Purchase
     C*
     C***
     C           TRTYU     IFEQ 'P'
     C                     SUB  WPREM     LDBL
     C                     SUB  WPREM     CLBL
     C** Sale
     C                     ELSE
     C                     ADD  WPREM     LDBL
     C                     ADD  WPREM     CLBL
     C                     END
     C***
     C                     END
     C**
     C*
     C** Apply exercise Realised P & L
     C*
     C** Purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     ADD  WPOL      LDBL
     C                     ADD  WPOL      CLBL
     C** Sale
     C                     ELSE
     C                     SUB  WPOL      LDBL
     C                     SUB  WPOL      CLBL
     C                     END
     C*
     C** If record exists update it, else write a new one
     C*
     C                     EXSR UPMEMO
     C**                                                                  S01240
     C** Set MEMOSM/PRONOM Update Indicator to 'M' (used in SR WACMVD)    S01240
     C                     MOVE 'M'       MPIND                           S01240
     C**                                                                  S01240
     C** Write record to PF/FFACMVD                                       S01240
     C                     EXSR WACMVD                                    S01240
     C*
     C                     END
     C*
     C/SPACE 5
     C*
     C** If settled across a nostro account
     C*
     C           FFPIND    IFEQ 'Y'
     C*
     C** Access Projected Nostro Balance (LF/PRONOM)
     C*
     C                     EXSR RDPRON
     C*
     C** Reset balance fields if record does not exist
     C*
     C           PEXIST    IFEQ 'N'
     C                     MOVE *ZERO     PNBL
     C                     END
     C**                                                                  S01240
     C** Store Projected Nostro Balance for use in SR. WACMVD             S01240
     C                     Z-ADDPNBL      WPNBL                           S01240
     C*
     C** Update projected nostro balance with premiums & RL.           P/L
     C** due to exercise creation
     C*
     C** Apply premiums if paid at end
     C*
     C**
     C           PUPF      IFEQ 'N'
     C*
     C** Purchase
     C*
     C***
     C           TRTYU     IFEQ 'P'
     C                     SUB  WPREM     PNBL
     C** Sale
     C                     ELSE
     C                     ADD  WPREM     PNBL
     C                     END
     C***
     C                     END
     C**
     C*
     C** Apply exercise Realised P & L
     C*
     C** Purchase
     C*
     C           TRTYU     IFEQ 'P'
     C                     ADD  WPOL      PNBL
     C** Sale
     C                     ELSE
     C                     SUB  WPOL      PNBL
     C                     END
     C*
     C** If record exists update it, else write a new one
     C*
     C                     EXSR UPPRON
     C*
     C           FFMIND    IFNE 'Y'                                       S01240
     C**                                                                  S01240
     C** Set MEMOSM/PRONOM Update Indicator to 'P' (used in SR WACMVD)    S01240
     C                     MOVE 'P'       MPIND                           S01240
     C**                                                                  S01240
     C** Write record to PF/FFACMVD                                       S01240
     C                     EXSR WACMVD                                    S01240
     C                     END                                            S01240
     C                     END
     C*
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R WDEFLT TO INITIALISE BROKER/CUSTOMER DEFAULT VALUES
     C**
     C** CALLED FROM CUSNO
     C**             BOCNO
     C**
     C** CALLS SR DBERR
     C**
     C********************************************************************
     C*
     C           WDEFLT    BEGSR
     C**
     C*
     C**  Initialise default fields
     C*
     C                     MOVE *BLANKS   WCPTW
     C                     MOVE *BLANKS   WSLAW
     C                     MOVE *BLANKS   WSLBW                           S01117
     C                     MOVE *BLANKS   WFAOW
     C                     MOVE *BLANKS   WCPNW
     C                     Z-ADD0         WCMCW
     C                     Z-ADD0         WCMSW
     C                     Z-ADD0         WSLTW
     C                     Z-ADD0         WCGPW
     C                     Z-ADD0         WCGSW
     C/SPACE 2
     C*
     C**  If broker/customer code non-zero set up default values
     C*
     C********** WCBCD     IFNE 0                                                             CSD027
     C           WCBCD     IFNE *BLANKS                                                       CSD027
     C*
     C**  Access FOCLT for broker/customer settlement details
     C**  If unsuccessful - db-error
     C*
     C           WCBCD     CHAINFOCLT                79
     C**
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'FOCLT'   DBFILE
     C                     MOVELWCBCD     DBKEY            ***************
     C                     Z-ADD10        DBASE            * DB ERROR 10 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C**
     C*
     C**  Access DEFLT for broker/customer default values
     C**     ( LF/DEFLT records only exist for market instruments )
     C**     ( NB. *IN51 is on if record does NOT exist )
     C*
     C                     SETON                     51
     C**
     C           PMRKT     IFNE *BLANKS
     C           KWDFLT    CHAINDEFLT                51
     C*
     C**  If record found, it must be live
     C*
     C***
     C           *IN51     IFEQ '0'
     C           RECI      ANDNE'D'
     C                     SETON                     51
     C                     END
     C***
     C                     END
     C**
     C/SPACE 1
     C*
     C**  Default Commission Fields
     C*
     C*
     C**  Use values for broker/customer/instrument on LF/DEFLT
     C**  if they exist
     C*
     C**
     C           *IN51     IFEQ '0'
     C           CPAT      ANDNE*BLANKS
     C*
     C                     MOVE CPAT      WCPTW
     C                     Z-ADDCMCD      WCMCW
     C                     Z-ADDCMSD      WCMSW
     C*
     C**
     C                     ELSE
     C**
     C*
     C**  Otherwise, use values for broker/customer/instrument on LF/INTYP
     C**  if they exist
     C*
     C***
     C           WCPT      IFNE *BLANKS
     C                     MOVE WCPT      WCPTW
     C                     Z-ADDWCMC      WCMCW
     C                     Z-ADDWCMS      WCMSW
     C                     END
     C***
     C                     END
     C**
     C/SPACE 1
     C*
     C**  Default Charge Fields
     C*
     C**  Use values for broker/customer/instrument on LF/DEFLT
     C**  if they exist
     C*
     C**   Purchase
     C*
     C           *IN51     IFEQ '0'
     C           CGEP      ANDNE*ZEROS
     C*
     C                     Z-ADDCGEP      WCGPW
     C*
     C**
     C                     ELSE
     C**
     C*
     C**  Otherwise, use values for broker/customer/instrument on LF/INTYP
     C*
     C***
     C                     Z-ADDWCGP      WCGPW
     C*
     C                     END
     C*
     C**   Sale
     C*
     C           *IN51     IFEQ '0'
     C           CGES      ANDNE*ZEROS
     C*
     C                     Z-ADDCGES      WCGSW
     C*
     C**
     C                     ELSE
     C**
     C*
     C**  Otherwise, use values for broker/customer/instrument on LF/INTYP
     C*
     C***
     C                     Z-ADDWCGS      WCGSW
     C*
     C                     END
     C**
     C/SPACE 1
     C*
     C**  Default Settlement Fields
     C*
     C**  Use values for broker/customer/instrument on LF/DEFLT
     C**  if they exist
     C*
     C**
     C           *IN51     IFEQ '0'
     C           SETP      ANDNE*ZEROS
     C*
     C                     Z-ADDSETP      WSLTW
     C                     MOVE SETA      WSLAW
     C                     MOVE SEBR      WSLBW                           S01117
     C                     MOVE FACO      WFAOW
     C                     MOVE CNOS      WCPNW
     C*
     C**
     C                     ELSE
     C**
     C*
     C**  Otherwise, use values for broker/customer/instrument on LF/FOCLT
     C**  if they exist
     C*
     C***
     C           SETPF     IFNE *ZEROS
     C                     Z-ADDSETPF     WSLTW
     C                     MOVE SETAF     WSLAW
     C                     MOVE SEBRF     WSLBW                           S01117
     C                     MOVE FACOF     WFAOW
     C                     MOVE CNOSF     WCPNW
     C                     END
     C***
     C                     END
     C**
     C                     END
     C*
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R CUSNO TO INITIALISE CUSTOMER DEFAULT VALUES
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS WDEFLT
     C**
     C********************************************************************
     C*
     C           CUSNO     BEGSR
     C**
     C*
     C**  Set indicator to show if Customer is present for use
     C**  in exception time output
     C**             ( *IN11 = Customer Present )
     C*
     C********** CUSCU     IFEQ *ZEROS                                                        CSD027
     C           CUSCU     IFEQ *BLANKS                                                       CSD027
     C                     SETOF                     11
     C                     ELSE
     C                     SETON                     11
     C                     END
     C*
     C**  Initialise Broker/Customer work field with Customer number
     C**  for work routine
     C*
     C**********           Z-ADDCUSCU     WCBCD                                               CSD027
     C                     MOVE CUSCU     WCBCD                                               CSD027
     C*
     C**  Initialise LF/INTYP work fields for Customer for work routine
     C*
     C                     MOVE CCPTI     WCPT
     C                     Z-ADDCCMCI     WCMC
     C                     Z-ADDCCMSI     WCMS
     C                     Z-ADDCCGPI     WCGP
     C                     Z-ADDCCGSI     WCGS
     C*
     C**  Call work routine to initialise Customer Defaults
     C*
     C                     EXSR WDEFLT
     C*
     C**  Update work fields for Customer defauts
     C**  from work routine
     C*
     C                     MOVE WCPTW     CCPTW
     C                     MOVE WSLAW     CSLAW
     C                     MOVE WSLBW     BRSCW                           S01117
     C                     MOVE WFAOW     CFAOW
     C                     MOVE WCPNW     CCPNW
     C                     Z-ADDWCMCW     CCMCW
     C                     Z-ADDWCMSW     CCMSW
     C                     Z-ADDWSLTW     CSLTW
     C                     Z-ADDWCGPW     CCGPW
     C                     Z-ADDWCGSW     CCGSW
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R BOCNO TO INITIALISE BROKER DEFAULT VALUES
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS DEFLT
     C**
     C********************************************************************
     C*
     C           BOCNO     BEGSR
     C**
     C*
     C**  Set indicator to show if Broker is present for use
     C**  in exception time output
     C**             ( *IN10 = Broker Present )
     C*
     C********** BOCOU     IFEQ *ZEROS                                                        CSD027
     C           BOCOU     IFEQ *BLANKS                                                       CSD027
     C                     SETOF                     10
     C                     ELSE
     C                     SETON                     10
     C                     END
     C*
     C**  Initialise Broker/Customer work field with Broker number
     C**  for work routine
     C*
     C**********           Z-ADDBOCOU     WCBCD                                               CSD027
     C                     MOVE BOCOU     WCBCD                                               CSD027
     C*
     C**  Initialise LF/INTYP work fields for Broker for work routine
     C*
     C                     MOVE BCPTI     WCPT
     C                     Z-ADDBCMCI     WCMC
     C                     Z-ADDBCMSI     WCMS
     C                     Z-ADDBCGPI     WCGP
     C                     Z-ADDBCGSI     WCGS
     C*
     C**  Call work routine to initialise Broker Defaults
     C*
     C                     EXSR WDEFLT
     C*
     C**  Update work fields for broker defauts
     C**  from work routine
     C*
     C                     MOVE PSCI      BPSCI   1
     C                     MOVE WCPTW     BCPTW
     C                     MOVE WSLAW     BSLAW
     C                     MOVE WSLBW     BSBRW                           S01117
     C                     MOVE WFAOW     BFAOW
     C                     MOVE WCPNW     BCPNW
     C                     Z-ADDWCMCW     BCMCW
     C                     Z-ADDWCMSW     BCMSW
     C                     Z-ADDWSLTW     BSLTW
     C                     Z-ADDWCGPW     BCGPW
     C                     Z-ADDWCGSW     BCGSW
     C**
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C**
     C** S/R INIT TO PERFORM FIRST CYCLE ONLY CALCULATIONS
     C**
     C** CALLED FROM MAIN PROCESSING
     C**
     C** CALLS SR DBERR
     C**
     C********************************************************************
     C*
     C           INIT      BEGSR
     C**
     C*
     C** Set on not-first cycle indicator
     C*
     C                     SETON                     20
     C/SPACE 2
     C*
     C** Set up a version of the market centre received as a parameter
     C** that can be used as a datastructure subfield
     C*
     C                     MOVE PMRKT     XMRKT
     C**
     C/SPACE 2
     C*
     C** Prepare LDA
     C*
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL*BLANK    DBPGM                           S01117
     C                     MOVEL'FF0350  'DBPGM
     C                     MOVE *BLANKS   DBASE
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     OUT  LDA                                       S01117
     C*                                                                   S01117
     C**      IN THE DATAAREA                                             S01117
     C*                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
     C/COPY WNCPYSRC,FF0350C010
      *                                                                   CFF007
      ** Access MPHAS to retrieve the Phase of the Day                    CFF007
      *                                                                   CFF007
     C           *NAMVAR   DEFN MPHAS     PHASE                           CFF007
     C                     IN   PHASE                                     CFF007
      *                                                                   CFF007
      ** Check if switchable feature CFF007 is installed                  CFF007
      *                                                                   CFF007
     C                     CALL 'AOSARDR0'                                CFF007
     C                     PARM *BLANKS   @RTCD                           CFF007
     C                     PARM '*VERIFY' @OPTN                           CFF007
     C                     PARM 'CFF007'  @SARD   6                       CFF007
     C           SCSARD    PARM SCSARD    @DSSDY                          CFF007
      *                                                                   CFF007
     C           @RTCD     IFNE *BLANKS                                   CFF007
     C           @RTCD     ANDNE'*NRF   '                                 CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD5         DBASE              *************CFF007
     C                     MOVE 'SCSARDPD'DBFILE             * DBERR 005 *CFF007
     C                     MOVEL@SARD     DBKEY              *************CFF007
     C                     EXSR DBERR                                     CFF007
      *                                                                   CFF007
     C                     ELSE                                           CFF007
      *                                                                   CFF007
     C           @RTCD     IFEQ *BLANKS                                   CFF007
     C                     MOVE 'Y'       CFF007  1                       CFF007
     C                     ELSE                                           CFF007
     C                     MOVE 'N'       CFF007                          CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
      *                                                                   CFF007
     C                     CALL 'AOMMODR0'                                CFF007
     C                     PARM *BLANKS   @RTCD                           CFF007
     C                     PARM '*FIRST ' @OPTN                           CFF007
     C           SDMMOD    PARM SDMMOD    @DSFDY                          CFF007
      *                                                                   CFF007
     C           @RTCD     IFNE *BLANKS                                   CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD6         DBASE              *************CFF007
     C                     MOVE 'SDMMODPD'DBFILE             * DBERR 006 *CFF007
     C                     MOVE *BLANKS   DBKEY              *************CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C** If Portfolio Management module is installed, access              CFF007
     C** Portfolio Management ICD using acess object.                     CFF007
     C*                                                                   CFF007
     C           BGPFMG    IFEQ 'Y'                                       CFF007
     C*                                                                   CFF007
     C                     CALL 'AOPORTR0'                                CFF007
     C                     PARM *BLANKS   @RTCD                           CFF007
     C                     PARM '*FIRST ' @OPTN                           CFF007
     C           SDPORT    PARM SDPORT    @DSFDY                          CFF007
     C*                                                                   CFF007
     C           @RTCD     IFNE *BLANKS                                   CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     Z-ADD7         DBASE              *************CFF007
     C                     MOVE 'SDPORTPD'DBFILE             * DBERR 007 *CFF007
     C                     MOVE *BLANKS   DBKEY              *************CFF007
     C                     OUT  LDA                                       CFF007
     C                     EXSR DBERR                                     CFF007
     C                     ENDIF                                          CFF007
     C*                                                                   CFF007
     C                     ENDIF                                          CFF007
     C/SPACE 2
     C*
     C***If*parameter*is*blank*(OTC)**************************************S01117
     C******Then*access*TABTB10*for*run-date******************************S01117
     C******IF*no*record*found,*******************************************S01117
     C******OR*record*not*live********************************************S01117
     C*********Perform*Database-error*************************************S01117
     C***********                                                         S01117
     C***********PMRKT     IFEQ *BLANKS                                   S01117
     C***********                                                         S01117
     C***NB.**PF/TABTB10*IS*NOT*ACCESSED*IF*THE*PROGRAM*IS*CALLED*********S01117
     C********WITH*A*NON*BLANK*PARAMETER*(*IE*FOR*A*MARKET*)**************S01117
     C********ALSO,**IN98*-*WHICH*IS*REQUIRED*BY*ZDATE*ROUTINES***********S01117
     C********AND*SET*DEPENDING*ON*THE*STATUS*OF*DATF*-*IS*NOT*SET********S01117
     C********AS*IT*IS*NOT*REQUIRED*AT*THE*MOMENT*************************S01117
     C*
     C                     MOVE *BLANKS   ZTABKY 12
     C*
     C***********          MOVEL'01'      ZTABKY                          S01117
     C***********          MOVE '10'      ZTABKY                          S01117
     C***********ZTABKY    CHAINTABFF                79                   S01117
     C***********                                                         S01117
     C***DB*Error*Handler*************************************************S01117
     C***********                                                         S01117
     C***********                                                         S01117
     C************IN79     IFEQ '1'                                       S01117
     C***********RECI      ORNE 'D'                                       S01117
     C***********          MOVEL'TABFF'   DBFILE           ***************S01117
     C***********          Z-ADD11        DBASE            * DB ERROR 11 *S01117
     C***********          MOVELZTABKY    DBKEY            ***************S01117
     C***********          EXSR DBERR                                     S01117
     C***********          END                                            S01117
     C**
     C** IF SINGLE BRANCH, GET SINGLE BRANCH VALUE IN AO BANK DETAILS     S01117
     C*                                                                   S01117
     C/COPY WNCPYSRC,FF0350C011
     C           MBIN      IFNE 'Y'                                       S01117
     C/COPY WNCPYSRC,FF0350C016
     C                     CALL 'AOBANKR0'                                S01117
     C/COPY WNCPYSRC,FF0350C012
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    @DSFDY                          S01117
     C*                                                                   S01117
     C** DB Error Handler                                                 S01117
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBANKPD'DBFILE                          S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     MOVEL@OPTN     DBKEY            ***************S01117
     C                     Z-ADD11        DBASE            * DB ERROR 11 *S01117
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C/COPY WNCPYSRC,FF0350C013
     C                     END                                            S01117
     C/COPY WNCPYSRC,FF0350C014
     C*
     C** Otherwise, if parameter is not blank
     C**    Then access MKCTL for business date
     C**    IF no record found,
     C**    OR record not live
     C**        Perform Database-error
     C*
     C***********          ELSE                                           S01117
     C           PMRKT     IFNE *BLANKS                                   S01117
     C*
     C                     OPEN MKCTL
     C           PMRKT     CHAINMKCTL                79
     C                     CLOSEMKCTL
     C*
     C** DB Error Handler
     C*
     C**
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'MKCTL'   DBFILE
     C                     MOVELPMRKT     DBKEY            ***************
     C                     Z-ADD12        DBASE            * DB ERROR 12 *
     C                     OUT  LDA                        ***************S01117
     C                     EXSR DBERR                      ***************
     C                     END
     C**
     C                     END
     C*
     C** Access Installation Control Data Records 20 40 80                S01117
     C***Access*Installation*Control*Data*Records*11*20*40*80*************S01117
     C***********                                                         S01117
     C***TABTB11*-*ICD*2**************************************************S01117
     C***********                                                         S01117
     C***********          MOVE *BLANKS   ZTABKY                          S01117
     C***********                                                         S01117
     C***********          MOVEL'01'      ZTABKY                          S01117
     C***********          MOVE '11'      ZTABKY                          S01117
     C***********ZTABKY    CHAINTABFF                79                   S01117
     C***********                                                         S01117
     C***DB*Error*Handler*************************************************S01117
     C***********                                                         S01117
     C************IN79     IFEQ '1'                                       S01117
     C***********RECI      ORNE 'D'                                       S01117
     C***********          MOVEL'TABFF'   DBFILE           ***************S01117
     C***********          Z-ADD13        DBASE            * DB ERROR 13 *S01117
     C***********          MOVELZTABKY    DBKEY            ***************S01117
     C***********          EXSR DBERR                                     S01117
     C***********          END                                            S01117
     C*
     C** TABTB20 - ICD 3
     C*
     C                     MOVE *BLANKS   ZTABKY
     C*
     C                     MOVEL'01'      ZTABKY
     C                     MOVE '20'      ZTABKY
     C           ZTABKY    CHAINTABFF                79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'TABFF'   DBFILE           ***************
     C                     Z-ADD14        DBASE            * DB ERROR 14 *
     C                     MOVELZTABKY    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C** TABTB40 - ICD 5
     C*
     C                     MOVE *BLANKS   ZTABKY
     C*
     C                     MOVEL'01'      ZTABKY
     C                     MOVE '40'      ZTABKY
     C           ZTABKY    CHAINTABFF                79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'TABFF'   DBFILE           ***************
     C                     Z-ADD15        DBASE            * DB ERROR 15 *
     C                     MOVELZTABKY    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C** TABTB80 - ICD FUTURES & OPTIONS
     C*
     C                     MOVE *BLANKS   ZTABKY
     C*
     C                     MOVEL'01'      ZTABKY
     C                     MOVE '80'      ZTABKY
     C           ZTABKY    CHAINTABFF                79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'TABFF'   DBFILE           ***************
     C                     Z-ADD16        DBASE            * DB ERROR 16 *
     C                     MOVELZTABKY    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*                                                                   S01117
     C** ACCESS BICN OF SINGLE BRANCH WHEN NON-MULTIBRANCHING             S01117
     C*                                                                   S01117
     C           MBIN      IFEQ 'N'                                       S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM USRBCH    @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    @DSFDY                                       S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C** DB Error Handler                                                 S01117
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBRCHPD'DBFILE           ***************S01117
     C                     Z-ADD18        DBASE            * DB ERROR 18 *S01117
     C                     MOVEL@DSNB     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                                            S01117
     C/SPACE 2
     C*
     C**   Initialisation of Key Lists for use in Standard Routine FFSETL
     C*
     C/COPY ZSRSRC,FFSETLZ3
     C**
     C/COPY WNCPYSRC,FF0350CCP1                                           S01408
     C                     ENDSR
     C/COPY WNCPYSRC,FF0350C015
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C*
     C** S/R DBERR TO PERFORM DATABASE ERROR EXIT FROM PROGRAM
     C*
     C** CALLED FROM MAIN
     C**             SR. UTRSET
     C**             SR. RDTABR
     C**             SR. UPOSTN
     C**             SR. UTRANA
     C**             SR. WDEFLT
     C**             SR. INIT
     C*
     C** CALLS NONE.
     C*
     C**             FILE                       DBASE NO.
     C**
     C**            INTYP                          01
     C**            INTYP2                         02
     C**            TRANS6                         03
     C**            TRSET                          04
     C**************TABLETR************************05*********************S01117
     C**            SDBRCHPD (IN SUB. RDTABR)      05                     S01117
     C**            POSTNC ( CUSTOMER )            06
     C**            POSTNC ( BROKER )              07
     C**            POSTNK                         08
     C**            TRANSA                         09
     C**            FOCLT ( CUSTOMER & BROKER )    10
     C**************TABTB10************************11*********************S01117
     C**            MKCTL                          12
     C**************TABTB11************************13*********************S01117
     C**            TABTB20                        14
     C**            TABTB40                        15
     C**            TABTB80                        16
     C**            SDBRCHPD (IN SUB. INIT)        18                     S01117
     C**            SDBRCHPD (IN SUB. WTRSET)      19                     S01117
     C**            SDBRCHPD (IN SUB. WTRSET)      20                     S01117
     C*
     C********************************************************************
     C*
     C           DBERR     BEGSR
     C*
     C** Seton U7 U8 LR
     C** Dump                                                             S01117
     C** Return
     C*
     C                     SETON                     U7U8LR
     C**                                                                  S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C**                                                                  S01117
     C                     RETRN
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C/EJECT                                                              AUS022
     C/COPY ZSRSRC,FFYTOPZ1                                               AUS022
     C/COPY WNCPYSRC,FF0350C004
      /EJECT
     O*
     OMEMOSMEFE                EMEMOS
     O*    UPDATE LF/MEMOSM - FO Retail Shadow postings for markets
     O                         LDBL
     O                         CLBL
     O*
     OPRONOMEFE                EPRONO
     O*    UPDATE LF/PRONOM - Projected Nostros for markets
     O                         PNBL
     O*
     OTRANSAF E                ETRANA
     O*    Amend LF/TRANSA (Trailer )
     O                         NORE
     O                         NINS
     O*
     OTRANSUF E                ETRANS
     O*    Amend LF/TRANS (Trade)
     O                         NOCOU
     O                         NOBOU
     O                         FCINU
     O                         FBINU
     O*
     OTRSETUF E                ETRSET
     O*    Amend LF/TRSET (Trade)
     O*    *IN10 = Update Broker
     O*    *IN11 = Update Customer
     O                 10      OCSBU
     O                 11      OCSCU
     O                 10      BMARU
     O                 11      CMARU
     O*
     OPOSTNCDFE                EPSTNC
     O*    Customer/Broker Position on LF/POSTNC
     O                         LOPC
     O                         SOPC
     O                         CUTV
     O                         RPLD
     O                         TOTM
     O                         LOCO
     O                         SOCO
     O*
     OPOSTNKDFE                EPSTNK
     O*    Book Position on LF/POSTNK
     O                         LOPC
     O                         SOPC
     O                         CUTV
     O                         RPLD
     O*
     O*****************************************************************
** STAMP - Dummy timestamp                                                                    CPK015
0001-01-01-00.00.00.000000                                                                    CPK015
**  CPY@
(c) Finastra International Limited 2001
**   MSG - FIELD NARRATIVE
 SETTLEMENT EXERCISE
     X/COPY WNCPYSRC,FF0350X001
