     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FF Closeout set creation shadow post')           *
/*OVRF*: OVRDBF FOCLTB FOCLT                                        : *
/*OVRF*: OVRDBF FOCLTC FOCLT                                        : *
/*OVRF*: OVRDBF DEFLTB DEFLT                                        : *
/*OVRF*: OVRDBF DEFLTC DEFLT                                        : *
/*OVRF*: OVRDBF TRSETP TRSET                                        : *
/*OVRF*: OVRDBF TRSETS TRSET                                        : *
/*OVRF*: OVRDBF TRANSP TRANS                                        : *
/*OVRF*: OVRDBF TRANSS TRANS                                        : *
     H**     ***EXTERNALLY-DESCRIBED INPUT SPECS ARE IN ALPHABETIC SEQ***
     H**                    (BUT TAB* AT END)
      *****************************************************************
      *                                                               *
      *  Midas FUTURES AND OPTIONS MODULE                             *
      *                                                               *
      *   FF0360  -  CLOSE OUT SET CREATION SHADOW POSTING            *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. AR746662           Date 03May11               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. 246526             Date 21Mar07               *
      *                 247517             Date 09May07               *
      *                 247296             Date 25Apr07               *
      *                 CPK027             Date 16Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 241147A            Date 07Nov06               *
      *                 241147             Date 26Oct06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CER001             Date 25Apr05               *
      *                 BUG6688            Date 30May05               *
      *                 CGL029             Date 01Sep03               *
      *                 215528             Date 21Mar03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CFF006             Date 28Nov00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 126117             Date 20Apr00               *
      *                 140017             Date 20Apr00               *
     F*                 140455             Date 20Apr00               *
     F*                 136056             Date 14Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.01 Patch E ---------------------------------------*
     F*                 171172             Date 25Nov99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 CAP003             Date 18Aug98               *
     F*                 CFF004             DATE 16SEP96                  *
     F*                 S71062             DATE 19DEC95                  *
     F*                 S01456             DATE 08NOV93                  *
     F*                  S01455             DATE 05NOV93                 *
     F*                  S04662             DATE 12JUL93                 *
     F*                  S01411             DATE 05JUL93              *  *
     F*                  E30416             DATE 23MAR93              *
     F*                  E03643             DATE 23MAR93              *
     F*                  S01393             DATE 30OCT92              *
     F*                  E44985             DATE 25SEP92              *
     F*                  FUJI-FF0011        DATE 21AUG92                 *
     F*                  AUS022             DATE 07AUG92                 *
     F*                  FO0017             DATE 07JAN91                 *
     F*                  S01117             DATE 07MAR90                 *
     F*                  S01240             DATE 20MAR89                 *
     F*                                                                  *
     F*------------------------------------------------------------------*
      *                                                               *
      *  AR746662 - Discrepancy in premium amount in Currency OTC     *
      *             screen and Projected Available Balance Enquiry    *
      *             Applied fix 249171. (Recompile)                   *
      *             (Child: Artf746663)                               *
      *  246526 - Recompiled due to change in FFSETLZ4.               *
      *  247517 - Reversed fix 241147.                                *
      *  247296 -  For Ccy OTC, as MNPF was defaulted to '0.00000001',*
      *            premium must be divided by 100.                    *
      *  CPK027 - Errors in compiling MP1_3_TTTS - recompile over     *
      *           changed FFTVCLZ2.                                   *
      *  241147A - Recompile.                                         *
      *  241147 - Recompile.                                          *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CER001 - LUX Upgrade to MidasPlus                            *
      *  BUG6688- Branch record not found in TABLETR                  *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  215528 - System is associating a wrong premium amount.       *
      *           Recompiled only.                                    *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed FFYTOPZ1.                    *
      *  CFF006 - Fractional Ticks Enhancement.  (Recompiled)         *
     F*  126117 - Recompiled due to changes to FFYTOPZ1.              *
     F*  140017 - Recompiled due to changes to FFPMCLZ1.              *
     F*  140455 - Recompiled due to changes to FFPMCLZ1               *
     F*  136056 - Dft accuracy = 9; Australian 3 & 10 TB Future = 8.  *
     F*           Calculate Australian option premiums correctly      *
     F*           Recompiled due to changes in FFYTOPZ1               *
     F*  171172 - Recompile over changed POSTNCD/POSTNKD             *
      *  CAP003 - Conversion of Midas inputs to modular API structure *
      *           (phase 2) - recompiled                              *
     F*  CFF004 - Increase in size of Price Fields                       *
     F*  S71062 - FF/PM Interface (Just recompiled)                   *
     F*  S01456 - 'FF' MONTHLY P&L ENHANCEMENTS.                         *
     F*           Recompiled due to change to PF/MKCTLD.                 *
     F*  S01455 - 'FF' ACCOUNT KEY ENHANCEMENTS.                         *
     F*           Recompiled due to changes in PF/TABTB80.               *
     F*  S04662 - Switchable Feature for Init Margins for Futures;       *
     F*           Deposit and Spread Margin Rate added to DEFLTD.        *
     F*           Recompile only.                                        *
     F*   S01411 - Recompiled as field 'ORIGINAL ENTRY DATE' added to *  *
     F*            PF/TRANSD.                                         *  *
     F*  E30416 - Recompiled due to amendments on subroutine FFYTOP.  *
     F*  E03643 - Commissions, though calculated correctly on         *
     F*         - a trade basis for accounting purposes are not       *
     F*         - reported correctly by individual closeout.          *
     F*  S01393 -  RECOMPILED FOR STRATEGIC RISK MANAGEMENT           *
     F*   E44985  -  ZYIELD requires 3 new parameters. Recompile only    *
     F* FUJI-FF0011 - The system does not differentiate between          *
     F*               american and european option on exercise           *
     F*               validation and OTC confirmation wording.           *
     F*               *** RECOMPILE ONLY ***                             *
     F*   AUS022  -  AUSTRALIAN CHANGE : Introduction of Processing      *
     F*              Types 7 and 8.                                      *
     F*   FO0017  -  ADD BRCA ON UPDATE OF ACCOUNT MOVEMENTS FILE        *
     F*   S01117  -  MULTIBRANCHING                                      *
     F*   S01240  -  ADDITION OF REAL TIME STATEMENTS CHANGES            *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*     CREATION REQUIREMENTS                                        *
     F*                                                                  *
     F*     IGNDECERR(*NO)                                               *
     F*     OVRDBF     FILE(FOCLTB) TOFILE(FOCLT)                        *
     F*     OVRDBF     FILE(FOCLTC) TOFILE(FOCLT)                        *
     F*     OVRDBF     FILE(DEFLTB) TOFILE(DEFLT)                        *
     F*     OVRDBF     FILE(DEFLTC) TOFILE(DEFLT)                        *
     F*     OVRDBF     FILE(TRSETP) TOFILE(TRSET)                        *
     F*     OVRDBF     FILE(TRSETS) TOFILE(TRSET)                        *
     F*     OVRDBF     FILE(TRANSP) TOFILE(TRANS)                        *
     F*     OVRDBF     FILE(TRANSS) TOFILE(TRANS)                        *
     F*                                                                  *
     F********************************************************************
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F/SPACE 2
     F*                                                                  *
     FMKCTL   IF  E           K        DISK                           UC
     FTABFF   IF  E           K        DISK
     F* ICD 1     TABTB10F                          KIGNORE
     F* ICD 2     TABTB11F                          KIGNORE
     F            TABTB10F                          KIGNORE               S01117
     F            TABTB11F                          KIGNORE               S01117
     F* ICD 3     TABTB20F                          KIGNORE
     F* ICD 5     TABTB40F                          KIGNORE
     F* ICD-FF    TABTB80F                          KIGNORE
     F* A/C 1     TABTE10F                          KIGNORE
     F            TABTG10F                          KIGNORE
     F            TABLETHF                          KIGNORE
     F* NOSTROS   TABLETLF                          KIGNORE
     F* BRANCH    TABLETRF                          KIGNORE
     F            TABLET2F                          KIGNORE
     FFOCLTB  IF  E           K        DISK
     F            FOCLTDF                           KRENAMEFOCLTBF
     FFOCLTC  IF  E           K        DISK
     F            FOCLTDF                           KRENAMEFOCLTCF
     FDEFLTB  IF  E           K        DISK
     F            DEFLTDF                           KRENAMEDEFLTBF
     FDEFLTC  IF  E           K        DISK
     F            DEFLTDF                           KRENAMEDEFLTCF
     FINTYP   IF  E           K        DISK
     FPOSTNC  UF  E           K        DISK
     F                                              KCOMIT
     FPOSTNK  UF  E           K        DISK
     F                                              KCOMIT
     FCLOST6  UF  E           K        DISK
     F            CLOSTDF                           KRENAMECLOST6F
     F                                              KCOMIT
     F*                                                                   E03643
     F***CLOST4**IF**E           K        DISK                            E03643
     F************CLOSTTF                           KRENAMECLOST4F        E03643
     FCLOST4  UF  E           K        DISK                               E03643
     F            CLOSTTF                           KRENAMECLOST4F        E03643
     F                                              KCOMIT                E03643
     F*                                                                   E03643
     F***CLOST5**IF**E           K        DISK                            E03643
     F************CLOSTTF                           KRENAMECLOST5F        E03643
     FCLOST5  UF  E           K        DISK                               E03643
     F            CLOSTTF                           KRENAMECLOST5F        E03643
     F                                              KCOMIT                E03643
     F*                                                                   E03643
     FTRANSP  IF  E           K        DISK
     F            TRANSDF                           KRENAMETRANSPF
     FTRANSS  IF  E           K        DISK
     F            TRANSDF                           KRENAMETRANSSF
     FTRSETP  UF  E           K        DISK
     F            TRSETDF                           KRENAMETRSETPF
     F                                              KCOMIT
     FTRSETS  UF  E           K        DISK
     F            TRSETDF                           KRENAMETRSETSF
     F                                              KCOMIT
     FMEMOSM  UF  E           K        DISK                      A    U2
     F                                              KCOMIT
     FPRONOM  UF  E           K        DISK                      A    U6
     F                                              KCOMIT
     FFFACMVD O   E           K        DISK                           U6  S01240
     F                                              KCOMIT                S01240
     FACCNT   IF  E           K        DISK
     F            ACCNTAAF                          KIGNORE
     F            ACCNTACF                          KIGNORE
     FACNUM   IF  E           K        DISK
     F            ACCNTABF                          KRENAMEACNUMF
     F*
     F/EJECT
     F*                                                                  *
     F* ID F  C  H  L    FUNCTION OF INDICATORS
     F*                                                                  *
     F*       10         LF/TRSETP / LF/TRSETS UPDATE BROKER FIELDS
     F*       20         LF/TRSETP / LF/TRSETS UPDATE CUSTOMER FIELDS
     F*       77         GENERAL EOF IND
     F*       78         EOF CLOST6 -- PRIMARY FILE
     F*       79         RECORD NOT FOUND
     F*     80-89     RESERVED FOR STANDARD FF SUBROUTINES
     F*       89         USED BY STANDARD SR FFSETL
     F*             U7   DATABASE ERROR
     F*             U8   PROGRAM  ERROR
     E                    CPY@    1   1 80
     IACCNTABF
     I***********   BRCD                            BRCDA                 S01117
     I              BRCA                            BRCDA                 S01117
     I/SPACE 1
     IACNUMF
     I/SPACE 1
     ICLOST6F
     I* THIS RENAME PREVENT THE CONFUSTION OF BRCA THAT COMES FROM TABLETLS01117
     I              BRCA                            BRCA6                 S01117
     I/SPACE 1
     ICLOST4F
     I              CLON                            CLON4
     I              TNBR                            TNBR4
     I              NCCL                            NCCL4
     I              TRSD                            TRSD4
     I              TRTY                            TRTY4
     I              FCLI                            FCLI4
     I              OCOB                            OCOB4                 E03643
     I              CCOB                            CCOB4                 E03643
     I              OCOC                            OCOC4                 E03643
     I              CCOC                            CCOC4                 E03643
     I/SPACE 1
     ICLOST5F
     I              CLON                            CLON5
     I              TNBR                            TNBR5
     I              NCCL                            NCCL5
     I              TRSD                            TRSD5
     I              TRTY                            TRTY5
     I              FCLI                            FCLI5
     I              OCOB                            OCOB5                 E03643
     I              CCOB                            CCOB5                 E03643
     I              OCOC                            OCOC5                 E03643
     I              CCOC                            CCOC5                 E03643
     I/SPACE 1
     IDEFLTBF
     I              CBCD                            CBCDB
     I              MRKT                            MRKTB
     I              ISTC                            ISTCB
     I              SETP                            SETPBD
     I              SETA                            SETABD
     I              SEBR                            SEBRBD                S01117
     I              FACO                            FACOB
     I              CNOS                            CNOSB
     I              CPAT                            CPATB
     I              CMCD                            CMCDB
     I              CMSD                            CMSDB
     I              CGEP                            CGEPB
     I              CGES                            CGESB
     I              RVFR                            RVFRB
     I              RVDY                            RVDYB
     I              RVDT                            RVDTB
     I              EXPD                            EXPDB
     I              LCD                             LCDB
     I              CHTP                            CHTPB
     I/SPACE 1
     IDEFLTCF
     I              CBCD                            CBCDC
     I              MRKT                            MRKTC
     I              ISTC                            ISTCC
     I              SETP                            SETPCD
     I              SETA                            SETACD
     I              SEBR                            SEBRCD                S01117
     I              FACO                            FACOC
     I              CNOS                            CNOSC
     I              CPAT                            CPATC
     I              CMCD                            CMCDC
     I              CMSD                            CMSDC
     I              CGEP                            CGEPC
     I              CGES                            CGESC
     I              RVFR                            RVFRC
     I              RVDY                            RVDYC
     I              RVDT                            RVDTC
     I              EXPD                            EXPDC
     I              LCD                             LCDC
     I              CHTP                            CHTPC
     I/SPACE 1
     IFOCLTBF
     I              CBCD                            CBCDB
     I              BRKI                            BRKIB
     I              SETP                            SETPBF
     I              SETA                            SETABF
     I              SEBR                            SEBRBF                S01117
     I              FACO                            FACOB
     I              CNOS                            CNOSB
     I              CORA                            CORAB
     I              FTAO                            FTAOB
     I              TLCI                            TLCIB
     I              CNTL                            CNTLB
     I              STFQ                            STFQB
     I              STDY                            STDYB
     I              NSTD                            NSTDB
     I              REFQ                            REFQB
     I              REDY                            REDYB
     I              NRED                            NREDB
     I              PSCI                            PSCIB
     I              AUCI                            AUCIB
     I              CLDS                            CLDSB
     I              CLCC                            CLCCB
     I              CLAM                            CLAMB
     I              LCD                             LCDB
     I              CHTP                            CHTPB
     I/SPACE 1
     IFOCLTCF
     I              CBCD                            CBCDC
     I              BRKI                            BRKIC
     I              SETP                            SETPCF
     I              SETA                            SETACF
     I              SEBR                            SEBRCF                S01117
     I              FACO                            FACOC
     I              CNOS                            CNOSC
     I              CORA                            CORAC
     I              FTAO                            FTAOC
     I              TLCI                            TLCIC
     I              CNTL                            CNTLC
     I              STFQ                            STFQC
     I              STDY                            STDYC
     I              NSTD                            NSTDC
     I              REFQ                            REFQC
     I              REDY                            REDYC
     I              NRED                            NREDC
     I              PSCI                            PSCIC
     I              AUCI                            AUCIC
     I              CLDS                            CLDSC
     I              CLCC                            CLCCC
     I              CLAM                            CLAMC
     I              LCD                             LCDC
     I              CHTP                            CHTPC
     I/SPACE 1
     IINTYPDF
     I              ISCY                            ISCYI
     I              CTAM                            FFCTAM                AUS022
     I              CNTT                            FFCNTT                AUS022
     I/SPACE 1
     IMEMOSMEF
     I/SPACE 1
     IMKCTLDF
     I/SPACE 1
     IPOSTNCDF
     I***********   BRCD                            BRCDNC                S01117
     I              BRCA                            BRCDNC                S01117
     I              ISCY                            ISCYNC
     I/SPACE 1
     IPOSTNKDF
     I***********   BRCD                            BRCDNK                S01117
     I              BRCA                            BRCDNK                S01117
     I              ISCY                            ISCYNK
     I/SPACE 1
     IPRONOMEF
     I/SPACE 1
     ITRANSPF
     I              TNBR                            TNBRP
     I***********   BRCD                            BRCDP                 S01117
     I              BRCA                            BRCDP                 S01117
     I              BOCO                            BOCOP
     I              CUSC                            CUSCP
     I              BOKC                            BOKCP
     I              ISTT                            ISTTP
     I              YRNO                            YRNOP
     I              MTHN                            MTHNP
     I              PCAL                            PCALP
     I              STRP                            STRPP
     I              TRTY                            TRTYP
     I              ULTT                            ULTTP
     I              TRSD                            TRSDP
     I              NUCO                            NUCOP
     I              NOCO                            NOCOP
     I              NOBO                            NOBOP
     I              COPR                            COPRP
     I              TNAR                            TNARP
     I              TBLO                            TBLOP
     I              LNKR                            LNKRP
     I              CLSR                            CLSRP
     I              ECPI                            ECPIP
     I              CBPI                            CBPIP
     I              ISCY                            ISCYP
     I              FCDA                            FCDAP
     I              FCIN                            FCINP
     I              FBIN                            FBINP
     I              LCD                             LCDP
     I              CHTP                            CHTPP
     I/SPACE 1
     ITRANSSF
     I              TNBR                            TNBRS
     I***********   BRCD                            BRCDS                 S01117
     I              BRCA                            BRCDS                 S01117
     I              BOCO                            BOCOS
     I              CUSC                            CUSCS
     I              BOKC                            BOKCS
     I              ISTT                            ISTTS
     I              YRNO                            YRNOS
     I              MTHN                            MTHNS
     I              PCAL                            PCALS
     I              STRP                            STRPS
     I              TRTY                            TRTYS
     I              ULTT                            ULTTS
     I              TRSD                            TRSDS
     I              NUCO                            NUCOS
     I              NOCO                            NOCOS
     I              NOBO                            NOBOS
     I              COPR                            COPRS
     I              TNAR                            TNARS
     I              TBLO                            TBLOS
     I              LNKR                            LNKRS
     I              CLSR                            CLSRS
     I              ECPI                            ECPIS
     I              CBPI                            CBPIS
     I              ISCY                            ISCYS
     I              FCDA                            FCDAS
     I              FCIN                            FCINS
     I              FBIN                            FBINS
     I              LCD                             LCDS
     I              CHTP                            CHTPS
     I/SPACE 1
     ITRSETPF
     I              TNBR                            TNBRP
     I              OCSB                            OCSBP
     I              OCDB                            OCDBP
     I              CCSB                            CCSBP
     I              CCDB                            CCDBP
     I              OCSC                            OCSCP
     I              OCDC                            OCDCP
     I              CCSC                            CCSCP
     I              CCDC                            CCDCP
     I              NCCP                            NCCPP
     I              PRMP                            PRMPP
     I              BCPT                            BCPTP
     I              BCMC                            BCMCP
     I              BCMS                            BCMSP
     I              BCMA                            BCMAP
     I              BCHC                            BCHCP
     I              BCHA                            BCHAP
     I              BMAR                            BMARP
     I              BSLT                            BSLTP
     I              BSLA                            BSLAP
     I              BSBR                            BSBRP                 S01117
     I              BFAO                            BFAOP
     I              BCPN                            BCPNP
     I              BCHP                            BCHPP
     I              BCMP                            BCMPP
     I              CCPT                            CCPTP
     I              CCMC                            CCMCP
     I              CCMS                            CCMSP
     I              CCMA                            CCMAP
     I              CCHC                            CCHCP
     I              CCHA                            CCHAP
     I              CMAR                            CMARP
     I              CSLT                            CSLTP
     I              CSLA                            CSLAP
     I              BRSC                            BRSCP                 S01117
     I              CFAO                            CFAOP
     I              CCPN                            CCPNP
     I              CCHP                            CCHPP
     I              CCMP                            CCMPP
     I/COPY WNCPYSRC,FF0360I001
     I              CMCB                            CMCBP                                     CER001
     I              CHCB                            CHCBP                                     CER001
     I              CMCC                            CMCCP                                     CER001
     I              CHCC                            CHCCP                                     CER001
     I/SPACE 1
     ITRSETSF
     I              TNBR                            TNBRS
     I              OCSB                            OCSBS
     I              OCDB                            OCDBS
     I              CCSB                            CCSBS
     I              CCDB                            CCDBS
     I              OCSC                            OCSCS
     I              OCDC                            OCDCS
     I              CCSC                            CCSCS
     I              CCDC                            CCDCS
     I              NCCP                            NCCPS
     I              PRMP                            PRMPS
     I              BCPT                            BCPTS
     I              BCMC                            BCMCS
     I              BCMS                            BCMSS
     I              BCMA                            BCMAS
     I              BCHC                            BCHCS
     I              BCHA                            BCHAS
     I              BMAR                            BMARS
     I              BSLT                            BSLTS
     I              BSLA                            BSLAS
     I              BSBR                            BSBRS                 S01117
     I              BFAO                            BFAOS
     I              BCPN                            BCPNS
     I              BCHP                            BCHPS
     I              BCMP                            BCMPS
     I              CCPT                            CCPTS
     I              CCMC                            CCMCS
     I              CCMS                            CCMSS
     I              CCMA                            CCMAS
     I              CCHC                            CCHCS
     I              CCHA                            CCHAS
     I              CMAR                            CMARS
     I              CSLT                            CSLTS
     I              CSLA                            CSLAS
     I              BRSC                            BRSCS                 S01117
     I              CFAO                            CFAOS
     I              CCPN                            CCPNS
     I              CCHP                            CCHPS
     I              CCMP                            CCMPS
     I/COPY WNCPYSRC,FF0360I002
     I              CMCB                            CMCBS                                     CER001
     I              CHCB                            CHCBS                                     CER001
     I              CMCC                            CMCCS                                     CER001
     I              CHCC                            CHCCS                                     CER001
     I/SPACE 1
     I*ABTB10F***                                                         S01117
     I*ABTB11F***                                                         S01117
     ITABTB20F
     ITABTB40F
     ITABTB80F
     ITABTE10F
     ITABLETLF
     ITABLETRF
     I/SPACE 3
     I/COPY ZSRSRC,ZYLDZ1                                                 AUS022
     IRUNDT       DS                                                      S01117
      **  DATA AREA RUNDAT                                                S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
     I*DA********UDS                            256                       S01117
     ILDA         DS                            256                       S01117
     I*
     I**      LOCAL DATA AREA CONTAINING DB ERROR INFORMATION
     I*
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 1770DBASE                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I/SPACE 3
     I********************************************************************
     I*                                                                  *
     I**      K   E   Y        L   I   S   T   S    ( FOR DBKEY )        *
     I*                                                                  *
     I********************************************************************
     I/SPACE 1
     I**   LF/POSTNC
     I*
     IXPSTNC      DS
     I***********                             1   30KBRCDC                S01117
     I                                        1   3 KBRCAC                S01117
     I**********                              4   90KCBCDC                                    CSD027
     I                                        4   9 KCBCDC                                    CSD027
     I                                       10  14 KISTTC
     I                                       15  160KYRNOC
     I                                       17  180KMTHNC
     I                                       19  19 KPCALC
     I***********                         P  20  257KSTRPC                CFF004
     I                                    P  20  278KSTRPC                CFF004
     I/SPACE 1
     I**   LF/POSTNK
     I*
     IXPSTNK      DS
     I***********                             1   30KBRCDK                S01117
     I                                        1   3 KBRCAK                S01117
     I                                        4   5 KBOKCK
     I                                        6  10 KISTTK
     I                                       11  120KYRNOK
     I                                       13  140KMTHNK
     I                                       15  15 KPCALK
     I***********                         P  16  217KSTRPK                CFF004
     I                                    P  16  238KSTRPK                CFF004
     I/EJECT
     I********************************************************************
     I*                                                                  *
     I**      S   T   D      S   U   B   R   O   U   T   I   N   E   S   *
     I*                    (I-Specs)                                     *
     I*                                                                  *
     I********************************************************************
     I/SPACE 1
     I/COPY ZSRSRC,ZTNLU1Z1
     I/SPACE 1
     I/COPY ZSRSRC,FFSETLZ1
     I/SPACE 3
     I/COPY ZSRSRC,FFSRDSZ1
     I/SPACE 3
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                                       CGL029
     ISDACOD    E DSSDACODPD                                                                  CGL029
      ** External data structure for account code                                             CGL029
      *                                                                                       CGL029
     IDSSDY     E DSDSSDY                                                                     CGL029
      ** Second DS for Access Programs, Long Data Structure                                   CGL029
      *                                                                                       CGL029
     ISDBRCH    E DSSDBRCHPD                                                                 BUG6688
      ** Midas SD Branch Codes                                                               BUG6688
      *                                                                                      BUG6688
     C********************************************************************
     C*                                                                  *
     C**      S   T   D      S   U   B   R   O   U   T   I   N   E   S   *
     C*                    (C-Specs -- KLISTs)                           *
     C*                                                                  *
     C********************************************************************
     C*
     C/COPY ZSRSRC,FFSETLZ2
     C/COPY ZSRSRC,FFSETLZ3
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C**           W   O   R   K        F   I   E   L   D   S            *
     C*                                                                  *
     C********************************************************************
     C*
     C           *LIKE     DEFN NCCL4     NCCLW            WORK NCCL 4/5
     C           *LIKE     DEFN TRTY4     TRTYW            WORK TRTY 4/5
     C           *LIKE     DEFN FCLI4     FCLIW            WORK FCLI 4/5
     C           *LIKE     DEFN BMARP     BMARW            WORK BMAR P/S
     C           *LIKE     DEFN CMARP     CMARW            WORK CMAR P/S
     C           *LIKE     DEFN NCCL4     T4CNT            RUNNING TOT of
     C           *LIKE     DEFN NCCL4     T5CNT             UNMTCHD CONTRs
     C           *LIKE     DEFN NCCL4     MATCON           MATCHD CONTRCTS
     C*
     C           *LIKE     DEFN BMARP     BMAPX            } MARGIN VALUES
     C           *LIKE     DEFN BMARS     BMASX            } PRIOR TO TRSET
     C           *LIKE     DEFN CMARP     CMAPX            } UPDATE - USED
     C           *LIKE     DEFN CMARS     CMASX            } IN POSTN CALC
     C*
     C           *LIKE     DEFN NCCL4     CCSC4
     C           *LIKE     DEFN NCCL4     CCSC5            see P2452 spec
     C**                                  Cls-Cons-Same-Cust for clost4/5
     C**                                  -   -    -    -
     C*
     C           *LIKE     DEFN NCCL4     OCSC4
     C           *LIKE     DEFN NCCL4     OCSC5            see P2452 spec
     C**                                  Opn-Cons-Same-Cust for clost4/5
     C**                                  -   -    -    -
     C*
     C           *LIKE     DEFN NCCL4     CCSB4
     C           *LIKE     DEFN NCCL4     CCSB5            see P2452 spec
     C**                                  Cls-Cons-Same-Brok for clost4/5
     C**                                  -   -    -    -
     C*
     C           *LIKE     DEFN NCCL4     OCSB4
     C           *LIKE     DEFN NCCL4     OCSB5            see P2452 spec
     C**                                  Opn-Cons-Same-Brok for clost4/5
     C**                                  -   -    -    -
     C*
     C           *LIKE     DEFN NCCL4     CCTC4
     C           *LIKE     DEFN NCCL4     CCTC5            see P2452 spec
     C**                                 Cls-Cons-sTand-Cust for clost4/5
     C**                                 -   -    -     -
     C*
     C           *LIKE     DEFN NCCL4     OCTC4
     C           *LIKE     DEFN NCCL4     OCTC5            see P2452 spec
     C**                                 Opn-Cons-sTand-Cust for clost4/5
     C**                                 -   -    -     -
     C*
     C           *LIKE     DEFN NCCL4     CCTB4
     C           *LIKE     DEFN NCCL4     CCTB5            see P2452 spec
     C**                                 Cls-Cons-sTand-Brok for clost4/5
     C**                                 -   -    -     -
     C*
     C           *LIKE     DEFN NCCL4     OCTB4
     C           *LIKE     DEFN NCCL4     OCTB5            see P2452 spec
     C**                                 Opn-Cons-sTand-Brok for clost4/5
     C**                                 -   -    -     -
     C           *LIKE     DEFN LOCO      TPCC
     C           *LIKE     DEFN SOCO      TSCC             see P2460/5 spc
     C**                                Total-Purch/Sales-Contracts-Closed
     C**                                -     -     -     -         -
     C*
     C           *LIKE     DEFN CUTV      TCCTVP
     C           *LIKE     DEFN CUTV      TCCTVS           see P2460/5 spc
     C**                      Total-Change-Current-Total-Value-Purch/Sales
     C**                      -     -      -       -     -     -     -
     C*
     C           *LIKE     DEFN TOTM      TCBMPY
     C           *LIKE     DEFN TOTM      TCCMPY           see P2460/5 spc
     C**                    Total-Change-in-Broker/Customer-Margin-PaYable
     C**                    -     -         -      -        -      - -
     C*
     C           *LIKE     DEFN LOCO      TCBMLO
     C           *LIKE     DEFN SOCO      TCBMSO
     C           *LIKE     DEFN LOCO      TCCMLO
     C           *LIKE     DEFN SOCO      TCCMSO           see P2460/5 spc
     C**  Total-Change-in-Broker/Customer-Margin-Long/Short-Open-contracts
     C**  -     -         -      -        -      -    -     -
     C*
     C           *LIKE     DEFN FFPREM    PREMMP           Premium - purch.
     C           *LIKE     DEFN FFPREM    PREMMS           Premium - sale
     C*
     C*
     C* FFSETL return values for Broker
     C*                          ------
     C           *LIKE     DEFN FFBRCB    FBBRCB           Branch Code    S01117
     C           *LIKE     DEFN FFCNUM    FBCNUM           Customer Number
     C           *LIKE     DEFN FFACOD    FBACOD           Account Code
     C           *LIKE     DEFN FFACSQ    FBACSQ           Account Sequenc
     C           *LIKE     DEFN FFMIND    FBMIND           Memos Updt Ind
     C           *LIKE     DEFN FFPIND    FBPIND           Prono Updt Ind
     C           *LIKE     DEFN FFNOSN    FBNOSN           Nostro number
     C*
     C* FFSETL return values for Customer
     C*                          --------
     C           *LIKE     DEFN FFBRCB    FCBRCB           Branch Code    S01117
     C           *LIKE     DEFN FFCNUM    FCCNUM           Customer Number
     C           *LIKE     DEFN FFACOD    FCACOD           Account Code
     C           *LIKE     DEFN FFACSQ    FCACSQ           Account Sequenc
     C           *LIKE     DEFN FFMIND    FCMIND           Memos Updt Ind
     C           *LIKE     DEFN FFPIND    FCPIND           Prono Updt Ind
     C           *LIKE     DEFN FFNOSN    FCNOSN           Nostro number
     C*                          --------                                 S01240
     C           *LIKE     DEFN MVAM      CHGBAL           chg in acc bal.S01240
     C           *LIKE     DEFN CUSN      @CUSN                           S01240
     C           *LIKE     DEFN CCYD      @CCYD                           S01240
     C           *LIKE     DEFN ACDE      @ACDE                           S01240
     C           *LIKE     DEFN ASNC      @ASNC                           S01240
     C/SPACE 2
     C********************************************************************
     C*                                                                  *
     C**      C   O   N   T   R   O   L        F   I   E   L   D   S     *
     C*                                                                  *
     C********************************************************************
     C*
     C************LIKE     DEFN BRCD      @BRCD            BRANCH         S01117
     C           *LIKE     DEFN BRCA      @BRCD            BRANCH         S01117
     C           *LIKE     DEFN BOCO      @BOCO            BROKER
     C           *LIKE     DEFN CUSC      @CUSC            CUSTOMER
     C           *LIKE     DEFN ISTT      @ISTT            INSTRUMENT TYPE
     C/SPACE 2
     C********************************************************************
     C*                                                                  *
     C**      K   E   Y        L   I   S   T   S                         *
     C*                                                                  *
     C********************************************************************
     C*                                                                  *
     C/SPACE 1
     C           *LIKE     DEFN BRCA      KBRCA                           S01117
     C           *LIKE     DEFN CNUM      KCNUM
     C           *LIKE     DEFN ISCY      KCCY
     C           *LIKE     DEFN ACOD      KACOD
     C           *LIKE     DEFN ACSQ      KACSQ
     C           *LIKE     DEFN CUSC      KCBCD
     C           *LIKE     DEFN REQMKT    KMRKT
     C           *LIKE     DEFN ISTCC     KISTC
     C           *LIKE     DEFN ISCY      KCCY@
     C           *LIKE     DEFN NOSN      KNOSN
     C/SPACE 1
     C*                                                                  *
     C**   LF/DEFLT (Broker or Client)
     C*
     C           KDEFLT    KLIST
     C                     KFLD           KCBCD
     C                     KFLD           KMRKT
     C                     KFLD           KISTC
     C/SPACE 1
     C**   LF/MEMOSM
     C*
     C           KMEMSM    KLIST
     C                     KFLD           KBRCA                           S01117
     C                     KFLD           KCNUM
     C                     KFLD           KCCY
     C                     KFLD           KACOD
     C                     KFLD           KACSQ
     C/SPACE 1
     C**   LF/PRONOM
     C*
     C           KPRONM    KLIST
     C                     KFLD           KCCY@
     C                     KFLD           KNOSN
     C/SPACE 1
     C**   LF/POSTNC
     C*
     C           KPSTNC    KLIST
     C***********          KFLD           KBRCDC                          S01117
     C                     KFLD           KBRCAC                          S01117
     C                     KFLD           KCBCDC
     C                     KFLD           KISTTC
     C                     KFLD           KYRNOC
     C                     KFLD           KMTHNC
     C                     KFLD           KPCALC
     C                     KFLD           KSTRPC
     C/SPACE 1
     C**   LF/POSTNK
     C*
     C           KPSTNK    KLIST
     C***********          KFLD           KBRCDK                          S01117
     C                     KFLD           KBRCAK                          S01117
     C                     KFLD           KBOKCK
     C                     KFLD           KISTTK
     C                     KFLD           KYRNOK
     C                     KFLD           KMTHNK
     C                     KFLD           KPCALK
     C                     KFLD           KSTRPK
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**      M  A  I  N     P  R  O  C  E  S  S  I  N  G                *
     C**                                                                 *
     C********************************************************************
     C*
     C**   Receive  Parameters
     C*
     C**   ( REQMKT = Market Centre Code, blank for OTCs )
     C           *ENTRY    PLIST
     C                     PARM           REQMKT  2
     C                     PARM           RTNCD   10
     C*
     C**   Initialisation Routines
     C*
     C                     EXSR INIT
     C*
     C**   Main Loop
     C*
     C           *IN78     DOWNE'1'                        *IN78=EOF CLOST
     C*
     C** Next transaction number off DTAARA-MNATN
     C*
     C                     EXSR ZTNLU1
     C*
     C***********BRCD      IFNE @BRCD                                     S01117
     C           BRCA6     IFNE @BRCD                                     S01117
     C                     EXSR RDTABR
     C                     EXSR RDBROK
     C                     EXSR RDCUST
     C                     EXSR INSTSR
     C                     ELSE
     C*
     C           BOCO      IFNE @BOCO
     C                     EXSR RDBROK
     C                     EXSR RDCUST
     C                     EXSR INSTSR
     C                     ELSE
     C*
     C           CUSC      IFNE @CUSC
     C                     EXSR RDCUST
     C                     EXSR INSTSR
     C                     ELSE
     C*
     C           ISTT      IFNE @ISTT
     C                     EXSR INSTSR
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C                     EXSR P2450
     C*
     C                     COMIT
     C*
     C** Store controls
     C*
     C***********          MOVE BRCD      @BRCD                           S01117
     C                     MOVE BRCA6     @BRCD                           S01117
     C                     MOVE BOCO      @BOCO
     C                     MOVE CUSC      @CUSC
     C                     MOVE ISTT      @ISTT
     C*
     C** Main read for primary input LF/CLOST6
     C*
     C                     EXSR RD6
     C                     END
     C*
     C                     SETON                         LR
     C/EJECT
     C*
     C*
     C********************************************************************
     C**                                                                 *
     C**             S  U  B  R  O  U  T  I  N  E  S                     *
     C**                                                                 *
     C********************************************************************
     C*
     C*================================================================
      **
      ** MAIN PROCESSING OF PROGRAM
      ** CALLED FROM INITIAL STRUCTURE
      ** CALLS:
      **        P2451 - CLOSTT processing
      **        P2462 - Determine if MEMOSM or PRONOM processing needed
      **        P2463 - Update MEMOSM
      **        P2464 - Update PRONOM
      **        P2465 - Update POSTNx
      **        U2450 - Update close-out-set detail
      **
     C*================================================================
     C*
     C           P2450     BEGSR                                     P2450
     C**
     C*
     C** Read through all LF/CLOST4 & LF/CLOST5 records for all close
     C** out transactions in this close out set
     C*
     C                     EXSR P2451
     C*
     C** Determine if MEMOSM & PRONOM updating required if Instrument
     C** type is a future
     C*
     C           ISPT      IFLE 3                          Future = 1,2,3
     C           ISPT      OREQ 7                                         AUS022
     C                     EXSR P2462
     C*
     C** FFMIND = Y if MEMOSM;  set by P2462   (Customer or Broker)
     C** Shadow post the close out realised profit/loss
     C** And write the corresponding movement to ffacmvd                  S01240
     C*
     C           FCMIND    IFEQ 'Y'
     C           FBMIND    OREQ 'Y'
     C                     EXSR P2463
     C                     END
     C*
     C** FFPIND = Y if PRONOM;  set by P2462   (Customer or Broker)
     C** Shadow post the close out realised profit/loss
     C** And write the corresponding movement to ffacmvd                  S01240
     C*
     C           FCPIND    IFEQ 'Y'
     C           FBPIND    OREQ 'Y'
     C                     EXSR P2464
     C                     END
     C**
     C                     END
     C*
     C** Update POSTN broker customer & book instruments positions
     C*
     C                     EXSR P2465
     C*
     C** Update CLOST6 close out detail record
     C*
     C                     EXSR U2450
     C**
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** CLOSTT PROCESSING
      ** CALLED FROM
      **             P2450 - Main Processing of program
      ** CALLS:
      **        P2452 - CLOST4 Settlement
      **        P2453 - CLOST5 Settlement
      **        P2454 - Finish CLOST4
      **        P2455 - Finish CLOST5
      **        RD4   - Read next CLOST4 record
      **                      and associated TRANS and TRSET records
      **        RD5   - Read next CLOST5 record
      **                      and associated TRANS and TRSET records
      **
     C*================================================================
     C*
     C           P2451     BEGSR                                     P2451
     C*
     C** Position CLOST4 pointer at beginning of group
     C** and EXSR RD4 which
     C**   Reads first CLOST4 (Purchases) record for this set
     C**        and corresponding TRANS (transaction) record
     C**        and corresponding TRSET (settlement) record
     C*
     C           CLON      SETLLCLOST4                   77
     C           *IN77     IFNE '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD11        DBASE            ***************
     C                     MOVEL'CLST4'   DBFILE           **DB ERROR 11**
     C                     MOVELCLON      DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C*
     C                     ELSE
     C                     EXSR RD4
     C                     END
     C*
     C*
     C** Position CLOST5 pointer at beginning of group
     C** and EXSR RD5 which
     C**   Read first CLOST5 (Sales) record for this set
     C**        and corresponding TRANS (transaction) record
     C**        and corresponding TRSET (settlement) record
     C*
     C           CLON      SETLLCLOST5                   77
     C           *IN77     IFNE '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD12        DBASE            ***************
     C                     MOVEL'CLST5'   DBFILE           **DB ERROR 12**
     C                     MOVELCLON      DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C*
     C                     ELSE
     C                     EXSR RD5
     C                     END
     C*
     C** Match purchase/sales for this transaction
     C*
     C           CLON4     DOWEQCLON5
     C           CLON4     ANDEQCLON
     C*
     C** Find number of matched contracts
     C*
     C           T5CNT     IFLT T4CNT
     C                     MOVE T5CNT     MATCON
     C                     ELSE
     C                     MOVE T4CNT     MATCON
     C                     END
     C*
     C** Decide whether purchase or sale exhausted
     C*
     C                     MOVELTRSD4     NDT4   110
     C                     MOVE TNBR4     NDT4
     C                     MOVELTRSD5     NDT5   110
     C                     MOVE TNBR5     NDT5
     C*
     C** Transaction numbers may be negative ( at maturity)
     C*
     C           NDT4      IFLT *ZERO
     C                     Z-SUBNDT4      NDT4
     C                     END
     C           NDT5      IFLT *ZERO
     C                     Z-SUBNDT5      NDT5
     C                     END
     C*
     C           NDT4      IFGT NDT5
     C*
     C** Shadow post CLOST4 & CLOST5 premiums to CLOST4 settlement account
     C** if close out is for options and accumulate commision contracts
     C*
     C                     EXSR P2452
     C                     ELSE
     C*
     C** Shadow post CLOST4 & CLOST5 premiums to CLOST5 settlement account
     C** if close out is for options and accumulate commision contracts
     C*
     C                     EXSR P2453
     C                     END
     C*
     C** CLOST4 complete?
     C*
     C                     SUB  MATCON    T4CNT
     C           T4CNT     IFEQ *ZERO
     C*
     C** Update LF/TRSET for CLOST4 transaction, accumulate changes in
     C** position details due to closure of this transaction and read
     C** next record off LF/CLOST4
     C*
     C                     EXSR P2454
     C                     END
     C*
     C** CLOST5 complete?
     C*
     C                     SUB  MATCON    T5CNT
     C           T5CNT     IFEQ *ZERO
     C*
     C** Update LF/TRSET for CLOST5 transaction, accumulate changes in
     C** position details due to closure of this transaction and read
     C** next record off LF/CLOST5
     C*
     C                     EXSR P2455
     C                     END
     C*
     C                     END
     C*
     C** DB error if Sales and Purchases did not reach end-of-group
     C**  simultaneosly, or if there are any outstanding contracts
     C*
     C           CLON      IFEQ CLON4
     C           CLON      OREQ CLON5
     C           T4CNT     ORNE *ZERO
     C           T5CNT     ORNE *ZERO
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD17        DBASE            ***************
     C                     MOVEL'CL4/5'   DBFILE           **DB ERROR 17**
     C                     MOVELCLON4     DBKEY            ***************
     C                     MOVE CLON5     DBKEY
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C*
     C                     END
     C**
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** CLOST4 Settlement
      ** CALLED FROM
      **             P2451 - CLOSTT processing
      ** CALLS:
      **        P2456 - Calc Premium
      **        P2457 - Determine if MEMOSM or PRONOM
      **********P2458*-*Update*MEMOSM*                                    S01240
      **********P2459*-*Update*PRONOM*                                    S01240
      **        P2458 - Update MEMOSM and FFACMVD                         S01240
      **        P2459 - Update PRONOM and FFACMVD                         S01240
      **
     C*================================================================
     C*
     C           P2452     BEGSR                                     P2452
     C*
     C** Is instrument an option, and premium not paid?
     C*
     C           ISPT      IFGE 4
     C           ISPT      ANDNE7                                         AUS022
     C           PUPF      ANDEQ'N'
     C*
     C** Calc premium for Purchases and Sales
     C*
     C                     Z-ADDMATCON    FFNOC
     C                     Z-ADDCOPRP     FFPRIC
     C                     Z-ADDSTRPP     FFSTRP                          136056
     C                     EXSR P2456
     C                     Z-ADDFFPREM    PREMMP
     C*
     C                     Z-ADDMATCON    FFNOC
     C                     Z-ADDCOPRS     FFPRIC
     C                     Z-ADDSTRPS     FFSTRP                          136056
     C                     EXSR P2456
     C                     Z-ADDFFPREM    PREMMS
     C*
     C** Determine if MEMOSM, PRONOM or both to be updated
     C**                                                  (for Broker)
     C*
     C                     MOVE 'N'       FBMIND
     C                     MOVE 'N'       FBPIND
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**     Update if Close out type is not 'X' (for match)
     C*
     C           CLOT      ANDNE'X'
     C**********           Z-ADDBOCO      FFCBCD                                              CSD027
     C                     MOVE BOCO      FFCBCD                                              CSD027
     C                     MOVE 'Y'       FFBRKI
     C                     Z-ADDBSLTP     FFSETP
     C                     MOVE BSLAP     FFSETA
     C                     MOVE BSBRP     FFSETB                          S01117
     C                     EXSR P2457
     C*
     C** Save result
     C*
     C                     MOVE FFBRCB    FBBRCB                          S01117
     C                     MOVE FFCNUM    FBCNUM
     C                     MOVE FFACOD    FBACOD
     C                     MOVE FFACSQ    FBACSQ
     C                     MOVE FFNOSN    FBNOSN
     C                     MOVE FFMIND    FBMIND
     C                     MOVE FFPIND    FBPIND
     C                     END
     C*
     C** Determine if MEMOSM, PRONOM or both to be updated
     C**                                                  (for Client)
     C*
     C********** CUSC      IFEQ *ZERO                                                         CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'N'       FCMIND
     C                     MOVE 'N'       FCPIND
     C*
     C                     ELSE
     C**********           Z-ADDCUSC      FFCBCD                                              CSD027
     C                     MOVE CUSC      FFCBCD                                              CSD027
     C                     MOVE 'N'       FFBRKI
     C                     Z-ADDCSLTP     FFSETP
     C                     MOVE CSLAP     FFSETA
     C                     MOVE BRSCP     FFSETB                          S01117
     C                     EXSR P2457
     C*
     C** Save result
     C*
     C                     MOVE FFBRCB    FCBRCB                          S01117
     C                     MOVE FFCNUM    FCCNUM
     C                     MOVE FFACOD    FCACOD
     C                     MOVE FFACSQ    FCACSQ
     C                     MOVE FFNOSN    FCNOSN
     C                     MOVE FFMIND    FCMIND
     C                     MOVE FFPIND    FCPIND
     C                     END
     C*
     C*                                                                   S01240
     C***Update*MEMOSM*for*Client*(if req)*                               S01240
     C***Update*MEMOSM*for*Broker*(if req)*                               S01240
     C*                                                                   S01240
     C** Update MEMOSM and FFACMVD for Client (if req)                    S01240
     C** Update MEMOSM and FFACMVD for Broker (if req)                    S01240
     C*
     C           FCMIND    IFEQ 'Y'
     C           FBMIND    OREQ 'Y'
     C                     EXSR P2458
     C                     END
     C*
     C***Update*PRONOM*for*Client*(if req)                                S01240
     C***Update*PRONOM*for*Broker*(if req)                                S01240
     C*
     C** Update PRONOM and FFACMVD for Client (if req)                    S01240
     C** Update PRONOM and FFACMVD for Broker (if req)                    S01240
     C*                                                                   S01240
     C           FCPIND    IFEQ 'Y'
     C           FBPIND    OREQ 'Y'
     C                     EXSR P2459
     C                     END
     C**
     C                     END
     C/SPACE 2
     C*
     C** If transaction dates equal (CLOST4/5)
     C**    update SAME DAY commission totals
     C*
     C           TRSD4     IFEQ TRSD5
     C*
     C**     Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     ADD  MATCON    CCSC4
     C                     ADD  MATCON    OCSC5
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOC4                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOC5                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C**     Broker involved?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**     Update if instrument is a future or
     C**     instrument is an option & broker is Positions Combined:NO
     C**     or close out type is 'X' (for match)
     C*
     C           ISPT      IFLE 3
     C           ISPT      OREQ 7                                         AUS022
     C           ISPT      ORGT 3
     C           ISPT      ANDNE7                                         AUS022
     C           PSCIB     ANDEQ'N'
     C           CLOT      OREQ 'X'
     C                     ADD  MATCON    CCSB4
     C                     ADD  MATCON    OCSB5
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOB4                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOB5                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C                     END
     C** else
     C**    update STANDARD commission totals
     C                     ELSE
     C*
     C**     Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     ADD  MATCON    CCTC4
     C                     ADD  MATCON    OCTC5
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOC4                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOC5                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C**     Broker involved?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**     Update if instrument is a future or
     C**     instrument is an option & broker is Positions Combined:NO
     C**     or close out type is 'X' (for match)
     C*
     C           ISPT      IFLE 3
     C           ISPT      OREQ 7                                         AUS022
     C           ISPT      ORGT 3
     C           ISPT      ANDNE7                                         AUS022
     C           PSCIB     ANDEQ'N'
     C           CLOT      OREQ 'X'
     C                     ADD  MATCON    CCTB4
     C                     ADD  MATCON    OCTB5
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOB4                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOB5                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C                     END
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** CLOST5 Settlement
      ** CALLED FROM
      **             P2451 - CLOSTT processing
      ** CALLS:
      **        P2456 - Calc Premium
      **        P2457 - Determine if MEMOSM or PRONOM
      **        P2458 - Update MEMOSM
      **        P2459 - Update PRONOM
      **
     C*================================================================
     C*
     C           P2453     BEGSR                                     P2453
     C*
     C** Is instrument an option, and premium not paid?
     C*
     C           ISPT      IFGE 4
     C           ISPT      ANDNE7                                         AUS022
     C           PUPF      ANDEQ'N'
     C*
     C** Calc premium for Purchases and Sales
     C*
     C                     Z-ADDMATCON    FFNOC
     C                     Z-ADDCOPRP     FFPRIC
     C                     Z-ADDSTRPP     FFSTRP                          136056
     C                     EXSR P2456
     C                     Z-ADDFFPREM    PREMMP
     C*
     C                     Z-ADDMATCON    FFNOC
     C                     Z-ADDCOPRS     FFPRIC
     C                     Z-ADDSTRPS     FFSTRP                          136056
     C                     EXSR P2456
     C                     Z-ADDFFPREM    PREMMS
     C*
     C** Determine if MEMOSM, PRONOM or both to be updated
     C**                                                  (for Broker)
     C*
     C                     MOVE 'N'       FBMIND
     C                     MOVE 'N'       FBPIND
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**     Update if Close out type is not 'X' (for match)
     C*
     C           CLOT      ANDNE'X'
     C**********           Z-ADDBOCO      FFCBCD                                              CSD027
     C                     MOVE BOCO      FFCBCD                                              CSD027
     C                     MOVE 'Y'       FFBRKI
     C                     Z-ADDBSLTS     FFSETP
     C                     MOVE BSLAS     FFSETA
     C                     MOVE BSBRS     FFSETB                          S01117
     C                     EXSR P2457
     C*
     C** Save result
     C*
     C                     MOVE FFBRCB    FBBRCB                          S01117
     C                     MOVE FFCNUM    FBCNUM
     C                     MOVE FFACOD    FBACOD
     C                     MOVE FFACSQ    FBACSQ
     C                     MOVE FFNOSN    FBNOSN
     C                     MOVE FFMIND    FBMIND
     C                     MOVE FFPIND    FBPIND
     C                     END
     C*
     C** Determine if MEMOSM, PRONOM or both to be updated
     C**                                                  (for Client)
     C*
     C********** CUSC      IFEQ *ZERO                                                         CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'N'       FCMIND
     C                     MOVE 'N'       FCPIND
     C*
     C                     ELSE
     C**********           Z-ADDCUSC      FFCBCD                                              CSD027
     C                     MOVE CUSC      FFCBCD                                              CSD027
     C                     MOVE 'N'       FFBRKI
     C                     Z-ADDCSLTS     FFSETP
     C                     MOVE CSLAS     FFSETA
     C                     MOVE BRSCS     FFSETB                          S01117
     C                     EXSR P2457
     C*
     C** Save result
     C*
     C                     MOVE FFBRCB    FCBRCB                          S01117
     C                     MOVE FFCNUM    FCCNUM
     C                     MOVE FFACOD    FCACOD
     C                     MOVE FFACSQ    FCACSQ
     C                     MOVE FFNOSN    FCNOSN
     C                     MOVE FFMIND    FCMIND
     C                     MOVE FFPIND    FCPIND
     C                     END
     C*
     C** Update MEMOSM for Client (if req)
     C** Update MEMOSM for Broker (if req)
     C*
     C           FCMIND    IFEQ 'Y'
     C           FBMIND    OREQ 'Y'
     C                     EXSR P2458
     C                     END
     C*
     C** Update PRONOM for Client (if req)
     C** Update PRONOM for Broker (if req)
     C*
     C           FCPIND    IFEQ 'Y'
     C           FBPIND    OREQ 'Y'
     C                     EXSR P2459
     C                     END
     C**
     C                     END
     C/SPACE 2
     C*
     C** If transaction dates equal (CLOST4/5)
     C**    update SAME DAY commission totals
     C*
     C           TRSD5     IFEQ TRSD4
     C*
     C**     Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     ADD  MATCON    CCSC5
     C                     ADD  MATCON    OCSC4
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOC5                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOC4                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C**     Broker involved?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**     Update if instrument is a future or
     C**     instrument is an option & broker is Positions Combined:NO
     C**     or close out type is 'X' (for match)
     C*
     C           ISPT      IFLE 3
     C           ISPT      OREQ 7                                         AUS022
     C           ISPT      ORGT 3
     C           ISPT      ANDNE7                                         AUS022
     C           PSCIB     ANDEQ'N'
     C           CLOT      OREQ 'X'
     C                     ADD  MATCON    CCSB5
     C                     ADD  MATCON    OCSB4
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOB5                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOB4                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C                     END
     C** else
     C**    update STANDARD commission totals
     C                     ELSE
     C*
     C**     Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     ADD  MATCON    CCTC5
     C                     ADD  MATCON    OCTC4
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOC5                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the customer                               E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOC4                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C**     Broker involved?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**     Update if instrument is a future or
     C**     instrument is an option & broker is Positions Combined:NO
     C**     or close out type is 'X' (for match)
     C*
     C           ISPT      IFLE 3
     C           ISPT      OREQ 7                                         AUS022
     C           ISPT      ORGT 3
     C           ISPT      ANDNE7                                         AUS022
     C           PSCIB     ANDEQ'N'
     C           CLOT      OREQ 'X'
     C                     ADD  MATCON    CCTB5
     C                     ADD  MATCON    OCTB4
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of closing contracts for the trade from clost5 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @CCOB5                          E03643
     C*                                                                   E03643
     C** Add the no. of matched contracts to the running total of         E03643
     C** the no of opening contracts for the trade from clost4 within     E03643
     C** the closeout. NB. for the broker                                 E03643
     C*                                                                   E03643
     C                     ADD  MATCON    @OCOB4                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C                     END
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Finish CLOST4 Record
      ** CALLED FROM
      **             P2451 - CLOSTT processing
      ** CALLS:
      **        P2460 - Accumulate POSTN change
      **        U2452 - Update TRSET
      **        UCLOP - Update CLOST4                                     E03643
      **        RD4   - Read next CLOST4 record
      **                      and associated TRANS and TRSET records
      **
     C*================================================================
     C*
     C           P2454     BEGSR                                     P2454
     C*
     C** Set CLOST4/5 ind
     C*
     C                     MOVE '4'       IND4@5  1
     C*
     C** Update TRSET - commission details and margin amounts if nec.
     C*
     C                     EXSR U2452
     C*                                                                   E03643
     C** Update CLOST4- no of opening and closing contracts for trade     E03643
     C**                within close out.                                 E03643
     C*                                                                   E03643
     C                     EXSR UCLOP                                     E03643
     C*
     C** Accumulate POSTN change
     C*
     C                     EXSR P2460
     C*
     C** Read next CLOST4 record and assoc TRANS and TRSET records
     C*
     C                     EXSR RD4
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Finish CLOST5 Record
      ** CALLED FROM
      **             P2451 - CLOSTT processing
      ** CALLS:
      **        P2460 - Accumulate POSTN change
      **        U2452 - Update TRSET
      **        UCLOS - Update CLOST5
      **        RD5   - Read next CLOST5 record
      **                      and associated TRANS and TRSET records
      **
     C*================================================================
     C*
     C           P2455     BEGSR                                     P2455
     C*
     C** Set CLOST4/5 ind
     C*
     C                     MOVE '5'       IND4@5
     C*
     C** Update TRSET - commission details and margin amounts if nec.
     C*
     C                     EXSR U2452
     C*                                                                   E03643
     C** Update CLOST5- no of opening and closing contracts for trade     E03643
     C**                within close out.                                 E03643
     C*                                                                   E03643
     C                     EXSR UCLOS                                     E03643
     C*
     C** Accumulate POSTN change
     C*
     C                     EXSR P2460
     C*
     C** Read next CLOST5 record and assoc TRANS and TRSET records
     C*
     C                     EXSR RD5
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================   E03643
     C**                                                                  E03643
     C** Update CLOST5                                                    E03643
     C** CALLED FROM                                                      E03643
     C**             P2455 - Finish CLOST5                                E03643
     C** CALLS:                                                           E03643
     C**        (None)                                                    E03643
     C**                                                                  E03643
     C*================================================================   E03643
     C           UCLOS     BEGSR                                          E03643
     C*                                                                   E03643
     C** Update (LF/CLOST5)                                               E03643
     C*                                                                   E03643
     C                     Z-ADD@OCOB5    OCOB5                           E03643
     C                     Z-ADD@CCOB5    CCOB5                           E03643
     C                     Z-ADD@OCOC5    OCOC5                           E03643
     C                     Z-ADD@CCOC5    CCOC5                           E03643
     C*                                                                   E03643
     C                     EXCPTECLOSS                                    E03643
     C*                                                                   E03643
     C*                                                                   E03643
     C*                                                                   E03643
     C                     ENDSR                                          E03643
     C*================================================================
     C/EJECT                                                              E03643
      **
      ** Calculate Premiums
      ** CALLED FROM
      **             P2452 - CLOST4 Settlement
      **             P2453 - CLOST5 Settlement
      ** CALLS:
      **        FFPMCL - Premium Calculation
      **
     C*================================================================
     C*
     C           P2456     BEGSR                                     P2456
     C*
     C** Set up parms, and call standard subroutine
     C*
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     EXSR FFPMCL
      **                                                                                      247296
      **   for processing type 5 (CCY OTC), divide premium by 100                             247296
     C           ISPT      IFEQ 5                                                             247296
     C           FFPREM    DIV  100       FFPREM                                              247296
     C                     ENDIF                                                              247296
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Determine if Memo/Prono settlement
      ** CALLED FROM
      **             P2452 - CLOST4 Settlement
      **             P2453 - CLOST5 Settlement
      ** CALLS:
      **        FFSETL - Determine if Memo/Prono settlement
      **
     C*================================================================
     C*
     C           P2457     BEGSR                                     P2457
     C*
     C** Set up parms (search argument)
     C** FFCBCD FFBRKI FFSETP and FFSETA set up at CALL
     C*
     C***********          Z-ADDBRCD      FFBRCD                          S01117
     C                     MOVE BRCA6     FFBRCA                          S01117
     C                     MOVE ISCY      FFCCY
     C*
     C***********MBIN      IFEQ 'Y'                                       S01117
     C***********          Z-ADDNSACS     FFDASQ                          S01117
     C***********          ELSE                                           S01117
     C***********          MOVE 01        FFDASQ                          S01117
     C***********          END                                            S01117
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFSETL
     C*
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Update LF/MEMOSM transaction
      ** And write a corresponding account movement to ffacmvd            S01240
      ** CALLED FROM
      **             P2452 - CLOST4 Settlement
      **             P2453 - CLOST5 Settlement
      ** CALLS:
      **        U2453  - Update MEMOSM
      **        W2453  - Write  MEMOSM
      **        W2455  - Write  FFACMVD                                   S01240
      **        RDMEMO - Read   MEMOSM
      **
     C*================================================================
     C*
     C           P2458     BEGSR                                     P2458
     C*
     C** Broker involved, and retail account?
     C           FBMIND    IFEQ 'Y'
     C*
     C** Access Retail Account Shadow Balance (LF/MEMOSM)
     C*
     C                     MOVE FBBRCB    KBRCA                           S01117
     C                     MOVE FBCNUM    KCNUM
     C                     MOVE ISCY      KCCY
     C                     MOVE FBACOD    KACOD
     C                     MOVE FBACSQ    KACSQ
     C                     EXSR RDMEMO
     C*
     C** If not found zeroise ledger and closing balances
     C*
     C           MEXIST    IFNE 'Y'
     C                     MOVE *ZERO     LDBL
     C                     MOVE *ZERO     CLBL
     C                     END
     C*
     C** If purchase add premium to ledger and closing balances
     C*
     C                     SUB  PREMMP    LDBL
     C                     SUB  PREMMP    CLBL
     C*
     C** If sale subtract
     C*
     C                     ADD  PREMMS    LDBL
     C                     ADD  PREMMS    CLBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C           PREMMS    SUB  PREMMP    CHGBAL                          S01240
     C*
     C** If MEMOSM record exists update it, otherwise write one
     C*
     C           MEXIST    IFEQ 'Y'
     C                     EXSR U2453
     C/SPACE 1
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE FBBRCB    BRCA                            S01117
     C                     MOVE FBCNUM    CNUM
     C                     MOVE ISCY      CCY
     C                     MOVE FBACOD    ACOD
     C                     MOVE FBACSQ    ACSQ
     C                     EXSR W2453
     C                     END
     C*
     C** If the broker settlement account is not also a nostro write      S01240
     C** an account movement record to ffacmvd.                           S01240
     C*                                                                   S01240
     C           FBPIND    IFNE 'Y'                                       S01240
     C*                                                                   S01240
     C                     MOVE FBBRCB    @BRCA                           FO0017
     C                     MOVE FBCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FBACOD    @ACDE                           S01240
     C                     MOVE FBACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C*                                                                   S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C                     END
     C/SPACE 1
     C*=Para 2=========================================================
     C** Customer involved, and retail account?
     C*
     C           FCMIND    IFEQ 'Y'
     C*
     C** Access Retail Account Shadow Balance (LF/MEMOSM)
     C*
     C                     MOVE FCBRCB    KBRCA                           S01117
     C                     MOVE FCCNUM    KCNUM
     C                     MOVE ISCY      KCCY
     C                     MOVE FCACOD    KACOD
     C                     MOVE FCACSQ    KACSQ
     C                     EXSR RDMEMO
     C*
     C** If not found zeroise ledger and closing balances
     C*
     C           MEXIST    IFNE 'Y'
     C                     MOVE *ZERO     LDBL
     C                     MOVE *ZERO     CLBL
     C                     END
     C*
     C** Book involved?
     C*
     C**  No
     C           BOKC      IFEQ *BLANK
     C*
     C** If purchase subtract premium from ledger and cleared balances
     C*
     C                     ADD  PREMMP    LDBL
     C                     ADD  PREMMP    CLBL
     C*
     C** If sale subtract
     C*
     C                     SUB  PREMMS    LDBL
     C                     SUB  PREMMS    CLBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C           PREMMP    SUB  PREMMS    CHGBAL                          S01240
     C/SPACE 1
     C**  Yes
     C                     ELSE
     C*                    ----
     C*
     C** If purchase add premium to ledger and cleared balances
     C*
     C                     SUB  PREMMP    LDBL
     C                     SUB  PREMMP    CLBL
     C*
     C** If sale subtract
     C*
     C                     ADD  PREMMS    LDBL
     C                     ADD  PREMMS    CLBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C           PREMMS    SUB  PREMMP    CHGBAL                          S01240
     C**
     C                     END
     C*
     C** If MEMOSM record exists update it, otherwise write one
     C*
     C           MEXIST    IFEQ 'Y'
     C                     EXSR U2453
     C*
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE FCBRCB    BRCA                            S01117
     C                     MOVE FCCNUM    CNUM
     C                     MOVE ISCY      CCY
     C                     MOVE FCACOD    ACOD
     C                     MOVE FCACSQ    ACSQ
     C                     EXSR W2453
     C                     END
     C*                                                                   S01240
     C** If the customer settlement account is not also a nostro write    S01240
     C** an account movement record to ffacmvd.                           S01240
     C*                                                                   S01240
     C           FCPIND    IFNE 'Y'                                       S01240
     C*                                                                   S01240
     C                     MOVE FCBRCB    @BRCA                           FO0017
     C                     MOVE FCCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FCACOD    @ACDE                           S01240
     C                     MOVE FCACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C*                                                                   S01240
     C                     END                                            S01240
     C*
     C                     END
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Update LF/PRONOM transaction
      ** And write a corresponding account movement to ffacmvd            S01240
      ** CALLED FROM
      **             P2452 - CLOST4 Settlement
      **             P2453 - CLOST5 Settlement
      ** CALLS:
      **        U2454 - Update PRONOM
      **        W2454 - Update PRONOM
      **        W2455 - Write  FFACMVD                                    S01240
      **        RDPRO - Read   PRONOM
      **
     C*================================================================
     C*
     C           P2459     BEGSR                                     P2459
     C*
     C** Broker involved, and Nostro?
     C*
     C           FBPIND    IFEQ 'Y'
     C*
     C** Access Projected Nostro Balance (LF/PRONOM)
     C*
     C                     MOVE ISCY      KCCY@
     C                     MOVE FBNOSN    KNOSN
     C                     EXSR RDPRO
     C*
     C** If not found zeroise Projected Nostro balance
     C*
     C           PEXIST    IFNE 'Y'
     C                     MOVE *ZERO     PNBL
     C                     END
     C*
     C** If purchase add premium to  Projected Nostro balance
     C*
     C                     SUB  PREMMP    PNBL
     C*
     C** If sale subtract
     C*
     C                     ADD  PREMMS    PNBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C           PREMMS    SUB  PREMMP    CHGBAL                          S01240
     C*
     C** If PRONOM record exists update it, otherwise write one
     C*
     C           PEXIST    IFEQ 'Y'
     C                     EXSR U2454
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE ISCY      CCY
     C                     MOVE FBNOSN    NOSN
     C                     EXSR W2454
     C                     END
     C*
     C** Write an account movement to FFACMVD for the broker settlement   S01240
     C** account .                                                        S01240
     C*                                                                   S01240
     C                     MOVE FBBRCB    @BRCA   3                       FO0017
     C                     MOVE FBCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FBACOD    @ACDE                           S01240
     C                     MOVE FBACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C*                                                                   S01240
     C                     END
     C/SPACE 1
     C*=Para 2=========================================================
     C** Customer involved, and retail account?
     C*
     C           FCPIND    IFEQ 'Y'
     C*
     C** Access Projected Nostro Balance (LF/PRONOM)
     C*
     C                     MOVE ISCY      KCCY@
     C                     MOVE FCNOSN    KNOSN
     C                     EXSR RDPRO
     C*
     C** If not found zeroise Projected Nostro balance
     C*
     C           PEXIST    IFNE 'Y'
     C                     MOVE *ZERO     PNBL
     C                     END
     C*
     C** Book involved?
     C*
     C**  No
     C           BOKC      IFEQ *BLANK
     C*
     C** If purchase subtract premium from Projected Nostro balance
     C*
     C                     ADD  PREMMP    PNBL
     C*
     C** If sale add
     C*
     C                     SUB  PREMMS    PNBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C           PREMMP    SUB  PREMMS    CHGBAL                          S01240
     C/SPACE 1
     C**  Yes
     C                     ELSE
     C*                    ----
     C*
     C** If purchase add premium to  Projected Nostro balance
     C*
     C                     SUB  PREMMP    PNBL
     C*
     C** If sale subtract
     C*
     C                     ADD  PREMMS    PNBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C           PREMMS    SUB  PREMMP    CHGBAL                          S01240
     C*
     C                     END
     C*
     C** If PRONOM record exists update it, otherwise write one
     C*
     C           PEXIST    IFEQ 'Y'
     C                     EXSR U2454
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE ISCY      CCY
     C                     MOVE FCNOSN    NOSN
     C                     EXSR W2454
     C                     END
     C** Write an account movement to FFACMVD for the customer            S01240
     C** settlement account .                                             S01240
     C*                                                                   S01240
     C                     MOVE FCBRCB    @BRCA                           FO0017
     C                     MOVE FCCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FCACOD    @ACDE                           S01240
     C                     MOVE FCACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C*                                                                   S01240
     C*
     C                     END
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Accum  LF/POSTNC Change
      ** CALLED FROM
      **             P2454 - Finish CLOST4
      **             P2455 - Finish CLOST5
      ** CALLS:
      **        P2461 - Calc CTV Change
      **
     C*================================================================
     C*
     C           P2460     BEGSR                                     P2460
     C*
     C** Set up work NCCL depending if processing CLOST4/5
     C*
     C                     MOVE *ZERO     NCCLW
     C           IND4@5    IFEQ '4'
     C                     MOVE NCCL4     NCCLW
     C                     MOVE TRTY4     TRTYW
     C                     MOVE FCLI4     FCLIW
     C                     MOVE BMAPX     BMARW
     C                     MOVE CMAPX     CMARW
     C                     END
     C           IND4@5    IFEQ '5'
     C                     MOVE NCCL5     NCCLW
     C                     MOVE TRTY5     TRTYW
     C                     MOVE FCLI5     FCLIW
     C                     MOVE BMASX     BMARW
     C                     MOVE CMASX     CMARW
     C                     END
     C*
     C** If purchase add number of contracts closed (from CLOST4/5) to
     C**                                                  Total purchase
     C*
     C           TRTYW     IFEQ 'P'
     C                     ADD  NCCLW     TPCC
     C                     END
     C*
     C** If sale add number of contracts closed (from CLOST4/5) to
     C**                                              Total sale
     C*
     C           TRTYW     IFEQ 'S'
     C                     ADD  NCCLW     TSCC
     C                     END
     C*
     C** Calculate CTV (Current Total Value) Change
     C*
     C                     EXSR P2461
     C*
     C** If purchase add CTV  to Total-Change-Current-Total-Value
     C**                                                     Purchase
     C*
     C           TRTYW     IFEQ 'P'
     C                     ADD  FFTNVL    TCCTVP
     C                     END
     C*
     C** If sale add CTV  to Total-Change-Current-Total-Value
     C**                                                     Sale
     C*
     C           TRTYW     IFEQ 'S'
     C                     ADD  FFTNVL    TCCTVS
     C                     END
     C*
     C** Broker involved ?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C** Broker margin zero ?
     C*
     C           BMARW     IFEQ *ZERO
     C           TRTYW     IFEQ 'S'
     C                     ADD  NCCLW     TCBMLO
     C                     END
     C           TRTYW     IFEQ 'P'
     C                     ADD  NCCLW     TCBMSO
     C                     END
     C                     END
     C*
     C** Broker margin greater than zero, and final closure ind = 'Y' ?
     C*
     C           BMARW     IFGT *ZERO
     C           FCLIW     ANDEQ'Y'
     C                     ADD  BMARW     TCBMPY
     C                     END
     C*
     C                     END
     C*
     C** Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C** Customer margin zero ?
     C*
     C           CMARW     IFEQ *ZERO
     C*
     C** Book involved?
     C**  No
     C           BOKC      IFEQ *BLANK
     C*
     C           TRTYW     IFEQ 'P'
     C                     ADD  NCCLW     TCCMLO
     C                     END
     C           TRTYW     IFEQ 'S'
     C                     ADD  NCCLW     TCCMSO
     C                     END
     C**  Yes
     C                     ELSE
     C*
     C           TRTYW     IFEQ 'S'
     C                     ADD  NCCLW     TCCMLO
     C                     END
     C           TRTYW     IFEQ 'P'
     C                     ADD  NCCLW     TCCMSO
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C** Customer margin greater than zero, and final closure ind = 'Y' ?
     C*
     C           CMARW     IFGT *ZERO
     C           FCLIW     ANDEQ'Y'
     C                     ADD  CMARW     TCCMPY
     C                     END
     C*
     C*
     C                     END
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Calculate CTV (Current Total Value) Change
      ** CALLED FROM
      **             P2460 - Accum  LF/POSTNC Change
      ** CALLS:
      **        FFTVCL - Calculate Transaction Value
      **
     C*================================================================
     C*
     C           P2461     BEGSR                                     P2461
     C*
     C** Set up Parameters for FFTVCL
     C*
     C           IND4@5    IFEQ '4'
     C                     Z-ADDNCCL4     FFNOC
     C                     Z-ADDCOPRP     FFPRIC
     C                     END
     C*
     C           IND4@5    IFEQ '5'
     C                     Z-ADDNCCL5     FFNOC
     C                     Z-ADDCOPRS     FFPRIC
     C                     END
     C*
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFTVCL
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Determine if MEMOSM or PRONOM processing needed
      ** CALLED FROM
      **             P2450 - Main Processing of program
      ** CALLS:
      **        FFSETL - Determine if Memo/Prono settlement
      **
     C*================================================================
     C*
     C           P2462     BEGSR                                     P2462
     C*
     C** Customer involved?
     C*
     C********** CUSC      IFEQ *ZERO                                                         CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'N'       FCMIND
     C                     MOVE 'N'       FCPIND
     C                     ELSE
     C*
     C** Set up parms for FFSETL (search argument) for Customer
     C*
     C***********          Z-ADDBRCD      FFBRCD                          S01117
     C                     MOVE BRCA6     FFBRCA                          S01117
     C**********           Z-ADDCUSC      FFCBCD                                              CSD027
     C                     MOVE CUSC      FFCBCD                                              CSD027
     C                     MOVE 'N'       FFBRKI
     C                     MOVE ISCY      FFCCY
     C*
     C** Use values from DEFLT if rec exists and Settlement Type not zero
     C*
     C           FLGDFC    IFEQ 'Y'
     C                     MOVE SETPCD    FFSETP
     C                     MOVE SETACD    FFSETA
     C                     MOVE SEBRCD    FFSETB                          S01117
     C                     ELSE
     C                     MOVE SETPCF    FFSETP
     C                     MOVE SETACF    FFSETA
     C                     MOVE SEBRCF    FFSETB                          S01117
     C                     END
     C*
     C***********MBIN      IFEQ 'Y'                                       S01117
     C***********          Z-ADDNSACS     FFDASQ                          S01117
     C***********          ELSE                                           S01117
     C***********          MOVE 01        FFDASQ                          S01117
     C***********          END                                            S01117
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFSETL
     C*
     C*
     C** Store results for Customer
     C*
     C                     MOVE FFBRCB    FCBRCB                          S01117
     C                     MOVE FFCNUM    FCCNUM
     C                     MOVE FFACOD    FCACOD
     C                     MOVE FFACSQ    FCACSQ
     C                     MOVE FFMIND    FCMIND
     C                     MOVE FFPIND    FCPIND
     C                     MOVE FFNOSN    FCNOSN
     C                     END
     C/SPACE 1
     C*==============================================================
     C*
     C*
     C** Broker involved?
     C*
     C********** BOCO      IFEQ *ZERO                                                         CSD027
     C           BOCO      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'N'       FBMIND
     C                     MOVE 'N'       FBPIND
     C                     ELSE
     C*
     C** Set up parms for FFSETL (search argument) for Broker
     C*
     C***********          Z-ADDBRCD      FFBRCD                          S01117
     C                     MOVE BRCA6     FFBRCA                          S01117
     C**********           Z-ADDBOCO      FFCBCD                                              CSD027
     C                     MOVE BOCO      FFCBCD                                              CSD027
     C                     MOVE 'Y'       FFBRKI
     C                     MOVE ISCY      FFCCY
     C*
     C** Use values from DEFLT if rec exists and Settlement Type not zero
     C*
     C           FLGDFB    IFEQ 'Y'
     C                     MOVE SETPBD    FFSETP
     C                     MOVE SETABD    FFSETA
     C                     MOVE SEBRBD    FFSETB                          S01117
     C                     ELSE
     C                     MOVE SETPBF    FFSETP
     C                     MOVE SETABF    FFSETA
     C                     MOVE SEBRBF    FFSETB                          S01117
     C                     END
     C*
     C***********MBIN      IFEQ 'Y'                                       S01117
     C***********          Z-ADDNSACS     FFDASQ                          S01117
     C***********          ELSE                                           S01117
     C***********          MOVE 01        FFDASQ                          S01117
     C***********          END                                            S01117
     C*
     C** Call standard subroutine
     C*
     C                     EXSR FFSETL
     C*
     C*
     C** Store results for Broker
     C*
     C                     MOVE FFBRCB    FBBRCB                          S01117
     C                     MOVE FFCNUM    FBCNUM
     C                     MOVE FFACOD    FBACOD
     C                     MOVE FFACSQ    FBACSQ
     C                     MOVE FFMIND    FBMIND
     C                     MOVE FFPIND    FBPIND
     C                     MOVE FFNOSN    FBNOSN
     C                     END
     C*
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Update MEMOSM-FO-Client
      ** And write a corresponding account movement to ffacmvd            S01240
      ** CALLED FROM
      **             P2450 - Main Processing of program
      ** CALLS:
      **        U2453  - Update MEMOSM
      **        W2453  - Write  MEMOSM
      **        W2455  - Write  FFACMVD                                   S01240
      **        RDMEMO - Read   MEMOSM
      **
     C*================================================================
     C*
     C           P2463     BEGSR                                     P2463
     C*
     C** Broker involved and settlement retail (ie MEMOSM)?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           FBMIND    ANDEQ'Y'
     C*
     C*
     C** Access Retail Account Shadow Balance (LF/MEMOSM)
     C*
     C                     MOVE FBBRCB    KBRCA                           S01117
     C                     MOVE FBCNUM    KCNUM
     C                     MOVE ISCY      KCCY
     C                     MOVE FBACOD    KACOD
     C                     MOVE FBACSQ    KACSQ
     C                     EXSR RDMEMO
     C*
     C** Reset balance fields if record does not exist
     C*
     C           MEXIST    IFEQ 'N'
     C                     MOVE *ZERO     LDBL
     C                     MOVE *ZERO     CLBL
     C                     END
     C*
     C** Update ledger balance and cleared balance by realised profit/loss
     C*
     C                     ADD  COPL      LDBL
     C                     ADD  COPL      CLBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C                     Z-ADDCOPL      CHGBAL                          S01240
     C*
     C** If record exists update it, else write a new one
     C*
     C           MEXIST    IFEQ 'Y'
     C                     EXSR U2453
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE FBBRCB    BRCA                            S01117
     C                     MOVE FBCNUM    CNUM
     C                     MOVE ISCY      CCY
     C                     MOVE FBACOD    ACOD
     C                     MOVE FBACSQ    ACSQ
     C                     EXSR W2453
     C                     END
     C** If the broker settlement account is not also a nostro write      S01240
     C** an account movement record to ffacmvd.                           S01240
     C*                                                                   S01240
     C           FBPIND    IFNE 'Y'                                       S01240
     C*                                                                   S01240
     C                     MOVE FBBRCB    @BRCA                           FO0017
     C                     MOVE FBCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FBACOD    @ACDE                           S01240
     C                     MOVE FBACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C*                                                                   S01240
     C                     END                                            S01240
     C*
     C                     END
     C/SPACE 1
     C*================================================================
     C*
     C** Customer involved and settlement retail (ie MEMOSM)?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           FCMIND    ANDEQ'Y'
     C*
     C*
     C** Access Retail Account Shadow Balance (LF/MEMOSM)
     C*
     C                     MOVE FCBRCB    KBRCA                           S01117
     C                     MOVE FCCNUM    KCNUM
     C                     MOVE ISCY      KCCY
     C                     MOVE FCACOD    KACOD
     C                     MOVE FCACSQ    KACSQ
     C                     EXSR RDMEMO
     C*
     C** Reset balance fields if record does not exist
     C*
     C           MEXIST    IFEQ 'N'
     C                     MOVE *ZERO     LDBL
     C                     MOVE *ZERO     CLBL
     C                     END
     C*
     C** Update ledger balance and cleared balance by realised profit/loss
     C** Book involved?
     C*
     C*  No
     C           BOKC      IFEQ *BLANK
     C                     SUB  COPL      LDBL
     C                     SUB  COPL      CLBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C                     Z-SUBCOPL      CHGBAL                          S01240
     C** Yes
     C                     ELSE
     C*
     C                     ADD  COPL      LDBL
     C                     ADD  COPL      CLBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C                     Z-ADDCOPL      CHGBAL                          S01240
     C                     END
     C*
     C** If record exists update it, else write a new one
     C*
     C           MEXIST    IFEQ 'Y'
     C                     EXSR U2453
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE FCBRCB    BRCA                            S01117
     C                     MOVE FCCNUM    CNUM
     C                     MOVE ISCY      CCY
     C                     MOVE FCACOD    ACOD
     C                     MOVE FCACSQ    ACSQ
     C                     EXSR W2453
     C                     END
     C*
     C** If the customer settlement account is not also a nostro write    S01240
     C** an account movement record to ffacmvd.                           S01240
     C*                                                                   S01240
     C           FCPIND    IFNE 'Y'                                       S01240
     C*                                                                   S01240
     C                     MOVE FCBRCB    @BRCA                           FO0017
     C                     MOVE FCCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FCACOD    @ACDE                           S01240
     C                     MOVE FCACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C*                                                                   S01240
     C                     END                                            S01240
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Update PRONOM-FO-Client
      ** And write a corresponding account movement to ffacmvd            S01240
      ** CALLED FROM
      **             P2450 - Main Processing of program
      ** CALLS:
      **        U2454 - Update PRONOM
      **        W2454 - Update PRONOM
      **        W2455 - Write  FFACMVD                                    S01240
      **        RDPRO - Read   PRONOM
      **
     C*================================================================
     C*
     C           P2464     BEGSR                                     P2464
     C*
     C** Broker involved and settlement Nostro (ie PRONOM)?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           FBPIND    ANDEQ'Y'
     C*
     C** Access Projected Nostro Balance (LF/PRONOM)
     C*
     C                     MOVE ISCY      KCCY@
     C                     MOVE FBNOSN    KNOSN
     C                     EXSR RDPRO
     C*
     C** Reset balance fields if record does not exist
     C*
     C           PEXIST    IFEQ 'N'
     C                     MOVE *ZERO     PNBL
     C                     END
     C*
     C** Update projected Nostro balance by realised profit/loss
     C*
     C                     ADD  COPL      PNBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C                     Z-ADDCOPL      CHGBAL                          S01240
     C*
     C** If record exists update it, else write a new one
     C*
     C           PEXIST    IFEQ 'Y'
     C                     EXSR U2454
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE ISCY      CCY
     C                     MOVE FBNOSN    NOSN
     C                     EXSR W2454
     C                     END
     C** Write an account movement to FFACMVD for the broker              S01240
     C** settlement account .                                             S01240
     C*                                                                   S01240
     C                     MOVE FBBRCB    @BRCA                           FO0017
     C                     MOVE FBCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FBACOD    @ACDE                           S01240
     C                     MOVE FBACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C*
     C                     END
     C*
     C/EJECT
     C*================================================================
     C** Customer involved and settlement retail (ie MEMOSM)?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           FCPIND    ANDEQ'Y'
     C*
     C** Access Projected Nostro Balance (LF/PRONOM)
     C*
     C                     MOVE ISCY      KCCY@
     C                     MOVE FCNOSN    KNOSN
     C                     EXSR RDPRO
     C*
     C** Reset balance fields if record does not exist
     C*
     C           PEXIST    IFEQ 'N'
     C                     MOVE *ZERO     PNBL
     C                     END
     C*
     C** Update projected Nostro balance by realised profit/loss
     C** Book involved?
     C*
     C*  No
     C           BOKC      IFEQ *BLANK
     C                     SUB  COPL      PNBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C                     Z-SUBCOPL      CHGBAL                          S01240
     C** Yes
     C                     ELSE
     C*
     C                     ADD  COPL      PNBL
     C*                                                                   S01240
     C** Determine the change in the account balance                      S01240
     C*                                                                   S01240
     C                     Z-ADDCOPL      CHGBAL                          S01240
     C                     END
     C*
     C** If record exists update it, else write a new one
     C*
     C           PEXIST    IFEQ 'Y'
     C                     EXSR U2454
     C                     ELSE
     C                     MOVE 'D'       RECI
     C                     MOVE ISCY      CCY
     C                     MOVE FCNOSN    NOSN
     C                     EXSR W2454
     C                     END
     C*
     C** Write an account movement to FFACMVD for the customer            S01240
     C** settlement account .                                             S01240
     C*                                                                   S01240
     C                     MOVE FCBRCB    @BRCA                           FO0017
     C                     MOVE FCCNUM    @CUSN                           S01240
     C                     MOVE ISCY      @CCYD                           S01240
     C                     MOVE FCACOD    @ACDE                           S01240
     C                     MOVE FCACSQ    @ASNC                           S01240
     C                     EXSR W2455                                     S01240
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Update POSTN (Customer/Broker Instrument Position)
      ** CALLED FROM
      **             P2450 - Main Processing of program
      ** CALLS:
      **        U2465 -  Update POSTNC Broker/Client Instrument Positions
      **        U2466 -  Update POSTNK Book Instrument Positions
      **        RDPSTK - Read Book Instrument Position   (LF/POSTNK)
      **
     C*================================================================
     C*
     C           P2465     BEGSR                                     P2465
     C*
     C** Broker involved?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C**     Update if Close out type is not 'X' (for match)
     C*
     C           CLOT      ANDNE'X'
     C*
     C** Access Broker Instrument Position (LF/POSTNC)
     C*
     C***********          MOVE BRCD      KBRCDC                          S01117
     C                     MOVE BRCA6     KBRCAC                          S01117
     C                     MOVE BOCO      KCBCDC
     C                     MOVE ISTT      KISTTC
     C                     MOVE YRNO      KYRNOC
     C                     MOVE MTHN      KMTHNC
     C                     MOVE PCAL      KPCALC
     C                     MOVE STRP      KSTRPC
     C                     EXSR RDPSTC
     C*
     C** Apply Updates
     C*
     C                     SUB  TSCC      LOPC
     C                     SUB  TPCC      SOPC
     C                     ADD  TCCTVP    CUTV
     C                     SUB  TCCTVS    CUTV
     C                     SUB  COPL      RPLD
     C                     SUB  TCBMLO    LOCO
     C                     SUB  TCBMSO    SOCO
     C                     SUB  TCBMPY    TOTM
     C*
     C** Update Broker Instrument Position (LF/POSTNC)
     C*
     C                     EXSR U2465
     C*
     C                     END
     C/SPACE 1
     C*================================================================
     C*
     C** Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C** Access Customer Instrument Position (LF/POSTNC)
     C*
     C***********          MOVE BRCD      KBRCDC                          S01117
     C                     MOVE BRCA6     KBRCAC                          S01117
     C                     MOVE CUSC      KCBCDC
     C                     MOVE ISTT      KISTTC
     C                     MOVE YRNO      KYRNOC
     C                     MOVE MTHN      KMTHNC
     C                     MOVE PCAL      KPCALC
     C                     MOVE STRP      KSTRPC
     C                     EXSR RDPSTC
     C*
     C** Apply Updates
     C** Book involved?
     C** No
     C*
     C           BOKC      IFEQ *BLANK
     C*
     C                     SUB  TPCC      LOPC
     C                     SUB  TSCC      SOPC
     C                     SUB  TCCTVP    CUTV
     C                     ADD  TCCTVS    CUTV
     C                     ADD  COPL      RPLD
     C                     SUB  TCCMLO    LOCO
     C                     SUB  TCCMSO    SOCO
     C                     SUB  TCCMPY    TOTM
     C** Yes
     C                     ELSE
     C*
     C                     SUB  TSCC      LOPC
     C                     SUB  TPCC      SOPC
     C                     ADD  TCCTVP    CUTV
     C                     SUB  TCCTVS    CUTV
     C                     SUB  COPL      RPLD
     C                     SUB  TCCMLO    LOCO
     C                     SUB  TCCMSO    SOCO
     C                     SUB  TCCMPY    TOTM
     C*
     C                     END
     C*
     C** Update Customer Instrument Position (LF/POSTNC)
     C*
     C                     EXSR U2465
     C*
     C*
     C                     END
     C/EJECT
     C*================================================================
     C*
     C** Book involved?
     C*
     C** Yes
     C           BOKC      IFNE *BLANK
     C*
     C** Access Book Instrument Position (LF/POSTNK)
     C*
     C***********          MOVE BRCD      KBRCDK                          S01117
     C                     MOVE BRCA6     KBRCAK                          S01117
     C                     MOVE BOKC      KBOKCK
     C                     MOVE ISTT      KISTTK
     C                     MOVE YRNO      KYRNOK
     C                     MOVE MTHN      KMTHNK
     C                     MOVE PCAL      KPCALK
     C                     MOVE STRP      KSTRPK
     C                     EXSR RDPSTK
     C*
     C** Apply Updates
     C*
     C                     SUB  TPCC      LOPC
     C                     SUB  TSCC      SOPC
     C                     SUB  TCCTVP    CUTV
     C                     ADD  TCCTVS    CUTV
     C                     ADD  COPL      RPLD
     C*
     C** Update Book Instrument Position (LF/POSTNK)
     C*
     C                     EXSR U2466
     C*
     C                     END
     C*
     C** Reset Totals
     C*
     C                     MOVE *ZERO     TSCC
     C                     MOVE *ZERO     TPCC
     C                     MOVE *ZERO     TCCTVP
     C                     MOVE *ZERO     TCCTVS
     C                     MOVE *ZERO     TCBMLO
     C                     MOVE *ZERO     TCBMSO
     C                     MOVE *ZERO     TCCMLO
     C                     MOVE *ZERO     TCCMSO
     C                     MOVE *ZERO     TCBMPY
     C                     MOVE *ZERO     TCCMPY
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Read next CLOST6 record and obtain a transaction number
      ** CALLED FROM
      **             INIT  - Initialise
      **             MAINLINE
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C           RD6       BEGSR                                    RD6
     C*
     C                     READ CLOST6                   78
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Read next CLOST4 record and associated TRANS and TRSET records
      ** CALLED FROM
      **             P2451 - CLOSTT processing
      **             P2454 - Finish CLOST4
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C           RD4       BEGSR                                    RD4
     C*
     C** Read CLOST4
     C*
     C                     READ CLOST4                   77
     C           *IN77     IFEQ '1'
     C                     MOVE *HIVAL    CLON4
     C                     END
     C*
     C*
     C** If record from same close-out-set
     C**                increment total of unmatched contracts
     C**                get corresponding TRANS (transaction) record
     C**                and corresponding TRSET (settlement) record
     C*
     C           CLON4     IFEQ CLON
     C                     Z-ADDNCCL4     T4CNT
     C*
     C** Transactions record (purchases)
     C*
     C           TNBR4     CHAINTRANSP               79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD13        DBASE            ***************
     C                     MOVEL'TRNSP'   DBFILE           **DB ERROR 13**
     C                     MOVELTNBR4     DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C** TRSET (settlement) record
     C*
     C           TNBR4     CHAINTRSETP               79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD15        DBASE            ***************
     C                     MOVEL'TRSTP'   DBFILE           **DB ERROR 15**
     C                     MOVELTNBR4     DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*                                                                   E03643
     C** Zero the work fields holding the no. of opening contracts        E03643
     C** within the closeout and the no. of closing contracts             E03643
     C** within the closeout, for the CLOST4 trade.                       E03643
     C*                                                                   E03643
     C           *LIKE     DEFN OCOB4     @OCOB4                          E03643
     C           *LIKE     DEFN CCOB4     @CCOB4                          E03643
     C           *LIKE     DEFN OCOC4     @OCOC4                          E03643
     C           *LIKE     DEFN CCOC4     @CCOC4                          E03643
     C                     Z-ADD0         @OCOB4                          E03643
     C                     Z-ADD0         @CCOB4                          E03643
     C                     Z-ADD0         @OCOC4                          E03643
     C                     Z-ADD0         @CCOC4                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Read next CLOST5 record and associated TRANS and TRSET records
      ** CALLED FROM
      **             P2451 - CLOSTT processing
      **             P2455 - Finish CLOST5
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C           RD5       BEGSR                                    RD5
     C*
     C** Read CLOST5
     C*
     C                     READ CLOST5                   77
     C           *IN77     IFEQ '1'
     C                     MOVE *HIVAL    CLON5
     C                     END
     C*
     C*
     C** If record from same close-out-set
     C**                increment total of unmatched contracts
     C**                get corresponding TRANS (transaction) record
     C**                and corresponding TRSET (settlement) record
     C*
     C           CLON5     IFEQ CLON
     C                     Z-ADDNCCL5     T5CNT
     C*
     C** Transaction (sales) record
     C*
     C           TNBR5     CHAINTRANSS               79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD14        DBASE            ***************
     C                     MOVEL'TRANSS'  DBFILE           **DB ERROR 14**
     C                     MOVELTNBR5     DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C** TRSET (settlement) record
     C*
     C           TNBR5     CHAINTRSETS               79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD16        DBASE            ***************
     C                     MOVEL'TRSETS'  DBFILE           **DB ERROR 16**
     C                     MOVELTNBR5     DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*                                                                   E03643
     C** Zero the work fields holding the no. of opening contracts        E03643
     C** within the closeout and the no. of closing contracts             E03643
     C** within the closeout, for the CLOST5 trade.                       E03643
     C*                                                                   E03643
     C           *LIKE     DEFN OCOB5     @OCOB5                          E03643
     C           *LIKE     DEFN CCOB5     @CCOB5                          E03643
     C           *LIKE     DEFN OCOC5     @OCOC5                          E03643
     C           *LIKE     DEFN CCOC5     @CCOC5                          E03643
     C                     Z-ADD0         @OCOB5                          E03643
     C                     Z-ADD0         @CCOB5                          E03643
     C                     Z-ADD0         @OCOC5                          E03643
     C                     Z-ADD0         @CCOC5                          E03643
     C*                                                                   E03643
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Read Retail Shadow Balance record (LF/MEMOSM)
      ** CALLED FROM:
      **        P2458 - Update (LF/MEMOSM) transaction
      **        P2463   Update MEMOSM-FO-Client
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C*
     C           RDMEMO    BEGSR                                    RDMEMO
     C*
     C                     MOVE 'Y'       MEXIST  1
     C*
     C           KMEMSM    CHAINMEMOSM               79
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE 'N'       MEXIST
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Read Projected Nostro Balance record (LF/PRONOM)
      ** CALLED FROM:
      **        P2459 - Update (LF/PRONOM) transaction
      **        P2464 - Update PRONOM-FO-Client
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C*
     C           RDPRO     BEGSR                                    RDMEMO
     C*
     C                     MOVE 'Y'       PEXIST  1
     C*
     C           KPRONM    CHAINPRONOM               79
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE 'N'       PEXIST
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Read Broker Instrument Position   (LF/POSTNC)
      ** CALLED FROM:
      **        P2465 - Update POSTNx
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C*
     C           RDPSTC    BEGSR                                    RDPSTC
     C*
     C           KPSTNC    CHAINPOSTNC               79
     C*
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD18        DBASE            ***************
     C                     MOVEL'PSTNC'   DBFILE           **DB ERROR 18**
     C                     MOVELXPSTNC    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Read Book Instrument Position   (LF/POSTNK)
      ** CALLED FROM:
      **        P2465 - Update POSTNx
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C*
     C           RDPSTK    BEGSR                                    RDPSTK
     C*
     C           KPSTNK    CHAINPOSTNK               79
     C*
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD19        DBASE            ***************
     C                     MOVEL'PSTNK'   DBFILE           **DB ERROR 19**
     C                     MOVELXPSTNK    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Update close-out-set detail
      ** CALLED FROM
      **             P2450 - Main Processing of program
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           U2450     BEGSR                                     U2450
     C*
     C** Shadow Posted Indicator
     C*
     C                     MOVE 'Y'       SHPI
     C*
     C**     Set Last Change Date if close out type is not 'X'
     C**     ( To force reporting of this close out set in FF1260 )
     C*
     C           CLOT      IFNE 'X'
     C*
     C** If OTC
     C**     Run Date off PF/TABTB10
     C** else
     C**     Current Business Date off LF/MKCTL
     C*
     C           REQMKT    IFEQ *BLANKS
     C                     MOVE RUND      LCD
     C                     ELSE
     C                     MOVE BUSD      LCD
     C                     END
     C*
     C                     ELSE
     C*
     C**     This type of close out set is not reported in FF1260
     C*
     C                     Z-ADD*ZERO     LCD
     C*
     C**     There is no EOC processing for this type of close out set
     C*
     C                     MOVE 'Y'       ECPI
     C*
     C                     END
     C*
     C** Last change Type
     C*
     C                     MOVE 'A'       CHTP
     C*
     C** Next transaction number off DTAARA-MNATN
     C*
     C                     Z-ADDNATN      TNLU
     C*
     C** Update close-out-set detail (LF/CLOST6)
     C*
     C                     EXCPTECLST6
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Update TRSET
      ** CALLED FROM
      **             P2454 - Finish CLOST4
      **             P2455 - Finish CLOST5
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           U2452     BEGSR                                     U2452
     C*
     C** Reset "Broker Present" and "Customer present" indicators
     C** for exception output condition
     C*
     C                     SETOF                     1020
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     SETON                     10
     C                     END
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C                     SETON                     20
     C                     END
     C*
     C** Processing CLOST4 or 5?
     C*
     C           IND4@5    IFEQ '4'
     C*
     C** Broker involved?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C** Number of Contracts Opening a Broker Position
     C**      with Standard Commission
     C*
     C                     ADD  OCTB4     OCSBP
     C*
     C** Number of Contracts Opening a Broker Position
     C**      with Same Day Commission
     C*
     C                     ADD  OCSB4     OCDBP
     C*
     C** Number of Contracts Closing a Broker Position
     C**      with Standard Commission
     C*
     C                     ADD  CCTB4     CCSBP
     C*
     C** Number of Contracts Closing a Broker Position
     C**      with Same Day Commission
     C*
     C                     ADD  CCSB4     CCDBP
     C*
     C** Broker margin
     C*
     C** Save value for use when accumulating position changes (P2460)
     C*
     C                     Z-ADDBMARP     BMAPX
     C*
     C           FCLI4     IFEQ 'Y'
     C           BMARP     ANDGT0
     C                     Z-ADD0         BMARP
     C                     END
     C*
     C** Reset counts
     C*
     C                     Z-ADD0         OCTB4
     C                     Z-ADD0         OCSB4
     C                     Z-ADD0         CCTB4
     C                     Z-ADD0         CCSB4
     C*
     C                     END
     C*
     C** Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C** Number of Contracts Opening a Customer Position
     C**      with Standard Commission
     C*
     C                     ADD  OCTC4     OCSCP
     C*
     C** Number of Contracts Opening a Customer Position
     C**      with Same Day Commission
     C*
     C                     ADD  OCSC4     OCDCP
     C*
     C** Number of Contracts Closing a Customer Position
     C**      with Standard Commission
     C*
     C                     ADD  CCTC4     CCSCP
     C*
     C** Number of Contracts Closing a Customer Position
     C**      with Same Day Commission
     C*
     C                     ADD  CCSC4     CCDCP
     C*
     C** Customer margin
     C*
     C** Save value for use when accumulating position changes (P2460)
     C*
     C                     Z-ADDCMARP     CMAPX
     C*
     C           FCLI4     IFEQ 'Y'
     C           CMARP     ANDGT0
     C                     Z-ADD0         CMARP
     C                     END
     C*
     C** Reset counts
     C*
     C                     Z-ADD0         OCTC4
     C                     Z-ADD0         OCSC4
     C                     Z-ADD0         CCTC4
     C                     Z-ADD0         CCSC4
     C*
     C                     END
     C*
     C** Update (LF/TRSET)
     C*
     C                     EXCPTETRSTP
     C*
     C                     END
     C/SPACE 1
     C*
     C** Processing CLOST4 or 5?
     C*
     C           IND4@5    IFEQ '5'
     C*
     C** Broker involved?
     C*
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
     C** Number of Contracts Opening a Broker Position
     C**      with Standard Commission
     C*
     C                     ADD  OCTB5     OCSBS
     C*
     C** Number of Contracts Opening a Broker Position
     C**      with Same Day Commission
     C*
     C                     ADD  OCSB5     OCDBS
     C*
     C** Number of Contracts Closing a Broker Position
     C**      with Standard Commission
     C*
     C                     ADD  CCTB5     CCSBS
     C*
     C** Number of Contracts Closing a Broker Position
     C**      with Same Day Commission
     C*
     C                     ADD  CCSB5     CCDBS
     C*
     C** Broker margin
     C*
     C** Save value for use when accumulating position changes (P2460)
     C*
     C                     Z-ADDBMARS     BMASX
     C*
     C           FCLI5     IFEQ 'Y'
     C           BMARS     ANDGT0
     C                     Z-ADD0         BMARS
     C                     END
     C*
     C** Reset counts
     C*
     C                     Z-ADD0         OCTB5
     C                     Z-ADD0         OCSB5
     C                     Z-ADD0         CCTB5
     C                     Z-ADD0         CCSB5
     C*
     C                     END
     C*
     C** Customer involved?
     C*
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C** Number of Contracts Opening a Customer Position
     C**      with Standard Commission
     C*
     C                     ADD  OCTC5     OCSCS
     C*
     C** Number of Contracts Opening a Customer Position
     C**      with Same Day Commission
     C*
     C                     ADD  OCSC5     OCDCS
     C*
     C** Number of Contracts Closing a Customer Position
     C**      with Standard Commission
     C*
     C                     ADD  CCTC5     CCSCS
     C*
     C** Number of Contracts Closing a Customer Position
     C**      with Same Day Commission
     C*
     C                     ADD  CCSC5     CCDCS
     C*
     C** Customer margin
     C*
     C** Save value for use when accumulating position changes (P2460)
     C*
     C                     Z-ADDCMARS     CMASX
     C*
     C           FCLI5     IFEQ 'Y'
     C           CMARS     ANDGT0
     C                     Z-ADD0         CMARS
     C                     END
     C*
     C** Reset counts
     C*
     C                     Z-ADD0         OCTC5
     C                     Z-ADD0         OCSC5
     C                     Z-ADD0         CCTC5
     C                     Z-ADD0         CCSC5
     C*
     C                     END
     C*
     C** Update (LF/TRSET)
     C*
     C                     EXCPTETRSTS
     C*
     C                     END
     C*
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================   E03643
     C**                                                                  E03643
     C** Update CLOST4                                                    E03643
     C** CALLED FROM                                                      E03643
     C**             P2454 - Finish CLOST4                                E03643
     C** CALLS:                                                           E03643
     C**        (None)                                                    E03643
     C**                                                                  E03643
     C*================================================================   E03643
     C           UCLOP     BEGSR                                          E03643
     C*                                                                   E03643
     C** Update (LF/CLOST4)                                               E03643
     C*                                                                   E03643
     C                     Z-ADD@OCOB4    OCOB4                           E03643
     C                     Z-ADD@CCOB4    CCOB4                           E03643
     C                     Z-ADD@OCOC4    OCOC4                           E03643
     C                     Z-ADD@CCOC4    CCOC4                           E03643
     C*                                                                   E03643
     C                     EXCPTECLOSP                                    E03643
     C*                                                                   E03643
     C*                                                                   E03643
     C*                                                                   E03643
     C                     ENDSR                                          E03643
     C/EJECT                                                              E03643
     C*                                                                   E03643
     C*================================================================   E03643
     C**                                                                  E03643
      ** Update MEMOSM
      ** CALLED FROM
      **             P2458 (twice) - Update LF/MEMOSM transaction
      **             P2463 (twice) - Update MEMOSM-FO-Client
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           U2453     BEGSR                                     U2453
     C*
     C** Ledger Balance and Cleared Balance updated in P2458 and P2463
     C*
     C*
     C** Update (LF/MEMOSM)
     C*
     C                     EXCPTEMEMOS
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Update MEMOSM
      ** CALLED FROM
      **             P2459 (twice) - Update LF/PRONOM transaction
      **             P2464 (twice) - Update PRONOM-FO-Client
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           U2454     BEGSR                                     U2454
     C*
     C** Projected Nostro balance updated in P2459 and P2464)
     C*
     C*
     C** Update (LF/PRONOM)
     C*
     C                     EXCPTEPRONO
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Update POSTNC Broker/Customer Instrument Positions
      ** CALLED FROM
      **        P2465 (twice)  Update POSTN (Client/Broker Instr Position)
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           U2465     BEGSR                                     U2465
     C*
     C** Field updates carried out in P2465
     C*
     C*
     C** Update (LF/POSTNC)
     C*
     C                     EXCPTEPSTNC
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Update POSTNK Book Instrument Positions
      ** CALLED FROM
      **             P2465 - Update POSTN (Client/Broker Instr Position)
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           U2466     BEGSR                                     U2466
     C*
     C** Field updates carried out in P2465
     C*
     C*
     C** Update (LF/POSTNK)
     C*
     C                     EXCPTEPSTNK
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Write MEMOSM
      ** CALLED FROM
      **             P2458 (twice) - Update LF/MEMOSM transaction
      **             P2463 (twice) - Update MEMOSM-FO-Client
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           W2453     BEGSR                                     W2453
     C*
     C** New record created in P2458  and P2463
     C*
     C*
     C** Write new record (LF/MEMOSM)
     C*
     C                     WRITEMEMOSMEF
     C*
     C                     ENDSR
     C/EJECT
     C*
     C*================================================================
      **
      ** Update MEMOSM
      ** CALLED FROM
      **             P2459 (twice) - Update LF/PRONOM transaction
      **             P2464 (twice) - Update PRONOM-FO-Client
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           W2454     BEGSR                                     W2454
     C*
     C** New record created in P2459  and P2464
     C*
     C*
     C** Write new record (LF/PRONOM)
     C*
     C                     WRITEPRONOMEF
     C*
     C                     ENDSR
     C/EJECT                                                              S01240
     C*                                                                   S01240
     C*================================================================   S01240
      **                                                                  S01240
      ** Write a record to FFACMVD                                        S01240
      ** CALLED FROM  P2485, P2459, P2463, P2464                          S01240
      **                                                                  S01240
      **                                                                  S01240
      ** CALLS:                                                           S01240
      **        (None)                                                    S01240
      **                                                                  S01240
      ** INPUT PARAMETERS -   @BRCA 3A        Branch Code                 S01240
      **                  -   @CUSN 6N ( 6,0) Customer number             S01240
      **                  -   @CCYD 3A        Currency                    S01240
      ********************-***@ACDE*4N*(*4,0)*Account*code*************                S01240 CGL029
      **                  -   @ACDE10N (10,0) Account code                                    CGL029
      **                  -   @ACDE 2N ( 2,0) Account sequence            S01240
      **                                                                  S01240
     C*================================================================   S01240
     C*                                                                   S01240
     C           W2455     BEGSR                                     W2455S01240
     C*                                                                   S01240
     C**********           MOVE *BLANK    BRCA                            FO0017
     C                     MOVE @BRCA     BRCA                            FO0017
     C                     MOVE @CUSN     CUSN                            S01240
     C                     MOVE @CCYD     CCYD                            S01240
     C                     MOVE @ACDE     ACDE                            S01240
     C                     MOVE @ASNC     ASNC                            S01240
     C                     Z-ADDRUND      PTDT                            S01240
     C                     Z-ADDRUND      VUDT                            S01240
     C                     MOVE 'CO'      TRYP                            S01240
     C                     MOVE *BLANK    NRTC                            S01240
     C                     MOVELISTN      NRTD                            S01240
     C                     Z-ADD*ZERO     CQNR                            S01240
     C*                                                                   S01240
     C**  ONLY WRITE RECORD TO FFACMVD IF MOVEMENT AMOUNT NOT EQUAL TO    S01240
     C**  ZERO                                                            S01240
     C           CHGBAL    IFNE *ZERO                                     S01240
     C*                                                                   S01240
     C           CHGBAL    IFGT *ZERO                                     S01240
     C                     Z-ADDCHGBAL    MVAM                            S01240
     C                     Z-ADD*ZERO     DORC                            S01240
     C*                                                                   S01240
     C/SPACE 1                                                            S01240
     C                     ELSE                                           S01240
     C                     Z-SUBCHGBAL    MVAM                            S01240
     C                     Z-ADD1         DORC                            S01240
     C*                                                                   S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C                     WRITEFFACMVDF                                  S01240
     C*                                                                   S01240
     C                     END                                            S01240
     C*                                                                   S01240
     C                     ENDSR                                          S01240
     C/EJECT
     C*================================================================
      **
      **   DBERR SR. - DATABASE ERROR HANDLING : TERMINATE PROGRAM       *
      **
      ** CALLED FROM
      **             Every DB access if an error occurs
      ** CALLS:
      **        (None)
      **
     C*================================================================
     C*
     C           DBERR     BEGSR
     C*
     C                     SETON                     U7U8LR
     C*
     C** SET RETURN CODE TO '1' TO SIGNIFY PROGRAM ERROR
     C*
     C                     Z-ADD1         RTNCD
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C                     RETRN
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Read Branch Table Record (on change of branch)
      ** CALLED FROM MAIN PROCESSING
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C           RDTABR    BEGSR                                    RDTABR
     C*
     C**********           MOVE *BLANKS   ZTABKY                                             BUG6688
     C*
     C                     MOVEL'10'      ZTABKY 12
     C***********          MOVE BRCD      ZTABKY                          S01117
     C**********           MOVE BRCA6     ZTABKY                          S01117             BUG6688
     C********** ZTABKY    CHAINTABFF                79                                      BUG6688
      *                                                                                      BUG6688
     C                     CALL 'AOBRCHR1'                                                   BUG6688
     C                     PARM *BLANKS   PRTCD   7                                          BUG6688
     C                     PARM '*KEY   ' POPTN   7                                          BUG6688
     C                     PARM BRCA6     PBRCH   3                                          BUG6688
     C           SDBRCH    PARM SDBRCH    DSSDY                                              BUG6688
     C*
     C** DB Error Handler
     C*
     C           PRTCD     IFNE *BLANKS                                                      BUG6688
     C********** *IN79     IFNE '0'                                                          BUG6688
     C********** RECI      ORNE 'D'                                                          BUG6688
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD7         DBASE            ***************
     C**********           MOVEL'TABFF'   DBFILE           **DB ERROR 07**                   BUG6688
     C**********           MOVELZTABKY    DBKEY            ***************                   BUG6688
     C                     MOVEL'SDBRCHPD'DBFILE                                             BUG6688
     C                     MOVELBRCA6     DBKEY                                              BUG6688
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Read Broker's Client record (on change of broker)
      ** CALLED FROM MAIN PROCESSING
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C           RDBROK    BEGSR                                    RDBROK
     C********** BOCO      IFNE *ZERO                                                         CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           BOCO      CHAINFOCLTB               79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD8         DBASE            ***************
     C                     MOVEL'FCLTB'   DBFILE           **DB ERROR 08**
     C                     MOVELBOCO      DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Read Client's Client record (on change of client)
      ** CALLED FROM MAIN PROCESSING
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C           RDCUST    BEGSR                                    RDCUST
     C********** CUSC      IFNE *ZERO                                                         CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           CUSC      CHAINFOCLTC               79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD9         DBASE            ***************
     C                     MOVEL'FCLTC'   DBFILE           **DB ERROR 09**
     C                     MOVELCUSC      DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** Change of Instrument-type processing
      ** CALLED FROM MAIN PROCESSING
      ** CALLS:
      **        (No calls)
      **
     C*================================================================
     C*
     C           INSTSR    BEGSR                                    INSTSR
     C           ISTT      CHAININTYP                79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD10        DBASE            ***************
     C                     MOVEL'INTYP'   DBFILE           **DB ERROR 10**
     C                     MOVELISTT      DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C** If market not Over-The-Counter
     C** Attempt to access DEFLT for broker, and set existence-flag
     C*
     C                     MOVE 'N'       FLGDFB
     C                     MOVE 'N'       FLGDFC
     C*
     C           REQMKT    IFNE *BLANKS
     C                     MOVE 'Y'       FLGDFB  1
     C*
     C                     MOVE BOCO      KCBCD
     C                     MOVE REQMKT    KMRKT
     C                     MOVE ISTT      KISTC
     C           KDEFLT    CHAINDEFLTB               79
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           SETPBD    OREQ *ZERO
     C                     MOVE 'N'       FLGDFB
     C                     END
     C*
     C*
     C** Attempt to access DEFLT for client, and set existence-flag
     C*
     C                     MOVE 'Y'       FLGDFC  1
     C*
     C                     MOVE CUSC      KCBCD
     C                     MOVE REQMKT    KMRKT
     C                     MOVE ISTT      KISTC
     C           KDEFLT    CHAINDEFLTC               79
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           SETPCD    OREQ *ZERO
     C                     MOVE 'N'       FLGDFC
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*================================================================
      **
      ** INIT S/R - TO INITIALISE STATIC FIELDS AND ACCESS STANDING DATA
      ** CALLED ONCE AT START OF PROGRAM FROM MAIN LINE
      ** CALLS NO OTHER ROUTINES
      **
     C*================================================================
     C*
     C           INIT      BEGSR                                      INIT
     C*
     C** PREPARE LDA
     C*
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'FF0360  'DBPGM
     C                     MOVE *BLANKS   DBASE
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     OUT  LDA                                       S01117
     C*
     C** Get Market date if not Over-The-Counter (OTC)
     C*
     C           REQMKT    IFNE *BLANKS
     C*
     C                     OPEN MKCTL
     C           REQMKT    CHAINMKCTL                79
     C                     CLOSEMKCTL
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD1         DBASE            ***************
     C                     MOVEL'MKCTL'   DBFILE           **DB ERROR 01**
     C                     MOVELREQMKT    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     END
     C*
     C***GET*INSTALLATION*CONTROL*DATA*RECORDS*10*11*20*40*80*************S01117
     C** GET INSTALLATION CONTROL DATA RECORDS 20 40 80                   S01117
     C*
     C***TABTB10*-*ICD*1**************************************************S01117
     C***********                                                         S01117
     C***********          MOVE *BLANKS   ZTABKY 12                       S01117
     C***********                                                         S01117
     C***********          MOVEL'01'      ZTABKY                          S01117
     C***********          MOVE '10'      ZTABKY                          S01117
     C***********ZTABKY    CHAINTABFF                79                   S01117
     C***********                                                         S01117
     C***DB*Error*Handler*************************************************S01117
     C***********                                                         S01117
     C************IN79     IFNE '0'                                       S01117
     C***********RECI      ORNE 'D'                                       S01117
     C***********          Z-ADD2         DBASE            ***************S01117
     C***********          MOVEL'TABFF'   DBFILE           **DB ERROR 02**S01117
     C***********          MOVELZTABKY    DBKEY            ***************S01117
     C***********          EXSR DBERR                                     S01117
     C***********          END                                            S01117
     C***********                                                         S01117
     C***TABTB11*-*ICD*2**************************************************S01117
     C***********                                                         S01117
     C***********          MOVE *BLANKS   ZTABKY                          S01117
     C***********                                                         S01117
     C***********          MOVEL'01'      ZTABKY                          S01117
     C***********          MOVE '11'      ZTABKY                          S01117
     C***********ZTABKY    CHAINTABFF                79                   S01117
     C***********                                                         S01117
     C***DB*Error*Handler*************************************************S01117
     C***********                                                         S01117
     C************IN79     IFNE '0'                                       S01117
     C***********RECI      ORNE 'D'                                       S01117
     C***********          Z-ADD3         DBASE            ***************S01117
     C***********          MOVEL'TABFF'   DBFILE           **DB ERROR 03**S01117
     C***********          MOVELZTABKY    DBKEY            ***************S01117
     C***********          EXSR DBERR                                     S01117
     C***********          END                                            S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
     C*
     C** TABTB20 - ICD 3
     C*
     C                     MOVE *BLANKS   ZTABKY
     C*
     C                     MOVEL'01'      ZTABKY
     C                     MOVE '20'      ZTABKY
     C           ZTABKY    CHAINTABFF                79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD4         DBASE            ***************
     C                     MOVEL'TABFF'   DBFILE           **DB ERROR 04**
     C                     MOVELZTABKY    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C** TABTB40 - ICD 5
     C*
     C                     MOVE *BLANKS   ZTABKY
     C*
     C                     MOVEL'01'      ZTABKY
     C                     MOVE '40'      ZTABKY
     C           ZTABKY    CHAINTABFF                79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD5         DBASE            ***************
     C                     MOVEL'TABFF'   DBFILE           **DB ERROR 05**
     C                     MOVELZTABKY    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C** TABTB80 - ICD FUTURES & OPTIONS
     C*
     C                     MOVE *BLANKS   ZTABKY
     C*
     C                     MOVEL'01'      ZTABKY
     C                     MOVE '80'      ZTABKY
     C           ZTABKY    CHAINTABFF                79
     C*
     C** DB Error Handler
     C*
     C           *IN79     IFNE '0'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     Z-ADD6         DBASE            ***************
     C                     MOVEL'TABFF'   DBFILE           **DB ERROR 06**
     C                     MOVELZTABKY    DBKEY            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C*
     C** Priming read for primary input LF/CLOST6
     C*
     C                     EXSR RD6
     C                     ENDSR
     C*================================================================
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C**      S   T   D      S   U   B   R   O   U   T   I   N   E   S   *
     C*                    (C-Specs)                                     *
     C*                                                                  *
     C********************************************************************
     C/SPACE 3
     C/COPY ZSRSRC,FFSETLZ4
     C/SPACE 3
     C/COPY ZSRSRC,FFPMCLZ1
     C/SPACE 3
     C/COPY ZSRSRC,FFTVCLZ2
     C/SPACE 3
     C/COPY ZSRSRC,ZTNLU1Z2
     C/EJECT                                                              AUS022
     C/COPY ZSRSRC,FFYTOPZ1                                               AUS022
     O/EJECT
     O*
     OCLOST6F E                ECLST6
     O*    UPDATE LF/CLOST6 - Close out details
     O                         SHPI
     O                         ECPI
     O                         LCD
     O                         CHTP
     O                         TNLU
     O*
     OMEMOSMEFE                EMEMOS
     O*    UPDATE LF/MEMOSM - FO Retail Shadow postings for markets
     O                         LDBL
     O                         CLBL
     O*
     OPOSTNCDFE                EPSTNC
     O*    UPDATE LF/POSTNC - Customer/Broker Instrument Positions
     O                         LOPC
     O                         SOPC
     O                         CUTV
     O                         RPLD
     O                         TOTM
     O                         LOCO
     O                         SOCO
     O*
     OPOSTNKDFE                EPSTNK
     O*    UPDATE LF/POSTNK - Customer/Broker Book Positions
     O                         LOPC
     O                         SOPC
     O                         CUTV
     O                         RPLD
     O*
     OPRONOMEFE                EPRONO
     O*    UPDATE LF/PRONOM - Projected Nostros for markets
     O                         PNBL
     O*
     OTRSETPF E                ETRSTP
     O*    UPDATE LF/TRSETP - Transaction Settlement Details- Purchase
     O*    *IN10 = Update Broker
     O*    *IN20 = Update Customer
     O                 10      OCSBP
     O                 10      OCDBP
     O                 10      CCSBP
     O                 10      CCDBP
     O                 20      OCSCP
     O                 20      OCDCP
     O                 20      CCSCP
     O                 20      CCDCP
     O                 10      BMARP
     O                 20      CMARP
     O*
     OTRSETSF E                ETRSTS
     O*    UPDATE LF/TRSETS - Transaction Settlement Details- Sale
     O*    *IN10 = Update Broker
     O*    *IN20 = Update Customer
     O                 10      OCSBS
     O                 10      OCDBS
     O                 10      CCSBS
     O                 10      CCDBS
     O                 20      OCSCS
     O                 20      OCDCS
     O                 20      CCSCS
     O                 20      CCDCS
     O                 10      BMARS
     O                 20      CMARS
     OCLOST4F E                ECLOSP                                     E03643
     O*    UPDATE LF/CLOST4 - Close out transaction Details- Purchase     E03643
     O                         OCOB4                                      E03643
     O                         CCOB4                                      E03643
     O                         OCOC4                                      E03643
     O                         CCOC4                                      E03643
     O*                                                                   E03643
     OCLOST5F E                ECLOSS                                     E03643
     O*    UPDATE LF/CLOST5 - Close out transaction Details- Sale         E03643
     O                         OCOB5                                      E03643
     O                         CCOB5                                      E03643
     O                         OCOC5                                      E03643
     O                         CCOC5                                      E03643
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
