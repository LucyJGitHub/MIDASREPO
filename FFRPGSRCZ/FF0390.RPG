     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FF Transn update II (optns/unrl p & l)')         *
      *****************************************************************
      *                                                               *
      *  Midas  -  Futures and Options Module                         *
      *                                                               *
      *   FF0390  -  TRANSACTIONS UPDATE PHASE II                     *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. AR746662           Date 03May11               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. 247517             Date 09May07               *
      *                 247296             Date 25Apr07               *
      *                 CPK027             Date 16Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 245463             Date 08Feb07               *
      *                 241147A            Date 07Nov06               *
      *                 241147             Date 26Oct06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 216084             Date 19Jun06               *
      *                 168987             Date 26May06               *
      *                 204413             Date 13Jun02               *
      *                 CSD027             Date 09Dec05               *
      *                 CGL029             Date 01Sep03               *
      *                 215528             Date 21Mar03               *
      *                 CGL020             Date 12Dec02                  *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun02               *
      *                 CAS002             Date 14Jan02               *
      *                 193538             Date 07Dec01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CFF007             Date 13Feb01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CFF006             Date 28Nov00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 126117             Date 20Apr00               *
      *                 140017             Date 20Apr00               *
     F*                 140455             Date 20Apr00               *
     F*                 136056             Date 14Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
     F*                 CPB001             Date 18Jun99               *
      * Midas DBA 3.01 Patch E ---------------------------------------*
     F*               . 170520             Date 19Nov99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CAP003             Date 18Aug98               *
      *                 100819             DATE 24APR96                  *
      *                 113901             DATE 26FEB97                  *
     F*                 CFF003             Date 07Apr97                  *
     F*                 CAC003             Date 25Feb97               *
     F*                 CFF004             Date 16Sep96                  *
     F*                 099293             Date 29Jul96                  *
     F*                 098653             DATE 25JUL96                  *
     F*                 CPM003             DATE 01MAY96               *
     F*                 075998             DATE 12DEC95                  *
     F*                 S71062             DATE 12DEC95                  *
     F*                 S01408             DATE 09JAN96                  *
     F*                 S01408             DATE 09OCT95                  *
     F*                 073714             DATE 01MAR95                  *
     F*                 S01456             DATE 08NOV93                  *
     F*                 S01455             DATE 08NOV93                  *
     F*                 S01411             DATE 05JUL93                  *
     F*                 E30419             DATE 02MAR93                  *
     F*                 E30416             DATE 02MAR93                  *
     F*                 S01393             DATE 30OCT92                  *
     F*                 E44985             DATE 25SEP92                  *
     F*                  FUJI-FF0011        DATE 21AUG92                 *
     F*                  AUS022             DATE 07AUG92                 *
     F*                  E20526             DATE 03MAY90                 *
     F*                  S01117             DATE 19APR90                 *
     F*                                                                  *
     F*------------------------------------------------------------------*
      *                                                               *
      *  AR746662 - Discrepancy in premium amount in Currency OTC     *
      *             screen and Projected Available Balance Enquiry    *
      *             Applied fix 249171. (Recompile)                   *
      *             (Child: Artf746663)                               *
      *  247517 - Reversed fix 241147.                                *
      *  247296 -  For Ccy OTC, as MNPF was defaulted to '0.00000001',*
      *            net transaction value must be divided by 100.      *
      *  CPK027 - Errors in compiling MP1_3_TTTS - recompile over     *
      *           changed FFTVCLZ2.                                   *
      *  245463 - Applied fix 241735.                                 *
      *  241735 - Should use book profit centre instead of the ICD    *
      *           default if the posting is for the broker. Applied   *
      *  241147A - Recompile.                                         *
      *  241147 - Recompile.                                          *
      *  216084 - Use correct work fields when computing for          *
      *           contingent amounts. Corrected fix 168987 to         *
      *           use field EAMT instead of EVTA.                     *
      *  168987 - The event amount should be multiplied by the strike *
      *           price only if the processing type is 6.             *
      *           In case of processing type 3, the event amount must *
      *           be multiplied by the contract price.                *
     F*  204413 - If premium ccy different to that of the underlying, *
     F*           contingent postings are shown in premium currency.  *
     F*           Fix is to use other currency OTHC in PF/INTYPD when *
     F*           generating contingent a/c key for OTC trades whose  *
     F*           premium ccy is different from the underlying ccy.   *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  215528 - System is associating a wrong premium amount.       *
      *           Recompiled only.                                    *
      *  CGL020 - Midas Compliance Watch - Additional A/c Postings    *
      *           Information                                         *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed FFYTOPZ1.                    *
      *  CAS002 - Hedge Strategy/Linkage (Recompile)                  *
      *  193538 - No profit and loss generated once OTC trade was     *
      *           exercised due to suppression by 073714.  Applied fix*
      *           189417 to remove the suppresion.                    *
      *  CFF007 - Futures and Options Enhancement for Private Banking *
      *  CFF006 - Fractional Ticks Enhancement.  (Recompiled)         *
     F*  126117 - Recompiled due to changes to FFYTOPZ1.              *
     F*  140017 - Recompiled due to changes to FFPMCLZ1.              *
     F*  140455 - Recompiled due to changes to FFPMCLZ1               *
      *  136056 - Dft accuracy = 9; Australian 3 & 10 TB Future = 8.  *
      *           Recompiled due to changes in FFYTOPZ1               *
      *           Recalculate unrealised P/L                          *
      *  CPB001 - 'Private Banking' Module                            *
      *  170520 - Recompile over changed TRANSD file                  *
      *  CAP003 - Conversion of Midas inputs to modular API structure *
      *           (phase 2) - recompiled                              *
     F*  100819 - CONTINGENT AMOUNT CALCULATED WITH STRIKE PRICE         *
     F*           FOR COMMODITY (FIX 'BIKLUX/ENHAN1' FOR OPTION ONLY )   *
     F*           USE FF0390C004                                         *
     F*               FF0390C005                                         *
     F*  113901 - Due to fix 73714, account keys are generated when the  *
     F*           value date is reached but FBIN and FCIN indicators are *
     F*           updated before reaching the value date. TRANS3 (in     *
     F*           pgm FF0380) and TRANS4 (in FF0390) only take the       *
     F*           records with FBIN and FCIN = 'N'. In this case, account*
     F*           keys are never produced                                *
     F*  CFF003 - ENHANCED OTC PROCESSING - PHASE II                  *
     F*           UPGRADE FROM BLI LBL001 (RECOMPILE ONLY)            *
     F*  CAC003 - Profit Centre Accounting Development Phase 3.       *
     F*  CFF004 - Increase in size of Price Fields                       *
     F*  099293 - Remove the suppression of 'the generation of premium
     F*           a/c keys at end minus the exercise realized P/L' on
     F*           exercise of an option. The key is required to balance
     F*           out the premium a/c key at end, otherwise a suspense
     F*           entry will be generated. This relates to 073714.
     F*         - On exercise of the option, user should input the
     F*           'exercise price' the same as the 'strike price' such
     F*           that no exercise P/L will be generated in the F&O
     F*           module; the P/L should be realized by the underlying
     F*           transaction input as FX deal or SE trade in these
     F*           other modules. Should exercise P/L be realized in
     F*           F&O module and cash settlement to occur (instead of
     F*           carrying out the corr transaction), then exercise
     F*           price would be different to strike price, and an
     F*           additional exercise P/L key will be generated.
     F*  098653 - Missing account keys reported for OTC ccy options      *
     F*           after installing OTC enhancements (073714). 'Include   *
     F*           processing type on A/c key' is set to 'Y' in ICD but   *
     F*           the missing key has a blank processing type. Should    *
     F*           call SR/S00001 to set up the processing type for       *
     F*           OTC ccy options.                                       *
     F*  CPM003 - FF PM Interface Upgrade to R10.                     *
     F*  075998 - FF/PM Performance interface                         *
     F*  S71062 - FF/PM Interface - Initial margin                    *
     F*  S01408 - Addition of Core Hooks FF0390FFP2                      *
     F*                                  FF0390IIP1                      *
     F*                                  FF0390CCP7                      *
     F*                                  FF0390CCP8                      *
     F*  S01408 - Addition of Core Hooks FF0390FFP1                      *
     F*                                  FF0390EEP1                      *
     F*                                  FF0390CCP1                      *
     F*                                  FF0390CCP2                      *
     F*                                  FF0390CCP3                      *
     F*                                  FF0390CCP4                      *
     F*                                  FF0390CCP5                      *
     F*                                  FF0390CCP6                      *
     F*  073714 - OTC ENHANCEMENTS                                       *
     F*  S01456 - 'FF' MONTHLY P&L ENHANCEMENTS.                         *
     F*           Recompiled due to change to PF/MKCTLD.                 *
     F*  S01455 - 'FF' ACCOUNT KEY ENHANCEMENTS.                         *
     F*  S01411 - Recomplied as field 'ORIGINAL ENTRY DATE' added to     *
     F*           PF/TRANSD.                                             *
     F*  E30419 - Recompiled due to amendments on subroutine FFPLCL      *
     F*           due to rounding errors and incorrect sign of           *
     F*           profit/loss.                                           *
     F*  E30416 - Recompiled due to amendments on subroutines FFYTOP     *
     F*           and FFPLCL due to rounding errors on the               *
     F*           computation of values for 3-year bond futures.         *
     F*   S01393  -  RECOMPILED FOR STRATEGIC RISK MANAGEMENT            *
     F*   E44985  -  ZYIELD requires 3 new parameters. Recompile only    *
     F* FUJI-FF0011 - The system does not differentiate between          *
     F*               american and european option on exercise           *
     F*               validation and OTC confirmation wording.           *
     F*               *** RECOMPILE ONLY ***                             *
     F*   AUS022  -  AUSTRALIAN CHANGE : Introduction of Processing      *
     F*              Types 7 and 8.                                      *
     F*   E20526  -  RECOMPILED OVER CHANGED FILE PRICS                  *
     F*   S01117  -  MULTIBRANCHING                                      *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*     CREATION REQUIREMENTS                                        *
     F******IGNDECERR(*NO)                                               *073714
     F*     IGNDECERR(*YES)                                              *073714
     F********************************************************************
     F*
     F/COPY WNCPYSRC,FF0390FFP2                                           S01408
     F*
     F*ABTB10*IF* E                    DISK                               S01117
     FMKCTL   IF  E           K        DISK                           UC
     FMARKT   IF  E           K        DISK                           UC
     FINTYP2  IF  E           K        DISK
     F            INTYPDF                           KRENAMEINTYP2F
     FINTYP   IF  E           K        DISK
     FPRICS   IF  E           K        DISK
     FTRANS4  UP  E           K        DISK
     FTRSET   UF  E           K        DISK
     FWUNRLC  UF  E           K        DISK                      A
     FWUNRLK  UF  E           K        DISK                      A
     FFOKEYA  UF  E                    DISK
      *
     F/COPY WNCPYSRC,FF0390FFP1                                           S01408
      *
     FFOKEYD  O   E                    DISK                      A
     FPOCHGTC O   E                    DISK                      A
     FPOCHGTK O   E                    DISK                      A
     FPOCHGCC O   E                    DISK                      A
     FPOCHGCK O   E                    DISK                      A
     FFF0390AUO   E                    PRINTER
     F*
     F/SPACE 2
     F* ID F  C  H  L    FUNCTION OF INDICATORS
     F*
     F*       01         FIRST CYCLE COMPLETE
     F*
     F*       02         CHAIN FAILS FOR PRICS
     F*       03         CHAIN FAILS FOR WUNRLC -- BROKER
     F*       04         CHAIN FAILS FOR WUNRLC -- CUSTOMER
     F*       05         CHAIN FAILS FOR WUNRLK
     F*
     F*       06         WRITE BROKER CODE TO FOKEYD
     F*       07         WRITE CUSTOMER CODE TO FOKEYD
     F*
     F*       99         CHAIN FAILS
     F*
     F*              L2  CHANGE OF INSTRUMENT
     F*              L1  CHANGE OF PRICES KEY
     F*
     F*       U7         DATABASE ERROR
     F*       U8         PROGRAM  ERROR
     F*
     F*     80-89       Reserved for Standard FF Subroutines
     F*     90-99       Reserved for Standard MIDAS Subroutines
     F*
     E                    CPY@    1   1 80
     E*
     E********************************************************************
     E                    MSG     1   1 20
     E*
     E** ARRAY FOR UNDERLINING
     E                    FULA       34  1
      /COPY ZSRSRC,ZDATE2Z1
      /COPY ZSRSRC,FFFMTZ1
      *
     E/COPY WNCPYSRC,FF0390EEP1                                           S01408
      *
     E********************************************************************
     E*
      *                                                                   CFF007
     ITRSETDF                                                             CFF007
     I              RECI                            FRECI                 CFF007
      *                                                                   CFF007
     IINTYP2F
     I*
     I** Rename fields on INTYP2
     I*
     I              ISTT                            ISTT2
     I              ISPT                            ISPT2
     I              TKDM                            TKDM2
     I              MNPF                            MNPF2
     I              TKVL                            TKVL2
     IINTYPDF                                                             AUS022
     I              CNTT                            FFCNTT                AUS022
     ITRANSDF
     I*
     I** Level break on Instrument for TRANS4 file
     I*
     I              RECI                            TRECI
     I              PTFR                            TPTFR                 S71062
     I                                              ISTT  L2
     I                                              YRNO  L1
     I                                              MTHN  L1
     I                                              PCAL  L1
     I                                              STRP  L1
     I*
     IFFKY        DS
     I*
      ** ACCOUNT KEY SUB-FIELDS
     I*
     I                                        1   1 TYPE
     I                                        2   2 INVA                  S01455
     I                                        3   3 ETYP
     I                                        4   5 BOOK
     I                                        6  10 MKINST
     I/COPY WNCPYSRC,FF0390I001
     I                                       11  11 LORS
     I                                       12  12 PRTY
     I                                       14  14 AMTC
     IPRCKEY      DS
     I*
     I** DATA STRUCTURE TO STORE THE KEY FIELDS
     I*
     I                                        1   5 ISTT
     I                                        6   70YRNO
     I                                        8   90MTHN
     I                                       10  10 PCAL
     I***********                            11  217STRP                  CFF004
     I                                       11  258STRP                  CFF004
     I/COPY ZSRSRC,ZYLDZ1                                                 AUS022
     I*DA********UDS                            256                       S01117
     ILDA         DS                            256                       S01117
     I*
     I** LOCAL DATA AREA FOR DATABASE ERROR DETAILS
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 1770DBASE                 S01117
     I                                      134 180 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     IRUNDT       DS                                                      S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
      *                                                                   S01455
     ISDFODA    E DSSDFODAPD                                              S01455
      * SDFODAPD - Futures and Options Data data structure                S01455
      *                                                                   S01455
     ISCSARD    E DSSCSARDPD                                              CFF007
      ** External data structure for SAR details                          CFF007
      *                                                                   CFF007
     ISDBANK    E DSSDBANKPD                                              S01117
     I**  BANK DETAILS DATA STRUCTURE                                     S01117
     I              BJURPT                          TITL                  S01117
     ISDGELR    E DSSDGELRPD                                              073714
     I              QQACCD                          ACCDQQ                                    CGL029
     I**  GENERAL LEDGER DETAILS DATA STRUCTURE                           073714
      *                                                                   S71062
     ISDMMOD    E DSSDMMODPD                                              S71062
      **  EXTERNAL DS FOR MODULE DETAILS                                  S71062
     ISDPORT    E DSSDPORTPD                                              CPM003
     I** Portfolio Management ICD                                         CPM003
     I@DSFDY    E DSDSFDY                                                 S01117
     I**  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE              S01117
     I*
      /COPY ZSRSRC,FFSRDSZ1
     I** DATA STRUCTURE FOR STD SUBROUTINE,FFTVCL
      /COPY ZSRSRC,FFFMTZ2
     I********************************************************************
      /EJECT
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                                       CGL020
     I            DS                                                                          CGL020
     I**********                              1   60PCBCD                              CGL020 CSD027
     I                                        1   6 PCBCD                                     CSD027
      ** Customer Broker Code Parameter for ZAAMLSETFF                                        CGL020
      *                                                                                       CGL020
     I              'ZAAMLSETFF'          C         WZAAML                                    CGL020
     I*
     I/COPY WNCPYSRC,FF0390IIP1                                           S01408
      *                                                                                       CGL029
     IDSSDY     E DSDSSDY                                                                     CGL029
      *                                                                                       CGL029
     I*
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
      **  DEFINE KEY LIST FOR CHAINING TO PRICS  FILE
     C*
     C           PRICSK    KLIST
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C*
      **  DEFINE KEY LIST FOR CHAINING TO WUNRLC FILE
     C*
     C           WUNRCK    KLIST
     C***********          KFLD           BRCD                            S01117
     C                     KFLD           BRCA                            S01117
     C                     KFLD           CBCD
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C*
      **  DEFINE KEY LIST FOR CHAINING TO WUNRLK FILE
     C*
     C           WUNRKK    KLIST
     C***********          KFLD           BRCD                            S01117
     C                     KFLD           BRCA                            S01117
     C                     KFLD           BOKC
     C                     KFLD           ISTT
     C                     KFLD           YRNO
     C                     KFLD           MTHN
     C                     KFLD           PCAL
     C                     KFLD           STRP
     C*
      ** PARMETER ON MARKET CENTER
     C*
     C           *ENTRY    PLIST
     C                     PARM           PMRKT   2
      /EJECT
     C*================================================================
     C*  P R O G R A M     S T A R T
     C*================================================================
     C*
      ** START PROCESS - THE INITIAL DATA RETRIEVALS
     C*
     C           *IN01     IFEQ '0'
     C                     EXSR START
     C                     END
     C*
      ** ACCESS INTYP FOR INSTRUMENT TYPE DETAILS IF CHANGED
     C*
     C           *INL1     IFEQ '1'
     C*
     C           ISTT      CHAININTYP                99
     C*
      ** DB ERROR
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     SETON                     U7U8LR***************
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'03'      DBASE            **DB ERROR 03**S01117
     C                     Z-ADD3         DBASE            **DB ERROR 03**S01117
     C                     MOVEL'INTYP'   DBFILE           ***************
     C                     MOVELISTT      DBKEY
     C                     OUT  LDA                                       S01117
     C                     WRITEDBERROR
     C                     EXSR *PSSR                                     S01117
     C                     RETRN
     C                     END
     C*
      ** IF THE INSTRUMENT ON THE TRANSACTION IS AN OTC THE TICKS
      ** DENOMINATOR, MIN PRICE FLUCTUATION AND TICK VALUE ARE
      ** THOSE FOUND ON THE INSTRUMENT TYPE RECORD FOR THE OTC
      ** OTHERWISE (THE INSTRUMENT TYPE IS A MARKET INSTRUMENT) COMBINE
      ** FUTURE TYPE REFERENCE WITH MARKET CENTER AND ACCESS INTYP2
     C*
     C           ISTI      IFEQ 'N'
     C           ISPT      ANDGT3
     C           ISPT      ANDNE7                                         AUS022
     C*
     C           *LIKE     DEFN ISTT      TISTT
     C                     MOVE ISTT      TISTT
     C                     MOVE FTRF      TISTT
     C           TISTT     CHAININTYP2               99
     C*
      ** DB ERROR
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     SETON                     U7U8LR***************
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'04'      DBASE            **DB ERROR 04**S01117
     C                     Z-ADD4         DBASE            **DB ERROR 04**S01117
     C                     MOVEL'INTYP'   DBFILE           ***************
     C                     MOVELTISTT     DBKEY
     C                     OUT  LDA                                       S01117
     C                     WRITEDBERROR
     C                     EXSR *PSSR                                     S01117
     C                     RETRN
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
      ** ACCESS PRICS FOR MARKET PRICES SETON *IN02 IF NO PRICE IS FOUND
     C*
     C           *INL1     IFEQ '1'
     C*
     C           PRICSK    CHAINPRICS                02
     C  N02      RECI      COMP 'D'                  0202
     C*
     C                     END
     C*
      ** MAIN PROCESS - THE MAIN PROGRAM LOGIC
     C*
     C                     EXSR MAIN
     C*
      ** END PROCESS - UPDATING COMPLETED OR DB ERRORS
     C*
     CLR                   EXSR TOTAL
     C*
     C*================================================================
     C*  P R O G R A M     E N D
     C*================================================================
      /EJECT
      ********************************************************************
      ** INDEX OF SUBROUTINES
      **
      ** START             INITIALISATION AND STANDING DATA ACCESSES
      **
      ** MAIN              CONTROLLING SUBROUTINE FOR TYPE OF TRANSACTION
      **                   PROCESSING REQUIRED
      **
      ** TOTAL             LAST RECORD PROCESSING - AUDIT REPORT/RECORDS
      **                   UPDATE
      **
      ** OPTACK            TO DETERMINE TYPE OF OPTION ACCOUNT KEY TO
      **                   BE GENERATED
      **
      ** EXRLPL            TO CALCULATE EXERCISE REALISED PROFIT/LOSS
      **
      ** OPTPRS            GENERATE OPTION ACCOUNT KEY TO FOKEY BASED
      **                   ON PREMIUM AT START (TRADE INPUT)
      **
      ** OPTPRE            GENERATE OPTION ACCOUNT KEY TO FOKEY BASED
      **                   ON PREMIUM AT END (EXERCISE INPUT)
      **
      ** OPTEXP            GENERATE OPTION ACCOUNT KEY TO FOKEY BASED
      **                   ON EXERCISE P/L - PREMIUM (EXERCISE INPUT)
      **
      ** OPTEPL            GENERATE OPTION ACCOUNT KEY TO FOKEY BASED
      **                   ON EXERCISE P/L (EXERCISE INPUT)
      **
      ** OPTPOT            GENERATE TRANSACTION POSITION CHANGE RECORDS
      **                   (FOR TRADE AND EXERCISE PREMIUMS)
      **
      ** OPTPOC            GENERATE CLOSE OUT (REALISED P/L) POSITION
      **                   CHANGE RECORDS (FOR EXERCISE REALIZED P/L)
      **
      ** UNRLPL            UNREALIZED PROFIT/LOSS CALCULATION
      **
      ** OWUNRL            OUTPUT THE UNREALISED P/L TO WUNRLC AND
      **                   WUNRLK FILES
      **
      ** CTGACK            CONTINGENT ACCOUNT KEY PROCESSING WHEN THE
      **                   TRANSACTION IS A BOOK TRADE
      **
      ** CTGACO            CONTINGENT ACCOUNT KEY PROCESSING WHEN THE     073714
      **                   TRANSACTION IS A BOOK TRADE (OTC CURRENCY OPT) 073714
      **                                                                  073714
      ** FFPLCL            STANDARD SUBROUTINE FOR PROFIT/LOSS CALCULATION
      **
      ** FFTVCL            STANDARD SUBROUTINE FOR TRANSACTION VALUE
      **                   CALCULATION
      **                                                                  AUS022
      ** FFYTOP            STANDARD SUBROUTINE FOR YIELD/PRICE CALCULATIONAUS022
      **
      ** ZZADD             STANDARD SUBROUTINE TO HASH AMOUNTS
      **
      ** FFFMT             STANDARD SUBROUTINE TO FORMAT MARKET NAME/DATE
      **
      ** ZDATE2            STANDARD SUBROUTINE TO CONVERT MIDAS DAYNO TO
      **                   A DATE
      **
      ** *PSSR             HANDLE ABNORMAL ERROR CONDITIONS               S01117
      **                                                                  S01117
      ********************************************************************
      /EJECT
      ********************************************************************
      **
      ** START S/R - TO INITIALISE STATIC FIELDS AND ACCESS STANDING DATA
      ** CALLED ONCE AT START OF PROGRAM
      ** CALLS NO OTHER ROUTINES
      **
      ********************************************************************
     C*
     C           START     BEGSR                           * START BEGSR *
     C*
      ** PREPARE LDA
     C*
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL*BLANK    DBLOT
     C                     MOVEL'FF0390'  DBPGM
     C                     Z-ADD0         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     SETON                     01
     C*
      ** ACCESS MARKET CENTER FILE FOR CURRENT BUSINESS DATE IF PARAMETER
      ** IS NOT BLANK
     C*
     C           PMRKT     IFNE *BLANKS
     C*
     C                     OPEN MKCTL
     C*
     C           PMRKT     CHAINMKCTL                99
     C*
      ** DB ERROR
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     SETON                     U7U8LR***************
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'01'      DBASE            **DB ERROR 01**S01117
     C                     Z-ADD1         DBASE            **DB ERROR 01**S01117
     C                     MOVEL'MKCTL'   DBFILE           ***************
     C                     MOVELPMRKT     DBKEY
     C                     OUT  LDA                                       S01117
     C                     WRITEDBERROR
     C                     EXSR *PSSR                                     S01117
     C                     RETRN
     C                     END
     C*
     C*********************MOVE BUSD      VDAT                            073714
     C*
      ** Access market file for market name
     C*
     C                     OPEN MARKT
     C*
     C           PMRKT     CHAINMARKT                99
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'MARKT'   DBFILE           ***************
     C                     MOVELPMRKT     DBKEY            * DB ERROR 08 *
     C                     Z-ADD08        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     WRITEDBERROR
     C                     EXSR *PSSR                                     S01117
     C                     RETRN
     C                     END
     C*
     C                     END
     C*                                                                   S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST  '@OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    @DSFDY                          S01117
     C***********                                                         S01117
      ***GET*INSTALLATION*CONTROL*DATA*RECORD*1*FOR*RUN*DATE**************S01117
     C***********                                                         S01117
     C***********          READ TABTB10                  99               S01117
     C***********                                                         S01117
      ***DB*ERROR*********************************************************S01117
     C***********                                                         S01117
     C************IN99     IFEQ '1'                                       S01117
     C***********RECI      ORNE 'D'                                       S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C                     SETON                     U7U8LR***************
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'02'      DBASE            **DB ERROR 02**S01117
     C                     Z-ADD2         DBASE            **DB ERROR 02**S01117
     C***********          MOVEL'TABFF'   DBFILE           ***************S01117
     C                     MOVEL'SDBANKPD'DBFILE           ***************S01117
     C***********          MOVEL'01'      ZTABKY 12                       S01117
     C***********          MOVE '10'      ZTABKY                          S01117
     C***********          MOVELZTABKY    DBKEY                           S01117
     C                     MOVEL@OPTN     DBKEY                           S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     OUT  LDA                                       S01117
     C                     WRITEDBERROR
     C                     EXSR *PSSR                                     S01117
     C                     RETRN
     C                     END
     C*                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
     C*                                                                   S71062
     C** Access SDMMODPD                                                  S71062
     C** IF no record found,                                              S71062
     C**     Perform Database-error                                       S71062
     C*                                                                   S71062
     C                     CALL 'AOMMODR0'                                S71062
     C                     PARM '*MSG   ' @RTCD                           S71062
     C                     PARM '*FIRST ' @OPTN                           S71062
     C           SDMMOD    PARM SDMMOD    @DSFDY                          S71062
     C*                                                                   S71062
     C           @RTCD     IFNE *BLANK                                    S71062
     C                     SETON                     U7U8LR               S71062
     C           *LOCK     IN   LDA                                       S71062
     C                     MOVEL'SDMMODPD'DBFILE                          S71062
     C                     MOVEL@OPTN     DBKEY                           S71062
     C                     MOVEL@OPTN     DBOPTN           ***************S71062
     C                     Z-ADD10        DBASE            * DB ERROR 10 *S71062
     C                     OUT  LDA                        ***************S71062
     C                     WRITEDBERROR                                   S71062
     C                     EXSR *PSSR                                     S71062
     C                     RETRN                                          S71062
     C                     END                                            S71062
     C*                                                                   CAC003
     C** Check if Analytical Accounting and Switchable Feature            CAC003
     C** CAC003 are switched on.                                          CAC003
     C                     MOVE '0'       *IN20                           CAC003
     C*                                                                   CAC003
     C                     CALL 'AOSARDR0'                                CAC003
     C                     PARM           @RTCD                           CAC003
     C                     PARM '*VERIFY' @OPTN                           CAC003
     C                     PARM 'CAC003'  @SARD   6                       CAC003
      *                                                                   CAC003
     C           @RTCD     IFEQ *BLANK                                    CAC003
     C           BGN0ST    ANDEQ'Y'                                       CAC003
     C                     MOVE '1'       *IN20                           CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CPM003
     C           BGPFMG    IFEQ 'Y'                                       CPM003
     C                     CALL 'AOPORTR0'                                CPM003
     C                     PARM *BLANKS   @RTCD                           CPM003
     C                     PARM '*FIRST  '@OPTN                           CPM003
     C           SDPORT    PARM SDPORT    @DSFDY                          CPM003
     C           @RTCD     IFNE *BLANKS                                   CPM003
     C                     SETON                     U7U8LR               CPM003
     C           *LOCK     IN   LDA                                       CPM003
     C                     MOVE *BLANKS   DBKEY            ***************CPM003
     C                     Z-ADD11        DBASE            * DB ERROR 11 *CPM003
     C                     MOVE 'SDPORTPD'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     WRITEDBERROR                                   CPM003
     C                     EXSR *PSSR                                     CPM003
     C                     RETRN                                          CPM003
     C                     END                                            CPM003
     C                     END                                            CPM003
     C*                                                                   073714
      ** GET INSTALLATION CONTROL DATA RECORD 2                           073714
     C*                                                                   073714
     C**********           CALL 'AOGELRR0'                                             073714 CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD                           073714
     C                     PARM '*FIRST  '@OPTN                           073714
     C********** SDGELR    PARM SDGELR    @DSFDY                          073714              CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*                                                                   073714
      ** DB ERROR                                                         073714
     C*                                                                   073714
     C           @RTCD     IFNE *BLANK                                    073714
     C                     SETON                     U7U8LR               073714
     C           *LOCK     IN   LDA                        ***************073714
     C                     Z-ADD09        DBASE            * DB ERROR 09 *073714
     C                     MOVEL'SDGELRPD'DBFILE           ***************073714
     C                     MOVEL@OPTN     DBKEY                           073714
     C                     MOVEL@OPTN     DBOPTN                          073714
     C                     OUT  LDA                                       073714
     C                     WRITEDBERROR                                   073714
     C                     EXSR *PSSR                                     073714
     C                     RETRN                                          073714
     C                     END                                            073714
     C*                                                                   073714
      ** DETERMINE EVENT CONTROL DATE                                     073714
     C*                                                                   073714
     C           PMRKT     IFEQ *BLANK                                    073714
     C           BKAPDT    IFLT BJDNWD                                    073714
     C                     Z-ADDBKAPDT    EVCD    50                      073714
     C                     ELSE                                           073714
     C           BJDNWD    SUB  1         EVCD                            073714
     C                     END                                            073714
     C                     ELSE                                           073714
     C                     Z-ADDBUSD      EVCD                            073714
     C                     END                                            073714
     C***********                                                         073714
      ***MOVE*RUN DATE TO EVENT DATE                                      073714
     C***********                                                         073714
     C***********          MOVE RUND      EDAT                            073714
     C***********VDAT      IFEQ *ZERO                                     073714
     C***********          MOVE RUND      VDAT                            073714
     C***********          END                                            073714
     C*
      ** Check date format
     C*
     C           DATF      COMP 'M'                      98
     C*
      **          Format run/business date for report title
     C*
     C           PMRKT     IFNE *BLANKS
     C                     Z-ADDBUSD      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    FFDAT
     C                     MOVE MKTN      FFNAM
     C                     ELSE
     C                     MOVE MSG,1     FFNAM
     C                     MOVE RUNA      FFDAT
     C                     END
     C*
     C                     EXSR FFFMT
     C                     MOVE FFTXT     MNAMED
     C*
     C**  Set up underlining for heading
     C**  Initialise array index
     C                     Z-ADD0         X       20
     C*
     C**  FFULIN returned from SR. FFFMT contains number of characters
     C**  for underline
     C           X         DOUEQFFULIN
     C                     ADD  1         X
     C                     MOVEA'-'       FULA,X
     C                     END
     C*
     C**  Move underline array to output field
     C                     MOVEAFULA      FULINE
     C*
     C**  SET BROKER AND CUST/BOOK UNREALISED PL TO 0                     AUS022
     C                     Z-ADD0         BUPAL  152                      AUS022
     C                     Z-ADD0         CUPAL  152                      AUS022
     C*                                                                   AUS022
      *                                                                   S01455
      *** Use the Access object to obtain the FF ICD details.             S01455
      *                                                                   S01455
     C                     CALL 'AOFODAR0'                                S01455
     C                     PARM '*MSG   ' P@RTCD  7        B:Return code  S01455
     C                     PARM '*FIRST ' P@OPTN  7        I:Option       S01455
     C           SDFODA    PARM SDFODA    @DSFDY           O:Format       S01455
     C           P@RTCD    IFNE *BLANKS                                   S01455
     C*DO NOT CHECK FOR RECI                                              S01455
     C********** RECI      ORNE 'D'                                       S01455
     C                     SETON                     U7U8LR               S01455
     C           *LOCK     IN   LDA                                       S01455
     C                     MOVE 'SDFODAPD'DBFILE                          S01455
     C                     MOVELP@OPTN    DBKEY                           S01455
     C                     Z-ADD9         DBASE            ***************S01455
     C                     MOVELP@OPTN    DBOPTN  7        *DB ERROR  09**S01455
     C                     OUT  LDA                        ***************S01455
     C                     WRITEDBERROR                                   S01455
     C                     EXSR *PSSR                                     S01455
     C                     RETRN                                          S01455
     C                     END                                            S01455
      *
     C/COPY WNCPYSRC,FF0390CCP1                                           S01408
      *
     C                     MOVE 'N'       CFF007  1                       CFF007
     C                     CALL 'AOSARDR0'                                CFF007
     C                     PARM *BLANKS   PRTCD   7                       CFF007
     C                     PARM '*VERIFY' POPTN   7                       CFF007
     C                     PARM 'CFF007'  PSARD   6                       CFF007
     C           SCSARD    PARM SCSARD    @DSFDY                          CFF007
     C           PRTCD     IFEQ *BLANKS                                   CFF007
     C                     MOVE 'Y'       CFF007                          CFF007
     C                     ELSE                                           CFF007
     C           PRTCD     IFNE '*NRF   '                                 CFF007
     C           *LOCK     IN   LDA                                       CFF007
     C                     MOVE '040'     DBASE                           CFF007
     C                     MOVEL'CFF007  'DBKEY                           CFF007
     C                     MOVEL'SCSARDPD'DBFILE                          CFF007
     C                     OUT  LDA                                       CFF007
     C                     MOVE *ON       *INU7                           CFF007
     C                     MOVE *ON       *INU8                           CFF007
     C                     MOVE *ON       *INLR                           CFF007
     C                     WRITEDBERROR                                   CFF007
     C                     EXSR *PSSR                                     CFF007
     C                     RETRN                                          CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
     C                     Z-ADDVDAT      WWVDAT  50                      CFF007
      *                                                                                       CGL020
      ** Check if Switchable Feature CGL020 is switched on.                                   CGL020
      *                                                                                       CGL020
     C                     CALL 'AOSARDR0'                                                    CGL020
     C                     PARM *BLANKS   PRTCD                                               CGL020
     C                     PARM '*VERIFY' POPTN                                               CGL020
     C                     PARM 'CGL020'  PSARD                                               CGL020
     C           SCSARD    PARM SCSARD    @DSFDY                                              CGL020
      *                                                                                       CGL020
      ** Database error                                                                       CGL020
      *                                                                                       CGL020
     C           PRTCD     IFNE *BLANKS                                                       CGL020
     C           PRTCD     ANDNE'*NRF   '                                                     CGL020
     C           *LOCK     IN   LDA                                                           CGL020
     C                     Z-ADD41        DBASE                                               CGL020
     C                     MOVEL'CGL020  'DBKEY                                               CGL020
     C                     MOVEL'SCSARDPD'DBFILE                                              CGL020
     C                     OUT  LDA                                                           CGL020
     C                     EXSR *PSSR                                                         CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C           PRTCD     IFEQ *BLANKS                                                       CGL020
     C                     MOVE 'Y'       CGL020  1                                           CGL020
     C                     ELSE                                                               CGL020
     C                     MOVE 'N'       CGL020                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C*                                                                   S01455
     C           XTSTAR    ENDSR                           ** XTSTAR ESR**
     C*===================================================================
      /EJECT
      ********************************************************************
      **
      ** MAIN  S/R TO PROCESS TRANS3 RECORD
      ** CALLED ONCE AT START OF THE PROGRAM
      ** CALLS: OPTACK TO PROCESS OPTION ACCOUNT KEYS
      **        CTGACK TO PROCESS CONTINGENT ACCOUNT KEYS
      **        CTGACO TO PROCESS CONTINGENT ACCOUNT KEYS                 073714
      **        OWUNRL TO PROCESS OUTPUT TO WUNRL
      **
      ********************************************************************
     C*
     C           MAIN      BEGSR                           ** MAIN  BSR **
     C*
      ** ACCESS TRSET FOR TRANSACTION SETTLEMENT DETAILS
     C*
     C           TNBR      CHAINTRSET                99
     C*
      ** DB ERROR
     C*
     C           *IN99     IFEQ '1'
     C***********RECI      ORNE TRECI                                     CFF007
     C           FRECI     ORNE TRECI                                     CFF007
     C                     SETON                     U7U8LR***************
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'06'      DBASE            **DB ERROR 06**S01117
     C                     Z-ADD6         DBASE            **DB ERROR 06**S01117
     C                     MOVEL'TRSET'   DBFILE           ***************
     C                     MOVELTNBR      DBKEY
     C                     OUT  LDA                                       S01117
     C                     WRITEDBERROR
     C                     EXSR *PSSR                                     S01117
     C                     RETRN
     C                     END
     C*                                                                   073714
      ** VALUE DATE FOR MARKET TRADES AND EXERCISES IS TRANSACTION DATE   073714
     C/COPY WNCPYSRC,FF0390C006
      *                                                                   CFF007
     C           CFF007    IFEQ 'N'                                       CFF007
     C*                                                                   073714
     C           ISTI      IFEQ 'N'                                       073714
     C           TRTY      OREQ 'E'                                       073714
     C                     Z-ADDTRSD      VALD                            073714
     C                     END                                            073714
     C/COPY WNCPYSRC,FF0390C007
      *                                                                   CFF007
     C                     ENDIF                                          CFF007
     C*
      ** IF THE INSTRUMENT TYPE IS AN OPTION
     C*
     C           ISPT      IFGT 3
     C           ISPT      ANDNE7                                         AUS022
     C*
      ** IF THE TRANSACTION IS LIVE & HAS NOT YET BEEN PROCESSED BY AN EOC
      ** AND THE VALUE DATE HAS BEEN REACHED                              073714
      ** OR IF THE TRANSACTION IS REVERSED & HAS BEEN PROCESSED BY AN EOC
      **    GENERATE PREMIUM AND EXERCISE REALISED P/L ACCOUNT KEYS
     C/COPY WNCPYSRC,FF0390C008
      *                                                                   CFF007
     C           CFF007    IFEQ 'N'                                       CFF007
     C*
     C           TRECI     IFEQ 'D'
     C           ECPI      ANDEQ'N'
     C           VALD      ANDLEEVCD                                      073714
     C           TRECI     OREQ '*'
     C           ECPI      ANDEQ'Y'
     C                     EXSR OPTACK
     C                     END
     C/COPY WNCPYSRC,FF0390C009
      *                                                                   CFF007
     C                     ELSE                                           CFF007
     C           TRECI     IFEQ 'D'                                       CFF007
     C           ECPI      ANDEQ'N'                                       CFF007
     C           TRECI     OREQ '*'                                       CFF007
     C           ECPI      ANDEQ'Y'                                       CFF007
     C                     EXSR OPTACK                                    CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
     C*
     C                     END
     C*
      ** IF THE TRANSACTION IS A TRADE
     C*
     C           TRTY      IFEQ 'P'
     C           TRTY      OREQ 'S'
     C*
      ** PROCESS CONTINGENT ACCOUNT KEYS.OUTPUT ONLY IF EITHER
      ** BROKER OR CUSTOMER IS ZERO, IE IF TRADE IS THROUGH A BOOK
     C*
     C********** BOCO      IFEQ 0                                                             CSD027
     C********** CUSC      OREQ 0                                                             CSD027
     C           BOCO      IFEQ *BLANKS                                                       CSD027
     C           CUSC      OREQ *BLANKS                                                       CSD027
     C/COPY WNCPYSRC,FF0390C023
     C*                                                                   073714
      ** IF OTC CURRENCY OPTION                                           073714
     C*                                                                   073714
     C           ISTI      IFEQ 'Y'                                       073714
     C           ISPT      ANDEQ5                                         073714
     C                     EXSR CTGACO                                    073714
     C                     ELSE                                           073714
     C                     EXSR CTGACK
     C                     END                                            073714
     C                     END
     C*
     C           TRECI     IFEQ 'D'
     C*
      ** IF A PRICE WAS FOUND FOR THIS INSTRUMENT DETERMINE UNREALIZED
      ** P/L AND OUTPUT THIS UNREALIZED P/L TO WUNRLC/WUNRLK
     C*
     C           *IN02     IFEQ '0'
     C                     EXSR UNRLPL
     C                     EXSR OWUNRL
     C*
     C/COPY WNCPYSRC,FF0390CCP7                                           S01408
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
      ** UPDATE TRANSACTION DETAILS AND TRANSACTION SETTLEMENT DETAILS
     C*
      ** IF THE VALUE DATE HAS BEEN REACHED                               113901
      ** IF BROKER NOW CLOSED OUT, UPDATE FINAL CLOSURE INDICATOR
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           NOBO      ANDEQ0
     C           VALD      ANDLEEVCD                                      113901
     C                     MOVE 'Y'       FBIN
     C                     END
     C*
      ** IF THE VALUE DATE HAS BEEN REACHED                               113901
      ** IF CUSTOMER NOW CLOSED OUT, UPDATE FINAL CLOSURE INDICATOR
     C*
     C           NOCO      IFEQ 0
     C           VALD      ANDLEEVCD                                      113901
     C                     MOVE 'Y'       FCIN
     C                     END
     C*
      ** IF CUSTOMER AND BROKER NOW CLOSED OUT, SET FINAL CLOSURE DATE
     C*
     C           FCIN      IFEQ 'Y'
     C           FBIN      ANDEQ'Y'
     C                     Z-ADDVDAT      FCDA
     C                     END
     C*
      ** IF THE VALUE DATE HAS BEEN REACHED                               073714
      ** TRANSACTION HAS NOW PASSED THROUGH AN END OF CENTRE
     C/COPY WNCPYSRC,FF0390C010
      *                                                                   CFF007
     C           CFF007    IFEQ 'N'                                       CFF007
     C*
     C           TRECI     IFEQ 'D'
     C           VALD      ANDLEEVCD                                      073714
     C                     MOVE 'Y'       ECPI
     C                     END
     C/COPY WNCPYSRC,FF0390C011
      *                                                                   CFF007
     C                     ELSE                                           CFF007
     C           TRECI     IFEQ 'D'                                       CFF007
     C                     MOVE 'Y'       ECPI                            CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
     C*
     C** TRANSACTION IS REVERSED
     C*
     C           TRECI     IFEQ '*'
     C/COPY WNCPYSRC,FF0390C012
      *                                                                   CFF007
     C           CFF007    IFEQ 'N'                                       CFF007
     C***********          MOVE 'R'       RECI                            CFF007
     C                     MOVE 'R'       FRECI                           CFF007
     C                     MOVE 'R'       TRECI
      *
     C/COPY WNCPYSRC,FF0390CCP2                                           S01408
      *                                                                   CFF007
     C                     ELSE                                           CFF007
     C           VALD      IFLE BUSD                                      CFF007
     C                     MOVE 'R'       FRECI                           CFF007
     C                     MOVE 'R'       TRECI                           CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
      *
     C                     END
     C*
     C                     EXCPTUTRANS
     C                     EXCPTUTRSET
     C*
     C                     ENDSR                           ** MAIN   ESR**
     C*===================================================================
      /EJECT
      ********************************************************************
      **
      ** TOTAL S/R TO PROCESS AUDIT RECORD/REPORT
      ** CALLED ONCE AT END OF THE PROGRAM
      ** CALLS:
      **
      ********************************************************************
     C*
     C           TOTAL     BEGSR                           ** TOTAL BSR **
     C*
      ** DO INITIALISATION PROCESSING IF NOT YET DONE
     C*
     C           *IN01     IFEQ '0'
     C                     EXSR START
     C                     END
     C*
      ** WRITE TO AUDIT REPORT
     C*
     C                     WRITEAUDIT
     C*
     C           COUNT     IFGT 0
     C                     READ FOKEYAF                  99
     C*
      ** DB ERROR
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'T'
     C                     SETON                     U7U8LR***************
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'07'      DBASE            **DB ERROR 07**S01117
     C                     Z-ADD7         DBASE            **DB ERROR 07**S01117
     C                     MOVEL'FOKEY'   DBFILE           ***************
     C                     MOVEL'TRAILER' DBKEY
     C                     OUT  LDA                                       S01117
     C                     WRITEDBERROR
     C                     EXSR *PSSR                                     S01117
     C                     RETRN
     C                     END
     C*
      ** UPDATE AUDIT RECORD TOTALS
     C*
     C                     ADD  COUNT     NORE
     C*
     C** ADD HASH TOTAL TO FILE CONTROL TOTAL, ACCOMODATING OVERFLOW
     C*
     C                     ADD  ZZTOTI    HRWN
     C           HRDC      ADD  ZZTOTD    TEMP    30
     C*
     C           TEMP      IFLT HRDC
     C                     ADD  1         HRWN
     C                     END
     C*
     C                     Z-ADDTEMP      HRDC
     C*
     C                     UPDATFOKEYAF
     C                     END
     C***********                                                         S01117
      ***WRITE*TO*AUDIT*REPORT*(END*OF*REPORT)****************************S01117
     C***********                                                         S01117
     C***********          WRITEEND                                       S01117
     C*
     C                     ENDSR                           ** TOTAT  ESR**
     C*===================================================================
      /EJECT                                                              S01455
     C           S00001    BEGSR                                          S01455
      *                                                                   S01455
      ********************************************************************S01455
      *                                                                   S01455
      ** The instrument type is defined on the account key                S01455
      ** but for market instruments only                                  S01455
      *                                                                   S01455
     C           BXISTY    IFEQ 'Y'                                       S01455
     C           ISTI      IFEQ 'N'                                       S01455
     C                     MOVE ISTT      MKINST                          S01455
     C                     MOVELPMRKT     MKINST                          S01455
     C                     ELSE                                           S01455
     C                     MOVE '     '   MKINST                          S01455
     C                     END                                            S01455
     C                     ELSE                                           S01455
     C/COPY WNCPYSRC,FF0390C001
     C                     MOVE '     '   MKINST                          S01455
     C                     END                                            S01455
     C/COPY WNCPYSRC,FF0390C002
     C*                                                                   S01455
      ** The processing type is only valid if indicator is 'Y'            S01455
      ** on I.C.D. "SDFODAPD"                                             S01455
      *                                                                   S01455
     C           BXPROT    IFEQ 'Y'                                       S01455
     C                     MOVE ISPT      INVA                            S01455
     C                     ELSE                                           S01455
     C                     MOVE *BLANKS   INVA                            S01455
     C                     END                                            S01455
      *                                                                   S01455
     C/COPY WNCPYSRC,FF0390C003
     C                     ENDSR                                          S01455
     C********************************************************************S01455
      /EJECT
     C********************************************************************
      **
      ** OPTACK S/R TO GENERATE OPTION ACCOUNT KEYS/POSITION CHANGE RECORDS
      ** CALLED FROM MAIN S/R
      ** CALLS: OPTPRS TO GENERATE PREMIUM A/C KEYS ON TRADE INPUT
      **        OPTPOT TO GENERATE TRANSACTION POSITION CHANGE RECORDS
      **        EXRLPL TO CALCULATE EXERCISE REALISED P/L
      **        OPTPRE TO GENERATE PREMIUM       A/C KEYS ON EXERCISE INPUT
      **        OPTEXP TO GENERATE P/L - PREMIUM A/C KEYS ON EXERCISE INPUT
      **        OPTEPL TO GENERATE EXERCISE P/L  A/C KEYS ON EXERCISE INPUT
      **        OPTPOC TO GENERATE CLOSE OUT POSITION CHANGE RECORDS
      **
     C********************************************************************
     C*
     C           OPTACK    BEGSR                           ** OPTACK BSR**
     C*
      ** IF THE TRANSACTION IS A TRADE
     C*
     C           TRTY      IFEQ 'P'
     C           TRTY      OREQ 'S'
     C*
      ** GENERATE A/C KEYS FOR THE PREMIUM AT START AMOUNT
      ** ( FOR THE PREMIUM PAYABLE ON THE TRADE )
     C*
     C           PRMP      IFNE 0
     C           PRMP      OREQ 0                                         075998
     C           PUPF      ANDEQ'Y'                                       075998
     C           BGPFMG    ANDEQ'Y'                                       075998
     C** If Bank Portfolios are supported, treat as if PM off             CPM003
     C           FCPORS    ANDNE'B'                                       CPM003
     C           PRMP      OREQ 0                                         CPB001
     C           PUPF      ANDEQ'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C*
     C                     EXSR OPTPRS
     C*
      ** GENERATE TRANSACTION POSITION CHANGE RECORDS FOR PREMIUM PAYABLE
      ** IF THE PREMIUM UP FRONT INDICATOR FOR THE INSTRUMENT IS 'Y'
     C*
     C           PUPF      IFEQ 'Y'
     C           PRMP      ANDNE0                                         075998
     C           BGPFMG    ANDEQ'Y'                                       075998
     C           FCPORS    ANDNE'B'                                       CPM003
     C           PUPF      OREQ 'Y'                                       075998
     C           BGPFMG    ANDNE'Y'                                       075998
     C           FCPORS    ANDNE'B'                                       CPM003
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C           PUPF      OREQ 'Y'                                       CPB001
     C           PRMP      ANDNE0                                         CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     EXSR OPTPOT
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
      ** IF THE TRANSACTION IS AN EXERCISE
     C*
     C           TRTY      IFEQ 'E'
     C*
      ** CALCULATE EXERCISE REALIZED P/L
      ***IF*A*MARKET INSTRUMENT                                                        073714 193538
     C*
     C********** ISTI      IFEQ 'N'                                                    073714 193538
     C                     EXSR EXRLPL
     C**********           END                                                         073714 193538
     C*
      ** GENERATE A/C KEYS FOR THE PREMIUM AT END AMOUNT
      ** ( FOR THE PREMIUM PAYABLE ON THE EXERCISE )
     C*
     C           PRMP      IFNE 0
     C                     EXSR OPTPRE
     C                     END
     C***********                                                   073714099293
      ***IF*A*MARKET*INSTRUMENT                                     073714099293
     C***********                                                   073714099293
     C***********ISTI      IFEQ 'N'                                 073714099293
     C*
      ** GENERATE A/C KEYS FOR THE PREMIUM AT END AMOUNT
      ** MINUS THE EXERCISE REALIZED P/L
     C*
     C           *LIKE     DEFN EAMT      EVTA
     C           FFPOL     SUB  PRMP      EVTA
     C*
     C           EVTA      IFNE 0
     C                     EXSR OPTEXP
     C                     END
     C*
      ** GENERATE A/C KEYS FOR THE EXERCISE REALISED P/L AMOUNT
     C*
     C                     Z-ADDFFPOL     EVTA
     C*
     C           EVTA      IFNE 0
     C                     EXSR OPTEPL
     C                     END
     C***********          END                                      073714099293
     C*
      ** GENERATE TRANSACTION POSITION CHANGE RECORDS FOR PREMIUM PAYABLE
     C*
     C           PRMP      IFNE 0
     C                     EXSR OPTPOT
     C                     END
     C*
      ** GENERATE CLOSE OUT POSITION CHANGE RECORDS FOR THE EXERCISE P/L
      ** IF A MARKET INSTRUMENT                                           073714
     C*
     C           FFPOL     IFNE 0
     C           ISTI      ANDEQ'N'                                       073714
     C                     EXSR OPTPOC
     C                     END
     C*
     C                     END
     C*
     C           XTOPTA    ENDSR                           ** XTOPTA ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      **
      ** EXRLPL S/R TO CALCULATE EXERCISE REALIZED P/L
      ** CALLED FROM OPTACK S/R
      ** CALLS  FFPLCL STANDARD SUBROUTINE TO CALCULATE PROFIT/LOSS
      **
     C********************************************************************
     C*
     C           EXRLPL    BEGSR                           ** EXRLPL BSR**
     C*
     C                     Z-ADDNUCO      FFNOC
     C************LIKE     DEFN TKVL      FFTKVL                   AUS022 136056
     C************LIKE     DEFN YIELDX    FFYLD                    AUS022 136056
     C*
      ** PROFIT/LOSS IS DUE TO DIFFERENCE BETWEEN STRIKE/EXERCISE PRICE
     C*
     C           PCAL      IFEQ 'C'
     C*********************Z-ADDCOPR      FFPRCX                          AUS022
     C*********************Z-ADDSTRP      FFPRCY                          AUS022
     C***********          Z-ADDCOPR      FFPRCX 117                AUS022CFF004
     C***********          Z-ADDSTRP      FFPRCY 117                AUS022CFF004
     C           *LIKE     DEFN COPR      FFPRCX                          CFF004
     C           *LIKE     DEFN STRP      FFPRCY                          CFF004
     C                     Z-ADDCOPR      FFPRCX                          CFF004
     C                     Z-ADDSTRP      FFPRCY                          CFF004
     C                     ELSE
     C                     Z-ADDSTRP      FFPRCX
     C                     Z-ADDCOPR      FFPRCY
     C                     END
     C*
      ** IF A MARKET INSTRUMENT USE DETAILS FROM UNDERLYING INSTRUMENT
     C*
     C           ISTI      IFEQ 'N'
     C                     Z-ADDTKDM2     FFTKDM
     C                     Z-ADDMNPF2     FFMNPF
     C                     Z-ADDTKVL2     FFTKVL
     C                     ELSE
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     END
     C*
     C*  FOR ISPT 1-6, FFCNTT=0                                           AUS022
     C*                                                                   AUS022
     C           ISPT      IFLE 6                                         AUS022
     C                     Z-ADD0         FFCNTT                          AUS022
     C                     END                                            AUS022
     C*                                                                   AUS022
     C                     Z-ADDCTAM      FFCTAM 130                      AUS022
     C                     EXSR FFPLCL
     C*
     C           XTEXRL    ENDSR                           ** XTEXRL ESR**
     C********************************************************************
      /EJECT
     C********************************************************************
      **
      ** OPTPRS S/R TO GENERATE ACCOUNT KEYS FOR PREMIUM AT START
      ** CALLED FROM S/R OPTACK
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           OPTPRS    BEGSR                           ** OPTPRS BSR**
     C*
      ** SET VALUE FOR FOKEYD
     C*
     C                     MOVE 'D'       RECI
     C                     Z-ADDRUND      EDAT
     C/COPY WNCPYSRC,FF0390C013
     C           CFF007    IFEQ 'N'                                       CFF007
     C                     Z-ADDVALD      VDAT                            073714
     C/COPY WNCPYSRC,FF0390C014
     C                     ENDIF                                          CFF007
     C                     MOVE ISCY      CCY
     C*
      ** CUSTOMER ACCOUNT KEYS
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE CUSC      CBCD
     C                     MOVE TPTFR     PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'P'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C                     MOVE ' '       PRTY
     C                     ELSE
     C                     MOVE 'C'       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDEQ0                                                             CSD027
     C           BOCO      ANDEQ*BLANKS                                                       CSD027
     C           BXISTY    IFEQ 'Y'                                       S01455
     C                     MOVE 'D'       AMTC
     C                     ELSE                                           S01455
     C           PUPF      IFEQ 'Y'                                       S01455
     C                     MOVE 'D'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'F'       AMTC                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C                     END
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'B'       AMTC
     C                     ELSE
     C                     MOVE 'C'       AMTC
     C                     END
     C*
     C                     END
     C*
     C           ISTI      IFEQ 'Y'
     C*
     C           PUPF      IFEQ 'Y'
     C                     MOVE 'D'       AMTC
     C                     ELSE
     C                     MOVE 'F'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD - CUSTOMER SETTLEMENT FROM TRSET
     C*
     C                     MOVE CSLT      SETP
     C                     MOVE CSLA      SETA
     C                     MOVE BRSC      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE CFAO      SEFA   10                                           CGL020
     C                     MOVE CCPN      SECP    8                                           CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT IS PREMIUM PAID FROM TRSET
     C*
     C                     Z-ADDPRMP      EAMT
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
      *
     C/COPY WNCPYSRC,FF0390CCP3                                           S01408
      *                                                                   CFF007
      ** Set up value date with trade value date                          CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           ETYP      IFEQ 'P'                                       CFF007
     C           AMTC      ANDEQ'B'                                       CFF007
     C           ETYP      OREQ 'P'                                       CFF007
     C           AMTC      ANDEQ'C'                                       CFF007
     C           ETYP      OREQ 'P'                                       CFF007
     C           AMTC      ANDEQ'D'                                       CFF007
     C                     Z-ADDVALD      VDAT                            CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
      *
     C*
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move Transaction Profit Centre to Profit Centre field.           CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C                     MOVE TPRC      PRFC                            CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     WRITEFOKEYDF
      *
     C/COPY WNCPYSRC,FF0390CCP4                                           S01408
      *                                                                   CFF007
      ** Restore value date                                               CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C                     Z-ADDWWVDAT    VDAT                            CFF007
     C                     ENDIF                                          CFF007
      *
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF CUSTOMER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
      ** BROKER ACCOUNT KEYS
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           PRMP      ANDNE0                                         075998
     C           BGPFMG    ANDEQ'Y'                                       075998
     C           FCPORS    ANDNE'B'                                       CPM003
     C********** BOCO      ORNE 0                                                      075998 CSD027
     C           BOCO      ORNE *BLANKS                                                       CSD027
     C           BGPFMG    ANDNE'Y'                                       075998
     C           FCPORS    ANDNE'B'                                       CPM003
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C********** BOCO      ORNE 0                                                      CPB001 CSD027
     C           BOCO      ORNE *BLANKS                                                       CSD027
     C           PRMP      ANDNE0                                         CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE BOCO      CBCD
     C                     MOVE *BLANKS   PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'P'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C********** CUSC      IFEQ 0                                                             CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'B'       PRTY
     C                     ELSE
     C                     MOVE ' '       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C********** CUSC      IFEQ 0                                                             CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C           BXISTY    IFEQ 'Y'                                       S01455
     C                     MOVE 'D'       AMTC
     C                     ELSE                                           S01455
     C           PUPF      IFEQ 'Y'                                       S01455
     C                     MOVE 'D'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'F'       AMTC                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C                     END
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'C'       AMTC
     C                     ELSE
     C                     MOVE 'B'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD - BROKER SETTLEMENT FROM TRSET
     C*
     C                     MOVE BSLT      SETP
     C                     MOVE BSLA      SETA
     C                     MOVE BSBR      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE BFAO      SEFA                                                CGL020
     C                     MOVE BCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT IS PREMIUM PAID FROM TRSET
     C*
     C                     Z-ADDPRMP      EAMT
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
      *
     C/COPY WNCPYSRC,FF0390CCP5                                           S01408
      *                                                                   CFF007
      ** Set up value date with trade value date                          CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C           ETYP      IFEQ 'P'                                       CFF007
     C           AMTC      ANDEQ'B'                                       CFF007
     C           ETYP      OREQ 'P'                                       CFF007
     C           AMTC      ANDEQ'C'                                       CFF007
     C           ETYP      OREQ 'P'                                       CFF007
     C           AMTC      ANDEQ'D'                                       CFF007
     C                     Z-ADDVALD      VDAT                            CFF007
     C                     ENDIF                                          CFF007
     C                     ENDIF                                          CFF007
      *
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move FF ICD Default Profit Centre to Profit Centre field.        CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C**********           MOVE BXFOPC    PRFC                                         CAC003 241735
     C                     MOVE BPRC      PRFC                                                241735
     C                     ENDIF                                          CAC003
     C*
     C                     WRITEFOKEYDF
      *
     C/COPY WNCPYSRC,FF0390CCP6                                           S01408
      *                                                                   CFF007
      ** Restore value date                                               CFF007
     C           CFF007    IFEQ 'Y'                                       CFF007
     C                     Z-ADDWWVDAT    VDAT                            CFF007
     C                     ENDIF                                          CFF007
      *
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF BROKER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
     C           XTPRSF    ENDSR                           ** XTPRSF ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      **
      ** OPTPRE S/R TO GENERATE ACCOUNT KEYS FOR PREMIUM AT END
      ** CALLED FROM S/R OPTACK
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           OPTPRE    BEGSR                           ** OPTPRE BSR**
     C*
      ** SET VALUE FOR FOKEYD
     C*
     C                     MOVE 'D'       RECI
     C                     Z-ADDRUND      EDAT
     C/COPY WNCPYSRC,FF0390C015
     C           CFF007    IFEQ 'N'                                       CFF007
     C                     Z-ADDVALD      VDAT                            073714
     C/COPY WNCPYSRC,FF0390C016
     C                     ENDIF                                          CFF007
     C                     MOVE ISCY      CCY
     C*
      ** CUSTOMER ACCOUNT KEYS
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE CUSC      CBCD
     C                     MOVE TPTFR     PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'P'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C           ULTT      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C                     MOVE ' '       PRTY
     C                     ELSE
     C                     MOVE 'C'       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDEQ0                                                             CSD027
     C           BOCO      ANDEQ*BLANKS                                                       CSD027
     C           BXISTY    IFEQ 'Y'                                       S01455
     C                     MOVE 'E'       AMTC
     C                     ELSE                                           S01455
     C           PUPF      IFEQ 'Y'                                       S01455
     C                     MOVE 'E'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'G'       AMTC                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C                     END
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C*
     C           ULTT      IFEQ 'P'
     C                     MOVE 'R'       AMTC
     C                     ELSE
     C                     MOVE 'S'       AMTC
     C                     END
     C*
     C                     END
     C*
     C           ISTI      IFEQ 'Y'
     C*
     C           PUPF      IFEQ 'Y'
     C                     MOVE 'E'       AMTC
     C                     ELSE
     C                     MOVE 'G'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD - CUSTOMER SETTLEMENT FROM TRSET
     C*
     C                     MOVE CSLT      SETP
     C                     MOVE CSLA      SETA
     C                     MOVE BRSC      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE CFAO      SEFA                                                CGL020
     C                     MOVE CCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT IS PREMIUM PAID FROM TRSET
     C*
     C                     Z-ADDPRMP      EAMT
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
     C*
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move Transaction Profit Centre to Profit Centre field.           CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C                     MOVE TPRC      PRFC                            CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF CUSTOMER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
      ** BROKER ACCOUNT KEYS
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE BOCO      CBCD
     C                     MOVE *BLANKS   PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'P'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C           ULTT      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C********** CUSC      IFEQ 0                                                             CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'B'       PRTY
     C                     ELSE
     C                     MOVE ' '       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C********** CUSC      IFEQ 0                                                             CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C           BXISTY    IFEQ 'Y'                                       S01455
     C                     MOVE 'E'       AMTC
     C                     ELSE                                           S01455
     C           PUPF      IFEQ 'Y'                                       S01455
     C                     MOVE 'E'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'G'       AMTC                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C                     END
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C           ULTT      IFEQ 'P'
     C                     MOVE 'S'       AMTC
     C                     ELSE
     C                     MOVE 'R'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD - BROKER SETTLEMENT FROM TRSET
     C*
     C                     MOVE BSLT      SETP
     C                     MOVE BSLA      SETA
     C                     MOVE BSBR      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE BFAO      SEFA                                                CGL020
     C                     MOVE BCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT IS PREMIUM PAID FROM TRSET
     C*
     C                     Z-ADDPRMP      EAMT
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move FF ICD Default Profit Centre to Profit Centre field.        CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C**********           MOVE BXFOPC    PRFC                                         CAC003 241735
     C                     MOVE BPRC      PRFC                                                241735
     C                     ENDIF                                          CAC003
     C*
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF BROKER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
     C           XTPREF    ENDSR                           ** XTPREF ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      **
      ** OPTEXP S/R TO GENERATE ACCOUNT KEYS FOR EXERCISE PROFIT/LOSS
      **                                        MINUS EXERCISE PREMIUM
      ** CALLED FROM S/R OPTACK
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           OPTEXP    BEGSR                           ** OPTEXP BSR**
     C*
      ** SET VALUE FOR FOKEYD
     C*
     C                     MOVE 'D'       RECI
     C                     Z-ADDRUND      EDAT
     C/COPY WNCPYSRC,FF0390C017
     C           CFF007    IFEQ 'N'                                       CFF007
     C                     Z-ADDVALD      VDAT                            073714
     C/COPY WNCPYSRC,FF0390C018
     C                     ENDIF                                          CFF007
     C                     MOVE ISCY      CCY
     C*
      ** CUSTOMER ACCOUNT KEYS
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE CUSC      CBCD
     C                     MOVE TPTFR     PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'X'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C           ULTT      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C                     MOVE ' '       PRTY
     C                     ELSE
     C                     MOVE 'C'       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDEQ0                                                             CSD027
     C           BOCO      ANDEQ*BLANKS                                                       CSD027
     C********** ISTI      OREQ 'Y'                                       S01455
     C*                                                                   S01455
     C* FOR TRADE TYPE 3 OR 4, IF MARK./INST. NOT ON KEY GENERATE DIFF    S01455
     C* AMOUNT CODE DEPENDING ON PREMIUM UP-FRONT INDICATOR               S01455
     C*                                                                   S01455
     C           BXISTY    IFEQ 'Y'                                       S01455
     C           BXISTY    OREQ 'N'                                       S01455
     C           PUPF      ANDEQ'Y'                                       S01455
     C           EVTA      IFGT 0                                         S01455
     C                     MOVE 'J'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'K'       AMTC                            S01455
     C                     END                                            S01455
     C                     ELSE                                           S01455
     C           EVTA      IFGT 0                                         S01455
     C                     MOVE 'N'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'O'       AMTC                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C*                                                                   S01455
     C           ISTI      IFEQ 'Y'                        TRADE TYP 5/6  S01455
     C           PUPF      ANDEQ'Y'
     C*
     C           EVTA      IFGT 0
     C                     MOVE 'J'       AMTC
     C                     ELSE
     C                     MOVE 'K'       AMTC
     C                     END
     C*
     C                     END
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C           ISTI      OREQ 'Y'
     C           PUPF      ANDEQ'N'
     C*
     C           EVTA      IFGT 0
     C                     MOVE 'N'       AMTC
     C                     ELSE
     C                     MOVE 'O'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD - CUSTOMER SETTLEMENT FROM TRSET
     C*
     C                     MOVE CSLT      SETP
     C                     MOVE CSLA      SETA
     C                     MOVE BRSC      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE CFAO      SEFA                                                CGL020
     C                     MOVE CCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT ALWAYS POSITIVE
     C*
     C           EVTA      IFLT 0
     C                     Z-SUBEVTA      EAMT
     C                     ELSE
     C                     Z-ADDEVTA      EAMT
     C                     END
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move Transaction Profit Centre to Profit Centre field.           CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C                     MOVE TPRC      PRFC                            CAC003
     C                     ENDIF                                          CAC003
     C*
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF CUSTOMER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
      ** BROKER ACCOUNT KEYS
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE BOCO      CBCD
     C                     MOVE *BLANKS   PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'X'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C           ULTT      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C********** CUSC      IFEQ 0                                                             CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'B'       PRTY
     C                     ELSE
     C                     MOVE ' '       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C* INSTRUMENT ON A/C KEYS                                            S01455
     C*                                                                   S01455
     C           BXISTY    IFEQ 'Y'                                       S01455
     C           EVTA      IFGT 0
     C                     MOVE 'J'       AMTC
     C                     ELSE
     C                     MOVE 'K'       AMTC
     C                     END
      *                                                                   S01455
     C* INSTRUMENT NOT ON A/C KEYS                                        S01455
     C*                                                                   S01455
     C                     ELSE                                           S01455
     C********** CUSC      IFEQ 0                          TRADE TYPE 1/2             S01455 CSD027
     C           CUSC      IFEQ *BLANKS                    TRADE TYPE 1/2                    CSD027
     C           PUPF      ANDEQ'Y'                        PREMIUM UP FR.S01455
     C********** CUSC      ORNE 0                          TRADE TYPE 7/8              S01455 CSD027
     C           CUSC      ORNE *BLANKS                    TRADE TYPE 7/8                     CSD027
     C           EVTA      IFGT 0                                         S01455
     C                     MOVE 'J'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'K'       AMTC                            S01455
     C                     END                                            S01455
     C                     ELSE                            TYPE 1/2 AT ENDS01455
     C           EVTA      IFGT 0                                         S01455
     C                     MOVE 'N'       AMTC                            S01455
     C                     ELSE                                           S01455
     C                     MOVE 'O'       AMTC                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C                     END                                            S01455
     C*
      ** ADD A RECORD TO FOKEYD - BROKER SETTLEMENT FROM TRSET
     C*
     C                     MOVE BSLT      SETP
     C                     MOVE BSLA      SETA
     C                     MOVE BSBR      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE BFAO      SEFA                                                CGL020
     C                     MOVE BCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT IS ALWAYS POSITIVE
     C*
     C           EVTA      IFLT 0
     C                     Z-SUBEVTA      EAMT
     C                     ELSE
     C                     Z-ADDEVTA      EAMT
     C                     END
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move FF ICD Default Profit Centre to Profit Centre field.        CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C**********           MOVE BXFOPC    PRFC                                         CAC003 241735
     C                     MOVE BPRC      PRFC                                                241735
     C                     ENDIF                                          CAC003
     C*
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF BROKER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
     C           XTEXPF    ENDSR                           ** XTEXPF ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      **
      ** OPTEPL S/R TO GENERATE ACCOUNT KEYS FOR EXERCISE PROFIT/LOSS
      ** CALLED FROM S/R OPTACK
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           OPTEPL    BEGSR                           ** OPTEPL BSR**
     C*
      ** SET VALUE FOR FOKEYD
     C*
     C                     MOVE 'D'       RECI
     C                     Z-ADDRUND      EDAT
     C/COPY WNCPYSRC,FF0390C019
     C           CFF007    IFEQ 'N'                                       CFF007
     C                     Z-ADDVALD      VDAT                            073714
     C/COPY WNCPYSRC,FF0390C020
     C                     ENDIF                                          CFF007
     C                     MOVE ISCY      CCY
     C*
      ** CUSTOMER ACCOUNT KEYS
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE CUSC      CBCD
     C                     MOVE TPTFR     PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'X'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C*
     C           ULTT      IFEQ 'P'
     C           EVTA      ANDGT0
     C*
     C           ULTT      OREQ 'S'
     C           EVTA      ANDLT0
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
     C                     ELSE
     C*
     C                     MOVE ' '       LORS
     C*
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C********** BOCO      ANDNE0                                                             CSD027
     C           BOCO      ANDNE*BLANKS                                                       CSD027
     C                     MOVE ' '       PRTY
     C                     ELSE
     C                     MOVE 'C'       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C           ISTI      IFEQ 'N'
     C           PUPF      OREQ 'Y'
     C*
     C           ULTT      IFEQ 'P'
     C           EVTA      ANDGT0
     C           ULTT      OREQ 'S'
     C           EVTA      ANDLT0
     C                     MOVE 'P'       AMTC
     C                     ELSE
     C                     MOVE 'L'       AMTC
     C                     END
     C*
     C                     END
     C*
     C           ISTI      IFEQ 'Y'
     C           PUPF      ANDEQ'N'
     C*
     C           ULTT      IFEQ 'P'
     C           EVTA      ANDGT0
     C           ULTT      OREQ 'S'
     C           EVTA      ANDLT0
     C                     MOVE 'H'       AMTC
     C                     ELSE
     C                     MOVE 'I'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD - CUSTOMER SETTLEMENT FROM TRSET
     C*
     C                     MOVE CSLT      SETP
     C                     MOVE CSLA      SETA
     C                     MOVE BRSC      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE CFAO      SEFA                                                CGL020
     C                     MOVE CCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT ALWAYS POSITIVE
     C*
     C           EVTA      IFLT 0
     C                     Z-SUBEVTA      EAMT
     C                     ELSE
     C                     Z-ADDEVTA      EAMT
     C                     END
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move Transaction Profit Centre to Profit Centre field.           CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C                     MOVE TPRC      PRFC                            CAC003
     C                     ENDIF                                          CAC003
     C*
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF CUSTOMER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
      ** BROKER ACCOUNT KEYS
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
      ** ACCOUNT KEY FIELD POSITIONS 1-10
     C*
     C                     MOVE *BLANK    FFKY
     C                     MOVE BOCO      CBCD
     C                     MOVE *BLANKS   PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'X'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE - POSITION 11 OF A/C KEY
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C           ULTT      IFEQ 'P'
     C           EVTA      ANDGT0
     C*
     C           ULTT      OREQ 'S'
     C           EVTA      ANDLT0
     C*
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
     C                     ELSE
     C*
     C                     MOVE ' '       LORS
     C*
     C                     END
     C*
      ** SET UP POSITION 12 OF ACCOUNT KEY
     C*
     C********** CUSC      IFEQ 0                                                             CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'B'       PRTY
     C                     ELSE
     C                     MOVE ' '       PRTY
     C                     END
     C*
      ** SET UP POSITION 14 OF ACCOUNT KEY
     C*
     C********** CUSC      IFEQ 0                                                             CSD027
     C           CUSC      IFEQ *BLANKS                                                       CSD027
     C*
     C           ULTT      IFEQ 'P'
     C           EVTA      ANDGT0
     C*
     C           ULTT      OREQ 'S'
     C           EVTA      ANDLT0
     C*
     C                     MOVE 'P'       AMTC
     C                     ELSE
     C                     MOVE 'L'       AMTC
     C                     END
     C*
     C                     END
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
     C           ULTT      IFEQ 'P'
     C           EVTA      ANDGT0
     C*
     C           ULTT      OREQ 'S'
     C           EVTA      ANDLT0
     C*
     C                     MOVE 'L'       AMTC
     C                     ELSE
     C                     MOVE 'P'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD - BROKER SETTLEMENT FROM TRSET
     C*
     C                     MOVE BSLT      SETP
     C                     MOVE BSLA      SETA
     C                     MOVE BSBR      SEBR                            S01117
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE BFAO      SEFA                                                CGL020
     C                     MOVE BCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** EVENT AMOUNT IS ALWAYS POSITIVE
     C*
     C           EVTA      IFLT 0
     C                     Z-SUBEVTA      EAMT
     C                     ELSE
     C                     Z-ADDEVTA      EAMT
     C                     END
     C*
      ** REVERSAL INDICATOR
     C*
     C           TRECI     IFEQ 'D'
     C                     Z-ADD0         REVI
     C                     ELSE
     C                     Z-ADD1         REVI
     C                     END
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** move FF ICD Default Profit Centre to Profit Centre field.        CAC003
     C*                                                                   CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C**********           MOVE BXFOPC    PRFC                                         CAC003 241735
     C                     MOVE BPRC      PRFC                                                241735
     C                     ENDIF                                          CAC003
     C*
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
      ** END OF BROKER PREMIUM ACCOUNT KEYS
     C*
     C                     END
     C*
     C           XTEPLF    ENDSR                           ** XTEPLF ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      ** OPTPOT S/R TO GENERATE TRANSACTION POSITION CHANGE RECORDS
      **                        FOR PREMIUM PAYABLE
      ** CALLED FROM S/R OPTACK
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           OPTPOT    BEGSR                           ** OPTPOT BSR**
     C*
      ** SET FIELDS FOR POCHGTC, POCHGTK
     C*
     C                     MOVE 'D'       RECI
     C*********************MOVE TRSD      POCD                            073714
     C                     MOVE VALD      POCD                            073714
     C/COPY WNCPYSRC,FF0390C021
     C           CFF007    IFEQ 'Y'                                       CFF007
     C                     MOVE TRSD      POCD                            CFF007
     C                     ENDIF                                          CFF007
     C                     MOVE 'C'       PCGT
     C                     MOVE 'N'       AOSI
     C                     MOVE 'N'       ATCI
     C*
      ** SET REPORTING INDICATORS
     C*
     C           TRTY      IFEQ 'E'
     C           PUPF      ANDEQ'Y'
     C                     MOVE 'Y'       AOSI
     C                     MOVE 'Y'       ATCI
     C                     END
     C*
     C                     MOVE 'N'       PUPI
     C                     Z-ADD0         POCQ
     C                     MOVE '0'       PAYI
     C*
      ** BROKER INVOLVED, GENERATE A BROKER TRANSACTION POSITION CHANGE
      ** RECORD
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
      ** PREPARE FIELDS FOR OUTPUT TO POCHGTC
     C*
      ** TRADE EXERCISED WAS PURCHASE OR SALE ?
     C*
     C           TRTY      IFEQ 'P'
     C           ULTT      OREQ 'P'
     C                     Z-SUBPRMP      PCGA
     C                     END
     C*
     C           TRTY      IFEQ 'S'
     C           ULTT      OREQ 'S'
     C                     Z-ADDPRMP      PCGA
     C                     END
     C*
      ** TRANSACTION DELETED
     C*
     C           TRECI     IFEQ 'D'
     C                     MOVE '0'       REVI
     C                     ELSE
     C                     MOVE '1'       REVI
     C                     END
     C*
      ** WRITE A RECORD TO POCHGTC -- BROKER
     C*
     C**********           Z-ADDBOCO      CBCD                                                CSD027
     C                     MOVE BOCO      CBCD                                                CSD027
     C                     WRITEPOCHGTCF
     C*
     C                     END
     C*
      ** CUSTOMER INVOLVED, GENERATE A CUSTOMER TRANSACTION POSITION CHANGE
      ** RECORD
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
      ** PREPARE FIELDS FOR OUTPUT TO POCHGTC
     C*
      ** TRADE EXERCISED WAS PURCHASE
     C*
     C           TRTY      IFEQ 'P'
     C           ULTT      OREQ 'P'
     C*
      ** IF A BROKER IS INVOLVED, POSITIVE AMOUNT, ELSE NEGATIVE
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     Z-ADDPRMP      PCGA
     C                     ELSE
     C                     Z-SUBPRMP      PCGA
     C                     END
     C*
     C                     END
     C*
      ** TRADE EXERCISED WAS SALE
     C*
     C           TRTY      IFEQ 'S'
     C           ULTT      OREQ 'S'
     C*
      ** IF A BROKER IS INVOLVED, NEGATIVE AMOUNT, ELSE POSITIVE
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     Z-SUBPRMP      PCGA
     C                     ELSE
     C                     Z-ADDPRMP      PCGA
     C                     END
     C*
     C                     END
     C*
      ** TRANSACTION DELETED
     C*
     C           TRECI     IFEQ 'D'
     C                     MOVE '0'       REVI
     C                     ELSE
     C                     MOVE '1'       REVI
     C                     END
     C*
      ** WRITE A RECORD TO POCHGTC -- CUSTOMER
     C*
     C**********           Z-ADDCUSC      CBCD                                                CSD027
     C                     MOVE CUSC      CBCD                                                CSD027
     C                     WRITEPOCHGTCF
     C*
     C                     END
     C*
      ** BOOK INVOLVED, GENERATE A BOOK TRANSACTION POSITION CHANGE RECORD
     C*
     C********** BOCO      IFEQ 0                                                             CSD027
     C********** CUSC      OREQ 0                                                             CSD027
     C           BOCO      IFEQ *BLANKS                                                       CSD027
     C           CUSC      OREQ *BLANKS                                                       CSD027
     C*
      ** PREPARE FIELDS FOR OUTPUT TO POCHGTK
     C*
      ** TRADE EXERCISED WAS PURCHASE OR SALE ?
     C*
     C           TRTY      IFEQ 'P'
     C           ULTT      OREQ 'P'
     C                     Z-ADDPRMP      PCGA
     C                     END
     C*
     C           TRTY      IFEQ 'S'
     C           ULTT      OREQ 'S'
     C                     Z-SUBPRMP      PCGA
     C                     END
     C*
      ** TRANSACTION DELETED
     C*
     C           TRECI     IFEQ 'D'
     C                     MOVE '0'       REVI
     C                     ELSE
     C                     MOVE '1'       REVI
     C                     END
     C*
      ** WRITE A RECORD TO POCHGTK -- BOOK
     C*
     C                     WRITEPOCHGTKF
     C*
     C                     END
     C*
     C           XTOPTT    ENDSR                           ** XTOPTT ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      ** OPTPOC S/R TO GENERATE CLOSE OUT (REALIZED PROFIT/LOSS) POSITION
      **            CHANGE RECORDS FOR EXERCISE REALIZED P/L
      ** CALLED FROM S/R OPTACK
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           OPTPOC    BEGSR                           ** OPTPOC BSR**
     C*
      ** SET FIELDS FOR POCHGCC, POCHGCK
     C*
     C                     MOVE 'D'       RECI
     C*********************MOVE TRSD      POCD                            073714
     C                     MOVE VALD      POCD                            073714
     C/COPY WNCPYSRC,FF0390C022
     C           CFF007    IFEQ 'Y'                                       CFF007
     C                     MOVE TRSD      POCD                            CFF007
     C                     ENDIF                                          CFF007
     C                     Z-ADDTNBR      CLON
     C                     MOVE 'N'       AOSI
     C                     MOVE 'N'       ATCI
     C                     MOVE 'N'       PUPI
     C*
      ** BROKER INVOLVED, GENERATE A BROKER CLOSE OUT POSITION CHANGE
      ** RECORD
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
      ** PREPARE FIELDS FOR OUTPUT TO POCHGCC
     C*
      ** TRADE EXERCISED WAS PURCHASE OR SALE ?
     C*
     C           ULTT      IFEQ 'P'
     C                     Z-ADDFFPOL     RLPL
     C                     END
     C*
     C           ULTT      IFEQ 'S'
     C                     Z-SUBFFPOL     RLPL
     C                     END
     C*
      ** TRANSACTION DELETED ?
     C*
     C           TRECI     IFEQ 'D'
     C                     MOVE '0'       REVI
     C                     ELSE
     C                     MOVE '1'       REVI
     C                     END
     C*
      ** WRITE A RECORD TO POCHGCC -- BROKER
     C*
     C                     MOVE BOCO      CBCD
     C                     WRITEPOCHGCCF
     C*
     C                     END
     C*
      ** CUSTOMER INVOLVED, GENERATE A CUSTOMER CLOSE OUT POSITION CHANGE
      ** RECORD
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C*
      ** PREPARE FIELDS FOR OUTPUT TO POCHGCC
     C*
      ** TRADE EXERCISED WAS PURCHASE
     C*
     C           ULTT      IFEQ 'P'
     C*
      ** IF A BROKER IS INVOLVED, POSITIVE AMOUNT, ELSE NEGATIVE
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     Z-SUBFFPOL     RLPL
     C                     ELSE
     C                     Z-ADDFFPOL     RLPL
     C                     END
     C*
     C                     END
     C*
      ** TRADE EXERCISED WAS SALE
     C*
     C           ULTT      IFEQ 'S'
     C*
      ** IF A BROKER IS INVOLVED, NEGATIVE AMOUNT, ELSE POSITIVE
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     Z-ADDFFPOL     RLPL
     C                     ELSE
     C                     Z-SUBFFPOL     RLPL
     C                     END
     C*
     C                     END
     C*
      ** TRANSACTION DELETED ?
     C*
     C           TRECI     IFEQ 'D'
     C                     MOVE '0'       REVI
     C                     ELSE
     C                     MOVE '1'       REVI
     C                     END
     C*
      ** WRITE A RECORD TO POCHGCC -- CUSTOMER
     C*
     C                     MOVE CUSC      CBCD
     C                     WRITEPOCHGCCF
     C*
     C                     END
     C*
      ** BOOK INVOLVED, GENERATE A BOOK CLOSE OUT POSITION CHANGE RECORD
     C*
     C********** BOCO      IFEQ 0                                                             CSD027
     C********** CUSC      OREQ 0                                                             CSD027
     C           BOCO      IFEQ *BLANKS                                                       CSD027
     C           CUSC      OREQ *BLANKS                                                       CSD027
     C*
      ** PREPARE FIELDS FOR OUTPUT TO POCHGCK
     C*
      ** TRADE EXERCISED WAS PURCHASE OR SALE ?
     C*
     C           ULTT      IFEQ 'P'
     C                     Z-SUBFFPOL     RLPL
     C                     END
     C*
     C           ULTT      IFEQ 'S'
     C                     Z-ADDFFPOL     RLPL
     C                     END
     C*
      ** TRANSACTION DELETED ?
     C*
     C           TRECI     IFEQ 'D'
     C                     MOVE '0'       REVI
     C                     ELSE
     C                     MOVE '1'       REVI
     C                     END
     C*
      ** WRITE A RECORD TO POCHGCK -- BOOK
     C*
     C                     WRITEPOCHGCKF
     C*
     C                     END
     C*
     C                     Z-ADD0         CLON
     C*
     C           XTOPTC    ENDSR                           ** XTOPTC ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      ** UNRLPL S/R TO CALCULATE UNREALIZED PROFIT/LOSS
      ** CALLED FROM MAIN S/R
      ** CALLS  FFPLCL STD S/R
      **
     C********************************************************************
     C*
     C           UNRLPL    BEGSR                           ** UNRLPL BSR**
     C*
     C                     Z-ADD0         NTVLB
     C                     Z-ADD0         NTVLC
     C*                                                                   AUS022
     C*  FOR ISPT 1-6, FFCNTT=0                                           AUS022
     C*                                                                   AUS022
     C           ISPT      IFLE 6                                         AUS022
     C                     Z-ADD0         FFCNTT                          AUS022
     C                     END                                            AUS022
     C*
      ** Set up ticks denominator and Minimum Price Fluctuation
     C*
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C*
      ** CUSTOMER/BOOK CALCULATIONS
     C*
     C           NOCO      IFNE 0
     C*
     C                     Z-ADDNOCO      FFNOC
     C                     Z-ADDNEWP      FFPRCX
     C                     Z-ADDCOPR      FFPRCY
     C*
     C                     Z-ADDCTAM      FFCTAM                          AUS022
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          EXSR FFPLCL                                    136056
     C                     EXSR FFUNPL                                    136056
      **                                                                                      247296
      **   for processing type 5 (CCY OTC), divide net transaction value by 100               247296
     C           ISPT      IFEQ 5                                                             247296
     C           FFNTVL    DIV  100       FFNTVL                                              247296
     C                     ENDIF                                                              247296
      *                                                                                       247296
     C*
     C           *LIKE     DEFN FFNTVL    NTVLC
     C*                                                                   AUS022
     C*  FOR ISPT 1-6, USE FFNTVL; FOR ISPT=7,8 USE FFPOL                 AUS022
     C*                                                                   AUS022
     C           ISPT      IFLE 6                                         AUS022
     C                     Z-ADDFFNTVL    NTVLC
     C                     ELSE                                           AUS022
     C                     Z-ADDFFPOL     NTVLC                           AUS022
     C                     END                                            AUS022
     C                     END
     C*
      ** IF A BROKER IS INVOLVED AND THE INSTRUMENT
      ** IS AN OPTION USE CUSTOMER/BOOK CONTRACTS
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           ISPT      ANDGT3
     C           ISPT      ANDNE7                                         AUS022
     C                     Z-ADDNOCO      NOBO
     C                     END
     C*
      ** BROKER CALCULATIONS
     C*
     C           NOBO      IFNE 0
     C*
     C                     Z-ADDNOBO      FFNOC
     C                     Z-ADDNEWP      FFPRCX
     C                     Z-ADDCOPR      FFPRCY
     C*
     C                     Z-ADDCTAM      FFCTAM                          AUS022
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          EXSR FFPLCL                                    136056
     C                     EXSR FFUNPL                                    136056
      **                                                                                      247296
      **   for processing type 5 (CCY OTC), divide net transaction value by 100               247296
     C           ISPT      IFEQ 5                                                             247296
     C           FFNTVL    DIV  100       FFNTVL                                              247296
     C                     ENDIF                                                              247296
      *                                                                                       247296
     C*
     C           *LIKE     DEFN FFNTVL    NTVLB
     C*                                                                   AUS022
     C*  FOR ISPT 1-6, USE FFNTVL; FOR ISPT=7,8 USE FFPOL                 AUS022
     C*                                                                   AUS022
     C           ISPT      IFLE 6                                         AUS022
     C                     Z-ADDFFNTVL    NTVLB
     C                     ELSE                                           AUS022
     C                     Z-ADDFFPOL     NTVLB                           AUS022
     C                     END                                            AUS022
     C                     END
     C*
     C           XTUNRL    ENDSR                           ** XTUNRL ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      ** OWUNRL S/R OUTPUT TO WORK FILE OF UNREALIZED PROFIT/LOSS
      ** CALLED FROM S/R MAIN
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           OWUNRL    BEGSR                           ** OWUNRL BSR**
     C*
      ** BROKER INVOLVED, GENERATE A BROKER UNREALIZED PROFIT/LOSS RECORD
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C           NTVLB     ANDNE0
     C*
      ** PREPARE FIELDS FOR OUTPUT TO WUNRLC
     C*
     C**********           Z-ADDBOCO      CBCD                                                CSD027
     C                     MOVE BOCO      CBCD                                                CSD027
     C           WUNRCK    CHAINWUNRLC               03
     C*
     C           *IN03     IFEQ '1'
     C                     Z-ADD0         ULPL
     C                     END
     C*
      ** TRADE IS PURCHASE OR SALE ?
     C*
     C           TRTY      IFEQ 'P'
     C                     SUB  NTVLB     ULPL
     C                     END
     C*
     C           TRTY      IFEQ 'S'
     C                     ADD  NTVLB     ULPL
     C                     END
     C*
      ** UPDATE IF RECORD EXIST OTHERWISE WRITE A NEW RECORD
     C*
     C           *IN03     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     WRITEWUNRLCDF
     C                     ELSE
     C                     EXCPTUWUNRC
     C                     END
     C*
     C                     END
     C*
      ** CUSTOMER INVOLVED, GENERATE A CUSTOMER UNREALIZED PROFIT/LOSS
      ** RECORD
     C*
     C********** CUSC      IFNE 0                                                             CSD027
     C           CUSC      IFNE *BLANKS                                                       CSD027
     C           NTVLC     ANDNE0
     C*
      ** PREPARE FIELDS FOR OUTPUT TO WUNRLC -- CUSTOMER
     C*
     C**********           Z-ADDCUSC      CBCD                                                CSD027
     C                     MOVE CUSC      CBCD                                                CSD027
     C           WUNRCK    CHAINWUNRLC               04
     C*
     C           *IN04     IFEQ '1'
     C                     Z-ADD0         ULPL
     C                     END
     C*
     C*
      ** BROKER INVOLVED ?
     C*
     C********** BOCO      IFNE 0                                                             CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C*
      ** TRADE IS PURCHASE OR SALE ?
     C*
     C           TRTY      IFEQ 'P'
     C                     ADD  NTVLC     ULPL
     C                     END
     C*
     C           TRTY      IFEQ 'S'
     C                     SUB  NTVLC     ULPL
     C                     END
     C*
     C                     ELSE
     C*
      ** TRADE IS PURCHASE OR SALE ?
     C*
     C           TRTY      IFEQ 'P'
     C                     SUB  NTVLC     ULPL
     C                     END
     C*
     C           TRTY      IFEQ 'S'
     C                     ADD  NTVLC     ULPL
     C                     END
     C*
     C                     END
     C*
      ** UPDATE IF RECORD EXIST OTHERWISE WRITE A NEW RECORD
     C*
     C           *IN04     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     WRITEWUNRLCDF
     C                     ELSE
     C                     EXCPTUWUNRC
     C                     END
     C*
     C                     END
     C*
      ** BOOK INVOLVED, GENERATE A BOOK UNREALIZED PROFIT/LOSS RECORD
     C*
     C********** BOCO      IFEQ 0                                                             CSD027
     C           BOCO      IFEQ *BLANKS                                                       CSD027
     C           NTVLC     ANDNE0
     C********** CUSC      OREQ 0                                                             CSD027
     C           CUSC      OREQ *BLANKS                                                       CSD027
     C           NTVLC     ANDNE0
     C*
      ** PREPARE FIELDS FOR OUTPUT TO WUNRLK
     C*
     C           WUNRKK    CHAINWUNRLK               05
     C*
     C           *IN05     IFEQ '1'
     C                     Z-ADD0         ULPL
     C                     END
     C*
      ** TRADE IS PURCHASE OR SALE ?
     C*
     C           TRTY      IFEQ 'P'
     C                     ADD  NTVLC     ULPL
     C                     END
     C*
     C           TRTY      IFEQ 'S'
     C                     SUB  NTVLC     ULPL
     C                     END
     C*
      ** UPDATE IF RECORD EXIST OTHERWISE WRITE A NEW RECORD
     C*
     C           *IN05     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     WRITEWUNRLKDF
     C                     ELSE
     C                     EXCPTUWUNRK
     C                     END
     C*
     C                     END
     C*
     C           XTWUNR    ENDSR                           ** XTWUNR ESR**
     C*
     C********************************************************************
     C*
     C/COPY WNCPYSRC,FF0390CCP8                                           S01408
     C*
      /EJECT
     C********************************************************************
      ** CTGACK S/R TO GENERATE ACCOUNT KEYS FOR CONTINGENT AMOUNTS
      ** CALLED FROM MAIN S/R
      ** CALLS  NO S/R
      **
     C********************************************************************
     C*
     C           CTGACK    BEGSR                           ** CTGACK BSR**
     C*
      ** SET VALUE FOR FOKEYD
     C*
     C                     MOVE 'D'       RECI
     C                     MOVE RUND      EDAT
     C                     MOVE RUND      VDAT                            073714
     C                     MOVE ISCY      CCY
     C                     Z-ADD0         REVI
      *                                                                                       204413
      ** If OTC and instrument proc. type is 4 or 6, check if premium                         204413
      ** ccy is different from underlying ccy. If different, use other                        204413
      ** ccy field as the currency for contingent posting.                                    204413
      *                                                                                       204413
     C           ISTI      IFEQ 'Y'                                                           204413
     C           ISPT      ANDEQ4                                                             204413
     C           ISCY      ANDNEOTHC                                                          204413
     C           ISTI      OREQ 'Y'                                                           204413
     C           ISPT      ANDEQ6                                                             204413
     C           ISCY      ANDNEOTHC                                                          204413
     C                     MOVE OTHC      CCY                                                 204413
     C                     ENDIF                                                              204413
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE *BLANKS   F1RACT                                              CGL020
     C                     MOVE *BLANKS   F1RCTY                                              CGL020
     C                     MOVE *BLANKS   F1RBNK                                              CGL020
     C                     MOVE *BLANKS   F1RCDE                                              CGL020
     C                     MOVE *BLANKS   F1PACT                                              CGL020
     C                     MOVE *BLANKS   F1PCTY                                              CGL020
     C                     MOVE *BLANKS   F1PBNK                                              CGL020
     C                     MOVE *BLANKS   F1PCDE                                              CGL020
     C                     MOVE *BLANKS   F1DACT                                              CGL020
     C                     MOVE *BLANKS   F1DCTY                                              CGL020
     C                     MOVE *BLANKS   F1DBNK                                              CGL020
     C                     Z-ADD0         F1SDAT                                              CGL020
     C                     ENDIF                                                              CGL020
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** set up Profit Centre field.                                      CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C*                                                                   CAC003
     C********** BOCO      IFNE 0                                                      CAC003 CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C**********           MOVE BXFOPC    PRFC                                         CAC003 241735
     C                     MOVE BPRC      PRFC                                                241735
     C                     ELSE                                           CAC003
     C                     MOVE TPRC      PRFC                            CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*
      ** ACCOUNT KEY FIELD
     C*
     C                     MOVE *BLANK    FFKY
     C**********           Z-ADD0         CBCD                                                CSD027
     C********** BOCO      IFNE 0                                                      073714 CSD027
     C**********           Z-ADDBOCO      CBCD                                         073714 CSD027
     C                     MOVE *BLANKS   CBCD                                                CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     MOVE BOCO      CBCD                                                CSD027
     C                     ELSE                                           073714
     C**********           Z-ADDCUSC      CBCD                                         073714 CSD027
     C                     MOVE CUSC      CBCD                                                CSD027
     C                     END                                            073714
     C                     MOVE *BLANKS   PTFR                            S71062
     C                     MOVE BOKC      BOOK
     C                     MOVE 'F'       TYPE
     C                     MOVE 'G'       ETYP
     C*
      ** INCLUDE INSTRUMENT NAME ONLY IF MARKET INSTRUMENT
     C*
     C                     EXSR S00001                                    S01455
     C********** ISTI      IFEQ 'N'                                       S01455
     C**********           MOVE ISTT      MKINST                          S01455
     C**********           END                                            S01455
     C*
      ** ACCOMODATE TRANSACTION TYPE
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
     C                     MOVE 'I'       PRTY
     C*
      ** RECORD STATUS, ACTIVE OR DELETED
     C*
     C           TRECI     IFEQ 'D'
     C           NOCO      ANDNENCCP
     C*
      ** PREPARE FIELDS FOR A/C KEY OUTPUT TO FOKEYD
     C*
      ** CALCULATE EVENT AMOUNT
     C*
     C           NOCO      SUB  NCCP      EVTA
     C*
     C           EVTA      MULT CTAM      EVTA
     C*
     C/COPY WNCPYSRC,FF0390C004
     C           ISPT      IFEQ 6                                        168987
     C           EVTA      MULT STRP      EVTA                           168987
     C                     END                                           168987
     C*                                                                  168987
     C           ISPT      IFEQ 3                                        168987
     C           EVTA      MULT COPR      EVTA                           168987
     C                     END                                           168987
     C*                                                                  168987
     C           EVTA      IFLT 0
     C                     Z-SUBEVTA      EAMT
     C                     MOVE 'T'       AMTC
     C                     ELSE
     C                     Z-ADDEVTA      EAMT
     C                     MOVE 'A'       AMTC
     C                     END
     C*
      ** FX INSTRUMENT
     C*
     C           ISPT      IFEQ 2
     C           ISPT      OREQ 5
     C                     MOVE OTHC      CCY
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD
     C*
     C                     MOVE *BLANK    SETP
     C                     MOVE *BLANK    SETA
     C/COPY WNCPYSRC,FF0390C024
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C/COPY WNCPYSRC,FF0390C025
     C*
      ** UPDATE TRANSACTION SETTLEMENT DETAIL FILE
     C*
     C                     Z-ADDNOCO      NCCP
     C/COPY WNCPYSRC,FF0390C026
     C*
     C                     END
     C*
     C           TRECI     IFEQ '*'
     C           NCCP      ANDNE0
     C*
      ** PREPARE FIELDS FOR A/C KEY OUTPUT TO FOKEYD
     C*
     C           NCCP      MULT CTAM      EAMT
     C/COPY WNCPYSRC,FF0390C005
     C           ISPT      IFEQ 6                                        168987
     C           EAMT      MULT STRP      EAMT                           168987
     C                     END                                           168987
     C*                                                                  168987
     C           ISPT      IFEQ 3                                        168987
     C********** EVTA      MULT COPR      EVTA                                         168987 216084
     C           EAMT      MULT COPR      EAMT                                                216084
     C                     END                                           168987
     C*                                                                  168987
     C                     MOVE '1'       REVI
     C                     MOVE 'A'       AMTC
     C*
      ** FX INSTRUMENT
     C*
     C           ISPT      IFEQ 2
     C           ISPT      OREQ 5
     C                     MOVE OTHC      CCY
     C                     END
     C*
      ** ADD A RECORD TO FOKEYD
     C*
     C                     MOVE *BLANK    SETP
     C                     MOVE *BLANK    SETA
     C/COPY WNCPYSRC,FF0390C027
     C                     WRITEFOKEYDF
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C/COPY WNCPYSRC,FF0390C028
     C*
     C                     END
     C*
     C           XTCTGA    ENDSR                           ** XTCTGA ESR**
     C*
     C********************************************************************
      /EJECT
     C********************************************************************073714
      ** CTGACO S/R TO GENERATE ACCOUNT KEYS FOR CONTINGENT AMOUNTS       073714
      ** CALLED FROM MAIN S/R                                             073714
      ** CALLS  NO S/R                                                    073714
      **                                                                  073714
     C********************************************************************073714
     C*                                                                   073714
     C           CTGACO    BEGSR                           ** CTGACO BSR**073714
     C*                                                                   073714
      ** SET VALUE FOR FOKEYD                                             073714
     C*                                                                   073714
     C                     MOVE 'D'       RECI                            073714
     C                     MOVE RUND      EDAT                            073714
     C                     MOVE RUND      VDAT                            073714
     C                     Z-ADD0         REVI                            073714
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE *BLANKS   F1RACT                                              CGL020
     C                     MOVE *BLANKS   F1RCTY                                              CGL020
     C                     MOVE *BLANKS   F1RBNK                                              CGL020
     C                     MOVE *BLANKS   F1RCDE                                              CGL020
     C                     MOVE *BLANKS   F1PACT                                              CGL020
     C                     MOVE *BLANKS   F1PCTY                                              CGL020
     C                     MOVE *BLANKS   F1PBNK                                              CGL020
     C                     MOVE *BLANKS   F1PCDE                                              CGL020
     C                     MOVE *BLANKS   F1DACT                                              CGL020
     C                     MOVE *BLANKS   F1DCTY                                              CGL020
     C                     MOVE *BLANKS   F1DBNK                                              CGL020
     C                     Z-ADD0         F1SDAT                                              CGL020
     C                     ENDIF                                                              CGL020
     C*                                                                   CAC003
     C** If Analytical Accounting and SAR CAC003 are installed,           CAC003
     C** set up Profit Centre field.                                      CAC003
     C           *IN20     IFEQ '1'                                       CAC003
     C*                                                                   CAC003
     C********** BOCO      IFNE 0                                                      CAC003 CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C**********           MOVE BXFOPC    PRFC                                         CAC003 241735
     C                     MOVE BPRC      PRFC                                                241735
     C                     ELSE                                           CAC003
     C                     MOVE TPRC      PRFC                            CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   073714
      ** ACCOUNT KEY FIELD                                                073714
     C*                                                                   073714
     C                     MOVE *BLANK    FFKY                            073714
     C**********           Z-ADD0         CBCD                                         073714 CSD027
     C********** BOCO      IFNE 0                                                      073714 CSD027
     C**********           Z-ADDBOCO      CBCD                                         073714 CSD027
     C                     MOVE *BLANKS   CBCD                                                CSD027
     C           BOCO      IFNE *BLANKS                                                       CSD027
     C                     MOVE BOCO      CBCD                                                CSD027
     C                     ELSE                                           073714
     C**********           Z-ADDCUSC      CBCD                                         073714 CSD027
     C                     MOVE CUSC      CBCD                                                CSD027
     C                     END                                            073714
     C                     MOVE BOKC      BOOK                            073714
     C                     MOVE 'F'       TYPE                            073714
     C                     MOVE 'G'       ETYP                            073714
     C*                                                                   073714
     C                     MOVE 'I'       PRTY                            073714
     C*                                                                   098653
     C** Call to SR/S00001 to set up processing type                      098653
     C*                                                                   098653
     C                     EXSR S00001                                    098653
     C*                                                                   073714
      ** RECORD STATUS, ACTIVE OR DELETED                                 073714
     C*                                                                   073714
     C           TRECI     IFEQ 'D'                                       073714
     C           NOCO      ANDNENCCP                                      073714
     C*                                                                   073714
      ** PROCESS BUY AMOUNT                                               073714
     C*                                                                   073714
     C                     MOVE 'L'       LORS                            073714
     C*                                                                   073714
     C           NOCO      SUB  NCCP      EVTA                            073714
     C*                                                                   073714
      ** BUY AMOUNT IS CONTINGENT AMOUNT IF BOUGHT CALL OR SOLD   PUT     073714
      **          ELSE COUNTER    AMOUNT IF SOLD   CALL OR BOUGHT PUT     073714
     C*                                                                   073714
     C           TRTY      IFEQ 'P'                                       073714
     C           PCAL      ANDEQ'C'                                       073714
     C           TRTY      OREQ 'S'                                       073714
     C           PCAL      ANDEQ'P'                                       073714
     C           EVTA      MULT CTAM      EVTA                            073714
     C                     MOVE OTHC      CCY                             073714
     C                     ELSE                                           073714
     C           EVTA      MULT CCAM      EVTA                            073714
     C                     MOVE CTCY      CCY                             073714
     C                     END                                            073714
     C*                                                                   073714
     C           EVTA      IFLT 0                                         073714
     C                     Z-SUBEVTA      EAMT                            073714
     C                     MOVE 'T'       AMTC                            073714
     C                     ELSE                                           073714
     C                     Z-ADDEVTA      EAMT                            073714
     C                     MOVE 'A'       AMTC                            073714
     C                     END                                            073714
     C*                                                                   073714
      ** ADD A RECORD TO FOKEYD                                           073714
     C*                                                                   073714
     C                     MOVE *BLANK    SETP                            073714
     C                     MOVE *BLANK    SETA                            073714
     C/COPY WNCPYSRC,FF0390C029
     C                     WRITEFOKEYDF                                   073714
     C                     ADD  1         COUNT                           073714
     C           EAMT      DIV  1000      ZZAMT                           073714
     C                     EXSR ZZADD                                     073714
     C/COPY WNCPYSRC,FF0390C030
     C*                                                                   073714
      ** PROCESS SELL AMOUNT                                              073714
     C*                                                                   073714
     C                     MOVE 'S'       LORS                            073714
     C*                                                                   073714
     C           NOCO      SUB  NCCP      EVTA                            073714
     C*                                                                   073714
      ** SELL AMOUNT IS CONTINGENT AMOUNT IF SOLD   CALL OR BOUGHT PUT    073714
      **           ELSE COUNTER    AMOUNT IF BOUGHT CALL OR SOLD   PUT    073714
     C*                                                                   073714
     C           TRTY      IFEQ 'S'                                       073714
     C           PCAL      ANDEQ'C'                                       073714
     C           TRTY      OREQ 'P'                                       073714
     C           PCAL      ANDEQ'P'                                       073714
     C           EVTA      MULT CTAM      EVTA                            073714
     C                     MOVE OTHC      CCY                             073714
     C                     ELSE                                           073714
     C           EVTA      MULT CCAM      EVTA                            073714
     C                     MOVE CTCY      CCY                             073714
     C                     END                                            073714
     C*                                                                   073714
     C           EVTA      IFLT 0                                         073714
     C                     Z-SUBEVTA      EAMT                            073714
     C                     MOVE 'T'       AMTC                            073714
     C                     ELSE                                           073714
     C                     Z-ADDEVTA      EAMT                            073714
     C                     MOVE 'A'       AMTC                            073714
     C                     END                                            073714
     C*                                                                   073714
      ** ADD A RECORD TO FOKEYD                                           073714
     C*                                                                   073714
     C                     MOVE *BLANK    SETP                            073714
     C                     MOVE *BLANK    SETA                            073714
     C/COPY WNCPYSRC,FF0390C031
     C                     WRITEFOKEYDF                                   073714
     C                     ADD  1         COUNT                           073714
     C           EAMT      DIV  1000      ZZAMT                           073714
     C                     EXSR ZZADD                                     073714
     C/COPY WNCPYSRC,FF0390C032
     C*                                                                   073714
      ** UPDATE TRANSACTION SETTLEMENT DETAIL FILE                        073714
     C*                                                                   073714
     C                     Z-ADDNOCO      NCCP                            073714
     C*                                                                   073714
     C/COPY WNCPYSRC,FF0390C033
     C                     END                                            073714
     C*                                                                   073714
     C           TRECI     IFEQ '*'                                       073714
     C           NCCP      ANDNE0                                         073714
     C*                                                                   073714
      ** PROCESS BUY AMOUNT                                               073714
     C*                                                                   073714
     C                     MOVE 'L'       LORS                            073714
     C                     MOVE 'A'       AMTC                            073714
     C*                                                                   073714
      ** BUY AMOUNT IS CONTINGENT AMOUNT IF BOUGHT CALL OR SOLD   PUT     073714
      **          ELSE COUNTER    AMOUNT IF SOLD   CALL OR BOUGHT PUT     073714
     C*                                                                   073714
     C           TRTY      IFEQ 'P'                                       073714
     C           PCAL      ANDEQ'C'                                       073714
     C           TRTY      OREQ 'S'                                       073714
     C           PCAL      ANDEQ'P'                                       073714
     C           NCCP      MULT CTAM      EAMT                            073714
     C                     MOVE OTHC      CCY                             073714
     C                     ELSE                                           073714
     C           NCCP      MULT CCAM      EAMT                            073714
     C                     MOVE CTCY      CCY                             073714
     C                     END                                            073714
     C*                                                                   073714
     C                     MOVE '1'       REVI                            073714
     C*                                                                   073714
      ** ADD A RECORD TO FOKEYD                                           073714
     C*                                                                   073714
     C                     MOVE *BLANK    SETP                            073714
     C                     MOVE *BLANK    SETA                            073714
     C/COPY WNCPYSRC,FF0390C034
     C                     WRITEFOKEYDF                                   073714
     C                     ADD  1         COUNT                           073714
     C           EAMT      DIV  1000      ZZAMT                           073714
     C                     EXSR ZZADD                                     073714
     C/COPY WNCPYSRC,FF0390C035
     C*                                                                   073714
      ** PROCESS SELL AMOUNT                                              073714
     C*                                                                   073714
     C                     MOVE 'S'       LORS                            073714
     C                     MOVE 'A'       AMTC                            073714
     C*                                                                   073714
      ** SELL AMOUNT IS CONTINGENT AMOUNT IF SOLD   CALL OR BOUGHT PUT    073714
      **           ELSE COUNTER    AMOUNT IF BOUGHT CALL OR SOLD   PUT    073714
     C*                                                                   073714
     C           TRTY      IFEQ 'S'                                       073714
     C           PCAL      ANDEQ'C'                                       073714
     C           TRTY      OREQ 'P'                                       073714
     C           PCAL      ANDEQ'P'                                       073714
     C           NCCP      MULT CTAM      EAMT                            073714
     C                     MOVE OTHC      CCY                             073714
     C                     ELSE                                           073714
     C           NCCP      MULT CCAM      EAMT                            073714
     C                     MOVE CTCY      CCY                             073714
     C                     END                                            073714
     C*                                                                   073714
     C                     MOVE '1'       REVI                            073714
     C*                                                                   073714
      ** ADD A RECORD TO FOKEYD                                           073714
     C*                                                                   073714
     C                     MOVE *BLANK    SETP                            073714
     C                     MOVE *BLANK    SETA                            073714
     C/COPY WNCPYSRC,FF0390C036
     C                     WRITEFOKEYDF                                   073714
     C                     ADD  1         COUNT                           073714
     C           EAMT      DIV  1000      ZZAMT                           073714
     C                     EXSR ZZADD                                     073714
     C/COPY WNCPYSRC,FF0390C037
     C*                                                                   073714
     C                     END                                            073714
     C*                                                                   073714
     C           XTCTOA    ENDSR                           ** XTCTOA ESR**073714
     C*                                                                   073714
     C********************************************************************073714
      /EJECT                                                              073714
      /COPY ZSRSRC,FFPLCLZ1
      /EJECT                                                              136056
      /COPY ZSRSRC,FFUNPLZ1                                               136056
      /EJECT                                                              136056
      /COPY ZSRSRC,FFPMCLZ1                                               136056
      /EJECT
      /COPY ZSRSRC,FFTVCLZ2
      /EJECT
      /COPY ZSRSRC,ZZADDZ1
      /EJECT
      /COPY ZSRSRC,FFFMTZ3
      /EJECT
      /COPY ZSRSRC,ZDATE2Z2
      /EJECT                                                              S01117
      *****************************************************************                       CGL020
      /EJECT                                                                                  CGL020
      *****************************************************************                       CGL020
      *                                                               *                       CGL020
      *  SRAMPR   - Determines AML Pay/Receive Instructions           *                       CGL020
      *                                                               *                       CGL020
      *  Called by: SROptnAcPRS                                       *                       CGL020
      *                                                               *                       CGL020
      *  Calls:     None                                              *                       CGL020
      *                                                               *                       CGL020
      *****************************************************************                       CGL020
      *                                                                                       CGL020
     C           SRAMPR    BEGSR                                                              CGL020
      *                                                                                       CGL020
     C**********           Z-ADDCBCD      PCBCD                                        CGL020 CSD027
     C                     MOVE CBCD      PCBCD                                               CSD027
      *                                                                                       CGL020
     C                     CALL WZAAML                                                        CGL020
      *                                                                                       CGL020
     C                     PARM           PCBCD                                               CGL020
     C                     PARM           SETA                                                CGL020
     C                     PARM           SEBR                                                CGL020
     C                     PARM           SEFA                                                CGL020
     C                     PARM           SECP                                                CGL020
     C                     PARM           CCY                                                 CGL020
     C                     PARM           F1RACT                                              CGL020
     C                     PARM           F1RCTY                                              CGL020
     C                     PARM           F1RBNK                                              CGL020
     C                     PARM           F1RCDE                                              CGL020
     C                     PARM           F1PACT                                              CGL020
     C                     PARM           F1PCTY                                              CGL020
     C                     PARM           F1PBNK                                              CGL020
     C                     PARM           F1PCDE                                              CGL020
     C                     PARM           F1DACT                                              CGL020
     C                     PARM           F1DCTY                                              CGL020
     C                     PARM           F1DBNK                                              CGL020
      *                                                                                       CGL020
     C                     Z-ADDFCDA      F1SDAT                                              CGL020
      *                                                                                       CGL020
     C                     ENDSR                                                              CGL020
      *                                                                                       CGL020
     C*****************************************************************   S01117
     C**                                                                  S01117
     C**  *PSSR -- SUBROUTINE TO HANDLE ABNORMAL ERROR CONDITIONS         S01117
     C**  CALLED FROM: AFTER ABNORMAL OPERATION OCCURS                    S01117
     C**  CALLS: NOTHING                                                  S01117
     C**                                                                  S01117
     C*****************************************************************   S01117
     C*                                                                   S01117
     C           *PSSR     BEGSR                                          S01117
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANK                                    S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     ENDSR                                          S01117
     C*                                                                   S01117
     C*****************************************************************   S01117
      /EJECT
     C/COPY ZSRSRC,FFYTOPZ1                                               AUS022
     C/COPY WNCPYSRC,FF0390C038
      /EJECT                                                              AUS022
      *****************************************************************
     O*
     OWUNRLCDFE                UWUNRC
     O                         ULPL
     O*
     O*
     OWUNRLKDFE                UWUNRK
     O                         ULPL
     O*
     O*
     OTRSETDF E                UTRSET
     O***********              RECI                                       CFF007
     O                         FRECI                                      CFF007
     O                         NCCP
     O*
     OTRANSDF E                UTRANS
     O                         TRECI
     O                         FCDA
     O                         ECPI
     O                         FCIN
     O                         FBIN
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   MSG
OVER THE COUNTER
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
