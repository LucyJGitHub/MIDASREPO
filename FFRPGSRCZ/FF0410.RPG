     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FF Closeout set account key generation')         *
     F*****************************************************************
     F*                                                               *
     F*  Midas Futures and Options Module
     F*                                                               *
     F*  FF0410 - Close Out Set Account Key Generation                *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. AR746662           Date 03May11               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. 247517             Date 09May07               *
      *                 247057             Date 16Apr07               *
      *                 CPK027             Date 16Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 245463             Date 08Feb07               *
      *                 245070             Date 17Jan06               *
      *                 241147A            Date 07Nov06               *
      *                 241147             Date 26Oct06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD027             Date 09Dec05               *
      *                 083196             Date 25Apr05               *
      *                 CGL029             Date 01Sep03               *
      *                 215528             Date 21Mar03               *
      *                 CGL020             Date 12Dec02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CFF006             Date 28Nov00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 126117             Date 20Apr00               *
      *                 140017             Date 20Apr00               *
     F*                 140455             Date 20Apr00               *
     F*                 136056             Date 14Apr00               *
     F*                 136054             Date 06Apr00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 CFF003             Date 07Apr97               *
     F*                 CAC003             Date 25Feb97               *
     F*                 CFF004             Date 11Sep96               *
     F*                 S71062             Date 19Dec95               *
     F*                 046303             DATE 14JAN94               *
     F*                 S01455             DATE 09NOV93               *
     F*                 S01456             DATE 08NOV93               *
     F*                 S04662             DATE 12JUL93               *
     F*                 S01411             DATE 05JUL93               *  *
     F*                 054174             DATE 21APR93               *
     F*                 E30416             DATE 02MAR93               *
     F*                 E03643             DATE 19FEB93               *
     F*                 E30422             DATE 15FEB93               *
     F*                 S01393             DATE 30OCT92               *
     F*                 E44985             DATE 25SEP92               *
     F*                  FUJI-FF0011        DATE 21SEP92                 *
     F*                  E38323             DATE 30JUL92                 *
     F*                  AUS022             DATE 07AUG92                 *
     F*                  FO0094             DATE 24APR91                 *
     F*                  FO0071             DATE 12APR91                 *
     F*                  S01117             DATE 16MAR90                 *
     F*                  S01195             DATE 16MAR90                 *
     F*                  E18232             DATE 10AUG89                 *
     F*                                                                  *
     F*---------------------------------------------------------------*
      *                                                               *
      *  AR746662 - Discrepancy in premium amount in Currency OTC     *
      *             screen and Projected Available Balance Enquiry    *
      *             Applied fix 249171. (Recompile)                   *
      *             (Child: Artf746663)                               *
      *  247517 - Reversed fix 241147.                                *
     F*  247057 - For Ccy OTC, as MNPF was defaulted to '0.00000001', *
     F*           premium must be divided by 100.                     *
      *  CPK027 - Errors in compiling MP1_3_TTTS - recompile over     *
      *           changed FFTVCLZ2.                                   *
      *  245463 - Applied fix 241735.                                 *
      *  241735 - Future commission fee profit centre is not right.   *
     F*  245070 - Processing type not appearing on account key        *
      *  241147A - Recompile.                                         *
      *  241147 - Recompile.                                          *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  083196 - Add field Market in the Ac/k for IML requirement    *
      *         - Fix applied by CER001                               *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
      *  215528 - System is associating a wrong premium amount.       *
      *           Recompiled only.                                    *
      *  CGL020 - Midas Compliance Watch - Additional A/C Postings    *
      *           Information                                         *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed FFYTOPZ1.                    *
      *  CFF006 - Fractional Ticks Enhancement. (Recompile)           *
     F*  126117 - Recompiled due to changes to FFYTOPZ1.              *
     F*  140017 - Recompiled due to changes to FFPMCLZ1.              *
     F*  140455 - Recompiled due to changes to FFPMCLZ1               *
     F*  136056 - Dft accuracy = 9; Australian 3 & 10 TB Future = 8.  *
     F*           Calculate Australian option premiums correctly      *
     F*           Recompiled due to changes in FFYTOPZ1               *
      *  136054 - AUD bond future p&l missing from reports.           *
     F*  CFF003 - ENHANCED OTC PROCESSING - PHASE II                  *
     F*           UPGRADE FROM BLI LBL001 (RECOMPILE ONLY)            *
     F*  CAC003 - Profit Centre Accounting Development Phase 3.       *
     F*  CFF004 - Increase in size of Price Fields,(Recompiled Only)  *
     F*  S71062 - FF/PM Interface - Initial margin                    *
     F*  046303 - /COPY source subr. ZFWDT amended to prevent array   *
     F*           error if no holiday record found - fixed by S01434. *
     F*           Program recompiled.                                 *
     F*  S01455 - Account key generation of the futures and options   *
     F*           module-Depending on the ICD indicator,the fields    *
     F*           'BXPROT' & 'BXISTY' are optional on the account key *
     F*  S01456 - 'FF' MONTHLY P&L ENHANCEMENTS.                      *
     F*  S04662 - Switchable Feature for Init Margins for Futures;    *
     F*           Deposit and Spread Margin Rate added to DEFLTD.     *
     F*           Recompile only.                                     *
     F*  S01411 - Recompiled as field 'ORIGINAL ENTRY DATE' added to  *  *
     F*           PF/TRANSD.                                          *  *
     F*  054174 - Premium Calculation introduced by E30422            *
     F*           should only apply to processing type 8              *
     F*  E30416 - Recompiled due to amendments on subroutine FFYTOP   *
     F*  E03643 - Recompile because of change to pf/clostt            *
     F*  E30422 - Premium calculations appear to be incorrect on      *
     F*           options purchased. To fix the error, the strike     *
     F*           price is used in the tick value computations        *
     F*           instead of the contract price.                      *
     F*   S01393  -  RECOMPILED FOR STRATEGIC RISK MANAGEMENT            *
     F*   E44985  -  ZYIELD requires 3 new parameters. Recompile only    *
     F* FUJI-FF0011 - The system does not differentiate between          *
     F*               american and european option on exercise           *
     F*               validation and OTC confirmation wording.           *
     F*               *** RECOMPILE ONLY ***                             *
     F*   E38323  -  Recompilation of the program done due to a change   *
     F*              in copy source ZFWDT subroutine                     *
     F*   AUS022  -  AUSTRALIAN CHANGE : Introduction of Processing      *
     F*              Types 7 and 8.                                      *
     F*   FO0094  -  PTF L170382 INSTALLED TO FIX READE ERROR, AND       *
     F*              PROGRAM RECOMPILED WITH IGNDECERR *NO               *
     F*   FO0071  -  PGM RECOMPILED WITH IGNDECERR *YES DUE TO PROBLEMS  *
     F*              WITH READE OP CODE IN OS/400 REL3                   *
     F*   S01117  -  MULTIBRANCHING                                      *
     F*   S01195  -  HOLIDAY PROCESSING AMENDMENT                        *
     F*   E18232  -  FILE BOOKD ONLY ACCESSED IF BOOK CODE IS NOT BLANK  *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*     CREATION REQUIREMENTS                                        *
     F*                                                                  *
     F******IGNDECERR(*NO)************************************************FO0071
     F******IGNDECERR(*YES)*****************************************FO0071FO0094
     F*     IGNDECERR(*NO)                                               *FO0094
     F*                                                                  *
     F********************************************************************
     F*
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
/******:*USRPRF(*USER)*CODELIST(*NONE)*IGNDECERR(*NO)***************: *   FO0071
/******:*USRPRF(*USER)*CODELIST(*NONE)*IGNDECERR(*YES)**************FO0071FO0094
     F*                                                               *
     F*****************************************************************
     F*ABTB10*IF* E           K        DISK                               S01117
     F*ABLETJ*IF* E           K        DISK                               S01195
     FMARKT   IF  E           K        DISK                           UC
     FMKCTL   IF  E           K        DISK                           UC
     FFOKEYA  UF  E                    DISK
     FFF0410AUO   E                    PRINTER
     FFOCLT   IF  E           K        DISK
     FDEFLT   IF  E           K        DISK
     FINTYP   IF  E           K        DISK
     FPOCHGTC O   E                    DISK
     FPOCHGTK O   E                    DISK
     FPOCHGCC O   E                    DISK
     FPOCHGCK O   E                    DISK
     FFOKEYD  O   E                    DISK
     FTRANS   IF  E           K        DISK
     FTRSET   IF  E           K        DISK
     FCLOST1  UP  E           K        DISK
     FCLOST4  IF  E           K        DISK
     F            CLOSTTF                           KRENAMECLOST4F
     FCLOST5  IF  E           K        DISK
     F            CLOSTTF                           KRENAMECLOST5F
     FBOOKD   IF  E           K        DISK
     FFOPCC   IF  E           K        DISK                           UC  S01117
     FFOPCK   IF  E           K        DISK                           UC  S01117
      /EJECT
     F********************************************************************
     F*
     F* ID F  C  H  L    FUNCTION OF INDICATORS
     F*
     F*        20     FIRST CYCLE INDICATOR
     F*
     F*        30     HEDGING AMORTISATION NEEDED
     F*        31     AUDIT HAS BEEN ALREADY PRINTED IN THE TOTAL S/R     S01117
     F*
     F*        40     END OF CLOST4 FILE
     F*        41     END OF CLOST5 FILE
     F*
     F*     80-89     RESERVED FOR STANDARD FF SUBROUTINES
     F*
     F*     90-99     USED FOR STANDARD S/RS - NOTE THAT *IN98 IS NOT SET
     F*        99     GENERAL ERROR INDICATOR
     F*
     F*            L3 CHANGE OF BROKER      }
     F*            L2 CHANGE OF CUSTOMER    } ON CLOST1
     F*            L1 CHANGE OF INSTRUMENT  }
     F*
     F*         U7&U8 DATABASE ERROR
     F*
     F********************************************************************
      /SPACE 5
     E                    CPY@    1   1 80
     E********************************************************************
     E                    MSG     1   1 20
     E*
     E** ARRAY FOR UNDERLINING
     E                    FULA       34  1
      /COPY ZSRSRC,ZDATE2Z1
      /COPY ZSRSRC,FFFMTZ1
      *COPY*ZSRSRC,ZDATE3Z1                                               S01195
      *COPY*ZSRSRC,ZDATE5Z1                                               S01195
      /COPY ZSRSRC,ZHOLE                                                  S01195
      /COPY ZSRSRC,FFDATEZ1
     E********************************************************************
      /EJECT
     I********************************************************************
      *COPY*ZSRSRC,ZDATE3Z2                                               S01195
     I********************************************************************
     I*
     ICLOSTDF
     I*
      ** CLOSE OUT SET HEADERS - LEVEL BREAK INDICATORS
     I*
     I***********   BRCD                            BRCDD                 S01117
     I              BRCA                            BRCAD                 S01117
     I              BOCO                            BOCOD L3
     I              CUSC                            CUSCD L2
     I              BOKC                            BOKCD
     I                                              ISTT  L1
     I              ECPI                            ECPID
     I              ISCY                            ISCYD
     I              YRNO                            YRNOD
     I              MTHN                            MTHND
     ICLOST4F
     I*
      ** CLOST 4 FILE - CLOSE OUT DETAILS FOR PURCHASE TRANSACTIONS
     I*
     I              RECI                            RECIP
     I              CLON                            CLONP
     I              TNBR                            TNBRP
     I              NCCL                            NCCLP
     I              TRSD                            TRSDP
     I              TRTY                            TRTYP
     ICLOST5F
     I*
      ** CLOST 5 FILE - CLOSE OUT DETAILS FOR SALE TRANSACTIONS
     I*
     I              RECI                            RECIS
     I              CLON                            CLONS
     I              TNBR                            TNBRS
     I              NCCL                            NCCLS
     I              TRSD                            TRSDS
     I              TRTY                            TRTYS
     IBOOKDDF
     I*
      ** BOOKD FILE - RENAME OF COMMON FIELDS
     I*
     I              BOKC                            BOKCB
      *                                                                   AUS022
      ** INTYPD FILE - RENAME OF FIELDS USED BY SUBROUTINE                AUS022
     IINTYPDF                                                             AUS022
     I              CNTT                            FFCNTT                AUS022
     I              CTAM                            FFCTAM                AUS022
     IFOCLTDF                                                             S01117
     I*                                                                   S01117
      ** FOCLT FILE - RENAME OF COMMON FIELDS                             S01117
     I*                                                                   S01117
     I              SEBR                            SEBRF                 S01117
     IDEFLTDF                                                             S01117
     I*                                                                   S01117
      ** DEFLT FILE - RENAME OF COMMON FIELDS                             S01117
     I*                                                                   S01117
     I              SEBR                            SEBRD                 S01117
     ITRANSDF                                                             S01117
     I*                                                                   S01117
      ** TRANS FILE - RENAME OF COMMON FIELDS                             S01117
     I*                                                                   S01117
     I              PRFC                            PRFCT                 S01117
     I********************************************************************
      /EJECT
     I********************************************************************
     I*
     IISTTI       DS
     I*
      ** INSTRUMENT TYPE REDEFINED FOR CHAINING TO DEFLT
     I*
     I                                        1   2 MRKT
     I                                        3   5 ISTC
     I********************************************************************
     I*
     IFFKY        DS
     I*
      ** ACCOUNT KEY SUB-FIELDS
     I*
     I                                        1   1 TYPE
     I                                        2   2 INVA                  S01455
     I                                        3   3 ETYP
     I                                        4   5 BOOK
     I                                        6  10 MKINST
     I/COPY WNCPYSRC,FF0410I001
     I                                       11  11 LORS
     I                                       12  12 CORB
     I                                       13  13 AMOR
     I                                       14  14 AMTC
     I*
     I*DA********UDS                            256                       S01117
     ILDA         DS                            256                       S01117
     I*  LOCAL DATA AREA FOR DATABASE ERROR DETAILS
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 1770DBASE                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I**                                                                  S01117
     ISDBANK    E DSSDBANKPD                                              S01117
      **  EXTERNAL DS FOR BANK DETAILS                                    S01117
     I              BJURPT                          TITL                  S01117
     ISDGELR    E DSSDGELRPD                                              S01117
     I** GENERAL LEDGER DETAILS                                           S01117
     I              BKPRCU                          PFCU                  S01117
     I              BKPRCA                          PFCA                  S01117
     I              BKPCDU                          PFCD                  S01117
     I              BKOBRU                          OBUU                  S01117
      *                                                                   S01455
     ISDFODA    E DSSDFODAPD                                              S01455
      * SDFODAPD - Futures and Options Data data structure                S01455
     I              QQACCD                          ACCDQQ                                    CGL029
      **                                                                  CAC003
     ISDMMOD    E DSSDMMODPD                                              CAC003
     I** EXTERNAL DS FOR MODULES                                          CAC003
      *                                                                   S01455
     ISCSARD    E DSSCSARDPD                                                                  CGL020
      ** External DS for Switchable Features                                                  CGL020
      *                                                                                       CGL020
     I@DSFDY    E DSDSFDY                                                 S01117
     I*  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE               S01117
     I*                                                                   S01117
     I/COPY ZSRSRC,ZHOLDS                                                 S01195
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     IRUNDT       DS                                                      S01117
      **  DATA AREA RUNDAT                                                S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
     I*
     I********************************************************************
      /COPY ZSRSRC,FFSRDSZ1
     I********************************************************************
      /COPY ZSRSRC,ZTNLU1Z1
     I********************************************************************
      /COPY ZSRSRC,FFFMTZ2
     I********************************************************************
      *COPY*ZSRSRC,ZDATE3Z3                                               S01195
     I********************************************************************
      /COPY ZSRSRC,FFDATEZ2
     I********************************************************************
      /EJECT
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I/COPY ZSRSRC,ZYLDZ1                                                 AUS022
     I*                                                                   S01117
     I*  DATA STRUCTURE FOR LF/FOPCC & LF/FOPCK KEYS                      S01117
     IFOPCKY      DS                                                      S01117
     I                                        1   3 BRCA                  S01117
     I**********                              4   90CBCD                               S01117 CSD027
     I                                        4   9 CBCD                                      CSD027
     I                                       10  14 ISTT                  S01117
     I*                                                                   S01117
     IFOPKKY      DS                                                      S01117
     I                                        1   3 KBRCA                 S01117
     I                                        4   5 KBOKC                 S01117
     I                                        6  10 KISTT                 S01117
      *                                                                                       CGL020
     I              'ZAAMLSETFF'          C         ZAAML                                     CGL020
     C/EJECT                                                              S01117
     C********************************************************************
     C*
      ** Parameter Market is passed to the program
     C*
     C           *LIKE     DEFN MRKT      MARKET
     C*
     C           *ENTRY    PLIST
     C                     PARM           MARKET
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C*
     C           DEFLTK    KLIST
     C                     KFLD           CBCD
     C                     KFLD           MRKT
     C                     KFLD           ISTC
     C*                                                                   S01117
     C           FOPCCK    KLIST                                          S01117
     C                     KFLD           BRCA                            S01117
     C                     KFLD           CBCD                            S01117
     C                     KFLD           ISTT                            S01117
     C*                                                                   S01117
     C           FOPCKK    KLIST                                          S01117
     C                     KFLD           BRCA                            S01117
     C                     KFLD           BOKC                            S01117
     C                     KFLD           ISTT                            S01117
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
      **     IF first cycle
      **          Perform Initial Processing
     C*
     C           *IN20     IFEQ '0'
     C                     EXSR INIT
     C                     END
     C*
      **     Perform Clostd Processing
     C*
     C                     EXSR CLSTD
     C*
      ** At last record, if processing was performed and no DB error,
      ** write to trailer/file control report.
     C*
     CLRNU7                EXSR TOTAL
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
      **       INDEX TO SUBROUTINES
      **
      ** S/R INIT - TO PERFORM INITIAL FILE ACCESSES
      ** S/R CLSTD - TO PERFORM PROCESSING ON ONE CLOST1 RECORD
      ** S/R CLPFC - TO DETERMINE BROKER/CUSTOMER/BOOK PROFIT CENTRES     S01117
      **             FOR THE CLOST1 RECORD                                S01117
      ** S/R FCLOT - TO PERFORM ACCESS FIRST CLOST4/5 RECORDS FOR A SET
      ** S/R REMCLT - TO PERFORM REMAINING CLOST4/5 RECORD PROCESSING
      ** S/R FFTVCL - STANDARD S/R TO CALCULATE TRANSACTION VALUE
      ** S/R FFPMCL - STANDARD SUBROUTINE TO CALCULATE PREMIUM
      ** S/R ENDSET - TO PERFORM REMAINING CLOST1 RECORD PROCESSING
      ** S/R GENAKT - TO WRITE PREMIUM ACCOUNT KEYS (PER CLOST4/5 RECORD)
      ** S/R POCOPT - TO WRITE POCHGTC/K RECORDS FOR PREMIUM PAYABLE (CLOST4/5)
      ** S/R POCFOA - TO WRITE POCHGTC/K RECORDS FOR CONTRACTS CLOSED (CLOST4/5)
      ** S/R GENAKD - TO WRITE REALIZED P/L ACCOUNT KEYS (PER CLOST1 RECORD)
      ** S/R POCC1R - TO WRITE POCHGCC/K RECORDS FOR REALIZED P/L (CLOST1)
      ** S/R TOTAL - TO PERFORM LAST RECORD CALCULATIONS
      ** S/R ZTNLU1 - STANDARD S/R TO GET NEXT AVAILABLE TRANSACTION NO.
      ** S/R ZZADD - STANDARD SUBROUTINE TO HASH AMOUNTS
      ** S/R FFFMT - STANDARD SUBROUTINE TO FORMAT MARKET NAME
      ** S/R ZDATE2 - STANDARD SUBROUTINE TO FORMAT MIDAS DAY TO DATE
      ** S/R ZDATE1 - STANDARD SUBROUTINE TO FORMAT DATE TO MIDAS DAY     S01195
      ** S/R ZFWDT  - STANDARD SUBROUTINE TO CALCULATE FORWARD DATE       S01195
      ** S/R ZBKDT  - STANDARD SUBROUTINE TO CALCULATE BACKWARD DATE      S01195
      ** S/R ZCHKH  - STANDARD SUBROUTINE TO CHECK FOR HOLIDAY            S01195
      ** S/R DBERR - SUBROUTINE TO REPORT DB ERRORS AND TERMINATE
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R INIT - TO PERFORM INITIAL FILE ACCESSES
      ** CALLED FROM MAIN PROCESSING
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           INIT      BEGSR
     C*
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE *BLANK    DBPGM                           S01117
     C                     MOVE 'FF0410  'DBPGM
     C                     MOVE *BLANK    DBKEY                           S01117
     C                     MOVE *BLANK    DBFILE                          S01117
     C                     Z-ADD0         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     SETON                     20
     C*
      ************Access*TABTB10******************************************S01117
      ************IF*no*live*record*found*********************************S01117
      *****************Set*on*U7,*U8,*LR*and*update*LDA*******************S01117
      *****************Bypass*further*processing**************************S01117
     C***********                                                         S01117
     C***********          READ TABTB10F                 99               S01117
     C************IN99     IFEQ '1'                                       S01117
     C***********RECI      ORNE 'D'                                       S01117
     C***********          MOVE 'TABLE'   DBFILE           ***************S01117
     C***********          MOVEL'TABTB10' DBKEY            * DB ERROR 01 *S01117
     C***********          Z-ADD1         DBASE            ***************S01117
     C***********          EXSR DBERR                                     S01117
     C***********          END                                            S01117
      *                                                                   S01455
      ***  Access SDFODAPD to obtain the 'FF' ICD details.                S01455
      *                                                                   S01455
     C                     CALL 'AOFODAR0'                                S01455
     C                     PARM '*MSG   ' @RTCD   7                       S01455
     C                     PARM '*FIRST ' @OPTN   7                       S01455
     C           SDFODA    PARM SDFODA    @DSFDY                          S01455
     C*                                                                   S01455
     C           @RTCD     IFNE *BLANK                                    S01455
     C           *LOCK     IN   LDA                                       S01455
     C                     MOVEL'SDFODAPD'DBFILE                          S01455
     C                     MOVEL@OPTN     DBKEY            ***************S01455
     C                     MOVEL@OPTN     DBOPTN  7        * DBERROR 021 *S01455
     C                     Z-ADD21        DBASE            ***************S01455
     C                     OUT  LDA                                       S01455
     C                     SETON                     U7U8LR               S01455
     C                     EXSR DBERR                                     S01455
     C                     RETRN                                          S01455
     C                     END                                            S01455
     C*                                                                   S01117
     C**   ACCESS BANK DETAILS, FOR TITLE                                 S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    @DSFDY                          S01117
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBANKPD'DBFILE                          S01117
     C                     MOVEL@OPTN     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7        * DBERROR 001 *S01117
     C                     Z-ADD1         DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     SETON                     U7U8LR               S01117
     C                     EXSR DBERR                                     S01117
     C                     RETRN                                          S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C**   Get General Ledger Details                                     S01117
     C*                                                                   S01117
     C**********           CALL 'AOGELRR0'                                S01117              CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C********** SDGELR    PARM SDGELR    @DSFDY                          S01117              CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDGELRPD'DBFILE             *************S01117
     C                     Z-ADD23        DBASE              * DBERR 23  *S01117
     C                     MOVEL@OPTN     DBOPTN  7          *************S01117
     C                     MOVEL@OPTN     DBKEY                           S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C** Check if Analytical Accounting and Switchable Feature            CAC003
     C** CAC003 are switched on.                                          CAC003
     C                     MOVE '0'       *IN50                           CAC003
     C                     CALL 'AOMMODR0'                                CAC003
     C                     PARM *BLANKS   @RTCD   7                       CAC003
     C                     PARM '*FIRST ' @OPTN   7                       CAC003
     C           SDMMOD    PARM SDMMOD    @DSFDY                          CAC003
     C*                                                                   CAC003
     C           @RTCD     IFNE *BLANKS                                   CAC003
     C           *LOCK     IN   LDA                                       CAC003
     C                     MOVE 'SDMMODPD'DBFILE             *************CAC003
     C                     Z-ADD24        DBASE              * DBERR 024 *CAC003
     C                     MOVEL@OPTN     DBOPTN  7          *************CAC003
     C                     MOVEL@OPTN     DBKEY                           CAC003
     C                     OUT  LDA                                       CAC003
     C                     EXSR DBERR                                     CAC003
     C                     END                                            CAC003
     C*                                                                   CAC003
     C                     CALL 'AOSARDR0'                                CAC003
     C                     PARM           @RTCD                           CAC003
     C                     PARM '*VERIFY' @OPTN                           CAC003
     C                     PARM 'CAC003'  @SARD   6                       CAC003
      *                                                                   CAC003
     C           @RTCD     IFEQ *BLANK                                    CAC003
     C           BGN0ST    ANDEQ'Y'                                       CAC003
     C                     MOVE '1'       *IN50                           CAC003
     C                     ENDIF                                          CAC003
      *                                                                                       CGL020
      ** Access AOSARDR0 and check if CGL020 is installed                                     CGL020
      *                                                                                       CGL020
     C                     CALL 'AOSARDR0'                                                    CGL020
     C                     PARM *BLANKS   PRTCD   7                                           CGL020
     C                     PARM '*VERIFY' POPTN   7                                           CGL020
     C                     PARM 'CGL020'  PSARD   6                                           CGL020
     C           SCSARD    PARM SCSARD    @DSFDY                                              CGL020
      *                                                                                       CGL020
     C           PRTCD     IFNE *BLANKS                                                       CGL020
     C           PRTCD     ANDNE'*NRF    '                                                    CGL020
     C           *LOCK     IN   LDA                                                           CGL020
     C                     MOVE 'SCSARDPD'DBFILE                                              CGL020
     C                     Z-ADD25        DBASE                                               CGL020
     C                     MOVEL'CGL020'  DBKEY                                               CGL020
     C                     OUT  LDA                                                           CGL020
     C                     EXSR DBERR                                                         CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C           PRTCD     IFEQ *BLANKS                                                       CGL020
     C                     MOVE 'Y'       CGL020  1                                           CGL020
     C                     ELSE                                                               CGL020
     C                     MOVE 'N'       CGL020                                              CGL020
     C                     ENDIF                                                              CGL020
     C*                                                                   CAC003
     C*                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
     C*
      **     IF Market parameter is blank
      **          Set Last change Date for Output to RUND
     C*
     C           MARKET    IFEQ *BLANK
     C           *LIKE     DEFN RUND      LCDO
     C                     Z-ADDRUND      LCDO
     C                     END
     C*
      ** Check date format
     C*
     C           DATF      COMP 'M'                      98
     C*
      **     IF Market parameter is NOT blank
      **          Access LF/MKCTL
      **          IF no live record found
      **               Set on U7, U8, LR and update LDA
      **               Bypass further processing
     C*
     C           MARKET    IFNE *BLANK
     C                     OPEN MKCTL
     C           MARKET    CHAINMKCTL                99
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'MKCTL'   DBFILE           ***************
     C                     MOVELMARKET    DBKEY            * DB ERROR 02 *
     C                     Z-ADD2         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     OPEN MARKT
     C           MARKET    CHAINMARKT                99
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'MARKT'   DBFILE           ***************
     C                     MOVELMARKET    DBKEY            * DB ERROR 03 *
     C                     Z-ADD3         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
      **          Set Last change Date for Output to BUSD
     C*
     C                     Z-ADDBUSD      LCDO
     C*
      **          Format business date for report title
     C*
     C                     Z-ADDBUSD      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    FFDAT
     C                     MOVE MKTN      FFNAM
     C                     ELSE
     C                     MOVE RUNA      FFDAT
     C                     MOVE MSG,1     FFNAM
     C                     END
     C*
     C                     EXSR FFFMT
     C                     MOVE FFTXT     MNAMED
     C*
     C**  Set up underlining for heading
     C**  Initialise array index
     C                     Z-ADD0         X       20
     C*
     C**  FFULIN returned from SR. FFFMT contains number of characters
     C**  for underline
     C           X         DOUEQFFULIN
     C                     ADD  1         X
     C                     MOVEA'-'       FULA,X
     C                     END
     C*
     C**  Move underline array to output field
     C                     MOVEAFULA      FULINE
     C*
     C                     MOVE 'F'       TYPE
     C*                                                                   S01117
      **     IF PROFIT CENTRE USED, OPEN PROFIT CENTRE FILES              S01117
      **     TO BE USED IN SR/CLPFC.                                      S01117
     C*                                                                   S01117
     C           PFCU      IFEQ 'Y'                                       S01117
     C                     OPEN FOPCC                                     S01117
     C                     OPEN FOPCK                                     S01117
     C*                                                                   S01117
      **     ELSE PROFIT CENTRE NOT USED, SET PROFIT CENTRES TO *BLANK    S01117
     C*                                                                   S01117
     C                     ELSE                                           S01117
     C                     MOVE *BLANK    BRKRPC  4                       S01117
     C                     MOVE *BLANK    CUSTPC  4                       S01117
     C                     MOVE *BLANK    BOOKPC  4                       S01117
     C                     END                                            S01117
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R CLSTD - TO PERFORM PROCESSING ON ONE CLOST1 RECORD
      ** CALLED FROM MAIN PROCESSING
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           CLSTD     BEGSR
     C*
      **     IF *INL3 is on
      **          Access LF/FOCLT for Broker Code
      **          IF no live record found
      **               Set on U7, U8, LR and update LDA
      **               Bypass further processing
     C*
     C           *INL3     IFEQ '1'
     C********** BOCOD     ANDNE0                                                             CSD027
     C           BOCOD     ANDNE*BLANKS                                                       CSD027
     C           BOCOD     CHAINFOCLT                99
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'FOCLT'   DBFILE           ***************
     C                     MOVELBOCOD     DBKEY            * DB ERROR 04 *
     C                     Z-ADD4         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C           *LIKE     DEFN SETP      BSETPF
     C                     Z-ADDSETP      BSETPF
     C           *LIKE     DEFN SETA      BSETAF
     C                     MOVE SETA      BSETAF
     C           *LIKE     DEFN SEBRF     BSEBRF                          S01117
     C                     MOVE SEBRF     BSEBRF                          S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           *LIKE     DEFN FACO      BFACOF                                              CGL020
     C                     MOVE FACO      BFACOF                                              CGL020
     C           *LIKE     DEFN CNOS      BCNOSF                                              CGL020
     C                     MOVE CNOS      BCNOSF                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C                     END
     C*
      **     IF *INL2 is on
      **     AND Customer is non-zero
      **          Access LF/FOCLT for Customer Code
      **          IF no live record found
      **               Set on U7, U8, LR and update LDA
      **               Bypass further processing
     C*
     C           *INL2     IFEQ '1'
     C********** CUSCD     ANDNE0                                                             CSD027
     C           CUSCD     ANDNE*BLANKS                                                       CSD027
     C           CUSCD     CHAINFOCLT                99
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'FOCLT'   DBFILE           ***************
     C                     MOVELCUSCD     DBKEY            * DB ERROR 05 *
     C                     Z-ADD5         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C           *LIKE     DEFN SETP      CSETPF
     C                     Z-ADDSETP      CSETPF
     C           *LIKE     DEFN SETA      CSETAF
     C                     MOVE SETA      CSETAF
     C           *LIKE     DEFN SEBRF     CSEBRF                          S01117
     C                     MOVE SEBRF     CSEBRF                          S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           *LIKE     DEFN FACO      CFACOF                                              CGL020
     C                     MOVE FACO      CFACOF                                              CGL020
     C           *LIKE     DEFN CNOS      CCNOSF                                              CGL020
     C                     MOVE CNOS      CCNOSF                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C                     END
     C*
      **     IF *INL1 is on
      **          Access LF/INTYP for Instrument Details
      **          IF no live record found
      **               Set on U7, U8, LR and update LDA
      **               Bypass further processing
     C*
     C           *INL1     IFEQ '1'
     C           ISTT      CHAININTYP                99
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'INTYP'   DBFILE           ***************
     C                     MOVELISTT      DBKEY            * DB ERROR 06 *
     C                     Z-ADD6         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     END
     C*
      **          Set off Default flags
      **          IF customer is non-zero
      **               Access LF/DEFLT for this Customer/Instrument
      **               IF live record found
      **                    Flag that Defaults exist for this Customer
     C*
     C           *LIKE     DEFN SETP      BSETPD
     C                     Z-ADD0         BSETPD
     C           *LIKE     DEFN SETP      CSETPD
     C                     Z-ADD0         CSETPD
     C*
     C           *LIKE     DEFN SETA      BSETAD
     C                     MOVE *BLANK    BSETAD
     C           *LIKE     DEFN SETA      CSETAD
     C                     MOVE *BLANK    CSETAD
     C*                                                                   S01117
     C           *LIKE     DEFN SEBRD     BSEBRD                          S01117
     C                     MOVE *BLANK    BSEBRD                          S01117
     C           *LIKE     DEFN SEBRD     CSEBRD                          S01117
     C                     MOVE *BLANK    CSEBRD                          S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           *LIKE     DEFN FACO      BFACOD                                              CGL020
     C                     MOVE *BLANKS   BFACOD                                              CGL020
     C           *LIKE     DEFN CNOS      BCNOSD                                              CGL020
     C                     MOVE *BLANKS   BCNOSD                                              CGL020
     C           *LIKE     DEFN FACO      CFACOD                                              CGL020
     C                     MOVE *BLANKS   CFACOD                                              CGL020
     C           *LIKE     DEFN CNOS      CCNOSD                                              CGL020
     C                     MOVE *BLANKS   CCNOSD                                              CGL020
     C                     ENDIF                                                              CGL020
     C*
     C           MARKET    IFNE *BLANK
     C********** CUSCD     ANDGT0                                                             CSD027
     C**********           Z-ADDCUSCD     CBCD                                                CSD027
     C           CUSCD     ANDGT*BLANKS                                                       CSD027
     C                     MOVE CUSCD     CBCD                                                CSD027
     C                     MOVE ISTT      ISTTI
     C           DEFLTK    CHAINDEFLT                99
     C           *IN99     IFEQ '0'
     C           RECI      ANDEQ'D'
     C                     Z-ADDSETP      CSETPD
     C                     MOVE SETA      CSETAD
     C                     MOVE SEBRD     CSEBRD                          S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE FACO      CFACOD                                              CGL020
     C                     MOVE CNOS      CCNOSD                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C                     END
     C*
     C                     END
     C*
      **          IF Broker is non-zero
      **               Access LF/DEFLT for Broker/Instrument
      **               IF live record found
      **                    Flag that Defaults exist for this Broker
     C*
     C           MARKET    IFNE *BLANK
     C********** BOCOD     ANDGT0                                                             CSD027
     C**********           Z-ADDBOCOD     CBCD                                                CSD027
     C           BOCOD     ANDGT*BLANKS                                                       CSD027
     C                     MOVE BOCOD     CBCD                                                CSD027
     C                     MOVE ISTT      ISTTI
     C           DEFLTK    CHAINDEFLT                99
     C           *IN99     IFEQ '0'
     C           RECI      ANDEQ'D'
     C                     Z-ADDSETP      BSETPD
     C                     MOVE SETA      BSETAD
     C                     MOVE SEBRD     BSEBRD                          S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE FACO      BFACOD                                              CGL020
     C                     MOVE CNOS      BCNOSD                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C                     END
     C*
     C                     END
     C*                                                                   S01117
     C**     IF PROFIT CENTRE USED, DETERMINE RESPECTIVE PROFIT CENTRES   S01117
     C**               BROKER PROFIT CENTRE                               S01117
     C**               CUSTOMER PROFIT CENTRE                             S01117
     C**               BOOK PROFIT CENTRE                                 S01117
     C*                                                                   S01117
     C           PFCU      IFEQ 'Y'                                       S01117
     C                     EXSR CLPFC                                     S01117
     C                     END                                            S01117
     C*
      **     Perform First clostt Purchase/Sale processing
      **     Perform Remaining clostt processing
      **     Perform End of set processing
      **
     C*
     C                     EXSR FCLOT
     C                     EXSR REMCLT
     C                     EXSR ENDSET
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT                                                              S01117
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * S01117
      **                                                                  S01117
      ** S/R CLPFC - TO DETERMINE BROKER / CUSTOMER / BOOK PROFIT CENTRES S01117
      ** CALLED FROM S/R CLSTD                                            S01117
      ** CALLS: NOTHING                                                   S01117
      ** RESULT FIELDS : BRKRPC - BROKER PROFIT CENTRE                    S01117
      **                 CUSTPC - CUSTOMER PROFIT CENTRE                  S01117
      **                 BOOKPC - BOOK PROFIT CENTRE                      S01117
      **                                                                  S01117
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * S01117
     C*                                                                   S01117
     C           CLPFC     BEGSR                                          S01117
     C*                                                                   S01117
      **     IF BRANCH OR BROKER OR ISTRUEMENT CHANGED                    S01117
      **          ACCESS LF/FOPCC FOR BROKER PROFIT CENTRE                S01117
      **          IF no live record found                                 S01117
      **               Set on U7, U8, LR and update LDA                   S01117
      **               Bypass further processing                          S01117
     C*                                                                   S01117
     C********** BOCOD     IFNE 0                                                      S01117 CSD027
     C           BOCOD     IFNE *BLANKS                                                       CSD027
     C*                                                                   S01117
     C           BRCAD     IFNE PBRCA                                     S01117
     C           BOCOD     ORNE PBOCOD                                    S01117
     C           ISTT      ORNE PISTT                                     S01117
     C*                                                                   CAC003
     C***If*Analytical*Accounting*and*SAR*CAC003*are*installed,****                    CAC003 241735
     C***move*FF*ICD*Default*Profit*Centre*to*Broker*Profit*Centre*                    CAC003 241735
     C*                                                                   CAC003
     C************IN50     IFEQ '1'                                                    CAC003 241735
     C***********          MOVE BXFOPC    BRKRPC                                       CAC003 241735
     C***********          ELSE                                                        CAC003 241735
     C*                                                                   S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     MOVE BOCOD     CBCD                            S01117
     C           FOPCCK    CHAINFOPCC                99                   S01117
     C           *IN99     IFEQ '1'                                       S01117
     C           RECI      ORNE 'D'                                       S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'FOPCC'   DBFILE           ***************S01117
     C                     MOVELFOPCKY    DBKEY            * DB ERROR 20 *S01117
     C                     Z-ADD20        DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C                     MOVE PCCB      BRKRPC                          S01117
     C*                                                                   CAC003
      ** Check if Analytical Accounting is on.  If on and processing                          241735
      ** a broker but profit ctr in FOPCCD is blank, use profit ctr                           241735
      ** defined in ICD.                                                                      241735
      *                                                                                       241735
     C           *IN50     IFEQ '1'                                                           241735
     C           PCCB      ANDEQ*BLANK                                                        241735
     C                     MOVE BXFOPC    BRKRPC                                              241735
     C                     ENDIF                                          CAC003
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                                            S01117
     C*                                                                   S01117
      **     IF BRANCH OR CUSTOMER OR ISTRUEMENT CHANGED                  S01117
      **          ACCESS LF/FOPCC FOR CUSTOMER PROFIT CENTRE              S01117
      **          IF no live record found                                 S01117
      **               Set on U7, U8, LR and update LDA                   S01117
      **               Bypass further processing                          S01117
     C*                                                                   S01117
     C********** CUSCD     IFNE 0                                                      S01117 CSD027
     C           CUSCD     IFNE *BLANKS                                                       CSD027
     C*                                                                   S01117
     C           BRCAD     IFNE PBRCA                                     S01117
     C           CUSCD     ORNE PCUSCD                                    S01117
     C           ISTT      ORNE PISTT                                     S01117
     C*                                                                   S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     MOVE CUSCD     CBCD                            S01117
     C           FOPCCK    CHAINFOPCC                99                   S01117
     C           *IN99     IFEQ '1'                                       S01117
     C           RECI      ORNE 'D'                                       S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'FOPCC'   DBFILE           ***************S01117
     C                     MOVELFOPCKY    DBKEY            * DB ERROR 21 *S01117
     C                     Z-ADD21        DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C                     MOVE PCCB      CUSTPC                          S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                                            S01117
     C*                                                                   S01117
      **     IF BRANCH OR BOOK OR ISTRUEMENT CHANGED                      S01117
      **          ACCESS LF/FOPCK FOR BOOK PROFIT CENTRE                  S01117
      **          IF no live record found                                 S01117
      **               Set on U7, U8, LR and update LDA                   S01117
      **               Bypass further processing                          S01117
     C*                                                                   S01117
     C           BOKCD     IFNE *BLANK                                    S01117
     C*                                                                   S01117
     C           BRCAD     IFNE PBRCA                                     S01117
     C           BOKCD     ORNE PBOKCD                                    S01117
     C           ISTT      ORNE PISTT                                     S01117
     C*                                                                   S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     MOVE BOKCD     BOKC                            S01117
     C           FOPCKK    CHAINFOPCK                99                   S01117
     C           *IN99     IFEQ '1'                                       S01117
     C           RECI      ORNE 'D'                                       S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE BRCA      KBRCA                           S01117
     C                     MOVE BOKCD     KBOKC                           S01117
     C                     MOVE ISTT      KISTT                           S01117
     C                     MOVEL'FOPCK'   DBFILE           ***************S01117
     C                     MOVELFOPKKY    DBKEY            * DB ERROR 22 *S01117
     C                     Z-ADD22        DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR                                     S01117
     C                     END                                            S01117
     C                     MOVE PCBK      BOOKPC                          S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C** SAVE BROKER/CUSTOMER/BOOK/BRANCH/INSTRUMENT CODE FOR             S01117
     C** NEXT CYCLE'S TESTING                                             S01117
     C           *LIKE     DEFN BOCOD     PBOCOD                          S01117
     C                     MOVE BOCOD     PBOCOD                          S01117
     C           *LIKE     DEFN CUSCD     PCUSCD                          S01117
     C                     MOVE CUSCD     PCUSCD                          S01117
     C           *LIKE     DEFN BOKCD     PBOKCD                          S01117
     C                     MOVE BOKCD     PBOKCD                          S01117
     C           *LIKE     DEFN BRCAD     PBRCA                           S01117
     C                     MOVE BRCAD     PBRCA                           S01117
     C           *LIKE     DEFN ISTT      PISTT                           S01117
     C                     MOVE ISTT      PISTT                           S01117
     C*                                                                   S01117
     C                     ENDSR                                          S01117
     C*                                                                   S01117
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * S01117
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R FCLOT - TO PERFORM ACCESS FIRST CLOST4/5 RECORDS FOR A SET
      ** CALLED FROM CLSTD
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           FCLOT     BEGSR
     C*
      **     Access LF/CLOST4 for current close out number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           CLON      CHAINCLOST4               40
     C*
     C           *IN40     IFEQ '1'
     C           RECIP     ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLST4'   DBFILE           ***************
     C                     MOVELCLON      DBKEY            * DB ERROR 07 *
     C                     Z-ADD7         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
      **     Access LF/CLOST5 for current close out number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           CLON      CHAINCLOST5               41
     C*
     C           *IN41     IFEQ '1'
     C           RECIS     ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLST5'   DBFILE           ***************
     C                     MOVELCLON      DBKEY            * DB ERROR 08 *
     C                     Z-ADD8         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
      **     Access LF/TRANS for LF/CLOST4 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           TNBRP     CHAINTRANS                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRANS'   DBFILE           ***************
     C                     MOVELTNBRP     DBKEY            * DB ERROR 09 *
     C                     Z-ADD9         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C           *LIKE     DEFN COPR      COPRP
     C                     Z-ADDCOPR      COPRP
     C           *LIKE     DEFN BOKC      BOKCP
     C                     MOVE BOKC      BOKCP
     C*
      **     Access LF/TRSET for LF/CLOST4 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           TNBRP     CHAINTRSET                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRSET'   DBFILE           ***************
     C                     MOVELTNBRP     DBKEY            * DB ERROR 10 *
     C                     Z-ADD10        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C           *LIKE     DEFN BSLT      BSLTP
     C                     Z-ADDBSLT      BSLTP
     C           *LIKE     DEFN CSLT      CSLTP
     C                     Z-ADDCSLT      CSLTP
     C           *LIKE     DEFN BSLA      BSLAP
     C                     MOVE BSLA      BSLAP
     C           *LIKE     DEFN CSLA      CSLAP
     C                     MOVE CSLA      CSLAP
     C           *LIKE     DEFN BSBR      BSBRP                           S01117
     C                     MOVE BSBR      BSBRP                           S01117
     C           *LIKE     DEFN BRSC      BRSCP                           S01117
     C                     MOVE BRSC      BRSCP                           S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           *LIKE     DEFN BFAO      BFAOP                                               CGL020
     C                     MOVE BFAO      BFAOP                                               CGL020
     C           *LIKE     DEFN BCPN      BCPNP                                               CGL020
     C                     MOVE BCPN      BCPNP                                               CGL020
     C           *LIKE     DEFN CFAO      CFAOP                                               CGL020
     C                     MOVE CFAO      CFAOP                                               CGL020
     C           *LIKE     DEFN CCPN      CCPNP                                               CGL020
     C                     MOVE CCPN      CCPNP                                               CGL020
     C                     ENDIF                                                              CGL020
     C*
      **     Access LF/TRANS for LF/CLOST5 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           TNBRS     CHAINTRANS                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRANS'   DBFILE           ***************
     C                     MOVELTNBRS     DBKEY            * DB ERROR 11 *
     C                     Z-ADD11        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C           *LIKE     DEFN COPR      COPRS
     C                     Z-ADDCOPR      COPRS
     C           *LIKE     DEFN BOKC      BOKCS
     C                     MOVE BOKC      BOKCS
     C           *LIKE     DEFN PTFR      WWPTFR                          S71062
     C                     MOVE PTFR      WWPTFR                          S71062
     C*
      **     Access LF/TRSET for LF/CLOST5 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           TNBRS     CHAINTRSET                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRSET'   DBFILE           ***************
     C                     MOVELTNBRS     DBKEY            * DB ERROR 12 *
     C                     Z-ADD12        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C           *LIKE     DEFN BSLT      BSLTS
     C                     Z-ADDBSLT      BSLTS
     C           *LIKE     DEFN CSLT      CSLTS
     C                     Z-ADDCSLT      CSLTS
     C           *LIKE     DEFN BSLA      BSLAS
     C                     MOVE BSLA      BSLAS
     C           *LIKE     DEFN CSLA      CSLAS
     C                     MOVE CSLA      CSLAS
     C           *LIKE     DEFN BSBR      BSBRS                           S01117
     C                     MOVE BSBR      BSBRS                           S01117
     C           *LIKE     DEFN BRSC      BRSCS                           S01117
     C                     MOVE BRSC      BRSCS                           S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           *LIKE     DEFN BFAO      BFAOS                                               CGL020
     C                     MOVE BFAO      BFAOS                                               CGL020
     C           *LIKE     DEFN BCPN      BCPNS                                               CGL020
     C                     MOVE BCPN      BCPNS                                               CGL020
     C           *LIKE     DEFN CFAO      CFAOS                                               CGL020
     C                     MOVE CFAO      CFAOS                                               CGL020
     C           *LIKE     DEFN CCPN      CCPNS                                               CGL020
     C                     MOVE CCPN      CCPNS                                               CGL020
     C                     ENDIF                                                              CGL020
     C*
      **     Set running totals of unmatched purchase/sale contracts
     C*
     C           *LIKE     DEFN NCCLP     WNCCLP
     C                     Z-ADDNCCLP     WNCCLP
     C           *LIKE     DEFN NCCLS     WNCCLS
     C                     Z-ADDNCCLS     WNCCLS
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R REMCLT - TO PERFORM REMAINING CLOST4/5 RECORD PROCESSING
      ** CALLED FROM CLSTD
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           REMCLT    BEGSR
     C*
      **     DO WHILE Close out number for Transactions is same as Set number
      **     AND Not end of CLOST4/5
     C*
     C           *IN40     DOWEQ'0'
     C           *IN41     ANDEQ'0'
     C*
      ** Assess number of contracts being closed (smaller of P/S)
     C*
     C           *LIKE     DEFN NCCLP     CURNOC
     C           WNCCLP    IFGT WNCCLS
     C                     Z-ADDWNCCLS    CURNOC
     C                     ELSE
     C                     Z-ADDWNCCLP    CURNOC
     C                     END
     C*
      **     IF Instrument type is 4, 5 or 6 (ie. Option)
     C*
     C           ISPT      IFGE 4
     C           ISPT      ANDNE7                                         AUS022
     C*
      **    IF purchase transaction date is greater than sale, or if
      **     they are equal but purchase transaction number is greater,
      **     then purchase is closing out sale.
      **    Perform Premium calculation on Purchase
      **    Perform A/c key generation on Purchase
      **    Perform Premium calculation on Sale
      **    Perform A/c key generation on Sale
     C*
     C           TRSDP     IFGT TRSDS
     C*
     C           TRSDP     OREQ TRSDS
     C           TNBRP     ANDGTTNBRS
     C*
     C                     MOVE CSLAP     CSLA
     C                     Z-ADDCSLTP     CSLT
     C                     MOVE BRSCP     BRSC                            S01117
     C                     MOVE BSLAP     BSLA
     C                     Z-ADDBSLTP     BSLT
     C                     MOVE BSBRP     BSBR                            S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE CFAOP     CFAO                                                CGL020
     C                     MOVE CCPNP     CCPN                                                CGL020
     C                     MOVE BFAOP     BFAO                                                CGL020
     C                     MOVE BCPNP     BCPN                                                CGL020
     C                     ENDIF                                                              CGL020
     C*
     C                     Z-ADDCURNOC    FFNOC
     C***********          Z-ADDCOPRP     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
     C*                                                                   E30422
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRP      FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRP     FFPRIC                          054174
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     EXSR FFPMCL
      **                                                                  247057
      **   for processing type 5 (CCY OTC), divide premium by 100         247057
     C           ISPT      IFEQ 5                                         247057
     C           FFPREM    DIV  100       FFPREM                          247057
     C                     ENDIF                                          247057
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRP     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTNBRP     TNBR
     C                     MOVE TRTYP     TRTY
     C                     MOVE BOKCP     BOKC
     C           FFPREM    IFNE 0
     C                     EXSR GENAKT
     C                     END
     C*
     C                     Z-ADDCURNOC    FFNOC
     C***********          Z-ADDCOPRS     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
     C*                                                                   E30422
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRP      FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRS     FFPRIC                          054174
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     EXSR FFPMCL
      **                                                                  247057
      **   for processing type 5 (CCY OTC), divide premium by 100         247057
     C           ISPT      IFEQ 5                                         247057
     C           FFPREM    DIV  100       FFPREM                          247057
     C                     ENDIF                                          247057
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRS     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTNBRS     TNBR
     C                     MOVE TRTYS     TRTY
     C                     MOVE BOKCS     BOKC
     C           FFPREM    IFNE 0
     C                     EXSR GENAKT
     C                     END
     C*
     C                     ELSE
     C*
      **       IF Sale transaction date is greater than Purchase or if
      **        they are equal but Sale transaction number is greater,
      **        then Sale is closing out Purchase,
      **       Perform Premium calculation on Sale
      **       Perform A/c key generation on Sale
      **       Perform Premium calculation on Purchase
      **       Perform A/c key generation on Purchase
     C*
     C                     MOVE CSLAS     CSLA
     C                     Z-ADDCSLTS     CSLT
     C                     MOVE BRSCS     BRSC                            S01117
     C                     MOVE BSLAS     BSLA
     C                     Z-ADDBSLTS     BSLT
     C                     MOVE BSBRS     BSBR                            S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE CFAOS     CFAO                                                CGL020
     C                     MOVE CCPNS     CCPN                                                CGL020
     C                     MOVE BFAOS     BFAO                                                CGL020
     C                     MOVE BCPNS     BCPN                                                CGL020
     C                     ENDIF                                                              CGL020
     C*
     C                     Z-ADDCURNOC    FFNOC
     C***********          Z-ADDCOPRS     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
     C*                                                                   E30422
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRP      FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRS     FFPRIC                          054174
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     EXSR FFPMCL
      **                                                                  247057
      **   for processing type 5 (CCY OTC), divide premium by 100         247057
     C           ISPT      IFEQ 5                                         247057
     C           FFPREM    DIV  100       FFPREM                          247057
     C                     ENDIF                                          247057
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRS     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTNBRS     TNBR
     C                     MOVE TRTYS     TRTY
     C                     MOVE BOKCS     BOKC
     C           FFPREM    IFNE 0
     C                     EXSR GENAKT
     C                     END
     C*
     C                     Z-ADDCURNOC    FFNOC
     C***********          Z-ADDCOPRP     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
     C*                                                                   E30422
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRP      FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRP     FFPRIC                          054174
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          END                                     054174 136056
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     EXSR FFPMCL
      **                                                                  247057
      **   for processing type 5 (CCY OTC), divide premium by 100         247057
     C           ISPT      IFEQ 5                                         247057
     C           FFPREM    DIV  100       FFPREM                          247057
     C                     ENDIF                                          247057
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRP     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTNBRP     TNBR
     C                     MOVE TRTYP     TRTY
     C                     MOVE BOKCP     BOKC
     C           FFPREM    IFNE 0
     C                     EXSR GENAKT
     C                     END
     C*
     C                     END
     C                     END
     C*
      **     Subtract No. Matched contracts from running totals
     C*
     C           WNCCLP    SUB  CURNOC    WNCCLP
     C           WNCCLS    SUB  CURNOC    WNCCLS
     C*
      **     IF Purchase running total is Zero
      **          IF Instrument type is 4, 5 or 6
      **          AND Premium up front is 'N'
      **                Calculate Premium on Purchase (original no. conts)
      **                Write to POCHGTC/K for purchase premium payable
      **          Write POCHGTC/K for purchase contracts closed
      **          Read LF/CLOST4
      **          IF Close out number is unchanged
      **              Add to running totals of unmatched Purchase contracts
     C*
     C           WNCCLP    IFEQ 0
     C*
     C           ISPT      IFGE 4
     C           ISPT      ANDNE7                                         AUS022
     C           PUPF      ANDEQ'N'
     C                     Z-ADDNCCLP     FFNOC
     C***********          Z-ADDCOPRP     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
     C*                                                                   E30422
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRP      FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRP     FFPRIC                          054174
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     EXSR FFPMCL
      **                                                                  247057
      **   for processing type 5 (CCY OTC), divide premium by 100         247057
     C           ISPT      IFEQ 5                                         247057
     C           FFPREM    DIV  100       FFPREM                          247057
     C                     ENDIF                                          247057
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRP     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTNBRP     TNBR
     C                     MOVE TRTYP     TRTY
     C                     EXSR POCOPT
     C                     END
     C*
     C                     Z-ADDTNBRP     TNBR
     C                     Z-SUBNCCLP     POCQ
     C                     EXSR POCFOA
     C*
     C           CLON      READECLOST4                   40
     C*
     C           *IN40     IFEQ '0'
     C                     ADD  NCCLP     WNCCLP
     C                     END
     C*
     C                     END
     C*
      **          IF Sale running total is Zero
      **               IF Instrument type is 4, 5 or 6
      **               AND Premium up front is 'N'
      **                    Calculate Premium on Sale (original no. conts)
      **                    Write to POCHGTC/K for sale premium payable
      **               Write POCHGTC/K for sale contracts closed
      **               Read LF/CLOST5
      **               IF Close out number is unchanged
      **                    Add to running totals of unmatched sale contracts
     C*
     C           WNCCLS    IFEQ 0
     C*
     C           ISPT      IFGE 4
     C           ISPT      ANDNE7                                         AUS022
     C           PUPF      ANDEQ'N'
     C                     Z-ADDNCCLS     FFNOC
     C***********          Z-ADDCOPRS     FFPRIC                          E30422
     C*                                                                   E30422
     C**   Use the strike price in the Premium calculation.               E30422
      **   for processing type 8                                          054174
     C*                                                                   E30422
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          Z-ADDSTRP      FFPRIC                   E30422 136056
     C*                                                                   054174
      **   for other types of options use the contract price              054174
     C*                                                                   054174
     C***********          ELSE                                    054174 136056
     C                     Z-ADDCOPRS     FFPRIC                          054174
     C                     Z-ADDSTRP      FFSTRP                          136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTKDM      FFTKDM
     C                     Z-ADDMNPF      FFMNPF
     C                     Z-ADDTKVL      FFTKVL
     C                     EXSR FFPMCL
      **                                                                  247057
      **   for processing type 5 (CCY OTC), divide premium by 100         247057
     C           ISPT      IFEQ 5                                         247057
     C           FFPREM    DIV  100       FFPREM                          247057
     C                     ENDIF                                          247057
     C*                                                                   054174
      **   for processing type 8, multiply the amount calculated          054174
      **   by the contract price.                                         054174
     C*                                                                   054174
     C***********ISPT      IFEQ 8                                  054174 136056
     C***********          MULT COPRS     FFPREM                   E30422 136056
     C***********          END                                     054174 136056
     C*                                                                   054174
     C                     Z-ADDTNBRS     TNBR
     C                     MOVE TRTYS     TRTY
     C                     EXSR POCOPT
     C                     END
     C*
     C                     Z-ADDTNBRS     TNBR
     C                     Z-SUBNCCLS     POCQ
     C                     EXSR POCFOA
     C*
     C           CLON      READECLOST5                   41
     C*
     C           *IN41     IFEQ '0'
     C                     ADD  NCCLS     WNCCLS
     C                     END
     C*
     C                     END
     C*
      **          IF CLOST4/5 Close out numbers differ
      **               Set on U7, U8, LR and update LDA
      **               Bypass further processing (Set EOF for CLOST4/5)
     C*
     C           *IN40     IFNE *IN41
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLOST'   DBFILE           ***************
     C                     MOVELCLON      DBKEY            * DB ERROR 13 *
     C                     Z-ADD13        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C*
     C                     END
     C*
      **     Access LF/TRANS for LF/CLOST4 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           *IN40     IFEQ *IN41
     C*
     C           TNBRP     CHAINTRANS                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRANS'   DBFILE           ***************
     C                     MOVELTNBRP     DBKEY            * DB ERROR 14 *
     C                     Z-ADD14        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     Z-ADDCOPR      COPRP
     C                     MOVE BOKC      BOKCP
     C*
      **     Access LF/TRSET for LF/CLOST4 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           TNBRP     CHAINTRSET                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRSET'   DBFILE           ***************
     C                     MOVELTNBRP     DBKEY            * DB ERROR 15 *
     C                     Z-ADD15        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     Z-ADDBSLT      BSLTP
     C                     Z-ADDCSLT      CSLTP
     C                     MOVE BSLA      BSLAP
     C                     MOVE CSLA      CSLAP
     C                     MOVE BSBR      BSBRP                           S01117
     C                     MOVE BRSC      BRSCP                           S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE BFAO      BFAOP                                               CGL020
     C                     MOVE BCPN      BCPNP                                               CGL020
     C                     MOVE CFAO      CFAOP                                               CGL020
     C                     MOVE CCPN      CCPNP                                               CGL020
     C                     ENDIF                                                              CGL020
     C*
      **     Access LF/TRANS for LF/CLOST5 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           TNBRS     CHAINTRANS                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRANS'   DBFILE           ***************
     C                     MOVELTNBRS     DBKEY            * DB ERROR 16 *
     C                     Z-ADD16        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     Z-ADDCOPR      COPRS
     C                     MOVE BOKC      BOKCS
     C                     MOVE PTFR      WWPTFR                          S71062
     C*
      **     Access LF/TRSET for LF/CLOST5 Transaction number
      **     IF no live record found
      **          Set on U7, U8, LR and update LDA
      **          Bypass further processing
     C*
     C           TNBRS     CHAINTRSET                99
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRSET'   DBFILE           ***************
     C                     MOVELTNBRS     DBKEY            * DB ERROR 17 *
     C                     Z-ADD17        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
     C                     Z-ADDBSLT      BSLTS
     C                     Z-ADDCSLT      CSLTS
     C                     MOVE BSLA      BSLAS
     C                     MOVE CSLA      CSLAS
     C                     MOVE BSBR      BSBRS                           S01117
     C                     MOVE BRSC      BRSCS                           S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE BFAO      BFAOS                                               CGL020
     C                     MOVE BCPN      BCPNS                                               CGL020
     C                     MOVE CFAO      CFAOS                                               CGL020
     C                     MOVE CCPN      CCPNS                                               CGL020
     C                     ENDIF                                                              CGL020
     C*
     C                     END
     C*
      ** End of DO loop
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /COPY ZSRSRC,FFTVCLZ2
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /COPY ZSRSRC,FFPMCLZ1
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R ENDSET - TO PERFORM REMAINING CLOST1 RECORD PROCESSING
      ** CALLED FROM CLSTD
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           ENDSET    BEGSR
     C*
      **        Initialise hedging amortisation needed indicator
     C*
     C                     MOVE '0'       *IN30
     C           BOKCD     IFNE *BLANK                                    E18232
     C*
      **        Access BOOKD for Hedge Indicator
     C*
     C           BOKCD     CHAINBOOKD                99
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BOOKD'   DBFILE           ***************
     C                     MOVELBOKCD     DBKEY            * DB ERROR 18 *
     C                     Z-ADD18        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
      **        Check if Hedge Indicator equal to 'Y'
     C*
     C           HDGI      IFEQ 'Y'
     C*
      **        Check that Underlying Period is not equal to zero
     C*
     C           ULPD      IFNE 0
     C*
      **        Check if Close Out Date is on or after spot month date
     C*
      **        If program being run for OTC, compare close out date
      **        with spot month date
     C*
     C           MARKET    IFEQ *BLANK
     C           CLOD      IFGE SPDT
     C/COPY WNCPYSRC,FF0410C001
     C*
      **        Set on hedging amortisation needed indicator
     C*
     C                     MOVE '1'       *IN30
     C*
     C                     END
     C*
      **        Else program being run for a market;
      **        Use spot month formula and standard sr. FFDATE to
      **        calculate spot month date
     C*
     C                     ELSE
     C*
     C                     MOVE SPMF      FFDATC
     C                     Z-ADDMTHND     FFMTH
     C                     Z-ADDYRNOD     FFYR
     C                     MOVE MKLC      FFCCY1
     C                     MOVE MLOC      FFLOC                           S01195
     C                     MOVE ISCYD     FFCCY2
     C                     MOVE OTHC      FFCCY3
     C*
     C                     EXSR FFDATE
     C*
      **        Check if Close Out Date is on or after spot month date
     C*
     C           CLOD      IFGE FFDAY
     C/COPY WNCPYSRC,FF0410C002
     C*
      **        Set on hedging amortisation needed indicator
     C*
     C                     MOVE '1'       *IN30
     C*
     C                     END
     C*
     C                     END
     C                     END
     C                     END
     C                     END                                            E18232
     C*
      **        Write Realized P/L Account keys
      **        Write Realized P/L Position change records
      **        Set details for update of CLOST1 record
     C*
     C           COPL      IFNE 0
     C                     EXSR GENAKD
     C                     END
     C*
     C                     EXSR POCC1R
     C*
     C                     EXSR ZTNLU1
     C                     MOVE NATN      TNLU
     C                     MOVE 'A'       CHTP
     C                     Z-ADDLCDO      LCD
     C                     MOVE 'Y'       ECPID
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R GENAKT - TO WRITE PREMIUM ACCOUNT KEYS (PER CLOST4/5 RECORD)
      ** CALLED FROM
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           GENAKT    BEGSR
     C*
     C                     MOVE 'D'       RECI
     C                     Z-ADDRUND      EDAT
     C                     Z-ADDLCDO      VDAT
     C                     MOVE ISCY      CCY
     C***********          Z-ADDBRCDD     BRCD                            S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     MOVE ISTT      ISTTI
     C                     MOVE *BLANK    AMOR
     C*
      ** The instrument type is defined on the account key
      ** but for market instruments only
     C*
     C           BXISTY    IFEQ 'Y'                                       S01455
     C********** MARKET    IFNE *BLANK                                                        083196
     C           ISTI      IFEQ 'N'                                                           083196
     C                     MOVE ISTT      MKINST
     C                     MOVELMRKT      MKINST                          S01455
     C                     ELSE                                           S01455
     C                     MOVE '     '   MKINST                          S01455
     C                     END
     C                     ELSE                                           S01455
     C**********           MOVE '     '   MKINST                                       S01455 083196
     C**********           END                                                         S01455 083196
     C           ISTI      IFEQ 'Y'                                                           083196
     C                     MOVEL*BLANK    MKINST                                              083196
     C                     ELSE                                                               083196
     C                     MOVELMRKT      MKINST                                              083196
     C                     END                                                                083196
      *                                                                                       245070
     C                     END                                                                245070
     C*                                                                   S01455
     C*                                                                   S01455
      ** The processing type is only valid if indicator is 'Y'            S01455
      ** on I.C.D. "SDFODAPD"                                             S01455
      *                                                                   S01455
     C           BXPROT    IFEQ 'Y'                                       S01455
     C                     MOVE ISPT      INVA                            S01455
     C                     ELSE                                           S01455
     C                     MOVE *BLANKS   INVA                            S01455
     C                     END                                            S01455
      **********                                                                       083196 245070
     C**********           END                                                         083196 245070
     C*
      ** BOKC is set up just prior to execution of this subroutine
      ** (It is the book code on the trade being closed out)
     C*
     C                     MOVE BOKC      BOOK
     C                     MOVE 'P'       ETYP
     C/COPY WNCPYSRC,FF0410C003
     C*
      **     IF Customer is non-zero
      **          Write FOKEYD Record for Customer
     C*
     C********** CUSCD     IFGT 0                                                             CSD027
     C           CUSCD     IFGT *BLANKS                                                       CSD027
     C*
      **     IF Broker is zero
     C*
     C********** BOCOD     IFEQ 0                                                             CSD027
     C           BOCOD     IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'C'       CORB
     C*
      ** For Market instruments, amount code is 'E'
      ** IF MARKET/INST ON THE KEY ELSE CHECK PREMIUM UP FRONT INDIC.     S01455
     C*
     C           ISTI      IFEQ 'N'
     C           BXISTY    IFEQ 'Y'                                       S01455
     C           BXISTY    OREQ 'N'                                       S01455
     C           PUPF      ANDEQ'Y'                                       S01455
     C                     MOVE 'E'       AMTC
     C                     ELSE                                           S01455
     C                     MOVE 'G'       AMTC                            S01455
     C                     END                                            S01455
     C                     END
     C*
      ** For Over the Counter: Premium up front, 'E'
     C*
     C           ISTI      IFEQ 'Y'
     C           PUPF      ANDEQ'Y'
     C                     MOVE 'E'       AMTC
     C                     END
     C*
      ** For Over the Counter: Premium not up front, 'G'
     C*
     C           ISTI      IFEQ 'Y'
     C           PUPF      ANDEQ'N'
     C                     MOVE 'G'       AMTC
     C                     END
     C*
     C                     ELSE
     C*
     C                     MOVE *BLANK    CORB
     C*
      ** Transaction type of trade closed out
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'R'       AMTC
     C                     ELSE
     C                     MOVE 'S'       AMTC
     C                     END
     C*
     C                     END
     C*
     C**********           Z-ADDCUSCD     CBCD                                                CSD027
     C                     MOVE CUSCD     CBCD                                                CSD027
     C                     MOVE WWPTFR    PTFR                            S71062
     C*
      ** Customer settlement details
     C*
     C                     Z-ADDCSLT      SETP
     C                     MOVE CSLA      SETA
     C                     MOVE BRSC      SEBR                            S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE CFAO      SEFA   10                                           CGL020
     C                     MOVE CCPN      SECP    8                                           CGL020
     C                     EXSR SRAMPR                                                        CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** Transaction type of trade closed out
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** Premium payable on closure
     C*
     C           FFPREM    IFLT 0
     C                     Z-SUBFFPREM    EAMT
     C                     ELSE
     C                     Z-ADDFFPREM    EAMT
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*                                                                   S01117
      ** SET CUSTOMER-PROFIT-CENTRE                                       S01117
     C*                                                                   S01117
     C                     MOVE CUSTPC    PRFC                            S01117
     C*
     C                     WRITEFOKEYDF
     C*
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
     C                     END
     C*
      **     IF Broker is non-zero
      **          Write FOKEYD Record for Broker
     C*
     C********** BOCOD     IFGT 0                                                             CSD027
     C           BOCOD     IFGT *BLANKS                                                       CSD027
     C*
      **     IF Customer is zero
     C*
     C********** CUSCD     IFEQ 0                                                             CSD027
     C           CUSCD     IFEQ *BLANKS                                                       CSD027
     C                     MOVE 'B'       CORB
      * IF MARKET/INSTR. ON ACCOUNT KEY AMOUNT CODE = 'E'                 S01455
      * ELSE DEPEND IF PREMIUM UP-FRONT OR NOT                            S01455
      *                                                                   S01455
     C           BXISTY    IFEQ 'Y'                                       S01455
     C           BXISTY    OREQ 'N'                                       S01455
     C           PUPF      ANDEQ'Y'                                       S01455
     C                     MOVE 'E'       AMTC
     C                     ELSE                                           S01455
     C                     MOVE 'G'       AMTC                            S01455
     C                     END                                            S01455
     C*
     C                     ELSE
     C*
     C                     MOVE *BLANK    CORB
     C*
      ** Transaction type of trade closed out
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'S'       AMTC
     C                     ELSE
     C                     MOVE 'R'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** Broker settlement details
     C*
     C**********           Z-ADDBOCOD     CBCD                                                CSD027
     C                     MOVE BOCOD     CBCD                                                CSD027
     C                     MOVE *BLANKS   PTFR                            S71062
     C                     Z-ADDBSLT      SETP
     C                     MOVE BSLA      SETA
     C                     MOVE BSBR      SEBR                            S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE BFAO      SEFA                                                CGL020
     C                     MOVE BCPN      SECP                                                CGL020
     C                     EXSR SRAMPR                                                        CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** Transaction type of trade closed out
     C*
     C           TRTY      IFEQ 'P'
     C                     MOVE 'L'       LORS
     C                     ELSE
     C                     MOVE 'S'       LORS
     C                     END
     C*
      ** Premium payable on closure
     C*
     C           FFPREM    IFLT 0
     C                     Z-SUBFFPREM    EAMT
     C                     ELSE
     C                     Z-ADDFFPREM    EAMT
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*                                                                   S01117
      ** SET BROKER-PROFIT-CENTRE                                         S01117
     C*                                                                   S01117
     C                     MOVE BRKRPC    PRFC                            S01117
     C*
     C                     WRITEFOKEYDF
     C*
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R POCOPT - TO WRITE POCHGTC/K RECORDS FOR PREMIUM PAYABLE (CLOST4/5)
      ** CALLED FROM
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           POCOPT    BEGSR
     C*
     C***********          Z-ADDBRCDD     BRCD                            S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     MOVE 'D'       RECI
     C                     Z-ADDLCDO      POCD
     C                     MOVE 'N'       AOSI
     C                     MOVE 'N'       ATCI
     C                     MOVE 'N'       PUPI
     C                     MOVE 'C'       PCGT
     C                     Z-ADD0         POCQ
     C*
      **     IF Customer is non-zero
      **          Write POCHGTC Record for Customer
     C*
     C********** CUSCD     IFGT 0                                                             CSD027
     C           CUSCD     IFGT *BLANKS                                                       CSD027
     C*
     C**********           Z-ADDCUSCD     CBCD                                                CSD027
     C                     MOVE CUSCD     CBCD                                                CSD027
     C*
      ** Premium amount sign is reversed if book is not present and
      ** trade is a purchase or if book is present and trade is a sale
     C*
     C           BOKCD     IFEQ *BLANK
     C           TRTY      ANDEQ'P'
     C           BOKCD     ORNE *BLANK
     C           TRTY      ANDEQ'S'
     C                     Z-ADDFFPREM    PCGA
     C                     ELSE
     C                     Z-SUBFFPREM    PCGA
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set is reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGTCF
     C*
     C                     END
     C*
      **     IF Broker is non-zero
      **          Write POCHGTC Record for Broker
     C*
     C********** BOCOD     IFGT 0                                                             CSD027
     C           BOCOD     IFGT *BLANKS                                                       CSD027
     C*
     C**********           Z-ADDBOCOD     CBCD                                                CSD027
     C                     MOVE BOCOD     CBCD                                                CSD027
     C*
      ** Transaction type of trade being closed out
     C*
     C           TRTY      IFEQ 'P'
     C                     Z-SUBFFPREM    PCGA
     C                     ELSE
     C                     Z-ADDFFPREM    PCGA
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set is reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGTCF
     C*
     C                     END
     C*
      **     IF Book is non-zero
      **          Write POCHGTK Record for Book
     C*
     C           BOKCD     IFNE *BLANK
     C*
     C                     MOVE BOKCD     BOKC
     C*
      ** Transaction type of trade being closed out
     C*
     C           TRTY      IFEQ 'P'
     C                     Z-ADDFFPREM    PCGA
     C                     ELSE
     C                     Z-SUBFFPREM    PCGA
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set is reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGTKF
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R POCFOA - TO WRITE POCHGTC/K RECORDS FOR CONTRACTS CLOSED (CLOST4/5)
      ** CALLED FROM
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           POCFOA    BEGSR
     C*
     C                     MOVE 'D'       RECI
     C***********          Z-ADDBRCDD     BRCD                            S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     Z-ADDLCDO      POCD
     C                     MOVE 'N'       AOSI
     C                     MOVE 'N'       ATCI
     C                     MOVE 'N'       PUPI
     C                     MOVE *BLANK    PCGT
     C                     Z-ADD0         PCGA
     C*
      **     IF Customer is non-zero
      **          Write POCHGTC Record for Customer
     C*
     C********** CUSCD     IFGT 0                                                             CSD027
     C           CUSCD     IFGT *BLANKS                                                       CSD027
     C*
     C**********           Z-ADDCUSCD     CBCD                                                CSD027
     C                     MOVE CUSCD     CBCD                                                CSD027
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set is reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGTCF
     C*
     C                     END
     C*
      **     IF Broker is non-zero
      **          Write POCHGTC Record for Broker
     C*
     C********** BOCOD     IFGT 0                                                             CSD027
     C           BOCOD     IFGT *BLANKS                                                       CSD027
     C*
     C**********           Z-ADDBOCOD     CBCD                                                CSD027
     C                     MOVE BOCOD     CBCD                                                CSD027
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set is reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGTCF
     C*
     C                     END
     C*
      **     IF Book is non-zero
      **          Write POCHGTK Record for Book
     C*
     C           BOKCD     IFNE *BLANK
     C                     MOVE BOKCD     BOKC
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set is reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGTKF
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R GENAKD - TO WRITE REALIZED P/L ACCOUNT KEYS (PER CLOST1 RECORD)
      ** CALLED FROM
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           GENAKD    BEGSR
     C*
     C***********          Z-ADDBRCDD     BRCD                            S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     MOVE 'D'       RECI
     C                     Z-ADD0         TNBR
     C                     Z-ADDRUND      EDAT
     C                     Z-ADDLCDO      VDAT
     C                     MOVE ISCY      CCY
     C                     MOVE ISTT      ISTTI
     C*
      ** The instrument type is defined on the account key
      ** but for market instruments only
     C*
     C           BXISTY    IFEQ 'Y'                                       S01455
     C           MARKET    IFNE *BLANK
     C                     MOVE ISTT      MKINST
     C                     MOVELMRKT      MKINST                          S01455
     C                     ELSE                                           S01455
     C                     MOVE '     '   MKINST                          S01455
     C                     END
     C                     ELSE                                           S01455
     C                     MOVE '     '   MKINST                          S01455
     C                     END                                            S01455
     C*                                                                   S01455
     C*                                                                   S01455
      ** The processing type is only valid if indicator is 'Y'            S01455
      ** on I.C.D. "SDFODAPD"                                             S01455
     C*                                                                   S01455
     C           BXPROT    IFEQ 'Y'                                       S01455
     C                     MOVE ISPT      INVA                            S01455
     C                     ELSE                                           S01455
     C                     MOVE *BLANKS   INVA                            S01455
     C                     END                                            S01455
     C*
     C                     MOVE 'R'       ETYP
     C                     MOVE BOKCD     BOOK
     C                     MOVE BOKCD     BOKC
     C                     MOVE *BLANK    LORS
     C/COPY WNCPYSRC,FF0410C004
     C*
      **     IF amortisation needed, set position on account
      **     key to 'Y'
     C*
     C           *IN30     IFEQ '1'
     C                     MOVE 'Y'       AMOR
     C                     ELSE
     C                     MOVE *BLANK    AMOR
     C                     END
     C*
      **     IF Customer is non-zero
      **          Write FOKEYD Record for Customer
     C*
     C********** CUSCD     IFGT 0                                                             CSD027
     C           CUSCD     IFGT *BLANKS                                                       CSD027
     C*
     C********** BOCOD     IFEQ 0                                                             CSD027
     C           BOCOD     IFEQ *BLANKS                                                       CSD027
     C           BOKCD     ANDEQ*BLANK
     C                     MOVE 'C'       CORB
     C                     ELSE
     C                     MOVE *BLANK    CORB
     C                     END
     C*
     C**********           Z-ADDCUSCD     CBCD                                                CSD027
     C                     MOVE CUSCD     CBCD                                                CSD027
     C                     MOVE WWPTFR    PTFR                            S71062
     C*
      ** Customer settlement details
     C*
     C           CSETPD    IFNE 0
     C                     Z-ADDCSETPD    SETP
     C                     ELSE
     C                     Z-ADDCSETPF    SETP
     C                     END
     C*
     C           CSETAD    IFNE *BLANK
     C                     MOVE CSETAD    SETA
     C                     ELSE
     C                     MOVE CSETAF    SETA
     C                     END
     C*                                                                   S01117
     C           CSEBRD    IFNE *BLANK                                    S01117
     C                     MOVE CSEBRD    SEBR                            S01117
     C                     ELSE                                           S01117
     C                     MOVE CSEBRF    SEBR                            S01117
     C                     END                                            S01117
     C*
      ** Profit or Loss
     C*
     C           COPL      IFGT 0
     C                     MOVE 'P'       AMTC
     C                     ELSE
     C                     MOVE 'L'       AMTC
     C                     END
     C*
     C           COPL      IFLT 0
     C                     Z-SUBCOPL      EAMT
     C                     ELSE
     C                     Z-ADDCOPL      EAMT
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*                                                                   S01117
      ** SET CUSTOMER-PROFIT-CENTRE                                       S01117
     C*                                                                   S01117
     C                     MOVE CUSTPC    PRFC                            S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           CSETAD    IFNE *BLANKS                                                       CGL020
     C                     MOVE CFACOD    SEFA                                                CGL020
     C                     MOVE CCNOSD    SECP                                                CGL020
     C                     ELSE                                                               CGL020
     C                     MOVE CFACOF    SEFA                                                CGL020
     C                     MOVE CCNOSF    SECP                                                CGL020
     C                     ENDIF                                                              CGL020
     C                     EXSR SRAMPR                                                        CGL020
     C                     ENDIF                                                              CGL020
     C*
     C                     WRITEFOKEYDF
     C*
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
     C                     END
     C*
      **     IF Broker is non-zero
      **          Write FOKEYD Record for Broker
     C*
     C********** BOCOD     IFGT 0                                                             CSD027
     C           BOCOD     IFGT *BLANKS                                                       CSD027
     C*
     C**********           Z-ADDBOCOD     CBCD                                                CSD027
     C                     MOVE BOCOD     CBCD                                                CSD027
     C                     MOVE *BLANKS   PTFR                            S71062
     C*
     C********** CUSCD     IFEQ 0                                                             CSD027
     C           CUSCD     IFEQ *BLANKS                                                       CSD027
     C           BOKCD     ANDEQ*BLANK
     C*
     C                     MOVE 'B'       CORB
     C*
     C                     ELSE
     C*
     C                     MOVE *BLANK    CORB
     C*
     C                     END
     C*
      ** Profit or Loss
     C*
     C           COPL      IFGT 0
     C                     MOVE 'L'       AMTC
     C                     ELSE
     C                     MOVE 'P'       AMTC
     C                     END
     C*
      ** For a Broker/Book trade, profit/loss reversed
     C*
     C********** CUSCD     IFEQ 0                                                             CSD027
     C           CUSCD     IFEQ *BLANKS                                                       CSD027
     C           BOKCD     ANDNE*BLANK
     C*
     C           COPL      IFGT 0
     C                     MOVE 'P'       AMTC
     C                     ELSE
     C                     MOVE 'L'       AMTC
     C                     END
     C*
     C                     END
     C*
      ** Broker settlement details
     C*
     C           BSETPD    IFNE 0
     C                     Z-ADDBSETPD    SETP
     C                     ELSE
     C                     Z-ADDBSETPF    SETP
     C                     END
     C*
     C           BSETAD    IFNE *BLANK
     C                     MOVE BSETAD    SETA
     C                     ELSE
     C                     MOVE BSETAF    SETA
     C                     END
     C*                                                                   S01117
     C           BSEBRD    IFNE *BLANK                                    S01117
     C                     MOVE BSEBRD    SEBR                            S01117
     C                     ELSE                                           S01117
     C                     MOVE BSEBRF    SEBR                            S01117
     C                     END                                            S01117
     C*
     C           COPL      IFLT 0
     C                     Z-SUBCOPL      EAMT
     C                     ELSE
     C                     Z-ADDCOPL      EAMT
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*                                                                   S01117
      ** SET BROKER-PROFIT-CENTRE                                         S01117
     C*                                                                   S01117
     C                     MOVE BRKRPC    PRFC                            S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           BSETAD    IFNE *BLANKS                                                       CGL020
     C                     MOVE BFACOD    SEFA                                                CGL020
     C                     MOVE BCNOSD    SECP                                                CGL020
     C                     ELSE                                                               CGL020
     C                     MOVE BFACOF    SEFA                                                CGL020
     C                     MOVE BCNOSF    SECP                                                CGL020
     C                     ENDIF                                                              CGL020
     C                     EXSR SRAMPR                                                        CGL020
     C                     ENDIF                                                              CGL020
     C*
     C                     WRITEFOKEYDF
     C*
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
     C                     END
     C*
      **     IF Book trade
      **          Write FOKEYD Record for Book
     C*
     C********** BOCOD     IFEQ 0                                                             CSD027
     C********** CUSCD     ANDEQ0                                                             CSD027
     C           BOCOD     IFEQ *BLANKS                                                       CSD027
     C           CUSCD     ANDEQ*BLANKS                                                       CSD027
     C*
     C                     MOVE 'I'       CORB
     C*
     C**********           Z-ADD0         CBCD                                                CSD027
     C                     MOVE *BLANKS   CBCD                                                CSD027
     C                     MOVE *BLANKS   PTFR                            S71062
     C                     Z-ADD0         SETP
     C                     MOVE *BLANK    SETA
     C                     MOVE *BLANK    SEBR                            S01117
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE *BLANKS   F1RACT                                              CGL020
     C                     MOVE *BLANKS   F1RCTY                                              CGL020
     C                     MOVE *BLANKS   F1RBNK                                              CGL020
     C                     MOVE *BLANKS   F1RCDE                                              CGL020
     C                     MOVE *BLANKS   F1PACT                                              CGL020
     C                     MOVE *BLANKS   F1PCTY                                              CGL020
     C                     MOVE *BLANKS   F1PBNK                                              CGL020
     C                     MOVE *BLANKS   F1PCDE                                              CGL020
     C                     MOVE *BLANKS   F1DACT                                              CGL020
     C                     MOVE *BLANKS   F1DCTY                                              CGL020
     C                     MOVE *BLANKS   F1DBNK                                              CGL020
     C                     Z-ADD0         F1SDAT                                              CGL020
     C                     ENDIF                                                              CGL020
     C*
      ** Profit or Loss
     C*
     C           COPL      IFGT 0
     C                     MOVE 'P'       AMTC
     C                     ELSE
     C                     MOVE 'L'       AMTC
     C                     END
     C*
     C           COPL      IFLT 0
     C                     Z-SUBCOPL      EAMT
     C                     ELSE
     C                     Z-ADDCOPL      EAMT
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*                                                                   S01117
      ** SET BOOK-PROFIT-CENTRE                                           S01117
     C*                                                                   S01117
     C                     MOVE BOOKPC    PRFC                            S01117
     C*
     C                     WRITEFOKEYDF
     C*
     C                     ADD  1         COUNT
     C           EAMT      DIV  1000      ZZAMT
     C                     EXSR ZZADD
     C*
     C                     END
     C*
     C                     ENDSR
     C*
      ***********************************************************************                 CGL020
      /EJECT                                                                                  CGL020
      ***********************************************************************                 CGL020
      *                                                                     *                 CGL020
      *  SRAMPR - Determines AML Pay/Receive Instructions                   *                 CGL020
      *                                                                     *                 CGL020
      ***********************************************************************                 CGL020
      *                                                                                       CGL020
     C           SRAMPR    BEGSR                                                              CGL020
      *                                                                                       CGL020
     C                     CALL ZAAML                                                         CGL020
     C                     PARM           CBCD                                                CGL020
     C                     PARM           SETA                                                CGL020
     C                     PARM           SEBR                                                CGL020
     C                     PARM           SEFA                                                CGL020
     C                     PARM           SECP                                                CGL020
     C                     PARM           CCY                                                 CGL020
     C                     PARM           F1RACT                                              CGL020
     C                     PARM           F1RCTY                                              CGL020
     C                     PARM           F1RBNK                                              CGL020
     C                     PARM           F1RCDE                                              CGL020
     C                     PARM           F1PACT                                              CGL020
     C                     PARM           F1PCTY                                              CGL020
     C                     PARM           F1PBNK                                              CGL020
     C                     PARM           F1PCDE                                              CGL020
     C                     PARM           F1DACT                                              CGL020
     C                     PARM           F1DCTY                                              CGL020
     C                     PARM           F1DBNK                                              CGL020
      *                                                                                       CGL020
     C                     Z-ADDFCDA      F1SDAT                                              CGL020
      *                                                                                       CGL020
     C                     ENDSR                                                              CGL020
      *                                                                                       CGL020
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      /EJECT
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      **
      ** S/R POCC1R - TO WRITE POCHGCC/K RECORDS FOR REALIZED P/L (CLOST1)
      ** CALLED FROM
      ** CALLS: DBERR
      **
     C* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
     C*
     C           POCC1R    BEGSR
     C*
     C***********          Z-ADDBRCDD     BRCD                            S01117
     C                     MOVE BRCAD     BRCA                            S01117
     C                     MOVE 'D'       RECI
     C                     Z-ADD0         CLON
     C                     Z-ADDLCDO      POCD
     C*
      **     IF instrument is an option realized profit/loss
      **     is not to be printed on confirmations/statements
     C*
     C           ISPT      IFGE 4
     C           ISPT      ANDNE7                                         136054
     C                     MOVE 'Y'       AOSI
     C                     MOVE 'Y'       ATCI
     C                     ELSE
     C                     MOVE 'N'       AOSI
     C                     MOVE 'N'       ATCI
     C                     END
     C*
     C                     MOVE 'N'       PUPI
     C                     MOVE 'C'       PCGT
     C                     Z-SUB0         POCQ
     C*
      **     IF Customer is non-zero
      **          Write POCHGCC Record for Customer
     C*
     C********** CUSCD     IFGT 0                                                             CSD027
     C           CUSCD     IFGT *BLANKS                                                       CSD027
     C*
     C**********           Z-ADDCUSCD     CBCD                                                CSD027
     C                     MOVE CUSCD     CBCD                                                CSD027
     C*
     C           BOKCD     IFEQ *BLANK
     C                     Z-SUBCOPL      RLPL
     C                     ELSE
     C                     Z-ADDCOPL      RLPL
     C                     END
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGCCF
     C*
     C                     END
     C*
      **     IF Broker is non-zero
      **          Write POCHGCC Record for Broker
     C*
     C********** BOCOD     IFGT 0                                                             CSD027
     C           BOCOD     IFGT *BLANKS                                                       CSD027
     C*
     C**********           Z-ADDBOCOD     CBCD                                                CSD027
     C                     MOVE BOCOD     CBCD                                                CSD027
     C*
     C                     Z-ADDCOPL      RLPL
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
     C                     WRITEPOCHGCCF
     C*
     C                     END
     C*
      **     IF Book is non-zero
      **          Write POCHGCK Record for Book
     C*
     C           BOKCD     IFNE *BLANK
     C*
     C                     MOVE BOKCD     BOKC
     C*
     C                     Z-SUBCOPL      RLPL
     C*
     C                     Z-ADD0         REVI
     C*
      ** Close out set reversed
     C*
     C           CORI      IFEQ 'Y'
     C                     ADD  1         REVI
     C                     END
     C*
      **     IF amortisation needed, set position on account
      **     key to 'Y'
     C*
     C           *IN30     IFEQ '1'
     C                     MOVE 'Y'       HDGA
     C                     ELSE
     C                     MOVE *BLANK    HDGA
     C                     END
     C*
     C                     WRITEPOCHGCKF
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      **
      ** TOTAL S/R TO PERFORM LAST RECORD CALCULATIONS
      ** CALLED FROM MAIN PROCESSING
      ** CALLS NO OTHER SUBROUTINES
      **
     C********************************************************************
     C*
     C           TOTAL     BEGSR
     C*
     C           *IN20     IFEQ '0'
     C                     EXSR INIT
     C                     END
     C*
      ** WRITE AUDIT REPORT
     C*
     C                     WRITEAUDIT
     C                     MOVE '1'       *IN31                           S01117
     C*
     C           COUNT     IFGT 0
     C                     READ FOKEYAF                  99
     C*
      ** DB ERROR
     C*
     C           *IN99     IFEQ '1'
     C           RECI      ORNE 'T'                        ***************
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'19'      DBASE            **DB ERROR 19**S01117
     C                     Z-ADD19        DBASE            **DB ERROR 19**S01117
     C                     MOVEL'FOKEY'   DBFILE           ***************
     C                     MOVEL'TRAILER' DBKEY
     C                     OUT  LDA                                       S01117
     C                     EXSR DBERR
     C                     END
     C*
      ** ADD COUNT TO TRAILER NUMBER OF RECORDS
     C*
     C                     ADD  COUNT     NORE
     C*
      ** ADD HASH TOTAL TO FILE CONTROL TOTAL, ACCOMODATING OVERFLOW
     C*
     C                     ADD  ZZTOTI    HRWN
     C           HRDC      ADD  ZZTOTD    TEMP    30
     C*
     C           TEMP      IFLT HRDC
     C                     ADD  1         HRWN
     C                     END
     C*
     C                     Z-ADDTEMP      HRDC
     C*
     C                     UPDATFOKEYAF
     C*
     C                     END
     C*
     C***********          WRITEEND                                       S01117
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
      /COPY ZSRSRC,ZTNLU1Z2
     C********************************************************************
      /EJECT
     C********************************************************************
      /COPY ZSRSRC,ZZADDZ1
     C********************************************************************
      /EJECT
     C********************************************************************
      /COPY ZSRSRC,FFFMTZ3
     C********************************************************************
      /EJECT
     C********************************************************************
      /COPY ZSRSRC,ZDATE2Z2
     C********************************************************************
      /EJECT
     C********************************************************************
      /COPY ZSRSRC,ZDATE1Z2
     C********************************************************************
      /EJECT
     C********************************************************************
      *COPY*ZSRSRC,ZDATE3Z4                                               S01195
      /COPY ZSRSRC,ZFWDT                                                  S01195
     C********************************************************************
      /EJECT
     C********************************************************************S01195
      /COPY ZSRSRC,ZBKDT                                                  S01195
     C********************************************************************S01195
      /EJECT                                                              S01195
     C********************************************************************
      *COPY*ZSRSRC,ZDATE5Z2                                               S01195
      /COPY ZSRSRC,ZCHKH                                                  S01195
     C********************************************************************S01195
      /EJECT                                                              S01195
     C********************************************************************S01195
      /COPY ZSRSRC,ZACCH                                                  S01195
     C********************************************************************
      /EJECT
     C********************************************************************
      /COPY ZSRSRC,FFDATEZ3
      /COPY ZSRSRC,FFYTOPZ1                                               AUS022
     C********************************************************************
      /EJECT
     C********************************************************************
      **
      ** DBERR S/R TO TERMINATE PROGRAM WHEN ERROR OCCURS
      ** CALLED FROM
      ** CALLS NO OTHER SUBROUTINES
      **
     C********************************************************************
     C*
     C           DBERR     BEGSR
     C*
      **     Set U7&U8
      **     Return
     C*
     C           *IN31     IFEQ '0'                                       S01117
     C                     WRITEAUDIT                                     S01117
     C                     END                                            S01117
     C                     WRITEDBERROR
     C                     SETON                     U7U8LR
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C                     RETRN
     C*
     C                     ENDSR
     C*
     C********************************************************************
     OCLOSTDF D        20
     O                         ECPID
     O                         LCD
     O                         CHTP
     O                         TNLU
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   MSG
OVER THE COUNTER
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   TABDY/TABNO - SHORTNAMES & DAY NUMBERS
F0S1X2M3U4W5T6
