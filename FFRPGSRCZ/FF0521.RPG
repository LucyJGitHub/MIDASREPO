     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FF Initial margin account keys')
     F*****************************************************************
     F*                                                               *
     F*  Midas - FUTURES AND OPTIONS MODULE                           *
     F*                                                               *
     F*  FF0521- INITIAL MARGIN ACCOUNT KEYS                          *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. MD034233           Date 27Apr15               *
      *  Prev Amend No. CFF015             Date 11Mar15               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 CRE026             Date 24May06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *             No. CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CGL029             Date 01Sep03               *
      *                 CGL020             Date 12Dec02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CAS002             Date 14Jan02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 184289             Date 27Mar01               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.01 Patch E ---------------------------------------*
      *                 170520             Date 19Nov99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CPL002             Date 08Mar99               *
      *                 CSD005             Date 01MAR99               *
      *                 157661             Date 22Mar99               *
      *                 CTI002             Date 22Mar99               *
      *                 CAP003             Date 18Aug98               *
      *                 119065             Date 09Jun97               *
      *                 CAC003             Date 25Feb97               *
     F*                 CFF004             Date 12Sep96               *
     F*                 CPM003             Date 13Dec95               *
     F*                 S71062             DATE 31JAN94               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD034233 - Updates on CFF015 design                          *
      *  CFF015 - Differentiate accounting keys as Put or Call option.*
      *  CRE026 - Consumer Banking (Recompile)                        *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CGL020 - Midas Compliance Watch - Additional A/c Postings    *
      *           Information                                         *
      *  CAS002 - Hedge Strategy/Linkage (Recompile)                  *
      *  184289 - Renamed LCD and CHTP of TRANSD file.                *
      *  170520 - Recompile over changed TRANSD file                  *
      *  CPL002 - Midas-Plato Interface (Recomipled)                  *
      *  CSD005 - Standing Data Account Narrative.  Add new field     *
      *           to SDACODPD.  Recompilation of programs.            *
      *  157661 - CPM003 does not set up IN89 and ATYP correctly.     *
      *  CTI002 - Recompiled : File SDACODPD changed                  *
      *  CAP003 - Conversion of Midas inputs to modular API structure *
      *           (phase 2) - recompiled                              *
     F*  119065 - Account not found in REIAC for settlement type 14.  *
     F*  CAC003 - Profit Centre Accounting Development Phase 3.       *
     F*  CFF004 - Increase in size of Price Fields,(Recompiled Only)  *
     F*  CPM003 - FF PM Interface Upgrade to R10.                     *
     F*  S71062 - FF/PM INITIAL MARGIN                                *
     F*                                                               *
     F*****************************************************************
      **DEALING*DATA***************************************************   CPM003
     F***SDDEALL1IF**E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      ****GENERAL*LEDGER*DETAILS***************************************   CPM003
     F***SDGELRL1IF**E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      ****TRADING*DATA*************************************************   CPM003
     F***SDTRADL1IF**E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      **FF*DATA********************************************************   CPM003
     F***SDFODAL1IF**E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      *****BANK*DETAILS************************************************   CPM003
     F***SDBANKL1IF**E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      ****ACCOUNT*CODES************************************************   CPM003
     F***SDACODL0IF  E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      *****NOSTRO*CODES************************************************   CPM003
     F***SDNOSTL0IF  E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      * INSTRUMENT TYPES
     FINTYP   IF  E           K        DISK
     F                                              KINFSR *PSSR
      * RETAIL INTEREST SUB TYPES
     FREINT   IF  E           K        DISK
     F            REINTAF                           KIGNORE
     F            REINTZF                           KIGNORE
     F                                              KINFSR *PSSR
      * RETAIL INTEREST & CHARGES
     FREIAC   IF  E           K        DISK
     F            REIACAF                           KIGNORE
     F            REIACZF                           KIGNORE
     F                                              KINFSR *PSSR
      * ACCOUNT MASTER
     FACCNT   IF  E           K        DISK
     F                                              KINFSR *PSSR
      * RE ACCOUNT
     FACNUM   IF  E           K        DISK
     F            ACCNTABF                          KRENAMEACCNTABR
     F                                              KINFSR *PSSR
      **BRANCH*DETAILS****************************************************CPM003
     F***SDBRCHL0IF**E           K        DISK                            CPM003
     F***********                                      KINFSR *PSSR       CPM003
      * MARKET CONTROL DETAILS
     FMKCTL   IF  E           K        DISK
     F                                              KINFSR *PSSR
      * MARKET CENTRES
     FMARKT   IF  E           K        DISK
     F                                              KINFSR *PSSR
      * TRANSACTION SETTLEMENT DETAILS
     FTRSET   IF  E           K        DISK
     F                                              KINFSR *PSSR
      * TRANSACTION DETAILS
     FTRANS   UF  E           K        DISK
     F                                              KINFSR *PSSR
      * FF COLL.
     FWCOLTDM UF  E           K        DISK
     F                                              KINFSR *PSSR
      * TRAILER FOKEYD
     FFOKEYA  UF  E                    DISK
     F                                              KINFSR *PSSR
      * ACCOUNT KEY
     FFOKEYD  O   E           K        DISK
     F                                              KINFSR *PSSR
      * AUDIT REPORT
     FFF0521AUO   E                    PRINTER
     F/EJECT
      *****************************************************************
     E                    CPY@    1   1 80
     E** ARRAY FOR UNDERLINING
     E                    FULA       34  1
     E                    BAL        11 15 0
     E                    MSG     1   1 20
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,FFFMTZ1
      *****************************************************************
     I/EJECT
      *
      ** RENAME FIELD FOR TRANS
     ITRANSDF
     I              TNBR                            TNBR9
     I**************BRCD                            BRCD9                 CPM003
     I              BRCA                            BRCA9                 CPM003
     I              BOKC                            BOKC9
     I              ISTT                            ISTT9
     I              YRNO                            YRNO9
     I              MTHN                            MTHN9
     I              PCAL                            PCAL9
     I              STRP                            STRP9
     I              PTFR                            PTFR9
     I              LCD                             LCD9                  184289
     I              CHTP                            CHTP9                 184289
      *
      ** RENAME FIELD FOR INTYP
     IINTYPDF
     I              ISTN                            ISTNY
      *
     IWCOLTDF
     I**************BRCD                            BRCDX                 CPM003
     I              BRCA                            BRCAX                 CPM003
      *
     IACCNTABF
     I**************BRCD                            BRCDX                 CPM003
     I              BRCA                            BRCAX                 CPM003
     I              PRFC                            PRFCX                 CAC003
     I*                                                                   CPM003
     IACCNTABR                                                            CPM003
     I*                                                                   CPM003
     I** Rename of fields on ACNUM                                        CPM003
     I*                                                                   CPM003
     I************* BRCD                            BRCDY                 CPM003
     I              BRCA                            BRCAY                 CPM003
      *
      /COPY ZSRSRC,FFFMTZ2
      *
      ** DATA STRUCTURE FOR DATABASE ERROR
     ILDA         DS                            256
     I************                          132 183 DBLOT                 CPM003
     I************                          132 141 DBFILE                CPM003
     I                                      134 183 DBLOT                 CPM003
     I                                      134 141 DBFILE                CPM003
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
      *
      ** DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *
      ** DATA STRUCTURE FOR LOADING F O ACCOUNT KEY
     IFFKY        DS                             14
     I                                        1   1 FFKY1
     I                                        2   2 FFKY2
     I                                        3   3 FFKY3
     I                                        4   4 FFKY4
     I                                        5   5 FFKY5
     I                                        6   6 FFKY6
     I                                        7   7 FFKY7
     I                                        8   8 FFKY8
     I                                        9   9 FFKY9
     I                                       10  10 FFKY10
     I                                       11  11 FFKY11
     I                                       12  12 FFKY12
     I                                       13  13 FFKY13
     I                                       14  14 FFKY14
      *
      ** SETTLEMENT ACCOUNT (FFSETA) REDEFINED:
      ** CUSTOMER/ACCOUNT CODE/ACCOUNT SEQ,  + RETAIL A/C NO.
     I**********  DS                             12                                           CGL029
     I**********                              1  12 FFSETA                                    CGL029
     I            DS                             18                                           CGL029
     I**********                              1   60FFSCNM                                    CSD027
     I                                        1   6 FFSCNM                                    CSD027
     I**********                              7  100FFSACD                                    CGL029
     I**********                             11  120FFSASQ                                    CGL029
     I                                        7  160FFSACD                                    CGL029
     I                                       17  180FFSASQ                                    CGL029
     I                                        1  100FFACMK
      *
      ** FOR ACCESSING REINT
     IREINTK      DS                             12
     I                                        2   30CICT
     I                                        4   80CCST
     I                                        9  11 CCY
     I                                       12  12 CEND
      *
      ** BALANCE RETAIL
     IBAL2        DS
     I                                    P   1  880BAL
      *
      ** DATA STRUCTURE FOR SETTLEMENT A/C ID
     I***ATID***     DS                             15                                        CGL029
     IATID        DS                             21                                           CGL029
     I**********                              1   60ATIDCN                                    CSD027
     I                                        1   6 ATIDCN                                    CSD027
     I                                        7   9 ATIDCY
     I**********                             10  130ATIDAC                                    CGL029
     I**********                             14  150ATIDAQ                                    CGL029
     I                                       10  190ATIDAC                                    CGL029
     I                                       20  210ATIDAQ                                    CGL029
     ISDMMOD    E DSSDMMODPD                                              CAC003
     I** External data structure for module details                       CAC003
     ISDBANK    E DSSDBANKPD                                              CPM003
     I** External data structure for bank details                         CPM003
     ISDNOST    E DSSDNOSTPD                                              CPM003
     I** External data structure for nostro details                       CPM003
     ISDBRCH    E DSSDBRCHPD                                              CPM003
     I** External data structure for branches details                     CPM003
     ISDFODA    E DSSDFODAPD                                              CPM003
     I              QQACCD                          QQACD1                                    CGL029
     I** External data structure for FF ICD                               CPM003
     ISDACOD    E DSSDACODPD                                              CPM003
     I              QQACCD                          QQACD2                                    CGL029
     I** External data structure for A/c details                          CPM003
     ISDTRAD    E DSSDTRADPD                                              CPM003
     I              QQACCD                          QQACD3                                    CGL029
     I** External data structure for trade details                        CPM003
     ISDGELR    E DSSDGELRPD                                              CPM003
     I              QQACCD                          QQACD4                                    CGL029
     I** External data structure for GL ICD                               CPM003
     ISDDEAL    E DSSDDEALPD                                              CPM003
     I              QQACCD                          QQACD5                                    CGL029
     I** External data structure for dealing ICD                          CPM003
     ISCSARD    E DSSCSARDPD                                                                  CGL020
      ** External data structure for SAR details                                              CGL020
     I@DSFDY    E DSDSFDY                                                 CPM003
     I*                                                                   CPM003
     IDSSDY     E DSDSSDY                                                                     CGL029
     I*                                                                                       CGL029
     I            DS                                                                          CGL020
     I**********                              1   60PCBCD                              CGL020 CSD027
     I                                        1   6 PCBCD                                     CSD027
      ** Customer Broker Code Parameter for ZAAMLSETFF                                        CGL020
      *                                                                                       CGL020
     I              'ZAAMLSETFF'          C         WZAAML                                    CGL020
      *                                                                                       CGL020
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * INDEX OF SUBROUTINES                                             *
      * MAIN     - SR MAIN PROCESSING                                    *
      * SRINIT   - SR INIT PROCESSING                                    *
      * SRMAIN   - SR MAIN PROCESSING                                    *
      * SRTRDM   - SR RETRIEVE MARGIN                                    *
      * SRCUST   - SR PROCESSING FOR CUSTOMER                            *
      * SRBROK   - SR PROCESSING FOR BROKER                              *
      * SRMACU   - SR ADJUST MARGIN FOR CUSTOMER                         *
      * SRMABK   - SR ADJUST MARGIN FOR BROKER                           *
      * SRACKY   - SR GENERATE ACCOUNT KEY                               *
      * SRWACK   - SR WRITE ACCOUNT KEY                                  *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      * SRENDD   - SR END PGM                                            *
      * SRSDET   - SR DETERMINE SETTLEMENT ID                            *
      * SRTRAI   - SR UPDATE TRAILER                                     *
      * FFSETL   - SR DETERMINE SETTLEMENT DETAIL                        *
      * ZZADD    - SR ADD AMOUNTS INTO HASH FIELDS                       *
      * SRMARG   - SR CHECK IF MARGIN PRESENT FOR CUSTOMER               *
      *                                                                  *
      * EXTERNAL ROUTINES CALLED                                         *
      *                                                                  *
      ********************************************************************
     C/EJECT
     C                     EXSR SRINIT
      *
     C                     EXSR SRMAIN
      *
     C                     EXSR SRENDD
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRINIT   - SR INIT PROCESSING                                    *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - SR MAIN PROCESSING                                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWNOSN   - WORK FIELD TO ACCESS ON SDNOSTPD                      *
      * WWCOLL   - WORK FIELD TO ACCESS IN WCOLTDM                       *
      * WWPGM    - WORK FIELD DATABASE ERROR                             *
      * WWKEY    - WORK FIELD DATABASE ERROR                             *
      * WWFILE   - WORK FIELD DATABASE ERROR                             *
      * WWBASE   - WORK FIELD DATABASE ERROR                             *
      *                                                                  *
      ********************************************************************
     C           SRINIT    BEGSR
      *
      ** RECEIVE MARKET END OF CENTRE CODE PARAMETER
     C           *ENTRY    PLIST
     C                     PARM           PMRKT   2
      *
      ** KEY LIST FOR NOSTRO
     C           FFNKY     KLIST
     C                     KFLD           FFNCCY
     C                     KFLD           WWNOSN
      *
      ** KEY LIST FOR RETAIL
     C           REIACK    KLIST
     C                     KFLD           ATIDCN
     C                     KFLD           ATIDCY
     C                     KFLD           ATIDAC
     C                     KFLD           ATIDAQ
     C                     KFLD           SBID                            CPM003
      *
      ** KEY LIST FOR LF/ACCNT (ACCOUNTS)
     C           FFACTK    KLIST
     C                     KFLD           FFCNUM
     C                     KFLD           FFCCY
     C                     KFLD           FFACOD
     C                     KFLD           FFACSQ
     C                     KFLD           FFBRCB                          CPM003
      *
      ** KEY TO ACCESS WCOLTDM FILE
     C           TBCKEY    KLIST
     C***********          KFLD           BRCD9                           CPM003
     C                     KFLD           BRCA9                           CPM003
     C                     KFLD           CBCD
     C                     KFLD           ISCY
     C                     KFLD           TBCID                           CPM003
     C*
     C           CLCKEY    KLIST
     C***********          KFLD           ZERO3                           CPM003
     C                     KFLD           BRCA9                           CPM003
     C                     KFLD           CBCD
     C                     KFLD           ISCY
     C                     KFLD           TBCID                           CPM003
      *
     C***********          Z-ADD*ZERO     ZERO3   30                      CPM003
     C                     MOVE *BLANKS   BLANK3  3                       CPM003
      *
      ** DEFINE LDA FOR DATABASE ERROR
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA                                       CPM003
     C                     MOVEL*BLANKS   DBLOT                           CPM003
     C                     MOVEL'FF0521'  DBPGM                           CPM003
     C                     OUT  LDA                                       CPM003
     C                     MOVEACPY@      ACT    80                       CPM003
      *
      ** SETUP FIELD FOR DATABASE ERROR
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVEL'FF0521'  WWPGM                           CPM003
     C***********          MOVEL*BLANKS   WWKEY                           CPM003
     C***********          MOVEL*BLANKS   WWFILE                          CPM003
     C***********          Z-ADD*ZEROS    WWBASE                          CPM003
     C                     MOVEL'FF0521'  DBPGM                           CPM003
     C                     MOVEL*BLANKS   DBKEY                           CPM003
     C                     MOVEL*BLANKS   DBFILE                          CPM003
     C                     Z-ADD*ZEROS    DBASE                           CPM003
     C                     OUT  LDA                                       CPM003
      *
      ** ACCESS TO BANK DETAILS
     C************LOVAL    SETLLSDBANKL1                                  CPM003
     C************         READ SDBANKL1                 01               CPM003
     C                     CALL 'AOBANKR0'                                CPM003
     C                     PARM *BLANKS   @RTCD   7                       CPM003
     C                     PARM '*FIRST  '@OPTN   7                       CPM003
     C           SDBANK    PARM SDBANK    @DSFDY                          CPM003
      *
      ** IF RECORD NOT FOUND
     C************IN01     IFEQ '1'                        *B1            CPM003
     C           @RTCD     IFNE *BLANKS                    *B1            CPM003
     C***********          MOVEL*BLANKS   WWKEY            ***************CPM003
     C***********          Z-ADD1         WWBASE           ***************CPM003
     C************         MOVEL'SDBANKL1'WWFILE           ***************CPM003
     C           *LOCK     IN   LDA                                       CPM003
     C                     MOVEL*BLANKS   DBKEY            ***************CPM003
     C                     Z-ADD1         DBASE            **DB ERROR 01**CPM003
     C                     MOVE 'SDBANKPD'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
      ** ACCESS TO DEALING DATA
     C************LOVAL    SETLLSDDEALL1                                  CPM003
     C***********          READ SDDEALL1                 01               CPM003
     C**********           CALL 'AODEALR0'                                CPM003              CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       CPM003
     C                     PARM '*FIRST  '@OPTN   7                       CPM003
     C********** SDDEAL    PARM SDDEAL    @DSFDY                          CPM003              CGL029
     C           SDDEAL    PARM SDDEAL    DSSDY                                               CGL029
      *
      ** IF RECORD NOT FOUND
     C************IN01     IFEQ '1'                        *B1            CPM003
     C           @RTCD     IFNE *BLANKS                    *B1            CPM003
     C***********          MOVEL*BLANKS   WWKEY            ***************CPM003
     C***********          Z-ADD2         WWBASE           ***************CPM003
     C***********          MOVEL'SDDEALL1'WWFILE           ***************CPM003
     C           *LOCK     IN   LDA                                       CPM003
     C                     MOVEL*BLANKS   DBKEY            ***************CPM003
     C                     Z-ADD2         DBASE            **DB ERROR 01**CPM003
     C                     MOVE 'SDDEALPD'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
      ** ACCESS TO GENERAL LEDGER DETAILS
     C************LOVAL    SETLLSDGELRL1                                  CPM003
     C***********          READ SDGELRL1                 01               CPM003
     C**********           CALL 'AOGELRR0'                                CPM003              CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       CPM003
     C                     PARM '*FIRST  '@OPTN   7                       CPM003
     C********** SDGELR    PARM SDGELR    @DSFDY                          CPM003              CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *
      ** IF RECORD NOT FOUND
     C************IN01     IFEQ '1'                        *B1            CPM003
     C           @RTCD     IFNE *BLANKS                    *B1            CPM003
     C***********          MOVEL*BLANKS   WWKEY            ***************CPM003
     C***********          Z-ADD3         WWBASE           ***************CPM003
     C***********          MOVEL'SDGELRL1'WWFILE           ***************CPM003
     C           *LOCK     IN   LDA                                       CPM003
     C                     MOVEL*BLANKS   DBKEY            ***************CPM003
     C                     Z-ADD3         DBASE            **DB ERROR 03**CPM003
     C                     MOVE 'SDGELRPD'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
      ** ACCESS TO TRADE DETAILS
     C************LOVAL    SETLLSDTRADL1                                  CPM003
     C***********          READ SDTRADL1                 01               CPM003
     C                     CALL 'AOTRADR0'                                CPM003
     C                     PARM *BLANKS   @RTCD   7                       CPM003
     C                     PARM '*FIRST  '@OPTN   7                       CPM003
     C           SDTRAD    PARM SDTRAD    @DSFDY                          CPM003
      *
      ** IF RECORD NOT FOUND
     C************IN01     IFEQ '1'                        *B1            CPM003
     C           @RTCD     IFNE *BLANKS                    *B1            CPM003
     C***********          MOVEL*BLANKS   WWKEY            ***************CPM003
     C***********          Z-ADD4         WWBASE           ***************CPM003
     C***********          MOVEL'SDTRADL1'WWFILE           ***************CPM003
     C           *LOCK     IN   LDA                                       CPM003
     C                     MOVEL*BLANKS   DBKEY            ***************CPM003
     C                     Z-ADD4         DBASE            **DB ERROR 04**CPM003
     C                     MOVE 'SDTRADPD'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
      ** ACCESS TO FF DETAILS
     C************LOVAL    SETLLSDFODAL1                                  CPM003
     C***********          READ SDFODAL1                 01               CPM003
     C                     CALL 'AOFODAR0'                                CPM003
     C                     PARM *BLANKS   @RTCD   7                       CPM003
     C                     PARM '*FIRST  '@OPTN   7                       CPM003
     C           SDFODA    PARM SDFODA    @DSFDY                          CPM003
      *
      ** IF RECORD NOT FOUND
     C************IN01     IFEQ '1'                        *B1            CPM003
     C           @RTCD     IFNE *BLANKS                    *B1            CPM003
     C***********          MOVEL*BLANKS   WWKEY            ***************CPM003
     C***********          Z-ADD5         WWBASE           ***************CPM003
     C***********          MOVEL'SDFODAL1'WWFILE           ***************CPM003
     C           *LOCK     IN   LDA                                       CPM003
     C                     MOVEL*BLANKS   DBKEY            ***************CPM003
     C                     Z-ADD5         DBASE            **DB ERROR 05**CPM003
     C                     MOVE 'SDFODAPD'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
     C*                                                                   CAC003
     C** Access the Module Details File using AOMMODR0                    CAC003
     C                     CALL 'AOMMODR0'                                CAC003
     C                     PARM *BLANKS   @RTCD   7                       CAC003
     C                     PARM '*FIRST  '@OPTN   7                       CAC003
     C           SDMMOD    PARM SDMMOD    @DSFDY                          CAC003
      *                                                                   CAC003
     C           @RTCD     IFNE *BLANKS                                   CAC003
     C           *LOCK     IN   LDA                                       CAC003
     C                     MOVEL*BLANKS   DBKEY            ***************CAC003
     C                     Z-ADD14        DBASE            **DB ERROR 14**CAC003
     C                     MOVE 'SDMMODPD'DBFILE           ***************CAC003
     C                     OUT  LDA                                       CAC003
     C                     EXSR *PSSR                                     CAC003
     C                     END                                            CAC003
     C*                                                                   CAC003
     C** Check if SAR CAC003 is installed using AOSARDR0                  CAC003
     C                     CALL 'AOSARDR0'                                CAC003
     C                     PARM '       ' @RTCD   7                       CAC003
     C                     PARM '*VERIFY' @OPTN   7                       CAC003
     C                     PARM 'CAC003 ' @SARD   6                       CAC003
     C*                                                                   CAC003
     C** Set on *IN30 if Analytical Accounting Module and                 CAC003
     C** SAR CAC003 is installed                                          CAC003
     C           @RTCD     IFEQ *BLANKS                                   CAC003
     C           BGN0ST    ANDEQ'Y'                                       CAC003
     C                     MOVE '1'       *IN30                           CAC003
     C                     ENDIF                                          CAC003
      *                                                                                       CGL020
      ** Check if Switchable Feature CGL020 is switched on.                                   CGL020
      *                                                                                       CGL020
     C                     CALL 'AOSARDR0'                                                    CGL020
     C                     PARM *BLANKS   @RTCD                                               CGL020
     C                     PARM '*VERIFY' @OPTN                                               CGL020
     C                     PARM 'CGL020'  @SARD                                               CGL020
     C           SCSARD    PARM SCSARD    @DSFDY                                              CGL020
      *                                                                                       CGL020
      ** Database error                                                                       CGL020
      *                                                                                       CGL020
     C           @RTCD     IFNE *BLANKS                                                       CGL020
     C           @RTCD     ANDNE'*NRF   '                                                     CGL020
     C           *LOCK     IN   LDA                                                           CGL020
     C                     Z-ADD15        DBASE                                               CGL020
     C                     MOVEL'CGL020  'DBKEY                                               CGL020
     C                     MOVEL'SCSARDPD'DBFILE                                              CGL020
     C                     OUT  LDA                                                           CGL020
     C                     EXSR *PSSR                                                         CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C           @RTCD     IFEQ *BLANKS                                                       CGL020
     C                     MOVE 'Y'       CGL020  1                                           CGL020
     C                     ELSE                                                               CGL020
     C                     MOVE 'N'       CGL020                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CFF015
      ** Access SAR Details to see if CFF015 (Differentiate account keys by Put and Call)     CFF015
      ** is switched on                                                                       CFF015
      *                                                                                       CFF015
     C                     MOVEL'N'       CFF015  1                                           CFF015
     C                     CALL 'AOSARDR0'                                                    CFF015
     C                     PARM *BLANKS   @RTCD                                               CFF015
     C                     PARM '*VERIFY '@OPTN                                               CFF015
     C                     PARM 'CFF015'  @SARD                                               CFF015
     C           SCSARD    PARM SCSARD    DSSDY                                               CFF015
      *                                                                                       CFF015
     C           @RTCD     IFEQ *BLANKS                                                       CFF015
     C                     MOVEL'Y'       CFF015                                              CFF015
     C                     ENDIF                                                              CFF015
     C*                                                                                       CFF015
      *
     C           PMRKT     IFNE *BLANK                     *B1
     C*
     C           PMRKT     CHAINMKCTL                01
      *
      ** IF RECORD NOT FOUND
     C           *IN01     IFEQ '1'                        *B2
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVELPMRKT     WWKEY            ***************CPM003
     C***********          Z-ADD6         WWBASE           ***************CPM003
     C***********          MOVEL'MKCTL   'WWFILE           ***************CPM003
     C                     MOVELPMRKT     DBKEY            ***************CPM003
     C                     Z-ADD6         DBASE            **DB ERROR 06**CPM003
     C                     MOVE 'MKCTL   'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E2
      *
     C           PMRKT     CHAINMARKT                01
      *
      ** IF RECORD NOT FOUND
     C           *IN01     IFEQ '1'                        *B2
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVELPMRKT     WWKEY            ***************CPM003
     C***********          Z-ADD7         WWBASE           **DB ERROR 07**CPM003
     C***********          MOVEL'MARKT   'WWFILE           ***************CPM003
     C                     MOVELPMRKT     DBKEY            ***************CPM003
     C                     Z-ADD7         DBASE            **DB ERROR 07**CPM003
     C                     MOVE 'MARKT   'DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E2
     C                     END                             *E1
     C*
      ** SET INDICATOR FOR DATE FORMAT
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     END
      *
      **  FORMAT RUN/BUSINESS DATE FOR REPORT TITLE
     C           PMRKT     IFNE *BLANK
     C                     Z-ADDBUSD      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    FFDAT
     C                     MOVE MKTN      FFNAM
     C                     ELSE
     C                     MOVE BJMRDT    FFDAT
     C                     MOVE MSG,1     FFNAM
     C                     END
     C*
     C                     EXSR FFFMT
     C                     MOVE FFTXT     MNAMED
     C*
     C**  SET UP UNDERLINING FOR HEADING
     C**  INITIALISE ARRAY INDEX
     C                     Z-ADD0         X       20
     C*
     C**  FFULIN RETURNED FROM SR. FFFMT CONTAINS NUMBER OF CHARACTERS
     C**  FOR UNDERLINE
     C           X         DOUEQFFULIN
     C                     ADD  1         X
     C                     MOVEA'-'       FULA,X
     C                     END
     C*
     C**  MOVE UNDERLINE ARRAY TO OUTPUT FIELD
     C                     MOVEAFULA      FULINE
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRMAIN   - SR MAIN PROCESSING                                    *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SRTRDM   - SR RETRIEVE MARGIN                                    *
      * SRCUST   - SR PROCESSING FOR CUSTOMER                            *
      * SRBROK   - SR PROCESSING FOR BROKER                              *
      * SRTRAI   - SR UPDATE TRAILER                                     *
      * SRENDD   - SR END PGM                                            *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - SR MAIN PROCESSING                                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           SRMAIN    BEGSR
      *
      ** READ FIRST RECORD IN FILE
     C                     READ TRANS                    02
      *
      ** NOT END OF FILE TRANS
     C           *IN02     DOWEQ'0'                        *BW1
      *
     C                     MOVE '0'       *IN20
     C                     MOVE '0'       *IN21
      *
      ** IF RECI EQUAL 'D' EXECUTE PROCESSING ELSE READ NEXT RECORD IN TRANS
     C           RECI      IFEQ 'D'                        *B1
      *
     C                     EXSR SRTRDM
      *
      ** IF INITIAL MARGIN OR INITIAL MARGIN ALREADY POSTED NOT EQUAL TO ZEROS
      ** (FOR THE CUSTOMER OR FOR THE BROKER), CONTINUE PROCESSING
     C           CMAR      IFNE *ZEROS                     *B2
     C***********AAMABK    ORNE *ZEROS                                    CPM003
     C           MABK      ORNE *ZEROS                                    CPM003
     C           BMAR      ORNE *ZEROS
     C***********AAMACU    ORNE *ZEROS                                    CPM003
     C           MACU      ORNE *ZEROS                                    CPM003
      *
     C                     Z-ADD*ZEROS    WWAMNT 130
     C                     Z-ADD*ZEROS    WMACU  130
     C                     Z-ADD*ZEROS    WMABK  130
      *
     C                     EXSR SRCUST
      *
     C                     EXSR SRBROK
      *
     C           *IN20     IFEQ '1'                        *B3
     C           *IN21     OREQ '1'
      *
     C           *IN20     IFEQ '1'                        *B4
     C***********          Z-ADDWMACU     AAMACU                          CPM003
     C                     Z-ADDWMACU     MACU                            CPM003
     C                     END                             *E4
      *
     C           *IN21     IFEQ '1'                        *B4
     C***********          Z-ADDWMABK     AAMABK                          CPM003
     C                     Z-ADDWMABK     MABK                            CPM003
     C                     END                             *E4
      *
     C                     UPDATTRANSDF
     C                     END                             *E3
      *
     C                     END                             *E2
      *
     C                     END                             *E1
      *
      ** READ NEXT RECORD IN TRANS
     C                     READ TRANS                    02
     C                     END                             *EW1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRTRDM   - SR RETRIEVE MARGIN                                    *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRMAIN   - SR MAIN PROCESSING                                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWKEY    - WORK FIELD DATABASE ERROR                             *
      * WWBASE   - WORK FIELD DATABASE ERROR                             *
      * WWFILE   - WORK FIELD DATABASE ERROR                             *
      * WWCMAR   - WORK FIELD CUSTOMER MARGIN                            *
      * WWBMAR   - WORK FIELD BROKER MARGIN                              *
      *                                                                  *
      ********************************************************************
     C           SRTRDM    BEGSR
      *
      ** ACCESS TO TRSET WITH TRADE NUMBER OF TRANS
     C           TNBR9     CHAINTRSET                04
      *
      ** RECORD NOT FOUND, DATABASE ERROR
     C           *IN04     IFEQ '1'                        *B1
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVELTNBR9     WWKEY            ***************CPM003
     C***********          Z-ADD8         WWBASE           **DB ERROR 08**CPM003
     C***********          MOVEL'TRSET'   WWFILE           ***************CPM003
     C                     MOVELTNBR9     DBKEY            ***************CPM003
     C                     Z-ADD8         DBASE            **DB ERROR 08**CPM003
     C                     MOVE 'TRSET'   DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     ELSE                            *X1
      *
      ** SAVE CUSTOMER INITIAL MARGIN FOR ADJUST MARGIN IN SR SRMACU
     C                     Z-ADDCMAR      WWCMAR 130
      *
      ** SAVE BROKER INITIAL MARGIN FOR ADJUST MARGIN IN SR SRMABK
     C                     Z-ADDBMAR      WWBMAR 130
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRCUST   - SR PROCESSING FOR CUSTOMER                            *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SRMACU   - SR ADJUST MARGIN FOR CUSTOMER                         *
      * SRACKY   - SR GENERATE ACCOUNT KEY                               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRMAIN   - SR MAIN PROCESSING                                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWMABC   - WORK FIELD CUSTOMER/BROKER MARGIN                     *
      * WWSETP   - WORK FIELD SETTLEMENT TYPE                            *
      * WWCBNB   - WORK FIELD CUSTOMER/BROKER CODE                       *
      * WWBRKI   - WORK FIELD FOR BROKER INDICATOR                       *
      * WWSETA   - WORK FIELD SETTLEMENT ACCOUNT                         *
      *                                                                  *
      ********************************************************************
     C           SRCUST    BEGSR
      *
     C***********          Z-ADDAAMACU    WWMABC 130                      CPM003
     C                     Z-ADDMACU      WWMABC 130                      CPM003
     C                     Z-ADDCSLT      WWSETP  20
     C**********           Z-ADDCUSC      WWCBNB  60                                          CSD027
     C                     MOVE CUSC      WWCBNB  6                                           CSD027
     C                     MOVEL'N'       WWBRKI  1
     C**********           MOVELCSLA      WWSETA 12                                           CGL029
     C                     MOVELCSLA      WWSETA 18                                           CGL029
     C                     MOVELCBID      WWSETB  3                       CPM003
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVELCFAO      WWSEFA 10                                           CGL020
     C                     MOVELCCPN      WWSECP  8                                           CGL020
     C                     ENDIF                                                              CGL020
      *
      ** IF INITIAL MARGIN ON THE TRADE DIFFERENT THAN MARGIN ALREADY POSTED
      ** FOR THE CUSTOMER
     C***********AAMACU    IFNE WWCMAR                     *B1            CPM003
     C           MACU      IFNE WWCMAR                     *B1            CPM003
     C           NOCO      OREQ *ZEROS
      *
      ** IF NUMBER OF OPEN CONTRACTS IS EQUAL TO ZEROS
     C           NOCO      IFEQ *ZEROS                     *B2
     C                     Z-ADD*ZEROS    WWAMNT
     C                     ELSE
     C                     EXSR SRMACU
     C                     END                             *E2
      *
      ** COMPARE MARGIN REQUIREMENT WITH MARGIN ALREADY POSTED
     C                     Z-ADDWWAMNT    WMACU  130
      *
     C***********WWAMNT    IFNE AAMACU                     *B2            CPM003
     C           WWAMNT    IFNE MACU                       *B2            CPM003
     C                     MOVE '1'       *IN20
     C                     EXSR SRACKY
     C                     END                             *E2
      *
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRBROK   - SR PROCESSING FOR BROKER                              *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SRMABK   - SR ADJUST MARGIN FOR BROKER                           *
      * SRACKY   - SR GENERATE ACCOUNT KEY                               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRMAIN   - SR MAIN PROCESSING                                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWMABC   - WORK FIELD CUSTOMER/BROKER MARGIN                     *
      * WWSETP   - WORK FIELD SETTLEMENT TYPE                            *
      * WWCBNB   - WORK FIELD CUSTOMER/BROKER CODE                       *
      * WWBRKI   - WORK FIELD FOR BROKER INDICATOR                       *
      * WWSETA   - WORK FIELD SETTLEMENT ACCOUNT                         *
      *                                                                  *
      ********************************************************************
     C           SRBROK    BEGSR
      *
     C***********          Z-ADDAAMABK    WWMABC                          CPM003
     C                     Z-ADDMABK      WWMABC                          CPM003
     C                     Z-ADDBSLT      WWSETP
     C**********           Z-ADDBOCO      WWCBNB                                              CSD027
     C                     MOVE BOCO      WWCBNB                                              CSD027
     C                     MOVEL'Y'       WWBRKI
     C                     MOVELBSLA      WWSETA
     C                     MOVELBBID      WWSETB                          CPM003
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVELBFAO      WWSEFA                                              CGL020
     C                     MOVELBCPN      WWSECP                                              CGL020
     C                     ENDIF                                                              CGL020
      *
      ** IF INITIAL MARGIN ON THE TRADE DIFFERENT THAN MARGIN ALREADY POSTED
      ** FOR THE CUSTOMER
     C***********AAMABK    IFNE WWBMAR                     *B1            CPM003
     C           MABK      IFNE WWBMAR                     *B1            CPM003
     C           NOBO      OREQ *ZEROS
      *
      ** IF NUMBER OF OPEN CONTRACTS IS EQUAL TO ZEROS
     C           NOBO      IFEQ *ZEROS                     *B2
     C                     Z-ADD*ZEROS    WWAMNT
     C                     ELSE
     C                     EXSR SRMABK
     C                     END                             *E2
      *
      ** COMPARE MARGIN REQUIREMENT WITH MARGIN ALREADY POSTED
     C                     Z-ADDWWAMNT    WMABK  130
      *
     C***********WWAMNT    IFNE AAMABK                     *B2            CPM003
     C           WWAMNT    IFNE MABK                       *B2            CPM003
     C                     MOVE '1'       *IN21
     C                     EXSR SRACKY
     C                     END                             *E2
      *
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRMACU   - SR ADJUST MARGIN FOR CUSTOMER                         *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRCUST   - SR PROCESSING FOR CUSTOMER                            *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * TBCKEY   - WORK FIELD TO ACCESS IN WCOLTDM                       *
      * WWCMAR   - WORK FIELD CUSTOMER MARGIN                            *
      * WWAMNT   - WORK FIELD AMOUNT CALCULATED                          *
      *                                                                  *
      ********************************************************************
     C           SRMACU    BEGSR
      *
     C                     Z-ADD*ZEROS    WWWAMT 130
      *
      ** ACCESS TO COLLATERAL FILE
     C**********           Z-ADDCUSC      CBCD                                                CSD027
     C                     MOVE CUSC      CBCD                                                CSD027
     C           CLCKEY    CHAINWCOLTDM              05
      *
      ** RECORD FOUND AND COLLATERAL AMOUNT NOT EQUAL ZEROS
     C           *IN05     IFEQ '0'                        *B1
     C           COLA      ANDNE*ZEROS
      *
      ** COMPARE COLLATERAL FOUND WITH MARGIN REQUIREMENT
     C           COLA      IFLE WWCMAR                     **B2
     C                     SUB  COLA      WWCMAR
     C                     Z-ADD*ZERO     COLA
     C                     ELSE                            **X2
     C                     SUB  WWCMAR    COLA
     C                     Z-ADD*ZEROS    WWCMAR
     C                     END                             **E2
      *
     C                     UPDATWCOLTDF
     C                     END                             *E1
     C                     Z-ADDWWCMAR    WWAMNT
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRMABK   - SR ADJUST MARGIN FOR BROKER                           *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRBROK   - SR PROCESSING FOR BROKER                              *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWCOLL   - WORK FIELD TO ACCESS IN WCOLTDM                       *
      * WWBMAR   - WORK FIELD BROKER MARGIN                              *
      * WWAMNT   - WORK FIELD AMOUNT CALCULATED                          *
      *                                                                  *
      ********************************************************************
     C           SRMABK    BEGSR
      *
     C                     Z-ADD*ZEROS    WWWAMT
      *
      ** ACCESS TO COLLATERAL FILE (WHICH HOLDS DETAILS OF T BILL COLLATERAL)
      ** WITH THE T BILL COLLATERAL INDICATOR = 'TB'                      CPM003
     C                     MOVEL'TB'      TBCID                           CPM003
     C           TBCKEY    CHAINWCOLTDM              05
      *
     C           *IN05     IFEQ '0'                        *B1
     C           COLA      ANDNE*ZEROS
      *
      *
      ** COMPARE COLLATERAL FOUND WITH MARGIN REQUIREMENT
     C           COLA      IFGT WWBMAR                     *B2
     C                     SUB  WWBMAR    COLA
     C                     Z-ADD*ZERO     WWBMAR
     C                     ELSE                            *X2
     C                     SUB  COLA      WWBMAR
     C                     Z-ADD*ZERO     COLA
     C                     END                             *E2
      *
     C                     UPDATWCOLTDF
     C                     END                             *E1
      *
      ** ACCESS TO COLLATERAL FILE
      ** WITH THE T BILL COLLATERAL INDICATOR = BLANK                     CPM003
     C                     MOVEL*BLANK    TBCID                           CPM003
     C**********           Z-ADDBOCO      CBCD                                                CSD027
     C                     MOVE BOCO      CBCD                                                CSD027
     C           CLCKEY    CHAINWCOLTDM              05
      *
      ** RECORD FOUND AND COLLATERAL AMOUNT NOT EQUAL ZEROS
     C           *IN05     IFEQ '0'                        *B1
     C           COLA      ANDNE*ZEROS
      *
      ** COMPARE COLLATERAL FOUND WITH MARGIN REQUIREMENT
     C           COLA      IFGT WWBMAR                     **B2
     C                     SUB  WWBMAR    COLA
     C                     Z-ADD*ZERO     WWBMAR
     C                     ELSE                            **X2
     C                     SUB  COLA      WWBMAR
     C                     Z-ADD*ZERO     COLA
     C                     END                             **E2
      *
     C                     UPDATWCOLTDF
     C                     END                             *E1
     C                     Z-ADDWWBMAR    WWAMNT
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRACKY   - SR GENERATE ACCOUNT KEY                               *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SRSDET   - SR DETERMINE SETTLEMENT ID                            *
      * SRMARG   - SR CHECK IF MARGIN PRESENT FOR CUSTOMER               *
      * SRWACK   - SR WRITE ACCOUNT KEY                                  *
      * ZZADD    - SR ADD AMOUNTS INTO HASH FIELDS                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRCUST   - SR PROCESSING FOR CUSTOMER                            *
      * SRBROK   - SR PROCESSING FOR BROKER                              *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWBRKI   - WORK FIELD FOR BROKER INDICATOR                       *
      * WWMABC   - WORK FIELD CUSTOMER/BROKER MARGIN                     *
      * WWAMNT   - WORK FIELD AMOUNT CALCULATED                          *
      *                                                                  *
      ********************************************************************
     C           SRACKY    BEGSR
     C                     EXSR SRSDET
      *
     C                     SETOF                     07
     C                     MOVE 'F'       FFKY1
     C                     MOVE 'J'       FFKY3
      *
      ** CHECK THE BROKER INDICATOR
     C           WWBRKI    IFEQ 'Y'                        *B1
     C                     MOVE 'B'       FFKY12
     C                     ELSE                            *X1
     C                     MOVE 'C'       FFKY12
      *
      ** IF SETTLEMENT ACCOUNT IS RETAIL, SEE IF MARGINS SET UP
     C           SATYP     IFEQ 'R'                        **B2
     C                     EXSR SRMARG
     C                     END                             **E2
      *
     C                     END                             *E1
      *
      ** OUTPUT ACCOUNT KEYS IF MARGINS NOT REQUIRED
     C           *IN07     IFEQ '0'                        *B1
      *
      ** COMPARE MARGIN REQUIREMENT WITH MARGIN POSTED
     C           WWAMNT    IFGT WWMABC                     **B2
      *
     C           WWAMNT    SUB  WWMABC    WWWAMT
     C                     Z-ADDWWWAMT    WWAMNT
      *
      ** CHECK THE BROKER INDICATOR.
     C           WWBRKI    IFEQ 'Y'                        ***B3
     C                     MOVE 'B'       FFKY14
     C                     ELSE                            ***X3
     C                     MOVE 'C'       FFKY14
     C                     END                             ***E3
      *
      *                                                                                       CGL020
      **If*CFF015*is*On,*set*position*2*of*the*account*key*equal*to*Put/Call*indicatoCFF015 MD034233
     C********** CFF015    IFEQ 'Y'                                                  CFF015 MD034233
     C**********           MOVE PCAL9     FFKY2                                      CFF015 MD034233
     C**********           END                                                       CFF015 MD034233
      *                                                                              CFF015 MD034233
     C                     EXSR SRWACK
      *
     C                     ADD  1         NORECS  50
     C           WWAMNT    DIV  1000      ZZAMT
     C                     EXSR ZZADD
      *
     C                     ELSE                            **X2
      *
     C           WWAMNT    IFLT WWMABC                     ***B3
      *
     C           WWMABC    SUB  WWAMNT    WWWAMT
     C                     Z-ADDWWWAMT    WWAMNT
      *
      ** CHECK THE BROKER INDICATOR
     C           WWBRKI    IFEQ 'Y'                        ****B4
     C                     MOVE 'C'       FFKY14
     C                     ELSE                            ****X4
     C                     MOVE 'B'       FFKY14
     C                     END                             ****E4
      *
      *                                                                                       CGL020
      **If*CFF015*is*On,*set*position*2*of*the*account*key*equal*to*Put/Call*indicatoCFF015 MD034233
     C********** CFF015    IFEQ 'Y'                                                  CFF015 MD034233
     C**********           MOVE PCAL9     FFKY2                                      CFF015 MD034233
     C**********           END                                                       CFF015 MD034233
      *                                                                                       CFF015
     C                     EXSR SRWACK
      *
     C                     ADD  1         NORECS  50
     C           WWAMNT    DIV  1000      ZZAMT
     C                     EXSR ZZADD
      *
     C                     END                             ***E3
      *
     C                     END                             **E2
      *
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRWACK   - SR WRITE ACCOUNT KEY                                  *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRACKY   - SR GENERATE ACCOUNT KEY                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWCBNB   - WORK FIELD CUSTOMER/BROKER CODE                       *
      * WWAMNT   - WORK FIELD AMOUNT CALCULATED                          *
      * WWSETP   - WORK FIELD SETTLEMENT TYPE                            *
      * WWSETA   - WORK FIELD SETTLEMENT ACCOUNT                         *
      * WWKEY    - WORK FIELD DATABASE ERROR                             *
      * WWBASE   - WORK FIELD DATABASE ERROR                             *
      * WWFILE   - WORK FIELD DATABASE ERROR                             *
      *                                                                  *
      ********************************************************************
     C           SRWACK    BEGSR
      *
     C                     MOVEL'D'       RECI
     C                     Z-ADDTNBR9     TNBR
     C                     Z-ADDCLSR      CLON
     C**********           Z-ADDWWCBNB    CBCD                                                CSD027
     C                     MOVE WWCBNB    CBCD                                                CSD027
     C                     MOVELBOKC9     BOKC
     C***********          Z-ADDBRCD9     BRCD                            CPM003
     C                     MOVE BRCA9     BRCA                            CPM003
     C                     MOVEL*BLANKS   OBKC
     C                     Z-ADD*ZEROS    ASEQ
     C                     Z-ADDBJRDNB    EDAT
     C                     Z-ADDWWAMNT    EAMT
     C                     MOVELISCY      CCY
     C                     Z-ADDBJRDNB    VDAT
     C                     Z-ADDWWSETP    SETP
     C                     MOVELWWSETA    SETA
     C                     MOVELWWSETB    SEBR                            CPM003
     C                     MOVELISTT9     ISTT
     C                     Z-ADDYRNO9     YRNO
     C                     Z-ADDMTHN9     MTHN
     C                     MOVELPCAL9     PCAL
     C                     Z-ADDSTRP9     STRP
      *
     C           ISTT9     CHAININTYP                01
      *
     C           *IN01     IFEQ '1'                        *B1
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVELISTT9     WWKEY            ***************CPM003
     C***********          Z-ADD9         WWBASE           ***************CPM003
     C***********          MOVEL'INTYP'   WWFILE           ***************CPM003
     C                     MOVELISTT9     DBKEY            ***************CPM003
     C                     Z-ADD9         DBASE            **DB ERROR 09**CPM003
     C                     MOVE 'INTYP'   DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
     C                     MOVELISTNY     ISTN
     C                     Z-ADD*ZEROS    REVI
      *
      ** OUTPUT PORTFOLIO REFERENCE ONLY FOR THE NON-BROKER
     C           WWBRKI    IFEQ 'N'                        *B1
     C                     MOVELPTFR9     PTFR
     C                     ELSE                            *X1
     C                     MOVEL*BLANKS   PTFR
     C                     END                             *E1
     C*                                                                   CAC003
     C** Determine value of the Profit Centre                             CAC003
     C           *IN30     IFEQ '1'                                       CAC003
     C                     MOVE PRFC      PRFC1   4                       CAC003
     C*                                                                   CAC003
     C           WWBRKI    IFEQ 'Y'                                       CAC003
     C                     MOVE BXFOPC    PRFC                            CAC003
     C                     ELSE                                           CAC003
     C                     MOVE TPRC      PRFC                            CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
      *                                                                                       CGL020
      ** Call ZAAMLSETFF before writing the details to the                                    CGL020
      ** account keys file FOKEYD                                                             CGL020
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
      *                                                                                       CGL020
     C**********           Z-ADDCBCD      PCBCD                                        CGL020 CSD027
     C                     MOVE CBCD      PCBCD                                               CSD027
      *                                                                                       CGL020
     C                     CALL WZAAML                                                        CGL020
      *                                                                                       CGL020
     C                     PARM           PCBCD                                               CGL020
     C                     PARM           SETA                                                CGL020
     C                     PARM           SEBR                                                CGL020
     C                     PARM           WWSEFA                                              CGL020
     C                     PARM           WWSECP                                              CGL020
     C                     PARM           CCY                                                 CGL020
     C                     PARM           F1RACT                                              CGL020
     C                     PARM           F1RCTY                                              CGL020
     C                     PARM           F1RBNK                                              CGL020
     C                     PARM           F1RCDE                                              CGL020
     C                     PARM           F1PACT                                              CGL020
     C                     PARM           F1PCTY                                              CGL020
     C                     PARM           F1PBNK                                              CGL020
     C                     PARM           F1PCDE                                              CGL020
     C                     PARM           F1DACT                                              CGL020
     C                     PARM           F1DCTY                                              CGL020
     C                     PARM           F1DBNK                                              CGL020
      *                                                                                       CGL020
     C                     Z-ADDFCDA      F1SDAT                                              CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                     MD034233
      * If CFF015 is On, set position 2 of the account key equal to Put/Call indicator      MD034233
      *                                                                                     MD034233
     C           CFF015    IFEQ 'Y'                                                         MD034233
     C           ISPT      IFEQ 4                                                           MD034233
     C           ISPT      OREQ 5                                                           MD034233
     C           ISPT      OREQ 6                                                           MD034233
     C           ISPT      OREQ 8                                                           MD034233
     C                     MOVE PCAL9     FFKY2                                             MD034233
     C                     END                                                              MD034233
     C                     END                                                              MD034233
      *                                                                                     MD034233
      *
     C                     WRITEFOKEYDF
     C*                                                                   CAC003
     C** Restore value of Profit Centre                                   CAC003
     C           *IN30     IFEQ '1'                                       CAC003
     C                     MOVE PRFC1     PRFC                            CAC003
     C                     ENDIF                                          CAC003
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SRTRAI   - SR UPDATE TRAILER                                     *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRINIT   - SR INIT PROCESSING                                    *
      * SRTRDM   - SR RETRIEVE MARGIN                                    *
      * SRWACK   - SR WRITE ACCOUNT KEY                                  *
      * SRSDET   - SR DETERMINE SETTLEMENT ID                            *
      * SRTRAI   - SR UPDATE TRAILER                                     *
      * SRMARG   - SR CHECK IF MARGIN PRESENT FOR CUSTOMER               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWFILE   - WORK FIELD DATABASE ERROR                             *
      * WWPGM    - WORK FIELD DATABASE ERROR                             *
      * WWKEY    - WORK FIELD DATABASE ERROR                             *
      * WWBASE   - WORK FIELD DATABASE ERROR                             *
      *                                                                  *
      ********************************************************************
     C           *PSSR     BEGSR
     C*                                                                   CPM003
     C           WWPSSR    IFNE 'Y'                                       CPM003
     C                     MOVE 'Y'       WWPSSR  1                       CPM003
      *
      ** WRITE DATABASE ERROR
     C                     WRITEFMTP101
     C                     WRITEFMTP102
     C************         WRITEFMTP103                                   CPM003
      *
      ***UPDATE*LDA*WITH*ERROR*INFORMATION                                CPM003
     C************LOCK     IN   LDA                                       CPM003
     C************         MOVELWWFILE    DBFILE                          CPM003
     C************         MOVELWWPGM     DBPGM                           CPM003
     C************         MOVELWWKEY     DBKEY                           CPM003
     C************         Z-ADDWWBASE    DBASE                           CPM003
     C************         OUT  LDA                                       CPM003
      *
      ** PRINT DUMP AND CANCEL PROGRAM
     C                     DUMP
      *
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     ENDIF                                          CPM003
      *
     C                     RETRN
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRENDD   - SR END PGM                                            *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SRTRAI   - SR UPDATE TRAILER                                     *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - SR MAIN PROCESSING                                    *
      * SRMAIN   - SR MAIN PROCESSING                                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           SRENDD    BEGSR
      *
     C                     EXSR SRTRAI
      *
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRSDET   - SR DETERMINE SETTLEMENT ID                            *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      * FFSETL   - SR DETERMINE SETTLEMENT DETAIL                        *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRACKY   - SR GENERATE ACCOUNT KEY                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWBRCD   - WORK FIELD TO ACCESS ON SDBRCHPD                      *
      * WWKEY    - WORK FIELD DATABASE ERROR                             *
      * WWBASE   - WORK FIELD DATABASE ERROR                             *
      * WWFILE   - WORK FIELD DATABASE ERROR                             *
      * WWCBNB   - WORK FIELD CUSTOMER/BROKER CODE                       *
      * WWBRKI   - WORK FIELD FOR BROKER INDICATOR                       *
      * WWSETP   - WORK FIELD SETTLEMENT TYPE                            *
      * WWSETA   - WORK FIELD SETTLEMENT ACCOUNT                         *
      *                                                                  *
      ********************************************************************
     C           SRSDET    BEGSR
      *
     C***********          MOVE BRCD9     WWBRCD  3                       CPM003
     C***********WWBRCD    CHAINSDBRCHL0             01                   CPM003
      ***********                                                         CPM003
      ***IF*RECORD NOT FOUND                                              CPM003
     C************IN01     IFEQ '1'                        *B1            CPM003
     C************         MOVELBRCD      WWKEY            ***************CPM003
     C************         Z-ADD10        WWBASE           **DB ERROR 10**CPM003
     C************         MOVEL'SDBRCHL0'WWFILE           ***************CPM003
     C                     MOVE BRCA9     WWBRCA  3                       CPM003
     C**********           CALL 'AOBRCHR0'                                CPM003              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM           @RTCD                           CPM003
     C                     PARM '*KEY    '@OPTN                           CPM003
     C                     PARM WWBRCA    @KEY3   3                       CPM003
     C********** SDBRCH    PARM SDBRCH    @DSFDY                          CPM003              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      ** If record not found                                              CPM003
     C           @RTCD     IFNE *BLANKS                                   CPM003
     C           *LOCK     IN   LDA                        ***************CPM003
     C                     Z-ADD10        DBASE            * DB ERROR 10 *CPM003
     C                     MOVELWWBRCA    DBKEY            ***************CPM003
     C                     MOVE 'SDBRCHPD'DBFILE                          CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
      ** BRANCH CODE
     C***********          Z-ADDBRCD      FFBRCD                          CPM003
     C                     MOVE BRCA      FFBRCA                          CPM003
      *
      ** CUSTOMER/BROKER CODE
     C**********           Z-ADDWWCBNB    FFCBCD                                              CSD027
     C                     MOVE WWCBNB    FFCBCD                                              CSD027
      *
      ** BROKER INDICATOR
     C                     MOVE WWBRKI    FFBRKI
      *
      ** SETTLEMENT TYPE
     C                     Z-ADDWWSETP    FFSETP
      *
      ** SETTLEMENT ACCOUNT
     C                     MOVE WWSETA    FFSETA
     C                     MOVE WWSETB    FFSETB                          CPM003
      *
      ** CURRENCY
     C                     MOVE ISCY      FFCCY
      ***********                                                         CPM003
      ***DEFAULT*ACCOUNT SEQUENCE                                         CPM003
     C***********BJMBDI    IFEQ 'Y'                        *B1            CPM003
     C***********          Z-ADDA8SACS    FFDASQ                          CPM003
     C***********          ELSE                            *X1            CPM003
     C                     Z-ADD01        FFDASQ
     C***********          END                             *E1            CPM003
      *
     C                     EXSR FFSETL
      *
      ** SET SETTLEMENT A/C ID IF IT IS VALID ( *IN89 IS OFF )
     C           *IN89     IFEQ '0'                        *B1
     C                     MOVELFFBRCB    SBID    3                       CPM003
     C                     MOVELFFCNUM    ATIDCN
     C                     MOVELFFCCY     ATIDCY
     C                     MOVELFFACOD    ATIDAC
     C                     MOVELFFACSQ    ATIDAQ
     C                     MOVE ATYP      SATYP
     C                     ELSE                            *X1
     C                     MOVEL*BLANK    SBID                            CPM003
     C                     MOVEL*BLANKS   ATID
     C           *LIKE     DEFN ATYP      SATYP
     C                     MOVE *BLANKS   SATYP
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRTRAI   - SR UPDATE TRAILER                                     *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      * ZZADD    - SR ADD AMOUNTS INTO HASH FIELDS                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRMAIN   - SR MAIN PROCESSING                                    *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      * SRENDD   - SR END PGM                                            *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWKEY    - WORK FIELD DATABASE ERROR                             *
      * WWBASE   - WORK FIELD DATABASE ERROR                             *
      * WWFILE   - WORK FIELD DATABASE ERROR                             *
      *                                                                  *
      ********************************************************************
     C           SRTRAI    BEGSR
      *
      ** ACCESS AUDIT RECORD OFF PF/FOKEYA
     C           1         CHAINFOKEYAF              01
      *
      ** IF RECORD NOT FOUND, DATABASE ERROR
     C           *IN01     IFEQ '1'                        *B1
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVEL*BLANKS   WWKEY            ***************CPM003
     C***********          Z-ADD11        WWBASE           ***************CPM003
     C***********          MOVEL'FOKEYA'  WWFILE           ***************CPM003
     C                     MOVEL*BLANKS   DBKEY            ***************CPM003
     C                     Z-ADD11        DBASE            **DB ERROR 11**CPM003
     C                     MOVE 'FOKEYA'  DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
     C                     ADD  NORECS    NORE
      *
     C                     Z-ADDZZTOTI    NOTOTI
     C                     Z-ADDZZTOTD    NOTOTD
      *
     C           HRDC      DIV  1000      ZZAMT
     C                     ADD  HRWN      ZZAMT
     C                     EXSR ZZADD
     C                     Z-ADDZZTOTI    HRWN
     C                     Z-ADDZZTOTD    HRDC
      *
     C                     MOVE 'T'       RECI
     C                     UPDATFOKEYAF
      *
      ** OUTPUT RUN CONTROL REPORT, ONE PAGE ONLY
     C                     WRITEFMTP101
      *
     C*************        WRITEFMTP103                                   CPM003
      *
     C                     ENDSR
      ****************************************************************
      **  THIS SUBROUTINE HAS BEEN CHANGED ONLY FOR THIS PGM         *
      **  FFSETL SR.  - Determines from input Settlement Details     *
      **  ~~~~~~~~~~    whether MEMOS or PRONO processing is required*
      **                In addition,whilst doing this,the associated *
      **                settlement account ID is constructed.        *
      **                                                             *
      **  NB. FOR THIS SUBROUTINE TO WORK THE FOLLOWING FILES NEED   *
      **  TO HAVE BEEN ACCESSED PREVIOUSLY : PF/SDDEALPD             *
      **                                     PF/SDTRADPD             *
      **                                     PF/SDTRADPD             *
      **                                     PF/SDFODAPD             *
      **                                     PF/SDBRCHPD(for Branch) *
      **                                                             *
      ****************************************************************
      **                                                             *
      ******INPUTS****- FFBRCD  (3,0S) BRANCH CODE                   *    CPM003
      **    INPUTS    - FFBRCA  (3A)   BRANCH CODE                   *    CPM003
      **                FFCBCD  (6,0S) CUSTOMER/BROKER CODE          *
      **                FFBRKI    (1A) BROKER INDICATOR              *
      **                FFSETP  (2,0S) SETTLEMENT TYPE               *
      **                FFSETA   (12A) SETTLEMENT ACCOUNT            *
     C**                FFSETB    (3A) SETTLEMENT BRANCH             *    CPM003
      **                FFCCY     (3A) CURRENCY                      *
      **                FFDASQ  (2,0S) DEFAULT A/C SEQUENCE          *
      ******************   (= Start A/c Seq no. for the Branch if    *    CPM003
      ******************    Multi-branching, else '01')              *    CPM003
      **                *INU2     (1A) RETAIL IS PRESENT             *
      **                *INU6     (1A) INPUT CYCLE MODE              *
      **    OUTPUTS   - FFCNUM  (6,0S) CUSTOMER NUMBER               *
      **                FFACOD  (4,0S) ACCOUNT CODE                  *
      **                FFACSQ  (2,0S) ACCOUNT SEQUENCE              *
     C**                FFBRCB    (3A) BRANCH CODE                   *    CPM003
      **                FFNOSN  (2,0S) NOSTRO NUMBER to access PRONO *
      **                FFMIND    (1A) MEMOS UPDATE INDICATOR        *
      **                                (= Y or N or E)              *
      **                FFPIND    (1A) PRONO UPDATE INDICATOR        *
      **                                (= Y or N)                   *
      **                *IN89     (1A) CHAIN FAIL INDICATOR          *
      **                                                             *
      ****************************************************************
     C           FFSETL    BEGSR                           ** FFSETL SR **
      *
      ** INPUT PARAMATERS
     C***********          Z-ADDFFBRCD    FFBRCD  30                      CPM003
     C                     MOVE FFBRCA    FFBRCA  3                       CPM003
     C**********           Z-ADDFFCBCD    FFCBCD  60                                          CSD027
     C                     MOVE FFCBCD    FFCBCD  6                                           CSD027
     C                     MOVE FFBRKI    FFBRKI  1
     C                     Z-ADDFFSETP    FFSETP  20
     C**********           MOVE FFSETA    FFSETA 12                                           CGL029
     C                     MOVE FFSETA    FFSETA 18                                           CGL029
     C                     MOVE FFSETB    FFSETB  3                       CPM003
     C                     MOVE FFCCY     FFCCY   3
     C                     MOVE FFCCY     FFNCCY  3
     C                     Z-ADDFFDASQ    FFDASQ  20
      *
      ** OUTPUT PARAMETERS
     C                     MOVE *BLANKS   FFBRCB  3                       CPM003
     C**********           Z-ADD*ZERO     FFCNUM  60                                          CSD027
     C                     MOVE *BLANKS   FFCNUM  6                                           CSD027
     C**********           Z-ADD*ZERO     FFACOD  40                                          CGL029
     C                     Z-ADD*ZERO     FFACOD 100                                          CGL029
     C                     Z-ADD*ZERO     FFACSQ  20
     C                     Z-ADD*ZERO     FFNOSN  20
     C                     MOVE 'N'       FFMIND  1
     C                     MOVE 'N'       FFPIND  1
     C                     SETOF                     89
      *
      ** IF THIS SUBROUTINE IS NOT BEING RUN
      ** IN INPUT CYCLE, THEN FINISH
     C           *INU6     CABEQ'0'       FFEEND
      *
      ** 1. DETERMINE THE OUTPUT CUSTOMER NUMBER, ACCOUNT CODE AND
      ** ACCOUNT SEQUENCE DEPENDING ON SETTLEMENT TYPE
      *
      ** SETTLEMENT TYPES 01,02,07,08,12 : DETAILS FROM NOSTRO RECORD
     C           FFSETP    IFEQ 01                         *B1
     C           FFSETP    OREQ 02
     C           FFSETP    OREQ 07
     C           FFSETP    OREQ 08
     C           FFSETP    OREQ 12
      *
      ** SET PRONO UPDATE IND. TO 'Y'
     C                     MOVE 'Y'       FFPIND
      *
     C           FFSETA    IFEQ *BLANK                     **B2
     C                     Z-ADD0         FFNOSN
     C                     SETON                     89
     C                     GOTO FFEEND
     C                     ELSE                            **X2
      *
     C                     MOVELFFSETA    FFNOSN
     C                     MOVELFFSETA    WWNOSN  2                       CPM003
     C                     MOVELFFCCY     WWKEY5  5                       CPM003
     C                     MOVE WWNOSN    WWKEY5                          CPM003
     C***********FFNKY     CHAINSDNOSTL0             89                   CPM003
      ***********                                                         CPM003
      ***RECORD*MISSING                                                   CPM003
     C************IN89     IFEQ '1'                        ***B3          CPM003
     C                     CALL 'AONOSTR0'                                CPM003
     C                     PARM *BLANKS   @RTCD                           CPM003
     C                     PARM '*KEY    '@OPTN                           CPM003
     C                     PARM *BLANKS   P@CUST  6                       CPM003
     C                     PARM FFCCY     P@CYCD  3                       CPM003
     C**********           PARM *BLANKS   P@ACCD  4                                    CPM003 CGL029
     C                     PARM *BLANKS   P@ACCD 10                                           CGL029
     C                     PARM *BLANKS   P@ACSN  2                       CPM003
     C                     PARM WWNOSN    P@NONB  2                       CPM003
     C                     PARM *BLANKS   P@BRCD  3                       CPM003
     C                     PARM *BLANKS   P@CSSN 10                       CPM003
     C                     PARM *BLANKS   P@PNOI  1                       CPM003
     C           SDNOST    PARM SDNOST    @DSFDY                          CPM003
     C           @RTCD     IFNE *BLANKS                                   CPM003
     C                     Z-ADD0         FFNOSN
     C                     GOTO FFEEND
     C                     ELSE                            ***X3
      *
     C                     MOVE A7BRCD    FFBRCB                          CPM003
     C                     MOVE A7CUST    FFCNUM
     C                     MOVE A7ACCD    FFACOD
     C                     Z-ADDA7ACSN    FFACSQ
     C                     END                             ***E3
      *
     C                     END                             **E2
      *
     C                     END                             *E1
      *
      ** SETTLEMENT TYPE 03
     C           FFSETP    IFEQ 03                         *B1
      *
     C                     MOVE FFBRCA    FFBRCB                          CPM003
     C                     MOVE A8BICN    FFCNUM
     C                     MOVE BLACCD    FFACOD
     C                     Z-ADDFFDASQ    FFACSQ
      *
     C                     END                             *E1
      *
      ** SETTLEMENT TYPE 04
     C           FFSETP    IFEQ 04                         *B1
      *
     C                     MOVE FFBRCA    FFBRCB                          CPM003
     C**********           Z-ADDFFCBCD    FFCNUM                                              CSD027
     C                     MOVE FFCBCD    FFCNUM                                              CSD027
     C                     MOVE BNACCD    FFACOD
     C                     Z-ADDFFDASQ    FFACSQ
      *
     C                     END                             *E1
      *
      ** SETTLEMENT TYPE 05
     C           FFSETP    IFEQ 05                         *B1
      *
     C                     MOVE FFSETB    FFBRCB                          CPM003
     C**********           Z-ADDFFSCNM    FFCNUM                                              CSD027
     C                     MOVE FFSCNM    FFCNUM                                              CSD027
     C                     Z-ADDFFSACD    FFACOD
     C                     Z-ADDFFSASQ    FFACSQ
      *
      ** A/C SEQUENCE MAY BE ZERO (IN A MULTIBRANCHING ENVIRONMENT)
     C           FFACSQ    IFEQ *ZERO                      **B2
     C                     Z-ADDFFDASQ    FFACSQ
     C                     END                             **E2
      *
     C                     END                             *E1
      *
      ** SETTLEMENT TYPE 06
     C           FFSETP    IFEQ 06                         *B1
      *
     C                     MOVE FFBRCA    FFBRCB                          CPM003
     C                     MOVE A8BICN    FFCNUM
     C                     MOVE BKACCD    FFACOD
     C                     Z-ADDFFDASQ    FFACSQ
      *
     C                     END                             *E1
      *
      ** SETTLEMENT TYPE 14 : DETAILS FROM LF/ACNUM
     C           FFSETP    IFEQ 14                         *B1
      *
     C           FFACMK    CHAINACNUM                89
     C  N89      RECI      COMP 'D'                  8989
      *
      ** RECORD MISSING
     C           *IN89     CABEQ'1'       FFEEND
      *
     C***********          MOVE BRCA      FFBRCB                   CPM003 119065
     C                     MOVE BRCAY     FFBRCB                          119065
     C**********           Z-ADDCNUM      FFCNUM                                              CSD027
     C                     MOVE CNUM      FFCNUM                                              CSD027
     C                     Z-ADDACOD      FFACOD
     C                     Z-ADDACSQ      FFACSQ
      *
     C                     END                             *E1
      *
      ** SETTLEMENT TYPE 15
     C           FFSETP    IFEQ 15                         *B1
      *
     C                     MOVE FFBRCA    FFBRCB                          CPM003
     C**********           Z-ADDFFCBCD    FFCNUM                                              CSD027
     C                     MOVE FFCBCD    FFCNUM                                              CSD027
      *
     C           FFBRKI    IFEQ 'Y'                        **B2
      *
      ** DEFAULT BROKER ACCOUNT CODE
     C                     MOVE BXACCD    FFACOD
      *
     C                     ELSE                            **X2
      *
      ** DEFAULT CUSTOMER ACCOUNT CODE
     C                     MOVE BXDCAC    FFACOD
     C                     END                             **E2
      *
     C                     Z-ADDFFDASQ    FFACSQ
      *
     C                     END                             *E1
      *
      ** IF THE RETAIL MODULE IS NOT SUPPORTED
      ** BY THE SYSTEM, THEN FINISH
     C           *INU2     CABEQ'0'       FFEEND
      *
      ** 2. ACCESS ACCOUNT CODES TABLE FILE
     C**********           MOVE FFACOD    WWACOD  4                                           CGL029
     C                     MOVE FFACOD    WWACOD 10                                           CGL029
     C***********WWACOD    CHAINSDACODL0             89                   CPM003
     C                     CALL 'AOACODR0'                                CPM003
     C                     PARM *BLANKS   @RTCD                           CPM003
     C                     PARM '*KEY    '@OPTN                           CPM003
     C**********           PARM WWACOD    @KEY4   4                                    CPM003 CGL029
     C                     PARM WWACOD    @KEY4  10                                           CGL029
     C********** SDACOD    PARM SDACOD    @DSFDY                                       CPM003 CGL029
     C           SDACOD    PARM SDACOD    DSSDY                                               CGL029
      *
      ** RECORD MISSING
     C************IN89     CABEQ'1'       FFEEND                          CPM003
     C***********@RTCD     CABNE*BLANKS   FFEEND                   CPM003 157661
     C           @RTCD     IFNE *BLANKS                                   157661
     C                     SETON                     89                   157661
     C                     GOTO FFEEND                                    157661
     C                     ENDIF                                          157661
      *                                                                   157661
     C                     MOVELA5ACTY    ATYP                            157661
      *
      ** IF A RETAIL ACCOUNT ACCESS LF/ACCNT
     C           ATYP      IFEQ 'R'                        *B1
      *
     C           FFACTK    CHAINACCNT                89
      *
      ** IF RECORD EXISTS AND IS NEITHER FLAGGED FOR DELETION
      ** NOR CLOSED THEN SET MEMOS UPDATE IND. TO 'Y'.
     C           *IN89     IFEQ '0'                        **B2
     C           RECI      ANDNE'*'
     C           ACST      ANDNE'C'
     C                     MOVE 'Y'       FFMIND
      *
      ** IF NO LIVE OPEN RETAIL A/C,
      ** SET MEMOS UPDATE IND. TO 'E'.
     C                     ELSE                            **X2
     C                     MOVE 'E'       FFMIND
     C                     END                             **E2
      *
     C                     END                             *E1
      *
     C           FFEEND    ENDSR                           **  FFEEND  **
      ****************************************************************
      **                                                             *
      **  SR:ZZADD    - TO ADD AMOUNTS INTO HASH FIELDS              *
      **                                                             *
      **  INPUTS      - ZZAMT  (15,3) AMOUNT                         *
      **              - ZZTOTI (15,0) INITIAL INTEGER PART OF THE    *
      **                HASH FEILD                                   *
      **                ZZTOTD (3,0)  INITIAL DECIMAL PART OF THE    *
      **                HASH FEILD                                   *
      **  OUTPUTS     - ZZTOTI (15,0) INTEGER PART OF THE HASH FIELD *
      **                ZZTOTD (3,0)  DECIMAL PART OF THE HASH FIELD *
      **                                                             *
      ****************************************************************
     C           ZZADD     BEGSR                           ** ZZADD  SR **
      *
      ** SET UP FIELDS TO BE HASHED
     C                     Z-ADDZZAMT     ZZAMT  153   91
     C   91                Z-SUBZZAMT     ZZAMT
     C                     Z-ADDZZAMT     ZZAMTI 150
     C                     MOVE ZZAMT     ZZAMTD  30
      *
      ** ADD DECIMAL PART AND CHECK FOR CARRY
     C                     ADD  ZZAMTD    ZZTOTD  30
     C           ZZTOTD    COMP ZZAMTD                 91
     C   91                ADD  1         ZZAMTI
      *
      ** ADD INTEGER PART
     C                     ADD  ZZAMTI    ZZTOTI 150
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SRMARG   - SR CHECK IF MARGIN PRESENT FOR CUSTOMER               *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - SR ERROR IN FILE - DATABASE ERROR                     *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * SRACKY   - SR GENERATE ACCOUNT KEY                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      **WWKEY****-*WORK FIELD DATABASE ERROR                             *CPM003
      **WWBASE***-*WORK FIELD DATABASE ERROR                             *CPM003
      **WWFILE***-*WORK FIELD DATABASE ERROR                             *CPM003
      *                                                                  *
      ********************************************************************
     C           SRMARG    BEGSR
      *
      ** ACCESS REIAC RETAIL INTEREST AND CHARGES FILE
     C           REIACK    CHAINREIAC                01
      *
      ** DATABASE ERROR IF NO RECORD FOR A RETAIL ACCOUNT
     C           *IN01     IFEQ '1'                        *B1
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVELATID      WWKEY            ***************CPM003
     C***********          Z-ADD12        WWBASE           ***************CPM003
     C***********          MOVEL'REIAC'   WWFILE           ***************CPM003
     C                     MOVELATID      DBKEY            ***************CPM003
     C                     Z-ADD12        DBASE            **DB ERROR 12**CPM003
     C                     MOVE 'REIAC'   DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             *E1
      *
      ** ACCESS REINT IF CREDIT INTEREST TYPE PRESENT
     C           CICT      IFGT 0                          *B1
     C           REINTK    CHAINREINT                01
      *
      ** DATABASE ERROR IF NO RECORD FOR A RETAIL ACCOUNT
     C           *IN01     IFEQ '1'                        **B2
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       CPM003
     C***********          MOVELREINTK    WWKEY            ***************CPM003
     C***********          Z-ADD13        WWBASE           ***************CPM003
     C***********          MOVEL'REINT'   WWFILE           ***************CPM003
     C                     MOVELREINTK    DBKEY            ***************CPM003
     C                     Z-ADD13        DBASE            **DB ERROR 13**CPM003
     C                     MOVE 'REINT'   DBFILE           ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR
     C                     END                             **E2
      *
      ** IF BALANCE ONE IS LESS THAN 0, MARGINS ARE REQUIRED - NO A/C KEY
     C           BAL,2     IFLT 0                          **B2
     C                     SETON                     07
     C                     END                             **E2
      *
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
     C/COPY ZSRSRC,ZDATE2Z2
     C/COPY ZSRSRC,FFFMTZ3
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   MSG
OVER THE COUNTER
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
