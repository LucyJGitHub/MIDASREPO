     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FT Incoming payments by a sender')               *
      *****************************************************************
      *                                                               *
      *  Midas   FUNDS TRANSFER MODULE                                *
      *                                                               *
      *  FT0155  - INCOMING PAYMENTS FOR A SENDER                     *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. CRE075             Date 06Dec10               *
      *  Prev Amend No. CER059             Date 19Jul10               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 07Jul06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 195352             Date 31Oct01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CFT009             Date 01Jun00               *
      * Midas DBA 3.04 -----------------------------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CAP136             Date 15Nov99               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CFT004             Date 27Jul99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 S01435             Date 22Jul93               *
      *                 056032               DATE 04JUN93             *
      *                 003357               DATE 13MAY93             *
      *                 S01414               DATE 29MAR93             *
      *                 042167               DATE 05AUG92             *
      *                 E29970               DATE 20JUNE91            *   E29970
      *                 E29969               DATE 19JUNE91            *   E29969
      *                 E29966               DATE 13JUNE91            *   E29966
      *                 E32790               DATE 12JUNE91            *   E32790
      *                 S01117               DATE 14/08/90            *   S01117
      *                 S01194               DATE 14/08/90            *   S01194
      *                 S01199               DATE 17/08/89            *   S01199
      *                                                               *
      *****************************************************************
      *                                                               *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  195352 - Incoming payments enquiry array index error.        *
      *  CFT009 - FT Fees and Charge Development-Recompiled           *
      *  CAP136 - Conversion of FT Incoming Payment inputs into       *
      *           modular structure to use as APIs.                   *
      *  CFT004 - International Bank Account Number                   *
      *           New Account Type 'I' (IBAN)                         *
      *  S01435 - Incoming Message Management.                        *
      *  056032 - Prevent database error processing for Account With  *
      *           Bank / Beneficiary if PVDT (pay value date) is less *
      *           than Rundate or if the payment is matured.          *
      *           N.B fix includes errors 048005,054302               *
      *  003357 - Program shows entries for sender with a value date  *
      *           before the date specified on input screen. Selection*
      *           process picks up all transactions with a matching   *
      *           sender but as the Sender field was truncated from   *
      *           35 to 20 the match process was not accurate. Need to*
      *           extend Sender field to full length of 35.           *
      *  S01414 - Book Code and Profit Centre Incorporation.          *
      *           Rename of profit centre field on ACCNTABF           *
      *  042167 - Include CL program to check for record locking      *
      *         - Call program to clear dataarea if database error    *
      *  E29970 - ENABLE COMMAND 7 PROCESSING                         *   E29970
      *  E29969 - IF F8 TAKEN BYPASS VALIDATION AND GO TO NEXT SNDR   *   E29969
      *  E29966 - DUMP IN INCORRECT POSITION                          *   E29966
      *  E32790 - Change destination to sender.                       *   E32790
      *  S01117 - MULTIBRANCHING                                      *   S01117
      *  S01194 - NEW DATABASE HANDLING                               *   S01194
      *  S01199 -  HELP SYSTEM.                                       *   S01199
      *                                                               *
      *****************************************************************
      *
     FFT0155DFCF  E                    WORKSTN
     F                                        @SFK  KSFILE FT0155F0
     F                                              KINFDS DSPDS          S01117
     F*TABFP***IF**E***********K        DISK                              S01194
     F*INPALL**IF**E***********K        DISK                              S01117
     F*INPSND**IF**E***********K        DISK                              S01117
     F************INPAYDDF*****                     KRENAMEINPAYDSF       S01117
     F*CLINT***IF**E***********K        DISK                              S01117
     F*SNAME***IF**E***********K        DISK                              S01117
     F************CLINTCBF*****                     KRENAMESNAMEF         S01117
     FINPALLBBIF  E           K        DISK                               S01117
     FINPALLOBIF  E           K        DISK                               S01117
     F            INPAYDDF                          KRENAMEINPAYAOB       S01117
     FINPSNDBBIF  E           K        DISK                               S01117
     F            INPAYDDF                          KRENAMEINPAYSBB       S01117
     FINPSNDOBIF  E           K        DISK                               S01117
     F            INPAYDDF                          KRENAMEINPAYSOB       S01117
     FACNUMA  IF  E           K        DISK
     FACCNT   IF  E           K        DISK                               S01117
     F            ACCNTAAF                          KIGNORE               S01117
     F            ACCNTACF                          KIGNORE               S01117
     F            ACCNTABF                          KRENAMEACCNTTF        S01117
     F/COPY WNCPYSRC,FT0155F001
      /EJECT
      *
      *****************************************************************
      *                                                               *
      *   INDICATOR USAGE                                             *
      *   ---------------                                             *
      *                                                               *
      *   01      CHAIN fail - payments awaiting authorisation        *
      *   02      End of file on subfile                              *
      *   03      LOKUP operation successful                          *
      *   05      CHAIN fail - currencies, clients, retail a/c nos    *
      *   06      Subfile record has been read on this cycle          *
      *   07      CHAIN fail - shortnames file                        *
      *   08      ORIGINATING USED FLAG ON                            *   S01117
      *   13      used in LOKUP, on if ? found in currency field      *   S01194
      *   14      used in LOKUP, on if ? found in branch field        *   S01194
      *   15      on then redisplay screen                            *   S01194
      *   16      BORO = B                                            *   S01117
      *   17      BORO = O                                            *   S01117
      *   18      Currency and Sender blank                           *   S01117
      *   19      Currency and Sender both non-blank                  *   S01117
      *   20      Branch entry ='ALL'                                 *   S01117
      *   21      Disable F8                                          *   S01117
      ****22******HELP requested                                      *   S01117
      *   23      SFLCLR                                              *
      *   24      SFLDSP                                              *
      *   25      SFLEND                                              *
      *   26      SFLNXTCHG                                           *
      *   28      DSPATR(PR) on subfile field Select payment          *
      *   29      ROLLUP requested                                    *
      *   30      SFLDSPCTL on subfile                                *
      *   31      Highlight bits on subfile                           *
      *   43      MULTIBRANCHING                                      *   S01117
      *   44      Subfile validation error - Select payment           *
      *   46      No payments awaiting authorisation                  *
      *   50      A validation error has occurred                     *
      *   51      Validation error - currency                         *
      *   52      Validation error - payment reference                *
      *   53      Validation error - authorised indicator             *
      *   54      Validation error - start value date                 *
      *   55      Validation error - branch code                      *   S01117
      *   56      Validation error - originating/booking indicator    *   S01117
      *   60      On means Currency is blank and sender is on, so that*
      *           INPSND is used instead of INPALL                    *
      *   75      1st time through subheading processing              *   S01117
      *   77      READ LOOP INDICATOR                                 *   S01117
      *   78      READ LOOP INDICATOR BRANCHES ='ALL'                 *   S01117
      *   79      SENDER NOT EQUAL TO SCREEN SENDER                   *   S01117
      *   80      FULL ACCOUNT ENTERED FOR SENDER MB=N                *   S01117
      *   81      ACCNT CHAIN FAIL ERROR                              *   S01117
      *   83      IF ON VALID RECORDS FOUND BUT USER NOT AUTHORISED   *   S01117
      *           TO ANY OF THEM.                                     *   S01117
      *   88      ? FOUND IN @SDEST SCREEN FIELD                      *   S01194
      *                                                               *
      *   90 - 99 Used in validation/conversion routines (Z s/r's)    *
      *                                                               *
      *   U7      Data base error                                     *
      *   U8      Data base error                                     *
      *                                                               *
      *****************************************************************
      *
      /EJECT
      *
      *****************************************************************
      *                                                               *
      *   SUB-ROUTINE DEFINITIONS                                     *
      *   -----------------------                                     *
      *                                                               *
      *   INIT    Initialization                                      *
      *   SELECT  Display and validate first screen                   *   S01117
      *   SETUP   Initialize subfile for enquiry/delete               *
      *   POSSET  Setup initial key field values                      *   S01117
      *   INPONE  Position to valid INPALBB/OB or INPSNDBB/OB record  *   S01117
      *   PALSET  Position file INPALBB/OB after F8                   *   S01117
      *   SNDSET  Position file INSNDBB/OB after F8                   *   S01117
      *   CONTRL  Control display of subfile                          *
      *   DSPLY   Display initial screen or subfile                   *
      *   VALID   Validate initial screen                             *
      *   NEXTP   Create page of subfile records                      *
      *   SFFILL  Write a page of records to the subfile              *   S01117
      *   TOTAL   Write a total line to the subfile                   *   S01117
      *   CONVRT  Convert destination or ordering bank/customer code  *
      *           and entry to a client name                          *
      *   DBERR   Error handling                                      *
      *   ZSEDIT  Insert a decimal point and sign into a numeric field*
      *           and to blank out leading zeros (optionally inserting*
      *                                                       commas) *
      *   FLDQRY  Resolve entry of ? for standing data fields         *   S01117
      *                                                               *
      *****************************************************************
      /EJECT
      *
     E                    CPY@    1   1 80
     E                    @TX     1   1 80
     E                    @TX2    1   1 40                                042167
     E                    @TX3        1 30                                042167
     E                    @TS     1   1 80
     E                    @AT     1   1 80               AUTHORITY NON F8
     E                    @FT     1   1 80               AUTHORITY F8
     E                    @EA        40  4               Error codes
     E                    ZYDY    4   4  4 0             ZDATE1/2 SR.ARRAY
     E                    ZMDY   13  13  3 0             ZDATE1/2 SR.ARRAY
     E                    ZMNM   12  12  3               ZDATE2 SR. ARRAY
     E**********          FLDQ       12  1               Question Mark                 S01194 CGL029
     E**********          WRKARR     15  1               WORK ARRAY                    S01117 CGL029
     E                    FLDQ       35  1                                                    CGL029
     E                    WRKARR     21  1                                                    CGL029
      /COPY ZSRSRC,ZSEDITZ1
      *
      /EJECT
     I** RENAME ACCNT/ACNUMA BRANCH FIELD AVOID CORRUPTION                S01117
     I*                                                                   S01414
     I* Rename of Profit Centre to avoid overwriting                      S01414
     I*                                                                   S01414
     IACCNTTF                                                             S01117
     I              BRCA                            STBRCA                S01117
     I              PRFC                            ACPRFC                S01414
     IACCNTABF                                                            S01117
     I              BRCA                            STBRCA                S01117
     I              PRFC                            ACPRFC                S01414
      *                                                                   056032
      *  Rename fields for Payments by Booking Branch                     056032
     IINPAYDDF                                                            056032
     I              RECI                            @RECI                 056032
      *  Rename fields for Payments by Originating Branch                 056032
     IINPAYAOB                                                            056032
     I              RECI                            @RECI                 056032
      *  Rename fields for Payments by Booking Branch/Sender              056032
     IINPAYSBB                                                            056032
     I              RECI                            @RECI                 056032
      *  Rename fields for Payments by Originating Branch/Sender          056032
     IINPAYSOB                                                            056032
     I              RECI                            @RECI                 056032
      *
      *                                                                   CFT004
      *  Data Structure for AOIBANR4                                      CFT004
     IP@ACCN    E DSACCNTAB                                               CFT004
     I              CNUM                            IBCNUM                CFT004
     I              BRCA                            IBRCA                 CFT004
     I              PRFC                            IPRFC                 CFT004
      *                                                                   CFT004
      * Data structure for compilation - Copyright insertion
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *  Error reporting data structure
     ILDA         DS                            256
      *   Local data area                                                 S01194
     I**************************************134 138 @DBFIL                S01194
     I**************************************139 167 @DBKEY                S01194
     I**************************************168 175 @DBPGM                S01194
     I**************************************176 1770@DBASE                S01194
     I**************************************134 177 @DBALL                S01194
     I                                      134 141 @DBFIL                S01194
     I                                      142 170 @DBKEY                S01194
     I                                      171 180 @DBPGM                S01194
     I                                      181 1830@DBASE                S01194
     I                                      134 183 @DBALL                S01194
     I**                                                                  S01117
     I** FILE INFO DS FOR SUBFILE PROVIDES CURRENT SCREEN TOP RRN         S01117
     I*                                                                   S01117
     IDSPDS       DS                            528                       S01117
     I                                    B 378 3790SRRN                  S01117
      *  Data structure used to redefine CNUM as alpha                    S01194
     I            DS                                                      S01194
     I**********                              1   60CNUM                               S01194 CSD027
     I                                        1   6 CNUM                                      CSD027
     I                                        1   6 CNUMA                 S01194
      *
      * Data structure to setup payment reference, sub-type and
      * currency
     I*  Data structure to redefine fields in the subfile                 S01117
     I***@SFLIN*     DS                             66                                 S01117 CGL029
     I@SFLN1      DS                                                                          CGL029
     I                                        1   7 SVALD                 S01117
     I                                       10  33 SFLD24                S01117
     I                                       36  52 @AMNT                 S01117
     I**********                             55  66 @ORBC                              S01117 CGL029
     I                                       11  13 @SBRCH                S01117
     I                                       15  44 @SBRNM                S01117
     I                                       10  24 @PREF                 S01117
     I                                       27  28 @SUBT                 S01117
     I                                       30  33 @CCY                  S01117
      *                                                                                       CGL029
     I@SFLN2      DS                                                                          CGL029
     I                                        1  21 @ORBC                                     CGL029
      *   DATA STRUCTURE TO CHECK IF @SDEST ENTERED AS FULL ACC           S01117
     I*@SDEST******DS***                          20                S01117003357
     I@SDEST      DS                             35                       003357
     I**********                              1   60ACNTCN                             S01117 CSD027
     I                                        1   6 ACNTCN                                    CSD027
     I                                        7   9 ACNTCY                S01117
     I                                       10  190ACNTAC                                    CGL029
     I                                       20  210ACNTAS                                    CGL029
     I                                        1  21 FULLAC                                    CGL029
     I                                       22  35 NOTFUL                                    CGL029
     I**********                             10  130ACNTAC                             S01117 CGL029
     I**********                             14  150ACNTAS                             S01117 CGL029
     I**********                              1  15 FULLAC                             S01117 CGL029
     I*****************                      16  20 NOTFUL          S01117003357
     I**********                             16  35 NOTFUL                             003357 CGL029
      *   Data structure to retrieve Rundate                              S01117
     IRUNDAT      DS                             13                       S01117
     I                                        1   7 SRUNA                 S01117
     I                                       12  12 DATF                  195352
     I                                       13  13 @MBIN                 S01117
     IZMUSER      DS                                                      S01117
      *   User / Branch data area                                         S01117
     I                                       11  13 @DBRN                 S01117
     I                                       14  16 @DPPT                 S01117
     I                                       17  17 @BANK                 S01117
      *  Program status data structure
     IPSDS       SDS
     I                                      244 253 WSID                  S01117
     I                                      254 263 USRID                 S01117
     I**************************************244 253 @JOB                  S01117
     I**************************************254 263 @USR                  S01117
     I************************************** 96 101 @CMBR                 S01117
      *  Data structure to insert variables into error message
     I@ERR        DS                             76
     I                                        6  14 @SJOB
     I************************************                                S01194
     I***Data*structure*used*as*key*to*TABTG10                            S01194
     I*@KEY12******DS*********************        12                      S01194
     I************************************    9  11 @KCCY                 S01194
     I***Data*structure*used*as*key*to*nostros - TABLETL                  S01194
     I*@KEYNO******DS*********************        12                      S01194
     I************************************    8  10 @NCCY                 S01194
     I************************************   11  12 @NOSN                 S01194
      /COPY ZSRSRC,ZSEDITZ2
      *  Data structure to strip last character from ZSEDIT output
     I            DS
     I                                        1  21 ZOUT21
     I                                        1  20 ZOUT20
     I***************************************                             S01117
     I**Data*structure*to*setup*payment*reference, sub-type and           S01117
     I**currency*****************************                             S01117
     I*@FLD24*****DS*************************    24                       S01117
     I*************************************** 1  15 @PREF                 S01117
     I***************************************18  19 @SUBT                 S01117
     I***************************************21  24 @CCY                  S01117
     I@WORD       DS                             24
     I                                        1   8 @WORD1
     I                                        9  24 @WORD2
      *
      ** Data*structure*to*get*first*20*characters*from*SND1*********     003357
      ** Data structure to get first 15 characters from SND1              003357
     ISND1        DS
     I****************                        1  20 DST120                003357
     I                                        1  15 DST15                 S01117
      *
      *
     I            DS
     I                                        1   60@DATE
     I                                        1   20DD
     I                                        3   40MM
     I                                        1   20MM1                   195352
     I                                        3   40DD1                   195352
     I                                        5   60YY
     I                                        7  13 @VALD
     I                                        7   80@DD
     I                                        9  11 @MMM
     I                                       12  130@YY
     I*                                                                   S01194
     I*                                                                   S01194
     I**   Dummy data structures to return the record accessed            S01194
     I*                                                                   S01194
     IDSFDY     E DSDSFDY                                                 S01194
     IDSSDY     E DSDSSDY                                                 S01194
     I*                                                                   S01194
     I**   External data structures to move the fields from the standing  S01194
     I**   data record into the correct fields.                           S01194
     I*                                                                   S01194
     ISDBANK    E DSSDBANKPD                                              S01194
     ISDCURR    E DSSDCURRPD                                              S01194
     ISDGELR    E DSSDGELRPD                                              S01194
     ISDBRCH    E DSSDBRCHPD                                              S01194
     ISDCUST    E DSSDCUSTPD                                              S01194
     I              QQDFAC                          QQDFA1                                    CGL029
     ISDNOST    E DSSDNOSTPD                                              S01194
     I              QQACCD                          QQACC1                                    CGL029
      *                                                                   CAP136
      ** Externally described DS for SAR details                          CAP136
     ISCSARD    E DSSCSARDPD                                              CAP136
     I              LCD                             SLCD                  CAP136
     I*                                                                   S01194
     I/COPY WNCPYSRC,FT0155I001
      /EJECT
      *
      * Initialize program
     C                     MOVEACPY@      BIS@   80
     C                     EXSR INIT
      *
      * Repeat main processing until F3 pressed
     C           *INKC     DOUEQ'1'                        B001
     C           *IN46     ANDEQ'0'                        B001
      *
      * Display/validate first screen
     C                     EXSR SELECT
      *
     C           *INKC     DOWNE'1'                        B002
     C           *INKL     ANDNE'1'
     C           *IN46     ANDNE'1'
      * Initial fill of subfile
     C  NKCNKL             EXSR SETUP
      *
      * Display/validate subfile until F3 or F12.
     C  NKCNKLN46          EXSR CONTRL
     C                     END                             E002
      *
     C                     END                             E001
      *
      * Terminate program
     C                     SETON                     LR
     C                     RETRN
      /EJECT
      *****************************************************************
      *  PLIST's, KLIST's, DEFN's etc....                             *
      *****************************************************************
      *
     C           *NAMVAR   DEFN           LDA
     C           *LIKE     DEFN @DBALL    @DBSAV
     C           *LIKE     DEFN ORBR      KORBR                           S01117
     C           *LIKE     DEFN BRCA      KBRCA                           S01117
     C           *LIKE     DEFN SMCY      KSMCY                           S01117
     C           *LIKE     DEFN SND1      KSND1                           S01117
     C           *LIKE     DEFN SLDT      KSLDT                           S01117
     C           *LIKE     DEFN PREF      KPREF                           S01117
      *********************                                               S01194
      **Key*for*chain*to*client file                                      S01194
     C***********@CLKEY****KLIST                                          S01194
     C*********************KFLD           CNUM                            S01194
     C*********************KFLD           @CHARA  1                       S01194
     C*********************                                               S01117
     C**Key*for*SETLT*to*payments file                                    S01117
     C**by*currency*(INPALL)                                              S01117
     C***********@PYKEY****KLIST                                          S01117
     C*********************KFLD           SMCY                            S01117
     C*********************KFLD           SND1                            S01117
     C*********************KFLD           SLDT                            S01117
     C*********************KFLD           PREF                            S01117
     C*********************                                               S01117
     C**Key*for*SETLT*to*payments file by sender (INPSND)                 S01117
     C***********@PYKYS****KLIST                                          S01117
     C*********************KFLD           SND1                            S01117
     C*********************KFLD           SMCY                            S01117
     C*********************KFLD           SLDT                            S01117
     C*********************KFLD           PREF                            S01117
     C*  KEY FOR CHAINING TO LF/ACCNT                                     S01117
     C           ACCNTK    KLIST                                          S01117
     C                     KFLD           ACNTCN                          S01117
     C                     KFLD           ACNTCY                          S01117
     C                     KFLD           ACNTAC                          S01117
     C                     KFLD           ACNTAS                          S01117
     C                     KFLD           ACNTBR  3                       S01117
     C*
      *                                                                   S01117
      * Key for SETLT to payments file                                    S01117
      * by currency (INPALLBB) (with booking branch)                      S01117
     C           @PYKEA    KLIST                                          S01117
     C                     KFLD           KBRCA                           S01117
     C                     KFLD           KSMCY                           S01117
     C                     KFLD           KSND1                           S01117
     C                     KFLD           KSLDT                           S01117
     C                     KFLD           KPREF                           S01117
     C* Partial key list for INPALLBB                                     S01117
     C           @PYKYA    KLIST                                          S01117
     C                     KFLD           KBRCA                           S01117
     C                     KFLD           KSMCY                           S01117
      *                                                                   S01117
      * Key for SETLT to payments file                                    S01117
      * by currency (INPALLOB) (with originating branch)                  S01117
     C           @PYKEB    KLIST                                          S01117
     C                     KFLD           KORBR                           S01117
     C                     KFLD           KSMCY                           S01117
     C                     KFLD           KSND1                           S01117
     C                     KFLD           KSLDT                           S01117
     C                     KFLD           KPREF                           S01117
     C* Partial key list for INPALLOB                                     S01117
     C           @PYKYB    KLIST                                          S01117
     C                     KFLD           KORBR                           S01117
     C                     KFLD           KSMCY                           S01117
      *                                                                   S01117
      * Key for SETLT to payments file by sender (INPSNDBB)               S01117
      * (with booking branch)                                             S01117
     C           @PYKEC    KLIST                                          S01117
     C                     KFLD           KBRCA                           S01117
     C                     KFLD           KSND1                           S01117
     C                     KFLD           KSMCY                           S01117
     C                     KFLD           KSLDT                           S01117
     C                     KFLD           KPREF                           S01117
     C* Partial key list for INPSNDBB                                     S01117
     C           @PYKYC    KLIST                                          S01117
     C                     KFLD           KBRCA                           S01117
     C                     KFLD           KSND1                           S01117
      *                                                                   S01117
      * Key for SETLT to payments file by sender (INPSNDOB)               S01117
      * (with originating branch)                                         S01117
     C           @PYKED    KLIST                                          S01117
     C                     KFLD           KORBR                           S01117
     C                     KFLD           KSND1                           S01117
     C                     KFLD           KSMCY                           S01117
     C                     KFLD           KSLDT                           S01117
     C                     KFLD           KPREF                           S01117
     C* Partial key list for INPSNDOB                                     S01117
     C           @PYKYD    KLIST                                          S01117
     C                     KFLD           KORBR                           S01117
     C                     KFLD           KSND1                           S01117
      /EJECT
      *******************************************************************
      *  INIT  Program initialization                                   *
      *******************************************************************
     C           INIT      BEGSR
      *
      * Set up fixed values
      *
     C**for*currencies*table file key                                     S01194
     C*********************MOVEL'20      '@KEY12                          S01194
     C*********************MOVE '       1'@KEY12                          S01194
     C*********************                                               S01194
     C**for*client*file*key                                               S01194
     C*********************MOVE 'A'       @CHARA                          S01194
     C*********************                                               S01194
     C**for*nostros*table*file key                                        S01194
     C*********************MOVEL'70      '@KEYNO                          S01194
      *
      * edit code for ZSEDIT subroutine
     C                     MOVE 'J'       ZECODE
      *
     C                     SETOF                     05
      *
     C**Chain*to*installation control record 1                            S01194
     C*********************MOVE *BLANK    KEY    12                       S01194
     C*********************MOVEL'01'      KEY                             S01194
     C*********************MOVE '10'      KEY                             S01194
     C***********KEY*******CHAINTABTB10F             88                   S01194
     C**N88******RECI******COMP 'D'                  8888                 S01194
     C***88****************DO                              B001           S01194
     C*********************MOVE 'TABFP'   @DBFIL           ***************S01194
     C*********************Z-ADD1         @DBASE           * DB ERROR 01 *S01194
     C*********************MOVELKEY       @DBKEY           ***************S01194
     C*********************END                             E001           S01194
     C*                                                                   S01194
     C                     CALL 'AOBANKR0'                                S01194
     C                     PARM '*DBERR'  @RTCD   7                       S01194
     C                     PARM '*FIRST'  @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C           *NAMVAR   DEFN           RUNDAT                          S01194
     C                     IN   RUNDAT                                    S01194
     C*                                                                   S01117
     C** Setup run date                                                   S01117
     C*                                                                   S01117
     C                     MOVE BJMRDT    SRUNA                           S01117
     C                     TIME           TIME                            S01117
     C*                                                                   S01117
     C** If multi branched set on indicator to display branch field.      S01117
     C** Else move single branch code to @BRCA                            S01117
     C*                                                                   S01117
     C           @MBIN     IFEQ 'Y'                        B001           S01117
     C                     SETON                     43                   S01117
     C                     ELSE                            X001           S01117
     C                     SETON                     16                   S01117
     C                     END                             E001           S01117
     C*                                                                   S01117
     C** If multi branched call AOGELRR0 and retrieve ZMUSER              S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '1'                        B001           S01117
     C**********           CALL 'AOGELRR0'                                S01194              CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR'  @RTCD   7                       S01194
     C                     PARM '*FIRST'  @OPTN   7                       S01194
     C********** SDGELR    PARM SDGELR    DSFDY                           S01194              CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*                                                                   S01117
     C           BKOBRU    IFEQ 'Y'                        B002           S01117
     C                     SETON                     08                   S01117
     C                     END                             E002           S01117
     C*                                                                   S01117
      *** Check if CFT004 is switched on                                  CFT004
      *                                                                   CFT004
     C                     CALL 'AOSARDR0'                                CFT004
     C                     PARM '       ' @RTCD   7                       CFT004
     C                     PARM '*VERIFY' @OPTN                           CFT004
     C                     PARM 'CFT004'  @SARD   6                       CFT004
      *                                                                   CFT004
     C           @RTCD     IFEQ *BLANK                                    CFT004
     C                     MOVE 'Y'       CFT004  1                       CFT004
     C                     ELSE                                           CFT004
     C                     MOVE 'N'       CFT004                          CFT004
     C                     ENDIF                                          CFT004
      *                                                                   CAP136
      ** Access SAR file to determine if CAP136 (New Maint.               CAP136
      ** Funct - Incoming Payments) is installed.                         CAP136
      *                                                                   CAP136
     C                     CALL 'AOSARDR0'                                CAP136
     C                     PARM *BLANKS   @RTCD                           CAP136
     C                     PARM '*VERIFY' @OPTN                           CAP136
     C                     PARM 'CAP136'  @SARD                           CAP136
     C           SCSARD    PARM SCSARD    DSFDY                           CAP136
      *                                                                   CAP136
      ** An NRF (No Record Found) return code is valid.                   CAP136
      ** Issue database error only for error return codes.                CAP136
      *                                                                   CAP136
     C           @RTCD     IFNE *BLANKS                                   CAP136
     C           @RTCD     ANDNE'*NRF   '                                 CAP136
     C                     MOVEL'CAP136'  @DBKEY                          CAP136
     C                     MOVEL'SCSARDPD'@DBFIL                          CAP136
     C                     Z-ADD14        @DBASE                          CAP136
     C                     EXSR DBERR                                     CAP136
     C                     ENDIF                                          CAP136
      *                                                                   CAP136
     C           @RTCD     IFEQ *BLANK                                    CAP136
     C                     MOVEL'Y'       CAP136  1                       CAP136
     C                     MOVEL'FTIPAY'  PPGM   10                       CAP136
     C                     MOVE 'SIN '    PPGM                            CAP136
     C                     ELSE                                           CAP136
     C                     MOVEL'N'       CAP136                          CAP136
     C                     MOVE *BLANKS   PPGM                            CAP136
     C                     ENDIF                                          CAP136
      *                                                                   CFT004
     C           *NAMVAR   DEFN           ZMUSER           get DBRN       S01117
     C                     IN   ZMUSER                                    S01117
     C                     UNLCKZMUSER                                    S01117
     C                     END                             E001           S01117
      *
      *  Setup value date total literal
     C                     MOVE 'Value da'@WORD1
     C                     MOVEL'te total'@WORD2
     C/COPY WNCPYSRC,FT0155C001
      *
     C                     ENDSR                           INIT  ends
      /EJECT
      *******************************************************************
      *  SELECT - Display and validate first screen                     *
      *******************************************************************
     C           SELECT    BEGSR
      *
      * Clear input fields/initialise indicators
     C           *IN46     IFEQ '0'                        B001
     C                     MOVE *BLANKS   @SCCY
     C                     MOVE *BLANKS   @SDEST
     C                     MOVE *BLANKS   @SAUTH
     C                     MOVE *BLANKS   @SVALD
     C*********************MOVE  BLANKS   @FLD24                          S01117
     C                     MOVE *BLANKS   SFLD24                          S01117
     C                     MOVE *BLANKS   @ORBC
     C                     MOVE *BLANKS   @BRCA                           S01117
     C                     MOVE *BLANKS   @BORO                           S01117
     C                     SETOF                     50
     C                     SETOF                     77                   S01117
     C                     END                             E001
      *                                                                   S01117
     C                     SETOF                     78                   S01117
     C*                                                                   S01117
     C**IF SINGLE BRANCHED SET UP SCREEN FIELD WITH SINGLEBRANCH          S01117
     C*                                                                   S01117
     C           *IN43     IFNE '1'                        B001           S01117
     C                     MOVE BJSBRC    @BRCA                           S01117
     C                     END                             E001           S01117
      *
     C                     SETOF                     232425
     C                     SETOF                     262829
     C                     SETOF                     4446
     C                     SETOF                       5152
     C                     SETOF                     535452
     C                     SETOF                     60
     C                     SETOF                     5556                 S01117
     C                     SETOF                     181920               S01117
     C                     SETOF                     21                   S01117
      *
      * Do until no errors or CMD/1 or CMD/5
      *
     C           *IN50     DOUEQ'0'                        B001
     C           *INKC     OREQ '1'
     C           *INKL     OREQ '1'
      *
     C                     SETON                     30
      *
     C                     WRITEFT0155F2
     C                     WRITEFT0155F1
      *
     C**         *IN22     DOUEQ'0'                        B002           S01199
      *
     C                     READ FT0155F1                 01
      *
     C**         *IN22     IFEQ '1'                        B003           S01199
     C**                   CALL 'MHELP'                                   S01199
     C**                   PARM 'FT0000  '@ERPGM  8                       S01199
     C**                   PARM           @EA                             S01199
      *
     C**         *IN01     IFEQ '1'                        B004           S01199
     C**                   Z-ADD11        @DBASE           ***************S01199
     C**                   MOVEL*BLANKS   @DBFIL           * DB ERROR 11 *S01199
     C**                   MOVEL'MHELP'   @DBKEY           ***************S01199
     C**                   EXSR DBERR                                     S01199
     C**                   END                             E004           S01199
      *
     C**                   END                             E003           S01199
     C**                   END                             E002           S01199
      *
     C           IGINT     TAG                                            S01194
     C           *INKC     IFNE '1'                        B002
     C           *INKL     ANDNE'1'
      *                                                                   S01194
      ** Resolve ?'s before validation                                    S01194
      *                                                                   S01194
     C           *IN15     DOUEQ'0'                        B003           S01194
     C                     SETOF                     50    ERCD LINE 1    S01194
     C                     EXSR FLDQRY                                    S01194
     C           *INKC     IFEQ '1'                        B004           S01194
     C                     SETON                     LR                   S01194
     C                     RETRN                                          S01194
     C                     END                             E004           S01194
     C           *INKL     CABEQ'1'       IGINT                           S01194
     C                     END                             E003           S01194
     C*                                                                   S01194
      *
      * Perform validation
     C                     SETOF                     505152
     C                     SETOF                     5354
     C                     SETOF                     5556                 S01117
     C                     SETOF                     181920               S01117
     C                     SETOF                     216016               S01117
     C                     MOVE *BLANKS   @EA
     C                     Z-ADD1         I       30
      *
      * Currency
     C*********************                                               S01194
     C           @SCCY     IFNE *BLANKS                    B003
     C*********************MOVEL@SCCY     @KCCY                           S01194
     C***********@KEY12****CHAINTABTG10F             01                   S01194
     C*********************                                               S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM *BLANKS   @RTCD   7                       S01194
     C                     PARM '*KEY'    @OPTN   7                       S01194
     C                     PARM @SCCY     P@K101  3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C           @RTCD     COMP *BLANKS              0101                 S01194
     C*                                                                   S01194
     C           *IN01     IFEQ '1'                        B004
     C***********RECI******OREQ '*'                                       S01194
     C                     SETON                     5051
     C*********************MOVEL' 398'    @EA,I                           S01117
     C                     MOVEL' 001'    @EA,I                           S01117
     C                     ADD  1         I
     C** ELSE SETON 19 IF SENDER ALSO NOT BLANK                           S01117
     C                     ELSE                            X004           S01117
     C           @SDEST    IFNE *BLANKS                                   S01117
     C                     SETON                     19                   S01117
     C                     END                                            S01117
     C                     END                             E004
     C*
     C** IF CURRENCY IS BLANK AND SENDER IS NOT, A DIFFERENT LOGICAL
     C** IS USED TO CHAIN TO WHICH IS KEYED IN SENDER,CURRENCY ORDER
     C*
     C*********************ELSE                            X003           S01117
     C                     END                             E003           S01117
     C           @SDEST    IFNE *BLANKS                    B003
     C                     MOVE '1'       *IN60
     C                     END                             E003
     C*********************END                             E003           S01117
     C*                                                                   S01117
     C           @SDEST    IFEQ *BLANKS                                   S01117
     C           @SCCY     ANDEQ*BLANKS                                   S01117
     C                     SETON                     18                   S01117
     C                     END                                            S01117
     C**                                                                  S01117
     C           @BRCA     IFEQ 'ALL'                                     S01117
     C                     SETON                     20                   S01117
     C                     END                                            S01117
     C**                                                                  S01117
     C**IF CCY AND DEST NON BLANK,BRANCH=ALL AND MBIN OR NOT MBIN         S01117
     C**SETON INDICATOR 21 TO DISABLE F8 ON SCREEN                        S01117
     C**                                                                  S01117
     C           *IN19     IFEQ '1'                                       S01117
     C           *IN20     IFEQ '0'                                       S01117
     C           *IN43     ANDEQ'1'                                       S01117
     C           *IN43     OREQ '0'                                       S01117
     C                     SETON                     21                   S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *
      * Destination - no validation
      *
      * Authorised indicator
     C           @SAUTH    IFNE ' '                        B003
     C           @SAUTH    IFNE 'Y'                        B004
     C           @SAUTH    ANDNE'N'
     C           @SAUTH    ANDNE'B'
     C                     SETON                     5053
     C*********************MOVEL' 399'    @EA,I                           S01117
     C                     MOVEL' 004'    @EA,I                           S01117
     C                     ADD  1         I
     C                     END                             E004
     C                     ELSE                            X003
     C                     MOVE 'Y'       @SAUTH
     C                     END                             E003
      *
      * Start value date
      *
     C           @SVALD    IFEQ *BLANKS                    B003
      *
      * Start value defaults to run date
      *
     C*********************Z-ADDRUND      ZDAYNO                          S01194
     C                     Z-ADDBJRDNB    ZDAYNO                          S01194
     C*********************Z-ADDRUND      @SVDP   50                      S01194
     C                     Z-ADDBJRDNB    @SVDP   50                      S01194
     C                     SETOF                     98
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     @SVALD
     C                     ELSE                            X003
     C                     MOVEL@SVALD    DATEL   70
     C                     MOVELDATEL     DATES   6
      *
      * Check date is numeric
     C           @SVALD    IFNE DATES                      B004
     C                     SETON                     5054
     C*********************MOVEL' 400'    @EA,I                           S01117
     C                     MOVEL' 005'    @EA,I                           S01117
     C                     ADD  1         I
     C                     ELSE                            X004
     C                     MOVE @SVALD    ZDATE
     C                     SETOF                     98
     C                     EXSR ZDATE1
     C           *IN99     IFEQ '1'                        B005
     C                     SETON                     5054
     C*********************MOVEL' 400'    @EA,I                           S01117
     C                     MOVEL' 005'    @EA,I                           S01117
     C                     ADD  1         I
     C                     ELSE                            X005
     C                     Z-ADDZDAYNO    @SVDP
     C                     END                             E005
     C                     END                             E004
      *
     C                     END                             E003
     C*                                                                   S01117
     C*    Branch Processing                                              S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '1'                        B003           S01117
     C*                                                                   S01117
     C*    Validation of Branch                                           S01117
     C*                                                                   S01117
     C           @BRCA     IFEQ 'ALL'                      B004           S01117
     C           @BANK     IFNE 'Y'                        B005           S01117
     C                     SETON                     5055                 S01117
     C                     MOVEL' 002'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C           @BRCA     IFEQ *BLANKS                    B004           S01117
     C                     MOVE @DBRN     @BRCA                           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B004           S01117
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*KEY'    @OPTN   7                       S01117
     C                     PARM @BRCA     P@BRCD  3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS                    B005           S01117
     C                     SETON                     5055  (error)        S01117
     C                     MOVEL' 003'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C*    Originating/Booking indicator processing                       S01117
     C           @BORO     COMP 'B'                      16               S01117
     C           @BORO     COMP 'O'                      17               S01117
     C           @BORO     IFEQ *BLANKS                    B004           S01117
     C                     MOVE 'B'       @BORO                           S01117
     C                     SETON                     16                   S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C           @BORO     IFNE 'B'                        B004           S01117
     C           @BORO     ANDNE'O'                                       S01117
     C                     SETON                     5056                 S01117
     C                     MOVEL' 006'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B004           S01117
     C           @BORO     ANDEQ'B'                                       S01117
     C                     CALL 'ZVBBU'                                   S01117
     C                     PARM @BRCA     ZBRCDX  3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B005           S01117
     C           ERR       IFEQ 1                          B006           S01117
     C                     MOVEL' 307'    @EA,I                           S01117
     C                     ELSE                            X006           S01117
     C                     MOVEL' 308'    @EA,I                           S01117
     C                     END                             E006           S01117
     C                     SETON                     5055                 S01117
     C                     ADD  1         I                               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B004           S01117
     C           @BORO     ANDEQ'O'                                       S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM @BRCA     ZOBRX   3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B005           S01117
     C           ERR       IFEQ 1                          B006           S01117
     C                     SETON                     5055                 S01117
     C                     MOVEL' 305'    @EA,I                           S01117
     C                     ELSE                            X006           S01117
     C                     SETON                     5055                 S01117
     C                     MOVEL' 306'    @EA,I                           S01117
     C                     END                             E006           S01117
     C                     ADD  1         I                               S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C                     END                             E004           S01117
     C** ELSE FOR MB=N CAUSE INPSNDBB TO BE READ                          S01117
     C                     ELSE                                           S01117
     C                     SETON                     16                   S01117
     C*                                                                   S01117
     C*                                                                   S01117
     C                     END                             E003           S01117
      *
      * Errors ?
     C   50                MOVEA@EA,1     @ERR
      *
     C                     END                             E002
      *
     C                     END                             E001
     C                     ENDSR                           SELECT ends
      *
      /EJECT
      *******************************************************************
      *  SETUP  - Set up subfile                                        *
      *******************************************************************
      /EJECT
     C           SETUP     BEGSR
      *
      * Protect initial screen fields, clear s/file
      *
     C                     SETOF                       2430
     C                     SETOF                     2629
     C                     SETOF                     44
     C                     SETON                     2325
     C                     SETOF                     75                   S01117
     C                     MOVE *BLANKS   SAVEB                           S01117
      *
      **  Check whether shortname entered, and if so, use customer no.
      *
     C*********************                                               S01194
     C*********************MOVEL@SDEST    SKEY   10                       S01194
     C***********SKEY******CHAINSNAMEF               07                   S01194
     C** IF NO ? ENTERED                                                  S01194
     C                     MOVEA*BLANKS   FLDQ                            S01194
     C                     MOVEA@SDEST    FLDQ                            S01194
     C           '?'       LOKUPFLDQ                     88               S01194
     C           *IN88     IFNE '1'                        B001           S01194
      *                                                                   S01194
     C                     CALL 'AOCUSTR0'                                S01194
     C                     PARM *BLANKS   @RTCD   7                       S01194
     C                     PARM '*KEY'    @OPTN   7                       S01194
     C                     PARM @SDEST    KEY1   10                       S01194
     C                     PARM *BLANKS   KYST    7                       S01194
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
     C*                                                                   S01194
     C           @RTCD     COMP *BLANKS              0707                 S01194
     C           *IN07     IFEQ '0'                        B002
     C                     MOVE *BLANKS   @SDEST
     C                     MOVE BBCUST    CNUMA                           S01194
     C                     MOVELBBCUST    @SDEST                          S01194
     C*********************MOVELCNUM      @SDEST                          S01194
     C                     END                             E002
     C                     END                             E001           S01194
      *
     C                     Z-ADD1         @SFREC
     C                     Z-ADD1         @SFK    50
     C                     WRITEFT0155F1
      *
      * Fill the s/file from the payments awaiting authorisation file
      *
      ** Note that indicator 60 on will cause program to use INPSND
      ** Rather than INPALL.
     C*********************                                               S01117
     C**NKH****************MOVE *LOVAL    PREF                            S01117
     C***KH****************MOVE *HIVAL    PREF                            S01117
     C*********************MOVE @SCCY     SMCY                            S01117
     C**NKH****************MOVE @SVDP     SLDT                            S01117
     C***KH****************Z-ADD99999     SLDT                            S01117
     C*********************MOVE *BLANK    SND1                            S01117
     C**NKH****************MOVEL@SDEST    SND1                            S01117
     C***KH****************MOVEL@DST1     SND1                            S01117
     C**N60******@PYKEY****SETLLINPALL                   01               S01117
     C***60******@PYKYS****SETLLINPSND                   01               S01117
     C**N60****************READ INPAYDDF                 01               S01117
     C***60****************READ INPAYDSF                 01               S01117
     C**N01****************MOVE @SVDP     SLDT                            S01117
     C**N01N60***@PYKEY****SETLLINPALL                   01               S01117
     C**N01*60***@PYKYS****SETLLINPSND                   01               S01117
     C***********RREAD1****TAG                                            S01117
     C**N60****************READ INPAYDDF                 01               S01117
     C***60****************READ INPAYDSF                 01               S01117
     C*********************                                               S01117
     C*                                                                   S01117
     C** FIRST TIME ROUND POSITION TO VALID RECORD                        S01117
     C**                                                   B001           S01117
     C           *INKH     IFEQ '0'                                       S01117
     C                     EXSR POSSET                                    S01117
     C                     EXSR INPONE                                    S01117
     C                     ELSE                            X001           S01117
     C*                                                                   S01117
     C** IF F8                                                            S01117
     C           *IN60     IFEQ '0'                        B002           S01117
     C           *IN18     ANDEQ'0'                                       S01117
     C                     EXSR PALSET                                    S01117
     C                     ELSE                            X002           S01117
     C                     EXSR SNDSET                                    S01117
     C                     END                             E002           S01117
     C                     END                             E001           S01117
     C*                                                                   S01117
     C           *IN01     IFNE '1'                        B001
     C                     MOVE SND1      @DST1  35                       S01117
     C                     MOVE SMCY      @SCCY                           S01117
     C*                                                                   S01117
     C** IF SINGLE BRANCHED AND SENDER IS FULL ACCOUNT LOSE BRANCH        S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '0'                        B002           S01117
     C           SNTP      ANDEQ'G'                                       S01117
     C**********           MOVELSND1      WRK15  15                                    S01117 CGL029
     C                     MOVELSND1      WRK15  21                                           CGL029
     C                     MOVE *BLANKS   @SDEST                          S01117
     C                     MOVELWRK15     @SDEST                          S01117
     C                     ELSE                            X002           S01117
     C                     MOVELSND1      @SDEST                          S01117
     C                     END                             E002           S01117
     C                     END                             E001           S01117
      *
     C**Value*date*cannot*be less than start value date                   S01117
     C***********SLDT******IFLT @SVDP                                     S01117
     C*********************GOTO RREAD1                                    S01117
     C*********************END                                            S01117
     C*********************                                               S01117
     C**Authorisation*indicator must match                                S01117
     C***********@SAUTH****IFNE 'B'                                       S01117
     C***********@SAUTH****IFEQ 'N'                                       S01117
     C***********AUIN******ANDEQ'Y'                                       S01117
     C***********@SAUTH****OREQ 'Y'                                       S01117
     C***********AUIN******ANDNE'Y'                                       S01117
     C*********************GOTO RREAD1                                    S01117
     C*********************END                                            S01117
     C*********************END                                            S01117
     C*********************                                               S01117
     C**Payment*must*match*specified criteria                             S01117
     C*********************                                               S01117
     C**Currency*must*match if entered                                    S01117
     C***********@SCCY*****IFNE *BLANKS                                   S01117
     C************INKH*****ANDEQ'0'                                       S01117
     C***********SMCY******IFNE @SCCY                                     S01117
     C*********************SETON                     01                   S01117
     C*********************END                                            S01117
     C*********************ELSE                                           S01117
     C*********************MOVE SMCY      @SCCY                           S01117
     C*********************END                                            S01117
     C*********************                                               S01117
     C**Destination*must*match if entered                                 S01117
     C***********@SDEST****IFNE *BLANKS                                   S01117
     C************INKH*****ANDEQ'0'                                       S01117
     C***********DST120****IFNE @SDEST                                    S01117
     C*********************SETON                     01                   S01117
     C*********************END                                            S01117
     C*********************ELSE                                           S01117
     C*********************MOVE DST120    @SDEST                          S01117
     C*********************END                                            S01117
     C*********************                                               S01117
     C*********************END                                            S01117
      *
      * If no payments awaiting authorisation, output message, else
      * fill the subfile with payments
     C           *IN01     IFEQ '1'                        B001           S01117
     C*                                                                   S01117
     C** IF NOT F8                                                        S01117
     C           *INKH     IFEQ '0'                        B002           S01117
     C** IF NOT AUTHORISED                                                S01117
     C           *IN83     IFEQ '1'                        B003           S01117
     C                     MOVEA@AT,1     @EA,1                           S01117
     C                     ELSE                            X003           S01117
     C                     MOVEA@TX,1     @EA,1                           S01117
     C                     END                             E003           S01117
     C                     ELSE                            X002           S01117
     C** IF F8                                                            S01117
     C** IF NOT AUTHORISED                                                S01117
     C           *IN83     IFEQ '1'                        B003           S01117
     C                     MOVEA@FT,1     @EA,1                           S01117
     C                     ELSE                            X003           S01117
     C                     MOVEA@TS,1     @EA,1                           S01117
     C                     END                             E003           S01117
     C                     END                             E002           S01117
     C**NKH****************MOVEA@TX,1     @EA,1                           S01117
     C***KH****************MOVEA@TS,1     @EA,1                           S01117
     C                     MOVEA@EA,1     @ERR
     C                     SETON                     5046
     C                     ELSE                            X001
     C                     Z-ADDSMAM      @TOTAL 130
     C                     EXSR SFFILL
     C                     Z-ADD@SFK      @SFR    40
     C                     Z-ADD*ZERO     @SFSTR  40                      S01117
      *
      * Initial fields are now to be protected
     C                     SETON                     28
      *
     C                     END                             E001
      *
      * Subfile now full
     C                     SETOF                     23
     C                     SETON                     30
      *
      *
     C                     ENDSR                           SETUP  ends
      /EJECT
     C******************************************************************* S01117
     C*  POSSET - SETUP INITIAL KEY FIELD VALUES                        * S01117
     C******************************************************************* S01117
     C           POSSET    BEGSR                                          S01117
     C*                                                                   S01117
     C                     SETOF                     80                   S01117
     C** IF ALL SELECTED OBTAIN FIRST BRANCH RECORD                       S01117
     C*                                                                   S01117
     C           @BRCA     IFEQ 'ALL'                      B001           S01117
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*DBERR'  @RTCD   7                       S01117
     C                     PARM '*FIRST'  @OPTN   7                       S01117
     C                     PARM *BLANKS   P@BRCD  3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C                     MOVE A8BRCD    KBRCA                           S01117
     C                     MOVE A8BRCD    KORBR                           S01117
     C                     ELSE                            X001           S01117
     C*                                                                   S01117
     C* ELSE USE RESPECTIVE SCREEN FIELD                                  S01117
     C*                                                                   S01117
     C**BOOK                                                              S01117
     C           *IN16     IFEQ '1'                        B002           S01117
     C                     MOVE @BRCA     KBRCA                           S01117
     C                     END                             E002           S01117
     C**ORIG                                                              S01117
     C           *IN17     IFEQ '1'                        B002           S01117
     C                     MOVE @BRCA     KORBR                           S01117
     C                     END                             E002           S01117
     C                     END                             E001           S01117
     C**                                                                  S01117
     C**SET UP CORRECT KEY IF SENDER ENTERED AS FULL ACCOUNT AND MB=N     S01117
     C           *IN43     IFEQ '0'                        B001           S01117
     C           NOTFUL    ANDEQ*BLANKS                                   S01117
     C                     MOVEA*BLANKS   WRKARR                          S01117
     C                     MOVEAFULLAC    WRKARR                          S01117
     C           *BLANK    LOKUPWRKARR                   81               S01117
      *                                                                   S01117
     C           *IN81     IFNE '1'                        B002           S01117
     C                     MOVE BJSBRC    ACNTBR                          S01117
     C           ACCNTK    CHAINACCNTTF              8181                 S01117
      *                                                                   S01117
     C           *IN81     IFNE '1'                        B003           S01117
     C                     SETON                     80                   S01117
     C**********           MOVE *BLANKS   WRK18  18                                    S01117 CGL029
     C                     MOVE *BLANKS   WRK18  24                                           CGL029
     C                     MOVELFULLAC    WRK18                           S01117
     C                     MOVE BJSBRC    WRK18                           S01117
     C                     MOVE *BLANKS   KSND1                           S01117
     C                     MOVELWRK18     KSND1                           S01117
     C                     END                             E003           S01117
      *                                                                   S01117
     C                     END                             E002           S01117
      *                                                                   S01117
     C                     END                             E001           S01117
      *                                                                   S01117
     C** SET UP ORIGINAL KEY FIELD VALUES                                 S01117
     C*                                                                   S01117
     C                     MOVE *LOVAL    KPREF                           S01117
     C                     MOVE @SCCY     KSMCY                           S01117
     C                     MOVE @SVDP     KSLDT                           S01117
      *                                                                   S01117
     C           *IN80     IFNE '1'                        B001           S01117
     C                     MOVE *BLANKS   KSND1                           S01117
     C                     MOVEL@SDEST    KSND1                           S01117
     C                     END                             E001           S01117
      *                                                                   S01117
     C                     ENDSR                           POSONE ends    S01117
     C/EJECT                                                              S01117
     C******************************************************************* S01117
     C*INPONE - POSITION FILE TO VALID INPALBB/OB OR INPSNDBB/OB RECORD * S01117
     C******************************************************************* S01117
     C**                                                                  S01117
     C           INPONE    BEGSR                                          S01117
     C*                                                                   S01117
     C** SETOFF VALIDATION ERROR INDICATOR                                S01117
     C*                                                                   S01117
     C                     SETOF                     8283                 S01117
     C*                                                                   S01117
     C** PERFORM INITIAL SET LOWER LIMIT                                  S01117
     C**                                                                  S01117
     C** IF INPALLBB/OB TYPE RECORD - Booking/Originating Branch          S01117
     C**                                                                  S01117
     C           *IN60     IFEQ '0'                        B001           S01117
     C           *IN18     ANDNE'1'                                       S01117
     C*BOOK                                                               S01117
     C           *IN16     IFEQ '1'                        B002           S01117
     C           @PYKEA    SETLLINPALLBB                 01               S01117
     C                     END                             E002           S01117
     C*ORIG                                                               S01117
     C           *IN17     IFEQ '1'                        B002           S01117
     C           @PYKEB    SETLLINPALLOB                 01               S01117
     C                     END                             E002           S01117
     C*                                                                   S01117
     C** ELSE INPSNDBB/OB RECORD - Booking/Originating and Sender         S01117
     C*                                                                   S01117
     C                     ELSE                            X001           S01117
     C*BOOK                                                               S01117
     C           *IN16     IFEQ '1'                        B002           S01117
     C           @PYKEC    SETLLINPSNDBB                 01               S01117
     C                     END                             E002           S01117
     C*ORIG                                                               S01117
     C           *IN17     IFEQ '1'                        B002           S01117
     C           @PYKED    SETLLINPSNDOB                 01               S01117
     C                     END                             E002           S01117
     C*                                                                   S01117
     C                     END                             E001           S01117
     C*                                                                   S01117
     C*  Read all matching payments                                       S01117
     C**                                                                  S01117
     C** PERFORM UNTIL EITHER INVALID OR END OF POSSIBLE BRANCHES         S01117
     C**                                                                  S01117
     C           *IN78     DOUEQ'1'                        B001           S01117
     C                     SETON                     78                   S01117
     C*                                                                   S01117
     C           *IN77     DOUEQ'0'                        B002           S01117
     C                     SETOF                     77                   S01117
     C*                                                                   S01117
     C** IF INPALLBB/OB TYPE RECORD - Booking/Originating Branch          S01117
     C*                                                                   S01117
     C           *IN60     IFEQ '0'                        B003           S01117
     C           *IN18     ANDNE'1'                                       S01117
     C*                                                                   S01117
     C**BOOKING                                                           S01117
     C           *IN16     IFEQ '1'                        B004           S01117
     C           @PYKYA    READEINPALLBB                 01               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C**ORIGINATING                                                       S01117
     C           *IN17     IFEQ '1'                        B004           S01117
     C           @PYKYB    READEINPALLOB                 01               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* ELSE INPSND RECORD - Booking/Originating and Sender               S01117
     C*                                                                   S01117
     C                     ELSE                            X003           S01117
     C*                                                                   S01117
     C**BOOKING                                                           S01117
     C*                                                                   S01117
     C           *IN16     IFEQ '1'                        B004           S01117
     C*                                                                   S01117
     C           *IN18     IFNE '1'                                       S01117
     C           @PYKYC    READEINPSNDBB                 01               S01117
     C                     ELSE                                           S01117
     C           KBRCA     READEINPSNDBB                 01               S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C**ORIGINATING                                                       S01117
     C*                                                                   S01117
     C           *IN17     IFEQ '1'                        B004           S01117
     C*                                                                   S01117
     C           *IN18     IFNE '1'                                       S01117
     C           @PYKYD    READEINPSNDOB                 01               S01117
     C                     ELSE                                           S01117
     C           KORBR     READEINPSNDOB                 01               S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
     C**IF FOUND VALIDATE                                                 S01117
     C*                                                                   S01117
     C           *IN01     IFEQ '0'                        B003           S01117
     C*                                                                   S01117
     C**  Insert selection criteria                                       S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '1'                        B004           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B005           S01117
     C           @BORO     ANDEQ'B'                                       S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM ORBR      ZOBRX   3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B006           S01117
     C                     SETON                     770182               S01117
     C                     ELSE                            X006           S01117
     C                     SETOF                         82               S01117
     C                     END                             E006           S01117
     C*                                                                   S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B005           S01117
     C           @BORO     ANDEQ'O'                                       S01117
     C                     CALL 'ZVBBU'                                   S01117
     C                     PARM BRCA      ZBRCDX  3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B006           S01117
     C                     SETON                     770182               S01117
     C                     ELSE                            X006           S01117
     C                     SETOF                         82               S01117
     C                     END                             E006           S01117
     C*                                                                   S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C*                                                                   S01117
     C* Value date cannot be less than start value date                   S01117
     C           SLDT      IFLT @SVDP                      B004           S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* Authorisation indicator must match                                S01117
     C           @SAUTH    IFNE 'B'                        B004           S01117
     C           @SAUTH    IFEQ 'N'                        B005           S01117
     C           AUIN      ANDEQ'Y'                                       S01117
     C           @SAUTH    OREQ 'Y'                                       S01117
     C           AUIN      ANDNE'Y'                                       S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* IF NO PREVIOUS VALIDATION ERROR                                   S01117
     C*                                                                   S01117
     C           *IN01     IFNE '1'                        B004           S01117
     C*                                                                   S01117
     C* Sender must match if entered                                      S01117
     C*                                                                   S01117
     C           @SDEST    IFNE *BLANKS                    B005           S01117
     C*                                                                   S01117
     C** IF NON MBIN AND SENDER IS FULL ACC REMOVE BRANCH FROM END        S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '0'                        B006           S01117
     C           SNTP      ANDEQ'G'                                       S01117
     C*                                                                   S01117
     C           DST15     IFNE @SDEST                     B007           S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E007           S01117
     C*                                                                   S01117
     C                     ELSE                            X006           S01117
     C*                                                                   S01117
     C***********DST120****IFNE @SDEST                     B007     S01117003357
     C           SND1      IFNE @SDEST                     B007           003357
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E007           S01117
     C*                                                                   S01117
     C                     END                             E006           S01117
     C*                                                                   S01117
     C* CURRENCY MUST MATCH IF ENTERED                                    S01117
     C*                                                                   S01117
     C           @SCCY     IFNE *BLANKS                                   S01117
     C           SMCY      ANDNE@SCCY                                     S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E007           S01117
     C*                                                                   S01117
     C                     ELSE                            X005           S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '0'                        B006           S01117
     C           SNTP      ANDEQ'G'                                       S01117
     C                     MOVE *BLANKS   @SDEST                          S01117
     C                     MOVELDST15     @SDEST                          S01117
     C                     ELSE                            X006           S01117
     C*********************MOVE DST120    @SDEST                    S01117003357
     C                     MOVELSND1      @SDEST                    S01117003357
     C                     END                             E006           S01117
     C*                                                                   S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
     C** IF RECORD INVALID BECAUSE OF AUTHORITY PROBLEM                   S01117
     C*                                                                   S01117
     C           *IN82     IFEQ '1'                        B003           S01117
     C                     SETON                     83                   S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
     C                     END                             E002           S01117
     C*                                                                   S01117
     C** IF NOT VALID AND 'ALL' TRY NEW BRANCH                            S01117
     C*                                                                   S01117
     C*                                                                   S01117
     C           *IN01     IFEQ '1'                        B002           S01117
     C           @BRCA     ANDEQ'ALL'                                     S01117
     C                     SETOF                     0178                 S01117
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*NEXT'   @OPTN   7                       S01117
     C                     PARM *BLANKS   P@BRCD  3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                    B003           S01117
     C                     SETON                     0178                 S01117
     C                     ELSE                            X003           S01117
     C                     SETOF                       82                 S01117
     C** BOOKING                                                          S01117
     C           *IN16     IFEQ '1'                        B004           S01117
     C                     MOVE A8BRCD    KBRCA                           S01117
     C**INPALL RECORD                                                     S01117
     C*                                                                   S01117
     C           *IN60     IFEQ '0'                        B005           S01117
     C** AND BOTH CURRENCY AND SENDER NOT BLANK                           S01117
     C*                                                                   S01117
     C           *IN18     ANDNE'1'                                       S01117
     C           @PYKEA    SETLLINPALLBB                 01               S01117
     C**INPSND RECORD                                                     S01117
     C                     ELSE                            X005           S01117
     C           @PYKEC    SETLLINPSNDBB                 01               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C**ORIGINATING                                                       S01117
     C           *IN17     IFEQ '1'                        B004           S01117
     C                     MOVE A8BRCD    KORBR                           S01117
     C**INPALL RECORD                                                     S01117
     C*                                                                   S01117
     C           *IN60     IFEQ '0'                        B005           S01117
     C** AND BOTH CURRENCY AND SENDER NOT BLANK                           S01117
     C*                                                                   S01117
     C           *IN18     ANDNE'1'                                       S01117
     C           @PYKEB    SETLLINPALLOB                 01               S01117
     C**INPSND RECORD                                                     S01117
     C                     ELSE                            X005           S01117
     C           @PYKED    SETLLINPSNDOB                 01               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C                     END                             E003           S01117
     C                     END                             E002           S01117
     C                     END                             E001           S01117
     C                     ENDSR                            IMPONE END    S01117
     C******************************************************************* S01117
     C*PALSET- POSITION FILE INPALBB/OB AFTER F8                        * S01117
     C******************************************************************* S01117
     C**                                                                  S01117
     C           PALSET    BEGSR                                          S01117
     C** SETOFF VALIDATION ERROR INDICATOR                                S01117
     C                     SETOF                     8283                 S01117
     C**                                                                  S01117
     C** SET UP KEY VALUES USING LAST VALID SENDER                        S01117
     C**                                                                  S01117
     C                     MOVE @DST1     KSND1                           S01117
     C                     MOVE *HIVAL    KSLDT                           S01117
     C                     MOVE *HIVAL    KPREF                           S01117
     C** BOOKING                                                          S01117
     C*                                                                   S01117
     C           *IN16     IFEQ '1'                        B001           S01117
     C           @PYKEA    SETLLINPALLBB                 01               S01117
     C                     END                             E001           S01117
     C** ORIGINATING                                                      S01117
     C*                                                                   S01117
     C           *IN17     IFEQ '1'                        B001           S01117
     C           @PYKEB    SETLLINPALLOB                 01               S01117
     C                     END                             E001           S01117
     C**                                                                  S01117
     C** DO UNTIL VALID/INVALID OR END OF BRANCHES                        S01117
     C**                                                                  S01117
     C           *IN78     DOUEQ'1'                        B001           S01117
     C                     SETON                         78               S01117
     C*                                                                   S01117
     C           *IN77     DOUEQ'0'                        B002           S01117
     C                     SETOF                         77               S01117
     C**BOOKING                                                           S01117
     C           *IN16     IFEQ '1'                        B003           S01117
     C           @PYKYA    READEINPALLBB                 01               S01117
     C                     END                             E003           S01117
     C**ORIGINATING                                                       S01117
     C           *IN17     IFEQ '1'                        B003           S01117
     C           @PYKYB    READEINPALLOB                 01               S01117
     C                     END                             E003           S01117
     C** IF VALID VALIDATE                                                S01117
     C*                                                                   S01117
     C           *IN01     IFEQ '0'                        B003           S01117
     C**  Insert selection criteria                                       S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '1'                        B004           S01117
     C           @BRCA     IFNE 'ALL'                      B005           S01117
     C           @BORO     ANDEQ'B'                                       S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM ORBR      ZOBRX   3                       S01117
     C                     PARM           ERR     10                      S01117
     C           ERR       IFNE 0                          B006           S01117
     C                     SETON                     770182               S01117
     C                     ELSE                            X006           S01117
     C                     SETOF                         82               S01117
     C                     END                             E006           S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B005           S01117
     C           @BORO     ANDEQ'O'                                       S01117
     C                     CALL 'ZVBBU'                                   S01117
     C                     PARM BRCA      ZBRCDX  3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B006           S01117
     C                     SETON                     770182               S01117
     C                     ELSE                            X006           S01117
     C                     SETOF                         82               S01117
     C                     END                             E006           S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* Value date cannot be less than start value date                   S01117
     C           SLDT      IFLT @SVDP                      B004           S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* Authorisation indicator must match                                S01117
     C           @SAUTH    IFNE 'B'                        B004           S01117
     C           @SAUTH    IFEQ 'N'                        B005           S01117
     C           AUIN      ANDEQ'Y'                                       S01117
     C           @SAUTH    OREQ 'Y'                                       S01117
     C           AUIN      ANDNE'Y'                                       S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C                     END                             E003           S01117
     C** IF RECORD INVALID BECAUSE OF AUTHORITY PROBLEM                   S01117
     C           *IN82     IFEQ '1'                        B003           S01117
     C                     SETON                     83                   S01117
     C                     END                             E003           S01117
     C                     END                             E002           S01117
     C** IF 'ALL' SELECTED TRY NEXT BRANCH                                S01117
     C**                                                                  S01117
     C           *IN01     IFEQ '1'                        B002           S01117
     C           @BRCA     ANDEQ'ALL'                                     S01117
     C                     SETOF                       0178               S01117
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*NEXT'   @OPTN   7                       S01117
     C                     PARM *BLANKS   P@BRCD  3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS                    B003           S01117
     C                     SETON                       0178               S01117
     C                     ELSE                            X003           S01117
     C                     SETOF                         82               S01117
     C                     MOVE A8BRCD    KBRCA                           S01117
     C                     MOVE A8BRCD    KORBR                           S01117
     C                     MOVE *LOVAL    KSND1                           S01117
     C                     MOVE *LOVAL    KPREF                           S01117
     C                     MOVE @SVDP     KSLDT                           S01117
     C** BOOKING AND NOT END OF BRANCHES                                  S01117
     C*                                                                   S01117
     C           *IN16     IFEQ '1'                        B004           S01117
     C           *IN78     ANDEQ'0'                                       S01117
     C           @PYKEA    SETLLINPALLBB                 01               S01117
     C                     END                             E004           S01117
     C** ORIGINATING AND NOT END OF BRANCHES                              S01117
     C*                                                                   S01117
     C           *IN17     IFEQ '1'                        B004           S01117
     C           *IN78     ANDEQ'0'                                       S01117
     C           @PYKEB    SETLLINPALLOB                 01               S01117
     C                     END                             E004           S01117
     C                     END                             E003           S01117
     C                     END                             E002           S01117
     C                     END                             E001           S01117
     C                     ENDSR                                          S01117
     C******************************************************************* S01117
     C*SNDSET- POSITION FILE INSNDBB/OB AFTER F8                        * S01117
     C******************************************************************* S01117
     C**                                                                  S01117
     C           SNDSET    BEGSR                                          S01117
     C** SETOFF VALIDATION ERROR INDICATOR                                S01117
     C                     SETOF                     8283                 S01117
     C**                                                                  S01117
     C** SET UP KEY VALUES USING LAST VALID SENDER                        S01117
     C**                                                                  S01117
     C                     MOVE @DST1     KSND1                           S01117
     C                     MOVE *HIVAL    KSLDT                           S01117
     C                     MOVE *HIVAL    KPREF                           S01117
     C                     MOVE @SCCY     KSMCY                           S01117
     C** BOOKING                                                          S01117
     C*                                                                   S01117
     C           *IN16     IFEQ '1'                        B001           S01117
     C           @PYKEC    SETLLINPSNDBB                 01               S01117
     C                     END                             E001           S01117
     C** ORIGINATING                                                      S01117
     C*                                                                   S01117
     C           *IN17     IFEQ '1'                        B001           S01117
     C           @PYKED    SETLLINPSNDOB                 01               S01117
     C                     END                             E001           S01117
     C**                                                                  S01117
     C** DO UNTIL VALID/INVALID OR END OF BRANCHES                        S01117
     C**                                                                  S01117
     C           *IN78     DOUEQ'1'                        B001           S01117
     C                     SETON                         78               S01117
     C*                                                                   S01117
     C           *IN77     DOUEQ'0'                        B002           S01117
     C                     SETOF                         77               S01117
     C**BOOKING                                                           S01117
     C           *IN16     IFEQ '1'                        B003           S01117
     C           KBRCA     READEINPSNDBB                 01               S01117
     C                     END                             E003           S01117
     C**ORIGINATING                                                       S01117
     C           *IN17     IFEQ '1'                        B003           S01117
     C           KORBR     READEINPSNDOB                 01               S01117
     C                     END                             E003           S01117
     C** IF VALID VALIDATE                                                S01117
     C*                                                                   S01117
     C           *IN01     IFEQ '0'                        B003           S01117
     C**  Insert selection criteria                                       S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '1'                        B004           S01117
     C           @BRCA     IFNE 'ALL'                      B005           S01117
     C           @BORO     ANDEQ'B'                                       S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM ORBR      ZOBRX   3                       S01117
     C                     PARM           ERR     10                      S01117
     C           ERR       IFNE 0                          B006           S01117
     C                     SETON                     770182               S01117
     C                     ELSE                            X006           S01117
     C                     SETOF                         82               S01117
     C                     END                             E006           S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B005           S01117
     C           @BORO     ANDEQ'O'                                       S01117
     C                     CALL 'ZVBBU'                                   S01117
     C                     PARM BRCA      ZBRCDX  3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B006           S01117
     C                     SETON                     770182               S01117
     C                     ELSE                            X006           S01117
     C                     SETOF                         82               S01117
     C                     END                             E006           S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* Sender must match if entered                                      S01117
     C*                                                                   S01117
     C           *IN60     IFEQ '1'                        B005           S01117
     C*                                                                   S01117
     C** IF NON MBIN AND SENDER IS FULL ACC REMOVE BRANCH FROM END        S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '0'                        B006           S01117
     C           SNTP      ANDEQ'G'                                       S01117
     C*                                                                   S01117
     C           DST15     IFNE @SDEST                     B007           S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E007           S01117
     C*                                                                   S01117
     C                     ELSE                            X006           S01117
     C*                                                                   S01117
     C***********DST120****IFNE @SDEST                     B007     S01117003357
     C           SND1      IFNE @SDEST                     B007           003357
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E007           S01117
     C*                                                                   S01117
     C                     END                             E006           S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C* If both Sender and currency entered,currency must match           S01117
     C*                                                                   S01117
     C           *IN19     IFEQ '1'                        B004           S01117
     C           @SCCY     ANDNESMCY                       B004           S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C*                                                                   S01117
     C* Value date cannot be less than start value date                   S01117
     C           SLDT      IFLT @SVDP                      B004           S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* Authorisation indicator must match                                S01117
     C           @SAUTH    IFNE 'B'                        B004           S01117
     C           @SAUTH    IFEQ 'N'                        B005           S01117
     C           AUIN      ANDEQ'Y'                                       S01117
     C           @SAUTH    OREQ 'Y'                                       S01117
     C           AUIN      ANDNE'Y'                                       S01117
     C                     SETON                     7701                 S01117
     C                     SETOF                         82               S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C* Payment must match specified criteria                             S01117
     C*                                                                   S01117
     C                     END                             E003           S01117
     C** IF RECORD INVALID BECAUSE OF AUTHORITY PROBLEM                   S01117
     C           *IN82     IFEQ '1'                        B003           S01117
     C                     SETON                     83                   S01117
     C                     END                             E003           S01117
     C                     END                             E002           S01117
     C** IF 'ALL' SELECTED TRY NEXT BRANCH                                S01117
     C**                                                                  S01117
     C           *IN01     IFEQ '1'                        B002           S01117
     C           @BRCA     ANDEQ'ALL'                                     S01117
     C                     SETOF                       0178               S01117
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*NEXT'   @OPTN   7                       S01117
     C                     PARM *BLANKS   P@BRCD  3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS                    B003           S01117
     C                     SETON                       0178               S01117
     C                     ELSE                            X003           S01117
     C                     SETOF                         82               S01117
     C                     MOVE A8BRCD    KBRCA                           S01117
     C                     MOVE A8BRCD    KORBR                           S01117
     C                     END                             E003           S01117
     C** BOOKING AND NOT END OF BRANCHES                                  S01117
     C*                                                                   S01117
     C           *IN16     IFEQ '1'                        B003           S01117
     C           *IN78     ANDEQ'0'                                       S01117
     C           KBRCA     SETLLINPSNDBB                 01               S01117
     C                     END                             E003           S01117
     C** ORIGINATING AND NOT END OF BRANCHES                              S01117
     C*                                                                   S01117
     C           *IN17     IFEQ '1'                        B003           S01117
     C           *IN78     ANDEQ'0'                                       S01117
     C           KORBR     SETLLINPSNDOB                 01               S01117
     C                     END                             E003           S01117
     C                     END                             E002           S01117
     C                     END                             E001           S01117
     C                     ENDSR                                          S01117
      *******************************************************************
      *  CONTRL - Control display/validation of s/file 1                *
      *******************************************************************
     C           CONTRL    BEGSR
      *
      *  DO UNTIL CMD 12 OR CMD 8                                         S01117
      *
     C           *INKH     DOUEQ'1'                        B001           S01117
     C           *INKL     OREQ '1'                                       S01117
      *                                                                   S01117
      * RESTORE RELEVANT SUBFILE RRN TO POSITION SFL CORRECTLY            S01117
      *                                                                   S01117
     C           @SFSTR    IFNE *ZERO                                     S01117
     C                     Z-ADD@SFSTR    @SFREC                          S01117
     C                     END                                            S01117
      *                                                                   S01117
      * Display s/file 1
      *
     C                     EXSR DSPLY
      *                                                                   S01117
      *  CLEAR RETURN CODE                                                S01117
      *                                                                   S01117
     C                     MOVE *BLANKS   @RETC                           S01117
      *
      * No processing if cmd/12 or cmd/8 pressed
      *
     C           *INKL     IFNE '1'                        B002
     C           *INKH     ANDNE'1'
      *
      * Subfile now valid
      * Read all changed records in the subfile
      *
     C           *IN02     DOUEQ'1'                        B003
     C                     READCFT0155F0                 02
      *                                                                   S01117
     C**IF CHANGED NON BLANK RECORD FOUND UPDATE STORE WITH ITS RRN       S01117
     C**                                                                  S01117
     C           *IN02     IFNE '1'                                       S01117
     C           @DET      ANDNE*BLANK                                    S01117
     C                     Z-ADD@SFK      @SFSTR                          S01117
     C                     END                                            S01117
      *                                                                   S01117
      * For each record read with selection field = '1' call
      * maintenance program
      *
     C           *IN02     IFEQ '0'                        B004
     C           @DET      ANDEQ'1'
      *                                                                   042167
      * Call CL program to check for other users                          042167
      *                                                                   042167
     C                     MOVE 'FT'      @MODLE  2                       042167
     C                     MOVE @PREF     @TREF  15                       042167
     C                     MOVE *BLANKS   @RTINF 80                       042167
     C                     MOVE *BLANKS   @RTCDE  7                       042167
     C                     CALL 'AOC8000'                                 042167
     C                     PARM           @RTCDE                          042167
     C                     PARM           @MODLE                          042167
     C                     PARM           @TREF                           042167
     C                     PARM           @RTINF                          042167
      *                                                                   042167
      *  If 'IN USE' then redisplay subfile with error message            042167
      *                                                                   042167
     C           @RTCDE    IFEQ '*IN USE'                  B005           042167
      *                                                                   042167
      * If this record is in error, and the SFLRCDNBR field has not yet   042167
      * been set, set it to the record number of this record              042167
      *                                                                   042167
     C           @SFREC    IFEQ -1                                        042167
     C                     Z-ADD@SFK      @SFREC                          042167
     C                     END                                            042167
      *                                                                   042167
     C                     MOVEA@RTINF    @TX3                            042167
     C                     MOVEA@TX2,1    @EA,1                           042167
     C                     MOVEA@TX3,1    @EA,11                          042167
     C                     MOVEA@EA,1     @ERR                            042167
     C                     SETON                     445026               042167
      *                                                                   042167
      * Update s/file record and leave the READC DO loop                  042167
      *                                                                   042167
     C                     UPDATFT0155F0                                  042167
     C                     LEAVE                                          042167
     C                     ELSE                                           042167
      *                                                                   042167
      * If transaction NOT already in use, CALL maintenance program       042167
      *                                                                   042167
     C                     MOVE *BLANK    @RETC
      *                                                                   CAP136
     C           CAP136    IFNE 'Y'                                       CAP136
     C                     CALL 'FTC0050'              05
     C                     PARM 'A'       @SORT   1
     C                     PARM           @PREF  15
     C                     PARM           @RETC   1
     C                     PARM 'Y'       WLINK   1
     C                     ELSE                                           CAP136
     C                     CALL 'FTC0051'              05                 CAP136
     C                     PARM           PPGM                            CAP136
     C                     PARM 'A'       @SORT                           CAP136
     C                     PARM           @PREF                           CAP136
     C                     PARM           @RETC                           CAP136
     C                     PARM 'Y'       WLINK                           CAP136
     C                     PARM '1'       PLEVEL  1                       CAP136
     C                     ENDIF                                          CAP136
      *
     C           *IN05     IFEQ '1'                        B005
     C                     Z-ADD12        @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 12 *
     C                     MOVEL'FT0050'  @DBKEY           ***************
     C                     EXSR DBERR
     C                     END                             E005
      *                                                                   042167
      * Call CL program to clear used transaction reference               042167
      *                                                                   042167
     C                     EXSR DALLOC                                    042167
      *                                                                   042167
     C                     END                             E005           042167
      *
     C                     END                             E004
      *
      * For each record read with selection field = '2' call
      * authorisation program
      *
     C           *IN02     IFEQ '0'                        B004
     C           @DET      ANDEQ'2'
      *                                                                   042167
      * Call CL program to check for other users                          042167
      *                                                                   042167
     C                     MOVE 'FT'      @MODLE  2                       042167
     C                     MOVE @PREF     @TREF  15                       042167
     C                     MOVE *BLANKS   @RTINF 80                       042167
     C                     MOVE *BLANKS   @RTCDE  7                       042167
     C                     CALL 'AOC8000'                                 042167
     C                     PARM           @RTCDE                          042167
     C                     PARM           @MODLE                          042167
     C                     PARM           @TREF                           042167
     C                     PARM           @RTINF                          042167
      *                                                                   042167
      *  If 'IN USE' then redisplay subfile with error message            042167
      *                                                                   042167
     C           @RTCDE    IFEQ '*IN USE'                      B005       042167
      *                                                                   042167
      * If this record is in error, and the SFLRCDNBR field has not yet   042167
      * been set, set it to the record number of this record              042167
      *                                                                   042167
     C           @SFREC    IFEQ -1                                        042167
     C                     Z-ADD@SFK      @SFREC                          042167
     C                     END                                            042167
      *                                                                   042167
     C                     MOVEA@RTINF    @TX3                            042167
     C                     MOVEA@TX2,1    @EA,1                           042167
     C                     MOVEA@TX3,1    @EA,11                          042167
     C                     MOVEA@EA,1     @ERR                            042167
     C                     SETON                     445026               042167
      *                                                                   042167
      * Update s/file record and leave the READC DO loop                  042167
      *                                                                   042167
     C                     UPDATFT0155F0                                  042167
     C                     LEAVE                                          042167
     C                     ELSE                                           042167
      *                                                                   042167
      * If transaction NOT already in use, CALL authorisation program     042167
      *                                                                   042167
     C                     MOVE *BLANK    @RETC
     C                     CALL 'FTC0060'              05
     C                     PARM           @PREF  15
     C                     PARM           @RETC   1
      *
     C           *IN05     IFEQ '1'                        B005
     C                     Z-ADD12        @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 12 *
     C                     MOVEL'FT0060'  @DBKEY           ***************
     C                     EXSR DBERR
     C                     END                             E005
      *                                                                   042167
      * Call CL program to clear used transaction reference               042167
      *                                                                   042167
     C                     EXSR DALLOC                                    042167
      *                                                                   042167
     C                     END                             E005           042167
      *
     C                     END                             E004
      *
      * For each record read with selection field = '3' call              S01117
      * enquiry function of maintenance program
      *
     C           *IN02     IFEQ '0'                        B004
     C           @DET      ANDEQ'3'
     C                     MOVE *BLANK    @RETC
      *                                                                   CAP136
     C           CAP136    IFNE 'Y'                                       CAP136
     C                     CALL 'FTC0050'              05
     C                     PARM 'E'       @SORT   1
     C                     PARM           @PREF  15
     C                     PARM           @RETC   1
     C                     PARM 'Y'       WLINK   1
     C                     ELSE                                           CAP136
     C                     CALL 'FTC0051'              05                 CAP136
     C                     PARM           PPGM                            CAP136
     C                     PARM 'E'       @SORT                           CAP136
     C                     PARM           @PREF                           CAP136
     C                     PARM           @RETC                           CAP136
     C                     PARM 'Y'       WLINK                           CAP136
     C                     PARM '1'       PLEVEL                          CAP136
     C                     ENDIF                                          CAP136
      *
     C           *IN05     IFEQ '1'                        B005
     C                     Z-ADD12        @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 12 *
     C                     MOVEL'FT0050'  @DBKEY           ***************
     C                     EXSR DBERR
     C                     END                             E005
      *
     C                     END                             E004
      *
      *                                                                   S01117
     C           *IN02     IFEQ '0'                        B004           S01117
     C           @SFK      CHAINFT0155F0             99                   S01117
      *                                                                   S01117
      * IF PAYMENT AUTHORISED IN FT0060 SET SCREEN FIELD TO 'YES'         S01117
      *                                                                   S01117
     C           @RETC     IFEQ 'Y'                        B005           S01117
     C           @DET      ANDEQ'2'                                       S01117
     C                     MOVEL'YES'     @SFAUT                          S01117
     C                     MOVEL' '       @RETC                           S01117
     C                     END                             E005           S01117
      *                                                                   S01117
     C                     MOVE *BLANK    @DET                            S01117
     C                     UPDATFT0155F0                                  S01117
     C                     END                             E004           S01117
      *                                                                   E29970
      * IF CMD 7 NOT PRESSED CHECK FOR CMD1,5 OR DBASE ERROR              E29970
      *                                                                   E29970
     C           @RETC     IFNE '7'                        B004           E29970
      *
      * Return code of 1 (F3 pressed) or database error in FT0060 -
      * exit program
      *
     C           @RETC     IFEQ '1'                        B005
     C           @RETC     OREQ '*'
     C                     SETON                     LR
     C                     RETRN
     C                     END                             E005
      *                                                                   E29970
      * Return code of 5 (F12 pressed) - stop processing selections       E29970
      * and redisplay subfile after clearing selection fields             E29970
      *
     C           @RETC     IFEQ '5'                        B005           E29970
     C                     SETOF                     02                   E29970
      *
     C           *IN02     DOUEQ'1'                        B006           E29970
     C                     READCFT0155F0                 02               E29970
      *
     C           *IN02     IFEQ '0'                        B007           E29970
     C                     MOVE *BLANK    @DET                            E29970
     C                     UPDATFT0155F0                                  E29970
     C                     END                             E007           E29970
      *
     C                     END                             E006           E29970
     C                     END                             E005           E29970
     C                     END                             E004           E29970
      *                                                                   E29970
     C                     END                             E003
     C                     END                             E002
     C                     END                             E001           S01117
      *
     C                     ENDSR                           CONTRL ends
      /EJECT
      *******************************************************************
      *  DSPLY  - Display initial screen and s/file 1                   *
      *******************************************************************
     C           DSPLY     BEGSR
      *
      * Process screen until no errors
     C           *IN50     DOUEQ'0'                        B001
      *
      * Process while ROLLUP pressed
     C           *IN29     DOUEQ'0'                        B002
      *
      * Display screen
     C                     WRITEFT0155F2
     C                     WRITEFT0155F1
      *
      * Process while HELP pressed
     C**         *IN22     DOUEQ'0'                                       S01199
     C                     READ FT0155F1                 01
     C**         *IN22     IFEQ '1'                                       S01199
     C**                   CALL 'MHELP'                                   S01199
     C**                   PARM 'FT0000  '@ERPGM  8                       S01199
     C**                   PARM           @EA                             S01199
      *
     C**         *IN01     IFEQ '1'                                       S01199
     C**                   Z-ADD11        @DBASE           ***************S01199
     C**                   MOVEL*BLANKS   @DBFIL           * DB ERROR 11 *S01199
     C**                   MOVEL'MHELP'   @DBKEY           ***************S01199
     C**                   EXSR DBERR                                     S01199
     C**                   END                                            S01199
      *
     C**                   END                                            S01199
     C**                   END                                            S01199
      *
      * Add new page to subfile if ROLLUP pressed
     C   29                EXSR NEXTP
     C                     END                             E002
     C**                                                                  S01117
     C** UPDATE STORE VALUE WITH RRN OF CURRENT TOP SFL SCREEN REC        S01117
     C**                                                                  S01117
     C                     Z-ADDSRRN      @SFSTR                          S01117
      *
      * Exit if F3 pressed
     C           *INKC     IFEQ '1'                        B002
     C                     SETON                     LR
     C                     RETRN
     C                     END                             E002
      *
      * Exit if F12 pressed
     C           *INKL     IFEQ '1'                        B002
     C                     SETOF                     50
     C                     GOTO EDSPLY
     C                     END                             E002
      *                                                                   E29969
      * Bypass validation if command 8 and go one to next sender          E29969
     C           *INKH     IFEQ '1'                        B002           E29969
     C                     SETOF                     50                   E29969
     C                     GOTO EDSPLY                                    E29969
     C                     END                             E002           E29969
      *
      * Validate subfile if there were payments awaiting authorisation
      * i.e. file not empty
     C  N46                EXSR VALID
     C   50                MOVEA@EA,1     @ERR
     C                     END                             E001
      *
     C           EDSPLY    TAG
      *
     C                     ENDSR                           DSPLY  ends
      /EJECT
      *******************************************************************
      *  VALID  - Validate s/file                                       *
      *******************************************************************
     C           VALID     BEGSR
      *
      * Reset fields
     C                     Z-ADD-1        @SFREC
     C                     Z-ADD1         I       30
     C                     MOVEA*BLANKS   @EA
     C                     SETOF                     0650
     C                     SETOF                     44                   S01117
      *
      * Read all changed records in the subfile
     C           *IN02     DOUEQ'1'                        B001
     C                     READCFT0155F0                 02
     C           *IN02     IFEQ '0'                        B002
     C*                                                                   S01117
      *
      * Reset indicators
     C                     SETON                     06
     C                     SETOF                       4426
     C                     Z-ADD0         ERR                             S01117
      * Select payment flag must be 1,2 or 3 if entered
     C           @DET      IFNE *BLANKS                    B003
     C           @DET      ANDNE'1'
     C           @DET      ANDNE'2'
     C           @DET      ANDNE'3'
     C                     SETON                     50  44
      *
      * Check that error code is not already in error array
     C***********' 401'****LOKUP@EA                      03               S01117
     C           ' 007'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                        B004
     C*********************MOVEL' 401'    @EA,I                           S01117
     C                     MOVEL' 007'    @EA,I                           S01117
     C                     ADD  1         I
     C                     END                             E004
     C                     END                             E003
     C*
     C** PAYMENT MUST NOT BE AUTHORISED
     C*
     C           @DET      IFEQ '1'                        B003
     C           @DET      OREQ '2'                                       S01117
     C***********AUIN******ANDEQ'Y'                                       S01117
     C           @SFAUT    IFEQ 'YES'                      B004           S01117
     C           ' 008'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                        B005           S01117
     C*********************MOVEL' 508'    @EA,I                           S01117
     C                     MOVEL' 008'    @EA,I                           S01117
     C                     ADD  1         I
     C                     END                             E005           S01117
     C                     SETON                     4450
     C                     END                             E004           S01117
     C                     END                             E003
     C** Authority Check                                                  S01117
     C*  and no errors and selection not blank                            S01117
     C           *IN44     IFEQ '0'                        B003           S01117
     C           @DET      ANDNE*BLANK                                    S01117
     C           *IN43     IFEQ '1'                        B004           S01117
     C*                                                                   S01117
     C** Check if user is authorised to perform action code on booking    S01117
     C** branch by calling ZVACTBU                                        S01117
     C*                                                                   S01117
     C           @DET      IFEQ '1'                        B005 ACT=A     S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM 'A'       SACTCD  1                       S01117
     C                     PARM @HBRCA    SBRCAB  3                       S01117
     C                     PARM           ERR                             S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C           @DET      IFEQ '2'                        B005 ACT=X     S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM 'X'       SACTCD  1                       S01117
     C                     PARM @HBRCA    SBRCAB  3                       S01117
     C                     PARM           ERR                             S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C           @DET      IFEQ '3'                        B005 ACT=E     S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM 'E'       SACTCD  1                       S01117
     C                     PARM @HBRCA    SBRCAB  3                       S01117
     C                     PARM           ERR                             S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B005           S01117
     C           ERR       IFEQ 1                          B006           S01117
     C           ' 303'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                        B007           S01117
     C                     MOVEL' 303'    @EA,I                           S01117
     C                     END                             E007           S01117
     C                     ELSE                            X006           S01117
     C           ' 304'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                        B007           S01117
     C                     MOVEL' 304'    @EA,I                           S01117
     C                     END                             E007           S01117
     C                     END                             E006           S01117
     C                     ADD  1         I                               S01117
     C                     SETON                     5044                 S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C*                                                                   S01117
     C** Check if user is authorised to perform action code on originatingS01117
     C** branch by calling ZVOBU                                          S01117
     C*                                                                   S01117
     C           @BRCA     IFEQ 'ALL'                      B005           S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C*                                                                   S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM @HORBR    ZOBRX   3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B006           S01117
     C           ERR       IFEQ 1                          B007           S01117
     C           ' 305'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                        B008           S01117
     C                     MOVEL' 305'    @EA,I                           S01117
     C                     END                             E008           S01117
     C                     ELSE                            X007           S01117
     C           ' 306'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                        B008           S01117
     C                     MOVEL' 306'    @EA,I                           S01117
     C                     END                             E008           S01117
     C                     END                             E007           S01117
     C                     ADD  1         I                               S01117
     C                     SETON                     5044                 S01117
     C                     END                             E006           S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C                     ELSE                            X004 NON-MB    S01117
     C*                                                                   S01117
     C           @DET      IFNE *BLANKS                    B005           S01117
     C*                                                                   S01117
     C           @DET      IFEQ '1'                        B006           S01117
     C                     MOVE 'A'       ZACT    1                       S01117
     C                     END                             E006           S01117
     C           @DET      IFEQ '2'                                       S01117
     C                     MOVE 'X'       ZACT             B006           S01117
     C                     END                             E006           S01117
     C           @DET      IFEQ '3'                        B006           S01117
     C                     MOVE 'E'       ZACT                            S01117
     C                     END                             E006           S01117
     C*                                                                   S01117
     C                     CALL 'ZVACTU'                                  S01117
     C                     PARM ZACT      ZACTN   1                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C** If user does not have authority, display msg and allow input.    S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B006           S01117
     C                     SETON                     5044                 S01117
     C           ' 302'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                        B007           S01117
     C                     MOVEL' 302'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                             E007           S01117
     C                     END                             E006           S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
     C*
     C           *IN44     IFEQ '1'                        B003
     C                     SETON                     26
     C                     END                             E003
      *
      * If this record is in error, and the SFLRCDNBR field has not yet
      * been set, set it to the record number of this record
     C           @SFREC    IFEQ -1                         B003
     C           *IN50     ANDEQ'1'
     C                     Z-ADD@SFK      @SFREC
     C                     END                             E003
     C                     SETON                     26  08
      *
      * Update s/file record
     C                     UPDATFT0155F0
      *
     C                     END                             E002
     C                     END                             E001
      *
     C                     ENDSR                           VALID  ends
      /EJECT
      *******************************************************************
      *  NEXTP  - Add a page of records to subfile                      *
      *******************************************************************
     C           NEXTP     BEGSR
      *
     C                     SETOF                     26
     C                     SETOF                         44
     C                     SETON                         25
      *
     C                     Z-ADD@SFR      @SFK
     C                     Z-ADD@SFK      @SFREC
     C                     EXSR SFFILL
     C                     Z-ADD@SFK      @SFR
      *
     C                     ENDSR                           NEXTP  ends
      /EJECT
      *******************************************************************
      *  SFFILL - Write a page of records to the subfile                *
      *******************************************************************
     C           SFFILL    BEGSR
      *
      * Write a page of records
      *
     C           *IN01     IFEQ '0'                        B001
      *
     C                     Z-ADD1         Z       30
     C           Z         DOUGT15                         B002
     C*                                                                   S01117
     C*                                                                   S01117
     C** Subheading processing                                            S01117
     C*                                                                   S01117
     C                     SETON                     31                   S01117
     C           A8BRCD    IFNE SAVEB                      B003           S01117
     C*                                                                   S01117
     C           *IN75     IFEQ '1'                        B004           S01117
     C                     EXSR TOTAL                                     S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C                     SETON                     75                   S01117
     C                     MOVE A8BRCD    SAVEB   3                       S01117
     C**********           MOVE *BLANKS   @SFLIN                                       S01117 CGL029
     C                     MOVE *BLANKS   @SFLN1                                              CGL029
     C                     MOVE *BLANKS   @SFLN2                                              CGL029
     C                     SETOF                     31                   S01117
     C                     MOVE A8BRCD    @SBRCH                          S01117
     C                     MOVE A8BRNM    @SBRNM                          S01117
     C                     WRITEFT0155F0                                  S01117
     C**********           MOVE *BLANKS   @SFLIN                                       S01117 CGL029
     C                     MOVE *BLANKS   @SFLN1                                              CGL029
     C                     MOVE *BLANKS   @SFLN2                                              CGL029
     C                     ADD  1         @SFK                            S01117
     C                     ADD  1         Z                               S01117
     C                     END                             E003           S01117
      *
     C                     SETON                     2431
      * Selection field
     C                     MOVE *BLANK    @DET
      * Value date
     C                     Z-ADDSLDTD1    @DATE
     C           DATF      IFEQ 'D'                                       195352
     C                     Z-ADDDD        @DD
     C                     Z-ADDYY        @YY
     C                     MOVE ZMNM,MM   @MMM
     C                     ELSE                                           195352
     C                     Z-ADDDD1       @DD                             195352
     C                     Z-ADDYY        @YY                             195352
     C                     MOVE ZMNM,MM1  @MMM                            195352
     C                     ENDIF                                          195352
     C*                                                                   S01117
     C** SET UP HIDDEN BRANCH FIELDS                                      S01117
     C*                                                                   S01117
     C                     MOVE BRCA      @HBRCA                          S01117
     C                     MOVE ORBR      @HORBR                          S01117
     C*                                                                   S01117
     C** SET UP SCREEN AUTHORITY FIELD                                    S01117
     C**                                                                  S01117
     C           AUIN      IFEQ 'Y'                        B003           S01117
     C                     MOVEL'YES'     @SFAUT                          S01117
     C                     ELSE                            X003           S01117
     C                     MOVEL*BLANKS   @SFAUT                          S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
      * Payment reference
     C                     MOVE PREF      @PREF
      * Sub-type
     C                     MOVE PYST      @SUBT
      * Currency
     C                     MOVE SMCY      @CCY
      * Amount
      *
     C*********************MOVE SMCY      @KCCY                           S01194
     C***********@KEY12****CHAINTABTG10F             05                   S01194
     C************IN05*****IFEQ '1'                        B002           S01194
     C***********RECI******OREQ '*'                                       S01194
     C*********************Z-ADD5         @DBASE           ***************S01194
     C*********************MOVEL'TABFP'   @DBFIL           * DB ERROR 05 *S01194
     C*********************MOVEL@KEY12    @DBKEY           ***************S01194
     C*********************EXSR DBERR                                     S01194
     C*********************END                             E002           S01194
      *                                                                   S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*DBERR'  @RTCD   7                       S01194
     C                     PARM '*KEY'    @OPTN   7                       S01194
     C                     PARM SMCY      CYC     3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*                                                                   S01194
     C*********************Z-ADDCDP       @DEC    10                      S01194
     C                     Z-ADDA6NBDP    @DEC    10
     C                     MOVEL*BLANKS   ZFLD15
     C                     MOVE SMAM      ZFLD15
     C                     Z-ADD@DEC      ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @AMNT
      *
      * Ordering bank/customer
      *
     C           ACBT      IFEQ 'N'                        B003
     C                     MOVELACBK      @FLD2   2
     C                     MOVELPCCY      @FLD5
     C                     MOVE @FLD2     @FLD5
     C                     END                             E003
     C*
     C           ACBT      IFEQ 'C'                        B003
     C           ACBT      OREQ 'G'
     C           ACBT      OREQ 'P'
     C           ACBT      OREQ 'R'
     C           ACBT      OREQ 'N'
     C           ACBT      OREQ 'F'
     C           ACBT      OREQ 'S'
     C                     MOVE ACBT      @TYPE   1
     C                     MOVE *BLANKS   @FLD15                          S01117
     C*
     C           ACBT      IFEQ 'N'                        B004
     C**********           MOVEL@FLD5     @FLD15 15                                           CGL029
     C                     MOVEL@FLD5     @FLD15 21                                           CGL029
     C                     ELSE                            X004
     C**********           MOVELACBK      @FLD15 15                                           CGL029
     C                     MOVELACBK      @FLD15                                              CGL029
     C                     END                             E004
     C*
     C                     ELSE                            X003
     C                     MOVE *BLANKS   @FLD15                          S01117
     C*
     C           BNCT      IFEQ 'N'                        B004
     C                     MOVELBNC1      @FLD2
     C                     MOVELPCCY      @FLD5
     C                     MOVE @FLD2     @FLD5
     C                     MOVEL@FLD5     BNC1
     C                     END                             E004
     C*
     C                     MOVE BNCT      @TYPE
     C                     MOVELBNC1      @FLD15
     C                     MOVELBNC1      ##001   1                       S01435
      *                                                                   S01435
      *  If / then use second line if Customer or SWIFT                   S01435
      *                                                                   S01435
     C           ##001     IFEQ '/'                                       S01435
     C           BNCT      ANDEQ'C'                                       S01435
     C           ##001     OREQ '/'                                       S01435
     C           BNCT      ANDEQ'S'                                       S01435
     C                     MOVE *BLANKS   @FLD15                          S01117
     C                     MOVELBNC2      @FLD15                          S01435
     C                     END                                            S01435
      *                                                                   S01435
     C                     END                             E003
     C*
     C                     EXSR CONVRT
     C*
     C                     MOVEL@OUT      @ORBC
     C/COPY WNCPYSRC,FT0155C002
     C                     MOVE @VALD     SVALD                           S01117
     C*********************MOVE @FLD24    SFLD24                          S01117
     C                     WRITEFT0155F0
     C**********           MOVE *BLANKS   @SFLIN                                       S01117 CGL029
     C                     MOVE *BLANKS   @SFLN1                                              CGL029
     C                     MOVE *BLANKS   @SFLN2                                              CGL029
     C                     SETON                     31
     C                     ADD  1         @SFK
     C                     ADD  1         Z
     C*                                                                   S01117
     C           RREAD2    TAG
     C**N60****************READ INPAYDDF                 01               S01117
     C***60****************READ INPAYDSF                 01               S01117
     C*                                                                   S01117
     C           *IN16     IFEQ '1'                        B003           S01117
     C**N60******BRCA******READEINPAYDDF                 01               S01117
     C***60******BRCA******READEINPAYSBB                 01               S01117
     C*                                                                   S01117
     C           *IN60     IFEQ '0'                                       S01117
     C           *IN18     ANDEQ'0'                                       S01117
     C           BRCA      READEINPAYDDF                 01               S01117
     C                     ELSE                                           S01117
     C           BRCA      READEINPAYSBB                 01               S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
     C           *IN17     IFEQ '1'                        B003           S01117
     C**N60******ORBR******READEINPAYAOB                 01               S01117
     C***60******ORBR******READEINPAYSOB                 01               S01117
     C*                                                                   S01117
     C           *IN60     IFEQ '0'                                       S01117
     C           *IN18     ANDEQ'0'                                       S01117
     C           ORBR      READEINPAYAOB                 01               S01117
     C                     ELSE                                           S01117
     C           ORBR      READEINPAYSOB                 01               S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
     C**  Insert selection criteria                                       S01117
     C*                                                                   S01117
     C           *IN43     IFEQ '1'                        B003           S01117
     C           *IN01     ANDNE'1'                                       S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B004           S01117
     C           @BORO     ANDEQ'B'                                       S01117
     C           BKOBUV    ANDEQ'Y'                                       S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM ORBR      ZOBRX   3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B005           S01117
     C                     GOTO RREAD2                                    S01117
     C                     END                             E005           S01117
     C*                                                                   S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C           @BRCA     IFNE 'ALL'                      B004           S01117
     C           @BORO     ANDEQ'O'                                       S01117
     C                     CALL 'ZVBBU'                                   S01117
     C                     PARM BRCA      ZBRCDX  3                       S01117
     C                     PARM           ERR     10                      S01117
     C*                                                                   S01117
     C           ERR       IFNE 0                          B005           S01117
     C                     GOTO RREAD2                                    S01117
     C                     END                             E005           S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C                     END                             E003           S01117
      *
      * Authorisation indicator must match
      *
     C           *IN01     IFNE '1'                        B003
     C           @SAUTH    IFNE 'B'                        B004
     C           @SAUTH    IFEQ 'N'                        B005
     C           AUIN      ANDEQ'Y'
     C           @SAUTH    OREQ 'Y'
     C           AUIN      ANDNE'Y'
     C                     GOTO RREAD2
     C                     END                             E005
     C                     END                             E004
     C                     END                             E003
      *                                                                   S01117
     C** COMPARE NEW SENDER AGAINST SCREEN SENDER USE DST15 IF NEW        S01117
     C** SENDER IS FULL ACCOUNT AND NON MULTIBRANCHED                     S01117
     C*                                                                   S01117
     C                     SETOF                     79                   S01117
      *                                                                   S01117
     C           *IN43     IFEQ '0'                        B003           S01117
     C           SNTP      ANDEQ'G'                                       S01117
      *                                                                   S01117
     C           DST15     IFNE @SDEST                     B004           S01117
     C                     SETON                     79                   S01117
     C                     END                             E004           S01117
      *                                                                   S01117
     C                     ELSE                            X003           S01117
      *                                                                   S01117
     C***********DST120****IFNE @SDEST                     B004     S01117003357
     C           SND1      IFNE @SDEST                     B004           003357
     C                     SETON                     79                   S01117
     C                     END                             E004           S01117
      *                                                                   S01117
     C                     END                             E003           S01117
      *
     C           *IN01     IFEQ '1'                        B003
     C           @DATE     ORNE SLDTD1
     C***********@SDEST****ORNE DST120                                    S01117
     C           @SCCY     ORNE SMCY
     C                     SETON                     79                   S01117
     C                     END                             E003           S01117
     C*                                                                   S01117
     C           *IN79     IFEQ '1'                        B003           S01117
     C                     EXSR TOTAL
     C           Z         IFEQ 15                         B004           S01117
      *                                                                   S01117
      * Write a blank line                                                S01117
     C                     SETOF                     31                   S01117
     C                     MOVE *BLANK    @DET                            S01117
     C                     MOVE *BLANK    @VALD                           S01117
     C                     MOVE *BLANK    SFLD24                          S01117
     C                     MOVEL*BLANK    ZFLD15                          S01117
     C                     MOVE *BLANK    @AMNT                           S01117
     C                     MOVEL*BLANK    @ORBC                           S01117
     C                     MOVEL*BLANK    @SFAUT                          S01117
     C                     MOVE @VALD     SVALD                           S01117
     C                     WRITEFT0155F0                                  S01117
     C                     SETON                     31                   S01117
     C                     ADD  1         @SFK                            S01117
     C                     ADD  1         Z                               S01117
     C                     END                             E004           S01117
     C*                                                                   S01117
     C                     ELSE                            X003
     C                     ADD  SMAM      @TOTAL 130
     C           Z         IFEQ 15                         B004
      *
      * Write a blank line
     C                     SETOF                     31
     C                     MOVE *BLANK    @DET
     C                     MOVE *BLANK    @VALD
     C*********************MOVE *BLANK    @FLD24                          S01117
     C                     MOVE *BLANK    SFLD24
     C                     MOVEL*BLANK    ZFLD15
     C                     MOVE *BLANK    @AMNT
     C                     MOVEL*BLANK    @ORBC
     C                     MOVEL*BLANK    @SFAUT                          S01117
     C                     MOVE @VALD     SVALD                           S01117
     C*********************MOVE @FLD24    SFLD24                          S01117
     C                     WRITEFT0155F0
     C                     SETON                     31
     C                     ADD  1         @SFK
     C                     ADD  1         Z
     C                     END                             E004
     C                     END                             E003
     C           *IN01     IFNE '1'                        B003
      *
      * Payment must match specified criteria
      *
      * Currency must match if entered
     C           @SCCY     IFNE *BLANKS                    B004
     C           SMCY      IFNE @SCCY                      B005
     C                     SETON                     01
     C                     END                             E005
     C                     END                             E004
      *
      * Destination must match if entered
      *
     C           @SDEST    IFNE *BLANKS                    B004
      *                                                                   S01117
     C** IF NON MBIN AND SENDER IS FULL ACC REMOVE BRANCH FROM END        S01117
      *                                                                   S01117
     C           *IN43     IFEQ '0'                        B005           S01117
      *                                                                   S01117
     C           SNTP      ANDEQ'G'                                       S01117
     C           DST15     IFNE @SDEST                     B006           S01117
     C                     SETON                     01                   S01117
     C                     END                             E006           S01117
      *                                                                   S01117
     C                     ELSE                            X005           S01117
      *                                                                   003357
     C***********DST120****IFNE @SDEST                     B006           003357
     C           SND1      IFNE @SDEST                     B006           003357
     C                     SETON                     01
     C                     END                             E006
      *                                                                   003357
     C                     END                             E005
     C                     END                             E004           S01117
      *
     C                     END                             E003
     C  N01                END                             E002
      *
     C           *IN01     IFEQ '0'                        B002
     C                     SETOF                     25
     C                     END                             E002
      *
     C                     END                             E001
      *
     C                     ENDSR                           SFFILL ends
      *
      /EJECT
      *******************************************************************
      *  TOTAL  - Write a total line to the subfile                     *
      *******************************************************************
     C           TOTAL     BEGSR
      *
     C                     SETOF                     31
     C                     MOVE *BLANK    @DET
      * Payment reference
     C*********************MOVE  BLANKS   @FLD24                          S01117
     C                     MOVE *BLANKS   SFLD24                          S01117
     C*********************MOVE @WORD     @FLD24                          S01117
     C                     MOVE @WORD     SFLD24                          S01117
     C                     MOVEL*BLANKS   ZFLD15
     C                     MOVE @TOTAL    ZFLD15
     C                     Z-ADD@DEC      ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @AMNT
      * AUTHORITY INDICATOR                                               S01117
     C                     MOVEL*BLANK    @SFAUT                          S01117
      * Ordering bank/customer
     C                     MOVEL*BLANK    @ORBC
     C                     MOVE @VALD     SVALD                           S01117
     C*********************MOVE @FLD24    SFLD24                          S01117
     C                     WRITEFT0155F0
     C                     SETON                     31
     C                     Z-ADDSMAM      @TOTAL 130
     C*********************MOVE *BLANK    @FLD24                          S01117
     C                     MOVE *BLANK    SFLD24                          S01117
     C                     ADD  1         @SFK
     C                     ADD  1         Z
      *
     C                     ENDSR                           SFFILL ends
      *
      /EJECT
      *******************************************************************
      *  CONVRT - To translate type into destination or ord bnk/cus     *
      *******************************************************************
     C           CONVRT    BEGSR
      *
      * Acount type - Customer/General Ledger/Partial
      *
     C           @TYPE     IFEQ 'C'
     C           @TYPE     OREQ 'G'
     C           @TYPE     OREQ 'P'
     C*                                                                   S01117
     C** In multibranching , rightmost character of FLD15 can             S01117
     C** contain negative value if moved to numeric field.Therefore       S01117
     C** move to CNUMA instead of CNUM.                                   S01117
     C*                                                                   S01117
     C*********************MOVEL@FLD15    CNUM                            S01117
     C                     MOVEL@FLD15    CNUMA                           S01117
     C                     END
      *
      * Type - Retail
      *
     C           @TYPE     IFEQ 'R'
     C                     MOVEL@FLD15    @ACNUM 100
     C           @ACNUM    CHAINACNUMA               05
     C*                                                                   056032
     C* Process for database error UNLESS the payment is matured OR       056032
     C* the value date is prior to the rundate. The account may have      056032
     C* been closed/dropped since that date but it don't matter coz       056032
     C* the accounting is complete. The file key is displayed instead     056032
     C* of the name.                                                      056032
     C*                                                                   056032
     C           *IN05     IFEQ '1'                        B002
     C***********RECI******OREQ '*'                                       056032
     C           RECI      OREQ 'C'                                       056032
     C*                                                                   056032
     C           @RECI     IFNE 'M'                                       056032
     C           PVDT      ANDGEBJRDNB                                    056032
     C                     Z-ADD6         @DBASE           ***************
     C                     MOVEL'ACNUMA'  @DBFIL           * DB ERROR 06 *
     C                     MOVEL@ACNUM    @DBKEY           ***************
     C                     EXSR DBERR
     C                     ELSE                                           056032
     C                     MOVE *BLANKS   @OUT                            056032
     C                     MOVEL@ACNUM    @OUT                            056032
     C                     GOTO ENDCON                                    056032
     C                     END                                            056032
     C*                                                                   056032
     C                     END                             E002
     C*
     C                     END
      *
      * Type - Nostro/Full Nostro
      *
     C           @TYPE     IFEQ 'N'
     C           @TYPE     OREQ 'F'
     C*********************MOVEL@FLD15    @NCCY                           S01194
     C                     MOVEL@FLD15    @NCCY   3                       S01194
     C                     MOVEL@FLD15    @FLD5   5
     C*********************MOVE @FLD5     @NOSN                           S01194
     C                     MOVE @FLD5     @NOSN   2                       S01194
     C***********@KEYNO****CHAINTABLETLF             05                   S01194
     C/COPY WNCPYSRC,FT0155C003
     C                     CALL 'AONOSTR0'                                S01194
     C*********************PARM '*DBERR'  @RTCD   7                 S01194056032
     C                     PARM '*MSG  '  @RTCD   7                       056032
     C                     PARM '*KEY'    @OPTN   7                       S01194
     C                     PARM *BLANKS   @CUST   6                       S01194
     C                     PARM @NCCY     @NOSTC  3                       S01194
     C**********           PARM *BLANKS   @ACCD   4                                    S01194 CGL029
     C                     PARM *BLANKS   @ACCD  10                                           CGL029
     C                     PARM *BLANKS   @ACSN   2                       S01194
     C                     PARM @NOSN     @NOSTN  2                       S01194
     C                     PARM *BLANKS   @BRCD   3                       S01194
     C                     PARM *BLANKS   @CUSN  10                       S01194
     C                     PARM *BLANKS   @PNOI   1                       S01194
     C           SDNOST    PARM SDNOST    DSFDY                           S01194
     C                     MOVE A7CUST    CNUMA   6                       S01194
      *                                                                   056032
      * If return code is not blank - process for a database error.       056032
      * Must be processed here instead of the called pgm because the      056032
      * database error is conditional on the payment's RECI.              056032
      *                                                                   056032
      * Same conditions apply as for Retail account processing.           056032
      *                                                                   056032
     C           @RTCD     IFNE *BLANKS                                   056032
     C*                                                                   056032
     C           @RECI     IFNE 'M'                                       056032
     C           PVDT      ANDGEBJRDNB                                    056032
     C                     Z-ADD8         @DBASE           ***************056032
     C                     MOVEL'SDNOSTPD'@DBFIL           * DB ERROR 08 *056032
     C                     MOVEL*BLANKS   @DBKEY           ***************056032
     C                     MOVEL@FLD15    @DBKEY                          056032
     C                     EXSR DBERR                                     056032
     C                     ELSE                                           056032
     C                     MOVE *BLANKS   @OUT                            056032
     C                     MOVEL@FLD15    @OUT                            056032
     C                     GOTO ENDCON                                    056032
     C                     END                                            056032
     C*                                                                   056032
     C                     END                             E002           056032
     C*                                                                   S01194
     C************IN05*****IFEQ '1'                                       S01194
     C***********RECI******OREQ '*'                                       S01194
     C*********************Z-ADD8         @DBASE           ***************S01194
     C*********************MOVEL'TABFP'   @DBFIL           * DB ERROR 08 *S01194
     C*********************MOVEL@FLD5     @DBKEY           ***************S01194
     C*********************EXSR DBERR                                     S01194
     C*********************END                                            S01194
      *
     C                     END
      *
     C           CFT004    IFEQ 'Y'                                       CFT004
     C           @TYPE     IFEQ 'I'                                       CFT004
     C           34        SUBSTBNC1:2    P@IBN  34                       CFT004
     C                     MOVE *BLANKS   DSSDY                           CFT004
     C                     CALL 'AOIBANR4'                                CFT004
     C                     PARM           @RTCD                           CFT004
     C                     PARM '*KEY   ' @OPTN   7                       CFT004
     C                     PARM           P@IBN                           CFT004
     C           P@ACCN    PARM           DSSDY                           CFT004
     C           @RTCD     IFNE *BLANKS                                   CFT004
     C                     MOVE *BLANKS   @DBKEY                          CFT004
     C                     Z-ADD13        @DBASE           ***************CFT004
     C                     MOVEL'ACCNTL6' @DBFIL           * DB ERROR 13 *CFT004
     C                     MOVELP@IBN     @DBKEY           ***************CFT004
     C                     EXSR DBERR                                     CFT004
     C                     ENDIF                                          CFT004
     C**********           Z-ADDIBCNUM    CNUM                                         CFT004 CSD027
     C                     MOVE IBCNUM    CNUM                                                CSD027
     C                     ENDIF                                          CFT004
     C                     ENDIF                                          CFT004
      *                                                                   CFT004
      * Type is customer address/shortname
      *
     C           @TYPE     IFEQ 'A'
     C           @TYPE     OREQ 'S'
     C**********           MOVEL@FLD15    @OUT   15                                           CGL029
     C                     MOVEL@FLD15    @OUT   21                                           CGL029
     C                     ELSE
     C***********@CLKEY****CHAINCLINTCBF             05                   S01194
     C************IN05*****IFEQ '1'                                       S01194
     C***********RECI******OREQ '*'                                       S01194
     C*********************Z-ADD7         @DBASE           ***************S01194
     C*********************MOVEL'CLINT'   @DBFIL           * DB ERROR 07 *S01194
     C*********************MOVELCNUM      @DBKEY           ***************S01194
     C*********************EXSR DBERR                                     S01194
     C*********************ELSE                                           S01194
      *
      * Type is customer no.
      *
     C                     CALL 'AOCUSTR0'                                S01194
     C*********************PARM '*DBERR'  @RTCD   7                       S01194
     C                     PARM '*MSG  '  @RTCD   7                       S01194
     C                     PARM '*KEY'    @OPTN   7                       S01194
     C                     PARM CNUMA     KEY1   10                       S01194
     C                     PARM           KYST    7                       S01194
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
     C*********************MOVELCRNM      @OUT                            S01194
     C                     MOVELBBCRNM    @OUT                            S01194
      *                                                                   056032
      * If return code is not blank - process for a database error.       056032
      * Must be processed here instead of the called pgm because the      056032
      * database error is conditional on the payment's RECI.              056032
      *                                                                   056032
      * Same conditions apply as for Retail account processing.           056032
      *                                                                   056032
     C           @RTCD     IFNE *BLANKS                                   056032
     C*                                                                   056032
     C           @RECI     IFNE 'M'                                       056032
     C           PVDT      ANDGEBJRDNB                                    056032
     C                     Z-ADD7         @DBASE           ***************056032
     C                     MOVEL'SDCUSTPD'@DBFIL           * DB ERROR 07 *056032
     C                     MOVEL*BLANKS   @DBKEY           ***************056032
     C                     MOVELCNUMA     @DBKEY                          056032
     C                     EXSR DBERR                                     056032
     C                     ELSE                                           056032
     C                     MOVE *BLANKS   @OUT                            056032
     C                     MOVELCNUMA     @OUT                            056032
     C                     GOTO ENDCON                                    056032
     C                     END                                            056032
     C*                                                                   056032
     C                     END                             E002           056032
     C*                                                                   056032
     C*********************END                             E002           S01194
     C                     END
      *
     C*********************ENDSR                           CONVRT ends    056032
     C           ENDCON    ENDSR                                          056032
      /EJECT
      *******************************************************************
      *  DBERR  - Error handling                                        *
      *******************************************************************
     C           DBERR     BEGSR
      *
     C*********************DUMP                                           E29966
     C                     MOVEL@DBALL    @DBSAV
     C           *LOCK     IN   LDA
     C                     MOVEL@DBSAV    @DBALL
     C                     MOVEL'FT0155'  @DBPGM
     C                     OUT  LDA
      *                                                                   042167
      *  Allocate dataarea to blanks                                      042167
      *                                                                   042167
     C                     EXSR DALLOC                                    042167
      *                                                                   042167
     C                     DUMP                                           E29966
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR                           DBERR  ends
      *
      ******************************************************************* 042167
      * SUBROUTINE TO DEALLOCATE DATAAREA                                 042167
      ******************************************************************* 042167
      *                                                                   042167
     C           DALLOC    BEGSR                           *** DALLOC ****042167
      *                                                                   042167
      * Call CL program to de-allocate                                    042167
      *                                                                   042167
     C                     MOVE *BLANKS   @RTCDE                          042167
     C                     MOVE 'FT'      @MODLE                          042167
     C                     MOVE *BLANKS   @TREF                           042167
     C                     MOVE *BLANKS   @RTINF                          042167
     C                     CALL 'AOC8000'                                 042167
     C                     PARM           @RTCDE                          042167
     C                     PARM           @MODLE                          042167
     C                     PARM           @TREF                           042167
     C                     PARM           @RTINF                          042167
      *                                                                   042167
     C                     ENDSR                                          042167
      *                                                                   042167
      /EJECT
      /COPY ZSRSRC,ZSEDITZ3
      /EJECT
     C********************************************************************
     C**
     C**   ZDATE1 SR. TO VALIDATE DATES SUBMITTED AND
     C**              CONVERT TO A NUMBER OF DAYS.
     C**
     C**   THE YEAR 2000, BEING DIVISIBLE BY 400, IS A LEAP YEAR.
     C**
     C           ZDATE1    BEGSR                           *** ZDATE1 ***
     C**
     C**   CLEAR DAY NUMBER.
     C                     Z-ADD0         ZDAYNO  50
     C**
     C**   CALCULATION TO DEFINE INPUT DATE FIELD.
     C                     Z-ADDZDATE     ZDATE   60
     C**
     C**   GET INDIVIDUAL DAY, MONTH AND YEAR FIELDS.
     C                     MOVE ZDATE     ZYEAR   20
     C  N98                MOVELZDATE     ZDAY    20
     C   98                MOVELZDATE     ZMTH    20
     C                     MOVE ZDATE     ZWRK4   40
     C  N98                MOVELZWRK4     ZMTH
     C   98                MOVELZWRK4     ZDAY
     C**
     C**   ENSURE MONTH IS VALID.
     C           ZMTH      COMP 0                      9999
     C  N99      ZMTH      COMP 12                   99
     C   99                GOTO ZDEND1                     BYPASS IF ERROR
     C**
     C**   CHECK FOR 30 DAY MONTHS.
     C           ZMTH      COMP 4                        90IF 90 ON, 30
     C  N90      ZMTH      COMP 6                        90DAY MONTH.
     C  N90      ZMTH      COMP 9                        90
     C  N90      ZMTH      COMP 11                       90
     C**
     C**   ENSURE DAY IS VALID.
     C           ZDAY      COMP 0                      9999
     C   90N99   ZDAY      COMP 30                   99
     C  N90N99   ZDAY      COMP 31                   99
     C   99                GOTO ZDEND1                     BYPASS IF ERROR
     C**
     C**   CHECK FOR LEAP YEAR AND FEBRUARY.
     C           ZYEAR     ADD  28        ZYEAR
     C           ZYEAR     DIV  4         ZLYR    20
     C                     MVR            ZLY     10     91LEAP YR, 91 ON
     C           ZMTH      COMP 2                    93  92FEB., 92 ON
     C**                                                   PAST FEB, 93 ON
     C**   IF FEBUARY FURTHER VALIDATE DAY.
     C  N91 92   ZDAY      COMP 28                   99
     C   91 92   ZDAY      COMP 29                   99
     C   99                GOTO ZDEND1                     BYPASS IF ERROR
     C**
     C**   DETERMINE NUMBER OF DAYS FROM 31/12/1971.     NO.OF 4 YR. SPANS
     C           ZLYR      MULT 1461      ZDAYNO           X DAYS IN SPAN.
     C  N91      ZDAYNO    ADD  ZYDY,ZLY  ZDAYNO           SINCE LAST L.YR
     C   91 93   ZDAYNO    ADD  1         ZDAYNO           L.YR.,PAST FEB.
     C           ZDAYNO    ADD  ZMDY,ZMTH ZDAYNO           DAYS THIS YEAR
     C           ZDAYNO    ADD  ZDAY      ZDAYNO           DAYS THIS MONTH
     C**
     C           ZDEND1    ENDSR                           * ZDEND1 ENDSR*
     C**
     C**
     C********************************************************************
     C/EJECT
     C**
     C********************************************************************
     C**
     C**   ZDATE2 SR. TO CONVERT A DAY NUMBER TO DATE FORMATS.
     C**
     C**   THE YEAR 2000, BEING DIVISIBLE BY 400, IS A LEAP YEAR.
     C**
     C           ZDATE2    BEGSR                           *** ZDATE2 ***
     C**
     C**   CLEAR DATE FIELDS.
     C                     Z-ADD0         ZDATE   60
     C                     MOVEL'       ' ZADATE  7
     C**
     C**   CALCULATION TO DEFINE INPUT DAY NUMBER.
     C                     Z-ADDZDAYNO    ZDAYNO  50
     C**
     C**   DETERMINE YEAR NUMBER.
     C**
     C**   ADJUST DAY NUMBER IN CASE LAST DAY OF YEAR.
     C           ZDAYNO    SUB  1         ZDAYN1  50   99
     C   99                GOTO ZDEND2
     C**
     C**   CALCULATE NUMBER OF 4 YEAR SPANS SINCE 31/12/1971.
     C           ZDAYN1    DIV  1461      ZLYR    20
     C                     MVR            ZDAYN1           SAVE REMAINING
     C**                                                   DAYS
     C**   CALCULATE NUMBER OF REMAINING YEARS.
     C                     Z-ADD1         ZWRK2   20
     C           ZDTAG1    TAG                             ** ZDTAG1 TAG *
     C           ZDAYN1    COMP ZYDY,ZWRK2             90
     C  N90      ZWRK2     ADD  1         ZWRK2
     C  N90                GOTO ZDTAG1
     C           ZWRK2     SUB  1         ZWRK2          91LEAP YR, 91 ON
     C**
     C**   DECREMENT DAY NO. BY DAYS IN REMAINING YEARS.
     C  N91      ZDAYN1    SUB  ZYDY,ZWRK2ZDAYN1
     C**
     C**   CALCULATE ACTUAL YEAR NUMBER.
     C           ZLYR      MULT 4         ZWRK3   30
     C           ZWRK3     ADD  72        ZWRK3            BASE IS 1972
     C                     Z-ADDZWRK3     ZYEAR   20
     C           ZYEAR     ADD  ZWRK2     ZYEAR            YEAR
     C**
     C**   DETERMINE MONTH NUMBER.
     C**
     C**   ADJUST DAY NO. IN CASE LAST DAY OF LEAP YEAR FEBRUARY.
     C                     SETOF                     9293
     C   91      ZDAYN1    COMP 59                     9293
     C   91N92   ZDAYN1    SUB  1         ZDAYN1
     C**
     C**   CALCULATE MONTH NUMBER.
     C                     Z-ADD2         ZWRK2
     C           ZDTAG2    TAG                             ** ZDTAG2 TAG *
     C           ZDAYN1    COMP ZMDY,ZWRK2             94
     C  N94      ZWRK2     ADD  1         ZWRK2
     C  N94                GOTO ZDTAG2
     C           ZWRK2     SUB  1         ZWRK2
     C**
     C                     Z-ADDZWRK2     ZMTH    20       MONTH
     C**
     C**   DETERMINE DAY OF MONTH.
     C**
     C**   ADD BACK LAST DAY OF YEAR ADJUSTMENT.
     C           ZDAYN1    ADD  1         ZDAYN1
     C**
     C**   CALCULATE DAY OF MONTH.
     C           ZDAYN1    SUB  ZMDY,ZWRK2ZDAY    20       DAY
     C**
     C**   ADD BACK LEAP YEAR 29TH FEBUARY ADJUSTMENT, IF REQUIRED.
     C   93      ZDAY      ADD  1         ZDAY
     C**
     C**   FORMAT DATE, DDMMYY OR MMDDYY.
     C  N98                MOVELZDAY      ZWRK4   40
     C   98                MOVE ZDAY      ZWRK4
     C  N98                MOVE ZMTH      ZWRK4
     C   98                MOVELZMTH      ZWRK4
     C                     MOVELZWRK4     ZDATE
     C                     MOVE ZYEAR     ZDATE
     C**
     C**   FORMAT ALPHA DATE, DDMMMYY.
     C           ZDAY      COMP 10                     95
     C                     MOVELZDAY      ZWRK5   5
     C   95                MOVEL' '       ZWRK5
     C                     MOVE ZMNM,ZMTH ZWRK5
     C                     MOVELZWRK5     ZADATE
     C                     MOVE ZYEAR     ZADATE
     C**
     C           ZDEND2    ENDSR                           * ZDEND2 ENDSR*
     C/EJECT                                                              S01194
     C********************************************************************S01194
     C**                                                                  S01194
     C**                                                                  S01194
     C**   FLDQRY SUBROUTINE                                              S01194
     C**                                                                  S01194
     C           FLDQRY    BEGSR                                          S01194
      *----------------------------------------------------------------   S01194
      * Subroutine to resolve entry of ? for standing data fields.        S01194
      * Performed after function key validation and prior to field        S01194
      * validation                                                        S01194
      *                                                                   S01194
      * Indicators used:                                                  S01194
      *  13       used in LOKUP, on if ? found in currency field          S01194
      *  14       used in LOKUP, on if ? found in branch code field       S01194
      *  15       on then redisplay screen                                S01194
      *----------------------------------------------------------------   S01194
     C                     SETOF                     15                   S01194
      *                                                                   S01194
      ** Check currency field for entry of ?                              S01194
      *                                                                   S01194
     C                     MOVEA*BLANKS   FLDQ                            S01194
     C                     MOVEA@SCCY     FLDQ                            S01194
     C                     SETOF                     13                   S01194
     C           '?'       LOKUPFLDQ                     13               S01194
      *                                                                   S01194
      ** Check branch code for entry of ?                                 S01194
      *                                                                   S01194
     C                     MOVEA*BLANKS   FLDQ                            S01194
     C                     MOVEA@BRCA     FLDQ                            S01194
     C                     SETOF                     14                   S01194
     C           '?'       LOKUPFLDQ                     14               S01194
      ********************************************************************S01194
      *                                                                   S01194
      ** If ? found, seton redisplay ind and call access program          S01194
      *                                                                   S01194
     C           *IN13     IFEQ '1'                                       S01194
     C                     SETON                     15                   S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM *BLANKS   @RTCD   7                       S01194
     C                     PARM '*KEY'    @OPTN   7                       S01194
     C                     PARM '?'       P@K101  3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
      *                                                                   S01194
      ** If selection made, move value to screen field                    S01194
      *                                                                   S01194
     C           @RTCD     IFEQ *BLANKS                                   S01194
     C                     MOVELA6CYCD    @SCCY                           S01194
     C                     ELSE                                           S01194
     C                     MOVEL*BLANKS   @SCCY                           S01194
     C                     END                                            S01194
     C                     SETOF                     13                   S01194
     C                     END                                            S01194
      ********************************************************************S01194
      *                                                                   S01194
      ** If ? found, seton redisplay ind and call access program          S01194
      *                                                                   S01194
     C           *IN14     IFEQ '1'                                       S01194
     C                     SETON                     15                   S01194
     C**********           CALL 'AOBRCHR0'                                S01194              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM '?'       @DSNB   3                       S01194
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01194              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *                                                                   S01194
      ** If selection made, move value to screen field                    S01194
      *                                                                   S01194
     C           @RTCD     IFEQ *BLANKS                                   S01194
     C                     MOVELA8BRCD    @BRCA                           S01194
     C                     ELSE                                           S01194
     C                     MOVEL*BLANKS   @BRCA                           S01194
     C                     END                                            S01194
     C                     SETOF                     14                   S01194
     C                     END                                            S01194
      *-------------------------------------------------------------------S01194
      *                                                                   S01194
     C   15                EXFMTFT0155F1                                  S01194
     C                     ENDSR                                          S01194
     C************************************************************
     C/EJECT                                                              S01194
** CPY@   **      OBJECT COPYRIGHT
(c) Misys International Banking Systems Ltd. 2001
**  @TX - Large text strings
 No payments matching selection criteria
**  @TX2 - Large text strings                                             042167
 Transaction processing already started                                   042167
**  @TS - Large text strings   **** used to be 'Last destination on file' E32790
 Last sender on file
**  @AT - Large text strings
 Payments found but user not authorised
**  @FT - Large text strings
 Further Payments found but user not authorised
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
