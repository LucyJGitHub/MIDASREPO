     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
      *****************************************************************
      *                                                               *
      *  Midas - Message Management Module
      *                                                               *
      *  FTP890 - Midas FT Edit Pekao Customer Accountd               *
      *                                                               *
      *  Function:  This program controls the display and update      *
      *             of MEINFMPD records                               *
      *                                                               *
      *  Called By: FTP880  - Display Pekao A/c Detail Records        *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2003            *
      *                                                               *
      *  Last Amend No. EFix0022           Date 22Apr15               *
      *  Last Amend No. MD31937            Date 13Jan15               *
      *  Last Amend No. AR856737           Date 13Sep11               *
      *  Last Amend No. ESL038             Date 02Dec2004             *
      *  Prev Amend No. EEE065             Date 29Jun2004             *
      *                 EEE058  *Amend     Date 09Jun2004             *
      *                 E30004             Date 25Feb2004             *
      *                 PKO001             Date 23Jan2004             *
      *                 ERN054             Date 15Jul2003             *
      *                 EEE058  *Amend     Date 10Jun2003             *
      *                 EEE058             Date 26Feb2003             *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  EFix0022 - Remove /COPY, QWINDSRC. Pgm not compiling         *
      *  MD31937  - Upgrade STP enhancements to BF Midas 2.1          *
      *  AR856737 - Upgrade STP enhancements to Midas Plus level.     *
      *  ESL038 - Funds transfer STP Enhancements                     *
      *  EEE065 - Two types of transfer type R and C                  *
      *  EEE058 - Default non-standard commissions/FX rates on new    *
      *           accounts where a customer already has an existing   *
      *           Live account.                                       *
      *         - Also fix to initialise screen status description.   *
      *  E30004 - Add status Information                              *
      *  PKO001 - Zobra processing                                    *
      *  ERN054 - Cross validate IBAN to currency number              *
      *  EEE058 - Add default account indicator                       *
      *  EEE058 - Incoming STP                                        *
      *                                                               *
      *****************************************************************
     FFTP890DFCF  E                    WORKSTN
     F                                              KINFDS INFDS#
     F                                              KINFSR SRFILE
      * DSP: Midas FT Edit Pekao Customer Accountd  screen)
      *
     FFTPCATJ0IF  E           K        DISK
     F                                              KINFDS INFDS1
     F                                              KINFSR SRFILE
      * RTV : External Customer Details by IBAN
      *
     FFTPCATJ1IF  E           K        DISK
     F                                              KINFSR SRFILE
      * RTV : External Customer Details by Retail Number
      *
     F*FTPCATV1IF  E           K        DISK         KINFSR SRFILE                            ESL038
     FFTPCATV2IF  E           K        DISK         KINFSR SRFILE                             ESL038
      *                                                                                       EEE058
      ** PCAT details in customer id order                                                    EEE058
     FFTPCATV0UF  E           K        DISK                      A    UC
     F                                              KCOMIT
     F                                              KINFSR SRFILE
      * UPD : External Customer Details Update index
      *
     FFTPCEXV0UF  E           K        DISK                      A    UC
     F                                              KCOMIT
     F                                              KINFSR SRFILE
      * UPD : External Customer Extension Details Update index
      *
     F**SDCY11L0IF  E           K        DISK                                                 ERN054
     F**                                              KINFSR SRFILE                           ERN054
     *** RTV : Currency details, ISO definition                                              ERN054
      *                                                                                       ERN054
     FFTRBRCV0IF  E           K        DISK                                                   ERN054
     F                                              KINFSR SRFILE                             ERN054
      * RTV : Rocket Branches                                                                 ERN054
      *                                                                                       ERN054
     E/EJECT
     E                    CPY@    1   1 80
     E*
     E*  Array containing Copyright statement
     E*
     E/COPY MECPYSRC,SRERRE
     E*
     E*  Copysource for error processing
     E*
     I*@PCATV1                                                                                ESL038
     I@PCATV2                                                                                 ESL038
     I              PCIBAN                          CIBAN                                     EEE058
     I              PCRNB1                          CRNB1                                     EEE058
     I              PCRNB2                          CRNB2                                     EEE058
     I              PCBEN1                          CBEN1                                     EEE058
     I              PCBEN2                          CBEN2                                     EEE058
     I              PCBEN3                          CBEN3                                     EEE058
     I              PCRIND                          CRIND                                     EEE058
     I              PCBTYP                          CBTYP                                     EEE058
     I              PCBSEG                          CBSEG                                     EEE058
     I              PCBBRC                          CBBRC                                     EEE058
     I              PCBEXT                          CBEXT                                     EEE058
     I              PCBCCY                          CBCCY                                     EEE058
     I              PCRGON                          CRGON                                     EEE058
     I              PCPESL                          CPESL                                     EEE058
     I              PCIDKS                          CIDKS                                     EEE058
     I              PCGRPO                          CGRPO                                     EEE058
     I              PCRECI                          CRECI                                     EEE058
      * FTPCATP0 for customer commissions retrieval                                           EEE058
      *                                                                                       EEE058
      *                                                                                       EEE058
     I/COPY MECPYSRC,SRERRI
     I*
     I*  End of Program Error Processing copysource
     I*
     I*
      /EJECT
      * Data structures:
     IJBDTTM      DS
      * Job date/time
     I                                        1   60##JDT
     I                                        1   20##JYY
     I                                        3   40##JMM
     I                                        5   60##JDD
     I                                        7  120##JTM
     I                                        7   80##JHH
     I                                        9  100##JNN
     I                                       11  120##JSS
      * ABO DEFINE LARGE STRING FOR CL CMD
     IYARTCM      DS                            512
     I                                        1   1 DUMMY1
     IINFDS#    E DSY2I#DSP
      * Display file information data structure
      *
     IINFDS1    E DSY2I1DSP
      * File information data structure
      *
     I@1DBRC    E DSFTPCATV0
      * UPD : Pekao Customer Account Details Update index
      * Current/previous master file format fields for change control
      *
     I#1DBRC      DS                            242
      * Stored master file format fields
     I@2DBRC    E DSFTPCEXV0
     I              PCIBAN                          EXIBAN
     I              PCRNB1                          EXRNB1
     I              PCRNB2                          EXRNB2
      * UPD : Pekao Customer Account Details Update index
      * Current/previous master file format fields for change control
      *
     I*#2DBRC***** DS                            136                                          EEE058
     I*#2DBRC      DS                            137                                    EEE058E30004
     I#2DBRC      DS                            206                                           E30004
      * Stored master file format fields
     I                                        1   1 #1DB1
      *
     IRUNDTA    E DSRUNDAT
     I*
     I* Get Rundate - Rundate  *
     I*
     IMMODDS    E DSSDMMODPD
     I*
     I* Modules Data Structure *
     I*
     ISDBANK    E DSSDBANKPD
     I*
     I* Modules Data Structure *
     I*
     ISDCURR    E DSSDCURRPD
     I*
     I* Modules Data Structure *
     I*
     ID@ACCT    E DSACCNTAB
      * ACCNTABF - Account details record format data structure
      *
     IDSFDY     E DSDSFDY
     I*
     I* Data Structures used by Access Programs
     I*
     IDSSDY     E DSDSSDY
     I*
     I* Data Structures used by Access Programs
     I*
     IFTPCAT      DS                            256                                           ERN055
     I                                        1  10 V#VAL1                                    ERN055
     I                                        1   1 V#ALN1                                    ERN055
     I                                        2   2 V#ALN2                                    ERN055
     I                                        3   3 V#ALN3                                    ERN055
     I                                        4   4 V#ALN4                                    ERN055
     I                                        5   5 V#ALN5                                    ERN055
     I                                        6   6 V#ALN6                                    ERN055
     I                                        7   7 V#ALN7                                    ERN055
     I                                        8   8 V#ALN8                                    ERN055
     I                                        9   9 V#ALN9                                    ERN055
     I                                       10  10 V#ALN0                                    ERN055
     I                                       11  12 V#POS                                     ERN055
      /EJECT
      * Parameter declarations
     IP1PARM      DS
      * I : MAP Action Code
     I                                        1   1 P1ACTC
     IP2PARM      DS                             68
      * KEY: Pekao Customer A/c Detail Retrieval index
      * I : MAP IBAN
     I                                        1  34 P2IBAN
      * I : MAP Retail Number 1
     I                                       35  50 P2RNB1
      * I : MAP Retail Number 2
     I                                       51  68 P2RNB2
     I            DS
     I                                        1 132 ZAMSDA
      * Message data for 'Invalid Action code (FT)'
      * Action Code
     I                                        1   1 ZA0001
      *
     IDSMTR       DS
      *
      *  Define fields for message transalation
      *
     I                                        1 132 #MSDTA
     I                                      133 264 #MSTX1
     I#MSTX2      DS
     I                                        1 256 #MSTXA
     I                                      257 512 #MSTXB
      *
      /EJECT
      *
      * Data to be passed to window processing
      *
     IDATA        DS                           1024
     I                                        1   1 #DATA1
     I******/COPY QWINDSRC,FTP890WDTA                                                       EFix0022
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
     C           P1ACTC    PARM           WP0001  1        Action Code
     C                     PARM           P2PARM           KEY: PCAT key
      *
      *  Set up primary reference
      *
     C                     MOVELP2PARM    W0PREF
      *****************************************************************
      * Initialise
     C                     EXSR ZZINIT
      *
      * Check passed parameters
     C                     EXSR FACKPM
      * Perform once if all passed, else repeat
     C           W0RPT     DOUEQ'N'
      * Display and process key screen
     C                     EXSR BADSKY
     C                     END
      * Terminate program
     C                     EXSR ZXEXPG
      *****************************************************************
      /EJECT
     CSR         BADSKY    BEGSR
      *================================================================
      * Display and process key screen
      *================================================================
      * Initialise key screen
     C                     EXSR MDIZ#K
      * Bypass first display of key screen is possible
     C                     MOVEL'Y'       W0BYP   1
      * Signal start of transaction
     C                     MOVEL'Y'       W0TRN   1
     C           W0TRN     DOWEQ'Y'
     C           W0TRN     OREQ 'K'
      * Ensure transaction continues (if reset)
     C                     MOVEL'Y'       W0TRN   1
      * Initialise detail screen
     C                     EXSR MAIZ#1
      * Conduct screen conversation
     C           W0TRN     DOWEQ'Y'
      * Is bypass key screen still viable?
     C           W0BYP     IFEQ 'Y'
     C           #1IBAN    IFEQ *BLANK                     IBAN
     C           #1RNBR    ANDEQ*BLANK                     Retail Number
      * One or more key fields is blank
     C                     MOVEL'N'       W0BYP
     C                     END
     C                     END
      * Bypass key screen
     C           W0BYP     IFNE 'Y'
      * Display key screen
     C                     EXSR BBEXFM
     C                     END
      * Cancel key screen bypass
     C                     MOVEL'N'       W0BYP
      * Process response to key screen
      * Cancel & exit program
     C   03                CAS            ZXEXPG
     C   12                CAS            ZXEXPG
      * HOME: Reset screen fields
     C   05                CAS            BDHMKY
      * Process key screen input
     C                     CAS            BEPRKY
     C                     END
     C           W0TRN     DOWEQ'R'
     C                     MOVEL'Y'       W0TRN
     C                     EXSR BEPRKY
     C                     END
      *
     C                     END
     C                     END
      *================================================================
     CSR         BAEXIT    ENDSR
      /EJECT
     CSR         BBEXFM    BEGSR
      *================================================================
      * Display key screen and process HELP requests
      *================================================================
      * Set screen conditioning indicators
     C                     EXSR GADSAK
      * Update screen time
     C                     TIME           ##TME
     C                     MOVE *ALL'0'   ##OFF  30
     C                     MOVEA##OFF     *IN,1
      * PUTOVR unless conditioned fields change
     C                     SETON                         86*
     C           *IN89     IFNE BBIN89
     C                     SETOF                         86*
     C                     END
     C                     MOVE *IN89     BBIN89  1
     C                     WRITE#MSGCTL
     C                     WRITE#CMDTXT1
     C                     EXFMT#RCDKEY
      * Update job time
     C                     TIME           ##JTM
      * Clear messages from program message queue
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGMQ 10
     C                     PARM '*SAME'   ZAPGRL  5
      * Reset first message only flag
     C                     MOVEL'Y'       ZAFSMS  1
      * Reset global error indicator
     C                     SETOF                         99*
      *================================================================
     CSR         BBEXIT    ENDSR
      /EJECT
     CSR         BDHMKY    BEGSR
      *================================================================
      * Process HOME key
      *================================================================
     C                     MOVEL'N'       W0TRN
      *================================================================
     CSR         BDEXIT    ENDSR
      /EJECT
     CSR         BEPRKY    BEGSR
      *================================================================
      * Process key screen input
      *================================================================
      * Validate key fields
     C                     EXSR BFVLKY
     C           *IN99     CABEQ'1'       BEEXIT
      * Check for existing record
     C           KRTV      KLIST
     C                     KFLD           PCIBAN           IBAN
     C                     KFLD           PCRNB1           Retail Number 1
     C                     KFLD           PCRNB2           Retail Number 2
      * Check for existing record
     C           KRTV0     KLIST
     C                     KFLD           PCIBAN           IBAN
      * Check for existing record
     C           KRTV1     KLIST
     C                     KFLD           PCRNB1           Retail Number 1
     C                     KFLD           PCRNB2           Retail Number 2
      * Setup key
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Retail Number 2
     C           KRTV0     CHAIN@PCATJ0              9091  *
     C           *IN90     IFEQ *ON
     C           KRTV1     CHAIN@PCATJ1              9091  *
     C                     ENDIF                           FI 91
     C           *IN91     IFEQ '1'
      * Record locked
     C                     SETON                     993132*
     C                     GOTO BEEXIT
     C                     END                             FI 91
      *
      * If record does not exist, flip to add mode
     C           *IN90     IFEQ '1'
     C                     MOVEL'ADD'     W0PMD
      * USER: Initialise detail screen (new record)
      * EDTRCD: Init. det. scr NW - R10 Copy source templates  * 
     C                     ELSE
      *
      * If not insert then send record already exists
      *
     C           P1ACTC    IFEQ 'I'
     C                     MOVEA'1111'    *IN,31
     C                     MOVEL'1'       *IN99
      * Send message 'Already exists'
     C                     MOVEL'MIN0066' ZAMSID
     C                     EXSR ZASNMS
     C                     GOTO BEEXIT
     C                     END
      * If record does exist, flip to change mode
     C                     MOVEL'CHG'     W0PMD
      * Load screen fields from DBF
     C                     EXSR MBFL#1
      * CALC: Detail screen function fields
      * USER: Initialise detail screen (existing record)
     C                     END
      *..................................................
     C   99                GOTO BEEXIT
      *
      * No error: Display and process details
     C                     EXSR CADSDA
      *
      *================================================================
     CSR         BEEXIT    ENDSR
      /EJECT
     CSR         BFVLKY    BEGSR
      *================================================================
      * Validate key fields
      *================================================================
      * Check relations
      * USER: Validate key screen
      *
      * IBAN or Retail Number must not be blank
     C           #1IBAN    IFEQ *BLANK                     IF
     C           #1RNBR    ANDEQ*BLANK                     IF
     C                     SETON                     993132*
      * Send message '*Value required'
     C                     MOVEL'Y2U0001' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END                             FI
      *                                                                                       ERN054
      * Check IBAN correct                                                                    ERN054
     C*****      'PL'      CAT  #1IBAN:0  P5IBAN    P                                   ERN054MKEMR1
     C                     MOVEL*BLANKS   P5IBAN                                              MKEMR1
     C                     MOVEL#1IBAN    P5IBAN                                              MKEMR1
     C                     CALL 'AOIBANR4'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*KEY   ' P@OPTN  7
     C                     PARM           P5IBAN 34
     C           D@ACCT    PARM *BLANKS   DSSDY
     C***                  CALL 'AOIBANR5'                                                    ERN054
     C***                  PARM *BLANKS   P@RTCD                                              ERN054
     C***                  PARM           P5IBAN 34                                           ERN054
      *                                                                                       ERN054
     C           P@RTCD    IFNE *BLANKS                    IF                                 ERN054
     C           P1ACTC    IFNE 'D'                                                           ERN054
     C           P1ACTC    ANDNE'E'                                                           ERN054
     C                     SETON                     9931  *                                  ERN054
     C                     ENDIF                                                              ERN054
      * Send message 'Incorrect IBAN '                                                        ERN054
     C           1         SUBSTP@RTCD:7  ZAMSDA    P                                         ERN054
     C                     MOVEL'PTC0043' ZAMSID                                              ERN054
     C                     MOVEL'XXUSRMSG'ZAMSGF                                              ERN054
     C                     EXSR ZASNMS                                                        ERN054
     C                     END                             FI                                 ERN054
      *                                                                                       ERN054
      * If valid IBAN check that branch is valid                                              ERN054
     C           *IN31     IFEQ *OFF                       IF                                 ERN054
     C           8         SUBST#1IBAN:5  RBBRCH    P                                         ERN054
     C           RBBRCH    CHAIN@RBRCV0              90                                       ERN054
     C           *IN90     IFEQ *ON                        IF                                 ERN054
     C           *IN90     OREQ *OFF                       IF                                 PKO001
     C           RBTRFT    ANDEQ'R'                        IF                                 PKO001
     C           *IN90     OREQ *OFF                       IF                                 EEE065
     C           RBTRFT    ANDEQ'C'                        IF                                 EEE065
     C           P1ACTC    IFNE 'D'                                                           ERN054
     C           P1ACTC    ANDNE'E'                                                           ERN054
     C                     SETON                     9931  *                                  ERN054
     C                     ENDIF                                                              ERN054
      * Send message 'Invalid Branch '                                                        ERN054
     C                     MOVEL'PTC0044' ZAMSID                                              ERN054
     C                     MOVEL'XXUSRMSG'ZAMSGF                                              ERN054
     C                     EXSR ZASNMS                                                        ERN054
     C                     ENDIF                           FI                                 ERN054
     C                     END                             FI                                 ERN054
      * If V#POS not blanks and insert check position                                         ERN055
     C           V#POS     IFNE *BLANKS                                                       ERN055
     C                     MOVE V#POS     #2N     20                                          ERN055
     C           1         SUBST#1IBAN:#2N##001A  1                                           ERN055
      * Check field for valid numbers                                                         ERN055
     C           V#ALN0    IFEQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'0'                                                           ERN055
     C           V#ALN1    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'1'                                                           ERN055
     C           V#ALN2    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'2'                                                           ERN055
     C           V#ALN3    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'3'                                                           ERN055
     C           V#ALN4    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'4'                                                           ERN055
     C           V#ALN5    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'5'                                                           ERN055
     C           V#ALN6    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'6'                                                           ERN055
     C           V#ALN7    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'7'                                                           ERN055
     C           V#ALN8    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'8'                                                           ERN055
     C           V#ALN9    OREQ 'Y'                                                           ERN055
     C           ##001A    ANDEQ'9'                                                           ERN055
     C                     ELSE                                                               ERN055
     C           P1ACTC    IFEQ 'I'                                                           ERN055
     C                     SETON                     9931  *                                  ERN055
     C                     ENDIF                                                              ERN055
      * Send message 'Invalid Digit  '                                                        ERN055
     C                     MOVELV#POS     ZAMSDA                                              ERN055
     C                     MOVEL'ST10002' ZAMSID                                              ERN055
     C                     MOVEL'XXUSRMSG'ZAMSGF                                              ERN055
     C                     EXSR ZASNMS                                                        ERN055
     C                     ENDIF                                                              ERN055
     C                     ENDIF                                                              ERN055
      *                                                                                       ERN054
      *================================================================
     CSR         BFEXIT    ENDSR
      /EJECT
     CSR         CADSDA    BEGSR
      *================================================================
      * Display and process detail screen
      *================================================================
      * Conduct detail screen conversation
      * - repeat until screen control flag is reset:
     C           W0TRN     DOWEQ'Y'
      * Display detail screen
     C                     EXSR CBEXFM
      * Process response to detail screen
      * Cancel & exit program
     C   03                CAS            ZXEXPG
      * Redisplay previous screen
     C   12                CAS            CCDSPV
      * HOME: Reset screen fields
     C   05                CAS            CCDSPV
      * Process detail screen input
     C                     CAS            CFPRSC
     C                     END
     C           W0TRN     IFEQ 'R'
     C           W0PMD     IFEQ 'ADD'
     C                     MOVEL'Y'       W0TRN
     C                     EXSR MAIZ#1
     C                     END
     C                     END
      *
     C                     END
      *================================================================
     CSR         CAEXIT    ENDSR
      /EJECT
     CSR         CBEXFM    BEGSR
      *================================================================
      * Display screen and process HELP requests
      *================================================================
      * Set screen conditioning indicators
     C                     EXSR GBDSAD
      * Update screen time
     C                     TIME           ##TME
     C                     MOVE *ALL'0'   ##OFF  30
     C                     MOVEA##OFF     *IN,1
      * PUTOVR unless conditioned fields change
     C                     SETON                         86*
     C           *IN89     IFNE CBIN89
     C                     SETOF                         86*
     C                     END
     C                     MOVE *IN89     CBIN89  1
     C                     WRITE#MSGCTL
     C                     WRITE#CMDTXT2
     C                     EXFMT#RCDDTL1
      * Update job time
     C                     TIME           ##JTM
      * Clear messages from program message queue
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGMQ 10
     C                     PARM '*SAME'   ZAPGRL  5
      * Reset first message only flag
     C                     MOVEL'Y'       ZAFSMS  1
      * Reset global error indicator
     C                     SETOF                         99*
      *================================================================
     CSR         CBEXIT    ENDSR
      /EJECT
     CSR         CCDSPV    BEGSR
      *================================================================
      * Redisplay previous screen
      *================================================================
      * USER: Process key screen request
      * EDTRCD: Process key req. - R10 Copy source templates  * 
     C   05                MOVEL'R'       W0TRN
      *
      * If insert go to key screen else exit
      *
     C           *IN12     IFEQ '1'
     C           P1ACTC    IFEQ 'I'
     C                     MOVEL'K'       W0TRN
     C                     ELSE
     C                     EXSR ZXEXPG
     C                     END
     C                     END
      *================================================================
     CSR         CCEXIT    ENDSR
      /EJECT
     CSR         CFPRSC    BEGSR
      *================================================================
      * Validate record
      *================================================================
      * Confirm/update is not deferred
     C                     MOVEL'N'       W0DCF   1
      * If delete is not pending....
      * Validate details
     C           P1ACTC    IFEQ 'I'
     C           P1ACTC    OREQ 'A'
     C  N10                CAS            DCVLDL
     C                     END
     C                     END
      *
      *  Call window processing
      *
     C           *IN99     IFEQ '0'
     C****                 EXSR SRWIND
     C                     END
      * QUIT if error:
     C   99                GOTO CFEXIT
      * Defer confirm/update requested
     C           W0DCF     CABEQ'Y'       CFEXIT
      * No error: update record
     C           P1ACTC    IFEQ 'A'
     C           P1ACTC    OREQ 'I'
     C           P1ACTC    OREQ 'D'
     C           *IN10     ANDEQ'1'
     C                     EXSR EBPR##
     C                     END
      *
      * Exit if enquire
      *
     C           P1ACTC    IFEQ 'E'
     C                     MOVEL'N'       W0RPT
     C                     MOVEL'N'       W0TRN
     C                     END
      *================================================================
     CSR         CFEXIT    ENDSR
      /EJECT
     CSR         DCVLDL    BEGSR
      *================================================================
      * Validate details
      *================================================================
      * USER: Validate detail screen fields
      *
      *
      * Resident indicator must be R or N
      *
     C           #1RIND    IFNE 'R'
     C           #1RIND    ANDNE'N'
     C                     SETON                     9934
     C                     MOVEL'PTC0012' ZAMSID
     C                     MOVEL'XXUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      * Beneficiary type must be I or G
      *
     C           #1BTYP    IFNE 'I'
     C           #1BTYP    ANDNE'G'
     C                     SETON                     9935
     C                     MOVEL'PTC0014' ZAMSID
     C                     MOVEL'XXUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      * Currency must be valid
      *
     C           #1BCCY    IFEQ *BLANKS
     C                     SETON                     9939
     C                     MOVEL'PTC0015' ZAMSID
     C                     MOVEL'XXUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      * Currency must be valid
      *
     C           #1BCCY    IFNE *BLANKS
      *
     C                     CALL 'AOCURRR0'             9090
     C                     PARM *BLANKS   P@RTCD
     C                     PARM '*KEY   ' P@OPTN
     C                     PARM #1BCCY    P@CYCD  3
     C           SDCURR    PARM *BLANKS   DSSDY
      *
      *  If error on call
      *
     C           P@RTCD    IFNE *BLANKS
     C           *IN90     OREQ *ON
     C                     SETON                     9939
     C                     MOVEL'PTC0015' ZAMSID
     C                     MOVEL'XXUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     ELSE
     C           A6CYCD    IFNE #1BCCY
     C                     SETON                     99
     C                     ENDIF
     C                     MOVELA6CYCD    #1BCCY
     C                     ENDIF
      *                                                                                       ERN054
      * Currency  must be the same as that in IBAN                                         ERN054
      *                                                                                       ERN054
     C           #1BCCY    IFNE CCY                                                           ERN054
     C                     SETON                     9939                                     ERN054
     C                     MOVEL'PTC0042' ZAMSID                                              ERN054
     C                     MOVEL'XXUSRMSG'ZAMSGF                                              ERN054
     C                     EXSR ZASNMS                                                        ERN054
     C                     ENDIF                                                              ERN054
     C                     ENDIF                                                              ERN054
      *
      * Segment must be between 01 and 08
      *
     C           #1BSEG    IFNE '01'
     C           #1BSEG    ANDNE'02'
     C           #1BSEG    ANDNE'03'
     C           #1BSEG    ANDNE'04'
     C           #1BSEG    ANDNE'05'
     C           #1BSEG    ANDNE'06'
     C           #1BSEG    ANDNE'07'
     C           #1BSEG    ANDNE'08'
     C           #1BSEG    ANDNE*BLANKS
     C                     SETON                     9936
     C                     MOVEL'PTC0007' ZAMSID
     C                     MOVEL'XXUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     ENDIF
     C           #1BSEG    IFEQ *BLANKS
     C                     MOVEL'08'      #1BSEG                                              EEE058
     C                     ENDIF
      *                                                                                       EEE058
      * Default account must be Y or N defaults to N                                          EEE058
      *                                                                                       EEE058
     C           #1DACC    IFNE 'Y'                                                           EEE058
     C           #1DACC    ANDNE'N'                                                           EEE058
     C           #1DACC    ANDNE*BLANKS                                                       EEE058
     C                     SETON                     9949                                     EEE058
     C                     MOVEL'PTC0050' ZAMSID                                              EEE058
     C                     MOVEL'XXUSRMSG'ZAMSGF                                              EEE058
     C                     EXSR ZASNMS                                                        EEE058
     C                     ENDIF                                                              EEE058
      * Default to N                                                                          EEE058
     C           #1DACC    IFEQ *BLANKS                                                       EEE058
     C                     MOVEL'N'       #1DACC                                              EEE058
     C                     ENDIF                                                              EEE058
      *
      * Pensioner must be Y or N defaults to N
      *
     C           #1PENR    IFNE 'Y'
     C           #1PENR    ANDNE'N'
     C           #1PENR    ANDNE*BLANKS
     C                     SETON                     9948
     C                     MOVEL'PTC0021' ZAMSID
     C                     MOVEL'XXUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     ENDIF
      * Default to N
     C           #1PENR    IFEQ *BLANKS
     C                     MOVEL'N'       #1PENR
     C                     ENDIF
      *                                                                                       EEE058
      * Default existing non-standard customer commissions                                    EEE058
     C           #1IDKS    IFNE *BLANKS                                                       EEE058
     C           W0DFT     IFEQ 'N'                                                           EEE058
     C           #1IDKS    ORNE W0IDKS                                                        EEE058
     C                     MOVEL#1IDKS    W0IDKS                                              EEE058
      *                                                                                       EEE058
      * Check if customer already has a Live account on FTPCATP0                              EEE058
     C*****      #1IDKS    CHAIN@PCATV1              92                                       ESL038
     C           #1IDKS    CHAIN@PCATV2              92                                       ESL038
      *                                                                                       EEE058
      * If Live account exists then check associated commission/FX rate                       EEE058
      *                                                                                       EEE058
     C                     ENDIF                                                              EEE058
     C                     ENDIF                                                              EEE058
      *                                                                                       EEE058
      **Commission indicator must be S for Standard, I for individual or                      EMRMK1
      *****                          N for none                                               EMRMK1
      *****                                                                                   EMRMK1
     C*****      #1COMI    IFNE 'N'                                                           EMRMK1
     C*****      #1COMI    ANDNE'I'                                                           EMRMK1
     C*****      #1COMI    ANDNE'S'                                                           EMRMK1
     C*****                SETON                     9944                                     EMRMK1
     C*****                MOVEL'PTC0008' ZAMSID                                              EMRMK1
     C*****                MOVEL'XXUSRMSG'ZAMSGF                                              EMRMK1
     C*****                EXSR ZASNMS                                                        EMRMK1
     C*****                ENDIF                                                              EMRMK1
      *****                                                                                   EMRMK1
      **FX*Rate indicator must be T for Threshold I for dealer or                             EMRMK1
      *****                          L for Limit amount                                       EMRMK1
      *****                                                                                   EMRMK1
     C*****      #1FXRI    IFNE 'T'                                                           EMRMK1
     C*****      #1FXRI    ANDNE'I'                                                           EMRMK1
     C*****      #1FXRI    ANDNE'L'                                                           EMRMK1
     C*****                SETON                     9946                                     EMRMK1
     C*****                MOVEL'PTC0009' ZAMSID                                              EMRMK1
     C*****                MOVEL'XXUSRMSG'ZAMSGF                                              EMRMK1
     C*****                EXSR ZASNMS                                                        EMRMK1
     C*****                ENDIF                                                              EMRMK1
      *                                                                                       ERN054
      * Check Rocket Branch is library                                                        ERN054
     C********** #1BBRC    IFNE *BLANKS                    IF                                 ERN054
     C                     MOVEL#1BBRC    RBBRCH    P                                         ERN054
     C           RBBRCH    CHAIN@RBRCV0              90                                       ERN054
     C           *IN90     IFEQ *ON                        IF                                 ERN054
      * Or found but part of a transfer to Rocket                                             PKO001
     C           *IN90     OREQ *OFF                       IF                                 PKO001
     C           RBTRFT    ANDEQ'R'                        IF                                 PKO001
     C           *IN90     OREQ *OFF                       IF                                 EEE065
     C           RBTRFT    ANDEQ'C'                        IF                                 EEE065
     C                     SETON                     9937  *                                  ERN054
      * Send message 'Invalid Branch '                                                        ERN054
     C                     MOVEL'PTC0045' ZAMSID                                              ERN054
     C                     MOVEL#1BBRC    ZAMSDA                                              ERN054
     C                     MOVEL'XXUSRMSG'ZAMSGF                                              ERN054
     C                     EXSR ZASNMS                                                        ERN054
     C                     ENDIF                           FI                                 ERN054
     C**********           END                             FI                                 ERN054
      *                                                                                       ERN054
      * CALC: Detail screen function fields
      * USER: Validate detail screen relations
      *================================================================
     CSR         DCEXIT    ENDSR
      /EJECT
     CSR         EBPR##    BEGSR
      *================================================================
      * Process record:
      *================================================================
      * Process delete request
     C   10                CAS            EDDLRQ
      * Process add request
     C           W0PMD     CASEQ'ADD'     ECADRQ
      * Process update request
     C           W0PMD     CASNE'ADD'     EECHRQ
     C                     END
     C           W0RTN     IFNE *BLANK
      * Error: ROLLBACK any DBF changes
     C                     ROLBK
     C                     GOTO EBEXIT
     C                     ELSE
      * Otherwise COMMIT any DBF changes
     C                     COMIT
     C                     END
     C           W0RTN     IFEQ *BLANK
      * USER: Process command keys
     C           W0PMD     IFEQ 'ADD'
      * Exit after successful add
     C                     MOVEL'R'       W0RPT
     C                     END
      * Restart program for next record
     C                     MOVEL'N'       W0TRN
     C                     END
      *================================================================
     CSR         EBEXIT    ENDSR
      /EJECT
     CSR         ECADRQ    BEGSR
      *================================================================
      * Process add request
      *================================================================
      * USER: Create DBF record
      * Create Record - External A/c Records  *
     C                     EXSR SACRRC
     C           W0RTN     IFEQ *BLANK
      * Send message '*Record added'
     C                     MOVEL'Y2U0011' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END
      *================================================================
     CSR         ECEXIT    ENDSR
      /EJECT
     CSR         EDDLRQ    BEGSR
      *================================================================
      * Process delete request
      *================================================================
      * USER: Delete DBF record
      * Delete Record - External A/c records      *
     C                     EXSR SCCHRC
     C           W0RTN     IFEQ *BLANK
      * Send message '*Record deleted'
     C                     MOVEL'Y2U0013' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END
      *================================================================
     CSR         EDEXIT    ENDSR
      /EJECT
     CSR         EECHRQ    BEGSR
      *================================================================
      * Process update request
      *================================================================
      * USER: Change DBF record
      * Change External Account Records                       *
     C                     EXSR SDCHRC
     C           W0RTN     IFNE *BLANK
      * DBF update error
      * Reset screen fields if changed record
     C           W0RTN     CASEQ'Y2U0007' MBFL#1
     C                     END
     C                     ELSE
      * Send message '*Record changed'
     C                     MOVEL'Y2U0012' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END
     C                     EXSR XDCHRC
     C           W0RTN     IFNE *BLANK
      * DBF update error
      * Reset screen fields if changed record
     C           W0RTN     CASEQ'Y2U0007' MBFL#1
     C                     END
     C                     ELSE
      * Send message '*Record changed'
     C                     MOVEL'Y2U0012' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     END
      *================================================================
     CSR         EEEXIT    ENDSR
      /EJECT
     CSR         FACKPM    BEGSR
      *================================================================
      * Check passed parameters
      *================================================================
      * Is full key present?
     C           P2IBAN    IFEQ *BLANK                     IBAN
     C           P2RNB1    ANDEQ*BLANK                     Retail Number 1
      * Not every key field passed - loop program
     C                     MOVEL'Y'       W0RPT   1
     C                     ELSE
      * Full key passed, so single shot program
     C                     MOVEL'N'       W0RPT
     C                     END
      *================================================================
     CSR         FAEXIT    ENDSR
      /EJECT
     CSR         GADSAK    BEGSR
      *================================================================
      * Set key screen conditioning indicators
      *================================================================
     C           W0PMD     COMP 'ADD'                    89*
      *================================================================
     CSR         GAEXIT    ENDSR
      /EJECT
     CSR         GBDSAD    BEGSR
      *================================================================
      * Set detail screen conditioning indicators
      *================================================================
     C           W0PMD     COMP 'ADD'                    89*
      * Protect key fields on detail screen
     C                     SETON                     88    *
     C                     MOVEL'0'       *IN79
     C           P1ACTC    IFEQ 'E'                        *IF
     C           P1ACTC    OREQ 'D'                        *IF
     C                     MOVEL'1'       *IN79
     C                     END                             *FI
     C                     MOVEL'0'       *IN78
     C           W0PMD     IFEQ 'ADD'                      *IF
     C                     MOVEL'1'       *IN78
     C                     END                             *FI
      * Enable key screen
     C                     SETON                     87    *
      *================================================================
     CSR         GBEXIT    ENDSR
      /EJECT
     CSR         MAIZ#1    BEGSR
      *================================================================
      * Initialise record - except for key fields
      *================================================================
     C                     MOVEL*BLANK    #1RECI           Record Identifi
     C                     MOVEL*BLANK    #1AJOB           Job name
     C                     MOVEL*BLANK    #1AACT           Action Type
     C                     Z-ADD*ZERO     #1RDNB           Run day number
     C                     MOVELP1ACTC    #PACTC           Action Code
     C                     MOVEL*BLANK    #1BEN1           Beneficiary Name 1
     C                     MOVEL*BLANK    #1BEN2           Beneficiary Name 1
     C                     MOVEL*BLANK    #1BEN3           Beneficiary Name 1
     C                     MOVEL*BLANK    #1RIND           Resident/Non/resident
     C                     MOVEL*BLANK    #1BTYP           Beneficiary Type
     C                     MOVEL*BLANK    #1BSEG           Beneficiary Segment
     C                     MOVEL*BLANK    #1BBRC           Beneficiary Branch.
     C                     MOVEL*BLANK    #1BEXT           RABAN Branch External
     C                     MOVEL*BLANK    #1BCCY           Beneficiary A/c Currency
     C                     MOVEL*BLANK    #1RGON           REGON for beneficiary
     C                     MOVEL*BLANK    #1PESL           PESEL for beneficiary
     C                     MOVEL*BLANK    #1IDKS           IDKS cust id for beneficiary
     C                     MOVEL*BLANK    #1GRPO           GRPO code beneficiary
     C                     MOVEL*BLANK    #1AUSR           User name
     C                     MOVEL*BLANK    #1ARDT           Action Date
     C                     Z-ADD*ZERO     #1ATIM           Action Time
      *                                                                                       EEE058
      * Reset default commission work fields                                                  EEE058
     C                     MOVEL'N'       W0DFT   1                                           EEE058
     C                     MOVEL*BLANKS   W0IDKS 12                                           EEE058
      *
      * Fill Command lines and narrative text from messages
      *
     C                     SELEC
      *
      * Insert screen
      *
     C           P1ACTC    WHEQ 'I'
      *
      * Option Name
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'PTC0001' #MSGID
     C                     PARM 'XXUSRMSG'#MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##ONDT
      *
      * Action codes
      *
     C                     MOVEL*BLANKS   ##CMD1
      *
      * Function keys
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'MIN0061' #MSGID
     C                     PARM 'MEMSG'   #MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##CMD2
      *
      * Enquiry screen
      *
     C           P1ACTC    WHEQ 'E'
      *
      * Option Name
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'PTC0002' #MSGID
     C                     PARM 'XXUSRMSG'#MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##ONDT
      *
      * Action codes
      *
     C                     MOVEL*BLANKS   ##CMD1
      *
      * Function keys
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'MIN0061' #MSGID
     C                     PARM 'MEMSG'   #MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##CMD2
      *
      *
      * Amendment screen
      *
     C           P1ACTC    WHEQ 'A'
      *
      * Option Name
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'PTC0003' #MSGID
     C                     PARM 'XXUSRMSG'#MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##ONDT
      *
      * Action codes
      *
     C                     MOVEL*BLANKS   ##CMD1
      *
      * Function keys
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'MIN0061' #MSGID
     C                     PARM 'MEMSG'   #MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##CMD2
      *
      *
      * Delete screen
      *
     C           P1ACTC    WHEQ 'D'
      *
      * Option Name
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'PTC0004' #MSGID
     C                     PARM 'XXUSRMSG'#MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##ONDT
      *
      * Action codes
      *
     C                     MOVEL*BLANKS   ##CMD1
      *
      * Function keys and allow delete key
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'MIN0065' #MSGID
     C                     PARM 'MEMSG'   #MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
     C                     MOVEL'1'       *IN77
      *
     C                     MOVEL#MSTX1    ##CMD2
      *
     C                     ENDSL
      *================================================================
     CSR         MAEXIT    ENDSR
      /EJECT
     CSR         MBFL#1    BEGSR
      *================================================================
      * Move @PCATJ1 fields to screen
      *================================================================
     C                     MOVELPCRECI    #1RECI           Record Identifi
     C                     MOVELPCAJOB    #1AJOB           Job name
     C                     MOVELPCAACT    #1AACT           Action Type
     C                     Z-ADDPCRDNB    #1RDNB           Run day number
     C                     MOVELP1ACTC    #PACTC           Action Code
     C                     MOVELPCBEN1    #1BEN1           Beneficiary Name 1
     C                     MOVELPCBEN2    #1BEN2           Beneficiary Name 1
     C                     MOVELPCBEN3    #1BEN3           Beneficiary Name 1
     C                     MOVELPCRIND    #1RIND           Resident/Non/resident
     C                     MOVELPCBTYP    #1BTYP           Beneficiary Type
     C                     MOVELPCBSEG    #1BSEG           Beneficiary Segment
     C                     MOVELPCBBRC    #1BBRC           Beneficiary Branch.
     C                     MOVELPCBEXT    #1BEXT           RABAN Branch External
     C                     MOVELPCBCCY    #1BCCY           Beneficiary A/c Currency
     C                     MOVELPCRGON    #1RGON           REGON for beneficiary
     C                     MOVELPCPESL    #1PESL           PESEL for beneficiary
     C                     MOVELPCIDKS    #1IDKS           IDKS cust id for beneficiary
     C                     MOVELPCGRPO    #1GRPO           GRPO code beneficiary
     C                     MOVELPCAUSR    #1AUSR           User name
     C                     MOVELPCARDT    #1ARDT           Action Date
     C                     Z-ADDPCATIM    #1ATIM           Action Time
      * Hold existing record image
     C                     MOVEL@1DBRC    #1DBRC
     C                     MOVELPCIBAN    EXIBAN           IBAN
     C                     MOVELPCRNB1    EXRNB1           Retail Number 1
     C                     MOVELPCRNB2    EXRNB2           Message Field T
     C                     MOVEL@2DBRC    #2DBRC
      *================================================================
     CSR         MBEXIT    ENDSR
      /EJECT
     CSR         MDIZ#K    BEGSR
      *================================================================
      * Initialise key screen
      *================================================================
     C                     MOVELP1ACTC    #PACTC           Action Code
     C                     MOVELP2IBAN    #1IBAN           IBAN
     C                     MOVELP2RNB1    #1RNBR           Retail Number
     C                     MOVE P2RNB2    #1RNBR           Retail Number
      * USER: Initialise key screen
      *
      * Option Name
      *
     C                     MOVEL'1'       *IN77
     C                     CALL 'MEC1150'              9090
     C                     PARM 'PTC0001' #MSGID
     C                     PARM 'XXUSRMSG'#MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    ##ONKY
      *
      * Action codes
      *
     C                     MOVEL*BLANKS   #KCMD1
      *
      * Function keys
      *
     C                     CALL 'MEC1150'              9090
     C                     PARM 'MIN0061' #MSGID
     C                     PARM 'MEMSG'   #MSGF
     C                     PARM           #MSDTA
     C                     PARM *BLANKS   #MSTX1
     C                     PARM *BLANKS   #MSTX2
      *
     C                     MOVEL#MSTX1    #KCMD2
      *================================================================
     CSR         MDEXIT    ENDSR
      /EJECT
     CSR         SACRRC    BEGSR
      *================================================================
      * Create Record - Incoming Msg Translation  * 
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move all fields to @PCATV0/PCEXV0
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Message Field T
     C                     MOVEL#1BEN1    PCBEN1           Beneficiary Name 1
     C                     MOVEL#1BEN2    PCBEN2           Beneficiary Name 1
     C                     MOVEL#1BEN3    PCBEN3           Beneficiary Name 1
     C                     MOVEL#1RIND    PCRIND           Resident/Non/resident
     C                     MOVEL#1BTYP    PCBTYP           Beneficiary Type
     C                     MOVEL#1BSEG    PCBSEG           Beneficiary Segment
     C                     MOVEL#1BBRC    PCBBRC           Beneficiary Branch.
     C                     MOVEL#1BEXT    PCBEXT           RABAN Branch External
     C                     MOVEL#1BCCY    PCBCCY           Beneficiary A/c Currency
     C                     MOVEL#1RGON    PCRGON           REGON for beneficiary
     C                     MOVEL#1PESL    PCPESL           PESEL for beneficiary
     C                     MOVEL#1IDKS    PCIDKS           IDKS cust id for beneficiary
     C                     MOVEL#1GRPO    PCGRPO           GRPO code beneficiary
     C                     MOVEL'D'       PCRECI           Record Identifi
     C                     MOVEL##JOB     PCAJOB           Job name
     C                     MOVEL##USR     PCAUSR           User name
     C                     Z-ADD##JTM     PCATIM           Action Time
     C                     MOVELWUMRDT    PCARDT           Action Date
     C                     MOVEL'I'       PCAACT           Action Type
     C                     Z-ADDWURDNB    PCRDNB           Run day number
      *
     C           KLCRSA    KLIST
     C                     KFLD           PCIBAN           IBAN
     C*****                KFLD           PCRNB1           Retail Number 1                    ESL038
     C*****                KFLD           PCRNB2           Retail Number 2                    ESL038
      * Check for duplicate primary key
     C           KLCRSA    SETLL@PCATV0                  90*
     C           *IN90     IFEQ '1'
     C                     MOVEL'CCS0093' W0RTN   7
      * USER: Processing if DBF record already exists
      * Change Record *
     C                     EXSR SBCHRC
     C                     ELSE
      *
      *                                                                                       EMRMK1
     C           #1IBAN    CAT  #1RNBR    P2PARM                                              EMRMK1
      * Cal new maintenance function                                                          EMRMK1
     C           P0RTN     IFEQ *BLANKS                    *IF                                EMRMK1
     C                     CALL 'FTP1095'                                                     EMRMK1
     C                     PARM           P0RTN   7                                           EMRMK1
     C                     PARM 'A'       WP0002  1        Action Code                        EMRMK1
     C                     PARM           P2PARM           KEY: Incoming M                    EMRMK1
     C                     ENDIF                                                              EMRMK1
      *                                                                                       EMRMK1
     C                     MOVE *ON       *IN12                                               EMRMK1
      *                                                                                       EMRMK1
     C                     WRITE@PCATV0                91  *
     C                     ENDIF
      *
     C           *IN91     IFEQ '1'
      * Write error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF write successful
     C                     END
      * Check for duplicate primary key
     C           KLCRSA    SETLL@PCEXV0                  90*
     C           *IN90     IFEQ '1'
     C                     MOVEL'CCS0093' W0RTN   7
      * USER: Processing if DBF record already exists
      * Change Record *
     C                     EXSR XBCHRC
     C                     GOTO SAEXIT
     C                     END
      *
     C                     WRITE@PCEXV0                91  *
      *
     C           *IN91     IFEQ '1'
      * Write error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF write successful
     C                     END
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         SBCHRC    BEGSR
      *================================================================
      * Change Record *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move key fields to @PCATV0
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Message Field T
      *
     C           KLCHSB    KLIST
     C                     KFLD           PCIBAN           IBAN
     C****                 KFLD           PCRNB1           Retail Number 1                    ESL038
     C****                 KFLD           PCRNB2           Retail Number 2                    ESL038
     C           KLCHSB    CHAIN@PCATV0              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     MOVEL'Y2U0009' W0RTN   7
      * Send message '*Record no longer on file'
     C                     MOVEL'Y2U0009' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     GOTO SBEXIT
     C                     END
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     GOTO SBEXIT
     C                     END
      *
      * Move non-key fields to @PCATV0
     C                     MOVEL#1BEN1    PCBEN1           Beneficiary Name 1
     C                     MOVEL#1BEN2    PCBEN2           Beneficiary Name 1
     C                     MOVEL#1BEN3    PCBEN3           Beneficiary Name 1
     C                     MOVEL#1RIND    PCRIND           Resident/Non/resident
     C                     MOVEL#1BTYP    PCBTYP           Beneficiary Type
     C                     MOVEL#1BSEG    PCBSEG           Beneficiary Segment
     C                     MOVEL#1BBRC    PCBBRC           Beneficiary Branch.
     C                     MOVEL#1BEXT    PCBEXT           RABAN Branch External
     C                     MOVEL#1BCCY    PCBCCY           Beneficiary A/c Currency
     C                     MOVEL#1RGON    PCRGON           REGON for beneficiary
     C                     MOVEL#1PESL    PCPESL           PESEL for beneficiary
     C                     MOVEL#1IDKS    PCIDKS           IDKS cust id for beneficiary
     C                     MOVEL#1GRPO    PCGRPO           GRPO code beneficiary
     C                     MOVEL'D'       PCRECI           Record Identifi
      *
     C           #1IBAN    CAT  #1RNBR    P2PARM                                              EMRMK1
      * Cal new maintenance function                                                          EMRMK1
     C           P0RTN     IFEQ *BLANKS                    *IF                                EMRMK1
     C                     CALL 'FTP1095'                                                     EMRMK1
     C                     PARM           P0RTN   7                                           EMRMK1
     C                     PARM 'A'       WP0002  1        Action Code                        EMRMK1
     C                     PARM           P2PARM           KEY: Incoming M                    EMRMK1
     C                     ENDIF                                                              EMRMK1
      *                                                                                       EMRMK1
     C                     MOVE *ON       *IN12                                               EMRMK1
      *                                                                                       EMRMK1
     C                     UPDAT@PCATV0                91  *
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF change successful
     C                     END
      *================================================================
     CSR         SBEXIT    ENDSR
      /EJECT
     CSR         XBCHRC    BEGSR
      *================================================================
      * Change Record *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move key fields to @PCEXV0
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Message Field T
      *
     C           KLCHSB    CHAIN@PCEXV0              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     MOVEL'Y2U0009' W0RTN   7
      * Send message '*Record no longer on file'
     C                     MOVEL'Y2U0009' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     GOTO XBEXIT
     C                     END
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     GOTO XBEXIT
     C                     END
      *
      * Move non-key fields to @PCEXV0
     C                     MOVEL##JOB     PCAJOB           Job name
     C                     MOVEL##USR     PCAUSR           User name
     C                     Z-ADD##JTM     PCATIM           Action Time
     C                     MOVELWUMRDT    PCARDT           Action Date
     C                     MOVEL'I'       PCAACT           Action Type
     C                     Z-ADDWURDNB    PCRDNB           Run day number
      *
     C                     UPDAT@PCEXV0                91  *
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF change successful
     C                     END
      *================================================================
     CSR         XBEXIT    ENDSR
      /EJECT
     CSR         SCCHRC    BEGSR
      *================================================================
      * Delete Record   *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move key fields to @PCEXV0
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Message Field T
      *
     C           KLCHSC    KLIST
     C                     KFLD           PCIBAN           IBAN
     C****                 KFLD           PCRNB1           Retail Number 1                    ESL038
     C****                 KFLD           PCRNB2           Retail Number 2                    ESL038
     C           KLCHSC    CHAIN@PCATV0              9091  *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     MOVEL'Y2U0009' W0RTN   7
      * Send message '*Record no longer on file'
     C                     MOVEL'Y2U0009' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     GOTO SCEXIT
     C                     END
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     GOTO SCEXIT
     C                     END
      *
     C                     MOVELPCIBAN    EXIBAN           IBAN
     C                     MOVELPCRNB1    EXRNB1           Retail Number 1
     C                     MOVELPCRNB2    EXRNB2           Message Field T
      * Check for changed record
     C           #1DBRC    IFNE @1DBRC                     IF
     C                     MOVEL'Y2U0007' W0RTN   7
      * Send message '*Update not accepted'
     C                     MOVEL'Y2U0007' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
      * Use SETLL to release record lock
     C           KLCHSC    SETLL@PCATV0              9091  *
     C                     GOTO SCEXIT
     C                     END                             FI #1DBRC
      *
      * USER: Processing before DBF update
     C                     MOVEL'*'       PCRECI           Record Identifi
     C                     UPDAT@PCATV0                91  *
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF change successful
      * Update saved record image
     C                     MOVEL@1DBRC    #1DBRC
     C                     END
      *
     C           KLCHSC    CHAIN@PCEXV0              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     GOTO SCEXIT
     C                     END
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     GOTO SCEXIT
     C                     END
      *
     C                     MOVELPCIBAN    EXIBAN           IBAN
     C                     MOVELPCRNB1    EXRNB1           Retail Number 1
     C                     MOVELPCRNB2    EXRNB2           Message Field T
      * Check for changed record
     C           #2DBRC    IFNE @2DBRC                     IF
     C                     MOVEL'Y2U0007' W0RTN   7
      * Send message '*Update not accepted'
     C                     MOVEL'Y2U0007' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
      * Use SETLL to release record lock
     C           KLCHSC    SETLL@PCEXV0              9091  *
     C                     GOTO SCEXIT
     C                     END                             FI #1DBRC
      *
      * USER: Processing before DBF update
     C                     MOVEL'D'       PCAACT           Action Type
     C                     MOVEL##JOB     PCAJOB           Job name
     C                     MOVEL##USR     PCAUSR           User name
     C                     Z-ADD##JTM     PCATIM           Action Time
     C                     MOVELWUMRDT    PCARDT           Action Date
     C                     Z-ADDWURDNB    PCRDNB           Run day number
     C                     UPDAT@PCEXV0                91  *
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF change successful
      * Update saved record image
     C                     MOVELPCIBAN    EXIBAN           IBAN
     C                     MOVELPCRNB1    EXRNB1           Retail Number 1
     C                     MOVELPCRNB2    EXRNB2           Message Field T
     C                     MOVEL@2DBRC    #2DBRC
     C                     END
      *================================================================
     CSR         SCEXIT    ENDSR
      /EJECT
     CSR         SDCHRC    BEGSR
      *================================================================
      * Change   *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move key fields to @PCATV0/@PCEXV0
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Message Field T
      *
     C           KLCHSD    KLIST
     C                     KFLD           PCIBAN           IBAN
     C****                 KFLD           PCRNB1           Retail Number 1                    ESL038
     C****                 KFLD           PCRNB2           Retail Number 2                    ESL038
     C           KLCHSD    CHAIN@PCATV0              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
     C                     MOVEL'Y2U0009' W0RTN   7
      * Send message '*Record no longer on file'
     C                     MOVEL'Y2U0009' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     GOTO SDEXIT
     C                     END
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     GOTO SDEXIT
     C                     END
      *
      * Check for changed record
     C           #1DBRC    IFNE @1DBRC                     IF
     C                     MOVEL'Y2U0007' W0RTN   7
      * Send message '*Update not accepted'
     C                     MOVEL'Y2U0007' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
      * Use SETLL to release record lock
     C           KLCHSD    SETLL@PCATV0              9091  *
     C                     GOTO SDEXIT
     C                     END                             FI #1DBRC
      * Move non-key fields to @PCATV0
     C                     MOVEL#1BEN1    PCBEN1           Beneficiary Name 1
     C                     MOVEL#1BEN2    PCBEN2           Beneficiary Name 1
     C                     MOVEL#1BEN3    PCBEN3           Beneficiary Name 1
     C                     MOVEL#1RIND    PCRIND           Resident/Non/resident
     C                     MOVEL#1BTYP    PCBTYP           Beneficiary Type
     C                     MOVEL#1BSEG    PCBSEG           Beneficiary Segment
     C                     MOVEL#1BBRC    PCBBRC           Beneficiary Branch.
     C                     MOVEL#1BEXT    PCBEXT           RABAN Branch External
     C                     MOVEL#1BCCY    PCBCCY           Beneficiary A/c Currency
     C                     MOVEL#1RGON    PCRGON           REGON for beneficiary
     C                     MOVEL#1PESL    PCPESL           PESEL for beneficiary
     C                     MOVEL#1IDKS    PCIDKS           IDKS cust id for beneficiary
     C                     MOVEL#1GRPO    PCGRPO           GRPO code beneficiary
     C                     MOVEL'D'       PCRECI           Record Identifi
      *
     C                     UPDAT@PCATV0                91  *
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF change successful
      * Update saved record image
     C                     MOVEL@1DBRC    #1DBRC
     C                     END
      *================================================================
     CSR         SDEXIT    ENDSR
      /EJECT
     CSR         XDCHRC    BEGSR
      *================================================================
      * Change   *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Move key fields to @PCATV0/@PCEXV0
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Message Field T
      *
     C           KLCHSD    CHAIN@PCEXV0              9091  *
      *
     C           *IN90     IFEQ '1'
      * Record not found
      * Move all fields to @PCATV0/PCEXV0
     C                     MOVEL#1IBAN    PCIBAN           IBAN
     C                     MOVEL#1RNBR    PCRNB1           Retail Number 1
     C                     MOVE #1RNBR    PCRNB2           Message Field T
     C                     MOVEL##JOB     PCAJOB           Job name
     C                     MOVEL##USR     PCAUSR           User name
     C                     Z-ADD##JTM     PCATIM           Action Time
     C                     MOVELWUMRDT    PCARDT           Action Date
     C                     MOVEL'I'       PCAACT           Action Type
     C                     Z-ADDWURDNB    PCRDNB           Run day number
      *
     C                     WRITE@PCEXV0                91  *
      *
     C           *IN91     IFEQ '1'
      * Write error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ENDIF
     C                     GOTO XDEXIT
     C                     END
      *
     C           *IN91     IFEQ '1'
      * Record locked
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     GOTO XDEXIT
     C                     END
      *
      * Check for changed record
     C                     MOVELPCIBAN    EXIBAN           IBAN
     C                     MOVELPCRNB1    EXRNB1           Retail Number 1
     C                     MOVELPCRNB2    EXRNB2           Message Field T
     C           #2DBRC    IFNE @2DBRC                     IF
     C                     MOVEL'Y2U0007' W0RTN   7
      * Send message '*Update not accepted'
     C                     MOVEL'Y2U0007' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
      * Use SETLL to release record lock
     C           KLCHSD    SETLL@PCEXV0              9091  *
     C                     GOTO XDEXIT
     C                     END                             FI #1DBRC
      * Move non-key fields to @PCEXV0
     C                     MOVEL##JOB     PCAJOB           Job name
     C                     MOVEL##USR     PCAUSR           User name
     C                     Z-ADD##JTM     PCATIM           Action Time
     C                     MOVELWUMRDT    PCARDT           Action Date
     C                     MOVEL'A'       PCAACT           Action Type
     C                     Z-ADDWURDNB    PCRDNB           Run day number
      *
     C                     UPDAT@PCEXV0                91  *
     C           *IN91     IFEQ '1'
      * Change error detected
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     ELSE
      * DBF change successful
      * Update saved record image
     C                     MOVELPCIBAN    EXIBAN           IBAN
     C                     MOVELPCRNB1    EXRNB1           Retail Number 1
     C                     MOVELPCRNB2    EXRNB2           Message Field T
     C                     MOVEL@2DBRC    #2DBRC
     C                     END
      *================================================================
     CSR         XDEXIT    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
      * If no message file specified, use default
     C           ZAMSGF    IFEQ *BLANK
     C                     MOVELZADFMF    ZAMSGF
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA132        Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Cancel and exit from key screen
      *================================================================
      * USER: Exit program processing
     C                     MOVEL*BLANK    P0RTN
      *
      * CASE: CTL.*CMD key is CF03
     C           *IN03     IFEQ '1'                        *IF
     C                     MOVEL'Y2U9999' P0RTN            *Return code
     C                     END                             *FI
      * CASE: CTL.*CMD key is CF12
     C           *IN12     IFEQ '1'                        *IF
     C                     MOVEL'USR0790' P0RTN            *Return code
     C                     END                             *FI
      *
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * ROLLBACK any uncommitted DBF changes
     C                     ROLBK                       90
      *
      * Copy any undisplayed messages back to caller
     C                     CALL 'Y2CPMSC'
     C                     PARM           ##PGM
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
      * Initialise indicators for re-entry
     C                     MOVE '0'       *IN
      * Setup job date/time
      *
     C                     Z-ADDUDATE     ##JDT
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Obtain default message file
     C                     MOVEL'MEMSG'   ZADFMF 10
      * Define work field Action Code
     C                     MOVEL*BLANK    WUACTC  1
      * Define work field Run day number
     C                     Z-ADD*ZERO     WURDNB  50
     C                     Z-ADD0         Q       50
     C                     MOVEL'0'       *IN77
      * Open files first time only
     C           W0OPN     IFEQ *BLANK
      * Begin commit control
     C                     CALL 'Y2BGCMC'
     C                     PARM           W0RTN   7
     C           W0RTN     IFNE *BLANK
     C           W0RTN     ANDNE'CPF8351'
     C                     EXSR ZYEXPG
     C                     END
     C                     OPEN FTPCATV0
     C                     OPEN FTPCEXV0
      * Signal that files are now open
     C                     MOVE 'Y'       W0OPN   1
     C                     END
      * Select initial mode
     C           @1NROP    IFEQ *ZERO
      * Add mode
     C                     MOVEL'ADD'     W0PMD   3
     C                     ELSE
      * Change mode
     C                     MOVEL'CHG'     W0PMD
     C                     END
     C                     MOVEL*BLANK    W0GRP   1
      * USER: Initialise program
      * Retrieve Midas Date - R10 Standard Functions  * 
     C*
     C*  Set up copyright parameter
     C*
     C                     MOVEACPY@      BIS@   80
     C*
     C* Get Rundate - Rundate  *
     C*
     C           *NAMVAR   DEFN RUNDAT    RUNDTA
     C                     IN   RUNDTA
     C                     MOVE AGMRDT    ##MRDT  7        Midas Run date
     C                     MOVE AGMRDT    WUMRDT  7        Midas Run date
     C                     MOVE AGRDNB    WURDNB  50       Run day number
     C                     MOVE AGSUC     WUSUC   1        Set up complete
     C                     MOVE AGDFF     WUDFF   1        Date Format
     C                     MOVE AGMBIN    WUMBIN  1        Multi Branched
      *                                                                                       ERN055
      * Validation data area   *                                                              ERN055
      *                                                                                       ERN055
     C           *NAMVAR   DEFN FTPCATDT  FTPCAT                                              ERN055
     C                     IN   FTPCAT                                                        ERN055
     C*
     C* Get modules information
     C*
     C                     CALL 'AOMMODR0'             9090
     C                     PARM *BLANKS   P@RTCD  7        B:Return code
     C                     PARM '*FIRST ' P@OPTN  7        I:Option
     C           MMODDS    PARM *BLANKS   DSFDY            O:Module Flg
      *
      *  If return with an error (LR seton in called program) then
      *  process for database error.
      *
     C           *IN90     IFEQ '1'
     C           P@RTCD    OREQ '*ERROR*'
     C                     MOVEL'AOMMODR0'W0FILE
     C                     MOVEL'*CALL'   W0KEY            ***************
     C                     Z-ADD1         W0ERNB           * DB ERROR 01 *
     C                     MOVEL'MEM5003' W0MSGD           ***************
     C                     MOVEL'MIDAS  ' W0MSGF
     C                     EXSR SRERR
     C                     END
     C*
     C* Get Bank details
     C*
     C                     CALL 'AOBANKR0'             9090
     C                     PARM *BLANKS   P@RTCD  7        B:Return code
     C                     PARM '*FIRST ' P@OPTN  7        I:Option
     C           SDBANK    PARM *BLANKS   DSFDY            O:Module Flg
      *
      *  If return with an error (LR seton in called program) then
      *  process for database error.
      *
     C           *IN90     IFEQ '1'
     C           P@RTCD    OREQ '*ERROR*'
     C                     MOVEL'AOBANKR0'W0FILE
     C                     MOVEL'*CALL'   W0KEY            ***************
     C                     Z-ADD1         W0ERNB           * DB ERROR 01 *
     C                     MOVEL'MEM5003' W0MSGD           ***************
     C                     MOVEL'MIDAS  ' W0MSGF
     C                     EXSR SRERR
     C                     END
      *================================================================
     CSR         ZZEXIT    ENDSR
     C/EJECT
      *================================================================
      *                                                               *
      *  SRWIND   : Control Window Processing                         *
      *                                                               *
      *================================================================
     CSR         SRWIND    BEGSR
      *
      *  Set up subroutine stack name
      *
     C                     ADD  1         Q
     C                     MOVEL'SRWIND'  @STK,Q
      *
      * If window processing call WN0010
      *
     C           BGWDPR    IFEQ 'Y'
      *
      *    /copy to move data into the data structure fields passed
      *     as a parameter to the window controller
      *
      /COPY WNCPYSRC,FTP890MOV1
     C                     SELEC
     C           P1ACTC    WHEQ 'I'
      *
      *     Insert Processing
      *
      /COPY WNCPYSRC,FTP890MOV2
     C           P1ACTC    WHEQ 'A'
      *
      *     Amend Processing
      *
      /COPY WNCPYSRC,FTP890MOV3
     C           P1ACTC    WHEQ 'D'
      *
      *     Delete Processing
      *
      /COPY WNCPYSRC,FTP890MOV4
     C           P1ACTC    WHEQ 'E'
      *
      *     Enquire Processing
      *
      /COPY WNCPYSRC,FTP890MOV5
     C                     ENDSL
      *
     C                     CALL 'WN0010'
     C                     PARM ##PGM     O#PGM  10
     C                     PARM *BLANKS   O#CMD   2
     C                     PARM P1ACTC    O#ACTN  1
     C                     PARM           DATA
     C           R#RTN     PARM *BLANKS   O#RTN   7
     C                     PARM           EXTRA 256
      *
      *   /copy to move data back from the data structure fields passed
      *    as a parameter to the window controller and control user
      *    defined processing.
      *
      /COPY WNCPYSRC,FTP890MOV6
      *
     C           *LIKE     DEFN O#RTN     R#RTN
     C           R#RTN     CABEQ*BLANKS   EXWIND
      *
      *  Check return code and send message on action
      *  - set no update as some action has been specified.
      *
     C                     MOVEL'Y'       W0DCF
     C                     ROLBK
      *
     C                     SELEC
      *
      * *Return code is *User QUIT requested
      *
     C           R#RTN     WHEQ 'Y2U9999'
     C                     MOVEL'Y2U9999' P0RTN
     C                     MOVEL'Y2U9999' ZAMSID
     C                     MOVEL'Y2USRMSG'ZAMSGF
     C                     EXSR ZASNMS
     C                     EXSR ZYEXPG
      *
      * *Return code is WN Window Error
      *
     C           R#RTN     WHEQ 'USR0563'
     C                     MOVEL'USR0563' ZAMSID
     C                     MOVEL'SDUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
      *
      * *Return code is *DBF update error
      *
     C           R#RTN     WHEQ 'USR0567'
     C                     MOVEL'USR0567' ZAMSID
     C                     MOVEL'SDUSRMSG'ZAMSGF
     C                     EXSR ZASNMS
      *
      * *Return code is *Previous Screen
      *
     C           R#RTN     WHEQ 'USR0790'
     C                     MOVEL'MIN0001' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDSL
      *
     C                     END
      *
      *  Unwind subroutine stack name
      *
     C           EXWIND    TAG
     C                     MOVEA*BLANKS   @STK,Q
     C                     SUB  1         Q
      *
     CSR                   ENDSR
      *================================================================
     C/EJECT
     C*
     C* File and Program Error Processing
     C*
     C/COPY MECPYSRC,SRERRC
**  CPY@
(c) Misys International Banking Systems Ltd. 2003
