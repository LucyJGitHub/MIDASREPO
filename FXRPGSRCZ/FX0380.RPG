     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas FX Midas deals update')                          *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Dealing Module                                       *
     F*                                                               *
     F*  FX0380 - Midas Deals Update                                  *
     F*                                                               *
     F*     This program will be made redundant at DBA R4.00          *
     F*     In the interim please check the new ILE RPG versions      *
     F*     and apply any new fixes if they are appropriate.          *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. CDL099             Date 06Oct17               *
      *  Prev Amend No. CSW212             Date 03May12               *
      *                 CER059             Date 19Jul10               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242477             Date 27Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 07Jul06               *
      *                 CSD027             Date 09Dec05               *
      *                 CDL038             Date 10May05               *
      *                 CGL029             Date 01Sep03               *
      *                 CDL010             Date 02Aug02               *
      *                 CAS004             Date 26Jun02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 138389             Date 14Jun00               *
      *                 155333             Date 23May00               *
      * Midas DBA 3.02 -----------------------------------------------*
     F*                 143058             Date 05Oct99               *
      * Midas DBA 3.01 -----------------------------------------------*
      * Midas DBA 3.00 Patch D ---------------------------------------*
     F*                 168991             Date 12Oct99               *
     F* Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 161411             Date 09Jul99               *
     F*                 CEU003             Date 08Jan98               *
     F*                 106279             DATE 27JAN98               *
     F*                 105410             Date 24Sep97               *
     F*                 CDL002             Date 14Jan97               *
     F*                 CAC001             DATE 01FEB96               *
     F*                 S01408             DATE 28MAY96               *
     F*                 S01408             DATE 24MAY96               *
     F*                 099670             DATE 23APR96               *
     F*                 S01408             DATE 20FEB95               *
     F*                 S01486             DATE 06OCT94               *
     F*                 060106             DATE 07JUN94               *
     F*                 057334             DATE 10JAN94               *
     F*                 S01453             DATE 13DEC93               *
     F*                 049432             DATE 03NOV93               *
     F*                 S01440             DATE 06SEP93               *
     F*                 036100             DATE 15JUN93               *
     F*                 E29097             DATE 24NOV92               *
     F*                 BH1043             DATE 28AUG91               *
     F*                 E26614             DATE 26JUL91               *
     F*                 E26613             DATE 26JUL91               *
     F*                 DT0200             DATE 31MAY91               *
     F*                 DT0203             DATE 30MAY91               *
     F*                 RT116              DATE 22MAY91               *
     F*                 BHF889             DATE 08NOV90               *
     F*                 BHF771             DATE 29OCT90               *
     F*                 BHF849             DATE 18OCT90               *
     F*                 DT0068             DATE 10APR91               *
     F*                 E21923             DATE 22JUL90               *
     F*                 E21042             DATE 08MAY90               *
     F*                 E19238             DATE 24FEB90               *
     F*                 E20195             DATE 16FEB90               *
     F*                 E19728             DATE 23JAN90               *
     F*                 E18534             DATE 01JUN89               *
     F*                 E18519             DATE 20JUL89               *
     F*                 E22405             DATE 15AUG90               *
     F*                 E18519             DATE 19OCT89               *
     F*                 E18534             DATE 19OCT89               *
     F*                 E17742             DATE 19OCT89               *
     F*                 S01117             DATE 10MAY89               *
     F*                 S01194             DATE 26APR89               *
     F*                 S01195             DATE 21/04/89              *
     F*                 S01177             DATE 19/04/89              *
     F*                 E16211             DATE 18/01/89              *
     F*                 E13902             DATE 27/07/88              *
     F*                 E14099             DATE 12/07/88              *
     F*                 E12617             DATE 29/04/88              *
     F*                 E12615             DATE 11/04/88              *
     F*                 E12584             DATE 30/03/88              *
     F*                 E12298             DATE 08/03/88              *
     F*          (Superseded by E12279)                               *
     F*                 E12279             DATE 24/02/88              *
     F*                 E12189             DATE 22/02/88              *
     F*                 S01136             DATE 10/12/87              *
     F*                 S01136             DATE 08/12/87              *
     F*                                                               *
     F*---------------------------------------------------------------*
      *                                                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  CSW212 - SWIFT 2012 Changes (Recompile)                      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  242477 - Applied fix 199711.  Incorrect update of FSLI       *
      *           First/Second Leg Indicator).                        *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CDL010 - Prevent last user that actioned the trade from      *
      *           authorising it.Recompile due to changes in FXDEALPP.*
      *  CAS004 - Hedge Accounting Phase A (Recompile)                *
      *  CDL008 - Continuous Linked Settlement                        *
     F*  138389 - When the confo are already ran the first leg, CNFI  *
     F*           for the second leg is corrupted by the first one    *
     F*           and the confo are supressed                         *
     f*  155333 - Restore @@INCY input to ZA0690                      *
     F*  143058 - Applied fix 109681:                                 *
     F*           Set 'confirmation required' indicator always to 'Y' *
     F*           for cancellation, even if 'insert' confirmation     *
     F*           not yet printed                                     *
     F*  168991 - Complete the fix for SC#161411.                     *
     F*  161411 - Pay/Receive messages not being produced for FX deals*
     F*           where additional holidays have been specified,      *
     F*           because the correct currency code is not being used.*
     F*           Change CEU003 uses @RECUR instead of @@INCY - need  *
     F*           to amend SR/ZA0690 to use @RECUR instead of @@INCY. *
     F*  CEU003 - EMU Dealing Settlement Ccy conversion.              *
     F*  106279 - Deal link reference number not being output to      *
     F*           DEALSDB - it is correct on FXDEALPP.                *
     F*  105410 - RECI incorrectly set to 'R' on PF/DTRIXDD which     *
     F*           caused the 'controls out of balance' in List of     *
     F*           Today's Deals report.                               *
     F*  CDL002 - FX Netting.                                         *
     F*  CAC001 - Profit Centre Accounting Development:               *
     F*           For an Option Takedown deal ('OT'), reduce margin   *
     F*           amount of the related 'OP' deal if action is insert *
     F*           and increase the margin of the related 'OP' deal if *
     F*           action is delete.                                   *
     F*  S01408 - Addition of core hook FX0380CCP6                    *
     F*  S01408 - Addition of core hook FX0380CCP5                    *
     F*  099670 - Amend of linked reference number and book code      *
     F*           does not update DEALSDB.                            *
     F*  S01408 - Addition of core hook FX0380FFPG                    *
     F*           Addition of core hook FX0380CCPG                    *
     F*           Addition of core hook FX0380CCP1                    *
     F*           Addition of core hook FX0380CCP2                    *
     F*           Addition of core hook FX0380CCP3                    *
     F*           Addition of core hook FX0380CCP4                    *
     F*  S01486 - Portfolio Management Upgrade to Release 10.         *
     F*  060106 - During validation of hols for the input CCY, ZLOC   *
     F*           was wrong getting that of LOCCY. Get location code  *
     F*           based on the nostro shortname.                      *
     F*  057334 - Set bit 4 in DSTI if over-ride parameter was        *
     F*           passed into the program.                            *
     F*           Applied fix 035347.                                 *
     F*  S01453 - Margin and FX Positions/Points and Base             *
     F*           Currency Positions/Points added to FX input         *
     F*  049432 - Book Code not updated on DEALSDB when an            *
     F*           authorized deal is amended.                         *
     F*  S01440 - The new fields in DEALSDB initialised to zero       *
     F*           (GCPCAP and GCSCAP)                                 *
     F*  E36100 - DTYP overwritten on option takedown                 *
     F*  E29097 - Prevent backvalued deals from producing             *
     F*           S.W.I.F.T. messages.                                *
     F*  BH1043 - BHF771 was incomplete. For settlement methods       *
     F*           03, 04, 05, & 14 must have currency                 *
     F*  E26614 - *PSSR overwrites DBASE with 991, irrespective       *
     F*           of its previous value - change so that it only      *
     F*           changes it if it doesnt't already have a value.     *
     F*                                                               *
     F*  E26613 - BHF771 added calls to #BBAB which were not          *
     F*           on the settlement type. thereby leading to          *
     F*           database errors because the field @RECUR was        *
     F*           blank - change to make subroutine calls             *
     F*           conditional.                                        *
     F*                                                               *
     F*  DT0200 - All settlement fields need to be checked to see     *
     F*           if the settlement details have changed not just     *
     F*           the pre-extended settelments fields                 *
     F*  DT0203 - Recompiled for FXSTDDPP change                      *
     F*  RT116  - BHF933 was not incorporated                         *
     F*  BHF889 - Pay/Rec messages were not produced for the 2nd      *
     F*           leg of a swap due to chaining to the 1st leg        *
     F*           and overwriting some fields.                        *
     F*  BHF771 - When the 1st leg of the swap was reversed, the      *
     F*           2nd leg Pay/Rec. indicator not updated correctly    *
     F*           on index file.                                      *
     F*  BHF849 - Deal is entered and authorized without entry of     *
     F*           settlement instructions. The deal is then amended   *
     F*           and settlement instruction entered. If Pay/Rec      *
     F*           generation is not run prior to the amend the        *
     F*           instructions are not generated during I/C.          *
     F*  DT0068 - Fix E18728 is incomplete - add code to update       *
     F*           DTRIXDD and change status of record on DEALSDB.     *
     F*  E21923 - Set on Pay/Receive Indicator if Event Date is       *
     F*           less than or equal to (Date of next working         *
     F*           day minus one plus Telex Notice Days).              *
     F*  E21042 - A/C seq.no. not output from deals input,            *
     F*           therefore no update is possible for this field.     *
     F*           However this field is necess. in multi-branch       *
     F*           environment, therefore should be output             *
     F*           when writing deal to deals file - DEALSDB.          *
     F*           (Superseded by Multibranching Phase 2 - 01          *
     F*           output instead)                                     *
     F*           Addition of DUMP to assist error handling.          *
     F*  E19238 - To produce confirmation disregarding the Deal       *
     F*           done date (i.e. confirmation always printed for     *
     F*           amend).                                             *
     F*  E20195 - RECI incorrectly set to '*' on DTRIXDD. Caused      *
     F*           confirmations not to be printed and file            *
     F*           controls out of balance in Deals Today Report.      *
     F*  E19728 - Error in deleting Swap Deal if one or both legs     *
     F*           of the deal is not authorised. This fix will        *
     F*           also deal with the inconsistency between the        *
     F*           actual number of records in DTRIXDD and the         *
     F*           control total in DTRIXHH. @RADD is used to          *
     F*           indicate the actual number of records added to      *
     F*           DTRIXDD, and the value is passed back to FX0390     *
     F*           for the updating of the control total in DTRIXHH    *
     F*  E22405 - Add new field to Extended Settlements. (Cover       *
     F*           MT202 required).                                    *
     F*                                                               *
     F*  E18519 - Confirmations should be printed if a deal has       *
     F*           been amended. check against DEALSDB not FXSTDDPP    *
     F*                                                               *
     F*  E18534 - Incorrect update of Pay/Receive indicators on       *
     F*           DTRIXDD causing early swift message issue.          *
     F*                                                               *
     F*  E17742 - Related deal's value date not being output          *
     F*           to DEALSDB.                                         *
     F*                                                               *
     F*  S01117 - Amendments for multi-branching.                     *
     F*                                                               *
     F*  S01194 - Standing Data changes - to use Access Programs.     *
     F*                                                               *
     F*  S01195 - Holidays file format changed.                       *
     F*                                                               *
     F*  S01177 - Extended settlements incorporation.                 *
     F*                                                               *
     F*  E16211 - Release 1 new fields Book Code & Linked             *
     F*           Reference Number not being updated.                 *
     F*                                                               *
     F*  E13902 - If brokerage is to be calculated (ie. all 9's       *
     F*           sent and broker not TELX, PHON, MAIL, SWAP or       *
     F*           blank) set Midas Deals file brokerage to zero       *
     F*           and set on bit to indicate calculation needed.      *
     F*                                                               *
     F*  E14099 - Bit settings for brokerage calculation on           *
     F*           DEALSDB are not being set up for broker code        *
     F*           'SWAP'.                                             *
     F*                                                               *
     F*  E12615 - If Broker = SWAP, the related deal's brokerage      *
     F*           amount and broker code should be copied to this     *
     F*           SWAP deal on DEALSDB.                               *
     F*                                                               *
     F*  E12615 - Setting up CHTP , then chaining to FDCCYTLL         *
     F*           before writing new DTRIX record.  Hence picking     *
     F*           up wrong value of CHTP.                             *
     F*                                                               *
     F*  E12584 - If brokerage is all 9'S, the brokerage amount       *
     F*           is now set to 0 on the Deals file (DEALSDB)         *
     F*                                                               *
     F*  E12298 - Move deal transaction header update to a late       *
     F*           point in commitment cycle.                          *
     F*                                                               *
     F*  E12279 - Core fix to prevent locking out problems.           *
     F*                                                               *
     F*  E12189 - 22/02/88 - FXTB4011 opened inconsistently           *
     F*           between MM and FX with shared access path.          *
     F*           Change by using 'KEY' and not record number.        *
     F*                                                               *
     F*  S01136 - Update DTRIX file correctly                         *
     F*           Pay instructions should update sell                 *
     F*           instructions and Receive should update              *
     F*           purchase instructions, not vice versa.              *
     F*                                                               *
     F*  S01136 - 10/12/87 - Reversal of deal, sign gets muddled      *
     F*           causing incorrect totalling                         *
     F*                                                               *
     F*****************************************************************
     F**  Indicator Function Summary                                  *
     F*                                                               *
     F* ID F  C  H  L    FUNCTION OF INDICATORS                       *
     F* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*
     F*                                                               *
     F*       61   No Transaction to process found on FXSTDDLL        *
     F*               (This error condition now in higher level pgm)  *
     F********63***No*Installation Control Record  on FDICDRLL        *   S01194
     F********64***No*Installation Control Record  on FDTB40LL        *   S01194
     F*       63   Error on read of Bank Details file                 *   S01194
     F*       64   Error on read of Trading Data or Deal Data Codes   *   S01194
     F*                                                 Codes files   *   S01194
     F*       66   No MIDAS Deal Record located on DEALSDB            *
     F*                                                               *
     F*       71   General Work Indicator                             *
     F*       76   Related Deal non-existent for swap                 *
     F*                                                               *
     F*       80 - 99   Common Routines Indicators                    *
     F*                                                               *
     F*          U6    Program Error and dump                         *
     F*          U7    Set on with U8 if a database error occurs.     *
     F*          U8    File out of balance if on on its own.          *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F*                                                               *
     F***                                                             *
     F***  Data Base Error index                                      *
     F*                                                               *
     F*                                                               *
     F*      001   No Transaction to process found on FXSTDDLL        *
     F*               (This error condition now in higher level pgm)  *
     F*      002   No MIDAS Deal Record located on DEALSDB            *
     F*******003***No*Installation Control Record  on FDICDRLL        *   S01194
     F*******004***No*Installation Control Record  on FDTB40LL        *   S01194
     F*      003   Error on read of Bank Details file                 *   S01194
     F*      005   Physical delete on FXSTDDLL failed                 *
     F*               (This error condition now in higher level pgm)  *
     F*      006   Write to DEALSDB  failed   (MIDAS deals file)      *
     F*      007   Update to DEALSDB  failed  (MIDAS deals file)      *
     F*      008   Related deal not found on DEALSDB                  *
     F*      009   MIDAS deals trailer record DEALSDF not found       *
     F*      010   MIDAS deals trailer record DEALSDF update failed   *
     F*      011   Currency record TABTG10 Record not found           *
     F*      012   Write to SDTIX failed   (MIDAS deals index)        *
     F*      013   Read of SDTIX failed    (MIDAS deals index header) *
     F*      014   Update of SDTIX failed   (MIDAS deals index header)*
     F*      020   Error on read of Trading Data file                 *   S01194
     F*      021   Error on read of Deal Data Codes file              *   S01194
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F*
     F*  Installation control files
     F*
     F*XTB40LLIF  E                    DISK         KINFSR INFSR      UC  E12189
     F*FXTB40LLIF*E***********K********DISK         KINFSR INFSRUC E12189 S01194
     F*
     F*FDICDRLLIF*E***********K********DISK         KINFSR INFSR      UC  S01194
     F*****       TABTB20F                          KIGNORE               S01194
     F*FDBRNCLLIF*E********** K ****** DISK         KINFSR INFSRUC  E21042S01314
     F*
     F****************************************************************
     F*
     F*  Masterfiles for reference only
     F*
     F**
     F*FDCCYTLLIF*E***********K********DISK         KINFSR INFSR      UC  S01194
     F**
     F*FDTABJLLIF*E***********K********DISK         KINFSR INFSR      UC  S01194
     F**
     F****************************************************************
     F*
     F*  Deals files
     F*
     F**AMENDED FOR FILE LOCKOUT PROBLEM DTRIX TRAILER UPDATE MOVED.      E12279
     F**TIX   UF  E           K        DISK         KINFSR INFSR A    UC  E12279
     FSDTIX   O   E           K        DISK         KINFSR INFSR A    UC  E12279
     F            DTRIXHF                           KIGNORE               E12279
     F                                              KINFDS @SDT
     F                                              KCOMIT
     FFXMIDBLLUF  E           K        DISK         KINFSR INFSR A    UC
     F                                              KINFDS @MDEA
     F                                              KCOMIT
     F*********** DEALSDAF ************************ KIGNORE ***********
     F*********** DEALSDCF ************************ KIGNORE ***********
     F*********** DEALSDDF ************************ KIGNORE ***********
     F*********** DEALSDEF ************************ KIGNORE ***********
     F**  E19728 - FXDEALLL is added so that the status of the swap       E19728
     F**           deal can be checked                                    E19728
     FFXDEALLLIF  E           K        DISK         KINFSR INFSR      UC  E19728
     F                                              KINFDS @DLST          E19728
     F**
     F*                                                                   S01408
     F/COPY WNCPYSRC,FX0380FFPG                                           S01408
     F*                                                                   S01408
     F*****************************************************************
     F/EJECT
     E*****************************************************************
     E*
     E                    @YD     4   4  5 0A
     E**  ARRAY FOR SR. ZA0680 - CUMULATIVE DAYS IN YEAR FOR 4 YEAR PERIOD
     E*
     E                    @MD    13  13  5 0A
     E**  ARRAY FOR SR. ZA0680 - CUMULATIVE DAYS IN YEAR PER MONTH
     E*
     E*
     E                    @DOM    1  11  5  A@MOM    2 0
     E**  Deal Our Pay/Receive methods against MIDAS Our P/M Methods
     E*
     E                    @ID        15  1
     E**  Array for aligning integer/decimal portions of amount
     E*
     E                    CPY@    1   1 80
     E*   COPYRIGHT ARRAY
     E*****               @CY        50  3                                S01195
     E****USED*BY*SR.*ZA0830*-*CURRENCY RECORDS                           S01195
     E*****                                                               S01195
     E/COPY ZSRSRC,ZHOLE                                                  S01195
     E*****************************************************************
     F/EJECT
     I*****************************************************************
     I**RIXDF                                                             E12279
     I**            VDAT                            DVTDAT                E12279
     IDEALSDBF                                                            E21042
     I              ZZ002                           ACSQ                  E21042
     IPSDS       SDS
     I*
     I**  Program status data structure.
     I**  Field containing file in process.
     I                                      201 208 @FILE
     I**  Field containing workstaion  ID.
     I                                      244 253 @JOB
     I**  Field containing user ID.
     I                                      254 263 @USER
     I*
     I           UDS
     I**  Local data area for data base errors.
     I**  Field containing name of database file in error.
     I                                      134 141 DBFILE
     I**  Field containing key value causing database error.
     I                                      142 170 DBKEY
     I**  Field containing name of program causing database error.
     I                                      171 180 DBPGM
     I**  Field containing number of database error.
     I                                      181 183 DBASE
     I*
     I*
     I**  Read in Standard Deals File as parameter (external Data Structure)
     I*
     I@STDD     E DSFXSTDDPP
     I                                       30  370@VDTE
     I                                       46  530@DOED
     I*
     I*                                                                   S01194
     I* DATA STRUCTURES FOR USE WITH ACCESS PROGRAMS                      S01194
     I*                                                                   S01194
     I@BANK     E DSSDBANKPD                                              S01194
     I* DATA STRUCTURE FOR BANK DETAILS                                   S01194
     I*                                                                   S01194
     I@TRAD     E DSSDTRADPD                                              S01194
     I* DATA STRUCTURE FOR TRADING DATA                                   S01194
     I*                                                                   S01194
     I@DEAL     E DSSDDEALPD                                              S01194
     I              QQACCD                          QQACD2                                    CGL029
     I* DATA STRUCTURE FOR DEAL DATA CODES                                S01194
     I*                                                                   S01194
     I@CURR     E DSSDCURRPD                                              S01194
     I* DATA STRUCTURE FOR CURRENCIES                                     S01194
     I*                                                                   S01194
     I@GELR     E DSSDGELRPD                                              S01194
     I              QQACCD                          QQACD3                                    CGL029
     I* DATA STRUCTURE FOR GENERAL LEDGER DETAILS                         S01194
     I*
     ISDMMOD    E DSSDMMODPD                                              CAC001
     I** External Data Structure for Midas Modules Details                CAC001
     I*                                                                   CAC001
     ISDNOST    E DSSDNOSTPD                                              060106
     I              QQACCD                          QQACD4                                    CGL029
     I*                                                                   060106
     I** External data structure for nostro details                       060106
     I*                                                                   060106
     I*                                                                   060106
     I** Last 3 chars of nostro SNAME is the location code                060106
     I*                                                                   060106
     I                                       29  31 NOSLOC                060106
     I/COPY WNCPYSRC,FX0380I002
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   S01117
     IDSSDY     E DSDSSDY                                                 S01194
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE                S01194
     I*                                                                   S01194
     ISCSARD    E DSSCSARDPD                                              CEU003
      ** Switchable Features File                                         CEU003
      *                                                                   CEU003
     I@SDT        DS
     I                                     *STATUS  @STDT
     I                                        9   9 @DTOPN
     I**  FILE IN. DS. TO TEST IF FILE SDTIX IS OPEN.
     I*
     I@MDEA       DS
     I                                     *STATUS  @STEA
     I                                        9   9 @MAOPN
     I**  FILE IN. DS. TO TEST IF FILE FXMIDBLL IS OPEN.
     I*                                                                   E19728
     I@DLST       DS                                                      E19728
     I                                        9   9 @DLOPN                E19728
     I**  E19728 - FILE IN. DS. TO TEST IF FILE FXDEALLL IS OPEN.         E19728
     I**
     I**
     I*****                                                               S01194
     I*****Table Files Key                                                S01194
     I*****       DS                             12                       S01194
     I*****                                   1  12 KEY                   S01194
     I*****                                   1   2 @PRF                  S01194
     I*****Key to Branch Codes File                                       S01194
     I*****                                  10  12 @BNO                  S01194
     I*****Key to Currency Codes File                                     S01194
     I*****                                   9  11 @CUR                  S01194
     I*****                                  12  12 @SUF                  S01194
     I*****                                                               S01194
     I*
     I*    Avoid compile error, field greater than 256
     I*
     IZZ313       DS                            313
     I                                        1 256 @ZZ1
     I                                      257 313 @ZZ2
     I*
     I*                                                               *
     I**  DATA STRUCTURE FOR SR. ZA0680 - DATE INPUT TO SUBROUTINE
     I            DS                              8
     I                                        1   80@@DTIN
     I                                        1   40@@YYYY
     I                                        3   40@@YY
     I                                        1   20@@CC
     I                                        5   60@@MTH
     I                                        7   80@@DAY
     I*
     I*                                                               *
     I**  Data Structure for aligning integer/decimal purchase amount
     I            DS                             15
     I                                        1  120@INT
     I                                       13  150@DEC
     I                                        1  15 @ID
     I*                                                               *
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@Z71Y
     I            DS                              4
     I                                        1   40@@Z71Y
     I                                        1   10@@SSY1
     I                                        2   20@@SSY2
     I                                        3   30@@SSY3
     I                                        4   40@@SSY4
     I**  DATA STRUCTURE FOR SR. ZA0710 - FIELD IS @@VDT
     I            DS                              8
     I                                        1   80@@VDT
     I                                        1   40@@YR
     I                                        5   60@@Z71M
     I                                        7   80@@Z71D
     I*
     I            DS                            150
     I*
     I****USED*BY*SR.*ZA0830*-*ARRAY DATA STRUCTURE                       S01195
     I*****                                   1 150 @CY                   S01195
     I*****                                   1  75 @@CY1                 S01195
     I*****                                  76 150 @@CY2                 S01195
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     I*
     I            DS                             37
     I*
     I**  Redefine Deal Index fields, as Release 20 DDS insufficient
     I                                       18  37 ZZZ20
     I                                    P  21  230RRLX
     I                                    P  24  260RRXP
     I                                    P  27  290NDLR
     I                                    P  30  320NDAR
     I                                       33  330STPI
     I/COPY WNCPYSRC,FX0380I001
     I*
     I*****       DS                             34                       S01136
     I*
     I**  Redefine Deal Index fields, as Release 20 DDS insufficient
     I*****                                  17  34 ZZZ18                 S01136
     I*****                                  17  17 ACTC                  S01136
     I*****                                  18  18 CREQ                  S01136
     I*****                                  19  19 CPRI                  S01136
     I*****                                  21  250RRNL                  S01136
     I*****                                  26  26 DADI                  S01136
     I*****                                  27  270PRI1                  S01136
     I*****                                  28  280PRI2                  S01136
     I*****                                  29  290PRI3                  S01136
     I*
     I*****************************************************************
      /EJECT
     C**VERSION**
     C**SYSTEM*STATUS*INDICATORS MAINTENANCE                              S01194
     C******               MOVE '00.00.00'@VERS   8                       S01194
     C*
     C*
     C           *ENTRY    PLIST
     C                     PARM           @TERM   1
     C                     PARM           @STDD
     C                     PARM           @RADD   10                      E19728
     C                     PARM           @POVER  1                       057334
     C/COPY WNCPYSRC,FX0380C006
     C*
     C**  Initial processing.
     C*
     C           @FCYC     IFNE 'Y'                        B1
     C           @TERM     ANDNE'T'                        *1
     C                     EXSR #A                         *1
     C                     END                             E1
     C*
     C**  Main processing
     C*
     C           *INU7     IFNE '1'                        B1
     C                     EXSR #B                         *1
     C                     END                             E1
     C*
     C**  Termination processing
     C*
     C                     EXSR #C
     C*
     C           ENDPGM    TAG
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  Index to subroutines - Order of listing due to frequency of  *
     C*                         usage.                                *
     C*                                                               *
     C*   1. #B     - Main processing                                 *
     C*   2. #BA    - Process FXP0051  (Update DEALSDB)               *
     C*   3. #BB    - Process FXP0055  (Update DTRIXDD)               *
     C*   4. #BAA   - Process FXP0216  (Fill in supplementary data)   *
     C*   5. #BAB   - Process FXP0052  (Set confirmation reqd./ bits) *
     C*   6. #BAC   - R/FXR0021 generate a new DEALSDB/FXMIDBLL record*
     C****7.*#BAH***-*Update deals trailer DEALSDF*********************   E12279
     C*   8. #ZA    - Process FXP0053   (Profit/Loss amount/currency) *
     C*   9. #BBA   - Process FXP0056   (Pay/Receive indicators)      *
     C***10. #BBAA  - Process FXP0217   (Fill out supplementary data) *
     C*  11. #BBAB  - Set one pay/receive indicator                   *
     C*  12. #BAD   - R/FXR0022 update related swap                   *
     C*  13. #BAE   - R/FXR0023 update related option                 *
     C*  14. #BAF   - R/FXR0024 update related brokerage swap         *
     C*  15. #BAG   - R/FXR0025 update related swap deletion          *
     C*                                                               *
     C*                                                               *
     C*   --  Common Routines --                                      *
     C*                                                               *
     C***16.*ZA0150*-*Accesses*ICD*file.************************      *   S01194
     C*  17. ZA0680 - Convert date YYYYMMDD to 99999                  *
     C*  18. ZA0690 - Calculate mutual working days                   *
     C*  19. ZA0710 - Convert date 99999 to YYYYMMDD                  *
     C***20.*ZA0830*-*Determine if day is holiday or not              *   S01195
     C*  20. ZCHKH + ZACCH - Determine if day is a holiday or not     *   S01195
     C*                                                               *
     C*   --  Single Call Routines  --                                *
     C*                                                               *
     C*  21. #A     - Initial processing.                             *
     C*  22. #C     - Termination processing.                         *
     C*  23. INFSR  - Error handling sub- routine.                    *
     C*  24. *PSSR  - Error handling sub- routine.                    *
     C*  25. #D     - Accesses Bank Details file.                     *   S01194
     C*                                                               *
     C*                                                               *
     C*                                                               *
     C*                                                               *
     C*   --  External Programs Called --                             *
     C*                                                               *
     C*             **   NONE  **
     C*                                                               *
     C*                                                               *
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #B     - Main Processing; handles screen pro-    *
     C*                       cessing.                                *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : MAIN PROGRAM                                     *
     C*  CALLS     :  #BA    Process FXP0051                          *
     C*               #BB    Process FXP0055                          *
     C*                                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           #B        BEGSR
     C*
     C**  Termination request or data base error already in #A
     C*
     C           @TERM     IFEQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     GOTO #B9                        *1
     C                     END                             E1
     C*
     C**  E19728 - If it is deleting swap deal, first check whether       E19728
     C**           both legs of the deal are authorised or require        E19728
     C**           re-authorisation.                                      E19728
     C**           @DLA  - the deleted leg authorised                     E19728
     C**           @RDLA - the related leg authorised                     E19728
     C                     MOVE 'Y'       @DLA    1                       E19728
     C                     MOVE 'Y'       @RDLA   1                       E19728
     C           F3TYPE    IFEQ 'SW'                       B1             E19728
     C           F3MACT    ANDEQ'R'                        *1             E19728
     C                     MOVE F3DADN    @N6              *1             E19728
     C           @N6       CHAINFXDEALLL             76    *1             E19728
     C           *IN76     IFEQ '1'                        B*2            E19728
     C                     MOVE '016'     DBASE            **2            E19728
     C                     MOVEL'FXDEALLL'DBFILE           **2       *****E19728
     C                     MOVE *BLANKS   DBKEY            **2        016*E19728
     C                     MOVELF3DADN    DBKEY            **2       *****E19728
     C                     MOVE '1'       *INU7            **2            E19728
     C                     MOVE '1'       *INU8            **2            E19728
     C                     GOTO #B9                        **2            E19728
     C                     END                             E*2            E19728
     C           FHDSTS    IFNE 'A'                        B*2            E19728
     C           FHDSTS    ANDNE'R'                        B*2            E19728
     C           FHDSTS    ANDNE'E'                        B*2            DT0068
     C                     MOVE 'N'       @RDLA            **2            E19728
     C                     END                             E*2            E19728
     C           F3DN38    CHAINFXDEALLL             66    *1             E19728
     C           *IN66     IFEQ '1'                        B*2            E19728
     C                     MOVE '017'     DBASE            **2            E19728
     C                     MOVEL'FXDEALLL'DBFILE           **2       *****E19728
     C                     MOVE *BLANKS   DBKEY            **2        017*E19728
     C                     MOVELF3DN38    DBKEY            **2       *****E19728
     C                     MOVE '1'       *INU7            **2            E19728
     C                     MOVE '1'       *INU8            **2            E19728
     C                     GOTO #B9                        **2            E19728
     C                     END                             E*2            E19728
     C           FHDSTS    IFNE 'A'                        B*2            E19728
     C           FHDSTS    ANDNE'R'                        B*2            E19728
     C           FHDSTS    ANDNE'E'                        B*2            DT0068
     C                     MOVE 'N'       @DLA             **2            E19728
     C                     END                             E*2            E19728
     C                     END                             E1             E19728
     C*                                                                   E12279
     C**  To prevent lockout problems the related deal record is          E12279
     C**  accessed and updated to lock the record and stop other          E12279
     C**  users gaining hold of the related record.                       E12279
     C**                                                                  E12279
     C                     MOVE F3DADN    @N6
     C           F3TYPE    IFEQ 'SW'                       B1             E12279
     C           F3MACT    ANDEQ'R'                        *1             E12279
     C**  E19728 - Only access related deal detail if the                 E19728
     C**           related leg is authorised.                             E19728
     C********** @N6       ANDLTF3DN38                     *1     E12279  E19728
     C           @RDLA     ANDEQ'Y'                        *1             E19728
     C**                                                                  E12279
     C           @N6       CHAINFXMIDBLL             76    *1             E12279
     C           *IN76     IFEQ '1'                        B*2            E12279
     C                     MOVE '015'     DBASE            **2            E12279
     C                     MOVEL'DEALSDB 'DBFILE           **2       *****E12279
     C                     MOVE *BLANKS   DBKEY            **2        015*E12279
     C                     MOVELF3DADN    DBKEY            **2       *****E12279
     C                     MOVE '1'       *INU7            **2            E12279
     C                     MOVE '1'       *INU8            **2            E12279
     C                     GOTO #B9                        **2            E12279
     C                     END                             E*2            E12279
     C                     UPDATDEALSDBF               71  *1             E12279
     C                     END                             E1             E12279
     C*
     C**  Read the MIDAS deals Masterfile for amendments
     C*
     C           F3MACT    IFNE 'I'                        B1
     C**  E19728 - Only access deal detail if it is authorised            E19728
     C           @DLA      ANDNE'N'                        B1             E19728
     C           F3DN38    CHAINFXMIDBLL             6666  *1
     C           *IN66     IFEQ '1'                        B*2
     C                     MOVE '002'     DBASE            **2       ********
     C                     MOVEL'DEALSDB 'DBFILE           **2              *
     C                     MOVE *BLANKS   DBKEY            **2              *
     C                     MOVELF3DN38    DBKEY            **2       ERROR  *
     C                     MOVE '1'       *INU7            **2       02     *
     C                     MOVE '1'       *INU8            **2              *
     C                     GOTO #B9                        **2       ********
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  Process FXP0051   (Handle FXMIDBLL, MIDAS Deal File)
     C*
     C                     EXSR #BA
     C*
     C           *INU7     CABEQ'1'       #B9
     C*
     C**  Process FXP0055   (Handle DTRIX, MIDAS Deal Index)
     C*
     C                     EXSR #BB
     C*
     C           *INU7     CABEQ'1'       #B9
     C*
     C*
     C           #B9       ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BA    - Process FXP0051                         *
     C*                                                               *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #B                                               *
     C*  CALLS     : #BAA    Process FXP0216                          *
     C*            : #BAB    Process FXP0052                          *
     C*            : #BAC    Generate a new DEALSDB record            *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BA       BEGSR
     C*
     C*
     C*
     C**  Process FXP0216, Convert date formats and add to suppl. deal
     C*
     C                     EXSR #BAA
     C           F3MACT    IFEQ 'I'                        B1
     C                     MOVE F3DDDN    DDAT             *1
     C                     MOVE F3VDDN    VDAT             *1
     C                     MOVE F3OTDN    OTDT             *1
     C                     END                             E1
     C*                                                                   S01408
     C/COPY WNCPYSRC,FX0380CCPG                                           S01408
     C*                                                                   S01408
     C*
     C*
     C**  Update Confirmation bits, Process FXP0052
     C*
     C                     MOVE CNFI      @XCNFI
     C                     EXSR #BAB
     C                     MOVE @XCNFI    CNFI
     C*
     C*
     C*
     C**  -- Write the Main Deal results to file  --  Insertions
     C**              Write record as per R/FXR0021
     C*
     C*
     C           F3MACT    IFEQ 'I'                        B1
     C*
     C                     EXSR #BAC                       *1
     C*
      *
      ** SET UP FED FUNDS
     C           F3FEDF    IFEQ 'Y'                        B*2
     C*****      F3CCY1    ANDEQUSCY                       **2            S01194
     C           F3CCY1    ANDEQBLUSCY                     **2            S01194
     C           F3DAM1    ANDGE0                          **2
     C           F3FEDF    OREQ 'Y'                        **2
     C*****      F3CCY2    ANDEQUSCY                       **2            S01194
     C           F3CCY2    ANDEQBLUSCY                     **2            S01194
     C           F3DAM2    ANDGE0                          **2
     C                     BITON'2'       DSTI             **2
     C                     ELSE                            X*2
     C                     BITOF'2'       DSTI             **2
     C                     END                             E*2
     C           F3FEDF    IFEQ 'Y'                        B*2
     C*****      F3CCY1    ANDEQUSCY                       **2            S01194
     C           F3CCY1    ANDEQBLUSCY                     **2            S01194
     C           F3DAM1    ANDLT0                          **2
     C           F3FEDF    OREQ 'Y'                        **2
     C*****      F3CCY2    ANDEQUSCY                       **2            S01194
     C           F3CCY2    ANDEQBLUSCY                     **2            S01194
     C           F3DAM2    ANDLT0                          **2
     C                     BITON'3'       DSTI             **2
     C                     ELSE                            X*2
     C                     BITOF'3'       DSTI             **2
     C                     END                             E*2
     C*                                                                   057334
     C** Set Bit 4 on DSTI if Over-ride was used.                         057334
     C*                                                                   057334
     C           @POVER    IFEQ 'Y'                                       057334
     C                     BITON'4'       DSTI                            057334
     C                     ELSE                                           057334
     C                     BITOF'4'       DSTI                            057334
     C                     END                                            057334
     C*                                                                   057334
     C           *INU7     CABEQ'1'       #BA9             *1
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,FX0380CCP5                                           S01408
     C*                                                                   S01408
     C                     WRITEDEALSDBF               71  *1
     C           *IN71     IFEQ '1'                        B*2
     C                     MOVE '006'     DBASE            **2       ********
     C                     MOVEL'DEALSDB 'DBFILE           **2              *
     C                     MOVE *BLANKS   DBKEY            **2              *
     C                     MOVELF3DN38    DBKEY            **2       ERROR  *
     C                     MOVE '1'       *INU7            **2       06     *
     C                     MOVE '1'       *INU8            **2              *
     C                     GOTO #BA9                       **2       ********
     C                     END                             E*2
     C/COPY WNCPYSRC,FX0380C010
     C                     ELSE                            X1
     C*
     C**
     C***    Fill in fields from deals file for Amends/Reversals
     C**
     C**  E19728 - Only fill in field if deal authorised                  E19728
     C           @DLA      IFEQ 'Y'                        B*2            E19728
     C                     MOVE RECI      @RECIB           **2
     C**********           MOVE SODN      F3DADN           **2            E19728
     C**********           MOVE DTYP      F3TYPE           **2            E19728
     C                     MOVE BRKC      F3BROK           **2
     C                     MOVE BCEQ      F3BCAE           **2
     C                     Z-ADDPUAM      F3DAM1           **2
     C                     Z-SUBSLAM      F3DAM2           **2
     C                     MOVE PUCY      F3CCY1           **2
     C                     MOVE SLCY      F3CCY2           **2
     C*                                                                   S01408
     C/COPY WNCPYSRC,FX0380CCP1                                           S01408
     C*                                                                   S01408
     C                     END                             E*2            E19728
     C*                                                                   S01194
     C* Call Access Program to read the General Ledger details file       S01194
     C**********           CALL 'AOGELRR0'                                S01194              CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD                           S01194
     C                     PARM '*FIRST ' @OPTN                           S01194
     C********** @GELR     PARM @GELR     DSFDY                           S01194              CGL029
     C           @GELR     PARM @GELR     DSSDY                                               CGL029
     C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVEL'SDGELRPD'DBFILE           *************  S01194
     C                     MOVEL'920'     DBASE            * DBERR 920 *  S01194
     C                     MOVEL@OPTN     DBOPTN           *************  S01194
     C                     EXSR *PSSR                                     S01194
     C                     END                                            S01194
     C*
     C**  Update main deal record  --  Reversals
     C**  -- Update Record I.D. only
     C*
     C           F3MACT    IFEQ 'R'                        B*2
     C                     MOVE 'R'       RECI             **2
     C*
     C                     MOVE 'R'       CHTP             **2
     C*
     C**  Update main deal record  --  Amendments
     C*
     C                     ELSE                            X*2
     C*
     C                     MOVE 'A'       CHTP             **2
     C                     Z-ADDF3LNKN    LNKDN            **2            099670
     C                     MOVE F3BOKC    BOKC             **2            099670
     C*
     C**  -- Update Our Pay/Receive Method & Instructions
     C*
     C                     MOVE F3DMPM    SCST             **2
     C                     MOVE F3MOPI    OSCA             **2
     C                     MOVE F3ORCM    PCST             **2
     C                     MOVE F3MORI    OPCA             **2
     C*                                                                   S01177
     C**  -- Update Our Pay/Receive Method & Inst - Extended format       S01177
     C*                                                                   S01177
     C                     MOVE F3PSTM    PSTM             **2            S01177
     C                     MOVE F3PONS    PONS             **2            S01177
     C                     MOVE F3RSTM    RSTM             **2            S01177
     C                     MOVE F3RONS    RONS             **2            S01177
     C*                                                                   S01177
     C** - Update Our Settlement Branches                                 S01177
     C*                                                                   S01177
     C                     MOVELF3ROBR    ROBR             **2            S01117
     C                     MOVELF3POBR    POBR             **2            S01117
     C*
     C**  -- Update Customer Pay/Receive Instructions
     C*
     C*                    MOVE F3MCPI    TPCN             **2            S01136
     C*                    MOVE F3MCRI    TSCN             **2            S01136
     C                     MOVE F3MCPI    TSCN             **2            S01136
     C                     MOVE F3MCRI    TPCN             **2            S01136
     C*                                                                   S01177
     C**  -- Update Customer Pay/Receive Inst - Extended format           S01177
     C*                                                                   S01177
     C                     MOVE F3RIBN    RIBN             **2            S01177
     C                     MOVE F3AWBN    AWBN             **2            S01177
     C*
     C*                                                                   S01177
     C**  -- Update Settlement Instructions                               S01177
     C*                                                                   S01177
     C                     MOVE F3RIBA    RIBA                            S01177
     C                     MOVE F3ROBN    ROBN                            S01177
     C                     MOVE F3ROCN    ROCN                            S01177
     C                     MOVE F3PIBN    PIBN                            S01177
     C                     MOVE F3PIBA    PIBA                            S01177
     C                     MOVE F3POBN    POBN                            S01177
     C                     MOVE F3POCN    POCN                            S01177
     C                     MOVE F3RCRN    RCRN                            S01177
     C                     MOVE F3RCRA    RCRA                            S01177
     C                     MOVE F3RVNO    RVNO                            S01177
     C                     MOVE F3AWBA    AWBA                            S01177
     C                     MOVE F3BENA    BENA                            S01177
     C                     MOVE F3DTP1    DTP1                            S01177
     C                     MOVE F3DTP2    DTP2                            S01177
     C                     MOVE F3DTP3    DTP3                            S01177
     C                     MOVE F3DTP4    DTP4                            S01177
     C                     MOVE F3DCHG    DCHG                            S01177
     C                     MOVE F3BTB2    BTB2                            S01177
     C                     MOVE F3BTB3    BTB3                            S01177
     C                     MOVE F3BTB4    BTB4                            S01177
     C                     MOVE F3BTB5    BTB5                            S01177
     C                     MOVE F3BTB6    BTB6                            S01177
     C** Linked Ref NO                                                    106279
     C                     MOVE F3LNKN    LNKDN                           106279
     C*                                                                   106279
     C*                                                                   S01177
     C** Portfolio Reference                                              S01486
     C*                                                                   S01486
     C                     MOVE F3PTFR    PTFR                            S01486
     C*
     C**  -- Update Deal for account / Special Instructions
     C*
     C                     MOVE F3MFAC    FACO             **2
     C                     MOVE F3SPEC    SPI              **2
     C                     MOVE F3BENN    BENN             **2            S01177
     C                     MOVE F3BTB1    BTB1             **2            S01177
     C           F3CVMR    IFNE 'Y'                        B**3           E22405
     C                     MOVE 'N'       CVMR             ***3           E22405
     C                     ELSE                            X**3           E22405
     C                     MOVE 'Y'       CVMR             ***3           E22405
     C                     END                             E**3           E22405
     C**  -- Update Profit Centre if Profit Centre Amendable is on        S01117
     C           BKPRCA    IFEQ 'Y'                        B*3            S01117
     C                     MOVE F3PRFC    PRFC             **3            S01177
     C                     END                             E*3            S01117
     C                     MOVE F3RVCY    RSCY             **2            CEU003
     C                     MOVE F3PSCY    PSCY             **2            CEU003
     C                     MOVE F3IC72    IC72             **2            CEU003
     C                     END                             E*2
      ** FX Netting Fields                                                CDL002
     C                     MOVE F3NBUY    NETBY                           CDL002
     C                     MOVE F3NBRF    NETBR                           CDL002
     C                     MOVE F3NSEL    NETSL                           CDL002
     C                     MOVE F3NSRF    NETSR                           CDL002
     C                     MOVE F3MTCH    MATCH                           CDL002
      *
     C*                                                                   049432
     C** Set up Book Code                                                 049432
     C*                                                                   049432
     C                     MOVE F3BOKC    BOKC                            049432
      *                                                                   CDL008
     C           CDL008    IFEQ 'Y'                                       CDL008
     C                     MOVE F3CLSS    CLSS                            CDL008
     C                     ENDIF                                          CDL008
      *
      ** SET UP FED FUNDS
     C           F3FEDF    IFEQ 'Y'                        B*2
     C*****      F3CCY1    ANDEQUSCY                       **2            S01194
     C           F3CCY1    ANDEQBLUSCY                     **2            S01194
     C           F3DAM1    ANDGE0                          **2
     C           F3FEDF    OREQ 'Y'                        **2
     C*****      F3CCY2    ANDEQUSCY                       **2            S01194
     C           F3CCY2    ANDEQBLUSCY                     **2            S01194
     C           F3DAM2    ANDGE0                          **2
     C                     BITON'2'       DSTI             **2
     C                     ELSE                            X*2
     C                     BITOF'2'       DSTI             **2
     C                     END                             E*2
     C           F3FEDF    IFEQ 'Y'                        B*2
     C*****      F3CCY1    ANDEQUSCY                       **2            S01194
     C           F3CCY1    ANDEQBLUSCY                     **2            S01194
     C           F3DAM1    ANDLT0                          **2
     C           F3FEDF    OREQ 'Y'                        **2
     C*****      F3CCY2    ANDEQUSCY                       **2            S01194
     C           F3CCY2    ANDEQBLUSCY                     **2            S01194
     C           F3DAM2    ANDLT0                          **2
     C                     BITON'3'       DSTI             **2
     C                     ELSE                            X*2
     C                     BITOF'3'       DSTI             **2
     C                     END                             E*2
     C*
     C*
     C**  Update main deal record  --  Reversals/Amendments
     C**  E19728 - Only update DEALSDBF if the deal is AUTHORISED         E19728
     C           @DLA      IFEQ 'Y'                        B*2            E19728
     C*
     C                     UPDATDEALSDBF               71  **2
     C           *IN71     IFEQ '1'                        B**3
     C                     MOVE '007'     DBASE            ***3      ********
     C                     MOVEL'DEALSDB 'DBFILE           ***3             *
     C                     MOVE *BLANKS   DBKEY            ***3             *
     C                     MOVELF3DN38    DBKEY            ***3      ERROR  *
     C                     MOVE '1'       *INU7            ***3      07     *
     C                     MOVE '1'       *INU8            ***3             *
     C                     GOTO #BA9                       ***3      ********
     C                     END                             E**3
     C                     END                             E*2            E19728
     C/COPY WNCPYSRC,FX0380C011
     C*
     C                     END                             E1
     C**
     C***    Access the related deal for swaps/Options take-up
     C**
     C**  E19728 - Only access the related deal if the related deal       E19728
     C**           is Authorised                                          E19728
     C           @RDLA     IFNE 'Y'                        B1             E19728
     C                     GOTO #BA9                       *1             E19728
     C                     END                             E1             E19728
     C*                                                                   E19728
     C           F3MACT    IFNE 'A'                        B1
     C**
     C           F3TYPE    IFEQ 'SW'                       B*2
     C           F3TYPE    OREQ 'OT'                       **2
     C           F3BROK    OREQ 'SWAP'                     **2
     C**
     C                     MOVE PCST      SPCST   20                      BHF889
     C                     MOVE SCST      SSCST   20                      BHF889
     C                     MOVE PUCY      SPUCY   3                       BHF889
     C                     MOVE SLCY      SSLCY   3                       BHF889
     C**                                                                  BHF889
     C                     MOVE F3DADN    @N6              **2
     C           @N6       CHAINFXMIDBLL             76    **2
     C           *IN76     IFEQ '1'                        B**3
     C           F3TYPE    IFEQ 'OT'                       B***4
     C                     MOVE '008'     DBASE            ****4
     C                     MOVEL'DEALSDB 'DBFILE           ****4     *****
     C                     MOVE *BLANKS   DBKEY            ****4      008*
     C                     MOVELF3DADN    DBKEY            ****4     *****
     C                     MOVE '1'       *INU7            ****4
     C                     MOVE '1'       *INU8            ****4
     C                     GOTO #BA9                       ****4
     C                     ELSE                            X***4
     C                     GOTO #BA8                       ****4
     C                     END                             E***4
     C                     ELSE                            X**3
     C*                                                    ***3
     C**   Save record I.D. / Related deal type for #BAH   ***3
     C**   later                                           ***3
     C                     MOVE RECI      @RELRI           ***3
     C                     MOVE DTYP      @RELDT           ***3
     C                     Z-ADDVDAT      VDATXX  50       ***3           BHF771
     C                     END                             E**3
     C                     END                             E*2
     C*
     C           F3MACT    IFEQ 'I'                        B*2
     C*
     C*    Update related swaps as per R/FXR0022
     C*
     C           F3TYPE    IFEQ 'SW'                       B**3
     C                     EXSR #BAD                       ***3
     C*
     C           *INU7     CABEQ'1'       #BA9             ***3
     C*
     C                     ELSE                            X**3
     C*
     C*
     C*    Update related options as per R/FXR0023
     C*
     C           F3TYPE    IFEQ 'OT'                       B***4
     C                     EXSR #BAE                       ****4
     C*
     C           *INU7     CABEQ'1'       #BA9             ****4
     C*
     C                     ELSE                            X***4
     C*
     C*
     C*    Update related brokerage swaps as per R/FXR0024
     C*
     C           F3BROK    IFEQ 'SWAP'                     B****5
     C                     EXSR #BAF                       *****5
     C*
     C           *INU7     CABEQ'1'       #BA9             *****5
     C*
     C                     END                             E****5
     C*
     C                     END                             E***4
     C*
     C                     END                             E**3
     C*
     C                     ELSE                            X*2
     C*
     C           F3MACT    IFEQ 'R'                        B**3
     C*
     C*    Reverse related swaps as per R/FXR0025
     C*
     C           F3TYPE    IFEQ 'SW'                       B***4
     C                     EXSR #BAG                       ****4
     C*
     C           *INU7     CABEQ'1'       #BA9             ****4
     C*
     C                     ELSE                            X***4
     C*
     C*
     C*    Reverse related options
     C*
     C           F3TYPE    IFEQ 'OT'                       B****5
     C*
     C           F3DAM1    IFGT *ZERO                      B*****6
     C                     ADD  F3DAM1    PUAM             ******6
     C                     SUB  F3DAM2    SLAM             ******6
     C                     ELSE                            X*****6
     C                     ADD  F3DAM2    PUAM             ******6
     C                     SUB  F3DAM1    SLAM             ******6
     C                     END                             E*****6
      *                                                                   CAC001
      **  Increase the margin amount of the related 'OP' deal             CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
     C                     ADD  F3MGAM    MGAM                            CAC001
     C                     ENDIF                                          CAC001
     C*
     C                     ADD  F3BCAE    BCEQ             *****5
     C                     BITON'2'       DNSI             *****5
     C*
     C                     MOVE 'A'       CHTP             *****5
     C*
     C                     ELSE                            X****5
     C*
     C*
     C*    Reverse related brokerage swaps
     C**      Zeroise Swap Other Leg Value Date, Swap Leg Indicator,
     C**       and related deal number, and set deal static indicator.
     C*
     C           F3BROK    IFEQ 'SWAP'                     B*****6
     C*
     C                     Z-ADD*ZERO     OTDT             ******6
     C                     Z-ADD*ZERO     FSLI             ******6
     C                     Z-ADD*ZERO     SODN             ******6
     C                     BITOF'1'       DSTI             ******6
     C                     MOVE 'A'       CHTP             ******6
     C*
     C                     END                             E*****6
     C*
     C                     END                             E****5
     C*
     C                     END                             E***4
     C*
     C                     END                             E**3
     C*
     C                     END                             E*2
     C**
     C***   Write related deal changes back to disk
     C**
     C           F3TYPE    IFEQ 'SW'                       B*2
     C           F3TYPE    OREQ 'OT'                       **2
     C           F3BROK    OREQ 'SWAP'                     **2
     C*****                Z-ADDRUND      LCD              **2            S01194
     C                     Z-ADDBJRDNB    LCD              **2            S01194
     C                     UPDATDEALSDBF               71  **2
     C           *IN71     IFEQ '1'                        B**3
     C                     MOVE '009'     DBASE            ***3      ********
     C                     MOVEL'DEALSDB 'DBFILE           ***3             *
     C                     MOVE *BLANKS   DBKEY            ***3             *
     C                     MOVELF3DADN    DBKEY            ***3      ERROR  *
     C                     MOVE '1'       *INU7            ***3      09     *
     C                     MOVE '1'       *INU8            ***3             *
     C                     GOTO #BA9                       ***3      ********
     C*
     C                     END                             E**3
     C                     MOVE SPCST     PCST                            BHF889
     C                     MOVE SSCST     SCST                            BHF889
     C                     MOVE SPUCY     PUCY                            BHF889
     C                     MOVE SSLCY     SLCY                            BHF889
     C**                                                                  BHF889
     C*
     C           F3TYPE    IFEQ 'OT'                                      036100
     C                     MOVE 'OT'      DTYP                            036100
     C                     END                                            036100
     C*
     C                     END                             E*2
     C***                                                                 E12279
     C***  Update MIDAS trailer record   LF/FXMIDBLL   PF/DEALSDF         E12279
     C***  This processing is done in FX0390 to prevent locking problem   E12279
     C           #BA8      TAG                             *1
     C***                                                                 E12279
     C***                  EXSR #BAH                       *1             E12279
     C***                                                                 E12279
     C***        *INU7     CABEQ'1'       #BA9             *1             E12279
     C***                                                                 E12279
     C                     END                             E1
     C*
     C*
     C           #BA9      ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BB    - Process FXP0055                         *
     C*             Write out Deal Index records                      *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #B                                               *
     C*  CALLS     : #BBA,  Process FXP0056                           *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BB       BEGSR
     C**  E19728 - Initialise @RADD                                       E19728
     C                     Z-ADD0         @RADD                           E19728
     C*
     C**   Set up values as per R/FXR0026
     C*
     C**  E20195 - Move 'D' to RECI only just before update               E20195
     C**********           MOVE 'D'       RECI                            E20195
     C                     MOVE 'D'       RCDT
     C                     Z-ADDF3DN38    DLNO
     C*                                                                   CEU003
     C                     MOVE *BLANKS   @BESC   3                       CEU003
     C                     MOVE *BLANKS   @SESC   3                       CEU003
      *                                                                   CEU003
      ** Determine PUCY is  an 'In' currency or Euro.                     CEU003
      *                                                                   CEU003
     C                     CALL 'AOCURRR0'                                CEU003
     C                     PARM '       ' @RTCD   7                       CEU003
     C                     PARM '*KEY   ' @OPTN   7                       CEU003
     C                     PARM PUCY      @CURKY  3                       CEU003
     C           @CURR     PARM @CURR     DSSDY                           CEU003
      *                                                                   CEU003
     C           A6INCY    IFEQ 'Y'                                       CEU003
     C           PUCY      OREQ BKEURO                                    CEU003
     C                     MOVE 'Y'       @INFLG  1                       CEU003
     C                     ELSE                                           CEU003
     C                     MOVE 'N'       @INFLG                          CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
      ** Determine buy effective settlement currency.                     CEU003
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           @INFLG    ANDEQ'Y'                                       CEU003
     C           RSCY      ANDNE*BLANKS                                   CEU003
     C                     MOVE RSCY      @BESC                           CEU003
     C                     ELSE                                           CEU003
     C                     MOVE PUCY      @BESC                           CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
      ** Determine SLCY is  an 'In' currency or Euro.                     CEU003
      *                                                                   CEU003
     C                     CALL 'AOCURRR0'                                CEU003
     C                     PARM '       ' @RTCD   7                       CEU003
     C                     PARM '*KEY   ' @OPTN   7                       CEU003
     C                     PARM SLCY      @CURKY  3                       CEU003
     C           @CURR     PARM @CURR     DSSDY                           CEU003
      *                                                                   CEU003
     C                     MOVE *BLANK    @INFLG                          CEU003
      *                                                                   CEU003
     C           A6INCY    IFEQ 'Y'                                       CEU003
     C           SLCY      OREQ BKEURO                                    CEU003
     C                     MOVE 'Y'       @INFLG                          CEU003
     C                     ELSE                                           CEU003
     C                     MOVE 'N'       @INFLG                          CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
      ** Determine sell effective settlement currency.                    CEU003
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           @INFLG    ANDEQ'Y'                                       CEU003
     C           PSCY      ANDNE*BLANKS                                   CEU003
     C                     MOVE PSCY      @SESC                           CEU003
     C                     ELSE                                           CEU003
     C                     MOVE SLCY      @SESC                           CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
     C*                                                                   E18534
     C**  RESTORE VALUE OF VDAT FROM F3VDDN TO PREVENT PAY/RECEIVE        E18534
     C**  INDICATOR FROM INCORRECT SET UP USING ASSOCIATED LEG'S          E18534
     C**  VDAT WHICH WOULD GENERATE  PAY/RECEIVE MESSAGES.                E18534
     C*                                                                   E18534
     C                     Z-ADDF3VDDN    VDAT                            E18534
     C*                                                                   S01408
     C/COPY WNCPYSRC,FX0380CCP2                                           S01408
     C*                                                                   S01408
     C*                                                                   E18534
     C***                  Z-ADD*ZERO     DVTDAT                          E12279
     C                     Z-ADD*ZERO     DASN
     C*
     C****                 MOVE F3MACT    ACTC                            S01136
     C****                 MOVE @XCREQ    CREQ                            S01136
     C****                 MOVE 'N'       CPRI                            S01136
     C*
     C                     MOVE F3MACT    CHTP                            S01136
     C                     MOVE @XCREQ    CNRQ                            S01136
     C                     MOVE 'N'       CNPR                            S01136
     C/COPY WNCPYSRC,FX0380C007
     C*
     C                     MOVE 'N'       DADI
     C*
     C                     Z-ADD*ZERO     TNLU
     C*
     C*  Time in '0hhmm' format
     C*
     C                     TIME           @XTIME  60
     C****                 MOVEL@XTIME    @X4     4                       S01136
     C****                 MOVEL'0'       RRNL                            S01136
     C****                 MOVE @X4       RRNL                            S01136
     C                     MOVEL@XTIME    @X4     40                      S01136
     C                     Z-ADD@X4       TIM                             S01136
     C/COPY WNCPYSRC,FX0380C008
     C*
     C**   Call process FXP0056 (Calculate pay/receive indicators)
     C*              and store results in the file
     C*
     C           @DLA      IFEQ 'Y'                        B1             BHF933
     C                     EXSR #BBA
     C*
     C                     Z-ADD@PRIN1    PRI1
     C                     Z-ADD@PRIN2    PRI2
     C                     Z-ADD@PRIN3    PRI3
     C*
     C                     MOVE F3MACT    CHTP                            E12615
     C*
     C**   Write record to PF/DTRIXDF   LF/SDTIX
     C*
      *  Blank Dtrix Value Date.                                          E12279
     C                     Z-ADDVDAT      DVTDAT  50                      E12279
     C                     Z-ADD*ZERO     VDAT                            E12279
     C*                                                                   E20195
     C** SETUP RECI                                                       E20195
     C                     MOVE 'D'       RECI                            E20195
     C** E19728 - If Deal is not authorised, do not update DTRIXDD        E19728
     C*                                                                   E19728
     C********** @DLA      IFEQ 'Y'                        B1       E19728BHF933
     C           DVTDAT    IFLT BJRDNB                                    E29097
     C/COPY WNCPYSRC,FX0380C001
     C                     Z-ADD0         PRI1                            E29097
     C/COPY WNCPYSRC,FX0380C002
     C                     Z-ADD0         PRI3                            E29097
     C/COPY WNCPYSRC,FX0380C003
     C                     END                                            E29097
     C                     WRITEDTRIXDF                71  *1
     C                     Z-ADDDVTDAT    VDAT             *1             E12279
     C           *IN71     IFEQ '1'                        B*2
     C                     MOVE '012'     DBASE            **2       *********
     C                     MOVEL'SDTIX   'DBFILE           **2               *
     C                     MOVE *BLANKS   DBKEY            **2               *
     C                     MOVELF3DN38    DBKEY            **2       ERROR   *
     C                     MOVE '1'       *INU7            **2       12      *
     C                     MOVE '1'       *INU8            **2               *
     C                     GOTO #BB9                       **2       *********
     C                     END                             E*2
     C**  E19728 - Add 1 to @RADD if record is written to DTRIXDD         E19728
     C                     ADD  1         @RADD            *1             E19728
     C                     END                             E1             E19728
     C*
     C**   Second index record for swap reversal (not brokerage swap)
     C*
     C           F3TYPE    IFEQ 'SW'                       B1
     C           F3MACT    ANDEQ'R'                        *1
     C           F3BROK    ANDNE'SWAP'                     *1
     C           *IN76     ANDEQ'0'                        *1
     C           @RDLA     ANDEQ'Y'                        *1             E19728
     C                     MOVE F3DADN    DLNO             *1
     C****                 MOVE 'Y'       CREQ             *1             S01136
     C                     MOVE 'Y'       CNRQ             *1             S01136
     C                     Z-ADD*ZERO     PRI1             *1
     C                     Z-ADD*ZERO     PRI2             *1
     C                     Z-ADD*ZERO     PRI3             *1
     C*                                                                   BHF771
     C**   Setup Pay/Rec Indicator for the 2nd index record               BHF771
     C*                                                                   BHF771
     C                     Z-ADDVDATXX    @CMPDT                          BHF771
     C*
     C*     Calculate pay/receive indicator based on                      BHF771
     C*           purchase currency and receipt instructions              BHF771
     C*  (The purchase ccy of the 2nd leg is the sale ccy of 1st leg)     BHF771
     C           SCST      IFEQ 01                                        BHF771
     C           SCST      OREQ 07                                        BHF771
     C           SCST      OREQ 08                                        BHF771
     C           SCST      OREQ 00                                        BHF771
     C           SCST      OREQ 03                                        BH1043
     C           SCST      OREQ 04                                        BH1043
     C           SCST      OREQ 05                                        BH1043
     C           SCST      OREQ 06                                        BH1043
     C           SCST      OREQ 14                                        BH1043
     C                     MOVE SLCY      @RECUR                          BHF771
     C                     MOVE @SESC     @SECUR                          CEU003
     C                     EXSR #BBAB                                     E26613
     C                     END                                            BHF771
     C*                                                                   BHF771
     C           SCST      IFEQ 02                                        BHF771
     C           SCST      OREQ 12                                        BHF771
     C                     MOVE BJLCCY    @RECUR                          BHF771
     C                     MOVE BJLCCY    @SECUR                          CEU003
     C                     EXSR #BBAB                                     E26613
     C                     END                                            BHF771
     C*                                                                   BHF771
     C***********          EXSR #BBAB                               BHF771E26613
     C           *INU7     CABEQ'1'       #BB9                            BHF771
     C*                                                                   BHF771
     C           @INOUT    IFEQ 'I'                                       BHF771
     C                     Z-ADD1         @PRIN1                          BHF771
     C                     END                                            BHF771
     C*                                                                   BHF771
     C*     Calculate pay/receive indicator based on                      BHF771
     C*              sale currency and payment instructions               BHF771
     C*  (The sale ccy of the 2nd leg is the purchase ccy of 1st leg)     BHF771
     C*                                                                   BHF771
     C           PCST      IFEQ 01                                        BHF771
     C           PCST      OREQ 07                                        BHF771
     C           PCST      OREQ 08                                        BHF771
     C           PCST      OREQ 00                                        BHF771
     C           PCST      OREQ 03                                        BH1043
     C           PCST      OREQ 04                                        BH1043
     C           PCST      OREQ 05                                        BH1043
     C           PCST      OREQ 06                                        BH1043
     C           PCST      OREQ 14                                        BH1043
     C                     MOVE PUCY      @RECUR                          BHF771
     C                     MOVE @BESC     @SECUR                          CEU003
     C                     EXSR #BBAB                                     E26613
     C                     END                                            BHF771
     C*                                                                   BHF771
     C           PCST      IFEQ 02                                        BHF771
     C           PCST      OREQ 12                                        BHF771
     C                     MOVE BJLCCY    @RECUR                          BHF771
     C                     MOVE BJLCCY    @SECUR                          CEU003
     C                     EXSR #BBAB                                     E26613
     C                     END                                            BHF771
     C*                                                                   BHF771
     C***********          EXSR #BBAB                               BHF771E26613
     C           *INU7     CABEQ'1'       #BB9                            BHF771
     C*                                                                   BHF771
     C           @INOUT    IFEQ 'I'                                       BHF771
     C                     Z-ADD1         @PRIN3                          BHF771
     C                     END                                            BHF771
     C*                                                                   BHF771
     C                     Z-ADD*ZERO     VDAT                            BHF771
     C                     Z-ADD@PRIN1    PRI1                            BHF771
     C                     Z-ADD@PRIN2    PRI2                            BHF771
     C                     Z-ADD@PRIN3    PRI3                            BHF771
     C*                                                                   BHF771
     C*                                                                   BHF771
     C*
     C**   Write record to PF/DTRIXDF   LF/SDTIX
     C*
      *                                                                   105410
      ** Save the original value of RECI to a temporary variable          105410
      ** then, restore after writing to PF/DTRIXDD.                       105410
      *                                                                   105410
     C                     MOVE RECI      RECTMP  1                       105410
     C                     MOVE 'D'       RECI                            105410
     C                     WRITEDTRIXDF                71  *1
     C                     MOVE RECTMP    RECI                            105410
     C           *IN71     IFEQ '1'                        B*2
     C                     MOVE '012'     DBASE            **2       ********
     C                     MOVEL'SDTIX   'DBFILE           **2              *
     C                     MOVE *BLANKS   DBKEY            **2              *
     C                     MOVELF3DADN    DBKEY            **2       ERROR  *
     C                     MOVE '1'       *INU7            **2       2      *
     C                     MOVE '1'       *INU8            **2              *
     C                     GOTO #BB9                       **2       ********
     C                     END                             E*2
     C**  E19728 - Add 1 to @RADD if record is written to DTRIXDD         E19728
     C                     ADD  1         @RADD            *1             E19728
     C                     END                             E1
     C*
     C***  Update header record on deal index                             E12279
     C***  This update of dtrixhh record is also done in FX0390 now.      E12279
     C***                  Z-ADD*ZERO     DLNO                            E12279
     C***        DLNO      CHAINSDTIX                7171                 E12279
     C***        *IN71     IFEQ '1'                        B1             E12279
     C***                  MOVE '013'     DBASE            *1 ************E12279
     C***                  MOVEL'SDTIX   'DBFILE           *1 *           E12279
     C***                  MOVE *BLANKS   DBKEY            *1 *           E12279
     C***                  MOVELF3DN38    DBKEY            *1 * D.B ERROR E12279
     C***                  MOVE '1'       *INU7            *1 *   013     E12279
     C***                  MOVE '1'       *INU8            *1 *           E12279
     C***                  GOTO #BB9                       *1 ************E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***                  ADD  1         NDLR                            E12279
     C***                                                                 E12279
     C***  Second index record for swap reversal (not brokerage swap)     E12279
     C***                                                                 E12279
     C***        F3TYPE    IFEQ 'SW'                       B1             E12279
     C***        F3MACT    ANDEQ'R'                        X1             E12279
     C***        F3BROK    ANDNE'SWAP'                     X1             E12279
     C***        *IN76     ANDEQ'0'                        *1             E12279
     C***                  ADD  1         NDLR             *1             E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***                  UPDATDTRIXHF                71                 E12279
     C***        *IN71     IFEQ '1'                        B*2            E12279
     C***                  MOVE '014'     DBASE            **2 *************
     C***                  MOVEL'SDTIX   'DBFILE           **2 *           *
     C***                  MOVE *BLANKS   DBKEY            **2 *           *
     C***                  MOVELDLNO      DBKEY            **2 * D.B ERROR *
     C***                  MOVE '1'       *INU7            **2 *    014    *
     C***                  MOVE '1'       *INU8            **2 *           *
     C***                  GOTO #BB9                       **2 *************
     C***                  END                             E*2            E12279
     C***                                                                 E12279
     C***                                                                 E12279
     C           #BB9      ENDSR                                          E12279
     C*****************************************************************   E12279
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BAA   - Process FXP0216                         *
     C*                                                               *
     C*          Fill in Supplemetary Deal information (MIDAS data)   *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BA                                              *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BAA      BEGSR
     C*
     C**   Recalculate Customer Number if short name has changed
     C*
     C**         *IN62     IFEQ '1'                        B1
     C**         F3DCSN    ORNE FHDCSN                     X1
     C**         F3CNUM    OREQ *ZERO                      X1
     C**         F3DCSN    IFNE *BLANKS                    B*2
     C**         F3DCSN    CHAINSNAME                6565  **2
     C**         *IN65     IFEQ '0'                        B**3
     C**                   MOVE CNUM      F3CNUM           ***3
     C**                   END                             E**3
     C**                   END                             E*2
     C**                   END                             E1
     C*
     C*
     C**   Recalculate Midas Branch Code if Deal Branch has changed
     C*
     C**         *IN62     IFEQ '1'                        B1
     C**         F3DBRC    ORNE FHDBRC                     X1
     C**         F3MBRC    OREQ '000'                      X1
     C**         F3MBRC    OREQ *BLANKS                    X1
     C**         F3DBRC    IFNE *BLANKS                    B*2
     C**                   MOVE F3DBRC    @BNO             **2
     C**                   MOVE '10'      @PRF             **2
     C**         KEY       CHAINFDBRNCLL             6666  **2
     C**         *IN66     IFEQ '0'                        B**3
     C**                   MOVE BRSN      F3MBRC           ***3
     C**                   ELSE                            X**3
     C**                   MOVE *BLANKS   F3MBRC           ***3
     C**                   END                             E**3
     C**                   END                             E*2
     C**                   END                             E1
     C*
     C*
     C*
     C**   Reconvert Dates if Dates have changed
     C*
     C*    1. Deal Done Date
     C*
     C           F3DDDN    IFEQ *ZERO                      B1
     C           F3DDDT    IFNE *ZERO                      B*2
     C                     MOVE F3DDDT    @@DTIN           **2
     C                     EXSR ZA0680                     **2
     C                     MOVE @@MDNO    F3DDDN           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C*    2. Value Date
     C*
     C           @VDTE     IFNE F3BVDT                     B1
     C           F3VDDN    OREQ *ZERO                      *1
     C           @VDTE     IFNE *ZERO                      B*2
     C                     MOVE @VDTE     @@DTIN           **2
     C                     EXSR ZA0680                     **2
     C                     MOVE @@MDNO    F3VDDN           **2
     C                     ELSE                            X*2
     C                     Z-ADD*ZERO     F3VDDN           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C*    3. Deal Option End Date
     C*
     C           @DOED     IFNE F3BOTD                     B1
     C           F3OTDN    OREQ *ZERO                      *1
     C           @DOED     IFNE *ZERO                      B*2
     C                     MOVE @DOED     @@DTIN           **2
     C                     EXSR ZA0680                     **2
     C                     MOVE @@MDNO    F3OTDN           **2
     C                     ELSE                            X*2
     C                     Z-ADD*ZERO     F3OTDN           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C           #BAA9     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BAB   - Process FXP0052                         *
     C*     Calculate Confirmation Bits and Confirmation Required     *
     C*                                          Flag.                *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*  CALLED BY : #BA                                              *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BAB      BEGSR
     C*
     C                     MOVE 'N'       @XCREQ
     C*
     C           F3MACT    IFEQ 'I'                        B1
     C*
     C***  Set confirmation bits for insertions
     C*
     C                     BITOF'01234567'@XCNFI           *1
     C           F3ORCM    IFNE *ZERO                      B*2
     C           F3DMPM    ORNE *ZERO                      **2
     C*****      TLII      OREQ 'N'                        **2            S01194
     C           BLL2II    OREQ 'N'                        **2            S01194
     C                     MOVE 'Y'       @XCREQ           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C           F3MACT    IFEQ 'R'                        B1
     C*
     C***  Set confirmation bits for reversals
     C*
     C* UDC will produce 'insert' confirmation even if deal deleted       143058
     C* in the meantime. Therefore cancellation confirmation should       143058
     C* also be produced.                                                 143058
     C**********           TESTB'7'       CNFI           71*1             143058
     C********** *IN71     IFEQ '1'                        B*2            143058
     C                     MOVE 'Y'       @XCREQ           **2
     C                     BITOF'0'       @XCNFI           **2
     C**********           END                             E*2            143058
     C*
     C                     END                             E1
     C*
     C*
     C           F3MACT    IFEQ 'A'                        B1
     C*
     C***  Set confirmation bits for amendments
     C*
     C***  Special case of Settlement Type "04", Instructions
     C***      changes are not interesting in this case
     C*
     C           F3DMPM    IFEQ 04                         B*2
     C           F3BOPM    ANDEQ04                         **2
     C                     MOVE F3MORI    @XMORI           **2
     C                     MOVE F3ROBR    @XROBR           **2            S01117
     C                     ELSE                            X*2
     C                     MOVE F3BORI    @XMORI           **2
     C                     MOVE F3BROB    @XROBR           **2            S01117
     C                     END                             E*2
     C*
     C           F3ORCM    IFEQ 04                         B*2
     C           F3BORM    ANDEQ04                         **2
     C                     MOVE F3MOPI    @XMOPI           **2
     C                     MOVE F3POBR    @XPOBR           **2            S01117
     C                     ELSE                            X*2
     C                     MOVE F3BOPI    @XMOPI           **2
     C                     MOVE F3BPOB    @XPOBR           **2            S01117
     C                     END                             E*2
     C*
     C***  If any settlement details have changed
     C*
     C*****      F3MORI    IFNE @XMORI                     B*2            E18519
     C*****      F3ROBR    ORNE @XROBR                     **2     S01117 E18519
     C*****      F3DMPM    ORNE F3BOPM                     **2            E18519
     C*****      F3MOPI    ORNE @XMOPI                     **2            E18519
     C*****      F3POBR    ORNE @XPOBR                     **2     S01117 E18519
     C*****      F3ORCM    ORNE F3BORM                     **2            E18519
     C*****      F3MCPI    ORNE F3BCPI                     **2            E18519
     C*****      F3MCRI    ORNE F3BCRI                     **2            E18519
     C*****      F3DFAC    ORNE FACO                       **2            E18519
     C           F3MORI    IFNE OPCA                       B*2            E18519
     C           F3ROBR    ORNE ROBR                       **2            E18519
     C           F3DMPM    ORNE SCST                       **2            E18519
     C           F3MOPI    ORNE OSCA                       **2            E18519
     C           F3POBR    ORNE POBR                       **2            E18519
     C           F3ORCM    ORNE PCST                       **2            E18519
     C           F3MCPI    ORNE TSCN                       **2            E18519
     C           F3MCRI    ORNE TPCN                       **2            E18519
     C           F3MFAC    ORNE FACO                       **2            E18519
     C           F3SPEC    ORNE SPI                        **2
     C           F3RSTM    ORNE RSTM                       **2            DT0200
     C           F3RONS    ORNE RONS                       **2            DT0200
     C           F3RIBN    ORNE RIBN                       **2            DT0200
     C           F3RIBA    ORNE RIBA                       **2            DT0200
     C           F3ROBN    ORNE ROBN                       **2            DT0200
     C           F3ROCN    ORNE ROCN                       **2            DT0200
     C           F3PSTM    ORNE PSTM                       **2            DT0200
     C           F3PONS    ORNE PONS                       **2            DT0200
     C           F3PIBN    ORNE PIBN                       **2            DT0200
     C           F3PIBA    ORNE PIBA                       **2            DT0200
     C           F3POBN    ORNE POBN                       **2            DT0200
     C           F3POCN    ORNE POCN                       **2            DT0200
     C           F3RCRN    ORNE RCRN                       **2            DT0200
     C           F3RCRA    ORNE RCRA                       **2            DT0200
     C           F3RVNO    ORNE RVNO                       **2            DT0200
     C           F3AWBN    ORNE AWBN                       **2            DT0200
     C           F3AWBA    ORNE AWBA                       **2            DT0200
     C           F3BENN    ORNE BENN                       **2            DT0200
     C           F3BENA    ORNE BENA                       **2            DT0200
     C           F3DTP1    ORNE DTP1                       **2            DT0200
     C           F3DTP2    ORNE DTP2                       **2            DT0200
     C           F3DTP3    ORNE DTP3                       **2            DT0200
     C           F3DTP4    ORNE DTP4                       **2            DT0200
     C           F3DCHG    ORNE DCHG                       **2            DT0200
     C           F3BTB1    ORNE BTB1                       **2            DT0200
     C           F3BTB2    ORNE BTB2                       **2            DT0200
     C           F3BTB3    ORNE BTB3                       **2            DT0200
     C           F3BTB4    ORNE BTB4                       **2            DT0200
     C           F3BTB5    ORNE BTB5                       **2            DT0200
     C           F3BTB6    ORNE BTB6                       **2            DT0200
     C           F3CVMR    ORNE CVMR                       **2            DT0200
     C           F3RVCY    ORNE RSCY                       **2            CEU003
     C           F3PSCY    ORNE PSCY                       **2            CEU003
     C           F3IC72    ORNE IC72                       **2            CEU003
     C*
     C*********                                                           E19238
     C*****And*the original entry date is current date                    E19238
     C********when at least one settlement method has changed             E19238
     C*
     C**  E19238 - Print confirmation disregarding ORIGINAL ENTRY DATE    E19238
     C*                                                                   E19238
     C********** ORED      IFEQ RUND                       B**3           S01194
     C********** ORED      IFEQ BJRDNB                     B**3     S01194E19238
     C*
     C           F3ORCM    IFNE *ZERO                      B***4
     C           F3DMPM    ORNE *ZERO                      ****4
     C*****      TLII      OREQ 'N'                        ****4          S01194
     C           BLL2II    OREQ 'N'                        ****4          S01194
     C*
     C                     MOVE 'Y'       @XCREQ           ****4
     C                     BITOF'0'       @XCNFI           ****4
     C*
     C                     END                             E***4
     C*
     C**********           ELSE                            X**3           E19238
     C**********                                                          E19238
     C*****Or*The original entry date is not current date                 E19238
     C********and the run date is in range (original entry / value)       E19238
     C**********                                                          E19238
     C*****      ORED      IFLT RUND                       B***4          S01194
     C*****      RUND      ANDLEF3VDDN                     ****4          S01194
     C***********ORED      IFLT BJRDNB                     B***4    S01194E19238
     C***********BJRDNB    ANDLEF3VDDN                     ****4    S01194E19238
     C**********                                                          E19238
     C**********           MOVE 'Y'       @XCREQ           ****4          E19238
     C**********           BITOF'0'       @XCNFI           ****4          E19238
     C**********                                                          E19238
     C**********           END                             E***4          E19238
     C**********
     C**********           END                             E**3           E19238
     C*
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C*
     C*
     C           #BAB9     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BAC   - Generate a new MIDAS Deal Record        *
     C*                                                               *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BA                                              *
     C*  CALLS     : #BAB     --  Set Confirmation Bits               *
     C*              #ZA      --  Process FXP0053                     *
     C*
     C*****************************************************************
     C*
     C           #BAC      BEGSR
     C*
     C**    Locate Static Indicator settings
     C**       and buy/sell amounts, for related swap deal
     C**       and copy broker code and brokerage amount from             E12617
     C**       related deal if broker = SWAP                              E12617
     C*
     C           F3TYPE    IFEQ 'SW'                       B1
     C           F3BROK    OREQ 'SWAP'                     *1
     C                     MOVE F3DADN    @N6     60       *1
     C           @N6       CHAINFXMIDBLL             76    *1
     C           *IN76     IFEQ '0'                        B*2
     C                     BITOF'01234567'CNFI                            138389
     C                     MOVE DSTI      @RELBC           **2
     C                     Z-ADDVDAT      @@DAYN  80       **2
     C                     Z-ADDVDAT      SVOTDT  50       **2            E17742
     C                     EXSR ZA0710                     **2
     C                     Z-ADD@@VDT     F3RVDT           **2
     C                     Z-ADDPUAM      @RELBA           **2
     C           SLAM      IFGT *ZERO                      B**3
     C                     Z-ADDSLAM      @RELSA           ***3
     C                     ELSE                            X**3
     C                     Z-SUBSLAM      @RELSA           ***3
     C                     END                             E**3
     C********** F3BROK    IFEQ 'SWAP'                     B**3    E12617 E14099
     C**********           MOVE BAGE      F3BRKG           ***3    E12617 E14099
     C**********           MOVE BRKC      F3BROK           ***3    E12617 E14099
     C**********           END                             E**3    E12617 E14099
     C                     END                             E*2
     C                     END                             E1
     C*
     C**    Record I.D./Deal Number/Record Type
     C*
     C                     MOVE 'D'       RECI
     C                     MOVE F3DN38    DLNO
     C                     MOVE 'B'       RCDT
     C*
     C**    Record Code
     C*
     C           F3TYPE    IFEQ 'OP'                       B1
     C                     MOVE '12'      RCDC             *1
     C                     ELSE                            X1
     C           F3TYPE    IFEQ 'OT'                       B*2
     C                     MOVE '13'      RCDC             **2
     C                     ELSE                            X*2
     C           F3TYPE    IFEQ 'SW'                       B**3
     C                     MOVE '14'      RCDC             ***3
     C                     ELSE                            X**3
     C                     MOVE '11'      RCDC             ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C**    Customer Number/Branch Code
     C*
     C                     MOVE F3CNUM    CNUM
     C**    Account sequence number                                       E21042
     C*********************MOVEL'10'      @BRKEY 12                 E21042S01314
     C*********************MOVE F3MBRC    @BRKEY                    E21042S01314
     C***********@BRKEY    CHAINFDBRNCLL             71             E21042S01314
     C*********************MOVE NSACS     ACSQ                      E21042S01314
     C                     MOVE '01'      ACSQ                            S01314
     C*                                                                   E21042
     C*****                MOVE F3MBRC    BRCD                            S01117
     C                     MOVE F3MBCA    BRCA                            S01117
     C*
     C**    Deal Type and Sub-type
     C*
     C                     MOVE F3TYPE    DTYP
     C                     MOVE F3STYP    DLST
     C*
     C**    Deal date, value and option to date
     C*
     C                     MOVE F3DDDN    DDAT
     C                     MOVE F3VDDN    VDAT
     C*****                MOVE F3OTDN    OTDT                            E17742
     C*                                                                   S01408
     C/COPY WNCPYSRC,FX0380CCP3                                           S01408
     C*                                                                   S01408
     C*                                                                   E17742
     C           F3TYPE    IFNE 'SW'                                      E17742
     C           F3BROK    ANDNE'SWAP'                                    E17742
     C                     MOVE F3OTDN    OTDT                            E17742
     C                     ELSE                                           E17742
     C                     MOVE SVOTDT    OTDT                            E17742
     C                     END                                            E17742
     C*
     C**    Broker Code and Brokerage Amount
     C*
     C           F3BROK    IFNE 'SWAP'                     B1             E14099
     C           *IN76     OREQ '1'                        B1             E14099
     C                     MOVE F3BROK    BRKC
     C           F3BRKG    IFEQ *ALL'9'                                   E12584
     C**********           Z-ADD0         F3BRKG                   E12584 E13902
     C**********           END                                     E12584 E13902
     C                     Z-ADD0         BAGE             **2            E13902
     C                     ELSE                            X*2            E13902
     C                     MOVE F3BRKG    BAGE
     C                     END                             E*2            E13902
     C                     END                             E1             E14099
     C*
     C**    Purchase/Sale Currency and amounts, and exchange rate
     C*
     C           F3DAM1    IFGT *ZERO                      B1
     C                     Z-ADDF3DAM1    PUAM             *1
     C                     Z-SUBF3DAM2    SLAM             *1
     C                     MOVE F3CCY1    PUCY             *1
     C                     MOVE F3CCY2    SLCY             *1
     C                     ELSE                            X1
     C                     Z-ADDF3DAM2    PUAM             *1
     C                     Z-SUBF3DAM1    SLAM             *1
     C                     MOVE F3CCY2    PUCY             *1
     C                     MOVE F3CCY1    SLCY             *1
     C                     END                             E1
     C                     MOVE PUCY      @PUCY   3
     C                     MOVE SLCY      @SLCY   3
     C*
     C           SLAM      IFLT *ZERO                      B1
     C                     Z-SUBSLAM      SLAM             *1
     C                     END                             E1
     C*
     C                     MOVE F3DXRT    EXRT
     C*
     C*
     C**    Base Equivalent Amounts, and Original Purchase/Sale Amts.
     C*
     C                     Z-ADDF3BCAE    BCEQ
     C*
     C           F3TYPE    IFEQ 'OP'                       B1
     C                     Z-ADDF3BCAE    OBCE             *1
     C                     Z-ADDPUAM      ORPA             *1
     C                     Z-ADDSLAM      ORSA             *1
     C                     ELSE                            X1
     C                     Z-ADD*ZERO     OBCE             *1
     C                     Z-ADD*ZERO     ORPA             *1
     C                     Z-ADD*ZERO     ORSA             *1
     C                     END                             E1
     C*
     C*
     C**    Limit Currency Exchange Rate
     C*
     C*****                MOVE *BLANKS   KEY                             S01194
     C*****                MOVE '20'      @PRF                            S01194
     C*****                MOVE PUCY      @CUR                            S01194
     C*****                MOVE '1'       @SUF                            S01194
     C*****      KEY       CHAINFDCCYTLL             7171                 S01194
     C*                                                                   S01194
     C***** USE ACCESS PROGRAM TO READ CURRENCIES FILE                    S01194
     C*                                                                   S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*MSG   ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM PUCY      @AJCD   3                       S01194
     C           @CURR     PARM @CURR     DSSDY                           S01194
     C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN71                           S01194
     C                     END                                            S01194
     C*                                                                   S01194
     C           *IN71     IFEQ '0'                        B1
     C*****                Z-ADDERLC      LCXR             *1             S01194
     C                     Z-ADDA6ERLC    LCXR             *1             S01194
     C                     END                             E1
     C*
     C*
     C**  -- Update Our Pay/Receive Method & Instructions
     C*
     C                     MOVE F3DMPM    SCST
     C                     MOVE F3MOPI    OSCA
     C                     MOVE F3ORCM    PCST
     C                     MOVE F3MORI    OPCA
     C*                                                                   S01177
     C**  -- Update Our Pay/Receive Method & Inst - Extended format       S01177
     C*                                                                   S01177
     C                     MOVE F3PSTM    PSTM                            S01177
     C                     MOVE F3PONS    PONS                            S01177
     C                     MOVE F3RSTM    RSTM                            S01177
     C                     MOVE F3RONS    RONS                            S01177
     C*
     C**  -- Update Customer Pay/Receive Instructions
     C*
     C*                    MOVE F3MCPI    TPCN                            S01136
     C*                    MOVE F3MCRI    TSCN                            S01136
     C                     MOVE F3MCPI    TSCN                            S01136
     C                     MOVE F3MCRI    TPCN                            S01136
     C*                                                                   S01177
     C**  -- Update Customer Pay/Receive Inst - Extended format           S01177
     C*                                                                   S01177
     C                     MOVE F3RIBN    RIBN                            S01177
     C                     MOVE F3AWBN    AWBN                            S01177
     C*
     C**  -- Update Settlement Instructions                               S01177
     C*                                                                   S01177
     C                     MOVE F3RIBA    RIBA                            S01177
     C                     MOVE F3ROBN    ROBN                            S01177
     C                     MOVE F3ROCN    ROCN                            S01177
     C                     MOVE F3PIBN    PIBN                            S01177
     C                     MOVE F3PIBA    PIBA                            S01177
     C                     MOVE F3POBN    POBN                            S01177
     C                     MOVE F3POCN    POCN                            S01177
     C                     MOVE F3RCRN    RCRN                            S01177
     C                     MOVE F3RCRA    RCRA                            S01177
     C                     MOVE F3RVNO    RVNO                            S01177
     C                     MOVE F3AWBA    AWBA                            S01177
     C                     MOVE F3BENA    BENA                            S01177
     C                     MOVE F3DTP1    DTP1                            S01177
     C                     MOVE F3DTP2    DTP2                            S01177
     C                     MOVE F3DTP3    DTP3                            S01177
     C                     MOVE F3DTP4    DTP4                            S01177
     C                     MOVE F3DCHG    DCHG                            S01177
     C                     MOVE F3BTB2    BTB2                            S01177
     C                     MOVE F3BTB3    BTB3                            S01177
     C                     MOVE F3BTB4    BTB4                            S01177
     C                     MOVE F3BTB5    BTB5                            S01177
     C                     MOVE F3BTB6    BTB6                            S01177
     C           F3CVMR    IFNE 'Y'                        B1             E22405
     C                     MOVE 'N'       CVMR             *1             E22405
     C                     ELSE                            X1             E22405
     C                     MOVE 'Y'       CVMR             *1             E22405
     C                     END                             E1             E22405
     C*                                                                   S01177
     C*
      ** FX Netting Fields                                                CDL002
     C                     MOVE F3NBUY    NETBY                           CDL002
     C                     MOVE F3NBRF    NETBR                           CDL002
     C                     MOVE F3NSEL    NETSL                           CDL002
     C                     MOVE F3NSRF    NETSR                           CDL002
     C                     MOVE F3MTCH    MATCH                           CDL002
      *                                                                   CDL002
     C** Book Code                                                        E16211
     C                     MOVE F3BOKC    BOKC                            E16211
     C** Linked Ref NO                                                    E16211
     C                     MOVE F3LNKN    LNKDN                           E16211
      *                                                                   S01486
     C** Portfolio Reference                                              S01486
     C                     MOVE F3PTFR    PTFR                            S01486
     C*                                                                   S01453
     C**    Check if SAR S01453 is installed                              S01453
     C*                                                                   S01453
     C                     CALL 'AOSARDR0'                                S01453
     C                     PARM *BLANKS   @RTCD   7                       S01453
     C                     PARM '*VERIFY' @OPTN   7                       S01453
     C                     PARM 'S01453'  @SARD   6                       S01453
     C                     PARM           DSFDY                           S01453
     C*                                                                   S01453
     C**    SAR S01453 is installed                                       S01453
     C*                                                                   S01453
     C           @RTCD     IFEQ *BLANK                     *B1            S01453
     C                     MOVE '0'       *IN04                           S01453
     C                     ELSE                            *X1            S01453
     C*                                                                   S01453
     C**    SAR S01453 is not installed                                   S01453
     C*                                                                   S01453
     C           @RTCD     IFEQ '*NRF'                     *B2            S01453
     C                     MOVE '1'       *IN04                           S01453
     C                     ELSE                            *X2            S01453
     C*                                                                   S01453
     C**    Database error processing                                     S01453
     C*                                                                   S01453
     C                     MOVEL'SCSARDPD'DBFILE                          S01453
     C                     MOVEL'921'     DBASE                           S01453
     C                     MOVEL'S01453'  DBKEY                           S01453
     C                     MOVEL@OPTN     DBOPTN                          S01453
     C                     EXSR *PSSR                                     S01453
     C                     END                             *E2            S01453
     C*                                                                   S01453
     C                     END                             *E1            S01453
     C*                                                                   S01453
     C*                                                                   E16211
     C** Update Margin details if S01453 is installed                     S01453
     C*                                                                   S01453
     C           *IN04     IFEQ '0'                                       S01453
     C                     MOVE F3MGPT    MGPT                            S01453
     C                     MOVE F3MGAM    MGAM                            S01453
     C                     MOVE F3MGCY    MGCY                            S01453
     C                     MOVE F3MGBS    MGBS                            S01453
     C                     MOVE F3OSRT    OSRT                            S01453
     C                     MOVE F3BFPA    BFPA                            S01453
     C                     MOVE F3SFPA    SFPA                            S01453
     C                     MOVE F3BDBS    BDBS                            S01453
     C                     MOVE F3SDBS    SDBS                            S01453
     C                     MOVE F3SDBE    SDBE                            S01453
     C                     MOVE F3BDBF    BDBF                            S01453
     C                     MOVE F3SDBF    SDBF                            S01453
     C                     MOVE F3BDFA    BDFA                            S01453
     C                     MOVE F3SDFA    SDFA                            S01453
     C                     MOVE F3FWPZ    FWPT                            S01453
     C                     END                                            S01453
     C*                                                                   S01453
     C**  -- Swap Leg Indicator
     C*
     C           F3TYPE    IFNE 'SW'                       B1
     C           F3BROK    ANDNE'SWAP'                                                        242477
     C           F3DADN    OREQ *BLANKS                    *1
     C                     Z-ADD*ZERO     FSLI             *1
     C                     ELSE                            X1
     C           *IN76     IFEQ '1'                        B*2
     C                     Z-ADD0         FSLI             **2
     C                     ELSE                            X*2
     C           @VDTE     IFLT F3RVDT                     B**3
     C                     Z-ADD1         FSLI             ***3
     C                     ELSE                            X**3
     C                     Z-ADD2         FSLI             ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  -- Swap Profit/Loss fields and Swap/Option Deal Number
     C*
     C                     Z-ADD*ZERO     SPPD
     C                     Z-ADD*ZERO     SPLA
     C                     MOVE *BLANKS   SPLC
     C           F3TYPE    IFEQ 'SW'                       B1
     C                     EXSR #ZA                        *1
     C                     END                             E1
     C*
     C                     Z-ADD*ZERO     SODN
     C           F3TYPE    IFEQ 'SW'                       B1
     C           F3TYPE    OREQ 'OT'                       *1
     C           F3BROK    OREQ 'SWAP'                     *1
     C                     MOVE F3DADN    SODN             *1
     C                     END                             E1
     C*
     C**  -- Update Deal for account / Special Instructions
     C*
     C                     MOVELF3MFAC    FACO
     C                     MOVELF3SPEC    SPI
     C                     MOVELF3BENN    BENN                            S01177
     C                     MOVELF3BTB1    BTB1                            S01177
     C*                                                                   S01117
     C**  -- Originating Branch                                           S01117
     C*                                                                   S01117
     C                     MOVELF3ORBR    ORBR                            S01117
     C*                                                                   S01117
     C**  -- Profit Centre                                                S01117
     C*                                                                   S01117
     C                     MOVELF3PRFC    PRFC                            S01117
     C*                                                                   S01117
     C**  -- Our Receive Branch                                           S01117
     C*                                                                   S01117
     C*****************    MOVELF3OPSB    OPSB                            S01117
     C                     MOVELF3ROBR    ROBR                            S01117
     C*                                                                   S01117
     C**  -- Our Pay Branch                                               S01117
     C*                                                                   S01117
     C**************       MOVELF3OSSB    OSSB                            S01117
     C                     MOVELF3POBR    POBR                            S01117
     C                     MOVELF3RVCY    RSCY                            CEU003
     C                     MOVELF3PSCY    PSCY                            CEU003
     C                     MOVELF3IC72    IC72                            CEU003
     C*
     C**  -- Update Non-Static and Static Bit Indicators
     C**      By setting off all bits, Spec.instr and Option
     C**            Takedown bits are also set off
     C*
     C                     BITOF'01234567'DNSI
     C                     BITOF'01234567'DSTI
     C*
     C           F3BROK    IFNE 'SWAP'                     B1
     C           F3BROK    ANDNE'TELX'                     *1
     C           F3BROK    ANDNE'PHON'                     *1
     C           F3BROK    ANDNE'MAIL'                     *1
     C           F3BROK    ANDNE*BLANK                     *1             E13902
     C********** F3BRKG    IFEQ *ZERO                      B*2            E13902
     C           F3BRKG    IFEQ *ALL'9'                    B*2            E13902
     C                     BITON'0'       DSTI             **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C*
     C           F3BROK    IFEQ 'SWAP'                     B1
     C           F3TYPE    ANDEQ'SW'                       *1
     C           *IN76     ANDEQ'0'                        *1
     C                     TESTB'0'       @RELBC         71*1
     C           *IN71     IFEQ '1'                        B*2
     C                     BITON'0'       DSTI             **2
     C                     END                             E*2
     C                     END                             E1
     C**
     C           F3BROK    IFEQ 'SWAP'                     B1
     C                     BITON'1'       DSTI             *1
     C                     END                             E1
     C*
     C**  -- Update Accounting and Telex Bit Indicators
     C*
     C                     BITOF'01234567'ACEI
     C                     BITOF'01234567'TLXI
     C*
     C**  -- Last Swift Details
     C*
     C                     Z-ADD*ZERO     LSWC
     C                     Z-ADD*ZERO     LSWS
     C*
     C**  -- Last Change Fields
     C*
     C*****                Z-ADDRUND      ORED                            S01194
     C*****                Z-ADDRUND      LCD                             S01194
     C                     Z-ADDBJRDNB    ORED                            S01194
     C                     Z-ADDBJRDNB    LCD                             S01194
     C                     MOVEL'I'       CHTP
      *                                                                   CDL008
     C           CDL008    IFEQ 'Y'                                       CDL008
     C                     MOVE F3CLSS    CLSS                            CDL008
     C                     ENDIF                                          CDL008
     C*
     C**  -- Zeroise/Blank unspecified fields
     C*
     C                     Z-ADD*ZERO     LITD
     C                     Z-ADD*ZERO     LILA
     C                     Z-ADD*ZERO     DITD
     C                     Z-ADD*ZERO     DILA
     C                     MOVE *BLANKS   ILCY
     C                     Z-ADD*ZERO     ILAM
     C                     MOVE *BLANKS   IDCY
     C                     Z-ADD*ZERO     IDAM
     C                     Z-ADD*ZERO     IDIA
     C                     Z-ADD*ZERO     ILIR
     C                     Z-ADD*ZERO     IDIR
     C                     Z-ADD*ZERO     ILCM
     C                     Z-ADD*ZERO     IDCM
     C                     Z-ADD*ZERO     GCPCAP                          S01440
     C                     Z-ADD*ZERO     GCSCAP                          S01440
     C/COPY WNCPYSRC,FX0380C012
     C*
     C           #BAC9     ENDSR
     C*****************************************************************
      /EJECT                                                              E12279
     C*****************************************************************   E12279
     C***                                                             *   E12279
     C***SUBROUTINE: #BAH   - File DEALSDF                            *   E12279
     C***                     Update deals trailer                    *   E12279
     C***                                                             *   E12279
     C***FIELDS USED:                                                 *   E12279
     C***                                                             *   E12279
     C***                                                             *   E12279
     C***CALLED BY : #BA                                              *   E12279
     C***CALLS     :                                                  *   E12279
     C***                                                             *   E12279
     C***                                                             *   E12279
     C*****************************************************************   E12279
     C***                                                                 E12279
     C***        #BAH      BEGSR                                          E12279
     C***                                                                 E12279
     C***   Access the deals trailer record                               E12279
     C***                                                                 E12279
     C***                  Z-ADD999999    @N6                             E12279
     C***        @N6       CHAINFXMIDBLL             7171                 E12279
     C***        *IN71     IFEQ '1'                        B1             E12279
     C***                  MOVE '009'     DBASE            *1 ***************
     C***                  MOVEL'DEALSDF 'DBFILE           *1 *             *
     C***                  MOVE *BLANKS   DBKEY            *1 *  D.B.ERROR  *
     C***                  MOVE '1'       *INU7            *1 *     009     *
     C***                  MOVE '1'       *INU8            *1 *             *
     C***                  GOTO #BAH9                      *1 ***************
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***   Set up purchase amount in @INT/@DEC (Integer/decimal)         E12279
     C***                                                                 E12279
     C***                                                                 E12279
     C***                  MOVE *BLANKS   KEY                             E12279
     C***                  MOVE '20'      @PRF                            E12279
     C***                  MOVE PUCY      @CUR                            E12279
     C***                  MOVE '1'       @SUF                            E12279
     C***                                                                 E12279
     C***  Determine whether amount 1 or 2 is purchase, and load          E12279
     C***                                                                 E12279
     C***                  Z-ADD*ZERO     @DEC                            E12279
     C***        F3DAM1    IFGT *ZERO                      B1             E12279
     C***                  MOVE F3DAM1    @X15   15        *1             E12279
     C***                  ELSE                            X1             E12279
     C***                  MOVE F3DAM2    @X15             *1             E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***                  MOVEA@X15      @ID,1                           E12279
     C***                                                                 E12279
     C***        @DEC      IFLT *ZERO                      B1             E12279
     C***                  Z-SUB@INT      @INT             *1             E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***   Update control totals for insertions                          E12279
     C***                                                                 E12279
     C***        F3MACT    IFEQ 'I'                        B1             E12279
     C***                  ADD  1         NORE             *1             E12279
     C***                  ADD  1         NINS             *1             E12279
     C***                  ADD  1         NLRA             *1             E12279
     C***        F3TYPE    IFNE 'OT'                       B*2            E12279
     C***                                                                 E12279
     C***  Add in new amounts                                             E12279
     C***                  Z-ADDVRIF      @OLDIT 150       **2            E12279
     C***                  Z-ADDVRIL      @OLDDC 150       **2            E12279
     C***                  EXSR #BAHA                      **2            E12279
     C***                  Z-ADD@NEWIT    VRIF             **2            E12279
     C***                  Z-ADD@NEWDC    VRIL             **2            E12279
     C***                                                                 E12279
     C***  Add in new amounts                                             E12279
     C***                  Z-ADDVLAF      @OLDIT 150       **2            E12279
     C***                  Z-ADDVLAL      @OLDDC 150       **2            E12279
     C***                  EXSR #BAHA                      **2            E12279
     C***                  Z-ADD@NEWIT    VLAF             **2            E12279
     C***                  Z-ADD@NEWDC    VLAL             **2            E12279
     C***                  END                             E*2            E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***   Update control totals for reversals  (main deal)              E12279
     C***                                                                 E12279
     C***        F3MACT    IFEQ 'R'                        B1             E12279
     C***                                                                 E12279
     C***        F3TYPE    IFNE 'SW'                       B*2            E12279
     C***        @RECIB    OREQ 'D'                        X*2            E12279
     C***                  ADD  1         NDEL             **2            E12279
     C***                  SUB  1         NLRA             **2            E12279
     C***        F3TYPE    IFNE 'OT'                       B**3           E12279
     C***                                                                 E12279
     C***  Add in new amounts                                             E12279
     C***                  Z-ADDVRDF      @OLDIT 150       **2            E12279
     C***                  Z-ADDVRDL      @OLDDC 150       **2            E12279
     C***                  EXSR #BAHA                      **2            E12279
     C***                  Z-ADD@NEWIT    VRDF             **2            E12279
     C***                  Z-ADD@NEWDC    VRDL             **2            E12279
     C***                                                                 E12279
     C***  Subtract new amounts (reverse signs and add)                   E12279
     C***                  Z-SUB@INT      @INT             ***3           E12279
     C***                  Z-SUB@DEC      @DEC             ***3           E12279
     C***                  Z-ADDVLAF      @OLDIT 150       **2            E12279
     C***                  Z-ADDVLAL      @OLDDC 150       **2            E12279
     C***                  EXSR #BAHA                      **2            E12279
     C***                  Z-ADD@NEWIT    VLAF             **2            E12279
     C***                  Z-ADD@NEWDC    VLAL             **2            E12279
     C***orrect the signs for futher use                                  E12279
     C***                  Z-SUB@INT      @INT             ***3           E12279
     C***                  Z-SUB@DEC      @DEC             ***3           E12279
     C***                  END                             E**3           E12279
     C***                  END                             E*2            E12279
     C***                                                                 E12279
     C***   Update control totals for reversals  (related deal)           E12279
     C***                                                                 E12279
     C***        @RELRI    IFEQ 'SW'                       B*2            E12279
     C***        @RELDT    ANDEQ'D'                        X*2            E12279
     C***        *IN76     ANDEQ'0'                        **2            E12279
     C***                  ADD  1         NDEL             **2            E12279
     C***                  SUB  1         NLRA             **2            E12279
     C***                                                                 E12279
     C***  Add in new amounts                                             E12279
     C***                  Z-ADDVRDF      @OLDIT 150       **2            E12279
     C***                  Z-ADDVRDL      @OLDDC 150       **2            E12279
     C***                  EXSR #BAHA                      **2            E12279
     C***                  Z-ADD@NEWIT    VRDF             **2            E12279
     C***                  Z-ADD@NEWDC    VRDL             **2            E12279
     C***                                                                 E12279
     C***  Subtract new amounts (reverse signs and add)                   E12279
     C***                  Z-SUB@INT      @INT             ***3           E12279
     C***                  Z-SUB@DEC      @DEC             ***3           E12279
     C***                  Z-ADDVLAF      @OLDIT 150       **2            E12279
     C***                  Z-ADDVLAL      @OLDDC 150       **2            E12279
     C***                  EXSR #BAHA                      **2            E12279
     C***                  Z-ADD@NEWIT    VLAF             **2            E12279
     C***                  Z-ADD@NEWDC    VLAL             **2            E12279
     C***orrect the signs for futher use                                  E12279
     C***                  Z-SUB@INT      @INT             ***3           E12279
     C***                  Z-SUB@DEC      @DEC             ***3           E12279
     C***                  END                             E*2            E12279
     C***                                                                 E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***   Write the results back to disk                                E12279
     C***                                                                 E12279
     C***                  UPDATDEALSDFF               71                 E12279
     C***        *IN71     IFEQ '1'                        B1             E12279
     C***                  MOVE '010'     DBASE            *1 **************
     C***                  MOVEL'DEALSDF 'DBFILE           *1 *            *
     C***                  MOVE *BLANKS   DBKEY            *1 * D.B.ERROR  *
     C***                  MOVE '1'       *INU7            *1 *   010      *
     C***                  MOVE '1'       *INU8            *1 *            *
     C***                  GOTO #BAH9                      *1 **************
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***                                                                 E12279
     C***        #BAH9     ENDSR                           **#BAH9**      E12279
     C*****************************************************************   E12279
     C***                                                                 E12279
     C*** Subroutine #BAHA:  To add decimal and integer amounts           E12279
     C***                    to file trailer totals                       E12279
     C***                                                                 E12279
     C*** Uses  :   @TOTDC    Working decimal total     (4,0)             E12279
     C***           @TOTIT    Working integer total     (15,0)            E12279
     C*** Input :   @OLDDC    Old decimal total         (3,0)             E12279
     C***           @OLDIT    Old integer total         (15,0)            E12279
     C***           @DEC      Decimal value to be added (3,0)             E12279
     C***           @INT      Integer value to be added (15,0)            E12279
     C*** Output:   @NEWDC    New decimal total         (3,0)             E12279
     C***           @NEWIT    New integer total         (15,0)            E12279
     C***                                                                 E12279
     C*****************************************************************   E12279
     C***                                                                 E12279
     C***        #BAHA     BEGSR                           **BAHA**       E12279
     C***                                                                 E12279
     C*** Initialise fields                                               E12279
     C***                  Z-ADD*ZERO     @TOTDC  40                      E12279
     C***                  Z-ADD@OLDIT    @NEWIT 150                      E12279
     C***                                                                 E12279
     C***Ensure that the decimal has the same sign as the integer         E12279
     C***(On file the decimal already has a sign ie. @OLDDC)              E12279
     C***        @INT      IFLT *ZERO                      B1             E12279
     C***        @DEC      ANDGT*ZERO                      B1             S01136
     C***                  Z-SUB@DEC      @DEC             *1             E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C*** Decimals                                                        E12279
     C*** Add the new decimals to the old total                           E12279
     C***        @DEC      ADD  @OLDDC    @TOTDC                          E12279
     C***                                                                 E12279
     C*** Monitor for overflow (eg. -15 + -990 = -1005)                   E12279
     C***        @TOTDC    IFLT -999                       B1             E12279
     C***                  SUB  1         @NEWIT           *1             E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C*** Monitor for overflow (eg. 15 + 990 = 1005)                      E12279
     C***        @TOTDC    IFGT 999                        B1             E12279
     C***                  ADD  1         @NEWIT           *1             E12279
     C***                  END                             E1             E12279
     C***                                                                 E12279
     C***If -ve decimals must correct to get correct amount & +/-   S01136E12279
     C***        @TOTDC    IFLT *ZERO                      B1       S01136E12279
     C***                  ADD  1000      @TOTDC           *1       S01136E12279
     C***        @NEWIT    SUB  1         @NEWIT           *1       S01136E12279
     C***                  END                             E1       S01136E12279
     C***                                                                 E12279
     C*** Return decimals as a 3,0 field                                  E12279
     C***                  MOVE @TOTDC    @NEWDC  30                      E12279
     C***                                                                 E12279
     C*** Integers                                                        E12279
     C*** Add the integers to the overflow corrected old total            E12279
     C***                  ADD  @INT      @NEWIT                          E12279
     C***                                                                 E12279
     C***        #BAHA9    ENDSR                           **BAHA9**      E12279
      /EJECT                                                              E12279
     C*****************************************************************   E12279
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BBA   - Process FXP0056                         *
     C*      (Set up pay/receive indicators)                          *
     C*                                                               *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BB                                              *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BBA      BEGSR
     C*
     C                     Z-ADD*ZERO     @PRIN1  10
     C                     Z-ADD*ZERO     @PRIN2  10
     C                     Z-ADD*ZERO     @PRIN3  10
     C*
     C*
     C**  Process FXP0217  (Interpret deal methods to MIDAS methods)
     C*****
     C******               EXSR #BBAA
     C*
     C*
     C*     Set up relevant date for comparison in #BBAB
     C*
     C           DTYP      IFEQ 'OP'                       B1
     C                     Z-ADDOTDT      @CMPDT           *1
     C                     ELSE                            X1
     C                     Z-ADDVDAT      @CMPDT           *1
     C                     END                             E1
     C*
     C*     Calculate pay/receive indicator based on
     C*           purchase currency and receipt instructions
     C*
     C           PCST      IFEQ 01                         B1
     C           PCST      OREQ 02                         *1
     C           PCST      OREQ 07                         *1
     C           PCST      OREQ 08                         *1
     C           PCST      OREQ 12                         *1
     C           PCST      OREQ 00                                        BHF849
     C*
     C                     MOVE PUCY      @RECUR           *1
     C                     MOVE @BESC     @SECUR           *1             CEU003
     C           PCST      IFEQ 02                         B*2
     C           PCST      OREQ 12                         **2
     C*****                MOVE LOCY      @RECUR           **2            S01194
     C                     MOVE BJLCCY    @RECUR           **2            S01194
     C                     MOVE BJLCCY    @SECUR           **2            CEU003
     C                     END                             E*2
     C*
     C                     EXSR #BBAB                      *1
     C           *INU7     CABEQ'1'       #BBA9            *1
     C*
     C           @INOUT    IFEQ 'I'                        B*2
     C                     Z-ADD1         @PRIN1           **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C*     Calculate pay/receive indicator based on
     C*              sale currency and payment instructions
     C*
     C           SCST      IFEQ 01                         B1
     C           SCST      OREQ 02                         *1
     C           SCST      OREQ 07                         *1
     C           SCST      OREQ 08                         *1
     C           SCST      OREQ 12                         *1
     C           SCST      OREQ 00                                        BHF849
     C*
     C                     MOVE SLCY      @RECUR           *1
     C                     MOVE @SESC     @SECUR           *1             CEU003
     C           SCST      IFEQ 02                         B*2
     C           SCST      OREQ 12                         **2
     C*****                MOVE LOCY      @RECUR           **2            S01194
     C                     MOVE BJLCCY    @RECUR           **2            S01194
     C                     MOVE BJLCCY    @SECUR           **2            CEU003
     C                     END                             E*2
     C*
     C/COPY WNCPYSRC,FX0380C009
     C                     EXSR #BBAB                      *1
     C           *INU7     CABEQ'1'       #BBA9            *1
     C*
     C           @INOUT    IFEQ 'I'                        B*2
     C                     Z-ADD1         @PRIN3           **2
     C                     END                             E*2
     C*
     C*
     C                     END                             E1
     C*
     C           #BBA9     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #ZA    - Process FXP0053                         *
     C*        Calculate Profit/Loss amount and currency.
     C*                                                               *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BAC                                             *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           #ZA       BEGSR
     C*
     C           F3DAM1    IFGT *ZERO                      B1
     C                     Z-ADDF3DAM1    @CURPA           *1
     C                     Z-SUBF3DAM2    @CURSA           *1
     C                     ELSE                            X1
     C                     Z-ADDF3DAM2    @CURPA           *1
     C                     Z-SUBF3DAM1    @CURSA           *1
     C                     END                             E1
     C*
     C           @CURPA    IFNE @RELSA                     B1
     C           @CURPA    SUB  @RELSA    SPLA             *1
     C                     MOVE @PUCY     SPLC             *1
     C                     ELSE                            X1
     C           @RELBA    SUB  @CURSA    SPLA             *1
     C                     MOVE @SLCY     SPLC             *1
     C                     END                             E1
     C*
     C           #ZA9      ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BBAA  - Process FXP0217                         *
     C*          Fill in Supplemetary Deal information (Pay/          *
     C*                                  Receive indicators)          *
     C*     Process made redundant, as calculations are already
     C*     performed in previously executed FXP0215
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BBA                                             *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C******     #BBAA     BEGSR
     C**
     C**
     C**   Recalculate Our Receive Indicator if method has changed
     C**
     C**         *IN62     IFEQ '1'                        B1
     C**         F3DORM    ORNE FHDORM                     X1
     C**         F3ORCM    OREQ *ZERO                      X1
     C**         F3DORM    IFEQ *BLANKS                    B*2
     C**                   Z-ADD*ZERO     F3ORCM           **2
     C**                   ELSE                            X*2
     C**                   MOVE '0'       *IN71            **2
     C**                   Z-ADD1         @NN     20       **2
     C**         F3DORM    LOKUP@DOM,@NN               71  **2
     C**         *IN71     IFEQ '1'                        B**3
     C**                   Z-ADD@MOM,@NN  F3ORCM           ***3
     C**                   ELSE                            X**3
     C**                   Z-ADD*ZERO     F3ORCM           ***3
     C**                   END                             E**3
     C**                   END                             E*2
     C**                   END                             E1
     C**
     C**
     C**   Recalculate Our Pay Indicator if method has changed
     C**
     C**         *IN62     IFEQ '1'                        B1
     C**         F3DOPM    ORNE FHDOPM                     X1
     C**         F3DMPM    OREQ *ZERO                      X1
     C**         F3DOPM    IFEQ *BLANKS                    B*2
     C**                   Z-ADD*ZERO     F3DMPM           **2
     C**                   ELSE                            X*2
     C**                   MOVE '0'       *IN71            **2
     C**                   Z-ADD1         @NN     20       **2
     C**         F3DOPM    LOKUP@DOM,@NN               71  **2
     C**         *IN71     IFEQ '1'                        B**3
     C**                   Z-ADD@MOM,@NN  F3DMPM           ***3
     C**                   ELSE                            X**3
     C**                   Z-ADD*ZERO     F3DMPM           ***3
     C**                   END                             E**3
     C**                   END                             E*2
     C**                   END                             E1
     C**
     C**
     C*******    #BBAA9    ENDSR                           **#BBAA9**
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BBAB  - Set up one pay/receive indicator        *
     C*                                                               *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BBA                                             *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BBAB     BEGSR
     C*
     C*
     C*     Retrieve telex notice days for the currency
     C*
     C*****                MOVE *BLANKS   KEY                             S01194
     C*****                MOVE '20'      @PRF                            S01194
     C*****                MOVE @RECUR    @CUR                            S01194
     C*****                MOVE '1'       @SUF                            S01194
     C*****      KEY       CHAINFDCCYTLL             7171                 S01194
     C*****      *IN71     IFEQ '1'                        B1             S01194
     C*****                MOVE '011'     DBASE            *1        *****S01194
     C*****                MOVEL'FDCCYTLL'DBFILE           *1             S01194
     C*****                MOVE *BLANKS   DBKEY            *1             S01194
     C*****                MOVEL@RECUR    DBKEY            *1        ERRORS01194
     C*****                MOVE '1'       *INU7            *1        11   S01194
     C*****                MOVE '1'       *INU8            *1             S01194
     C*****                GOTO #BBAB9                     *1        *****S01194
     C*****                END                             E1             S01194
     C*                                                                   S01194
     C***** USE ACCESS PROGRAM TO READ CURRENCIES FILE                    S01194
     C*                                                                   S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*MSG   ' @RTCD                           S01194
     C                     PARM '*KEY   ' @OPTN                           S01194
     C***********          PARM @RECUR    @AJCD   3                S01194 CEU003
     C                     PARM @SECUR    @AJCD   3                       CEU003
     C           @CURR     PARM @CURR     DSSDY                           S01194
     C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN71                           S01194
     C                     END                                            S01194
     C*                                                                   S01194
     C           *IN71     IFEQ '1'                        B1             S01194
     C                     MOVE '011'     DBASE            *1   **********S01194
     C                     MOVEL'SDCURRPD'DBFILE           *1   *        *S01194
     C                     MOVE *BLANKS   DBKEY            *1   *        *S01194
     C***********          MOVEL@RECUR    DBKEY            *1   * S01194  CEU003
     C                     MOVEL@SECUR    DBKEY            *1   *         CEU003
     C                     MOVE '1'       *INU7            *1   *    011 *S01194
     C                     MOVE '1'       *INU8            *1   *        *S01194
     C                     EXSR *PSSR                      *1   *        *S01194
     C                     GOTO #BBAB9                     *1   **********S01194
     C                     END                             E1             S01194
     C*                                                                   S01194
     C*
     C*    Calculate no. of working days forward from system date
     C*
     C*        (i)  Convert NNNNN to YYYYMMDD
     C*
     C*****                MOVE RUND      @@DAYN                          S01194
     C*********************MOVE BJRDNB    @@DAYN                    S01194E21923
     C           BJDNWD    SUB  1         @@DAYN                          E21923
     C                     EXSR ZA0710
     C                     MOVE @@VDT     @@DTIN
     C*
     C*       (ii)  Calculate no. working days forward for telex notice
     C*
     C***********          MOVE @RECUR    @@INCY                          CEU003
     C                     MOVE @RECUR    @@INCY                          155333
     C                     MOVE @SECUR    @RECUR                          CEU003
     C*                                                                   060106
     C** If buy ccy use receipt, else if sell ccy use pay                 060106
     C*                                                                   060106
     C***********@@INCY    IFEQ PUCY                               060106 CEU003
     C           @RECUR    IFEQ PUCY                                      CEU003
     C                     MOVELF3RONS    @@NOST  2                       060106
     C                     ELSE                                           060106
     C***********@@INCY    IFEQ SLCY                               060106 CEU003
     C           @RECUR    IFEQ SLCY                                      CEU003
     C                     MOVELF3PONS    @@NOST  2                       060106
     C                     END                                            060106
     C                     END                                            060106
     C*                                                                   060106
     C*****                Z-ADDTNOT      @@FWD                           S01194
     C                     Z-ADDA6TXND    @@FWD                           S01194
     C                     EXSR ZA0690
     C                     MOVE @@EDAT    @@DTIN
     C*
     C*       (iii)  Convert YYYYMMDD  to NNNNN
     C*
     C                     EXSR ZA0680
     C                     MOVE @@MDNO    @CONDT
     C*
     C*
     C*      Compare system date, comparison date and control date
     C*          and say if comparison date is in or out of range
     C*
     C                     MOVE 'O'       @INOUT  1
     C*****      RUND      IFLE @CMPDT                     B1             S01194
     C           BJRDNB    IFLE @CMPDT                     B1             S01194
     C           @CONDT    ANDGE@CMPDT                     *1
     C/COPY WNCPYSRC,FX0380C005
     C                     MOVE 'I'       @INOUT           *1
     C                     END                             E1
     C*
     C*
     C           #BBAB9    ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BAD   - Result content sheet R/FXR0022          *
     C*                       Update related swap                     *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BA                                              *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BAD      BEGSR
     C/COPY WNCPYSRC,FX0380C013
     C*
     C**  Set up record code, Deal type, Option End Date
     C*
     C                     Z-ADD14        RCDC
     C                     MOVE 'SW'      DTYP
     C                     Z-ADDF3VDDN    OTDT
     C*
     C**  Set up swap leg indicator, other deal number
     C*
     C           F3VDDN    IFLT VDAT                       B1
     C                     Z-ADD2         FSLI             *1
     C                     ELSE                            X1
     C                     Z-ADD1         FSLI             *1
     C                     END                             E1
     C*
     C                     Z-ADD*ZERO     SPPD
     C                     EXSR #ZA
     C                     Z-ADDF3DN38    SODN
     C*
     C           F3BROK    IFEQ 'SWAP'                     B1
     C                     BITON'1'       DSTI             *1
     C                     END                             E1
     C*
     C**   Record last change information
     C*
     C                     MOVE 'A'       CHTP
     C/COPY WNCPYSRC,FX0380C004
     C*
     C           #BAD9     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BAE   - Result content sheet R/FXR0023          *
     C*                       Update related option                   *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BA                                              *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BAE      BEGSR
     C*
     C*    Subtract option-taken-down purchased amount from purchased
     C*               amount in the original deal.   The "original" deal
     C*               is the related deal as seen from the OT deal.
     C*
     C           F3DAM1    IFGT *ZERO                      B1
     C                     SUB  F3DAM1    PUAM             *1
     C                     ELSE                            X1
     C                     SUB  F3DAM2    PUAM             *1
     C                     END                             E1
     C*
     C*    Subtract option-taken-down sell amount from sell amount
     C*               in the original deal.   The "original" deal
     C*               is the related deal as seen from the OT deal.
     C*        N.B. Sell amount is held as negative on FXSTDDLL
     C*
     C           F3DAM1    IFGT *ZERO                      B1
     C                     ADD  F3DAM2    SLAM             *1
     C                     ELSE                            X1
     C                     ADD  F3DAM1    SLAM             *1
     C                     END                             E1
      *                                                                   CAC001
      **  Reduce the margin amount of the related 'OP' deal               CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
     C                     SUB  F3MGAM    MGAM                            CAC001
     C                     ENDIF                                          CAC001
     C*
     C                     SUB  F3BCAE    BCEQ
     C                     BITON'2'       DNSI
     C*
     C                     MOVE 'A'       CHTP
     C*
     C           #BAE9     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BAF   - Result content sheet R/FXR0024          *
     C*                       Update related swap                     *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BA                                              *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BAF      BEGSR
     C*
     C                     Z-ADDF3VDDN    OTDT
     C*
     C*
     C**  Set up swap leg indicator, other deal number
     C*
     C           VDAT      IFLT F3VDDN                     B1
     C                     Z-ADD1         FSLI             *1
     C                     ELSE                            X1
     C                     Z-ADD2         FSLI             *1
     C                     END                             E1
     C*
     C                     Z-ADDF3DN38    SODN
     C*
     C           F3BROK    IFEQ 'SWAP'                     B1
     C                     BITON'1'       DSTI             *1
     C                     END                             E1
     C*
     C**   Record last change information
     C*
     C                     MOVE 'A'       CHTP
     C*
     C*
     C           #BAF9     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #BAG   - Result content sheet R/FXR0025          *
     C*                         Reverse related swap                  *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*                                                               *
     C*  CALLED BY : #BA                                              *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           #BAG      BEGSR
     C*
     C                     MOVE 'R'       RECI
     C*
     C                     TESTB'7'       @XCNFI         71
     C           *IN71     IFEQ '1'                        B1
     C                     BITOF'0'       CNFI             *1
     C                     END                             E1
     C*
     C**   Record last change information
     C*
     C                     MOVE 'R'       CHTP
     C*
     C*
     C           #BAG9     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************   S01194
     C******                                                          *   S01194
     C******  SUBROUTINE ZA0150 - THIS SUBROUTINE CHAINS TO FILE LF/  *   S01194
     C******  FDICDRLL TO GET THE INSTALLATION CONTROL DETAILS RECORD *   S01194
     C******  1 (HELD ON PF/TABTB10)                                  *   S01194
     C******  INDICATOR 80 IS SET ON IF THE CHAIN FAILS OR THE RECORD *   S01194
     C******  IS FLAGGED FOR DELETION.                                *   S01194
     C******  IF INDICATOR 80 IS SET ON DETAILS OF THE ATTEMPTED      *   S01194
     C******  ACCESS ARE PLACED IN THE LDA.                           *   S01194
     C******                                                          *   S01194
     C******  FIELDS USED : SS0150 - KEY USED TO ACCESS FDICDRLL      *   S01194
     C******                                                          *   S01194
     C*****************************************************************   S01194
     C******                                                              S01194
     C******     ZA0150    BEGSR                                          S01194
     C******                                                              S01194
     C***SET*UP KEY TO OBTAIN FORMAT TABTB10F '01        10'              S01194
     C******               MOVEL'01'      SS0150 12                       S01194
     C*****                MOVE '10'      SS0150                          S01194
     C*****                                                               S01194
     C***CHAIN TO FILE FDICDRLL                                           S01194
     C*****      SS0150    CHAINFDICDRLL             8080                 S01194
     C*****      RECI      IFNE 'D'                        B1             S01194
     C*****                MOVE '1'       *IN80            *1             S01194
     C*****                END                             E1             S01194
     C*****                                                               S01194
     C***DEAL*WITH DATA BASE ERROR                                        S01194
     C*****      *IN80     IFEQ '1'                        B1        *****S01194
     C*****                MOVEL'FDICDRLL'DBFILE           *1            *S01194
     C*****                MOVEL'900'     DBASE            *1        900 *S01194
     C*****                MOVELSS0150    DBKEY            *1            *S01194
     C*****                END                             E1        *****S01194
     C*****                                                               S01194
     C*****      ZA0159    ENDSR                                          S01194
     C*****************************************************************   S01194
     C/EJECT                                                              S01194
     C*****************************************************************   S01194
     C*                                                               *   S01194
     C*       SUBROUTINE #D - THIS SUBROUTINE USES AN ACCESS PROGRAM  *   S01194
     C*       TO READ THE BANK DETAILS FILE.                              S01194
     C*       INDICATOR 80 IS SET ON IF THERE IS AN ERROR ON THE READ.*   S01194
     C*       IF INDICATOR 80 IS SET ON DETAILS OF THE ATTEMPTED      *   S01194
     C*       ACCESS ARE PLACED IN THE LDA.                           *   S01194
     C*                                                               *   S01194
     C*                                                               *   S01194
     C*****************************************************************   S01194
     C*                                                                   S01194
     C           #D        BEGSR                                          S01194
     C*                                                                   S01194
     C                     CALL 'AOBANKR0'                                S01194
     C                     PARM '*MSG    '@RTCD                           S01194
     C                     PARM '*FIRST  '@OPTN                           S01194
     C           @BANK     PARM @BANK     DSFDY                           S01194
     C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVEL'SDBANKPD'DBFILE           *************  S01194
     C                     MOVEL'900'     DBASE            * DBERR 900 *  S01194
     C                     MOVEL@OPTN     DBOPTN  7        *************  S01194
     C                     MOVE '1'       *IN80                           S01194
     C                     EXSR *PSSR                                     S01194
     C                     END                                            S01194
     C*                                                                   S01194
     C           #D9       ENDSR                                          S01194
     C*****************************************************************   S01194
     C/EJECT
     C*******************************************************************
     C*
     C* ZA0680 - THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO
     C*          MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)
     C*
     C* CALLED BY :
     C*
     C* CALLS :
     C*
     C* INPUT  : @@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)
     C*
     C* OUTPUT : @@MDNO MIDAS DAY NUMBER  (SIZE : 5N)
     C*
     C* USES :   @@CC   NUMBER OF CENTURIES IN DATE
     C*          @@DAY  DAY NUMBER
     C*          @@REM  REMAINDER FROM DIVIDE
     C*          @@MTH  MONTH NUMBER
     C*          @MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN
     C*                 MONTH
     C*          @@WK2  WORK FIELD (2,0)
     C*          @@WK5  WORK FIELD (5,0)
     C*          @@YYYY YEAR (4 CHARACTER)
     C*          @@YY   YEAR (2 CHARACTER)
     C*          @YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN
     C*                 A FOUR YEAR PERIOD
     C*
     C*******************************************************************
     C*
     C           ZA0680    BEGSR
     C*
     C**  CLEAR OUT ANY 'OLD' DATA IN FIELD
     C                     Z-ADD0         @@MDNO  50
     C*
     C**   IF DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING
     C           @@YYYY    IFGE 2072                       B1
     C*
     C**    MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)
     C           @@CC      SUB  19        @@WK2   20       *1
     C           @@WK2     MULT 36524     @@MDNO           *1
     C*
     C**  YEAR 2000 IS A LEAP YEAR MUST ALLOW EXTRA DAY
     C                     ADD  1         @@MDNO           *1
     C                     END                             E1
     C*
     C           @@YYYY    ADD  28        @@WK2
     C*
     C           @@WK2     DIV  4         @@WK2
     C                     MVR            @@REM   10
     C*
     C**    MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD
     C           @@WK2     MULT 1461      @@WK5   50
     C                     ADD  @@WK5     @@MDNO
     C*
     C**  CHECK REMAINDER AND MONTH NUMBER
     C           @@REM     IFEQ 0                          B1
     C           @@MTH     ANDGT2                          *1
     C                     ADD  1         @@MDNO           *1
     C                     END                             E1
     C*
     C**  YEAR NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR
     C           @@REM     IFNE 0                          B1
     C                     ADD  @YD,@@REM @@MDNO           *1
     C                     END                             E1
     C*
     C**  ADD MONTHS THIS YEAR
     C                     ADD  @MD,@@MTH @@MDNO
     C*
     C**  ADD DAYS THIS MONTH
     C                     ADD  @@DAY     @@MDNO
     C*
     C           ZA0689    ENDSR                                     AG**
     C*****************************************************************
     C/EJECT
     C*******************************************************************
     C* ZA0690 - CALCULATE MUTUAL WORKING DAYS FORWARD AGAINST
     C*          LOCAL CURRENCY
     C*          ADD MUTUAL WORKING DAYS FOR TWO DIFFERENT
     C*          CURRENCIES TO A START DATE TO PRODUCE AN END
     C*          DATE.
     C*
     C* CALLED BY :
     C*
     C* CALLS :  ZA0680
     C***********ZA0830********************************                   S01195
     C*          ZCHKH                                                    S01195
     C*          ZA0710
     C*
     C*
     C* INPUT  : @@DTIN INPUT DATE (YYYYMMDD)
     C***********@@INCY*INPUT*CURRENCY*(NOT*LOCAL)*****                   161411
     C*          @RECUR INPUT CURRENCY (NOT LOCAL)                        161411
     C*          @@FWD  NO OF WORKING DAYS FORWARD
     C*
     C* OUTPUT : @@EDAT OUTPUT DATE (YYYYMMDD)
     C*
     C* USES :   @@MDNO DATE NO. OUTPUT FROM ZA0680 5N
     C***********@@MNO**DATE NO. 5N                                       S01195
     C*          ZDAYNO DATE NO. 5N                                       S01195
     C*          @@WRKF NO. OF WORK DAYS FOUND
     C***********@@CCY**INPUT*CURRENCY*TO*ZA0830*********                 S01195
     C*          ZCCY   INPUT CURRENCY TO ZCHKH                           S01195
     C*          ZLOC   INPUT LOCATION CODE TO ZCHKH                      S01195
     C***********@@INCY*INPUT*CURRENCY*TO*THIS*SUBROUTINE                 161411
     C*          @RECUR INPUT CURRENCY TO THIS SUBROUTINE                 161411
     C***********@@HIND*HOLIDAY*/*WORK*DAY*INDICTOR                       S01195
     C*          ZIND   HOLIDAY / WORK DAY INDICTOR                       S01195
     C*          @@DAYN DATE INPUT TO ZA0710
     C*          @@VDT  DATE OUTPUT FROM ZA0710
     C***********LOCY***LOCAL*CURRENCY*FROM*TABTB11******                 S01195
     C*
     C*******************************************************************
     C*
     C           ZA0690    BEGSR
     C*
     C*  CONVERT START DATE TO MIDAS DAY NUMBER FORMAT
     C                     EXSR ZA0680
     C*****                MOVE @@MDNO    @@MNO   50                      S01195
     C                     MOVE @@MDNO    ZDAYNO  50                      S01195
     C*
     C*  INITIALISE NO. OF WORK DAYS FOUND
     C                     Z-ADD0         @@WRKF  50
     C*
     C*  MAIN LOOP
     C           @@WRKF    DOWLT@@FWD                      B1
     C*
     C*  INCREMENT DATE
     C*****                ADD  1         @@MNO            *1             S01195
     C                     ADD  1         ZDAYNO           *1             S01195
     C*
     C*  SEE IF DATE IS A WORK DAY IN LOCAL CCY
     C*****                MOVE LOCY      @@CCY   3        *1             S01194
     C                     MOVE BJLCCY    ZCCY    3        *1             S01194
     C                     MOVE BJSLCD    ZLOC    3        *1             S01194
     C*****                EXSR ZA0830                     *1             S01195
     C                     EXSR ZCHKH                      *1             S01195
     C*
     C*   F DATE IS A WORK DAY IN LOCAL CCY THEN
     C*  SEE IF DATE IS A WORK DAY IN INPUT CCY
     C*****      @@HIND    IFEQ 'W'                        B*2            S01195
     C           ZIND      IFEQ 'W'                        B*2            S01195
     C*****                MOVE @@INCY    @@CCY            **2            S01195
     C***********          MOVE @@INCY    ZCCY             **2     S01195 161411
     C                     MOVE @RECUR    ZCCY             **2            161411
     C*                                                                   060106
     C** Determine input CCY location thru Nostro Sname                   060106
     C*                                                                   060106
     C                     CALL 'AONOSTR0'                                060106
     C                     PARM *BLANKS   @RTCD   7                       060106
     C                     PARM '*KEY   ' @OPTN   7                       060106
     C                     PARM *BLANKS   @KEYA   6                       060106
     C***********          PARM @@INCY    @KEYB   3                060106 168991
     C                     PARM @RECUR    @KEYB   3                       168991
     C                     PARM *BLANKS   @KEYC   4                       060106
     C                     PARM *BLANKS   @KEYD   2                       060106
     C                     PARM @@NOST    @KEYE   2                       060106
     C                     PARM *BLANKS   @KEYF   3                       060106
     C                     PARM *BLANKS   @KEYG  10                       060106
     C                     PARM *BLANKS   @KEYH   1                       060106
     C           SDNOST    PARM SDNOST    DSFDY                           060106
     C*                                                                   060106
     C           @RTCD     IFEQ *BLANKS                                   060106
     C                     MOVE NOSLOC    ZLOC                            060106
     C                     END                                            060106
     C*                                                                   060106
     C*****                EXSR ZA0830                     **2            S01195
     C                     EXSR ZCHKH                      **2            S01195
     C*
     C*  IF BOTH ARE WORK DAYS THEN INCREMENT WORK DAYS FOUND
     C*****      @@HIND    IFEQ 'W'                        B**3           S01195
     C           ZIND      IFEQ 'W'                        B**3           S01195
     C                     ADD  1         @@WRKF           ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C*  CONVERT INCREMENTED START DATE TO YYYYMMDD
     C*****                MOVE @@MNO     @@DAYN  80                      S01195
     C                     MOVE ZDAYNO    @@DAYN  80                      S01195
     C                     EXSR ZA0710
     C                     MOVE @@VDT     @@EDAT  80
     C*
     C*  END SUBROUTINE
     C           ZA0699    ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*       TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *
     C*                                                               *
     C*       SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *
     C*       PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *
     C*       THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *
     C*       SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *
     C*       IF '@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *
     C*       '@@VDT'  IN 'YYYYMMDD' FORMAT.                          *
     C*                                                               *
     C* NOTE: FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS
     C*                                                               *
     C*       1) @@DAYN   LENGTH 5,0.                                 *
     C*                                                               *
     C*       FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *
     C*                                                               *
     C*       1) @@VDT    LENGTH 8,0 DEFINED BY A DS.                 *
     C*       2) @@RTN    LENGTH 1,0.                                 *
     C*       3) @@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *
     C*       4) @@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *
     C*       5) @@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *
     C*       6) @@RDAY   LENGTH 5,0.                                 *
     C*       7) @@LEAP   LENGTH 1,0.
     C*                                                               *
     C*       INDICATORS USED ARE:                                    *
     C*                                                               *
     C*       1) 80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *
     C*       2) 81       CHECK FOR LOW ON ARRAY @MD.                 *
     C*                                                               *
     C* INPUT FIELD:       @@DAYN                                     *
     C*                                                               *
     C* OUTPUT FIELD:      @@VDT                                      *
     C*                                                               *
     C* WORK FIELDS:       @@RTN                                      *
     C*                    @@Z71Y                                     *
     C*                    @@RDAY                                     *
     C*                    @@LEAP                                     *
     C*                    @@I                                        *
     C*                    @@J                                        *
     C*                                                               *
     C* ARRAYS USED:       @YD COMPILE TIME ARRAY.
     C*                    @MD COMPILE TIME ARRAY.
     C*
     C*****************************************************************
     C*
     C           ZA0710    BEGSR
     C*
     C                     SETOF                     8081
     C                     Z-ADD0         @@RTN   10
     C                     Z-ADD0         @@VDT
     C                     Z-ADD1         @@I     20
     C                     Z-ADD1         @@J     20
     C                     Z-ADD1         @@LEAP  10
     C*
     C           @@DAYN    IFLT 1                          B1
     C                     Z-ADD1         @@RTN            *1
     C                     GOTO ZA0719                     *1
     C                     END                             E1
     C*
     C* DIVISION TO DETERMINE WETHER LEAP YEAR.
     C*
     C           @@DAYN    DIV  1461      @@Z71Y
     C                     MVR            @@RDAY  50
     C*
     C* CALCULATING YEAR.
     C*
     C           @@Z71Y    MULT 4         @@Z71Y
     C                     ADD  1972      @@Z71Y
     C*
     C* CHECKING IF YEAR IS GREATER THAN OR EQUAL TO 2100
     C*
     C           @@Z71Y    IFGE 2100                       B1
     C                     ADD  @@SSY2    @@RDAY           *1
     C                     END                             E1
     C*
     C* LOKUP ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE
     C* HAVE PASSED.
     C*
     C           @@RDAY    LOKUP@YD,@@I                8080
     C*
     C* IF YEAR IS A LEAP YEAR SSLEAP IS SET TO ZERO.
     C*
     C           *IN80     IFEQ '0'                        B1
     C                     Z-ADD0         @@LEAP           *1
     C                     END                             E1
     C*
     C* ADD INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.
     C*
     C           @@LEAP    IFEQ 1                          B1
     C           @@RDAY    SUB  @YD,@@I   @@RDAY           *1
     C                     ADD  @@I       @@Z71Y           *1
     C                     END                             E1
     C*
     C* PROCESSING FOR A LEAP YEAR.
     C*
     C           @@LEAP    IFEQ 0                          B1
     C*
     C* IF '@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.
     C*
     C           @@RDAY    IFEQ 60                         B*2
     C                     Z-ADD29        @@Z71D           **2
     C                     Z-ADD2         @@Z71M           **2
     C                     GOTO ZA0711                     **2
     C                     END                             E*2
     C*
     C* IF '@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN
     C* PROCEED AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP
     C* YEAR. NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.
     C*
     C           @@RDAY    IFGT 60                         B*2
     C           @@RDAY    SUB  1         @@RDAY           **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C* IF DAY '@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS
     C* IN 4 YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR
     C* GROUP.
     C*
     C           @@RDAY    IFEQ 0                          B1
     C                     Z-ADD31        @@Z71D           *1
     C                     Z-ADD12        @@Z71M           *1
     C                     SUB  1         @@Z71Y           *1
     C                     GOTO ZA0711                     *1
     C                     END                             E1
     C*
     C* LOOK UP ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'
     C* OCCURS IN
     C*
     C           @@RDAY    LOKUP@MD,@@J                81
     C                     Z-ADD@@J       @@Z71M
     C           @@RDAY    SUB  @MD,@@J   @@Z71D
     C*
     C* DS @@VDT  IS RETURNED IN YYYYMMDD FORMAT
     C*
     C           ZA0711    TAG
     C*
     C                     MOVE @@Z71Y    @@YR
     C*
     C           ZA0719    ENDSR
     C*****************************************************************
     C/EJECT
     C********************************************************************S01195
     C******                                                              S01195
     C**ZA0830 - THIS SUBROUTINE FINDS OUT WHETHER A PARTICULAR DAY       S01195
     C******     IS A HOLIDAY IN A PARTICULAR CURRENCY                    S01195
     C******                                                              S01195
     C**CALLED BY :                                                       S01195
     C******                                                              S01195
     C**CALLS :                                                           S01195
     C******                                                              S01195
     C**INPUT  : @@MNO  MIDAS DAY NUMBER 5N                               S01195
     C******     @@CCY  CURRENCY CODE 3A                                  S01195
     C******                                                              S01195
     C**OUTPUT : @@HIND HOLIDAY/WORKING DAY INDICATOR 1A                  S01195
     C******                                                              S01195
     C**USES :   @@MNO  MIDAS DAY NUMBER                                  S01195
     C******     @@CCY  CURRENCY CODE                                     S01195
     C******     @@ONCE FIRST TIME THROUGH INDICATOR                      S01195
     C******     @@CY1  FIRST HALF OF CURRENCY ARRAY                      S01195
     C******     @@CY2  SECOND HALF OF CURRENCY ARRAY                     S01195
     C******     @@MNO6 MIDAS NUMBER WITH TRAILING BLANK                  S01195
     C******     @@HIND HOLIDAY/WORKING DAY INDICATOR                     S01195
     C******     @@INEX INCLUDE/EXCLUDE INDICATOR                         S01195
     C******                                                              S01195
     C******     INDICATORS                                               S01195
     C******     80 RECORD NOT FOUND                                      S01195
     C******     81 CURRENCY NOT FOUND ON RECORD                          S01195
     C******                                                              S01195
     C********************************************************************S01195
     C******     ZA0830    BEGSR                                          S01195
     C******                                                              S01195
     C***OPEN CURRENCY/HOLIDAY FILE IF FIRST TIME THROUGH                 S01195
     C******     @@ONCE    IFNE 'Y'                        B1             S01195
     C*****                OPEN FDTABJLL                   *1             S01195
     C*****                MOVE 'Y'       @@ONCE  1        *1             S01195
     C*****                END                             E1             S01195
     C*****                                                               S01195
     C***BLANK OUT ARRAY                                                  S01195
     C*****                MOVE *BLANKS   @@CY1                           S01195
     C*****                MOVE *BLANKS   @@CY2                           S01195
     C*****                                                               S01195
     C***ACCESS TABLE ON FIRST KEY                                        S01195
     C*****                MOVEL@@MNO     @@MNO6  6                       S01195
     C*****                MOVE @@MNO6    SS0830 12                       S01195
     C*****                MOVEL'22    '  SS0830                          S01195
     C*****                MOVE '1'       SS0830                          S01195
     C*****      SS0830    CHAINTABLETJF             8080                 S01195
     C*****                                                               S01195
     C***IF RECORD NOT FOUND OR DELETED                                   S01195
     C*****      *IN80     IFEQ '1'                        B1             S01195
     C*****      RECI      OREQ '*'                        *1             S01195
     C*****                MOVE 'W'       @@HIND           *1             S01195
     C*****                GOTO ZA0839                     *1             S01195
     C*****                END                             E1             S01195
     C*****                                                               S01195
     C***MOVE FIRST 25 CURRENCIES TO ARRAY                                S01195
     C*****                MOVE HCCY      @@CY1                           S01195
     C*****                                                               S01195
     C***ACCESS TABLE ON SECOND KEY                                       S01195
     C*****                MOVE '2'       SS0830                          S01195
     C*****      SS0830    CHAINTABLETJF             8080                 S01195
     C*****                                                               S01195
     C***IF SECOND RECORD FOUND AND NOT DELETED                           S01195
     C*****      *IN80     IFEQ '0'                        B1             S01195
     C*****      RECI      ANDNE'*'                        *1             S01195
     C*****                MOVE HCCY      @@CY2            *1             S01195
     C*****                END                             E1             S01195
     C*****                                                               S01195
     C***SEARCH ARRAY FOR INPUT CURRENCY                                  S01195
     C*****      @@CCY     LOKUP@CY                      81               S01195
     C*****                                                               S01195
     C***IF INPUT CURRENCY IS IN ARRAY                                    S01195
     C*****      *IN81     IFEQ '1'                        B1             S01195
     C*****                                                               S01195
     C***IF INCLUDE/EXCLUDE INDICATOR EQ 'E'                              S01195
     C*****      INEX      IFEQ 'E'                        B*2            S01195
     C*****                MOVE 'W'       @@HIND  1        **2            S01195
     C*****                ELSE                            X*2            S01195
     C*****                MOVE 'H'       @@HIND           **2            S01195
     C*****                END                             E*2            S01195
     C*****                END                             E1             S01195
     C*****                                                               S01195
     C***IF INPUT CURRENCY IS NOT IN ARRAY                                S01195
     C*****      *IN81     IFEQ '0'                        B1             S01195
     C*****                                                               S01195
     C***IF INCLUDE/EXCLUDE INDICATOR EQ 'I'                              S01195
     C*****      INEX      IFEQ 'I'                        B*2            S01195
     C*****                MOVE 'W'       @@HIND           **2            S01195
     C*****                ELSE                            X*2            S01195
     C*****                MOVE 'H'       @@HIND           **2            S01195
     C*****                END                             E*2            S01195
     C*****                END                             E1             S01195
     C*****      ZA0839    ENDSR                                          S01195
     C*****************************************************************   S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
      /EJECT                                                              S01195
     C/COPY ZSRSRC,ZCHKH                                                  S01195
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE:  #A  - Initial processing; initialisation and    *
     C*                     retrieval of ICD and user data.           *
     C*                                                               *
     C*  FIELDS USED:         @ACTN  - program work field holding     *
     C*                                action code                    *
     C*                                                               *
     C*  CALLED BY :  MAIN PROGRAM                                    *
     C***CALLS*****:**ZA0150**                                        *   S01194
     C*  CALLS     :  #D                                              *   S01194
     C*                                                               *
     C*****************************************************************
     C*
     C           #A        BEGSR
     C*
     C                     MOVEACPY@      BIS@   80
     C*
     C**  Define program work fields with reference to file fields.
     C*
     C           *LIKE     DEFN RECI      @RECIB
     C           *LIKE     DEFN RECI      @RELRI
     C           *LIKE     DEFN DTYP      @RELDT
     C           *LIKE     DEFN DSTI      @RELBC
     C           *LIKE     DEFN PUAM      @RELBA
     C           *LIKE     DEFN SLAM      @RELSA
     C           *LIKE     DEFN PUAM      @CURPA
     C           *LIKE     DEFN SLAM      @CURSA
     C           *LIKE     DEFN PUCY      @RECUR
     C           *LIKE     DEFN PUCY      @@INCY
     C           *LIKE     DEFN PUCY      @SECUR                          CEU003
     C           *LIKE     DEFN CNFI      @XCREQ
     C           *LIKE     DEFN CNFI      @XCNFI
     C*****      *LIKE     DEFN TNOT      @@FWD                           S01194
     C*****      *LIKE     DEFN RUND      @CMPDT                          S01194
     C*****      *LIKE     DEFN RUND      @CONDT                          S01194
     C           *LIKE     DEFN A6TXND    @@FWD                           S01194
     C           *LIKE     DEFN BJRDNB    @CMPDT                          S01194
     C           *LIKE     DEFN BJRDNB    @CONDT                          S01194
     C           *LIKE     DEFN F3MORI    @XMORI
     C           *LIKE     DEFN F3MOPI    @XMOPI
     C           *LIKE     DEFN F3ROBR    @XROBR                          S01117
     C           *LIKE     DEFN F3POBR    @XPOBR                          S01117
     C*
     C**                                                              *
     C***   Initialise Data Structure Fields
     C**
     C                     Z-ADD*ZERO     RRLX
     C                     Z-ADD*ZERO     RRXP
     C                     Z-ADD*ZERO     NDLR
     C                     Z-ADD*ZERO     NDAR
     C                     Z-ADD*ZERO     STPI
     C****                 Z-ADD*ZERO     RRNL                            S01136
     C                     Z-ADD*ZERO     TIM                             S01136
     C                     Z-ADD*ZERO     PRI1
     C                     Z-ADD*ZERO     PRI2
     C                     Z-ADD*ZERO     PRI3
     C*                                                               *
     C**    Avoid Compile Errors on unreferenced FXP0217 arrays
     C*                                                               *
     C                     MOVEL@DOM,1    @X1     1                   *
     C                     MOVEL@MOM,1    @X1                         *
     C*                                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           @TERM     IFEQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     ELSE                            X1
     C*****                                                               S01194
     C****Open*all*files*not*already*open***                              S01194
     C*****                                                               S01194
     C*****                OPEN FXTB40LL                   *1             S01194
     C*****                                                               S01194
     C*****                OPEN FDICDRLL                   *1             S01194
     C*****                                                               S01194
     C*****                OPEN FDCCYTLL                   *1             S01194
     C*****                                                               S01194
     C*
     C           @DTOPN    IFEQ ' '                        B*2
     C                     OPEN SDTIX                      **2
     C                     END                             E*2
     C*
     C           @MAOPN    IFEQ ' '                        B*2
     C                     OPEN FXMIDBLL                   **2
     C                     END                             E*2
     C*
     C**  E19728 - Addition of FXDEALLL                                   E19728
     C*                                                                   E19728
     C           @DLOPN    IFEQ ' '                        B*2            E19728
     C                     OPEN FXDEALLL                   **2            E19728
     C                     END                             E*2            E19728
     C*                                                                   E19728
     C                     MOVE 'Y'       @FCYC   1        *1
     C*
     C****Call*subroutine*t**access ICD file for MIDAS run date.          S01194
     C*****                                                               S01194
     C*****                EXSR ZA0150                     *1             S01194
     C**  Call subr. to access Bank Details file for Run Day Number.      S01194
     C                     EXSR #D                         *1             S01194
     C*
     C****Access*TABTB11*record*from*ICD*file*for*Local*Currency.***      S01194
     C*****                                                               S01194
     C*****      *IN80     IFEQ '1'                        B*2            S01194
     C*****                MOVEL'TABTB10 'DBFILE           **2            S01194
     C*****                ELSE                            X*2            S01194
     C*****                MOVE '11'      SS0150           **2            S01194
     C*****      SS0150    CHAINFDICDRLL             8080  **2            S01194
     C*****      *IN80     IFEQ '0'                        B**3           S01194
     C*****      RECI      ANDNE'D'                        ***3           S01194
     C*****                MOVE '1'       *IN80            ***3           S01194
     C*****                END                             E**3           S01194
     C*****      *IN80     IFEQ '1'                        B**3           S01194
     C*****                MOVEL'TABTB11 'DBFILE           ***3           S01194
     C*****                END                             E**3           S01194
     C*****                END                             E*2            S01194
     C*
     C**  Check for data base error.
     C           *IN80     IFEQ '1'                        B*2
     C                     MOVE '003'     DBASE            **2       ********
     C                     MOVE *BLANKS   DBKEY            **2        ERROR *
     C                     MOVE '1'       *INU7            **2       003    *
     C                     MOVE '1'       *INU8            **2              *
     C                     MOVE '1'       *IN63            **2       ********
     C*
     C                     GOTO #A9                        **2
     C                     END                             E*2
     C*
     C****Read*the*TABTB40*record********                                 S01194
     C*****                                                               S01194
     C********   1         CHAINFXTB40LL             6464  *1       E12189S01194
     C*****      *LOVAL    SETLLFXTB40LL                            E12189S01194
     C*****                READ FXTB40LL               6464         E12189S01194
     C*****      *IN64     IFEQ '1'                        B*2            S01194
     C*****                MOVE '004'     DBASE            **2       *****S01194
     C*****                MOVEL'TABTB40 'DBFILE           **2            S01194
     C*****                MOVE *BLANKS   DBKEY            **2       ERRORS01194
     C*****                MOVE '1'       *INU7            **2       04   S01194
     C*****                MOVE '1'       *INU8            **2            S01194
     C*****                GOTO #A9                        **2       *****S01194
     C*****                END                             E*2            S01194
     C*                                                                   S01194
     C*  USE ACCESS PROGRAM TO READ TRADING DATA FILE                     S01194
     C                     CALL 'AOTRADR0'                                S01194
     C                     PARM '*MSG    '@RTCD                           S01194
     C                     PARM '*FIRST  '@OPTN                           S01194
     C           @TRAD     PARM @TRAD     DSFDY                           S01194
     C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVEL'SDTRADPD'DBFILE           *************  S01194
     C                     MOVEL'020'     DBASE            * DBERR 020 *  S01194
     C                     MOVEL@OPTN     DBOPTN           *************  S01194
     C                     MOVE '1'       *INU7                           S01194
     C                     MOVE '1'       *INU8                           S01194
     C                     MOVE '1'       *IN64                           S01194
     C                     EXSR *PSSR                                     S01194
     C                     GOTO #A9                                       S01194
     C                     END                                            S01194
     C*                                                                   S01194
     C*  USE ACCESS PROGRAM TO READ DEAL DATA CODES FILE                  S01194
     C**********           CALL 'AODEALR0'                                S01194              CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM '*MSG    '@RTCD                           S01194
     C                     PARM '*FIRST  '@OPTN                           S01194
     C********** @DEAL     PARM @DEAL     DSFDY                           S01194              CGL029
     C           @DEAL     PARM @DEAL     DSSDY                                               CGL029
     C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVEL'SDDEALPD'DBFILE           *************  S01194
     C                     MOVEL'021'     DBASE            * DBERR 021 *  S01194
     C                     MOVEL@OPTN     DBOPTN           *************  S01194
     C                     MOVE '1'       *INU7                           S01194
     C                     MOVE '1'       *INU8                           S01194
     C                     MOVE '1'       *IN64                           S01194
     C                     EXSR *PSSR                                     S01194
     C                     GOTO #A9                                       S01194
     C                     END                                            S01194
     C*                                                                   S01408
     C/COPY WNCPYSRC,FX0380CCP6                                           S01408
     C*                                                                   S01408
      *                                                                   CEU003
      ** Check if CEU003 is switched *ON.                                 CEU003
      *                                                                   CEU003
     C                     CALL 'AOSARDR0'                                CEU003
     C                     PARM *BLANKS   @RTCD                           CEU003
     C                     PARM '*VERIFY' @OPTN                           CEU003
     C                     PARM 'CEU003'  @SARD   6                       CEU003
     C           SCSARD    PARM SCSARD    DSFDY                           CEU003
      *                                                                   CEU003
     C           @RTCD     IFNE *BLANKS                                   CEU003
     C                     MOVE 'N'       CEU003  1                       CEU003
     C                     ELSE                                           CEU003
      *                                                                   CEU003
     C                     MOVE 'Y'       CEU003                          CEU003
     C                     END                                            CEU003
      *                                                                   CDL008
      ** Determine if SAR Continuous Linked Settlement enhancement is     CDL008
      ** installed.                                                       CDL008
      *                                                                   CDL008
     C                     CALL 'AOSARDR0'                                CDL008
     C                     PARM *BLANKS   @RTCD                           CDL008
     C                     PARM '*VERIFY '@OPTN                           CDL008
     C                     PARM 'CDL008'  @SARD                           CDL008
     C           SCSARD    PARM SCSARD    DSFDY                           CDL008
      *                                                                   CDL008
     C           @RTCD     IFNE *BLANKS                                   CDL008
     C           @RTCD     ANDNE'*NRF   '                                 CDL008
     C                     MOVE *ON       *INU7                           CDL008
     C                     MOVE *ON       *INU8                           CDL008
     C                     MOVEL'SCSARDPD'DBFILE                          CDL008
     C                     MOVEL'994'     DBASE                           CDL008
     C                     MOVEL'CDL008'  DBKEY                           CDL008
     C                     EXSR *PSSR                                     CDL008
     C                     GOTO #A9                                       CDL008
     C                     ENDIF                                          CDL008
      *                                                                   CDL008
     C           @RTCD     IFEQ *BLANKS                                   CDL008
     C                     MOVE 'Y'       CDL008  1                       CDL008
     C                     ELSE                                           CDL008
     C                     MOVE 'N'       CDL008                          CDL008
     C                     ENDIF                                          CDL008
      *                                                                   CEU003
      ** Access General Ledger ICD file to get Euro curr. code.           CEU003
      *                                                                   CEU003
     C**********           CALL 'AOGELRR0'                                CEU003              CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD                           CEU003
     C                     PARM '*FIRST ' @OPTN                           CEU003
     C********** @GELR     PARM @GELR     DSFDY                           CEU003              CGL029
     C           @GELR     PARM @GELR     DSSDY                                               CGL029
      *                                                                   CEU003
     C           @RTCD     IFNE *BLANKS                                   CEU003
     C           @RTCD     ANDNE'*NRF   '                                 CEU003
     C                     MOVEL'*FIRST'  DBKEY            ***************CEU003
     C                     MOVEL'SDGELRPD'DBFILE           * DBERROR 052 *CEU003
     C                     MOVEL'052'     DBASE            ***************CEU003
     C                     MOVE '1'       *INU7                           CEU003
     C                     MOVE '1'       *INU8                           CEU003
     C                     EXSR *PSSR                                     CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CAC001
      ** Call access program for Midas modules details                    CAC001
      *                                                                   CAC001
     C                     CALL 'AOMMODR0'                                CAC001
     C                     PARM *BLANKS   @RTCD                           CAC001
     C                     PARM '*FIRST  '@OPTN                           CAC001
     C           SDMMOD    PARM SDMMOD    DSFDY                           CAC001
     C*                                                                   CAC001
     C           @RTCD     IFNE *BLANK                                    CAC001
     C                     MOVEL'SDMMODPD'DBFILE           *************  CAC001
     C                     MOVEL'022'     DBASE            * DBERR 022 *  CAC001
     C                     MOVEL@OPTN     DBOPTN           *************  CAC001
     C                     MOVE '1'       *INU7                           CAC001
     C                     MOVE '1'       *INU8                           CAC001
     C                     MOVE '1'       *IN64                           CAC001
     C                     EXSR *PSSR                                     CAC001
     C                     GOTO #A9                                       CAC001
     C                     END                                            CAC001
     C*                                                                   S01194
     C                     END                             E1
     C*
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,FX0380CCP4                                           S01408
     C*                                                                   S01408
     C           #A9       ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: #C     - Terminates program.                     *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*  CALLED BY : Main processing                                  *
     C*  CALLS     :                                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           #C        BEGSR
     C*
     C/COPY WNCPYSRC,FX0380C014
     C**  Inform Calling Program of Database Error
     C**  Move program name into *LDA field.
     C**
     C*
     C           *INU7     IFEQ '1'                        B1
     C                     MOVEL'FX0380'  DBPGM            *1
     C                     MOVE '1'       *INLR            *1
     C                     MOVE 'E'       @TERM            *1
     C                     DUMP                            *1             E21042
     C                     END                             E1
     C*
     C                     RETRN
     C*
     C           #C9       ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: *INFSR -- File Error handling subroutine.        *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*  CALLED BY : This routine is called if there are any          *
     C*              errors on add-to files.                          *
     C*  CALLS :                                                      *
     C*                                                               *
     C*****************************************************************
     C*
     C           INFSR     BEGSR
     C*
     C** SET @ERR2 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR2     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR2   1        *1
     C                     MOVE '1'       *INU7            *1
     C                     MOVE '1'       *INU8            *1
     C** TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR            *1
     C                     MOVE 'E'       @TERM            *1
     C*
     C** SET UP FIELDS IN LOCAL DATA AREA
     C                     MOVE @FILE     DBFILE           *1
     C                     MOVEL'FX0380'  DBPGM            *1
     C                     MOVE '992'     DBASE            *1
     C*
     C                     DUMP                            *1
     C                     END                             E1
     C*
     C*
     C           @STDT     IFEQ 01021                      B1
     C*       Error on add-to DTRIXDD                      *1
     C                     ELSE                            X1
     C           @STEA     IFEQ 01021                      B*2
     C*       Error on add-to DEALSDB                      **2
     C                     ELSE                            X*2
     C                     MOVE '*CANCL'  EXTTAG  6        **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C                     RETRN
     C*
     C           INFSR9    ENDSREXTTAG                               *
     C*
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE: *PSSR - Error handling subroutine.               *
     C*                                                               *
     C*  FIELDS USED:                                                 *
     C*                                                               *
     C*  CALLED BY : This routine is called if there are any program  *
     C*              or file errors.                                  *
     C*  CALLS :                                                      *
     C*                                                               *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C**  SET @ERR1 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR1     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR1   1        *1
     C*
     C                     MOVEL'FX0380'  DBPGM            *1
     C                     MOVE '1'       *INU6            *1
     C           DBASE     IFEQ *BLANKS                                   E26614
     C                     MOVE '991'     DBASE            *1
     C                     END                                            E26614
     C*
     C                     DUMP                            *1
     C                     MOVE 'E'       @TERM            *1
     C                     END                             E1
     C*
     C                     MOVE '1'       *INLR
     C*
     C                     RETRN
     C*
     C           #PSSR9    ENDSR                                     *
     C*
     C*****************************************************************
      /EJECT
** @YD  USED BY SR. ZA0680 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZA0680 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
** Pay/Receive Methods in ascending sequence
CCOLL12
CHIPS07
COMP 03
CSENT02
CURR 14
MACC 05
NA   00
PCURR04
SUSP 06
SWIFT08
TELX 01
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
