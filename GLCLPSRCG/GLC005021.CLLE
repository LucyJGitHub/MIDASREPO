/*********************************************************************/
/*STD    CLPBASEBND                                                  */
/*EXI    TEXT('Midas GL EOD Monitor job')                            */
/*********************************************************************/
/*                                                                   */
/*       Midas - General Ledger Module                               */
/*                                                                   */
/*       GLC005021 - EOD Monitor                                     */
/*                                                                   */
/*       (c) Finastra International Limited 2004                     */
/*                                                                   */
/*       Last Amend No. MD046248           Date 27Oct17              */
/*       Prev Amend No. AR1057854          Date 19Nov12              */
/*                      AR1015290          Date 20Oct12              */
/*                      AR918665           Date 20Oct12              */
/*                      CSC043             Date 18Jun10              */
/*                      BUG27747A          Date 25Jun10              */
/*                      BUG27747           Date 22Jun10              */
/* Bank Fusion Midas 1.4 Base ---------------------------------------*/
/* Midas Plus 1.4 Base 04 -------------------------------------------*/
/* Midas Plus 1.4 Base ----------------------------------------------*/
/* Midas Plus 1.3 ---------------- Base -----------------------------*/
/*                      CLE040  *CREATE    Date 05Jul04              */
/*                                                                   */
/*********************************************************************/
/*                                                                   */
/*       MD046248 - Finastra Rebranding                              */
/*       AR1057854 - Geneva Drop 01 Build Issues - RPG Program       */
/*                   Compilation Error                               */
/*       AR1015290 - Classpath cannot be set using a wildcard.       */
/*                Retrieved Jar list from SDJARFPD.                  */
/*                (Child: AR1015291)                                 */
/*       AR918665 - Unable to start the calculator jobs              */
/*       CSC043 - MidasPlus IASP Enablement                          */
/*       BUG27747 - Error in CALCMGR_zz and LTVMNTR_zz (Reopen)      */
/*       BUG27747 - Error in CALCMGR_zz and LTVMNTR_zz               */
/*       CLE040 - Collateralised Lending Phase 2                     */
/*                                                                   */
/*********************************************************************/
             PGM        PARM(&PREFIX)
 
             DCL        VAR(&PREFIX) TYPE(*CHAR) LEN(2)
             DCL        VAR(&JAVAPATH) TYPE(*CHAR) LEN(200)
             DCL        VAR(&JOBNAME) TYPE(*CHAR) LEN(10)
             DCL        VAR(&JOBUSER) TYPE(*CHAR) LEN(10)
             DCL        VAR(&JOBNBR) TYPE(*CHAR) LEN(6)
             DCL        VAR(&GLEODMON) TYPE(*CHAR) LEN(200)
             DCL        VAR(&RTNCDE) TYPE(*CHAR) LEN(7)
             DCL        VAR(&SVALK2) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL2) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK3) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL3) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK4) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL4) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK5) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL5) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK6) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL6) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK7) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL7) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK8) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL8) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK9) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL9) TYPE(*CHAR) LEN(200)
             DCL        VAR(&SVALK0) TYPE(*CHAR) LEN(20)
             DCL        VAR(&SVAL10) TYPE(*CHAR) LEN(200)
             DCL        VAR(&EXECUTE) TYPE(*CHAR) LEN(5000)
             DCL        VAR(&ABNOR) TYPE(*CHAR) LEN(1) VALUE('Y')
             DCL        VAR(&CLASSPATH) TYPE(*CHAR) LEN(5000)
             DCL        VAR(&COMMAND) TYPE(*CHAR) LEN(100)
             DCL        VAR(&LSCOMMAND) TYPE(*CHAR) LEN(100)
             DCL        VAR(&GPLIB) TYPE(*CHAR) LEN(100)
             DCL        VAR(&LNKNAME) TYPE(*CHAR) LEN(10)
             DCL        VAR(&JAVA_HOME) TYPE(*CHAR) LEN(1024)                           /*BUG27747*/
             DCL        VAR(&IASP_YN) TYPE(*CHAR) LEN(1)                                  /*CSC043*/
             DCL        VAR(&IASP) TYPE(*CHAR) LEN(18)                                    /*CSC043*/
             DCL        VAR(&LIBEXT) TYPE(*CHAR) LEN(200)                              /*AR1015290*/
/*/COPY GPCPYSRCG,GPSVALDCL  */                                                           /*CSC043*/
/**********  DCLF       FILE(GLEODMPD) */                                               /*AR918665*/
             DCLF       FILE(GPSDJARFPD)                                               /*AR1015290*/
 
             COPYRIGHT TEXT('(c) Finastra International Limited +
                          Ltd. 2004')
 
/* Global monitor message */
 
             MONMSG     MSGID(CPF0000 MCH0000 RPG0000) EXEC(GOTO +
                          CMDLBL(ABNOR))
 
             OVRPRTF FILE(QPRINT) MAXRCDS(999999) OVRSCOPE(*JOB)
/*                                                                                        /*CSC043*/
/** Get the global IASP system values */                                                  /*CSC043*/
/*                                                                                        /*CSC043*/
             CALL       PGM(GPAOSVALR0) PARM(&RSVALRTNC +
                          'IASPinstallation' &SVAL1 'IASPdatabase' +
                          &SVAL2 &SVALK3 &SVAL3 &SVALK4 &SVAL4 +
                          &SVALK5 &SVAL5 &SVALK6 &SVAL6 &SVALK7 +
                          &SVAL7 &SVALK8 &SVAL8 &SVALK9 &SVAL9 +
                          &SVALK10 &SVAL10)                                               /*CSC043*/
/*                                                                                        /*CSC043*/
/** Check whether system is in IASP environment. */                                       /*CSC043*/
/*                                                                                        /*CSC043*/
              CHGVAR     VAR(&IASP_YN) VALUE(%SST(&SVAL1 1 1))                            /*CSC043*/
/*                                                                                        /*CSC043*/
/** If IASP environment */                                                                /*CSC043*/
/*                                                                                        /*CSC043*/
             IF         COND(&IASP_YN *EQ 'Y') THEN(DO)                                   /*CSC043*/
/*                                                                                        /*CSC043*/
/** Get name of database. */                                                              /*CSC043*/
/*                                                                                        /*CSC043*/
              CHGVAR     VAR(&IASP) VALUE(%SST(&SVAL2 1 18))                              /*CSC043*/
                                                                                          /*CSC043*/
             ENDDO                                                                        /*CSC043*/
                                                                                          /*CSC043*/
 
/* Check if the EODMONITOR job is running */
 
             ALCOBJ     OBJ((GLEODMNLCK *DTAARA *EXCL)) WAIT(0)
             MONMSG     MSGID(CPF1002) EXEC(GOTO CMDLBL(ENDPGM))
 
/* Log job details */
 
             RTVJOBA    JOB(&JOBNAME) USER(&JOBUSER) NBR(&JOBNBR)
 
/* Log the EODMONITOR job details */
 
             CHGVAR     VAR(&GLEODMON) VALUE(&JOBNAME *CAT &JOBUSER +
                          *CAT &JOBNBR)
             CHGDTAARA  DTAARA(GLEODMON (1 26)) VALUE(&GLEODMON)
 
/* Get 'GlobalJavaPath' system value from file GPSVALPD  */
 
/**********  CALL       PGM(GPAOSVALR0) PARM(&RTNCDE +               */                /*BUG27747A*/
/**********               'GlobalJavaPathStem' &JAVAPATH &SVALK2 +   */                /*BUG27747A*/
/**********               &SVAL2 &SVALK3 &SVAL3 &SVALK4 &SVAL4 +     */                /*BUG27747A*/
/**********               &SVALK5 &SVAL5 &SVALK6 &SVAL6 &SVALK7 +    */                /*BUG27747A*/
/**********               &SVAL7 &SVALK8 &SVAL8 &SVALK9 &SVAL9 +     */                /*BUG27747A*/
/**********               &SVALK0 &SVAL10)                           */                /*BUG27747A*/
 
/**/                                                                                   /*BUG27747A*/
/*  Get 'GlobalJavaPathStem' and 'GlobalJavaHome'     */                               /*BUG27747A*/
/*  system values from file GPSVALPD                  */                               /*BUG27747A*/
/**/                                                                                   /*BUG27747A*/
             CALL       PGM(GPAOSVALR0) PARM(&RTNCDE +
                          'GlobalJavaPathStem' &JAVAPATH +
                          'GlobalJavaHome' &JAVA_HOME &SVALK3 +
                          &SVAL3 &SVALK4 &SVAL4 &SVALK5 &SVAL5 +
                          &SVALK6 &SVAL6 &SVALK7 &SVAL7 &SVALK8 +
                          &SVAL8 &SVALK9 &SVAL9 &SVALK0 &SVAL10)                       /*BUG27747A*/
                                                                                       /*BUG27747A*/
/* If the 'GlobalJavaPathStem' system value is missing then end abnormally */
 
             IF         COND(%SST(&JAVAPATH 1 4) *EQ '*NRF') THEN(GOTO +
                          CMDLBL(ABNOR))
 
/* Get 'GlobalJavaHome' system value from file GPSVALPD  */                             /*BUG27747*/
                                                                                        /*BUG27747*/
/**********  CALL       PGM(GPAOSVALR0) PARM(&RTNCDE +               */                /*BUG27747A*/
/**********               'GlobalJavaHome' &JAVA_HOME &SVALK2 +      */                /*BUG27747A*/
/**********               &SVAL2 &SVALK3 &SVAL3 &SVALK4 &SVAL4 +     */                /*BUG27747A*/
/**********               &SVALK5 &SVAL5 &SVALK6 &SVAL6 &SVALK7 +    */                /*BUG27747A*/
/**********               &SVAL7 &SVALK8 &SVAL8 &SVALK9 &SVAL9 +     */                /*BUG27747A*/
/**********               &SVALK0 &SVAL10)                           */       /*BUG27747 BUG27747A*/
                                                                                        /*BUG27747*/
/* If the 'GlobalJavaHome' system value is missing then end abnormally */               /*BUG27747*/
                                                                                        /*BUG27747*/
             IF         COND(%SST(&JAVA_HOME 1 4) *EQ '*NRF') THEN(GOTO +
                          CMDLBL(ABNOR))                                                /*BUG27747*/
                                                                                        /*BUG27747*/
             RMVLNK     OBJLNK(A)                                                      /*AR1015290*/
             MONMSG     MSGID(CPFA0A9)                                                 /*AR1015290*/
                                                                                       /*AR1015290*/
             RMVLNK     OBJLNK(B)                                                      /*AR1015290*/
             MONMSG     MSGID(CPFA0A9)                                                 /*AR1015290*/
                                                                                       /*AR1015290*/
             ADDLNK     OBJ(&JAVAPATH) NEWLNK(A)                                       /*AR1015290*/
             MONMSG     MSGID(CPFA0A0)                                                 /*AR1015290*/
                                                                                       /*AR1015290*/
             CHGVAR     VAR(&LIBEXT) VALUE(&JAVAPATH *TCAT +
                          '/lib/ext')                                                  /*AR1015290*/
             ADDLNK     OBJ(&LIBEXT) NEWLNK(B)                                         /*AR1015290*/
             MONMSG     MSGID(CPFA0A0)                                                 /*AR1015290*/
                                                                                       /*AR1015290*/
/** Setup environment variable JAVA_HOME */                                             /*BUG27747*/
                                                                                        /*BUG27747*/
             RMVENVVAR  ENVVAR(JAVA_HOME)                                               /*BUG27747*/
             MONMSG     MSGID(CPFA981)                                                  /*BUG27747*/
                                                                                        /*BUG27747*/
             ADDENVVAR  ENVVAR(JAVA_HOME) VALUE(&JAVA_HOME)                             /*BUG27747*/
             MONMSG     MSGID(CPFA0A0)                                                  /*BUG27747*/
                                                                                        /*BUG27747*/
             ALCOBJ     OBJ((GLMLCLJLCK *DTAARA *EXCL)) WAIT(30)
             MONMSG     MSGID(CPF1002) EXEC(GOTO CMDLBL(ENDPGM))
             CHGVAR     VAR(&GPLIB) VALUE(&PREFIX *CAT 'GPLIB')
 
/**********  CHGVAR     VAR(&LNKNAME) VALUE('eod' *CAT 'EXT')                          /*AR1015290*/
             CHGVAR     VAR(&LNKNAME) VALUE('A')                                       /*AR1015290*/
/**********  RMVLNK     OBJLNK(&LNKNAME)                           */                  /*AR1015290*/
/**********  MONMSG     MSGID(CPF0000)                             */                  /*AR1015290*/
/**********  ADDLNK     OBJ(&JAVAPATH) NEWLNK(&LNKNAME)            */                  /*AR1015290*/
/**********  MONMSG     MSGID(CPFA0A0)                             */                  /*AR1015290*/
 
/**********  CLRPFM     FILE(&GPLIB/GLEODMPD)                      */                  /*AR1015290*/
/**********  MONMSG     MSGID(CPF0000)                             */                  /*AR1015290*/
 
/*                                                                                        /*CSC043*/
/** If IASP environment */                                                                /*CSC043*/
/*                                                                                        /*CSC043*/
/**********  IF         COND(&IASP_YN *EQ 'Y') THEN(DO)            */           /*CSC043 AR1015290*/
/**********  CHGVAR     VAR(&LSCOMMAND) VALUE('LS ' *CAT &JAVAPATH +
                          *TCAT '/lib/ext/ > /' *CAT &IASP *TCAT +
                          '/QSYS.LIB/' *TCAT &GPLIB *TCAT +
                          '.LIB/GLEODMPD.FILE/GLEODMPD.MBR') */                 /*CSC043 AR1015290*/
/**********  ENDDO                                                 */           /*CSC043 AR1015290*/
/**********  ELSE       CMD(DO)                                    */           /*CSC043 AR1015290*/
/**********  CHGVAR     VAR(&LSCOMMAND) VALUE('LS ' *CAT &JAVAPATH +
                          *TCAT '/lib/ext/ > /QSYS.LIB/' *TCAT +
                          &GPLIB *TCAT +
                          '.LIB/GLEODMPD.FILE/GLEODMPD.MBR') */                        /*AR1015290*/
/**********  ENDDO                                                              /*CSC043 AR1057854*/
 
/**********  QSH        CMD(&LSCOMMAND)                            */                  /*AR1015290*/
 
/**********  CHGVAR     VAR(&CLASSPATH) VALUE(&JAVAPATH *TCAT ':') */                  /*AR1015290*/
/**********READNEXT: */                                                                 /*AR918665*/
/**********  RCVF    */                                                                 /*AR918665*/
/**********  MONMSG     MSGID(CPF0864) EXEC(GOTO CMDLBL(ENDFILE)) */                    /*AR918665*/
/**********  CHGVAR     VAR(&CLASSPATH) VALUE(&CLASSPATH *TCAT +
                          &LNKNAME *TCAT '/lib/ext/' *TCAT +
                          &GLEODMPD *TCAT ':')  */                                      /*AR918665*/
/**********  CHGVAR     VAR(&CLASSPATH) VALUE(&CLASSPATH *TCAT +
                          &LNKNAME *TCAT '/lib/ext/*:')                       /*AR918665 AR1015290*/
/**********  GOTO       CMDLBL(READNEXT) */                                             /*AR918665*/
/**********ENDFILE: */                                                                  /*AR918665*/
             DLCOBJ     OBJ((GLMLCLJLCK *DTAARA *EXCL))
 
             CHGVAR     VAR(&CLASSPATH) VALUE('A')                                     /*AR1015290*/
                                                                                       /*AR1015290*/
 SETUP_PATH: RCVF       RCDFMT(GPSDJARFD0)                                             /*AR1015290*/
                                                                                       /*AR1015290*/
             /* END OF FILE */                                                         /*AR1015290*/
             MONMSG     MSGID(CPF0864) EXEC(GOTO CMDLBL(END_PATH))                     /*AR1015290*/
                                                                                       /*AR1015290*/
             /* CONCATENATE JAVA PATH */                                               /*AR1015290*/
             CHGVAR     VAR(&CLASSPATH) VALUE(&CLASSPATH *TCAT ':' +
                          *TCAT &JFNAME)                                               /*AR1015290*/
                                                                                       /*AR1015290*/
             /* READ NEXT RECORD */                                                    /*AR1015290*/
             GOTO       CMDLBL(SETUP_PATH)                                             /*AR1015290*/
 END_PATH:                                                                             /*AR1015290*/
                                                                                       /*AR1015290*/
/* Build the QSH command string */
 
             CHGVAR     VAR(&CLASSPATH) VALUE(&LNKNAME *TCAT +
                          '/eodmonitor' *TCAT ':' *TCAT &CLASSPATH)
             CHGVAR     VAR(&COMMAND) VALUE(' com.misys.midas.+
                          midasplus.eod.EODMonitor')
 
             CHGVAR     VAR(&EXECUTE) VALUE('java -cp ' *CAT +
                          &CLASSPATH *TCAT &COMMAND)
 
/* Execute the QSH command string */
 
             QSH        CMD(&EXECUTE)
 
/* For a normal end set the abnormal termination indicator off */
 
             CHGVAR     VAR(&ABNOR) VALUE('N')
 
             GOTO       CMDLBL(ENDPGM)
 
 ABNOR:
             CHGJOB     SWS(XXXXXX11)
 
             SNDPGMMSG  MSGID(CPF9898) MSGF(QCPFMSG) MSGDTA('Program +
                          GLC005021 ended abnormally - see job +
                          log') TOMSGQ(GPOPERQ)
             MONMSG     MSGID(CPF0000 MCH0000)
 
 ENDPGM:
 
/* Only clear the job information for an abnormal end */
 
             IF         COND(&ABNOR *NE 'Y') THEN(DO)
                CHGDTAARA  DTAARA(GLEODMON (1 26)) VALUE(' ')
                MONMSG     MSGID(CPF0000)
             ENDDO
 
             ENDPGM
