     H        1   Y
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas GL Batch trans file task split copy records')    *
      *****************************************************************
      *                                                               *
      *  Midas - General Ledger Module                                *
      *                                                               *
      *  GL0262 - GL Batch Transaction File Task Split Copy records   *
      *                                                               *
      *  Function:  This program will copy a block of records from    *
      *             the old driver LF/GLJENHL2 to a member in the     *
      *             new driver PF/GLBATHPD.                           *
      *                                                               *
      *  Called By: GLC0262 - Batch Transaction File Split Task       *
      *                       Split Server.                           *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. MD036165           Date 25May16               *
      *  Prev Amend No. CGL127AM           Date 06Aug12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 09Nov01               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CAP032             Date 26Apr99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CCB003 *Create     Date 08Oct96               *
      *                                                               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD036165 - Forward journal entries did not reverse.          *
      *             GLC26 ignored the process because batch is empty. *
      *  CGL127AM - COB Restructure - GL Module Optimisation Phase 2  *
      *  CPK014 - Release 4 packaging:                                *
      *           - A default timestamp string is required for        *
      *             file GLJNHIPD write.                              *
      *  CAP032 - Conversion of Journal Batch Entry inputs into       *
      *           modular structure to use as APIs.  Recompiled       *
      *           due to changes to files.                            *
      *  CCB003 - COB Performance Enhancements - Task Split           *
      *           Copy records from old driver to new driver file.    *
      *                                                               *
      *****************************************************************
      *
     FGLJENHL2IF  E           K        DISK         KINFSR *PSSR
      *
     F***GLBATHPDUF**E                    DISK         KINFSR *PSSR A                       CGL127AM
     FGLBATHPDUF  E           K        DISK         KINFSR *PSSR A    UC                    CGL127AM
     F            GLBATHD0                          KRENAMEDRIVEF                           CGL127AM
     F                                              KCOMIT
      *
     FGLJNHIPDUF  E                    DISK         KINFSR *PSSR A
     F**********  @BRREMA                           KRENAMEINDEXF                           CGL127AM
     F            GLBATHD0                          KRENAMEINDEXF                           CGL127AM
     F                                              KCOMIT
     FGLVALPL2IF  E           K        DISK         KINFSR *PSSR      UC                    MD036165
      *
      *****************************************************************
      *                                                               *
      *  Function of indicators                                       *
      *  ----------------------                                       *
      *                                                               *
      *     50 - Indicator for dummy read of GLBATHPD                 *
      *     80 - CHAIN indicator for GLJNHIPD                         *
      *     81 - CHAIN indicator for GLJENHL2                         *
      *     83 - READE indicator for GLVALPL2                         *                     MD036165
      *                                                               *
      *  U7+U8 - Database error occurs                                *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *
     E                    CPY@    1   1 80
      ** Array containing Copyright statement
      *
     E**********          STAMP   1   1 26                                           CPK014 CGL127AM
      ***Array*containing*dummy*timestamp******************************              CPK014 CGL127AM
      *                                                                                       CPK014
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *
     IINDEXF
      ** Rename fields for GLJNHIPD format
     I              BRBTNB                          JNBTNB
     I              BRBCDA                          JNBCDA
     I**********    BRDPCD                          JNDPCD                                  CGL127AM
     I**********    BRWSID                          JNWSID                                  CGL127AM
     I**********    BRHICC                          JNHICC                                  CGL127AM
     I**********    BRHDCC                          JNHDCC                                  CGL127AM
     I**********    BRHINC                          JNHINC                                  CGL127AM
     I**********    BRHIIN                          JNHIIN                                  CGL127AM
     I**********    BRHDIN                          JNHDIN                                  CGL127AM
     I**********    BRHINI                          JNHINI                                  CGL127AM
     I**********    BRBTSF                          JNBTSF                                  CGL127AM
     I**********    BRBIUF                          JNBIUF                                  CGL127AM
     I**********    BRSHPI                          JNSHPI                                  CGL127AM
     I**********    BRRAPI                          JNRAPI                                  CGL127AM
     I**********    BRMBRB                          JNMBRB                                  CGL127AM
     I**********    BRRVVD                          JNRVVD                                  CGL127AM
     I**********    BRBDES                          JNBDES                                  CGL127AM
     I**********    BRSPTT                          JNSPTT                                  CGL127AM
     I**********    BRNIST                          JNNIST                                  CGL127AM
     I**********    BRSPRF                          JNSPRF                                  CGL127AM
     I**********    BRDCIN                          JNDCIN                                  CGL127AM
     I**********    BRIBCF                          JNIBCF                                  CGL127AM
     I**********    BRCUSF                          JNCUSF                                  CGL127AM
     I**********    BRCYCF                          JNCYCF                                  CGL127AM
     I**********    BRACCF                          JNACCF                                  CGL127AM
     I**********    BRACSF                          JNACSF                                  CGL127AM
     I**********    BRNNBF                          JNNNBF                                  CGL127AM
     I**********    BRRACF                          JNRACF                                  CGL127AM
     I**********    BRPRCF                          JNPRCF                                  CGL127AM
     I**********    BRAMTF                          JNAMTF                                  CGL127AM
     I**********    BRIBCT                          JNIBCT                                  CGL127AM
     I**********    BRCYCT                          JNCYCT                                  CGL127AM
     I**********    BRCNAT                          JNCNAT                                  CGL127AM
     I**********    BRACCT                          JNACCT                                  CGL127AM
     I**********    BRASNT                          JNASNT                                  CGL127AM
     I**********    BRNNBT                          JNNNBT                                  CGL127AM
     I**********    BRRACT                          JNRACT                                  CGL127AM
     I**********    BRTOJE                          JNTOJE                                  CGL127AM
     I**********    BRTMST                          JNTMST                           CPK014 CGL127AM
      *
     ILDA       E DSLDA                         256
      ** Local data area for database error details
      *
     IPSDS       SDS
      ** Program Status Data Structure
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
     IDSFDY     E DSDSFDY                                                                   MD036165
      ** FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                                 MD036165
      *                                                                                     MD036165
     ISDBANK    E DSSDBANKPD                                                                MD036165
      ** EXTERNAL DATA STRUCTURES FOR BANK DETAILS                                          MD036165
      *
      *****************************************************************
      /EJECT
      *****************************************************************
     C           *ENTRY    PLIST
     C                     PARM           RECTOT  70
     C                     PARM           RTCODE  3
      *
     C                     OPEN GLBATHPD                                                    CGL127AM
      *                                                                                     CGL127AM
      ** Initial processing
     C           @FIRST    IFEQ ' '                                                         CGL127AM
     C                     EXSR INIT
     C                     MOVE 'Y'       @FIRST  1                                         CGL127AM
     C                     ENDIF                                                            CGL127AM
      *
      ** Split records into new file
     C                     EXSR TSPLIT
      *
      ** End processing
     C                     EXSR END
      *****************************************************************
      /EJECT
      *****************************************************************
      * TSPLIT - Split records into new driver and index files        *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           TSPLIT    BEGSR
      *                                                                                     MD036165
     C                     OPEN GLVALPL2                                                    MD036165
     C           BJRDNB    READEGLVALPL2            N    83                                 MD036165
     C                     CLOSEGLVALPL2                                                    MD036165
      *
     C                     Z-ADD0         TOT     70
      *
      ** Check the Index file and set the file pointer to the next
      ** driver record to be copied accordingly.
      *
     C           1         SETLLGLJNHIPD                 80                                 CGL127AM
     C                     READ GLJNHIPD                 80
      *
     C           *IN80     IFEQ '1'
     C           *LOVAL    SETLLGLJENHL2
     C                     ELSE
     C                     MOVE JNBTNB    KBTNB
     C                     MOVE JNBCDA    KBCDA
     C           KEY       SETGTGLJENHL2
     C                     ENDIF
      *
      ** Copy records to the new driver file until the limit
      ** specified in the input parameter (RECTOT) is reached.
      *
     C           TOT       DOUEQRECTOT
     C           *IN81     OREQ '1'
      *
     C                     CLEARDRIVEF                                                      CGL127AM
     C                     READ GLJENHL2                 81
      *                                                                                     CGL127AM
      ** Write first record, if there is one                                                CGL127AM
      *                                                                                     CGL127AM
     C           *IN81     IFEQ '0'
     C           TOT       IFEQ 0                                                           CGL127AM
     C                     MOVE 'A'       RECID                                             CGL127AM
     C                     MOVE ' '       PROT                                              CGL127AM
      *                                                                                     CGL127AM
      ** Do we want timestamp in Core version?                                              CGL127AM
      *                                                                                     CGL127AM
     C                     CALL 'ZAGENTS'                                                   CGL127AM
     C                     PARM           TMST   26                                         CGL127AM
     C**********           WRITE@BRREMA                                                     CGL127AM
     C                     WRITEDRIVEF                                                      CGL127AM
      *                                                                                     CGL127AM
     C                     MOVE 'F'       RECID                                             CGL127AM
     C                     MOVE ' '       PROT                                              CGL127AM
     C                     CALL 'ZAGENTS'                                                   CGL127AM
     C                     PARM           TMST   26                                         CGL127AM
     C                     WRITEDRIVEF                                                      CGL127AM
     C                     ENDIF
     C                     ADD  1         TOT
     C                     ENDIF
      *
     C                     ENDDO
      *                                                                                     CGL127AM
      ** Write last record, if there is one                                                 CGL127AM
      *                                                                                     CGL127AM
     C           *IN81     IFEQ '1'                                                         CGL127AM
     C           *HIVAL    SETGTGLJENHL2                                                    CGL127AM
     C                     READPGLJENHL2                 82                                 CGL127AM
     C                     ENDIF                                                            CGL127AM
      *                                                                                     CGL127AM
     C           TOT       IFGT 0                                                           CGL127AM
      *                                                                                     CGL127AM
     C                     MOVE 'L'       RECID                                             CGL127AM
     C                     MOVE ' '       PROT                                              CGL127AM
     C                     CALL 'ZAGENTS'                                                   CGL127AM
     C                     PARM           TMST                                              CGL127AM
     C                     WRITEDRIVEF                                                      CGL127AM
     C                     MOVE 'Z'       RECID                                             CGL127AM
     C                     MOVE ' '       PROT                                              CGL127AM
      *                                                                                     CGL127AM
      ** Do we want a timestamp in Core version?                                            CGL127AM
      *                                                                                     CGL127AM
     C                     CALL 'ZAGENTS'                                                   CGL127AM
     C                     PARM           TMST                                              CGL127AM
     C                     WRITEDRIVEF                                                      CGL127AM
     C                     ENDIF                                                            CGL127AM
      *
      ** Set up fields for Index file with data from last record
      ** written to PF/GLBATHPD.
      *
     C                     MOVE BRBTNB    JNBTNB
     C                     MOVE BRBCDA    JNBCDA
     C**********           MOVE BRDPCD    JNDPCD                                            CGL127AM
     C**********           MOVE BRWSID    JNWSID                                            CGL127AM
     C**********           Z-ADDBRHICC    JNHICC                                            CGL127AM
     C**********           Z-ADDBRHDCC    JNHDCC                                            CGL127AM
     C**********           Z-ADDBRHINC    JNHINC                                            CGL127AM
     C**********           Z-ADDBRHIIN    JNHIIN                                            CGL127AM
     C**********           Z-ADDBRHDIN    JNHDIN                                            CGL127AM
     C**********           Z-ADDBRHINI    JNHINI                                            CGL127AM
     C**********           MOVE BRBTSF    JNBTSF                                            CGL127AM
     C**********           MOVE BRBIUF    JNBIUF                                            CGL127AM
     C**********           MOVE BRSHPI    JNSHPI                                            CGL127AM
     C**********           MOVE BRRAPI    JNRAPI                                            CGL127AM
     C**********           MOVE BRMBRB    JNMBRB                                            CGL127AM
     C**********           MOVE BRRVVD    JNRVVD                                            CGL127AM
     C**********           MOVE BRBDES    JNBDES                                            CGL127AM
     C**********           Z-ADDBRSPTT    JNSPTT                                            CGL127AM
     C**********           Z-ADDBRNIST    JNNIST                                            CGL127AM
     C**********           MOVE BRSPRF    JNSPRF                                            CGL127AM
     C**********           MOVE BRDCIN    JNDCIN                                            CGL127AM
     C**********           MOVE BRIBCF    JNIBCF                                            CGL127AM
     C**********           MOVE BRCUSF    JNCUSF                                            CGL127AM
     C**********           MOVE BRCYCF    JNCYCF                                            CGL127AM
     C**********           MOVE BRACCF    JNACCF                                            CGL127AM
     C**********           MOVE BRACSF    JNACSF                                            CGL127AM
     C**********           MOVE BRNNBF    JNNNBF                                            CGL127AM
     C**********           Z-ADDBRRACF    JNRACF                                            CGL127AM
     C**********           MOVE BRPRCF    JNPRCF                                            CGL127AM
     C**********           Z-ADDBRAMTF    JNAMTF                                            CGL127AM
     C**********           MOVE BRIBCT    JNIBCT                                            CGL127AM
     C**********           MOVE BRCYCT    JNCYCT                                            CGL127AM
     C**********           MOVE BRCNAT    JNCNAT                                            CGL127AM
     C**********           MOVE BRACCT    JNACCT                                            CGL127AM
     C**********           MOVE BRASNT    JNASNT                                            CGL127AM
     C**********           MOVE BRNNBT    JNNNBT                                            CGL127AM
     C**********           Z-ADDBRRACT    JNRACT                                            CGL127AM
     C**********           MOVE BRTOJE    JNTOJE                                            CGL127AM
      *
      ** If Index file is empty write new record to it, else update
      ** with details of last record written to PF/GLBATHPD.
      *
     C           *IN80     IFEQ '1'
     C**********           MOVEASTAMP,1   JNTMST                                     CPK014 CGL127AM
     C                     WRITEINDEXF
     C                     ELSE
     C                     UPDATINDEXF
     C                     ENDIF
      *
     C                     COMIT
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      * END - Exit program and return to calling program              *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           END       BEGSR
      *
      ** If end of file on GLJENHL2 set return code to notify server
      *
     C           *IN81     IFEQ '1'
     C           *IN83     ANDEQ'1'                                                         MD036165
     C           TOT       IFEQ 0                                                           CGL127AM
     C                     MOVE 'NRF'     RTCODE                                            CGL127AM
     C                     ELSE                                                             CGL127AM
     C                     MOVE 'EOF'     RTCODE
     C                     ENDIF                                                            CGL127AM
     C                     ENDIF
      *
     C**********           SETON                     LR                                     CGL127AM
     C                     CLOSEGLBATHPD                                                    CGL127AM
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      * INIT - Initial processing                                     *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           INIT      BEGSR
      *
      ** KLIST for setting file pointer to next record to be copied
     C           KEY       KLIST
     C                     KFLD           KBCDA   3
     C                     KFLD           KBTNB   3
      *
      ** Set up copyright parameter
     C                     MOVEACPY@      CPY2@  80
      *
      ** Define LDA
     C           *NAMVAR   DEFN           LDA
      *
      ** Dummy READ to GLBATHPD for compilation purpose
     C           *IN50     IFEQ '1'
     C                     READ GLBATHPD                 50
     C                     ENDIF
      *                                                                                     MD036165
      **  CALL ACCESS PROGRAM FOR BANK DETAILS                                              MD036165
      *                                                                                     MD036165
     C                     CALL 'AOBANKR0'                                                  MD036165
     C                     PARM *BLANK    WRTCD   7                                         MD036165
     C                     PARM '*FIRST ' WOPTN   7                                         MD036165
     C           SDBANK    PARM SDBANK    DSFDY                                             MD036165
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      * Called by: (**calling routines**)                             *
      * Calls: None                                                   *
      *****************************************************************
     C           *PSSR     BEGSR
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'GL0262'  DBPGM     P
     C                     OUT  LDA
      *
     C                     SETON                     U7U8LR
     C                     DUMP
     C                     ROLBK
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
** CPY@ - Object copyright
(c) Misys International Banking Systems Ltd. 2001
