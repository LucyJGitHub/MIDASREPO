     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas UPDATE PRONO WITH CLEARPD')                      *
      *****************************************************************
      *                                                               *
      *  Midas - General Ledger Module                                *
      *                                                               *
      *  GL0580C - UPDATE PRONO WITH CLEARPD                          *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. MD032907 *CREATE   Date 27Apr15               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  MD032907 - Get PBR correct balance on PRONO reading CLEARPD. *
      *                                                               *
      *****************************************************************
     FSDNOSTL2IF  E           K        DISK         KINFSR ERRSR
      * IN  - @NOSTBH Nostros          (CUST¦CYCD¦ACCD¦ACSN¦BRCD)
     FCLEARPD IF  E                    DISK         KINFSR ERRSR
      *****************************************************************
      *                                                               *
      *  F U N C T I O N   O F   I N D I C A T O R S                  *
      *                                                               *
      *   01  - Chain on batch header - GLJENHL0                      *
      *   02  - Update batch header - GLJENHL0                        *
      *   03  - Chain/Reade transactions - CLEARPD                    *
      *   09  - Lokup operation on Prono dates                        *
      *   10  - Write operation on Rsacmtpd                           *
      *   22  - Error occurred on GLJENHPD                            *
      * 90-99 - Used by Standard Subroutines                          *
      *   U3  - Record lock on GLJENHPD                               *
      *                                                               *
      *****************************************************************
     E                    CPY@    1   1 80               COPYRIGHT STATEMENT
      *
      ** File structure for write to file
      *
      ** DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     IRUNDAT      DS                             13
     I                                    P   8  100EJNB
      *
      ** Prono key for error reporting
      *
     IPROERR      DS
     I                                        1   3 KCCY
     I                                        4   50KNNO
      *
     IW#ACID      DS
     I                                        1   6 W#CNUM
     I                                        7   9 W#CCY
     I                                       10  19 W#ACOD
     I                                       10  190ACOD
     I                                       20  210W#ACSQ
     I                                       22  24 W#BRCA
      *
      ** Local Data Area to identify database errors
      *
     ILDA        UDS                            256
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
      *
     IDSFDY     E DSDSFDY
      ** FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE
     ISDNOST    E DSSDNOSTPD
     I              QQACCD                          QQACD1
      *
     IMMOD      E DSMMODF
      *
     ISCSARD    E DSSCSARDPD
     I              LCD                             LLCD
      *
     ID@CURR    E DSSDCURRPD
      *
      ** Currency Codes DS for assigning data from Access
      ** Programs to work fields
      *
     IDSPGM     ESDSY2PGDSP
      *
      ** Program data structure
      *
      /EJECT
     C           K@NOST    KLIST                                                Account ID
     C                     KFLD           CNUM                                    Customer
     C                     KFLD           CCY                                     Currency
     C                     KFLD           W#ACOD                                  Acc.code
     C                     KFLD           ACSQ                                    Acc.seq.
     C                     KFLD           BRCA                                    Branch code
      *
      ** Program INITSRlisation
      *
     C                     EXSR INITSR
      *
      ** Transaction processing
      *
     C                     EXSR TRANSR
      *
      ** Program termination
      *
     C                     EXSR TERMSR
      *
      *****************************************************************
      *                                                               *
      *     TRANSR SR     SUB-ROUTINE                                 *
      *                                                               *
      *     Transaction processing                                    *
      *                                                               *
      *****************************************************************
      *
     C           TRANSR    BEGSR
      *
      ** Position pointer on first transaction record of CLEARPD
      *
     C           1         SETLLCLEARPD
      *
      ** Read all file till eoF
      *
     C                     READ APOSTPDF                 03
      *
      ** Process all transactions relating to the batch
      *
     C           *IN03     DOWEQ'0'
      *
      ** Check it posting  is for a nostro
      *
     C           K@NOST    CHAIN@NOSTBH              95
     C           *IN95     IFEQ *OFF
      *
      ** Process records
      *
     C                     EXSR PROSR
      *
     C                     END
      *
      **  Read next record
      *
     C                     READ APOSTPDF                 03
     C                     ENDDO
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *     PROSR  SR     SUB-ROUTINE                                 *
      *                                                               *
      *     Prono processing - (Nostro)                               *
      *                                                               *
      *****************************************************************
      *
     C           PROSR     BEGSR
      *
      **    Prono record update
      *
     C                     MOVELA7CYCD    NOSKEY  5
     C                     MOVE A7NONB    NOSKEY
     C                     MOVELNOSKEY    PPRKEY
     C                     MOVELVALD      PVDAT
     C           DRCR      IFEQ 0
     C                     Z-ADDPSTA      PAMT
     C                     ELSE
     C           DRCR      IFEQ 1
     C                     Z-SUBPSTA      PAMT
     C                     ENDIF
     C                     ENDIF
      *
     C                     CALL 'AOPRONU0'
     C                     PARM *BLANKS   PRTCD   7
     C                     PARM           PPRKEY  8
     C                     PARM           PVDAT   50
     C                     PARM           PAMT   150
     C*
     C*     Data base error if update fails
     C*
     C           PRTCD     IFNE *BLANKS
     C                     Z-ADD05        DBASE            * DB ERROR 05 *
     C                     MOVE 'PRONO'   DBFILE
     C                     MOVELPROERR    DBKEY
     C                     EXSR ERRSR
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *     INITSR SR     SUB-ROUTINE                                 *
      *                                                               *
      *     Program initialisation                                    *
      *                                                               *
      *****************************************************************
     C           INITSR    BEGSR
     C                     MOVEACPY@      BIS@   80
      *
      ** Setup program name for reporting DB errors
      *
     C                     MOVE 'GL580C'  DBPGM
      *
      ** Accept run date
      *
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
     C                     Z-ADDEJNB      RDATE   50
      *
      ** Access SAR Details for Projected Movements Update Prior to Auth.
      *
     C                     MOVEL'N'       CGL016  1
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY' @OPTN   7
     C                     PARM 'CGL016'  @SARD   6
     C           SCSARD    PARM SCSARD    DSFDY
      *
     C           @RTCD     IFEQ *BLANK
     C                     MOVEL'Y'       CGL016
     C                     ENDIF
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *     TERMSR SR     SUB-ROUTINE                                 *
      *                                                               *
      *     Program termination                                       *
      *                                                               *
      *****************************************************************
     C           TERMSR    BEGSR
      *
     C                     MOVE '1'       *INLR
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *     ERRSR  SR     SUB-ROUTINE                                 *
      *                                                               *
      *     Error routine                                             *
      *                                                               *
      *****************************************************************
     C           ERRSR     BEGSR
     C*
     C                     SETON                     U7U8LR
     C                     DUMP
     C                     RETRN
     C*
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  *PSSR - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      *  Called by: Error-trapping routines.                          *
      *                                                               *
      *  Calls:  None.                                                *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR
      *
     C                     SETON                     U7U8
     C           WRUN      IFEQ *BLANKS
     C                     MOVE 'Y'       WRUN    1
     C                     DUMP
     C                     ENDIF
      *
     C                     ENDSR
     C*
**  CPY@
(c) Finastra International Limited 2001
