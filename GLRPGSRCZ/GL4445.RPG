     H        1                                                           CCB002
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas GL Batch input account movements')               *
/*XBI *:  OVRDBF GLJEXXX2 GLJENPL2                                  : *   S01229
      *****************************************************************
      *                                                               *
      *  Midas - General Ledger Module                                *
      *                                                               *
      *  GL4445 - BATCH INPUT ACCOUNT MOVEMENTS                       *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. MD031009           Date 16Oct14               *
      *  Prev Amend No. MD028278           Date 08Jul14               *
      *                 MD027654           Date 02Jul14               *
      *                 MD023889           Date 10Dec13               *
      *                 CGL135B            Date 04Nov13               *
      *                 CAP207             Date 10Feb11               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 BUG23717           Date 09Apr09               *
      *                 CER047             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 CAP205             Date 08Mar10               *
      *                 BUG27209           Date 12Mar10               *
      *                 CAP204             Date 09Feb10               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 241672A            Date 09Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 BUG12777A          Date 08Dec06               *
      *                 BUG12777           Date 30Nov06               *
      *                 243093             Date 19Oct06               *
      *                 192335             Date 06Jun06               *
      *                 136184             Date 06Jun06               *
      *                 239155 (Reopen)    Date 31May06               *
      *                 239155             Date 30May06               *
      *                 239830             Date 24May06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 236197             Date 29Sep05               *
      *                 CRE023             Date 29Jul05               *
      *                 BUG7459            Date 14Jun05               *
      *                 CSC024             Date 07Feb05               *
      *                 CLE025             Date 20Oct03               *
      *                 BUG2368            Date 30Apr04               *
      *                 CSC022             Date 24Feb04               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 04Nov03               *
      *                 CDE005             Date 28Aug03               *
      *                 CGL016             Date 01Aug02               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 182086             Date 13Mar02               *
      * Midas Release 4.01 -------------------------------------------*
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CDE001             Date 10Feb00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CEU013             Date 09Apr98               *
      *                 108484             Date 03Sep97               *
      *                 CCB002             DATE 19JUL96               *
      *                 100027             DATE 08JUL96               *
      *                 092161             DATE 01NOV95               *
      *                 S01408             DATE 08MAR95               *
      *                 080050             DATE 26JAN95               *
      *                 078325             DATE 22NOV94               *
      *                 S01413             DATE 13APR93               *
      *                 042757             DATE 12JAN94               *
      *                 046303             DATE 09DEC93               *
      *                 E38323             DATE 30JUL92               *
      *                 S01340             DATE 21FEB92               *
      *                 S01251             DATE 20MAR90               *
      *                 BHF675             DATE 18SEP90               *
      *                 BHF674             DATE 18SEP90               *
      *                 BHF515             DATE 18SEP90               *
      *                 S01229             DATE 11APR90               *
      *                 S01229             DATE 04APR90               *
      *                 E19313             DATE 01NOV89               *
      *                 E19285             DATE 31OCT89               *
      *                 E19359             DATE 26OCT89               *
      *                 E19860             DATE 17SEP89               *
      *                 S01194             DATE 23/02/90              *
      *                 S01195             DATE 23/01/90              *
      *                 E17482             DATE 11/05/89              *
      *                 S01194             DATE 13/03/89              *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD031009 - Re-deliver missing copy sources (Recompile)       *
      *  MD028278 - Journal entry posting for nostro account is       *
      *             incorrect in Projected Nostro                     *
      *  MD027654 - Cannot accept batch item                          *
      *  MD023889 - Accounting Rules Process (GL Account creation)    *
      *            Added hook: CGL135_112                             *
      *  CGL135B - Accounting Rules Process                           *
      *            Added hooks: CGL135_091, CGL135_092, CGL135_093,   *
      *                         CGL135_094, CGL135_095, CGL135_096,   *
      *                         CGL135_097, CGL135_098, CGL135_099    *
      *  CAP207 - Account Balance Check extended to other APIs        *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  BUG23717 - MEMOS file incorrectly updated; duplicate of      *
      *             BUG27209                                          *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  BUG27209 - Double posting on journal entry                   *
      *  CAP204 - Teller Related APIs - Account Transfer (Recompile)  *
      *  241672A- REC0880 in MSGW due to locked record.               *
      *  BUG12777A- Still create the Shadow Posting record but        *
      *             use the details from SDNOSTPD, if Nostro is       *
      *             newly created (unallocated).                      *
      *  BUG12777 - Do not write unallocated nostros in RSACMTPD.     *
      *             This is causing other COB components to fail      *
      *             because of zero account code.                     *
      *  243093 - Reverse 2 O'clock flag. Memos should be updated.    *
      *  192335 - Correction to 136184 which causes PRONO balance not *
      *           to be updated if the Nostro appears on the PRONO    *
      *           file.                                               *
      *  136184 - GL4445 120700 array index is not valid when a new   *
      *           Nostro is created.  PRONO will not be updated if    *
      *           currency and Nostro does not exist.                 *
      *  239155 - (Reopen) Batch should be flagged as ACCEPTED once   *
      *           the shadow postings are updated succesfully.        *
      *  239155 - Avoid lock between thin client session and GLC445.  *
      *           Few codings done by BUG7459.                        *
      *  239830 - Initialise unused fields to avoid data mapping error*
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  236197 - Change logical file to wait for record access.      *
      *  CRE023 - 2 O'clock Flag Upgrade to MidasPlus.                *
      *  BUG7459 - Avoid lock between thin client session and GLC445. *
      *  CSC024 - Open Month End (Recompile)                          *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  BUG2368- Programs looking at wrong dataarea for CSC022       *
      *  CSC022 - Commitment Control Changes for MidasPlus            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Correct parameters on program calls                 *
      *  CDE005 - Date Export - Reservation ID                        *
      *  CGL016 - Projected Movements Update Prior to Authorisation   *
      *  182086 - Initialise ZDAYNO to prevent Decimal Data Error.    *
      *  CDE001 - Data Export - CCRM Limits                           *
      *  CEU013 - EMU Account Postings Narrative                      *
      *           Allow Retai/Nostro 'In' currency accounts from an   *
      *           interface batch to be processed without checks.     *
      *  108484 - On Line Position must be updated by posting from    *
      *           batch input if the Spot Trade Account is used.      *
      *  CCB002 - COB Performance Enhancements                        *
      *           Access now via access object                        *
      *           Change MEMOS processing to use access objects.      *
      *  100027 - If RRN of MEMOS record is blank, chain to ACCNT to  *
      *           obtain it, to prevent GLC445 terminating abnormally.*
      *           Note: this should happen only if Interface batch is *
      *                 (wrongly) input with status 'Accepted'        *
      *  092161 - Do not output a database error if nostro record on  *
      *           PRONO, as the nostro may have been set up today.    *
      *           Also, do not try to update PRONO if no record read. *
      *  S01408 - Core hook GL4445CCPG added                          *
      *           Core hook GL4445FFPG added                          *
      *  080050  -  Recompile over amended file RSACMTPD              *
      *          -  Produce program dump if DB error                  *
      *  078325 - Do not update last 2 bytes of Terminal ID with '**' *
      *           or blanks as it serves no purpose and corrupts the  *
      *           10 character ID of the user who accepted the batch. *
      *  S01413 - Retail 3 Incorporation                              *
      *  042757 - Projected Nostro account movement value dated on    *
      *           a non-working day should be reflected on the next   *
      *           working day (and not on the previous working day).  *
      *  046303 - /COPY source subr. ZFWDT amended to prevent array   *
      *           error if no holiday record found - fixed by S01434. *
      *           Program recompiled.                                 *
      *  E38323 - Recompiled due to a change in copy source ZFWDT/sr. *
      *  S01340 - RECOMPILED FOR MIS RELEASE 10                       *
      *  S01251 - SYNON NAMES CHANGES                                 *
      *  BHF675 - Need to zeroise temporary transaction no. WTRN      *
      *         - to stop accumulation of batch item numbers          *
      *  BHF674 - Need to move left batch number into trans. no.      *
      *  BHF515 - Need to output branch code to RSACMTPD              *
      *  S01229 - SYNON file name changes                             *
      ***E19313*-*GL4445*UNABLE*TO*ALLOCATE*RECORD*IN*GLBTREL************ S01251
      *  E19313 - GL4445 UNABLE TO ALLOCATE RECORD IN GLJENPL2        *   S01251
      *           WHEN IT HAES READ ALL ITEMS FROM CURRENT            *
      *           BATCH, IT ATTEMPTS TO READ THE FIRST RECORD         *
      *           FROM THE NEXT BATCH TO CONFIRM ALL RECORDS          *
      *           HAVE BEEN READ. THIS RECORD MAY BE LOCKED           *
      *           BY BATCH INPUT AND READE WILL FAIL.                 *
      *           FIX BY READING INPUT ONLY FILE FIRST AND            *
      ************ONLY*READING*GLBTREL2*IF*THE*READE*IS****************** S01251
      *           ONLY READING GLJENPL2 IF THE READE IS               *   S01251
      *           SUCCESSFUL.                                         *
      *  E19285 - VALIDATE ON ACCOUNT TYPE INSTEAD OF ON              *
      *           RETAIL NUMBER.                                      *
      *  E19359 - IF THE RETAIL FLAG IS OFF CANNOT OPEN               *
      *           MEMOS FOR RETAIL TRANSACTIONS.                      *
      *           CPF4328 DISPLAYED                                   *
      *  E19860 - BRCKST SET TO 'N' INSTEAD OF ' '                    *
      *  S01194 - NEW STANDING DATA                                   *
      *  S01195 - HOLIDAY PROCESSING                                  *
      *  E17482 - NON RETAIL POSTING HAS RE NUMBER OF ZEROS           *
      *  S01194 - NEW STANDING DATA                                   *
      *                                                               *
      *****************************************************************
     F*
     F*                                                                   S01408
     F/COPY WNCPYSRC,GL4445FFPG                                           S01408
     F*                                                                   S01408
     F*GLBRREL0UF  E           K        DISK         KCOMIT               S01229
     F*GLJENHL0UF**E***********K        DISK         KCOMIT                            S01229 236197
     FGLJENHL5UF  E           K        DISK         KCOMIT                                    236197
     F                                              KINFSR ERRSR                              239155
     F                                              KINFDS GLHDS                             241672A
     F*GLBTXXX2IF  E           K        DISK         KCOMIT        E19313 S01229
     FGLJEXXX2IF  E           K        DISK         KCOMIT                S01229
     F            @BTREBG                           KRENAME@BTXXX
     F                                              KINFSR ERRSR                              239155
     F/COPY OFCPYSRCZ,CGL135_091                                                             CGL135B
     F*GLBTREL2UF  E           K        DISK         KCOMIT               S01229
     FGLJENPL2UF  E           K        DISK         KCOMIT                S01229
     F                                              KINFSR ERRSR                              239155
     F**MEMOS   UF  E                    DISK         KCOMIT****       ** E19359
     F**MEMOS   UF  E                    DISK         KCOMIT    UC  E19359CCB002
     F***PRONO   UF  E           K        DISK         KCOMIT                               MD027654
     FPRONO   IF  E           K        DISK         KCOMIT                                  MD027654
     F                                              KINFSR ERRSR                              239155
     F/COPY WNCPYSRC,GL4445F001
     FRSACMTPDO   E           K        DISK         KCOMIT       A
     F                                              KINFSR ERRSR                              239155
     F**ACCNT   IF  E           K        DISK                       100027CCB002
     F*FDTABJLLIF*E***********K        DISK                               S01194
     F*
     F*-------------------------------------------------------------------
     F*                                                                  *
     F* ID F  C  H  L    FUNCTION OF INDICATORS                          *
     F*                                                                  *
     F*    01            Chain on batch header - GLJENHL0                *S01229
     F*    02            Update batch header - GLJENHL0                  *S01229
     F*    03            Chain/Reade transactions - GLJENPL2             *S01229
     F*    04            Update transaction record - GLJENPL2            *S01229
     F*****05************Chain on Memos - MEMOSMDF                       *CCB002
     F*****06************Update Memos - MEMOSMDF                         *CCB002
     F*    07            Chain on Prono - PRONOPNF                       *
     F*    08            Update Prono - PRONOPNF                         *
     F*       09         Lokup operation on Prono dates                  *
     F*    10            Write operation on Rsacmtpd                     *
      *    22            Error occurred on GLJENHPD                      *                   241672A
     F*       90-99      STANDARD SUBROUTINES / WORK INDS.
      *    U3            Record lock on GLJENHPD                         *                   241672A
     F*                                                                  *
     F********************************************************************
     F*
     E                    PRB         5 15 0             PROJ. NOSTRO BALS
     E                    PRD         5  5 0A            PRONO BAL. DATES
     E/COPY WNCPYSRC,GL4445E001
     E                    ZHC        50  3               ZDATES SR.ARRAY
     E*
     E                    CPY@    1   1 80               COPYRIGHT STATEMENT
      *                                                                                       CSC022
      ** Array to hold commitment jobs name                                                   CSC022
      *                                                                                       CSC022
     E                    WCMT       10 10                                                    CSC022
      *                                                                                       CSC022
     E/COPY ZSRSRC,ZHOLE                                                  S01195
     I*                                                                   CDE001
     I** File structure for write to file                                 CDE001
     I*                                                                   CDE001
     II#RSAC    E DSRSACMTPD                                              CDE001
     I              BRCA                            RSBRCA                CDE001
     I**********                              1  18 W#ACID                             CDE001 CGL029
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     IRUNDAT      DS                             13
     I                                    P   8  100EJNB
     I*
     I*     Accept Prono balances & dates into arrays
     I*
     I            DS
     I                                        1  40 PNB
     I                                    P   1  40 PRB
     I                                       41  55 PND
     I                                    P  41  55 PRD
     I/COPY WNCPYSRC,GL4445I003
     I*
     I*     Prono key for error reporting
     I*
     IPROERR      DS
     I                                        1   3 KCCY
     I                                        4   50KNNO
      *                                                                                       CGL029
     IW#ACID      DS                                                                          CGL029
     I**********                              1   60W#CNUM                             CGL029 CSD027
     I                                        1   6 W#CNUM                                    CSD027
     I                                        7   9 W#CCY                                     CGL029
     I                                       10  190W#ACOD                                    CGL029
     I                                       20  210W#ACSQ                                    CGL029
     I                                       22  24 W#BRCA                                    CGL029
     I*
     I***   Local Data Area to identify database errors
     I*
     ILDA        UDS                            256
     I**********                            134 138 DBFILE                S01194
     I**********                            139 167 DBKEY                 S01194
     I**********                            168 175 DBPGM                 S01194
     I**********                            176 1770DBASE                 S01194
     I                                      134 141 DBFILE                S01194
     I                                      142 170 DBKEY                 S01194
     I                                      171 180 DBPGM                 S01194
     I                                      181 1830DBASE                 S01194
     I*                                                                   S01194
     IDSMEMS    E DSMEMOS                                                                     222373
     I              RECI                            MRECI                                     222373
     I              CNUM                            MCNUM                                     222373
     I              CCY                             MCCY                                      222373
     I              ACOD                            MACOD                                     222373
     I              ACSQ                            MACSQ                                     222373
     I              BRCA                            MBRCA                                     222373
     I              ACNO                            MACNO                                     222373
     I** External data structure for MEMOS Details                                            222373
      *                                                                                       222373
     I/COPY WNCPYSRC,GL4445I002
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   108484
     ISDTRAD    E DSSDTRADPD                                              108484
     I* TRADING DETAILS ACCESSED VIA ACCESS PROGRAM                       108484
     I*                                                                   S01194
     ISDNOST    E DSSDNOSTPD                                              S01194
     I              QQACCD                          QQACD1                                    CGL029
     I*                                                                   S01194
     IMMOD      E DSMMODF                                                 E19359
     I*                                                                   CGL016
     ISCSARD    E DSSCSARDPD                                              CGL016
     I              LCD                             LLCD                  CGL016
     I*                                                                   CEU013
     ID@CURR    E DSSDCURRPD                                              CEU013
     I*                                                                   CEU013
     I*  Currency Codes DS for assigning data from Access                 CEU013
     I*  Programs to work fields                                          CEU013
     I*                                                                   CEU013
     I*                                                                   S01413
     I*                                                                   CEU013
     ID@ACCT    E DSACCNTAB                                               CEU013
     I*                                                                   CEU013
     I*  Account Details DS for assigning data from Access                CEU013
     I*  Programs to work fields                                          CEU013
     I              ZZ002                           ZZ002B                CEU013
     I              ACODQQ                          ACDDQQ                                    CGL029
      *                                                                                       CSC022
      *                                                                                       CSC022
     IDSPGM     ESDSY2PGDSP                                                                   CSC022
      ** Program data structure                                                               CSC022
      *                                                                                       CSC022
     IWDSJOB    E DSSCCMTJOB                                                                  CSC022
     I              COMITNUM                        WCMTNO                                    CSC022
     I              COMITJOB1                       WJOB01                                    CSC022
     I              COMITJOB2                       WJOB02                                    CSC022
     I              COMITJOB3                       WJOB03                                    CSC022
     I              COMITJOB4                       WJOB04                                    CSC022
     I              COMITJOB5                       WJOB05                                    CSC022
     I              COMITJOB6                       WJOB06                                    CSC022
     I              COMITJOB7                       WJOB07                                    CSC022
     I              COMITJOB8                       WJOB08                                    CSC022
     I              COMITJOB9                       WJOB09                                    CSC022
     I              COMITJOB10                      WJOB10                                    CSC022
     I                                        4 103 WCJOBS                                    CSC022
      ** Commitment Control dataarea                                                          CSC022
      *                                                                                       CSC022
     IGLHDS       DS                                                                         241672A
     I                                     *STATUS  GLHST                                    241672A
     IGLHDET      DS                                                                         241672A
     I                                        1   5 GH4RTY                                   241672A
     I                                        6  10 GH4WAT                                   241672A
     I                                       11  15 GH8RTY                                   241672A
     I                                       16  20 GH8WAT                                   241672A
      *                                                                                      241672A
     I* Transaction number data structure for RSACMTPD                    S01413
     IWTRNM       DS                                                      S01413
     I                                        1   3 WBNUM                 S01413
     I                                        4   6 WBINB                 S01413
     I/COPY WNCPYSRC,GL4445I001
     I/COPY ZSRSRC,ZHOLDS                                                 S01195
     I/COPY ZSRSRC,ZHOLI                                                  S01195
      /EJECT                                                              S01194
     C           PLIST1    PLIST                                          S01194
     C                     PARM '*MSG   ' P@RTCD  7                       S01194
     C                     PARM '*KEY   ' P@OPTN  7                       S01194
     C                     PARM *BLANK    P@CUST  6                    A  S01194
     C*                                                                   S01194
     C                     PARM BTCYCD    P@CYCD  3                    B  S01194
     C**********           PARM *BLANK    P@ACCD  4                    C               S01194 CGL029
     C                     PARM *BLANK    P@ACCD 10                    C                      CGL029
     C                     PARM *BLANK    P@ACSN  2                    D  S01194
     C*                                                                   S01194
     C                     PARM BTNNBI    P@NONB  2                    E  S01194
     C                     PARM *BLANK    P@BRCD  3                    F  S01194
     C                     PARM *BLANK    P@CSSN 10                    G  S01194
     C                     PARM *BLANK    P@PNOI  1                    H  S01194
     C           SDNOST    PARM SDNOST    DSFDY                           S01194
     C*                                                                   S01194
     C                     MOVEACPY@      BIS@   80
     C*                                                                   S01195
     C*
     C*     Program initialisation
     C*
     C                     EXSR INITSR
     C*
     C*     Transaction processing
     C*
     C                     EXSR TRANSR
     C*
     C*     Program termination
     C*
     C                     EXSR TERMSR
     C*
     C********************************************************************
     C*                                                                  *
     C*     TRANSR SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Transaction processing                                       *
     C*                                                                  *
     C********************************************************************
     C*
     C           TRANSR    BEGSR
     C*
     C*     Position pointer on first transaction record of the batch
     C*
     C********   BATCH     CHAINGLBTREL2             03**********         E19313
     C***********BATCH*****CHAINGLBTXXX2             03            E19313 S01229
     C           BATCH     CHAINGLJEXXX2             03            E19313 S01229
     C**N03******BATCH*****CHAINGLBTREL2             03            E19313 S01229
     C  N03      BATCH     CHAINGLJENPL2             03            E19313 S01229
     C*
     C*     Data base error if no transaction recs exist for the batch
     C*
     C           *IN03     IFEQ '1'
     C                     Z-ADD01        DBASE            * DB ERROR 01 *
     C                     MOVE 'GLTRL'   DBFILE
     C                     MOVELBATCH     DBKEY
     C                     EXSR ERRSR
     C                     END
     C*
     C*     Process all transactions relating to the batch
     C*
     C           *IN03     DOWEQ'0'
      *                                                                   CGL016
     C                     MOVE 'Y'       W0OK    1                       CGL016
      *                                                                   CGL016
     C/COPY OFCPYSRCZ,CGL135_092                                                             CGL135B
     C           CGL016    IFEQ 'Y'                                       CGL016
     C           BTSHPI    ANDEQ'Y'                                       CGL016
     C                     MOVE 'N'       W0OK                            CGL016
     C                     ENDIF                                          CGL016
     C*                                                                   CGL016
     C           W0OK      IFEQ 'Y'                                       CGL016
     C/COPY WNCPYSRC,GLH00615
     C*                                                                   CGL016
     C*     Process records that have not been shadow posted
     C*
     C           BTSHPI    IFNE 'Y'
     C*                                                                   108484
     C**  Obtain Spot Trade Account Code of the system                    108484
     C*                                                                   108484
     C                     CALL 'AOTRADR0'                                108484
     C                     PARM '*MSG   ' @RTCD   7                       108484
     C                     PARM '*FIRST ' @OPTN   7                       108484
     C           SDTRAD    PARM SDTRAD    DSFDY                           108484
     C*                                                                   108484
     C           @RTCD     IFNE *BLANK                                    108484
     C                     MOVE '015'     DBASE            ***************108484
     C/COPY WNCPYSRC,GLH00614
     C                     MOVEL'*FIRST ' DBOPTN  7        * DB ERROR 15 *108484
     C                     MOVEL'*FIRST ' DBKEY            ***************108484
     C                     MOVEL'SDTRADPD'DBFILE                          108484
     C                     EXSR ERRSR                                     108484
     C                     END                                            108484
     C*                                                                   CEU013
     C                     MOVE *BLANKS   WKRETL  1        Retail a/c n/f CEU013
     C                     MOVE *BLANKS   WKNOST  1        Nostro a/c n/f CEU013
     C*                                                                   CEU013
     C*  Access Currency codes file for the 'In' currency flag            CEU013
     C*                                                                   CEU013
     C           CEU013    IFEQ 'Y'                                       CEU013
     C           BRTOJE    ANDEQ'I'                                       CEU013
     C           WKCYCD    IFNE BTCYCD                                    CEU013
     C                     MOVELBTCYCD    UUCYCD                          CEU013
     C                     CALL 'AOCURRR0'                                CEU013
     C                     PARM *BLANKS   UUAPRC  7        B:Return Cd    CEU013
     C                     PARM '*KEY'    UUAPOP  7        I:Option       CEU013
     C                     PARM           UUCYCD  3        I:Currency CodeCEU013
     C           D@CURR    PARM *BLANK    DSSDY            O:Format       CEU013
     C*                                                                   CEU013
     C           UUAPRC    IFNE *BLANKS                    *IF            CEU013
     C                     MOVE '017'     DBASE            ***************CEU013
     C                     MOVEL'*KEY   ' DBOPTN  7        * DB ERROR 17 *CEU013
     C                     MOVELBTCYCD    DBKEY            ***************CEU013
     C                     MOVEL'SDCURRPD'DBFILE                          CEU013
     C                     EXSR ERRSR                                     CEU013
     C                     ELSE                                           CEU013
     C* Assign work field to file field values.                           CEU013
     C                     MOVELA6INCY    WKINCY           'In' Currency  CEU013
     C                     ENDIF                                          CEU013
     C                     MOVE BTCYCD    WKCYCD                          CEU013
     C                     ENDIF                                          CEU013
     C                     ENDIF                                          CEU013
     C*                                                                   CEU013
     C*
     C*                                                                   CEU013
     C*  Access Account master file for 'Closed' accounts and             CEU013
     C*    unopened accounts.                                             CEU013
     C*                                                                   CEU013
     C           CEU013    IFEQ 'Y'                                       CEU013
     C           BRTOJE    ANDEQ'I'                                       CEU013
     C           WKINCY    ANDEQ'Y'                                       CEU013
     C           BTACTY    IFEQ 'R'                                       CEU013
     C           BTNNBI    ORNE *BLANKS                                   CEU013
      * Check Account Number. - Standard functions  *                     CEU013
     C*                                                                   CEU013
     C* Set up Parameters for call to AOACCTR0                            CEU013
     C*                                                                   CEU013
     C                     MOVEL*BLANK    UUACID                          CEU013
     C                     MOVELBTCUST    UUCUST                          CEU013
     C                     MOVELBTCYCD    UUCYCD                          CEU013
     C                     MOVELBTACCD    UUACNO                          CEU013
     C                     MOVELBTACSN    UUACSN                          CEU013
     C                     MOVELBTIBCA    UUBRCD                          CEU013
     C*                                                                   CEU013
     C*  Call to Access Program - AOACCTR0 Check Account Number           CEU013
     C*  Access Account Details file for the file fields                  CEU013
     C*                                                                   CEU013
     C                     CALL 'AOACCTR0'                                CEU013
     C                     PARM *BLANKS   UUAPRC  7        B:Return Cd    CEU013
     C                     PARM '*KEY'    UUAPOP  7        B:Option       CEU013
     C                     PARM           UUACID 10        I:Account IdentCEU013
     C                     PARM           UUCUST  6        I:Customer NumbCEU013
     C                     PARM           UUCYCD  3        I:Currency CodeCEU013
     C**********           PARM           UUACNO  4        I:Account Code              CEU013 CGL029
     C                     PARM           UUACNO 10        I:Account Code                     CGL029
     C                     PARM           UUACSN  2        I:Account SequeCEU013
     C                     PARM           UUBRCD  3        I:Branch code  CEU013
     C           D@ACCT    PARM *BLANK    DSSDY            O:Format       CEU013
     C*                                                                   CEU013
     C           UUAPRC    IFEQ '*NRF'                     Not found      CEU013
     C           ACST      OREQ 'C'                        Closed         CEU013
     C                     MOVE 'Y'       WKRETL           Retail a/c n/f CEU013
     C                     MOVE 'Y'       WKNOST           Nostro a/c n/f CEU013
      *
     C                     ENDIF                                          CEU013
     C*                                                                   CEU013
     C                     ENDIF                                          CEU013
     C                     ENDIF                                          CEU013
     C*                                                                   CEU013
     C*     Retail transaction
     C*
     C***********BTABST    IFEQ 'R'                                       E19285
     C           BTACTY    IFEQ 'R'                                 E19285S01194
     C***                  MOVE '00000'   WF10   10                 E17482E19285
     C***                  MOVEL'00000'   WF10                      E17482E19285
     C***        BTB9NB    IFNE WF10                                E17482E19285
     C***        BTB9NB    IFNE *BLANKS                                   E17482
     C* The Memo file is not updated if the account is not found or       CEU013
     C*   the account is closed.  This is applicable for only             CEU013
     C*   interface batch with 'In' currency and Retail/Nostro account.   CEU013
     C*   The switchable feature CEU013 must have been installed.         CEU013
     C           WKRETL    ANDNE'Y'                                       CEU013
      ** Do not execute SR/RETSR if CRE023 is on.                                             CRE023
     C********** CRE023    ANDEQ'N'                                                    CRE023 243093
     C           CRE023    ANDEQ'N'                                                         BUG27209
     C/COPY OFCPYSRCZ,CGL135_093                                                             CGL135B
     C                     EXSR RETSR
     C                     END
     C*
     C*     Prono transaction
     C*
     C* If Retail account was not found, bypass the Nostro processing     CEU013
     C*                                                                   CEU013
     C           BTNNBI    IFNE *BLANKS
     C           WKRETL    ANDNE'Y'                                       CEU013
     C/COPY WNCPYSRC,GL4445C011
     C                     EXSR PROSR
     C/COPY WNCPYSRC,GL4445C012
     C                     END
     C*                                                                   108484
     C**  On Line Position Update (only if account code is                108484
     C**  Spot Trade Account Code)                                        108484
     C*                                                                   108484
     C* If Retail account or Nostro account was not found, on line        CEU013
     C*   position update is not performed.                               CEU013
     C*                                                                   CEU013
     C           BTACCD    IFEQ BLSPTA                                    108484
     C           WKRETL    ANDNE'Y'                                       CEU013
     C           WKNOST    ANDNE'Y'                                       CEU013
     C                     EXSR OLPSR                                     108484
     C                     END                                            108484
     C*                                                                   S01408
     C/COPY WNCPYSRC,GL4445CCPG                                           S01408
     C*                                                                   S01408
      *   FOR ALL TYPES OF ACCOUNTS                                       S01413
     C           UPDIND    IFNE 'Y'                                       S01413
     C                     MOVE 'Y'       UPDIND                          S01413
     C                     END                                            S01413
     C*
     C/COPY OFCPYSRCZ,CGL135_112                                                            MD023889
      *
     C*     Shadow postings and batch transaction record update
     C*
     C*                                                                   CEU013
     C* If Retail account or Nostro account was not found, G/L            CEU013
     C*   account meovements are not generated and the Shadow             CEU013
     C*   postings flag is not updated to 'Y'.                            CEU013
     C*                                                                   CEU013
     C           UPDIND    IFEQ 'Y'
     C                     MOVE 'N'       UPDIND
     C           WKRETL    IFNE 'Y'                                       CEU013
     C           WKNOST    ANDNE'Y'                                       CEU013
     C                     EXSR RSACSR
     C                     MOVE 'Y'       BTSHPI
     C                     ELSE                                           CEU013
     C                     MOVE 'N'       BTSHPI                          CEU013
     C                     ENDIF                                          CEU013
     C                     UPDAT@BTREBG                04
     C*
     C*     Data base error if update fails
     C*
     C           *IN04     IFEQ '1'
     C                     Z-ADD02        DBASE            * DB ERROR 02 *
     C*********************MOVE 'GLBTR'   DBFILE                          S01229
     C                     MOVE 'GLJEN'   DBFILE                          S01229
     C                     MOVELBATCH     DBKEY
     C                     EXSR ERRSR
     C                     END
     C*
     C           CSC022    IFEQ 'N'                                                           CSC022
     C           CSC022    OREQ 'Y'                                                           CSC022
     C           WCMTSK    ANDEQ'N'                                                           CSC022
     C                     COMIT
     C                     ENDIF                                                              CSC022
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDIF                                          CGL016
      *                                                                   CGL016
     C*     Read next transaction record
     C*     READ DUMMY FILE FIRST IN CASE RECORD LOCK                     E19313
     C*
     C           BATCH     READE@BTXXX                   03               E19313
     C********** BATCH     READE@BTREBG                  03               E19313
     C  N03      BATCH     READE@BTREBG                  03               E19313
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C*                                                                  *
     C*     RETSR  SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Memos processing - (Retail)                                  *
     C*                                                                  *
     C********************************************************************
     C*
     C           RETSR     BEGSR
      *                                                                   CEU013
      ** Move alpha fields to numeric for call.                           CEU013
     C                     MOVE BTCUST    W0CNUM                          CEU013
     C                     MOVE BTACCD    W0ACCD                          CEU013
     C                     MOVE BTACSN    W0ACSQ                          CEU013
     C*                                                                   CEU013
     C* If switchable function CEU013 is installed, the batch is an       CEU013
     C*   interface batch, the item currency is an 'In' currency,         CEU013
     C*   the account may not be opened yet.  The call to AOMEMSU0        CEU013
     C*   issues a data base error if the record is not found.            CEU013
     C*   Hence the account is first verified before giving the           CEU013
     C*   call for update.                                                CEU013
     C*                                                                   CEU013
     C                     MOVE *BLANKS   W0RTCD                          CEU013
     C           CEU013    IFEQ 'Y'                                       CEU013
     C           BRTOJE    ANDEQ'I'                                       CEU013
     C           WKINCY    ANDEQ'Y'                                       CEU013
      ** Call Access Object AOMEMSR0                                      CEU013
     C                     CALL 'AOMEMSR0'                                CEU013
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CEU013
     C                     PARM '*VERIFY' W0OPTN  7        I:Option       CEU013
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCEU013
     C**********           PARM           W0CNUM  60       O:Customer No.              CEU013 CSD027
     C                     PARM           W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM BTCYCD    W0CUCD  3        O:Currency     CEU013
     C**********           PARM           W0ACCD  40       O:Account Code              CEU013 CGL029
     C                     PARM           W0ACCD 100       O:Account Code                     CGL029
     C                     PARM           W0ACSQ  20       O:Account Seq. CEU013
     C                     PARM BTIBCA    W0BRCA  3        O:Branch       CEU013
     C           DSMEMS    PARM *BLANKS   DSFDY                                               222373
     C           W0RTCD    IFEQ '*NRF   '                                 CEU013
     C                     MOVE 'Y'       WKRETL                          CEU013
     C                     ENDIF                                          CEU013
     C           W0RTCD    IFNE *BLANKS                                   CEU013
     C           W0RTCD    ANDNE'*NRF   '                                 CEU013
     C                     MOVE *BLANKS   W0RTCD                          CEU013
     C                     ENDIF                                          CEU013
     C                     ENDIF                                          CEU013
      *                                                                   CEU013
     C           W0RTCD    IFEQ *BLANKS                                   CEU013
     C*                                                                   CEU013
      *                                                                   CCB002
      ** If a credit transaction reverse the sign.                        CCB002
     C           BTDCIN    IFEQ 'C'                                       CCB002
     C                     Z-SUBBTPTAM    W0AMT                           CCB002
     C                     ELSE                                           CCB002
     C                     Z-ADDBTPTAM    W0AMT                           CCB002
     C                     ENDIF                                          CCB002
      *                                                                   CCB002
      ***Move*alpha*fields*to*numeric*for*call.                     CCB002CEU013
     C***********          MOVE BTCUST    W0CNUM                    CCB002CEU013
     C***********          MOVE BTACCD    W0ACCD                    CCB002CEU013
     C***********          MOVE BTACSN    W0ACSQ                    CCB002CEU013
     C/COPY OFCPYSRCZ,CGL135_094                                                             CGL135B
      *                                                                   CCB002
      ** Call Access Object AOMEMSU0                                      CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM           W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM           W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM BTCYCD    W0CUCD  3        O:Currency     CCB002
     C**********           PARM           W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM           W0ACCD           O:Account Code                     CGL029
     C                     PARM           W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM BTIBCA    W0BRCA  3        O:Branch       CCB002
     C/COPY OFCPYSRCZ,CGL135_095                                                             CGL135B
     C                     PARM BTPTDT    W0PSTD  50       O:Posting date CCB002
     C/COPY OFCPYSRCZ,CGL135_096                                                             CGL135B
     C                     PARM BTVLDT    W0VDAT  50       O:Value date   CCB002
     C                     PARM           W0AMT  150       O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV  1        O:FT override  CCB002
      *                                                                   CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C                     Z-ADD03        DBASE            * DB ERROR 03 *CCB002
     C                     MOVE 'MEMOS'   DBFILE                          CCB002
     C                     EXSR ERRSR                                     CCB002
     C                     ELSE                                           CCB002
     C                     MOVE 'Y'       UPDIND  1                       CCB002
     C                     END                                            CCB002
     C/COPY WNCPYSRC,GL4445C008
     C                     ENDIF                                          CEU013
      *                                                                   CCB002
      ** Redefine INDEX. This workfield was originally defined in         CCB002
      ** SR/ACCMSR but this subroutine has been replaced by the           CCB002
      ** AOMEMSU0 access object processing.                               CCB002
     C                     Z-ADD*ZERO     INDEX   10                      CCB002
     C***********                                                         CCB002
     C******Access Memos record                                           CCB002
     C***********                                                         CCB002
     C***********          EXSR ACCMSR                                    CCB002
     C***********                                                         CCB002
     C******Cleared balance update ((Value date <= Posting date))         CCB002
     C***********                                                         CCB002
     C***********BTVLDT    IFLE BTPTDT                                    CCB002
     C***********                                                         CCB002
     C***********BTDCIN    IFEQ 'D'                                       CCB002
     C***********          ADD  BTPTAM    CLBLN                           CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C***********BTDCIN    IFEQ 'C'                                       CCB002
     C***********          SUB  BTPTAM    CLBLN                           CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C******Ledger balance update                                         CCB002
     C***********                                                         CCB002
     C***********BTDCIN    IFEQ 'D'                                       CCB002
     C***********          ADD  BTPTAM    LDBLN                           CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C***********BTDCIN    IFEQ 'C'                                       CCB002
     C***********          SUB  BTPTAM    LDBLN                           CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C******Batch and item number update                                  CCB002
     C***********                                                         CCB002
     C*********************Z-ADDBATCH     BNLU                            S01229
     C***********          MOVE BATCH     BNLU                            CCB002
     C***********          Z-ADDBTBINB    INLU                            CCB002
     C***********                                                         CCB002
     C******Memos record update                                           CCB002
     C***********                                                         CCB002
     C***********          UPDATMEMOSMDF               06                 CCB002
     C***********                                                         CCB002
     C***********base error if update fails                               CCB002
     C***********                                                         CCB002
     C************IN06     IFEQ '1'                                       CCB002
     C***********          Z-ADD03        DBASE            * DB ERROR 03 *CCB002
     C***********          MOVE 'MEMOS'   DBFILE                          CCB002
     C***********          MOVELBTRRNM    DBKEY                           CCB002
     C***********          EXSR ERRSR                                     CCB002
     C***********          ELSE                                           CCB002
     C***********          MOVE 'Y'       UPDIND  1                       CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C                     ENDSR
     C*
     C********************************************************************
     C***********                                                        *CCB002
     C******ACCMSR SR     SUB-ROUTINE                                    *CCB002
     C***********                                                        *CCB002
     C******Access Memos record                                          *CCB002
     C***********                                                        *CCB002
     C********************************************************************
     C***********                                                         CCB002
     C***********ACCMSR    BEGSR                                          CCB002
     C***********                                                         CCB002
     C***If*BTRRNM = 0, use account details to chain to ACCNT and obtain  CCB002
     C***the*relative record number of the MEMOS record.account     100027CCB002
     C***Note*- BTRRNM will be blank only if the batch was input via an   CCB002
     C*******interface with status 'Accepted'. Interface batches should   CCB002
     C*******always be status 'Held' to allow Midas to validate/update on CCB002
     C*******acceptance; however, include this processing to cater for    CCB002
     C*******other possibilities.                                   100027CCB002
     C***********                                                   100027CCB002
     C***********BTRRNM    IFEQ 0                                   100027CCB002
     C***********          MOVELBTCUST    CNUM                      100027CCB002
     C***********          MOVELBTCYCD    CCY                       100027CCB002
     C***********          MOVELBTACCD    ACOD                      100027CCB002
     C***********          MOVELBTACSN    ACSQ                      100027CCB002
     C***********          MOVELBTIBCA    BRCA                      100027CCB002
     C***********@BTLST    CHAINACCNT                1112           100027CCB002
     C************IN11     IFEQ '0'                                 100027CCB002
     C************IN12     ANDEQ'0'                                 100027CCB002
     C***********          Z-ADDRRNM      BTRRNM                    100027CCB002
     C***********          END                                      100027CCB002
     C***********          END                                      100027CCB002
     C***********                                                   100027CCB002
     C***********          Z-ADD*ZERO     INDEX   10                      CCB002
     C***********                                                         CCB002
     C******Try*and retry to access record (five attempts)                CCB002
     C***********                                                         CCB002
     C***********INDEX     DOWLT5                                         CCB002
     C***********                                                         CCB002
     C***********BTRRNM    CHAINMEMOS                0506                 CCB002
     C***********                                                         CCB002
     C************IN05     IFEQ '1'                                       CCB002
     C***********          Z-ADD5         INDEX                           CCB002
     C***********          ELSE                                           CCB002
     C************IN06     IFEQ '0'                                       CCB002
     C***********          Z-ADD5         INDEX                           CCB002
     C***********          ELSE                                           CCB002
     C***********          ADD  1         INDEX                           CCB002
     C***********          END                                            CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C******Data*base error if all attempts unsuccessful                  CCB002
     C***********                                                         CCB002
     C************IN05     IFEQ '1'                                       CCB002
     C************IN06     OREQ '1'                                       CCB002
     C***********          Z-ADD04        DBASE            * DB ERROR 04 *CCB002
     C***********          MOVE 'MEMOS'   DBFILE                          CCB002
     C***********          MOVELBTRRNM    DBKEY                           CCB002
     C***********          EXSR ERRSR                                     CCB002
     C***********          END                                            CCB002
     C***********                                                         CCB002
     C***********          ENDSR                                          CCB002
     C***********                                                         CCB002
     C********************************************************************
     C*                                                                  *
     C*     PROSR  SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Prono processing - (Nostro)                                  *
     C*                                                                  *
     C********************************************************************
     C*
     C           PROSR     BEGSR
     C*
     C*     Access Prono record
     C*
     C                     EXSR ACCPSR
     C*
     C                     Z-ADD1         X       10
     C**
     C**   Set up next working day in loan CCY
     C**
     C                     MOVE BTCYCD    ZCCY
     C           PRD,5     ADD  1         ZDAYNO
     C                     Z-ADD0         ZNRDYS                          S01195
     C**                                                                  S01195
     C*    Access nostro details                                          S01195
     C**                                                                  S01195
     C                     CALL 'AONOSTR0'PLIST1                          S01194
     C*                                                                   S01195
     C           P@RTCD    IFNE *BLANK                       * DBERR 14 * S01195
     C* Ignore the error if CEU013 is installed, the batch is from        CEU013
     C*  an external interface and the currency is an 'In' currency.      CEU013
     C*                                                                   CEU013
     C           CEU013    IFNE 'Y'                                       CEU013
     C           BRTOJE    ANDNE'I'                                       CEU013
     C           WKINCY    ANDNE'Y'                                       CEU013
     C                     MOVE 'SDNOSTPD'DBFILE                          S01195
     C                     MOVE 'NOSKEY'  DBKEY                           S01195
     C                     Z-ADD14        DBASE                           S01195
     C                     EXSR ERRSR                                     S01195
     C                     ELSE                                           CEU013
     C                     MOVE 'Y'       WKNOST                          CEU013
     C                     ENDIF                                          CEU013
     C                     ELSE                                           S01195
     C*********************MOVE A7CSSN    ZLOC    3                S01195 S01229
     C                     MOVE A7NOSN    ZLOC    3                S01195 S01229
     C                     END                                            S01195
     C*                                                                   CEU013
     C* If CEU013 switchable function is installed, Nostro account is     CEU013
     C*   not found, the batch is from external interface and the         CEU013
     C*   currency is an 'In' currency, then the remaining checks are     CEU013
     C*   not carried out.                                                CEU013
     C*                                                                   CEU013
     C           P@RTCD    IFEQ *BLANK                                    CEU013
     C*                                                                   092161
     C*   Output database error message if error occurs - ignore condition092161
     C*   where nostro record not found on PRONO, as nostro may have      092161
     C*   been set up today.                                              092161
     C           PRNERR    IFEQ 'Y'                                       092161
     C           A7LCD     IFNE RDATE                                     092161
     C           A7TYLC    ORNE 'I'                                       092161
     C                     Z-ADD06        DBASE            * DB ERROR 06 *092161
     C                     MOVE 'PRONO'   DBFILE                          092161
     C                     MOVELPROERR    DBKEY                           092161
     C                     EXSR ERRSR                                     092161
     C                     END                                            092161
     C**********           END                                     092161 136184
      *                                                                   192335
      ** If Nostro record is found in PRONOPN, continue processing.       192335
      *                                                                   192335
     C                     ELSE                                           192335
     C*                                                                   092161
     C*************        MOVE 'Y'       ZOPT                            S01195
     C*************        EXSR ZDATE5                                    S01195
     C*************        EXSR ZFWDT                                                S01195 MD027654
     C*************        Z-ADDZDYNBR    PNDS    50                                        MD027654
     C**
     C********** BTVLDT    IFLT PNDS                                                        MD027654
     C/COPY WNCPYSRC,GL4445C002
     C*
     C***********BTVLDT    LOKUPPRD,X                  0909               042757
     C*                                                                   042757
     C** Access the date 'equal to' or 'greater than' the value date      042757
     C*                                                                   042757
     C********** BTVLDT    LOKUPPRD,X                09  09                          042757 MD027654
     C**********                                                                            MD027654
     C******Array pointer would be positioned at:                                           MD027654
     C**********                                                                            MD027654
     C******Equal element     - When an *EQ is on                                           MD027654
     C******Greater than element - When *EQ is off and *HI is on                     042757 MD027654
     C******First element     - When both *EQ & *HI are off                          042757 MD027654
     C******Less*than element*-*When**EQ*is*off*and**LO*is*on**********              042757 MD027654
     C******First*element*****-*When*both**EQ*&**LO*are*off************              042757 MD027654
     C**********                                                                            MD027654
     C********** X         DOWLT6                                                           MD027654
     C**********                                                                            MD027654
     C********** BTDCIN    IFEQ 'D'                                                         MD027654
     C**********           ADD  BTPTAM    PRB,X                                             MD027654
     C**********           END                                                              MD027654
     C**********                                                                            MD027654
     C********** BTDCIN    IFEQ 'C'                                                         MD027654
     C**********           SUB  BTPTAM    PRB,X                                             MD027654
     C**********           END                                                              MD027654
     C**********                                                                            MD027654
     C**********           ADD  1         X                                                 MD027654
     C**********           END                                                              MD027654
     C/COPY WNCPYSRC,GL4445C003
     C*
     C                     MOVE 'Y'       UPDIND
     C                     MOVE 'Y'       NOSIND  1
     C**********           END                                                              MD027654
     C                     ENDIF                                          CEU013
     C/COPY WNCPYSRC,GL4445C004
     C*
     C*     Prono record update
     C*
     C***********          UPDATPRONOPNF               08                 092161
     C**N07*****           UPDATPRONOPNF               08                            092161 MD027654
     C           *IN07     IFEQ *OFF                                                        MD027654
      *                                                                                     MD027654
     C                     MOVELBTCYCD    NOSKEY  5                                         MD027654
     C                     MOVE BTNNBI    NOSKEY                                            MD027654
     C                     MOVELNOSKEY    PPRKEY                                            MD027654
     C                     MOVELBTVLDT    PVDAT                                             MD027654
     C**********           MOVELBTPTAM    PAMT                                     MD027654 MD028278
     C           BTDCIN    IFEQ 'D'                                                         MD028278
     C                     Z-ADDBTPTAM    PAMT                                              MD028278
     C                     ELSE                                                             MD028278
     C           BTDCIN    IFEQ 'C'                                                         MD028278
     C                     Z-SUBBTPTAM    PAMT                                              MD028278
     C                     ENDIF                                                            MD028278
     C                     ENDIF                                                            MD028278
      *                                                                                     MD027654
     C                     CALL 'AOPRONU0'                                                  MD027654
     C                     PARM *BLANKS   PRTCD   7                                         MD027654
     C                     PARM           PPRKEY  8                                         MD027654
     C                     PARM           PVDAT   50                                        MD027654
     C                     PARM           PAMT   150                                        MD027654
     C*
     C*     Data base error if update fails
     C*
     C********** *IN08     IFEQ '1'                                                         MD027654
     C           PRTCD     IFNE *BLANKS                                                     MD027654
     C                     Z-ADD05        DBASE            * DB ERROR 05 *
     C                     MOVE 'PRONO'   DBFILE
     C                     MOVELPROERR    DBKEY
     C                     EXSR ERRSR
     C**********           END                                                              MD027654
     C                     ENDIF                                                            MD027654
     C                     ENDIF                                                            MD027654
     C/COPY WNCPYSRC,GL4445C005
     C*
     C                     END                                            136184
     C                     ENDSR
     C*
     C/COPY WNCPYSRC,GL4445C013
     C********************************************************************
     C*                                                                  *
     C*     ACCPSR SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Access Prono record                                          *
     C*                                                                  *
     C********************************************************************
     C*
     C           ACCPSR    BEGSR
     C*
     C                     Z-ADD*ZERO     INDEX
     C                     MOVE BTCYCD    KCCY
     C                     MOVE BTNNBI    KNNO
     C*
     C*     Try and retry to access record (five attempts)
     C*
     C           INDEX     DOWLT5
     C*
     C           PROKEY    CHAINPRONOPNF             0708
     C*
     C           *IN07     IFEQ '1'
     C                     Z-ADD5         INDEX
     C                     ELSE
     C           *IN08     IFEQ '0'
     C                     Z-ADD5         INDEX
     C                     ELSE
     C                     ADD  1         INDEX
     C                     END
     C                     END
     C*
     C                     END
     C*
     C*     Data base error if Prono record found -  but locked
     C*
     C           *IN08     CABEQ'1'       PDBERR
     C*
     C*     If Prono record not found -  try for an unallocated nostro
     C*
     C           *IN07     IFEQ '1'
     C           RECI      ORNE 'D'
     C*
     C                     Z-ADD*ZERO     INDEX
     C                     Z-ADD*ZEROS    KNNO
     C*
     C*     Try and retry to access record (five attempts)
     C*     Set on *IN07 if record not found, or *IN08 if an error occurs 092161
     C*
     C           INDEX     DOWLT5
     C*
     C           PROKEY    CHAINPRONOPNF             0708
     C*
     C*     If record not on file, exit loop                              092161
     C           *IN07     IFEQ '1'
     C                     Z-ADD5         INDEX
     C                     ELSE
     C*                                                                   092161
     C*     If correct record found, exit loop                            092161
     C           *IN08     IFEQ '0'
     C                     Z-ADD5         INDEX
     C/COPY WNCPYSRC,GL4445C014
     C*                                                                   092161
     C*     else retry                                                    092161
     C                     ELSE
     C                     ADD  1         INDEX
     C                     END
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C           PDBERR    TAG
     C*
     C******Data*base*error if all attempts unsuccessful                  092161
     C*
     C********** *IN07     IFEQ '1'                                       092161
     C********** *IN08     OREQ '1'                                       092161
     C***********RECI      ORNE 'D'                                       092161
     C***********          Z-ADD06        DBASE            * DB ERROR 06 *092161
     C***********          MOVE 'PRONO'   DBFILE                          092161
     C***********          MOVELPROERR    DBKEY                           092161
     C***********          EXSR ERRSR                                     092161
     C*                                                                   092161
     C*     Set up Nostro Error flag if error occurred                    092161
     C*     If record not on file (i.e. nostro has been set up today)     092161
     C*     do NOT set up error flag.                                     092161
     C                     MOVE ' '       PRNERR                          092161
     C           *IN08     IFEQ '1'                                       092161
     C                     MOVE 'Y'       PRNERR  1                       092161
     C                     END
     C*
     C                     ENDSR
     C*                                                                   108484
     C*****************************************************************   108484
     C*                                                               *   108484
     C*     OLPSR  SR     SUB-ROUTINE                                 *   108484
     C*                                                               *   108484
     C*     On Line Position Processing (only for Spot Trade Account) *   108484
     C*                                                               *   108484
     C*****************************************************************   108484
     C*                                                                   108484
     C           OLPSR     BEGSR                                          108484
     C*                                                                   108484
     C**  Set up parameters for access object                             108484
     C*                                                                   108484
     C                     MOVEL*BLANKS   R#RTN   7                       108484
     C*                                                                   108484
     C                     MOVEL*BLANKS   WRK8    8                       108484
     C                     MOVEL*BLANKS   WRK6    6                       108484
     C                     MOVELBTIBCA    WRK6                            108484
     C                     MOVE BTCYCD    WRK6                            108484
     C                     MOVELWRK6      WRK8                            108484
     C                     MOVE '01'      WRK8                            108484
     C*                                                                   108484
     C                     MOVEL*BLANKS   WRK1    1                       108484
     C           BTDCIN    IFEQ 'C'                                       108484
     C                     MOVEL'I'       WRK1                            108484
     C                     ELSE                                           108484
     C                     MOVEL'O'       WRK1                            108484
     C                     ENDIF                                          108484
     C*                                                                   108484
     C**  Update On Line Position                                         108484
     C*                                                                   108484
     C                     CALL 'AOOLPSU0'             9090               108484
     C           R#RTN     PARM *BLANKS   O#RTN   7        B: Return code 108484
     C                     PARM WRK8      O#KOLP  8        I: Olpos key   108484
     C                     PARM BTVLDT    O#VDAT  50       I: Value date  108484
     C                     PARM BTPTAM    O#AMT  150       I: Post amount 108484
     C                     PARM WRK1      O#IO    1        I: In/Out      108484
     C*                                                                   108484
     C           *IN90     IFEQ '1'                                       108484
     C           R#RTN     ORNE *BLANKS                                   108484
     C                     MOVEL'*CALL   'DBFILE           ***************108484
     C                     MOVEL'AOOLPSU0'DBKEY            * DB ERROR 16 *108484
     C                     Z-ADD16        DBASE            ***************108484
     C                     EXSR ERRSR                                     108484
     C                     END                                            108484
     C*                                                                   108484
     C                     ENDSR                                          108484
     C*                                                                   108484
     C********************************************************************
     C*******************                                                 S01195
     C*****ZDATE5*SR.*TO*DETERMINE IF A DAY NUMBER DATE IS A HOLIDAY      S01195
     C****************IN*GIVEN CURRENCY, AND, IF DAY IS A HOLIDAY         S01195
     C****************AND IF REQUIRED, DETERMINE NEXT WORKING DAY.        S01195
     C***************                                                     S01195
     C***********ZDATE5    BEGSR                           ***  ZDATE5 ***S01195
     C***************                                                     S01195
     C*****CALCULATIONS TO DEFINE INPUT FIELDS.                           S01195
     C***************      Z-ADDZDAYNO    ZDAYNO  50                      S01195
     C***************      MOVE ZCCY      ZCCY    3                       S01195
     C***************      MOVE ZOPT      ZOPT    1                       S01195
     C***************                                                     S01195
     C*****CALCULATIONS TO DEFINE/CLEAR WORKFIELDS.                       S01195
     C***************      MOVE '   '     ZHC                             S01195
     C**************                                                      S01195
     C*****RESET*INDICATOR.                                               S01195
     C*************        SETOF                     99                   S01195
     C*************                                                       S01195
     C*****CALCULATION TO DEFINE/SET OUTPUT FIELD.                        S01195
     C*************        Z-ADDZDAYNO    ZDYNBR  50                      S01195
     C*************                                                       S01195
     C*****DETERMINE IF HOLIDAY                                           S01195
     C***********ZDHOL     TAG                             ***  ZDHOL  ***S01195
     C*************        SETOF                     91                   S01195
     C*************                                                       S01195
     C*****SET*KEY*FOR FIRST HOLIDAY RECORD.                              S01195
     C*************        MOVEL'22      'ZTABKY 12                       S01195
     C*************        MOVELZDYNBR    ZWRK6   6                       S01195
     C*************        MOVE '1'       ZWRK6                           S01195
     C************         MOVE ZWRK6     ZTABKY                          S01195
     C************                                                        S01195
     C*****CHAIN*FOR HOLIDAY RECORD, RECORD 1 OR 2.                       S01195
     C***********ZDHCH5    TAG                             ***  ZDHCH5 ***S01195
     C********** ZTABKY    CHAINTABLETJF             90    ON NOT THERE   S01195
     C**N90***** RECI      COMP 'D'                  9090  DELETED        S01195
     C***********                                                         S01195
     C*****STORE*CURRENCIES IF RECORD FOUND.                              S01195
     C**N90N91***          MOVEAHCCY      ZHC,1                           S01195
     C***91N90***          MOVEAHCCY      ZHC,26                          S01195
     C***********                                                         S01195
     C*****GET*SECOND RECORD, IF NOT ALREADY DONE.                        S01195
     C**********           MOVE ZTABKY    ZWRK1N  10                      S01195
     C********** ZWRK1N    COMP 1                        91               S01195
     C**********           MOVE '2'       ZTABKY                          S01195
     C***91N90**           GOTO ZDHCH5                                    S01195
     C**********                                                          S01195
     C*****BYPASS*TO END IF NO FIRST RECORD FOUND.                        S01195
     C***90*91****         GOTO ZDEND5                                    S01195
     C***********                                                         S01195
     C*****DETERMINE HOLIDAY RECORD TYPE.                                 S01195
     C***********INEX      COMP 'E'                      92               S01195
     C***********INEX      COMP 'I'                      93               S01195
     C***********                                                         S01195
     C*****CHECK*IF CURRENCY ON HOLIDAY.                                  S01195
     C***********ZCCY      LOKUPZHC                      94               S01195
     C************                                                        S01195
     C*****BYPASS*TO END IF NOT HOLIDAY FOR CURRENCY.                     S01195
     C***92*94***                                                         S01195
     C*OR*93N94**           GOTO ZDEND5                                   S01195
     C************                                                        S01195
     C*****SET*INDICATOR FOR HOLIDAY FOR DAY NUMBER.                      S01195
     C************         SETON                     99                   S01195
     C***********                                                         S01195
     C***********                                                         S01195
     C*****CHECK*IF NEXT WORKING DAY REQUIRED.                            S01195
     C***********ZOPT      COMP 'Y'                      95               S01195
     C***95******ZDYNBR    ADD  1         ZDYNBR                          S01195
     C***95******          GOTO ZDHOL                                     S01195
     C************                                                        S01195
     C************                                                        S01195
     C***********ZDEND5    ENDSR                           ***  ZDEND5 ***S01195
     C***********                                                         S01195
     C***********                                                         S01195
     C***********                                                         S01195
     C********************************************************************
     C*                                                                  *
     C*     RSACSR SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Shadow postings to RSACMTPD                                  *
     C*                                                                  *
     C********************************************************************
     C*
     C           RSACSR    BEGSR
     C*
     C***** For*unallocated*nostros*initialise*account*key***                               BUG12777
     C*
      ***Do*not*write*unallocated*nostros****                                    BUG12777  BUG12777A
      *                                                                                     BUG12777
     C********** NOSIND    IFEQ 'Y'                                                         BUG12777
     C********** NOSN      ANDEQ*ZEROS                                                      BUG12777
     C*
     C**********           Z-ADD*ZEROS    CUSN                                                CSD027
     C**********           MOVE *BLANKS   CUSN                                       CSD027 BUG12777
     C**********           Z-ADD*ZEROS    ACDE                                              BUG12777
     C**********           Z-ADD*ZEROS    ASNC                                              BUG12777
     C**********           MOVE *BLANKS   BRCA                            BHF515            BUG12777
     C**********           ELSE                                                             BUG12777
     C********** NOSIND    IFNE 'Y'                                               BUG12777 BUG12777A
     C********** NOSIND    OREQ 'Y'                                               BUG12777 BUG12777A
     C********** NOSN      ANDNE*ZEROS                                            BUG12777 BUG12777A
     C*                                                                                    BUG12777A
     C*     For unallocated nostros use details from SDNOSTPD                              BUG12777A
     C*                                                                                    BUG12777A
     C           NOSIND    IFEQ 'Y'                                                        BUG12777A
     C           NOSN      ANDEQ*ZEROS                                                     BUG12777A
     C*                                                                                    BUG12777A
     C                     MOVE A7CUST    CUSN                                             BUG12777A
     C                     MOVE A7ACCD    ACDE                                             BUG12777A
     C                     MOVE A7ACSN    ASNC                                             BUG12777A
     C                     MOVE A7BRCD    BRCA                                             BUG12777A
     C                     ELSE                                                            BUG12777A
     C                     MOVE BTCUST    CUSN
     C                     MOVE BTACCD    ACDE
     C*********************MOVE BTASNB    ASNC                            S01194
     C                     MOVE BTACSN    ASNC                            S01194
     C                     MOVE BTIBCA    BRCA                            BHF515
     C*
     C**********           END                                                              BUG12777
     C                     END                                                             BUG12777A
     C*
     C                     MOVE BTCYCD    CCYD
     C                     Z-ADDRDATE     PTDT
     C/COPY OFCPYSRCZ,CGL135_097                                                             CGL135B
     C                     Z-ADDBTVLDT    VUDT
     C                     MOVE 'ME'      TRYP
     C/COPY WNCPYSRC,GL4445C001
     C*********************MOVE BTNRCD    NRTC                            S01194
     C                     MOVE BTNVCD    NRTC                            S01194
     C                     MOVE BTNRDC    NRTD
     C/COPY WNCPYSRC,GLH00504
     C                     Z-ADD*ZEROS    WTRN    60                      BHF675
     C*********************Z-ADDBTBTNB    WTRN    60                      S01229
     C***********          MOVE BTBTNB    WTRN    60                S01229BHF674
     C                     MOVELBTBTNB    WTRN    60                      BHF674
     C                     ADD  BTBINB    WTRN
     C                     MOVE WTRN      TNMR
     C/COPY WNCPYSRC,GLH00505
     C*                                                                   S01413
     C* Set up Trans. number with Batch number in first 3                 S01413
     C* digits, and Batch item number in last 3 digits                    S01413
     C                     MOVELBTBTNB    WBNUM                           S01413
     C                     Z-ADDBTBINB    #BINB   30                      S01413
     C                     MOVE #BINB     WBINB                           S01413
     C                     MOVELWTRNM     TNMR                            S01413
     C                     MOVE BTCQNB    CQNR
     C                     Z-ADDBTPTAM    MVAM
     C*
     C           BTDCIN    IFEQ 'D'
     C                     Z-ADD*ZERO     DORC
     C                     END
     C*
     C           BTDCIN    IFEQ 'C'
     C                     Z-ADD1         DORC
     C                     END
      *                                                                                       239830
      ** Initialise usused zone fields in RSACMTPD that are causing decimal data errors       239830
      *                                                                                       239830
     C                     Z-ADD0         ACDEQQ           ZONE  4,0                          239830
     C                     Z-ADD0         XRFN             ZONE 10,0                          239830
      *                                                                                       CAP205
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVEL'GL'      CMOD                                                CAP205
     C                     MOVEL'S'       MTYP                                                CAP205
     C                     ELSE                                                               CAP205
     C                     MOVEL*BLANKS   CMOD                                                CAP205
     C                     MOVEL*BLANKS   MTYP                                                CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CAP207
     C                     CALL 'GL006001'                                                    CAP207
     C                     PARM           BTPDID                                              CAP207
      *                                                                                       CAP207
      *                                                                                       CAP205
     C*
     C/COPY WNCPYSRC,GL4445C010
     C                     WRITERSACMTPO               10
      *                                                                                       CGL029
      ** Set up the Account Identifier                                                        CGL029
      *                                                                                       CGL029
     C**********           Z-ADDCNUM      W#CNUM                                       CGL029 CSD027
     C                     MOVE CNUM      W#CNUM                                              CSD027
     C                     MOVE CCY       W#CCY                                               CGL029
     C                     Z-ADDACDE      W#ACOD                                              CGL029
     C                     Z-ADDASNC      W#ACSQ                                              CGL029
     C                     MOVE RSBRCA    W#BRCA                                              CGL029
     C*
     C*     Data base error if write fails
     C*
     C           *IN10     IFEQ '1'
     C                     Z-ADD07        DBASE            * DB ERROR 07 *
     C                     MOVE 'RSACM'   DBFILE
     C                     MOVEL'ON WRITE'DBKEY
     C                     EXSR ERRSR
     C                     ELSE
      *                                                                   CDE001
      * Data export for CCRM - Limits                                     CDE001
      *                                                                   CDE001
     C           CDE001    IFEQ 'Y'                                       CDE001
     C           NOSIND    IFNE 'Y'                                       CDE001
     C           NOSN      ORNE *ZEROS                                    CDE001
     C                     MOVELBRCA      RSBRCA                          CDE001
     C                     MOVELW#ACID    T#TREF                          CDE001
      *                                                                   CDE005
     C           CDE005    IFEQ 'Y'                                       CDE005
     C                     MOVE BTNRDC    T#RSRV                          CDE005
     C                     ENDIF                                          CDE005
      *                                                                   CDE005
     C                     CALL 'DEWTTRIG'                                CDE001
     C**********           PARM           T#TREF 20                                    CDE001 CGL029
     C                     PARM           T#TREF 26                                           CGL029
     C                     PARM 'ACCT'    T#TCAT  4                       CDE001
     C                     PARM           T#RSRV 10                       CDE005
     C                     ENDIF                                          CDE001
     C                     ENDIF                                          CDE001
     C**********           MOVE 'N'       NOSIND                                            BUG12777
     C                     MOVE 'N'       NOSIND                                           BUG12777A
     C                     END
     C**********           ENDIF                                                  BUG12777 BUG12777A
     C**********           MOVE 'N'       NOSIND                                  BUG12777 BUG12777A
     C/COPY WNCPYSRC,GL4445C009
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C*                                                                  *
     C*     INITSR SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Program initialisation                                       *
     C*                                                                  *
     C********************************************************************
     C*
     C           INITSR    BEGSR
     C                     MOVEACPY@      BIS@   80
     C*
     C*     Accept batch number
     C*
     C           *ENTRY    PLIST
     C                     PARM           PARAM   3
     C*
     C*     Move alpha parameter to numeric key field
     C*
     C*********************MOVE PARAM     BATCH   30                      S01229
     C                     MOVE PARAM     BATCH   3                       S01229
     C*
     C*     Setup program name for reporting DB errors
     C*
     C                     MOVE 'GL4445'  DBPGM
     C*
     C*     Accept run date
     C*
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
     C                     Z-ADDEJNB      RDATE   50
      *                                                                                       182086
      **  Initialise ZDAYNO to prevent Decimal Data Error                                     182086
      *                                                                                       182086
     C                     Z-ADD0         ZDAYNO                                              182086
      *                                                                                       182086
     C***********                                                   E19359CCB002
     C******OPEN PF/MEMOS IF RETAIL 2 IS PRESENT                    E19359CCB002
     C***********                                                   E19359CCB002
     C************NAMVAR   DEFN           MMOD                      E19359CCB002
     C***********          IN   MMOD                                E19359CCB002
     C***********RETF      IFEQ 'Y'                                 E19359CCB002
     C***********          OPEN MEMOS                               E19359CCB002
     C***********          END                                      E19359CCB002
     C*
     C*     Set up Prono key
     C*
     C           PROKEY    KLIST
     C                     KFLD           KCCY    3
     C                     KFLD           KNNO    20
     C/COPY OFCPYSRCZ,CGL135_098                                                             CGL135B
     C*
     C******Set up Accnt key                                        100027CCB002
     C***********                                                   100027CCB002
     C***********@BTLST    KLIST                                    100027CCB002
     C***********          KFLD           CNUM                      100027CCB002
     C***********          KFLD           CCY                       100027CCB002
     C***********          KFLD           ACOD                      100027CCB002
     C***********          KFLD           ACSQ                      100027CCB002
     C***********          KFLD           BRCA                      100027CCB002
     C***********                                                   100027CCB002
      *                                                                                      241672A
      ** Access dataarea to get the number of CHAIN-retries and delay wait                   241672A
      *                                                                                      241672A
     C           *NAMVAR   DEFN GLJENDTA  GLHDET                                             241672A
     C                     IN   GLHDET                 23                                    241672A
     C                     UNLCKGLHDET                                                       241672A
      *                                                                                      241672A
     C                     MOVE GH4RTY    X#RTY   50                                         241672A
     C                     MOVE GH4WAT    X#WAIT  60                                         241672A
     C                     Z-ADDX#RTY     W#RTY   50                                         241672A
     C                     MOVE '000000'  W#WAIT  6                                          241672A
     C                     MOVE X#WAIT    W#WAIT                                             241672A
      *                                                                                      241672A
      ** If error occurs on data area access, not found                                      241672A
      ** or not yet initialised                                                              241672A
      *                                                                                      241672A
     C           *IN23     IFEQ '1'                                                          241672A
     C           GH4RTY    OREQ *BLANKS                                                      241672A
     C           GH4WAT    ANDEQ*BLANKS                                                      241672A
     C                     Z-ADD2         W#RTY                                              241672A
     C                     MOVE '000000'  W#WAIT                                             241672A
     C                     MOVE 2         W#WAIT                                             241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C                     MOVE 'N'       GLHLCK  1                                          241672A
     C                     Z-ADD*ZEROS    W#RIED  50                                         241672A
     C                     Z-ADD*ZEROS    W#LOOP  50                                         241672A
     C                     MOVE '0'       *IN22                                              241672A
     C                     MOVE '0'       *INU3                                              241672A
      *                                                                                      241672A
     C           *IN22     DOUEQ'0'                                                          241672A
     C           W#RIED    ORGT W#RTY                                                        241672A
     C           W#LOOP    ORGT 200                                                          241672A
      *                                                                                      241672A
     C*     Access batch header
     C*
     C***********BATCH*****CHAINGLBRREL0             01                   S01229
     C********** BATCH     CHAINGLJENHL0             01                                S01229 236197
     C********** BATCH     CHAINGLJENHL5             01                               236197 241672A
     C           BATCH     CHAINGLJENHL5             0122                                    241672A
     C*
      ** Check if record locked to another job, wait and retry                               241672A
      **   Delay job if needed                                                               241672A
      **   Retry CHAIN after specified times                                                 241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '1'                                                          241672A
     C           GLHST     ANDEQ01218                                                        241672A
     C           W#RIED    ANDLTW#RTY                                                        241672A
     C                     MOVE 'Y'       GLHLCK                                             241672A
      *                                                                                      241672A
     C           W#WAIT    IFNE '000000'                                                     241672A
     C           W#WAIT    ANDNE'      '                                                     241672A
     C                     CALL 'GLDLY2'                                                     241672A
     C                     PARM           W#WAIT                                             241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
      ** Other database error occurred, end program and dump                                 241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '1'                                                          241672A
     C           GLHST     ANDNE01218                                                        241672A
     C                     Z-ADD22        DBASE            * DB ERROR 22 *                   241672A
     C                     MOVEL'GLJENHL0'DBFILE                                             241672A
     C                     MOVELBATCH     DBKEY                                              241672A
     C                     EXSR ERRSR                                                        241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C                     ADD  1         W#RIED                                             241672A
     C                     ADD  1         W#LOOP                                             241672A
     C                     ENDDO                                                             241672A
      *                                                                                      241672A
      ** Terminate program if number of retries has been reached                             241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '1'                                                          241672A
     C           GLHST     ANDEQ01218                                                        241672A
     C                     MOVE '1'       *INU3                                              241672A
     C                     Z-ADD23        DBASE            * DB ERROR 23 *                   241672A
     C                     MOVEL'GLJENHL0'DBFILE                                             241672A
     C                     MOVELBATCH     DBKEY                                              241672A
     C                     EXSR ERRSR                                                        241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '0'                                                          241672A
     C                     MOVE 'N'       GLHLCK                                             241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C*     Data base error if batch not found
     C*
     C           *IN01     IFEQ '1'
     C                     Z-ADD08        DBASE            * DB ERROR 08 *
     C                     MOVE 'GLBRL'   DBFILE
     C                     MOVELBATCH     DBKEY
     C                     EXSR ERRSR
     C                     ELSE
     C*
     C*     Data base error if batch is in use
     C*
     C           BRBIUF    IFEQ 'Y'
     C                     Z-ADD09        DBASE            * DB ERROR 09 *
     C                     MOVE 'GLBRL'   DBFILE
     C                     MOVELBATCH     DBKEY
     C                     MOVE '*IN USE*'DBKEY
     C                     EXSR ERRSR
     C                     END
     C*
     C*     Data base error if batch is already posted
     C*
     C           BRSHPI    IFEQ 'Y'
     C                     Z-ADD10        DBASE            * DB ERROR 10 *
     C                     MOVE 'GLBRL'   DBFILE
     C                     MOVELBATCH     DBKEY
     C                     MOVE '*POSTED*'DBKEY
     C                     EXSR ERRSR
     C                     END
     C*
     C                     END
     C*
     C*     Update batch header (to show that it is in use)
     C*
     C***********          MOVE '***'     BRWSID                          S01413
     C***********          MOVE '**'      BRWSID                    S01413078325
     C                     MOVE 'Y'       BRBIUF
     C                     MOVEL'GLC445'  BRWSID                                             BUG7459
     C                     UPDAT@BRREAG                02
     C*
     C*     Data base error if update fails
     C*
     C           *IN02     IFEQ '1'
     C                     Z-ADD11        DBASE            * DB ERROR 11 *
     C                     MOVE 'GLBRL'   DBFILE
     C                     MOVELBATCH     DBKEY
     C                     EXSR ERRSR
     C                     END
     C*                                                                   CEU013
     C**  Access SAR details file to see if CEU013 is installed.          CEU013
     C*                                                                   CEU013
     C                     CALL 'AOSARDR0'                                CEU013
     C                     PARM '       ' @RTCD   7                       CEU013
     C                     PARM '*VERIFY' @OPTN   7                       CEU013
     C                     PARM 'CEU013'  WSARD   6                       CEU013
     C*                                                                   CEU013
     C           @RTCD     IFEQ *BLANK                                    CEU013
     C                     MOVE 'Y'       CEU013  1                       CEU013
     C                     ELSE                                           CEU013
     C                     MOVE 'N'       CEU013                          CEU013
     C                     ENDIF                                          CEU013
     C                     MOVE *BLANKS   WKINCY  1        'In' Currency  CEU013
     C                     MOVE *BLANKS   WKCYCD  3        Saved currency CEU013
      *                                                                   CDE001
      ** Determine if Data Export for CCRM Limits is active               CDE001
      *                                                                   CDE001
     C                     CALL 'AOSARDR0'                                CDE001
     C                     PARM *BLANKS   @RTCD                           CDE001
     C                     PARM '*VERIFY' @OPTN                           CDE001
     C                     PARM 'CDE001'  WSARD                           CDE001
      *                                                                   CDE001
     C           @RTCD     IFEQ *BLANK                                    CDE001
     C                     MOVE 'Y'       CDE001  1                       CDE001
     C                     ENDIF                                          CDE001
      *                                                                   CDE001
      ** Determine if Data Export - Reservation ID is active              CDE005
      *                                                                   CDE005
     C                     CALL 'AOSARDR0'                                CDE005
     C                     PARM *BLANKS   @RTCD                           CDE005
     C                     PARM '*VERIFY' @OPTN                           CDE005
     C                     PARM 'CDE005'  WSARD                           CDE005
      *                                                                   CDE005
     C           @RTCD     IFEQ *BLANK                                    CDE005
     C                     MOVE 'Y'       CDE005  1                       CDE005
     C                     ENDIF                                          CDE005
      *                                                                   CDE005
      ** Access SAR Details for Projected Movements Update Prior to Auth. CGL016
      *                                                                   CGL016
     C                     MOVEL'N'       CGL016  1                       CGL016
     C                     CALL 'AOSARDR0'                                CGL016
     C                     PARM *BLANKS   @RTCD                           CGL016
     C                     PARM '*VERIFY' @OPTN                           CGL016
     C                     PARM 'CGL016'  @SARD   6                       CGL016
     C           SCSARD    PARM SCSARD    DSFDY                           CGL016
      *                                                                   CGL016
     C           @RTCD     IFEQ *BLANK                                    CGL016
     C                     MOVEL'Y'       CGL016                          CGL016
     C                     ENDIF                                          CGL016
      *                                                                   CGL016
      ** Access SAR details file to determine if CSC022 switchable feature                    CSC022
      ** is switched on                                                                       CSC022
      *                                                                                       CSC022
     C                     MOVE 'N'       CSC022  1                                           CSC022
     C                     MOVE 'N'       WCMTSK  1                                           CSC022
      *                                                                                       CSC022
     C                     CALL 'AOSARDR0'                                                    CSC022
     C                     PARM *BLANKS   @RTCD                                               CSC022
     C                     PARM '*VERIFY' @OPTN                                               CSC022
     C                     PARM 'CSC022'  WSARD                                               CSC022
     C           SCSARD    PARM SCSARD    DSFDY                                               CSC022
      *                                                                                       CSC022
     C           @RTCD     IFEQ *BLANKS                                                       CSC022
     C                     MOVE 'Y'       CSC022                                              CSC022
     C                     MOVE 'N'       WCMTSK                                              CSC022
      *                                                                                       CSC022
     C                     IN   WDSJOB                                                        CSC022
      *                                                                                       CSC022
     C           WCMTNO    IFGT 0                                                             CSC022
     C                     MOVEAWCJOBS    WCMT                                                CSC022
     C                     Z-ADD1         I       20                                          CSC022
      *                                                                                       CSC022
     C           ##JOB     LOKUPWCMT,I                   50                                   CSC022
     C           *IN50     IFEQ *ON                                                           CSC022
     C                     MOVE 'Y'       WCMTSK                                              CSC022
     C                     ENDIF                                                              CSC022
     C                     ENDIF                                                              CSC022
      *                                                                                       CSC022
     C                     ELSE                                                               CSC022
     C           @RTCD     IFNE '*NRF'                                                        CSC022
     C                     MOVEL'CSC022'  DBFILE                                              CSC022
     C                     MOVEL'SCSARDPD'DBKEY                                               CSC022
     C                     Z-ADD18        DBASE                                               CSC022
     C                     EXSR ERRSR                                                         CSC022
     C                     ENDIF                                                              CSC022
      *                                                                                       CSC022
     C************NAMVAR   DEFN           WDSJOB                                       CSC022BUG2368
     C           *NAMVAR   DEFN SCCMTJOB  WDSJOB                                             BUG2368
      *                                                                                       CSC022
     C                     ENDIF                                                              CSC022
      *                                                                                       CSC022
     C           *NAMVAR   DEFN           LDA                                                 CRE023
     C                     MOVEL'N'       CRE023  1                                           CRE023
     C                     CALL 'AOSARDR0'                                                    CRE023
     C                     PARM *BLANKS   @RTCD                                               CRE023
     C                     PARM '*VERIFY' @OPTN                                               CRE023
     C                     PARM 'CRE023'  @SARD                                               CRE023
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE023
      *                                                                                       CRE023
     C           @RTCD     IFNE *BLANKS                                                       CRE023
     C           @RTCD     ANDNE'*NRF   '                                                     CRE023
     C           *LOCK     IN   LDA                                                           CRE023
     C                     MOVEL'SCSARDPD'DBFILE                                              CRE023
     C                     Z-ADD19        DBASE                                               CRE023
     C                     MOVEL@SARD     DBKEY                                               CRE023
     C                     OUT  LDA                                                           CRE023
     C                     EXSR *PSSR                                                         CRE023
     C                     ENDIF                                                              CRE023
      *                                                                                       CRE023
     C           @RTCD     IFEQ *BLANK                                                        CRE023
     C                     MOVEL'Y'       CRE023                                              CRE023
     C                     ENDIF                                                              CRE023
     C/COPY WNCPYSRC,GL4445C006
     C*                                                                   CEU013
     C*
      ** Determine if SAR CAP205 Teller Related APIs - Account Balance Check                  CAP205
      ** is installed.                                                                        CAP205
      *                                                                                       CAP205
     C                     MOVEL'N'       CAP205  1                                           CAP205
     C                     CALL 'AOSARDR0'                                                    CAP205
     C                     PARM *BLANKS   @RTCD                                               CAP205
     C                     PARM '*VERIFY '@OPTN                                               CAP205
     C                     PARM 'CAP205'  @SARD                                               CAP205
     C           SCSARD    PARM SCSARD    DSFDY                                               CAP205
      *                                                                                       CAP205
     C           @RTCD     IFEQ *BLANKS                                                       CAP205
     C                     MOVEL'Y'       CAP205                                              CAP205
     C                     ELSE                                                               CAP205
     C           @RTCD     IFNE *BLANKS                                                       CAP205
     C           @RTCD     ANDNE'*NRF   '                                                     CAP205
     C                     MOVEL'SCSARDPD'DBFILE                                              CAP205
     C                     Z-ADD38        DBASE                                               CAP205
     C                     MOVEL'CAP205'  DBKEY                                               CAP205
     C                     EXSR *PSSR                                                         CAP205
     C                     ENDIF                                                              CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CAP205
     C/COPY OFCPYSRCZ,CGL135_099                                                             CGL135B
     C                     ENDSR
     C*
     C********************************************************************
     C*                                                                  *
     C*     TERMSR SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Program termination                                          *
     C*                                                                  *
     C********************************************************************
     C*
     C           TERMSR    BEGSR
      *                                                                                      241672A
     C                     MOVE 'N'       GLHLCK                                             241672A
     C                     Z-ADD*ZEROS    W#RIED                                             241672A
     C                     Z-ADD*ZEROS    W#LOOP                                             241672A
     C                     MOVE '0'       *IN22                                              241672A
     C                     MOVE '0'       *INU3                                              241672A
      *                                                                                      241672A
     C           *IN22     DOUEQ'0'                                                          241672A
     C           W#RIED    ORGT W#RTY                                                        241672A
     C           W#LOOP    ORGT 200                                                          241672A
      *                                                                                      241672A
     C*
     C*     Access batch header and update it as 'not in use'
     C*
     C***********BATCH     CHAINGLBRREL0             01                   S01229
     C********** BATCH     CHAINGLJENHL0             01                                S01229 236197
     C********** BATCH     CHAINGLJENHL5             01                               236197 241672A
     C           BATCH     CHAINGLJENHL5             0122                                    241672A
     C*
      ** Check if record locked to another job, wait and retry                               241672A
      **   Delay job if needed                                                               241672A
      **   Retry CHAIN after specified times                                                 241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '1'                                                          241672A
     C           GLHST     ANDEQ01218                                                        241672A
     C           W#RIED    ANDLTW#RTY                                                        241672A
     C                     MOVE 'Y'       GLHLCK                                             241672A
      *                                                                                      241672A
     C           W#WAIT    IFNE '000000'                                                     241672A
     C           W#WAIT    ANDNE'      '                                                     241672A
     C                     CALL 'GLDLY2'                                                     241672A
     C                     PARM           W#WAIT                                             241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
      ** Other database error occurred, end program and dump                                 241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '1'                                                          241672A
     C           GLHST     ANDNE01218                                                        241672A
     C                     Z-ADD22        DBASE            * DB ERROR 22 *                   241672A
     C                     MOVEL'GLJENHL0'DBFILE                                             241672A
     C                     MOVELBATCH     DBKEY                                              241672A
     C                     EXSR ERRSR                                                        241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C                     ADD  1         W#RIED                                             241672A
     C                     ADD  1         W#LOOP                                             241672A
     C                     ENDDO                                                             241672A
      *                                                                                      241672A
      ** Terminate program if number of retries has been reached                             241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '1'                                                          241672A
     C           GLHST     ANDEQ01218                                                        241672A
     C                     MOVE '1'       *INU3                                              241672A
     C                     Z-ADD23        DBASE            * DB ERROR 23 *                   241672A
     C                     MOVEL'GLJENHL0'DBFILE                                             241672A
     C                     MOVELBATCH     DBKEY                                              241672A
     C                     EXSR ERRSR                                                        241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C           *IN22     IFEQ '0'                                                          241672A
     C                     MOVE 'N'       GLHLCK                                             241672A
     C                     ENDIF                                                             241672A
      *                                                                                      241672A
     C*     Data base error if batch not found
     C*
     C           *IN01     IFEQ '1'
     C                     Z-ADD12        DBASE            * DB ERROR 12 *
     C                     MOVE 'GLBRL'   DBFILE
     C                     MOVELBATCH     DBKEY
     C                     EXSR ERRSR
     C                     ELSE
     C**********           MOVE *BLANKS   BRWSID                          S01413
     C**********           MOVE '  '      BRWSID                    S01413078325
     C**********           MOVE 'N'       BRBIUF                          E19860
     C                     MOVE ' '       BRBIUF                          E19860
     C                     MOVE 'Y'       BRSHPI
     C                     MOVE 'A'       BRBTSF                                              239155
     C                     MOVE 'A'       BRBHAI                                              239155
     C                     MOVE *BLANKS   BRWSID                                             BUG7459
     C*
     C                     UPDAT@BRREAG                02
     C                     END
     C*
     C*     Data base error if update fails
     C*
     C           *IN02     IFEQ '1'
     C                     Z-ADD13        DBASE            * DB ERROR 13 *
     C                     MOVE 'GLBRL'   DBFILE
     C                     MOVELBATCH     DBKEY
     C                     EXSR ERRSR
     C                     ELSE
     C*
     C           CSC022    IFEQ 'N'                                                           CSC022
     C           CSC022    OREQ 'Y'                                                           CSC022
     C           WCMTSK    ANDEQ'N'                                                           CSC022
     C                     COMIT
     C                     ENDIF                                                              CSC022
     C*
     C                     MOVE '1'       *INLR
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C*                                                                  *
     C*     ERRSR  SR     SUB-ROUTINE                                    *
     C*                                                                  *
     C*     Error routine                                                *
     C*                                                                  *
     C********************************************************************
     C*
     C           ERRSR     BEGSR
     C*
     C           CSC022    IFEQ 'N'                                                           CSC022
     C           CSC022    OREQ 'Y'                                                           CSC022
     C           WCMTSK    ANDEQ'N'                                                           CSC022
     C                     ROLBK
     C                     ENDIF                                                              CSC022
     C                     SETON                     U7U8LR
     C                     DUMP                                           080050
     C                     RETRN
     C*
     C                     ENDSR
      *                                                                                       CRE023
      *****************************************************************                       CRE023
      *                                                               *                       CRE023
      *  *PSSR - Program exception error routine                      *                       CRE023
      *          Called automatically if a program error occurs,      *                       CRE023
      *          or directly by the program code using EXSR.          *                       CRE023
      *          This subroutine DUMPs the program just once.         *                       CRE023
      *                                                               *                       CRE023
      *  Called by: Error-trapping routines.                          *                       CRE023
      *                                                               *                       CRE023
      *  Calls:  None.                                                *                       CRE023
      *                                                               *                       CRE023
      *****************************************************************                       CRE023
      *                                                                                       CRE023
     C           *PSSR     BEGSR                                                              CRE023
      *                                                                                       CRE023
     C                     SETON                     U7U8                                     CRE023
     C           WRUN      IFEQ *BLANKS                                                       CRE023
     C                     MOVE 'Y'       WRUN    1                                           CRE023
     C                     DUMP                                                               CRE023
     C                     ENDIF                                                              CRE023
      *                                                                                       CRE023
     C                     ENDSR                                                              CRE023
     C/COPY WNCPYSRC,GL4445C007
     C*
     C********************************************************************
     C/COPY ZSRSRC,ZACCH
     C/COPY ZSRSRC,ZFWDT
     C********************************************************************
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
