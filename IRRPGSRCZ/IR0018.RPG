      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas IR Voce/Sottovoce Codes Maintenance')            *
      *****************************************************************
      *                                                               *
      *  Midas - European Reporting - Italy                           *
      *                                                               *
      *  IR0018 - Voce/Sottovoce Codes Maintenance                    *
      *                                                               *
      *  Function:  A new table of all valid Voce/Sottovoce           *
      *             codes is maintained for validation during input   *
      *             of theses codes                                   *
      *                                                               *
      *  (phase(s)) Input Cycle                                       *
      *                                                               *
      *  Called By:                                                   *
      *                                                               *
      *  (C) Copyright Midas-Kapiti International Ltd. 1997           *
      *                                                               *
      *  Last Amend No. LUC139             Date 10Feb21               *
      *  Prev Amend No. UIT021  *Create    Date 27jan97               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *   LUC139 - UCI Italian returns upgrade to FM2.1               *
      *   UIT021 - Bank Of Italy Monthly Reporting                    *
      *                                                               *
      *****************************************************************
      /TITLE FUNCTION OF INDICATORS
      *****************************************************************
      *
      *  *INKC  -  F3  pressed, exit program.
      *  *INKE  -  F5  pressed, redisplay the screen
      *  *INKI  -  F9  pressed, goto change/add  mode
      *  *INLR  -  End processing
      *
      *  *IN25  -  SFLEND on message subfile                  (*OFF)
      *
      *  *IN31  -  Selection field in error                   (*ON)
      *  *IN32  -  Voce code entered in error                 (*ON)
      *  *IN33  -  Sottovoce code entered in error            (*ON)
      *  *IN34  -  Narrative in error                         (*ON)
      *  *IN35  -  Frequency in error                         (*ON)
      *
      *  *IN79  -  Protect key fields in amend/enquire modes  (*ON)
      *  *IN80  -  SFLCLR                                     (*ON)
      *  *IN81  -  SFLDSP                                     (*ON)
      *  *IN82  -  SFLEND                                     (*ON)
      *  *IN85  -  Protect other fields in enquire mode       (*ON)
      *
      *  *IN97  -  Global error indicator                     (*ON)
      *
      *  *INU7
      *  *INU8  -  External indicators for Database errors    (*ON)
      *
      *                                                               *
      *****************************************************************
      /TITLE SUBROUTINE INDEX
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *  ===============================                              *
      *                                                               *
      * BAIZSF   - Initialise & load subfile page                     *
      * BBLDSF   - Load subfile page (write empty page if add mode)   *
      * CAEXFM   - Display screen                                     *
      * DAPR##   - Process screen input                               *
      * DBPRSF   - Process modified subfile records                   *
      * DCPRSR   - Process subfile record                             *
      * DDNLRC   - Check for null record                              *
      * DEV1RC   - Validate subfile record                            *
      * EAPRSF   - Update DBF from subfile records                    *
      * EBPRSR   - Process modified subfile record                    *
      * ECADRQ   - Process add request                                *
      * EDDLRQ   - Process delete request                             *
      * EECHRQ   - Process update request                             *
      * FACHMD   - Flip between *ADD and *CHANGE modes                *
      * FBRQRL   - Request subfile reload                             *
      * GADSA1   - Set display attributes for subfile control         *
      * GBDSA2   - Set display attributes for subfile control         *
      * MAIZ#1   - Initialise subfile record                          *
      * MBFL#1   - Move NRPSTCD2 fields to subfile                    *
      * MEIZ#2   - Initialise subfile control                         *
      * SACRRC   - Create Voce/Sottovoce code                         *
      * SBDLRC   - Delete Voce/Sottovoce code                         *
      * SCCHRC   - Change Voce/Sottovoce code                         *
      * ZASNMS   - Send message to program's message queue            *
      * ZXEXPG   - Exit program: Normal                               *
      * ZYEXPG   - Exit program: Direct                               *
      * ZZINIT   - Initialisation                                     *
      *                                                               *
      * EXTERNAL ROUTINES CALLED                                      *
      * Y2CLMSC  - Clear messages from program message queue          *
      * Y2SNMGC  - Send messages from program message queue           *
      * Y2BGCMC  - Begin Commit control                               *
      *****************************************************************
      /TITLE FILES DESCRIPTION
      *****************************************************************
     FMUSER   IF  E           K        DISK
     FIR0018DFCF  E                    WORKSTN
     F                                        ##RR  KSFILE #SFLRCD
     F                                              KINFDS INFDS#
      * DSP: Edit Voce/Sottovoce codes      Edit file
      *
     FERITCDL1IF  E           K        DISK
     F            ERITCDD0                          KRENAMERTVIDX
     F                                              KINFDS INFDS1
      * RTV: Voce/Sottovoce codes      Retrieval index
      *
     FERITCDL0UF  E           K        DISK                      A    UC
     F            ERITCDD0                          KRENAMEUPDIDX
     F                                              KCOMIT
      * UPD: Voce/Sottovoce            Update index
      *
      * Array to set-up command key text
     E                    CMD     1   5 60
      *
      ***  Copyright
      *
     E                    CPY@    1   1 80
      *
     E/COPY ZSRSRC,ZALIGNZ1
      /EJECT
      *****************************************************************
      /TITLE I-SPECIFICATIONS
      *****************************************************************
      * Data structures:-
     IPGMDS     ESDSY2PGDSP
      * Program data structure.
     IINFDS#    E DSY2I#DSP
      * Display file data structure.
      *
     IINFDS1    E DSY2I1DSP
      * File information data structure.
      *
     I@1DBRC    E DSERITCDPD
      * Current/previous master file format fields for change control.
      *
     IRUNDAT      DS
     I                                        1   7 AANA
     I                                    P   8  100AKTX
     I                                       11  11 AUST
     I                                       12  12 E3ST
     I                                       13  13 F1ST
      ********************************************************************
      /EJECT
      ********************************************************************
      **         P R O G R A M    S T A R T                             **
      ********************************************************************
      *
     C           *ENTRY    PLIST                            Entry parameter
     C                     PARM           P0RTN   7         Return code
      *
      * Initialise
      *
     C                     EXSR ZZINIT
      *
     C                     DO   *HIVAL
      *
      * Initialise and load subfile page.
      *
     C                     EXSR BAIZSF
     C                     MOVEL'N'       W0RSF   1
      *
      * Display screen until reload requested:
      *
     C           W0RSF     DOWEQ'N'
      *
      * Display screen.
      *
     C                     EXSR CAEXFM
      *
      * Process response:
      * Exit request: Cancel & exit program.
      *
     C   KC                CAS            ZXEXPG
      *
      * HOME: Request subfile reload.
      *
     C   KE                CAS            FBRQRL
      *
      * Switch between *ADD/*CHANGE modes.
      *
     C   KI                CAS            FACHMD
      *
      *   Display next SFL page.
      *
     C   27                CAS            BBLDSF
      *
      * Process screen input.
      *
     C                     CAS            DAPR##
     C                     ENDCS
      *
     C                     ENDDO
     C                     ENDDO
      *
      ********************************************************************
      **         P R O G R A M    E N D                                 **
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * BAIZSF   - Initialise & load subfile page                        *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * BBLDSF   - Load subfile page (write empty page if add mode)      *
      * ZASNMS   - Send message to program's message queue               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - Main Processing                                       *
      *                                                                  *
      ********************************************************************
     CSR         BAIZSF    BEGSR
      *
      * Clear subfile.
      *
     C                     SETON                     80
     C                     WRITE#SFLCTL
     C                     SETOF                     80
      *
      * Reset no of records in subfile.
      *
     C                     Z-ADD*ZERO     ##RRMX  50 81     SETOF 81
      *
      * If CHANGE mode, then position file:
      *
     C           W0PMD     IFNE 'ADD'
      *
      * Setup key.
      *
     C                     Z-ADD*ZERO     N2BOIC
     C           KPOS      SETLLRTVIDX               82     *82=EOF
     C  N82                READ RTVIDX                 9182 *82=EOF
     C                     ELSE
     C                     SETOF                     82
     C                     ENDIF
      *
      ***  If EOF change to ADD mode.
      *
     C           *IN82     IFEQ *ON
     C                     MOVE 'ADD'     W0PMD
      * If no records found, display error message.
      *
      * Send message '*No data to display'
      *
     C                     MOVEL'ITI1812' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     ENDIF                            FI ##RR = *ZERO
      *
      * Load subfile page.
      *
     C                     EXSR BBLDSF
      *
     CSR         BAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * BBLDSF   - Load subfile page (write empty page if add mode)      *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * MAIZ#1   - Initialise subfile record                             *
      * MBFL#1   - Move ERITCDPD fields to subfile                       *
      * GADSA1   - Set display attributes for subfile control            *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - Main Processing                                       *
      * BAIZSF   - Initialise & load subfile page                        *
      *                                                                  *
      ********************************************************************
     CSR         BBLDSF    BEGSR
      *
     C                     SETOF                     84     No SFLNXTCHG
      *
      * Re-establish fields in read-ahead record.
      *
     C   27      W0PMD     IFNE 'ADD'
     C  N82                READPRTVIDX                   90
     C  N82                READ RTVIDX                   90
     C                     ENDIF
      *
      * Setof record error indicators.
      *
     C                     MOVE *ALL'0'   WKIND0  5
      *
      * Start at previous highest SFL record reached.
      *
     C                     Z-ADD##RRMX    ##RR    50
     C                     Z-ADD*ZERO     ##RROK  50
      *................................................................
      * Load next page of SFL:
      *
     C           ##RROK    DOWLT##SFPG                      DO
     C                     MOVEAWKIND0    *IN,31
     C                     SETOF                     87
     C                     SETOF                     85
      *
      * Clear SFL fields.
      *
     C                     EXSR MAIZ#1
      *
      * If change mode, load SFL fields.
      *
     C           W0PMD     IFNE 'ADD'
     C                     EXSR MBFL#1
      *
      * Record will be selected unless overridden.
      *
     C                     MOVEL'Y'       W0RSL   1
      *
      * If record dropped...
      *
     C           W0RSL     CABNE'Y'       BB020
      *
      * Validate subfile record and calculate derived fields.
      *
     C                     ENDIF
      *
      * Output to subfile.
      *
     C                     ADD  1         ##RR       81
     C                     ADD  1         ##RROK
      *
      * Set screen conditioning indicators.
      *
     C                     EXSR GADSA1
     C                     WRITE#SFLRCD
     C           BB020     TAG
     C           W0PMD     IFNE 'ADD'
     C                     READ RTVIDX                   82 *82=EOF
      *
     C           *IN82     IFEQ *ON
     C                     LEAVE
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDDO                            OD 1 - #SFPG
      *................................................................
      * Save highest SFL rec, so load can continue at end point.
      *
     C           ##RR      IFGT ##RRMX
     C           ##RRMX    ADD  1         ##SFRC
      *
     C                     Z-ADD##RR      ##RRMX
     C                     END
      *
     CSR         BBEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * CAEXFM   - Display screen                                        *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * GBDSA2   - Set display attributes for subfile control            *
      * Y2CLMSC  - Clear messages from program message queue             *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - Main processing                                       *
      *                                                                  *
      ********************************************************************
     CSR         CAEXFM    BEGSR
      *
      * Set screen conditioning indicators.
      *
     C                     EXSR GBDSA2
     C           W0HLP     DOUEQ'N'
      *
     C                     WRITE#MSGCTL
      *
     C                     SELEC
      *
     C           *IN89     WHEQ *ON
     C           *IN44     ANDEQ*ON
     C                     MOVEACMD,1     #0CMD
      *
     C           *IN89     WHEQ *OFF
     C           *IN44     ANDEQ*ON
     C           *IN43     ANDEQ*ON
     C                     MOVEACMD,2     #0CMD
      *
     C           *IN89     WHEQ *OFF
     C           *IN44     ANDEQ*ON
     C           *IN43     ANDEQ*OFF
     C                     MOVEACMD,3     #0CMD
      *
     C           *IN44     WHEQ *OFF
     C           *IN43     ANDEQ*OFF
     C                     MOVEACMD,4     #0CMD
      *
     C           *IN44     WHEQ *OFF
     C           *IN43     ANDEQ*ON
     C                     MOVEACMD,5     #0CMD
     C                     ENDSL
      *
     C                     WRITE#CMDTXT1
     C                     EXFMT#SFLCTL
     C                     MOVEL'N'       W0HLP   1         Reset help requ
     C                     SETOF                     98
     C                     Z-ADD0         SFRC##
     C                     ENDDO
      *
      * Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      * Reset first message only flag.
      *
     C                     MOVEL'Y'       ZAFSMS  1      97
      *
     CSR         CAEXIT    ENDSR
      /EJECT
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * DAPR##   - Process screen input                                  *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * DBPRSF   - Process modified subfile records                      *
      * EAPRSF   - Update DBF from subfile records                       *
      * FACHMD   - Flip between *ADD and *CHANGE modes                   *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - Main processing                                       *
      *                                                                  *
      ********************************************************************
     CSR         DAPR##    BEGSR
      *
      * Maintain subfile position where possible.
      *
     C           @#SFRC    IFGT *ZERO
     C                     Z-ADD@#SFRC    ##SFRC
     C                     ENDIF
      *
      * Quit if reload requested.
      *
     C           W0RSF     CABEQ'Y'       DAEXIT
      *
     C   81                DO
      *
      * No data entered as yet.
      *
     C                     MOVEL'N'       WKIPIN  1
      *
      * Confirm/update is not defered.
      *
     C                     MOVEL'N'       W0DCF   1
      *
      * Process subfile records.
      *
     C                     EXSR DBPRSF
      *
      * If error, exit:
      *
     C   98                Z-ADDSFRC##    ##SFRC
     C           *IN98     CABEQ'1'       DAEXIT
      *
      * Defer confirm/update requested:
      *
     C           W0DCF     CABEQ'Y'       DAEXIT
      *
      * If data entered.
      *
     C           WKIPIN    IFEQ 'Y'
      *
      * Update DBF from subfile.
      *
     C                     EXSR EAPRSF
      * If error during update, exit:
     C           *IN97     CABEQ'1'       DAEXIT
     C                     ENDIF                            WKIPIN
     C                     ENDDO                            OD 81
      *
     CSR         DAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * DBPRSF   - Process modified subfile records                      *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * DCPRSR   - Process subfile record                                *
      * GADSA1   - Set display attributes for subfile control            *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * DAPR##   - Process screen input                                  *
      *                                                                  *
      ********************************************************************
     CSR         DBPRSF    BEGSR
      *
     C                     READC#SFLRCD                  92
     C           *IN92     DOWEQ'0'
     C                     MOVEL#0VOCE    N2BOIC
     C                     MOVE #0SOTV    N2BOIC
     C                     EXSR DCPRSR
     C                     SETOF                     87
     C                     SETOF                     85
      *
      * Set screen conditioning indicators.
      *
     C                     EXSR GADSA1
     C                     UPDAT#SFLRCD
     C                     READC#SFLRCD                  92
     C                     END
      *
     CSR         DBEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * DCPRSR   - Process subfile record                                *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * DDNLRC   - Check for null record                                 *
      * DEV1RC   - Validate subfile record                               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * DBPRSF   - Process modified subfile records                      *
      *                                                                  *
      ********************************************************************
     CSR         DCPRSR    BEGSR
      *
      * Setoff error indicators.
      *
     C                     MOVEAWKIND0    *IN,31
     C                     SETOF                     84     NO SFLNXTCHG
     C           W0PMD     IFEQ 'ADD'
      *
      * Check for null record.
      *
     C                     EXSR DDNLRC
     C           W0NLR     IFEQ 'Y'
     C                     GOTO DCEXIT
     C                     ENDIF
      *
      * If not null record, continue.
      *
     C                     ENDIF
     C                     MOVEL'Y'       WKIPIN            Data entered
     C                     SETON                     84     SFLNXTCHG
      *
      * If delete request, bypass validation.
      *
     C           #0SEL     IFEQ 'D'
     C                     GOTO DCEXIT
     C                     ENDIF
      *
      * Validate subfile record.
      *
     C                     EXSR DEV1RC
      *
      * If SFLRCD invalid, note the fact.
      *
     C   98N97             Z-ADD##RR      ##SFRC     97     Invalid SFLRCD
      *
     CSR         DCEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * DDNLRC   - Check for null record                                 *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * DCPRSR   - Process subfile record                                *
      * EBPRSR   - Process modified subfile record                       *
      *                                                                  *
      ********************************************************************
     CSR         DDNLRC    BEGSR
      *
     C                     MOVEL'N'       W0NLR   1
     C           #0VOCE    CABNE*BLANK    DDEXIT
     C           #0SOTV    CABNE*BLANK    DDEXIT
     C           #0NARR    CABNE*BLANK    DDEXIT
     C           #0FREQ    CABNE*BLANK    DDEXIT
     C                     MOVEL'Y'       W0NLR
      *
     CSR         DDEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * DEV1RC   - Validate subfile record                               *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZASNMS   - Send message to program's message queue               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * DCPRSR   - Process subfile record                                *
      *                                                                  *
      ********************************************************************
     CSR         DEV1RC    BEGSR
      *
      ***  Option must be blank or 'D'
      *
     C           #0SEL     IFNE *BLANK                     *B1
     C           #0SEL     ANDNE'D'
      *
     C                     SETON                     983190
      *
      * Send message 'Option invalid'
      *
     C                     MOVEL'ITI1801' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     ENDIF                           *E1
      *
      ***  Voce code must be numeric
      *
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE #0VOCE    ZFIELD
     C                     Z-ADD5         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ *OFF                       *B1
     C                     MOVE ZFIELD    #0VOCE
     C                     ENDIF                           *E1
      *
     C           *IN99     IFEQ *ON                        *B1
     C                     MOVE *ON       *IN90
     C                     MOVEL'ITI1802' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     SETON                     9832
     C                     ENDIF                           *E1
      *
      ***  Sottovoce code must be numeric
      *
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE #0SOTV    ZFIELD
     C                     Z-ADD2         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ *OFF                       *B1
     C                     MOVE ZFIELD    #0SOTV
     C                     ENDIF                           *E1
      *
     C           *IN99     IFEQ *ON                        *B1
     C                     MOVE *ON       *IN90
     C                     MOVEL'ITI1803' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     SETON                     9833
     C                     ENDIF                           *E1
      *
      ***  Voce/Sottovoce combination must be valid
      *
     C                     MOVEL#0VOCE    N2BOIC
     C                     MOVE #0SOTV    N2BOIC
     C           N2BOIC    IFEQ *ZEROS                     *B1
     C                     MOVE *ON       *IN90
     C                     MOVEL'ITI1804' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     SETON                     983233
     C                     ENDIF                           *E1
      *
      * Voce/Sottovoce Narrative required.
      *
     C           #0NARR    IFEQ *BLANK                     *B1
     C                     SETON                     983490
      *
      * Send message 'Value required'
      *
     C                     MOVEL'ITI1805' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     ENDIF                           *E1
      *
      ***  If Frequency left blank, defaulted to 'M'
      *
     C           #0FREQ    IFEQ ' '
     C                     MOVE 'M'       #0FREQ
     C                     ENDIF
      *
      * Validate Frequency
      *
     C           #0FREQ    IFNE 'M'                        *B1
     C           #0FREQ    ANDNE'T'
     C           #0FREQ    ANDNE'S'
     C           #0FREQ    ANDNE'A'
     C                     SETON                     983590
     C                     MOVEL'ITI1806' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     ENDIF                           *E1
      *
     C   98      SFRC##    IFEQ 0
     C                     Z-ADD##RR      SFRC##  40
     C                     ENDIF
      *
     CSR         DEEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * EAPRSF   - Update DBF from subfile records                       *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * EBPRSR   - Process modified subfile record                       *
      * GADSA1   - Set display attributes for subfile control            *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * DAPR##   - Process screen input                                  *
      *                                                                  *
      ********************************************************************
     CSR         EAPRSF    BEGSR
      *
      * Initialise subfile reload flag.
     C           W0PMD     IFEQ 'ADD'
     C                     MOVEL'Y'       W0RSF
     C                     ELSE
     C                     MOVEL'N'       W0RSF
     C                     ENDIF
      *
      * Process all modified subfile records.
      *
     C                     READC#SFLRCD                  92
     C           *IN92     DOWEQ'0'
     C                     MOVEL#0VOCE    N2BOIC
     C                     MOVE #0SOTV    N2BOIC
      *
      * Process modified subfile record.
      *
     C                     EXSR EBPRSR
     C           W0RTN     IFNE *BLANK
      *
      * Error: ROLLBACK any DBF changes.
      *
     C                     ROLBK
     C                     ELSE
      *
      * Otherwise COMMIT any DBF changes.
      *
     C                     COMIT
     C                     ENDIF
     C                     MOVEL*BLANK    #0SEL
      *
      * Set screen conditioning indicators.
      *
     C                     EXSR GADSA1
     C                     UPDAT#SFLRCD
     C                     READC#SFLRCD                  92
     C                     ENDDO
      *
      * If any errors, cancel reload.
      *
     C           *IN97     IFEQ '1'
     C                     MOVEL'N'       W0RSF   1
     C                     ENDIF
      *
     CSR         EAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * EBPRSR   - Process modified subfile record                       *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * DDNLRC   - Check for null record                                 *
      * ECADRQ   - Process add request                                   *
      * EDDLRQ   - Process delete request                                *
      * EECHRQ   - Process update request                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * EAPRSF   - Update DBF from subfile records                       *
      *                                                                  *
      ********************************************************************
     CSR         EBPRSR    BEGSR
      *
      * Set off error indicators.
      *
     C                     MOVEAWKIND0    *IN,31            Clear errors
     C                     SETOF                     98     No errors
      *
     C           W0PMD     IFEQ 'ADD'                      *B1
      *
      * Process add request.
      *
     C           #0SEL     IFNE 'D'
     C                     EXSR DDNLRC
     C           W0NLR     IFNE 'Y'
     C                     EXSR ECADRQ
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE                            *X1
      *
     C           #0SEL     IFEQ 'D'
      *
      * Process delete request.
      *
     C                     EXSR EDDLRQ
      *
     C                     ELSE
      *
      * Process change request.
      *
     C                     EXSR EECHRQ
      *
     C                     ENDIF
      *
     C                     ENDIF                           *E1
      *
      * If error occurred on update, note the fact.
      *
     C           *IN98     IFEQ '1'
     C           *IN97     IFEQ '0'
     C                     Z-ADD##RR      ##SFRC     97     Error on update
     C                     ENDIF
     C                     ENDIF
      *
     CSR         EBEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * ECADRQ   - Process add request                                   *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SACRRC   - Create Voce/Sottovoce record                          *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * EBPRSR   - Process modified subfile record                       *
      *                                                                  *
      ********************************************************************
     CSR         ECADRQ    BEGSR
      *
      * USER: Create DBF record
      *
     C                     EXSR SACRRC
     C           W0RTN     IFNE *BLANK
      *
      * Write error detected.
      *
     C                     MOVEA'11'      *IN,32            Screen errors
     C                     SETON                     98     Format Error
     C                     SETOF                     87     Enable entry
     C                     SETOF                     85
     C                     SETON                     84     SFLNXTCHG
     C                     ELSE
      *
      * DBF Write successful.
      *
     C                     SETON                     87     Disable entry
     C                     SETON                     85
     C                     SETOF                     84     No SFLNXTCHG
     C                     ENDIF
      *
     CSR         ECEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * EDDLRQ   - Process delete request                                *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SBDLRC   - Delete Voce/Sottovoce record                          *
      * MBFL#1   - Move ERITCDPD fields to subfile                       *
      * MAIZ#1   - Initialise subfile record                             *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * EBPRSR   - Process modified subfile record                       *
      *                                                                  *
      ********************************************************************
     CSR         EDDLRQ    BEGSR
      *
      * USER: Delete DBF record
      *
     C                     EXSR SBDLRC
     C           W0RTN     IFNE *BLANK
      *
      * Delete unsuccessful.
      *
     C                     MOVE '111'     *IN,31            Screen errors
     C                     SETON                     98     Format Error
     C                     SETOF                     87     Enable entry
     C                     SETOF                     85
     C                     SETON                     84     SFLNXTCHG
      *
      * If record altered, reset subfile record.
      *
     C           W0RTN     CASEQ'Y2U0007' MBFL#1            IF
     C                     ENDCS
     C                     ELSE
      *
      * DBF Delete successful.
      * Blank out record and protect from entry.
      *
     C                     EXSR MAIZ#1
     C                     SETON                     87     Disable entry
     C                     SETON                     85
     C                     SETOF                     84     No SFLNXTCHG
     C                     MOVEL'Y'       W0RSF   1         Reload subfile
     C                     ENDIF                            FI W0RTCD
      *
     CSR         EDEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * EECHRQ   - Process update request                                *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * SCCHRC   - Change Voce/Sottovoce record                          *
      * MBFL#1   - Move ERITCDPD fields to subfile                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * EBPRSR   - Process modified subfile record                       *
      *                                                                  *
      ********************************************************************
     CSR         EECHRQ    BEGSR
      *
      * USER: Change DBF record
      *
     C                     EXSR SCCHRC
     C           W0RTN     IFNE *BLANK
      *
      * DBF Update error detected.
      *
     C                     MOVEA'11'      *IN,32            Screen errors
     C                     SETON                     98     Format Error
     C                     SETOF                     87     Enable entry
     C                     SETOF                     85
     C                     SETON                     84     SFLNXTCHG
      *
      * Reset subfile record if changed record.
      *
     C           W0RTN     CASEQ'Y2U0007' MBFL#1            IF
     C                     ENDCS
     C                     ELSE
      *
      * DBF Update successful.
      *
     C                     SETOF                     87     Enable entry
     C                     SETOF                     85
     C                     SETOF                     84     No SFLNXTCHG
     C                     ENDIF                            FI W0RTCD
      *
     CSR         EEEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * FACHMD   - Flip between *ADD and *CHANGE modes                   *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * FBRQRL   - Request subfile reload                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * DAPR##   - Process screen input                                  *
      *                                                                  *
      ********************************************************************
     CSR         FACHMD    BEGSR
      *
     C           W0PMD     IFNE 'ADD'
     C                     MOVEL'ADD'     W0PMD
     C                     ELSE
     C                     MOVEL'CHG'     W0PMD
     C                     ENDIF
     C                     EXSR FBRQRL
      *
     CSR         FAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * FBRQRL   - Request subfile reload                                *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - Main Processing                                       *
      * FACHMD   - Flip between *ADD and *CHANGE modes                   *
      *                                                                  *
      ********************************************************************
     CSR         FBRQRL    BEGSR
      *
      * Request subfile reload.
      *
     C                     MOVEL'Y'       W0RSF
      *
     CSR         FBEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * GADSA1   - Set display attributes for subfile control            *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * BBLDSF   - Load subfile page (write empty page if add mode)      *
      * DBPRSF   - Process modified subfile records                      *
      * EAPRSF   - Update DBF from subfile records                       *
      *                                                                  *
      ********************************************************************
     CSR         GADSA1    BEGSR
      *
     C           W0PMD     COMP 'ADD'                    89
      *
      * Protect keys if change mode or updated record.
      *
     C                     SETON                     88
     C   89N87             SETOF                     88
     C                     MOVEL*IN87     *IN79
     C           W0PMD     IFEQ 'CHG'                       IF
     C                     MOVEL'1'       *IN79
     C                     ENDIF                            FI
      *
     C                     MOVE *OFF      *IN44
      *
     C           W0PMD     IFEQ 'CHG'                       IF
     C           *IN42     IFEQ *ON
     C                     MOVE *ON       *IN44
     C                     ENDIF
     C           *IN41     IFEQ *OFF
     C                     MOVE *ON       *IN85
     C                     ENDIF
     C           *IN43     IFEQ *OFF
     C                     MOVE *ON       *IN87
     C                     ENDIF
     C                     ENDIF                            FI
      *
     C           W0PMD     IFEQ 'ADD'                       IF
     C                     MOVE *ON       *IN44
     C           *IN42     IFEQ *OFF
     C                     MOVE *ON       *IN85
     C                     MOVE *ON       *IN87
     C                     MOVE *ON       *IN79
     C           W0071     IFEQ *BLANKS
      *
      * Send message 'NO DATA AND THE USER NOT AUTHORIZED TO INPUT'
      *
     C                     MOVEL'ITI1807' W0071   7         Message id.
     C                     MOVEL'ITI1807' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                            FI
      *
     CSR         GAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * GBDSA2   - Set display attributes for subfile control            *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * CAEXFM   - Display screen and process HELP requests              *
      *                                                                  *
      ********************************************************************
     CSR         GBDSA2    BEGSR
      *
     C           W0PMD     COMP 'ADD'                    89
      *
     CSR         GBEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * MAIZ#1   - Initialise subfile record                             *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * BBLDSF   - Load subfile page (write empty page if add mode)      *
      * EDDLRQ   - Process delete request                                *
      *                                                                  *
      ********************************************************************
     CSR         MAIZ#1    BEGSR
      *
     C                     MOVEL*BLANK    #0DBRC            Previous values
     C                     MOVEL*BLANK    #0SEL             SFLSEL
     C                     MOVEL*BLANK    #0VOCE
     C                     MOVEL*BLANK    #0SOTV
     C                     MOVEL*BLANK    #0NARR
     C                     MOVEL*BLANK    #0FREQ
      *
     CSR         MAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * MBFL#1   - Move ERITCDPD fields to subfile                       *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * BBLDSF   - Load subfile page (write empty page if add mode)      *
      * EDDLRQ   - Process delete request                                *
      * EECHRQ   - Process update request                                *
      *                                                                  *
      ********************************************************************
     CSR         MBFL#1    BEGSR
      *
     C                     MOVELN2BOIC    #0VOCE
     C                     MOVE N2BOIC    #0SOTV
     C                     MOVELN2NARR    #0NARR
     C                     MOVELN2FREQ    #0FREQ
      *
      * Hold current record image for change detection.
      *
     C                     MOVEL@1DBRC    #0DBRC
      *
     CSR         MBEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * MEIZ#2   - Initialise subfile control                            *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * ZZINIT   - Initialisation                                        *
      *                                                                  *
      ********************************************************************
     CSR         MEIZ#2    BEGSR
      *
     CSR         MEEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SACRRC   - Create Voce/Sottovoce record                          *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZASNMS   - Send message to program's message queue               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * ECADRQ   - Process add request                                   *
      *                                                                  *
      ********************************************************************
     CSR         SACRRC    BEGSR
      *
     C                     MOVEL*BLANK    W0RTN   7
      *
      * Move all fields to ERITCDPD file
      *
     C                     MOVEL#0VOCE    N2BOIC
     C                     MOVE #0SOTV    N2BOIC
     C                     MOVEL#0NARR    N2NARR
     C                     MOVEL#0FREQ    N2FREQ
     C                     MOVEL'I'       N2TYLC            Type of Last Ch
     C                     Z-ADDWUAKTX    N2LCD             Last Change Dat
      *
      * Check for duplicate primary key.
      *
     C           KPOS      SETLLUPDIDX                   90
     C           *IN90     IFEQ '1'
     C                     MOVEL'ITI1811' W0RTN   7
      *
      * Send message 'Voce/Sottovoce already exists'
      *
     C                     MOVEL'ITI1811' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     GOTO SAEXIT
     C                     ENDIF
      *
     C                     WRITEUPDIDX                 91
      *
     C           *IN91     IFEQ '1'
      *
      * Write error detected.
      *
     C                     MOVEL'ITI1810' W0RTN   7
     C                     MOVEL'ITI1810' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     GOTO SAEXIT
     C                     ELSE
      *
      * DBF Write successful.
      *
     C                     ENDIF
      *
     CSR         SAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SBDLRC   - Delete Vove/Sottovoce record                          *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZASNMS   - Send message to program's message queue               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * EDDLRQ   - Process delete request                                *
      *                                                                  *
      ********************************************************************
     CSR         SBDLRC    BEGSR
      *
     C                     MOVEL*BLANK    W0RTN   7
      *
     C           KPOS      CHAINUPDIDX               90
     C           *IN90     IFEQ *ON
      *
      * Record already deleted.
      *
     C                     MOVEL'Y2U0009' W0RTN   7
      *
      * Send message '*Record no longer on file'
      *
     C                     MOVEL'ITI1808' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     GOTO SBEXIT
     C                     ENDIF
      *
     C           ##STCD    IFEQ 01218
      *
      * Record locked.
      *
     C                     MOVEL'Y2U0004' W0RTN   7
     C                     GOTO SBEXIT
     C                     ENDIF
      *
      * Check for changed record.
      *
     C           #0DBRC    IFNE @1DBRC                      IF
     C                     MOVEL'ITI1809' W0RTN   7
      *
      * Send message '*Update not accepted'
      *
     C                     MOVEL'ITI1809' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
      *
      * Use SETLL to release record lock.
      *
     C           KPOS      SETLLUPDIDX               9091
     C                     GOTO SBEXIT
     C                     ENDIF                            FI #0DBRC
      *
     C                     DELETUPDIDX                 91
     C           *IN91     IFEQ '1'
      *
      * Delete error detected.
      *
     C                     MOVEL'ITI1813' W0RTN   7
     C                     MOVEL'ITI1813' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     ENDIF
      *
     CSR         SBEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * SCCHRC   - Change Voce/Sottovoce record                          *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZASNMS   - Send message to program's message queue               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * EECHRQ   - Process update request                                *
      *                                                                  *
      ********************************************************************
     CSR         SCCHRC    BEGSR
      *
     C                     MOVEL*BLANK    W0RTN   7
      *
     C           KPOS      CHAINUPDIDX               9091
      *
     C           *IN90     IFEQ '1'
      *
      * Record not found.
      *
     C                     MOVEL'ITI1808' W0RTN   7
      *
      * Send message '*Record no longer on file'
      *
     C                     MOVEL'ITI1808' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     GOTO SCEXIT
     C                     ENDIF
      *
     C           *IN91     IFEQ '1'
      *
      * Record locked.
      *
     C                     MOVEL'ITI1814' W0RTN   7
     C                     MOVEL'ITI1814' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     GOTO SCEXIT
     C                     ENDIF
      *
      * Check for changed record.
      *
     C           #0DBRC    IFNE @1DBRC                      IF
     C                     MOVEL'ITI1809' W0RTN   7
      *
      * Send message '*Update not accepted'
      *
     C                     MOVEL'ITI1809' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
      *
      * Use SETLL to release record lock.
      *
     C           KPOS      SETLLUPDIDX               9091
     C                     GOTO SCEXIT
     C                     ENDIF                            FI #0DBRC
      *
      * Move Non-key fields to ERITCDPD file
      *
     C                     MOVE #0NARR    N2NARR
     C                     MOVE #0FREQ    N2FREQ
     C                     MOVE 'A'       N2TYLC            Type of Last Ch
     C                     Z-ADDWUAKTX    N2LCD             Last Change Dat
      *
     C                     UPDATUPDIDX                 91
     C           *IN91     IFEQ '1'
      *
      * Change error detected.
      *
     C                     MOVEL'ITI1815' W0RTN   7
     C                     MOVEL'ITI1815' ZAMSID            Message id.
     C                     MOVEL'ERUSRMSG'ZAMSGF            Message file.
     C                     EXSR ZASNMS                      Send message
     C                     ELSE
      *
      * DBF Change successful.
      * Update saved record image.
      *
     C                     MOVEL@1DBRC    #0DBRC
     C                     ENDIF
      *
     CSR         SCEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * ZASNMS   - Send message to program's message queue               *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * Y2SNMGC  - Send messages from program message queue              *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * BAIZSF   - Initialise & load subfile page                        *
      * DEV1RC   - Validate subfile record                               *
      * SACRRC   - Create Voce/Sottovoce record                          *
      * SBDLRC   - Delete Voce/Sottovoce record                          *
      * SCCHRC   - Change Voce/Sottovoce record                          *
      *                                                                  *
      ********************************************************************
     CSR         ZASNMS    BEGSR
      *
     C           ZAPGM     IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGM
     C                     ENDIF
      *
      * If no message file specified use default.
      *
     C           ZAMSGF    IFEQ *BLANK
     C                     MOVELZADFMF    ZAMSGF
     C                     ENDIF
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGM  10         Program queue
     C                     PARM           ZAPGRL  5         Rel queue
     C                     PARM           ZAMSID  7         Message Id.
     C                     PARM           ZAMSGF 10         Message file.
     C                     PARM           ZAMSDA132         Message data.
     C                     PARM           ZAMSTP  7         Message type.
      *
      * Clear all fields for default mechanism next time.
      *
     C                     MOVEL*BLANK    ZAPGM             Program queue
     C                     MOVEL*BLANK    ZAPGRL            Rel queue
     C                     MOVEL*BLANK    ZAMSID            Message Id.
     C                     MOVEL*BLANK    ZAMSGF            Message file.
     C                     MOVEL*BLANK    ZAMSDA            Message data.
     C                     MOVEL*BLANK    ZAMSTP            Message type.
      *
     CSR         ZAEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * ZXEXPG   - Exit program: Normal                                  *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZYEXPG   - Exit program: Direct                                  *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - Main Processing                                       *
      *                                                                  *
      ********************************************************************
     CSR         ZXEXPG    BEGSR
      *
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *
     CSR         ZXEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * ZYEXPG   - Exit program: Direct                                  *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * ZXEXPG   - Exit program: Normal                                  *
      * ZZINIT   - Initialisation                                        *
      *                                                                  *
      ********************************************************************
     CSR         ZYEXPG    BEGSR
      *
      * ROLLBACK any uncommitted DBF changes.
      *
     C                     ROLBK                       90
      *
      * Terminate program.
      *
     C                     SETON                     LR
      *
      * Exit program.
      *
     C                     RETRN
      *
     CSR         ZYEXIT    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * ZZINIT   - Initialisation                                        *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * Y2BGCMC  - Begin Commit control                                  *
      * ZYEXPG   - Exit program: Direct                                  *
      * MEIZ#2   - Initialise subfile control                            *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - Main Processing                                       *
      *                                                                  *
      ********************************************************************
     CSR         ZZINIT    BEGSR
      *
      ** Set up copyright parameter
     C                     MOVEACPY@      ACT@   80
      *
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
      *
      * Define work field run day number
      *
     C                     Z-ADD*ZERO     WUAKTX  50
      *
      * Obtain default message file.
      *
     C           *NAMVAR   DEFN Y2MGFLA   ZADFMF 10
     C                     IN   ZADFMF
      *
      * Define work field Midas Run Date
      *
     C                     MOVEL*BLANK    WUHZNB  7
      *
      * Define work field Set Up Complete
      *
     C                     MOVEL*BLANK    WUAUST  1
      *
      * Define work field date format flag
      *
     C                     MOVEL*BLANK    WUE3ST  1
      *
      * Define work field Multi-branching Indicator
      *
     C                     MOVEL*BLANK    WUF1ST  1
      *
      * Open files.
      * Begin commit control.
      *
     C                     CALL 'Y2BGCMC'
     C                     PARM           W0RTN   7
     C           W0RTN     IFNE *BLANK
     C           W0RTN     ANDNE'CPF8351'
     C                     EXSR ZYEXPG
     C                     ENDIF
     C                     OPEN ERITCDL0
      *
     C                     Z-ADD15        ##SFPG  30        SFLPAG
     C                     Z-ADD1         ##SFRC
     C                     Z-ADD*ZERO     ##RRMX            MAX RECNO
      *................................................................
      * If member empty, set to *ADD mode, else to *CHANGE mode.
      *
     C           @1NROP    IFEQ *ZERO
     C                     MOVEL'ADD'     W0PMD   3         Add mode
     C                     ELSE
     C                     MOVEL'CHG'     W0PMD             Change mode
     C                     ENDIF
      *
      * USER: Initialise program
      *
      * Standard RPG Creation PAR - Standard Functions  * 
      * Get Rundate - Rundate  * 
      *
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
     C                     MOVE AANA      ##AANA
     C                     MOVE AANA      WUHZNB
     C                     MOVE AKTX      WUAKTX
     C                     MOVE AUST      WUAUST
     C                     MOVE E3ST      WUE3ST
     C                     MOVE F1ST      WUF1ST
      *
      * Check the default branch for the user
      *
     C           ##USR     CHAINMUSER                83
     C           *IN83     IFEQ '0'
     C                     MOVE DBRN      WWDBRN  3
     C                     ELSE
     C                     MOVE *BLANKS   WWDBRN
     C                     ENDIF
      *
      * Check user authorised to action code
      *
     C                     Z-ADD1         X       10
     C           X         DOWLE4                          B1
      *
     C           X         IFEQ 1
     C                     MOVE 'A'       ZACTN   1
     C                     ENDIF
      *
     C           X         IFEQ 2
     C                     MOVE 'E'       ZACTN
     C                     ENDIF
      *
     C           X         IFEQ 3
     C                     MOVE 'I'       ZACTN
     C                     ENDIF
      *
     C           X         IFEQ 4
     C                     MOVE 'D'       ZACTN
     C                     ENDIF
      *
      * If multibranched
      *
     C           WUF1ST    IFEQ 'Y'                        B2
     C                     CALL 'ZVACTBU'
     C                     PARM           ZACTN   1
     C                     PARM WWDBRN    ZBR     3
     C                     PARM *ZEROS    @ERR    10
     C                     ELSE                            X2
     C                     CALL 'ZVACTU'
     C                     PARM           ZACTN   1
     C                     PARM *ZEROS    @ERR    10
     C                     ENDIF                           E2
      *
     C           @ERR      IFEQ 0                          B2
      *
     C           ZACTN     IFEQ 'E'
     C                     MOVE *ON       *IN40
     C                     ENDIF
      *
     C           ZACTN     IFEQ 'A'
     C                     MOVE *ON       *IN41
     C                     ENDIF
      *
     C           ZACTN     IFEQ 'I'
     C                     MOVE *ON       *IN42
     C                     ENDIF
      *
     C           ZACTN     IFEQ 'D'
     C                     MOVE *ON       *IN43
     C                     ENDIF
      *
     C                     ENDIF                           E2
      *
     C                     ADD  1         X
     C                     ENDDO                           E1
      *
      * Initialise subfile control.
      *
     C                     EXSR MEIZ#2
      *
     C           KPOS      KLIST
     C                     KFLD           N2BOIC
      *
     CSR         ZZEXIT    ENDSR
      /EJECT
     C/COPY ZSRSRC,ZALIGNZ2
      /EJECT
**   CMD
F3=Exit   F5=Refresh   F9=Go to 'Change' mode
F3=Exit   F5=Refresh   F9=Go to 'Add' mode   D=Delete
F3=Exit   F5=Refresh   F9=Go to 'Add' mode
F3=Exit
F3=Exit   F5=Refresh   D=Delete
**  CPY@
(C) Copyright Midas-Kapiti International Ltd. 1997
