     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Guarantees and Pledges Maintenance')          *
/*OVRF*: OVRDBF FILE(PMPORTXX) TOFILE(PMPORTPD) SHARE(*NO)          : *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                         *
     F*                                                               *
     F*  LB0220 - Guarantees and Pledges Maintenance                  *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. CDL099             Date 06Oct17               *
      *  Prev Amend No. CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CDL049             Date 07Jul06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CSE071             Date 19Jul05               *
      *                 CDL038             Date 10May05               *
      *                 CSW037A            Date 02May05               *
      *                 CDL028             Date 07Feb05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CPB001             Date 18Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 087628             Date 04Sep95               *
     F*                 080106             DATE 09JAN95               *
     F*                 080767             DATE 28DEC94               *
     F*                 080556             DATE 20DEC94               *
     F*                 S01498             DATE 11AUG94               *
     F*                 054787     GB      DATE 05MAY93               *
     F*                 S01313             DATE 24FEB93               *
     F*                 B08218             DATE 24FEB93               *
     F*                 B08040             DATE 25NOV91               *
     F*                 B10519     PA      DATE 21OCT91               *
     F*                 B10091     JVM     DATE 11OCT91               *
     F*                 B7979              DATE 26SEP91               *
     F*                 B9669      SL      DATE 05SEP91               *
     F*                 001280     PA      DATE 02AUG91               *
     F*                 R0065      LC      DATE 31JAN91               *
     F*                 R0746              DATE 16NOV90               *
     F*                 R0552      DC      DATE 90OCT90               *
     F*                 R00300             DATE 21AUG90               *
     F*                 S01241             DATE 25JUL90               *
     F*                 B4809              DATE 24JUL90               *
     F*                 LB0009             DATE 09JUL90               *
     F*                 LB0000             DATE 15JUN90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CLE134 - Past Due Call Loan Processing (Recompile)           *
      *  CLE148 - Alpha Loan Reference                                *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus (Recompile)                              *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CDL028 - Automatic Rate Interpolations (Recompile)           *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
     F*  CPB001 - 'Private Banking' Module                               *
     F*  087628 - Add branches to accounts                            *
     F*  080106 - Miscellaneous errors on validation                  *
     F*  080767 - SHORT NAME NOT UPDATED                              *
     F*  080556 - Date of Last Update not updated correctly           *
     F*  S01498 - Portfolio Lending Upgrade to Release 10.            *
     F*  054787 - WRONG MESSAGE WHEN ' GIVEN BY ' IS BLANK            *
     F*  S01313 - PORTFOLIO PERFORMANCE CHANGES                       *
     F*  B08218 - Use CLOAN instead of CLOANCL1                       *
     F*  B08040 - SUNDRY FIXES TO SPEED UP COB                        *
     F*  B10519 - Display always borrowing power amount               *
     F*  B10091 - If Security or Collateral given by can be same as   *
     F*           given to                                            *
     F*  B7979  - Increment Order No. by 1 not 10 (else too small)    *
     F*  B9669  - Field 'Agreement signed' should default to 'N'      *
     F*  001280 - If type is collateral, guarantee or security,       *
     F*           the Issued may be blank.                            *
     F*  R0065  - Warning if issuer of pledge has no commitment line  *
     F*  R0746  - SNB code not mandatory for pledges                  *
     F*  R0552  - No insert in master file when the window is on.     *
     F*  R00300 - Message file changes                                *
     F*  S01241 - WINDOW INCORPORATION                                *
     F*  B4809  - Used to secure fields may now be blank for fixed    *
     F*           and limited pledges                                 *
     F*  LB0009 - Change review from subfile to process more than     *
     F*           one entry                                           *
     F*  LB0000 - FIX remove start date back value validation         *
     F*           FIX maturity date validation                        *
     F*         - FIX borrowing power output to screen                *
     F*         - FIX If Applied % is 0, put 100 into file field      *
     F*         - FIX change to right align Pledge %                  *
     F*         - FIX change to update pledge amount in amend mode    *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F********************************************************************
     F**
     F** FILE DEFINITIONS
     F** ----------------
     F*
     F***Midas*Modules*Present?*-*Prefix*BG*******************************S01498
     F*SDMMODPDIF  E                    DISK         KINFSR *PSSR         S01498
     F*
     F***Bank*Details*File*-*Prefix*BJ************************************S01498
     F*SDBANKPDIF  E                    DISK         KINFSR *PSSR         S01498
     F*
     F** Securities File - No Prefix
     FSECTY   IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Account master File - No Prefix
     F***ACCNABL1IF  E           K        DISK         KINFSR *PSSR       S01498
     FLBACCNL1IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F** Account master File - No Prefix
     F*ACCNTPT IF  E           K        DISK         KINFSR *PSSR         S01498
     FPMACCNL1IF  E           K        DISK         KINFSR *PSSR          S01498
     F            ACCNTABF                          KRENAMEACCNTPTF
     F*
     F** Deals File - No Prefix
     FDEALS   IF  E           K        DISK         KINFSR *PSSR
     F            DEALSDGF                          KIGNORE               S01498
     F*
     F** Deals Customer File - No Prefix
     FCUSDL   IF  E           K        DISK         KINFSR *PSSR
     F            DEALSDBF                          KRENAMECUSDLDBF
     F            DEALSDCF                          KRENAMECUSDLDCF
     F            DEALSDDF                          KRENAMECUSDLDDF
     F            DEALSDEF                          KRENAMECUSDLDEF
     F*********** DEALSDGF                          KRENAMECUSDLDGF       S01498
     F            DEALSDGF                          KIGNORE               S01498
     F*
     F** Investment types file. No prefix.
     FINVTPC  IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Borrowing power file. Prefix BP.
     FLBBPWRL1IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Borrowing power file. Prefix BP.
     FLBBPWRL2IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD2
     F*
     F** Borrowing power file. Prefix BP.
     FLBBPWRL3IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD3
     F*
     F** Borrowing power file. Prefix BP.
     FLBBPWRL4IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD4
     F*
     F** Borrowing power file. Prefix BP.
     FLBBPWRL5IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD5
     F*
     F***Fiduciary*Deposits*File*-*Prefix*FD******************************S01498
     F*FIDEPOL0IF  E           K        DISK         KINFSR *PSSR         S01498
     F*
     F***Fiduciary*Deposits*File*-*Prefix*FD******************************S01498
     F*FIDEPOL1IF  E           K        DISK         KINFSR *PSSR         S01498
     F*********** FIDEPOD0                          KRENAMEFIDEPOD1       S01498
     F*
     F***Portfolio*lending*Credit*I*C*D**-*Prefix*LB**********************S01498
     F*SDLOMBPDIF  E                    DISK         KINFSR *PSSR         S01498
     F*
     F***Currency*Codes*****-*Prefix*A6***********************************S01498
     F*SDCURRL1IF  E           K        DISK         KINFSR *PSSR         S01498
     F*
     F** Portfolio ?        - Prefix QC
     F*PMPOTTPPIF  E           K        DISK         KINFSR *PSSR         S01498
     FPMPOTTPDIF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F** Client Master file - Prefix BB & CU
     F*SDLBCSL8IF  E           K        DISK         KINFSR *PSSR         S01498
     FLBLBCSJ8IF  E           K        DISK         KINFSR *PSSR          S01498
     F            SDLBCSJ0                          KRENAMESDLBCSJ8
     F*
     F** Client Master file - Prefix BB & CU
     F*SDLBCSL7IF  E           K        DISK         KINFSR *PSSR         S01498
     FLBLBCSJ7IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F** Loans file         - No prefix
     F*CLOANCL1IF**E****       K        DISK         KINFSR *PSSR         B08218
     FCLOAN   IF  E           K        DISK         KINFSR *PSSR          B08218
     F            CLOANHHF                          KIGNORE               B08218
     F            CLOANCKF                          KIGNORE               B08218
     F            CLOANZ1F                          KIGNORE               B08218
     F*
     F** Facliity File      - No prefix
     F**FCLYFML2IF  E           K        DISK         KINFSR *PSSR        S01498
     FLBFCLTL2IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F** Portfolio positions - Prefix QA
     FPMCPOSLLIF  E           K        DISK         KINFSR *PSSR
     F*
     F** Portfolio Details - Prefix PN
     F*PMPORTPPUF  E           K        DISK         KINFSR *PSSR      UC S01498
     FPMPORTPDUF  E           K        DISK         KINFSR *PSSR      UC  S01498
     F*                                             KCOMIT
     F*
     F** Portfolio Details - Prefix PX
     FPMPORTXXIF  E           K        DISK         KINFSR *PSSR      UC
     F            PMPORTP0                          KRENAMEPMPORTPX
     F*
     F** Guarantees/Pledges Details - Prefix PG
     FLBPLEGLNIF  E           K        DISK         KINFSR *PSSR
     F            LBPLEGD0                          KRENAMELBPLEGDN
     F*
     F** Guarantees/Pledges Details - Prefix PG
     FLBPLEGLAIF  E           K        DISK         KINFSR *PSSR
     F                                              KINFDS ERF1DS
     F            LBPLEGD0                          KRENAMELBPLEGDA
     F*
     F** Portfolio lending Extract Summary    - Prefix ES
     FLBEXTSL1IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Guarantees/Pledges Details - Prefix PG
     FLBPLEGPDUF  E                    DISK         KINFSR *PSSR A
     F                                              KINFDS ERF2DS
     F                                              KCOMIT
     F*
     F** Portfolio lending Credits TRailer Details - Prefix TR
     FLBTRAIPDUF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
     F*
     F** Maintenance screens
     FLB0220DFCF  E                    WORKSTN      KINFDS L220DS
     F                                        RRN   KSFILE LB0220S2
     F                                              KINFSR *PSSR
     F*
     F********************************************************************
     F/EJECT
     F*****************************************************************
     F** ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F**                                                              *
     F**       18         Multibranching indicator                    *   S01498
     F**       20         ENABLE CMD-12 PREVIOUS SCREEN               *
     F**       21         ENABLE CMD-10 DELETE                        *
     F**                                                              *
     F**       24         ROLLDOWN                                    *
     F**       25         ROLLUP                                      *
     F**       26         SFLEND (MESSAGE SUBFILE)                    *
     F**       27         LOKUP                                       *
     F**                                                              *
     F**       28         (RI PC) ON ACTION                           *
     F**       29         (RI PC) ON CUSTOMER                         *
     F**       30         (RI PC) ON COLLATERAL NUMBER                *
     F**       31         (RI PC) ON SEQUENCE NUMBER                  *
     F**                                                              *
     F**       32         (RI PC) ON REVIEW FROM CUSTOMER             *
     F**       33         (RI PC) ON REVIEW FROM COLLATERAL           *
     F**       34         (RI PC) ON REVIEW FROM SEQUENCE             *
     F**                                                              *   LB0009
     F**       35         SFLNXTCHG                                   *   LB0009
     F**                                                              *
     F**       36         (RI PC) ON ACTION FIELD - REVIEW SUBFILE    *
     F**                                                              *
     F**       37         SFLDSPCTL                                   *
     F**       38         SFLDSP                                      *
     F**       39         SFLEND                                      *
     F**       40         SFLCLR                                      *
     F**                                                              *
     F**       41         FILE ACCESS                                 *
     F**       42          "     "                                    *
     F**       43          "     "                                    *
     F**       44          "     "                                    *
     F**       45          "     "                                    *
     F**       46          "     "                                    *
     F**       47          "     "                                    *
     F**                                                              *
     F**       48         AT LEAST ONE NON BLANK SELECTION ON THE     *   LB0009
     F**                  'REVIEW FROM' SCREEN                        *   LB0009
     F**                                                              *   LB0009
     F**       49         AT LEAST 1 RECORD FOUND                     *
     F**                                                              *
     F**       50         CONDITION DISPLAY OF CERTAIN FIELDS         *
     F**       51         DEPENDING ON THE MODULES INSTALLED          *
     F**       52             "           "           "               *
     F**       53             "           "           "               *
     F**       54         CONDITION DISPLAY OF DELETED TEXT           *
     F**       55         CONDITION DISPLAY OF FUNCTION KEY TEXT      *
     F**                                                              *
     F**       56         (RI PC) ON REVIEW FROM CUSTOMER NUMBER      *
     F**       57         (RI PC) ON REVIEW FROM COLLATERAL           *
     F**       58         (RI PC) ON REVIEW FROM SEQUENCE             *
     F**                                                              *
     F**       59         (RI PC) ON CUSTOMER NUMBER                  *
     F**       60         (RI PC) ON TYPE                             *
     F**       61         (RI PC) ON CODE                             *
     F**       63         (RI PC) ON GIVEN BY                         *
     F**       64         (RI PC) ON CURRENCY                         *
     F**       65         (RI PC) ON AGREEMENT SIGNED                 *
     F**       66         (RI PC) ON AGREEMENT DATE                   *
     F**       67         (RI PC) ON START DATE                       *
     F**       68         (RI PC) ON MATURITY DATE                    *
     F**       69         (RI PC) ON REVIEW DATE                      *
     F**       70         (RI PC) ON REVIEW FREQUENCY                 *
     F**       71         (RI PC) ON REVIEW DAY NUMBER                *
     F**                                                              *
     F**       72         (RI PC) ON USED TO SECURE ACCOUNT           *
     F**       73         (RI PC) ON USED TO SECURE LOAN              *
     F**       74         (RI PC) ON USED TO SECURE FACILTY           *
     F**       75         (RI PC) ON USED TO SECURE PORTFOLIO         *
     F**                                                              *
     F**       76         (RI PC) ON AMOUNT                           *
     F**       77         (RI PC) ON PERCENTAGE                       *
     F**       78         (RI PC) ON ORDER NUMBER                     *
     F**       79         (RI PC) ON BORROWING POWER                  *
     F**       80         (RI PC) ON SECURITY REFERENCE               *
     F**       81         (RI PC) ON PORTFOLIO REFERENCE              *
     F**       82         (RI PC) ON ACCOUNT NUMBER                   *
     F**                                                              *
     F**       83         (RI PC) ON DEAL NUMBER                      *
     F**       84         (RI PC) ON DEAL CUSTOMER CODE               *
     F**                                                              *
     F**       85         (RI PC) ON FIDUCIARY DEPOSIT NUMBER         *
     F**       86         (RI PC) ON FIDUCIARY CUSTOMER CODE          *
     F**                                                              *
     F**       87         (RI PC) ON PLEDGE AMOUNT                    *
     F**       88         (RI PC) ON PLEDGE PERCENTAGE                *
     F**       89         (RI PC) ON PLEDGE PORTFOLIO REFERENCE       *
     F**                                                              *
     F**       98         DATE FORMAT INDICATOR                       *
     F**       99         EDIT ERROR                                  *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     E*
     E** Array for COPYRIGHT
     E                    CPY@    1   1 80
     E*
     E** Array of ALPHANUMERICS
     E                    ALPNU  37  37  1
     E*
     E** Array of NUMBERS
     E                    NUM    10  10  1
     E*
     E** Array for CUST NO / SHORTNAME FIELD
     E                    INP1       10  1
     E*
     E** Array for CUST NO / SHORTNAME FIELD (AMEND/INSERT)
     E                    INP3       10  1
     E*****************************************************************
     E/COPY ZSRSRC,ZALIGNZ1
     E*****************************************************************
     E/EJECT
     E*****************************************************************
     E/COPY ZSRSRC,ZSEDITZ1
     E*****************************************************************
     E/EJECT
     E*****************************************************************
     E/COPY ZSRSRC,ZDATE2Z1
     E*****************************************************************
     I/EJECT
     I********************************************************************
     IACCNTABF                                                            S01313
     I              SCAP                            RNSCAP                S01313
     IACCNTPTF                                                            S01313
     I              SCAP                            RNSCAP                S01313
     I*
     I** Rename fields on SECTY
     ISECTYDF
     I              NMCY                            SENMCY
     I              NMDP                            SENMDP
     I              SITP                            SESITP
     I              SPBS                            SESPBS
     I              ISSP                            SEISSP
     I              MKPR                            SEMKPR
     I              CFCT                            SECFCT
     I              ITLD                            SEITLD
     I              MATY                            SEMATY
     I*
     I** Data structure to pass data to window                            S01241
     I*
     I/COPY QWINDSRC,LB0220DTA                                            S01241
     I*
     I** Data structure for compilation - Copyright Insertion
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*
     I** Data structure to split Used to secure facility (5a)
     IWWDS        DS
     I                                        1   50WWETSF
     I                                        1   30WWFACT
     I                                        4   50WWFCNO
     I*
     I** Data structure to split REVIEW DATE into DD MM YY
     IWWRDAT      DS
     I                                        1   6 DD3EVD
     I                                        1   2 WWDD
     I                                        3   4 WWMM
     I                                        5   6 WWYY
     I*
     I** Data structure to split customer no./shortname
     IWWCND1      DS
     I                                        1  10 DDCNUM
     I                                        1  10 INP1
     I                                        7  10 WWL1
     I*
     I** Data structure to split customer no./shortname (AMEND/INSERT)
     IWWCND3      DS
     I                                        1  10 DD3SSB
     I                                        1  10 INP3
     I                                        7  10 WWL3
     I*
     I** Data structure to split MIDAS run date
     I            DS
     I***********                             1   7 BJMRDT                S01498
     I                                        1   7 WWMRDT                S01498
     I                                        1   20WWDLUP
     I                                        3   5 WWMLUP
     I                                        6   70WWYLUP
     I*
     I** Data structure to change display %age to numerics
     I            DS
     I                                        1   3 DD3GPE
     I                                        1   30WW3GPE
     I*
     I** Display file information data structure
     I*
     IL220DS      DS
     I                                    B 378 3790SFLL
     I*
     I** LBPLEGLA information data structure
     I*
     IERF1DS      DS
     I                                    B 397 4000LGARRN
     I*
     I** FILE INFORMATION DATA STRUCTURE - LBPLEGPD
     IERF2DS      DS
     I                                     *STATUS  STATUS
     I*
     I** Program status Data structure
     IPSDS       SDS
     I                                      244 253 DDJOB
     I                                      254 263 USER
     I*
     I**  Local data area
     I*LDA*******UDS                            256                       S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*
     I** Data Structure to UPDATE LAST TRANSACTION NUMBER DTAARA
     IDNATN       DS                              5
     I                                        1   50FNATN
     I*
     I** Data Structure TO PROVIDE TEXT ON COMIT ENTRY IN JOURNAL
     ICMTTXT      DS                             55
     I                                        1   50WWNATN
     I                                        6   7 MDID
     I                                        8  17 PGMN
     I                                       18  27 WSIDX
     I                                       28  330MTIME
     I                                       34  34 ACTCDX
     I                                       35  42 USIDX
     I                                       43  52 DD3SHN
     I                                       53  55 DD3SEQ
     I*                                                                   S01498
     IRUNDAT    E DS                                                      S01498
     I** Rundate data area                                                S01498
     I*                                                                   S01498
     IZMUSER    E DS                                                      S01498
     I** Midas user data area                                             S01498
     I*                                                                   S01498
     ISDBANK    E DSSDBANKPD                                              S01498
     I** Bank details                                                     S01498
     I*                                                                   S01498
     ISDMMOD    E DSSDMMODPD                                              S01498
     I** Midas modules                                                    S01498
     I*                                                                   S01498
     ISDCUST    E DSSDCUSTPD                                              S01498
     I** Customer details                                                 S01498
     I*                                                                   S01498
     ISDLOMB    E DSSDLOMBPD                                              S01498
     I** Portfolio Lending ICD                                            S01498
     I*                                                                   S01498
     ISDCURR    E DSSDCURRPD                                              S01498
     I** Currency codes                                                   S01498
     I*                                                                   S01498
     IDSFDY     E DSDSFDY                                                 S01498
     I** First DS for access programs, short data structure               S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I** Second DS for access programs, long data structure               S01498
     I*
     I** Data Structure for KEY LIST 8
     I            DS
     I                                        1  10 KLST8
     I**********                              1   60HHISSB                                    CSD027
     I                                        1   6 HHISSB                                    CSD027
     I                                        7  10 HHPORP
     I*
     I** Data Structure for KEY LIST 6
     I            DS
     I                                        1  10 KLST6
     I**********                              1   60WWCUS2                                    CSD027
     I                                        1   6 WWCUS2                                    CSD027
     I                                        7  10 DD3ORP
     I*
     I** Data Structure for SPLIT ACCOUNT NUMBER
     I            DS
     I**********                              1  15 KACNT                                     CGL029
     I                                        1  21 KACNT                                     CGL029
     I**********                              1   60WKACNU                                    CSD027
     I                                        1   6 WKACNU                                    CSD027
     I                                        7   9 WKCCY
     I**********                             10  130WKACOD                                    CGL029
     I**********                             14  150WKACSQ                                    CGL029
     I                                       10  190WKACOD                                    CGL029
     I                                       20  210WKACSQ                                    CGL029
     I*
     I**   USED TO OUTPUT INVESTMENT TYPES KEY IF DATABASE ERROR
     I            DS
     I                                        1   6 WWITDS
     I                                        1   3 SESITP
     I                                        4   6 SENMCY
     I/EJECT
     I*****************************************************************
     I/COPY ZSRSRC,ZSEDITZ2
     I*****************************************************************
     I/EJECT
     C*****************************************************************
     C*
     C** DEFINE KLISTS
     C*  =============
     C*
     C** Key List for LBPLEGLA (Entered Customer no./collateral/sequence)
     C*
     C           KL1       KLIST
     C                     KFLD           WWCUS1
     C                     KFLD           WWCON1
     C                     KFLD           WWSEQ1
     C*
     C** Key List for LBPLEGLA (Entered Customer no./collateral)
     C*
     C           KPLEGA    KLIST
     C                     KFLD           WKCNUM
     C                     KFLD           WKBPSN
     C*
     C** Key List for LBPLEGLN (Covering type/Covering ref)
     C*
     C           KPLEGN    KLIST
     C                     KFLD           WKITYP
     C                     KFLD           WKIREF
     C*
     C** Key List for LBPLEGLN (Covering type/Covering ref/order no)
     C*
     C           KPLGN2    KLIST
     C                     KFLD           WKITYP
     C                     KFLD           WKIREF
     C                     KFLD           WKORDN
     C*
     C***Key*List*for*ACCNABL1*(Customer*no./acc.code/acc.seq/currency)   S01498
     C** Key List for LBACCNL1 (Customer no./acc.code/acc.seq/currency)   S01498
     C*
     C           KACCNT    KLIST
     C                     KFLD           WKACNU
     C                     KFLD           WKACOD
     C                     KFLD           WKACSQ
     C                     KFLD           WKCCY
     C                     KFLD           WKBRCA                          087628
     C*
     C***Key*List*for*ACCNTPT*(Cust.no./Portfolio Ref.)*******************S01498
     C** Key List for PMACCNL1 (Cust.no./Portfolio Ref.)                  S01498
     C*
     C           KACCPT    KLIST
     C                     KFLD           WWCUS2
     C                     KFLD           DD3TFR
     C*
     C           WWBPK1    KLIST                           'LBBPWRL1'
     C                     KFLD           WWCUS2
     C                     KFLD           LBSECU
     C*
     C           WWBPK2    KLIST                           'LBBPWRL2'
     C                     KFLD           WWCUS2
     C                     KFLD           DD3SEN
     C*
     C           WWBPK3    KLIST                           'LBBPWRL3'
     C                     KFLD           LBSECU
     C*
     C           WWBPK4    KLIST                           'LBBPWRL4'
     C                     KFLD           DD3SEN
     C*
     C           WWBPK5    KLIST                           'LBBPWRL5'
     C                     KFLD           BBCOLC
     C*
     C           WWITK1    KLIST                           'INVTPC'
     C                     KFLD           SESITP
     C                     KFLD           SENMCY
     C*
     C***Key*List*for*PMPORTPP*(Issued*By*Customer*No./Portfolio No.)*****S01498
     C** Key List for PMPORTPD (Issued By Customer No./Portfolio No.)     S01498
     C*
     C           KL2       KLIST
     C                     KFLD           HHISSB
     C                     KFLD           DD3ORP
     C*
     C***Key*List*for*FCLYFML2*(Customer*No./Used*secure*facility)        S01498
     C** Key List for LBFCLTL2 (Customer No./Used secure facility)        S01498
     C*
     C           KL3       KLIST
     C                     KFLD           HHCNUM
     C                     KFLD           WWFACT
     C                     KFLD           WWFCNO
     C*
     C** Key List for PMPORTXX (Customer No./Portfolio Number)
     C*
     C           KL4       KLIST
     C                     KFLD           HHCNUM
     C                     KFLD           DD3TSP
     C*
     C** Key List for PMCPOSL0 (Customer No./Portfolio Ref./Security
     C** Shortname)
     C*
     C           KL5       KLIST
     C                     KFLD           WWCUS2
     C                     KFLD           DD3TFR
     C                     KFLD           DD3SEN
     C*
     C** Key List for PMPORTXX (Customer No./Portfolio Ref.)
     C*
     C           KPMPXX    KLIST
     C                     KFLD           WWCUS2
     C                     KFLD           DD3TFR
     C*
     C** Key List for XXXXXXXX (Issued by Cust/Portfolio Ref)
     C*
     C           KL6       KLIST
     C                     KFLD           WWCUS2
     C                     KFLD           DD3ORP
     C*
     C***Key*List*for*PMPORTPP*(Issued*By*Customer*No./Portfolio No.)*****S01498
     C** Key List for PMPORTPD (Issued By Customer No./Portfolio No.)     S01498
     C*
     C           KL8       KLIST
     C                     KFLD           HHISSB
     C                     KFLD           HHPORP
     C*                                                                   B08218
     C** KLIST FOR CLOAN                                                  B08218
     C*                                                                   B08218
     C           KL11      KLIST                                          B08218
     C                     KFLD           WWETSL                          B08218
     C                     KFLD           WWRECT  1                       B08218
     C*****************************************************************
     C* DEFINE DATA AREA LDA                                              S01241
     C*                                                                   S01241
     C           *NAMVAR   DEFN           LDA                             S01241
     C*                                                                   S01241
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  Main Line Processing                                        *
     C**                                                              *
     C*****************************************************************
     C*
     C** Initialisation Process
     C*
     C                     EXSR #A
     C*
     C** Loop until Exit Key pressed.
     C*
B1   C           *INKC     DOUEQ'1'
     C*
     C** Validate selection
     C*
     C                     EXSR #B
     C*
     C** Exit or Restart Screen not requested / no errors
     C*
B2   C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C           *IN99     ANDEQ'0'
     C*
     C** REVIEW FROM SCREEN PROCESSING
     C** -----------------------------
     C*
B3   C           DDACTC    IFEQ *BLANKS
     C*
     C                     EXSR #C
     C*
     C** NORMAL REQUEST MADE
     C** -------------------
     C*
X3   C                     ELSE
     C*
     C                     EXSR #E
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** Termination Process
     C*
     C                     MOVE '1'       *INLR
     C                     RETRN
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    INDEX TO SUBROUTINES                                      *
     C**   ----------------------                                     *
     C**                                                              *
     C**   #ZALIGN  - VALIDATE AND RIGHT ALIGN NUMERIC AMOUNTS        *
     C**   #ZDATE1  - CONVERT DATE TO MIDAS DAY NUMBER                *
     C**   #ZDATE2  - CONVERT MIDAS DAY NUMBER FOR OUTPUT             *
     C**   #ZSEDIT  - CONVERT AMOUNT FOR OUTPUT                       *
     C**                                                              *
     C**   #A       - INITIAL PROCESSING                              *
     C**   #B       - SCREEN 1 PROCESSING                             *
     C**   #BB      - VALIDATE SCREEN 1 (1)                           *
     C**   #BBA     - VALIDATE SHORTNAME                              *
     C**   #BBB     - VALIDATE CUSTOMER NUMBER                        *
     C**   #BBC     - VALIDATE SCREEN 1 (2)                           *
     C**   #BBD     - REVIEW REQUEST VALIDATION                       *
     C**   #C       - REVIEW FROM PROCESSING                          *
     C**   #CA      - PROCESS SUBFILE BUILD                           *
     C**   #CAA     - BUILD REVIEW FROM SUBFILE PAGE                  *
     C**   #CB      - VALIDATE SUBFILE SELECTION                      *
     C**   #CC      - REVIEW REQUEST VALIDATION                       *
     C**   #D       - FILE MAINTENANCE CONTROL FROM REVIEW FROM       *
     C**              SUBFILE SELECTION                               *
     C**   #DA      - ENQUIRY/DELETE/AMEND - INITIALISE FIELDS        *
     C**   #DAA     - CONVERT ALL AMOUNTS TO DISPLAY FORMAT           *
     C**   #DAB     - CONVERT ALL DATES TO DISPLAY FORMAT             *
     C**   #DB      - INSERT MODE INITIALISE SCREEN                   *
     C**   #DC      - PROCESS SCREEN 3 - ENQUIRY                      *
     C**   #DD      - PROCESS SCREEN 3 - DELETE                       *
     C**   #DE      - PROCESS SCREEN 3 - INSERT/AMEND                 *
     C**   #DEA     - VALIDATE SCREEN 3 - INSERT/AMEND                *
     C**   #DEAA    - VALIDATE TYPE & CODE                            *
     C**   #DEAB    - VALIDATE ISSUED BY CUSTOMER AND CURRENCY        *
     C**   #DEAC    - VALIDATE AGREEMENT SIGNED FIELD AND THE         *
     C**              FOLLOWING DATES - START DATE , AGREEMENT        *
     C**              DATE , MATURITY DATE & REVIEW DATE              *
     C**   #DEAD    - VALIDATE REVIEW FREQUENCY AND REVIEW DAY NO.    *
     C**   #DEAE    - VALIDATE 'USED TO SECURE' FIELDS                *
     C**   #DEAEA   - VALIDATE 'USED TO SECURE' ACCOUNT               *
     C**   #DEAEB   - VALIDATE 'USED TO SECURE' LOAN                  *
     C**   #DEAEC   - VALIDATE 'USED TO SECURE' FACILTY               *
     C**   #DEAED   - VALIDATE 'USED TO SECURE' PORTFOLIO             *
     C**   #DEAF    - VALIDATE TYPE SPECIFIC INPUT                    *
     C**   #DEAG    - VALIDATE PERCENTAGE.                            *
     C**   #DEAH    - VALIDATE SECURITY REF AND PORTFOLIO REF         *
     C**   #DEAI    - VALIDATE GUAR,COLL,SECURITY AMOUNT              *
     C**   #DEAJ    - VALIDATE ACCOUNT NUMBER                         *
     C**   #DEAK    - VALIDATE DEAL NUMBER & DEAL CUSTOMER CODE       *
     C**   #DEAL    - VALIDATE FID. DEP. NUMBER & CUSTOMER CODE       *
     C**   #DEAM    - VALIDATE PLEDGE FIELDS                          *
     C**   #DEAN    - CHECK START DATE & MATURITY DATE                *
     C**              ARE IN THE CORRECT RANGE                        *
     C**   #DEAO    - VALIDATE ORDER NO.                              *
     C**   #DEB     - FILE UPDATE - INSERT/AMEND                      *
     C**   #DEBA    - CALCULATE PLEDGE AMOUNT                         *
     C**   #DEBAA   - CALCULATE AVAILABLE LENDING                     *
     C**   #DEBB    - UPDATE FILES (INSERT)                           *
     C**   #DEBC    - UPDATE FILES (AMEND)                            *
     C**   #DEBD    - CALCULATE BORROWING POWER                       *
     C**   #DEBDA   - CALCULATE BORROWING POWER PERCENTAGE            *
     C**   #DEBDB   - CALCULATE COLLATERAL                            *
     C**   #DEBE    - UPDATE PORTFOLIO MANAGEMENT FILES               *
     C**   #E       - FILE MAINTENANCE CONTROL FROM NORMAL REQUEST    *
     C**   #EA      - SAVE HIDDEN FIELDS                              *
     C**                                                              *
     C**   #ZA      - CALL ZDATE1                                     *
     C**   #ZB      - SET UP FIELDS FOR INSERT/AMEND ON LBPLEGPD      *
     C**   #ZC      - CHECK COLLATERAL NOT USED TO SECURE ANOTHER     *
     C**              ACCOUNT/LOAN/FACILITY/PORTFOLIO                 *
     C**                                                              *
     C**   #ZTNLU1  - RETRIEVE/UPDATE TRANS. NO. LAST UPDATE          *
     C**   ZASNMS   - SEND MESSAGE TO PROGRAMS MESSAGE QUEUE          *
     C**   *PSSR    - ERROR HANDLING                                  *
     C**                                                              *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZALIGNZ2
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZDATE1Z2
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZDATE2Z2
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZSEDITZ3
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #A  - Initial processing                         *
     C**                                                              *
     C**  CALLS          - NONE                                       *
     C**                                                              *
     C**  CALLED BY      - MAINLINE                                   *
     C**                                                              *
     C*****************************************************************
     C           #A        BEGSR
     C*                                                                   S01498
     C***  Copyright Statement                                            S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*
     C**   SET OFF ALL INDICATORS
     C*
     C                     MOVEA'00000000'*IN,21           OFF 21-28
     C                     MOVEA'000'     *IN,29           OFF 29-31
     C                     MOVEA'00000000'*IN,40           OFF 40-47
     C                     MOVEA'00000000'*IN,50           OFF 50-57
     C                     MOVEA'000'     *IN,58           OFF 58-60
     C                     MOVEA'00'      *IN,98           OFF 98-99
     C*                                                                   LB0009
     C** Initialise records selected indicator                            LB0009
     C*                                                                   LB0009
     C                     MOVE '0'       *IN48                           LB0009
     C*
     C** Initialise DB error fields and store program name
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'LB0220'  DBPGM
     C                     MOVE *BLANKS   DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY                           S01498
     C                     OUT  LDA                                       S01498
     C*
     C** Initialize MESSAGE FILE NAME
     C                     MOVE *BLANKS   ZAMSGF
     C*********************MOVEL'LXGBMSGF'ZAMSGF                          R00300
     C                     MOVEL'LBUSRMSG'ZAMSGF 10        Message file   R00300
     C*****                MOVEL*BLANK    ZAPGRL  5        Rel queue      R0065
     C                     MOVEL*BLANK    ZAMSID  7        Message Id.    R00300
     C                     MOVEL*BLANK    ZAMSDA132        Message data.  R00300
     C                     MOVEL*BLANK    ZAMSTP  7        Message type.  R00300
     C*
     C** Read Bank Details File
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 43               S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM '*DBERR ' @RTCD   7                       S01498
     C                     PARM '*FIRST ' @OPTN   7                       S01498
     C           SDBANK    PARM SDBANK    DSSDY                           S01498
     C*
     C           @RTCD     IFEQ *BLANKS                                   080556
     C                     MOVELBJMRDT    WWMRDT                          080556
     C                     END                                            080556
     C*                                                                   080556
     C************IN43     IFEQ '1'                                       S01498
     C***********BJTYLC    OREQ 'D'                                       S01498
     C***********          MOVE *BLANKS   DBFILE                          S01498
     C***********          MOVEL'SDBANKPD'DBFILE           ***************S01498
     C***********          MOVE *BLANKS   DBKEY            *             *S01498
     C***********          Z-ADD1         DBASE            * DBERROR 001 *S01498
     C***********          MOVE '1'       *INU7            *             *S01498
     C***********          MOVE '1'       *INU8            ***************S01498
     C***********          MOVE '1'       *INLR                           S01498
     C***********          RETRN                                          S01498
     C***********          ELSE                                           S01498
     C*
     C** Check Date format indicator for ZDATE2
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ELSE
     C           BJDFIN    IFEQ 'D'
     C                     MOVE '0'       *IN98
     C                     END
     C                     END
     C***********          END                                            S01498
     C*
     C** Read the record on SDMMODPD to detemine whether Portfolio Management
     C** is installed / Customer  if installed
     C*
     C***********1         SETLLSDMMODPD                                  S01498
     C***********          READ SDMMODPD                 20               S01498
     C                     CALL 'AOMMODR0'                                S01498
     C                     PARM '*DBERR ' @RTCD   7                       S01498
     C                     PARM '*FIRST ' @OPTN   7                       S01498
     C           SDMMOD    PARM SDMMOD    DSSDY                           S01498
     C*
     C************IN20     IFEQ '1'                                       S01498
     C***********BGTYLC    OREQ 'D'                                       S01498
     C***********          MOVE *BLANKS   DBFILE                          S01498
     C***********          MOVEL'SDMMODPD'DBFILE           ***************S01498
     C***********          MOVE *BLANKS   DBKEY            *             *S01498
     C***********          Z-ADD2         DBASE            * DBERROR 002 *S01498
     C***********          MOVE '1'       *INU7            *             *S01498
     C***********          MOVE '1'       *INU8            ***************S01498
     C***********          MOVE '1'       *INLR                           S01498
     C***********          RETRN                                          S01498
     C***********          ELSE                                           S01498
     C*
     C** If Portfolio Management installed then open PM files
     C*
     C           BGPFMG    IFEQ 'Y'
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     OPEN PMPORTXX
     C***********          OPEN PMPORTPP                                  S01498
     C                     OPEN PMPORTPD                                  S01498
     C                     END
     C***********          END                                            S01498
     C*
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 43               S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM '*DBERR ' @RTCD   7                       S01498
     C                     PARM '*FIRST ' @OPTN   7                       S01498
     C           SDLOMB    PARM SDLOMB    DSSDY                           S01498
     C************IN43     IFEQ '1'                                       S01498
     C***********LBRECI    OREQ '*'                                       S01498
     C***********          MOVE *BLANKS   DBFILE                          S01498
     C***********          MOVEL'SDLOMBPD'DBFILE           ***************S01498
     C***********          MOVE *BLANKS   DBKEY            *             *S01498
     C***********          Z-ADD3         DBASE            * DBERROR 003 *S01498
     C***********          MOVE '1'       *INU7            *             *S01498
     C***********          MOVE '1'       *INU8            ***************S01498
     C***********          MOVE '1'       *INLR                           S01498
     C***********          RETRN                                          S01498
     C***********          END                                            S01498
     C*
     C** Initialise SUBFILE Message Queue
     C*
     C                     MOVE *BLANKS   DDPGMQ
     C                     MOVEL'*'       DDPGMQ
     C*
     C** Initialise and clear the program message queue
     C                     MOVE *BLANKS   WWTPGQ
     C                     MOVEL'*'       WWTPGQ
     C                     MOVE *BLANKS   WWPGQR
     C                     MOVEL'*PRV'    WWPGQR
     C                     MOVEL'*PRV'    ZAPGRL                          R0065
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C** Set Message Subfile Indicator
     C*
     C                     MOVE '1'       *IN26
     C*
     C** Define work fields
     C*
     C           *LIKE     DEFN PGPLED    WWPAMT                          LB0000
     C           *LIKE     DEFN PGCOLS    WWCOLL
     C           *LIKE     DEFN PGPCAA    WWBPPC
     C           *LIKE     DEFN BBCUST    WWPNP8
     C           *LIKE     DEFN BBTYLC    WWTYLC
     C           *LIKE     DEFN PGPLEP    WWPLEP
     C           *LIKE     DEFN PNTNLU    WWTNLP
     C           *LIKE     DEFN PGETYP    WWETYP
     C           *LIKE     DEFN PGEREF    WWEREF
     C           *LIKE     DEFN PGITYP    WWITYP
     C           *LIKE     DEFN PGIREF    WWIREF
     C           *LIKE     DEFN PGETYP    WKETYP
     C           *LIKE     DEFN PGEREF    WKEREF
     C           *LIKE     DEFN PGITYP    WKITYP
     C           *LIKE     DEFN PGIREF    WKIREF
     C           *LIKE     DEFN PGCNUM    WWCUS1
     C           *LIKE     DEFN PGBPSN    WWCON1
     C           *LIKE     DEFN PGSEQN    WWSEQ1
     C           *LIKE     DEFN PGCNUM    WKCNUM
     C           *LIKE     DEFN PGBPSN    WKBPSN
     C           *LIKE     DEFN PGSEQN    WKSEQN
     C           *LIKE     DEFN PGORDN    WKORDN
     C           *LIKE     DEFN PGORDN    WWORDN
     C           *LIKE     DEFN PGORDN    WWSORN
     C           *LIKE     DEFN DLNO      WWDENR
     C           *LIKE     DEFN ESTPRD    WWTPRD
     C           *LIKE     DEFN ESTPID    WWTPID
     C           *LIKE     DEFN ESCHTP    WWCHTP
     C           *LIKE     DEFN PGAGRD    WWEDAT
     C           *LIKE     DEFN PGSTTD    WWETTD
     C           *LIKE     DEFN PGSTTD    WW1SDT
     C           *LIKE     DEFN PGSTTD    WW2SDT
     C           *LIKE     DEFN PGMATD    WWEATD
     C           *LIKE     DEFN PGMATD    WW1MDT
     C           *LIKE     DEFN PGMATD    WW2MDT
     C           *LIKE     DEFN PGREVD    WWEEVD
     C           *LIKE     DEFN PGLCD     WWLCD
     C           *LIKE     DEFN PGEBCH    WWEBCH                          087628
     C           *LIKE     DEFN PGEBCH    WKEBCH                          087628
     C           *LIKE     DEFN PGIBCH    WWIBCH                          087628
     C           *LIKE     DEFN PGIBCH    WKIBCH                          087628
     C           *LIKE     DEFN PGIBCH    WKBRCA                          087628
     C*
     C** Initialise work fields
     C*
     C                     MOVE *BLANKS   WWPNP8
     C                     MOVE *BLANKS   WWTYLC
     C                     MOVE *BLANKS   WWETYP
     C                     MOVE *BLANKS   WWEREF
     C                     MOVE *BLANKS   WWITYP
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE *BLANKS   WWCHTP
     C                     MOVE *BLANKS   WWEBCH                          087628
     C                     MOVE *BLANKS   WWIBCH                          087628
     C*
     C                     Z-ADD*ZEROS    WWPAMT                          LB0000
     C                     Z-ADD*ZEROS    WWCOLL
     C                     Z-ADD*ZEROS    WWBPPC
     C                     Z-ADD*ZEROS    WWPLEP
     C                     Z-ADD*ZEROS    WWTNLP
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C**********           Z-ADD*ZEROS    WKCNUM                                              CSD027
     C                     MOVE *BLANKS   WKCNUM                                              CSD027
     C                     Z-ADD*ZEROS    WKBPSN
     C                     Z-ADD*ZEROS    WKSEQN
     C                     Z-ADD*ZEROS    WKORDN
     C                     Z-ADD*ZEROS    WWORDN
     C                     Z-ADD*ZEROS    WWSORN
     C                     Z-ADD*ZEROS    WWDENR
     C                     Z-ADD*ZEROS    WWTPRD
     C                     Z-ADD*ZEROS    WWTPID
     C                     Z-ADD*ZEROS    WWEDAT
     C                     Z-ADD*ZEROS    WWETTD
     C                     Z-ADD*ZEROS    WW1SDT
     C                     Z-ADD*ZEROS    WW2SDT
     C                     Z-ADD*ZEROS    WWEATD
     C                     Z-ADD*ZEROS    WW1MDT
     C                     Z-ADD*ZEROS    WW2MDT
     C                     Z-ADD*ZEROS    WWEEVD
     C                     Z-ADD*ZEROS    WWLCD
     C*
     C** Set SFL page size
     C*
     C                     Z-ADD13        WWSFLS  30
     C*
     C                     MOVE *BLANKS   DDLINE
     C*                                                                   S01498
     C** Read data area RUNDAT to test for multibranching                 S01498
     C           *NAMVAR   DEFN           RUNDAT                          S01498
     C                     IN   RUNDAT                                    S01498
     C           AGMBIN    IFEQ 'Y'                                       S01498
     C                     MOVE '1'       *IN18                           S01498
     C                     ELSE                                           S01498
     C                     MOVE '0'       *IN18                           S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C** Read data area ZMUSER to get default branch                      S01498
     C           *NAMVAR   DEFN           ZMUSER                          S01498
     C                     IN   ZMUSER                                    S01498
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #B  - Screen 1 processing                        *
     C**                                                              *
     C**  CALLS          - #BB #C                                     *
     C**                                                              *
     C**  CALLED BY      - MAINLINE                                   *
     C**                                                              *
     C*****************************************************************
     C           #B        BEGSR
     C*
     C** Initialise entry fields
     C*
B1   C           *IN99     IFEQ '0'
     C                     MOVE *BLANKS   DDACTC
     C                     MOVE *BLANKS   DDCNUM
     C                     MOVE *BLANKS   DD1CON
     C                     MOVE *BLANKS   DDSEQN
     C                     MOVE *BLANKS   DDRCU1
     C                     MOVE *BLANKS   DD1RCO
     C                     MOVE *BLANKS   DDRSE1
E1   C                     END
     C*
     C** Disable F10 & F12
     C*
     C                     MOVEA'00'      *IN,20           OFF 20-21
     C*
     C                     WRITELB0220F1
     C                     WRITELB0220C1
     C                     EXFMTLB0220F2
     C*
     C** Reset indicators
     C*
     C                     MOVEA'0000000' *IN,28           OFF 28-34
     C                     MOVE '0'       *IN99
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C** Exit not pressed
     C*
B1   C           *INKC     IFEQ '0'
     C*
     C** Display Review from screen if no data entered
     C*
B2   C           DDACTC    IFEQ *BLANKS
     C           DDCNUM    ANDEQ*BLANKS
     C           DD1CON    ANDEQ*BLANKS
     C           DDSEQN    ANDEQ*BLANKS
     C           DDRCU1    ANDEQ*BLANKS
     C           DD1RCO    ANDEQ*BLANKS
     C           DDRSE1    ANDEQ*BLANKS
     C*
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
     C                     EXSR #C
     C*
X2   C                     ELSE
     C*
     C** Review from fields blank
     C*
B3   C           DDRCU1    IFEQ *BLANKS
     C           DD1RCO    ANDEQ*BLANKS
     C           DDRSE1    ANDEQ*BLANKS
     C*
     C** Action Code must be valid
     C*
B4   C           DDACTC    IFNE 'I'
     C           DDACTC    ANDNE'A'
     C           DDACTC    ANDNE'D'
     C           DDACTC    ANDNE'E'
     C*
     C                     MOVE '1'       *IN28
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0039' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
     C** If action code = A,D or E
     C*
B4   C           DDACTC    IFEQ 'A'
     C           DDACTC    OREQ 'D'
     C           DDACTC    OREQ 'E'
     C*
     C** Customer , Collateral and Sequence must have been entered
     C*
B5   C           DDCNUM    IFEQ *BLANKS
     C           DD1CON    OREQ *BLANKS
     C           DDSEQN    OREQ *BLANKS
     C*
     C                     MOVEA'111'     *IN,29           ON 29-31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0078' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
E4   C                     END
     C*
     C** If action code = I
     C*
B4   C           DDACTC    IFEQ 'I'
     C*
     C** Customer must have been entered
     C*
B5   C           DDCNUM    IFEQ *BLANKS
     C*
     C                     MOVE '1'       *IN29
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0078' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C** Sequence must be blank
     C*
B6   C           DDSEQN    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0130' ZAMSID
     C                     EXSR ZASNMS
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
X3   C                     ELSE
     C*
     C** If any review from fields entered
     C*
B4   C           DDRCU1    IFNE *BLANKS
     C           DD1RCO    ORNE *BLANKS
     C           DDRSE1    ORNE *BLANKS
     C*
     C** Error - action, customer, collateral or sequence entered
     C*
B5   C           DDACTC    IFNE *BLANKS
     C           DDCNUM    ORNE *BLANKS
     C           DD1CON    ORNE *BLANKS
     C           DDSEQN    ORNE *BLANKS
     C*
     C                     MOVEA'1111111' *IN,28           ON 28-34
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0054' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C** If review from customer = blanks - error
     C*
B6   C           DDRCU1    IFEQ *BLANKS
     C*
     C                     MOVEA'111'     *IN,32           ON 32-34
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0078' ZAMSID
     C                     EXSR ZASNMS
     C*
X6   C                     ELSE
     C*
     C** If review from collateral = blanks
     C*
B7   C           DD1RCO    IFEQ *BLANKS
     C*
     C** If review from sequence not = blanks - error
     C*
B8   C           DDRSE1    IFNE *BLANKS
     C*
     C                     MOVEA'11'      *IN,33           ON 33-34
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0132' ZAMSID
     C                     EXSR ZASNMS
     C*
E8   C                     END
     C*
E7   C                     END
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Validate request made
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     EXSR #BB
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #BB - Validation screen 1 (1)                    *
     C**                                                              *
     C**  CALLS          - #BBA #BBB #BBC #BBD                        *
     C**                                                              *
     C**  CALLED BY      - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BB       BEGSR
     C*
     C** Normal request made
     C*
B1   C           DDACTC    IFNE *BLANKS
     C*
     C** Customer validation
     C*
     C           DDCNUM    IFEQ '?'                                       S01498
     C                     CALL 'AOCUSTR0'                                S01498
     C                     PARM *BLANKS   @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM DDCNUM    @KEY1  10                       S01498
     C                     PARM *BLANKS   @KYST   7                       S01498
     C           SDCUST    PARM SDCUST    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFEQ '*NOSEL '                                 S01498
     C                     MOVE *BLANKS   DDCNUM                          S01498
     C                     ELSE                                           S01498
     C                     MOVE *BLANKS   DDCNUM                          S01498
     C                     MOVELBBCUST    DDCNUM                          S01498
     C                     END                                            S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     MOVELDDCNUM    WWALF1  1
     C           WWALF1    LOKUPALPNU                    27
     C*
     C** Check if first char alphanumeric or blank
     C*
B2   C           *IN27     IFEQ '0'
     C                     MOVE '1'       *IN29
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C** Check if first char numeric
     C*
     C           WWALF1    LOKUPNUM                      27
     C*
B3   C           *IN27     IFNE '1'
     C*
     C** Shortname
     C*
     C                     EXSR #BBA
     C*
X3   C                     ELSE
     C*
     C** Customer Number
     C*
     C                     EXSR #BBB
     C*
E3   C                     END
     C*
     C** If valid so far
     C*
B3   C           *IN99     IFEQ '0'
     C*
     C** If collateral number entered validate usign ZALIGN
     C*
B4   C           DD1CON    IFNE *BLANKS
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD1CON    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check collateral in correct range
     C*
B5   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DD1CON
     C                     MOVE ZFIELD    HHBPSN
     C*
B6   C           DD1CON    IFLE '000'
     C           DD1CON    ORGT '999'
     C*
     C                     MOVE '1'       *IN30
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
X6   C                     ELSE
     C*
     C                     MOVE DD1CON    WWCON1
     C                     MOVE DD1CON    HHBPSN
     C*
E6   C                     END
     C*
X5   C                     ELSE
     C*
     C                     MOVE '1'       *IN30
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** If valid so far
     C*
B3   C           *IN99     IFEQ '0'
     C*
     C** If seq. number entered validate usign ZALIGN
     C*
B4   C           DDSEQN    IFNE *BLANKS
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DDSEQN    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check sequence in correct range
     C*
B5   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DDSEQN
     C                     MOVE ZFIELD    HHSEQN
     C*
B6   C           DDSEQN    IFLE '000'
     C           DDSEQN    ORGT '999'
     C*
     C                     MOVE '1'       *IN31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
X6   C                     ELSE
     C*
     C                     MOVE DDSEQN    WWSEQ1
     C*
E6   C                     END
     C*
X5   C                     ELSE
     C*
     C                     MOVE '1'       *IN31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*                                                                   S01498
     C** If valid so far                                                  S01498
     C           *IN99     IFEQ '0'                                       S01498
     C*                                                                   S01498
     C** Check if User is authorised to Action Code                       S01498
     C           *IN18     IFEQ '0'                                       S01498
     C*                                                                   S01498
     C** Single entity                                                    S01498
     C                     CALL 'ZVACTU'                                  S01498
     C                     PARM DDACTC    @ACT    1                       S01498
     C                     PARM           @ERR    10                      S01498
     C*                                                                   S01498
     C*  If action invalid for user, send error message                   S01498
     C           @ERR      IFEQ 1                                         S01498
     C                     MOVEL'LBM0302' ZAMSID                          S01498
     C                     EXSR ZASNMS                                    S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ELSE                                           S01498
     C*                                                                   S01498
     C** Multi-entity                                                     S01498
     C                     CALL 'ZVACTBU'                                 S01498
     C                     PARM DDACTC    @ACT    1                       S01498
     C                     PARM BBBRCD    @BCH    3                       S01498
     C                     PARM           @ERR    10                      S01498
     C*                                                                   S01498
     C*  If action invalid for user, send error message                   S01498
     C           @ERR      IFEQ 1                                         S01498
     C                     MOVEL'LBM0303' ZAMSID                          S01498
     C                     EXSR ZASNMS                                    S01498
     C                     END                                            S01498
     C           @ERR      IFEQ 2                                         S01498
     C                     MOVEL'LBM0304' ZAMSID                          S01498
     C                     EXSR ZASNMS                                    S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           @ERR      IFNE *ZERO                                     S01498
     C                     MOVE '1'       *IN28                           S01498
     C                     MOVE '1'       *IN29                           S01498
     C                     MOVE '1'       *IN99                           S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     END                                            S01498
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C** Perform further validation of normal request
     C*
     C                     EXSR #BBC
     C*
E2   C                     END
     C*
     C** Review request made
     C*
X1   C                     ELSE
     C*
     C** Validate review request
     C*
     C                     EXSR #BBD
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #BBA - Validate SHORTNAME                        *
     C**                                                              *
     C**  CALLS           - NONE                                      *
     C**                                                              *
     C**  CALLED BY       - #BB                                       *
     C**                                                              *
     C*****************************************************************
     C           #BBA      BEGSR
     C*
     C***Non-numeric*Chain*SDLBCSL8***************************************S01498
     C** Non-numeric Chain LBLBCSJ8                                       S01498
     C*
     C***********DDCNUM    CHAINSDLBCSL8             45                   S01498
     C           DDCNUM    CHAINLBLBCSJ8             45                   S01498
     C*
     C** If customer not found or deleted
     C*
B1   C           *IN45     IFEQ '1'
     C           BBTYLC    OREQ 'D'
     C*
     C                     MOVE '1'       *IN29
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X1   C                     ELSE
     C*
     C                     MOVE BBCUST    WWCUS1
     C                     MOVE BBCUST    HHCNUM
     C***********          MOVE CULOMB    HHLOMB                          S01498
     C                     MOVE DDCNUM    HHSHNM
     C                     MOVE BBBRCD    HHBRCH                          S01498
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #BBB - Validate CUSTOMER NUMBER                  *
     C**                                                              *
     C**  CALLS           - NONE                                      *
     C**                                                              *
     C**  CALLED BY       - #BB                                       *
     C**                                                              *
     C*****************************************************************
     C           #BBB      BEGSR
     C*
     C** Numeric - check if valid customer number
     C** First check if 6 digits
     C*
     C                     Z-ADD0         W       20
     C*
B1   C********** W         DOUEQ6                                                             CSD027
     C********** *IN99     OREQ '1'                                                           CSD027
     C*
     C**********           ADD  1         W                                                   CSD027
     C********** INP1,W    LOKUPNUM                      27                                   CSD027
     C*
B2   C********** *IN27     IFNE '1'                                                           CSD027
     C*
     C**********           MOVE '1'       *IN29                                               CSD027
     C**********           MOVE '1'       *IN99                                               CSD027
     C**********           MOVEL'LBM0007' ZAMSID                                              CSD027
     C**********           EXSR ZASNMS                                                        CSD027
     C*
E2   C**********           END                                                                CSD027
     C*
E1   C**********           END                                                                CSD027
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** 6 Digits - Now check rest is blank
     C*
B2   C           WWL1      IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN29
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C** Valid 6 Digit number
     C*
     C                     MOVELDDCNUM    WWPNP8
     C                     MOVELDDCNUM    WWCUS1
     C                     MOVELDDCNUM    HHCNUM
     C*
     C***********WWPNP8    CHAINSDLBCSL7             42                   S01498
     C           WWPNP8    CHAINLBLBCSJ7             42                   S01498
     C*
     C** If Customer not found or deleted
     C*
B3   C           *IN42     IFEQ '1'
     C           BBTYLC    OREQ 'D'
     C*
     C                     MOVE '1'       *IN29
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X3   C                     ELSE
     C*
     C                     MOVE BBCSSN    HHSHNM
     C***********          MOVE CULOMB    HHLOMB                          S01498
     C                     MOVE BBBRCD    HHBRCH                          S01498
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #BBC - Validation screen 1 (2)                   *
     C**                                                              *
     C**  CALLS           - NONE                                      *
     C**                                                              *
     C**  CALLED BY       - #BB                                       *
     C**                                                              *
     C*****************************************************************
     C           #BBC      BEGSR
     C*
     C** If Action code = I
     C*
B1   C           DDACTC    IFEQ 'I'
     C*
     C** If Collateral entered
     C*
B2   C           DD1CON    IFNE *BLANKS
     C*
     C** Get next available sequence number
     C*
     C                     Z-ADD*HIVAL    WWSEQ1
     C*
     C           KL1       SETGTLBPLEGLA
     C                     READPLBPLEGLA                 42
     C*
     C** If BOF file reached or different customer/collateral
     C*
B3   C           *IN42     IFEQ '1'
     C           WWCUS1    ORNE PGCNUM
     C           WWCON1    ORNE PGBPSN
     C*
     C                     Z-ADD1         WWSEQ1
     C                     Z-ADDWWSEQ1    HHSEQN
     C*
X3   C                     ELSE
     C*
     C** If no available sequence number - error
     C*
B4   C           PGSEQN    IFGE 999
     C*
     C                     MOVEA'1111'    *IN,28           ON 28-31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0133' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Increment sequence number
     C*
X4   C                     ELSE
     C*
     C           PGSEQN    ADD  1         WWSEQ1
     C                     Z-ADDWWSEQ1    HHSEQN
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** Else collateral not entered
     C*
X2   C                     ELSE
     C*
     C** Get next available collateral and sequence number
     C*
     C                     Z-ADD*HIVAL    WWCON1
     C                     Z-ADD*HIVAL    WWSEQ1
     C*
     C           KL1       SETGTLBPLEGLA
     C                     READPLBPLEGLA                 42
     C*
     C** If BOF file reached or different customer
     C*
B3   C           *IN42     IFEQ '1'
     C           WWCUS1    ORNE PGCNUM
     C*
     C                     Z-ADD1         WWCON1
     C                     Z-ADD1         WWSEQ1
     C                     Z-ADDWWCON1    HHBPSN
     C                     Z-ADDWWSEQ1    HHSEQN
     C*
X3   C                     ELSE
     C*
     C** If no available collateral - error
     C*
B4   C           PGBPSN    IFGE 999
     C*
     C                     MOVEA'1111'    *IN,28           ON 28-31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0133' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else increment collateral number
     C*
X4   C                     ELSE
     C*
     C           PGBPSN    ADD  1         WWCON1
     C                     Z-ADD1         WWSEQ1
     C                     Z-ADDWWCON1    HHBPSN
     C                     Z-ADDWWSEQ1    HHSEQN
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Else Action = 'A','D' or 'E'
     C*
X1   C                     ELSE
     C*
     C           KL1       CHAINLBPLEGLA             42
     C*
     C** If Action code = 'A' or 'D'
     C*
B2   C           DDACTC    IFEQ 'A'
     C           DDACTC    OREQ 'D'
     C*
     C** If record not found or deleted
     C*
B3   C           *IN42     IFEQ '1'
     C           PGRECI    OREQ '*'
     C*
     C                     MOVEA'1111'    *IN,28           ON 28-31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0077' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
     C** Else action code = 'E'
     C*
X2   C                     ELSE
     C*
     C** If record not found
     C*
B3   C           *IN42     IFEQ '1'
     C*
     C                     MOVEA'1111'    *IN,28           ON 28-31
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0079' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #BBD - Review request validation                 *
     C**                                                              *
     C**  CALLS           - NONE                                      *
     C**                                                              *
     C**  CALLED BY       - #BB                                       *
     C**                                                              *
     C*****************************************************************
     C           #BBD      BEGSR
     C*
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
     C** Customer validation - check if numeric
     C*
     C                     MOVE DDRCU1    WWNUM7  70
     C                     MOVE WWNUM7    WWALF6  6
     C*
B1   C           DDRCU1    IFNE WWALF6
     C*
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
X1   C                     ELSE
     C*
     C                     MOVE DDRCU1    WWCUS1
     C*
     C** If collateral number entered
     C*
B2   C           DD1RCO    IFNE *BLANKS
     C*
     C** Check numeric using ZALIGN
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD1RCO    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check collateral in correct range
     C*
B3   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DD1RCO
     C*
B4   C           DD1RCO    IFLT '0'
     C           DD1RCO    ORGT '999'
     C*
     C                     MOVE '1'       *IN33
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0134' ZAMSID
     C                     EXSR ZASNMS
     C*
X4   C                     ELSE
     C*
     C                     MOVE DD1RCO    WWCON1
     C*
E4   C                     END
     C*
     C** Not numeric - error
     C*
X3   C                     ELSE
     C*
     C                     MOVE '1'       *IN33
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0134' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C** If sequence number entered
     C*
B3   C           DDRSE1    IFNE *BLANKS
     C*
     C** Check numeric using ZALIGN
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DDRSE1    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check sequence in correct range
     C*
B4   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DDRSE1
     C*
B5   C           DDRSE1    IFLT '0'
     C           DDRSE1    ORGT '999'
     C*
     C                     MOVE '1'       *IN34
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C                     MOVE DDRSE1    WWSEQ1
     C*
E5   C                     END
     C*
     C** Else not numeric - error
     C*
X4   C                     ELSE
     C*
     C                     MOVE '1'       *IN34
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #C  - Review From processing                     *
     C**                                                              *
     C**  CALLS          - #CA #CB #CC #C                             *
     C**                                                              *
     C**  CALLED BY      - MAINLINE #B                                *
     C**                                                              *
     C*****************************************************************
     C           #C        BEGSR
     C*
     C** Process subfile build
     C*
     C                     EXSR #CA
     C*
     C** Display review from subfile until F3 or F12 pressed
     C*
B1   C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C*
     C** Seton F12
     C*
     C                     MOVE '1'       *IN37
     C                     MOVEA'10'      *IN,20           ON 20 OFF 21
     C*
     C                     WRITELB0220F3
     C                     WRITELB0220C1
     C*
B2   C           *IN38     IFEQ '0'
     C                     WRITELB0220F5
E2   C                     END
     C*
     C                     EXFMTLB0220C2
     C*
     C                     MOVE '0'       *IN99
     C                     MOVEA'00'      *IN,36           OFF 36-37
     C                     MOVEA'000'     *IN,56           OFF 56-58
     C*                                                                   LB0009
     C** Initialise records selected indicator                            LB0009
     C*                                                                   LB0009
     C                     MOVE '0'       *IN48                           LB0009
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C** F12/F3 not requested
     C*
B2   C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C***********                                                         LB0009
     C***Rollup*requested SETLL LBPLEGLA with current review details      LB0009
     C***ie*details retained from initial build of subfile                LB0009
     C***********                                                         LB0009
B3   C************IN25     IFEQ '1'                                       LB0009
     C***********                                                         LB0009
     C***********          MOVE '1'       *IN99                           LB0009
     C***********                                                         LB0009
     C***Process*subfile build                                            LB0009
     C***********                                                         LB0009
     C***********          EXSR #CA                                       LB0009
     C***********                                                         LB0009
X3   C***********          ELSE                                           LB0009
     C***********                                                         LB0009
     C***Rolldown requested SETLL LBPLEGLA with blank review details      LB0009
     C***********                                                         LB0009
B4   C************IN24     IFEQ '1'                                       LB0009
     C***********                                                         LB0009
     C***********          MOVE '1'       *IN99                           LB0009
     C***********                                                         LB0009
     C***Review*From Fields = blank                                       LB0009
     C***********                                                         LB0009
     C***********          MOVE *BLANKS   DDRCU2                          LB0009
     C***********          MOVE *BLANKS   DD2RCO                          LB0009
     C***********          MOVE *BLANKS   DDRSE2                          LB0009
     C***********                                                         LB0009
     C***Klist*for LBPLEGLA                                               LB0009
     C***********                                                         LB0009
     C***********          Z-ADD*ZEROS    WWCUS1                          LB0009
     C***********          Z-ADD*ZEROS    WWCON1                          LB0009
     C***********          Z-ADD*ZEROS    WWSEQ1                          LB0009
     C***********                                                         LB0009
     C***Process*subfile build                                            LB0009
     C***********                                                         LB0009
     C***********          EXSR #CA                                       LB0009
     C***********                                                         LB0009
     C***Validate subfile                                                 LB0009
     C***********                                                         LB0009
X4   C***********          ELSE                                           LB0009
     C*
     C** SFL Displayed
     C*
B5   C           *IN38     IFEQ '1'
     C*
     C                     READCLB0220S2                 45
     C*
     C** Change NOT FOUND
     C*
B6   C           *IN45     IFEQ '1'
     C*                                                                   LB0009
     C** Rolldown requested SETLL LBPLEGLA with blank review details      LB0009
     C*                                                                   LB0009
     C           *IN24     IFEQ '1'                                       LB0009
     C*                                                                   LB0009
     C                     MOVE '1'       *IN99                           LB0009
     C*                                                                   LB0009
     C** Review From Fields = blank                                       LB0009
     C*                                                                   LB0009
     C                     MOVE *BLANKS   DDRCU2                          LB0009
     C                     MOVE *BLANKS   DD2RCO                          LB0009
     C                     MOVE *BLANKS   DDRSE2                          LB0009
     C*                                                                   LB0009
     C** Klist for LBPLEGLA                                               LB0009
     C*                                                                   LB0009
     C**********           Z-ADD*ZEROS    WWCUS1                                       LB0009 CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1                          LB0009
     C                     Z-ADD*ZEROS    WWSEQ1                          LB0009
     C*                                                                   LB0009
     C** Process subfile build                                            LB0009
     C*                                                                   LB0009
     C                     EXSR #CA                                       LB0009
     C*                                                                   LB0009
     C                     ELSE                                           LB0009
     C*
     C** Enter: validate review from fields if <> blanks
     C*
B7   C           DDRCU2    IFNE *BLANKS
     C           DD2RCO    ORNE *BLANKS
     C           DDRSE2    ORNE *BLANKS
     C*
     C** If review from customer = blanks - error
     C*
B8   C           DDRCU2    IFEQ *BLANKS
     C*
     C                     MOVEA'111'     *IN,56           ON 56-58
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0078' ZAMSID
     C                     EXSR ZASNMS
     C*
X8   C                     ELSE
     C*
     C** If review from collateral = blanks
     C*
B9   C           DD2RCO    IFEQ *BLANKS
     C*
     C** If review from sequence not = blanks - error
     C*
B10  C           DDRSE2    IFNE *BLANKS
     C*
     C                     MOVEA'11'      *IN,57           ON 57-58
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0132' ZAMSID
     C                     EXSR ZASNMS
     C*
E10  C                     END
     C*
E9   C                     END
     C*
E8   C                     END
     C*
     C** If valid so far
     C*
B8   C           *IN99     IFEQ '0'
     C*
     C** Validate review from fields
     C*
     C                     EXSR #CC
     C*
E8   C                     END
     C*
X7   C                     ELSE
     C*
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
E7   C                     END
     C*
     C** No errors
     C*
B7   C           *IN99     IFEQ '0'
     C*
     C** Process subfile build
     C*
     C                     EXSR #CA
     C*
     C                     MOVE '1'       *IN99
     C*
E7   C                     END
     C*                                                                   LB0009
     C                     END                                            LB0009
     C*
     C** Change FOUND
     C*
X6   C                     ELSE
     C*
     C** Validate subfile selections                                      LB0009
     C*                                                                   LB0009
     C                     EXSR #CB
     C***********                                                         LB0009
     C***********          MOVE DDACT2    SSACT2  1                       LB0009
     C***********          UPDATLB0220S2                                  LB0009
     C***********                                                         LB0009
     C***********          Z-ADDRRN       WWRRN   40                      LB0009
     C***********          Z-ADD1         RRN                             LB0009
     C***********                                                         LB0009
B7   C***********RRN       DOWLEWWSFLC                                    LB0009
     C***********                                                         LB0009
B8   C***********WWRRN     IFNE RRN                                       LB0009
     C***********                                                         LB0009
     C***********RRN       CHAINLB0220S2             42                   LB0009
     C***********          MOVE *BLANKS   DDACT2                          LB0009
     C***********          MOVE '0'       *IN36                           LB0009
     C***********          UPDATLB0220S2                                  LB0009
     C***********                                                         LB0009
E8   C***********          END                                            LB0009
     C***********                                                         LB0009
     C***********          ADD  1         RRN                             LB0009
     C***********                                                         LB0009
E7   C***********          END                                            LB0009
     C*
     C***********          Z-ADD1         RRN                             LB0009
     C*
     C***********WWRRN     CHAINLB0220S2             42                   LB0009
     C*                                                                   LB0009
     C** If all selections valid                                          LB0009
     C*                                                                   LB0009
B7   C           *IN99     IFEQ '0'
     C*                                                                   LB0009
     C                     Z-ADD*ZEROS    RRN                             LB0009
     C*                                                                   LB0009
     C** Do while not EOF , CMD-3 & CMD-12                                LB0009
     C*                                                                   LB0009
B8   C           RRN       DOWLTWWSFLC                                    LB0009
     C           *INKC     ANDEQ'0'                                       LB0009
     C           *INKL     ANDEQ'0'                                       LB0009
     C*                                                                   LB0009
     C                     ADD  1         RRN                             LB0009
     C*                                                                   LB0009
     C** Read record on subfile                                           LB0009
     C*                                                                   LB0009
     C           RRN       CHAINLB0220S2             42                   LB0009
     C*                                                                   LB0009
     C** If selection not blanks                                          LB0009
     C*                                                                   LB0009
B9   C           DDACT2    IFNE *BLANKS                                   LB0009
     C*                                                                   LB0009
     C** Seton 'at least one selection' indicator                         LB0009
     C*                                                                   LB0009
     C                     MOVE '1'       *IN48
     C*                                                                   LB0009
     C** Process selection                                                LB0009
     C*                                                                   LB0009
     C**********           Z-ADDDDPNP8    WWCUS1                                       LB0009 CSD027
     C                     MOVE DDPNP8    WWCUS1                                              CSD027
     C                     MOVE DD2CON    WWCON1                          LB0009
     C                     MOVE DDSENQ    WWSEQ1                          LB0009
     C                     MOVE DDACT2    SSACT2  1                       LB0009
     C*
     C                     EXSR #D
     C*                                                                   LB0009
E9   C                     END                                            LB0009
     C*                                                                   LB0009
E8   C                     END                                            LB0009
     C*                                                                   LB0009
     C** If not CMD-3                                                     LB0009
     C*                                                                   LB0009
B8   C           *INKC     IFEQ '0'                                       LB0009
     C*                                                                   LB0009
     C** If no records selected ie. all changed records blank             LB0009
     C*                                                                   LB0009
B9   C           *IN48     IFEQ '0'                                       LB0009
     C*                                                                   LB0009
     C** ROLLDOWN                                                         LB0009
     C*                                                                   LB0009
B10  C           *IN24     IFEQ '1'                                       LB0009
     C*                                                                   LB0009
     C                     MOVE '1'       *IN99                           LB0009
     C*                                                                   LB0009
     C** Review from fields = blank                                       LB0009
     C*                                                                   LB0009
     C                     MOVE *BLANKS   DDRCU2                          LB0009
     C                     MOVE *BLANKS   DD2RCO                          LB0009
     C                     MOVE *BLANKS   DDRSE2                          LB0009
     C*                                                                   LB0009
     C** Klist for LBPLEGLA                                               LB0009
     C*                                                                   LB0009
     C**********           Z-ADD*ZEROS    WWCUS1                                       LB0009 CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1                          LB0009
     C                     Z-ADD*ZEROS    WWSEQ1                          LB0009
     C*                                                                   LB0009
X10  C                     ELSE                                           LB0009
     C*                                                                   LB0009
     C** ENTER/ROLLUP                                                     LB0009
     C*                                                                   LB0009
B11  C           DDRCU2    IFNE *BLANKS                                   LB0009
     C           DD2RCO    ORNE *BLANKS                                   LB0009
     C           DDRSE2    ORNE *BLANKS                                   LB0009
     C*                                                                   LB0009
     C** If review from customer = blanks - error                         LB0009
     C*                                                                   LB0009
B12  C           DDRCU2    IFEQ *BLANKS                                   LB0009
     C*                                                                   LB0009
     C                     MOVEA'111'     *IN,56           ON 56-58       LB0009
     C                     MOVE '1'       *IN99                           LB0009
     C                     MOVEL'LBM0078' ZAMSID                          LB0009
     C                     EXSR ZASNMS                                    LB0009
     C*                                                                   LB0009
X12  C                     ELSE                                           LB0009
     C*                                                                   LB0009
     C** If review from collateral = blanks                               LB0009
     C*                                                                   LB0009
B13  C           DD2RCO    IFEQ *BLANKS                                   LB0009
     C*                                                                   LB0009
     C** If review from sequence not = blanks - error                     LB0009
     C*                                                                   LB0009
B14  C           DDRSE2    IFNE *BLANKS                                   LB0009
     C*                                                                   LB0009
     C                     MOVEA'11'      *IN,57           ON 57-58       LB0009
     C                     MOVE '1'       *IN99                           LB0009
     C                     MOVEL'LBM0132' ZAMSID                          LB0009
     C                     EXSR ZASNMS                                    LB0009
     C*                                                                   LB0009
E14  C                     END                                            LB0009
     C*                                                                   LB0009
E13  C                     END                                            LB0009
     C*                                                                   LB0009
E12  C                     END                                            LB0009
     C*                                                                   LB0009
     C** If valid so far                                                  LB0009
     C*                                                                   LB0009
B12  C           *IN99     IFEQ '0'                                       LB0009
     C*                                                                   LB0009
     C** Validate review from fields                                      LB0009
     C*                                                                   LB0009
     C                     EXSR #CC                                       LB0009
     C*                                                                   LB0009
E12  C                     END                                            LB0009
     C*                                                                   LB0009
X11  C                     ELSE                                           LB0009
     C*                                                                   LB0009
     C**********           Z-ADD*ZEROS    WWCUS1                                       LB0009 CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1                          LB0009
     C                     Z-ADD*ZEROS    WWSEQ1                          LB0009
     C*                                                                   LB0009
E11  C                     END                                            LB0009
     C*                                                                   LB0009
E10  C                     END                                            LB0009
     C*                                                                   LB0009
     C** No errors                                                        LB0009
     C*                                                                   LB0009
B10  C           *IN99     IFEQ '0'                                       LB0009
     C*                                                                   LB0009
     C** Process subfile build                                            LB0009
     C*                                                                   LB0009
     C                     EXSR #CA                                       LB0009
     C*                                                                   LB0009
     C                     MOVE '1'       *IN99                           LB0009
     C*                                                                   LB0009
E10  C                     END                                            LB0009
     C*                                                                   LB0009
X9   C                     ELSE                                           LB0009
     C*                                                                   LB0009
     C** CMD-12 required to stay on this screen                           LB0009
     C*                                                                   LB0009
B10  C           *INKL     IFEQ '1'                                       LB0009
     C                     MOVE '0'       *INKL                           LB0009
     C                     Z-ADD0         SW      10                      R0065
E10  C                     END                                            LB0009
     C*
     C** Rebuild subfile                                                  LB0009
     C*                                                                   LB0009
     C**********           Z-ADDKEY1      WWCUS1                                              CSD027
     C                     MOVE KEY1      WWCUS1                                              CSD027
     C                     Z-ADDKEY2      WWCON1
     C                     Z-ADDKEY3      WWSEQ1
     C*
     C                     EXSR #CA
     C*
     C                     MOVE '1'       *IN99
     C*                                                                   LB0009
E9   C                     END                                            LB0009
     C*                                                                   LB0009
E8   C                     END                                            LB0009
     C*
E7   C                     END
     C*
E6   C                     END
     C*
     C** Blank subfile => review from                                     LB0009
     C*                                                                   LB0009
X5   C                     ELSE
     C*
     C** Enter: validate review from fields if <> blanks & changed
     C** from file entry.
     C*
B6   C           DDRCU2    IFNE *BLANKS
     C           DD2RCO    ORNE *BLANKS
     C           DDRSE2    ORNE *BLANKS
     C*                                                                   LB0009
     C** If review from customer = blanks - error                         LB0009
     C*                                                                   LB0009
B7   C           DDRCU2    IFEQ *BLANKS                                   LB0009
     C*                                                                   LB0009
     C                     MOVEA'111'     *IN,56           ON 56-58       LB0009
     C                     MOVE '1'       *IN99                           LB0009
     C                     MOVEL'LBM0078' ZAMSID                          LB0009
     C                     EXSR ZASNMS                                    LB0009
     C*                                                                   LB0009
X7   C                     ELSE                                           LB0009
     C*                                                                   LB0009
     C** If review from collateral = blanks                               LB0009
     C*                                                                   LB0009
B8   C           DD2RCO    IFEQ *BLANKS                                   LB0009
     C*                                                                   LB0009
     C** If review from sequence not = blanks - error                     LB0009
     C*                                                                   LB0009
B9   C           DDRSE2    IFNE *BLANKS                                   LB0009
     C*                                                                   LB0009
     C                     MOVEA'11'      *IN,57           ON 57-58       LB0009
     C                     MOVE '1'       *IN99                           LB0009
     C                     MOVEL'LBM0132' ZAMSID                          LB0009
     C                     EXSR ZASNMS                                    LB0009
     C*                                                                   LB0009
E9   C                     END                                            LB0009
     C*                                                                   LB0009
E8   C                     END                                            LB0009
     C*                                                                   LB0009
E7   C                     END                                            LB0009
     C*                                                                   LB0009
     C** If valid so far                                                  LB0009
     C*                                                                   LB0009
B7   C           *IN99     IFEQ '0'                                       LB0009
     C*
     C** Validate review from fields
     C*
     C                     EXSR #CC
     C*                                                                   LB0009
E7   C                     END                                            LB0009
     C*
X6   C                     ELSE
     C*
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
E6   C                     END
     C*
     C** No errors
     C*
B6   C           *IN99     IFEQ '0'
     C*
     C** Process subfile build
     C*
     C                     EXSR #CA
     C*
     C                     MOVE '1'       *IN99
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C***********          END                                            LB0009
     C*
E3   C***********          END                                            LB0009
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CA - Process subfile build                      *
     C**                                                              *
     C**  CALLS          - #CAA                                       *
     C**                                                              *
     C**  CALLED BY      - #C                                         *
     C**                                                              *
     C*****************************************************************
     C           #CA       BEGSR
     C*
     C** Clear review from subfile
     C*
     C                     MOVE '1'       *IN40
     C                     WRITELB0220C2
     C                     MOVE '0'       *IN40
     C*
     C                     Z-ADD*ZEROS    RRN
     C*
     C           KL1       SETLLLBPLEGLA             20
     C*
     C** Beyond EOF
     C*
     C           *IN20     IFEQ '1'
     C*
     C                     MOVE '0'       *IN38
     C*
     C** Review from fields
     C*
     C                     MOVE *BLANKS   DDRCU2
     C                     MOVE *BLANKS   DD2RCO
     C                     MOVE *BLANKS   DDRSE2
     C*
     C** Klist for LBPLEGLA
     C*
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
     C                     ELSE
     C*
     C** Setll successful - build subfile page
     C*
     C                     READ LBPLEGLA                 20
     C*
     C                     EXSR #CAA
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CAA - Build Review from subfile page            *
     C**                                                              *
     C**  CALLS          -  #EA                                       *
     C**                                                              *
     C**  CALLED BY      -  #CA                                       *
     C**                                                              *
     C*****************************************************************
     C           #CAA      BEGSR
     C*
     C** Seton SFLDSP
     C*
     C                     MOVE '1'       *IN38
     C                     Z-ADD*ZEROS    WWSFLC  30
     C**********           Z-ADD*ZEROS    KEY1                                                CSD027
     C                     MOVE *BLANKS   KEY1                                                CSD027
     C                     Z-ADD*ZEROS    KEY2
     C                     Z-ADD*ZEROS    KEY3
     C*
     C** Loop until EOF or 13 records loaded
     C*
B1   C           *IN20     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLS
     C*
     C                     MOVE *BLANKS   DDACT2
     C*
     C** Set up status field
     C*
B2   C           PGRECI    IFEQ '*'
     C*
     C                     MOVE 'D'       DDSTAT
     C*
X2   C                     ELSE
     C*
B3   C           PGRECI    IFEQ 'M'
     C*
     C                     MOVE 'M'       DDSTAT
     C*
X3   C                     ELSE
     C*
     C                     MOVE *BLANKS   DDSTAT
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C**********           Z-ADDPGCNUM    DDPNP8                                              CSD027
     C                     MOVE PGCNUM    DDPNP8                                              CSD027
     C*
     C***Access*SDLBCSL7*to*get*shortname*********************************S01498
     C** Access LBLBCSJ7 to get shortname                                 S01498
     C*
     C                     MOVE PGCNUM    WWPNP8
     C***********WWPNP8    CHAINSDLBCSL7             42                   S01498
     C           WWPNP8    CHAINLBLBCSJ7             42                   S01498
     C*
     C***If*record*not*found*or*deleted*on*SDLBCSL7***********************S01498
     C** If record not found or deleted on LBLBCSJ7                       S01498
     C*
B2   C           *IN42     IFEQ '1'
     C           BBTYLC    OREQ 'D'
     C*
     C** Record must be deleted or matured on LBPLEGLA
     C*
B3   C           PGRECI    IFNE '*'
     C           PGRECI    ANDNE'M'
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDLBCSL7'DBFILE           ***************S01498
     C                     MOVE 'LBLBCSJ7'DBFILE           ***************S01498
     C                     MOVELWWPNP8    DBKEY            *             *
     C                     Z-ADD4         DBASE            * DBERROR 004 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C** Record deleted/matured on LBPLEGLA
     C*
X3   C                     ELSE
     C*
     C** Set shortname to blanks
     C*
     C                     MOVE *BLANKS   DDSHNM
     C                     MOVE *BLANKS   HHSHNM
     C                     MOVE *BLANKS   HHLOMB
     C                     MOVE *BLANKS   HHBRCH                          S01498
     C*
E3   C                     END
     C*
     C***Record*found*on*SDLBCSL7*****************************************S01498
     C** Record found on LBLBCSJ7                                         S01498
     C*
X2   C                     ELSE
     C*
     C** Set values to those retrieved
     C*
     C                     MOVE BBCSSN    DDSHNM
     C                     MOVE BBCSSN    HHSHNM
     C***********          MOVE CULOMB    HHLOMB                          S01498
     C                     MOVE BBBRCD    HHBRCH                          S01498
     C*
E2   C                     END
     C*
     C                     MOVE PGBPSN    DD2CON
     C                     MOVE PGSEQN    DDSENQ
     C                     MOVE PGTYPE    DDTYPE
     C                     MOVE PGCODE    DDCODE
     C*
     C** If issued by <> zero
     C*
B2   C********** PGISSB    IFNE *ZERO                                                         CSD027
B2   C           PGISSB    IFNE *BLANKS                                                       CSD027
     C*
     C                     MOVE PGISSB    DDISSB
     C*
     C***Access*SDLBCSL7*to*get*shortname*-*issued*by*********************S01498
     C** Access LBLBCSJ7 to get shortname - issued by                     S01498
     C*
     C                     MOVE PGISSB    WWPNP8
     C***********WWPNP8    CHAINSDLBCSL7             42                   S01498
     C           WWPNP8    CHAINLBLBCSJ7             42                   S01498
     C*                                                                   1
     C***If*record*not*found*or*deleted*on*SDLBCSL7***********************S01498
     C** If record not found or deleted on LBLBCSJ7                       S01498
     C*
B3   C           *IN42     IFEQ '1'
     C           BBTYLC    OREQ 'D'
     C*
     C** Record must be deleted or matured on LBPLEGLA
     C*
B4   C           PGRECI    IFNE '*'
     C           PGRECI    ANDNE'M'
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDLBCSL7'DBFILE           ***************S01498
     C                     MOVE 'LBLBCSJ7'DBFILE           ***************S01498
     C                     MOVELWWPNP8    DBKEY            *             *
     C                     Z-ADD5         DBASE            * DBERROR 005 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C** Record deleted/matured on LBPLEGLA
     C*
X4   C                     ELSE
     C*
     C** Set shortname to blanks
     C*
     C                     MOVE *BLANKS   DDISSN
     C*
E4   C                     END
     C*
     C***Record*found*on*SDLBCSL7*****************************************S01498
     C** Record found on LBLBCSJ7                                         S01498
     C*
X3   C                     ELSE
     C*
     C** Set values to those retrieved
     C*
     C                     MOVE BBCSSN    DDISSN
     C*
E3   C                     END
     C*
     C** else issued by = zero
     C*
X2   C                     ELSE
     C*
     C** Set issued by & shortname to blanks
     C*
     C                     MOVE *BLANKS   DDISSB
     C                     MOVE *BLANKS   DDISSN
     C*
E2   C                     END
     C*
     C** Save hidden fields
     C*
     C                     EXSR #EA
     C*
     C                     ADD  1         RRN
     C*
     C** Store key fields of first record on subfile
     C*
B2   C           RRN       IFEQ 1
     C*
     C**********           Z-ADDDDPNP8    KEY1    60                                          CSD027
     C                     MOVE DDPNP8    KEY1    6                                           CSD027
     C                     Z-ADDDD2CON    KEY2    30
     C                     Z-ADDDDSENQ    KEY3    30
     C*
E2   C                     END
     C*
     C** Write record to the subfile
     C*
     C                     WRITELB0220S2
     C                     ADD  1         WWSFLC
     C*
     C** Read next record on LBPLEGLA
     C*
     C                     READ LBPLEGLA                 20
     C*
E1   C                     END
     C*
     C** If EOF has already been reached
     C*
B1   C           *IN20     IFEQ '1'
     C*
     C** Set review from fields to blank
     C*
     C                     MOVE '1'       *IN39
     C*
     C** Review from fields
     C*
     C                     MOVE *BLANKS   DDRCU2
     C                     MOVE *BLANKS   DD2RCO
     C                     MOVE *BLANKS   DDRSE2
     C*
     C** Klist for LBPLEGLA
     C*
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
     C** If EOF not reached
     C*
X1   C                     ELSE
     C*
     C** Set review from fields to those values retrieved
     C*
     C                     MOVE '0'       *IN39
     C*
     C** Review from fields
     C*
     C                     MOVELPGCNUM    DDRCU2
     C                     MOVE PGBPSN    DD2RCO
     C                     MOVE PGSEQN    DDRSE2
     C*
     C** Klist for LBPLEGLA
     C*
     C**********           Z-ADDPGCNUM    WWCUS1                                              CSD027
     C                     MOVE PGCNUM    WWCUS1                                              CSD027
     C                     Z-ADDPGBPSN    WWCON1
     C                     Z-ADDPGSEQN    WWSEQ1
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CB - Validate subfile selection                 *
     C**                                                              *
     C**  CALLS          - NONE                                       *
     C**                                                              *
     C**  CALLED BY      - #C                                         *
     C**                                                              *
     C*****************************************************************
     C           #CB       BEGSR
     C*                                                                   LB0009
     C** Dowhile changed records exist                                    LB0009
     C*                                                                   LB0009
     C           *IN45     DOWEQ'0'
     C*
     C***Action*code blank                                                LB0009
     C** Validate selection                                               LB0009
     C*
B1   C           DDACT2    IFNE 'A'
     C           DDACT2    ANDNE'D'
     C           DDACT2    ANDNE'E'
     C           DDACT2    ANDNE' '                                       LB0009
     C*
     C***********          MOVE '1'       *IN36                           LB0009
     C*
     C** Only load error message once
     C*
B2   C           *IN99     IFEQ '0'                                       LB0009
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0046' ZAMSID
     C                     EXSR ZASNMS
E2   C                     END                                            LB0009
     C*
     C                     MOVE '1'       *IN35            SFLNXTCHG      LB0009
     C                     MOVE '1'       *IN36            (RI PC)        LB0009
     C*
X1   C                     ELSE
     C*                                                                   S01498
     C** Check if User is authorised to Action Code                       S01498
     C*                                                                   S01498
     C                     Z-ADD0         @ERR                            S01498
     C*                                                                   S01498
     C           DDACT2    IFNE ' '                                       S01498
     C*                                                                   S01498
     C           *IN18     IFEQ '0'                                       S01498
     C*                                                                   S01498
     C** Single entity                                                    S01498
     C                     CALL 'ZVACTU'                                  S01498
     C                     PARM DDACT2    @ACT    1                       S01498
     C                     PARM           @ERR    10                      S01498
     C*                                                                   S01498
     C*  If action invalid for user, send error message                   S01498
     C           @ERR      IFEQ 1                                         S01498
     C                     MOVEL'LBM0302' ZAMSID                          S01498
     C                     EXSR ZASNMS                                    S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ELSE                                           S01498
     C*                                                                   S01498
     C** Multi-entity                                                     S01498
     C                     CALL 'ZVACTBU'                                 S01498
     C                     PARM DDACT2    @ACT    1                       S01498
     C                     PARM HHBRCH    @BCH    3                       S01498
     C                     PARM           @ERR    10                      S01498
     C*                                                                   S01498
     C*  If action invalid for user, send error message                   S01498
     C           @ERR      IFEQ 1                                         S01498
     C                     MOVEL'LBM0303' ZAMSID                          S01498
     C                     EXSR ZASNMS                                    S01498
     C                     END                                            S01498
     C           @ERR      IFEQ 2                                         S01498
     C                     MOVEL'LBM0304' ZAMSID                          S01498
     C                     EXSR ZASNMS                                    S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           @ERR      IFNE *ZERO                                     S01498
     C                     MOVE '1'       *IN35                           S01498
     C                     MOVE '1'       *IN36                           S01498
     C                     MOVE '1'       *IN99                           S01498
     C                     ELSE                                           S01498
     C*
     C** If Action code = A or D
     C*
B2   C           DDACT2    IFEQ 'A'
     C           DDACT2    OREQ 'D'
     C*
     C** Record can not have status deleted or matured
     C*
B3   C           DDSTAT    IFEQ 'M'
     C           DDSTAT    OREQ 'D'
     C*
     C***********          MOVE '1'       *IN36                           LB0009
     C*
     C** Only load error message once
     C*
B4   C           *IN99     IFEQ '0'                                       LB0009
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0047' ZAMSID
     C                     EXSR ZASNMS
E4   C                     END                                            LB0009
     C*
     C                     MOVE '1'       *IN35            SFLNXTCHG      LB0009
     C                     MOVE '1'       *IN36            (RI PC)        LB0009
     C*                                                                   LB0009
     C** else - no error                                                  LB0009
     C*                                                                   LB0009
X3   C                     ELSE                                           LB0009
     C*
     C                     MOVE '0'       *IN35            SFLNXTCHG      LB0009
     C                     MOVE '0'       *IN36            (RI PC)        LB0009
     C*                                                                   LB0009
E3   C                     END
     C*                                                                   LB0009
     C** else - no error                                                  LB0009
     C*                                                                   LB0009
X2   C                     ELSE                                           LB0009
     C*
     C                     MOVE '0'       *IN35            SFLNXTCHG      LB0009
     C                     MOVE '0'       *IN36            (RI PC)        LB0009
     C*                                                                   LB0009
E2   C                     END
     C                     END                                            S01498
     C***********
     C***If*valid so far
     C***********
B2   C************IN99     IFEQ '0'
     C***********
     C***********          Z-ADDDDCUST    WWCUS1
     C***********          MOVE DD2CON    WWCON1
     C***********          MOVE DDSENQ    WWSEQ1
     C***********
E2   C***********          END
     C*
E1   C                     END
     C*                                                                   LB0009
     C                     UPDATLB0220S2                                  LB0009
     C*                                                                   LB0009
     C** Read next changed subfile record                                 LB0009
     C*                                                                   LB0009
     C                     READCLB0220S2                 45               LB0009
     C*                                                                   LB0009
     C                     END                                            LB0009
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CC  - Review request validation                 *
     C**                                                              *
     C**  CALLS           - NONE                                      *
     C**                                                              *
     C**  CALLED BY       - #C                                        *
     C**                                                              *
     C*****************************************************************
     C           #CC       BEGSR
     C*
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
     C** Customer validation - check if numeric
     C*
     C                     MOVE DDRCU2    WWNUM7  70
     C                     MOVE WWNUM7    WWALF6  6
     C*
B1   C           DDRCU2    IFNE WWALF6
     C*
     C**********           Z-ADD*ZEROS    WWCUS1                                              CSD027
     C                     MOVE *BLANKS   WWCUS1                                              CSD027
     C                     Z-ADD*ZEROS    WWCON1
     C                     Z-ADD*ZEROS    WWSEQ1
     C*
X1   C                     ELSE
     C*
     C                     MOVE DDRCU2    WWCUS1
     C*
     C** If collateral number entered
     C*
B2   C           DD2RCO    IFNE *BLANKS
     C*
     C** Check numeric using ZALIGN
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD2RCO    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check collateral in correct range
     C*
B3   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DD2RCO
     C*
B4   C           DD2RCO    IFLT '0'
     C           DD2RCO    ORGT '999'
     C*
     C                     MOVE '1'       *IN57
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0134' ZAMSID
     C                     EXSR ZASNMS
     C*
X4   C                     ELSE
     C*
     C                     MOVE DD2RCO    WWCON1
     C*
E4   C                     END
     C*
     C** Not numeric - error
     C*
X3   C                     ELSE
     C*
     C                     MOVE '1'       *IN57
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0134' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C** If sequence number entered
     C*
B3   C           DDRSE2    IFNE *BLANKS
     C*
     C** Check numeric using ZALIGN
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DDRSE2    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check sequence in correct range
     C*
B4   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DDRSE2
     C*
B5   C           DDRSE2    IFLT '0'
     C           DDRSE2    ORGT '999'
     C*
     C                     MOVE '1'       *IN58
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C                     MOVE DDRSE2    WWSEQ1
     C*
E5   C                     END
     C*
     C** Else not numeric - error
     C*
X4   C                     ELSE
     C*
     C                     MOVE '1'       *IN58
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0075' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #D  - File maintenance control from REVIEW FROM  *
     C**                   subfile selection                          *
     C**                                                              *
     C**  CALLS          - #DA #DB #DC #DD #DE                        *
     C**                                                              *
     C**  CALLED BY      - #C                                         *
     C**                                                              *
     C*****************************************************************
     C           #D        BEGSR
     C*
     C** AMEND / DELETE / ENQUIRY MODE : initialise screen from file
     C*
     C                     MOVEA'11111'   *IN,50           ON 50-54
     C                     MOVE HHCNUM    DD3CNU
     C                     MOVE HHSHNM    DD3SNM
     C                     MOVE HHBPSN    DD3CON
     C                     MOVE HHSEQN    DD3SEQ
     C                     MOVE HHBRCH    DD3BRC                          S01498
     C*
     C** Initialize screen
     C*
     C                     EXSR #DB
     C*
     C** Set up screen
     C*
     C                     EXSR #DA
     C*
     C** Enquiry
     C*
B1   C           SSACT2    IFEQ 'E'
     C*
     C** Process screen 3 - Enquiry
     C*
     C                     EXSR #DC
     C*
E1   C                     END
     C*
     C** Deletion
     C*
B1   C           SSACT2    IFEQ 'D'
     C*
     C** Process screen 3 - Delete
     C*
     C                     EXSR #DD
     C*
E1   C                     END
     C*
     C** Amend  (INSERT mode not allowed from subfile screen)
     C*
B1   C           SSACT2    IFEQ 'A'
     C*
     C** Process screen 3 - Amend
     C*
     C                     MOVE 'A'       DDACT3
     C                     EXSR #DE
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DA - ENQUIRY/DELETE/AMEND  - initialise fields  *
     C**                                                              *
     C**  CALLS          - #DAA #DAB                                  *
     C**                                                              *
     C**  CALLED BY      - #D #E                                      *
     C**                                                              *
     C*****************************************************************
     C           #DA       BEGSR
     C*
     C** If ccy <> blanks
     C*
B1   C           HHCCY     IFNE *BLANKS
     C*
     C** Chain SDCURRL1 & save dec. positions, spot rate & mult/div ind
     C*
B2   C***********HHCCY     CHAINSDCURRL1             42                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM HHCCY     @CYCD   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*
     C************IN42     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C           @RTCD     IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDCURRL1'DBFILE           ***************S01498
     C                     MOVE 'SDCURRPD'DBFILE           ***************S01498
     C                     MOVELHHCCY     DBKEY            *             *
     C                     Z-ADD6         DBASE            * DBERROR 006 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** Convert amounts to screen format
     C*
     C                     EXSR #DAA
     C*
     C** Convert dates to screen format
     C*
     C                     EXSR #DAB
     C*
     C** Load enquiry screen from LBPLEGLA
     C*
     C                     MOVE HHTYPE    DD3TYP
     C                     MOVE HHCODE    DD3ODE
     C                     MOVE HHNARR    DD3NAR
     C*
B1   C********** HHISSB    IFEQ *ZEROS                                                        CSD027
B1   C           HHISSB    IFEQ *BLANKS                                                       CSD027
     C                     MOVE *BLANKS   DD3SSB
X1   C                     ELSE
     C                     MOVELHHISSB    DD3SSB
E1   C                     END
     C*
     C                     MOVE HHCCY     DD3CCY
     C                     MOVE HHAGRS    DD3AGR
     C                     MOVE HHREVF    DD3EVF
     C*
B1   C           HHREVN    IFEQ *ZEROS
     C                     MOVE *BLANKS   DD3EVN
X1   C                     ELSE
     C                     MOVE HHREVN    DD3EVN
E1   C                     END
     C*
     C** Only display used to secure account when covered type = 'A'
     C*
B1   C           HHETYP    IFEQ 'A'
     C                     MOVE HHEREF    DD3ACC
     C                     MOVE HHEBCH    DD3EBH                          087628
E1   C                     END
     C*
B1   C********** HHUTSL    IFEQ *ZEROS                                                        CLE148
     C           HHUTSL    IFEQ *BLANKS                                                       CLE148
     C                     MOVE *BLANKS   DD3TSL
X1   C                     ELSE
     C                     MOVE HHUTSL    DD3TSL
E1   C                     END
     C*
     C                     MOVE HHUTSF    DD3TSF
     C                     MOVE HHUTSP    DD3TSP
     C*                                                                   LB0000
     C** IF %age present on file then borrowing power will be blank on    LB0000
     C** screen ELSE borrowing power will be the value from file          LB0000
     C*                                                                   LB0000
B1   C           HHPCAA    IFEQ *ZEROS
     C                     MOVE *BLANKS   DD3GPE
X1   C                     ELSE
     C                     MOVE HHPCAA    DD3GPE
     C*********************MOVE *BLANKS   DD3OLB                   LB0000 B10519
E1   C                     END
     C*
B1   C           HHORDN    IFEQ *ZEROS
     C                     MOVE *BLANKS   DD3ORN
     C                     Z-ADD*ZEROS    WWSORN
X1   C                     ELSE
     C                     MOVE HHORDN    DD3ORN
     C                     Z-ADDHHORDN    WWSORN
E1   C                     END
     C*
     C                     MOVE HHSESN    DD3SEN
     C                     MOVE HHPFTR    DD3TFR
     C*
     C** Only display account number when covering type = 'A'
     C*
B1   C           HHITYP    IFEQ 'A'
     C                     MOVE HHIREF    DD3ACN
     C                     MOVE HHIBCH    DD3IBH                          087628
E1   C                     END
     C*
     C** Only display deal number when covering type = 'D'
     C*
B1   C           HHITYP    IFEQ 'D'
     C                     MOVE HHIREF    DD3DNO
     C                     MOVE 'N'       DD3DCC
E1   C                     END
     C*
B1   C           HHITYP    IFEQ 'E'
     C                     MOVE *BLANKS   DD3DNO
     C                     MOVE 'Y'       DD3DCC
E2   C                     END
     C********************************************************************S01498
     C***Only*display*fid.*deposit*number*when*covering*type*=*'T'********S01498
     C********************************************************************S01498
B1   C***********HHITYP    IFEQ 'T'                                       S01498
     C***********          MOVE HHIREF    DD3FDN                          S01498
     C***********          MOVE 'N'       DD3FCC                          S01498
E1   C***********          END                                            S01498
     C*
B1   C***********HHITYP    IFEQ 'U'                                       S01498
     C***********          MOVE *BLANKS   DD3FDN                          S01498
     C***********          MOVE 'Y'       DD3FCC                          S01498
E1   C***********          END                                            S01498
     C*
B1   C           HHPLEP    IFEQ *ZEROS
     C                     MOVE *BLANKS   DD3LEP
X1   C                     ELSE
     C                     MOVE HHPLEP    DD3LEP
E1   C                     END
     C*
     C                     MOVE HHPORP    DD3ORP
     C*
     C** If Customer lending <> 'Y' => Non Display Loan & Facility
     C*
B1   C           BGCSLN    IFNE 'Y'
     C                     MOVE '0'       *IN51
E1   C                     END
     C*
     C** If Portfolio Management not exist => Non Display Portfolio flds.
     C*
B1   C           BGPFMG    IFNE 'Y'
B1   C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '0'       *IN52
E1   C                     END
     C*
     C** If Fiduciary Deposits not exist => Non Display Fiduciary
     C** Deposit No. & Fiduciary Cust. Code
     C*
B1   C           BGFLND    IFNE 'Y'
     C                     MOVE '0'       *IN53
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DAA - Convert all amounts to display format     *
     C**                                                              *
     C**  CALLS           - NONE                                      *
     C**                                                              *
     C**  CALLED BY       - #DA                                       *
     C**                                                              *
     C*****************************************************************
     C           #DAA      BEGSR
     C*
     C** Set screen fields to blanks
     C*
     C                     MOVE *BLANKS   DD3AMT
     C                     MOVE *BLANKS   DD3OLB
     C                     MOVE *BLANKS   DD3LED
     C*
     C** Type = Guarantee
     C*
B1   C           HHTYPE    IFEQ 'G'
     C*
     C                     Z-ADDHHGUAA    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3AMT
     C*
E1   C                     END
     C*
     C** Type = Collateral
     C*
B1   C           HHTYPE    IFEQ 'C'
     C*
     C                     Z-ADDHHCOLS    ZFLD15 150
     C                     Z-ADDA6NBDP    ZDECS   10
     C                     MOVE 'L'       ZECODE  1
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3AMT
     C*
     C** Borrowing Power
     C*
     C                     Z-ADDHHCOLB    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3OLB
     C*
E1   C                     END
     C*
     C** Type = Security
     C*
B1   C           HHTYPE    IFEQ 'S'
     C*
     C** Access SECTY to get nominal-decimal-places (NMDP)
     C*
     C           HHSESN    CHAINSECTY                42
     C*
     C** If not found or deleted
     C*
B2   C           *IN42     IFEQ '1'
     C           RECI      ORNE 'D'
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SECTY'   DBFILE                          S01498
     C                     MOVE 'SECTY'   DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVELWWFILE    DBKEY            *             *
     C                     Z-ADD7         DBASE            * DBERROR 007 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
X2   C                     ELSE
     C*
     C                     Z-ADDHHCOLS    ZFLD15 150
     C                     Z-ADDSENMDP    ZDECS   10
     C                     MOVE 'L'       ZECODE  1
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3AMT
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** Type = Pledges
     C*
B1   C           HHTYPE    IFEQ 'P'
     C*
B2   C           HHCODE    IFEQ 'FXD'
     C           HHCODE    OREQ 'LMT'
     C*
     C                     Z-ADDHHPLED    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3LED
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DAB - Convert all dates to display format       *
     C**                                                              *
     C**  CALLS           - NONE                                      *
     C**                                                              *
     C**  CALLED BY       - #DA                                       *
     C**                                                              *
     C*****************************************************************
     C           #DAB      BEGSR
     C*
     C** Set date fields to blanks
     C*
     C                     MOVE *BLANKS   DD3DAT
     C                     MOVE *BLANKS   DD3TTD
     C                     MOVE *BLANKS   DD3ATD
     C                     MOVE *BLANKS   DD3EVD
     C*
     C** Convert Day No.'s to display format using ZDATE2
     C*
     C*
     C** Agreement Date
     C*
B1   C           HHAGRD    IFNE *ZEROS
     C*
     C                     Z-ADDHHAGRD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     DD3DAT
     C*
E1   C                     END
     C*
     C** Start Date
     C*
B1   C           HHSTTD    IFNE *ZEROS
     C           HHTYPE    ANDNE'P'
     C*
     C                     Z-ADDHHSTTD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     DD3TTD
     C*
E1   C                     END
     C*
     C** Maturity Date
     C*
B1   C           HHMATD    IFNE *ZEROS
     C           HHTYPE    ANDNE'P'
     C*
     C                     Z-ADDHHMATD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     DD3ATD
     C*
E1   C                     END
     C*
     C** Review Date
     C*
B1   C           HHREVD    IFNE *ZEROS
     C*
     C                     Z-ADDHHREVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     DD3EVD
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DB - Insert Mode - initialise Screen            *
     C**                                                              *
     C**  CALLS          - NONE                                       *
     C**                                                              *
     C**  CALLED BY      - #E                                         *
     C**                                                              *
     C*****************************************************************
     C           #DB       BEGSR
     C*
     C                     MOVE *BLANKS   DD3TYP
     C                     MOVE *BLANKS   DD3ODE
     C                     MOVE *BLANKS   DD3NAR
     C                     MOVE *BLANKS   DD3SSB
     C                     MOVE *BLANKS   DD3CCY
     C                     MOVE *BLANKS   DD3AGR
     C                     MOVE *BLANKS   DD3DAT
     C                     MOVE *BLANKS   DD3TTD
     C                     MOVE *BLANKS   DD3ATD
     C                     MOVE *BLANKS   DD3EVD
     C                     MOVE *BLANKS   DD3EVF
     C                     MOVE *BLANKS   DD3EVN
     C                     MOVE *BLANKS   DD3TSL
     C                     MOVE *BLANKS   DD3TSF
     C                     MOVE *BLANKS   DD3ACC
     C                     MOVE *BLANKS   DD3TSP
     C                     MOVE *BLANKS   DD3AMT
     C                     MOVE *BLANKS   DD3GPE
     C                     MOVE *BLANKS   DD3ORN
     C                     Z-ADD*ZEROS    WWSORN
     C                     MOVE *BLANKS   DD3OLB
     C                     MOVE *BLANKS   DD3SEN
     C                     MOVE *BLANKS   DD3TFR
     C                     MOVE *BLANKS   DD3ACN
     C                     MOVE *BLANKS   DD3DNO
     C                     MOVE *BLANKS   DD3DCC
     C***********          MOVE *BLANKS   DD3FDN                          S01498
     C***********          MOVE *BLANKS   DD3FCC                          S01498
     C                     MOVE *BLANKS   DD3LED
     C                     MOVE *BLANKS   DD3LEP
     C                     MOVE *BLANKS   DD3ORP
     C                     MOVE *BLANKS   DD3EBH                          087628
     C                     MOVE *BLANKS   DD3IBH                          087628
     C*
     C** If Customer lending <> 'Y' => Non Display Loan & Facility
     C*
     C           BGCSLN    IFNE 'Y'
     C                     MOVE '0'       *IN51
     C                     END
     C*
     C** If Portfolio Management not exist => Non Display Portfolio flds
     C** & Security Ref.
     C*
     C           BGPFMG    IFNE 'Y'
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '0'       *IN52
     C                     END
     C*
     C** If Fiduciary Deposits not exist => Non Display Fiduciary
     C** Deposit No. & Fiduciary Cust. Code
     C*
     C           BGFLND    IFNE 'Y'
     C                     MOVE '0'       *IN53
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DC - Process Screen 3 - Enquiry                 *
     C**                                                              *
     C**  CALLS          - NONE                                       *
     C**                                                              *
     C**  CALLED BY      - #D #E                                      *
     C**                                                              *
     C*****************************************************************
     C           #DC       BEGSR
     C*
     C** If Type = 'P' & Code = 'GEN' => Non Display Pledge Amt
     C*
B1   C           HHTYPE    IFEQ 'P'
     C           HHCODE    ANDEQ'GEN'
     C*
     C                     MOVE '0'       *IN50
     C*
E1   C                     END
     C*
     C** Control DELETED literal
     C*
B1   C           HHRECI    IFEQ '*'
     C*
     C                     MOVE '1'       *IN54
     C*
X1   C                     ELSE
     C*
     C                     MOVE '0'       *IN54
     C*
E1   C                     END
     C*
     C                     MOVE 'E'       DDACT3
     C*
     C** Do until CMD-3 , CMD-12 or ENTER
     C*
B1   C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '1'
     C*
     C** Enable CMD-12 , Disable CMD-10
     C** and display correct function key text
     C*
     C                     MOVEA'10'      *IN,20           ON 20 OFF 21
     C                     MOVE '1'       *IN55
     C*
     C** Display screen 3 - Enquiry
     C*
     C                     WRITELB0220F1
     C                     EXFMTLB0220F6
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C** If ENTER pressed - Reset screen fields
     C*
B2   C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C                     MOVE '1'       *IN99
     C                     MOVE *BLANKS   DDACTC
     C                     MOVE *BLANKS   DDCNUM
     C                     MOVE *BLANKS   DD1CON
     C                     MOVE *BLANKS   DDSEQN
     C                     MOVE *BLANKS   DDRCU1
     C                     MOVE *BLANKS   DD1RCO
     C                     MOVE *BLANKS   DDRSE1
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DD - Process Screen 3 - Delete                  *
     C**                                                              *
     C**  CALLS          - NONE                                       *
     C**                                                              *
     C**  CALLED BY      - #D #E                                      *
     C**                                                              *
     C*****************************************************************
     C           #DD       BEGSR
     C*
     C** Control DELETED literal
     C*
     C                     MOVE '0'       *IN54
     C                     MOVE 'D'       DDACT3
     C*
     C** Do until CMD-3 , CMD-12 or valid request
     C*
B1   C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C*
     C** Enable CMD-12 & CMD-20 and display correct function key text
     C*
     C                     MOVEA'11'      *IN,20           ON 20-21
     C                     MOVE '0'       *IN55
     C*
     C** Initialise work fields
     C*
     C                     Z-ADD*ZEROS    WWTPRD
     C                     Z-ADD*ZEROS    WWTPID
     C                     Z-ADD*ZEROS    WWLCD
     C                     MOVE *BLANKS   WWCHTP
     C*
     C** Display screen 3 - Delete
     C*
     C                     WRITELB0220F1
     C                     WRITELB0220C1
     C                     EXFMTLB0220F6
     C                     MOVE '0'       *IN99
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C** If not CMD-3 or CMD-12
     C*
B2   C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C** If CMD-10
     C*
B3   C           *INKJ     IFEQ '1'
     C*
     C** Get tranaction number of last update
     C*
     C                     EXSR ZTNLU1
     C*
     C** Chain LBPLEGPD with saved RRN from LBPLEGLA
     C*
     C           HHARRN    CHAINLBPLEGPD             42
     C*
     C** If record not found , or TNLU <> saved TNLU
     C*
B4   C           *IN42     IFEQ '1'
     C           HHTNLU    ORNE PGTNLU
     C*
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0057' ZAMSID
     C                     EXSR ZASNMS
     C*
B5   C           *IN42     IFEQ '0'
     C                     EXCPTLBXXXX
E5   C                     END
     C*
     C** Record found
     C*
X4   C                     ELSE
     C*
     C** Save last change date & type
     C*
     C                     Z-ADDPGLCD     WWLCD
     C                     MOVE PGCHTP    WWCHTP
     C*
     C** Update status to deleted on LBPLEGPD
     C*
     C                     MOVE '*'       PGRECI
     C                     Z-ADDBJRDNB    PGLCD
     C                     MOVE 'D'       PGCHTP
     C                     Z-ADDWWDSTN    PGTNLU
     C                     UPDATLBPLEGD0
     C*
     C** Access trailer file using pledge file name
     C*
     C                     MOVE 'LBPLEGPD'WWFILE  8
     C           WWFILE    CHAINLBTRAIPD             42
     C*
     C** If record not found or record-id not = 'T'
     C*
B5   C           *IN42     IFEQ '1'
     C           TRRECI    ORNE 'T'
     C*
     C                     ROLBK
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'LBTRAIPD'DBFILE                          S01498
     C                     MOVE 'LBTRAIPD'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVELWWFILE    DBKEY            *             *
     C                     Z-ADD8         DBASE            * DBERROR 008 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C** else record found
     C*
X5   C                     ELSE
     C*
     C** If last-change-date = today
     C*
B6   C           WWLCD     IFEQ BJRDNB
     C*
     C** If last-change-type = 'I'
     C*
B7   C           WWCHTP    IFEQ 'I'
     C*
     C                     SUB  1         TRINS
     C*
E7   C                     END
     C*
     C** If last-change-type = 'A'
     C*
B7   C           WWCHTP    IFEQ 'A'
     C*
     C                     SUB  1         TRAMD
     C*
E7   C                     END
     C*
E6   C                     END
     C*
     C                     ADD  1         TRDEL
     C                     SUB  1         TRLIVE
     C                     Z-ADDBJRDNB    TRLCD
     C                     MOVE 'A'       TRCHTP
     C*
     C** Update trailer file
     C*
     C                     UPDATLBTRAID0
     C*
E5   C                     END
     C*
     C** If valid so far
     C*
B5   C           *IN99     IFEQ '0'
     C*
     C** If Portfolio Management Installed - Update portfolio details
     C*
B6   C           BGPFMG    IFEQ 'Y'
B6   C           BGN4ST    OREQ 'Y'                                       CPB001
     C*
     C** If portfolio pledged field is entered
     C*
B7   C           DD3ORP    IFNE *BLANKS
     C*
     C***Access*portfolio*details*file*-*PMPORTPP*************************S01498
     C** Access portfolio details file - PMPORTPD                         S01498
     C*
     C***********KL2       CHAINPMPORTPP             42                   S01498
     C           KL2       CHAINPMPORTPD             42                   S01498
     C*
     C** If record not found or deleted
     C*
B8   C           *IN42     IFEQ '1'
     C           PNRECI    OREQ '*'
     C                     ROLBK
     C                     MOVE '1'       *IN82
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0081' ZAMSID
     C                     EXSR ZASNMS
B9   C           *IN42     IFEQ '0'
     C                     EXCPTPMPORT
E9   C                     END
     C*
     C** else record found
     C*
X8   C                     ELSE
     C*
     C***Update*file*-*PMPORTPP*******************************************S01498
     C** Update file - PMPORTPD                                           S01498
     C*
     C                     Z-ADD*ZEROS    PNPDGS
     C                     Z-ADD*ZEROS    PNPDGF
     C                     UPDATPMPORTP0
     C*
E8   C                     END
     C*
E7   C                     END
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
     C** If no errors - comit update
     C*
B4   C           *IN99     IFEQ '0'
     C*
     C           CMTTXT    COMIT
     C*
E4   C                     END
     C***********                                                         LB0009
     C***ENTER*pressed - redisplay screen                                 LB0009
     C***********                                                         LB0009
X3   C***********          ELSE                                           LB0009
     C***********                                                         LB0009
     C***********          MOVE '1'       *IN99                           LB0009
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DE - Process Screen 3 - Insert/Amend            *
     C**                                                              *
     C**  CALLS          - #DEA #DEB                                  *
     C**                                                              *
     C**  CALLED BY      - #D #E                                      *
     C**                                                              *
     C*****************************************************************
     C           #DE       BEGSR
     C*
     C** Control DELETED literal/Command keys
     C*
     C                     MOVEA'10'      *IN,20           ON 20 OFF 21
     C                     MOVEA'01'      *IN,54           OFF 54 ON 55
     C*
     C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C*
     C                     WRITELB0220F1
     C                     WRITELB0220C1
     C                     EXFMTLB0220F4
     C*
     C                     MOVEA'00'      *IN,60           OFF 60-61
     C                     MOVEA'00000000'*IN,63           OFF 63-70
     C                     MOVEA'00000000'*IN,71           OFF 71-78
     C                     MOVEA'00000000'*IN,79           OFF 79-86
     C                     MOVEA'000'     *IN,87           OFF 87-89
     C                     MOVE '0'       *IN99
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C** No Command keys
     C*
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C** VALIDATION
     C*  ==========
     C                     EXSR #DEA
     C*
     C** If all validation sucessfull - UPDATE FILE
     C*
     C           *IN99     IFEQ '0'
     C*
     C                     EXSR #DEB
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEA - Validate screen 3 - Insert/Amend          *
     C**                                                              *
     C**  CALLS           - #DEAA #DEAB #DEAC #DEAD #DEAE #DEAF #DEAG *
     C**                    #DEAH #DEAI #DEAJ #DEAK #DEAL #DEAM #DEAN *
     C**                                                              *
     C**  CALLED BY      -  #DE                                       *
     C**                                                              *
     C*****************************************************************
     C           #DEA      BEGSR
     C*
     C** Initialise work fields - used for file update
     C*
     C                     MOVE *BLANKS   WWETYP
     C                     MOVE *BLANKS   WWEREF
     C                     MOVE *BLANKS   WWITYP
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE *BLANKS   WWEBCH                          087628
     C                     MOVE *BLANKS   WWIBCH                          087628
     C*
     C** Validate Type & Code
     C*
     C                     EXSR #DEAA
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Issued By Customer & Currency
     C*
     C                     EXSR #DEAB
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Agreement Signed , Agreement Date , Start Date ,
     C** Maturity Date & Review Date
     C*
     C                     EXSR #DEAC
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Review Frequency & Review Day No
     C*
     C                     EXSR #DEAD
     C*
     C                     END
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate 'Used to Secure' fields
     C*
     C                     EXSR #DEAE
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Type specific input
     C*
     C                     EXSR #DEAF
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Percentage
     C*
     C                     EXSR #DEAG
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Security Reference and Portfolio Security Reference
     C*
     C                     EXSR #DEAH
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Guarantee,Collateral,Security Amount
     C*
     C                     EXSR #DEAI
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Account number
     C*
     C                     EXSR #DEAJ
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Deal number & Deal customer code
     C*
     C                     EXSR #DEAK
     C*
     C                     END
     C*
     C************IN99     IFEQ '0'                                       S01498
     C********************************************************************S01498
     C***Validate*Fiduciary*Deposit*number*&*Fiduciary*customer*code******S01498
     C********************************************************************S01498
     C***********          EXSR #DEAL                                     S01498
     C********************************************************************S01498
     C***********          END                                            S01498
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate Pledge fields
     C*
     C                     EXSR #DEAM
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Check start date & maturity date are in correct range
     C*
     C                     EXSR #DEAN
     C*
     C                     END
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate order no.
     C*
     C                     EXSR #DEAO
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAA - Validate type & code                     *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAA     BEGSR
     C*
     C** Type
     C*
     C           DD3TYP    IFNE 'G'
     C           DD3TYP    ANDNE'S'
     C           DD3TYP    ANDNE'X'
     C           DD3TYP    ANDNE'C'
     C           DD3TYP    ANDNE'A'
     C           DD3TYP    ANDNE'T'
     C           DD3TYP    ANDNE'D'
     C           DD3TYP    ANDNE'P'
     C                     MOVE '1'       *IN60
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0084' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C*
     C** Type = C : Code must be entered
     C*
     C           DD3TYP    IFEQ 'C'
     C*
     C           DD3ODE    IFEQ *BLANKS
     C                     MOVE '1'       *IN61
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0085' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C*
     C                     END
     C*
     C** Type = P : Code must be 'FXD' 'LMT' GEN
     C*
     C           DD3TYP    IFEQ 'P'
     C*
     C           DD3ODE    IFNE 'FXD'
     C           DD3ODE    ANDNE'LMT'
     C           DD3ODE    ANDNE'GEN'
     C                     MOVE '1'       *IN61
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0086' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C*
     C***Type*=*P*:*Issued*to*customer*must*be*PORTFOLIO*LENDING*CUSTOMER*S01498
     C*
     C***********HHLOMB    IFNE 'Y'                                       S01498
     C***********          MOVEA'11'      *IN,59           ON 59-60       S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0088' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C***********          END                                            S01498
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAB - Validate issued by customer and ccy      *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAB     BEGSR
     C*
     C** Initialise workfields used for file update
     C*
     C**********           Z-ADD*ZEROS    WWCUS2                                              CSD027
     C                     MOVE *BLANKS   WWCUS2                                              CSD027
     C*
     C** Issued By Customer
B1   C           DD3SSB    IFEQ *BLANKS                                   054787
     C***********          MOVE '1'       *IN59                    054787 080106
     C                     MOVE '1'       *IN63                           080106
     C                     MOVE '1'       *IN99                           080106
     C                     MOVEL'LBM9003' ZAMSID                          054787
     C                     EXSR ZASNMS                                    054787
     C                     GOTO DEABEN                                    054787
     C                     END                                            054787
     C*
B1   C           DD3SSB    IFNE *BLANKS
     C*
     C                     MOVELDD3SSB    WWALF1
     C           WWALF1    LOKUPALPNU                    27
     C*
B2   C           *IN27     IFEQ '0'
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C           WWALF1    LOKUPNUM                      27
     C*
B3   C           *IN27     IFNE '1'
     C*
     C***Non-numeric*Chain*SDLBCSL8***************************************S01498
     C** Non-numeric Chain LBLBCSJ8                                       S01498
     C*
     C***********DD3SSB    CHAINSDLBCSL8             42                   S01498
     C           DD3SSB    CHAINLBLBCSJ8             42                   S01498
     C*
     C** If not found or deleted
     C*
B4   C           *IN42     IFEQ '1'
     C           BBTYLC    OREQ 'D'
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X4   C                     ELSE
     C*
     C** Issued by customer cannot be a parent
     C*
B5   C           BBPAIN    IFEQ 'P'
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0021' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C                     MOVE BBCUST    WWCUS2
     C*
E5   C                     END
     C*
E4   C                     END
     C*
X3   C                     ELSE
     C*
     C** Numeric
     C*
     C                     Z-ADD0         W       20
     C*
B4   C********** W         DOUEQ6                                                             CSD027
     C********** *IN99     OREQ '1'                                                           CSD027
     C*
     C**********           ADD  1         W                                                   CSD027
     C********** INP3,W    LOKUPNUM                      27                                   CSD027
     C*
B5   C********** *IN27     IFNE '1'                                                           CSD027
     C*
     C**********           MOVE '1'       *IN63                                               CSD027
     C**********           MOVE '1'       *IN99                                               CSD027
     C**********           MOVEL'LBM0007' ZAMSID                                              CSD027
     C**********           EXSR ZASNMS                                                        CSD027
     C*
E5   C**********           END                                                                CSD027
     C*
E4   C**********           END                                                                CSD027
     C*
B4   C           *IN99     IFEQ '0'
     C*
B5   C           WWL3      IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C** Valid 6 Digit number
     C*
     C                     MOVELDD3SSB    WWPNP8
     C                     MOVELDD3SSB    WWCUS2
     C*
     C***********WWPNP8    CHAINSDLBCSL7             42                   S01498
     C           WWPNP8    CHAINLBLBCSJ7             42                   S01498
     C*
     C** If not found or deleted
     C*
B6   C           *IN42     IFEQ '1'
     C           BBTYLC    OREQ 'D'
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
X6   C                     ELSE
     C*
     C** Issued by customer cannot be a parent
     C*
B7   C           BBPAIN    IFEQ 'P'
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0021' ZAMSID
     C                     EXSR ZASNMS
     C*
E7   C                     END
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** Issued to customer cannot = issued by customer
     C*
B3   C           *IN99     IFEQ '0'
     C*
B4   C           WWCUS2    IFEQ HHCNUM
     C*
B5   C           DD3TYP    IFEQ 'P'                                       B10091
     C           DD3TYP    OREQ 'G'                                       B10091
     C*
     C                     MOVE '1'       *IN59
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0090' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END                                            B10091
     C*
X4   C                     ELSE
     C*
     C***If*type*=*'P'*issued*by*customer*must*be*a*Portfolio*Lending*custS01498
     C*
B5   C***********DD3TYP    IFEQ 'P'                                       S01498
     C***********CULOMB    ANDNE'Y'                                       S01498
     C*
     C***********          MOVE '1'       *IN63                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0088' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C*
E5   C***********          END                                            S01498
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*                                                                   R0065
     C** If valid so far                                                  R0065
B1   C           *IN99     IFEQ '0'                                       R0065
     C*                                                                   R0065
     C** Access LBEXTSL1 to retrieve Commitment Line                      R0065
     C           WWCUS2    CHAINLBEXTSL1             42                   R0065
     C*                                                                   R0065
B1   C           *IN42     IFEQ '1'                                       R0065
     C           ESRECI    OREQ '*'                                       R0065
     C* Warning given if issuer of pledge has no commitment line.         R0065
     C           SW        IFEQ 0                                         R0065
     C                     MOVE '1'       *IN99                           R0065
     C                     MOVEL'LBM1104' ZAMSID                          R0065
     C                     EXSR ZASNMS                                    R0065
     C                     Z-ADD1         SW                              R0065
     C                     END                                            R0065
B1   C                     ELSE                                           R0065
     C* Warning given if issuer of pledge has no commitment line.         R0065
     C           ESCMTL    IFEQ 0                                         R0065
     C           SW        IFEQ 0                                         R0065
     C                     MOVE '1'       *IN99                           R0065
     C                     MOVEL'LBM1104' ZAMSID                          R0065
     C                     EXSR ZASNMS                                    R0065
     C                     Z-ADD1         SW                              R0065
     C                     END                                            R0065
     C                     END                                            R0065
     C                     END                                            R0065
     C                     END                                            R0065
     C*
     C** If valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** If type = 'S'
     C*
B2   C           DD3TYP    IFEQ 'S'
     C*
     C** Currency must be blank
     C*
B3   C           DD3CCY    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN64
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0135' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
X2   C                     ELSE
     C*
     C** else type not = 'S'
     C*
B3   C           DD3TYP    IFNE 'S'
     C*
     C** If currency is blank
     C*
B4   C           DD3CCY    IFEQ *BLANKS
     C*
     C** If action = insert - default to portfolio lending ccy
     C*
B5   C           DDACT3    IFEQ 'I'
     C*
     C***********          MOVE LBCCY     DD3CCY                          S01498
     C                     MOVE LBCYCD    DD3CCY                          S01498
     C*
     C** else ccy must be entered
     C*
X5   C                     ELSE
     C*
     C                     MOVE '1'       *IN64
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0091' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
X4   C                     ELSE
     C*
     C** else check valid ccy
     C*
     C***********DD3CCY    CHAINSDCURRL1             42                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM DD3CCY    @CYCD   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*
     C** If not found or deleted
     C*
B5   C************IN42     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C           @RTCD     IFNE *BLANKS                                   S01498
     C*
     C                     MOVE '1'       *IN64
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0092' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C           DEABEN    TAG                                            054787
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAC - Validate agreement signed field and the  *
     C**                     following dates - start date, agreement  *
     C**                     date, maturity date & review date        *
     C**                                                              *
     C**  CALLS            - #ZA                                      *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAC     BEGSR
     C*
     C** Initialise workfields used for file update
     C*
     C                     Z-ADD*ZEROS    WWEDAT
     C                     Z-ADD*ZEROS    WWETTD
     C                     Z-ADD*ZEROS    WWEATD
     C                     Z-ADD*ZEROS    WWEEVD
     C*
     C** If Agreement Signed = blanks and action = insert
     C**    default to 'Y'
     C*
B1   C           DD3AGR    IFEQ *BLANKS
     C           DDACT3    ANDEQ'I'
     C*
     C***                  MOVE 'Y'       DD3AGR                          B9669
     C                     MOVE 'N'       DD3AGR                          B9669
     C*
E1   C                     END
     C*
     C** If Agreement Signed = 'Y'
     C*
B1   C           DD3AGR    IFEQ 'Y'
     C*
     C** If agreement date not entered  - error
     C*
B2   C           DD3DAT    IFEQ *BLANKS
     C*
     C                     MOVEA'11'      *IN,65           ON 65-66
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0186' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
     C** Else agreement signed <> 'Y'
     C*
X1   C                     ELSE
     C*
     C** If Agreement Signed = 'N'
     C*
B2   C           DD3AGR    IFEQ 'N'
     C*
     C** If agreement date entered  - error
     C*
B3   C           DD3DAT    IFNE *BLANKS
     C*
     C                     MOVEA'11'      *IN,65           ON 65-66
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0136' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
     C** Else Agreement Signed <> 'Y' or 'N' - error
     C*
X2   C                     ELSE
     C*
     C                     MOVE '1'       *IN65
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0093' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** If agreement date entered
     C*
B2   C           DD3DAT    IFNE *BLANKS
     C*
     C** Convert Date Agreement signed to MIDAS DAY NUMBER
     C*
     C                     MOVE DD3DAT    WWDATE  6
     C*
     C                     EXSR #ZA
     C*
     C** Invalid date
     C*
B3   C           ZDAYNO    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN66
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0094' ZAMSID
     C                     EXSR ZASNMS
     C*
X3   C                     ELSE
     C*
     C** save valid Dayno
     C*
     C                     Z-ADDZDAYNO    WWEDAT
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** Pledges : Start date must be blank
     C*
B2   C           DD3TYP    IFEQ 'P'
     C*
     C                     Z-ADD*ZEROS    WWETTD
     C*
B3   C           DD3TTD    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN67
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0096' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
X2   C                     ELSE
     C*
     C** Convert Start Date to MIDAS DAY NUMBER
     C*
     C                     MOVE DD3TTD    WWDATE
     C*
     C                     EXSR #ZA
     C*
     C** Invalid date
     C*
B3   C           ZDAYNO    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN67
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0058' ZAMSID
     C                     EXSR ZASNMS
     C*
X3   C                     ELSE
     C*
     C** Date must be today or later
     C*
B4   C*          ZDAYNO    IFLT BJAKTX                                    LB0000
     C*                                                                   LB0000
     C*                    MOVE '1'       *IN67                           LB0000
     C*                    MOVE '1'       *IN99                           LB0000
     C*                    MOVEL'LBM0097' ZAMSID                          LB0000
     C*                    EXSR ZASNMS                                    LB0000
     C*                                                                   LB0000
X4   C*                    ELSE                                           LB0000
     C*
     C** save valid Dayno
     C*
     C                     Z-ADDZDAYNO    WWETTD
     C*
E4   C*                    END                                            LB0000
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** Pledges : Maturity Date must be blank
     C*
B2   C           DD3TYP    IFEQ 'P'
     C*
     C                     Z-ADD99999     WWEATD
     C*
B3   C           DD3ATD    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN68
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0098' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
X2   C                     ELSE
     C*
     C** Convert Maturity Date to MIDAS DAY NUMBER
     C*
     C                     MOVE DD3ATD    WWDATE
     C                     EXSR #ZA
     C*
     C** Invalid date
     C*
B3   C           ZDAYNO    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN68
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0099' ZAMSID
     C                     EXSR ZASNMS
     C*
X3   C                     ELSE
     C*
     C** Date must later than current date
     C*
B4   C           ZDAYNO    IFLE BJRDNB
     C*
     C                     MOVE '1'       *IN68
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0100' ZAMSID
     C                     EXSR ZASNMS
     C*
X4   C                     ELSE
     C*
     C** Date must later than start date
     C*
B5   C           ZDAYNO    IFLE WWETTD
     C*
     C                     MOVE '1'       *IN68
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0101' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C** save valid Dayno
     C*
     C                     Z-ADDZDAYNO    WWEATD
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** if valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** Review date optional
     C*
B2   C           DD3EVD    IFNE *BLANKS
     C*
     C** Convert Review date MIDAS DAY NUMBER
     C*
     C                     MOVE DD3EVD    WWDATE
     C                     EXSR #ZA
     C*
     C** Invalid date
     C*
B3   C           ZDAYNO    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN69
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0102' ZAMSID
     C                     EXSR ZASNMS
     C*
X3   C                     ELSE
     C*
     C** save valid Dayno
     C*
     C                     Z-ADDZDAYNO    WWEEVD
     C*
     C** Date must later than current date
     C*
B4   C           ZDAYNO    IFLE BJRDNB
     C*
     C                     MOVE '1'       *IN69
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0030' ZAMSID
     C                     EXSR ZASNMS
     C*
X4   C                     ELSE
     C*
B5   C           DD3TYP    IFNE 'P'
     C*
     C** Date must later than start date
     C*
B6   C           ZDAYNO    IFLE WWETTD
     C*
     C                     MOVE '1'       *IN69
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0031' ZAMSID
     C                     EXSR ZASNMS
     C*
X6   C                     ELSE
     C*
     C** Date must be earlier than maturity date
     C*
B7   C           ZDAYNO    IFGE WWEATD
     C*
     C                     MOVE '1'       *IN69
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0103' ZAMSID
     C                     EXSR ZASNMS
     C*
E7   C                     END
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAD  - Validate review frequency and review    *
     C**                      day number                              *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEA                                    *
     C**                                                              *
     C*****************************************************************
     C           #DEAD     BEGSR
     C*
     C** Review frequency cannot be entered if review date = blanks
     C*
B1   C           DD3EVF    IFNE *BLANKS
     C*
B2   C           DD3EVD    IFEQ *BLANKS
     C*
     C                     MOVEA'11'      *IN,69           ON 69-70
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0033' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C** Review frequency must be 'M' 'Q' 'X' or 'Y'
     C*
B3   C           DD3EVF    IFNE 'M'
     C           DD3EVF    ANDNE'Q'
     C           DD3EVF    ANDNE'X'
     C           DD3EVF    ANDNE'Y'
     C*
     C                     MOVE '1'       *IN70
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0036' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** Review Day no.
     C*
B2   C           DD3EVN    IFNE *BLANKS
     C*
     C** Error: Review Freq entered
     C*
B3   C           DD3EVF    IFEQ *BLANKS
     C*
     C                     MOVEA'111'     *IN,69           ON 69-71
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0034' ZAMSID
     C                     EXSR ZASNMS
     C*
X3   C                     ELSE
     C*
     C** Review from Day No. validation : execute ZALIGN
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD2         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3EVN    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check correct range
     C*
B4   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DD3EVN
     C*
B5   C           DD3EVN    IFLE '00'
     C           DD3EVN    ORGT '31'
     C*
     C                     MOVE '1'       *IN71
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0035' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
X4   C                     ELSE
     C*
     C                     MOVE '1'       *IN71
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0035' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** Day number = blanks
     C*
X2   C                     ELSE
     C*
     C** If review frequency entered
     C*
B3   C           DD3EVF    IFNE *BLANKS
     C*
     C** default to day number from review date
     C*
     C** *IN98 = 1 MMDDYY   *IN98 = 0 DDMMYY
     C*
B4   C           *IN98     IFEQ '1'
     C*
     C                     MOVE WWMM      DD3EVN
     C*
X4   C                     ELSE
     C*
     C                     MOVE WWDD      DD3EVN
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAE  - Validate 'Used to Secure' fields        *
     C**                                                              *
     C**  CALLS             - #DEAEA #DEAEB #DEAEC #DEAED             *
     C**                                                              *
     C**  CALLED BY         - #DEA                                    *
     C**                                                              *
     C*****************************************************************
     C           #DEAE     BEGSR
     C*
     C** initialise used-to-secure-fields-blank flag
     C*
     C                     MOVE 'N'       WWUTSB  1
     C*
     C** if customer lending & portfolio management are installed
     C*
B1   C           BGCSLN    IFEQ 'Y'
     C           BGPFMG    ANDEQ'Y'
B1   C           BGCSLN    OREQ 'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C*
     C** If used to secure account has been entered
     C*
B2   C           DD3ACC    IFNE *BLANKS
     C*
     C** Used to secure loan,facility & portfolio must be blank
     C*
B3   C           DD3TSL    IFNE *BLANKS
     C           DD3TSF    ORNE *BLANKS
     C           DD3TSP    ORNE *BLANKS
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
     C** else account not entered
     C*
X2   C                     ELSE
     C*
     C** If used to secure loan has been entered
     C*
B3   C           DD3TSL    IFNE *BLANKS
     C*
     C** Used to secure facility & portfolio must be blank
     C*
B4   C           DD3TSF    IFNE *BLANKS
     C           DD3TSP    ORNE *BLANKS
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
     C** else loan not entered
     C*
X3   C                     ELSE
     C*
     C** If used to secure facility has been entered
     C*
B4   C           DD3TSF    IFNE *BLANKS
     C*
     C** Used to secure portfolio must be blank
     C*
B5   C           DD3TSP    IFNE *BLANKS
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
     C** else facility not entered
     C*
X4   C                     ELSE
     C*
     C** If used to secure portfolio has not been entered
     C*
B5   C           DD3TSP    IFEQ *BLANKS
     C*
     C** If guarantee or generalised pledge
     C** set used-to-secure-fields-blank flag
     C*
B6   C           DD3TYP    IFEQ 'G'
     C*
     C           DD3TYP    OREQ 'P'
     C*                                                                   B4809
     C** Used to secure fields can now be blank for all types of pledge   B4809
     C*                                                                   B4809
     C***********DD3ODE    ANDEQ'GEN'                                     B4809
     C*
     C                     MOVE 'Y'       WWUTSB
     C*
X6   C                     ELSE
     C*
     C** If not guarantee or generalised pledge - field cannot be blank
     C*
     C*  Fields mandatory if type D or T otherwise are optional           080106
     C           DD3TYP    IFEQ 'D'                                       080106
     C           DD3TYP    OREQ 'T'                                       080106
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C                     END                                            080106
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** if customer lending installed & portfolio management not installed
     C*
B1   C           BGCSLN    IFEQ 'Y'
     C           BGPFMG    ANDNE'Y'
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C*
     C** If used to secure account has been entered
     C*
B2   C           DD3ACC    IFNE *BLANKS
     C*
     C** Used to secure loan & facility  must be blank
     C*
B3   C           DD3TSL    IFNE *BLANKS
     C           DD3TSF    ORNE *BLANKS
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
     C** else account not entered
     C*
X2   C                     ELSE
     C*
     C** If used to secure loan has been entered
     C*
B3   C           DD3TSL    IFNE *BLANKS
     C*
     C** Used to secure facility must be blank
     C*
B4   C           DD3TSF    IFNE *BLANKS
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
     C** else loan not entered
     C*
X3   C                     ELSE
     C*
     C** If used to secure facility has not been entered
     C*
B4   C           DD3TSF    IFEQ *BLANKS
     C*
     C** If guarantee or generalised pledge
     C** set used-to-secure-fields-blank flag
     C*
B5   C           DD3TYP    IFEQ 'G'
     C*
     C           DD3TYP    OREQ 'P'
     C*                                                                   B4809
     C** Used to secure fields can now be blank for all types of pledge   B4809
     C*                                                                   B4809
     C***********DD3ODE    ANDEQ'GEN'                                     B4809
     C*
     C                     MOVE 'Y'       WWUTSB
     C*
X5   C                     ELSE
     C*
     C** If not guarantee or generalised pledge - field cannot be blank
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** if customer lending not installed & portfolio management is installed
     C*
B1   C           BGCSLN    IFNE 'Y'
     C           BGPFMG    ANDEQ'Y'
B1   C           BGCSLN    ORNE 'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C*
     C** If used to secure account has been entered
     C*
B2   C           DD3ACC    IFNE *BLANKS
     C*
     C** Used to secure portfolio must be blank
     C*
B3   C           DD3TSP    IFNE *BLANKS
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
     C** else account not entered
     C*
X2   C                     ELSE
     C*
     C** If used to secure portfolio has not been entered
     C*
B3   C           DD3TSP    IFEQ *BLANKS
     C*
     C** If guarantee or generalised pledge
     C** set used-to-secure-fields-blank flag
     C*
B4   C           DD3TYP    IFEQ 'G'
     C*
     C           DD3TYP    OREQ 'P'
     C*                                                                   B4809
     C** Used to secure fields can now be blank for all types of pledge   B4809
     C*                                                                   B4809
     C***********DD3ODE    ANDEQ'GEN'                                     B4809
     C*
     C                     MOVE 'Y'       WWUTSB
     C*
X4   C                     ELSE
     C*
     C** If not guarantee or generalised pledge - field cannot be blank
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** if customer lending not installed & portfolio management not installed
     C*
B1   C           BGCSLN    IFNE 'Y'
     C           BGPFMG    ANDNE'Y'
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C*
     C** If used to secure account has not been entered
     C*
B2   C           DD3ACC    IFEQ *BLANKS
     C*
     C** If guarantee or generalised pledge
     C** set used-to-secure-fields-blank flag
     C*
B3   C           DD3TYP    IFEQ 'G'
     C*
     C           DD3TYP    OREQ 'P'
     C           DD3ODE    ANDEQ'GEN'
     C*
     C                     MOVE 'Y'       WWUTSB
     C*
X3   C                     ELSE
     C*
     C** If not guarantee or generalised pledge - field cannot be blank
     C*
     C                     MOVEA'1111'    *IN,72           ON 72-75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0145' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If used to secure fields not blank
     C*
B1   C           WWUTSB    IFEQ 'N'
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     EXSR #DEAEA
     C*
E2   C                     END
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     EXSR #DEAEB
     C*
E2   C                     END
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     EXSR #DEAEC
     C*
E2   C                     END
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     EXSR #DEAED
     C*
E2   C                     END
     C*
X1   C                     ELSE                                           LB0000
     C*                                                                   LB0000
     C** Set up start date & maturity date                                LB0000
     C*                                                                   LB0000
     C                     Z-ADD*HIVAL    WW1MDT                          LB0000
     C                     Z-ADD*LOVAL    WW1SDT                          LB0000
     C*                                                                   LB0000
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAEA - Validate 'Used to secure' account       *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEAE                                   *
     C**                                                              *
     C*****************************************************************
     C           #DEAEA    BEGSR
     C*
     C** If used secure account field has been entered
     C*
B1   C           DD3ACC    IFNE *BLANKS
     C*
     C                     MOVE DD3ACC    KACNT
     C           BGMBIN    IFEQ 'Y'                                       087628
     C                     MOVE DD3EBH    WKBRCA                          087628
     C                     END                                            087628
     C*
     C** Account customer must equal collateral customer
     C*
B2   C           WWCUS1    IFNE WKACNU
     C*
     C                     MOVE '1'       *IN59
     C                     MOVE '1'       *IN72
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0152' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C***Access*account*master*file*-*ACCNABL1                            S01498
     C** Access account master file - LBACCNL1                            S01498
     C*
     C********** KACCNT    CHAINACCNABL1             46                   S01498
     C           KACCNT    CHAINLBACCNL1             46                   S01498
     C*
     C** If record not found or deleted - error
     C*
B3   C           *IN46     IFEQ '1'
     C           RECI      OREQ '*'
     C*
     C                     MOVE '1'       *IN72
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0146' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else record found
     C*
X3   C                     ELSE
     C*
     C** retrieve start date & maturity date
     C*
     C                     Z-ADD*LOVAL    WW1SDT
     C                     Z-ADD*HIVAL    WW1MDT
     C*
     C** check collateral number is not already used to cover
     C** another account/loan/facility/portfolio
     C*
     C                     MOVE *BLANKS   WWEREF
     C                     MOVE DD3ACC    WWEREF
     C                     MOVE 'A'       WWETYP
     C           BGMBIN    IFEQ 'Y'                                       087628
     C                     MOVE DD3EBH    WWEBCH                          087628
     C                     END                                            087628
     C*
     C                     EXSR #ZC
     C*
     C** If error
     C*
B4   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN72
     C                     MOVEL'LBM0147' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAEB - Validate 'Used to secure' loan          *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEAE                                   *
     C**                                                              *
     C*****************************************************************
     C           #DEAEB    BEGSR
     C*
     C** Initialise work fields - used for file update
     C*
     C**********           Z-ADD*ZEROS    WWETSL  60                                          CLE148
     C                     MOVE *BLANKS   WWETSL  6                                           CLE148
     C*
     C** If customer lending is installed and
     C** used to secure loan field has been entered
     C*
B1   C           BGCSLN    IFEQ 'Y'
     C           DD3TSL    ANDNE*BLANKS
     C*
     C***check*if*numeric                                                                     CLE148
     C*
     C**********           MOVE DD3TSL    WWNUM7  70                                          CLE148
     C**********           MOVE WWNUM7    WWALF6  6                                           CLE148
     C*
     C***If*valid
     C*
     C********** DD3TSL    IFEQ WWALF6                                                        CLE148
     C*
     C***Chain*CLOANCL1*with*entered*loan*number************              B08218
     C** Chain CLOANC with entered loan number                            B08218
     C*
     C                     MOVE DD3TSL    WWETSL
     C********** WWETSL    CHAINCLOANCL1             42                   B08218
     C                     MOVE 'A'       WWRECT                          B08218
     C           KL11      CHAINCLOAN                42                   B08218
     C*
     C** If not found or deleted
     C*
     C           *IN42     IFEQ '1'
     C           RECI      OREQ '*'
     C*
     C                     MOVE '1'       *IN73
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0105' ZAMSID
     C                     EXSR ZASNMS
     C*
     C                     ELSE
     C*
     C** If found - processing type must be in the range 61-65
     C*
     C           PTYP      IFLT 61
     C           PTYP      ORGT 65
     C*
     C                     MOVE '1'       *IN73
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0104' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else in range
     C*
     C                     ELSE
     C*
     C** retrieve start date & maturity date
     C*
     C                     Z-ADDVDAT      WW1SDT
     C*
     C** If retrieved date is zero set workfield to *hival
     C*
     C           MDAT      IFEQ *ZEROS
     C                     Z-ADD*HIVAL    WW1MDT
X5   C                     ELSE
     C                     Z-ADDMDAT      WW1MDT
E5   C                     END
     C*
     C** check collateral number is not already used to cover
     C** another account/loan/facility/portfolio
     C*
     C                     MOVE *BLANKS   WWEREF
     C                     MOVE DD3TSL    WWEREF
     C                     MOVE 'L'       WWETYP
     C*
     C                     EXSR #ZC
     C*
     C** If error
     C*
B5   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN73
     C                     MOVEL'LBM0147' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C***Not*valid*number                                                                     CLE148
     C*
X2   C**********           ELSE                                                               CLE148
     C*
     C**********           MOVE '1'       *IN73                                               CLE148
     C**********           MOVE '1'       *IN99                                               CLE148
     C**********           MOVEL'LBM0105' ZAMSID                                              CLE148
     C**********           EXSR ZASNMS                                                        CLE148
     C*
E2   C**********           END                                                                CLE148
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAEC - Validate 'Used to secure' facility      *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEAE                                   *
     C**                                                              *
     C*****************************************************************
     C           #DEAEC    BEGSR
     C*
     C** If customer lending is installed and
     C** used to secure facility field has been entered
     C*
B1   C           BGCSLN    IFEQ 'Y'
     C           DD3TSF    ANDNE*BLANKS
     C*
     C                     MOVE DD3TSF    WWETSF
     C*
     C********** KL3       CHAINFCLYFML2             42                   S01498
     C           KL3       CHAINLBFCLTL2             42                   S01498
     C*
     C** If not found or deleted
     C*
B2   C           *IN42     IFEQ '1'
     C           RECI      OREQ '*'
     C*
     C                     MOVE '1'       *IN74
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0106' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else record found
     C*
X2   C                     ELSE
     C*
     C** retrieve start date & maturity date
     C*
     C                     Z-ADDDTAP      WW1SDT
     C*
     C** If retrieved date is zero set workfield to *hival
     C*
B3   C           DTEX      IFEQ *ZEROS
     C                     Z-ADD*HIVAL    WW1MDT
X3   C                     ELSE
     C                     Z-ADDDTEX      WW1MDT
E3   C                     END
     C*
     C** check collateral number is not already used to cover
     C** another account/loan/facility/portfolio
     C*
     C                     MOVE DD3TSF    WWEREF
     C                     MOVE 'F'       WWETYP
     C*
     C                     EXSR #ZC
     C*
     C** If error
     C*
B3   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN74
     C                     MOVEL'LBM0147' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAED - Validate 'Used to secure' portfolio     *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEAE                                   *
     C**                                                              *
     C*****************************************************************
     C           #DEAED    BEGSR
     C*
     C** If portfolio management is installed
     C** and used to secure portfolio field has been entered
     C*
B1   C           BGPFMG    IFEQ 'Y'
     C           DD3TSP    ANDNE*BLANKS
B1   C           BGN4ST    OREQ 'Y'                                       CPB001
     C           DD3TSP    ANDNE*BLANKS                                   CPB001
     C*
     C** Access portfolio details file - PMPORTXX
     C*
     C           KL4       CHAINPMPORTXX             42
     C*
     C** If not found or deleted
     C*
B2   C           *IN42     IFEQ '1'
     C           PNRECI    OREQ '*'
     C*
     C                     MOVE '1'       *IN75
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0107' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else record found
     C*
X2   C                     ELSE
     C*
     C** retrieve start date & maturity date
     C*
     C                     Z-ADDPNDPOP    WW1SDT
     C*
     C** If retrieved date is zero set workfield to *hival
     C*
B3   C           PNDPCL    IFEQ *ZEROS
     C                     Z-ADD*HIVAL    WW1MDT
X3   C                     ELSE
     C                     Z-ADDPNDPCL    WW1MDT
E3   C                     END
     C*
     C** check collateral number is not already used to cover
     C** another account/loan/facility/portfolio
     C*
     C                     MOVE *BLANKS   WWEREF
     C                     MOVE DD3TSP    WWEREF
     C                     MOVE 'X'       WWETYP
     C*
     C                     EXSR #ZC
     C*
     C** If error
     C*
B3   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN74
     C                     MOVEL'LBM0147' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAF  - Validate type specific input            *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEA                                    *
     C**                                                              *
     C*****************************************************************
     C           #DEAF     BEGSR
     C*
     C** If Type = 'A' ,  Given By Customer must be blank
     C*
B1   C           DD3TYP    IFEQ 'A'
     C*
B2   C           DD3SSB    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0153' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If Type = 'G','C','S','P' or 'X' Given By Customer must not be blank
     C*
B1   C***********DD3TYP    IFEQ 'G'                                       001280
     C***********DD3TYP    OREQ 'C'                                       001280
     C***********DD3TYP    OREQ 'S'                                       001280
     C***********DD3TYP    OREQ 'P'                                       001280
     C           DD3TYP    IFEQ 'P'
     C           DD3TYP    OREQ 'X'
     C*
B2   C           DD3SSB    IFEQ *BLANKS
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0183' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If Type = 'C','G' or 'S' ,  Amount must be entered
     C*
B1   C           DD3TYP    IFEQ 'C'
     C           DD3TYP    OREQ 'S'
     C           DD3TYP    OREQ 'G'
     C*
B2   C           DD3AMT    IFEQ *BLANKS
     C*
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0154' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
X1   C                     ELSE
     C*
B2   C           DD3AMT    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0155' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If Type <> 'C' or 'G' ,  Percentage must be blank
     C*
B1   C           DD3TYP    IFNE 'C'
     C           DD3TYP    ANDNE'G'
     C*
B2   C           DD3GPE    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN77
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0188' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If Type = 'C', Borrowing power must be entered
     C*
B1   C           DD3TYP    IFEQ 'C'
     C*
B2   C           DD3OLB    IFEQ *BLANKS
     C*
     C                     MOVE '1'       *IN79
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0184' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
X1   C                     ELSE
     C*
     C** If Type = 'G' ,  Either amount & %age or amount & borrowing power
     C** must be entered
     C*
B2   C           DD3TYP    IFNE 'G'
     C*
B3   C           DD3OLB    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN79
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0185' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
X2   C                     ELSE
     C*
B3   C           DD3GPE    IFEQ *BLANKS
     C           DD3OLB    ANDEQ*BLANKS
     C*
     C                     MOVE '1'       *IN77
     C                     MOVE '1'       *IN79
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0191' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
B3   C           DD3GPE    IFNE *BLANKS
     C           DD3OLB    ANDNE*BLANKS
     C*
     C                     MOVE '1'       *IN77
     C                     MOVE '1'       *IN79
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0192' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If Type = 'S' ,  Security Reference must be entered
     C*
B1   C           DD3TYP    IFEQ 'S'
     C*
B2   C           DD3SEN    IFEQ *BLANKS
     C*
     C                     MOVE '1'       *IN80
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0156' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
X1   C                     ELSE
     C*
B2   C           DD3SEN    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN80
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0157' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If Type = 'A' ,  Account Number must be entered
     C*
B1   C           DD3TYP    IFEQ 'A'
     C*
B2   C           DD3ACN    IFEQ *BLANKS
     C           DD3IBH    OREQ *BLANKS                                   087628
     C           BGMBIN    ANDEQ'Y'                                       087628
     C*
     C                     MOVE '1'       *IN82
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0158' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
X1   C                     ELSE
     C*
B2   C           DD3ACN    IFNE *BLANKS
     C           DD3IBH    ANDNE*BLANKS                                   087628
     C*
     C                     MOVE '1'       *IN82
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0159' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If Portfolio Management is installed
     C*
B1   C           BGPFMG    IFEQ 'Y'
B1   C           BGN4ST    OREQ 'Y'                                       CPB001
     C*
     C** If Type = 'X' or 'S',  Portfolio Reference must be entered
     C*
B2   C           DD3TYP    IFEQ 'X'
     C           DD3TYP    OREQ 'S'
     C*
B3   C           DD3TFR    IFEQ *BLANKS
     C*
     C                     MOVE '1'       *IN81
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0160' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
X2   C                     ELSE
     C*
B3   C           DD3TFR    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN81
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0161' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C********************************************************************S01498
     C***If*Fiduciary*Deposits*is*installed*******************************S01498
     C********************************************************************S01498
B1   C***********BGFLND    IFEQ 'Y'                                       S01498
     C********************************************************************S01498
     C***If*Type*<>*'T'*,**Fiduciary*Deposit*Number*and*Customer**********S01498
     C*********************Code*must*be*blank*****************************S01498
     C********************************************************************S01498
B2   C***********DD3TYP    IFNE 'T'                                       S01498
     C********************************************************************S01498
B3   C***********DD3FDN    IFNE *BLANKS                                   S01498
     C***********DD3FCC    ORNE *BLANKS                                   S01498
     C********************************************************************S01498
     C***********          MOVEA'11'      *IN,85           ON 85-86       S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0162' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
E3   C***********          END                                            S01498
     C********************************************************************S01498
E2   C***********          END                                            S01498
     C********************************************************************S01498
E1   C***********          END                                            S01498
     C*
     C** If Type <> 'D' ,  Deal Number and Customer
     C**                   Code must be blank
     C*
B1   C           DD3TYP    IFNE 'D'
     C*
B2   C           DD3DNO    IFNE *BLANKS
     C           DD3DCC    ORNE *BLANKS
     C*
     C                     MOVEA'11'      *IN,83           ON 83-84
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0163' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
B1   C           DD3TYP    IFNE 'P'
     C*
     C** If Type <> 'P' ,  Pledge Amount and Percentage
     C**                   must be blank
     C*
B2   C           DD3LED    IFNE *BLANKS
     C           DD3LEP    ORNE *BLANKS
     C*
     C                     MOVEA'111'     *IN,87           ON 87-89
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0164' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C** If Portfolio Management is installed
     C*
B3   C           BGPFMG    IFEQ 'Y'
B3   C           BGN4ST    OREQ 'Y'                                       CPB001
     C*
     C** If Type <> 'P' ,  Pledge Portfolio Reference
     C**                   must be blank
     C*
B4   C           DD3ORP    IFNE *BLANKS
     C*
     C                     MOVEA'111'     *IN,87           ON 87-89
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0164' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAG - Validate percentage & order number       *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAG     BEGSR
     C*
     C** Validate Percentage - if entered
     C*
B1   C           DD3GPE    IFNE *BLANKS
     C*
     C** Execute ZALIGN to check if numeric
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3GPE    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check correct range
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DD3GPE
     C*
B3   C           DD3GPE    IFLE '0'
     C           DD3GPE    ORGT '100'
     C*
     C                     MOVE '1'       *IN77
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0165' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
X2   C                     ELSE
     C*
     C                     MOVE '1'       *IN77
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0165' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
     C** Else not entered
     C*
X1   C                     ELSE
     C*
     C** If type = 'C' or type = 'G' & borrowing power blank - default % to 100
     C*
B2   C           DD3TYP    IFEQ 'C'
     C           DD3TYP    OREQ 'G'
     C           DD3OLB    ANDEQ*BLANKS
     C*
     C                     MOVE '100'     DD3GPE
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAH - Validate security reference and          *
     C**                     portfolio security reference             *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAH     BEGSR
     C*
     C** Only validate security reference if type = 'S'
     C*
B1   C           DD3TYP    IFEQ 'S'
     C*
     C** Access securities file - SECTY
     C*
     C           DD3SEN    CHAINSECTY                42
     C*
     C** If record not found or deleted
     C*
B2   C           *IN42     IFEQ '1'
     C           RECI      ORNE 'D'
     C*
     C                     MOVE '1'       *IN80
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0019' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Record found
     C*
X2   C                     ELSE
     C*
     C** retrieve start date & maturity date
     C*
     C                     Z-ADDSEITLD    WW2SDT
     C*
     C** If retrieved date is zero set workfield to *hival
     C*
B3   C           SEMATY    IFEQ *ZEROS
     C                     Z-ADD*HIVAL    WW2MDT
X3   C                     ELSE
     C                     Z-ADDSEMATY    WW2MDT
E3   C                     END
     C*
     C** Access investment types file to get processing type
     C*
     C           WWITK1    CHAININVTPC               47
     C*
     C** If record not found or deleted
     C*
B3   C           *IN47     IFEQ '1'
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD13        DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'INVTPC  'DBFILE          * DBERROR  013 *S01498
     C                     MOVE 'INVTPC  'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     MOVELWWITDS    DBKEY            ****************
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C** Else record found
     C*
X3   C                     ELSE
     C*
     C** If nominal decimal places from SECTY = 4
     C*
B4   C           SENMDP    IFEQ 4
     C*
     C** If processing type not = 7 (UNIT TRUST)
     C*
B5   C           PROT      IFNE '7'
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD14        DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'INVTPC  'DBFILE           * DBERROR  014 *
     C                     MOVE 'INVTPC  'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     MOVELWWITDS    DBKEY            ****************
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** Only validate portfolio reference
     C** field if portfolio management is installed
     C*
B2   C           BGPFMG    IFEQ 'Y'
B2   C           BGN4ST    OREQ 'Y'                                       CPB001
     C*
     C** Only validate portfolio reference if type = 'S' or 'X'
     C*
B3   C           DD3TYP    IFEQ 'S'
     C           DD3TYP    OREQ 'X'
     C*
     C** Access portfolio details file - PMPORTXX
     C*
     C           KPMPXX    CHAINPMPORTXX             46
     C*
     C** If not found or deleted
     C*
B4   C           *IN46     IFEQ '1'
     C           PNRECI    OREQ '*'
     C*
     C                     MOVE '1'       *IN81
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0113' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else record found
     C*
X4   C                     ELSE
     C*
     C** If type = 'S'
     C*
B5   C           DD3TYP    IFEQ 'S'
     C*
     C** If retrieved start date > previous start date
     C*
B6   C           PNDPOP    IFGT WW2SDT
     C                     Z-ADDPNDPOP    WW2SDT
E6   C                     END
     C*
     C** If retrieved maturity date <> zero and < previous maturity date
     C*
B6   C           PNDPCL    IFNE *ZEROS
     C           PNDPCL    ANDLTWW2MDT
     C                     Z-ADDPNDPCL    WW2MDT
E6   C                     END
     C*
     C** Type <> 'S' => Type must be 'X'
     C*
X5   C                     ELSE
     C*
     C** Use retrieved start date & maturity date
     C*
     C                     Z-ADDPNDPOP    WW2SDT
     C*
     C** If retrieved date is zero set workfield to *hival
     C*
B6   C           PNDPCL    IFEQ *ZEROS
     C                     Z-ADD*HIVAL    WW2MDT
X6   C                     ELSE
     C                     Z-ADDPNDPCL    WW2MDT
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
     C** If valid so far
     C*
B4   C           *IN99     IFEQ '0'
     C*
     C** If type = 'S'
     C*
B5   C           DD3TYP    IFEQ 'S'
     C*
     C** Access portfolio positions file - PMCPOSLL
     C*
     C           KL5       CHAINPMCPOSLL             42
     C*
     C** If not found or deleted ( NB. File omits deleted records )
     C*
B6   C           *IN42     IFEQ '1'
     C*
     C                     MOVEA'11'      *IN,80           ON 80-81
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0113' ZAMSID
     C                     EXSR ZASNMS
     C*
E6   C                     END
     C*
     C** Type <> 'S' => Type must be 'X'
     C*
X5   C                     ELSE
     C*
     C***Access*accounts*master*file*-*ACCNTPT****************************S01498
     C** Access accounts master file - PMACCNL1                           S01498
     C*
     C***********KACCPT    SETLLACCNTPT                                   S01498
     C***********KACCPT    READEACCNTPT                  46               S01498
     C           KACCPT    SETLLPMACCNL1                                  S01498
     C           KACCPT    READEPMACCNL1                 46               S01498
     C*
     C** Dowhile records exist for this Given By Cust/Portfolio Ref.
     C**         and valid
     C*
B6   C           *IN46     DOWEQ'0'
     C           *IN99     ANDEQ'0'
     C*
     C** Retrieve account number
     C*
     C**********           Z-ADDCNUM      WKCNUM                                              CSD027
     C                     MOVE CNUM      WKCNUM                                              CSD027
     C                     MOVE CCY       WKCCY
     C                     Z-ADDACOD      WKACOD
     C                     Z-ADDACSQ      WKACSQ
     C                     MOVE KACNT     WKIREF
     C                     MOVE 'A'       WKITYP
     C                     MOVE BRCA      WKBRCA                          087628
     C                     MOVE BRCA      WKIBCH                          087628
     C*
     C** Access pledges file to see if already used as a guarantee
     C*
     C           KPLEGN    CHAINLBPLEGLN             47
     C*
     C** If record found - error
     C*
B7   C           *IN47     IFEQ '0'
     C*
     C                     MOVE '1'       *IN81
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0182' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else record not found - read next record
     C*
X7   C                     ELSE
     C*
     C***********KACCPT    READEACCNTPT                  46               S01498
     C           KACCPT    READEPMACCNL1                 46               S01498
     C*
E7   C                     END
     C*
E6   C                     END
     C*
     C** Access portfolio positions file - PMCPOSLL
     C*
     C           KACCPT    SETLLPMCPOSLL
     C           KACCPT    READEPMCPOSLL                 46
     C*
     C** Dowhile records exist for this Given By Cust/Portfolio Ref.
     C**         and valid
     C*
B6   C           *IN46     DOWEQ'0'
     C           *IN99     ANDEQ'0'
     C*
     C                     MOVE '1'       *IN49
     C*
     C** Retrieve shortname
     C*
     C                     MOVE QATDSS    WKIREF
     C                     MOVE 'S'       WKITYP
     C*
     C** Access pledges file to see if already used as a guarantee
     C*
     C           KPLEGN    CHAINLBPLEGLN             47
     C*
     C** If record found - error
     C*
B7   C           *IN47     IFEQ '0'
     C*
     C                     MOVE '1'       *IN81
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0182' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else record not found - read next record
     C*
X7   C                     ELSE
     C*
     C           KACCPT    READEPMCPOSLL                 46
     C*
E7   C                     END
     C*
     C** If no records found on PMCPOSLL - error
     C*
B7   C           *IN49     IFEQ '0'
     C*
     C                     MOVE '1'       *IN81
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0113' ZAMSID
     C                     EXSR ZASNMS
     C*
E7   C                     END
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** Set workfields for file update - if valid
     C*
B1   C           *IN99     IFEQ '0'
     C*
B2   C           DD3TYP    IFEQ 'S'
     C*
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE 'S'       WWITYP
     C                     MOVELDD3SEN    WWIREF
     C                     MOVE DD3TFR    WWIREF
     C*
E2   C                     END
     C*
B2   C           DD3TYP    IFEQ 'X'
     C*
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE 'X'       WWITYP
     C                     MOVE DD3TFR    WWIREF
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAI - Validate Guarantee,Collateral,Security   *
     C**                     Amount                                   *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAI     BEGSR
     C*
     C** Guarantee / Collateral / Security Amount
     C*
     C                     Z-ADD*ZEROS    WWEAMT
     C                     Z-ADD*ZEROS    WWEOLB
     C                     MOVE *BLANKS   WWNOM
     C*
     C** If amount entered
     C*
B1   C           DD3AMT    IFNE *BLANKS
     C*
     C** If type not = 'S'
     C*
B2   C           DD3TYP    IFNE 'S'
     C*
     C                     Z-ADD*LOVAL    WW2SDT
     C                     Z-ADD*HIVAL    WW2MDT
     C*
     C                     Z-ADD13        ZADIG
     C           ZADIG     SUB  A6NBDP    ZADIG
     C                     Z-ADDA6NBDP    ZADEC
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3AMT    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** If not valid
     C*
B3   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0061' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else valid numeric
     C*
X3   C                     ELSE
     C*
     C                     MOVE ZFIELD    WWEAMT 130
     C*
     C** If amount = zeros - error
     C*
B4   C           WWEAMT    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0061' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else amount not = zeros
     C*
X4   C                     ELSE
     C*
     C** Convert amount for output
     C*
     C                     Z-ADDWWEAMT    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3AMT
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** else - Type = 'S'
     C*
X2   C                     ELSE
     C*
     C** Check amount is valid (using nominal dec places from SECTY)
     C*
     C                     Z-ADD11        ZADIG
     C           ZADIG     SUB  SENMDP    ZADIG
     C                     Z-ADDSENMDP    ZADEC
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3AMT    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** If not valid
     C*
B3   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0061' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else valid numeric
     C*
X3   C                     ELSE
     C*
     C                     MOVE ZFIELD    WWEAMT
     C*
     C** If amount = zeros - error
     C*
B4   C           WWEAMT    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0061' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else amount not = zeros
     C*
X4   C                     ELSE
     C*
     C** Convert amount for output
     C*
     C                     Z-ADDWWEAMT    ZFLD15
     C                     Z-ADDSENMDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3AMT
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** Only perform following check if portfolio management is installed
     C*
B3   C           BGPFMG    IFEQ 'Y'
B3   C           BGN4ST    OREQ 'Y'                                       CPB001
     C*
     C** Convert nominal amount for output
     C*
     C                     Z-ADDQANOML    ZFLD15
     C                     Z-ADDSENMDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    WWNOM  14
     C*
     C** If amount > nominal amount - error
     C*
B4   C           DD3AMT    IFGT WWNOM
     C*
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0116' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If valid so far
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** If borrowing power entered
     C*
B2   C           DD3OLB    IFNE *BLANKS
     C*
     C** Check borrowing power is numeric
     C*
     C                     Z-ADD13        ZADIG
     C           ZADIG     SUB  A6NBDP    ZADIG
     C                     Z-ADDA6NBDP    ZADEC
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3OLB    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** If not numeric
     C*
B3   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN79
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0115' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else - numeric
     C*
X3   C                     ELSE
     C*
     C                     MOVE ZFIELD    WWEOLB 130
     C*
     C** If borrowing power = zeros - error
     C*
B4   C           WWEOLB    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN79
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0115' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* else - not = zeros
     C*
X4   C                     ELSE
     C*
     C** Convert for output
     C*
     C                     Z-ADDWWEOLB    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3OLB
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** If valid so far
     C*
B3   C           *IN99     IFEQ '0'
     C*
     C** Borrowing power must be <= amount
     C*
B4   C           DD3OLB    IFGT DD3AMT
     C*
     C                     MOVE '1'       *IN79
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0117' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
X2   C                     ELSE
     C*
     C** If type = 'G', set borrowing power equal to amount * %age
     C*
B3   C           DD3TYP    IFEQ 'G'
     C*
     C           WWEAMT    MULT WW3GPE    WWTEMP 150
     C           WWTEMP    DIV  100       WWEOLB    H
     C*
     C** Convert for output
     C*
     C*                    Z-ADDWWEOLB    ZFLD15                          LB0000
     C*                    Z-ADDA6DANB    ZDECS                           LB0000
     C*                    MOVE 'L'       ZECODE                          LB0000
     C*                    EXSR ZSEDIT                                    LB0000
     C*                    MOVE ZOUT21    WWAL15 15                       LB0000
     C*                    MOVELWWAL15    DD3OLB                          LB0000
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Set workfields for file update - if valid
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C** If type = 'C' or 'G'
     C*
B3   C           DD3TYP    IFEQ 'C'
     C           DD3TYP    OREQ 'G'
     C*
     C                     MOVE DD3TYP    WWITYP
     C                     MOVE *BLANKS   WWIREF
     C                     MOVELWWCON1    WWIREF
     C                     MOVE WWSEQ1    WWIREF
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAJ - Validate Account number                  *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAJ     BEGSR
     C*
     C** If account number entered
     C*
B1   C           DD3ACN    IFNE *BLANKS
     C*
     C                     MOVE DD3ACN    KACNT
     C                     MOVE DD3IBH    WKBRCA                          087628
     C*
     C***Access*account*master*file*-*ACCNABL1                            S01498
     C** Access account master file - LBACCNL1                            S01498
     C*
     C********** KACCNT    CHAINACCNABL1             46                   S01498
     C           KACCNT    CHAINLBACCNL1             46                   S01498
     C*
     C** If record not found or deleted - error
     C*
B2   C           *IN46     IFEQ '1'
     C           RECI      OREQ '*'
     C*
     C                     MOVE '1'       *IN82
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0146' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else record found
     C*
X2   C                     ELSE
     C*
     C** retrieve start date & maturity date
     C*
     C                     Z-ADD*LOVAL    WW2SDT
     C                     Z-ADD*HIVAL    WW2MDT
     C*
     C** check account is not used as a portfolio
     C*
B3   C           PTFR      IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN82
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0168' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Set workfields for file update
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE 'A'       WWITYP
     C                     MOVE DD3ACN    WWIREF
     C                     MOVE DD3IBH    WWIBCH                          087628
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAK - Validate Deal number & Deal              *
     C**                     Customer Code                            *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAK     BEGSR
     C*
     C** Only validate deal fields if type = 'D'
     C*
B1   C           DD3TYP    IFEQ 'D'
     C*
     C** If deal number = blanks
     C*
B2   C           DD3DNO    IFEQ *BLANKS
     C*
     C** If deal cust code not = 'Y' - error
     C*
B3   C           DD3DCC    IFNE 'Y'
     C*
     C                     MOVE '1'       *IN83
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0169' ZAMSID
     C                     EXSR ZASNMS
     C*
X3   C                     ELSE
     C*
     C** Else deal cust code = 'Y'
     C*
     C                     MOVE '0'       *IN49
     C**********           Z-ADDWWCUS2    WKCNUM                                              CSD027
     C                     MOVE WWCUS2    WKCNUM                                              CSD027
     C                     Z-ADD*HIVAL    WW2SDT
     C                     Z-ADD*LOVAL    WW2MDT
     C*
     C** Access all deals for the given by customer
     C*
     C           WKCNUM    SETLLCUSDL
     C           WKCNUM    READECUSDL                    46
     C*
     C** Do while records exist for this customer & valid
     C*
B4   C           *IN46     DOWEQ'0'
     C           *IN99     ANDEQ'0'
     C*
     C** If record not deleted and a time deposit deal
     C*
B5   C           RECI      IFEQ 'D'
     C           DTYP      ANDEQ'TD'
     C*
     C** At least one record found
     C*
     C                     MOVE '1'       *IN49
     C*
     C** Retrieve first covering start date
     C*
B6   C           VDAT      IFLT WW2SDT
     C                     Z-ADDVDAT      WW2SDT
E6   C                     END
     C*
     C** Retrieve last covering maturity date
     C*
B6   C           MDAT      IFGT WW2MDT
     C                     Z-ADDMDAT      WW2MDT
E6   C                     END
     C*
     C** Check deal customer not already used as guarantees
     C*
     C                     MOVE 'D'       WKITYP
     C                     MOVE DLNO      WKIREF
     C*
     C           KPLEGN    CHAINLBPLEGLN             47
     C*
     C** If record found - error
     C*
B6   C           *IN47     IFEQ '0'
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN84
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0170' ZAMSID
     C                     EXSR ZASNMS
     C*
E6   C                     END
     C*
E5   C                     END
     C*
     C** Read next record for this customer
     C*
     C           WKCNUM    READECUSDL                    46
     C*
E4   C                     END
     C*
     C** If no records found on CUSDL - error
     C*
B4   C           *IN49     IFEQ '0'
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN84
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0171' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** Else deal number not = blanks
     C*
X2   C                     ELSE
     C*
     C** If deal customer code = 'Y' - error
     C*
B3   C           DD3DCC    IFEQ 'Y'
     C*
     C                     MOVE '1'       *IN84
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0172' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else deal customer code not = 'Y'
     C*
X3   C                     ELSE
     C*
     C** Check if numeric
     C*
     C                     MOVE DD3DNO    WWNUM7  70
     C                     MOVE WWNUM7    WWALF6  6
     C*
     C** If not valid numeric - error
     C*
B4   C           DD3DNO    IFNE WWALF6
     C*
     C                     MOVE '1'       *IN80
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0173' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else valid numeric
     C*
X4   C                     ELSE
     C*
     C** Access deals file - DEALS
     C*
     C                     MOVE DD3DNO    WWDENR
     C*
     C           WWDENR    CHAINDEALS                46
     C*
     C** If record not found or deleted
     C*
B5   C           *IN46     IFEQ '1'
     C           RECI      ORNE 'D'
     C*
     C                     MOVE '1'       *IN83
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0173' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else record found
     C*
X5   C                     ELSE
     C*
     C** If deal type <> 'TD' - Time deposit deal
     C*
B6   C           DTYP      IFNE 'TD'
     C*
     C                     MOVE '1'       *IN83
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0187' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** Else time deposit deal
     C*
X6   C                     ELSE
     C*
     C** Check deal customer not already used as guarantees
     C*
     C                     MOVE 'E'       WKITYP
     C                     MOVE CNUM      WKIREF
     C                     Z-ADDVDAT      WW2SDT
     C*
     C** If retrieved date is zero set workfield to *hival
     C*
B7   C           MDAT      IFEQ *ZEROS
     C                     Z-ADD*HIVAL    WW2MDT
X7   C                     ELSE
     C                     Z-ADDMDAT      WW2MDT
E7   C                     END
     C*
     C           KPLEGN    CHAINLBPLEGLN             47
     C*
     C** If record found - error
     C*
B7   C           *IN47     IFEQ '0'
     C*
     C                     MOVE '1'       *IN83
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0170' ZAMSID
     C                     EXSR ZASNMS
     C*
E7   C                     END
     C*
E6   C                     END
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** If deal customer code not = 'Y' or 'N' - error
     C*
B2   C           DD3DCC    IFNE 'Y'
     C           DD3DCC    ANDNE'N'
     C*
     C                     MOVE '1'       *IN84
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0174' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
     C** If deal customer code = 'Y'
     C*
B2   C           DD3DCC    IFEQ 'Y'
     C*
     C** Given By Customer must not be blank
     C*
B3   C           DD3SSB    IFEQ *BLANKS
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0183' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Set workfields for file update - if valid
     C*
B2   C           *IN99     IFEQ '0'
     C*
B3   C           DD3DCC    IFEQ 'Y'
     C*
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE 'E'       WWITYP
     C                     MOVE WWCUS2    WWIREF
     C*
X3   C                     ELSE
     C*
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE 'D'       WWITYP
     C                     MOVE WWDENR    WWIREF
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************S01498
     C********************************************************************S01498
     C****SUBROUTINE*#DEAL*-*Validate*Fiduciary*Deposit*Number*&**********S01498
     C***********************Customer*Code********************************S01498
     C********************************************************************S01498
     C****CALLS************-*NONE*****************************************S01498
     C********************************************************************S01498
     C****CALLED*BY********-*#DEA*****************************************S01498
     C********************************************************************S01498
     C********************************************************************S01498
     C***********#DEAL     BEGSR                                          S01498
     C********************************************************************S01498
     C***Only*validate*if*type*=*'T'*and*fiduciary*deposits*is*installed**S01498
     C********************************************************************S01498
B1   C***********DD3TYP    IFEQ 'T'                                       S01498
     C***********BGFLND    ANDEQ'Y'                                       S01498
     C********************************************************************S01498
     C***If*fiduciary*deposit*number*=*blanks*****************************S01498
     C********************************************************************S01498
B2   C***********DD3FDN    IFEQ *BLANKS                                   S01498
     C********************************************************************S01498
     C***If*fiduciary*cust*code*not*=*'Y'*-*error*************************S01498
     C********************************************************************S01498
B3   C***********DD3FCC    IFNE 'Y'                                       S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN85                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0175' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
X3   C***********          ELSE                                           S01498
     C********************************************************************S01498
     C***Else*fiduciary*cust*code*=*'Y'***********************************S01498
     C********************************************************************S01498
     C***********          MOVE '0'       *IN49                           S01498
     C***********          Z-ADDWWCUS2    WKCNUM                          S01498
     C***********          Z-ADD*HIVAL    WW2SDT                          S01498
     C***********          Z-ADD*LOVAL    WW2MDT                          S01498
     C********************************************************************S01498
     C***Access*all*fiduciary*deposits*for*the*given*by*customer**********S01498
     C********************************************************************S01498
     C***********WKCNUM    SETLLFIDEPOL1                                  S01498
     C***********WKCNUM    READEFIDEPOL1                 46               S01498
     C********************************************************************S01498
     C***Do*while*records*exist*for*this*customer*&*valid*****************S01498
     C********************************************************************S01498
B4   C************IN46     DOWEQ'0'                                       S01498
     C************IN99     ANDEQ'0'                                       S01498
     C********************************************************************S01498
     C***If*a*time*deposit************************************************S01498
     C********************************************************************S01498
B5   C***********FDDEDT    IFEQ 'TD'                                      S01498
     C********************************************************************S01498
     C***At*least*one*record*found****************************************S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN49                           S01498
     C********************************************************************S01498
     C***Retrieve*first*covering*start*date*******************************S01498
     C********************************************************************S01498
B6   C***********FDVDAT    IFLT WW2SDT                                    S01498
     C***********          Z-ADDFDVDAT    WW2SDT                          S01498
E6   C***********          END                                            S01498
     C********************************************************************S01498
     C***Retrieve*last*covering*maturity*date*****************************S01498
     C********************************************************************S01498
B6   C***********FDMDAT    IFGT WW2MDT                                    S01498
     C***********          Z-ADDFDMDAT    WW2MDT                          S01498
E6   C***********          END                                            S01498
     C********************************************************************S01498
     C***Check*fiduciary*customer*not*already*used*as*guarantees**********S01498
     C********************************************************************S01498
     C***********          MOVE 'T'       WKITYP                          S01498
     C***********          MOVE FDDENR    WKIREF                          S01498
     C********************************************************************S01498
     C***********KPLEGN    CHAINLBPLEGLN             47                   S01498
     C********************************************************************S01498
     C***If*record*found*-*error******************************************S01498
     C********************************************************************S01498
B6   C************IN47     IFEQ '0'                                       S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN63                           S01498
     C***********          MOVE '1'       *IN85                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0176' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
E6   C***********          END                                            S01498
     C********************************************************************S01498
E5   C***********          END                                            S01498
     C********************************************************************S01498
     C***Read*next*record*for*this*customer*******************************S01498
     C********************************************************************S01498
     C***********WKCNUM    READEFIDEPOL1                 46               S01498
     C********************************************************************S01498
E4   C***********          END                                            S01498
     C********************************************************************S01498
     C***If*no*records*found*on*FIDEPOL1*-*error**************************S01498
     C********************************************************************S01498
B4   C************IN49     IFEQ '0'                                       S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN63                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0177' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
E4   C***********          END                                            S01498
     C********************************************************************S01498
E3   C***********          END                                            S01498
     C********************************************************************S01498
     C***Else*fiduciary*deposit*number*not*=*blanks***********************S01498
     C********************************************************************S01498
X2   C***********          ELSE                                           S01498
     C********************************************************************S01498
     C***If*fiduciary*customer*code*=*'Y'*-*error*************************S01498
     C********************************************************************S01498
B3   C***********DD3FCC    IFEQ 'Y'                                       S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN86                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0178' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
     C***Else*fiduciary*customer*code*not*=*'Y'***************************S01498
     C********************************************************************S01498
X3   C***********          ELSE                                           S01498
     C********************************************************************S01498
     C***Check*if*numeric*************************************************S01498
     C********************************************************************S01498
     C***********          MOVE DD3FDN    WWNUM7  70                      S01498
     C***********          MOVE WWNUM7    WWALF6  6                       S01498
     C********************************************************************S01498
     C***If*not*valid*numeric*-*error*************************************S01498
     C********************************************************************S01498
B4   C***********DD3FDN    IFNE WWALF6                                    S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN85                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0179' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
     C***Else*valid*numeric***********************************************S01498
     C********************************************************************S01498
X4   C***********          ELSE                                           S01498
     C********************************************************************S01498
     C***Access*fiduciary*deposits*file*-*FIDEPOL0************************S01498
     C********************************************************************S01498
     C***********          MOVE DD3FDN    WWDENR                          S01498
     C********************************************************************S01498
     C***********WWDENR    CHAINFIDEPOL0             46                   S01498
     C********************************************************************S01498
     C***If*record*not*found**********************************************S01498
     C********************************************************************S01498
B5   C************IN46     IFEQ '1'                                       S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN85                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0179' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
     C***Else*record*found************************************************S01498
     C********************************************************************S01498
X5   C***********          ELSE                                           S01498
     C********************************************************************S01498
     C***If*deal*type*<>*'TD'*-*Time*deposit******************************S01498
     C********************************************************************S01498
B6   C***********FDDEDT    IFNE 'TD'                                      S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN85                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0187' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
     C***else*time*deposit************************************************S01498
     C********************************************************************S01498
X6   C***********          ELSE                                           S01498
     C********************************************************************S01498
     C***Check*fiduciary*customer*not*already*used*as*guarantees**********S01498
     C********************************************************************S01498
     C***********          MOVE 'U'       WKITYP                          S01498
     C***********          MOVE FDCNUM    WKIREF                          S01498
     C***********          Z-ADDFDVDAT    WW2SDT                          S01498
     C********************************************************************S01498
     C***If*retrieved*date*is*zero*set*workfield*to**hival****************S01498
     C********************************************************************S01498
B7   C***********FDMDAT    IFEQ *ZEROS                                    S01498
     C***********          Z-ADD*HIVAL    WW2MDT                          S01498
X7   C***********          ELSE                                           S01498
     C***********          Z-ADDFDMDAT    WW2MDT                          S01498
E7   C***********          END                                            S01498
     C********************************************************************S01498
     C***********KPLEGN    CHAINLBPLEGLN             47                   S01498
     C********************************************************************S01498
     C***If*record*found*-*error******************************************S01498
     C********************************************************************S01498
B7   C************IN47     IFEQ '0'                                       S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN85                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0176' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
E7   C***********          END                                            S01498
     C********************************************************************S01498
E6   C***********          END                                            S01498
     C********************************************************************S01498
E5   C***********          END                                            S01498
     C********************************************************************S01498
E4   C***********          END                                            S01498
     C********************************************************************S01498
E3   C***********          END                                            S01498
     C********************************************************************S01498
E2   C***********          END                                            S01498
     C********************************************************************S01498
     C***If*fiduciary*customer*code*not*=*'Y'*or*'N'*-*error**************S01498
     C********************************************************************S01498
B2   C***********DD3FCC    IFNE 'Y'                                       S01498
     C***********DD3FCC    ANDNE'N'                                       S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN86                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0180' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
E2   C***********          END                                            S01498
     C********************************************************************S01498
     C***If*fiduciary*customer*code**=*'Y'********************************S01498
     C********************************************************************S01498
B2   C***********DD3FCC    IFEQ 'Y'                                       S01498
     C********************************************************************S01498
     C***Given*By*Customer*must*not*be*blank******************************S01498
     C********************************************************************S01498
B3   C***********DD3SSB    IFEQ *BLANKS                                   S01498
     C********************************************************************S01498
     C***********          MOVE '1'       *IN63                           S01498
     C***********          MOVE '1'       *IN99                           S01498
     C***********          MOVEL'LBM0183' ZAMSID                          S01498
     C***********          EXSR ZASNMS                                    S01498
     C********************************************************************S01498
E3   C***********          END                                            S01498
     C********************************************************************S01498
E2   C***********          END                                            S01498
     C********************************************************************S01498
     C***Set*workfields*for*file*update***********************************S01498
     C********************************************************************S01498
B2   C************IN99     IFEQ '0'                                       S01498
     C********************************************************************S01498
B3   C***********DD3FCC    IFEQ 'Y'                                       S01498
     C********************************************************************S01498
     C***********          MOVE *BLANKS   WWIREF                          S01498
     C***********          MOVE 'U'       WWITYP                          S01498
     C***********          MOVE WWCUS2    WWIREF                          S01498
     C********************************************************************S01498
X3   C***********          ELSE                                           S01498
     C********************************************************************S01498
     C***********          MOVE *BLANKS   WWIREF                          S01498
     C***********          MOVE 'T'       WWITYP                          S01498
     C***********          MOVE WWDENR    WWIREF                          S01498
     C********************************************************************S01498
E3   C***********          END                                            S01498
     C********************************************************************S01498
E2   C***********          END                                            S01498
     C********************************************************************S01498
E1   C***********          END                                            S01498
     C********************************************************************S01498
     C***********          ENDSR                                          S01498
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAM - Validate pledge fields ie amount,        *
     C**                     percentage and portfolio                 *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAM     BEGSR
     C*
     C                     Z-ADD*ZEROS    WWPGED
     C                     Z-ADD*ZEROS    WWPLEP
     C                     Z-ADD*ZEROS    WWAVAL
     C*
     C** Only validate fields when Type = 'P' ( Pledge )
     C*
B1   C           DD3TYP    IFEQ 'P'
     C*
B2   C           DD3ODE    IFEQ 'FXD'
     C           DD3ODE    OREQ 'LMT'
     C*
B3   C           DD3LED    IFEQ *BLANKS
     C           DD3LEP    ORNE *BLANKS
     C           DD3ORP    ORNE *BLANKS
     C*
     C                     MOVEA'111'     *IN,87           ON 87-89
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0118' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
B2   C           DD3ODE    IFEQ 'GEN'
     C*
B3   C           DD3LED    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN87
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0118' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C** If pledge amount entered
     C*
B3   C           DD3LED    IFNE *BLANKS
     C*
     C** Check if numeric
     C*
     C                     Z-ADD13        ZADIG
     C           ZADIG     SUB  A6NBDP    ZADIG
     C                     Z-ADDA6NBDP    ZADEC
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3LED    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** If not valid
     C*
B4   C           *IN99     IFEQ '1'
     C*
     C                     MOVE '1'       *IN87
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0061' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else - valid numeric
     C*
X4   C                     ELSE
     C*
     C                     MOVE ZFIELD    WWPGED 130
     C*
     C** If amount = zeros - error
     C*
B5   C           WWPGED    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN87
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0061' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* Else amount not = zeros
     C*
X5   C                     ELSE
     C*
     C** Convert amount for output
     C*
     C                     Z-ADDWWPGED    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWAL15 15
     C                     MOVELWWAL15    DD3LED
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** If valid so far
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C** Pledge Percentage
     C*
B3   C           DD3LEP    IFNE *BLANKS
     C*
     C** Check percentage is numeric
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3LEP    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** Valid numeric : check percentage in correct range
     C*
B4   C           *IN99     IFEQ '0'
     C*                                                                   LB0000
     C                     MOVE ZFIELD    DD3LEP                          LB0000
     C*
B5   C           DD3LEP    IFLT '001'
     C           DD3LEP    ORGT '100'
     C*
     C                     MOVE '1'       *IN88
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0165' ZAMSID
     C                     EXSR ZASNMS
     C*
X5   C                     ELSE
     C*
     C                     MOVE DD3LEP    WWPLEP
     C*
E5   C                     END
     C*
     C** Else not valid percentage
     C*
X4   C                     ELSE
     C*
     C                     MOVE '1'       *IN88
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0165' ZAMSID
     C                     EXSR ZASNMS
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Only validate reference if portfolio management installed
     C*
B2   C           BGPFMG    IFEQ 'Y'
B2   C           BGN4ST    OREQ 'Y'                                       CPB001
     C*
     C** Portfolio pledged
     C*
B3   C           DD3ORP    IFNE *BLANKS
     C*
     C           KL6       CHAINPMPORTXX             42
     C*
     C** If record not found or deleted
     C*
B4   C           *IN42     IFEQ '1'
     C           PNRECI    OREQ '*'
     C*
     C                     MOVE '1'       *IN89
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0114' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else record found
     C*
X4   C                     ELSE
     C*
     C                     Z-ADDPNTNLU    WWTNLP
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Set workfields for file update - if valid
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     MOVE *BLANKS   WWIREF
     C                     MOVE DD3TYP    WWITYP
     C                     MOVELWWCON1    WWIREF
     C                     MOVE WWSEQ1    WWIREF
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAN - Check Start Date and Maturity Dete are   *
     C**                     in the correct range                     *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAN     BEGSR
     C*
     C** If type not = 'P' - Pledge
     C*
B1   C           DD3TYP    IFNE 'P'
     C           WWUTSB    ANDEQ'Y'                                       080106
     C*
     C** If Start date entered < Start date of the COVERED instrument
     C*
B2   C           WWETTD    IFLT WW1SDT
     C*
     C                     MOVE '1'       *IN67
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0148' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C** If Start date entered < Start date of the COVERING instrument
     C*
B3   C           WWETTD    IFLT WW2SDT
     C*
     C                     MOVE '1'       *IN67
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0149' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** If Maturity date entered > Maturity date of the COVERED instrument
     C*
B2   C           WWEATD    IFGT WW1MDT
     C*
     C                     MOVE '1'       *IN68
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0150' ZAMSID
     C                     EXSR ZASNMS
     C*
X2   C                     ELSE
     C*
     C** If Maturity date entered > Maturity date of the COVERING instrument
     C*
B3   C           WWEATD    IFGT WW2MDT
     C*
     C                     MOVE '1'       *IN68
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0151' ZAMSID
     C                     EXSR ZASNMS
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEAO - Validate order number                    *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEAO     BEGSR
     C*
     C                     Z-ADD*ZEROS    WWORDN
     C*
     C** If Order No. not entered
     C*
B1   C           DD3ORN    IFEQ *BLANKS
     C*
     C** If action = insert
     C*
B2   C           DDACT3    IFEQ 'I'
     C*
     C** Get next available order no
     C*
     C                     MOVE *HIVAL    WKORDN
     C                     MOVE WWIREF    WKIREF
     C                     MOVE WWITYP    WKITYP
     C                     MOVE WWIBCH    WKIBCH                          087628
     C           KPLGN2    SETGTLBPLEGLN
     C                     READPLBPLEGLN                 47
     C*
     C** If BOF file reached or different reference/type
     C*
B3   C           *IN47     IFEQ '1'
     C           WKIREF    ORNE PGIREF
     C           WKITYP    ORNE PGITYP
     C           WKIBCH    ORNE PGIBCH                                    087628
     C*
     C*********************MOVE '010'     DD3ORN                          B7979
     C                     MOVE '001'     DD3ORN                          B7979
     C*
X3   C                     ELSE
     C*
     C** If no available order number - error
     C*
B4   C***********PGORDN****IFEQ 990                                       B7979
     C*
     C*********************MOVE '1'       *IN78                           B7979
     C*********************MOVE '1'       *IN99                           B7979
     C*********************MOVEL'LBM0190' ZAMSID                          B7979
     C*********************EXSR ZASNMS                                    B7979
     C*
     C** Increment order number
     C*
X4   C*********************ELSE                                           B7979
     C*
     C***********PGORDN****ADD  10        WWORDN                          B7979
     C           PGORDN    ADD  1         WWORDN                          B7979
     C                     MOVE WWORDN    DD3ORN
     C*
E4   C*********************END                                            B7979
     C*
E3   C                     END
     C*
     C** Else must be entered
     C*
X2   C                     ELSE
     C*
     C                     MOVE '1'       *IN78
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0166' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
     C** Else Order No. entered
     C*
X1   C                     ELSE
     C*
     C** Execute ZALIGN to check if numeric
     C*
     C                     Z-ADD*ZEROS    ZADEC
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE '0'       *IN99
     C                     MOVE DD3ORN    ZFIELD
     C*
     C                     EXSR ZALIGN
     C*
     C** If valid numeric
     C*
B2   C           *IN99     IFEQ '0'
     C*
     C                     MOVE ZFIELD    DD3ORN
     C                     MOVE ZFIELD    WWORDN
     C*
     C** If equal to zeros - error
     C*
B3   C           WWORDN    IFEQ *ZEROS
     C*
     C                     MOVE '1'       *IN78
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0166' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** else not = zeros
     C*
X3   C                     ELSE
     C*
     C** if changed from previous value
     C*
B4   C           WWORDN    IFNE WWSORN
     C*
     C** access pledges file to see if already exists
     C*
     C                     MOVE DD3ORN    WKORDN
     C                     MOVE WWIREF    WKIREF
     C                     MOVE WWITYP    WKITYP
     C                     MOVE WWIBCH    WKIBCH                          087628
     C           KPLGN2    CHAINLBPLEGLN             47
     C*
     C** if record found - error
     C*
B5   C           *IN47     IFEQ '0'
     C*
     C                     MOVE '1'       *IN78
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0189' ZAMSID
     C                     EXSR ZASNMS
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*
     C** else not valid numeric - error
     C*
X2   C                     ELSE
     C*
     C                     MOVE '1'       *IN78
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0166' ZAMSID
     C                     EXSR ZASNMS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEB - File updates - insert/amend               *
     C**                                                              *
     C**  CALLS           - #DEBA #DEBB #DEBC #DEBD #DEBE             *
     C**                                                              *
     C**  CALLED BY       - #DE                                       *
     C**                                                              *
     C*****************************************************************
     C           #DEB      BEGSR
     C*
     C* Get TRANSACTION NUMBER for UPDATES
     C*
     C                     EXSR ZTNLU1
     C*
     C                     Z-ADD*ZEROS    PGPLED
     C                     Z-ADD*ZEROS    WWTOT1 152
     C*
     C** If Type = 'P' calculate Pledge Amount
     C*
B1   C           DD3TYP    IFEQ 'P'
     C*
     C                     EXSR #DEBA
     C*
E1   C                     END
     C*
     C** If Type = 'S' calculate collateral and borrowing power
     C*
B1   C           DD3TYP    IFEQ 'S'
     C*
     C                     EXSR #DEBD
     C*
E1   C                     END
     C*
     C***Process*window                                             S01241S01498
     C**********                                                    S01241S01498
     C***Process*window*only*for*non-pledges                        R0746 S01498
B1   C********** DD3TYP    IFNE 'P'                                 R0746 S01498
     C**********                                                    S01241S01498
     C**********           MOVEL'LB0220'  PROG                      S01241S01498
     C**********                                                    S01241S01498
     C**********           MOVE DD3CNU    #1CNUM                    S01241S01498
     C**********           MOVE DD3CON    #1CONB                    S01241S01498
     C**********           MOVE DD3SEQ    #1SEQN                    S01241S01498
     C**********           MOVE DD3TYP    #1TYPE                    S01241S01498
     C**********           MOVE DD3ODE    #1CODE                    S01241S01498
     C**********           MOVE DD3CCY    #1CCY                     S01241S01498
     C**********                                                    S01241S01498
     C**********           MOVE DDACT3    ACTION                    S01241S01498
     C**********                                                    S01241S01498
     C********** BGWDPR    IFEQ 'Y'                                 S01241S01498
     C**********           UNLCKLDA                                 S01241S01498
     C**********           CALL 'WN0010'                            S01241S01498
     C**********           PARM           PROG   10                 S01241S01498
     C**********           PARM *BLANK    KEYWN   2                 S01241S01498
     C**********           PARM           ACTION  1                 S01241S01498
     C**********           PARM           DATA                      S01241S01498
     C**********           PARM *BLANK    RTRN    7                 S01241S01498
     C**********           PARM           SPARE 256                 S01241S01498
     C********** *LOCK     IN   LDA                                 S01241S01498
     C**********           END                                      S01241S01498
     C**********                                                    S01241S01498
E1   C**********           END                                      R0746 S01498
     C**********                                                    R0746 S01498
     C********** RTRN      IFNE *BLANK                              S01241S01498
     C********** RTRN      IFEQ 'USR0790'                                 S01498
     C**********           CALL 'Y2SNMGC'                           S01241S01498
     C**********           PARM 'LB0220'  ZAPGM  10        Program qS01241S01498
     C**********           PARM           ZAPGRL  5        Rel queueS01241S01498
     C**********           PARM 'WND0001' ZAMSID  7        Message IS01241S01498
     C**********           PARM 'MIDAS  ' ZAMSGF 10        Message fS01241S01498
     C**********           PARM           ZAMSDA132        Message dS01241S01498
     C**********           PARM           ZAMSTP  7        Message tS01241S01498
      **Clear*all*fields                                            S01241S01498
     C**********           MOVEL*BLANK    ZAPGM            Program qS01241S01498
     C**********           MOVEL*BLANK    ZAMSID           Message IS01241S01498
     C**********           MOVEL*BLANK    ZAMSGF           Message fS01241S01498
     C**********           MOVEL*BLANK    ZAMSDA           Message dS01241S01498
     C**********           MOVEL*BLANK    ZAMSTP           Message tS01241S01498
      **********                                                    R0552 S01498
     C**********           END                                      R0552 S01498
     C**********                                                    S01241S01498
     C**********           ELSE                                     S01241S01498
     C**********                                                    S01241S01498
     C** If action = 'I' - update files (insert)
     C*
B1   C           DDACT3    IFEQ 'I'
     C*
     C                     EXSR #DEBB
     C*
E1   C                     END
     C*
     C** If action = 'A' - update files (amend)
     C*
B1   C           DDACT3    IFEQ 'A'
     C*
     C                     EXSR #DEBC
     C*
E1   C                     END
     C*
     C** If no errors
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C***If*portfolio*management*installed*update*PMPORTPP****************S01498
     C** If portfolio management installed update PMPORTPD                S01498
     C*
B2   C           BGPFMG    IFEQ 'Y'
B2   C           BGN4ST    OREQ 'Y'                                       CPB001
     C*
     C                     EXSR #DEBE
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If no errors - comit update
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C                     Z-ADD0         SW                              R0065
     C*
     C           CMTTXT    COMIT
     C*
E1   C                     END
     C**********           END                                      S01241S01498
     C******************** END                                      S01241R0552
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBA - Calculate Pledge Amount                  *
     C**                                                              *
     C**  CALLS            - #DEBAA                                   *
     C**                                                              *
     C**  CALLED BY        - #DEB                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEBA     BEGSR
     C*
B1   C           DD3ODE    IFEQ 'FXD'
     C           DD3ODE    OREQ 'LMT'
     C*
     C***********          Z-ADDWWPGED    PGPLED                          LB0000
     C                     Z-ADDWWPGED    WWPAMT                          LB0000
     C*
X1   C                     ELSE
     C*
B2   C           DD3ODE    IFEQ 'GEN'
     C*
     C** If Portfolio Management installed and
     C** pledge portfolio ref. entered
     C*
B3   C           DD3ORP    IFNE *BLANK
     C           BGPFMG    ANDEQ'Y'
     C*
     C***Access*portfolio*totals*file*-*PMPOTTPP**************************S01498
     C** Access portfolio totals file - PMPOTTPD                          S01498
     C*
     C***********KL6       CHAINPMPOTTPP             42                   S01498
     C           KL6       CHAINPMPOTTPD             42                   S01498
     C*
     C** If record not found or deleted
     C*
B4   C           *IN42     IFEQ '1'
     C*          QCRECI    ORNE 'D'                                       B08040
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'PMPOTTPP'DBFILE                          S01498
     C                     MOVE 'PMPOTTPD'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVELKLST6     DBKEY            *             *
     C                     Z-ADD9         DBASE            * DBERROR 009 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
E4   C                     END
     C*
     C***********QCPTPA    SUB  QCPTNA    PGPLED                          LB0000
     C           QCPTPA    SUB  QCPTNA    WWPAMT                          LB0000
     C*
X3   C                     ELSE
     C*
     C** Calculate Available Lending
     C*
     C                     EXSR #DEBAA
     C*
     C***********          Z-ADDWWAVAL    PGPLED                         LB0000
     C                     Z-ADDWWAVAL    WWPAMT                         LB0000
     C*
E3   C                     END
     C*
     C** If pledge percentage entered
     C*
B3   C           DD3LEP    IFNE *BLANKS
     C*
     C***********PGPLED    MULT WWPLEP    WWTOT1                          LB0000
     C***********WWTOT1    DIV  100       PGPLED                          LB0000
     C           WWPAMT    MULT WWPLEP    WWTOT1                          LB0000
     C           WWTOT1    DIV  100       WWPAMT                          LB0000
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBAA - Calculate available lending             *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEBA                                   *
     C**                                                              *
     C*****************************************************************
     C           #DEBAA    BEGSR
     C*
     C** Validate Issuer has sufficient available to pledge amount
     C*
     C                     Z-ADD*ZEROS    WWVAL1 150
     C*
     C** Access LBEXTSL1 to retrieve Lending power , Total exposure
     C** and Total pledges received ( For use in calculation )
     C*
     C           WWCUS2    CHAINLBEXTSL1             42
     C*
B1   C           *IN42     IFEQ '1'
     C           ESRECI    OREQ '*'
     C*
     C                     Z-ADD*ZEROS    WWLPWR
     C                     Z-ADD*ZEROS    WWTPRD
     C                     Z-ADD*ZEROS    WWOWEX
     C*
X1   C                     ELSE
     C*
     C                     Z-ADDESLPWR    WWLPWR 150
     C                     Z-ADDESTPRD    WWTPRD
     C                     Z-ADDESOWEX    WWOWEX 150
     C*
E1   C                     END
     C*
     C** Check pledges calculation on I.C.D record
     C*
B1   C***********LBPLEC    IFEQ 'B'                                       S01498
     C           LBPLDC    IFEQ 'B'                                       S01498
     C*
     C           WWLPWR    SUB  WWOWEX    WWAVAL 130
     C*
E1   C                     END
     C*
B1   C***********LBPLEC    IFEQ 'T'                                       S01498
     C           LBPLDC    IFEQ 'T'                                       S01498
     C*
     C           WWLPWR    ADD  WWTPRD    WWVAL1
     C           WWVAL1    SUB  WWOWEX    WWAVAL
     C*
E1   C                     END
     C*
B1   C***********LBPLEC    IFEQ 'C'                                       S01498
     C           LBPLDC    IFEQ 'C'                                       S01498
     C*
     C** Check pledges calulation on Portfolio Lending record
     C*
B2   C           CUPLEC    IFEQ 'B'
     C*
     C           WWLPWR    SUB  WWOWEX    WWAVAL
     C*
E2   C                     END
     C*
B2   C           CUPLEC    IFEQ 'T'
     C*
     C           WWLPWR    ADD  WWTPRD    WWVAL1
     C           WWVAL1    SUB  WWOWEX    WWAVAL
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBB - Update files (insert)                    *
     C**                                                              *
     C**  CALLS            - #ZB                                      *
     C**                                                              *
     C**  CALLED BY        - #DEB                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEBB     BEGSR
     C*
     C** Set up fields for output
     C*
     C                     EXSR #ZB
     C*
     C** Write new record to pledges file - LBPLEGPD
     C*
     C                     WRITELBPLEGD0               90
     C*
     C** If file error
     C*
B1   C           *IN90     IFEQ '1'
     C*
     C** If duplicate key error
     C*
B2   C           STATUS    IFEQ 01021
     C*
     C                     ROLBK
     C*
     C** Clear messages caused by status error
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0057' ZAMSID
     C                     EXSR ZASNMS
     C*
     C** other file error - dump
     C*
X2   C                     ELSE
     C*
     C                     EXSR *PSSR
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If no file error
     C*
B1   C           *IN99     IFEQ '0'
     C*
     C** Access trailer file
     C*
     C                     MOVE 'LBPLEGPD'WWFILE  8
     C           WWFILE    CHAINLBTRAIPD             42
     C*
     C** If record not found or record-id not = 'T'
     C*
B2   C           *IN42     IFEQ '1'
     C           TRRECI    ORNE 'T'
     C*
     C                     ROLBK
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'LBTRAIPD'DBFILE                          S01498
     C                     MOVE 'LBTRAIPD'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVELWWFILE    DBKEY            *             *
     C                     Z-ADD10        DBASE            * DBERROR 010 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C** else record found
     C*
X2   C                     ELSE
     C*
     C                     ADD  1         TRINS
     C                     ADD  1         TRLIVE
     C                     Z-ADDBJRDNB    TRLCD
     C                     MOVE 'A'       TRCHTP
     C*
     C** Update trailer file - LBTRAIPD
     C*
     C                     UPDATLBTRAID0
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBC - Update files (amend)                     *
     C**                                                              *
     C**  CALLS            - #ZB                                      *
     C**                                                              *
     C**  CALLED BY        - #DEB                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEBC     BEGSR
     C*
     C** Access pledges file using saved RRN
     C*
     C           HHARRN    CHAINLBPLEGPD             44
     C*
     C** If record not found , or TNLU <> saved TNLU
     C*
B1   C           *IN44     IFEQ '1'
     C           PGTNLU    ORNE HHTNLU
     C*
     C                     ROLBK
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0057' ZAMSID
     C                     EXSR ZASNMS
     C*
B2   C           *IN44     IFEQ '0'
     C                     EXCPTLBXXXX
E2   C                     END
     C*
     C** Else record found
     C*
X1   C                     ELSE
     C*
     C** Save last-change-date & type
     C*
     C                     MOVE PGLCD     WWLCD
     C                     MOVE PGCHTP    WWCHTP
     C*
     C** Set up fields for update
     C*
     C                     EXSR #ZB
     C*
     C** Update pledges file - LBPLEGPD
     C*
     C                     UPDATLBPLEGD0
     C*
     C** If record not inserted today
     C*
B2   C           WWLCD     IFNE BJRDNB
     C           WWCHTP    ORNE 'I'
     C*
     C** Access trailer file
     C*
     C                     MOVE 'LBPLEGPD'WWFILE  8
     C           WWFILE    CHAINLBTRAIPD             20
     C*
     C** If record not found or record-id <> 'T'
     C*
B3   C           *IN20     IFEQ '1'
     C           TRRECI    ORNE 'T'
     C*
     C                     ROLBK
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'LBTRAIPD'DBFILE                          S01498
     C                     MOVE 'LBTRAIPD'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVELWWFILE    DBKEY            *             *
     C                     Z-ADD11        DBASE            * DBERROR 011 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C** Else record found
     C*
X3   C                     ELSE
     C*
     C** Update trailer file
     C*
     C** If record not AMENDED today
     C           WWLCD     IFNE BJRDNB
     C           WWCHTP    ORNE 'A'
     C                     ADD  1         TRAMD
     C                     Z-ADDBJRDNB    TRLCD
     C                     MOVE 'A'       TRCHTP
     C                     END
     C*
     C                     UPDATLBTRAID0
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBD  - Calulate Collateral & Borrowing Power   *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEB                                    *
     C**                                                              *
     C*****************************************************************
     C           #DEBD     BEGSR
     C*
     C                     Z-ADD*ZEROS    WWBPPC
     C                     Z-ADD*ZEROS    WWCOLL
     C*
     C** Calculate borrowing power percentage
     C*
     C                     EXSR #DEBDA
     C*
     C** Calculate Collateral
     C*
     C                     EXSR #DEBDB
     C*
     C** Calculate borrowing power
     C** -------------------------
     C*
     C** If borrowing power percentage not = zero
     C*
B1   C           WWBPPC    IFNE *ZEROS
     C*
     C           WWCOLL    MULT WWBPPC    WWTMBP 150
     C           WWTMBP    DIV  100       PGCOLB
     C*
     C** Else assume borrowing power %age to be 100
     C*
X1   C                     ELSE
     C*
     C                     Z-ADDWWCOLL    WWEOLB
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBDA - Calulate Borrowing Power Percentage    *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEBD                                   *
     C**                                                              *
     C*****************************************************************
     C           #DEBDA    BEGSR
     C*
     C** Access Borrowing power file by security reference
     C*
     C           WWBPK4    CHAINLBBPWRL4             47
     C*
     C** Set to security percentage
     C*
B1   C           *IN47     IFEQ '0'
     C           BPSEPC    ANDNE*ZEROS
     C*
     C                     Z-ADDBPSEPC    WWBPPC
     C*
E1   C                     END
     C*
     C** Access Borrowing power file by cust no/security reference
     C*
     C           WWBPK2    CHAINLBBPWRL2             47
     C*
     C** Set to client percentage
     C*
B1   C           *IN47     IFEQ '0'
     C           BPSEPC    ANDNE*ZEROS
     C*
     C                     Z-ADDBPSEPC    WWBPPC
     C*
E1   C                     END
     C*
     C** If no percentage is found
     C*
B1   C           WWBPPC    IFEQ *ZEROS
     C*
     C** Access borrowing power file by instrument type
     C*
     C           WWBPK3    CHAINLBBPWRL3             47
     C*
     C** Set to instrument percentage
     C*
B2   C           *IN47     IFEQ '0'
     C           BPINPC    ANDNE*ZEROS
     C*
     C                     Z-ADDBPINPC    WWBPPC
     C*
E2   C                     END
     C*
     C** Access borrowing power file by cust no/instrument type
     C*
     C           WWBPK1    CHAINLBBPWRL1             47
     C*
     C** Set to client percentage
     C*
B2   C           *IN47     IFEQ '0'
     C           BPINPC    ANDNE*ZEROS
     C*
     C                     Z-ADDBPINPC    WWBPPC
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** Access borrowing power file by country of issued by
     C*
     C           WWBPK5    CHAINLBBPWRL5             47
     C*
     C** Set to country percentage
     C*
B1   C           *IN47     IFEQ '0'
     C           BPCTPC    ANDNE*ZEROS
     C*
     C           WWBPPC    MULT BPCTPC    WWTMPC  50
     C           WWTMPC    DIV  100       WWBPPC
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBDB - Calculate Collateral                    *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEBD                                   *
     C**                                                              *
     C*****************************************************************
     C           #DEBDB    BEGSR
     C*
     C** Calculate Collateral
     C*
B1   C           LBCMNV    IFEQ 'M'
     C*
     C           WWEAMT    MULT SEMKPR    WWCOLL
     C*
X1   C                     ELSE
     C*
B2   C           LBCMNV    IFEQ 'N'
     C*
     C           WWEAMT    MULT SEISSP    WWCOLL
     C*
E2   C                     END
     C*
E1   C                     END
     C*
B1   C           PROT      IFEQ '8'
     C*
     C                     MULT SECFCT    WWCOLL
     C*
E1   C                     END
     C*
B1   C           SESPBS    IFEQ 'P'
     C*
     C                     DIV  100       WWCOLL
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEBE -  Update Portfolio Maintenance files      *
     C**                                                              *
     C**  CALLS            - NONE                                     *
     C**                                                              *
     C**  CALLED BY        - #DEB                                     *
     C**                                                              *
     C*****************************************************************
     C           #DEBE     BEGSR
     C*
     C** If action = 'A'
     C*
B1   C           DDACT3    IFEQ 'A'
     C*
     C** If portfolio-pledged number entered
     C*
B2   C           PGPORP    IFNE *BLANKS
     C*
     C** If old issued-by <> new issued-by
     C*
B3   C           HHISSB    IFNE WWCUS2
     C*
     C***Access*PMPORTPP*using*old*issued-by*cust.*&*old*port.*number*****S01498
     C** Access PMPORTPD using old issued-by cust. & old port. number     S01498
     C*
     C***********KL8       CHAINPMPORTPP             42                   S01498
     C           KL8       CHAINPMPORTPD             42                   S01498
     C*
     C** If record not found or deleted
     C*
B4   C           *IN42     IFEQ '1'
     C           PNRECI    OREQ '*'
     C*
     C                     ROLBK
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'PMPORTPP'DBFILE                          S01498
     C                     MOVE 'PMPORTPD'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVELKLST8     DBKEY            *             *
     C                     Z-ADD12        DBASE            * DBERROR 012 *
     C                     OUT  LDA                                       S01498
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C** Else record found
     C*
X4   C                     ELSE
     C*
     C***Update*portfolio*details*file*-*PMPORTPP*************************S01498
     C** Update portfolio details file - PMPORTPD                         S01498
     C*
     C                     Z-ADD*ZEROS    PNPDGS
     C                     Z-ADD*ZEROS    PNPDGF
     C                     UPDATPMPORTP0
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** If portfolio-pledged number entered
     C*
B1   C           DD3ORP    IFNE *BLANKS
     C*
     C***Access*PMPORTPP*using*new*issued-by*cust.*&*new*port.*number*****S01498
     C** Access PMPORTPD using new issued-by cust. & new port. number     S01498
     C*
     C***********KL6       CHAINPMPORTPP             42                   S01498
     C           KL6       CHAINPMPORTPD             42                   S01498
     C*
     C** If record not found , or TNLU <> saved TNLU
     C*
B2   C           *IN42     IFEQ '1'
     C           PNTNLU    ORNE WWTNLP
     C*
     C                     ROLBK
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0057' ZAMSID
     C                     EXSR ZASNMS
     C*
B3   C           *IN42     IFEQ '0'
     C                     EXCPTPMPORT
E3   C                     END
     C*
     C** Else record found
     C*
X2   C                     ELSE
     C*
     C***Update*portfolio*details*file*-*PMPORTPP*************************S01498
     C** Update portfolio details file - PMPORTPD                         S01498
     C*
     C                     Z-ADDWWETTD    PNPDGS
     C                     Z-ADDWWEATD    PNPDGF
     C                     UPDATPMPORTP0
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #E  - File maintenance control from NORMAL       *
     C**                   REQUEST                                    *
     C**                                                              *
     C**  CALLS          - #DA #DB #DC #DD #DE #EA                    *
     C**                                                              *
     C**  CALLED BY      - MAINLINE                                   *
     C**                                                              *
     C*****************************************************************
     C           #E        BEGSR
     C*
     C** AMEND / DELETE / ENQUIRY MODE : initialise screen from file
     C*
B1   C           DDACTC    IFEQ 'A'
     C           DDACTC    OREQ 'D'
     C           DDACTC    OREQ 'E'
     C*
     C                     MOVEA'11111'   *IN,50           ON 50-54
     C                     MOVE HHCNUM    DD3CNU
     C                     MOVE HHSHNM    DD3SHN
     C                     MOVE HHSHNM    DD3SNM                          080767
     C                     MOVE HHBPSN    DD3CON
     C                     MOVE HHSEQN    DD3SEQ
     C                     MOVE HHBRCH    DD3BRC                          S01498
     C*
     C** Save Hidden fields
     C*
     C                     EXSR #EA
     C*
     C** Initialize screen
     C*
     C                     EXSR #DB
     C*
     C** Set up screen
     C*
     C                     EXSR #DA
     C*
X1   C                     ELSE
     C*
     C** INSERT mode : initialise screen to blanks
     C*
     C                     MOVEA'11110'   *IN,50           ON 50-53 OFF 54
     C                     MOVE HHCNUM    DD3CNU
     C                     MOVE HHSHNM    DD3SHN
     C                     MOVE HHBPSN    DD3CON
     C                     MOVE HHSEQN    DD3SEQ
     C                     MOVE HHBRCH    DD3BRC                          S01498
     C*
     C** Set up blank screen
     C*
     C                     EXSR #DB
     C*
E1   C                     END
     C*
     C** Enquiry
     C*
B1   C           DDACTC    IFEQ 'E'
     C*
     C** Process Screen 3 - Enquiry
     C*
     C                     EXSR #DC
     C*
E1   C                     END
     C*
     C** Deletion
     C*
B1   C           DDACTC    IFEQ 'D'
     C*
     C** Process Screen 3 - Delete
     C*
     C                     EXSR #DD
     C*
E1   C                     END
     C*
     C** Amend/Insert
     C*
B1   C           DDACTC    IFEQ 'A'
     C*
     C                     MOVE 'A'       DDACT3
     C*
     C** Process Screen 3 - Amend
     C*
     C                     EXSR #DE
     C*
E1   C                     END
     C*
B1   C           DDACTC    IFEQ 'I'
     C*
     C                     MOVE 'I'       DDACT3
     C*
     C** Process Screen 3 - Insert
     C*
     C                     EXSR #DE
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #EA - Save Hidden fields                         *
     C**                                                              *
     C**  CALLS          - #CAA #E                                    *
     C**                                                              *
     C**  CALLED BY      - #E                                         *
     C**                                                              *
     C*****************************************************************
     C           #EA       BEGSR
     C*
     C                     MOVE PGRECI    HHRECI
     C                     Z-ADDPGTNLU    HHTNLU
     C                     Z-ADDLGARRN    HHARRN
     C**********           Z-ADDPGCNUM    HHCNUM                                              CSD027
     C                     MOVE PGCNUM    HHCNUM                                              CSD027
     C                     Z-ADDPGBPSN    HHBPSN
     C                     Z-ADDPGSEQN    HHSEQN
     C                     MOVE PGTYPE    HHTYPE
     C                     MOVE PGCODE    HHCODE
     C                     MOVE PGNARR    HHNARR
     C**********           Z-ADDPGISSB    HHISSB                                              CSD027
     C                     MOVE PGISSB    HHISSB                                              CSD027
     C                     MOVE PGCCY     HHCCY
     C                     MOVE PGAGRS    HHAGRS
     C                     Z-ADDPGAGRD    HHAGRD
     C                     Z-ADDPGSTTD    HHSTTD
     C                     Z-ADDPGMATD    HHMATD
     C                     Z-ADDPGREVD    HHREVD
     C                     MOVE PGREVF    HHREVF
     C                     Z-ADDPGREVN    HHREVN
     C**********           Z-ADDPGUTSL    HHUTSL                                              CLE148
     C                     MOVELPGUTSL    HHUTSL                                              CLE148
     C                     MOVE PGUTSF    HHUTSF
     C                     MOVE PGUTSP    HHUTSP
     C                     Z-ADDPGGUAA    HHGUAA
     C                     Z-ADDPGCOLS    HHCOLS
     C                     Z-ADDPGCOLB    HHCOLB
     C                     MOVE PGSESN    HHSESN
     C                     MOVE PGPTFR    HHPFTR
     C                     Z-ADDPGPLED    HHPLED
     C                     Z-ADDPGPLEU    HHPLEU
     C                     Z-ADDPGPLEP    HHPLEP
     C                     MOVE PGPORP    HHPORP
     C                     MOVE PGETYP    HHETYP
     C                     MOVE PGEREF    HHEREF
     C                     MOVE PGITYP    HHITYP
     C                     MOVE PGIREF    HHIREF
     C                     Z-ADDPGORDN    HHORDN
     C                     MOVE PGFICC    HHFICC
     C                     MOVE PGDLCC    HHDLCC
     C                     Z-ADDPGPCAA    HHPCAA
     C                     MOVE PGEBCH    HHEBCH                          087628
     C                     MOVE PGIBCH    HHIBCH                          087628
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZA       - CALL ZDATE1                                    *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #DEAC                                          *
     C**                                                              *
     C*****************************************************************
     C           #ZA       BEGSR
     C*
     C** Check input date is numeric
     C*
     C                     MOVE WWDATE    WWNUM7  70
     C                     MOVE WWNUM7    WWALF6  6
     C*
     C** Convert date from input format to midas day number
     C*
     C           WWDATE    IFEQ WWALF6
     C                     MOVE WWDATE    ZDATE
     C                     EXSR ZDATE1
     C                     ELSE
     C                     Z-ADD*ZEROS    ZDAYNO
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #ZB - Set up fields for insert/amend on LBPLEGPD *
     C**                                                              *
     C**  CALLS          - None                                       *
     C**                                                              *
     C**  CALLED BY      - Mainline processing                        *
     C**                                                              *
     C*****************************************************************
     C           #ZB       BEGSR
     C*
     C                     MOVE 'D'       PGRECI
     C**********           Z-ADDHHCNUM    PGCNUM                                              CSD027
     C                     MOVE HHCNUM    PGCNUM                                              CSD027
     C                     Z-ADDHHBPSN    PGBPSN
     C                     Z-ADDHHSEQN    PGSEQN
     C*
     C                     MOVE DD3TYP    PGTYPE
     C                     MOVE DD3ODE    PGCODE
     C                     MOVE DD3NAR    PGNARR
     C**********           Z-ADDWWCUS2    PGISSB                                              CSD027
     C                     MOVE WWCUS2    PGISSB                                              CSD027
     C                     MOVE DD3CCY    PGCCY
     C                     MOVE DD3AGR    PGAGRS
     C*
     C                     Z-ADDWWEDAT    PGAGRD
     C                     Z-ADDWWETTD    PGSTTD
     C                     Z-ADDWWEATD    PGMATD
     C                     Z-ADDWWEEVD    PGREVD
     C*
     C                     MOVE DD3EVF    PGREVF
     C                     MOVE DD3EVN    PGREVN
     C                     MOVE WWEREF    PGEREF
     C                     MOVE WWETYP    PGETYP
     C                     MOVE WWEBCH    PGEBCH                          087628
     C**********           Z-ADDWWETSL    PGUTSL                                              CLE148
     C                     MOVELWWETSL    PGUTSL                                              CLE148
     C                     MOVE DD3TSF    PGUTSF
     C                     MOVE DD3TSP    PGUTSP
     C*
     C                     Z-ADD*ZEROS    PGGUAA
     C                     Z-ADD*ZEROS    PGCOLS
     C*
     C** If type = 'G' set up guarantee amount
     C*
B1   C           PGTYPE    IFEQ 'G'
     C*
     C                     Z-ADDWWEAMT    PGGUAA
     C*
X1   C                     ELSE
     C*
     C** Else if type = 'C' or 'S' set up collateral/security amount
     C*
B2   C           PGTYPE    IFEQ 'C'
     C           PGTYPE    OREQ 'S'
     C*
     C                     Z-ADDWWEAMT    PGCOLS
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     Z-ADDWWEOLB    PGCOLB
     C*
     C                     MOVE DD3TFR    PGPTFR
     C                     MOVE DD3SEN    PGSESN
     C*
     C                     Z-ADDWWPAMT    PGPLED                          LB0000
     C                     Z-ADD*ZEROS    PGPLEU
     C                     Z-ADDWWPLEP    PGPLEP
     C*
     C                     MOVE DD3ORP    PGPORP
     C*
     C                     MOVE WWIREF    PGIREF
     C                     MOVE WWITYP    PGITYP
     C                     MOVE WWIBCH    PGIBCH                          087628
     C                     MOVE DD3ORN    PGORDN
     C***********          MOVE DD3FCC    PGFICC                          S01498
     C                     MOVE DD3DCC    PGDLCC
     C                     MOVE DD3GPE    PGPCAA
     C*                                                                   LB0000
     C** If generalised pledge                                            LB0000
     C*                                                                   LB0000
B1   C           DD3TYP    IFEQ 'P'                                       LB0000
     C           DD3ODE    ANDEQ'GEN'                                     LB0000
     C*                                                                   LB0000
     C** If pledge percentage is equal to 0, put 100 in file field        LB0000
     C*                                                                   LB0000
B2   C           PGPLEP    IFEQ 0                                         LB0000
     C           PGPLED    ANDNE0                                         LB0000
     C                     Z-ADD100       PGPLEP                          LB0000
E2   C                     END                                            LB0000
     C*                                                                   LB0000
E1   C                     END                                            LB0000
     C*                                                                   LB0000
     C** If guarantee or collateral                                       LB0000
     C*                                                                   LB0000
B1   C           DD3TYP    IFEQ 'C'                                       LB0000
     C           DD3TYP    OREQ 'G'                                       LB0000
     C*                                                                   LB0000
     C** If applied percentage is equal to 0, put 100 in file field       LB0000
     C*                                                                   LB0000
B2   C           PGPCAA    IFEQ 0                                         LB0000
     C*                                                                   LB0000
     C** If amount or borrowing power has been entered                    LB0000
     C*                                                                   LB0000
B3   C           WWEAMT    IFNE 0                                         LB0000
     C           WWEOLB    ORNE 0                                         LB0000
     C                     Z-ADD100       PGPCAA                          LB0000
E3   C                     END                                            LB0000
     C*                                                                   LB0000
E2   C                     END                                            LB0000
     C*                                                                   LB0000
E1   C                     END                                            LB0000
     C*
     C** If inserting a new record
     C*
B1   C           DDACT3    IFEQ 'I'
     C*
     C                     MOVE *BLANKS   PGALLW
     C                     Z-ADDBJRDNB    PGORED
     C                     TIME           PGTLUP
     C                     Z-ADDWWDLUP    PGDLUP
     C                     MOVE WWMLUP    PGMLUP
     C                     Z-ADDWWYLUP    PGYLUP
     C                     MOVE 'I'       PGCHTP
     C                     Z-ADDBJRDNB    PGLCD
     C*
E1   C                     END
     C*
     C** If amending an existing record
     C*
B1   C           DDACT3    IFEQ 'A'
     C*
     C** If record was not inserted today
     C*
B2   C           PGLCD     IFNE BJRDNB
     C           PGCHTP    ORNE 'I'
     C*
     C                     TIME           PGTLUP
     C                     Z-ADDWWDLUP    PGDLUP
     C                     MOVE WWMLUP    PGMLUP
     C                     Z-ADDWWYLUP    PGYLUP
     C                     MOVE 'A'       PGCHTP
     C                     Z-ADDBJRDNB    PGLCD
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C                     Z-ADDWWDSTN    PGTNLU
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #ZC    - Check collateral not used to secure     *
     C**                      another account/loan/facility/portfolio *
     C**                                                              *
     C**  CALLS             - NONE                                    *
     C**                                                              *
     C**  CALLED BY         - #DEAEA #DEAEB #DEAEC                    *
     C**                                                              *
     C*****************************************************************
     C           #ZC       BEGSR
     C*
     C**********           Z-ADDWWCUS1    WKCNUM                                              CSD027
     C                     MOVE WWCUS1    WKCNUM                                              CSD027
     C                     Z-ADDWWCON1    WKBPSN
     C*
     C           KPLEGA    SETLLLBPLEGLA
     C           KPLEGA    READELBPLEGLA                 46
     C*
     C** Do while same customer/collateral and valid
     C*
B1   C           *IN46     DOWEQ'0'
     C           *IN99     ANDEQ'0'
     C*
     C** If record not deleted and not the same sequence entered
     C*
B2   C           PGRECI    IFNE '*'
     C           PGSEQN    ANDNEWWSEQ1
     C*
     C** If not the same covered type and ref - error
     C*
B3   C           WWETYP    IFNE PGETYP
     C           WWEREF    ORNE PGEREF
     C           WWEBCH    ORNE PGEBCH                                    087628
     C*
     C                     MOVE '1'       *IN99
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** Read next record for this customer/collateral
     C*
     C           KPLEGA    READELBPLEGLA                 46
     C*
E1   C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   ZTNLU1    - RETRIEVE/UPDATE TRANS NO. OF LAST UPDATE       *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C**   CALLS     - Y2SNMGC                                        *
     C**                                                              *
     C*****************************************************************
     C*
     C           ZTNLU1    BEGSR
     C*
     C           *NAMVAR   DEFN MNATN     DNATN
     C           *LOCK     IN   DNATN
     C                     Z-ADDFNATN     WWDSTN  50
     C                     Z-ADDFNATN     WWNATN
     C                     ADD  1         FNATN
     C                     OUT  DNATN
     C*
     C                     ENDSR
     C********************************************************************
     C**                                                                 *
     C** ZASNMS    - Send message to program's message queue             *
     C**                                                                 *
     C** CALLS     - Y2SNMGC                                             *
     C**                                                                 *
     C** CALLED BY - #B #CB #CC #CD #CE #CBA #ZB                         *
     C**                                                                 *
     C********************************************************************
     C           ZASNMS    BEGSR                           ** ZASNMS    **
     C*
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGM  10
     C                     PARM           ZAPGRL  5
     C                     PARM           ZAMSID  7
     C                     PARM           ZAMSGF 10
     C                     PARM           ZAMSDA132
     C                     PARM           ZAMSTP  7
     C**   Clear all fields for default mechanism next time.
     C******               MOVEL*BLANK    ZAPGRL           Rel queue      R0065
     C                     MOVEL*BLANK    ZAMSDA           Message data.
     C                     MOVEL*BLANK    ZAMSTP           Message type.
     C*
     C                     ENDSR                           **ZASNMS END**
      ********************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   *PSSR     - PROGRAM ERROR HANDLING ROUTINE                 *
     C**                                                              *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C                     ENDSR
     C/EJECT
     O*****************************************************************
     O*
     O**   RELEASE THE RECORD FROM LBPLEGPD
     O*
     OLBPLEGD0E                LBXXXX
     O*****************************************************************
     O/EJECT
     O*****************************************************************
     O*
     O*****RELEASE*THE*RECORD*FROM*PMPORTPP*******************************S01498
     O**   RELEASE THE RECORD FROM PMPORTPD                               S01498
     O*
     OPMPORTP0E                PMPORT
     O*****************************************************************
     O/EJECT
**   CPY@
(c) Misys International Banking Systems Ltd. 2001
**   ALPNU - ARRAY OF ALPHANUMERICS A-Z, BLANK, 0-9
A BCDEFGHIJKLMNOPQRSTUVWXYZ0123456789
**   NUM - ARRAY OF NUMBERS 0-9
0123456789
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
