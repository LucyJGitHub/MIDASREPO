     H        1                                                           S01498
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Borrowing Power Enquiry')                     *
     H***********                                                         S01498
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                             *
     F*                                                               *
     F*  LB0320 - Borrowing Power Enquiry                             *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. CRE026             Date 24May06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3644            Date 12Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 TDA035             Date 02Apr04               *
      *                 CAAA03             Date 25Mar04               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CGL008             Date 03Mar99               *
      *                 CPM005             Date 14Oct96               *
      *                 092955             Date 13Sep95               *
     F*                 088182             DATE 06SEP95               *
     F*                 085817             DATE 13MAR95               *
     F*                 081239             DATE 02FEB95               *
     F*                 083547             DATE 20FEB95               *
     F*                 S01498             DATE 11AUG94               *
     F*                 066235             DATE 27JAN93               *
     F*                 049421             DATE 19JAN93               *
     F*                 S01313             DATE 27AUG92               *
     F*                 001298PA           DATE 14AUG91               *
     F*                 R0119_BZ           DATE 08FEB91               *
     F*                 R00300             DATE 06NOV90               *
     F*                 R0671_DC           DATE 30OCT90               *
     F*                 B9698              DATE 23OCT90               *
     F*                 R00266             DATE 07AUG90               *
     F*                 LB0000             DATE 07JUN90               *
     F*                 LB0000             DATE 31MAY90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CLE148 - Alpha Loan Reference                                *
      *  CRE026 - Consumer Banking (Recompile)                        *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3644 - Serious Error in Collateralised Lending (Recompile)*
      *  CLE025 - Credit Lines (Recompile)                            *
      *  TDA035 - RTS Signon changes for MidasPlus. (Recompile)       *
      *  CAAA03 - Webfacing Changes (recompile).                      *
      *  CGL008 - Security on Journal Entry. Recompile.               *
     F*  CPM005 - Private Banking Phase 2                             *
     F*           Focus Group Changes upgraded to DBA                 *
     F*           Recompiled due to changes in PMLDAPD                *
     F*  092955 - Complete 088182 to output birth date as 7A          *
     F*  088182 - CORRECT FORMATTING OF DATE OF BIRTH                 *
     F*  085817 - Recompile due to changes in PMLDAPD                 *
     F*  081239 - R10 Private Banking Rework.                         *
     F*  083547 - Correcting Account Officer name on MUSERDD          *
     F*  S01498 - Portfolio Lending Upgrade to Release 10             *
     F*  066235 - Recompile program due to changes in DSPF            *
     F*  049421 - HEADER BOX STANDARDISATION                          *
     F*  S01313 - PORTFOLIO PERFORMANCE CHANGES                       *
     F*  001298 - Position on start of file                           *
     F*  R0119  - Call CL Program before calling Customer             *
     F*           Documentation.                                      *
     F*  R00300 - Message file changes                                *
     F*  R0671  - Rounding problem when you are in Details            *
     F*           Borrowing Power.                                    *
     F*  B9698  - OUTPUT CONDITIONNED BY VALUE BORROWING POWER        *
     F*  R00266 - SETUP CORRECT FILEDS ON DATA AREA PMLDAPP.          *
     F*  LB0000 - XH/JG FIX.                                          *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F** C R E A T I O N     P A R A M E T E R S                      *
     F**                                                              *
     F**                                                              *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**
     F** FILE DEFINITIONS
     F** ----------------
     F*
     F***Bank*Details*File.*Prefix*-*BJ********************************   S01498
     F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F***Portfolio*Lending*Installation*Control*Data.*Prefix*-*LB******   S01498
     F***SDLOMBPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F***Modules*Present*File*Prefix*-*BG******************************   S01498
     F**SDMMODPDIF**E*********  K        DISK         KINFSR *PSSR        001298
     F***SDMMODPDIF**E                    DISK         KINFSR *PSSR001298 S01498
     F*
     F***Currency*Codes.*Prefix*-*A6***********************************   S01498
     F***SDCURRL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** Client Master File (Customer Number). Prefix - BB & CU
     F***SDLBCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ0IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F** Client Master File (Customer Shortname). Prefix - BB & CU
     F***SDLBCSL5IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ5IF  E           K        DISK         KINFSR *PSSR          S01498
     F            SDLBCSJ0                          KRENAMESDLBCSJR
     F*
     F***Midas*User*Definition.*Prefix*-*NONE**************************   S01498
     F***MUSER***IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Account*Officers.*Prefix*-*AZ*********************************   S01498
     F***SDACOFL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Country*Details.*Prefix*-*A4**********************************   S01498
     F***SDCTRYL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Portfolio*Management*Customer*Details.*Prefix*-*QB************   S01498
     F***SDPLCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Portfolio*Management*I.C.D.*Prefix*-*P9***********************   S01498
     F*DPORTPDIF**E***********K********DISK         KINFSR *PSSR          LB0000
     F***SDPORTPDIF**E                    DISK         KINFSR *PSSRLB0000 S01498
     F*
     F***Portfolio*Lending*Groups.*Prefix*-*GP*(KEYED*ON*GROUP)********   S01498
     F***LBGROUL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Instrument*types.*Prefix*-*PD*********************************   S01498
     F***SDPLINL4IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** Portfolio Lending Detail. Prefix - EE (KEYED ON CUSTOMER,-,-ETC)
     FLBEXTRL4IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Portfolio Lending Extract Detail. Prefix - EE (KEYED ON PARENT,-,-ETC)
     FLBEXTRL7IF  E           K        DISK         KINFSR *PSSR
     F            LBEXTRD0                          KRENAMELBEXTRD7
     F*
     F** Portfolio Lending Extract Detail. Prefix - EE (KEYED ON CUSTOMER/GROUP)
     FLBEXTRL8IF  E           K        DISK         KINFSR *PSSR
     F            LBEXTRD0                          KRENAMELBEXTRD8
     F*
     F** Portfolio lending Extract Detail. Prefix - EE (KEYED ON PARENT/GROUP)
     FLBEXTRL9IF  E           K        DISK         KINFSR *PSSR
     F            LBEXTRD0                          KRENAMELBEXTRD9
     F*                                                                   LB0000
     F** Securities Details.                 (KEYED ON SECURITY SHORTNAME)LB0000
     FSECTY   IF  E           K        DISK         KINFSR *PSSR          LB0000
     F*
     F** Workstation File
     FLB0320DFCF  E                    WORKSTN      KINFSR *PSSR
     F                                        SFLRR2KSFILE LB0320S2
     F                                              KINFDS $1DS
     F*
     F********************************************************************
     F/EJECT
     F********************************************************************
     F**                                                                 *
     F** ID F  C  H  L    FUNCTION OF INDICATORS                         *
     F**                  ----------------------                         *
     F**      25          HELP                                           *
     F**      26          SFLEND    ------) Message Subfile              *
     F**      27          ROLLUP                                         *
     F**                                                                 *
     F**      28          SFLDSP    ------)                              *
     F**      29          SFLDSPCTL       )                              *
     F**      30          SFLCLR          ) Input Screen 2 Subfile       *
     F**      31          SFLEND          )                              *
     F**      32          SFLNXTCHG ------)                              *
     F**                                                                 *
     F**      33          Invalid customer number/shortname on screen 1  *
     F**      34          First character of customer number/shortname   *
     F**                  is (1) Alphanumeric (2) Numeric                *
     F**      35          Customer number/shortname found                *
     F**      36          Customer number available                      *
     F**      37          Customer shortname available                   *
     F********38**********Chain*fail*on*SDLBCSL0***********************  *S01498
     F********39**********Chain*fail*on*SDLBCSL5***********************  *S01498
     F**      38          Chain fail on LBLBCSJ0                         *S01498
     F**      39          Chain fail on LBLBCSJ5                         *S01498
     F********40**********Chain*fail*on*LBGROUL1***********************  *S01498
     F**      41          Portfolio Management installed                 *
     F**      42          No details for customer                        *
     F**      43          Record found on SETLL                          *
     F********44**********Chain*fail*on*SDPLINL4***********************  *S01498
     F**      45          Enable CMD11 & CMD/12                          *
     F**      46          Record found on LBEXTRL4                       *
     F**      47          Invalid Group Code on screen 2                 *
     F********48**********EOF*on*SDLBCSL0*for*customer*no.*************  *S01498
     F**      48          EOF on LBLBCSJ0 for customer no.               *S01498
     F**      49          Enable CMD23,CMD24                             *
     F**      50          PM0160 called during execution of program      *
     F**      51          End of LBEXTRL7                                *
     F********52**********Chain*fail*on*SDPLCSL0***********************  *S01498
     F**      53          Beyond EOF LBEXTRL8/9                          *
     F**      54          Record found on SETLL on LBEXTRL8/9            *
     F**      55          Record found on LBEXTRL8/9                     *
     F**      56          Record found on LBEXTRL7                       *
     F********57**********Chain*fail*on*SDCTRYL1***********************  *S01498
     F********58**********SDPORTPD*not*found***************************  *S01498
     F********59**********Chain*fail*on*MUSER**************************  *S01498
     F********60**********Chain*fail*on*SDACOFL1***********************  *S01498
     F**      61          End of LBEXTRL4                                *
     F**      62          Group Code Heading                             *
     F**      63          HIGHLIGHT GROUP NARRITIVE ON SUBFILE           *
     F**                                                                 *
     F********************************************************************
     F/EJECT
     E********************************************************************
     E*
     E**   Array for COPYRIGHT
     E                    CPY@    1   1 80
     E*
     E** SCONV S/R array for powers of 10
     E                    POWER   1   7  7 3
     E*
     E** Array of alphanumerics
     E                    ALPNU  37  37  1
     E*
     E** Array of numbers
     E**********          NUM    10  10  1                                                    CSD027
     E*
     E** Array to split customer field into individual characters
     E                    CUS        10  1
     E*
     E***Array*of*commands*********************************************   S01498
     E********************ARR     1   2 80                                S01498
     E*
     E**   Arrays for ZDATE2
     E/COPY ZSRSRC,ZDATE2Z1
     E*
     E** Arrays used in conversion of decimal amounts to character
     E/COPY ZSRSRC,ZSEDITZ1
     E*
     E********************************************************************
     E/EJECT
     I********************************************************************
     I*
     I**   DATA STRUCTURE FOR COMPILATION - Copyright Insertion
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*
     I*****DATA*STRUCTURE*TO*DEFINE*THE*GROUP*DATA*AREA****************   S01498
     I***WWPARM    E DSPMGDA
     I***WWPGDA****E*DSPMGRDAPP***************                            S01498
     I*
     I*****DATA*STRUCTURE*TO*DEFINE*THE*LOCAL*DATA*AREA*FOR*GROUP*JOBS*   S01498
     I***WWPLDA****E*DSPMLDAPP****************                            S01498
     I*                                                                   S01498
     I** Data structure to define DTAARA/*LDA                             S01498
     IWWPLDA    E DSPMLDAPD                                               S01498
     I*
     I** Display file information data structure
     I$1DS        DS
     I                                    B 378 3790$1DSRN
     I*
     I** Program status data structure
     IPSDS       SDS
     I**************************************244 253 DDWSID                S01498
     I**************************************254 263 DDUSER                S01498
     I                                      244 253 SWSID                 S01498
     I                                      254 263 SUSER                 S01498
     I*
     I** Local data area
     I***DTAR*******UDS***********************     256                    S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*
     I** Data Structure to split customer number/shortname field
     IWW1CNS      DS
     I                                        1  10 DD1CNS
     I                                        1  10 CUS
     I                                        1   6 DD1CNO
     I                                        1   1 WWCCH1
     I                                        7  10 WWC710
     I*
     I** Data Structure to rename customer number field
     IWW1CNM      DS
     I**********                              1   60WWCNMB                                    CSD027
     I                                        1   6 WWCNMB                                    CSD027
     I                                        1   6 WWCNMC
     I*
     I** DATA STRUCTURE FOR DATE OF BIRTH (READ FROM SDPLCSL0)
     I            DS
     I                                        1   60WWDAT1
     I                                        1   20WWDAY1
     I                                        3   40WWMON1
     I                                        5   60WWYER1
     I**
     I** DATA STRUCTURE FOR DATE OF BIRTH (CONVERTED AS PARAMETER)
     I**
     I            DS
     I                                        1   7 WWDAT2
     I                                        1   20WWDAY2
     I                                        3   5 WWMON2
     I                                        6   70WWYER2
     I*
     I** Data structure to convert @@IAMT decimal field to alpha
     I/COPY ZSRSRC,ZSEDITZ2
     I*                                                                   S01498
     ISDBANK    E DSSDBANKPD                                              S01498
     I**  Data structure for bank details                                 S01498
     I*                                                                   S01498
     ISDLOMB    E DSSDLOMBPD                                              S01498
     I**  Data structure for Portfolio Lending ICD                        S01498
     I*                                                                   S01498
     ISDCURR    E DSSDCURRPD                                              S01498
     I**  Data structure for currency details                             S01498
     I*                                                                   S01498
     ISDACOF    E DSSDACOFPD                                              S01498
     I**  Data structure for account officer details                      S01498
     I*                                                                   S01498
     ISDMMOD    E DSSDMMODPD                                              S01498
     I**  Data structure for Midas modules details                        S01498
     I*                                                                   S01498
     ISDPLCS    E DSSDPLCSPD                                              S01498
     I**  Data structure for Portfolio Management customer details        S01498
     I*                                                                   S01498
     ISDPORT    E DSSDPORTPD                                              S01498
     I**  Data structure for Portfolio Management ICD                     S01498
     I*                                                                   S01498
     ISDCTRY    E DSSDCTRYPD                                              S01498
     I**  Data structure for country code details                         S01498
     I*                                                                   S01498
     ISDGROU    E DSLBGROUPD                                              S01498
     I**  Data structure for lending group details                        S01498
     I*                                                                   S01498
     ISDUSER    E DSMUSERDD                                               S01498
     I**  Data structure for user details                                 S01498
     I*                                                                   S01498
     ISDPLIN    E DSSDPLINPD                                              S01498
     I**  Data structure for instrument type details                      S01498
     I*                                                                   S01498
     IDSFDY     E DSDSFDY                                                 S01498
     I**  Short data structure for access objects                         S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I**  Long data structure for access programs                         S01498
     I*
     I********************************************************************
     I/EJECT
     C********************************************************************
     C*
     C** PARAMETER LIST DECLARATIONS
     C** ---------------------------
     C** WWCALL - '0' = Called from menu
     C**          '1' = Called from LB0305 (PortfoliioEnquiry)
     C** WWCNUM - Customer number (If called from another program)
     C** WWFCTN - 03 = Function Key 3 returned
     C**          12 = Function Key 12 returned
     C** WWUPFL - User Profile Description
     C*
     C           *ENTRY    PLIST
     C                     PARM           WWCALL  1
     C**********           PARM           WWCNUM  60                                          CSD027
     C                     PARM           WWCNUM  6                                           CSD027
     C                     PARM           WWFCTN  2
     C                     PARM           WWUPFL 10
     C                     PARM           WWCHCK  1
     C*                                                                   S01498
     C**  Copyright statement                                             S01498
     C*                                                                   S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*
     C********************************************************************
     C/EJECT
     C*
     C**             START MAINLINE
     C**             --------------
     C** Initialisation
     C                     EXSR #A
     C*
     C** Main processing
     C           *IN48     IFEQ '0'
     C                     EXSR #B
     C                     END
     C*
     C** CALL PM0160 , IF NECESSARY
     C                     EXSR #ZE
     C*
     C** End program
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**                    INDEX TO SUBROTUINES                         *
     C**                    --------------------                         *
     C**  1.#BF    - Process an ENTER from input screen 2                *
     C**  2.#ZA    - Load a page of records to the subfile of screen 2   *
     C**             (Children or Orphans)                               *
     C**  3.#ZB    - Load a page of records to the subfile of screen 2   *
     C**             (Parents)                                           *
     C**  4.#ZC    - Set up output fields for subfile                    *
     C**  5.#BG    - Process roll-up                                     *
     C**  6.#BA    - Validate input screen 1                             *
     C**  7.#AA    - Validate customer no. if called from another pgm.   *
     C**  8.#BB    - Process CMD/11 to change currency                   *
     C**  9.#BC    - Process CMD/12 for previous screen                  *
     C** 10.#BD    - Process CMD/23 for Portfolio Management Enquiries   *
     C** 11.#BDA   - Load the Group Data Area                            *
     C** 12.#BE    - Process CMD/24 for Documentation                    *
     C** 13.#ZD    - Retrieve currency details for customer currency     *
     C** 14.#ZE    - Call 'PM0160'                                       *
     C** 15.ZSEDIT - Convert a decimal amount to character               *
     C**15a.ZDATE2 - Convert dates from MIDAS day number to date format  *
     C** 16.SCONV  - Convert an amount from one currency to another      *
     C** 17.ZASNMS - Send message to program's message queue             *
     C** 18.#A     - Initialisation                                      *
     C** 19.#B     - Main processing                                     *
     C** 20.*PSSR  - Program error handling routine                      *
     C**                                                                 *
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BF         - This subroutine processes an ENTER from input     *
     C**               screen 2                                          *
     C**                                                                 *
     C** CALLS       - Y2CLMSC #ZA #ZB                                   *
     C**                                                                 *
     C** CALLED BY   - #B                                                *
     C**                                                                 *
     C********************************************************************
     C           #BF       BEGSR
     C*
     C** Initialize group code error indicator (*IN47); Screen 2 is
     C** valid unless error occurs; Update subfile relative record
     C** number;
     C                     MOVE '0'       *IN47
     C                     MOVE 'Y'       WWVLD2
     C                     Z-ADDWWSTRN    SFLRR2
     C*
     C** Clear message subfile.
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C** If group code entered , access file for sequence number
     C           DD2LCG    IFNE *BLANKS
     C           BBPAIN    IFNE 'P'
     C           KLIST1    SETLLLBEXTRL8             53  54
     C           *IN53     IFEQ '0'
     C                     READ LBEXTRL8                 55
     C                     END
     C           WWCNMB    IFNE EECNUM
     C           *IN53     OREQ '1'
     C                     READPLBEXTRL8                 55
     C                     END
     C                     ELSE
     C           KLIST2    SETLLLBEXTRL9             53  54
     C           *IN53     IFEQ '0'
     C                     READ LBEXTRL9                 55
     C                     END
     C           WWCNMC    IFNE EEPCNB
     C           *IN53     OREQ '1'
     C                     READPLBEXTRL9                 55
     C                     END
     C                     END
     C*
     C           BBPAIN    IFNE 'P'
     C           KLIST3    SETLLLBEXTRL4                 46
     C                     ELSE
     C           KLIST4    SETLLLBEXTRL7                 56
     C                     END
     C*
     C** Clear the input screen 2 subfile
     C                     MOVE '1'       *IN30
     C                     WRITELB0320C2
     C                     MOVE '0'       *IN30
     C*
     C** Initialize fields
     C                     Z-ADD0         LSTRR2
     C                     MOVE '0'       *IN47
     C                     MOVE *BLANKS   DD1CNS
     C                     MOVE *BLANKS   DD2LCG
     C                     MOVE *BLANKS   WWLCGR
     C                     MOVE 'LB'      WWCUFG
     C***********          MOVE LBCCY     DDCCY                           S01498
     C                     MOVE LBCYCD    DDCCY                           S01498
     C*
     C** Load subfile
     C           BBPAIN    IFNE 'P'
     C                     READ LBEXTRL4                 61
     C                     EXSR #ZA
     C                     ELSE
     C                     READ LBEXTRL7                 51
     C                     EXSR #ZB
     C                     END
     C*
     C                     END
     C*
     C           #BF0      ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZA         - This subroutine loads a page of records to the    *
     C**               subfile of input screen 2 using customer details  *
     C**                                                                 *
     C** CALLS       - #ZC                                               *
     C**                                                                 *
     C** CALLED BY   - #B #BF #BG                                        *
     C**                                                                 *
     C********************************************************************
     C           #ZA       BEGSR
     C*
     C** Load a page of subfile records
     C                     Z-ADDLSTRR2    SFLRR2
     C                     Z-ADD0         WWSFCT  40
     C*
     C** Set on no details found indicator
     C                     MOVE '1'       *IN42
     C*
     C           *IN61     DOWEQ'0'
     C           WWSFCT    ANDLT13
     C           EECNUM    ANDEQWWCNMB
     C*
     C** Set up output fields using customer details
     C           *IN62     IFEQ '0'
     C           EEBPWR    ANDNE0                                         B9698
     C                     EXSR #ZC
     C                     END
     C*
     C           WWSFCT    IFLT 13
     C           EEBPWR    IFNE 0                                         B9698
     C                     ADD  1         WWSFCT
     C                     ADD  1         SFLRR2
     C                     WRITELB0320S2
     C                     END                                            B9698
     C                     READ LBEXTRL4                 61
     C                     MOVE '0'       *IN62
     C                     END
     C*
     C                     END
     C*
     C** Set on subfile end indicator on change of customer or End of File
     C           EECNUM    IFNE WWCNMB
     C           *IN61     OREQ '1'
     C                     MOVE '1'       *IN31
     C                     ELSE
     C                     MOVE '0'       *IN31
     C                     END
     C*
     C                     Z-ADDSFLRR2    LSTRR2
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZB         - This subroutine loads a page of records to the    *
     C**               subfile of input screen 2 using parent details    *
     C**                                                                 *
     C** CALLS       - #ZC                                               *
     C**                                                                 *
     C** CALLED BY   - #B #BF #BG                                        *
     C**                                                                 *
     C********************************************************************
     C           #ZB       BEGSR
     C*
     C** Load a page of subfile records
     C                     Z-ADDLSTRR2    SFLRR2
     C                     Z-ADD0         WWSFCT  40
     C*
     C** Set on no details found indicator
     C                     MOVE '1'       *IN42
     C*
     C           *IN51     DOWEQ'0'
     C           WWSFCT    ANDLT13
     C           EEPCNB    ANDEQWWCNMC
     C*
     C** Set up output fields using parent details
     C           *IN62     IFEQ '0'
     C           EEBPWR    ANDNE0                                         B9698
     C                     EXSR #ZC
     C                     END
     C*
     C           WWSFCT    IFLT 13
     C           EEBPWR    IFNE 0                                         B9698
     C                     ADD  1         WWSFCT
     C                     ADD  1         SFLRR2
     C                     WRITELB0320S2
     C                     END                                            B9698
     C                     READ LBEXTRL7                 51
     C                     MOVE '0'       *IN62
     C                     END
     C*
     C                     END
     C*
     C** Set on subfile end indicator on change of customer or End of File
     C           EEPCNB    IFNE WWCNMC
     C           *IN51     OREQ '1'
     C                     MOVE '1'       *IN31
     C                     ELSE
     C                     MOVE '0'       *IN31
     C                     END
     C*
     C                     Z-ADDSFLRR2    LSTRR2
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZC         - This subroutine sets up output fields for the     *
     C**               subfile of input screen 2                         *
     C**                                                                 *
     C** CALLS       - #ZE ZSEDIT SCONV                                  *
     C**                                                                 *
     C** CALLED BY   - #ZA #ZB                                           *
     C**                                                                 *
     C********************************************************************
     C           #ZC       BEGSR
     C*
     C** Write record to subfile for each new group code
     C           EELCGR    IFNE WWLCGR
     C***********EELCGR    CHAINLBGROUL1             40                   S01498
     C************IN40     IFEQ '1'                                       S01498
     C***********GPRECI    OREQ '*'                                       S01498
     C*                                                                   S01498
     C** Get group name using access object                               S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM EELCGR    P@LCGR  3                       S01498
     C           SDGROU    PARM SDGROU    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBKEY
     C***********          MOVEL'LBGROUL1'DBFILE           ***************S01498
     C                     MOVE 'LBGROUPD'DBFILE           ***************S01498
     C                     MOVELEELCGR    DBKEY            ** DBERROR 005 **
     C                     Z-ADD5         DBASE            *****************
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     END
     C*
     C                     MOVE '1'       *IN63
     C                     MOVE EELCGR    DDCRGP
     C                     MOVE *BLANKS   DDINSE
     C                     MOVELGPLCGN    DDINSE
     C                     MOVE *BLANKS   DDINCY
     C                     MOVE *BLANKS   DDPOWR
     C                     Z-ADD*ZEROS    DDPERC
     C                     Z-ADD*ZEROS    DDCLIN
     C                     Z-ADD*ZEROS    DDSECU
     C                     Z-ADD*ZEROS    DDINST
     C                     Z-ADD*ZEROS    DDCTRY
     C                     MOVE EELCGR    WWLCGR
     C                     ADD  1         WWSFCT
     C                     ADD  1         SFLRR2
     C                     WRITELB0320S2
     C                     MOVE '0'       *IN63
     C                     END
     C*
     C** Set off no details found indicator
     C                     MOVE '0'       *IN42
     C*
     C** Format Borrowing Power Weighting in Portfolio currency
     C                     Z-ADDEEBPWR    WWBPWR
     C***********          DIV  1000      WWBPWR    H                     R0671
     C           WWDILB    IFNE 0
     C                     DIV  WWDILB    WWBPWR    H
     C                     END
     C                     Z-ADDWWBPWR    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    DD2LBP
     C*
     C** Access Instrument file to obtain Instrument Type Narrative
     C           EESESN    IFEQ *BLANKS                    -B1            LB0000
     C***********EEINST    CHAINSDPLINL4             44                   S01498
     C************IN44     IFEQ '1'                        -B2            S01498
     C***********PDRECI    OREQ '*'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM EEINST    P@INST  3                       S01498
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBKEY
     C***********          MOVEL'SDPLINL4'DBFILE           ***************S01498
     C                     MOVE 'SDPLINPD'DBFILE           ***************S01498
     C                     MOVELEEINST    DBKEY            * DBERROR 006 *
     C                     Z-ADD6         DBASE            ***************
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE                            -X2            LB0000
     C                     MOVE *BLANKS   DDINSE                          LB0000
     C                     MOVE PDISTN    DDINSE                          LB0000
     C                     END                             -E2            LB0000
     C                     ELSE                            -X1            LB0000
     C*                                                                   LB0000
     C           EESESN    CHAINSECTY                77                   LB0000
     C           *IN77     IFEQ '1'                        -B2            LB0000
     C           RECI      OREQ '*'                                       LB0000
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANK    DBKEY                           LB0000
     C***********          MOVEL'SECTY'   DBFILE           ********LB0000 S01498
     C                     MOVE 'SECTY'   DBFILE           ***************S01498
     C                     MOVELEESESN    DBKEY            * DBERROR 010 *LB0000
     C                     Z-ADD10        DBASE            ***************LB0000
     C                     MOVE '1'       *INU7                           LB0000
     C                     MOVE '1'       *INU8                           LB0000
     C                     MOVE '1'       *INLR                           LB0000
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE                                       LB0000
     C                     RETRN                                          LB0000
     C                     ELSE                            -X2            LB0000
     C                     MOVE *BLANKS   DDINSE                          LB0000
     C                     MOVE SRPN      DDINSE                          LB0000
     C                     END                             -E2            LB0000
     C                     END                             -E1            LB0000
     C*
     C** Calculate the borrowing power percentage
     C           EECLPC    IFNE *ZEROS
     C                     Z-ADDEECLPC    WWCLPX
     C                     ELSE
     C           EESESN    IFNE *BLANKS
     C           EESEPC    ANDNE*ZEROS                                    B9698
     C                     Z-ADDEESEPC    WWCLPX
     C                     ELSE
     C           EEINPC    IFNE *ZEROS
     C                     Z-ADDEEINPC    WWCLPX
     C                     ELSE
     C                     Z-ADD100       WWCLPX
     C                     END
     C                     END
     C                     END
     C*
     C           EECTPC    IFNE *ZEROS
     C           WWCLPX    MULT EECTPC    WWBOPT  60
     C           WWBOPT    DIV  100       WWBOPP    H
     C                     ELSE
     C                     Z-ADDWWCLPX    WWBOPP
     C                     END
     C*
     C** If the customer currency differs from the Portfolio currency then
     C** calculate the corresponding amounts in the customer currency
     C***********CUCCY     IFEQ LBCCY                                     S01498
     C           CUCCY     IFEQ LBCYCD                                    S01498
     C*
     C                     MOVE DD2LBP    DD2CUP
     C*
     C                     ELSE
     C*
     C** Calculate the borrowing power in customer currency
     C                     Z-ADDEEBPWR    WWAMTI
     C                     EXSR SCONV
     C***********          DIV  1000      WWAMTO    H                     R0671
     C           WWDICU    IFNE 0
     C                     DIV  WWDICU    WWAMTO    H
     C                     END
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    DD2CUP
     C*
     C                     END
     C*
     C** Move hidden fields to the output fields
     C           WWCUFG    IFEQ 'LB'
     C*
     C                     MOVE DD2LBP    DDPOWR
     C                     MOVE DD2LCU    DDCCY
     C*
     C                     ELSE
     C*
     C                     MOVE DD2CUP    DDPOWR
     C                     MOVE DD2CCU    DDCCY
     C                     END
     C*
     C                     MOVE *BLANKS   DDCRGP
     C                     MOVE EECCY     DDINCY
     C                     Z-ADDWWBOPP    DDPERC
     C*
     C** Set up % Weighting values.
     C                     Z-ADD*ZEROS    DDCLIN
     C                     Z-ADD*ZEROS    DDSECU
     C                     Z-ADD*ZEROS    DDINST
     C*******    EECLPC    IFNE *ZEROS                                    LB0000
     C                     Z-ADDEECLPC    DDCLIN
     C*******              ELSE                                           LB0000
     C*******    EESESN    IFNE *BLANKS                                   LB0000
     C                     Z-ADDEESEPC    DDSECU
     C*******              ELSE                                           LB0000
     C*******    EEINPC    IFNE *ZEROS                                    LB0000
     C                     Z-ADDEEINPC    DDINST
     C*******              END                                            LB0000
     C*******              END                                            LB0000
     C*******              END                                            LB0000
     C*******    EECTPC    IFEQ *ZEROS                                    LB0000
     C                     Z-ADD*ZEROS    DDCTRY
     C*******              ELSE                                           LB0000
     C                     Z-ADDEECTPC    DDCTRY
     C*******              END                                            LB0000
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BG         - This subroutine processes ROLL-UP for customers   *
     C**               or parents                                        *
     C**                                                                 *
     C** CALLS       - #ZA #ZB                                           *
     C**                                                                 *
     C** CALLED BY   - #B                                                *
     C**                                                                 *
     C********************************************************************
     C           #BG       BEGSR
     C*
     C** Decide whether ROLL-UP is required for a customer or parent
     C           BBPAIN    IFEQ 'P'
     C                     EXSR #ZB
     C                     ELSE
     C                     EXSR #ZA
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BA         - This subroutine validates input screen 1          *
     C**                                                                 *
     C** CALLS       - Y2CLMSC ZASNMS                                    *
     C**                                                                 *
     C** CALLED BY   - #B                                                *
     C**                                                                 *
     C********************************************************************
     C           #BA       BEGSR
     C*
     C** Disable CMD/11 CMD/12 CMD/23 CMD/24 on screen 1; Screen 1 is not
     C** valid;
     C** Clear message queue.
     C                     MOVE '0'       *IN45
     C                     MOVE '0'       *IN49
     C                     MOVE 'N'       WWVLD1
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C** Validate the customer number or shortname
     C*
     C** The first character must be alphanumeric or blank
     C           WWCCH1    LOKUPALPNU                    34
     C           *IN34     IFEQ '0'
     C                     MOVE '1'       *IN33
     C           *IN33     CABEQ'1'       #BA0
     C                     END
     C**********                                                                              CSD027
     C***If*the*first character is non-numeric then check for a valid shortname               CSD027
     C********** WWCCH1    LOKUPNUM                      34                                   CSD027
     C**********                                                                              CSD027
     C********** *IN34     IFEQ '0'                                                           CSD027
     C**********                                                                              CSD027
     C***********DD1CNS    SETLLSDLBCSL5             33  35               S01498              CSD027
     C********** DD1CNS    SETLLLBLBCSJ5             33  35               S01498              CSD027
     C********** *IN35     IFEQ '1'                                                           CSD027
     C**********           MOVE '0'       *IN36                                               CSD027
     C**********           MOVE '1'       *IN37                                               CSD027
     C**********           END                                                                CSD027
     C********** *IN33     CABEQ'1'       #BA0                                                CSD027
     C**********                                                                              CSD027
     C**********           ELSE                                                               CSD027
     C**********                                                                              CSD027
     C***The*first character is numeric so check that the next 5 characters                   CSD027
     C***are*also numeric and the last 4 are blank. If still valid then                       CSD027
     C***check*that the customer number exists                                                CSD027
     C**********           Z-ADD1         WWFLD1  20                                          CSD027
     C********** WWFLD1    DOWLT6                                                             CSD027
     C**********           ADD  1         WWFLD1                                              CSD027
     C********** CUS,WWFLD1LOKUPNUM                      34                                   CSD027
     C********** *IN34     IFEQ '0'                                                           CSD027
     C**********           MOVE '1'       *IN33                                               CSD027
     C********** *IN33     CABEQ'1'       #BA0                                                CSD027
     C**********           END                                                                CSD027
     C**********           END                                                                CSD027
      * Check as a shortname                                                                  CSD027
     C           DD1CNS    CHAINLBLBCSJ5             77                                       CSD027
      * If shortname was not found                                                            CSD027
     C           *IN77     IFEQ *ON                                                           CSD027
     C*
     C           WWC710    IFNE *BLANKS
     C                     MOVE '1'       *IN33
     C           *IN33     CABEQ'1'       #BA0
     C                     END
     C*
     C                     MOVELDD1CNS    WWCNSN  6
     C***********WWCNSN    SETLLSDLBCSL0             33  35               S01498
     C           WWCNSN    SETLLLBLBCSJ0             33  35               S01498
     C           *IN35     IFEQ '1'
     C                     MOVE '1'       *IN36
     C                     MOVE '0'       *IN37
     C                     END
     C           *IN33     CABEQ'1'       #BA0
     C*
     C                     END
     C*
     C                     GOTO #BA1
     C*
     C** Invalid customer found, load message to message subfile
     C           #BA0      TAG
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C*
     C           #BA1      ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #AA         - This subroutine validates customer number if      *
     C**               program is called from another program            *
     C**                                                                 *
     C** CALLS       - #ZD                                               *
     C**                                                                 *
     C** CALLED BY   - #A                                                *
     C**                                                                 *
     C********************************************************************
     C           #AA       BEGSR
     C*
     C                     MOVE WWCNUM    WWCNSN
     C***********WWCNSN    SETLLSDLBCSL0             33  35               S01498
     C           WWCNSN    SETLLLBLBCSJ0             33  35               S01498
     C           *IN35     IFEQ '1'
     C***********          READ SDLBCSL0                 38               S01498
     C                     READ LBLBCSJ0                 38               S01498
     C                     MOVE WWCNUM    WWCNMB
     C                     END
     C           *IN33     CABEQ'1'       #AA0
     C*
     C                     EXSR #ZD
     C                     GOTO #AA1
     C*
     C           #AA0      TAG
     C**********           Z-ADD0         WWCNUM                                              CSD027
     C                     MOVE *BLANKS   WWCNUM                                              CSD027
     C                     MOVE '1'       *IN48
     C*
     C           #AA1      ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BB         - This subroutine processes a CMD/11 to change ccy  *
     C**                                                                 *
     C** CALLS       - Y2CLMSC                                           *
     C**                                                                 *
     C** CALLED BY   - #B                                                *
     C**                                                                 *
     C********************************************************************
     C           #BB       BEGSR
     C*
     C** Initialize group code; Clear message code; Screen 2 is valid
     C                     MOVE *BLANKS   DD2LCG
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C                     MOVE 'Y'       WWVLD2
     C                     MOVE '0'       *IN47
     C*
     C** If the figures are in Portfolio currency then display them in the
     C** customer currency and vice-versa
     C                     DO   LSTRR2    WWSFCT
     C*
     C           WWSFCT    CHAINLB0320S2             99
     C*
     C           DDCRGP    IFEQ *BLANKS
     C*
     C           WWCUFG    IFEQ 'LB'
     C*
     C                     MOVE DD2CUP    DDPOWR
     C                     MOVE DD2CCU    DDCCY
     C*
     C                     ELSE
     C*
     C                     MOVE DD2LBP    DDPOWR
     C                     MOVE DD2LCU    DDCCY
     C*
     C                     END
     C*
     C                     UPDATLB0320S2
     C*
     C                     END
     C*
     C                     END
     C*
     C           WWCUFG    IFEQ 'LB'
     C                     MOVE 'CU'      WWCUFG
     C                     ELSE
     C                     MOVE 'LB'      WWCUFG
     C                     END
     C*
     C                     Z-ADDWWSTRN    SFLRR2
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BC         - This subroutine processes a CMD/12 for previous   *
     C**               screen                                            *
     C**                                                                 *
     C** CALLS       - *NONE                                             *
     C**                                                                 *
     C** CALLED BY   - #B                                                *
     C**                                                                 *
     C********************************************************************
     C           #BC       BEGSR
     C*
     C** Reset CMD/12; Disable CMD/11 CMD/24; Screen 1 & 2 are no
     C** longer valid; Initialize input capable fields.
     C           WWCALL    IFEQ '0'
     C                     MOVE '0'       *INKL
     C                     MOVE '0'       *IN45
     C                     MOVE '0'       *IN49
     C                     MOVE 'N'       WWVLD1
     C                     MOVE 'N'       WWVLD2
     C                     MOVE *BLANKS   DD2LCG
     C                     MOVE *BLANKS   DD1CNS
     C                     ELSE
     C                     MOVE '12'      WWFCTN
     C                     END
     C*
     C** Previous screen is requested
     C                     MOVE 'Y'       WWPRSI
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BD         - This subroutine processes a CMD/23 for Portfolio  *
     C**               Management Enquiries - Extensive Security Checks  *
     C**                                                                 *
     C** CALLS       - ZASNMS QCMDEXC PMC1000 PMC0321 PMC1010 #ZE #BDA   *
     C**                                                                 *
     C** CALLED BY   - #B                                                *
     C**                                                                 *
     C********************************************************************
     C           #BD       BEGSR
     C           WWPROG    IFNE 'PM0630'                                  081239
     C*
     C**  CLEAR MESSAGE QUEUE
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C***CHECK*IF*GROUP*JOB*ACTIVE*OR*NOT***********************   R0121  S01498
     C***********          CALL 'LBC0305A'                         R0121  S01498
     C***********          PARM           GRPJOB 10                R0121  S01498
     C***********GRPJOB    IFNE '*NONE'                            R0121  S01498
     C***********          MOVE '0'       *INKX                    R0121  S01498
     C***********          MOVE '1'       *INKC                    R0121  S01498
     C***********          MOVE 'Y'       WWCHCK                   R0121  S01498
     C***********          ELSE                                    R0121  S01498
     C*
     C** Test for Authority to view enquiries.
     C** Is customer a Portfolio Management Customer,otherwise error.
     C***********WWCNMC    CHAINSDPLCSL0             52                   S01498
     C*
     C                     CALL 'AOPLCSR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWCNMC    P@CUST 10                       S01498
     C           SDPLCS    PARM SDPLCS    DSFDY                           S01498
     C*                                                                   S01498
     C** If record not found or is deleted return error.
     C************IN52     IFEQ '1'                                       S01498
     C***********QBRECI    ORNE 'D'                                       S01498
     C***********QBCHTP    OREQ 'D'                                       S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C********** QBPCUS    ORNE 'Y'                                       S01498
     C                     MOVEL'LBM0068' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE 'N'       WWVLD2
     C                     GOTO #BD0
     C                     END
     C*
     C** For High Level Security continue security checking.
     C***********P9HLVS    IFEQ 'Y'                                       S01498
     C           FCHLVS    IFEQ 'Y'                                       S01498
     C***********WWUPFL    CHAINMUSER                59                   S01498
     C************IN59     IFEQ '1'                                       S01498
     C***********RECI      ORNE 'D'                                       S01498
     C***********CHTP      OREQ 'D'                        ***************S01498
     C*                                                                   S01498
     C** Get user details using access object                             S01498
     C*                                                                   S01498
     C                     CALL 'AOUSERR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWUPFL    P@UPRF 10                       S01498
     C           SDUSER    PARM SDUSER    DSSDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'MUSER   'DBFILE           ** DBERROR 008 S01498
     C                     MOVE 'MUSERDD 'DBFILE           ** DBERROR 008 S01498
     C                     Z-ADD8         DBASE            *****************
     C                     MOVE *BLANKS   DBKEY
     C                     MOVELWWUPFL    DBKEY
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     END
     C*
     C** If user has an account officer check if the a/c officer is
     C** authorised to view customer portfolio details.
     C***********ACOC      IFNE *BLANKS                                   S01498
     C***********ACOC      IFNE '*A'                                      S01498
     C***********ACOC      ANDNEBBACOC                                    S01498
     C***********ACOF      IFNE *BLANKS                             S01498083547
     C***********ACOF      IFNE '*A'                                S01498083547
     C***********ACOF      ANDNEBBACOC                              S01498083547
     C           ACFA      IFNE *BLANKS                                   083547
     C           ACFA      IFNE 'ALL'                                     083547
     C           ACFA      ANDNEBBACOC                                    083547
     C                     MOVEL'LBM0069' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE 'N'       WWVLD2
     C                     GOTO #BD0
     C                     END
     C                     ELSE
     C***********BBACOC    CHAINSDACOFL1             60                   S01498
     C************IN60     IFEQ '1'                                       S01498
     C***********AZTYLC    OREQ 'D'                        ***************S01498
     C*                                                                   S01498
     C** Get account officer details using access object                  S01498
     C*                                                                   S01498
     C                     CALL 'AOACOFR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBACOC    P@ACOC  2                       S01498
     C           SDACOF    PARM SDACOF    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'SDACOFL1'DBFILE           ** DBERROR 009 S01498
     C                     MOVE 'SDACOFPD'DBFILE           ** DBERROR 009 S01498
     C                     Z-ADD9         DBASE            *****************
     C                     MOVE *BLANKS   DBKEY
     C                     MOVELBBACOC    DBKEY
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     END
     C***********AZDPCD    IFNE DEPC                                      S01498
     C           AZDPCD    IFNE DPPT                                      S01498
     C                     MOVEL'LBM0069' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE 'N'       WWVLD2
     C                     GOTO #BD0
     C                     END
     C                     END
     C                     END
     C*
     C** The user is authorised to Portfolio Management Enquiries.
     C***Change*current*job*to*become*a*Group*Job*called*CUSTOMER******   S01498
     C***********          MOVE ARR,1     CMD    80                       S01498
     C***********          Z-ADD80        LEN    155                      S01498
     C***********          CALL 'QCMDEXC'                                 S01498
     C***********          PARM           CMD                             S01498
     C***********          PARM           LEN                             S01498
     C*
     C***Set*up*Group*Data*Area****************************************   S01498
     C*                                                                   S01498
     C** Set up DTAARA/*LDA                                               S01498
     C*                                                                   S01498
     C                     EXSR #BDA
     C*
     C***Write*to*Group*Data*Area**************************************   S01498
     C*
     C**   Write to Local Data Area
     C                     CALL 'PMC1001'
     C                     PARM           WWPLDA
     C*
     C*****Write*to*Group*Data*Area************************************   S01498
     C***********          CALL 'PMC1002'                                 S01498
     C***********          PARM           WWPGDA                          S01498
     C*
     C** Access Portfolio Management Enquiries
     C***********          CALL 'PMC0621'                                 S01498
     C                     CALL 'PM0630'                                  S01498
     C                     PARM           WWUPFL                          S01498
     C*
     C***Access*Group*Data*Area****************************************   S01498
     C*****Retrieve*contents*of*Group*Data*Area*to*check*for*DBERROR***   S01498
     C*****(Nothing*required*from*WWPLDA)******************************   S01498
     C***********          CALL 'PMC1004'                                 S01498
     C***********          PARM           WWPGDA                          S01498
     C*                                                                   S01498
     C** Retrieve contents of DTAARA/*LDA                                 S01498
     C*                                                                   S01498
     C                     CALL 'PMC1003'                                 S01498
     C                     PARM           WWPLDA                          S01498
     C*
     C***If*database*error*condition*exists*load*required*error********   S01498
     C***Information*from**GDA*to*the*LDA******************************   S01498
     C*                                                                   S01498
     C** If database error exists, load information from *LDA             S01498
     C*                                                                   S01498
     C           QMDBER    IFEQ 'Y'
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVELQMPGM     DBPGM            *****************
     C***********          MOVELQMFILE    DBFILE           ** DBERROR xxx S01498
     C                     MOVE QMFILE    DBFILE           ** DBERROR xxx S01498
     C                     Z-ADDQMERRN    DBASE            *****************
     C                     MOVE QMKEY     DBKEY
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C*
     C***Change*current*job*to*become*a*NON-Group*Job******************   S01498
     C***********          MOVE ARR,2     CMD                             S01498
     C***********          CALL 'QCMDEXC'                                 S01498
     C***********          PARM           CMD                             S01498
     C***********          PARM           LEN                             S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C           QMENQT    IFEQ 'Y'
     C                     MOVE '03'      WWFCTN
     C                     MOVE '1'       *INKC
     C*
     C***Change*current*job*to*become*a*NON-Group*Job******************   S01498
     C***********          MOVE ARR,2     CMD                             S01498
     C***********          CALL 'QCMDEXC'                                 S01498
     C***********          PARM           CMD                             S01498
     C***********          PARM           LEN                             S01498
     C                     GOTO #BD0
     C                     END
     C                     END
     C*
     C***Change*current*job*to*become*a*NON-Group*Job******************   S01498
     C***********          MOVE ARR,2     CMD                             S01498
     C***********          CALL 'QCMDEXC'                                 S01498
     C***********          PARM           CMD                             S01498
     C***********          PARM           LEN                             S01498
     C*
     C                     Z-ADDWWSTRN    SFLRR2
     C***********                                                  R0121  S01498
     C***********          END                                     R0121  S01498
     C                     ELSE                                           081239
     C                     CALL 'PMC1003'                                 081239
     C                     PARM           WWPLDA                          081239
     C                     MOVEL'R'       QMENQT                          081239
     C                     CALL 'PMC1001'                                 081239
     C                     PARM           WWPLDA                          081239
     C                     MOVE '1'       *INLR                           081239
     C                     RETRN                                          081239
     C                     END                                            081239
     C*
     C           #BD0      ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BDA        - This subroutine loads the Group Data Area         *
     C**                                                                 *
     C** CALLS       - *NONE                                             *
     C**                                                                 *
     C** CALLED BY   - #BD                                               *
     C**                                                                 *
     C********************************************************************
     C           #BDA      BEGSR
     C                     MOVE ' '       QMRECI
     C                     MOVE BJMRDT    QMRUNA
     C                     Z-ADDBJRDNB    QMRDNB
     C                     MOVE BJCYCD    QMCYCD                          R00266
     C                     MOVE 'T'       QMTVPS
     C                     MOVE BBCUST    QMCNUM
     C                     MOVE BBCRNM    QMCRNM
     C                     MOVE QBCSBY    QMCSBY
     C                     Z-ADDQBBYDP    QMBYDP
     C***********BBCNCZ    CHAINSDCTRYL1             57                   S01498
     C*                                                                   S01498
     C** Get country code details using access object                     S01498
     C*                                                                   S01498
     C                     CALL 'AOCTRYR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBCNCZ    P@CNCZ  2                       S01498
     C           SDCTRY    PARM SDCTRY    DSFDY                           S01498
     C*                                                                   S01498
     C************IN57     IFEQ '0'                                       S01498
     C***********A4TYLC    ANDNE'D'                                       S01498
     C           P@RTCD    IFEQ *BLANKS                                   S01498
     C                     MOVE A4CNNM    QMNCTX
     C                     ELSE
     C                     MOVE *BLANKS   QMNCTX
     C                     END
     C***********BBCOLC    CHAINSDCTRYL1             57                   S01498
     C*                                                                   S01498
     C** Get country code details using access object                     S01498
     C*                                                                   S01498
     C                     CALL 'AOCTRYR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBCOLC    P@CNCZ  2                       S01498
     C           SDCTRY    PARM SDCTRY    DSFDY                           S01498
     C*                                                                   S01498
     C************IN57     IFEQ '0'                                       S01498
     C***********A4TYLC    ANDNE'D'                                       S01498
     C***********          MOVE A4CNNM    QMWADT                          R00266
     C           P@RTCD    IFEQ *BLANKS                                   S01498
     C                     MOVE A4CNNM    QMDCTX                          R00266
     C                     ELSE
     C***********          MOVE *BLANKS   QMWADT                          R00266
     C                     MOVE *BLANKS   QMDCTX                          R00266
     C                     END
     C                     MOVE QBLANG    QMLANG
     C*
     C** DATE OF BIRTH
     C***********          Z-ADDQBBDAT    WWDAT1                          088182
     C***********                                                         088182
     C***********WWMON1    IFGT 0                                         088182
     C***********                                                         088182
     C***********          Z-ADDWWMON1    X       20                      088182
     C***********          Z-ADDWWDAY1    WWDAY2                          088182
     C***********          Z-ADDWWYER1    WWYER2                          088182
     C***********          MOVELZMNM,X    WWMON2                          088182
     C***********                                                         088182
     C***********          MOVE WWDAT2    QMBDA1                          088182
     C***********          ELSE                                           088182
     C***********          MOVEL*BLANKS   QMBDA1                          088182
     C***********          END                                            088182
     C*                                                                   088182
     C** CASE: DB1.Date of Birth (Portfolio) is Zero                      088182
     C*                                                                   088182
     C           QBBDAT    IFEQ *ZERO                                     088182
     C                     MOVEL*BLANKS   QMBDA1                          088182
     C                     ELSE                                           088182
     C*                                                                   088182
     C** CASE: Check File Date - Rundate  *                               088182
     C*                                                                   088182
     C                     Z-ADDQBBDAT    ZDAYNO  50                      088182
     C                     EXSR ZDATE2                                    088182
     C************         MOVELZDATE     QMBDA1                    088182092955
     C                     MOVELZADATE    QMBDA1                          092955
     C                     END                                            088182
     C*
     C                     MOVE BBACOC    QMACOC
     C***********BBACOC    CHAINSDACOFL1             60                   S01498
     C************IN60     IFEQ '0'                                       S01498
     C***********AZTYLC    ANDNE'D'                                       S01498
     C*                                                                   S01498
     C** Get account officer details using access object                  S01498
     C*                                                                   S01498
     C                     CALL 'AOACOFR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBACOC    P@ACOC                          S01498
     C           SDACOF    PARM SDACOF    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFEQ *BLANKS                                   S01498
     C                     MOVE AZACON    QMACON
     C                     ELSE
     C                     MOVE *BLANKS   QMACON
     C                     END
     C*
     C**   Date account officer assumed
     C****                 Z-ADDQBDASS    ZDAYNO                          S01313
     C****                 EXSR ZDATE2                                    S01313
     C****                 MOVE ZADATE    QMDTA1                          S01313
     C*
     C                     MOVE QBSAFI    QMSAFI
     C                     MOVE QBDCMS    QMDCMS
     C****                 MOVE QBFPVC    QMFPVC                          S01313
     C                     MOVE *BLANKS   QMPTF1
     C                     MOVE *BLANKS   QMPTF2
     C                     MOVE *BLANKS   QMPTFN
     C                     MOVE *BLANKS   QMTPMV
     C                     MOVE *BLANKS   QMVPMV
     C***********          MOVE *BLANKS   QMPTA1                          R00266
     C                     MOVE *BLANKS   QMPTAI                          R00266
     C                     MOVE *BLANKS   QMPVAI                          R00266
     C                     MOVE *BLANKS   QMPTCY
     C                     Z-ADD*ZEROS    QMPCDP
     C                     MOVE *BLANKS   QMPTFT
     C                     MOVE *BLANKS   QMDPO1
     C                     MOVE *BLANKS   QMPPDG
     C                     MOVE *BLANKS   QMDSPG
     C                     MOVE *BLANKS   QMNDSP
     C                     MOVE *BLANKS   QMDSPT
     C                     Z-ADD*ZEROS    QMDSPS
     C                     MOVE *BLANKS   QMDGMV
     C                     MOVE *BLANKS   QMDGAI
     C                     MOVE *BLANKS   QMINNR
     C                     MOVE *BLANKS   QMISTN
     C                     Z-ADD*ZEROS    QMITDS
     C                     MOVE *BLANKS   QMTIMV
     C                     MOVE *BLANKS   QMVIMV
     C                     MOVE *BLANKS   QMITAI
     C                     MOVE *BLANKS   QMIVAI                          R00266
     C                     MOVE *BLANKS   QMMODI
     C                     MOVE *BLANKS   QMSESN
     C**********           Z-ADD*ZEROS    QMTRNB                                              CLE148
     C                     MOVEL*BLANKS   QMTRNB                                              CLE148
     C***********          MOVE 'N'       QMENQT                          R00266
     C***********          MOVE 'N'       QMDBER                          R00266
     C                     MOVE *BLANKS   QMENQT                          R00266
     C                     MOVE *BLANKS   QMDBER                          R00266
     C                     MOVE 'N'       QMATTN
     C                     MOVE *BLANKS   QMPGM
     C                     MOVE *BLANKS   QMFILE
     C                     MOVE *BLANKS   QMKEY
     C                     Z-ADD*ZEROS    QMERRN
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BE         - This subroutine processes a CMD/24 for Portfolio  *
     C**               Management Documentation                          *
     C**                                                                 *
     C** CALLS       - #ZE PM0160 Y2CLMSC                                *
     C**                                                                 *
     C** CALLED BY   - #B                                                *
     C**                                                                 *
     C********************************************************************
     C           #BE       BEGSR
     C*
     C**  CLEAR MESSAGE QUEUE
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C                     MOVE '1'       *IN50
     C                     MOVE '0'       WWRTCD
     C                     MOVE WWCNMC    WWPNP8
     C***********          UNLCKDTAR                                      S01498
     C                     UNLCKLDA                                       S01498
     C*********************CALL 'PM0160'                                  R0119
     C                     CALL 'PMC0160'                                 R0119
     C                     PARM           WWACTN
     C                     PARM           WWRTCD
     C                     PARM           WWPNP8
     C                     PARM           WWFNMO
     C*
     C** If errors in called program , return to point of call
     C************LOCK     IN   DTAR                                      S01498
     C           *LOCK     IN   LDA                                       S01498
     C           DBASE     IFGT 0
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     MOVEL'LB0320'  DBPGM
     C                     END
     C           WWRTCD    IFEQ '1'
     C                     MOVE '03'      WWFCTN
     C                     MOVE '1'       *INKC
     C                     ELSE
     C                     Z-ADDWWSTRN    SFLRR2
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZD         - This subroutine retrieves currency details for    *
     C**               customer currency                                 *
     C**                                                                 *
     C** CALLS       - #ZE                                               *
     C**                                                                 *
     C** CALLED BY   - #AA #B                                            *
     C**                                                                 *
     C********************************************************************
     C           #ZD       BEGSR
     C*
     C***********CUCCY     CHAINSDCURRL1             99                   S01498
     C*
     C************IN99     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get currency details using access object                         S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM CUCCY     P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBKEY            *****************
     C***********          MOVEL'SDCURRL1'DBFILE           ** DBERROR 003 S01498
     C                     MOVE 'SDCURRPD'DBFILE           ** DBERROR 003 S01498
     C                     MOVELCUCCY     DBKEY            *****************
     C                     Z-ADD3         DBASE
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     Z-ADD0         WWDICU  40
     C           A6NBDP    IFEQ 1
     C                     Z-ADD10        WWDICU
     C                     END
     C           A6NBDP    IFEQ 2
     C                     Z-ADD100       WWDICU
     C                     END
     C           A6NBDP    IFEQ 3
     C                     Z-ADD1000      WWDICU
     C                     END
     C*
     C                     Z-ADDA6SPRT    WWSRO
     C                     Z-ADDA6NBDP    WWDPO
     C                     MOVE A6MDIN    WWMDO
     C                     END
     C*
     C** Store Portfolio Credit Currency and customer currency
     C***********          MOVE LBCCY     DD2LCU                          S01498
     C                     MOVE LBCYCD    DD2LCU                          S01498
     C                     MOVE CUCCY     DD2CCU
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZE         - This subroutine calls 'PM0160'                    *
     C**                                                                 *
     C** CALLS       - PM0160                                            *
     C**                                                                 *
     C** CALLED BY   - MAINLINE,#BD,#BE,#ZC,#ZD                          *
     C**                                                                 *
     C********************************************************************
     C*
     C           #ZE       BEGSR
     C           *IN50     IFEQ '1'
     C*
     C** Save WWLDA fields to restore DBERROR after this call
     C                     MOVE DBFILE    WWDBF2  8
     C                     MOVE DBKEY     WWDBK2 29
     C                     MOVE DBPGM     WWDBP2 10
     C                     Z-ADDDBASE     WWDBS2  30
     C*
     C** Call 'PM0160' if already called once during execution of program
     C                     MOVE '9'       WWRTCD  1
     C                     MOVE *BLANKS   WWPNP8  6
     C***********          UNLCKDTAR                                      S01498
     C                     UNLCKLDA                                       S01498
     C*********************CALL 'PM0160'                                  R0119
     C                     CALL 'PMC0160'                                 R0119
     C                     PARM           WWACTN
     C                     PARM           WWRTCD
     C                     PARM           WWPNP8
     C                     PARM           WWFNMO
     C*
     C************LOCK     IN   DTAR                                      S01498
     C           *LOCK     IN   LDA                                       S01498
     C*
     C** If a database error was NOT already detected then check for one
     C** in PM0160 now...
     C           WWDBS2    IFEQ 0
     C*
     C** If database error in PM0160
     C           DBASE     IFGT 0
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     END
     C*
     C                     ELSE
     C*
     C** Else restore previous DBERROR
     C                     MOVE WWDBF2    DBFILE
     C                     MOVE WWDBK2    DBKEY
     C                     MOVE WWDBP2    DBPGM
     C                     Z-ADDWWDBS2    DBASE
     C                     END
     C*
     C                     END
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** ZSEDIT      - Convert a decimal amount to character             *
     C**                                                                 *
     C** CALLS       - *NONE                                             *
     C**                                                                 *
     C** CALLED BY   - #ZC                                               *
     C**                                                                 *
     C/COPY ZSRSRC,ZSEDITZ3                                              *
     C/EJECT
     C/COPY ZSRSRC,ZDATE2Z2
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** SCONV       - Convert an amount from one currency to another
     C**                                                                 *
     C** CALLS       - *NONE                                             *
     C**                                                                 *
     C** CALLED BY   - #ZC                                               *
     C**                                                                 *
     C**  Input Fields - WWAMTI 15/0 amount in input currency            *
     C**                 WWSRI  13/8 spot rate for input currency        *
     C**                 WWSRO  13/8 spot rate for output currency       *
     C**                 WWDPI  1/0  no. of decimals for input currency  *
     C**                 WWDPO  1/0  no. of decimals for output currency *
     C**                 WWMDI  1    mult/div indicator for input curr.  *
     C**                 WWMDO  1    mult/div indicator for output curr. *
     C**                                                                 *
     C**  Arrays       - POWER  powers of 10                             *
     C**                                                                 *
     C**  Output Fields- WWAMTO 15/0 output amount converted to new curr *
     C**                                                                 *
     C********************************************************************
     C           SCONV     BEGSR                           **  SCONV    **
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDWWAMTI    WWAMTI 150
     C                     Z-ADD0         WWAMTO 150
     C           *LIKE     DEFN A6SPRT    WWSRI
     C           *LIKE     DEFN A6SPRT    WWSRO
     C           *LIKE     DEFN A6NBDP    WWDPI
     C           *LIKE     DEFN A6NBDP    WWDPO
     C           *LIKE     DEFN A6MDIN    WWMDI
     C           *LIKE     DEFN A6MDIN    WWMDO
     C*
     C           WWDPO     SUB  WWDPI     Z       10
     C           Z         ADD  4         Z
     C*
     C           WWMDI     IFNE WWMDO
     C*
     C** MULT/DIV INDICATORS DIFFERENT
     C           WWSRI     MULT WWSRO     WWRATE 159H
     C                     ELSE
     C*
     C** MULT/DIV INDICATORS THE SAME
     C           WWSRO     IFEQ 0
     C                     GOTO SC0
     C                     END
     C           WWSRI     DIV  WWSRO     WWRATE    H
     C                     END
     C*
     C           WWMDI     IFEQ 'D'
     C           WWRATE    IFEQ 0
     C                     GOTO SC0
     C                     END
     C           POWER,Z   DIV  WWRATE    WWRATE    H
     C                     ELSE
     C           POWER,Z   MULT WWRATE    WWRATE    H
     C                     END
     C*
     C           WWAMTI    MULT WWRATE    WWAMTO    H
     C*
     C           SC0       ENDSR                           **  SC0      **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** ZASNMS    - Send message to program's message queue             *
     C**                                                                 *
     C** CALLS     - Y2SNMGC                                             *
     C**                                                                 *
     C** CALLED BY - #BA #BD #B                                          *
     C**                                                                 *
     C********************************************************************
     C           ZASNMS    BEGSR                           ** ZASNMS    **
     C*
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGM  10
     C                     PARM           ZAPGRL  5
     C                     PARM           ZAMSID  7
     C                     PARM           ZAMSGF 10
     C                     PARM           ZAMSDA132
     C                     PARM           ZAMSTP  7
     C*
     C                     ENDSR
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #A          - This subroutine performs the initial processing   *
     C**                                                                 *
     C** CALLS       - #AA                                               *
     C**                                                                 *
     C** CALLED BY   - MAINLINE                                          *
     C**                                                                 *
     C********************************************************************
     C*
     C           #A        BEGSR
     C**                                                                  081239
     C                     CALL 'PMC1003'                                 081239
     C                     PARM           WWPLDA                          081239
     C                     MOVE QMCPGM    WWPROG  6                       081239
     C*
     C** Define LDA for use in program
     C** -----------------------------
     C************NAMVAR   DEFN LDA       DTAR                            S01498
     C           *NAMVAR   DEFN           LDA                             S01498
     C*
     C** Define KEY LISTS
     C** ----------------
     C           KLIST1    KLIST
     C                     KFLD           WWCNMB
     C                     KFLD           DD2LCG
     C           KLIST2    KLIST
     C                     KFLD           WWCNMC
     C                     KFLD           DD2LCG
     C           KLIST3    KLIST
     C                     KFLD           WWCNMB
     C                     KFLD           EELCGS
     C                     KFLD           EELCGR
     C           KLIST4    KLIST
     C                     KFLD           WWCNMC
     C                     KFLD           EELCGS
     C                     KFLD           EELCGR
     C*
     C                     MOVE '0'       *IN41
     C*
     C** Initialize Database Error Fields
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVEL'LB0320'  DBPGM
     C                     Z-ADD0         DBASE
     C                     OUT  LDA                                       S01498
     C*
     C** Initialize WORK Fields
     C                     MOVE 'E'       WWACTN  1
     C                     MOVE 'I'       WWFNMO  1
     C           *LIKE     DEFN EELCGR    WWLCGR
     C           *LIKE     DEFN EEBPWR    WWBPWR
     C           *LIKE     DEFN EECLPC    WWCLPX
     C           *LIKE     DEFN EECLPC    WWBOPP
     C*
     C** Initialize MESSAGE FILE NAME
     C**   Fill in fields for subroutine ZASNMS                           R00300
     C                     MOVEL*BLANK    ZAPGM  10        Message queue  R00300
     C                     MOVE *BLANKS   ZAMSGF                          R00300
     C*********************MOVEL'LXGBMSGF'ZAMSGF                          R00300
     C                     MOVEL'LBUSRMSG'ZAMSGF 10        Message file   R00300
     C                     MOVEL*BLANK    ZAPGRL  5        Rel queue      R00300
     C                     MOVEL*BLANK    ZAMSID  7        Message Id.    R00300
     C                     MOVEL*BLANK    ZAMSDA132        Message data.  R00300
     C                     MOVEL*BLANK    ZAMSTP  7        Message type.  R00300
     C*
     C***Read*the*record*on*the*bank*details*file**********************   S01498
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 99               S01498
     C*
     C************IN99     IFEQ '1'                                       S01498
     C***********BJTYLC    OREQ 'D'                        ***************S01498
     C*                                                                   S01498
     C** Get bank details using access object                             S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM *BLANKS   P@RTCD  7                       S01498
     C                     PARM '*FIRST ' P@OPTN  7                       S01498
     C           SDBANK    PARM SDBANK    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'SDBANKPD'DBFILE           ** DBERROR 001 S01498
     C                     MOVE 'SDBANKPD'DBFILE           ** DBERROR 001 S01498
     C                     Z-ADD1         DBASE            *****************
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     RETRN
     C                     END
     C*                                                                   S01498
     C**  Rundate in DDMMMYY format                                       S01498
     C*                                                                   S01498
     C                     MOVE BJMRDT    SRUNA                           S01498
     C*
     C** Set up indicator 98 for ZDATE S/R's as per BJFKST
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ELSE
     C                     MOVE '0'       *IN98
     C                     END
     C*
     C***Read*the*record*on*the*Portfolio*credit*installation*control*dataS01498
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 99               S01498
     C*
     C************IN99     IFEQ '1'                                       S01498
     C***********LBRECI    OREQ '*'                        ***************S01498
     C*                                                                   S01498
     C** Get Portfolio Lending details using access object                S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST ' P@OPTN                          S01498
     C           SDLOMB    PARM SDLOMB    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'SDLOMBPD'DBFILE           ** DBERROR 002 S01498
     C                     MOVE 'SDLOMBPD'DBFILE           ** DBERROR 002 S01498
     C                     Z-ADD2         DBASE            *****************
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     RETRN
     C                     END
     C*
     C** Find the number of decimal places for the Portfolio base currency
     C***********LBCCY     CHAINSDCURRL1             99                   S01498
     C*
     C************IN99     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                        ***************S01498
     C*                                                                   S01498
     C** Get currency details using access object                         S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM LBCYCD    P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'SDCURRL1'DBFILE           ** DBERROR 003 S01498
     C                     MOVE 'SDCURRPD'DBFILE           ** DBERROR 003 S01498
     C                     MOVE *BLANKS   DBKEY            *****************
     C***********          MOVELLBCCY     DBKEY                           S01498
     C                     MOVELLBCYCD    DBKEY                           S01498
     C                     Z-ADD3         DBASE
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     RETRN
     C                     ELSE
     C*
     C** Store LB currency details
     C                     Z-ADDA6NBDP    WWLBDP  10
     C                     Z-ADD0         WWDILB  40
     C           A6NBDP    IFEQ 1
     C                     Z-ADD10        WWDILB
     C                     END
     C           A6NBDP    IFEQ 2
     C                     Z-ADD100       WWDILB
     C                     END
     C           A6NBDP    IFEQ 3
     C                     Z-ADD1000      WWDILB
     C                     END
     C                     END
     C*
     C                     Z-ADDA6SPRT    WWSRI
     C                     Z-ADDA6NBDP    WWDPI
     C                     MOVE A6MDIN    WWMDI
     C*
     C** Check if Portfolio Management is installed
     C***********1         SETLLSDMMODPD                           001298 S01498
     C***********          READ SDMMODPD                 99               S01498
     C*
     C************IN99     IFEQ '1'                                       S01498
     C***********BGTYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get Midas Modules details using access object                    S01498
     C*                                                                   S01498
     C                     CALL 'AOMMODR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST ' P@OPTN                          S01498
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE           *****************
     C***********          MOVEL'SDMMODPD'DBFILE           ** DBERROR 004 S01498
     C                     MOVE 'SDMMODPD'DBFILE           ** DBERROR 004 S01498
     C                     MOVE *BLANKS   DBKEY            *****************
     C                     Z-ADD4         DBASE
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     RETRN
     C                     END
     C           BGPFMG    IFEQ 'Y'
     C                     MOVE '1'       *IN41
     C                     END
     C*
     C***Read*the*record*on*Portfolio*Management*ICD*******************   S01498
     C***********1         SETLLSDPORTPD                           LB0000 S01498
     C***********          READ SDPORTPD                 58               S01498
     C*
     C************IN58     IFEQ '1'                                       S01498
     C*                                                                   S01498
     C** Get Portfolio Management ICD details using access object         S01498
     C*                                                                   S01498
     C                     CALL 'AOPORTR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST ' P@OPTN                          S01498
     C           SDPORT    PARM SDPORT    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'SDPORTPD'DBFILE           ***************S01498
     C                     MOVE 'SDPORTPD'DBFILE           ***************S01498
     C                     MOVE *BLANKS   DBKEY            ** DBERROR 007 **
     C                     Z-ADD7         DBASE            *****************
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     END
     C*
     C** Initialise the SUBFILE message queue
     C                     MOVE *BLANKS   DDPGMQ
     C                     MOVEL'*'       DDPGMQ
     C*
     C** Initialise and clear the program message queue
     C                     MOVE *BLANKS   WWTPGQ
     C                     MOVEL'*'       WWTPGQ
     C                     MOVE *BLANKS   WWPGQR
     C                     MOVEL'*PRV'    WWPGQR
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C                     MOVE '1'       *IN26
     C*
     C** Clear the input screen 2 subfile
     C                     MOVE '1'       *IN30
     C                     WRITELB0320C2
     C                     MOVE '0'       *IN30
     C*
     C** Initialise work fields and indicators
     C                     Z-ADD0         LSTRR2  40
     C                     MOVE *BLANKS   DD1CNS
     C                     MOVE 'N'       WWVLD1  1
     C                     MOVE 'Y'       WWVLD2  1
     C                     MOVE '0'       *IN33
     C                     MOVE '0'       *IN36
     C                     MOVE '0'       *IN37
     C                     MOVE '0'       *IN45
     C                     MOVE '0'       *IN49
     C                     MOVE '0'       *IN62
     C                     MOVE '1'       *IN28
     C                     MOVE '1'       *IN29
     C*
     C** Set currency flag to 'LB' and output currency to Portfolio Credit Ccy
     C                     MOVE 'LB'      WWCUFG  2
     C***********          MOVE LBCCY     DDCCY                           S01498
     C                     MOVE LBCYCD    DDCCY                           S01498
     C*
     C                     MOVE 'J'       ZECODE
     C                     Z-ADD0         ZDECS
     C*
     C** Validate customer no. if progam called from another program
     C           WWCALL    IFEQ '1'
     C                     EXSR #AA
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #B          - This subroutine performs the main processing      *
     C**                                                                 *
     C** CALLS       - #BA #BB #BC #BD #BE #BF #ZA #ZB LB0340 #ZD #ZE #BG*
     C**                                                                 *
     C** CALLED BY   - MAINLINE                                          *
     C**                                                                 *
     C********************************************************************
     C           #B        BEGSR
     C*
     C** Process until a termination request
     C           *INKC     DOWEQ'0'
     C           *INKL     ANDEQ'0'
     C*
     C** If the program was called from another program then skip the
     C** screen 1 processing and process screen 2 immediately
     C           WWCALL    IFEQ '0'
     C*
     C** Process screen 1 until a termination request or valid screen
     C           *INKC     DOWEQ'0'
     C           WWVLD1    ANDEQ'N'
     C*
     C** Write Screen 1
     C                     WRITELB0320F1
     C*
     C** If error on screen 1 write error message subfile
     C           *IN33     IFEQ '1'
     C                     WRITELB0320C3
     C                     END
     C*
     C** Read Screen 1
     C                     READ LB0320F1                 99
     C*
     C** Process if CMD/3 not pressed
     C           *INKC     IFEQ '0'
     C                     EXSR #BA                        Enter
     C*
     C** If valid input on screen 1 , but customer not found or was
     C** input as blanks then CALL customer enquiry program.
     C           *IN33     IFEQ '0'
     C           *IN35     IFEQ '0'
     C           DD1CNS    OREQ *BLANKS
     C                     MOVE '1'       WWPRM1  1
     C                     MOVE DD1CNS    WWPRM2 10
     C**********           Z-ADD*ZEROS    WWPRM3  60                                          CSD027
     C                     MOVE *BLANKS   WWPRM3  6                                           CSD027
     C                     MOVE *BLANKS   WWPRM4  2
     C***********          UNLCKDTAR                                      S01498
     C                     UNLCKLDA                                       S01498
     C                     CALL 'LB0340'
     C                     PARM           WWPRM1
     C                     PARM           WWPRM2
     C                     PARM           WWPRM3
     C                     PARM           WWPRM4
     C************LOCK     IN   DTAR                                      S01498
     C           *LOCK     IN   LDA                                       S01498
     C*
     C** If errors in called program , return to point of call
     C           DBASE     IFGT 0
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     MOVEL'LB0320'  DBPGM
     C                     END
     C           WWPRM4    IFEQ '03'
     C                     MOVE '1'       *INKC
     C                     GOTO #B0
     C                     ELSE
     C********** WWPRM3    IFNE *ZEROS                                                        CSD027
     C           WWPRM3    IFNE *BLANKS                                                       CSD027
     C           WWPRM4    ANDNE'12'
     C                     MOVE *BLANKS   DD1CNS
     C                     MOVELWWPRM3    DD1CNS
     C                     MOVE '1'       *IN36
     C                     MOVE '0'       *IN37
     C                     ELSE
     C                     MOVE *BLANKS   DD1CNS
     C                     GOTO #B0
     C                     END
     C                     END
     C                     END
     C*
     C                     MOVE '0'       *IN38
     C                     MOVE '0'       *IN39
     C*
     C** If customer number available retrieve customer details ----
     C           *IN36     IFEQ '1'
     C***********DD1CNO    CHAINSDLBCSL0             38                   S01498
     C           DD1CNO    CHAINLBLBCSJ0             38                   S01498
     C                     ELSE
     C*
     C** Else , use customer shortname.
     C           *IN37     IFEQ '1'
     C***********DD1CNS    CHAINSDLBCSL5             39                   S01498
     C           DD1CNS    CHAINLBLBCSJ5             39                   S01498
     C                     END
     C                     END
     C*
     C** If record not found or is deleted return error.
     C           *IN38     IFEQ '1'
     C           *IN39     OREQ '1'
     C           BBTYLC    OREQ 'D'
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN33
     C                     GOTO #B0
     C                     END
     C*
     C** Validation successful
     C                     MOVE 'Y'       WWVLD1
     C*
     C** Save number of requested customer
     C                     MOVE BBCUST    WWCNMC
     C*
     C** Retrieve currency details for customer currency
     C                     EXSR #ZD
     C*
     C** Clear the input screen 2 subfile
     C                     MOVE '1'       *IN30
     C                     MOVELWWPRM3    DD1CNS                          LB0000
     C                     WRITELB0320F1                                  LB0000
     C                     WRITELB0320C2
     C                     MOVE '0'       *IN30
     C*
     C** Initialize display field
     C                     MOVE *BLANKS   DD1CNS
     C*
     C           #B0       TAG
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C** Enable CMD/11 CMD/12 CMD/23 AND CMD/24(only if PM installed)
     C                     MOVE '1'       *IN45
     C           *IN41     IFEQ '1'
     C                     MOVE '1'       *IN49
     C                     END
     C*
     C** Initialize display fields
     C                     Z-ADD0         LSTRR2
     C                     MOVE *BLANKS   DD2LCG
     C                     MOVE 'LB'      WWCUFG
     C***********          MOVE LBCCY     DDCCY                           S01498
     C                     MOVE LBCYCD    DDCCY                           S01498
     C*
     C** Initialize work field for group code and previous screen request.
     C** Load the first page of records to the subfile if CMD/3 not taken
     C           *INKC     IFEQ '0'
     C                     MOVE *BLANKS   WWLCGR
     C                     MOVE '0'       *IN47
     C                     MOVE 'N'       WWPRSI  1
     C           BBPAIN    IFEQ 'P'
     C           WWCNMC    SETLLLBEXTRL7
     C                     READ LBEXTRL7                 51
     C                     EXSR #ZB
     C                     ELSE
     C           WWCNMB    SETLLLBEXTRL4
     C                     READ LBEXTRL4                 61
     C                     EXSR #ZA
     C                     END
     C                     END
     C*
     C** Process screen 2 until a termination request
     C           *INKC     DOWEQ'0'
     C           WWPRSI    ANDEQ'N'
     C*
     C** Write screen 2 headings
     C                     WRITELB0320H2
     C*
     C** If there are details for customer write subfile control -------
     C           *IN42     IFEQ '0'
     C                     MOVE '1'       *IN28
     C                     ELSE
     C                     MOVE '0'       *IN28
     C                     END
     C                     WRITELB0320C2
     C*
     C** otherwise , write NO DETAILS message
     C           *IN42     IFEQ '1'
     C                     MOVEL'LBM0049' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE 'N'       WWVLD2
     C                     MOVE '0'       *IN49
     C                     END
     C*
     C** Write error message subfile if screen 2 is not valid
     C           WWVLD2    IFEQ 'N'
     C                     WRITELB0320C3
     C                     END
     C*
     C** Read screen 2
     C                     READ LB0320C2                 99
     C*
     C** Store relative record number of subfile
     C           $1DSRN    IFEQ 0
     C                     Z-ADDSFLRR2    WWSTRN  40
     C                     ELSE
     C                     Z-ADD$1DSRN    WWSTRN
     C                     END
     C*
     C           *INKC     IFEQ '0'
     C*
     C           *IN27     CASEQ'1'       #BG              Rollup
     C           *INKK     CASEQ'1'       #BB              CMD/11
     C           *INKL     CASEQ'1'       #BC              CMD/12
     C           *INKX     CASEQ'1'       #BD              CMD/23
     C           *INKY     CASEQ'1'       #BE              CMD/24
     C                     CAS            #BF              Enter
     C                     END
     C                     ELSE
     C           WWCALL    IFEQ '1'
     C                     MOVE '03'      WWFCTN
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** *PSSR       - This subroutine processes a program file error    *
     C**                                                                 *
     C** CALLS       - *NONE                                             *
     C**                                                                 *
     C** CALLED BY   - *NONE                                             *
     C**                                                                 *
     C********************************************************************
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C                     ENDSR
     C/EJECT
      *                                                                   S01498
      ** Array ARR physically removed from compile-time array             S01498
      *                                                                   S01498
     ** NUM   - Array of numbers          REMOVED BY CSD027                                   CSD027
     ** 0123456789                                                                            CSD027
**   CPY@
(c) Misys International Banking Systems Ltd. 2001
** Array of powers of 10 for currency conversion S/R SCONV
0000001
0000010
0000100
0001000
0010000
0100000
1000000
** ALPHU - Array of alphanumerics A-Z, BLANK & 0-9
ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
