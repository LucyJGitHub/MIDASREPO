     H        1                                                           S01498
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Borrowing Power Weightings Enquiry')          *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                             *
     F*                                                               *
     F*  LB0330 - Borrowing Power Weightings Enquiry                  *
     F*                                                               *
     F*  Called By: LBC0330 - Borrowing Power Weightings Enquiry      *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *  Prev Amend No. CRE026             Date 24May06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3644            Date 12Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 TDA035             Date 02Apr04               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CGL008             Date 03Mar99               *
      *                 CPM005             Date 14Oct96               *
      *                 092955             Date 13Sep95               *
     F*                 088182             DATE 06SEP95               *
     F*                 087380             DATE 10MAY95               *
     F*                 085817             DATE 13MAR95               *
     F*                 S01498             DATE 11AUG94               *
     F*                 B8227              DATE 10SEP91               *
     F*                 049421             DATE 19JAN93               *
     F*                 S01313             DATE 27AUG92               *
     F*                 B4645 DT           DATE 24SEP91               *
     F*                 B7974 PDU          DATE 17JUN91               *
     F*                 R00300             DATE 20AUG90               *
     F*                 R00266             DATE 08AUG90               *
     F*                 LB0001             DATE 09JUL90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CLE148 - Alpha Loan Reference                                *
      *  CRE026 - Consumer Banking (Recompile)                        *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3644 - Serious Error in Collateralised Lending (Recompile)*
      *  CLE025 - Credit Lines (Recompile)                            *
      *  TDA035 - RTS Signon changes for MidasPlus. (Recompile)       *
      *  CGL008 - Security on Journal Entry. Recompile.               *
     F*  CPM005 - Private Banking Phase 2                             *
     F*           Focus Group Changes upgraded to DBA                 *
     F*           Recompiled due to changes in PMLDAPD                *
     F*  092955 - Complete 088182 to output birth date as 7A          *
     F*  088182 - CORRECT FORMATTING OF DATE OF BIRTH                 *
     F*  087380 - Enlarge parameter for AOUSERR0                      *
     F*  085817 - Recompile due to changes in PMLDAPD                 *
     F*  S01498 - Portfolio Lending Upgrade to Release 10             *
     F*  B8227  - Enhancement on report.                              *
     F*  049421 - HEADER BOX STANDARDISATION                          *
     F*  S01313 - CHANGES FOR PORTFOLIO PERFORMANCE                   *
     F*  B4645  - SECURITY TITLE NOT FOUND                            *
     F*  B7974  - NO POSSIBLE ROLLUP .                                *
     F*  R00300 - Message file changes                                *
     F*  R00266 - SETUP CORRECT FIELDS ON DATA AREA PMLDAPP.          *
     F*           CHANGE LB0001 TO CLEAR THE MESSAGE SUBFILE          *
     F*           AFTER DISPLAYING THE SCREEN.                        *
     F*  LB0001 - XH/JG FIX.                                          *
     F*                                                               *
     F*****************************************************************
     F**                                                              *
     F** C R E A T I O N     P A R A M E T E R S                      *
     F**                                                              *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**
     F** FILE DEFINITIONS
     F** ----------------
     F*
     F***Midas*Modules*Present?*-*Prefix*BG****************************   S01498
     F***SDMMODPDIF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Bank*Details*File*-*Prefix*BJ*********************************   S01498
     F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F** Client Master file - Prefix BB & CU   (Customer Number)
     F***SDLBCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ0IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F** Client Master File - Prefix BB & CU   (Shortname)
     F***SDLBCSL5IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ5IF  E           K        DISK         KINFSR *PSSR          S01498
     F            SDLBCSJ0                          KRENAMESDLBCSJ5
     F*
     F***Midas*User*Definition*-*Prefix**NONE**************************   S01498
     F***MUSER***IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Account*Officers******-*Prefix*AZ*****************************   S01498
     F***SDACOFL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Portfolio*Management*Customer*Details*-**Prefix*QB************   S01498
     F***SDPLCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Portfolio*Management*I.C.D*-**Prefix*P9***********************   S01498
     F***SDPORTPDIF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** Borrowing Power File  - Prefix BP
     FLBBPWRL1IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD1
     F*
     F** Borrowing Power File - Prefix BP
     FLBBPWRL2IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD2
     F*
     F** Borrowing Power File - Prefix BP
     FLBBPWRL3IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD3
     F*
     F** Borrowing Power File - Prefix BP
     FLBBPWRL4IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD4
     F*
     F** Borrowing Power File - Prefix BP
     FLBBPWRL5IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD5
     F*
     F***Instrument*Types*File*-*Prefix*PD*****************************   S01498
     F***SDPLINL4IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** Securities File - No Prefix
     FSECTY   IF  E           K        DISK         KINFSR *PSSR
     F*
     F***Country*Codes*File*-*Prefix*A4********************************   S01498
     F***SDCTRYL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Country*Codes*File*-*Prefix*A4********************************   S01498
     F***SDCTRYL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** Enquiry screens
     FLB0330DFCF  E                    WORKSTN      KINFDS L330DS
     F                                        RRN   KSFILE LB0330S2
     F                                        RRN1  KSFILE LB0330S3
     F                                        RRN2  KSFILE LB0330S4
     F                                        RRN3  KSFILE LB0330S5
     F                                        RRN4  KSFILE LB0330S6
     F                                        RRN5  KSFILE LB0330S8
     F                                        RRN6  KSFILE LB0330S9
     F                                              KINFSR *PSSR
     F*
     F********************************************************************
     F/EJECT
     F*****************************************************************
     F** ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F**                                                              *
     F**      20          File error indicator                        *
     F**      40          Inner Loop Control                          *
     F**      44          File error indicator                        *
     F**      99          Edit error                                  *
     F**      69          File error on SETLL                         *
     F**      70          Record Found on SETLL                       *
     F**      71          Record Found on SETLL                       *
     F**      72          File error on CHAIN                         *
     F********75**********File*error*on*CHAIN**************************   S01498
     F**                                                              *
     F**      38          F24 Documentation                           *
     F**      41          F12 Previous screen                         *
     F**      73          F23 Portfolio Details Enquiry               *
     F**      74          PM0160 called during execution of program   *
     F**                                                              *
     F**           Screen 1 validation                                *
     F**           ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯                                *
     F**      21          At Least one selection is required          *
     F**      22          Invalid Combination - Customer/Country      *
     F**      23          Invalid Combination - Instrument/Country    *
     F**      24          Invalid Combination - Security/Country      *
     F**      25          Invalid Combination - Security/Instrument   *
     F**                                                              *
     F**      27          Invalid customer number/Customer beyond Eof *
     F**      28          Customer number available(entered or Lb0340)*
     F**      46          At least 1 instr. type must exist for cust. *
     F**      47          At least 1 security must exist for customer *
     F**      29          Inst entered after last on file             *
     F**      30          Security entered after last on file         *
     F**      31          Country entered beyond end of file          *
     F**      32          Found on lookup on array                    *
     F**      26          Sflend                                      *
     F**                                                              *
     F**           Subfile screens                                    *
     F**           ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯                                    *
     F**      33          Sfldsp                                      *
     F**      34          Sflend                                      *
     F**      35          Sfldspctl                                   *
     F**      36          Sflclr                                      *
     F**      37          End of Subfile on Write(subfile)            *
     F**      39          Rollup                                      *
     F**      42          Sflend                                      *
     F**      45          Non dsp % If eq *zeros                      *
     F**                                                              *
     F**      98          Required for Copy                           *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     E*
     E** Array for COPYRIGHT
     E                    CPY@    1   1 80
     E*
     E** Array of ALPHANUMERICS
     E                    ALPNU  37  37  1
     E*
     E** Array of NUMBERS                                                                     CSD027
     E**********          NUM    10  10  1                                                    CSD027
     E*
     E***Array*of*commands*********************************************   S01498
     E********************ARR     1   2 80                                S01498
     E*
     E** Array for CUST NO / SHORTNAME FIELD
     E                    INP        10  1
     E*****************************************************************
     E/COPY ZSRSRC,ZDATE2Z1
     E*****************************************************************
     E/EJECT
     I*
     I**   Rename fields on LBBPWRL2
     ILBBPWRD2
     I              BPCNUM                          BPCNUR
     I              BPINST                          BPINSR
     I              BPINPC                          BPINPR
     I              BPSESN                          BPSESR
     I              BPSEPC                          BPSEPR
     I              BPREVD                          BPREVR
     I              BPREVF                          BPREFR
     I              BPREVN                          BPRENR
     E/EJECT
     I********************************************************************
     I*
     I** Data structure for compilation - Copyright Insertion
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*
     I** Display file information data structure
     I* POST - position of cursor on screen; required when displaying
     I*        2 subfiles on the screen. Used to determine which Sfl to
     I*        rollup.
     I* SFLL - current rrn for subfiles displays
     I*
     IL330DS      DS
     I                                    B 370 3710POST
     I                                    B 378 3790SFLL
     I*
     I** Data structure to split customer no./shortname
     IWWCNDS      DS
     I                                        1  10 DDPNP8
     I                                        1  10 INP
     I                                        7  10 WWL4
     I*
     I***Data*structure*to*define*the*group*data*area******************   S01498
     I***WWPGDA****E*DSPMGRDAPP***************                            S01498
     I*
     I*****DATA*STRUCTURE*TO*DEFINE*THE*LOCAL*DATA*AREA*FOR*GROUP*JOBS*   S01498
     I***WWPLDA****E*DSPMLDAPP****************                            S01498
     I*                                                                   S01498
     I** Data structure to define DTAARA/*LDA                             S01498
     IWWPLDA    E DSPMLDAPD                                               S01498
     I*
     I** Program status Data structure
     IPSDS       SDS
     I**************************************244 253 DDJOB                 S01498
     I**************************************254 263 USER                  S01498
     I                                      244 253 SWSID                 S01498
     I                                      254 263 SUSER                 S01498
     I*
     I**  Local data area
     I***DTAR*******UDS***********************     256                    S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*
     I** DATA STRUCTURE FOR DATE OF BIRTH (READ FROM SDPLCSL0)
     I            DS
     I                                        1   60WWDAT1
     I                                        1   20WWDAY1
     I                                        3   40WWMON1
     I                                        5   60WWYER1
     I**
     I** DATA STRUCTURE FOR DATE OF BIRTH (CONVERTED AS PARAMETER)
     I**
     I            DS
     I                                        1   7 WWDAT2
     I                                        1   20WWDAY2
     I                                        3   5 WWMON2
     I                                        6   70WWYER2
     I*                                                                   S01498
     ISDBANK    E DSSDBANKPD                                              S01498
     I**  Data structure for bank details                                 S01498
     I*                                                                   S01498
     ISDACOF    E DSSDACOFPD                                              S01498
     I**  Data structure for account officer details                      S01498
     I*                                                                   S01498
     ISDMMOD    E DSSDMMODPD                                              S01498
     I**  Data structure for Midas modules details                        S01498
     I*                                                                   S01498
     ISDPLCS    E DSSDPLCSPD                                              S01498
     I**  Data structure for Portfolio Management customer details        S01498
     I*                                                                   S01498
     ISDPORT    E DSSDPORTPD                                              S01498
     I**  Data structure for Portfolio Management ICD                     S01498
     I*                                                                   S01498
     ISDCTRY    E DSSDCTRYPD                                              S01498
     I**  Data structure for country code details                         S01498
     I*                                                                   S01498
     ISDUSER    E DSMUSERDD                                               S01498
     I**  Data structure for user details                                 S01498
     I*                                                                   S01498
     ISDPLIN    E DSSDPLINPD                                              S01498
     I**  Data structure for instrument type details                      S01498
     I*                                                                   S01498
     IDSFDY     E DSDSFDY                                                 S01498
     I**  Short data structure for access objects                         S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I**  Long data structure for access programs                         S01498
     I*                                                                   S01498
     C/EJECT
     C*****************************************************************
     C*
     C** DEFINE KLISTS
     C*  =============
     C*
     C** KEY LIST FOR LBBPWRL1
     C*
     C           KL1       KLIST
     C                     KFLD           WWCUS2
     C                     KFLD           DDINST
     C*
     C** KEY LIST FOR LBBPWRL2
     C*
     C           KL2       KLIST
     C                     KFLD           WWCUS2
     C                     KFLD           DDSECR
     C*
     C/EJECT
     C*****************************************************************
     C*
     C** Parameter List Declarations
     C** ---------------------------
     C**
     C** WWUPFL - User profile description - passed in by calling program
     C**
     C**
     C           *ENTRY    PLIST
     C                     PARM           WWUPFL 10
     C*                                                                   S01498
     C**  Copyright statement                                             S01498
     C*                                                                   S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  Main Line Processing                                        *
     C**                                                              *
     C*****************************************************************
     C*
     C** Initialisation Process
     C*
     C                     EXSR #A
     C*
     C** Loop until Exit Key pressed.
     C*
     C           *INKC     DOUEQ'1'
     C*
     C** No errors - initialise fields
     C*
     C           *IN99     IFEQ '0'
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVE *BLANKS   DDCTRY
     C                     MOVE *BLANKS   DDINST
     C                     MOVE *BLANKS   DDSECR
     C                     END
     C*
     C** Previous sceen/Portfolio/Documentation command keys invalid on
     C** screen 1
     C*
     C                     SETOF                     384173
     C*
     C** Display screen 1
     C*
     C                     WRITELB0330F1
     C                     WRITELB0330C1
     C*                                                                   LB0001
     C           *IN41     IFEQ '1'                                       LB0001
     C                     MOVE *BLANKS   DDPNP8                          LB0001
     C                     END                                            LB0001
     C*                                                                   LB0001
     C                     EXFMTLB0330F2
     C*                                                                   LB0001
     C                     EXSR #CLEAR                                    LB0001
     C*                                                                   LB0001
     C***Setof*all*error*msgs*associated*with screen1                     LB0001
     C************************************                                LB0001
     C******************** SETOF *********           212223               LB0001
     C******************** SETOF *********           242599               LB0001
     C******************** SETOF *********           272930               LB0001
     C******************** SETOF *********           314647               LB0001
     C************************************                                LB0001
     C** Clear msg queue *****************                                LB0001
     C************************************                                LB0001
     C******************** CALL*'Y2CLMSC'*                                LB0001
     C******************** PARM ********* WWTPGQ 10                       LB0001
     C******************** PARM ********* WWPGQR  5                       LB0001
     C******************** SETON ********            40                   LB0001
     C*
     C** Cmd3 - Exit
     C*
     C           *INKC     IFEQ '0'
     C*
     C** Enter
     C*
     C           *IN40     DOWEQ'1'
     C           *IN99     ANDEQ'0'
     C           *INKC     ANDEQ'0'
     C           *INKL     ANDEQ'0'                                       S01498
     C*
     C** Validate combinations entered
     C*
     C                     EXSR #B
     C*
     C** No errors : continue validation otherwise display error
     C*
     C           *IN99     IFEQ '0'
     C*
     C** Validate selection against files
     C*
     C                     EXSR #C
     C*
     C           *INKC     IFEQ '0'
     C*
     C           *IN99     IFEQ '0'
     C*
     C* Build relevant subfile
     C                     EXSR #D
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C** If Pm0160 Called during program then Recall resetting Parms
     C                     EXSR #ZE
     C*
     C** Termination Process
     C                     EXSR #E
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    INDEX TO SUBROUTINES                                      *
     C**   ----------------------                                     *
     C**                                                              *
     C**                                                              *
     C**   #B      - Screen 1 validation                              *
     C**   #C      - Validate selection against files                 *
     C**   #D      - Build relevant subfile                           *
     C**                                                              *
     C**   #CB     - Customer validation                              *
     C**   #CC     - Country validation                               *
     C**   #CD     - Instrument validation                            *
     C**   #CE     - Security Validation                              *
     C**                                                              *
     C**   #CBA    - Customer validation (2)                          *
     C**                                                              *
     C**   #DB     - Customer subfile                                 *
     C**   #DBA    - Customer No./Shortname only entered              *
     C**   #DBAA   - Customer has both instrument and security recs   *
     C**   #DBAAA  - Build instrument subfile page                    *
     C**   #DBAAB  - Build security subfile page                      *
     C**                                                              *
     C**   #DBB    - Customer + Inst type entered or inst recs only   *
     C**   #DBBA   - Build instrument subfile page                    *
     C**                                                              *
     C**   #DBC    - Customer + security entered or security recs only*
     C**   #DBCA   - Build security sfl page                          *
     C**                                                              *
     C**   #DC     - Country selected                                 *
     C**   #DCA    - Build country  sfl page                          *
     C**                                                              *
     C**   #DD     - Instrument selected                              *
     C**   #DDA    - Instrument subfile page build                    *
     C**                                                              *
     C**   #DE     - Security selected                                *
     C**   #DEA    - Security subfile page build                      *
     C**                                                              *
     C**   #A      - Performs initial processing                      *
     C**   #E      - Termination processing                           *
     C**   #CLEAR  - Reset if CMD12 is pressed                        *
     C**                                                              *
     C**   ZASNMS  - Send message to programs message queue           *
     C**   #ZB     - CMD23 Portfolio Management Enquiries             *
     C**   #ZBA    - Load Group Data Area                             *
     C**   #ZC     - CMD24 Portfolio Management Doc.                  *
     C**   #ZE     - Final Call to PM0160 before exit                 *
     C**   ZDATE2  - Converts Day No. to Day                          *
     C**                                                              *
     C**   *PSSR   - Program error handling routine                   *
     C**                                                              *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #B  - Screen 1 Validation                        *
     C**                                                              *
     C**  CALLS          - None                                       *
     C**                                                              *
     C**  CALLED BY      - Main Line Processing                       *
     C**                                                              *
     C*****************************************************************
     C           #B        BEGSR
     C*
     C** All Blank invalid
     C*
     C           DDPNP8    IFEQ *BLANKS
     C           DDCTRY    ANDEQ*BLANKS
     C           DDINST    ANDEQ*BLANKS
     C           DDSECR    ANDEQ*BLANKS
     C                     SETON                     2199
     C                     MOVEL'LBM0012' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C*
     C** Customer/ Country combination invalid
     C*
     C           DDPNP8    IFNE *BLANKS
     C           DDCTRY    ANDNE*BLANKS
     C                     SETON                     2299
     C                     MOVEL'LBM0015' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C*
     C** Instrument/ Country combination invalid
     C*
     C           DDCTRY    IFNE *BLANKS
     C           DDINST    ANDNE*BLANKS
     C                     SETON                     2399
     C                     MOVEL'LBM0015' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C*
     C** Security/ Country combination invalid
     C*
     C           DDCTRY    IFNE *BLANKS
     C           DDSECR    ANDNE*BLANKS
     C                     SETON                     2499
     C                     MOVEL'LBM0015' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C*
     C** Security/ Instrument combination invalid
     C*
     C           DDINST    IFNE *BLANKS
     C           DDSECR    ANDNE*BLANKS
     C                     SETON                     2599
     C                     MOVEL'LBM0015' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #C  - Validate entered fields against files      *
     C**                                                              *
     C**  CALLS          - #CB #CC #CD #CE                            *
     C**                                                              *
     C**  CALLED BY      - Mainline Processing                        *
     C**                                                              *
     C*****************************************************************
     C           #C        BEGSR
     C           *IN99     IFEQ '0'
     C*
     C* Customer entered
     C           DDPNP8    IFNE *BLANKS
     C                     EXSR #CB
     C                     ELSE
     C*
     C* Country  entered
     C           DDCTRY    IFNE *BLANKS
     C                     EXSR #CC
     C                     ELSE
     C*
     C* Instrument only entered
     C           DDINST    IFNE *BLANKS
     C           DDPNP8    ANDEQ*BLANKS
     C                     EXSR #CD
     C                     ELSE
     C*
     C* Security only entered
     C           DDSECR    IFNE *BLANKS
     C           DDPNP8    ANDEQ*BLANKS
     C                     EXSR #CE
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #D  - Build relevant subfile                     *
     C**                                                              *
     C**  CALLS          - #DB #DC #DD #DE                            *
     C**                                                              *
     C**  CALLED BY      - Mainline processing                        *
     C**                                                              *
     C*****************************************************************
     C           #D        BEGSR
     C           *IN99     IFEQ '0'
     C           DDPNP8    IFNE *BLANKS
     C*
     C* Customer Header Information
     C                     MOVE BBCUST    DDCUNO
     C                     MOVE BBCRNM    DDRPTN
     C                     MOVE BBCRTN    DDTOWN
     C*
     C* Process customer subfile(s)
     C                     EXSR #DB
     C                     ELSE
     C*
     C* Process country subfile
     C           DDCTRY    IFNE *BLANKS
     C                     EXSR #DC
     C                     ELSE
     C*
     C* Process instrument only subfile
     C           DDINST    IFNE *BLANKS
     C           DDPNP8    ANDEQ*BLANKS
     C                     EXSR #DD
     C                     ELSE
     C*
     C* Process security only subfile
     C           DDSECR    IFNE *BLANKS
     C           DDPNP8    ANDEQ*BLANKS
     C                     EXSR #DE
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CB - Customer Validation                        *
     C**                                                              *
     C**  CALLS          - #CBA                                       *
     C**                                                              *
     C**  CALLED BY      - #C                                         *
     C**                                                              *
     C*****************************************************************
     C           #CB       BEGSR
     C*
     C** Valid Customer No. entered indicator
     C*
     C                     SETOF                     28
     C*
     C** Check if first char alphanumeric or blank
     C*
     C                     MOVELDDPNP8    WWALF1  1
     C           WWALF1    LOKUPALPNU                    32
     C           *IN32     IFNE '1'                        -B1
     C                     SETON                     2799
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C                     END                             -E1
     C*
     C           *IN99     IFEQ '0'                        -B1
     C**********                                                                              CSD027
     C***Check*if first char numeric                                                          CSD027
     C**********                                                                              CSD027
     C********** WWALF1    LOKUPNUM                      32                                   CSD027
     C********** *IN32     IFNE '1'                        -B2                                CSD027
     C**********                                                                              CSD027
     C***Non-numeric check if valid shortname                                                 CSD027
     C**********                                                                              CSD027
     C***********DDPNP8    SETLLSDLBCSL5             69  70               S01498              CSD027
     C********** DDPNP8    SETLLLBLBCSJ5             69  70               S01498              CSD027
     C********** *IN69     IFEQ '1'                        -B3                                CSD027
     C**********           GOTO #CBB                                                          CSD027
     C**********           END                             -E3                                CSD027
     C********** *IN70     IFEQ '1'                        -B3                                CSD027
     C***********          READ SDLBCSL5                 77               S01498              CSD027
     C**********           READ LBLBCSJ5                 77               S01498              CSD027
     C********** *IN77     IFEQ '1'                        -B4                                CSD027
     C**********           MOVE '1'       *IN69                                               CSD027
     C**********           GOTO #CBB                                                          CSD027
     C**********           END                             -E4                                CSD027
     C**********           END                             -E3                                CSD027
     C**********           ELSE                            -X2                                CSD027
     C**********                                                                              CSD027
     C***Numeric - check if valid customer number                                             CSD027
     C***First*check if 6 digits                                                              CSD027
     C**********           Z-ADD0         W       20                                          CSD027
     C********** W         DOUEQ6                          -B3                                CSD027
     C********** *IN99     OREQ '1'                                                           CSD027
     C**********           ADD  1         W                                                   CSD027
     C********** INP,W     LOKUPNUM                      32                                   CSD027
     C********** *IN32     IFNE '1'                        -B4                                CSD027
     C**********           MOVE '1'       *IN69                                               CSD027
     C**********           GOTO #CBB                                                          CSD027
     C**********           END                             -E4                                CSD027
     C**********           END                             -E3                                CSD027
      * Check as a shortname                                                                  CSD027
     C           DDPNP8    CHAINLBLBCSJ5             77                                       CSD027
      * If shortname was not found                                                            CSD027
     C           *IN77     IFEQ *ON                                                           CSD027
     C*
     C** 6 Digits - Now check rest is blanks
     C*
     C           WWL4      IFNE *BLANKS                    -B3
     C                     MOVE '1'       *IN69
     C                     GOTO #CBB
     C                     END                             -E3
     C*
     C** Valid 6 Digit number
     C                     SETON                     28
     C                     MOVELDDPNP8    WWCUS1  6
     C***********WWCUS1    SETLLSDLBCSL0             69  70               S01498
     C           WWCUS1    SETLLLBLBCSJ0             69  70               S01498
     C           *IN69     IFEQ '1'                        -B3
     C                     GOTO #CBB
     C                     END                             -E3
     C           *IN70     IFEQ '1'                        -B3
     C***********          READ SDLBCSL0                 77               S01498
     C                     READ LBLBCSJ0                 77               S01498
     C           *IN77     IFEQ '1'                        -B4
     C                     MOVE '1'       *IN69
     C                     GOTO #CBB
     C                     END                             -E4
     C                     END                             -E3
     C                     END                                                                CSD027
     C**********           END                             -E2                                CSD027
     C*
     C*
     C** Customer/Short Name not exist. Call Customer Enquiry LB0340
     C*
     C           *IN70     IFEQ '0'                        -B2
     C*
     C** Initialise Parameters:
     C**                       WWPAR1 (Menu/Program flag) = 1
     C**                       WWPAR2 (Entered Customer)
     C**                       WWPAR3 (Returned Customer)
     C**                       WWPAR4 (Returned Function key)
     C*
     C                     MOVE '1'       WWPAR1  1
     C                     MOVE DDPNP8    WWPAR2 10
     C                     Z-ADD*ZEROS    WWPAR3  60
     C                     MOVE *BLANKS   WWPAR4  2
     C*
     C***********          UNLCKDTAR                                      S01498
     C                     UNLCKLDA                                       S01498
     C*
     C                     CALL 'LB0340'
     C                     PARM           WWPAR1
     C                     PARM           WWPAR2
     C                     PARM           WWPAR3
     C                     PARM           WWPAR4
     C*
     C************LOCK     IN   DTAR                                      S01498
     C           *LOCK     IN   LDA                                       S01498
     C*
     C** Data Base Error detected in LB0340
     C*
     C           DBASE     IFGT 0                          -B3
     C                     SETON                     LRU7U8
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE                            -X3
     C                     MOVE *BLANKS   DBPGM
     C                     MOVEL'LB0330'  DBPGM
     C*
     C** Returned function key = 03 exit Program
     C*
     C           WWPAR4    IFEQ '03'                       -B4
     C                     MOVE '1'       *INKC
     C                     ELSE                            -X4
     C*
     C** Lb0340 returns cutsomer no (6,0) if normal return
     C*
     C           WWPAR3    IFNE *ZEROS                     -B5
     C           WWPAR4    ANDNE'12'
     C                     MOVE WWPAR3    WWCUS1
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVELWWPAR3    DDPNP8
     C                     SETON                     28
     C                     ELSE                            -X5
     C*
     C** Returned function key = 12 or returned customer no. zero
     C** redisplay screen 1
     C*
     C                     MOVE *BLANKS   DDPNP8
     C                     SETON                     99
     C                     END                             -E5
     C                     END                             -E4
     C                     END                             -E3
     C                     END                             -E2
     C*
     C           *INKC     IFEQ '0'                        -B2
     C*
     C********** *IN99 *** IFEQ '0'*******
     C*
     C** Customer number available
     C*
     C           *IN28     IFEQ '1'                        -B3
     C***********WWCUS1    CHAINSDLBCSL0             72                   S01498
     C           WWCUS1    CHAINLBLBCSJ0             72                   S01498
     C                     ELSE                            -X3
     C*
     C** Short Name available
     C*
     C***********DDPNP8    CHAINSDLBCSL5             72                   S01498
     C           DDPNP8    CHAINLBLBCSJ5             72                   S01498
     C                     END                             -E3
     C           *IN72     IFEQ '0'                        -B3
     C                     EXSR #CBA
     C******************** ELSE **********                 -X3            LB0001
     C******************** SETON *********           9927                 LB0001
     C******************** MOVEL'LBM0007'*ZAMSID                          LB0001
     C******************** EXSR ZASNMS ***                                LB0001
     C                     END                             -E3
     C                     END                             -E2
     C*
     C** Invalid customer found, load message to message subfile
     C           #CBB      TAG                             ** #CBB **
     C           *IN69     IFEQ '1'                        -B2
     C                     MOVE '1'       *IN99
     C                     MOVEL'LBM0007' ZAMSID
     C                     EXSR ZASNMS
     C                     END                             -E2
     C                     END                             -E1
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CC - Country validation                         *
     C**                                                              *
     C**  CALLS          - none                                       *
     C**                                                              *
     C**  CALLED BY      - #C                                         *
     C**                                                              *
     C*****************************************************************
     C           #CC       BEGSR
     C*
     C********** DDCTRY ** SETLLLBBPWRL5 *               69               LB0001
     C           DDCTRY    SETLLLBBPWRL5             69                   LB0001
     C                     READ LBBPWRL5                 20               LB0001
     C************IN69 *** IFEQ*'0'*******                                LB0001
     C           *IN20     IFEQ '1'                                       LB0001
     C                     SETON                     3199
     C                     MOVEL'LBM0065' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CD - Instrument validation                      *
     C**                                                              *
     C**  CALLS          - none                                       *
     C**                                                              *
     C**  CALLED BY      - #C                                         *
     C**                                                              *
     C*****************************************************************
     C           #CD       BEGSR
     C*
     C********** DDINST ** SETLLLBBPWRL3 *               69               LB0001
     C           DDINST    SETLLLBBPWRL3             69                   LB0001
     C                     READ LBBPWRL3                 20               LB0001
     C************IN69 *** IFEQ*'0'*******                                LB0001
     C           *IN20     IFEQ '1'                                       LB0001
     C                     SETON                     2999
     C                     MOVEL'LBM0066' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CE - Security Validation                        *
     C**                                                              *
     C**  CALLS          - none                                       *
     C**                                                              *
     C**  CALLED BY      - #C                                         *
     C**                                                              *
     C*****************************************************************
     C           #CE       BEGSR
     C*
     C********** DDSECR ** SETLLLBBPWRL4 *               69               LB0001
     C           DDSECR    SETLLLBBPWRL4             69                   LB0001
     C                     READ LBBPWRL4                 20               LB0001
     C************IN69 *** IFEQ*'0'*******                                LB0001
     C           *IN20     IFEQ '1'                                       LB0001
     C                     SETON                     3099
     C                     MOVEL'LBM0067' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #CBA - Customer Validation Continued             *
     C**                                                              *
     C**  CALLED BY       - #CB                                       *
     C**                                                              *
     C**  CALLED BY       - none                                      *
     C**                                                              *
     C*****************************************************************
     C           #CBA      BEGSR
     C**********           MOVE BBCUST    WWCUS2  60                                          CSD027
     C                     MOVE BBCUST    WWCUS2  6                                           CSD027
     C*
     C* Customer only entered
     C*
     C* At least one record for the customer must exist on one of the
     C* following files.
     C           DDINST    IFEQ *BLANKS
     C           DDSECR    ANDEQ*BLANKS
     C           WWCUS2    SETLLLBBPWRL1                 71
     C           WWCUS2    SETLLLBBPWRL2                 70
     C           *IN70     IFEQ '0'
     C           *IN71     ANDEQ'0'
     C                     SETON                     2799
     C                     MOVEL'LBM0062' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C                     ELSE
     C*
     C* Customer/instrument entered
     C*
     C* At least one instrument must exist for customer
     C           DDINST    IFNE *BLANKS
     C           KL1       SETLLLBBPWRL1                 70
     C           *IN70     IFEQ '0'
     C                     SETON                     4699
     C                     MOVEL'LBM0063' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     READ LBBPWRL1                 20
     C           WWCUS2    IFNE BPCNUM
     C                     SETON                     4699
     C                     MOVEL'LBM0063' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C                     END
     C                     ELSE
     C*
     C* Customer/security entered
     C*
     C* At least one security must exist for customer
     C           DDSECR    IFNE *BLANKS
     C           KL2       SETLLLBBPWRL2                 70
     C           *IN70     IFEQ '0'
     C                     SETON                     4799
     C                     MOVEL'LBM0064' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     READ LBBPWRL2                 20
     C           WWCUS2    IFNE BPCNUR
     C                     SETON                     4799
     C                     MOVEL'LBM0064' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DB -    Customer Subfile  ...                   *
     C**                                                              *
     C**  CALLS          -    #DBA #DBB #DBC                          *
     C**                                                              *
     C**  CALLED BY      -    #D                                      *
     C**                                                              *
     C*****************************************************************
     C           #DB       BEGSR
     C*
     C* Customer only entered...
     C           DDINST    IFEQ *BLANKS
     C           DDSECR    ANDEQ*BLANKS
     C                     EXSR #DBA
     C                     ELSE
     C*
     C* Customer and instrument code entered...
     C           DDPNP8    IFNE *BLANKS
     C           DDINST    ANDNE*BLANKS
     C                     EXSR #DBB
     C                     ELSE
     C*
     C* Customer and security short name entered...
     C           DDPNP8    IFNE *BLANKS
     C           DDSECR    ANDNE*BLANKS
     C                     EXSR #DBC
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBA -   Customer No./Short Name only entered    *
     C**                                                              *
     C**  CALLS           -   #DBAA #DBB #DBC                         *
     C**                                                              *
     C**  CALLED BY       -   #DB                                     *
     C**                                                              *
     C*****************************************************************
     C           #DBA      BEGSR
     C*
     C* Customer has both instrument and security records
     C           *IN71     IFEQ '1'
     C           *IN70     ANDEQ'1'
     C                     EXSR #DBAA
     C                     ELSE
     C*
     C* Customer has only instrument records
     C           *IN71     IFEQ '1'
     C                     EXSR #DBB
     C                     ELSE
     C*
     C* Customer has only security records
     C           *IN70     IFEQ '1'
     C                     EXSR #DBC
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBAA - Customer has both instrument and security*
     C**                     records                                  *
     C**                                                              *
     C**  CALLS            - #DBAAA #DBAAB #CLEAR                     *   LB0001
     C**                                                              *
     C**  CALLED BY        - #DBA                                     *
     C**                                                              *
     C*****************************************************************
     C           #DBAA     BEGSR
     C*
     C* Clear instrument subfile
     C                     SETON                     36
     C                     WRITELB0330C8
     C                     SETOF                     36
     C                     Z-ADD*ZEROS    RRN5
     C                     Z-ADD*ZEROS    WKRRN5  30
     C*
     C* Clear security   subfile
     C                     SETON                     36
     C                     WRITELB0330C9
     C                     SETOF                     36
     C                     Z-ADD*ZEROS    RRN6
     C                     Z-ADD*ZEROS    WKRRN6  30
     C*
     C* Build initial instrument subfile page
     C           WWCUS2    SETLLLBBPWRL1             69
     C                     READ LBBPWRL1                 20
     C                     EXSR #DBAAA
     C                     Z-ADDRRN5      WKRRN5
     C*
     C* Build initial security   subfile page
     C           WWCUS2    SETLLLBBPWRL2             69
     C                     READ LBBPWRL2                 44
     C                     EXSR #DBAAB
     C                     SETOF                     40
     C*
     C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C           *IN40     OREQ '1'
     C*
     C* Initialise entry fields
     C           *IN99     IFEQ '0'
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVE *BLANKS   DDCTRY
     C                     MOVE *BLANKS   DDINST
     C                     MOVE *BLANKS   DDSECR
     C                     END
     C*
     C* Allow F12 and SFLCTRL
     C                     SETON                     3541
     C***********          EXSR #CLEAR                             LB0001 R00266
     C*
     C* Disable Function keys F23/F24 if Portfolio Management not
     C* installed
     C           BGPFMG    IFNE 'Y'
     C                     SETOF                     7338
     C                     ELSE
     C                     SETON                     7338
     C                     END
     C*
     C                     WRITELB0330F1
     C                     WRITELB0330C1
     C                     WRITELB0330C8
     C                     WRITELB0330C9
     C                     EXFMTLB0330F3
     C                     SETOF                     359940
     C                     EXSR #CLEAR                                    R00266
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C* Exit or Previous screen not pressed
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C** F23 pressed : call PORTFOLIO MANAGEMENT Enquiries
     C*
     C           *INKX     IFEQ '1'
     C                     EXSR #ZB
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN5
     C                     END
     C                     ELSE
     C*
     C** F24 pressed : call PORTFOLIO MANAGEMENT Documentation
     C*
     C           *INKY     IFEQ '1'
     C                     EXSR #ZC
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN5
     C                     END
     C                     ELSE
     C*
     C* Rollup requested for instrument subfile
     C           *IN39     IFEQ '1'
     C           POST      ANDLT3073
     C*
     C* Save current rrn and build new page
     C                     Z-ADDWKRRN5    RRN5
     C                     EXSR #DBAAA
     C                     Z-ADDRRN5      WKRRN5
     C                     SETON                     99
     C                     ELSE
     C*
     C* Rollup requested for security   subfile
     C           *IN39     IFEQ '1'
     C*
     C* Ensure instrument subfile displayed at current rrn
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN5
     C                     END
     C*
     C                     EXSR #DBAAB
     C                     SETON                     99
     C                     ELSE
     C*
     C* validate input fields
     C           DDPNP8    IFNE *BLANKS
     C           DDCTRY    ORNE *BLANKS
     C           DDINST    ORNE *BLANKS
     C           DDSECR    ORNE *BLANKS
     C*
     C* If entry made return to initial validation
     C                     SETON                     40
     C                     ELSE
     C*
     C* Enter pressed : display screen at current rrn.
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN5
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBAAA - Build instrument subfile page           *
     C**                                                              *
     C**  CALLS             - none                                    *
     C**                                                              *
     C**  CALLED BY         - #DBAA                                   *
     C**                                                              *
     C*****************************************************************
     C           #DBAAA    BEGSR
     C*
     C* seton SFLDSP
     C                     SETON                     33
     C                     Z-ADD*ZEROS    WWSFLC  30
     C*
     C* Read file, load subfile, increase rrn and initialise fields
     C*
     C           *IN20     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLS
     C*
     C***********BPINST    CHAINSDPLINL4             71                   S01498
     C************IN71     IFEQ '1'                                       S01498
     C***********PDRECI    OREQ '*'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BPINST    P@INST  3                       S01498
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDPLINL4'DBFILE                          S01498
     C                     MOVE 'SDPLINPD'DBFILE                          S01498
     C                     MOVELBPINST    DBKEY            * * * * * * * *
     C                     MOVE '003'     DBASE            * DBERROR 003 *
     C                     SETON                     U7U8LR* * * * * * * *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     MOVE PDISTN    DDINTN
     C                     END
     C*
     C                     MOVE BPINST    DDINTT
     C           BPINPC    IFNE *ZEROS
     C                     SETOF                     45
     C                     Z-ADDBPINPC    DDINTP
     C                     ELSE
     C                     SETON                     45
     C                     END
     C                     Z-ADDBPREVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    DDINTD
     C                     MOVE BPREVF    DDINTF
     C                     MOVE BPREVN    DDINTO
     C*
     C                     ADD  1         RRN5
     C                     WRITELB0330S8                 37
     C                     ADD  1         WWSFLC
     C*
     C* Read all instruments for entered customer
     C           WWCUS2    READELBBPWRL1                 20
     C*
     C                     MOVE *BLANKS   DDINTT
     C                     MOVE *BLANKS   DDINTN
     C                     Z-ADD*ZEROS    DDINTP
     C                     MOVE *BLANKS   DDINTD
     C                     MOVE *BLANKS   DDINTF
     C                     Z-ADD*ZEROS    DDINTO
     C*
     C* End of file setof Rollup
     C           *IN20     IFEQ '1'
     C                     SETON                     34
     C                     ELSE
     C                     SETOF                     34
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBAAB - Build Security subfile page             *
     C**                                                              *
     C**  CALLS             - none                                    *
     C**                                                              *
     C**  CALLED BY         - #DBAA                                   *
     C**                                                              *
     C*****************************************************************
     C           #DBAAB    BEGSR
     C*
     C* seton SFLDSP
     C                     SETON                     33
     C                     Z-ADD*ZEROS    WWSFLC  30
     C*
     C* Read file, load subfile, increase rrn and initialise fields
     C           *IN44     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLS
     C*
     C           BPSESR    CHAINSECTY                71
     C           *IN71     IFEQ '1'
     C           RECI      OREQ '*'
     C***************      MOVEL'*** NOT 'WWSEC1 16                       B8227
     C***************      MOVE 'FOUND **'WWSEC1                          B8227
     C***************      MOVELWWSEC1    WWSEC2 17                       B8227
     C***************      MOVE '*'       WWSEC2                          B8227
     C***************      MOVELWWSEC2    DDSECN                          B8227
     C                     MOVE *BLANKS   DDSECN                          B8227
     C                     ELSE
     C                     MOVE SRPN      DDSECN
     C                     END
     C*
     C                     MOVE BPSESR    DDSECT
     C           BPSEPR    IFNE *ZEROS
     C                     SETOF                     45
     C                     Z-ADDBPSEPR    DDSECP
     C                     ELSE
     C                     SETON                     45
     C                     END
     C                     Z-ADDBPREVR    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    DDSECD
     C                     MOVE BPREFR    DDSECF
     C                     MOVE BPRENR    DDSECO
     C                     ADD  1         RRN6
     C                     WRITELB0330S9                 37
     C                     ADD  1         WWSFLC
     C*
     C* Read all security records for entered customer
     C           WWCUS2    READELBBPWRL2                 44
     C*
     C                     MOVE *BLANKS   DDSECT
     C                     MOVE *BLANKS   DDSECN
     C                     Z-ADD*ZEROS    DDSECP
     C                     MOVE *BLANKS   DDSECD
     C                     MOVE *BLANKS   DDSECF
     C                     Z-ADD*ZEROS    DDSECO
     C*
     C* End of file setof Rollup
     C           *IN44     IFEQ '1'
     C                     SETON                     42
     C                     ELSE
     C                     SETOF                     42
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBB -   Customer no./Short name + instrument    *
     C**                      type entered                            *
     C**                                                              *
     C**                      OR                                      *
     C**                                                              *
     C**                      customer hase only instrument records   *
     C**                                                              *
     C**  CALLS           -   #DBBA #CLEAR                            *   LB0001
     C**                                                              *
     C**  CALLED BY       -   #DB                                     *
     C**                  -   #DBA                                    *
     C**                                                              *
     C*****************************************************************
     C           #DBB      BEGSR
     C*
     C* Clear instrument subfile
     C                     SETON                     36
     C                     WRITELB0330C5
     C                     SETOF                     36
     C*
     C                     Z-ADD*ZEROS    WKRRN3  30
     C                     Z-ADD*ZEROS    RRN3
     C*
     C* Build initial instrument subfile page
     C           KL1       SETLLLBBPWRL1             69
     C                     READ LBBPWRL1                 20
     C                     EXSR #DBBA
     C                     Z-ADDRRN3      WKRRN3
     C                     SETOF                     40
     C*
     C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C           *IN40     OREQ '1'
     C*
     C* Initialise entry
     C           *IN99     IFEQ '0'
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVE *BLANKS   DDCTRY
     C                     MOVE *BLANKS   DDINST
     C                     MOVE *BLANKS   DDSECR
     C                     END
     C*
     C* Allow F12 and SFLCTRL
     C                     SETON                     3541
     C***********          EXSR #CLEAR                             LB0001 R00266
     C*
     C* Disable Function keys F23/F24 if Portfolio Management not
     C* installed
     C           BGPFMG    IFNE 'Y'
     C                     SETOF                     7338
     C                     ELSE
     C                     SETON                     7338
     C                     END
     C*
     C                     WRITELB0330F1
     C                     WRITELB0330C1
     C                     WRITELB0330C5
     C                     EXFMTLB0330F3
     C                     SETOF                     354099
     C                     EXSR #CLEAR                                    R00266
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C* Exit or Previous screen not pressed
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C** F23 pressed : call PORTFOLIO MANAGEmeNT Enquiries
     C*
     C           *INKX     IFEQ '1'
     C                     EXSR #ZB
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN3
     C                     END
     C                     ELSE
     C*
     C** F24 pressed : call PORTFOLIO MANAGEMENT Documentation
     C*
     C           *INKY     IFEQ '1'
     C                     EXSR #ZC
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN3
     C                     END
     C                     ELSE
     C*
     C* Rollup requested
     C           *IN39     IFEQ '1'
     C*
     C* Save current rrn and build new page
     C                     Z-ADDWKRRN3    RRN3
     C                     EXSR #DBBA
     C                     Z-ADDRRN3      WKRRN3
     C                     SETON                     99
     C                     ELSE
     C*
     C* Validate input fields
     C           DDPNP8    IFNE *BLANKS
     C           DDCTRY    ORNE *BLANKS
     C           DDINST    ORNE *BLANKS
     C           DDSECR    ORNE *BLANKS
     C                     SETON                     40
     C                     ELSE
     C*
     C* Enter pressed : display screen at current rrn.
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN3
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBBA- Build Instrument subfile page             *
     C**                                                              *
     C**  CALLS           - none                                      *
     C**                                                              *
     C**  CALLED BY       - #DBB                                      *
     C**                                                              *
     C*****************************************************************
     C           #DBBA     BEGSR
     C*
     C* seton SFLDSP
     C                     SETON                     33
     C                     Z-ADD*ZEROS    WWSFLC  30
     C*
     C* Read file, load subfile, increase rrn and initialise fields
     C           *IN20     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLP
     C*
     C***********BPINST    CHAINSDPLINL4             71                   S01498
     C************IN71     IFEQ '1'                                       S01498
     C***********PDRECI    OREQ '*'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BPINST    P@INST  3                       S01498
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDPLINL4'DBFILE                          S01498
     C                     MOVE 'SDPLINPD'DBFILE                          S01498
     C                     MOVELBPINST    DBKEY            * * * * * * * *
     C                     MOVE '004'     DBASE            * DBERROR 004 *
     C                     SETON                     U7U8LR* * * * * * * *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     MOVE PDISTN    DDINTN
     C                     END
     C*
     C                     MOVE BPINST    DDINTT
     C           BPINPC    IFNE *ZEROS
     C                     SETOF                     45
     C                     Z-ADDBPINPC    DDINTP
     C                     ELSE
     C                     SETON                     45
     C                     END
     C                     Z-ADDBPREVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    DDINTD
     C                     MOVE BPREVF    DDINTF
     C                     MOVE BPREVN    DDINTO
     C                     ADD  1         RRN3
     C                     WRITELB0330S5                 37
     C                     ADD  1         WWSFLC
     C*
     C* Read all instrument records for entered customer
     C           WWCUS2    READELBBPWRL1                 20
     C*
     C                     MOVE *BLANKS   DDINTT
     C                     MOVE *BLANKS   DDINTN
     C                     Z-ADD*ZEROS    DDINTP
     C                     MOVE *BLANKS   DDINTD
     C                     MOVE *BLANKS   DDINTF
     C                     Z-ADD*ZEROS    DDINTO
     C*
     C* End of file setof SFLEND
     C           *IN20     IFEQ '1'
     C                     SETON                     34
     C                     ELSE
     C                     SETOF                     34
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBC  -  Customer no./short name + security      *
     C**                      Entered                                 *
     C**                                                              *
     C**                      or                                      *
     C**                                                              *
     C**                      Customer has only security records      *
     C**                                                              *
     C**  CALLS            -  #DBCA #CLEAR                            *   LB0001
     C**                                                              *
     C**  CALLED BY        -  #DB                                     *
     C**                   -  #DBA                                    *
     C**                                                              *
     C*****************************************************************
     C           #DBC      BEGSR
     C*
     C* Clear security subfile
     C                     SETON                     36
     C                     WRITELB0330C6
     C                     SETOF                     36
     C*
     C                     Z-ADD*ZEROS    RRN4
     C                     Z-ADD*ZEROS    WKRRN4  30
     C*
     C* Build initial security subfile page
     C           KL2       SETLLLBBPWRL2             69
     C                     READ LBBPWRL2                 20
     C                     EXSR #DBCA
     C                     Z-ADDRRN4      WKRRN4
     C                     SETOF                     40
     C*
     C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C           *IN40     OREQ '1'
     C*
     C* Initialise entry
     C           *IN99     IFEQ '0'
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVE *BLANKS   DDCTRY
     C                     MOVE *BLANKS   DDINST
     C                     MOVE *BLANKS   DDSECR
     C                     END
     C*
     C* Allow F12 and SFLCTRL
     C                     SETON                     3541
     C***********          EXSR #CLEAR                             LB0001 R00266
     C*
     C* Disable Function keys F23/F24 if Portfolio Management not
     C* installed
     C           BGPFMG    IFNE 'Y'
     C                     SETOF                     7338
     C                     ELSE
     C                     SETON                     7338
     C                     END
     C*
     C                     WRITELB0330F1
     C                     WRITELB0330C1
     C                     WRITELB0330C6
     C                     EXFMTLB0330F3
     C                     SETOF                     354099
     C                     EXSR #CLEAR                                    R00266
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C* Exit or Previous screen not pressed
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C** F23 pressed : call PORTFOLIO MANAGEMENT Enquiries
     C*
     C           *INKX     IFEQ '1'
     C                     EXSR #ZB
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN4
     C                     END
     C                     ELSE
     C*
     C** F24 pressed : call PORTFOLIO MANAGEMENT Documentation
     C*
     C           *INKY     IFEQ '1'
     C                     EXSR #ZC
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN4
     C                     END
     C                     ELSE
     C*
     C* Rollup requested for instrument subfile
     C           *IN39     IFEQ '1'
     C                     Z-ADDWKRRN4    RRN4
     C                     EXSR #DBCA
     C                     Z-ADDRRN4      WKRRN4
     C                     SETON                     99
     C                     ELSE
     C*
     C* validate input fields
     C           DDPNP8    IFNE *BLANKS
     C           DDCTRY    ORNE *BLANKS
     C           DDINST    ORNE *BLANKS
     C           DDSECR    ORNE *BLANKS
     C*
     C* If entry made return tio initial validation
     C                     SETON                     40
     C                     ELSE
     C*
     C* Enter pressed : display screen at current rrn.
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN4
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DBCA - Build Security subfile page              *
     C**                                                              *
     C**  CALLES           - none                                     *
     C**                                                              *
     C**  CALLED BY        - #DBC                                     *
     C**                                                              *
     C*****************************************************************
     C           #DBCA     BEGSR
     C*
     C* seton SFLDSP
     C                     SETON                     33
     C                     Z-ADD*ZEROS    WWSFLC  30
     C*
     C* Read file, load subfile, increase rrn and initialise fields
     C           *IN20     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLP
     C*
     C           BPSESR    CHAINSECTY                71
     C************IN71*****IFEQ '0'                                       B4645
     C           *IN71     IFEQ '1'                                       B4645
     C           RECI      OREQ '*'
     C***************      MOVEL'*** NOT 'WWSEC1                          B8227
     C***************      MOVE 'FOUND **'WWSEC1                          B8227
     C***************      MOVELWWSEC1    WWSEC2                          B8227
     C***************      MOVE '*'       WWSEC2                          B8227
     C***************      MOVELWWSEC2    DDSECN                          B8227
     C                     MOVE *BLANKS   DDSECN                          B8227
     C                     ELSE
     C                     MOVE SRPN      DDSECN
     C                     END
     C*
     C                     MOVE BPSESR    DDSECT
     C           BPSEPR    IFNE *ZEROS
     C                     SETOF                     45
     C                     Z-ADDBPSEPR    DDSECP
     C                     ELSE
     C                     SETON                     45
     C                     END
     C                     Z-ADDBPREVR    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    DDSECD
     C                     MOVE BPREFR    DDSECF
     C                     MOVE BPRENR    DDSECO
     C                     ADD  1         RRN4
     C                     WRITELB0330S6                 37
     C                     ADD  1         WWSFLC
     C*
     C* Read all security for entered customer
     C           WWCUS2    READELBBPWRL2                 20
     C*
     C                     MOVE *BLANKS   DDSECT
     C                     MOVE *BLANKS   DDSECN
     C                     Z-ADD*ZEROS    DDSECP
     C                     MOVE *BLANKS   DDSECD
     C                     MOVE *BLANKS   DDSECF
     C                     Z-ADD*ZEROS    DDSECO
     C*
     C* End of file setof Rollup
     C           *IN20     IFEQ '1'
     C                     SETON                     34
     C                     ELSE
     C                     SETOF                     34
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DC -    Country selected                        *
     C**                                                              *
     C**  CALLS          -    #DCA #CLEAR                             *   LB0001
     C**                                                              *
     C**  CALLED BY      -    #D                                      *
     C**                                                              *
     C*****************************************************************
     C           #DC       BEGSR
     C*
     C* Clear country subfile
     C                     SETON                     36
     C                     WRITELB0330C2
     C                     SETOF                     36
     C*
     C                     Z-ADD*ZEROS    RRN
     C                     Z-ADD*ZEROS    WKRRN   30
     C*
     C* Build initial country subfile page
     C********** DDCTRY ** SETLLLBBPWRL5 *           69                   LB0001
     C******************** READ*LBBPWRL5 *               20               LB0001
     C                     EXSR #DCA
     C                     Z-ADDRRN       WKRRN
     C                     SETOF                     40
     C*
     C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C           *IN40     OREQ '1'
     C*
     C* initialise entry
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVE *BLANKS   DDCTRY
     C                     MOVE *BLANKS   DDINST
     C                     MOVE *BLANKS   DDSECR
     C*
     C                     SETON                     3541
     C***********          EXSR #CLEAR                             LB0001 R00266
     C                     SETOF                     3873
     C*
     C                     WRITELB0330F1
     C                     WRITELB0330C1
     C                     WRITELB0330C2
     C                     EXFMTLB0330F3
     C                     SETOF                     354099
     C                     EXSR #CLEAR                                    R00266
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C* Exit or Previous screen not pressed
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C* Rollup requested
     C           *IN39     IFEQ '1'
     C*
     C* Save current rn and build new page
     C                     Z-ADDWKRRN     RRN
     C                     EXSR #DCA
     C                     Z-ADDRRN       WKRRN
     C                     SETON                     99
     C                     ELSE
     C*
     C* Vaslidate input fields
     C           DDPNP8    IFNE *BLANKS
     C           DDCTRY    ORNE *BLANKS
     C           DDINST    ORNE *BLANKS
     C           DDSECR    ORNE *BLANKS
     C*
     C* If Entry made return to initial validation
     C                     SETON                     40
     C                     ELSE
     C*
     C* Enter pressed : display screen at current rrn.
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DCA - Build Country subfile page                *
     C**                                                              *
     C**  CALLS           - none                                      *
     C**                                                              *
     C**  CALLED BY       - #DC                                       *
     C**                                                              *
     C*****************************************************************
     C           #DCA      BEGSR
     C*
     C* seton SFLDSP
     C                     SETON                     33
     C                     Z-ADD*ZEROS    WWSFLC  30
     C*
     C* Read file, load subfile, increase rrn and initialise fields
     C           *IN20     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLP
     C*
     C***********BPCTYI    CHAINSDCTRYL0             71                   S01498
     C*                                                                   S01498
     C** Get country code details using access object                     S01498
     C*                                                                   S01498
     C                     CALL 'AOCTRYR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BPCTYI    P@CNCZ  2                       S01498
     C           SDCTRY    PARM SDCTRY    DSFDY                           S01498
     C*                                                                   S01498
     C************IN71     IFEQ '1'                                       S01498
     C***********A4TYLC    OREQ 'D'                                       S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDCTRYL0'DBFILE                          S01498
     C                     MOVE 'SDCTRYPD'DBFILE                          S01498
     C                     MOVELBPCTYI    DBKEY            * * * * * * * *
     C                     MOVE '005'     DBASE            * DBERROR 005 *
     C                     SETON                     U7U8LR* * * * * * * *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     MOVE A4CNNM    DDCTRN
     C                     END
     C*
     C                     MOVE BPCTYI    DDCTRC
     C           BPCTPC    IFNE *ZEROS
     C                     SETOF                     45
     C                     Z-ADDBPCTPC    DDCTRP
     C                     ELSE
     C                     SETON                     45
     C                     END
     C                     Z-ADDBPREVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    DDCTRD
     C                     MOVE BPREVF    DDCTRF
     C                     MOVE BPREVN    DDCTRO
     C                     ADD  1         RRN
     C                     WRITELB0330S2                 37
     C                     ADD  1         WWSFLC
     C*
     C* Read country file until end of file
     C                     READ LBBPWRL5                 20
     C*
     C                     MOVE *BLANKS   DDCTRC
     C                     MOVE *BLANKS   DDCTRN
     C                     Z-ADD*ZEROS    DDCTRP
     C                     MOVE *BLANKS   DDCTRD
     C                     MOVE *BLANKS   DDCTRF
     C                     Z-ADD*ZEROS    DDCTRO
     C*
     C* End of file setof rollup
     C           *IN20     IFEQ '1'
     C                     SETON                     34
     C                     ELSE
     C                     SETOF                     34
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DD -    Instrument selected                     *
     C**                                                              *
     C**  CALLS          -    #DDA #CLEAR                             *   LB0001
     C**                                                              *
     C**  CALLED BY      -    #D                                      *
     C**                                                              *
     C*****************************************************************
     C           #DD       BEGSR
     C*
     C* Clear subfile
     C                     SETON                     36
     C                     WRITELB0330C3
     C                     SETOF                     36
     C*
     C                     Z-ADD*ZEROS    RRN1
     C                     Z-ADD*ZEROS    WKRRN1  30
     C*
     C* Build initial instrument page
     C********** DDINST ** SETLLLBBPWRL3 *           69                   LB0001
     C******************** READ*LBBPWRL3 *               20               LB0001
     C                     EXSR #DDA
     C                     Z-ADDRRN1      WKRRN1
     C                     SETOF                     40
     C*
     C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C           *IN40     OREQ '1'
     C*
     C* initialise entry fields
     C           *IN99     IFEQ '0'
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVE *BLANKS   DDCTRY
     C                     MOVE *BLANKS   DDINST
     C                     MOVE *BLANKS   DDSECR
     C                     END
     C*
     C                     SETON                     3541
     C***********          EXSR #CLEAR                             LB0001 R00266
     C                     SETOF                     3873
     C*
     C                     WRITELB0330F1
     C                     WRITELB0330C1
     C                     WRITELB0330C3
     C                     EXFMTLB0330F3
     C                     SETOF                     354099
     C                     EXSR #CLEAR                                    R00266
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C* Exit or Previous screen not selected
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C* Rollup requested
     C           *IN39     IFEQ '1'
     C                     Z-ADDWKRRN1    RRN1
     C                     EXSR #DDA
     C                     Z-ADDRRN1      WKRRN1
     C                     SETON                     3541                 B7974
     C                     SETOF                     3873                 B7974
     C                     WRITELB0330F1                                  B7974
     C                     WRITELB0330C1                                  B7974
     C                     WRITELB0330C3                                  B7974
     C                     EXFMTLB0330F3                                  B7974
     C                     SETOF                     354099               B7974
     C                     SETON                     99                   B7974
     C                     ELSE
     C*
     C* Validate input fields
     C           DDPNP8    IFNE *BLANKS
     C           DDCTRY    ORNE *BLANKS
     C           DDINST    ORNE *BLANKS
     C           DDSECR    ORNE *BLANKS
     C*
     C* Entry made return to initial validation
     C                     SETON                     40
     C                     ELSE
     C*
     C* Enter pressed : display screen at current rrn.
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN1
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DDA - Instrument subfile page build             *
     C**                                                              *
     C**  CALLS           - none                                      *
     C**                                                              *
     C**  CALLED BY       - #DD                                       *
     C**                                                              *
     C*****************************************************************
     C           #DDA      BEGSR
     C*
     C* Seton SFLDSP
     C                     SETON                     33
     C                     Z-ADD*ZEROS    WWSFLC  30
     C*
     C* Read file, load subfile, increase rrn and initialise fields
     C           *IN20     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLP
     C*
     C***********BPINST    CHAINSDPLINL4             71                   S01498
     C************IN71     IFEQ '1'                                       S01498
     C***********PDRECI    OREQ '*'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BPINST    P@INST  3                       S01498
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDPLINL4'DBFILE                          S01498
     C                     MOVE 'SDPLINPD'DBFILE                          S01498
     C                     MOVELBPINST    DBKEY            * * * * * * * *
     C                     MOVE '006'     DBASE            * DBERROR 006 *
     C                     SETON                     U7U8LR* * * * * * * *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     MOVE PDISTN    DDINTN
     C                     END
     C*
     C                     MOVE BPINST    DDINTT
     C           BPINPC    IFNE *ZEROS
     C                     SETOF                     45
     C                     Z-ADDBPINPC    DDINTP
     C                     ELSE
     C                     SETON                     45
     C                     END
     C                     Z-ADDBPREVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    DDINTD
     C                     MOVE BPREVF    DDINTF
     C                     MOVE BPREVN    DDINTO
     C                     ADD  1         RRN1
     C                     WRITELB0330S3                 37
     C                     ADD  1         WWSFLC
     C*
     C* Read inst file until end of file
     C                     READ LBBPWRL3                 20
     C*
     C                     MOVE *BLANKS   DDINTT
     C                     MOVE *BLANKS   DDINTN
     C                     Z-ADD*ZEROS    DDINTP
     C                     MOVE *BLANKS   DDINTD
     C                     MOVE *BLANKS   DDINTF
     C                     Z-ADD*ZEROS    DDINTO
     C*
     C* End of file setof SFLEND
     C           *IN20     IFEQ '1'
     C                     SETON                     34
     C                     ELSE
     C                     SETOF                     34
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DE -    Security selected                       *
     C**                                                              *
     C**  CALLS          -    #DEA                                    *
     C**                                                              *
     C**  CALLED BY      -    #D                                      *
     C**                                                              *
     C*****************************************************************
     C           #DE       BEGSR
     C*
     C* Clear subfile
     C                     SETON                     36
     C                     WRITELB0330C4
     C                     SETOF                     36
     C                     Z-ADD*ZEROS    RRN2
     C                     Z-ADD*ZEROS    WKRRN2  30
     C*
     C* Build initial page
     C********** DDSECR ** SETLLLBBPWRL4 *           69                   LB0001
     C******************** READ*LBBPWRL4 *               20               LB0001
     C                     EXSR #DEA
     C                     Z-ADDRRN2      WKRRN2
     C                     SETOF                     40
     C*
     C           *INKC     DOUEQ'1'
     C           *INKL     OREQ '1'
     C           *IN99     OREQ '0'
     C           *IN40     OREQ '1'
     C*
     C* Initialise entry fields
     C           *IN99     IFEQ '0'
     C                     MOVE *BLANKS   DDPNP8
     C                     MOVE *BLANKS   DDCTRY
     C                     MOVE *BLANKS   DDINST
     C                     MOVE *BLANKS   DDSECR
     C                     END
     C*
     C                     SETON                     3541
     C***********          EXSR #CLEAR                             LB0001 R00266
     C                     SETOF                     3873
     C*
     C                     WRITELB0330F1
     C                     WRITELB0330C1
     C                     WRITELB0330C4
     C                     EXFMTLB0330F3
     C                     SETOF                     354099
     C                     EXSR #CLEAR                                    R00266
     C*
     C** Clear msg queue
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ 10
     C                     PARM           WWPGQR  5
     C*
     C* Exit or Previous screen not pressed
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
     C*
     C* Rollup requested
     C           *IN39     IFEQ '1'
     C                     Z-ADDWKRRN2    RRN2
     C                     EXSR #DEA
     C                     Z-ADDRRN2      WKRRN2
     C                     SETON                     99
     C                     ELSE
     C*
     C* Validate input fields
     C           DDPNP8    IFNE *BLANKS
     C           DDCTRY    ORNE *BLANKS
     C           DDINST    ORNE *BLANKS
     C           DDSECR    ORNE *BLANKS
     C*
     C* If entry made return to initial validation
     C                     SETON                     40
     C                     ELSE
     C*
     C* Enter pressed : Display screen at current rrn
     C                     SETON                     99
     C           SFLL      IFNE *ZEROS
     C                     Z-ADDSFLL      RRN2
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #DEA - Security subfile page build               *
     C**                                                              *
     C**  CALLS           - None                                      *
     C**                                                              *
     C**  CALLED BY       - #DE                                       *
     C**                                                              *
     C*****************************************************************
     C           #DEA      BEGSR
     C*
     C* seton SFLDSP
     C                     SETON                     33
     C                     Z-ADD*ZEROS    WWSFLC  30
     C*
     C* Read file, load subfile, increase rrn and initialise fields
     C           *IN20     DOUEQ'1'
     C           WWSFLC    ORGE WWSFLP
     C*
     C           BPSESN    CHAINSECTY                71
     C************IN71*****IFEQ '0'                                       B4645
     C           *IN71     IFEQ '1'                                       B4645
     C           RECI      OREQ '*'
     C***************      MOVEL'*** NOT 'WWSEC1 16                       B8227
     C***************      MOVE 'FOUND **'WWSEC1                          B8227
     C***************      MOVELWWSEC1    WWSEC2 17                       B8227
     C***************      MOVE '*'       WWSEC2                          B8227
     C***************      MOVELWWSEC2    DDSECN                          B8227
     C                     MOVE *BLANKS   DDSECN                          B8227
     C                     ELSE
     C                     MOVE SRPN      DDSECN
     C                     END
     C*
     C                     MOVE BPSESN    DDSECT
     C           BPSEPC    IFNE *ZEROS
     C                     SETOF                     45
     C                     Z-ADDBPSEPC    DDSECP
     C                     ELSE
     C                     SETON                     45
     C                     END
     C                     Z-ADDBPREVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    DDSECD
     C                     MOVE BPREVF    DDSECF
     C                     MOVE BPREVN    DDSECO
     C                     ADD  1         RRN2
     C                     WRITELB0330S4                 37
     C                     ADD  1         WWSFLC
     C*
     C* Read security file until end of file
     C                     READ LBBPWRL4                 20
     C*
     C                     MOVE *BLANKS   DDSECT
     C                     MOVE *BLANKS   DDSECN
     C                     Z-ADD*ZEROS    DDSECP
     C                     MOVE *BLANKS   DDSECD
     C                     MOVE *BLANKS   DDSECF
     C                     Z-ADD*ZEROS    DDSECO
     C*
     C* End of file setof rollup
     C           *IN20     IFEQ '1'
     C                     SETON                     34
     C                     ELSE
     C                     SETOF                     34
     C                     END
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #A  - Initial processing                         *
     C**                                                              *
     C**  CALLS          - None                                       *
     C**                                                              *
     C**  CALLED BY      - Mainline processing                        *
     C**                                                              *
     C*****************************************************************
     C           #A        BEGSR
     C*
     C** Define LDA for use in program
     C** -----------------------------
     C************NAMVAR   DEFN LDA       DTAR                            S01498
     C           *NAMVAR   DEFN           LDA                             S01498
     C*
     C** Initialise DB error fields and store program name
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY                           S01498
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'LB0330'  DBPGM
     C                     OUT  LDA                                       S01498
     C*
     C** Initialise Parms for PM0160
     C                     MOVE 'E'       WWACTN  1
     C                     MOVE 'I'       WWFNMO  1
     C*
     C**   Fill in fields for subroutine ZASNMS                           R00300
     C                     MOVEL*BLANK    ZAPGM  10        Message queue  R00300
     C                     MOVE *BLANKS   ZAMSGF
     C*********************MOVEL'LXGBMSGF'ZAMSGF                          R00300
     C                     MOVEL'LBUSRMSG'ZAMSGF 10        Message file   R00300
     C                     MOVEL*BLANK    ZAPGRL  5        Rel queue      R00300
     C                     MOVEL*BLANK    ZAMSID  7        Message Id.    R00300
     C                     MOVEL*BLANK    ZAMSDA132        Message data.  R00300
     C                     MOVEL*BLANK    ZAMSTP  7        Message type.  R00300
     C*
     C***Read*Bank*Details*File****************************************   S01498
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 20               S01498
     C*
     C************IN20     IFEQ '1'                                       S01498
     C***********BJTYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get bank details using access object                             S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM *BLANKS   P@RTCD  7                       S01498
     C                     PARM '*FIRST ' P@OPTN  7                       S01498
     C           SDBANK    PARM SDBANK    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDBANKPD'DBFILE                          S01498
     C                     MOVE 'SDBANKPD'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            * * * * * * * *
     C                     MOVE '001'     DBASE            * DBERROR 001 *
     C                     SETON                     U7U8LR* * * * * * * *
     C                     OUT  LDA                                       S01498
     C                     RETRN
     C                     ELSE
     C*
     C** Check Date format indicator for ZDATE2
     C           BJDFIN    IFEQ 'M'
     C                     SETON                     98
     C                     ELSE
     C           BJDFIN    IFEQ 'D'
     C                     SETOF                     98
     C                     END
     C                     END
     C                     END
     C*                                                                   S01498
     C**  Rundate in DDMMMYY format                                       S01498
     C*                                                                   S01498
     C                     MOVE BJMRDT    SRUNA                           S01498
     C*
     C** Read the record on SDMMODPD to detemine whether Portfolio Management
     C** is installed. BGMGST = Y if installed
     C*
     C***********          READ SDMMODPD                 20               S01498
     C*
     C************IN20     IFEQ '1'                                       S01498
     C***********BGTYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get Midas Modules details using access object                    S01498
     C*                                                                   S01498
     C                     CALL 'AOMMODR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST ' P@OPTN                          S01498
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C***********          MOVEL'SDMMODPD'DBFILE                          S01498
     C                     MOVE 'SDMMODPD'DBFILE                          S01498
     C                     MOVE *BLANKS   DBKEY            * * * * * * * * *
     C                     Z-ADD2         DBASE            *  DBERROR 002  *
     C                     SETON                     U7U8LR* * * * * * * * *
     C                     OUT  LDA                                       S01498
     C                     RETRN
     C                     END
     C*
     C***Read*the*record*on*Portfolio*Management*ICD*******************   S01498
     C***********          READ SDPORTPD                 20               S01498
     C*
     C************IN20     IFEQ '1'                                       S01498
     C*                                                                   S01498
     C** Get Portfolio Management ICD details using access object         S01498
     C*                                                                   S01498
     C                     CALL 'AOPORTR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST ' P@OPTN                          S01498
     C           SDPORT    PARM SDPORT    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if an error occurred                                       S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'SDPORTPD'DBFILE           * * * * * * * *S01498
     C                     MOVE 'SDPORTPD'DBFILE           * * * * * * * *S01498
     C                     MOVE *BLANKS   DBKEY            *  DBERROR 007  *
     C                     Z-ADD7         DBASE            * * * * * * * * *
     C                     SETON                     U7U8LR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     END
     C*
     C** Initialise SUBFILE Message Queue
     C*
     C                     MOVE *BLANKS   DDPGMQ
     C                     MOVEL'*'       DDPGMQ
     C*
     C** Initialise and clear the program message queue
     C                     MOVE *BLANKS   WWTPGQ
     C                     MOVEL'*'       WWTPGQ
     C                     MOVE *BLANKS   WWPGQR
     C                     MOVEL'*PRV'    WWPGQR
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C** Set Message Subfile Indicator
     C*
     C                     SETON                     26
     C*
     C** Set Sfl Page Sizes
     C*
     C                     Z-ADD13        WWSFLP  30
     C                     Z-ADD6         WWSFLS  30
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**  SUBROUTINE #E  - Termination Processing                     *
     C**                                                              *
     C**  CALLS          - None                                       *
     C**                                                              *
     C**  CALLED BY      - Mainline Processing                        *
     C**                                                              *
     C*****************************************************************
     C           #E        BEGSR
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     ENDSR
     C/EJECT
     C********************************************************************LB0001
     C**                                                                 *LB0001
     C** #CLEAR    - Reset if F12 pressed                                *LB0001
     C**                                                                 *LB0001
     C** CALLS     - None                                                *LB0001
     C**                                                                 *LB0001
     C** CALLED BY - MAIN, #DBAA, #DBB, #DBC, #DC, #DD                   *LB0001
     C**                                                                 *LB0001
     C********************************************************************LB0001
     C           #CLEAR    BEGSR                                          LB0001
     C*                                                                   LB0001
     C** Setof all error msgs associated with screen1                     LB0001
     C*                                                                   LB0001
     C                     SETOF                     212223               LB0001
     C                     SETOF                     242599               LB0001
     C                     SETOF                     272930               LB0001
     C                     SETOF                     314647               LB0001
     C*                                                                   LB0001
     C** Clear msg queue                                                  LB0001
     C*                                                                   LB0001
     C                     CALL 'Y2CLMSC'                                 LB0001
     C                     PARM           WWTPGQ 10                       LB0001
     C                     PARM           WWPGQR  5                       LB0001
     C                     SETON                     40                   LB0001
     C*                                                                   LB0001
     C                     ENDSR                                          LB0001
     C/EJECT                                                              LB0001
     C********************************************************************
     C**                                                                 *
     C** ZASNMS    - Send message to program's message queue             *
     C**                                                                 *
     C** CALLS     - Y2SNMGC                                             *
     C**                                                                 *
     C** CALLED BY - #B #CB #CC #CD #CE #CBA #ZB                         *
     C**                                                                 *
     C********************************************************************
     C           ZASNMS    BEGSR                           ** ZASNMS    **
     C*
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGM  10
     C                     PARM           ZAPGRL  5
     C                     PARM           ZAMSID  7
     C                     PARM           ZAMSGF 10
     C                     PARM           ZAMSDA132
     C                     PARM           ZAMSTP  7
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZB         - This subroutine processes a CMD/23 for Portfolio  *
     C**               Management Enquiries - Extensive Security Checks  *
     C**                                                                 *
     C** CALLS       - ZASNMS QCMDEXC PMC1000 PMC0321 PMC1010 #ZE #BDA   *
     C**                                                                 *
     C** CALLED BY   - #DBAA #DBB #DBC                                   *
     C**                                                                 *
     C********************************************************************
     C           #ZB       BEGSR
     C*
     C**  Clear Msg Queue
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C** Test for Authority to view enquiries.
     C** Is customer a Portfolio Management Customer,otherwise error.
     C***********DDCUNO    CHAINSDPLCSL0             75                   S01498
     C*
     C                     CALL 'AOPLCSR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM DDCUNO    P@CUST 10                       S01498
     C           SDPLCS    PARM SDPLCS    DSFDY                           S01498
     C*                                                                   S01498
     C** If record not found or is deleted return error.
     C************IN75     IFEQ '1'                                       S01498
     C***********QBRECI    ORNE 'D'                                       S01498
     C***********QBCHTP    OREQ 'D'                                       S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C********** QBPCUS    ORNE 'Y'                                       S01498
     C                     SETON                     99
     C                     MOVEL'LBM0068' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C*
     C** For High Level Security continue security checking.
     C***********P9HLVS    IFEQ 'Y'                                       S01498
     C           FCHLVS    IFEQ 'Y'                                       S01498
     C***********WWUPFL    CHAINMUSER                75                   S01498
     C************IN75     IFEQ '1'                                       S01498
     C***********RECI      ORNE 'D'                                       S01498
     C***********CHTP      OREQ 'D'                        * * * * * * * *S01498
     C*                                                                   S01498
     C** Get user details using access object                             S01498
     C*                                                                   S01498
     C                     CALL 'AOUSERR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWUPFL    P@UPRF 10                       S01498
     C***********SDUSER    PARM SDUSER    DSFDY                     S01498087380
     C           SDUSER    PARM SDUSER    DSSDY                           087380
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'MUSER   'DBFILE           *  DBERROR 008 S01498
     C                     MOVE 'MUSERDD 'DBFILE           *  DBERROR 008 S01498
     C                     Z-ADD8         DBASE            * * * * * * * * *
     C                     MOVE *BLANKS   DBKEY
     C                     MOVELWWUPFL    DBKEY
     C                     SETON                     U7U8LR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C*
     C** If user has an account officer check if the a/c officer is
     C** authorised to view customer portfolio details.
     C***********ACOC      IFNE *BLANKS                                   S01498
     C***********ACOF      IFNE *BLANKS                             S01498083547
     C           ACFA      IFNE *BLANKS                                   083547
     C*
     C***********ACOC      IFNE '*A'                                      S01498
     C***********ACOC      ANDNEBBACOC                                    S01498
     C***********ACOF      IFNE '*A'                                S01498083547
     C***********ACOF      ANDNEBBACOC                              S01498083547
     C           ACFA      IFNE 'ALL'                                     083547
     C           ACFA      ANDNEBBACOC                                    083547
     C                     SETON                     99
     C                     MOVEL'LBM0069' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C*
     C                     ELSE
     C*
     C***********BBACOC    CHAINSDACOFL1             75                   S01498
     C************IN75     IFEQ '1'                                       S01498
     C***********AZTYLC    OREQ 'D'                        * * * * * * * *S01498
     C*                                                                   S01498
     C** Get account officer details using access object                  S01498
     C*                                                                   S01498
     C                     CALL 'AOACOFR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBACOC    P@ACOC  2                       S01498
     C           SDACOF    PARM SDACOF    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          MOVEL'SDACOFL1'DBFILE           *  DBERROR 009 S01498
     C                     MOVE 'SDACOFPD'DBFILE           *  DBERROR 009 S01498
     C                     Z-ADD9         DBASE            * * * * * * * * *
     C                     MOVE *BLANKS   DBKEY
     C                     MOVELBBACOC    DBKEY
     C                     SETON                     U7U8LR
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C*
     C                     ELSE
     C*
     C***********AZDPCD    IFNE DEPC                                      S01498
     C           AZDPCD    IFNE DPPT                                      S01498
     C                     SETON                     99
     C                     MOVEL'LBM0069' ZAMSID
     C                     EXSR ZASNMS
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C** The user is authorised to Portfolio Management Enquiries.
     C***Change*current*job*to*become*a*Group*Job*called*CUSTOMER******   S01498
     C           *IN99     IFEQ '0'
     C*
     C***********          MOVE ARR,1     CMD    80                       S01498
     C***********          Z-ADD80        LEN    155                      S01498
     C***********          CALL 'QCMDEXC'                                 S01498
     C***********          PARM           CMD                             S01498
     C***********          PARM           LEN                             S01498
     C*
     C***Set*up*Group*Data*Area****************************************   S01498
     C*                                                                   S01498
     C** Set up DTAARA/*LDA                                               S01498
     C*                                                                   S01498
     C                     EXSR #ZBA
     C*
     C***Write*to*Group*Data*Area**************************************   S01498
     C*
     C**   Write to Local Data Area
     C                     CALL 'PMC1001'
     C                     PARM           WWPLDA
     C*
     C*****Write*to*Group*Data*Area************************************   S01498
     C***********          CALL 'PMC1002'                                 S01498
     C***********          PARM           WWPGDA                          S01498
     C*
     C** Access Portfolio Management Enquiries
     C***********          CALL 'PMC0621'                                 S01498
     C                     CALL 'PM0630'                                  S01498
     C                     PARM           WWUPFL                          S01498
     C*
     C***Access*Group*Data*Area****************************************   S01498
     C*
     C*****Retrieve*contents*of*Group*Data*Area*to*check*for*DBERROR***   S01498
     C*****(Nothing*required*from*WWPLDA)******************************   S01498
     C***********          CALL 'PMC1004'                                 S01498
     C***********          PARM           WWPGDA                          S01498
     C*                                                                   S01498
     C** Retrieve contents of DTAARA/*LDA                                 S01498
     C*                                                                   S01498
     C                     CALL 'PMC1003'                                 S01498
     C                     PARM           WWPLDA                          S01498
     C*
     C***If*database*error*condition*exists*load*required*error********   S01498
     C***Information*from**GDA*to*the*LDA******************************   S01498
     C*                                                                   S01498
     C** If database error exists, load information from *LDA             S01498
     C*                                                                   S01498
     C           QMDBER    IFEQ 'Y'
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVELQMPGM     DBPGM            * * * * * * * * *
     C***********          MOVELQMFILE    DBFILE           *  DBERROR xxx S01498
     C                     MOVE QMFILE    DBFILE           *  DBERROR xxx S01498
     C                     Z-ADDQMERRN    DBASE            * * * * * * * * *
     C                     MOVE QMKEY     DBKEY
     C                     SETON                     U7U8LR
     C*
     C***Change*current*job*to*become*a*NON-Group*Job******************   S01498
     C***********          MOVE ARR,2     CMD                             S01498
     C***********          CALL 'QCMDEXC'                                 S01498
     C***********          PARM           CMD                             S01498
     C***********          PARM           LEN                             S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C*
     C           QMENQT    IFEQ 'Y'
     C                     MOVE '1'       *INKC
     C                     END
     C                     END
     C*
     C***Change*current*job*to*become*a*NON-Group*Job******************   S01498
     C***********          MOVE ARR,2     CMD                             S01498
     C***********          CALL 'QCMDEXC'                                 S01498
     C***********          PARM           CMD                             S01498
     C***********          PARM           LEN                             S01498
     C*
     C                     END
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZBA        - This subroutine loads the Group Data Area         *
     C**                                                                 *
     C** CALLS       - *NONE                                             *
     C**                                                                 *
     C** CALLED BY   - #ZB                                               *
     C**                                                                 *
     C********************************************************************
     C           #ZBA      BEGSR
     C                     MOVE ' '       QMRECI
     C                     MOVE BJMRDT    QMRUNA
     C                     Z-ADDBJRDNB    QMRDNB
     C                     MOVE BJCYCD    QMCYCD                          R00266
     C                     MOVE 'T'       QMTVPS
     C                     MOVE BBCUST    QMCNUM
     C                     MOVE BBCRNM    QMCRNM
     C                     MOVE QBCSBY    QMCSBY
     C                     Z-ADDQBBYDP    QMBYDP
     C***********BBCNCZ    CHAINSDCTRYL1             75                   S01498
     C*                                                                   S01498
     C** Get country code details using access object                     S01498
     C*                                                                   S01498
     C                     CALL 'AOCTRYR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBCNCZ    P@CNCZ  2                       S01498
     C           SDCTRY    PARM SDCTRY    DSFDY                           S01498
     C*                                                                   S01498
     C************IN75     IFEQ '0'                                       S01498
     C***********A4TYLC    ANDNE'D'                                       S01498
     C           P@RTCD    IFEQ *BLANKS                                   S01498
     C                     MOVE A4CNNM    QMNCTX
     C                     ELSE
     C                     MOVE *BLANKS   QMNCTX
     C                     END
     C***********BBCOLC    CHAINSDCTRYL1             75                   S01498
     C*                                                                   S01498
     C** Get country code details using access object                     S01498
     C*                                                                   S01498
     C                     CALL 'AOCTRYR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBCOLC    P@CNCZ  2                       S01498
     C           SDCTRY    PARM SDCTRY    DSFDY                           S01498
     C*                                                                   S01498
     C************IN75     IFEQ '0'                                       S01498
     C***********A4TYLC    ANDNE'D'                                       S01498
     C***********          MOVE A4CNNM    QMWADT                          R00266
     C           P@RTCD    IFEQ *BLANKS                                   S01498
     C                     MOVE A4CNNM    QMDCTX                          R00266
     C                     ELSE
     C***********          MOVE *BLANKS   QMWADT                          R00266
     C                     MOVE *BLANKS   QMDCTX                          R00266
     C                     END
     C                     MOVE QBLANG    QMLANG
     C*
     C** DATE OF BIRTH
     C***********          Z-ADDQBBDAT    WWDAT1                          088182
     C***********                                                         088182
     C***********WWMON1    IFGT 0                                         088182
     C***********                                                         088182
     C***********          Z-ADDWWMON1    X       20                      088182
     C***********          Z-ADDWWDAY1    WWDAY2                          088182
     C***********          Z-ADDWWYER1    WWYER2                          088182
     C***********          MOVELZMNM,X    WWMON2                          088182
     C***********                                                         088182
     C***********          MOVE WWDAT2    QMBDA1                          088182
     C***********          ELSE                                           088182
     C***********          MOVEL*BLANKS   QMBDA1                          088182
     C***********          END                                            088182
     C*                                                                   088182
     C** CASE: DB1.Date of Birth (Portfolio) is Zero                      088182
     C*                                                                   088182
     C           QBBDAT    IFEQ *ZERO                                     088182
     C                     MOVEL*BLANKS   QMBDA1                          088182
     C                     ELSE                                           088182
     C*                                                                   088182
     C** CASE: Check File Date - Rundate  *                               088182
     C*                                                                   088182
     C                     Z-ADDQBBDAT    ZDAYNO  50                      088182
     C                     EXSR ZDATE2                                    088182
     C************         MOVELZDATE     QMBDA1                    088182092955
     C                     MOVELZADATE    QMBDA1                          092955
     C                     END                                            088182
     C*
     C                     MOVE BBACOC    QMACOC
     C***********BBACOC    CHAINSDACOFL1             75                   S01498
     C************IN75     IFEQ '0'                                       S01498
     C***********AZTYLC    ANDNE'D'                                       S01498
     C*                                                                   S01498
     C** Get account officer details using access object                  S01498
     C*                                                                   S01498
     C                     CALL 'AOACOFR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBACOC    P@ACOC                          S01498
     C           SDACOF    PARM SDACOF    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFEQ *BLANKS                                   S01498
     C                     MOVE AZACON    QMACON
     C                     ELSE
     C                     MOVE *BLANKS   QMACON
     C                     END
     C*
     C**   Date account officer assumed
     C****                 Z-ADDQBDASS    ZDAYNO                          S01313
     C****                 EXSR ZDATE2                                    S01313
     C****                 MOVE ZADATE    QMDTA1                          S01313
     C*
     C                     MOVE QBSAFI    QMSAFI
     C                     MOVE QBDCMS    QMDCMS
     C****                 MOVE QBFPVC    QMFPVC                          S01313
     C                     MOVE *BLANKS   QMPTF1
     C                     MOVE *BLANKS   QMPTF2
     C                     MOVE *BLANKS   QMPTFN
     C                     MOVE *BLANKS   QMTPMV
     C                     MOVE *BLANKS   QMVPMV
     C***********          MOVE *BLANKS   QMPTA1                          R00266
     C                     MOVE *BLANKS   QMPTAI                          R00266
     C                     MOVE *BLANKS   QMPVAI                          R00266
     C                     MOVE *BLANKS   QMPTCY
     C                     Z-ADD*ZEROS    QMPCDP
     C                     MOVE *BLANKS   QMPTFT
     C                     MOVE *BLANKS   QMDPO1
     C                     MOVE *BLANKS   QMPPDG
     C                     MOVE *BLANKS   QMDSPG
     C                     MOVE *BLANKS   QMNDSP
     C                     MOVE *BLANKS   QMDSPT
     C                     Z-ADD*ZEROS    QMDSPS
     C                     MOVE *BLANKS   QMDGMV
     C                     MOVE *BLANKS   QMDGAI
     C                     MOVE *BLANKS   QMINNR
     C                     MOVE *BLANKS   QMISTN
     C                     Z-ADD*ZEROS    QMITDS
     C                     MOVE *BLANKS   QMTIMV
     C                     MOVE *BLANKS   QMVIMV
     C                     MOVE *BLANKS   QMITAI
     C                     MOVE *BLANKS   QMIVAI                          R00266
     C                     MOVE *BLANKS   QMMODI
     C                     MOVE *BLANKS   QMSESN
     C**********           Z-ADD*ZEROS    QMTRNB                                              CLE148
     C                     MOVEL*BLANKS   QMTRNB                                              CLE148
     C***********          MOVE 'N'       QMENQT                          R00266
     C***********          MOVE 'N'       QMDBER                          R00266
     C                     MOVE *BLANKS   QMENQT                          R00266
     C                     MOVE *BLANKS   QMDBER                          R00266
     C                     MOVE 'N'       QMATTN
     C                     MOVE *BLANKS   QMPGM
     C                     MOVE *BLANKS   QMFILE
     C                     MOVE *BLANKS   QMKEY
     C                     Z-ADD*ZEROS    QMERRN
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZC         - This subroutine processes a CMD/24 for Portfolio  *
     C**               Management Documentation                          *
     C**                                                                 *
     C** CALLS       - #ZE PM0160 Y2CLMSC                                *
     C**                                                                 *
     C** CALLED BY   - #DBAA #DBB #DBC                                   *
     C**                                                                 *
     C********************************************************************
     C           #ZC       BEGSR
     C*
     C** Clear Message Queue
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C                     SETON                     74
     C                     MOVE '0'       WWRTCD
     C                     MOVE DDCUNO    WWPNP8
     C***********          UNLCKDTAR                                      S01498
     C                     UNLCKLDA                                       S01498
     C                     CALL 'PM0160'
     C                     PARM           WWACTN
     C                     PARM           WWRTCD
     C                     PARM           WWPNP8
     C                     PARM           WWFNMO
     C*
     C** If errors in called program , return to point of call
     C************LOCK     IN   DTAR                                      S01498
     C           *LOCK     IN   LDA                                       S01498
     C           DBASE     IFGT 0
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     EXSR #ZE
     C                     RETRN
     C                     ELSE
     C                     MOVEL'LB0330'  DBPGM
     C                     END
     C*
     C** Returned function key = Exit
     C           WWRTCD    IFEQ '1'
     C                     MOVE '1'       *INKC
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZE         - This subroutine calls 'PM0160'                    *
     C**                                                                 *
     C** CALLS       - PM0160                                            *
     C**                                                                 *
     C** CALLED BY   - MAINLINE                                          *
     C**                                                                 *
     C********************************************************************
     C*
     C           #ZE       BEGSR
     C           *IN74     IFEQ '1'
     C*
     C** Save WWLDA fields to restore DBERROR after this call
     C                     MOVE DBFILE    WWDBF2  8
     C                     MOVE DBKEY     WWDBK2 29
     C                     MOVE DBPGM     WWDBP2 10
     C                     Z-ADDDBASE     WWDBS2  30
     C*
     C** Call 'PM0160' if already called once during execution of program
     C                     MOVE '9'       WWRTCD  1
     C                     MOVE *BLANKS   WWPNP8  6
     C***********          UNLCKDTAR                                      S01498
     C                     UNLCKLDA                                       S01498
     C                     CALL 'PM0160'
     C                     PARM           WWACTN
     C                     PARM           WWRTCD
     C                     PARM           WWPNP8
     C                     PARM           WWFNMO
     C*
     C************LOCK     IN   DTAR                                      S01498
     C           *LOCK     IN   LDA                                       S01498
     C*
     C** If a database error was NOT already detected then check for one
     C** in PM0160 now...
     C           WWDBS2    IFEQ 0
     C*
     C** If database error in PM0160
     C           DBASE     IFGT 0
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     END
     C*
     C                     ELSE
     C*
     C** Else restore previous DBERROR
     C                     MOVE WWDBF2    DBFILE
     C                     MOVE WWDBK2    DBKEY
     C                     MOVE WWDBP2    DBPGM
     C                     Z-ADDWWDBS2    DBASE
     C                     END
     C*
     C                     END
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZDATE2Z2
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   *PSSR     - PROGRAM ERROR HANDLING ROUTINE                 *
     C**                                                              *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C                     ENDSR
     C/EJECT
      *                                                                   S01498
      ** Array ARR physically removed from compile-time array             S01498
      *                                                                   S01498
      **   NUM - ARRAY OF NUMBERS 0-9   - RMOVED (CSD027)                                   CSD027
      ** 0123456789                                                                         CSD027
**   CPY@
(c) Misys International Banking Systems Ltd. 2001
**   ALPNU - ARRAY OF ALPHANUMERICS A-Z, BLANK, 0-9
A BCDEFGHIJKLMNOPQRSTUVWXYZ0123456789
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
