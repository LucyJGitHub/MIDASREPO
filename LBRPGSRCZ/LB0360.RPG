     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Portfolio Lending report')                    *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                         *
     F*                                                               *
     F*  LB0360 - Portfolio Lending Report                            *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CCB020             Date 06Aug12               *
      *                 CLE064             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER047             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CDL049             Date 07Jul06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CDL038             Date 10May05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CDL020             Date 03Feb04               *
      *                 CDL019             Date 03Feb04               *
      *                 CDL018             Date 03Feb04               *
      *                 CDL017             Date 03Feb04               *
      *                 CDL016             Date 03Feb04               *
      *                 CGL029             Date 01Sep03               *
      *                 222727             Date 05Nov03               *
      *                 CDL010             Date 02Aug02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 087628             Date 01Sep95               *
      *                 S01498             Date 11Aug94               *
     F*                 001313             DATE 26SEP91               *
     F*                 SA9101             DATE 12APR91               *
     F*                 SA9109             DATE 05APR91               *
     F*                 LB2000             DATE 23OCT90               *
     F*                 R0665_DC           DATE 23OCT90               *
     F*                 B4810              DATE 23OCT90               *
     F*                 LB0004             DATE 29JUN90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CLE134 - Past Due Call Loan Processing (Recompile)           *
      *  CLE148 - Alpha Loan Reference                                *
      *  CCB020 - COB Restructure - Secondary COB Infrastructure      *
      *  CLE064 - Enhancement of Lending Frequencies (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER047 - German Features LF037-00 Reporting §24c             *
      *           (Recompile)                                         *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type                              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CDL020 - Apply Base Rate at Value Date (Recompile)           *
      *  CDL019 - Allow Base Rate Changes on Fixed Deposits/Loans     *
      *           (Recompile)                                         *
      *  CDL018 - Multiple Settlement Accounts on Loans/Deposits      *
      *           (Recompile)                                         *
      *  CDL017 - Penalty Fee & Early Maturity of Fixed Term Loan/Dep *
      *           (Recompile)                                         *
      *  CDL016 - Automatic rollover of Fixed Term Loans/Deposits     *
      *           (Recompile)                                         *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  CDL010 - Prevent last user that actioned the trade from      *
      *           authorising it.Recompile due to changes in MMDELDPP.*
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
     F*  087628 - Add branches to accounts                            *
     F*  S01498 - Portfolio Lending Upgrade to Release 10             *
     F*  001313 - MATURED COMMITMENT LINE NOT TO BE USED              *
     F*  SA9101 - PORTFOLIO LENDING Forward Movements                 *
     F*  SA9109 - Print Margin Percentage on the report               *
     F*  LB2000 - PRECIOUS METALS                                     *
     F*  R0665  - -) EDITING OF PERCENTAGES                           *
     F*           -) THIS REPORT SHOWS UNREALISED FX FROFIT AS        *
     F*              COLLATERAL, WHICH IS NOT CORRECT.                *
     F*  B4810  - DO NOT DEFAULT BORROW POWER TO 100% IF 0%           *
     F*  B4810  - EDITING OF PERCENTAGES                              *
     F*  LB0004 - DISPLAY NET UNREALISED P/L                          *
     F*         - REMOVE REFERENCES TO EXPOSURE LIMIT ON REPORT       *
     F*         - CHANGE TOTAL COLLATERAL CALCULATION                 *
     F*         - CHANGE EQUITY CALCULATION                           *
     F*         - INCLUDE PROCESSING FOR ACCOUNT UTILISATION          *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F********************************************************************
     F*
     F**      FILE DEFINITIONS
     F**     ------------------
     F*
     F*****PORTFOLIO*LENDING*DETAILS*FILE.*PREFIX*-*LB*****************   S01498
     F***SDLOMBPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F*****BANK*DETAILS*FILE.*PREFIX*-*BJ******************************   S01498
     F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F** RUN CONTROLS PRINTER FILE
     FLB0360AUO   E             32     PRINTER      KINFSR *PSSR
     F***********                                   KINFDS ERF2DS         S01498
     F                                              KINFDS SPOOLU         S01498
     F*
     F*****Report*Selection*File.*No*Prefix.***************************   S01498
     F***QINLINE*IF**F      96            DISK         KINFSR *PSSR     UCS01498
     F*
     F*****ACCOUNT*OFFICERS*FILE.*PREFIX*AZ****************************   S01498
     F***SDACOFL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F*****CURRENCY*FILE.*PREFIX*-*A6**********************************   S01498
     F***SDCURRL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** MAIN DETAILS PRINTER FILE
     F***LB0360P1O***E             31     PRINTER      KINFSR *PSSR       S01498
     F***********                                   KINFDS ERF1DS         S01498
     FLB0360P1O   E             31     PRINTER      KINFSR *PSSR      UC  S01498
     F                                              KINFDS SPOOL          S01498
     F*
     F**   CLIENT MASTER FILE (KEYED ON CUST NO.). PREFIX - BB & CU
     F***SDLBCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ0IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   CLIENT MASTER FILE (PF/SDLBCSPD) (KEYED ON CUST NO.). PREFIX - CU
     F***SDLBCSL9UF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSL9UF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   Authorised Commitment file. PREFIX - CA
     FLBCOMAL2IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Client Master File (Brch code/Acct.Off./customer). Prefix - BB & CU
     F***SDLBCSLAIF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJAIF  E           K        DISK         KINFSR *PSSR          S01498
     F            SDLBCSJ0                          KRENAMESDLBCSJA
     F*
     F** Client Master File (Account Off./customer). Prefix - BB & CU
     F***SDLBCSLBIF**E           K        DISK         KINFSR *PSSR       S01498
     F*********** SDLBCSJ0                          KRENAMESDLBCSJB       S01498
     F*
     F** Client Master File (Parent/customer). Prefix - BB & CU
     F***SDLBCSL6IF  E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ6IF  E           K        DISK         KINFSR *PSSR          S01498
     F            SDLBCSJ0                          KRENAMESDLBCSJ6
     F*                                                                   LB0004
     F** Portfolio Extract Details (Cust/Instr). Prefix - EE              LB0004
     FLBEXTRL2IF  E           K        DISK         KINFSR *PSSR          LB0004
     F            LBEXTRD0                          KRENAMELBEXTRD2       LB0004
     F*
     F** Portfolio Extract Details (Cust/Instr.). Prefix - EE
     FLBEXTRL4IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Portfolio Extract Details (Parent/Instr.). Prefix - EE
     FLBEXTRL7IF  E           K        DISK         KINFSR *PSSR
     F            LBEXTRD0                          KRENAMELBEXTRD7
     F*
     F** portfolio Extract Details (Cust/Instr.). Prefix - EE
     FLBEXTRLAIF  E           K        DISK         KINFSR *PSSR
     F            LBEXTRD0                          KRENAMELBEXTRDA
     F*
     F** Portfolio Extract Details (Parent/Instr.). Prefix - EE
     FLBEXTRLBIF  E           K        DISK         KINFSR *PSSR
     F            LBEXTRD0                          KRENAMELBEXTRDB
     F*
     F***Portfolio*Credit*Groups.*Prefix*-*GP**************************   S01498
     F***LBGROUL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***Instrument*Types.*Prefix*-*PD*********************************   S01498
     F***SDPLINL4IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   Portfolio Extract Summary. Prefix - ES
     FLBEXTSL1IF  E           K        DISK         KINFSR *PSSR
     F*
     F**   PLEDGES FILE. PREFIX - PG
     FLBPLEGL2IF  E           K        DISK         KINFSR *PSSR
     F*
     F** Deal type/sub-type                                               SA9101
     F***SDDTSTLBIF  E           K        DISK         KINFSR *PSSRSA9101 S01498
     FFDDTSTL0IF  E           K        DISK         KINFSR *PSSR          S01498
     F*                                                                   SA9101
     F***Loan*type/sub-type****************************************SA9101 S01498
     F***SDLOANL1IF**E           K        DISK         KINFSR *PSSRSA9101 S01498
     F*                                                                   SA9101
     F** Customer loans - Loans without Guaranties                        SA9101
     F***CLOANCL2IF**E           K        DISK         KINFSR *PSSRSA9101 S01498
     FLBLOANL2IF  E           K        DISK         KINFSR *PSSR          S01498
     F*                                                                   SA9101
     F** Customer loans - Guaranties                                      SA9101
     F***CLOANCL3IF**E           K        DISK         KINFSR *PSSRSA9101 S01498
     FLBLOANL3IF  E           K        DISK         KINFSR *PSSR          S01498
     F            CLOANCLF                          KRENAMECLOANCF3       SA9101
     F*                                                                   SA9101
     F***Fiduciary*deposits****************************************SA9101 S01498
     F***FIDEPOLAIF**E           K        DISK         KINFSR *PSSRSA9101 S01498
     F*********** FIDEPOD0                          KRENAMEFIDEPODASA9101 S01498
     F*                                                                   SA9101
     F** Loans/Deposits/CD Issued                                         SA9101
     F***MMDELDL2IF**E           K        DISK         KINFSR *PSSRSA9101 S01498
     FLBDELDL2IF  E           K        DISK         KINFSR *PSSR          S01498
     F            MMDELDP0                          KRENAMEMMDELDD1       SA9101
     F*                                                                   SA9101
     F********************************************************************
     F/EJECT
     F********************************************************************
     F**                                                                 *
     F** ID F  C  H  L    FUNCTION OF INDICATORS                         *
     F**                 ------------------------                        *
     F***01*************-*EOF*etc*on*SDLBCSLA**************************  *S01498
     F***03*************-*EOF*etc*on*SDLBCSLB**************************  *S01498
     F***06*************-*EOF*etc*on*SDLBCSL6**************************  *S01498
     F***09*************-*EOF*etc*on*SDLBCSL9**************************  *S01498
     F***10*************-*EOF*etc*on*SDLBCSL0**************************  *S01498
     F** 01             - EOF etc on LBLBCSJA                            *S01498
     F** 06             - EOF etc on LBLBCSJ6                            *S01498
     F** 09             - EOF etc on LBLBCSL9                            *S01498
     F** 10             - EOF etc on LBLBCSJ0                            *S01498
     F***11*************-*EOF*etc*on*CLOANCL2,*CLOANCL3,*FIDEPOLA**SA9101 S01498
     F** 11             - EOF etc on LBLOANL2, LBLOANL3...               *S01498
     F** 13             - PRINT HEADER OF THE FORWARD TRANSACTIONS       *SA9101
     F**    20          - DATABASE ERROR ON SD----- FILES                *
     F**    21          - 'PARENT NO.' REQUIRED ON REPORT                *
     F**    22          - 'CUSTOMER NO.' REQUIRED ON REPORT              *
     F**    23          - PLEDGES REC'D INCR/DO NOT INCR BORROWING POWER *
     F**    24          - NOTES 2) & 3) REQUIRED ON REPORT               *
     F**    25          - COMMITMENT RECORD FOUND                        *
     F**    26          - 'FOR LOAN'      REQUIRED UNDER SPECIFIC UTILN. *
     F**    27          - 'FOR FACILITY'  REQUIRED UNDER SPECIFIC UTILN. *
     F**    28          - 'FOR PORTFOLIO' REQUIRED UNDER SPECIFIC UTILN. *
     F**    29          - CUSTOMER NOT FOUND                             *
     F**    30          - EXTRA BLANK LINE BEFORE DETAIL3 O/P RECORD     *
     F**    31          - OVERFLOW INDICATOR ON PRINTER FILE             *
     F**    32          - OVERFLOW INDICATOR ON CONTROLS FILE            *
     F******33**********-*A/C*OFFICER*NOT*FOUND*ON*SDACOFL0************  *S01498
     F**    34          - OVERVIEW %ages to appear                       *
     F**    35          - NOTE 3) TO APPEAR                              *
     F**    36          - USE FOR ADDITIONAL INFORMATION                 *R0665
     F**    37          - WORK INDICATOR                                 *R0665
     F**    39          - MULTIBRANCHING INDICATOR                       *S01498
     F*********40*******-*END*OF*FILE*QINLINE*****************************S01498
     F**       41       - READE ON LBEXTRL4 or LBEXTRL7                  *
     F**       42       - CALLED FROM INPUT CYCLE - PRINT SELECTIONS     *
     F**       43       - PRINT BRANCH CODE ON RUN CONTROLS              *
     F**       44       - PRINT ACCOUNT CODE ON RUN CONTROLS             *
     F**       45       - PRINT CUSTOMER NUMBER ON RUN CONTROLS          *
     F**       46       - PRINT CUSTOMER SHORTNAME ON RUN CONTROLS       *
     F**       47       - 'FOR ACCOUNT' REQUIRED UNDER SPECIFIC UTILN.   *LB0004
     F**       50       - PRINT FORWARD TRANSACTIONS                     *SA9101
     F**       51       -                                                *
     F**       52       -                                                *
     F**       53       -                                                *
     F**       54       -                                                *
     F**       55       -                                                *
     F**       56       -                                                *
     F**       57       -                                                *
     F**       58       -                                                *
     F**       59       - CHAIN ON LBEXTRL2                              *
     F*********72*******-*CUST*CCY*NOT*FOUND*IN*SDCURRL1***************  *S01498
     F*********74*******-*EOF*ON*SDPLINL0******************************  *S01498
     F**       75       - EOF ON LBEXTRL4 or LBEXTRL7                    *
     F*********76*******-*EOF*ON*LBGROUL1******************************  *S01498
     F**       77       - EOF ON LBCOMAL2                                *
     F**       78       - EOF ON LBEXTSL1                                *
     F**       79       - EOF ON LBPLEGL2                                *
     F**       U7 ----->  DATABASE                                        SA9101
     F**       U8 ----->       ERROR                                      SA9101
     F********************************************************************
     E/EJECT
     E********************************************************************
     E*
     E** Array for copyright
     E                    CPY@    1   1 80
     E*
     E                    POWER   1   7  7 3
     E*
     E** SCONV S/R array for powers of 10
     E*
     E/COPY ZSRSRC,ZSEDITZ1
     E***/COPY*LBSRSRC,ZHOLE                                              S01498
     E/COPY ZSRSRC,ZHOLE                                                  S01498
     E/COPY ZSRSRC,ZDATE2Z1
     E***/COPY*LBSRSRC,SFRQAZ1                                            S01498
     E/COPY ZSRSRC,ZFRQAZ1                                                S01498
     E*                                                                   SA9101
     E**  Array for sr. ZA0710 - Cumulative days in year for 4 year periodSA9101
     E                    @YD     4   4  5 0A                             SA9101
     E*                                                                   SA9101
     E**  Array for sr. ZA0710 - Cumulative days in year per month        SA9101
     E                    @MD    13  13  5 0A                             SA9101
     E********************************************************************
     I/EJECT
     I********************************************************************
     I*
     I*****INTERNALLY*DEFINE*QINLINE***********************************   S01498
     I***QINLINE NS                                                       S01498
     I***********                             1   3 WWQBRC                S01498
     I***********                             4   5 WWQACO                S01498
     I***********                             6  110WWQCNO                S01498
     I***********                             6  11 WWQCNA                S01498
     I@RPARM      DS                            100                       S01498
     I**  Report parameters                                               S01498
     I                                        1   60WWQCNO                S01498
     I                                        1   6 WWQCNA                S01498
     ICPYR@#      DS
     I*
     I** Data structure for compilation - copyright insertion
     I                                        1  80 CPY@
     I                                        1  80 CPY@##
     I/COPY ZSRSRC,ZSEDITZ2
     I***/COPY*LBSRSRC,ZHOLI                                              S01498
     I/COPY ZSRSRC,ZHOLI                                                  S01498
     IPSDS       SDS
     I*
     I**   PROGRAM STATUS DATA STRUCTURE
     I                                      244 253 JOB
     I                                      254 263 USER
     I***ERF1DS******DS                                                   S01498
     ISPOOL       DS                                                      S01498
     I                                       83  92 SFILE                 S01498
     I                                    B 123 1240SFNUM                 S01498
     I*
     I**   FILE INFORMATION DATA STRUCTURE
     I**   FOR OVERFLOW
     I                                    B 367 3680LINE
     I*
     I***ERF2DS******DS                                                   S01498
     ISPOOLU      DS                                                      S01498
     I                                       83  92 SFILEU                S01498
     I                                    B 123 1240SFNUMU                S01498
     I*
     I**   FOR OVERFLOW
     I                                    B 367 3680LINE1
     I            DS                                                      R0665
     I*                                                                   R0665
     I**   FOR PERCENTAGE DO NOT TAKE THE SIGNE                           R0665
     I                                        1  21 ZOUT21                R0665
     I                                       18  20 NOSIGN                R0665
     I***LDA********UDS                            256                    S01498
     ILDA         DS                            256                       S01498
     I*
     I**   LOCAL DATA AREA
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     IPLGKDS      DS
     I*
     I** PLEDGE KEY DS FOR DBERROR FIELD DBKEY
     I                                        1   7 PLGKY
     I**********                              1   60EECNUM                                    CSD027
     I                                        1   6 EECNUM                                    CSD027
     I                                        7   7 WWTYPE
     I*                                                                   SA9101
     I*KEY4********DS******************************4               SA9101 CLE042
     IKEY8        DS                              8                       CLE042
     I                                        1   2 WWTYP                 SA9101
     I                                        3   4 WWSUB                 SA9101
     I                                        5   8 WWCLS                 CLE042
     I*                                                                   SA9101
     I** Data structure for sr. ZA0710 - Field is @@Z71Y                  SA9101
     I            DS                                                      SA9101
     I                                        1   40@@Z71Y                SA9101
     I                                        1   10@@SSY1                SA9101
     I                                        2   20@@SSY2                SA9101
     I                                        3   30@@SSY3                SA9101
     I                                        4   40@@SSY4                SA9101
     I*                                                                   SA9101
     I** Data structure for sr. ZA0710 - Field is @@VDT                   SA9101
     I            DS                                                      SA9101
     I                                        1   80@@VDT                 SA9101
     I                                        1   40@@YR                  SA9101
     I                                        5   60@@Z71M                SA9101
     I                                        7   80@@Z71D                SA9101
     I*                                                                   SA9101
     I** To split the year of the maturity date                           SA9101
     IDSMDYY      DS                              4                       SA9101
     I                                        1   2 HKMDY1                SA9101
     I                                        3   4 HKMDY2                SA9101
     I*                                                                   SA9101
     I** To split the year of the value date                              SA9101
     IDSVDYY      DS                              4                       SA9101
     I                                        1   2 HKVDY1                SA9101
     I                                        3   4 HKVDY2                SA9101
     I*                                                                   SA9101
     I*                                                                   001313
     I**   Phase of Day                                                   001313
     I***MPHAS*******DS                                                                001313 CCB020
     I**********                              1   1 PHASE                              001313 CCB020
     I*                                                                   001313
     IRUNDAT    E DS                                                      S01498
     I**  Standard Data Area Layout for System flags and Run Date         S01498
     I*                                                                   S01498
     ISDBANK    E DSSDBANKPD                                              S01498
     I**  Data structure for bank details                                 S01498
     I*                                                                   S01498
     ISDBRCH    E DSSDBRCHPD                                              S01498
     I**  Data structure for branch details                               S01498
     I*                                                                   S01498
     ISDGELR    E DSSDGELRPD                                              S01498
     I**  Data structure for general ledger details                       S01498
     I*                                                                   S01498
     ISDLOMB    E DSSDLOMBPD                                              S01498
     I**  Data structure for Portfolio Lending ICD                        S01498
     I*                                                                   S01498
     ISDCURR    E DSSDCURRPD                                              S01498
     I**  Data structure for currency details                             S01498
     I*                                                                   S01498
     ISDACOF    E DSSDACOFPD                                              S01498
     I**  Data structure for account officer details                      S01498
     I*                                                                   S01498
     ISDPLIN    E DSSDPLINPD                                              S01498
     I**  Data structure for instrument type details                      S01498
     I*                                                                   S01498
     ISDLOAN    E DSSDLOANPD                                              S01498
     I**  Data structure for loan type/subtype details                    S01498
     I*                                                                   S01498
     ISDGROU    E DSLBGROUPD                                              S01498
     I**  Data structure for lending group details                        S01498
     I*                                                                   S01498
     IDSFDY     E DSDSFDY                                                 S01498
     I**  Short data structure for access programs                        S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I**  Long data structure for access programs                         S01498
     I*                                                                   S01498
     I*****************************************************************
     C/EJECT
     C*
     C** PARAMETER LIST DECLARATIONS
     C** ---------------------------
     C** WWICFG - INPUT CYCLE FLAG - 0 = CALLED FROM END OF DAY
     C**                           - 1 = CALLED FROM INPUT CYCLE
     C           *ENTRY    PLIST
     C                     PARM           WWICFG  1
     C                     PARM           @RSEQ   5                       S01498
     C                     PARM           @RLEV   1                       S01498
     C                     PARM           @RENT   3                       S01498
     C                     PARM           @RPARM                          S01498
     C*****************************************************************
     C*                                                                   LB0004
     C**   KLISTS                                                         LB0004
     C*                                                                   LB0004
     C           WWCKY1    KLIST                           'LBEXTRL2'     LB0004
     C**********           KFLD           WWCUST  60                                   LB0004 CSD027
     C                     KFLD           WWCUST  6                                           CSD027
     C                     KFLD           LBFXMA                          LB0004
     C*                                                                   LB0004
     C**   Key list 2                                                     SA9101
     C           WWCKY2    KLIST                                          SA9101
     C                     KFLD           WWCUST                          SA9101
     C                     KFLD           BJRDNB                          SA9101
     C*                                                                   SA9101
     C**   Key list 3                                                     SA9101
     C           WWCKY3    KLIST                                          SA9101
     C                     KFLD           WWCUST                          SA9101
     C                     KFLD           @@YR                            SA9101
     C                     KFLD           @@Z71M                          SA9101
     C                     KFLD           @@Z71D                          SA9101
     C*                                                                   SA9101
     C**   Key list 4                                                     SA9101
     C           WWCKY4    KLIST                                          SA9101
     C                     KFLD           WWTYP   2                       SA9101
     C                     KFLD           WWSUB   2                       SA9101
     C                     KFLD           WWCLS   4                       CLE042
     C*                                                                   SA9101
     C********************************************************************
     C*
     C**              START MAINLINE
     C**             ----------------
     C*
     C**   INITIALISATION
     C                     EXSR #A
     C*
     C**   MAIN PROCESSING
     C                     EXSR #B
     C*
     C**   TERMINATION PROCESSING
     C                     EXSR #C
     C*
     C**   END PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C*****************************************************************
     F/EJECT
     F********************************************************************
     F**                                                                 *
     F**        INDEX TO SUBROUTINES                                     *
     F**       ----------------------                                    *
     F**                                                                 *
     F**  1.  #BA    - Full or branch report                             *
     F**  2.  #BB    - Produce a report for a selected customer
     F****3.**#BC****-*Account*officer*report**************************  *S01498
     F**
     F**  4.  SCONV  - Converts an amount from one currency to another   *
     F**  5.  ZSEDIT - Converts an amount to display format              *
     F**
     F**  6.  #A     - Accesses ICD 1 and initialises work fields        *
     F**  7.  #B     - Main processing                                   *
     F**  8   #C     - Termination processing                            *
     F**
     F**  9.  #ZA    - Database error handling                           *
     F** 10.  #ZC    - Set up Account Officer, Cust. No., Parent No.
     F** 11.  #ZD    - Produce Overview setion of report
     F**
     F** 12.  #ZE    - Produce Exposure & Collateral Details section
     F**             - of report
     F** 13.  #ZEA   - Read LBGROUL1 for group name for display
     F** 14.  #ZEB   - Read extract records for instruments in groups
     F**
     F** 15.  #ZF    - Produce a run control report
     F**
     F** 16.  #ZG    - Write Collateral Borrowing power details
     F** 17.  #ZGA   - Print a detail record
     F** 18.  #ZGB   - Write all extract records for instrument
     F** 19.  #ZGBA  - Borrowing power percentage calculations
     F** 20.  #ZGBB  - Calcualte Collateral & Borrowing power
     F** 21.  #ZGBC  - Set up report amounts and write record
     F** 22.  #ZGBD  - Set up report amounts & write record for pledge
     F**
     F** 23.  #ZH    - Produce a report for a single customer
     F** 24.  #ZI    - Produce report for customer during End of Day
     F** 25.  #ZJ    - Retrieve Account officer or print no details
     F**
     F** 26.  *PSSR  - Program error handling routine                    *
     F*                                                                  *
     F********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**  SCONV - Converts an amount from one currency to another.       *
     C**                                                                 *
     C**  Input Fields - WWAMTI 15/0 amount in input currency            *
     C**                 WWSRI  13/8 spot rate for input currency        *
     C**                 WWSRO  13/8 spot rate for output currency       *
     C**                 WWDPI  1/0  no. of decimals for input currency  *
     C**                 WWDPO  1/0  no. of decimals for output currency *
     C**                 WWMDI  1    mult/div indicator for input curr.  *
     C**                 WWMDO  1    mult/div indicator for output curr. *
     C**                                                                 *
     C**  Arrays       - POWER  powers of 10                             *
     C**                                                                 *
     C**  Output Fields- WWAMTO 15/0 output amount converted to new curr *
     C**                                                                 *
     C**  CALLS    - NONE                                                *
     C**                                                                 *
     C********************************************************************
     C           SCONV     BEGSR                           **  SCONV    **
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDWWAMTI    WWAMTI 150
     C                     Z-ADD0         WWAMTO 150
     C           *LIKE     DEFN A6SPRT    WWSRI
     C           *LIKE     DEFN A6SPRT    WWSRO
     C           *LIKE     DEFN A6NBDP    WWDPI
     C           *LIKE     DEFN A6NBDP    WWDPO
     C           *LIKE     DEFN A6MDIN    WWMDI
     C           *LIKE     DEFN A6MDIN    WWMDO
     C*
     C           WWDPO     SUB  WWDPI     Z       10
     C           Z         ADD  4         Z
     C*
     C           WWMDI     IFNE WWMDO
     C*
     C** MULT/DIV INDICATORS DIFFERENT
     C           WWSRI     MULT WWSRO     WWRATE 159H
     C                     ELSE
     C*
     C** MULT/DIV INDICATORS THE SAME
     C           WWSRO     IFEQ 0
     C                     GOTO SC0
     C                     END
     C           WWSRI     DIV  WWSRO     WWRATE    H
     C                     END
     C*
     C           WWMDI     IFEQ 'D'
     C           WWRATE    IFEQ 0
     C                     GOTO SC0
     C                     END
     C           POWER,Z   DIV  WWRATE    WWRATE    H
     C                     ELSE
     C           POWER,Z   MULT WWRATE    WWRATE    H
     C                     END
     C*
     C           WWAMTI    MULT WWRATE    WWAMTO    H
     C*
     C           SC0       ENDSR                           **  SC0      **
     C/EJECT
     C/COPY ZSRSRC,ZSEDITZ3
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZC       - Retrieve Account Officer name for report,           *
     C**             set up other output fields and write HEADING        *
     C**                                                                 *
     C** CALLS     - #ZA                                                 *
     C**                                                                 *
     C** CALLED BY - #ZH                                                 *
     C**                                                                 *
     C********************************************************************
     C           #ZC       BEGSR                           ** #ZC       **
     C*
     C** Set up Branch Code, A/C Officer Code and Name fields
     C                     MOVE '0'       *IN29
     C                     MOVE BBBRCD    RRSPTA
     C                     MOVE BBACOC    RRACOC
     C           RRACOC    IFEQ *BLANKS
     C                     MOVE *BLANKS   RRACON
     C                     ELSE
     C***********RRACOC    CHAINSDACOFL0             33                   S01498
     C************IN33     IFEQ '0'                                       S01498
     C***********AZTYLC    ANDNE'D'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOACOFR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM RRACOC    P@ACOC  2                       S01498
     C           SDACOF    PARM SDACOF    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFEQ *BLANK                                    S01498
     C                     MOVE AZACON    RRACON
     C                     ELSE
     C                     MOVE *BLANKS   RRACON
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            ***************
     C***********          MOVEL'SDACOFL0'DBFILE           * DBERROR 004 *S01498
     C                     MOVE 'SDACOFPD'DBFILE           * DBERROR 004 *S01498
     C                     MOVELRRACOC    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     END
     C*
     C** If Customer is not a parent then set up customer number fields
     C           BBPAIN    IFEQ 'P'
     C                     MOVE '0'       *IN22
     C                     ELSE
     C                     MOVE '1'       *IN22
     C                     MOVE BBCUST    RRCUNO
     C                     MOVE BBCRNM    RRCRNM
     C                     END
     C*
     C** Save various fields for later use
     C                     MOVE CUINBP    WWINBP
     C                     MOVE CUCCY     WWCUCY
     C                     MOVE BBCUST    WWCUNO
     C**********           MOVE WWCUNO    WWCUND  60                                          CSD027
     C                     MOVE WWCUNO    WWCUND  6                                           CSD027
     C                     MOVE BBPAIN    WWPAIN
     C*
     C** If Customer has or is a parent then set up parent number fields
     C                     MOVE '1'       *IN21
     C           BBPCNB    IFNE *BLANKS
     C                     MOVE BBPCNB    RRPANO
     C                     ELSE
     C           BBPAIN    IFEQ 'P'
     C                     MOVE BBCUST    RRPANO
     C                     ELSE
     C                     MOVE '0'       *IN21
     C                     END
     C                     END
     C*
     C           *IN21     IFEQ '1'
     C***********RRPANO    CHAINSDLBCSL0             10                   S01498
     C           RRPANO    CHAINLBLBCSJ0             10                   S01498
     C           *IN10     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD6         DBASE            ***************
     C***********          MOVEL'SDLBCSL0'DBFILE           * DBERROR 006 *S01498
     C                     MOVE 'LBLBCSJ0'DBFILE           * DBERROR 006 *S01498
     C                     MOVELRRPANO    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     MOVE BBCRNM    RRPRNM
     C                     END
     C*
     C*******              WRITEHEADING
     C                     MOVE '0'       *IN51
     C*
     C           #ZC0      ENDSR                           ** #ZC0      **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZD         - Produce OVERVIEW section of report                *
     C**                                                                 *
     C** CALLS       -                                                   *
     C**                                                                 *
     C** CALLED BY   - #ZH                                               *
     C**                                                                 *
     C********************************************************************
     C           #ZD       BEGSR
     C*
     C** Set up OVERVIEW fields for Portfolio Currency
     C***********          MOVE LBCCY     RRCCY                           S01498
     C                     MOVE LBCYCD    RRCCY                           S01498
     C*
     C** Read totals from Portfolio Extract Summary file
     C           WWCUND    CHAINLBEXTSL1             78
     C           *IN78     IFEQ '1'
     C                     Z-ADD0         WWTOTE
     C                     Z-ADD0         WWTOTL
     C                     Z-ADD0         WWTOTC
     C                     Z-ADD0         WWTOTB
     C                     Z-ADD0         WWTOTA
     C                     Z-ADD0         WWTOTQ
     C                     ELSE
     C*
     C                     Z-ADDESCMTL    WWTOTC 150
     C           ESOWEX    ADD  ESTPIU    WWTOTE 150
     C***********ESOWCO    ADD  ESTPRD    WWTOTL 150                      LB0004
     C           ESOWCO    ADD  ESTPRV    WWTOTL 150                      LB0004
     C*
     C** Only include pledges received in borrowing power under
     C** certain circumstances
     C                     Z-ADDESLPWR    WWTOTB 150
     C           WWINBP    IFEQ 'Y'
     C***********          ADD  ESTPRD    WWTOTB                          LB0004
     C                     ADD  ESTPRV    WWTOTB                          LB0004
     C                     END
     C*
     C** Calculate AVAILABLE as lesser of (tot borr pwr - tot exposure)
     C**                              and (tot commit't - tot exposure)
     C           WWTOTB    SUB  WWTOTE    WWTMP1 150
     C           WWTOTC    SUB  WWTOTE    WWTMP2 150
     C           WWTMP1    IFLT WWTMP2
     C                     Z-ADDWWTMP1    WWTOTA 150
     C                     ELSE
     C                     Z-ADDWWTMP2    WWTOTA
     C                     END
     C***********                                                         LB0004
     C***Calculate EQUITY as (tot collateral - tot exposure)              LB0004
     C***********WWTOTL    SUB  WWTOTE    WWTOTQ 150                      LB0004
     C*
     C** CUSTOMER EQUITY = (own collateral - tot exposure + tot margin)   LB0004
     C                     MOVE BBCUST    WWCUST                          LB0004
     C           WWCKY1    CHAINLBEXTRL2             59                   LB0004
     C*                                                                   LB0004
     C           *IN59     IFEQ '1'                                       LB0004
     C                     Z-ADD0         WWMARG 150                      LB0004
     C                     Z-ADD0         RRMPFX  30                      SA9109
     C                     ELSE                                           LB0004
     C                     Z-ADDEEEXPS    WWMARG                          LB0004
     C                     Z-ADDEEMGPC    RRMPFX                          SA9109
     C                     END                                            LB0004
     C*                                                                   LB0004
     C           ESOWCO    SUB  WWTOTE    WWTOTQ 150                      LB0004
     C                     ADD  WWMARG    WWTOTQ                          LB0004
     C*                                                                   LB0004
     C                     END
     C*
     C** Now convert to display format in Portfolio base currency
     C*
     C                     Z-ADDWWLBDP    ZDECS
     C*
     C                     Z-ADDWWTOTE    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTOTE
     C*
     C                     Z-ADDWWTOTL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTOTL
     C*
     C                     Z-ADDWWTOTC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTOTC
     C*
     C                     Z-ADDWWTOTA    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTOTA
     C*
     C                     Z-ADDWWTOTB    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTOTB
     C*
     C                     Z-ADDWWTOTQ    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTOTQ
     C*
     C** Calculate percentages :
     C                     Z-ADD0         ZDECS
     C*
     C** If Total Collateral is non-zero
     C           WWTOTL    IFNE 0
     C*
     C**                        Total Exposure
     C** Exposure percentage =  ---------------    *  100
     C**                        Total Collateral
     C*
     C           WWTOTE    MULT 100       WW170  170
     C           WW170     DIV  WWTOTL    WWTOPE  30H
     C********             MOVE WWTOPE    RRTOPE                     B4810R0665
     C                     Z-ADDWWTOPE    ZFLD15                     B4810R0665
     C                     EXSR ZSEDIT                               B4810R0665
     C                     MOVE NOSIGN    RRTOPE                     B4810R0665
     C*
     C**                          Total Commitment
     C** Commitment percentage =  ----------------   *  100
     C**                          Total Collateral
     C*
     C           WWTOTC    MULT 100       WW170
     C           WW170     DIV  WWTOTL    WWTOPC  30H
     C********             MOVE WWTOPC    RRTOPC                     B4810R0665
     C                     Z-ADDWWTOPC    ZFLD15                     B4810R0665
     C                     EXSR ZSEDIT                               B4810R0665
     C                     MOVE NOSIGN    RRTOPC                     B4810R0665
     C*
     C**                               Total Borrowing Power
     C** Borrowing Power percentage =  ---------------------    *  100
     C**                                  Total Collateral
     C*
     C           WWTOTB    MULT 100       WW170  170
     C           WW170     DIV  WWTOTL    WWTOPB  30H
     C********             MOVE WWTOPB    RRTOPB                     B4810R0665
     C                     Z-ADDWWTOPB    ZFLD15                     B4810R0665
     C                     EXSR ZSEDIT                               B4810R0665
     C                     MOVE NOSIGN    RRTOPB                     B4810R0665
     C*
     C** else collateral is zero
     C                     ELSE
     C*
     C                     MOVE '  0'     RRTOPE
     C                     MOVE '  0'     RRTOPC
     C                     MOVE '  0'     RRTOPB
     C*
     C                     END
     C*
     C**
     C                     MOVE '1'       *IN34
     C*******              WRITEOVERVIEW
     C                     MOVE '0'       *IN52
     C*
     C** now convert to customer currency if different
     C***********LBCCY     IFNE WWCUCY                                    S01498
     C           LBCYCD    IFNE WWCUCY                                    S01498
     C*
     C*******              MOVE WWCUCY    RRCCY
     C                     MOVE WWCUCY    XXCCY   3
     C*
     C** convert to customer currency and display format
     C*
     C** SET UP THE CURRENCY DETAILS FOR THE CUSTOMER CURRENCY
     C** FOR THE CURRENCY CONVERSION SUBROUTINE - OUTPUT FIELDS
     C***********WWCUCY    CHAINSDCURRL1             72                   S01498
     C************IN72     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get currency details using access object                         S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWCUCY    P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 003 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 003 *S01498
     C                     MOVELWWCUCY    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR #ZA
     C                     END
     C                     MOVE A6SPRT    WWSRO
     C                     Z-ADDA6NBDP    WWDPO
     C                     MOVE A6MDIN    WWMDO
     C                     Z-ADDA6NBDP    ZDECS
     C*
     C                     Z-ADDWWTOTE    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C*******              MOVE ZOUT21    RRTOTE
     C                     MOVE ZOUT21    XXTOTE 21
     C*
     C                     Z-ADDWWTOTL    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C*******              MOVE ZOUT21    RRTOTL
     C                     MOVE ZOUT21    XXTOTL 21
     C*
     C                     Z-ADDWWTOTC    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C*******              MOVE ZOUT21    RRTOTC
     C                     MOVE ZOUT21    XXTOTC 21
     C*
     C                     Z-ADDWWTOTA    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C*******              MOVE ZOUT21    RRTOTA
     C                     MOVE ZOUT21    XXTOTA 21
     C*
     C                     Z-ADDWWTOTB    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C*******              MOVE ZOUT21    RRTOTB
     C                     MOVE ZOUT21    XXTOTB 21
     C*
     C                     Z-ADDWWTOTQ    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C*******              MOVE ZOUT21    RRTOTQ
     C                     MOVE ZOUT21    XXTOTQ 21
     C*
     C**
     C                     MOVE '0'       *IN34
     C*******              WRITEOVERVIEW
     C                     MOVE '0'       *IN53
     C*
     C                     ELSE
     C                     MOVE '1'       *IN53
     C*
     C                     END
     C*
     C** Produce NOTES
     C           WWINBP    IFEQ 'Y'
     C                     MOVE '1'       *IN23
     C                     ELSE
     C                     MOVE '0'       *IN23
     C                     END
     C*
     C           WWPAIN    IFEQ 'P'
     C*
     C** Dont write any more NOTES fields for a parent
     C                     MOVE '0'       *IN24
     C                     ELSE
     C                     MOVE '1'       *IN24
     C           COMAKY    KLIST
     C                     KFLD           WWCUND
     C                     KFLD           BJRDNB
     C*
     C** Find active Commitment record
     C                     MOVE '0'       *IN25
     C           COMAKY    SETLLLBCOMAL2             77
     C           *IN77     IFEQ '0'
     C           WWCUND    READELBCOMAL2                 77
     C           *IN77     DOWNE'1'
     C           CASTTD    IFLE BJRDNB
     C           CAEXPD    ANDGEBJRDNB
     C********** PHASE     ANDEQ'A'                                                    001313 CCB020
     C           COBST     ANDEQ'*NO'                                                         CCB020
     C           CASTTD    ORLE BJDNWD                                    001313
     C           CAEXPD    ANDGEBJDNWD                                    001313
     C********** PHASE     ANDNE'A'                                                    001313 CCB020
     C           COBST     ANDEQ'*YES'                                                        CCB020
     C                     MOVE '1'       *IN77
     C                     MOVE '1'       *IN25
     C                     ELSE
     C           WWCUND    READELBCOMAL2                 77
     C                     END
     C                     END
     C                     END
     C*
     C** If active record found set up output fields
     C           *IN25     IFEQ '1'
     C                     Z-ADDCAREVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RRCMRD  7
     C                     MOVE CANOT1    RRNOT1 35
     C                     MOVE CANOT2    RRNOT2 35
     C                     MOVE CANOT3    RRNOT3 35
     C                     MOVE CANOT4    RRNOT4 35
     C           CANOT1    IFEQ *BLANKS
     C           CANOT2    ANDEQ*BLANKS
     C           CANOT3    ANDEQ*BLANKS
     C           CANOT4    ANDEQ*BLANKS
     C                     MOVE '1'       *IN35
     C                     ELSE
     C                     MOVE '0'       *IN35
     C                     END
     C                     ELSE
     C                     MOVE '1'       *IN35
     C                     END
     C*
     C                     END
     C*
     C** Write NOTES lines
     C*******              WRITENOTES
     C                     MOVE '0'       *IN54
     C*
     C                     ENDSR
     C/EJECT
     C***/COPY*LBSRSRC,SACCH                                              S01498
     C/COPY ZSRSRC,ZACCH                                                  S01498
     C/EJECT
     C***/COPY*LBSRSRC,SCHKH                                              S01498
     C/COPY ZSRSRC,ZCHKH                                                  S01498
     C/EJECT
     C/COPY ZSRSRC,ZDATE1Z2
     C/EJECT
     C/COPY ZSRSRC,ZDATE2Z2
     C/EJECT
     C***/COPY*LBSRSRC,SFRQAZ2                                            S01498
     C/COPY ZSRSRC,ZFRQAZ2                                                S01498
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZE       - Produce Exposure and Collateral Details section     *
     C**             of Report                                           *
     C**                                                                 *
     C** CALLS     - #ZEA, #ZEB                                          *
     C**                                                                 *
     C** CALLED BY - #ZH                                                 *
     C**                                                                 *
     C********************************************************************
     C           #ZE       BEGSR                           ** #ZE       **
     C*
     C** WRITE HEADING2
     C*******              MOVE LBCCY     RRCCY
     C***********          MOVE LBCCY     YYCCY   3                       S01498
     C                     MOVE LBCYCD    YYCCY   3                       S01498
     C*******              WRITEHEADING2
     C                     MOVE '0'       *IN55
     C                     Z-ADDWWLBDP    ZDECS
     C*
     C** write detail lines
     C*
     C** SETLL on LBEXTRL4 or L7 and read first record
     C           WWPAIN    IFEQ 'P'
     C           WWCUNO    SETLLLBEXTRL7                 75
     C                     ELSE
     C           WWCUND    SETLLLBEXTRL4                 75
     C                     END
     C           *IN75     IFEQ '0'
     C*
     C** No data found for this customer
     C*******              WRITENODETLS
     C                     GOTO #ZE0
     C                     END
     C*
     C           WWPAIN    IFEQ 'P'
     C           WWCUNO    READELBEXTRL7                 41
     C                     ELSE
     C           WWCUND    READELBEXTRL4                 41
     C                     END
     C                     MOVE EELCGR    WWLCGR
     C                     EXSR #ZEA
     C*
     C           *IN41     DOWEQ'0'
     C*
     C** Read all extract records for all instruments in this group
     C                     EXSR #ZEB
     C*                                                                   LB0004
     C           WWEXPS    IFNE 0                                         LB0004
     C***********WWLIMT    ORNE 0                                         LB0004
     C           WWCOLL    ORNE 0                                         LB0004
     C*
     C** Set up Portfolio Exposure
     C                     Z-ADDWWEXPS    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRGREX
     C***********                                                         LB0004
     C***Set*up*Portfolio Limit                                           LB0004
     C***********          Z-ADDWWLIMT    ZFLD15                          LB0004
     C***********          EXSR ZSEDIT                                    LB0004
     C***********          MOVE ZOUT21    RRGREL                          LB0004
     C*
     C** Set up Portfolio Collateral
     C                     Z-ADDWWCOLL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRGRCL
     C*
     C           *IN51     IFEQ '0'
     C*                                                                   S01498
     C**  Process if there is a change in branch                          S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C                     WRITEHEADING
     C                     MOVE '1'       *IN51
     C                     END
     C           *IN52     IFEQ '0'
     C                     WRITEOVERVIEW
     C                     MOVE '1'       *IN52
     C                     MOVE '1'       *IN50                           SA9101
     C                     END
     C           *IN53     IFEQ '0'
     C                     MOVE XXCCY     RRCCY
     C                     MOVE XXTOTE    RRTOTE
     C                     MOVE XXTOTL    RRTOTL
     C                     MOVE XXTOTC    RRTOTC
     C                     MOVE XXTOTA    RRTOTA
     C                     MOVE XXTOTB    RRTOTB
     C                     MOVE XXTOTQ    RRTOTQ
     C                     WRITEOVERVIEW
     C                     MOVE '1'       *IN53
     C                     MOVE '1'       *IN50                           SA9101
     C                     END
     C           *IN54     IFEQ '0'
     C                     WRITENOTES
     C                     MOVE '1'       *IN54
     C                     END
     C           *IN55     IFEQ '0'
     C                     MOVE YYCCY     RRCCY
     C                     WRITEHEADING2
     C                     MOVE '1'       *IN55
     C                     END
     C*                                                                   SA9101
     C*
     C           LINE      IFGT 59
     C                     WRITEHEADING
     C                     WRITEHEADING2
     C                     END
     C*
     C                     WRITEDETAIL1
     C                     MOVE '1'       *IN57
     C                     MOVE '1'       *IN50                           SA9101
     C*                                                                   LB0004
     C                     END                                            LB0004
     C*
     C** read details of the next group from LBGROUPD
     C** (credit group key was set up in #ZEB)
     C           *IN41     IFEQ '0'
     C                     EXSR #ZEA
     C                     END
     C*
     C**         end of DOW
     C                     END
     C*
     C           #ZE0      ENDSR                           ** #ZE0      **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZEB        - Read all extract records for all instruments      *
     C**               in this group                                     *
     C**                                                                 *
     C** CALLS       - NONE                                              *
     C**                                                                 *
     C** CALLED BY   - #ZE                                               *
     C**                                                                 *
     C********************************************************************
     C           #ZEB      BEGSR
     C*
     C                     Z-ADD0         WWEXPS 150
     C***********          Z-ADDEELIMT    WWLIMT 150                      LB0004
     C                     Z-ADD0         WWCOLL 150
     C*
     C           EELCGR    DOWEQWWLCGR
     C           *IN41     ANDEQ'0'
     C*                                                                   LB0004
     C** omit records with Instrument type in LBFXUP and LBFXUL           LB0004
     C** of SDLOMBPD                                                      LB0004
     C/COPY WNCPYSRC,LB0360C001
     C           EEINST    IFNE LBFXUP                                    LB0004
     C           EEINST    ANDNELBFXUL                                    LB0004
     C           EEINST    ANDNELBPMUP                                    LB2000
     C           EEINST    ANDNELBPMUL                                    LB2000
     C*
     C** accumulate totals
     C           WWEXPS    ADD  EEEXPS    WWEXPS
     C           WWCOLL    ADD  EECOLL    WWCOLL
     C*                                                                   LB0004
     C                     END                                            LB0004
     C/COPY WNCPYSRC,LB0360C002
     C*
     C           WWPAIN    IFEQ 'P'
     C           WWCUNO    READELBEXTRL7                 41
     C                     ELSE
     C           WWCUND    READELBEXTRL4                 41
     C                     END
     C*
     C                     END
     C*
     C** set up key to credit group file LBGROUL1 for #ZEA
     C                     MOVE EELCGR    WWLCGR
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZEA      - Read the LBGROUL1 file to get the group name for    *
     C**             display                                             *
     C**                                                                 *
     C** CALLS     - #ZA                                                 *
     C**                                                                 *
     C** CALLED BY -                                                     *
     C**                                                                 *
     C********************************************************************
     C           #ZEA      BEGSR                           **  #ZEA     **
     C*
     C***********WWLCGR    CHAINLBGROUL1             76                   S01498
     C************IN76     IFEQ '1'                                       S01498
     C*                                                                   S01498
     C**  Use access object AOGROUR0 to get group name                    S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWLCGR    P@LCGR  3                       S01498
     C           SDGROU    PARM SDGROU    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVEL'LB0360'  DBPGM            ***************
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROR 007 *S01498
     C                     MOVE 'LBGROUPD'DBFILE           * DBERROR 007 *S01498
     C                     Z-ADD7         DBASE            ***************
     C                     MOVELWWLCGR    DBKEY
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     MOVE GPLCGN    RRGRNM 20
     C*
     C           #ZEA0     ENDSR                           **  #ZEA0    **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZG       - Write Collateral Borrowing Power Details            *
     C**                                                                 *
     C** CALLS     -                                                     *
     C**                                                                 *
     C** CALLED BY - #BB                                                 *
     C**                                                                 *
     C********************************************************************
     C           #ZG       BEGSR                           ** #ZG       **
     C*
     C** WRITE HEADINGS
     C*******              WRITEHEADING
     C                     MOVE '0'       *IN51
     C***********          MOVE LBCCY     RRLBCY  3                       S01498
     C                     MOVE LBCYCD    RRLBCY  3                       S01498
     C*******              WRITEHEADING3
     C                     MOVE '0'       *IN56
     C*
     C** write detail lines
     C*
     C** SETLL on LBEXTRL4 or L7 and read first record
     C           WWPAIN    IFEQ 'P'
     C***********WWCUNO    SETLLLBEXTRL7                 75
     C           WWCUNO    SETLLLBEXTRLB                 75
     C                     ELSE
     C***********WWCUND    SETLLLBEXTRL4                 75
     C           WWCUND    SETLLLBEXTRLA                 75
     C                     END
     C           *IN75     IFEQ '0'
     C*
     C** No data found for this customer
     C*******              WRITENODETLS
     C                     GOTO #ZG0
     C                     END
     C*
     C                     Z-ADD0         WWTBP  150
     C*
     C           WWPAIN    IFEQ 'P'
     C***********WWCUNO    READELBEXTRL7                 41
     C           WWCUNO    READELBEXTRLB                 41
     C                     ELSE
     C***********WWCUND    READELBEXTRL4                 41
     C           WWCUND    READELBEXTRLA                 41
     C                     END
     C*
     C** Set up keys for #ZGA and call it
     C                     MOVE EELCGR    WWLCGR
     C                     MOVE EEINST    WWINST
     C****************     EXSR #ZGA                                      R0665
     C*
     C           *IN41     DOWEQ'0'
     C                     SETOF                     37                   R0665
     C*
     C** Write all extract records for this instrument
     C                     EXSR #ZGB
     C*
     C** read details of the next instrument and write DETAIL2
     C** (keys were set up in #ZGB)
     C********** *IN41     IFEQ '0'                                       R0665
     C**********           EXSR #ZGA                                      R0665
     C**********           END                                            R0655
     C*
     C**         end of DOW
     C                     END
     C*
     C** Write BPTOTAL line
     C                     Z-ADDWWLBDP    ZDECS
     C                     Z-ADDWWTBP     ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTLBP 21
     C*
     C*********  *IN58     IFEQ '1'                                       R0665
     C  N36      *IN58     IFEQ '1'                                       R0655
     C                     WRITEBPTOTAL
     C                     END
     C*
     C           #ZG0      ENDSR                           ** #ZG0      **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZGBA       - Part of Borrowing Power Percentage calculations   *
     C**                                                                 *
     C** CALLS       -                                                   *
     C**                                                                 *
     C** CALLED BY   -                                                   *
     C**                                                                 *
     C********************************************************************
     C           #ZGBA     BEGSR
     C*
     C                     Z-ADD0         WWBFPC                          B4810
     C*                                                                   B4810
     C           EECLPC    IFEQ 0
     C*
     C           EEINPC    IFNE 0
     C                     Z-ADDEEINPC    WWBFPC
     C                     ELSE
     C*
     C           EESEPC    IFNE 0
     C                     Z-ADDEESEPC    WWBFPC
     C**                   ELSE                                           B4810
     C**                   Z-ADD100       WWBFPC                          B4810
     C                     END
     C*
     C                     END
     C*
     C                     ELSE
     C                     Z-ADDEECLPC    WWBFPC
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZGBB       - Calculate/read the Collateral and Borrowing Power *
     C**               depending on the Group/Instrument type            *
     C**                                                                 *
     C** CALLS       - #ZGBC, #ZGBD, #ZA                                 *
     C**                                                                 *
     C** CALLED BY   -                                                   *
     C**                                                                 *
     C********************************************************************
     C           #ZGBB     BEGSR
     C*                                                                   LB0004
     C**   INITIALISE COLL/SEQUENCE REPORT FIELDS                         LB0004
     C*                                                                   LB0004
     C                     MOVE *BLANKS   RRCOLL                          LB0004
     C                     MOVE *BLANKS   RRSEQN                          LB0004
     C*
     C           EEINST    IFNE LBPLEG
     C*
     C** Calculate the Borrowing Power from the Collateral
     C           EECOLL    IFNE 0
     C           WWBFPC    ANDNE0                                         B4810
     C           EECOLL    MULT WWBFPC    WWTM18 180H
     C           WWTM18    DIV  100       WWBPWR 150H
     C                     ELSE
     C                     Z-ADD0         WWBPWR
     C                     END
     C*
     C                     Z-ADDEECOLL    WWCOLL 150
     C*
     C** If instrument currency NE Portfolio currency then convert and
     C** report Collateral and Borrowing Power in Instrument CCY
     C                     EXSR #ZGBC
     C*
     C                     ELSE
     C*
     C           PLEGKY    KLIST
     C                     KFLD           EECNUM
     C                     KFLD           WWTYPE
     C*
     C** Everywhere else in this program, amounts are converted FROM
     C** LBCCY TO another currency - except here where amounts are stored
     C** on the Pledges file in instrument currency.
     C** Therefore swap the LBCCY fields from Input to Output fields
     C                     MOVE WWSRI     WWSRO
     C                     MOVE WWDPI     WWDPO
     C                     MOVE WWMDI     WWMDO
     C*
     C           PLEGKY    SETLLLBPLEGL2                 79
     C           *IN79     IFEQ '0'
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVEL'LB0360'  DBPGM            ***************
     C***********          MOVEL'LBPLEGL2'DBFILE           * DBERROR 009 *S01498
     C                     MOVE 'LBPLEGL2'DBFILE           * DBERROR 009 *S01498
     C                     Z-ADD9         DBASE            ***************
     C                     MOVELPLGKY     DBKEY
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C*
     C           PLEGKY    READELBPLEGL2                 79
     C           *IN79     DOWEQ'0'
     C                     Z-ADDPGCOLS    WWCOLL
     C                     Z-ADDPGCOLB    WWBPWR
     C*
     C** Set up Specific Utilisation
     C                     MOVE '0'       *IN26
     C                     MOVE '0'       *IN27
     C                     MOVE '0'       *IN28
     C                     MOVE '0'       *IN47                           LB0004
     C********** PGUTSL    IFNE 0                                                             CLE148
     C           PGUTSL    IFNE *BLANK                                                        CLE148
     C                     MOVE PGUTSL    RRLOAN
     C                     MOVE '1'       *IN26
     C                     ELSE
     C           PGUTSF    IFNE *BLANKS
     C                     MOVE PGUTSF    RRFCTY
     C                     MOVE '1'       *IN27
     C                     ELSE
     C           PGUTSP    IFNE *BLANKS
     C                     MOVE PGUTSP    RRPORT
     C                     MOVE '1'       *IN28
     C                     ELSE                                           LB0004
     C           PGEREF    IFNE *BLANKS                                   LB0004
     C                     MOVE PGEREF    RRACCT                          LB0004
     C                     MOVE PGEBCH    RRABCH                          087628
     C                     MOVE '1'       *IN47                           LB0004
     C                     END                                            LB0004
     C                     END
     C                     END
     C                     END
     C*
     C** Set up report amounts and write record
     C                     EXSR #ZGBD
     C           PLEGKY    READELBPLEGL2                 79
     C*
     C                     END
     C*
     C                     MOVE '0'       *IN26
     C                     MOVE '0'       *IN27
     C                     MOVE '0'       *IN28
     C                     MOVE '0'       *IN47                           LB0004
     C*
     C** See comments above, now swap the LBCCY fields back for the rest
     C** of the program
     C                     MOVE WWSRO     WWSRI
     C                     MOVE WWDPO     WWDPI
     C                     MOVE WWMDO     WWMDI
     C*
     C                     END
     C*
     C           #ZGBB0    ENDSR                           ** #ZGBB0   **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZGBC       - Set up report amounts and write record            *
     C**                                                                 *
     C** CALLS       -                                                   *
     C**                                                                 *
     C** CALLED BY   - #ZGBB, #ZA                                        *
     C**                                                                 *
     C********************************************************************
     C           #ZGBC     BEGSR
     C*
     C** If instrument currency NE Portfolio currency then convert and
     C** report Collateral and Borrowing Power in Instrument CCY
     C***********EECCY     IFNE LBCCY                                     S01498
     C           EECCY     IFNE LBCYCD                                    S01498
     C*
     C** SET UP THE CURRENCY DETAILS FOR THE INSTRUMENT CURRENCY
     C** FOR THE CURRENCY CONVERSION SUBROUTINE - OUTPUT FIELDS
     C           EECCY     IFNE A6CYCD
     C***********EECCY     CHAINSDCURRL1             72                   S01498
     C************IN72     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get currency details using access object                         S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM EECCY     P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 003 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 003 *S01498
     C                     MOVELEECCY     DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     MOVE A6SPRT    WWSRO
     C                     Z-ADDA6NBDP    WWDPO
     C                     MOVE A6MDIN    WWMDO
     C                     END
     C                     Z-ADDA6NBDP    ZDECS
     C*
     C                     Z-ADDWWCOLL    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINCL
     C                     Z-ADDWWBPWR    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINBP
     C*
     C                     ELSE
     C*
     C                     Z-ADDWWLBDP    ZDECS
     C                     Z-ADDWWCOLL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINCL
     C                     Z-ADDWWBPWR    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINBP
     C*
     C                     END
     C*
     C** Report Borrowing Power in Portfolio Currency
     C                     Z-ADDWWLBDP    ZDECS
     C                     Z-ADDWWBPWR    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRLBBP 21
     C*
     C** ADD BPWR IN PORTFOLIO CURRENCY TO TOTAL
     C                     ADD  WWBPWR    WWTBP
     C*
     C           LINE      IFGT 58
     C           *IN56     OREQ '0'
     C*                                                                   S01498
     C**  Process if there is a change in branch                          S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C                     WRITEHEADING
     C                     WRITEHEADING3
     C                     MOVE '1'       *IN56
     C                     MOVE '1'       *IN30
     C                     WRITEDETAIL3
     C                     MOVE '0'       *IN30
     C                     MOVE '1'       *IN50                           SA9101
     C                     MOVE '1'       *IN58
     C                     ELSE
     C                     WRITEDETAIL3
     C                     MOVE '1'       *IN50                           SA9101
     C                     MOVE '1'       *IN58
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZGBD       - Set up report amounts and write record for a      *
     C**               pledge                                            *
     C**                                                                 *
     C** CALLS       - #ZA                                               *
     C**                                                                 *
     C** CALLED BY   - #ZGBB                                             *
     C**                                                                 *
     C********************************************************************
     C           #ZGBD     BEGSR
     C*
     C** If instrument currency NE Portfolio currency then convert Borrowing
     C** Power to Portfolio currency and report BP and Collateral
     C***********EECCY     IFNE LBCCY                                     S01498
     C           EECCY     IFNE LBCYCD                                    S01498
     C*
     C** SET UP THE CURRENCY DETAILS FOR THE INSTRUMENT CURRENCY
     C** FOR THE CURRENCY CONVERSION SUBROUTINE - Input fields
     C***********EECCY     CHAINSDCURRL1             72                   S01498
     C************IN72     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get currency details using access object                         S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM EECCY     P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 003 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 003 *S01498
     C                     MOVELEECCY     DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     MOVE A6SPRT    WWSRI
     C                     Z-ADDA6NBDP    WWDPI
     C                     MOVE A6MDIN    WWMDI
     C*
     C** Report Borrowing Power and Collateral in instrument currency
     C                     Z-ADDWWDPI     ZDECS
     C                     Z-ADDWWBPWR    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINBP
     C                     Z-ADDWWCOLL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINCL
     C*
     C** Convert and report Borowing Power in Portfolio currency
     C                     Z-ADDWWLBDP    ZDECS
     C                     Z-ADDWWBPWR    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    ZFLD15
     C*
     C** (SAVE CONVERTED BPWR FOR TOTAL CALC)
     C                     Z-ADDWWAMTO    WWBPWR
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRLBBP
     C*
     C                     ELSE
     C*
     C                     Z-ADDWWLBDP    ZDECS
     C                     Z-ADDWWCOLL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINCL
     C                     Z-ADDWWBPWR    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINBP
     C                     MOVE ZOUT21    RRLBBP
     C*
     C                     END
     C*
     C**   SET UP COLLATERAL/SEQUENCE ON REPORTS
     C*
     C                     MOVE PGBPSN    RRCOLL
     C                     MOVE PGSEQN    RRSEQN
     C*
     C** ADD BPWR IN PORTFOLIO CURRENCY TO TOTAL
     C                     ADD  WWBPWR    WWTBP
     C*
     C           LINE      IFGT 58
     C           *IN56     OREQ '0'
     C*                                                                   S01498
     C**  Process if there is a change in branch                          S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C                     WRITEHEADING
     C                     WRITEHEADING3
     C                     MOVE '1'       *IN56
     C                     MOVE '1'       *IN30
     C                     WRITEDETAIL3
     C                     MOVE '0'       *IN30
     C                     MOVE '1'       *IN50                           SA9101
     C                     MOVE '1'       *IN58
     C                     ELSE
     C                     WRITEDETAIL3
     C                     MOVE '1'       *IN50                           SA9101
     C                     MOVE '1'       *IN58
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZGB        - Write all extract records for this instrument     *
     C**                                                                 *
     C** CALLS       - #ZGBA                                             *
     C**                                                                 *
     C** CALLED BY   -                                                   *
     C**                                                                 *
     C********************************************************************
     C           #ZGB      BEGSR
     C*
     C           EEINST    DOWEQWWINST
     C           *IN41     ANDEQ'0'
      *                                                                   R0665
      ** Difference with unrealized profit.                               R0665
      *                                                                   R0665
     C           *IN36     IFEQ '0'                                       R0665
     C           EEINST    ANDNELBFXUP                                    R0665
     C           EEINST    ANDNELBFXUL                                    R0665
     C           *IN36     OREQ '1'                                       R0665
     C           EEINST    ANDEQLBFXUP                                    R0665
     C           *IN36     OREQ '1'                                       R0665
     C           EEINST    ANDEQLBFXUL                                    R0665
      *                                                                   R0665
     C     N37             EXSR #ZGA                                      R0665
     C     N37             SETON                     37
      *                                                                   R0665
     C           WWPAIN    IFNE 'P'
     C                     ADD  1         RRNORE
     C                     END
     C*
     C** write a detail line
     C                     MOVE EECCY     RRINCC  3
     C*
     C** Calculate the Borrowing Power Percentage
     C                     EXSR #ZGBA
     C*
     C           EECTPC    IFNE 0
     C           WWBFPC    MULT EECTPC    WWTMP6  60
     C           WWTMP6    DIV  100       WWBFPC  62H
     C                     END
     C                     Z-ADDWWBFPC    WWBPPC  30H
     C*
     C** Now convert all percentages to report format
     C                     Z-ADD0         ZDECS
     C*
     C                     Z-ADDWWBPPC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRBPPC  4
     C                     Z-ADDEECLPC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRCLPC  4
     C                     Z-ADDEESEPC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRSCPC  4
     C                     Z-ADDEEINPC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRINPC  4
     C                     Z-ADDEECTPC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRCTPC  4
     C*
     C** Calculate the Borrowing Power and Collateral and report
     C                     EXSR #ZGBB
      *                                                                   R0665
     C                     END                                            R0665
     C*
     C           WWPAIN    IFEQ 'P'
     C***********WWCUNO    READELBEXTRL7                 41
     C           WWCUNO    READELBEXTRLB                 41
     C                     ELSE
     C***********WWCUND    READELBEXTRL4                 41
     C           WWCUND    READELBEXTRLA                 41
     C                     END
     C*
     C                     END
     C*
     C** set up keys for #ZGA
     C                     MOVE EELCGR    WWLCGR
     C                     MOVE EEINST    WWINST
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZGA      - Read the LBGROUL1 file to get the group name,       *
     C**             read the SDPLINL0 file to get the instrument name   *
     C**             and print a detail record.                          *
     C**                                                                 *
     C** CALLS     -                                                     *
     C**                                                                 *
     C** CALLED BY -                                                     *
     C**                                                                 *
     C********************************************************************
     C           #ZGA      BEGSR                           **  #ZGA     **
     C*
     C           WWLCGR    IFNE RRGRCD
     C***********WWLCGR    CHAINLBGROUL1             76                   S01498
     C************IN76     IFEQ '1'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWLCGR    P@LCGR                          S01498
     C           SDGROU    PARM SDGROU    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVEL'LB0360'  DBPGM            ***************
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROR 007 *S01498
     C                     MOVE 'LBGROUPD'DBFILE           * DBERROR 007 *S01498
     C                     Z-ADD7         DBASE            ***************
     C                     MOVELWWLCGR    DBKEY
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     END
     C*
     C***********WWINST    CHAINSDPLINL4             74                   S01498
     C************IN74     IFEQ '1'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWINST    P@INST  3                       S01498
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVEL'LB0360'  DBPGM            ***************
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROR 008 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 008 *S01498
     C                     Z-ADD8         DBASE            ***************
     C                     MOVELWWINST    DBKEY
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C*
     C                     MOVE WWLCGR    RRGRCD  3
     C                     MOVE GPLCGN    RRGRNM 20
     C                     MOVE PDINNR    RRINCD  3
     C                     MOVE PDISTN    RRINNM 20
     C*
     C*
     C           LINE      IFGT 57
     C           *IN56     OREQ '0'
     C*                                                                   S01498
     C**  Process if there is a change in branch                          S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C                     WRITEHEADING
     C                     WRITEHEADING3
     C                     MOVE '1'       *IN56
     C                     END
     C                     MOVE '1'       *IN58
     C*
     C           #ZGA0     ENDSR                           **  #ZGA0    **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZH       - Produce a report for a single Customer just read    *
     C**                                                                 *
     C** CALLS     - #ZC, #ZD, #ZE, #ZG                                  *
     C**                                                                 *
     C** CALLED BY - #ZI, #BC                                            *
     C**                                                                 *
     C********************************************************************
     C           #ZH       BEGSR                           ** #ZH       **
     C*
     C                     MOVE *BLANK    XXCCY
     C                     MOVE *BLANK    XXTOTE
     C                     MOVE *BLANK    XXTOTL
     C                     MOVE *BLANK    XXTOTC
     C                     MOVE *BLANK    XXTOTA
     C                     MOVE *BLANK    XXTOTB
     C                     MOVE *BLANK    XXTOTQ
     C*
     C                     ADD  1         WWCUPR
     C*
     C** WRITE HEADINGS
     C                     EXSR #ZC
     C*
     C** WRITE OVERVIEW
     C                     EXSR #ZD
     C*
     C** WRITE Exposure and Collateral details by group
     C                     EXSR #ZE
     C*
     C** WRITE Collateral Borowing Power details
      *                   Excluding unrealized FX Profit.                 R0665
     C                     EXSR #ZG
     C*                                                                   R0665
     C** WRITE Collateral Borowing Power - Additional information.        R0665
     C                     SETON                     36                   R0665
     C                     EXSR #ZG                                       R0665
     C                     SETOF                     36                   R0665
     C*
     C** WRITE Forward transactions for this customer                     SA9101
     C           *IN50     IFEQ '1'                                       SA9101
     C                     EXSR #ZK                                       SA9101
     C                     MOVE '0'       *IN50                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZI       - Produce a report for a single Customer just read    *
     C**             If End of Day run, only report if after report      *
     C**             date and update next report date.                   *
     C**                                                                 *
     C** CALLS     - #ZH                                                 *
     C**                                                                 *
     C** CALLED BY - #BA                                                 *
     C**                                                                 *
     C********************************************************************
     C           #ZI       BEGSR                           ** #ZI       **
     C*
     C           WWICFG    IFEQ '1'
     C                     EXSR #ZH
     C*
     C                     ELSE
     C*
     C** Only report if report date = or before run date
     C           BJRDNB    IFGE CUREPD
     C                     EXSR #ZH
     C*
     C** Now update report date fields
     C                     MOVE CUREPF    ZFREQ
     C                     Z-ADDCUREPD    ZDAYNO
     C                     Z-ADDCUREPN    ZMDAY
     C                     MOVE CUCCY     ZCCY
     C*
     C**   DON'T UPDATE IF ZMDAY = ZEROS
     C           ZMDAY     IFNE *ZEROS
     C*
     C**   NEW REVIEW DATE MUST BE > TODAY'S DATE
     C           ZDAYNO    DOWLEBJRDNB
     C***********          EXSR SFRQA                                     S01498
     C                     EXSR ZFRQA                                     S01498
     C                     END
     C*
     C**   UPDATE CLIENT MASTER FILE
     C*
     C***Not*allowed*to*update*the*Join*Logical*so*use*SDLBCSL9********   S01498
     C***********CUPNP8    CHAINSDLBCSL9             09                   S01498
     C*                                                                   S01498
     C** Not allowed to update the Join Logical so use LBLBCSL9           S01498
     C           CUCUST    CHAINLBLBCSL9             09                   S01498
     C           *IN09     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD6         DBASE            ***************
     C***********          MOVEL'SDLBCSL9'DBFILE           * DBERROR 006 *S01498
     C                     MOVE 'LBLBCSL9'DBFILE           * DBERROR 006 *S01498
     C***********          MOVELCUPNP8    DBKEY            ***************S01498
     C                     MOVELCUCUST    DBKEY            ***************S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C*
     C                     Z-ADDZDAYNO    CUREPD
     C                     UPDATSDLBCSD0
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #ZJ       - Retrieve account officer name OR report no details  *
     C**                                                                 *
     C** CALLS     - NONE                                                *
     C**                                                                 *
     C** CALLED BY - #BA, #BC                                            *
     C**                                                                 *
     C********************************************************************
     C           #ZJ       BEGSR                           **  #BC      **
     C*
     C** If nothing printed for this Account Officer :
     C**  write heading and NO DETAILS TO REPORT
     C           WWCUPR    IFEQ 0
     C                     MOVE '0'       *IN21
     C                     MOVE '0'       *IN22
     C*
     C** Set up Branch Code, A/C Officer Code and Name fields
     C                     MOVE '0'       *IN29
     C                     MOVE WWSPTA    RRSPTA
     C                     MOVE WWACOC    RRACOC
     C           RRACOC    IFEQ *BLANKS
     C                     MOVE *BLANKS   RRACON
     C                     ELSE
     C***********RRACOC    CHAINSDACOFL0             33                   S01498
     C************IN33     IFEQ '0'                                       S01498
     C***********AZTYLC    ANDNE'D'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOACOFR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM RRACOC    P@ACOC                          S01498
     C           SDACOF    PARM SDACOF    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFEQ *BLANK                                    S01498
     C                     MOVE AZACON    RRACON
     C                     ELSE
     C                     MOVE *BLANKS   RRACON
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            ***************
     C***********          MOVEL'SDACOFL0'DBFILE           * DBERROR 004 *S01498
     C                     MOVE 'SDACOFPD'DBFILE           * DBERROR 004 *S01498
     C                     MOVELRRACOC    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     END
     C*
     C*******              WRITEHEADING
     C*******              WRITENODETLS
     C*
     C                     END
     C*
     C***********          Z-ADD0         WWCUPR                          S01498
     C                     Z-ADD0         WWCUPR  50                      S01498
     C*
     C           #ZJ0      ENDSR                           **  #ZJ0     **
     C/EJECT
     C********************************************************************SA9101
     C**                                                                 *SA9101
     C** #ZK  -   Check if there are forward transactions to print       *SA9101
     C**                                                                 *SA9101
     C********************************************************************SA9101
     C           #ZK       BEGSR                           ** #ZK  **     SA9101
     C*                                                                   SA9101
     C                     MOVE '0'       *IN50                           SA9101
     C                     MOVE '0'       *IN13                           SA9101
     C***********WWCKY2    SETGTCLOANCL2                           SA9101 S01498
     C***********WWCUST    READECLOANCL2                 11        SA9101 S01498
     C           WWCKY2    SETGTLBLOANL2                                  S01498
     C           WWCUST    READELBLOANL2                 11               S01498
     C*                                                                   SA9101
     C***While*not*end*of*file*on*CLOANCL2*************************SA9101 S01498
     C** While not end of file on LBLOANL2                                S01498
     C           *IN11     DOWEQ'0'                                       SA9101
     C*                                                                   SA9101
     C           *IN13     IFEQ '0'                                       SA9101
     C*                                                                   SA9101
     C** If overflow detected on printer file                             SA9101
     C           *IN31     IFEQ '1'                                       SA9101
     C                     WRITEHEADING                                   SA9101
     C                     MOVE '0'       *IN31                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     WRITEHEADING4                                  SA9101
     C                     MOVE '1'       *IN13                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     MOVE LTYP      WWTYP                           SA9101
     C                     MOVE SUTP      WWSUB                           SA9101
     C                     MOVE CLAS      WWCLS                           CLE042
     C                     MOVE LNRF      RRREF                           SA9101
     C                     EXSR #ZKA                                      SA9101
     C                     EXSR #CONV                                     SA9101
     C*                                                                   SA9101
     C** If overflow detected on printer file                             SA9101
     C           *IN31     IFEQ '1'                                       SA9101
     C                     WRITEHEADING                                   SA9101
     C                     WRITEHEADING4                                  SA9101
     C                     MOVE '0'       *IN31                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     WRITEDETAIL4                                   SA9101
     C***********WWCUST    READECLOANCL2                 11        SA9101 S01498
     C           WWCUST    READELBLOANL2                 11               S01498
     C                     END                                            SA9101
     C*                                                                   SA9101
     C***********WWCKY2    SETGTCLOANCL3                           SA9101 S01498
     C***********WWCUST    READECLOANCL3                 11        SA9101 S01498
     C           WWCKY2    SETGTLBLOANL3                                  S01498
     C           WWCUST    READELBLOANL3                 11               S01498
     C*                                                                   SA9101
     C***While*not*end*of*file*on*CLOANCL3*************************SA9101 S01498
     C** While not end of file on LBLOANL3                                S01498
     C           *IN11     DOWEQ'0'                                       SA9101
     C*                                                                   SA9101
     C           *IN13     IFEQ '0'                                       SA9101
     C*                                                                   SA9101
     C** If overflow detected on printer file                             SA9101
     C           *IN31     IFEQ '1'                                       SA9101
     C                     WRITEHEADING                                   SA9101
     C                     MOVE '0'       *IN31                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     WRITEHEADING4                                  SA9101
     C                     MOVE '1'       *IN13                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     MOVE LTYP      WWTYP                           SA9101
     C                     MOVE SUTP      WWSUB                           SA9101
     C                     MOVE CLAS      WWCLS                           CLE042
     C                     MOVE LNRF      RRREF                           SA9101
     C                     EXSR #ZKA                                      SA9101
     C                     EXSR #CONV                                     SA9101
     C*                                                                   SA9101
     C** If overflow detected on printer file                             SA9101
     C           *IN31     IFEQ '1'                                       SA9101
     C                     WRITEHEADING                                   SA9101
     C                     WRITEHEADING4                                  SA9101
     C                     MOVE '0'       *IN31                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     WRITEDETAIL4                                   SA9101
     C***********WWCUST    READECLOANCL3                 11        SA9101 S01498
     C           WWCUST    READELBLOANL3                 11               S01498
     C                     END                                            SA9101
     C*                                                                   SA9101
     C***********WWCKY2    SETGTFIDEPOLA                           SA9101 S01498
     C***********WWCUST    READEFIDEPOLA                 11        SA9101 S01498
     C***********                                                  SA9101 S01498
     C***While*not*end*of*file*on*FIDEPOLA*************************SA9101 S01498
     C************IN11     DOWEQ'0'                                SA9101 S01498
     C***********                                                  SA9101 S01498
     C************IN13     IFEQ '0'                                SA9101 S01498
     C***********                                                  SA9101 S01498
     C***If*overflow*detected*on*printer*file**********************SA9101 S01498
     C************IN31     IFEQ '1'                                SA9101 S01498
     C***********          WRITEHEADING                            SA9101 S01498
     C***********          MOVE '0'       *IN31                    SA9101 S01498
     C***********          END                                     SA9101 S01498
     C***********                                                  SA9101 S01498
     C***********          WRITEHEADING4                           SA9101 S01498
     C***********          MOVE '1'       *IN13                    SA9101 S01498
     C***********          END                                     SA9101 S01498
     C***********                                                  SA9101 S01498
     C***********          MOVE FDDTYP    WWTYP                    SA9101 S01498
     C***********          MOVE FDSTRT    WWSUB                    SA9101 S01498
     C***********          MOVE FDDENR    RRREF                    SA9101 S01498
     C***********          EXSR #ZKB                               SA9101 S01498
     C***********          EXSR #CONV1                             SA9101 S01498
     C***********                                                  SA9101 S01498
     C***If*overflow*detected*on*printer*file**********************SA9101 S01498
     C************IN31     IFEQ '1'                                SA9101 S01498
     C***********          WRITEHEADING                            SA9101 S01498
     C***********          WRITEHEADING4                           SA9101 S01498
     C***********          MOVE '0'       *IN31                    SA9101 S01498
     C***********          END                                     SA9101 S01498
     C***********                                                  SA9101 S01498
     C***********          WRITEDETAIL4                            SA9101 S01498
     C***********WWCUST    READEFIDEPOLA                 11        SA9101 S01498
     C***********          END                                     SA9101 S01498
     C*                                                                   SA9101
     C                     Z-ADDBJRDNB    @@DAYN  50                      SA9101
     C                     EXSR ZA0710                                    SA9101
     C***********WWCKY3    SETGTMMDELDL2                           SA9101 S01498
     C***********WWCUST    READEMMDELDL2                 11        SA9101 S01498
     C           WWCKY3    SETGTLBDELDL2                                  S01498
     C           WWCUST    READELBDELDL2                 11               S01498
     C*                                                                   SA9101
     C***While*not*end*of*file*on*MMDELDL2*************************SA9101 S01498
     C** While not end of file on LBDELDL2                                S01498
     C           *IN11     DOWEQ'0'                                       SA9101
     C*                                                                   SA9101
     C           *IN13     IFEQ '0'                                       SA9101
     C*                                                                   SA9101
     C** If overflow detected on printer file                             SA9101
     C           *IN31     IFEQ '1'                                       SA9101
     C                     WRITEHEADING                                   SA9101
     C                     MOVE '0'       *IN31                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     WRITEHEADING4                                  SA9101
     C                     MOVE '1'       *IN13                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     MOVE HKTYPE    WWTYP                           SA9101
     C                     MOVE HKSTYP    WWSUB                           SA9101
     C                     MOVE HKCLAS    WWCLS                           CLE042
     C                     MOVE HKDN38    RRREF                           SA9101
     C                     EXSR #ZKB                                      SA9101
     C                     EXSR #CONV2                                    SA9101
     C*                                                                   SA9101
     C** If overflow detected on printer file                             SA9101
     C           *IN31     IFEQ '1'                                       SA9101
     C                     WRITEHEADING                                   SA9101
     C                     WRITEHEADING4                                  SA9101
     C                     MOVE '0'       *IN31                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     WRITEDETAIL4                                   SA9101
     C***********WWCUST    READEMMDELDL2                 11        SA9101 S01498
     C           WWCUST    READELBDELDL2                 11               S01498
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     ENDSR                                          SA9101
     C/EJECT                                                              SA9101
     C********************************************************************SA9101
     C**                                                                 *SA9101
     C** #CONV  -  Format value and maturity date                        *SA9101
     C**        -  Retrieve instrument group narrative                   *SA9101
     C**        -  Convert amount in Portfolio currency                  *SA9101
     C**        -  Edit amounts                                          *SA9101
     C**                                                                 *SA9101
     C********************************************************************SA9101
     C           #CONV     BEGSR                                          SA9101
     C*                                                                   SA9101
     C** Determine value date in DDMMMYY format                           SA9101
     C           VDAT      IFEQ *ZEROS                                    SA9101
     C                     MOVE *BLANKS   RRVDAT                          SA9101
     C                     ELSE                                           SA9101
     C                     Z-ADDVDAT      ZDAYNO                          SA9101
     C                     EXSR ZDATE2                                    SA9101
     C                     MOVE ZADATE    RRVDAT                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C** Determine maturity date in DDMMMYY format                        SA9101
     C           MDAT      IFEQ *ZEROS                                    SA9101
     C                     MOVE *BLANKS   RRMDAT                          SA9101
     C                     ELSE                                           SA9101
     C                     Z-ADDMDAT      ZDAYNO                          SA9101
     C                     EXSR ZDATE2                                    SA9101
     C                     MOVE ZADATE    RRMDAT                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C** Find the number of decimal places etc. for the Customer currency SA9101
     C                     MOVE CCY       RRCURR                          SA9101
     C                     MOVE CCY       WWCCY   3                       SA9101
     C                     EXSR #ZB                                       SA9101
     C                     Z-ADDA6NBDP    WWCUDP  10                      SA9101
     C                     Z-ADDA6SPRT    WWSRO                           SA9101
     C                     Z-ADDA6NBDP    WWDPO                           SA9101
     C                     MOVE A6MDIN    WWMDO                           SA9101
     C                     Z-ADDCPAM      WWAMTI                          SA9101
     C                     EXSR SCONV                                     SA9101
     C                     Z-ADDWWAMTO    ZFLD15                          SA9101
     C                     Z-ADDWWDPI     ZDECS                           SA9101
     C                     EXSR ZSEDIT                                    SA9101
     C                     MOVE ZOUT21    RRALC                           SA9101
     C*                                                                   SA9101
     C** If original currency not equal to Portfolio currency ...         SA9101
     C***********CCY       IFNE LBCCY                              SA9101 S01498
     C           CCY       IFNE LBCYCD                             SA9101 S01498
     C                     Z-ADDCPAM      ZFLD15                          SA9101
     C                     Z-ADDWWDPO     ZDECS                           SA9101
     C                     EXSR ZSEDIT                                    SA9101
     C                     MOVE ZOUT21    RRAOC                           SA9101
     C                     ELSE                                           SA9101
     C                     MOVE ZOUT21    RRAOC                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     ENDSR                                          SA9101
     C*                                                                   SA9101
     C********************************************************************SA9101
     C/EJECT                                                              SA9101
     C*************************************************************SA9101 S01498
     C*************************************************************SA9101 S01498
     C***#CONV1*-**Format*value*and*maturity*date******************SA9101 S01498
     C**********-**Retrieve*instrument*group*narrative*************SA9101 S01498
     C**********-**Convert*amount*in*Portfolio*currency************SA9101 S01498
     C**********-**Edit*amounts************************************SA9101 S01498
     C*************************************************************SA9101 S01498
     C*************************************************************SA9101 S01498
     C***********#CONV1    BEGSR                                   SA9101 S01498
     C***********                                                  SA9101 S01498
     C***Determine*value*date*in*DDMMMYY*format********************SA9101 S01498
     C***********FDVDAT    IFEQ *ZEROS                             SA9101 S01498
     C***********          MOVE *BLANKS   RRVDAT                   SA9101 S01498
     C***********          ELSE                                    SA9101 S01498
     C***********          Z-ADDFDVDAT    ZDAYNO                   SA9101 S01498
     C***********          EXSR ZDATE2                             SA9101 S01498
     C***********          MOVE ZADATE    RRVDAT                   SA9101 S01498
     C***********          END                                     SA9101 S01498
     C***********                                                  SA9101 S01498
     C***Determine*maturity*date*in*DDMMMYY*format*****************SA9101 S01498
     C***********FDMDAT    IFEQ *ZEROS                             SA9101 S01498
     C***********          MOVE *BLANKS   RRMDAT                   SA9101 S01498
     C***********          ELSE                                    SA9101 S01498
     C***********          Z-ADDFDMDAT    ZDAYNO                   SA9101 S01498
     C***********          EXSR ZDATE2                             SA9101 S01498
     C***********          MOVE ZADATE    RRMDAT                   SA9101 S01498
     C***********          END                                     SA9101 S01498
     C***********                                                  SA9101 S01498
     C***Find*the*number*of*decimal*places*etc.*for*the*Customer*cuSA9101 S01498
     C***********          MOVE FDCCY     RRCURR                   SA9101 S01498
     C***********          MOVE FDCCY     WWCCY                    SA9101 S01498
     C***********          EXSR #ZB                                SA9101 S01498
     C***********          Z-ADDA6NBDP    WWCUDP  10               SA9101 S01498
     C***********          Z-ADDA6SPRT    WWSRO                    SA9101 S01498
     C***********          Z-ADDA6NBDP    WWDPO                    SA9101 S01498
     C***********          MOVE A6MDIN    WWMDO                    SA9101 S01498
     C***********          Z-ADDFDPCPL    WWAMTI                   SA9101 S01498
     C***********          EXSR SCONV                              SA9101 S01498
     C***********          Z-ADDWWAMTO    ZFLD15                   SA9101 S01498
     C***********          Z-ADDWWDPI     ZDECS                    SA9101 S01498
     C***********          EXSR ZSEDIT                             SA9101 S01498
     C***********          MOVE ZOUT21    RRALC                    SA9101 S01498
     C***********                                                  SA9101 S01498
     C***If*original*currency*not*equal*to*Portfolio*currency******SA9101 S01498
     C***********FDCCY     IFNE LBCCY                              SA9101 S01498
     C***********          Z-ADDFDPCPL    ZFLD15                   SA9101 S01498
     C***********          Z-ADDWWDPO     ZDECS                    SA9101 S01498
     C***********          EXSR ZSEDIT                             SA9101 S01498
     C***********          MOVE ZOUT21    RRAOC                    SA9101 S01498
     C***********          ELSE                                    SA9101 S01498
     C***********          MOVE ZOUT21    RRAOC                    SA9101 S01498
     C***********          END                                     SA9101 S01498
     C***********                                                  SA9101 S01498
     C***********          ENDSR                                   SA9101 S01498
     C***********                                                  SA9101 S01498
     C********************************************************************SA9101
     C/EJECT                                                              SA9101
     C********************************************************************SA9101
     C**                                                                 *SA9101
     C** #CONV2 -  Format value and maturity date                        *SA9101
     C**        -  Retrieve instrument group narrative                   *SA9101
     C**        -  Convert amount in Portfolio currency                  *SA9101
     C**        -  Edit amounts as per standard routine (ZSEDIT)         *SA9101
     C**                                                                 *SA9101
     C********************************************************************SA9101
     C           #CONV2    BEGSR                                          SA9101
     C*                                                                   SA9101
     C** Determine the value date in DDMMMYY format                       SA9101
     C           HKVDMM    IFNE *ZEROS                                    SA9101
     C                     MOVE HKVDMM    J       20                      SA9101
     C                     MOVE *BLANKS   WWDAT1  5                       SA9101
     C                     MOVE HKVDYY    DSVDYY                          SA9101
     C                     MOVELHKVDDD    WWDAT1                          SA9101
     C                     MOVE ZMNM,J    WWDAT1                          SA9101
     C                     MOVE HKVDY2    RRVDAT                          SA9101
     C                     MOVELWWDAT1    RRVDAT                          SA9101
     C                     ELSE                                           SA9101
     C                     MOVE *BLANKS   RRVDAT                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C** Determine the maturity date in DDMMMYY format                    SA9101
     C           HKMDMM    IFNE *ZEROS                                    SA9101
     C                     MOVE HKMDMM    J                               SA9101
     C                     MOVE *BLANKS   WWDAT1                          SA9101
     C                     MOVE HKMDYY    DSMDYY                          SA9101
     C                     MOVELHKMDDD    WWDAT1                          SA9101
     C                     MOVE ZMNM,J    WWDAT1                          SA9101
     C                     MOVE HKMDY2    RRMDAT                          SA9101
     C                     MOVELWWDAT1    RRMDAT                          SA9101
     C                     ELSE                                           SA9101
     C                     MOVE *BLANKS   RRMDAT                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C** Find the number of decimal places etc. for the Customer currency SA9101
     C                     MOVE HKCCY     RRCURR                          SA9101
     C                     MOVE HKCCY     WWCCY                           SA9101
     C                     EXSR #ZB                                       SA9101
     C                     Z-ADDA6NBDP    WWCUDP  10                      SA9101
     C                     Z-ADDA6SPRT    WWSRO                           SA9101
     C                     Z-ADDA6NBDP    WWDPO                           SA9101
     C                     MOVE A6MDIN    WWMDO                           SA9101
     C                     Z-ADDHKAMNP    WWAMTI                          SA9101
     C                     EXSR SCONV                                     SA9101
     C                     Z-ADDWWAMTO    ZFLD15                          SA9101
     C                     Z-ADDWWDPI     ZDECS                           SA9101
     C                     EXSR ZSEDIT                                    SA9101
     C                     MOVE ZOUT21    RRALC                           SA9101
     C*                                                                   SA9101
     C** If original currency not equal to Portfolio currency             SA9101
     C***********HKCCY     IFNE LBCCY                              SA9101 S01498
     C           HKCCY     IFNE LBCYCD                             SA9101 S01498
     C                     Z-ADDHKAMNP    ZFLD15                          SA9101
     C                     Z-ADDWWDPO     ZDECS                           SA9101
     C                     EXSR ZSEDIT                                    SA9101
     C                     MOVE ZOUT21    RRAOC                           SA9101
     C                     ELSE                                           SA9101
     C                     MOVE ZOUT21    RRAOC                           SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     ENDSR                                          SA9101
     C*                                                                   SA9101
     C********************************************************************SA9101
     C/EJECT                                                              SA9101
     C********************************************************************SA9101
     C**                                                                 *SA9101
     C** #ZB       - Read Currency file                                  *SA9101
     C**                                                                 *SA9101
     C** CALLS     - #ZA                                                 *SA9101
     C**                                                                 *SA9101
     C** CALLED BY - #ZA                                                 *SA9101
     C**                                                                 *SA9101
     C********************************************************************SA9101
     C           #ZB       BEGSR                           **  #ZB  **    SA9101
     C*                                                                   SA9101
     C***********WWCCY     CHAINSDCURRL1             79            SA9101 S01498
     C***********                                                  SA9101 S01498
     C************IN79     IFEQ '1'                                SA9101 S01498
     C***********A6TYLC    OREQ 'D'                        ********SA9101 S01498
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROSA9101 S01498
     C*                                                                   S01498
     C** Get currency details using access object                         S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWCCY     P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                        ***************S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 009 *S01498
     C                     MOVE '009'     DBASE            ***************SA9101
     C                     MOVELWWCCY     DBKEY                           SA9101
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     ENDSR                                          SA9101
     C********************************************************************SA9101
      /EJECT                                                              SA9101
     C********************************************************************SA9101
     C**                                                                 *SA9101
     C** #ZKA  -  Retrieve instrument group narrative                    *SA9101
     C**                                                                 *SA9101
     C********************************************************************SA9101
     C           #ZKA      BEGSR                                          SA9101
     C*                                                                   SA9101
     C***********WWCKY4    CHAINSDLOANL1             15            SA9101 S01498
     C************IN15     IFEQ '1'                        ********SA9101 S01498
     C*                                                                   S01498
     C                     CALL 'AOLOANR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM WWTYP     P@TYP   2                       S01498
     C                     PARM WWSUB     P@SUB   2                       S01498
     C                     PARM WWCLS     P@CLS   4                       CLE042
     C           SDLOAN    PARM SDLOAN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                        ***************S01498
     C***********          MOVEL'SDLOANL1'DBFILE           * DBERROSA9101 S01498
     C                     MOVE 'SDLOANPD'DBFILE           * DBERROR 010 *S01498
     C                     MOVE '010'     DBASE            ***************SA9101
     C                     MOVE *BLANKS   DBKEY                           SA9101
     C                     MOVELKEY8      DBKEY                           CLE042
     C*********************MOVELKEY4      DBKEY                    SA9101 CLE042
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C***********AYINNR    CHAINSDPLINL4             15            SA9101 S01498
     C************IN15     IFEQ '1'                        ********SA9101 S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM AYINNR    P@INST                          S01498
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                        ***************S01498
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROSA9101 S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 011 *S01498
     C                     MOVE '011'     DBASE            ***************SA9101
     C                     MOVE *BLANKS   DBKEY                           SA9101
     C                     MOVELAYINNR    DBKEY                           SA9101
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C***********PDLOMG    CHAINLBGROUL1             15            SA9101 S01498
     C************IN15     IFEQ '1'                        ********SA9101 S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM PDLOMG    P@LCGR                          S01498
     C           SDGROU    PARM SDGROU    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                        ***************S01498
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROSA9101 S01498
     C                     MOVE 'LBGROUPD'DBFILE           * DBERROR 012 *S01498
     C                     MOVE '012'     DBASE            ***************SA9101
     C                     MOVE *BLANKS   DBKEY                           SA9101
     C                     MOVELPDLOMG    DBKEY                           SA9101
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9101
     C                     ELSE                                           SA9101
     C                     MOVE GPLCGN    RRLCGN                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     ENDSR                                          SA9101
     C/EJECT                                                              SA9101
     C********************************************************************SA9101
     C**                                                                 *SA9101
     C** #ZKB  -  Retrieve instrument group narrative                    *SA9101
     C**                                                                 *SA9101
     C********************************************************************SA9101
     C           #ZKB      BEGSR                                          SA9101
     C*                                                                   SA9101
     C***********WWCKY4    CHAINSDDTSTLB             15            SA9101 S01498
     C           WWCKY4    CHAINFDDTSTL0             15                   S01498
     C           *IN15     IFEQ '1'                        ***************SA9101
     C           *LOCK     IN   LDA                        ***************S01498
     C***********          MOVEL'SDDTSTLB'DBFILE           * DBERROSA9101 S01498
     C                     MOVE 'FDDTSTL0'DBFILE           * DBERROR 013 *S01498
     C                     MOVE '013'     DBASE            ***************SA9101
     C                     MOVE *BLANKS   DBKEY                           SA9101
     C                     MOVELKEY8      DBKEY                           CLE042
     C*********************MOVELKEY4      DBKEY                    SA9101 CLE042
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C***********P7INNR    CHAINSDPLINL4             15            SA9101 S01498
     C************IN15     IFEQ '1'                        ********SA9101 S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM INNR      P@INST                          S01498
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                        ***************S01498
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROSA9101 S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 014 *S01498
     C                     MOVE '014'     DBASE            ***************SA9101
     C                     MOVE *BLANKS   DBKEY                           SA9101
     C***********          MOVELP7INNR    DBKEY                    SA9101 S01498
     C                     MOVELINNR      DBKEY                           S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C***********PDLOMG    CHAINLBGROUL1             15            SA9101 S01498
     C************IN15     IFEQ '1'                        ********SA9101 S01498
     C*                                                                   S01498
     C**  Use access object AOGROUR0 to get group name                    S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM PDLOMG    P@LCGR                          S01498
     C           SDGROU    PARM SDGROU    DSFDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                        ***************S01498
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROSA9101 S01498
     C                     MOVE 'LBGROUPD'DBFILE           * DBERROR 015 *S01498
     C                     MOVE '015'     DBASE            ***************SA9101
     C                     MOVE *BLANKS   DBKEY                           SA9101
     C                     MOVELPDLOMG    DBKEY                           SA9101
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9101
     C                     ELSE                                           SA9101
     C                     MOVE GPLCGN    RRLCGN                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     ENDSR                                          SA9101
     C********************************************************************SA9101
     C/EJECT                                                              SA9101
     C********************************************************************
     C**                                                                 *
     C** #BB       - Produce a report for a selected Customer            *
     C**                                                                 *
     C** CALLS     - #ZH                                                 *
     C**                                                                 *
     C** CALLED BY - #B                                                  *
     C**                                                                 *
     C********************************************************************
     C           #BB       BEGSR                           ** #BB       **
     C*
     C** If this is a parent, report parent and all children
     C           BBPAIN    IFEQ 'P'
     C                     EXSR #ZH
     C*
     C** Now report all its children
     C                     MOVE BBCUST    WWPANO
     C*
     C***********WWPANO    SETLLSDLBCSL6                 06               S01498
     C***********WWPANO    READESDLBCSL6                 06               S01498
     C           WWPANO    SETLLLBLBCSJ6                 06               S01498
     C           WWPANO    READELBLBCSJ6                 06               S01498
     C           *IN06     DOWEQ'0'
     C                     EXSR #ZH
     C***********WWPANO    READESDLBCSL6                 06               S01498
     C           WWPANO    READELBLBCSJ6                 06               S01498
     C                     END
     C*
     C                     ELSE
     C*
     C** Else just report this orphan/loner or child
     C                     EXSR #ZH
     C                     END
     C*
     C           #BB0      ENDSR                           ** #BB0      **
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #A        - THIS SUBROUTINE ACCESSES ICD DATA AND INITIALISES   *
     C**             WORK FIELDS.                                        *
     C**                                                                 *
     C** CALLS     - #ZA                                                 *
     C**                                                                 *
     C** CALLED BY - MAINLINE                                            *
     C**                                                                 *
     C********************************************************************
     C           #A        BEGSR                           ** #A        **
     C*                                                                   S01498
     C**  Copyright statement                                             S01498
     C*                                                                   S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*                                                                   S01498
     C**  Read in DTAARA/RUNDAT to get multibranching indicator           S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           RUNDAT                          S01498
     C                     IN   RUNDAT                                    S01498
     C           AGMBIN    IFEQ 'Y'                                       S01498
     C                     MOVE '1'       *IN39                           S01498
     C                     ELSE                                           S01498
     C*                                                                   S01498
     C**  Else, setup appropriate level and entity                        S01498
     C                     MOVE 'S'       @RLEV                           S01498
     C                     MOVE *BLANKS   @RENT                           S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           LDA                             S01498
     C           *LOCK     IN   LDA                                       S01498
     C*
     C**   INITIALISE DB ERROR FIELDS AND STORE PROGRAM NAME FOR
     C**   DB ERROR FIELD.
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD0         DBASE
     C                     MOVEL'LB0360'  DBPGM
     C                     OUT  LDA                                       S01498
     C*
     C**   INITIALISE REPORT HEADER FIELDS
     C                     MOVE *BLANKS   RRSPTA
     C                     MOVE *BLANKS   RRACOC
     C                     MOVE *BLANKS   RRACON
     C                     MOVE *BLANKS   RRPANO
     C                     MOVE *BLANKS   RRPRNM
     C                     MOVE *BLANKS   RRCUNO
     C                     MOVE *BLANKS   RRCRNM
     C*
     C**   DEFINE WORK FIELDS
     C           *LIKE     DEFN BBCUST    WWCUNO
     C           *LIKE     DEFN BBPCNB    WWPANO
     C           *LIKE     DEFN BBBRCD    WWSPTA
     C           *LIKE     DEFN CUINBP    WWINBP
     C           *LIKE     DEFN CUCCY     WWCUCY
     C           *LIKE     DEFN BBPAIN    WWPAIN
     C           *LIKE     DEFN BBACOC    WWACOC
     C           *LIKE     DEFN EELCGR    WWLCGR
     C           *LIKE     DEFN EEINST    WWINST
     C/COPY WNCPYSRC,LB0360C003
     C*
     C*****ACCESS*ICD*RECORD*1*****************************************   S01498
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 20               S01498
     C***********                                                         S01498
     C*****IF*ICD*1*NOT*FOUND*THEN*DB*ERROR****************************   S01498
     C************IN20     IFEQ '1'                                       S01498
     C***********BJTYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C**  Get bank details using access object                            S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM '*DBERR'  P@RTCD  7                       S01498
     C                     PARM '*FIRST'  P@OPTN  7                       S01498
     C           SDBANK    PARM SDBANK    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD1         DBASE            ***************
     C***********          MOVEL'SDBANKPD'DBFILE           * DBERROR 001 *S01498
     C                     MOVE 'SDBANKPD'DBFILE           * DBERROR 001 *S01498
     C                     OUT  LDA                        ***************S01498
     C                     EXSR #ZA                        ***************
     C                     END
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ELSE
     C                     MOVE '0'       *IN98
     C                     END
     C*
     C** ACCESS PORTFOLIO LENDING ICD
     C**  using access objects                                            S01498
     C*                                                                   S01498
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 20               S01498
     C***********                                                         S01498
     C*****IF*ICD*1*NOT*FOUND*THEN*DB*ERROR****************************   S01498
     C************IN20     IFEQ '1'                                       S01498
     C***********LBRECI    ORNE 'D'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST'  P@OPTN                          S01498
     C           SDLOMB    PARM SDLOMB    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD2         DBASE            ***************
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 002 *S01498
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 002 *S01498
     C                     OUT  LDA                        ***************S01498
     C                     EXSR #ZA                        ***************
     C                     END
     C*                                                                   SA9101
     C** Find the number of decimal places for the Portfolio base currencySA9101
     C***********          MOVE LBCCY     WWCCY                    SA9101 S01498
     C                     MOVE LBCYCD    WWCCY                    SA9101 S01498
     C                     EXSR #ZB                                       SA9101
     C                     Z-ADDA6NBDP    WWLBDP  10                      SA9101
     C                     Z-ADDA6SPRT    WWSRI                           SA9101
     C                     Z-ADDA6NBDP    WWDPI                           SA9101
     C                     MOVE A6MDIN    WWMDI                           SA9101
     C*
     C** SET UP THE CURRENCY DETAILS FOR THE PORTFOLIO BASE CURRENCY
     C** FOR THE CURRENCY CONVERSION SUBROUTINE - INPUT FIELDS
     C***********LBCCY     CHAINSDCURRL1             72                   S01498
     C************IN72     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C** Get currency details using access object                         S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM LBCYCD    P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 003 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 003 *S01498
     C***********          MOVELLBCCY     DBKEY            ***************S01498
     C                     MOVELLBCYCD    DBKEY            ***************S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C                     MOVE A6SPRT    WWSRI
     C                     Z-ADDA6NBDP    WWDPI
     C                     MOVE A6MDIN    WWMDI
     C                     Z-ADDA6NBDP    WWLBDP  10
     C                     MOVE 'J'       ZECODE
     C*
     C**   INITIALISE LINE COUNTER ETC
     C                     Z-ADD*ZEROS    LINE
     C                     Z-ADD0         RRNORE  50
     C                     MOVE 'P'       WWTYPE
     C*
     C**   Initialise overflow and "forward transactions" indicators
     C                     MOVE '0'       *IN31                           SA9101
     C                     MOVE '0'       *IN50                           SA9101
     C*                                                                   S01498
     C**  If a specific branch is selected, move entity to work field     S01498
     C*                                                                   S01498
     C           @RENT     IFNE 'ALL'                                     S01498
     C           @RENT     ANDNE*BLANKS                                   S01498
     C                     MOVE @RENT     WBRCA   3                       S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C** Ensure Audit Spool File recorded by RCF                          S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUMU    ZSNUM2  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           @RSEQ                           S01498
     C                     PARM *BLANK    SENTY                           S01498
     C                     PARM           SFILEU                          S01498
     C                     PARM           ZSNUM2                          S01498
     C                     PARM           ZSERR                           S01498
     C*                                                                   S01498
     C** If an error occurred during ZSFILE processing,                   S01498
     C** return to the calling program.                                   S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     EXSR *PSSR                                     S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   SA9101
      *                                                                                       CCB020
      ** Check if the system is in COB Phase                                                  CCB020
      *                                                                                       CCB020
     C                     MOVEL'CBC00100'@RTPRM  9                                           CCB020
     C                     MOVE '1'       @RTPRM                                              CCB020
     C                     CALL @RTPRM                                                        CCB020
     C                     PARM *BLANKS   COBST   4                                           CCB020
      *                                                                                       CCB020
     C           #A0       ENDSR                           ** #A0       **
     C********************************************************************
     C/EJECT
     C********************************************************************
     C* #B        - MAIN PROCESSING                                      *
     C*                                                                  *
     C* CALLS     -                                                      *
     C*                                                                  *
     C* CALLED BY - MAINLINE                                             *
     C*                                                                  *
     C********************************************************************
     C           #B        BEGSR                           ** #B        **
     C*
     C**  Determine whether Input Cycle or End of Day
     C           WWICFG    IFEQ '1'
     C*
     C** Then input cycle
     C*
     C*****OPEN*INPUT*SPOOL*FILE***************************************   S01498
     C***********          OPEN QINLINE                                   S01498
     C***********                                                         S01498
     C*****READ*INPUT*FROM*'QINLINE'***********************************   S01498
     C***********          READ QINLINE                  40               S01498
     C***********                                                         S01498
     C*****NO*DETAILS*TO*REPORT****************************************   S01498
     C************IN40     IFEQ '1'                                       S01498
     C***********          WRITEHEADING                                   S01498
     C***********          WRITENODETLS                                   S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C*****DO*WHILE*NOT*EOF********************************************   S01498
     C************IN40     DOWEQ'0'                                       S01498
     C*
     C**   PRINT SELECTION REQUESTED
     C*
     C                     MOVE '1'       *IN42
     C*
     C*
     C**   PRODUCE REPORT AS REQUESTED
     C*
     C           WWQCNA    IFNE *BLANKS
     C*
     C                     MOVE '1'       *IN45
     C*
     C           WWQCNA    IFEQ '*ALL'
     C                     MOVE '0'       *IN57
     C                     MOVE '0'       *IN58
     C*
     C** Produce full report
     C                     MOVE '0'       WWBRPR  1
     C                     MOVE *BLANKS   WWSPTA
     C                     MOVE WWQCNA    RRPNP8
     C                     EXSR #BA
     C*
     C************IN57     IFEQ '0'                                       S01498
     C************IN58     ANDEQ'0'                                       S01498
     C***********                                                         S01498
     C***Write*no*details*to*report*for*ANY*branches*******************   S01498
     C***********          MOVE '0'       *IN21                           S01498
     C***********          MOVE '0'       *IN22                           S01498
     C***********          MOVE '0'       *IN29                           S01498
     C***********          MOVE *BLANKS   RRSPTA                          S01498
     C***********          MOVE *BLANKS   RRACOC                          S01498
     C***********          MOVE *BLANKS   RRACON                          S01498
     C***********          WRITEHEADING                                   S01498
     C***********          WRITENODETLS                                   S01498
     C***********          END                                            S01498
     C*
     C                     ELSE
     C                     MOVE '0'       *IN57
     C                     MOVE '0'       *IN58
     C*
     C** Produce a report for selected customer
     C***********WWQCNA    CHAINSDLBCSL0             10                   S01498
     C           WWQCNA    CHAINLBLBCSJ0             10                   S01498
     C           *IN10     IFEQ '1'
     C                     MOVE '1'       *IN29
     C                     MOVE '0'       *IN21
     C                     MOVE '1'       *IN22
     C                     MOVE *BLANKS   RRSPTA
     C                     ELSE
     C*                                                                   S01498
     C**  Produce report if ALL branches selected or if branch is         S01498
     C**  equal to branch selected                                        S01498
     C*                                                                   S01498
     C           @RENT     IFEQ 'ALL'                                     S01498
     C           @RENT     OREQ *BLANKS                                   S01498
     C           BBBRCD    OREQ WBRCA                                     S01498
     C                     MOVE '1'       *IN46
     C                     MOVE WWQCNA    RRPNP8
     C                     MOVE BBCSSN    RRNAME
     C                     MOVE BBBRCD    WLBRCA                          S01498
     C                     EXSR #BB
     C                     END                                            S01498
     C*
     C                     END
     C*
     C************IN57     IFEQ '0'                                       S01498
     C************IN58     ANDEQ'0'                                       S01498
     C***********          WRITEHEADING                                   S01498
     C***********          WRITENODETLS                                   S01498
     C***********          END                                            S01498
     C                     END
     C*
     C                     END
     C*
     C***********WWQBRC    IFNE *BLANKS                                   S01498
     C***********          MOVE '0'       *IN57                           S01498
     C***********          MOVE '0'       *IN58                           S01498
     C***********                                                         S01498
     C***Produce*a*report*for*a*selected*branch************************   S01498
     C***********          MOVE '1'       WWBRPR                          S01498
     C***********          MOVE WWQBRC    WWSPTA                          S01498
     C***********          MOVE '1'       *IN43                           S01498
     C***********          MOVE WWQBRC    RRSPTA                          S01498
     C***********          EXSR #BA                                       S01498
     C***********                                                         S01498
     C************IN57     IFEQ '0'                                       S01498
     C************IN58     ANDEQ'0'                                       S01498
     C***********          WRITEHEADING                                   S01498
     C***********          WRITENODETLS                                   S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***********WWQACO    IFNE *BLANKS                                   S01498
     C***********          MOVE '0'       *IN57                           S01498
     C***********          MOVE '0'       *IN58                           S01498
     C***********                                                         S01498
     C***Produce*a*report*for*a*selected*Account*Officer***************   S01498
     C***********          MOVE '1'       *IN44                           S01498
     C***********          MOVE WWQACO    RRACCO                          S01498
     C***********          MOVE *BLANKS   WWSPTA                          S01498
     C***********          MOVE WWQACO    WWACOC                          S01498
     C***********          EXSR #BC                                       S01498
     C***********                                                         S01498
     C************IN57     IFEQ '0'                                       S01498
     C************IN58     ANDEQ'0'                                       S01498
     C***********          WRITEHEADING                                   S01498
     C***********          WRITENODETLS                                   S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***********          END                                            S01498
     C*
     C** Produce a run controls report
     C                     EXSR #ZF
     C*
     C**   EXIT IF DATA BASE ERROR
     C           *INU7     CABEQ'1'       #B0
     C*
     C*****READ*NEXT*ENTRY*ON*'QINLINE'********************************   S01498
     C***********          READ QINLINE                  40               S01498
     C***********                                                         S01498
     C***********          END                                            S01498
     C*
     C                     ELSE
     C                     MOVE '0'       *IN57
     C                     MOVE '0'       *IN58
     C*
     C** End of Day processing - produce full report
     C                     MOVE '0'       WWBRPR
     C                     MOVE *BLANKS   WWSPTA
     C                     EXSR #BA
     C*
     C************IN57     IFEQ '0'                                       S01498
     C************IN58     ANDEQ'0'                                       S01498
     C***********                                                         S01498
     C***Write*no*details*to*report*for*ANY*branches*******************   S01498
     C***********          MOVE '0'       *IN21                           S01498
     C***********          MOVE '0'       *IN22                           S01498
     C***********          MOVE '0'       *IN29                           S01498
     C***********          MOVE *BLANKS   RRSPTA                          S01498
     C***********          MOVE *BLANKS   RRACOC                          S01498
     C***********          MOVE *BLANKS   RRACON                          S01498
     C***********          WRITEHEADING                                   S01498
     C***********          WRITENODETLS                                   S01498
     C***********          END                                            S01498
     C*
     C                     END
     C*
     C           #B0       ENDSR                           ** #B0       **
     C********************************************************************
     C/EJECT
     C********************************************************************
     C** #C        - TERMINATION PROCESSING                              *
     C**                                                                 *
     C** CALLS     - NONE                                                *
     C**                                                                 *
     C** CALLED BY - MAINLINE                                            *
     C**                                                                 *
     C********************************************************************
     C           #C        BEGSR                           ** #C        **
     C*
     C**   PRODUCE A RUN CONTROL REPORT
     C           WWICFG    IFEQ '0'
     C                     EXSR #ZF
     C                     END
     C*
     C           #C0       ENDSR                           ** #C0       **
     C/EJECT
     C********************************************************************
     C** #ZF       - PRODUCE A RUN CONTROL REPORT                        *
     C**                                                                 *
     C** CALLS     - NONE                                                *
     C**                                                                 *
     C** CALLED BY - MAINLINE                                            *
     C**                                                                 *
     C********************************************************************
     C           #ZF       BEGSR                           ** #ZF       **
     C*
     C**   PRINT HEADINGS ON OVERFLOW
     C           LINE      IFGT 56
     C                     WRITEHEADING
     C                     END
     C*                                                                   S01498
     C**  Write to LB0360P1 only if it is open                            S01498
     C           WLOPN     IFEQ 'Y'                                       S01498
     C*
     C**   'END OF REPORT' OUTPUT
     C                     WRITEENDOFR
     C                     CLOSELB0360P1                                  S01498
     C                     MOVE *BLANK    WLOPN                           S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C*
     C**   INITIALIZE LINE AND PAGE COUNT AND PRODUCE A RUN CONTROL
     C**   REPORT
     C                     Z-ADD*ZEROS    LINE1
     C                     Z-ADD*ZEROS    PAGE
     C*
     C** WRITE RUN CONTROLS REPORT
     C                     WRITERUNHDR
     C                     WRITERUNDET
     C***********          WRITERUNEOFR                                   S01498
     C*                                                                   S01498
     C**  Print 'No details to report'                                    S01498
     C           *IN57     IFEQ '0'                                       S01498
     C           *IN58     ANDEQ'0'                                       S01498
     C                     WRITENODTLS                                    S01498
     C                     END                                            S01498
     C*
     C** RESET LINE AND PAGE FOR MAIN REPORT
     C                     Z-ADD*ZEROS    LINE
     C                     Z-ADD*ZEROS    PAGE
     C                     Z-ADD*ZEROS    RRNORE
     C*
     C** SET OF SELECTION INDICATORS
     C*
     C                     MOVEA'00000'   *IN,42
     C*
     C           #ZF0      ENDSR                           ** #ZF0      **
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** #BA       - Full or Branch Report                               *
     C**                                                                 *
     C** CALLS     - #ZI, #ZJ                                            *
     C**                                                                 *
     C** CALLED BY - MAINLINE                                            *
     C**                                                                 *
     C********************************************************************
     C           #BA       BEGSR                           **  #BA      **
     C*
     C***This*S/R*produces*a*full*report*if*WWBRPR*=*'0'***************   S01498
     C***OR*a*report*for*branch*WWBRCD*if*WWBRPR*=*'1'*****************   S01498
     C***********WWBRPR    IFEQ '1'                                       S01498
     C***********                                                         S01498
     C***Report*for*single*branch*requested****************************   S01498
     C***********WWSPTA    SETLLSDLBCSLA                 01               S01498
     C***********WWSPTA    READESDLBCSLA                 01               S01498
     C***********                                                         S01498
     C***********          Z-ADD0         WWCUPR                          S01498
     C***********                                                         S01498
     C************IN01     IFEQ '0'                                       S01498
     C***********          MOVE BBACOC    WWACOC                          S01498
     C***********          ELSE                                           S01498
     C***********                                                         S01498
     C***Write*no*details*to*report*for*this*branch********************   S01498
     C***********          MOVE '0'       *IN21                           S01498
     C***********          MOVE '0'       *IN22                           S01498
     C***********          MOVE '0'       *IN29                           S01498
     C***********          MOVE WWSPTA    RRSPTA                          S01498
     C***********          MOVE *BLANKS   RRACOC                          S01498
     C***********          MOVE *BLANKS   RRACON                          S01498
     C***********                                                         S01498
     C*******              WRITEHEADING
     C*******              WRITENODETLS
     C***********                                                         S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C************IN01     DOWEQ'0'                                       S01498
     C***********                                                         S01498
     C***********          EXSR #ZH                                       S01498
     C***********WWSPTA    READESDLBCSLA                 01               S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***********          ELSE                                           S01498
     C*
     C** Report for ALL branches requested
     C** or report entity is blank                                        S01498
     C*                                                                   S01498
     C************LOVAL    SETLLSDLBCSLA                 01               S01498
     C***********          READ SDLBCSLA                 01               S01498
     C*                                                                   S01498
     C           @RENT     IFEQ 'ALL'                                     S01498
     C           @RENT     OREQ *BLANKS                                   S01498
     C           *LOVAL    SETLLLBLBCSJA                 01               S01498
     C                     READ LBLBCSJA                 01               S01498
     C*                                                                   S01498
     C**  If a specific entity is requested, use it as key                S01498
     C                     ELSE                                           S01498
     C           WBRCA     SETLLLBLBCSJA                                  S01498
     C           WBRCA     READELBLBCSJA                 01               S01498
     C                     END                                            S01498
     C*
     C                     Z-ADD0         WWCUPR
     C*
     C           *IN01     IFEQ '0'
     C                     MOVE BBBRCD    WWSPTA
     C                     MOVE BBBRCD    WLBRCA  3                       S01498
     C                     MOVE BBACOC    WWACOC
     C*
     C           *IN01     DOWEQ'0'
     C*
     C           BBACOC    IFEQ WWACOC
     C           BBBRCD    ANDEQWWSPTA
     C                     ELSE
     C*
     C**   Print header and no details for PREVIOUS branch/account officer
     C**   if required.
     C                     EXSR #ZJ
     C                     MOVE BBBRCD    WWSPTA
     C                     MOVE BBBRCD    WLBRCA                          S01498
     C                     MOVE BBACOC    WWACOC
     C                     END
     C*
     C**   Print details for this customer, just read
     C                     EXSR #ZI
     C***********          READ SDLBCSLA                 01               S01498
     C                     READ LBLBCSJA                 01               S01498
     C*                                                                   S01498
     C**  Check if branch is the same as the branch selected              S01498
     C*                                                                   S01498
     C           @RENT     IFNE 'ALL'                                     S01498
     C           @RENT     ANDNE*BLANKS                                   S01498
     C           WBRCA     ANDNEBBBRCD                                    S01498
     C                     MOVE '1'       *IN01                           S01498
     C                     END                                            S01498
     C*
     C                     END
     C*
     C**   Print header and no details for LAST branch/account officer
     C**   if required.
     C                     EXSR #ZJ
     C*
     C                     ELSE
     C*
     C** Write no details to report for ANY branches
     C                     MOVE '0'       *IN21
     C                     MOVE '0'       *IN22
     C                     MOVE '0'       *IN29
     C                     MOVE *BLANKS   RRSPTA
     C                     MOVE *BLANKS   RRACOC
     C                     MOVE *BLANKS   RRACON
     C*
     C*******              WRITEHEADING
     C*******              WRITENODETLS
     C*
     C                     END
     C*
     C***********          END                                            S01498
     C*
     C           #BA0      ENDSR                           **  #BA0     **
     C/EJECT
     C********************************************************************S01498
     C*                                                                   S01498
     C**  Subroutine #BC was removed as selection by account officer      S01498
     C**  has been removed                                                S01498
     C*                                                                   S01498
     C********************************************************************S01498
     C********************************************************************S01498
     C***#BC*******-*Account*Officer*Report*******************************S01498
     C********************************************************************S01498
     C***CALLS*****-*#ZJ,*#ZH*********************************************S01498
     C********************************************************************S01498
     C***CALLED*BY*-*MAINLINE*********************************************S01498
     C********************************************************************S01498
     C********************************************************************S01498
     C***********#BC       BEGSR                           **  #BC      **S01498
     C***********                                                         S01498
     C***This*S/R*produces*a*report*for*Account*Officer*WWACOC************S01498
     C***and*Branch*WWBRCD************************************************S01498
     C***********                                                         S01498
     C***********          Z-ADD0         WWCUPR  50                      S01498
     C***********                                                         S01498
     C***********WWACOC    SETLLSDLBCSLB                 03               S01498
     C***********WWACOC    READESDLBCSLB                 03               S01498
     C************IN03     DOWEQ'0'                                       S01498
     C***********          EXSR #ZH                                       S01498
     C***********WWACOC    READESDLBCSLB                 03               S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***Retrieve*account*officer*name*or*report*no*details***************S01498
     C***********                                                         S01498
     C***********          EXSR #ZJ                                       S01498
     C***********                                                         S01498
     C***********#BCO      ENDSR                                          S01498
     C/EJECT                                                              S01498
     C********************************************************************S01498
     C**                                                                 *S01498
     C** #BRPR     - Subroutine to process a change in branch            *S01498
     C**                                                                 *S01498
     C** CALLS     - none                                                *S01498
     C**                                                                 *S01498
     C** CALLED BY - #ZE, #ZGA, #ZGBC, #ZGBD                             *S01498
     C**                                                                 *S01498
     C********************************************************************S01498
     C           #BRPR     BEGSR                           **  #BRPR    **S01498
     C*                                                                   S01498
     C**  If printer file is open and entity is not blank, print footer   S01498
     C*                                                                   S01498
     C           WLOPN     IFEQ 'Y'                                       S01498
     C           @RENT     ANDNE*BLANKS                                   S01498
     C*                                                                   S01498
     C**  Output "End of Report"                                          S01498
     C                     WRITEENDOFR                                    S01498
     C                     CLOSELB0360P1                                  S01498
     C                     MOVE *BLANK    WLOPN   1                       S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C**  Open printer file LB0360P1 if entity is not blank               S01498
     C**  or the printer file is not yet open                             S01498
     C*                                                                   S01498
     C           @RENT     IFNE *BLANKS                                   S01498
     C           WLOPN     ORNE 'Y'                                       S01498
     C                     OPEN LB0360P1                                  S01498
     C                     MOVE 'Y'       WLOPN                           S01498
     C*                                                                   S01498
     C** Ensure Report Spool File recorded by RCF                         S01498
     C*                                                                   S01498
     C           @RENT     IFNE *BLANKS                                   S01498
     C                     MOVE WLBRCA    SENTY                           S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUM     ZSNUM1  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           @RSEQ                           S01498
     C                     PARM           SENTY   3                       S01498
     C                     PARM           SFILE                           S01498
     C                     PARM           ZSNUM1                          S01498
     C                     PARM           ZSERR   1                       S01498
     C*                                                                   S01498
     C** If an error occurred during ZSFILE processing,                   S01498
     C** return to the calling program.                                   S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     EXSR *PSSR                                     S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C**  Reset page and line numbers and initialise fields               S01498
     C*                                                                   S01498
     C                     Z-ADD*ZEROS    PAGE                            S01498
     C                     Z-ADD*ZEROS    LINE                            S01498
     C                     MOVE WLBRCA    RRBRCA                          S01498
     C*                                                                   S01498
     C**  Get branch name using access object                             S01498
     C*                                                                   S01498
     C**********           CALL 'AOBRCHR0'                                S01498              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM RRBRCA    P@BRCA  3                       S01498
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01498              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE 'SDBRCHPD'DBFILE           ***************S01498
     C                     Z-ADD50        DBASE            * DBERROR 050 *S01498
     C                     MOVE *BLANKS   DBKEY            ***************S01498
     C                     MOVELRRBRCA    DBKEY                           S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     MOVE A8BRNM    RRBRNM                          S01498
     C*                                                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           #BRPRO    ENDSR                                          S01498
     C/EJECT
     F*****************************************************************   SA9101
     F*                                                               *   SA9101
     F*       SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *   SA9101
     F*       PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *   SA9101
     F*       THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *   SA9101
     F*       SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *   SA9101
     F*       IF '@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *   SA9101
     F*       '@@VDT'  IN 'YYYYMMDD' FORMAT.                          *   SA9101
     F*                                                               *   SA9101
     F* NOTE: FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS              *   SA9101
     F*                                                               *   SA9101
     F*       1) @@DAYN   LENGTH 5,0.                                 *   SA9101
     F*                                                               *   SA9101
     F*       FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *   SA9101
     F*                                                               *   SA9101
     F*       1) @@VDT    LENGTH 8,0 DEFINED BY A DS.                 *   SA9101
     F*       2) @@RTN    LENGTH 1,0.                                 *   SA9101
     F*       3) @@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *   SA9101
     F*       4) @@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *   SA9101
     F*       5) @@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *   SA9101
     F*       6) @@RDAY   LENGTH 5,0.                                 *   SA9101
     F*       7) @@LEAP   LENGTH 1,0.                                 *   SA9101
     F*                                                               *   SA9101
     F*       INDICATORS USED ARE:                                    *   SA9101
     F*                                                               *   SA9101
     F*       1) 80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *   SA9101
     F*       2) 81       CHECK FOR LOW ON ARRAY @MD.                 *   SA9101
     F*                                                               *   SA9101
     F* INPUT FIELD:       @@DAYN                                     *   SA9101
     F*                                                               *   SA9101
     F* OUTPUT FIELD:      @@VDT                                      *   SA9101
     F*                                                               *   SA9101
     F* WORK FIELDS:       @@RTN                                      *   SA9101
     F*                    @@Z71Y                                     *   SA9101
     F*                    @@RDAY                                     *   SA9101
     F*                    @@LEAP                                     *   SA9101
     F*                    @@I                                        *   SA9101
     F*                    @@J                                        *   SA9101
     F*                                                               *   SA9101
     F* ARRAYS USED:       @YD COMPILE TIME ARRAY.                    *   SA9101
     F*                    @MD COMPILE TIME ARRAY.                    *   SA9101
     F*                                                               *   SA9101
     F*****************************************************************   SA9101
     C*                                                                   SA9101
     C           ZA0710    BEGSR                                          SA9101
     C*                                                                   SA9101
     C                     SETOF                     8081                 SA9101
     C                     Z-ADD0         @@RTN   10                      SA9101
     C                     Z-ADD0         @@VDT                           SA9101
     C                     Z-ADD1         @@I     20                      SA9101
     C                     Z-ADD1         @@J     20                      SA9101
     C                     Z-ADD1         @@LEAP  10                      SA9101
     C*                                                                   SA9101
     C           @@DAYN    IFLT 1                                         SA9101
     C                     Z-ADD1         @@RTN                           SA9101
     C                     GOTO ZA0719                                    SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C* DIVISION TO DETERMINE WETHER LEAP YEAR.                           SA9101
     C*                                                                   SA9101
     C           @@DAYN    DIV  1461      @@Z71Y                          SA9101
     C                     MVR            @@RDAY  50                      SA9101
     C*                                                                   SA9101
     C* CALCULATING YEAR.                                                 SA9101
     C*                                                                   SA9101
     C           @@Z71Y    MULT 4         @@Z71Y                          SA9101
     C                     ADD  1972      @@Z71Y                          SA9101
     C*                                                                   SA9101
     C* CHECKING IF YEAR IS GREATER THAN OR EQUAL TO 2100                 SA9101
     C*                                                                   SA9101
     C           @@Z71Y    IFGE 2100                                      SA9101
     C                     ADD  @@SSY2    @@RDAY                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C* LOKUP ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE        SA9101
     C* HAVE PASSED.                                                      SA9101
     C*                                                                   SA9101
     C           @@RDAY    LOKUP@YD,@@I                8080               SA9101
     C*                                                                   SA9101
     C* IF YEAR IS A LEAP YEAR SSLEAP IS SET TO ZERO.                     SA9101
     C*                                                                   SA9101
     C           *IN80     IFEQ '0'                                       SA9101
     C                     Z-ADD0         @@LEAP                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C* ADD INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.       SA9101
     C*                                                                   SA9101
     C           @@LEAP    IFEQ 1                                         SA9101
     C           @@RDAY    SUB  @YD,@@I   @@RDAY                          SA9101
     C                     ADD  @@I       @@Z71Y                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C* PROCESSING FOR A LEAP YEAR.                                       SA9101
     C*                                                                   SA9101
     C           @@LEAP    IFEQ 0                                         SA9101
     C*                                                                   SA9101
     C* IF '@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.                   SA9101
     C*                                                                   SA9101
     C           @@RDAY    IFEQ 60                                        SA9101
     C                     Z-ADD29        @@Z71D                          SA9101
     C                     Z-ADD2         @@Z71M                          SA9101
     C                     GOTO ZA0711                                    SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C* IF '@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN    SA9101
     C* PROCEED AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP     SA9101
     C* YEAR. NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.          SA9101
     C*                                                                   SA9101
     C           @@RDAY    IFGT 60                                        SA9101
     C           @@RDAY    SUB  1         @@RDAY                          SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C* IF DAY '@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS      SA9101
     C* IN 4 YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR      SA9101
     C* GROUP.                                                            SA9101
     C*                                                                   SA9101
     C           @@RDAY    IFEQ 0                                         SA9101
     C                     Z-ADD31        @@Z71D                          SA9101
     C                     Z-ADD12        @@Z71M                          SA9101
     C                     SUB  1         @@Z71Y                          SA9101
     C                     GOTO ZA0711                                    SA9101
     C                     END                                            SA9101
     C*                                                                   SA9101
     C* LOOK UP ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'         SA9101
     C* OCCURS IN                                                         SA9101
     C*                                                                   SA9101
     C           @@RDAY    LOKUP@MD,@@J                81                 SA9101
     C                     Z-ADD@@J       @@Z71M                          SA9101
     C           @@RDAY    SUB  @MD,@@J   @@Z71D                          SA9101
     C*                                                                   SA9101
     C* DS @@VDT  IS RETURNED IN YYYYMMDD FORMAT                          SA9101
     C*                                                                   SA9101
     C           ZA0711    TAG                                            SA9101
     C*                                                                   SA9101
     C                     MOVE @@Z71Y    @@YR                            SA9101
     C*                                                                   SA9101
     C           ZA0719    ENDSR                                          SA9101
     C*****************************************************************   SA9101
     C/EJECT                                                              SA9101
     C********************************************************************
     C**                                                                 *
     C** #ZA      - Database error handling routine.                     *
     C**                                                                 *
     C** CALLS     -  NONE                                               *
     C**                                                                 *
     C** CALLED BY - #BC, #BCA, #BB, #A                                  *
     C**                                                                 *
     C********************************************************************
     C           #ZA       BEGSR                           **  #ZA      **
     C*
     C** WRITE DATA BASE ERROR DETAILS
     C                     WRITERUNHDR
     C                     WRITERUNDBER
     C*                                                                   S01498
     C**  If printer file P1 is open, report the fact that a database     S01498
     C**  error has occurred                                              S01498
     C           WLOPN     IFEQ 'Y'                                       S01498
     C                     WRITEDBERROR                                   S01498
     C                     END                                            S01498
     C*
     C** WRITE END OF REPORT
     C***********          WRITERUNEOFR                                   S01498
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     EXSR *PSSR                                     S01498
     C                     RETRN
     C*
     C           #ZA0      ENDSR                           **  #ZA0     **
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C* *PSSR    - Program error handling routine.                       *
     C*                                                                  *
     C* CALLS             -  NONE                                        *
     C*                                                                  *
     C* CALLED BY         -  NONE                                        *
     C*                                                                  *
     C********************************************************************
     C           *PSSR     BEGSR                           **  *PSSR    **
     C*
     C                     DUMP
     C*
     C           #PSSR0    ENDSR                           **  *PSSR0   **
     C********************************************************************
** CPY@
(c) Finastra International Limited 2001
** Array of powers of 10 for currency conversion S/R SCONV
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ZFMD  -  NUMBER OF DAYS IN THE MONTH
312831303130313130313031
** @YD  USED BY SR. ZA0710 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZA0710 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
