     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Commitment Limit exceeded by amount')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                         *
     F*                                                               *
     F*  LB0370 -Total Commitment Exceeded by Amount                  *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Prev Amend No. CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 S01498             Date 11Aug94               *
      *                 B5869              Date 23Apr91               *
     F*                 R5672              DATE 13MAR91               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*  S01498 - Portfolio Lending Upgrade to Release 10             *
     F*  B5869  - SHOW ALL CHILDREN BELONGING TO THIS GROUP EVEN IF   *
     F*           NOT FROM SAME ACCOUNT OFFICER.                      *
     F*  R5672  - FOR PARENT ONLY PRINT EXCESS IF REALLY EXCEEDED     *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F** C R E A T I O N     P A R A M E T E R S                      *
     F**                                                              *
     F**                                                              *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**
     F**      FILE DEFINITIONS
     F**     ------------------
     F*
     F**   RUN CONTROLS REPORT
1    F***LB0370AUO***E             21     PRINTER      KINFDS ERF2DS      S01498
     FLB0370AUO   E             21     PRINTER      KINFDS SPOOLU         S01498
     F*
     F**   TOT. COMMITMENT LINES EXCEEDED BY AMOUNT REPORT
2    F***LB0370P1O***E             22     PRINTER      KINFDS ERF1DS      S01498
     FLB0370P1O   E             22     PRINTER      KINFDS SPOOL      UC  S01498
     F*
     F*****BANK*DETAILS*FILE.*PREFIX*BJ.*******************************   S01498
3    F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F*****PORTFOLIO*LENDING*ICD*FILE.*PREFIX*LB.**********************   S01498
4    F***SDLOMBPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F***CURRENCY*CODES*FILE.*PREFIX*A6.*******************************   S01498
5    F***SDCURRL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   TRAILER FILE. PREFIX TR.
6    FLBTRAIPDIF  E           K        DISK         KINFSR *PSSR
     F*
     F*****ACCOUNT*OFFICERS*FILE.*PREFIX*AZ.***************************   S01498
7    F***SDACOFL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**  PORTFOLIO EXTRACT SUMMARY FILE - PREFIX ES
8    FLBEXTSL1IF  E           K        DISK         KINFSR *PSSR
     F*
     F**   CLIENT MASTER FILE. JOIN LF - PREFIX BB , CU
9    F***SDLBCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ0IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   CLIENT MASTER FILE. JOIN LF - PREFIX BB , CU
10   F***SDLBCSL2IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ2IF  E           K        DISK         KINFSR *PSSR          S01498
     F            SDLBCSJ0                          KRENAMESDLBCSJ2
     F*                                                                   B5869
     F**   CLIENT MASTER FILE.(DIFFERENT LOCICAL VIEW) PREFIX - BB & CU   B5869
     F***SDLBCSL6IF**E           K        DISK         KINFSR *PSSR B5869 S01498
     FLBLBCSJ6IF  E           K        DISK         KINFSR *PSSR          S01498
     F            SDLBCSJ0                          KRENAMESDLBCSN3       B5869
     F*
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**                                                              *
     F** ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F**                 ------------------------                     *
     F**                                                              *
     F**    21         - OVERFLOW INDICATOR ON LB0370AU               *
     F**    22         - OVERFLOW INDICATOR ON LB0370P1               *
     F*********23******-*ACCESS*TO*BANK*DETAILS*FILE*-*SDBANKPD********   S01498
     F*********24******-*ACCESS*TO*LB*CREDIT*ICD*FILE*-*SDLOMBPD*******   S01498
     F*********25******-*ACCESS*TO*CURRENCY*FILE*-*SDCURRL1************   S01498
     F**       26      - ACCESS TO TRAILER FILE - LBTRAIPD            *
     F*********27******-*ACCESS*TO*ACCOUNT*OFFICERS*FILE*-*SDACOFL0****   S01498
     F**       28      - ACCESS TO LOMBSRD EXTRACT SUMMARY - LBEXTSL1 *
     F*********29******-*ACCESS*TO*CUSTOMER*FILE*-*SDLBCSL0************   S01498
     F*********30******-*ACCESS*TO*CUSTOMER*FILE*-*SDLBCSL2************   S01498
     F*********31******-*READE*ON*CUSTOMER*FILE*-*SDLBCSL2*************   S01498
     F**       29      - ACCESS TO CUSTOMER FILE - LBLBCSJ0           *   S01498
     F**       30      - ACCESS TO CUSTOMER FILE - LBLBCSJ2           *   S01498
     F**       31      - READE ON CUSTOMER FILE - LBLBCSJ2            *   S01498
     F**       41      - AT LEAST ONE CHILD HAS EXCEEDED PERCENTAGE   *
     F**       42      - HEADINGS ALREADY PRINTED FOR BRANCH & AC.OFF.*
     F**       43      - AT LEAST ONE DETAIL LINE PRINTED             *
     F**       50      - CONDITION OUTPUT ON REPORT                   *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     E*****************************************************************
     E*
     E**   ARRAY FOR COPYRIGHT
     E*
     E                    CPY@    1   1 80
     E*****************************************************************
     E/EJECT
     E*****************************************************************
     E/COPY ZSRSRC,ZSEDITZ1
     E*****************************************************************
     E*                                                                   B5869
     E** ARRAY FOR PARENT CUSTOMER NUMBERS                                B5869
     E                    PCNA      300  6                                B5869
     E/EJECT
     I*****************************************************************
     I*
     I**   RENAME FIELDS ON SDLBCSL0
     ISDLBCSJ0
     I              BBCUST                          C0CUST
     I              BBPCNB                          C0PCNB
     I              BBCRNM                          C0CRNM
     I*****************************************************************
     I/EJECT
     I*****************************************************************
     I*
     I**   DATA STRUCTURE FOR COMPILATION - COPYRIGHT INSERTION
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*****************************************************************
     I/EJECT
     I*****************************************************************
     I/COPY ZSRSRC,ZSEDITZ2
     I*****************************************************************
     I*                                                                   S01498
     I@RPARM      DS                            100                       S01498
     I**  Report parameters                                               S01498
     I                                        1  130WWINP2                S01498
     I*
     I**   PROGRAM STATUS DATA STRUCTURE
     IPSDS       SDS
     I                                      244 253 JOB
     I                                      254 263 USER
     I*
     I**   FILE INFORMATION DATA STRUCTURE
     I***ERF1DS******DS                                                   S01498
     ISPOOL       DS                                                      S01498
     I                                       83  92 SFILE                 S01498
     I                                    B 123 1240SFNUM                 S01498
     I*
     I**   FOR OVERFLOW
     I                                    B 367 3680LINE
     I*
     I***ERF2DS      DS                                                   S01498
     ISPOOLU      DS                                                      S01498
     I                                       83  92 SFILEU                S01498
     I                                    B 123 1240SFNUMU                S01498
     I*
     I**   FOR OVERFLOW
     I                                    B 367 3680LINE1
     I*
     I**   MULTIPLE OCCUR DATA STRUCTURE TO STORE DETAILS FOR CHILDREN
     IR02DS       DS                         99
     I                                        1   6 D2CUST
     I                                        7  26 D2CRNM
     I                                    P  27  330D2CMTL
     I                                    P  34  410D2EXPS
     I                                    P  42  490D2AMTE
     I                                       50  50 D2EXTA
     I*
     I**   LOCAL DATA AREA
     I***LDA        UDS                            256                    S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*                                                                   S01498
     IRUNDAT    E DS                                                      S01498
     I**  Standard Data Area Layout for System flags and Run Date         S01498
     I*                                                                   S01498
     ISDBANK    E DSSDBANKPD                                              S01498
     I**  Data structure for bank details                                 S01498
     I*                                                                   S01498
     ISDBRCH    E DSSDBRCHPD                                              S01498
     I**  Data structure for branch details                               S01498
     I*                                                                   S01498
     ISDLMB     E DSSDLOMBPD                                              S01498
     I**  Data structure for Portfolio Lending ICD                        S01498
     I*                                                                   S01498
     ISDCURR    E DSSDCURRPD                                              S01498
     I**  Data structure for currency details                             S01498
     I*                                                                   S01498
     ISDACOF    E DSSDACOFPD                                              S01498
     I**  Data structure for account officer details                      S01498
     I*                                                                   S01498
     IDSFDY     E DSDSFDY                                                 S01498
     I**  Short data structure for access objects                         S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I**  Long data structure for access programs                         S01498
     I*                                                                   S01498
     C*****************************************************************
     C*
     C**   PARAMETERS INPUT TO PROGRAM
     C**   ---------------------------
     C*
     C**   WWINP1  -  0 = END OF DAY
     C**           -  1 = INPUT CYCLE
     C*
     C**   WWINP2  -  CONTAINS SELECTION AMOUNT IF CALLED
     C**              FROM INPUT CYCLE
     C*
     C           *ENTRY    PLIST
     C                     PARM           WWINP1  1
     C***********          PARM           WWINP2 130                      S01498
     C                     PARM           @RSEQ   5                       S01498
     C                     PARM           @RLEV   1                       S01498
     C                     PARM           @RENT   3                       S01498
     C                     PARM           @RPARM                          S01498
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*
     C**   KEYS USED BY PROGRAM
     C**   --------------------
     C*
     C**   CUSTOMER MASTER FILE
     C*
     C           WWCMFK    KLIST
     C                     KFLD           BBBRCD
     C                     KFLD           BBACOC
     C                     KFLD           BBPCNB
     C*                                                                   B5869
     C           CUSKY6    KLIST                                          B5869
     C                     KFLD           BBPCNB                          B5869
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*
     C**              START MAINLINE
     C**             ----------------
     C*
     C**   INITIAL PROCESSING
     C*
     C                     EXSR #A
     C*
     C**   MAIN PROCESSING
     C*
     C                     EXSR #B
     C*
     C**   TERMINATION PROCESSING
     C*
     C                     EXSR #C
     C*
     C**   END PROGRAM
     C*
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    INDEX TO SUBROUTINES                                      *
     C**   ----------------------                                     *
     C**                                                              *
     C**   ZSEDIT  - CONVERT AMOUNT FOR OUTPUT                        *
     C**                                                              *
     C**   #A      - INITIAL PROCESSING                               *
     C**   #B      - MAIN PROCESSING                                  *
     C**   #BA     - PROCESS ACCOUNT OFFICERS                         *
     C**   #BAA    - PROCESS PARENT AND ASSOCIATED CHILDREN           *
     C**   #C      - TERMINATION PROCESSING                           *
     C**   #YA     - WRITE HEADING FORMAT                             *
     C**   #ZA     - PROCESS DATABASE ERRORS                          *
     C**   #ZB     - CALCULATE EXPOSURE                               *
     C**                                                              *
     C**   *PSSR   - PROGRAM ERROR HANDLING ROUTINE                   *
     C**                                                              *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZSEDITZ3
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #A        - INITIAL PROCESSING                             *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #A        BEGSR
     C*                                                                   S01498
     C**  Copyright statement                                             S01498
     C*                                                                   S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*                                                                   S01498
     C**  Read in DTAARA/RUNDAT to get multibranching indicator           S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           RUNDAT                          S01498
     C                     IN   RUNDAT                                    S01498
     C*                                                                   S01498
     C           AGMBIN    IFEQ 'Y'                                       S01498
     C                     MOVE '1'       *IN39                           S01498
     C                     ELSE                                           S01498
     C*                                                                   S01498
     C**  Else, setup appropriate level and entity                        S01498
     C                     MOVE 'S'       @RLEV                           S01498
     C                     MOVE *BLANKS   @RENT                           S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           LDA                             S01498
     C           *LOCK     IN   LDA                                       S01498
     C*
     C**   INITIALISE DB ERROR FIELDS AND STORE PROGRAM NAME FOR
     C**   DB ERROR FIELD.
     C*
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'LB0370'  DBPGM
     C                     OUT  LDA                                       S01498
     C*
     C**   DEFINE WORK FIELDS
     C*
     C           *LIKE     DEFN LBAMTE    WWSELA
     C           *LIKE     DEFN BBACOC    WWACOC
     C           *LIKE     DEFN BBBRCD    WWBRCD
     C           *LIKE     DEFN ESCMTL    WWCMTL
     C           *LIKE     DEFN ESCNUM    WWCNUM
     C           *LIKE     DEFN LBAMTE    WWAMTE
     C*
     C**   INITIALISE WORK FIELDS
     C*
     C                     Z-ADD*ZEROS    WWSELA
     C                     MOVE *BLANKS   WWACOC
     C                     MOVE *BLANKS   WWBRCD
     C                     Z-ADD*ZEROS    WWCMTL
     C**********           Z-ADD*ZEROS    WWCNUM                                              CSD027
     C                     MOVE *BLANKS   WWCNUM                                              CSD027
     C                     Z-ADD*ZEROS    WWAMTE
     C                     Z-ADD*ZEROS    RRNRIP
     C*
     C                     Z-ADD*ZEROS    WWEXPS 150
     C                     Z-ADD*ZEROS    WWTEMP 150
     C                     Z-ADD*ZEROS    WWCT1   20
     C                     Z-ADD*ZEROS    WWNOC   20
     C*                                                                   S01498
     C**  Initialise line counters and page numbers                       S01498
     C*                                                                   S01498
     C                     Z-ADD*ZEROS    LINE                            S01498
     C                     Z-ADD*ZEROS    LINE1                           S01498
     C                     Z-ADD*ZEROS    PAGE                            S01498
     C                     Z-ADD*ZEROS    PAGE1                           S01498
     C*
     C**   SET OFF ALL INDICATORS
     C*
     C                     MOVEA'00000000'*IN,21           OFF 21-28
     C                     MOVEA'000'     *IN,29           OFF 29-31
     C                     MOVEA'000'     *IN,41           OFF 41-43
     C                     MOVE '0'       *IN50            OFF 50
     C                     MOVE '0'       *IN98            OFF 98
     C                     Z-ADD1         W       30                      B5869
     C*
     C*****ACCESS*ICD*RECORD*1*TO*GET*RUN*DATE*&*TITLE*****************   S01498
     C***********                                                         S01498
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 23               S01498
     C***********                                                         S01498
     C*****IF*RECORD*NOT*FOUND*OR*LAST-CHANGE-TYPE*=*'D'*(DELETED)*****   S01498
     C***********                                                         S01498
B1   C************IN23     IFEQ '1'                                       S01498
     C***********BJTYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C**  Get title and date using access object                          S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM *BLANKS   P@RTCD  7                       S01498
     C                     PARM '*FIRST'  P@OPTN  7                       S01498
     C           SDBANK    PARM SDBANK    DSFDY                           S01498
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD1         DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'SDBANKPD'DBFILE           * DBERROR  001 S01498
     C                     MOVE 'SDBANKPD'DBFILE           * DBERROR 001 *S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     OUT  LDA                        ***************S01498
     C                     EXSR #ZA                        ****************
E1   C                     END
     C*
     C**   ACCESS PORTFOLIO LENDING ICD TO GET CURRENCY AND IF CALLED
     C**   FROM END OF DAY TO GET SELECTION AMOUNT
     C*
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 24               S01498
     C***********                                                         S01498
     C*****IF*RECORD*NOT*FOUND*OR*RECORD-ID*=*'*'*(DELETED)************   S01498
     C***********                                                         S01498
B1   C************IN24     IFEQ '1'                                       S01498
     C***********LBRECI    OREQ '*'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST'  P@OPTN                          S01498
     C           SDLMB     PARM SDLMB     DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD2         DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR  002 S01498
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 002 *S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     OUT  LDA                        ***************S01498
     C                     EXSR #ZA                        ****************
E1   C                     END
     C*
     C***********          MOVE LBCCY     RRCCY                           S01498
     C                     MOVE LBCYCD    RRCCY                           S01498
     C*
     C**   IF CALLED FROM END-OF-DAY
     C*
B1   C           WWINP1    IFEQ '0'
     C*
     C**   SET SELECTION-PERCENTAGE TO COMMITMENT/EXPOSURE %
     C*
     C                     Z-ADDLBAMTE    WWSELA
     C*
     C**   ELSE IF INPUT CYCLE USE INPUT PARAMETER
     C*
X1   C                     ELSE
     C*
     C                     Z-ADDWWINP2    WWSELA
     C*
E1   C                     END
     C*
     C                     Z-ADDWWSELA    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRAMT1
     C*
     C**   ACCESS CCY CODES FILE TO GET SPOT RATE & NO. OF DEC. PLACES
     C**   FOR PORTFOLIO LENDING CURRENCY
     C*
     C***********LBCCY     CHAINSDCURRL1             25                   S01498
     C*
B1   C************IN25     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM LBCYCD    P@CCY   3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C** Check if error occurred                                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR  003 S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 003 *S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C***********          MOVELLBCCY     DBKEY            ***************S01498
     C                     MOVELLBCYCD    DBKEY            ***************S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
E1   C                     END
     C*
     C**   SET OUTPUT CCY VALUES FOR CONVERSION SUBROUTINE 'SCONV'
     C*
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C*
     C** Ensure Audit Spool File recorded by RCF                          S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUMU    ZSNUM2  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           @RSEQ                           S01498
     C                     PARM *BLANK    SENTY                           S01498
     C                     PARM           SFILEU                          S01498
     C                     PARM           ZSNUM2                          S01498
     C                     PARM           ZSERR                           S01498
     C*                                                                   S01498
     C** If an error occurred during ZSFILE processing,                   S01498
     C** return to the calling program.                                   S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     EXSR *PSSR                                     S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*
     C           #A0       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #B        - MAIN PROCESSING                                *
     C**                                                              *
     C**   CALLS     - #BA , #YA                                      *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #B        BEGSR
     C*
     C*****READ*FIRST*LIVE*RECORD*ON*'SDLBCSL2'************************   S01498
     C*
     C************LOVAL    SETLLSDLBCSL2                                  S01498
     C***********          READ SDLBCSL2                 30               S01498
     C*                                                                   S01498
     C**   Read first live record on 'LBLBCSJ2' if entity is 'ALL'        S01498
     C*                                                                   S01498
     C           @RENT     IFEQ 'ALL'                                     S01498
     C           @RENT     OREQ *BLANKS                                   S01498
     C           *LOVAL    SETLLLBLBCSJ2                                  S01498
     C                     READ LBLBCSJ2                 30               S01498
     C                     ELSE                                           S01498
     C*                                                                   S01498
     C**  Else, use the selected branch (entity) as key                   S01498
     C*                                                                   S01498
     C           @RENT     SETLLLBLBCSJ2                                  S01498
     C           @RENT     READELBLBCSJ2                 30               S01498
     C                     END                                            S01498
     C*
     C**   DO WHILE NOT EOF
     C*
B1   C           *IN30     DOWEQ'0'
     C*
     C**   OUTPUT HEADER & RESET RECORDS SELECTED INDICATOR
     C*
     C                     EXSR #YA
     C                     MOVE '0'       *IN42
     C*
     C**   DO WHILE BRANCH CODE & ACCOUNT OFFICER HAVE NOT CHANGED
     C**   AND NOT EOF
     C*
B2   C           BBACOC    DOWEQWWACOC
     C           BBBRCD    ANDEQWWBRCD
     C           *IN30     ANDEQ'0'
     C*
     C**   PROCESS ACCOUNT OFFICER
     C*
     C                     EXSR #BA
     C*
     C*****READ*NEXT*LIVE*RECORD*ON*'SDLBCSL2'*************************   S01498
     C***********                                                         S01498
     C***********          READ SDLBCSL2                 30               S01498
     C*                                                                   S01498
     C**   Read next live record on 'LBLBCSJ2'                            S01498
     C*                                                                   S01498
     C                     READ LBLBCSJ2                 30               S01498
     C*                                                                   S01498
     C**  Stop processing if branch is not equal to branch selected       S01498
     C*                                                                   S01498
     C           @RENT     IFNE 'ALL'                                     S01498
     C           @RENT     ANDNE*BLANKS                                   S01498
     C           @RENT     ANDNEBBBRCD                                    S01498
     C                     MOVE '1'       *IN30                           S01498
     C                     END                                            S01498
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C           #B0       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BA       - PROCESS ACCOUNT OFFICERS                       *
     C**                                                              *
     C**   CALLS     - #BAA , #YA , #ZB                               *
     C**                                                              *
     C**   CALLED BY - #B                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BA       BEGSR
     C*
     C**   IF CUSTOMER HAS A PARENT
     C*
B1   C           BBPCNB    IFNE *BLANKS
     C*
     C**   PROCESS PARENT AND ASSOCIATED CHILDREN
     C*
     C           BBPCNB    LOKUPPCNA                     37               B5869
     C*                    EXSR #BAA                                      B5869
     C  N37                EXSR #BAA                                      B5869
     C***********          READ SDLBCSL2                 30         B5869 S01498
     C                     READ LBLBCSJ2                 30               S01498
     C*
     C**   CUSTOMER DOES NOT HAVE A PARENT
     C*
X1   C                     ELSE
     C*
     C**   CUSTOMER MUST NOT BE A PARENT
     C*
B2   C           BBPAIN    IFNE 'P'
     C*
     C**   CALCULATE EXPOSURE & DIFFERENCE
     C*
     C                     EXSR #ZB
     C*
     C**   IF DIFFERENCE BETWEEN THE COMMITMENT AMOUNT AND THE
     C**      EXPOSURE AMOUNT EXCEEDS THE SELECTION AMOUNT
     C**      AND IS POSITIVE AND RECORDS FOUND ON LBEXTSL1
     C*
B3   C           WWAMTE    IFGE WWSELA
     C           WWAMTE    ANDGE*ZEROS
     C           *IN28     ANDEQ'0'
     C*
     C**   CHECK FOR OVERFLOW
     C*
B4   C           LINE      IFGT 56
     C                     EXSR #YA
     C*                                                                   S01498
     C**  Process a change in branch                                      S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHEADER1
     C                     MOVE '1'       *IN42
E4   C                     END
     C*
     C**   OUTPUT ORPHAN DETAIL LINE
     C*
     C                     MOVE *BLANKS   RRPCNB
     C                     MOVE BBCUST    RRCUST
     C                     MOVE BBCRNM    RRCRNM
     C*
     C**   CONVERT COMMITMENT LINE AMOUNT FOR OUTPUT
     C*
     C                     Z-ADDESCMTL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRCMTL
     C*
     C**   CONVERT EXPOSURE AMOUNT FOR OUTPUT
     C*
     C                     Z-ADDWWEXPS    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RREXPS
     C*
     C**   CONVERT SELECTION AMOUNT FOR OUTPUT
     C*
     C                     Z-SUBWWAMTE    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRAMT2
     C*
     C                     MOVE '1'       *IN50            ON 50
B4   C           *IN42     IFEQ '0'
     C*                                                                   S01498
     C**  Process a change in branch                                      S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHEADER1
     C                     MOVE '1'       *IN42
E4   C                     END
     C                     WRITEDETAIL1
     C                     MOVE '1'       *IN43
     C*
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C           #BA0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BAA      - PROCESS PARENT AND ASSOCIATED CHILDREN         *
     C**                                                              *
     C**   CALLS     - #YA , #ZA , #ZB                                *
     C**                                                              *
     C**   CALLED BY - #BA                                            *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BAA      BEGSR
     C*
     C**   INITIALIZE COUNTS ETC
     C*
     C                     Z-ADD*ZEROS    WWNOC
     C                     MOVE '0'       *IN31            OFF 31
     C                     MOVE '0'       *IN41            OFF 41
     C                     MOVEABBPCNB    PCNA,W                          B5869
     C                     ADD  1         W                               B5869
     C***********CUSKY6    SETLLSDLBCSL6                            B5869 S01498
     C           CUSKY6    SETLLLBLBCSJ6                                  S01498
     C*
     C**   DOWHILE RECORDS EXIST FOR THIS PARENT
     C*
B1   C           *IN31     DOWEQ'0'
     C*
     C**   CALCULATE EXPOSURE & DIFFERENCE
     C*
     C                     EXSR #ZB
     C*
B2   C           *IN28     IFEQ '0'
     C*
     C**   STORE DETAILS FOR THIS CHILD
     C*
     C                     ADD  1         WWNOC
     C           WWNOC     OCUR R02DS
     C                     MOVE BBCUST    D2CUST
     C                     MOVE BBCRNM    D2CRNM
     C                     Z-ADDESCMTL    D2CMTL
     C                     Z-ADDWWEXPS    D2EXPS
     C                     Z-ADDWWAMTE    D2AMTE
     C*
     C**   IF DIFFERNCE BETWEEN THE COMMITMENT AMOUNT AND THE
     C**   EXPOSURE AMOUNT EXCEEDS THE SELECTION AMOUNT
     C**   AND IS POSITIVE
     C*
B3   C           WWAMTE    IFGE WWSELA
     C           WWAMTE    ANDGE*ZEROS
     C*
     C                     MOVE '1'       *IN41
     C                     MOVE 'Y'       D2EXTA
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C**   READ NEXT RECORD FOR THIS PARENT
     C*
     C*          WWCMFK    READESDLBCSL2                 31               B5869
     C***********CUSKY6    READESDLBCSL6                 31         B5869 S01498
     C           CUSKY6    READELBLBCSJ6                 31               S01498
     C           BBCUST    IFEQ D2CUST                                    B5869
     C***********CUSKY6    READESDLBCSL6                 31         B5869 S01498
     C           CUSKY6    READELBLBCSJ6                 31               S01498
     C                     END                                            B5869
     C*
E1   C                     END
     C*
     C**   REPOSITION POINTER READY TO READ NEXT RECORD
     C*
     C***********WWCMFK    SETGTSDLBCSL2                                  S01498
     C           WWCMFK    SETGTLBLBCSJ2                                  S01498
     C*
     C**   IF ANY OF THE CHILDREN EXCEED THE AMOUNT
     C*
B1   C           *IN41     IFEQ '1'
     C*
     C**   ACCESS CLIENT MASTER FILE TO GET REPORT NAME
     C*
     C***********BBPCNB    CHAINSDLBCSL0             29                   S01498
     C           BBPCNB    CHAINLBLBCSJ0             29                   S01498
     C*
B2   C           *IN29     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'SDLBCSL0'DBFILE           * DBERROR  004 S01498
     C                     MOVE 'SDLBCSL0'DBFILE           * DBERROR 004 *S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     MOVELBBPCNB    DBKEY            ****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
E2   C                     END
     C*
     C**   ACCESS THE PORTFOLIO EXTRACT SUMMARY FILE
     C*
     C                     Z-ADD*ZEROS    WWTEMP
     C                     Z-ADD*ZEROS    WWEXPS
     C                     Z-ADD*ZEROS    WWAMTE
     C                     MOVE BBPCNB    WWCNUM
     C           WWCNUM    CHAINLBEXTSL1             28
     C*
B2   C           *IN28     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD5         DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'LBEXTSL1'DBFILE           * DBERROR  005 S01498
     C                     MOVE 'LBEXTSL1'DBFILE           * DBERROR 005 *S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     MOVELWWCNUM    DBKEY            ****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
E2   C                     END
     C*
     C                     ADD  1         RRNRIP
     C*
     C**   CALCULATE THE EXPOSURE
     C*
     C           ESOWEX    ADD  ESTPIU    WWEXPS
     C*
     C**   CALCULATE THE DIFFERENCE BETWEEN THE COMMITMENT AMOUNT
     C**   AND THE EXPOSURE AMOUNT
     C*
     C           WWEXPS    SUB  ESCMTL    WWAMTE
     C*
     C**   CHECK FOR OVERFLOW
     C*
B2   C           LINE      IFGT 56
     C                     EXSR #YA
     C*                                                                   S01498
     C**  Process a change in branch                                      S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHEADER1
     C                     MOVE '1'       *IN42
E2   C                     END
     C*
     C**   OUTPUT PARENT DETAIL LINE
     C*
     C                     MOVE BBPCNB    RRPCNB
     C                     MOVE *BLANKS   RRCUST
     C                     MOVE C0CRNM    RRCRNM
     C*
     C**   CONVERT COMMITMENT LINE AMOUNT FOR OUTPUT
     C*
     C                     Z-ADDESCMTL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRCMTL
     C*
     C**   CONVERT EXPOSURE AMOUNT FOR OUTPUT
     C*
     C                     Z-ADDWWEXPS    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RREXPS
     C*
     C**   CONVERT SELECTION AMOUNT FOR OUTPUT
     C*
     C           WWAMTE    IFGT 0                                         R5672
     C                     Z-SUBWWAMTE    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRAMT2
     C                     ELSE                                           R5672
     C                     MOVE *BLANKS   RRAMT2                          R5672
     C                     END                                            R5672
     C*
     C                     MOVE '1'       *IN50            OFF 50
B3   C           *IN42     IFEQ '0'
     C*                                                                   S01498
     C**  Process a change in branch                                      S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHEADER1
     C                     MOVE '1'       *IN42
E3   C                     END
     C                     WRITEDETAIL1
     C                     MOVE '1'       *IN43
     C*
     C**   OUTPUT DETAIL LINES FOR ALL CHILDREN
     C*
B2   C                     DO   WWNOC     WWCT1
     C*
     C           WWCT1     OCUR R02DS
     C*
     C**   CHECK FOR OVERFLOW
     C*
B3   C           LINE      IFGT 56
     C                     EXSR #YA
     C*                                                                   S01498
     C**  Process a change in branch                                      S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHEADER1
     C                     MOVE '1'       *IN42
     C                     MOVE '1'       *IN50            ON 50
X3   C                     ELSE
     C                     MOVE '0'       *IN50            OFF 50
E3   C                     END
     C*
     C                     MOVE *BLANKS   RRPCNB
     C                     MOVE D2CUST    RRCUST
     C                     MOVE D2CRNM    RRCRNM
     C*
     C**   CONVERT COMMITMENT LINE AMOUNT FOR OUTPUT
     C*
     C                     Z-ADDD2CMTL    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRCMTL
     C*
     C**   CONVERT EXPOSURE AMOUNT FOR OUTPUT
     C*
     C                     Z-ADDD2EXPS    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RREXPS
     C*
     C**   IF AMOUNT NOT POSITIVE DONT OUTPUT
     C*
B3   C           D2AMTE    IFGE *ZEROS
     C*
     C**   CONVERT SELECTION AMOUNT FOR OUTPUT
     C*
     C                     Z-SUBD2AMTE    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRAMT2
     C*
X3   C                     ELSE
     C*
     C                     MOVE *BLANKS   RRAMT2
     C*
E3   C                     END
     C*
B3   C           *IN42     IFEQ '0'
     C*                                                                   S01498
     C**  Process a change in branch                                      S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHEADER1
     C                     MOVE '1'       *IN42
E3   C                     END
     C                     WRITEDETAIL1
     C                     MOVE '1'       *IN43
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C           #BAA0     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #C        - TERMINATION PROCESSING                         *
     C**                                                              *
     C**   CALLS     - #YA , #ZA                                      *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #C        BEGSR
     C*
     C*****IF*NO*DETAILS*SELECTED*OUTPUT*NULL*REPORT*******************   S01498
     C*
B1   C************IN43     IFEQ '0'                                       S01498
     C***********          MOVE *BLANK    RRBRCD                          S01498
     C***********          MOVE *BLANK    RRACOC                          S01498
     C***********          MOVE *BLANK    RRACON                          S01498
     C***********                                                         S01498
     C***********          WRITEHEADER1                                   S01498
     C***********          WRITENULL1                                     S01498
E1   C***********          END                                            S01498
     C*
     C**   IF OVERFLOW TAKE NEW PAGE
     C*
B1   C           LINE      IFGT 56
     C*
     C                     EXSR #YA
     C*                                                                   S01498
     C**  Process a change in branch                                      S01498
     C           WLBRCA    IFNE RRBRCA                                    S01498
     C                     EXSR #BRPR                                     S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHEADER1
     C*
E1   C                     END
     C*
     C**   WRITE REPORT FOOTING
     C*
     C           WLOPN     IFEQ 'Y'                                       S01498
     C                     WRITEFOOTING1
     C                     CLOSELB0370P1                                  S01498
     C                     END                                            S01498
     C*
     C**   ACCESS TRAILER FILE TO GET NUMBER OF LIVE RECORDS
     C*
     C                     MOVE 'LBEXTSPD'WWFILE  8
     C           WWFILE    CHAINLBTRAIPD             26
     C*
     C**   IF RECORD NOT FOUND OR RECORD-ID NOT = 'T'
     C*
B1   C           *IN26     IFEQ '1'
     C           TRRECI    ORNE 'T'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD6         DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'LBTRAIPD'DBFILE           * DBERROR  006 S01498
     C                     MOVE 'LBTRAIPD'DBFILE           * DBERROR 006 *S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     MOVELWWFILE    DBKEY            ****************
     C                     EXSR #ZA
     C                     OUT  LDA                                       S01498
E1   C                     END
     C*
     C**   NO OF LIVE RECORDS ON TRAILER FILE
     C*
     C                     Z-ADDTRLIVE    RRNROF
     C*
     C**   WRITE RUN CONTROL HEADER
     C*
     C                     WRITEHDRCTRL1
     C*
     C**   WRITE RUN CONTROL DETAIL
     C*
     C                     WRITEDTRCTRL1
     C*
     C*****WRITE*RUN*CONTROL*FOOTING***********************************   S01498
     C*
     C***********          WRITEFTRCTRL1                                  S01498
     C*                                                                   S01498
     C**  Output "No details to report"                                   S01498
     C*                                                                   S01498
     C           *IN43     IFEQ '0'                                       S01498
     C                     WRITENODTLS                                    S01498
     C                     END                                            S01498
     C*
     C           #C0       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #YA       - WRITE HEADING FORMAT                           *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #B , #BA , #BAA , #C                           *
     C**                                                              *
     C*****************************************************************
     C*
     C           #YA       BEGSR
     C*
     C**   SAVE ACCOUNT OFFICER AND BRANCH CODE
     C*
     C                     MOVE BBBRCD    WWBRCD
     C                     MOVE BBACOC    WWACOC
     C                     MOVE BBBRCD    WLBRCA  3                       S01498
     C*
     C**   SET UP REPORT HEADER
     C*
     C                     MOVE BBBRCD    RRBRCD
     C*
     C**   CONVERT SELECTION AMOUNT FOR OUTPUT
     C*
     C                     Z-ADDWWSELA    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRAMT1
     C*
     C                     MOVE *BLANKS   RRACOC
     C                     MOVE *BLANKS   RRACON
     C*
     C**   IF NO ACCOUNT OFFICER - DONT GET NAME
     C*
B1   C           BBACOC    IFNE *BLANKS
     C*
     C                     MOVE BBACOC    RRACOC
     C*
     C**   ACCESS THE ACCOUNT OFFICERS FILE TO GET ACCOUNT OFFICER NAME
     C*
     C***********BBACOC    CHAINSDACOFL0             27                   S01498
     C*                                                                   S01498
     C                     CALL 'AOACOFR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM BBACOC    P@ACOC  2                       S01498
     C           SDACOF    PARM SDACOF    DSFDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR TYPE-OF-LAST-CHANGE - 'D' (DELETED)
     C*
B2   C************IN27     IFEQ '1'                                       S01498
     C***********AZTYLC    OREQ 'D'                                       S01498
     C           P@RTCD    IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD7         DBASE            ****************
     C                     MOVE *BLANKS   DBFILE           *              *
     C***********          MOVEL'SDACOFL0'DBFILE           * DBERROR  007 S01498
     C                     MOVE 'SDACOFPD'DBFILE           * DBERROR 007 *S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     MOVELBBACOC    DBKEY            ****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
E2   C                     END
     C*
     C                     MOVE AZACON    RRACON
     C*
E1   C                     END
     C*
     C           #YA0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************   S01498
     C**                                                              *   S01498
     C** #BRPR     - Subroutine to process a change in branch         *   S01498
     C**                                                              *   S01498
     C** CALLS     - none                                             *   S01498
     C**                                                              *   S01498
     C** CALLED BY - #BA, #BAA, #C                                    *   S01498
     C**                                                              *   S01498
     C*****************************************************************   S01498
     C           #BRPR     BEGSR                           **  #BRPR    **S01498
     C*                                                                   S01498
     C**  If printer file is open and entity is not blank, print footer   S01498
     C*                                                                   S01498
     C           WLOPN     IFEQ 'Y'                                       S01498
     C           @RENT     ANDNE*BLANKS                                   S01498
     C*                                                                   S01498
     C**  Output "End of Report"                                          S01498
     C                     WRITEFOOTING1                                  S01498
     C*                                                                   S01498
     C**  Close printer file                                              S01498
     C                     CLOSELB0370P1                                  S01498
     C                     MOVE *BLANK    WLOPN   1                       S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C**  Open printer file LB0370P1 if entity is not blank               S01498
     C**  or the printer file is not yet open                             S01498
     C*                                                                   S01498
     C           @RENT     IFNE *BLANKS                                   S01498
     C           WLOPN     ORNE 'Y'                                       S01498
     C                     OPEN LB0370P1                                  S01498
     C                     MOVE 'Y'       WLOPN                           S01498
     C*                                                                   S01498
     C** Ensure Report Spool File recorded by RCF                         S01498
     C*                                                                   S01498
     C           @RENT     IFNE *BLANKS                                   S01498
     C                     MOVE WLBRCA    SENTY                           S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUM     ZSNUM1  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           @RSEQ                           S01498
     C                     PARM           SENTY   3                       S01498
     C                     PARM           SFILE                           S01498
     C                     PARM           ZSNUM1                          S01498
     C                     PARM           ZSERR   1                       S01498
     C*                                                                   S01498
     C** If an error occurred during ZSFILE processing,                   S01498
     C** return to the calling program.                                   S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     EXSR *PSSR                                     S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C**  Reset page and line numbers and initialise fields               S01498
     C*                                                                   S01498
     C                     Z-ADD*ZEROS    PAGE                            S01498
     C                     Z-ADD*ZEROS    LINE                            S01498
     C                     MOVE WLBRCA    RRBRCA                          S01498
     C*                                                                   S01498
     C**  Get branch name using access object                             S01498
     C*                                                                   S01498
     C**********           CALL 'AOBRCHR0'                                S01498              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*KEY   ' P@OPTN                          S01498
     C                     PARM RRBRCA    P@BRCA  3                       S01498
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01498              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01498
     C**  Check if error occurred                                         S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE 'SDBRCHPD'DBFILE           ***************S01498
     C                     Z-ADD50        DBASE            * DBERROR 050 *S01498
     C                     MOVE *BLANKS   DBKEY            ***************S01498
     C                     MOVELRRBRCA    DBKEY                           S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     MOVE A8BRNM    RRBRNM                          S01498
     C*                                                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           #BRPRO    ENDSR                                          S01498
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZA       - PROCESS DATABASE ERRORS                        *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #A , #BAA , #C , #YA                           *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZA       BEGSR
     C*
     C**   WRITE RUN CONTROL HEADER
     C*
     C                     WRITEHDRCTRL1
     C*
     C**   WRITE RUN CONTROL DBERROR FORMAT
     C*
     C                     WRITEDBRCTRL1
     C*
     C*****WRITE*RUN*CONTROL*FOOTING***********************************   S01498
     C*
     C***********          WRITEFTRCTRL1                                  S01498
     C*                                                                   S01498
     C**  If printer file P1 is open, report database error               S01498
     C*                                                                   S01498
     C           WLOPN     IFEQ 'Y'                                       S01498
     C                     WRITEDBERROR                                   S01498
     C                     END                                            S01498
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     EXSR *PSSR                                     S01498
     C                     RETRN
     C*
     C           #ZA0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZB       - CALCULATE THE DIFFERENCE BETWEEN THE           *
     C**               COMMITMENT AMOUNT AND THE EXPOSURE AMOUNT      *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #BA , #BAA                                     *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZB       BEGSR
     C*
     C**   ACCESS THE PORTFOLIO EXTRACT SUMMARY FILE
     C*
     C                     Z-ADD*ZEROS    WWTEMP
     C                     Z-ADD*ZEROS    WWEXPS
     C                     Z-ADD*ZEROS    WWAMTE
     C                     MOVE BBCUST    WWCNUM
     C           WWCNUM    CHAINLBEXTSL1             28
     C*
B1   C           *IN28     IFEQ '0'
     C*
     C                     ADD  1         RRNRIP
     C*
     C**   CALCULATE THE EXPOSURE
     C*
     C           ESOWEX    ADD  ESTPIU    WWEXPS
     C*
     C**   CALCULATE THE DIFFERENCE BETWEEN THE COMMITMENT AMOUNT
     C**   AND THE EXPOSURE AMOUNT
     C*
     C           WWEXPS    SUB  ESCMTL    WWAMTE
     C*
E1   C                     END
     C*
     C           #ZB0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   *PSSR     - PROGRAM ERROR HANDLING ROUTINE                 *
     C**                                                              *
     C**   CALLS     -                                                *
     C**                                                              *
     C**   CALLED BY -                                                *
     C**                                                              *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C           #PSSR0    ENDSR
     C*****************************************************************
     C/EJECT
**  CPY@
(c) Finastra International Limited 2001
