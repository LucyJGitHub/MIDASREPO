     H        1                                                           S01498
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB FX/PM Closed Position Regeneration')          *
     H***********                                                         S01498
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                         *
     F*                                                               *
     F*  LB0615 - Forex/Precious Metals Closed Position Regeneration  *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. CDL099             Date 06Oct17               *
      *  Prev Amend No. CDL094             Date 11Jun14               *
      *                 CSW212             Date 03May12               *
      *                 CER059             Date 19Jul10               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CDL049             Date 07Jul06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CDL038             Date 10May05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CAS004             Date 26Jun02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 087631             Date 06Sep95               *
     F*                 S01498             DATE 11AUG94               *
     F*                 38279              DATE 09APR92               *
     F*                 41978              DATE 15JUL92               *
     F*                 049421             DATE 12JUL93               *
     F*                 S01328             DATE 15JAN93               *
     F*                 43052              DATE 17SEP92               *
     F*                 37511              DATE 30MAR92               *
     F*                 B08154             DATE 15OCT91               *
     F*                 B7907              DATE 04JUN91               *
     F*                 R01168             DATE 29APR91               *
     F*                 R5519              DATE 21FEB91               *
     F*                 R0125              DATE 11FEB91               *
     F*                 R0102              DATE 06FEB91               *
     F*                 R0091              DATE 30JAN91               *
     F*                 R0055              DATE 30JAN91               *
     F*                 LB2000             DATE 06NOV90               *
     F*                 R0590              DATE 29OCT90               *
     F*                 B4812              DATE 23OCT90               *
     F*                 R0577              DATE 19OCT90               *
     F*                 B4813              DATE 17OCT90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CSW212 - SWIFT 2012 Changes (Recompile)                      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CAS004 - Hedge Accounting Phase A (Recompile)                *
      *  CDL008 - Continuous Linked Settlement (Recompiled DEALSDG)   *
     F*  087631 - Should only use Precious Metal limits if S01433,    *
     F*           Extended Dealing Limits switchable feature is on.   *
     F*  S01498 - Portfolio Lending Upgrade to Release 10             *
     F*  38279  - SWAP DEALS MENU NOT INCLUDED.                       *
     F*  41978  - SELECT ACTIVE RECORDS WITH MATURITY DATE GREATER    *
     F*  049421 - HEADER BOX STANDARDISATION                          *
     F*  S01328 - FRA/IRS Revaluation.                                *
     F*  043052 - FOR MATCHED DEALS, IT'S NECESSARY TO KEEP           *
     F*           THE NBR OF DECIMALS BEFORE OUTPUT REPORT            *
     F*           AND FILES.                                          *
     F*           REDUCE SIZE OF 'SMDL' MATCHED DEALS ARRAY           *
     F*  37511  - INITIALISE P/L AMOUNT FOR EACH CUSTOMER             *
     F*  B08154 - SHOW P/L IN ORIGINAL CURRENCY ON REPORT             *
     F*           P/L INCORRECT DUE TO DECIMAL PLACES                 *
     F*  B7907  - ARRAY INDEX INVALID DURING THE E.O.D.               *
     F*  R01168 - WRITE TO NEW EXTRACT FILE LBEXCOPD                  *
     F*  R5519  - OUTPUT BORROWING POWER % FOR METAL P/L              *
     F*  R0125  - EXPOSURE AND COLLATERAL NOT INITIALISED WHEN WORK   *
     F*           FIELDS ARE EQUAL TO ZERO                            *
     F*  R0102  - PM DEALS ARE REPORTED AS NORMAL FX.                 *
     F*  R0091  - PM ARE CHANGED ONE FILE USED BY LB.                 *
     F*           RECOMPILE THIS PROGRAM.                             *
     F*  R0055  - UPDATE THE FILE "DEALSDB" ABNORMALY.                *
     F*  LB2000 - PRECIOUS METALS                                     *
     F*  R0590  - NUMBERS OF DECIMAL PLACES IS WRONG.                 *
     F*  B4812  - OUTPUT BORROWING POWER % TO EXTRACT FILE            *
     F*  B4813  - ONLY REPORT CLOSED DEALS                            *
     F*  LB0000 - CHANGE TO PROFIT/LOSS CALCULATION                   *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**
     F**      FILE DEFINITIONS
     F**     ------------------
     F*
     F**   RUN CONTROLS REPORT
1    F***LB0615AUO***E             21     PRINTER      KINFDS ERF1DS      S01498
     FLB0615AUO   E             21     PRINTER      KINFDS SPOOLU         S01498
     F                                              KINFSR *PSSR
     F*
     F*****MISSING*INSTRUMENT*REPORT***********************************   S01498
2    F***LB0615P1O***E             20     PRINTER      KINFSR *PSSR       S01498
     F*
     F**   REGENERATION DETAILS REPORT
     F***LB0615P0O***E             19     PRINTER      KINFDS ERF2DS      S01498
     FLB0615P1O   E             19     PRINTER      KINFDS SPOOL1     UC  S01498
     F                                              KINFSR *PSSR
     F*
     F*****BANK*DETAILS*FILE.*PREFIX*BJ.*******************************   S01498
3    F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F*****PORTFOLIO*LENDING*ICD*FILE.*PREFIX*-*LB*********************   S01498
4    F***SDLOMBPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F*****CURRENCY*FILE.*PREFIX*-*A6**********************************   S01498
5    F***SDCURRL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F*****CURRENCY*EXTENDED*FILE.*PREFIX*-*CY******************** LB2000 S01498
     F***SDCURRX0IF**E           K        DISK         KINFSR *PSS LB2000 S01498
     F*
     F**   JOINT CUSTOMER DETAILS  LB / SD. PREFIX - CU/BB
7    F***SDLBCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ0IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   PORTFOLIO LENDING EXTRACT FILE. PREFIX - EE
     FLBEXTRPDO   E           K        DISK         KINFSR *PSSR
     F*                                                                   R01168
     F**   PORTFOLIO EXPOSURE/COLLATERAL EXTRACT FILE. PREFIX - EX        R01168
     FLBEXCOPDO   E                    DISK         KINFSR *PSSR          R01168
     F*
     F***PORTFOLIO*LENDING*GROUPS*-*PREFIX*GP**************************   S01498
     F***LBGROUL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***INSTRUMENT*TYPES*-*PREFIX*PD**********************************   S01498
     F***SDPLINL4IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** FORWARD RATES FILE
     FFWDRT   IF  E           K        DISK         KINFSR *PSSR
     F*
     F**   BORROWING POWER FILE. PREFIX BP.
     FLBBPWRL1IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD1
     F*
     F**   BORROWING POWER FILE. PREFIX BP.
     FLBBPWRL3IF  E           K        DISK         KINFSR *PSSR
     F            LBBPWRD0                          KRENAMELBBPWRD3
     F*
     F** DEALS MASTER (DUPLICATE FILE)
     F***XDEALSL1UF**E           K        DISK         KINFSR *PSSR       S01498
     FLBDEALL2UF  E           K        DISK         KINFSR *PSSR          S01498
     F            DEALSDBF                          KRENAMEXDEALSBF
     F*
     F** DEALS MASTER (DUPLICATE FILE)
     F***XDEALSL2UF**E           K        DISK         KINFSR *PSSR       S01498
     FLBDEALL3UF  E           K        DISK         KINFSR *PSSR          S01498
     F            DEALSDBF                          KRENAMEXDEALSBG
     F*
     F** DEALS DETAILS FILE
     F***DEALDBL1IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBDEALL1IF  E           K        DISK         KINFSR *PSSR          S01498
     F/COPY WNCPYSRC,LB0615F001
     F/EJECT
     F*****************************************************************
     F**                                                              *
     F** ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F**                 ------------------------                     *
     F**                                                              *
     F*********19******-*OVERFLOW*INDICATOR*ON*LB0615P0****************   S01498
     F**       19      - Overflow indicator on LB0615P1               *   S01498
     F**       21      - OVERFLOW INDICATOR ON FILE CONTROLS          *
     F**       22      - INDICATOR FOR MATCHED DEALS ARRAY            *
     F**       23      - INDICATOR FOR PUCYX DATE ARRAY               *
     F**       24      - INDICATOR FOR PUCY DATE ARRAY                *
     F*********25******-*INDICATOR*FOR*CHAINING*TO*'SDLBCSL0'**********   S01498
     F**       25      - Indicator for chaining to 'LBLBCSJ0'         *   S01498
     F**       26      - INDICATES WHETHER TO WRITE TO 'LBEXTRPD'     *
     F**       31      - ACCESS TO BORROWING POWER FILE - LBBPWRL1    *
     F**       32      - ACCESS TO BORROWING POWER FILE - LBBPWRL3    *
     F**       41      - LB0615P1 open                                *   S01498
     F*********71******-*READ*FAILS*ON*SDBANKPD************************   S01498
     F*********72******-*READ*FAILS*ON*SDLOMBPD************************   S01498
     F*********73******-*CHAIN*FAIL*ON*SDCURRL1************************   S01498
     F*********74******-*READ*FAILS*ON*DEALDBL1************************   S01498
     F**       74      - Read fails on LBDEALL1                       *   S01498
     F**       75      - NO PORTFOLIO LENDING CUSTOMERS FOUND            *
     F*********76******-*CHAIN*FAIL*ON*XDEALSL1************************   S01498
     F*********77******-*CHAIN*FAIL*ON*XDEALSL2************************   S01498
     F**       76      - Chain fail on LBDEALL2                       *   S01498
     F**       77      - Chain fail on LBDEALL3                       *   S01498
     F*********78******-*CHAIN*FAIL*ON*SDPLINL0************************   R01168
     F*********79******-*CHAIN*FAIL*ON*LBGROUL1************************   R01168
     F**       80      - CHAIN FAIL ON FWDRT                          *
     F*********81******-*CHAIN*FAIL*ON*SDPLINL4************************   R01168
     F**                                                              *
     F*****************************************************************
     F/EJECT
     E********************************************************************
     E*
     E** ARRAY FOR COPYRIGHT
     E                    CPY@    1   1 80
     E*
     E** ARRAY USED IN CURRENCY AMOUNT CONVERSION
     E                    POWER   1   7  7 3
     E*
     E** MATCHED DEALS ARRAY
     E******************* SMDL     9999  6 0                              043052
     E                    SMDL     2999  6 0                              043052
     E*
     E** DATE ARRAY
     E                    DAT        26  5 0A
     E*
     E** RATE ARRAY
     E                    RAT        26 13 8
     E*
     E** NUMBER OF DAYS FORWARD ARRAY
     E******************* DFWW       25  3 0                              S01328
     E                    DFWW       25  5 0                              S01328
     E*
     E** FORWARD RATES ARRAY
     E                    RFWW       25 13 8
     E/EJECT
     E*****************************************************************
     E/COPY ZSRSRC,ZSEDITZ1
     E*****************************************************************
     E/EJECT
     I*****************************************************************
     I/EJECT
     I*****************************************************************
     I*
     I*****RENAME*FIELDS*ON*XDEALSL1***********************************   S01498
     I**   Rename fields on LBDEALL2.                                     S01498
     IXDEALSBF
     I              RECI                            RECIX
     I              DLNO                            DLNOX
     I              CNUM                            CNUMX
     I              DTYP                            DTYPX
     I              VDAT                            VDATX
     I              PUCY                            PUCYX
     I              PUAM                            PUAMX
     I              SLCY                            SLCYX
     I              SLAM                            SLAMX
     I              SPLC                            SPLCX
     I              SODN                            SODNX
     I              SPLA                            SPLAX
     I              CHTP                            CHTPX
     I              RCDC                            RCDCX                 R0055
     I**************BRCD                            BRCDX          R0055  S01498
     I              BRCA                            BRCDX                 S01498
     I              DLST                            DLSTX                 R0055
     I              DDAT                            DDATX                 R0055
     I              OTDT                            OTDTX                 R0055
     I              BRKC                            BRKCX                 R0055
     I              BAGE                            BAGEX                 R0055
     I              EXRT                            EXRTX                 R0055
     I              BCEQ                            BCEQX                 R0055
     I              OBCE                            OBCEX                 R0055
     I              LCXR                            LCXRX                 R0055
     I              PCST                            PCSTX                 R0055
     I              OPCA                            OPCAX                 R0055
     I              TSCN                            TSCNX                 R0055
     I              SCST                            SCSTX                 R0055
     I              OSCA                            OSCAX                 R0055
     I              TPCN                            TPCNX                 R0055
     I              ORPA                            ORPAX                 R0055
     I              ORSA                            ORSAX                 R0055
     I              FSLI                            FSLIX                 R0055
     I              LITD                            LITDX                 R0055
     I              LILA                            LILAX                 R0055
     I              DITD                            DITDX                 R0055
     I              DILA                            DILAX                 R0055
     I              SPPD                            SPPDX                 R0055
     I              ILCY                            ILCYX                 R0055
     I              ILAM                            ILAMX                 R0055
     I              IDCY                            IDCYX                 R0055
     I              IDAM                            IDAMX                 R0055
     I              IDIA                            IDIAX                 R0055
     I              FACO                            FACOX                 R0055
     I              SPI                             SPIX                  R0055
     I              ILIR                            ILIRX                 R0055
     I              IDIR                            IDIRX                 R0055
     I              ILIA                            ILIAX                 R0055
     I              DNSI                            DNSIX                 R0055
     I              DSTI                            DSTIX                 R0055
     I              CNFI                            CNFIX                 R0055
     I              ACEI                            ACEIX                 R0055
     I              TLXI                            TLXIX                 R0055
     I              ILCM                            ILCMX                 R0055
     I              IDCM                            IDCMX                 R0055
     I              LSWC                            LSWCX                 R0055
     I              LSWS                            LSWSX                 R0055
     I              ORED                            OREDX                 R0055
     I              LCD                             LCDX                  R0055
     I              TNLU                            TNLUX                 R0055
     I              BOKC                            BOKCX                 R0055
     I              LNKDN                           LNKDNX                R0055
     I              RSTM                            RSTMX                 R0055
     I              RONS                            RONSX                 R0055
     I              RIBN                            RIBNX                 R0055
     I              RIBA                            RIBAX                 R0055
     I              ROBN                            ROBNX                 R0055
     I              ROCN                            ROCNX                 R0055
     I              PSTM                            PSTMX                 R0055
     I              PONS                            PONSX                 R0055
     I              PIBN                            PIBNX                 R0055
     I              PIBA                            PIBAX                 R0055
     I              POBN                            POBNX                 R0055
     I              POCN                            POCNX                 R0055
     I              RCRN                            RCRNX                 R0055
     I              RCRA                            RCRAX                 R0055
     I              RVNO                            RVNOX                 R0055
     I              AWBN                            AWBNX                 R0055
     I              AWBA                            AWBAX                 R0055
     I              BENN                            BENNX                 R0055
     I              BENA                            BENAX                 R0055
     I              DTP1                            DTP1X                 R0055
     I              DTP2                            DTP2X                 R0055
     I              DTP3                            DTP3X                 R0055
     I              DTP4                            DTP4X                 R0055
     I              DCHG                            DCHGX                 R0055
     I              BTB1                            BTB1X                 R0055
     I              BTB2                            BTB2X                 R0055
     I              BTB3                            BTB3X                 R0055
     I              BTB4                            BTB4X                 R0055
     I              BTB5                            BTB5X                 R0055
     I              BTB6                            BTB6X                 R0055
     I              CVMR                            CVMRX                 R0055
     I              PTFR                            PTFRX                 R0055
     I*
     I*****RENAME*FIELDS*ON*XDEALSL2***********************************   S01498
     I**   Rename fields on LBDEALL3.                                     S01498
     IXDEALSBG
     I              RECI                            RECIY
     I              DLNO                            DLNOY
     I              CNUM                            CNUMY
     I              DTYP                            DTYPY
     I              VDAT                            VDATY
     I              PUCY                            PUCYY
     I              PUAM                            PUAMY
     I              SLCY                            SLCYY
     I              SLAM                            SLAMY
     I              SPLC                            SPLCY
     I              SODN                            SODNY
     I              SPLA                            SPLAY
     I              CHTP                            CHTPY
     I              RCDC                            RCDCY                 R0055
     I**************BRCD                            BRCDY         R0055   S01498
     I              BRCA                            BRCDY                 S01498
     I              DLST                            DLSTY                 R0055
     I              DDAT                            DDATY                 R0055
     I              OTDT                            OTDTY                 R0055
     I              BRKC                            BRKCY                 R0055
     I              BAGE                            BAGEY                 R0055
     I              EXRT                            EXRTY                 R0055
     I              BCEQ                            BCEQY                 R0055
     I              OBCE                            OBCEY                 R0055
     I              LCXR                            LCXRY                 R0055
     I              PCST                            PCSTY                 R0055
     I              OPCA                            OPCAY                 R0055
     I              TSCN                            TSCNY                 R0055
     I              SCST                            SCSTY                 R0055
     I              OSCA                            OSCAY                 R0055
     I              TPCN                            TPCNY                 R0055
     I              ORPA                            ORPAY                 R0055
     I              ORSA                            ORSAY                 R0055
     I              FSLI                            FSLIY                 R0055
     I              LITD                            LITDY                 R0055
     I              LILA                            LILAY                 R0055
     I              DITD                            DITDY                 R0055
     I              DILA                            DILAY                 R0055
     I              SPPD                            SPPDY                 R0055
     I              ILCY                            ILCYY                 R0055
     I              ILAM                            ILAMY                 R0055
     I              IDCY                            IDCYY                 R0055
     I              IDAM                            IDAMY                 R0055
     I              IDIA                            IDIAY                 R0055
     I              FACO                            FACOY                 R0055
     I              SPI                             SPIY                  R0055
     I              ILIR                            ILIRY                 R0055
     I              IDIR                            IDIRY                 R0055
     I              ILIA                            ILIAY                 R0055
     I              DNSI                            DNSIY                 R0055
     I              DSTI                            DSTIY                 R0055
     I              CNFI                            CNFIY                 R0055
     I              ACEI                            ACEIY                 R0055
     I              TLXI                            TLXIY                 R0055
     I              ILCM                            ILCMY                 R0055
     I              IDCM                            IDCMY                 R0055
     I              LSWC                            LSWCY                 R0055
     I              LSWS                            LSWSY                 R0055
     I              ORED                            OREDY                 R0055
     I              LCD                             LCDY                  R0055
     I              TNLU                            TNLUY                 R0055
     I              BOKC                            BOKCY                 R0055
     I              LNKDN                           LNKDNY                R0055
     I              RSTM                            RSTMY                 R0055
     I              RONS                            RONSY                 R0055
     I              RIBN                            RIBNY                 R0055
     I              RIBA                            RIBAY                 R0055
     I              ROBN                            ROBNY                 R0055
     I              ROCN                            ROCNY                 R0055
     I              PSTM                            PSTMY                 R0055
     I              PONS                            PONSY                 R0055
     I              PIBN                            PIBNY                 R0055
     I              PIBA                            PIBAY                 R0055
     I              POBN                            POBNY                 R0055
     I              POCN                            POCNY                 R0055
     I              RCRN                            RCRNY                 R0055
     I              RCRA                            RCRAY                 R0055
     I              RVNO                            RVNOY                 R0055
     I              AWBN                            AWBNY                 R0055
     I              AWBA                            AWBAY                 R0055
     I              BENN                            BENNY                 R0055
     I              BENA                            BENAY                 R0055
     I              DTP1                            DTP1Y                 R0055
     I              DTP2                            DTP2Y                 R0055
     I              DTP3                            DTP3Y                 R0055
     I              DTP4                            DTP4Y                 R0055
     I              DCHG                            DCHGY                 R0055
     I              BTB1                            BTB1Y                 R0055
     I              BTB2                            BTB2Y                 R0055
     I              BTB3                            BTB3Y                 R0055
     I              BTB4                            BTB4Y                 R0055
     I              BTB5                            BTB5Y                 R0055
     I              BTB6                            BTB6Y                 R0055
     I              CVMR                            CVMRY                 R0055
     I              PTFR                            PTFRY                 R0055
     I*
     I**   RENAME FIELDS ON FWDRT
     IFWDRTFEF
     I              RECI                            RECIF
     I              CHTP                            CHTPF
     I*
     I/EJECT
     I*****************************************************************
     I/COPY ZSRSRC,ZSEDITZ2
     I*****************************************************************
     I/EJECT
     I*****************************************************************
     I** DATA STRUCTURES FOR COPYRIGHT
     ICPYR@       DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*
     I** Data Structure to split date into day month year
     I            DS
     I****************************************1   7 BJMRDT                S01498
     I                                        1   7 WWMRDT                S01498
     I                                        1   20WWDAY
     I                                        3   5 WWMNTH
     I                                        6   70WWYEAR
     I*
     I**   PROGRAM DATA STRUCTURES
     I            DS
     I*
     I**   TO FILL DATE ARRAY
     I**--                                    1  50 DFW                   R3IN
     I*************************************** 1  50 DFWC              R3INS01328
     I*********************************** P   1  50 DFWW                  S01328
     I                                        1  75 DFW                   S01328
     I                                    P   1  75 DFWW                  S01328
     I*
     I**   TO FILL FORWARD RATES ARRAY
     I            DS
     I                                        1 175 RFW
     I                                    P   1 175 RFWW
     I*
     I**   SET UP DATA STRUCTURE FOR KEY LIST
     I            DS
     I                                        1  12 KYLST
     I**********                              1   60CNUM                                      CSD027
     I                                        1   6 CNUM                                      CSD027
     I                                        7  120KVDAT
     I*                                                                   R01168
     I**   SET UP DATA STRUCTURE FOR REFERENCE ON LBEXCOPD                R01168
     I**   (ORIGINAL DEAL)                                                R01168
     I            DS                                                      R01168
     I                                        1  16 WWEREF                R01168
     I                                        1   60DLNO                  R01168
     I                                        7  120WWRLDN                R01168
     I*                                                                   R01168
     I**   SET UP DATA STRUCTURE FOR REFERENCE ON LBEXCOPD                R01168
     I**   (MATCHED DEAL)                                                 R01168
     I            DS                                                      R01168
     I                                        1  16 WWXREF                R01168
     I                                        1   60DLNOX                 R01168
     I                                        7  12 WWRLDX                R01168
     I*
     I**   PROGRAM STATUS DATA STRUCTURE
     IPSDS       SDS
     I                                      244 253 JOB
     I                                      254 263 USER
     I*
     I**   FILE INFORMATION DATA STRUCTURE
     I***ERF1DS******DS                                                   S01498
     ISPOOLU      DS                                                      S01498
     I                                       83  92 SFILEU                S01498
     I                                    B 123 1240SFNUMU                S01498
     I*                                                                   S01498
     I**   FOR OVERFLOW ON FILE CONTROLS
     I                                    B 367 3680LINE
     I*
     I**   FILE INFORMATION DATA STRUCTURE
     I***ERF2DS******DS                                                   S01498
     ISPOOL1      DS                                                      S01498
     I                                       83  92 SFILE1                S01498
     I                                    B 123 1240SFNUM1                S01498
     I*                                                                   S01498
     I**   FOR OVERFLOW ON FILE CONTROLS
     I                                    B 367 3680LINE1
     I*                                                                   S01498
     ISPOOL2      DS                                                      S01498
     I                                       83  92 SFILE2                S01498
     I                                    B 123 1240SFNUM2                S01498
     I*
     I**   LOCAL DATA AREA
     I***LDA********UDS                            256                    S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I** Local Data Area                                                  S01498
     I*                                                                   S01498
     IRUNDAT    E DS                                                      S01498
     I** Standard data area layout for system flags and run date          S01498
     I*                                                                   S01498
     I@BANK     E DSSDBANKPD                                              S01498
     I** Dummy record format for access to Bank Details                   S01498
     I*                                                                   S01498
     I@CURR     E DSSDCURRPD                                              S01498
     I** Dummy record format for access to Currency Details               S01498
     I*                                                                   S01498
     I@PLIN     E DSSDPLINPD                                              S01498
     I** Dummy record format for access to Instrument Types               S01498
     I*                                                                   S01498
     I@LOMB     E DSSDLOMBPD                                              S01498
     I** Dummy record format for access to Portfolio Lending ICD          S01498
     I*                                                                   S01498
     I@GROU     E DSLBGROUPD                                              S01498
     I** Dummy record format for access to Portfolio Lending Groups       S01498
     I*                                                                   S01498
     ISCSARD    E DSSCSARDPD                                              087631
     I** Dummy record format for access to SWITCHABLE FEATURES            087631
     I*                                                                   087631
     IDSFDY     E DSDSFDY                                                 S01498
     I** First DS for Access Programs, short data structure               S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I** Second DS for Access Programs, long data structure               S01498
     I*                                                                   S01498
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*
     C** DEFINE KEY LISTS
     C*
     C****KEY*TO*ACCESS*DUPLICATE*DEALS*FILE*'XDEALSL1'****************   S01498
     C**  Key to access duplicate deals file 'LBDEALL2'                   S01498
     C           KL1       KLIST
     C                     KFLD           CNUM
     C                     KFLD           VDAT
     C*
     C**  KEY TO ACCESS BORROWING POWER FILE 'LBBPWRL1'
     C           WWBPK1    KLIST
     C                     KFLD           WWCNUM
     C                     KFLD           LBFXPL
     C*
     C*LB2000/START
     C**  KEY TO ACCESS BORROWING POWER FILE 'LBBPWRL1'
     C           WWBPK2    KLIST
     C                     KFLD           WWCNUM
     C                     KFLD           LBPMPL
     C*LB2000/END
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*
     C**              START MAINLINE
     C**             ----------------
     C*
     C**   INITIAL PROCESSING
     C*
     C                     EXSR #A
     C*
     C**   MAIN PROCESSING
     C*
     C                     EXSR #B
     C*
     C**   TERMINATION PROCESSING
     C*
     C                     EXSR #C
     C*
     C**   END PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    INDEX TO SUBROUTINES                                      *
     C**   ----------------------                                     *
     C**                                                              *
     C**   ZSEDIT  - CONVERT AMOUNT FOR OUTPUT                        *
     C**                                                              *
     C**   #A      - PERFORMS INITIAL PROCESSING                      *
     C**                                                              *
     C**   #B      - MAIN PROCESSING                                  *
     C**   #BA     - CALCULATES CLOSED FOREX POSITION FOR NON-SWAP    *
     C**             DEALS AND ACCUMULATES RUNNING TOTALS.            *
     C**   #BAA    - PERFORMS CALCULATIONS FOR NON-SWAP DEALS         *
     C**   #BAAA   - CALCULATES PUCYX RATE AND RESULTING PROFIT/LOSS  *
     C**   #BAAB   - CALCULATES PUCY RATE AND RESULTING PROFIT/LOSS   *
     C**   #BB     - CALCULATES CLOSED FOREX POSITION FOR SWAP DEALS  *
     C**   #BC     - WRITES RECORD TO PORTFOLIO EXTRACT FILE          *
     C**   #BE     - PERFORMS CALCULATIONS TO WRITE RECORD TO NEW     *
     C**             PORTFOLIO EXTRACT FILE                           *
     C**   #BEA    - WRITES RECORD TO LBEXCOPD FOR ORIGINAL DEAL      *
     C**   #BEB    - WRITES RECORD TO LBEXCOPD FOR MATCHED DEAL       *
     C**                                                              *
     C**   #C      - PERFORMS TERMINATION PROCESSING                  *
     C**                                                              *
     C**   #YA     - FILLS FORWARD RATES AND DATE ARRAYS              *
     C**   #ZA     - PROCESS DATABASE ERRORS                          *
     C**   SCONV   - CONVERTS AN AMOUNT FROM ONE CURRENCY TO ANOTHER  *
     C**   *PSSR   - PROGRAM ERROR HANDLING ROUTINE                   *
     C**                                                              *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #A        - THIS SUBROUTINE PERFORMS INTIAL PROCESSING     *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #A        BEGSR
     C*                                                                   S01498
     C**  Copyright statement                                             S01498
     C*                                                                   S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*                                                                   S01498
     C**  Read in DTAARA/RUNDAT to get multibranching indicator           S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           RUNDAT                          S01498
     C                     IN   RUNDAT                                    S01498
     C           AGMBIN    IFEQ 'Y'                                       S01498
     C                     MOVE '1'       *IN39                           S01498
     C                     END                                            S01498
     C*
     C**   INITIALISE DB ERROR FIELDS AND STORE PROGRAM NAME FOR
     C**   DB ERROR FIELD.
     C*
     C           *NAMVAR   DEFN           LDA                             S01498
     C*                                                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'LB0615'  DBPGM
     C                     OUT  LDA                                       S01498
     C*
     C**   DEFINE WORK FIELDS
     C           *LIKE     DEFN BBCUST    WWPNP8
     C           *LIKE     DEFN CNUM      WWCNUM
     C************LIKE     DEFN LBCCY     WWCCY                           S01498
     C           *LIKE     DEFN LBCYCD    WWCCY                           S01498
     C           *LIKE     DEFN DLNO      WWDLNO
     C           *LIKE     DEFN DLNO      WWSODN
     C************LIKE     DEFN DLNO      WWRLDN                          R01168
     C           *LIKE     DEFN A6SPRT    WWBSSR
     C           *LIKE     DEFN A6NBDP    WWBSDP
     C           *LIKE     DEFN A6MDIN    WWBSMD
     C           *LIKE     DEFN A6SPRT    WWSPRT
     C           *LIKE     DEFN A6NBDP    WWDECP
     C           *LIKE     DEFN A6MDIN    WWMDIV
     C           *LIKE     DEFN BPINPC    WWBPPC                          LB0000
     C           *LIKE     DEFN EXRECI    WWRECI                          R01168
     C           *LIKE     DEFN EXORED    WWORED                          R01168
     C           *LIKE     DEFN EXPCNB    WWPCNB                          R01168
     C           *LIKE     DEFN EXREGE    WWREGE                          R01168
     C           *LIKE     DEFN EXLCGR    WWLCGR                          R01168
     C           *LIKE     DEFN EXLCGS    WWLCGS                          R01168
     C           *LIKE     DEFN EXINST    WWINST                          R01168
     C           *LIKE     DEFN EXEXCO    WWEXCO                          R01168
     C           *LIKE     DEFN EXAMNT    WWAMNT                          R01168
     C*
     C**   INITIALISE WORK FIELDS
     C                     MOVE *BLANKS   WWPNP8
     C**********           Z-ADD*ZEROS    WWCNUM                                              CSD027
     C                     MOVE *BLANKS   WWCNUM                                              CSD027
     C                     Z-ADD*ZEROS    WWRLDN
     C                     MOVE *BLANKS   WWCCY
     C                     Z-ADD*ZEROS    WWDLNO
     C                     Z-ADD*ZEROS    WWSODN
     C                     Z-ADD*ZEROS    WWBSSR
     C                     Z-ADD*ZEROS    WWBSDP
     C                     MOVE *BLANKS   WWBSMD
     C                     Z-ADD*ZEROS    WWSPRT
     C                     Z-ADD*ZEROS    WWDECP
     C                     MOVE *BLANKS   WWMDIV
     C                     Z-ADD*ZEROS    WWTOT  150
     C                     Z-ADD*ZEROS    WWTEXP 150                      LB0000
     C                     Z-ADD*ZEROS    WWTCOL 150                      LB0000
     C                     Z-ADD*ZEROS    WWLAST  20
     C*LB2000/START                                                       LB0000
     C                     Z-ADD*ZEROS    WWPEXP 150                      LB0000
     C                     Z-ADD*ZEROS    WWPCOL 150                      LB0000
     C*LB2000/END                                                         LB0000
     C*
     C**   INITIALISE RECORD COUNTERS
     C                     Z-ADD*ZEROS    RRNUMR
     C                     Z-ADD*ZEROS    RRRECW                          R01168
     C                     Z-ADD*ZEROS    RRRECS
     C*                                                                   R01168
     C**   INITIALISE WRITE TO EXTRACT FILE LBEXCOPD INDICATOR            R01168
     C                     MOVE '0'       *IN27                           R01168
     C*
     C**   INITIALISE MATCHED DEALS ARRAY
     C                     Z-ADD*ZEROS    SMDL
     C*
     C**   INITIALISE VARIOUS ARRAY ELEMENTS
     C*                    Z-ADD1         X       20                      B7907
     C                     Z-ADD1         X       50                      B7907
     C                     Z-ADD1         Y       20
     C                     Z-ADD1         L       20
     C                     Z-ADD1         M       20
     C                     Z-ADD1         N       20
     C                     Z-ADD1         P       20
     C                     Z-ADD1         Y       20
     C*
     C**   SET OFF ALL INDICATORS
     C                     MOVEA'000000'  *IN,21
     C                     MOVEA'00000000'*IN,71
     C                     MOVEA'00'      *IN,79
     C*
     C**   ACCESS ICD RECORD 1 TO GET RUN DATE & TITLE
     C*
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 71               S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM '*MSG    '@RTCD   7                       S01498
     C                     PARM '*FIRST  '@OPTN   7                       S01498
     C           @BANK     PARM @BANK     DSFDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR LAST-CHANGE-TYPE = 'D' (DELETED)
     C*
     C************IN71     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           BJTYLC    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD1         DBASE            ****************
     C***********          MOVEL'SDBANKPD'DBFILE           * DBERROR  001 S01498
     C                     MOVE 'SDBANKPD'DBFILE           * DBERROR  001 S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ****************
     C                     ELSE
     C*                                                                   S01498
     C                     MOVE BJMRDT    WWMRDT                          S01498
     C*
     C**   EVENT CONTROL DATE = DATE OF NEXT WORKING DAY MINUS 1
     C*
     C           BJDNWD    SUB  1         BJDNWD
     C                     END
     C*                                                                   087631
     C**  Access SAR details file to see if EXTENDED DEALING LIMITS       087631
     C**  is installed.                                                   087631
     C*                                                                   087631
     C                     CALL 'AOSARDR0'                                087631
     C                     PARM *BLANKS   @RTCD                           087631
     C                     PARM '*VERIFY' @OPTN                           087631
     C                     PARM 'S01433'  @SARD   6                       087631
     C           SCSARD    PARM SCSARD    DSFDY                           087631
     C*                                                                   087631
     C           @RTCD     IFEQ *BLANK                                    087631
     C                     MOVE 'Y'       S01433  1                       087631
     C                     END                                            087631
     C/COPY WNCPYSRC,LB0615C001
     C*
     C**   ACCESS PORTFOLIO LENDING ICD TO GET CURRENCY
     C*
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 72               S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM '*MSG    '@RTCD   7                       S01498
     C                     PARM '*FIRST  '@OPTN   7                       S01498
     C           @LOMB     PARM @LOMB     DSFDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR RECORD-ID = '*' THEN DB ERROR
     C*
     C************IN72     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           LBRECI    OREQ '*'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD2         DBASE            ***************
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 002 *S01498
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 002 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
     C*
     C*    IF RECORD FOUND CHECK CLOSED FOREX P/L
     C*    IF BLANK PERFORM DB ERROR PROCESSING AFTER OUTPUTING REPORT
     C                     ELSE
     C***********          WRITEHEADER1                                   S01498
     C*
     C           LBFXPL    IFEQ *BLANKS
     C***********          MOVEA'10'      *IN,50                          S01498
     C***********          WRITEDETAIL1                                   S01498
     C***********          WRITEFOOTING1                                  S01498
     C                     SETON                     50                   S01498
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD13        DBASE            ***************
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 013 *S01498
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 013 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
     C*LB2000/START
E2   C*****                END
X2   C                     ELSE
     C*
     C*    IF RECORD FOUND CHECK PRECIOUS METAL P/L PREDEFINED INSTRUMENT
     C*    IF BLANK PERFORM DB ERROR PROCESSING AFTER OUTPUTING REPORT
B3   C           LBPMPL    IFEQ *BLANKS
     C           S01433    ANDEQ'Y'                                       087631
     C***********          MOVEA'10'      *IN,50                          S01498
     C***********          WRITEDETAIL1                                   S01498
     C***********          WRITEFOOTING1                                  S01498
     C                     SETON                     50                   S01498
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD14        DBASE            ***************
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 014 *S01498
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 014 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
E3   C                     END
     C*
E2   C                     END
     C*LB2000/END
     C*
     C***********          MOVEA'01'      *IN,50                          S01498
     C***********          WRITEDETAIL1                                   S01498
     C***********          WRITEFOOTING1                                  S01498
     C                     END
     C*
     C**   CHAIN WITH PORTFOLIO CURRENCY TO GET NUMBER OF DECIMAL POINTS
     C**   / SPOT RATE / MULT/DIV INDICATOR.
     C*
     C***********LBCCY     CHAINSDCURRL1             73                   S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBCYCD    @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR
     C*
     C************IN73     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 003 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 003 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C***********          MOVELLBCCY     DBKEY            ************** S01498
     C                     MOVELLBCYCD    DBKEY            ************** S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C**   SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C**   FOR ROUTINE SCONV
     C*
     C                     Z-ADDA6SPRT    WWSRO
     C                     Z-ADDA6NBDP    WWDPO
     C                     MOVE A6MDIN    WWMDO
     C                     END
     C*
     C**   CHAIN WITH BASE CURRENCY TO GET NUMBER OF DECIMAL POINTS
     C**   / SPOT RATE / MULT/DIV INDICATOR.
     C*
     C***********BJCYCD    CHAINSDCURRL1             73                   S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM BJCYCD    @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR
     C*
     C************IN73     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 004 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 004 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELBJCYCD    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C**   SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C**   FOR ROUTINE SCONV
     C*
     C                     Z-ADDA6SPRT    WWBSSR
     C                     Z-ADDA6NBDP    WWBSDP
     C                     MOVE A6MDIN    WWBSMD
     C                     END
     C*
     C*****WRITE*HEADER*ON*LB0615P0************************************   S01498
     C*
     C***********          WRITEHEADER0                                   S01498
     C                     EXSR RCFAU                                     S01498
     C*
     C                     MOVE 'N'       WWDOR0  1
     C*
     C           #A0       ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #B        - THIS SUBROUTINE PERFORMS MAIN PROCESSING       *
     C**                                                              *
     C*****CALLS     - #BA, #BB, #BC                                  *   R01168
     C**   CALLS     - #BA, #BB, #BC, #BE                             *   R01168
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C           #B        BEGSR
     C*
     C** READ THE DEALING EVENTS DETAIL FILE
     C*
     C************LOVAL    SETLLDEALDBL1                                  S01498
     C***********          READ DEALDBL1                 74               S01498
     C/COPY WNCPYSRC,LB0615C002
     C           *LOVAL    SETLLLBDEALL1                                  S01498
     C                     READ LBDEALL1                 74               S01498
     C/COPY WNCPYSRC,LB0615C003
     C*
     C***LOOP*WHILE*NOT*AT*END*OF*DEALDBL1*****************************   S01498
     C** Loop while not at end of LBDEALL1.                               S01498
     C           *IN74     DOWEQ'0'
     C*
     C** SAVE DEFAULT PORTFOLIO EXTRACT KEY - CUSTOMER NO.
     C**********           Z-ADDCNUM      WWCNUM                                              CSD027
     C                     MOVE CNUM      WWCNUM                                              CSD027
     C*
     C***SET*OFF*CHAIN*TO*'SDLBCSL0'*INDICATOR*************************** S01498
     C** SET OFF CHAIN TO 'LBLBCSJ0' INDICATOR                            S01498
     C                     MOVE '0'       *IN25
     C*
     C** WHILE CUSTOMER NUMBER STAYS THE SAME AND NOT EOF
     C           CNUM      DOWEQWWCNUM
     C           *IN74     ANDEQ'0'
     C*
     C** SELECT ACTIVE RECORDS WITH VALUE DATE > EVENT CONTROL DATE
     C*
     C           RECI      IFEQ 'D'
     C***********VDAT      ANDGTBJDNWD                                    41978
     C           VDAT      ANDGEBJDNWD                                    41978
     C*
     C***SET*ON*CHAIN*TO*'SDLBCSL0'*INDICATOR**************************** S01498
     C** SET ON CHAIN TO 'LBLBCSJ0' INDICATOR                             S01498
     C           *IN25     IFEQ '0'
     C                     MOVE '1'       *IN25
     C*
     C** SETUP KEY FOR CHAIN (CUSTOMER NO. 6A)
     C*
     C                     MOVE CNUM      WWPNP8
     C*
     C** CHAIN PORTFOLIO LENDING CUSTOMER JOINT LOGICAL
     C*
     C***********WWPNP8    CHAINSDLBCSL0             75                   S01498
     C           WWPNP8    CHAINLBLBCSJ0             75                   S01498
     C*
     C                     END
     C*
     C** IF PORTFOLIO LENDING CUSTOMER DOES EXIST
     C           *IN75     IFEQ '0'
     C*                                                                   R01168
     C** SET OFF THE WRITE TO LBEXCOPD INDICATOR                          R01168
     C                     MOVE '0'       *IN27                           R01168
     C*
     C** IF CURRENT DEAL IS ON MATCHED DEALS ARRAY
     C           DLNO      LOKUPSMDL                     22
     C           *IN22     IFEQ '0'
     C*
     C** FOR NON-SWAP DEALS
     C***        DTYP      IFNE 'SW'                                      R0577
     C*
     C** CALCULATE FOREX CLOSED POSITION FOR NON-SWAP DEALS
     C                     EXSR #BA
     C*
     C***                  ELSE                                           R0577
     C*
     C** CALCULATE FOREX CLOSED POSITION FOR SWAP DEALS
     C***                  EXSR #BB                                       R0577
     C*
     C***                  END                                            R0577
     C*
     C                     END
     C*                                                                   R01168
     C** IF THE WRITE TO LBEXCOPD INDICATOR IS ON                         R01168
     C           *IN27     IFEQ '1'                                       R01168
     C                     EXSR #BE                                       R01168
     C                     END                                            R01168
     C*
     C***OUTPUT*DETAILS*REPORT*-*LB0615P0******************************   S01498
     C** Output details report - LB0615P1                                 S01498
     C*
     C                     EXSR #BD
     C*
     C                     END
     C*
     C                     END
     C*
     C** MAINTAIN A COUNT OF NUMBER OF RECORDS READ FROM DEALS FILE
     C                     ADD  1         RRNUMR
     C*
     C** READ NEXT RECORD FROM DEALS FILE
     C***********          READ DEALDBL1                 74               S01498
     C/COPY WNCPYSRC,LB0615C004
     C                     READ LBDEALL1                 74               S01498
     C/COPY WNCPYSRC,LB0615C005
     C*
     C                     END
     C*
     C** SHOULD A RECORD BE WRITTEN TO LBEXTRPD?
     C           *IN26     IFEQ '1'
     C*
     C***WRITE*TOTALS*-*LB0615P0***************************************   S01498
     C** Write totals - LB0615P1                                          S01498
     C*
     C                     Z-ADDWWTOT     ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0SPLT
     C*
     C           LINE1     IFGT 55
     C                     WRITEHEADER0
     C                     END
     C*
     C                     WRITETOTAL0
     C*
     C** WRITE RECORDS TO PORTFOLIO LENDING EXTRACT FILE
     C                     EXSR #BC
     C*
     C** RESET WRITE INDICATOR
     C                     MOVE '0'       *IN26
     C*
     C                     END
     C*
     C                     END
     C*
     C           #B0       ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BA       - THIS SUBROUTINE CALCULATES THE CLOSED FOREX    *
     C**               POSITION FOR NON-SWAP DEALS.                   *
     C**                                                              *
     C**   CALLS     - #BAA, #ZA                                      *
     C**                                                              *
     C**   CALLED BY - #B                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BA       BEGSR
     C*
     C** SETOF DEAL MATCHED FLAG
     C*
     C                     MOVE 'N'       WWDLMA  1
     C*
     C*
     C** ACCESS DUPLICATE DEALS DETAILS FILE WITH CNUM AND VALUE DATE
     C***********KL1       CHAINXDEALSL1             76                   S01498
     C           KL1       CHAINLBDEALL2             76                   S01498
     C*
     C** IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' - DBERROR
     C           *IN76     IFEQ '1'
     C           CHTPX     OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD5         DBASE            ***************
     C                     MOVE *BLANKS   DBFILE           *             *
     C***********          MOVEL'XDEALSL1'DBFILE           * DBERROR 005 *S01498
     C                     MOVE 'LBDEALL2'DBFILE           * DBERROR 005 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     Z-ADDVDAT      KVDAT            ***************
     C                     MOVELKYLST     DBKEY
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C*
     C** DO WHILE NOT END OF FILE & NOT MATCHED
     C           *IN76     DOWEQ'0'
     C           WWDLMA    ANDEQ'N'
     C*
     C** SELECT ONLY ACTIVE RECORDS WITH CUSTOMER NUMBER, VALUE DATE,
     C**  CURRENCIES AND AMOUNTS THE SAME AS THOSE IN THE DEALS MASTER
     C**   FILE BUT WHICH DO NOT HAVE THE SAME DEAL NUMBER AS THE
     C**    MASTER DEAL OR ARE NOT 'SWAP' DEALS.
     C           RECIX     IFEQ 'D'
     C           DLNO      ANDNEDLNOX
     C**         DTYPX     ANDNE'SW'                                      38279
     C           SLCY      ANDEQPUCYX
     C           PUCY      ANDEQSLCYX
     C*
     C           SLAM      IFEQ PUAMX
     C           PUAM      OREQ SLAMX
     C*
     C** CHECK MATCHED DEAL ARRAY FOR CURRENT DEAL NUMBER
     C           DLNOX     LOKUPSMDL                     22
     C           *IN22     IFEQ '0'
     C*
     C** CALL SUBROUTINE TO CALCULATE CLOSED FOREX POSITION
     C                     EXSR #BAA
     C*                                                                   R01168
     C** SET ON THE WRITE TO LBEXCOPD INDICATOR                           R01168
     C                     MOVE '1'       *IN27                           R01168
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C** NO NEED TO READ NEXT RECORD IF DEAL IS MATCHED
     C*
     C           WWDLMA    IFEQ 'N'
     C*
     C** IF CONDITIONS NOT MET READ NEXT RECORD
     C***********KL1       READEXDEALSL1                 76               S01498
     C           KL1       READELBDEALL2                 76               S01498
     C*
     C                     END
     C*
     C                     END
     C*
     C           #BA0      ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BAA      - THIS SUBROUTINE PERFORMS THE CALCULATIONS      *
     C**               FOR NON-SWAP DEALS.                            *
     C**                                                              *
     C**   CALLS     - #BAAA, #BAAB, #ZA                              *
     C**                                                              *
     C**   CALLED BY - #BA                                            *
     C**                                                              *
     C*****************************************************************
     C           #BAA      BEGSR
     C*
     C** INITIALISE TEMPORARY VARIABLES FOR THIS SUBROUTINE
     C                     Z-ADD*ZEROS    WWTMP1 138
     C                     Z-ADD*ZEROS    WWTMP2  50
     C                     Z-ADD*ZEROS    WWTMP3  50
     C                     Z-ADD*ZEROS    WWTMP4 188
     C                     Z-ADD*ZEROS    WWTMP5 138
     C                     Z-ADD*ZEROS    WWTMP6 130
     C                     Z-ADD*ZEROS    WWPLAM 150
     C                     Z-ADD*ZEROS    WWRAT  138
     C                     Z-ADD*ZEROS    WWPOW  159
     C*
     C** IF PUCYX RATE PROFIT/LOSS AMOUNT REQUIRED
     C           PUAM      IFEQ SLAMX
     C                     EXSR #BAAA
     C*
     C                     ELSE
     C*
     C** IF PUCY RATE PROFIT/LOSS AMOUNT REQUIRED
     C           SLAM      IFEQ PUAMX
     C                     EXSR #BAAB
     C                     END
     C*
     C                     END
     C*
     C** ADD MASTER DEAL NUMBER AS ELEMENT IN MATCHED DEALS ARRAY AND
     C** UPDATE DUPLICATE DEALS RECORDS FOR MASTER DEAL NUMBER
     C           DLNO      IFNE WWDLNO
     C                     Z-ADDDLNO      SMDL,X
     C                     ADD  1         X
     C***********DLNO      CHAINXDEALSL2             77                   S01498
     C           DLNO      CHAINLBDEALL3             77                   S01498
     C*
     C** IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' - DBERROR
     C           *IN77     IFEQ '1'
     C           CHTPY     OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD6         DBASE            ***************
     C                     MOVE *BLANKS   DBFILE           *             *
     C***********          MOVEL'XDEALSL2'DBFILE           * DBERROR 006 *S01498
     C                     MOVE 'LBDEALL3'DBFILE           * DBERROR 006 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELDLNO      DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C*
     C                     ELSE
     C*
     C                     MOVE 'C'       CHTPY
     C                     UPDATXDEALSBG
     C*
     C                     END
     C*
     C                     Z-ADDDLNO      WWDLNO
     C*
     C                     END
     C*
     C** SAVE DUPLICATE DEAL NO FOR USE ON REPORT
     C*
     C                     Z-ADDDLNOX     WWRLDN
     C*
     C** ADD CURRENT DUPLICATE DEAL NUMBER TO MATCHED DEAL ARRAY
     C                     Z-ADDDLNOX     SMDL,X
     C                     ADD  1         X
     C*
     C** UPDATE DUPLICATE DEALS FILE FOR DUPLICATE DEAL NUMBER
     C                     MOVE 'C'       CHTPX
     C                     UPDATXDEALSBF
     C*
     C** SETON DEAL MATCHED FLAG
     C*
     C                     MOVE 'Y'       WWDLMA
     C*
     C           #BAA0     ENDSR
     ******************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BAAA        - THIS SUBROUTINE CALCULATES THE PUCYX       *
     C**                   CURRENCY RATE AND THE RESULTING PROFIT/    *
     C**                   LOSS AMOUNT AND UPDATES FILES, ARRAYS      *
     C**                   AND TOTALS ACCORDINGLY.                    *
     C**                                                              *
     C**    CALLS        - #YA, SCONV                                 *
     C**                                                              *
     C**    CALLED BY    - #BAA                                       *
     C**                                                              *
     C*****************************************************************
     C           #BAAA     BEGSR
     C*
     C** CHECK CURRENT ARRAYS ARE FILLED FROM PUCYX AND IF NOT FILL
     C** FORWARD ARRAYS FOR THIS CURRENCY
     C           PUCYX     IFNE WWCCY
     C                     MOVE PUCYX     WWCCY
     C                     EXSR #YA
     C                     END
     C* R0102/START                                                       R0102
     C                     MOVE XXPMRT    WWPMRT  1                       R0102
     C**   IF PURCHASE CCY IS NOT A PRECIOUS METAL, CHECK IF SALE         R0102
     C**   CCY IS ONE.                                                    R0102
     C           WWPMRT    IFNE 'Y'                                       R0102
     C           S01433    ANDEQ'Y'                                       087631
     C***********SLCYX     CHAINSDCURRX0             73            R0102  S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM SLCYX     @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*                                                                   R0102
     C**   IF RECORD NOT FOUND THEN DB ERROR                              R0102
     C*                                                                   R0102
     C************IN73     IFEQ '1'                                R0102  S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD16        DBASE            ***************R0102
     C***********          MOVEL'SDCURRX0'DBFILE           * DBERR R0102  S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 016 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *R0102
     C                     MOVELSLCYX     DBKEY            ***************R0102
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R0102
     C                     ELSE                                           R0102
     C*                                                                   R0102
     C**   SAVE PRECIOUS METAL INDICATOR                                  R0102
     C*                                                                   R0102
     C***********          MOVE CYPMRT    WWPMRT  1                R0102  S01498
     C                     MOVE A6PMRT    WWPMRT  1                       S01498
     C                     END                                            R0102
     C                     END                                            R0102
     C*
     C** LOOK UP DATE ARRAY FOR VALUE DATE
     C           VDAT      LOKUPDAT,Y                    23
     C*
     C** IF VALUE DATE DOES NOT MATCH A DATE IN THE DATE ARRAY
     C           *IN23     IFEQ '0'
     C                     Z-ADD1         N
     C           VDAT      DOWGTDAT,N
     C           N         ANDLTWWLAST
     C                     ADD  1         N
     C                     END
     C           N         SUB  1         M
     C*
     C** IF DATE BETWEEN TWO DATES ON ARRAY
     C           VDAT      IFLT DAT,N
     C*
     C** USE TEMPORARY VARIABLES TO CALCULATE RATE
     C           RAT,N     SUB  RAT,M     WWTMP1
     C           VDAT      SUB  DAT,M     WWTMP2
     C           DAT,N     SUB  DAT,M     WWTMP3
     C           WWTMP1    MULT WWTMP2    WWTMP4
     C           WWTMP4    DIV  WWTMP3    WWTMP5
     C           RAT,M     ADD  WWTMP5    WWRAT
     C*
     C                     ELSE
     C*
     C** IF VALUE DATE AFTER LAST DATE IN ARRAY
     C                     MOVE RAT,N     WWRAT
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C** VALUE DATE MATCHES A DATE IN THE ARRAY
     C                     Z-ADDRAT,Y     WWRAT
     C*
     C                     END
     C*
     C** IF NO RATE RETRIEVED FROM FORWARD RATES FILE USE SPOT RATE
     C           WWRAT     IFEQ *ZEROS
     C                     Z-ADDWWSPRT    WWRAT
     C                     END
     C*
     C** CALCULATE REFERENCE NUMBER FOR POWER ARRAY
     C**         WWDECP    SUB  WWBSDP    K       10                      B08154
     C           WWBSDP    SUB  WWDECP    K       10                      B08154
     C           K         ADD  4         K
     C*
     C** CALCULATE PROFIT/LOSS AMOUNT
     C           WWMDIV    IFEQ 'M'
     C           SLAM      SUB  PUAMX     WWTMP6
     C*******    WWRAT     MULT WWTMP6    WWPLAM                          LB0000
     C*
     C** APPLY POWER OF 10
     C*******    WWRAT     DIV  POWER,K   WWPOW                           LB0000
     C           WWRAT     MULT POWER,K   WWPOW
     C*******              MULT WWPOW     WWPLAM                          LB0000
     C           WWTMP6    MULT WWPOW     WWPLAM    H                     LB0000
     C*
     C                     ELSE
     C*
     C           SLAM      SUB  PUAMX     WWTMP6
     C*******    WWTMP6    DIV  WWRAT     WWPLAM                          LB0000
     C*
     C** APPLY POWER OF 10
     C           WWRAT     MULT POWER,K   WWPOW
     C*******              DIV  WWPOW     WWPLAM                          LB0000
     C           WWTMP6    DIV  WWPOW     WWPLAM    H                     LB0000
     C*
     C                     END
     C*
     C** CONVERT P/L AMOUNT FROM BASE CURRENCY TO PORTFOLIO CURRENCY
     C                     MOVE WWBSMD    WWMDI
     C                     Z-ADDWWBSDP    WWDPI
     C                     Z-ADDWWBSSR    WWSRI
     C                     Z-ADDWWPLAM    WWAMTI
     C                     EXSR SCONV
     C*
     C** ACCUMULATE RUNNING TOTAL
     C                     ADD  WWAMTO    WWTOT
     C*LB2000/START
     C***        WWAMTO    IFLT 0                                         LB0000
     C***                  SUB  WWAMTO    WWTEXP                          LB0000
     C***                  ELSE                                           LB0000
     C***                  ADD  WWAMTO    WWTCOL                          LB0000
     C***                  END                                            LB0000
     C*                                                                   LB0000
B1   C           WWAMTO    IFLT 0                                         LB0000
     C*                                                                   LB0000
B2   C           WWPMRT    IFEQ 'N'                                       LB0000
     C           S01433    ORNE 'Y'                                       087631
     C                     SUB  WWAMTO    WWTEXP                          LB0000
X2   C                     ELSE                                           LB0000
     C                     SUB  WWAMTO    WWPEXP                          LB0000
B2   C                     END                                            LB0000
X1   C                     ELSE                                           LB0000
     C*                                                                   LB0000
B2   C           WWPMRT    IFEQ 'N'                                       LB0000
     C           S01433    ORNE 'Y'                                       087631
     C                     ADD  WWAMTO    WWTCOL                          LB0000
X2   C                     ELSE                                           LB0000
     C                     ADD  WWAMTO    WWPCOL                          LB0000
E2   C                     END                                            LB0000
     C*                                                                   LB0000
E1   C                     END                                            LB0000
     C*LB2000/END
     C*
     C** SET ON WRITE RECORD INDICATOR
     C                     MOVE '1'       *IN26
     C*
     C           #BAAA0    ENDSR
     ******************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BAAB        - THIS SUBROUTINE CALCULATES THE PUCY        *
     C**                   CURRENCY RATE AND THE RESULTING PROFIT/    *
     C**                   LOSS AMOUNT AND UPDATES FILES, ARRAYS      *
     C**                   AND TOTALS ACCORDINGLY.                    *
     C**                                                              *
     C**    CALLS        - #YA                                        *
     C**                                                              *
     C**    CALLED BY    - #BAA                                       *
     C**                                                              *
     C*****************************************************************
     C           #BAAB     BEGSR
     C*
     C** CHECK CURRENT ARRAYS ARE FILLED FROM PUCY AND IF NOT FILL
     C** FORWARD ARRAYS FOR THIS CURRENCY
     C           PUCY      IFNE WWCCY
     C                     MOVE PUCY      WWCCY
     C                     EXSR #YA
     C                     END
     C* R0102/START                                                       R0102
     C                     MOVE XXPMRT    WWPMRT  1                       R0102
     C**   IF PURCHASE CCY IS NOT A PRECIOUS METAL, CHECK IF SALE         R0102
     C**   CCY IS ONE.                                                    R0102
     C           WWPMRT    IFNE 'Y'                                       R0102
     C           S01433    ANDEQ'Y'                                       087631
     C***********SLCY      CHAINSDCURRX0             73            R0102  S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM SLCY      @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*                                                                   R0102
     C**   IF RECORD NOT FOUND THEN DB ERROR                              R0102
     C*                                                                   R0102
     C************IN73     IFEQ '1'                                R0102  S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD16        DBASE            ***************R0102
     C***********          MOVEL'SDCURRX0'DBFILE           * DBERR R0102  S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 016 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *R0102
     C                     MOVELSLCY      DBKEY            ***************R0102
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R0102
     C                     ELSE                                           R0102
     C*                                                                   R0102
     C**   SAVE PRECIOUS METAL INDICATOR                                  R0102
     C*                                                                   R0102
     C***********          MOVE CYPMRT    WWPMRT  1                R0102  S01498
     C                     MOVE A6PMRT    WWPMRT  1                       S01498
     C                     END                                            R0102
     C                     END                                            R0102
     C*
     C** LOOK UP DATE ARRAY FOR VALUE DATE
     C           VDAT      LOKUPDAT,Y                    23
     C*
     C** IF VALUE DATE DOES NOT MATCH A DATE IN THE DATE ARRAY
     C           *IN23     IFEQ '0'
     C                     Z-ADD1         N
     C           VDAT      DOWGTDAT,N
     C           N         ANDLTWWLAST
     C                     ADD  1         N
     C                     END
     C           N         SUB  1         M
     C*
     C** IF DATE BETWEEN TWO DATES ON ARRAY
     C           VDAT      IFLT DAT,N
     C*
     C** USE TEMPORARY VARIABLES TO CALCULATE RATE
     C           RAT,N     SUB  RAT,M     WWTMP1
     C           VDAT      SUB  DAT,M     WWTMP2
     C           DAT,N     SUB  DAT,M     WWTMP3
     C           WWTMP1    MULT WWTMP2    WWTMP4
     C           WWTMP4    DIV  WWTMP3    WWTMP5
     C           RAT,M     ADD  WWTMP5    WWRAT
     C*
     C                     ELSE
     C*
     C** IF VALUE DATE AFTER LAST DATE IN ARRAY
     C                     MOVE RAT,N     WWRAT
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C** VALUE DATE MATCHES A DATE IN THE ARRAY
     C                     Z-ADDRAT,Y     WWRAT
     C*
     C                     END
     C*
     C** IF NO RATE RETRIEVED FROM FOWARD RATES FILE USE SPOT RATE
     C           WWRAT     IFEQ *ZEROS
     C                     Z-ADDWWSPRT    WWRAT
     C                     END
     C*
     C** CALCULATE REFERENCE NUMBER FOR POWER ARRAY
     C**         WWDECP    SUB  WWBSDP    K                               B08154
     C           WWBSDP    SUB  WWDECP    K                               B08154
     C           K         ADD  4         K
     C*
     C** CALCULATE PROFIT/LOSS AMOUNT
     C           WWMDIV    IFEQ 'M'
     C           SLAMX     SUB  PUAM      WWTMP6
     C***********WWRAT     MULT WWTMP6    WWPLAM                          LB0000
     C*
     C** APPLY POWER OF 10
     C***********WWRAT     DIV  POWER,K   WWPOW                           LB0000
     C           WWRAT     MULT POWER,K   WWPOW                           LB0000
     C***********          MULT WWPOW     WWPLAM                          LB0000
     C           WWTMP6    MULT WWPOW     WWPLAM    H                     LB0000
     C*
     C                     ELSE
     C*
     C           SLAMX     SUB  PUAM      WWTMP6
     C***********WWTMP6    DIV  WWRAT     WWPLAM                          LB0000
     C*
     C** APPLY POWER OF 10
     C           WWRAT     MULT POWER,K   WWPOW
     C***********          DIV  WWPOW     WWPLAM                          LB0000
     C           WWTMP6    DIV  WWPOW     WWPLAM    H                     LB0000
     C*
     C                     END
     C*
     C** CONVERT P/L AMOUNT FROM BASE CURRENCY TO PORTFOLIO CURRENCY
     C                     MOVE WWBSMD    WWMDI
     C                     Z-ADDWWBSDP    WWDPI
     C                     Z-ADDWWBSSR    WWSRI
     C                     Z-ADDWWPLAM    WWAMTI
     C                     EXSR SCONV
     C*
     C** ACCUMULATE RUNNING TOTAL
     C                     ADD  WWAMTO    WWTOT
     C*LB2000/START
     C***        WWAMTO    IFLT 0                                         LB0000
     C***                  SUB  WWAMTO    WWTEXP                          LB0000
     C***                  ELSE                                           LB0000
     C***                  ADD  WWAMTO    WWTCOL                          LB0000
     C***                  END                                            LB0000
     C*                                                                   LB0000
B1   C           WWAMTO    IFLT 0                                         LB0000
     C*                                                                   LB0000
B2   C           WWPMRT    IFEQ 'N'                                       LB0000
     C           S01433    ORNE 'Y'                                       087631
     C                     SUB  WWAMTO    WWTEXP                          LB0000
X2   C                     ELSE                                           LB0000
     C                     SUB  WWAMTO    WWPEXP                          LB0000
B2   C                     END                                            LB0000
X1   C                     ELSE                                           LB0000
     C*                                                                   LB0000
B2   C           WWPMRT    IFEQ 'N'                                       LB0000
     C           S01433    ORNE 'Y'                                       087631
     C                     ADD  WWAMTO    WWTCOL                          LB0000
X2   C                     ELSE                                           LB0000
     C                     ADD  WWAMTO    WWPCOL                          LB0000
E2   C                     END                                            LB0000
     C*                                                                   LB0000
E1   C                     END                                            LB0000
     C*LB2000/END
     C*
     C** SET ON WRITE RECORD INDICATOR
     C                     MOVE '1'       *IN26
     C*
     C           #BAAB0    ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BB          - THIS SUBROUTINE CALCULATES CLOSED FOREX    *
     C**                   POSITION FOR SWAP DEALS.                   *
     C**                                                              *
     C**    CALLS        - #ZA, SCONV                                 *
     C**                                                              *
     C**    CALLED BY    - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BB       BEGSR
     C*
     C***********SPLC      CHAINSDCURRL1             73                   S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM SPLC      @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR
     C*
     C************IN73     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD7         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 007 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 007 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELSPLC      DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C*LB2000/START
     C*****ACCESS*CURRENCY*EXTENDED*FILE**********************************087631
     C***********                                                         087631
     C***********SPLC      CHAINSDCURRX0             73             S01498087631
     C***********                                                   S01498087631
     C***********          CALL 'AOCURRR0'                          S01498087631
     C***********          PARM '*MSG   ' @RTCD   7                 S01498087631
     C***********          PARM '*KEY   ' @OPTN   7                 S01498087631
     C***********          PARM SPLC      @CYCD   3                 S01498087631
     C***********@CURR     PARM @CURR     DSSDY                     S01498087631
     C***********                                                         087631
     C*****IF*RECORD*NOT*FOUND*OR*LAST*CHANGE*TYPE*='D'*THEN*DB*ERROR*****087631
     C***********                                                         087631
B2   C************IN73     IFEQ '1'                                       S01498
     C***********@RTCD     IFNE *BLANK                              S01498087631
     C************LOCK     IN   LDA                                 S01498087631
     C***********          Z-ADD15        DBASE            ***************087631
     C***********          MOVEL'SDCURRX0'DBFILE           * DBERROR 015 *S01498
     C***********          MOVE 'SDCURRPD'DBFILE        *DBERROR015*S01498087631
     C***********          MOVE *BLANKS   DBKEY            *             *087631
     C***********          MOVELSPLC      DBKEY            ***************087631
     C***********          OUT  LDA                                 S01498087631
     C***********          EXSR #ZA                                       087631
X2   C***********          ELSE                                           087631
     C*
     C**   SAVE PRECIOUS METAL INDICATOR
     C*
     C***********          MOVE CYPMRT    WWPMRT  1                       S01498
     C                     MOVE A6PMRT    WWPMRT  1                       S01498
E2   C***********          END                                            087631
     C*LB2000/END
     C*
     C**   SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C**   FOR ROUTINE SCONV
     C*
     C                     Z-ADDA6SPRT    WWSRI
     C                     Z-ADDA6NBDP    WWDPI
     C                     MOVE A6MDIN    WWMDI
     C                     END
     C*
     C**  CONVERT P/L AMOUNT FROM SWAP CCY TO PORTFOLIO CCY
     C                     Z-ADDSPLA      WWAMTI
     C                     EXSR SCONV
     C*
     C** ACCUMULATE RUNNING TOTAL
     C                     ADD  WWAMTO    WWTOT
     C*LB2000/START
     C***        WWAMTO    IFLT 0                                         LB0000
     C***                  SUB  WWAMTO    WWTEXP                          LB0000
     C***                  ELSE                                           LB0000
     C***                  ADD  WWAMTO    WWTCOL                          LB0000
     C***                  END                                            LB0000
     C*                                                                   LB0000
B1   C           WWAMTO    IFLT 0                                         LB0000
     C*                                                                   LB0000
B2   C           WWPMRT    IFEQ 'N'                                       LB0000
     C           S01433    ORNE 'Y'                                       087631
     C                     SUB  WWAMTO    WWTEXP                          LB0000
X2   C                     ELSE                                           LB0000
     C                     SUB  WWAMTO    WWPEXP                          LB0000
B2   C                     END                                            LB0000
X1   C                     ELSE                                           LB0000
     C*                                                                   LB0000
B2   C           WWPMRT    IFEQ 'N'                                       LB0000
     C           S01433    ORNE 'Y'                                       087631
     C                     ADD  WWAMTO    WWTCOL                          LB0000
X2   C                     ELSE                                           LB0000
     C                     ADD  WWAMTO    WWPCOL                          LB0000
E2   C                     END                                            LB0000
     C*                                                                   LB0000
E1   C                     END                                            LB0000
     C*LB2000/END
     C*
     C** SET ON WRITE RECORD INDICATOR
     C                     MOVE '1'       *IN26
     C*
     C** ADD MASTER DEAL NUMBER AS ELEMENT IN MATCHED DEALS ARRAY AND
     C** UPDATE DUPLICATE DEALS RECORDS FOR MASTER DEAL NUMBER
     C           DLNO      IFNE WWDLNO
     C                     Z-ADDDLNO      SMDL,X
     C                     ADD  1         X
     C***********DLNO      CHAINXDEALSL2             77                   S01498
     C           DLNO      CHAINLBDEALL3             77                   S01498
     C*
     C** IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' - DBERROR
     C           *IN77     IFEQ '1'
     C           CHTPY     OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD8         DBASE            ***************
     C                     MOVE *BLANKS   DBFILE           *             *
     C***********          MOVEL'XDEALSL2'DBFILE           * DBERROR 008 *S01498
     C                     MOVE 'LBDEALL3'DBFILE           * DBERROR 008 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELDLNO      DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C*
     C                     ELSE
     C*
     C                     MOVE 'C'       CHTPY
     C                     UPDATXDEALSBG
     C*
     C                     END
     C*
     C                     Z-ADDDLNO      WWDLNO
     C*
     C                     END
     C*
     C** SAVE SWOP OPTION DEAL NO FOR USE ON REPORT
     C*
     C                     Z-ADDSODN      WWRLDN
     C*
     C** ADD CURRENT SWAP OPTION DEAL AS ELEMENT IN SMDL ARRAY AND
     C** UPDATE DUPLICATE DEALS RECORDS FOR SWAP OPTION DEAL NUMBER
     C           SODN      IFNE WWSODN
     C                     Z-ADDSODN      SMDL,X
     C                     ADD  1         X
     C***********SODN      CHAINXDEALSL2             77                   S01498
     C           SODN      CHAINLBDEALL3             77                   S01498
     C*
     C** IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' - DBERROR
     C           *IN77     IFEQ '1'
     C           CHTPY     OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD9         DBASE            ***************
     C                     MOVE *BLANKS   DBFILE           *             *
     C***********          MOVEL'XDEALSL2'DBFILE           * DBERROR 009 *S01498
     C                     MOVE 'LBDEALL3'DBFILE           * DBERROR 009 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELSODN      DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C*
     C                     ELSE
     C*
     C                     MOVE 'C'       CHTPY
     C                     UPDATXDEALSBG
     C*
     C                     END
     C*
     C                     Z-ADDSODN      WWSODN
     C*
     C                     END
     C*
     C           #BB0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BC          - THIS SUBROUTINE WRITES RECORDS TO PORTFOLIO*
     C**                   EXTRACT FILE.                              *
     C**                                                              *
     C**    CALLS        - #ZA                                        *
     C**                                                              *
     C**    CALLED BY    - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BC       BEGSR
     C*
     C** SET UP EXPOSURE AND COLLATERAL FOR PROFIT/LOSS
     C***********WWTOT*****IFGE *ZEROS                                    LB0000
     C*******              Z-ADD*ZEROS    EEEXPS                          LB0000
     C*******              Z-ADDWWTOT     EECOLL                          LB0000
     C**************       Z-ADDWWTOT     EEEXPS                          LB0000
     C**************       Z-ADD*ZEROS    EECOLL                          LB0000
     C*********************Z-ADD*ZEROS    EEEXPS                          LB0000
     C*********************Z-ADDWWTOT     EECOLL                          LB0000
     C*********************ELSE                                           LB0000
     C*******              Z-SUBWWTOT     EEEXPS                          LB0000
     C*******              Z-ADD*ZEROS    EECOLL                          LB0000
     C**************       Z-ADD*ZEROS    EEEXPS                          LB0000
     C**************       Z-SUBWWTOT     EECOLL                          LB0000
     C*********************Z-SUBWWTOT     EEEXPS                          LB0000
     C*********************Z-ADD*ZEROS    EECOLL                          LB0000
     C*********************END                                            LB0000
     C*                                                                   LB0000
     C           WWTEXP    IFGT 0                                         LB0000
     C                     Z-ADDWWTEXP    EEEXPS                          LB0000
     C                     ELSE                                           LB0000
     C                     Z-ADD0         EEEXPS                          LB0000
     C                     END                                            LB0000
     C*                                                                   LB0000
     C           WWTCOL    IFGT 0                                         LB0000
     C                     Z-ADDWWTCOL    EECOLL                          LB0000
     C                     ELSE                                           LB0000
     C                     Z-ADD0         EECOLL                          LB0000
     C                     END                                            LB0000
     C*                                                                   LB0000
     C**   IF COLLATERAL NOT ZERO - RETRIEVE BORROWING POWER PERCENTAGE   LB0000
     C*                                                                   LB0000
B1   C*******    WWTOT     IFGT *ZEROS                                    LB0000
B1   C           WWTCOL    IFGT *ZEROS                                    LB0000
     C*                                                                   LB0000
     C**   ACCESS LBBPWRL3 TO RETREIVE INSTRUMENT PERCENTAGE              LB0000
     C*                                                                   LB0000
     C           LBFXPL    CHAINLBBPWRL3             32                   LB0000
     C*                                                                   LB0000
B2   C           *IN32     IFEQ '0'                                       LB0000
     C           BPINPC    ANDNE*ZEROS                                    LB0000
     C*                                                                   LB0000
     C                     Z-ADDBPINPC    WWBPPC                          LB0000
     C*                                                                   LB0000
X2   C                     ELSE                                           LB0000
     C*                                                                   LB0000
     C**   ACCESS LBBPWRL3 TO RETREIVE CLIENT PERCENTAGE                  LB0000
     C*                                                                   LB0000
     C           WWBPK1    CHAINLBBPWRL1             31                   LB0000
     C*                                                                   LB0000
B3   C           *IN32     IFEQ '0'                                       LB0000
     C           BPINPC    ANDNE*ZEROS                                    LB0000
     C*                                                                   LB0000
     C                     Z-ADDBPINPC    WWBPPC                          LB0000
     C*                                                                   LB0000
X3   C                     ELSE                                           LB0000
     C*                                                                   LB0000
     C                     Z-ADD100       WWBPPC                          LB0000
     C*                                                                   LB0000
E3   C                     END                                            LB0000
     C*                                                                   LB0000
E2   C                     END                                            LB0000
     C*                                                                   LB0000
E1   C                     END                                            LB0000
     C*                                                                   LB0000
     C** ACCESS INSTRUMENT TYPES FILE FOR PORTFOLIO LENDING GROUP
     C***********LBFXPL    CHAINSDPLINL4             78                   S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBFXPL    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN78     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD10        DBASE            ***************
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 010 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 010 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBFXPL    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE PDCSHI    EECIFL
     C                     END
     C*
     C** ACCESS PORTFOLIO LENDING GROUPS FILE FOR PORTFOLIO LENDING GROUP
     C**  AND PORTFOLIO LENDING SEQUENCE
     C***********PDLOMG    CHAINLBGROUL1             79                   S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN79     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD11        DBASE            ***************
     C***********          MOVEL'LBGROUL1'DBFILE           *             *S01498
     C                     MOVE 'LBGROUPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            * DBERROR 011 *
     C                     MOVELPDLOMG    DBKEY            *             *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
     C                     ELSE
     C                     MOVE GPLCGR    EELCGR
     C                     MOVE GPLCGS    EELCGS
     C                     END
     C*
     C** FORMAT REMAINING FIELDS
     C                     MOVE 'D'       EERECI
     C**********           Z-ADDWWCNUM    EECNUM                                              CSD027
     C                     MOVE WWCNUM    EECNUM                                              CSD027
     C                     MOVE LBFXPL    EEINST
     C***********          MOVE LBCCY     EECCY                           S01498
     C                     MOVE LBCYCD    EECCY                           S01498
     C                     Z-ADD*ZEROS    EELIMT
     C                     Z-ADD*ZEROS    EEACCD
     C                     Z-ADD*ZEROS    EEACCC
     C                     MOVE *BLANKS   EESESN
     C                     Z-ADD*ZEROS    EECLPC
     C                     Z-ADD*ZEROS    EESEPC
     C**                   Z-ADD*ZEROS    EEINPC                          B4813
     C                     Z-ADDWWBPPC    EEINPC                          B4813
     C                     Z-ADD*ZEROS    EECTPC
     C*******              Z-ADD*ZEROS    EEBPWR                          LB0000
     C           EECOLL    MULT WWBPPC    EEBPWR
     C                     DIV  100       EEBPWR
     C                     MOVE BBPCNB    EEPCNB
     C                     Z-ADDBJDNWD    EEORED
     C                     Z-ADDBJDNWD    EELCD
     C                     TIME           EETLUP
     C                     Z-ADDWWDAY     EEDLUP
     C                     MOVE WWMNTH    EEMLUP
     C                     Z-ADDWWYEAR    EEYLUP
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         RRRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C*                                                                   R00125
     C** REINITIALISE OUTPUT FIEDLS (NOT DONE WHEN WWPEXP AND WWPCOL      R00125
     C** EQUAL TO ZERO)                                                   R00125
     C                     Z-ADD0         EEEXPS                          R00125
     C                     Z-ADD0         EECOLL                          R00125
     C*
     C*LB2000/START
     C           S01433    IFEQ 'Y'                                       087631
B1   C           WWPEXP    IFNE 0
     C           WWPCOL    ORNE 0
     C*
B2   C           WWPEXP    IFGT 0
     C                     Z-ADDWWPEXP    EEEXPS
     C                     ELSE
     C                     Z-ADD0         EEEXPS
E2   C                     END
     C*
B2   C           WWPCOL    IFGT 0
     C                     Z-ADDWWPCOL    EECOLL
     C                     ELSE
     C                     Z-ADD0         EECOLL
E2   C                     END
     C*
     C**   IF COLLATERAL NOT ZERO - RETRIEVE BORROWING POWER PERCENTAGE
     C*
B2   C           WWPCOL    IFGT *ZEROS
     C*
     C**   ACCESS LBBPWRL3 TO RETREIVE INSTRUMENT PERCENTAGE
     C*
     C           LBPMPL    CHAINLBBPWRL3             32
     C*
B3   C           *IN32     IFEQ '0'
     C           BPINPC    ANDNE*ZEROS
     C*
     C                     Z-ADDBPINPC    WWBPPC
     C*
X3   C                     ELSE
     C*
     C**   ACCESS LBBPWRL3 TO RETREIVE CLIENT PERCENTAGE
     C*
     C           WWBPK2    CHAINLBBPWRL1             31
     C*
B4   C           *IN32     IFEQ '0'
     C           BPINPC    ANDNE*ZEROS
     C*
     C                     Z-ADDBPINPC    WWBPPC
     C*
X4   C                     ELSE
     C*
     C                     Z-ADD100       WWBPPC
     C*
E4   C                     END
     C*
E3   C                     END
     C*
E2   C                     END
     C*
     C** ACCESS INSTRUMENT TYPES FILE FOR PORTFOLIO LENDING GROUP
     C***********LBPMPL    CHAINSDPLINL4             78                   S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBPMPL    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN78     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD17        DBASE            ***************
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 017 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 017 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBPMPL    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE PDCSHI    EECIFL
     C                     END
     C*
     C** ACCESS PORTFOLIO LENDING GROUPS FILE FOR PORTFOLIO LENDING GROUP
     C**  AND PORTFOLIO LENDING SEQUENCE
     C***********PDLOMG    CHAINLBGROUL1             79                   S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN79     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD18        DBASE            ***************
     C***********          MOVEL'LBGROUL1'DBFILE           *             *S01498
     C                     MOVE 'LBGROUPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            * DBERROR 018 *
     C                     MOVELPDLOMG    DBKEY            *             *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
     C                     ELSE
     C                     MOVE GPLCGR    EELCGR
     C                     MOVE GPLCGS    EELCGS
     C                     END
     C*
     C** FORMAT REMAINING FIELDS
     C                     MOVE 'D'       EERECI
     C**********           Z-ADDWWCNUM    EECNUM                                              CSD027
     C                     MOVE WWCNUM    EECNUM                                              CSD027
     C                     MOVE LBPMPL    EEINST
     C***********          MOVE LBCCY     EECCY                           S01498
     C                     MOVE LBCYCD    EECCY                           S01498
     C                     Z-ADD*ZEROS    EELIMT
     C                     Z-ADD*ZEROS    EEACCD
     C                     Z-ADD*ZEROS    EEACCC
     C                     MOVE *BLANKS   EESESN
     C                     Z-ADD*ZEROS    EECLPC
     C                     Z-ADD*ZEROS    EESEPC
     C**                   Z-ADD*ZEROS    EEINPC                          R5519
     C                     Z-ADDWWBPPC    EEINPC                          R5519
     C                     Z-ADD*ZEROS    EECTPC
     C           EECOLL    MULT WWBPPC    EEBPWR
     C                     DIV  100       EEBPWR
     C                     MOVE BBPCNB    EEPCNB
     C                     Z-ADDBJDNWD    EEORED
     C                     Z-ADDBJDNWD    EELCD
     C                     TIME           EETLUP
     C                     Z-ADDWWDAY     EEDLUP
     C                     MOVE WWMNTH    EEMLUP
     C                     Z-ADDWWYEAR    EEYLUP
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         RRRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C*
E1   C                     END
     C                     END                                            087631
     C*LB2000/END
     C*
     C** INITIALISE WWTOT TO ZERO FOR NEXT CUSTOMER NUMBER
     C                     Z-ADD*ZEROS    WWTOT
     C                     Z-ADD*ZEROS    WWTEXP                          LB0000
     C                     Z-ADD*ZEROS    WWTCOL                          LB0000
     C                     Z-ADD*ZEROS    WWPEXP                          R00125
     C                     Z-ADD*ZEROS    WWPCOL                          R00125
     C*
     C           #BC0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BD       - THIS SUBROUTINE OUTPUTS THE FOREX CLOSED       *
     C**               POSITION REGENERATION DETAILS REPORT           *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #B                                             *
     C**                                                              *
     C*****************************************************************
     C           #BD       BEGSR
     C*
     C***********LINE1     IFGT 55                                        S01498
     C***********          WRITEHEADER0                                   S01498
     C***********          END                                            S01498
     C                     MOVE CNUM      R0CNUM
     C                     MOVE DLNO      R0DLNO
     C                     MOVE DTYP      R0DTYP
     C                     MOVE DLST      R0DLST
     C                     MOVE PUCY      R0PCCY
      *                                                                   R0590
      ** TAKE NUMBERS OF DECIMAL PLACES.                                  R0590
      *                                                                   R0590
     C                     MOVE PUCY      XCCY    3                       R0590
     C                     EXSR R0590                                     R0590
     C*
     C                     Z-ADDPUAM      ZFLD15
     C                     Z-ADDWWDPI     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0PAMT
     C*
     C                     MOVE SLCY      R0SCCY
      *                                                                   R0590
      ** TAKE NUMBERS OF DECIMAL PLACES.                                  R0590
      *                                                                   R0590
     C                     MOVE SLCY      XCCY    3                       R0590
     C                     EXSR R0590                                     R0590
     C*
     C*
     C                     Z-ADDSLAM      ZFLD15
     C                     Z-ADDWWDPI     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0SAMT
     C*
     C*  SHOW P/L IN ORIGINAL CURRENCY
     C**                   Z-ADDWWAMTI    ZFLD15                          B08154
     C**                   Z-ADDWWDPI     ZDECS                           B08154
     C                     Z-ADDWWTMP6    ZFLD15                          B08154
     C                     Z-ADDWWDECP    ZDECS                           B08154
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0SPLA
     C*
     C                     Z-ADDWWAMTO    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0SPL2
     C*
     C           WWRLDN    IFEQ *ZEROS
     C                     MOVE *BLANKS   R0RLDN
     C                     ELSE
     C                     MOVE WWRLDN    R0RLDN
     C                     END
     C*
     C***********DLNO      CHAINXDEALSL2             77                   S01498
     C           DLNO      CHAINLBDEALL3             77                   S01498
     C*
     C** IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' - DBERROR
     C           *IN77     IFEQ '1'
     C           CHTPY     OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD13        DBASE            ***************
     C                     MOVE *BLANKS   DBFILE           *             *
     C***********          MOVEL'XDEALSL2'DBFILE           * DBERROR 013 *S01498
     C                     MOVE 'LBDEALL3'DBFILE           * DBERROR 013 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELDLNO      DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C*
     C                     ELSE
     C*
     C                     MOVE CHTPY     R0CHTP
     C*
     C**   RELEASE RECORD
     C                     UPDATXDEALSBG
     C*
     C                     END
     C*
     C           R0CHTP    IFEQ 'C'                                       B4813
     C*                                                                   S01498
     C**  Open LB0615P1.                                                  S01498
     C*                                                                   S01498
     C           *IN41     IFEQ '0'                                       S01498
     C                     OPEN LB0615P1                                  S01498
     C                     EXSR RCFP1                                     S01498
     C                     WRITEHEADER0                                   S01498
     C                     SETON                     41                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           LINE1     IFGT 55                                        S01498
     C                     WRITEHEADER0                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEDETAIL0
     C                     END                                            B4813
     C*
     C                     MOVE 'Y'       WWDOR0
     C*
     C                     Z-ADD*ZEROS    WWTMP6                          37511
     C******************** Z-ADD*ZEROS    WWDECP                    37511 043052
     C                     Z-ADD*ZEROS    WWAMTI
     C                     Z-ADD*ZEROS    WWAMTO
     C                     Z-ADD*ZEROS    WWRLDN
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BE          - THIS SUBROUTINE WRITES RECORDS TO NEW      *   R01168
     C**                   EXTRACT FILE LBEXCOPD                      *   R01168
     C**                                                              *   R01168
     C**    CALLS        - #BEA #BEB                                  *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #B                                         *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BE       BEGSR                                          R01168
     C*                                                                   R01168
     C** SET UP FIELDS FOR THE ORIGINAL DEAL                              R01168
     C           WWPMRT    IFEQ 'Y'                                       R01168
     C           S01433    ANDEQ'Y'                                       087631
     C                     MOVE LBPMPL    WWINST                          R01168
     C                     ELSE                                           R01168
     C                     MOVE LBFXPL    WWINST                          R01168
     C                     END                                            R01168
     C                     MOVE WWRLDN    WWRLDX                          R01168
     C*                                                                   R01168
     C** ACCESS INSTRUMENT TYPES FILE TO GET PORTFOLIO LENDING GROUP      R01168
     C***********WWINST    CHAINSDPLINL4             78            R01168 S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWINST    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   R01168
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'   R01168
     C*                                                                   R01168
     C************IN78     IFEQ '1'                                R01168 S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'                                       R01168
     C           PDCHTP    OREQ 'D'                                       R01168
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD19        DBASE            ***************R01168
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERR R01168 S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 019 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *R01168
     C***********          MOVELLBFXPL    DBKEY            *********R01168087631
     C                     MOVELWWINST    DBKEY            ***************087631
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C** ACCESS GROUPS FILE TO GET PORTFOLIO GROUP CODE AND GROUP         R01168
     C** SEQUENCE                                                         R01168
     C***********PDLOMG    CHAINLBGROUL1             79            R01168 S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   R01168
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'   R01168
     C*                                                                   R01168
     C************IN79     IFEQ '1'                                R01168 S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'                                       R01168
     C           GPCHTP    OREQ 'D'                                       R01168
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD20        DBASE            ***************R01168
     C***********          MOVEL'LBGROUL1'DBFILE           *       R01168 S01498
     C                     MOVE 'LBGROUPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            * DBERROR 020 *R01168
     C                     MOVELPDLOMG    DBKEY            *             *R01168
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************R01168
     C                     ELSE                                           R01168
     C                     MOVE GPLCGR    WWLCGR                          R01168
     C                     Z-ADDGPLCGS    WWLCGS                          R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C           WWAMTO    IFLE 0                                         R01168
     C                     MOVE 'E'       WWEXCO                          R01168
     C** WRITE A RECORD TO LBEXCOPD FOR ORIGINAL DEAL                     R01168
     C                     EXSR #BEA                                      R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C           WWAMTO    IFGE 0                                         R01168
     C                     MOVE 'C'       WWEXCO                          R01168
     C*                                                                   R01168
     C** WRITE A RECORD TO LBEXCOPD FOR ORIGINAL DEAL                     R01168
     C                     EXSR #BEA                                      R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C           WWAMTO    IFLE 0                                         R01168
     C                     MOVE 'E'       WWEXCO                          R01168
     C*                                                                   R01168
     C** WRITE A RECORD TO LBEXCOPD FOR MATCHED DEAL                      R01168
     C                     EXSR #BEB                                      R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C           WWAMTO    IFGE 0                                         R01168
     C                     MOVE 'C'       WWEXCO                          R01168
     C*                                                                   R01168
     C** WRITE A RECORD TO LBEXCOPD FOR MATCHED DEAL                      R01168
     C                     EXSR #BEB                                      R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT                                                              R01168
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BEA         - WRITE A RECORD TO LBEXCOPD FOR ORIGINAL    *   R01168
     C**                   DEAL                                       *   R01168
     C**    CALLS        -                                            *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BE                                        *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BEA      BEGSR                                          R01168
     C*                                                                   R01168
     C                     MOVE 'D'       EXRECI                          R01168
     C                     Z-ADDWWDAY     EXDLUP                          R01168
     C                     MOVE WWMNTH    EXMLUP                          R01168
     C                     Z-ADDWWYEAR    EXYLUP                          R01168
     C                     TIME           EXTLUP                          R01168
     C                     Z-ADDBJRDNB    EXORED                          R01168
     C**********           Z-ADDCNUM      EXCNUM                                       R01168 CSD027
     C                     MOVE CNUM      EXCNUM                                              CSD027
     C                     MOVE BBPCNB    EXPCNB                          R01168
     C                     MOVE '15'      EXREGE                          R01168
     C                     MOVE WWLCGR    EXLCGR                          R01168
     C                     Z-ADDWWLCGS    EXLCGS                          R01168
     C                     MOVE WWINST    EXINST                          R01168
     C***********          MOVE LBCCY     EXCCY                    R01168 S01498
     C                     MOVE LBCYCD    EXCCY                           S01498
     C                     MOVE WWEXCO    EXEXCO                          R01168
     C*                                                                   R01168
     C** EXPOSURE COLLATERAL FLAG MUST BE POSITIVE ON FILE                R01168
     C           WWAMTO    IFLT 0                                         R01168
     C                     Z-SUBWWAMTO    EXAMNT                          R01168
     C                     ELSE                                           R01168
     C                     Z-ADDWWAMTO    EXAMNT                          R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C                     MOVE WWEREF    EXREF                           R01168
     C                     Z-ADDDDAT      EXDDAT                          R01168
     C                     Z-ADDVDAT      EXVDAT                          R01168
     C                     Z-ADD0         EXMDAT                          R01168
     C                     Z-ADD0         EXRLDT                          R01168
     C*                                                                   R01168
     C                     WRITELBEXCOPF                                  R01168
     C                     ADD  1         RRRECW                          R01168
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT                                                              R01168
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BEB         - WRITE A RECORD TO LBEXCOPD FOR MATCHED DEAL*   R01168
     C**                                                              *   R01168
     C**    CALLS        -                                            *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BE                                        *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BEB      BEGSR                                          R01168
     C*                                                                   R01168
     C                     MOVE *BLANKS   WWRLDX                          R01168
     C                     MOVE 'D'       EXRECI                          R01168
     C                     Z-ADDWWDAY     EXDLUP                          R01168
     C                     MOVE WWMNTH    EXMLUP                          R01168
     C                     Z-ADDWWYEAR    EXYLUP                          R01168
     C                     TIME           EXTLUP                          R01168
     C                     Z-ADDBJRDNB    EXORED                          R01168
     C**********           Z-ADDCNUM      EXCNUM                                       R01168 CSD027
     C                     MOVE CNUM      EXCNUM                                              CSD027
     C                     MOVE BBPCNB    EXPCNB                          R01168
     C                     MOVE '15'      EXREGE                          R01168
     C                     MOVE WWLCGR    EXLCGR                          R01168
     C                     Z-ADDWWLCGS    EXLCGS                          R01168
     C                     MOVE WWINST    EXINST                          R01168
     C***********          MOVE LBCCY     EXCCY                    R01168 S01498
     C                     MOVE LBCYCD    EXCCY                           S01498
     C                     MOVE WWEXCO    EXEXCO                          R01168
     C                     Z-ADD0         EXAMNT                          R01168
     C                     MOVE WWXREF    EXREF                           R01168
     C                     Z-ADDDDATX     EXDDAT                          R01168
     C                     Z-ADDVDATX     EXVDAT                          R01168
     C                     Z-ADD0         EXMDAT                          R01168
     C                     Z-ADD0         EXRLDT                          R01168
     C*                                                                   R01168
     C                     WRITELBEXCOPF                                  R01168
     C                     ADD  1         RRRECW                          R01168
     C                     ENDSR                                          R01168
     C*****************************************************************
     C**   #C - TERMINATION PROCESSING                                *
     C*                                                               *
     C**        CALLED BY - MAINLINE                                  *
     C**        CALLS     - NONE                                      *
     C*                                                               *
     C**        FLDS USED  XXXXX  - XXXXXX                            *
     C*                                                               *
     C*****************************************************************
     C*
     C           #C        BEGSR
     C*
     C***If*no*details*on*LB0615P0*-*output*null*report****************   S01498
     C*
     C***********WWDOR0    IFEQ 'N'                                       S01498
     C***********          WRITENULL0                                     S01498
     C***********          END                                            S01498
     C*
     C***Output*footings*on*LB0615P0***********************************   S01498
     C** Output footings on LB0615P1.                                     S01498
     C*
     C           *IN41     IFEQ '1'                                       S01498
     C           LINE1     IFGT 55
     C                     WRITEHEADER0
     C                     END
     C                     WRITEFOOTING0
     C                     CLOSELB0615P1                                  S01498
     C                     END                                            S01498
     C*
     C**   INITIALISE LINE COUNT AND PRODUCE RUN CONTROLS
     C                     Z-ADD*ZEROS    LINE
     C                     WRITEFCNTLS1
     C                     WRITEFCNTLS3
     C*                                                                   S01498
     C** If no details to report, then output 'No details' to audit.      S01498
     C*                                                                   S01498
     C           *IN41     IFEQ '0'                                       S01498
     C                     WRITENODTLS                                    S01498
     C                     END                                            S01498
     C*
     C           #C0       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #YA          - THIS SUBROUTINE FILLS THE FORWARD RATES    *
     C**                   AND DATE ARRAYS.                           *
     C**                                                              *
     C**    CALLS        - NONE                                       *
     C**                                                              *
     C**    CALLED BY    - #BAAA, #BAAB                               *
     C**                                                              *
     C*****************************************************************
     C           #YA       BEGSR
     C*
     C** INITIALISE ARRAYS
     C                     Z-ADD*ZEROS    DAT
     C                     Z-ADD*ZEROS    RAT
     C*
     C** INITIALISE LAST ELEMENT IN DATE ARRAY
     C                     Z-ADD26        WWLAST
     C*
     C** ACCESS FOWARD RATES FILE WITH CURRENT DEAL CURRENCY
     C           WWCCY     CHAINFWDRT                80
     C*
     C** PROCESS ONLY ACTIVE RECORDS
     C           *IN80     IFEQ '0'
     C           RECIF     ANDEQ'D'
     C           CHTPF     ANDNE'D'
     C*
     C** PUT TODAYS DATE IN FIRST ELEMENT OF ARRAY
     C                     Z-ADDBJRDNB    DAT,1
     C                     Z-ADD2         L
     C                     Z-ADD1         P
     C*
     C** IF FORWARD DATE ARRAY IS EMPTY
     C           DFWW,P    IFEQ *ZEROS
     C                     Z-ADD1         WWLAST
     C*
     C                     ELSE
     C*
     C** WHILE A VALID DATE EXISTS IN FORWARD DATE ARRAY USE THESE
     C**   VALUES TO FILL DATE ARRAY
     C           L         DOWLE26
     C           DFWW,P    ANDNE*ZEROS
     C           DFWW,P    ADD  BJRDNB    DAT,L
     C                     ADD  1         L
     C           L         IFNE 27
     C           L         SUB  1         P
     C                     END
     C                     END
     C*
     C** IF FORWARD DATE ARRAY NOT FULL NOTE POSITION OF LAST
     C**   VALID DATE
     C           DFWW,25   IFEQ *ZEROS
     C                     Z-ADDP         WWLAST
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C** ACCESS CURRENCIES FILE WITH REQUIRED CURRENCY
     C***********WWCCY     CHAINSDCURRL1             73                   S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWCCY     @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*
     C** IF NO RECORD FOUND OR LAST CHANGE TYPE = 'D' - DBERROR
     C************IN73     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD12        DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 012 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 012 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELWWCCY     DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C*LB2000/START
     C*****ACCESS*CURRENCY*EXTENDED*FILE**********************************087631
     C***********                                                         087631
     C***********WWCCY     CHAINSDCURRX0             73             S01498087631
     C***********                                                   S01498087631
     C***********          CALL 'AOCURRR0'                          S01498087631
     C***********          PARM '*MSG   ' @RTCD   7                 S01498087631
     C***********          PARM '*KEY   ' @OPTN   7                 S01498087631
     C***********          PARM WWCCY     @CYCD   3                 S01498087631
     C***********@CURR     PARM @CURR     DSSDY                     S01498087631
     C***********                                                         087631
     C*****IF*RECORD*NOT*FOUND*OR*LAST*CHANGE*TYPE*='D'*THEN*DB*ERROR*****087631
     C***********                                                         087631
B2   C************IN73     IFEQ '1'                                       S01498
     C***********@RTCD     IFNE *BLANK                              S01498087631
     C************LOCK     IN   LDA                                 S01498087631
     C***********          Z-ADD16        DBASE            ***************087631
     C***********          MOVEL'SDCURRX0'DBFILE           * DBERROR 016 *S01498
     C***********          MOVE 'SDCURRPD'DBFILE     * DBERROR 016 *S01498087631
     C***********          MOVE *BLANKS   DBKEY            *             *087631
     C***********          MOVELWWCCY     DBKEY            ***************087631
     C***********          OUT  LDA                                 S01498087631
     C***********          EXSR #ZA                                       087631
X2   C***********          ELSE                                           087631
     C*
     C**   SAVE PRECIOUS METAL INDICATOR
     C*
     C**                   MOVE CYPMRT    WWPMRT  1                       R0102
     C***********          MOVE CYPMRT    XXPMRT  1                R0102  S01498
     C                     MOVE A6PMRT    XXPMRT  1                       S01498
E2   C***********          END                                            087631
     C*LB2000/END
     C*
     C**   SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C**   FOR ROUTINE SCONV
     C                     Z-ADDA6SPRT    WWSPRT
     C                     Z-ADDA6NBDP    WWDECP
     C                     MOVE A6MDIN    WWMDIV
     C*
     C**  FILL FORWARD RATE ARRAY FOR REQUIRED CURRENCY
     C                     Z-ADDA6SPRT    RAT,1
     C                     Z-ADD2         L
     C           L         DOWLE26
     C           L         SUB  1         P
     C                     Z-ADDRFWW,P    RAT,L
     C                     ADD  1         L
     C                     END
     C                     END
     C*
     C           #YA0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZA       - PROCESS DATABASE ERRORS                        *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #A                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZA       BEGSR
     C*
     C                     WRITEFCNTLS1
     C*                                                                   S01498
     C           *IN50     IFEQ '1'                                       S01498
     C                     WRITEMISSING                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEFCNTLS2
     C*                                                                   S01498
     C           *IN41     IFEQ '1'                                       S01498
     C                     WRITEDBERROR                                   S01498
     C                     END                                            S01498
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     DUMP                                           S01498
     C                     RETRN
     C*
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZSEDITZ3
     C*****************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**  SCONV - Converts an amount from one currency to another.       *
     C**                                                                 *
     C**  Input Fields - WWAMTI 15/0 amount in input currency            *
     C**                 WWSRI  13/8 spot rate for input currency        *
     C**                 WWSRO  13/8 spot rate for output currency       *
     C**                 WWDPI  1/0  no. of decimals for input currency  *
     C**                 WWDPO  1/0  no. of decimals for output currency *
     C**                 WWMDI  1    mult/div indicator for input curr.  *
     C**                 WWMDO  1    mult/div indicator for output curr. *
     C**                                                                 *
     C**  Arrays       - POWER  powers of 10                             *
     C**                                                                 *
     C**  Output Fields- WWAMTO 15/0 output amount converted to new curr *
     C**                                                                 *
     C**  CALLS    - NONE                                                *
     C**                                                                 *
     C********************************************************************
     C           SCONV     BEGSR                           **  SCONV    **
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDWWAMTI    WWAMTI 150
     C                     Z-ADD0         WWAMTO 150
     C           *LIKE     DEFN A6SPRT    WWSRI
     C           *LIKE     DEFN A6SPRT    WWSRO
     C           *LIKE     DEFN A6NBDP    WWDPI
     C           *LIKE     DEFN A6NBDP    WWDPO
     C           *LIKE     DEFN A6MDIN    WWMDI
     C           *LIKE     DEFN A6MDIN    WWMDO
     C*
     C           WWDPO     SUB  WWDPI     Z       10
     C           Z         ADD  4         Z
     C*
     C           WWMDI     IFNE WWMDO
     C*
     C** MULT/DIV INDICATORS DIFFERENT
     C           WWSRI     MULT WWSRO     WWRATE 159H
     C                     ELSE
     C*
     C** MULT/DIV INDICATORS THE SAME
     C           WWSRO     IFEQ 0
     C                     GOTO SC0
     C                     END
     C           WWSRI     DIV  WWSRO     WWRATE    H
     C                     END
     C*
     C           WWMDI     IFEQ 'D'
     C           WWRATE    IFEQ 0
     C                     GOTO SC0
     C                     END
     C           POWER,Z   DIV  WWRATE    WWRATE    H
     C                     ELSE
     C           POWER,Z   MULT WWRATE    WWRATE    H
     C                     END
     C*
     C           WWAMTI    MULT WWRATE    WWAMTO    H
     C*
     C           SC0       ENDSR                           **  SC0      **
     C*****************************************************************
     C/EJECT
     C*****************************************************************   S01498
     C*                                                                   S01498
     C*  RCFP1 -- Subroutine to register P1 report via RCF                S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C           RCFP1     BEGSR                            ** RCFP1 **   S01498
     C*                                                                   S01498
     C**  Ensure report spool file is recorded by RCF.                    S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUM1    ZSNUM   60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ     5                       S01498
     C                     PARM *BLANKS   @PARM   3                       S01498
     C                     PARM           SFILE1                          S01498
     C                     PARM           ZSNUM                           S01498
     C                     PARM           ZSERR   1                       S01498
     C*                                                                   S01498
     C**  Error during ZSFILE processing, return to calling program.      S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ENDSR                                          S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C/EJECT                                                              S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C*  RCFAU -- Subroutine to register AU report via RCF                S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C           RCFAU     BEGSR                            ** RCFAU **   S01498
     C*                                                                   S01498
     C**   Ensure audit spool file is recorded by RCF.                    S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUMU    ZSNUMU  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ                             S01498
     C                     PARM *BLANKS   @PARM                           S01498
     C                     PARM           SFILEU                          S01498
     C                     PARM           ZSNUMU                          S01498
     C                     PARM           ZSERR                           S01498
     C*                                                                   S01498
     C**  Error during ZSFILE processing, return to calling program.      S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ENDSR                                          S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C/EJECT                                                              S01498
     C*****************************************************************
     C**                                                              *
     C**   *PSSR     - PROGRAM ERROR HANDLING ROUTINE                 *
     C**                                                              *
     C**   CALLS     -                                                *
     C**                                                              *
     C**   CALLED BY -                                                *
     C**                                                              *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************   R0590
     C**                                                              *   R0590
     C**    R0590        - THIS SUBROUTINE TAKE NUMBER OF DECIMAL     *   R0590
     C**                   PLACES FOR ONR CURRENCY.                   *   R0590
     C**                                                              *   R0590
     C*****************************************************************   R0590
     C           R0590     BEGSR                                          R0590
     C*                                                                   R0590
     C***********XCCY      CHAINSDCURRL1             73            R0590  S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM XCCY      @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*                                                                   R0590
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR     R0590
     C*                                                                   R0590
     C************IN73     IFEQ '1'                                R0590  S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'                                       R0590
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD7         DBASE            ***************R0590
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERR R0590  S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 007 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *R0590
     C                     MOVELXCCY      DBKEY            ***************R0590
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R0590
     C                     ELSE                                           R0590
     C*                                                                   R0590
     C**   SAVE NO. OF DECIMAL PLACES                                     R0590
     C*                                                                   R0590
     C                     Z-ADDA6NBDP    WWDPI                           R0590
     C                     END                                            R0590
     C*                                                                   R0590
     C                     ENDSR
     C*****************************************************************   R0590
     C/EJECT                                                              R0590
     C*****************************************************************
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   POWER - POWERS OF 10 FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
