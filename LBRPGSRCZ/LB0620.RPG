     H        1                                                           S01498
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Forward regeneration')                        *
     H***********                                                         S01498
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                             *
     F*                                                               *
     F*  LB0620 - Forward Regeneration                                *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CDL099             Date 06Oct17               *
      *                 CDL094             Date 11Jun14               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CDL049             Date 07Jul06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CDL038             Date 10May05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 095719             Date 25Jul96               *
      *                 092542             Date 19Oct95               *
     F*                 087631             DATE 05SEP95               *
     F*                 087376             DATE 10MAY95               *
     F*                 086863             DATE 01MAY95               *
     F*                 080375             DATE 21DEC94               *
     F*                 S01498             DATE 11AUG94               *
     F*                 S01328             DATE 15JAN93               *
     F*                 043724             DATE 29SEP92               *
     F*                 B08237             DATE 17SEP91               *
     F*                 37505              DATE 31MAR92               *
     F*                 S01355             DATE 06MAR92               *
     F*                 33150              DATE 11DEC91               *
     F*                 34690              DATE 17JAN92               *
     F*                 33503              DATE 18DEC91               *
     F*                 B10526             DATE 21OCT91               *
     F*                 B10524             DATE 18OCT91               *
     F*                 B10523             DATE 18OCT91               *
     F*                 B10521             DATE 18OCT91               *
     F*                 B10035             DATE 26SEP91               *
     F*                 B08157             DATE 08AUG91               *
     F*                 B7893              DATE 31MAY91               *
     F*                 B7855              DATE 27MAY91               *
     F*                 B7826              DATE 16MAY91               *
     F*                 B5986              DATE 16MAY91               *
     F*                 B5980              DATE 15MAY91               *
     F*                 B5937              DATE 03MAY91               *
     F*                 B5936              DATE 03MAY91               *
     F*                 B5922              DATE 01MAY91               *
     F*                 SA9109             DATE 26APR91               *
     F*                 R01168             DATE 11APR91               *
     F*                 R0170              DATE 15FEB91               *
     F*                 R0162              DATE 14FEB91               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*  095719 - Exposure shows incorrect figures for FX open deals. *
     F*           If calculating margin on exposure, convert full     *
     F*           amount to Lombard Currency before calculating       *
     F*           margin percentage to obtain exactly the % of open   *
     F*           FX amount.                                          *
     F*  092542 - DB error when using wrong field to chain            *
     F*  087631 - Should only use Precious Metal limits if S01433,    *
     F*           Extended Dealing Limits switchable feature is on.   *
     F*  087376 - Using wrong fields for forward limit amounts        *
     F*  086863 - Parameters for AOCLLMR0 are incorrect               *
     F*  080375 - Margin % fields not edited properly                 *
     F*  S01498 - Portfolio Lending Upgrade to Release 10             *
     F*  S01328 - FRA/IRS Revaluation.                                *
     F*  043724 - Limits for Precious Metal Customer not displayed    *
     F*           in LB enquiry.                                      *
     F*  B08237 - INCORRECT NARRATIVE ON UNREALISED P+L RECORDS       *
     F*  37505  - AVOID BLANK PAGES TO BE PRODUCED                    *
     F*  S01355 - RELEASE 3                                           *
     F*  33150  - INVALID DECIMAL POSITION (WWDECP SETUP ONLY IF      *
     F*           CHANGE OF EVENT CCY BUT THIS VALUE CAN BE MODIFIED  *
     F*           FOR CUSTOMER MARGIN OR LIMIT CALCULATION)           *
     F*  34690  - LB CUSTOMER MARGIN PERCENTAGE(SA9109)IS SWITCHABLE  *
     F*           NOW                                                 *
     F*  33503  - PORTFOLIO LENDING EXTENDED MARGIN IS SWITCHABLE NOW *
     F*  B10526 - INVALID CONVERSION FOR DEALING LIMITS               *
     F*  B10524 - MARGIN BASED ON EXPOSURE NOT CONVERTED              *
     F*  B10523 - INVALID DECIMAL POSITIONS                           *
     F*  B10521 - B7893/WRONG REFERENCE                               *
     F*  B10035 - PREVENT DBTE 29 BY CONDITIONING CE SAR              *
     F*  B08157 - PM LIMITS NOT SHOWN IF NO FX LIMIT EXISTS           *
     F*  B7893  - SAR9109 NOT CORRECT FOR UPDATE OF LBEXCOPD          *
     F*           SHOULD WRITE RECORD TO LBEXCOPD FOR THE NET         *
     F*           UNREALISED P&L ONLY                                 *
     F*  B7855  - SAR9109 NOT CORRECT FOR UPDATE OF LBEXCOPD-STILL    *
     F*           USES ICD MARGIN PERC. INSTEAD OF CUSTOMER ONES.     *
     F*  B7826  - DON'T EXTRACT P/L RECORDS FOR LINK ENQUIRY          *
     F*  B5986  - MARGIN PERC NOT RETRIEVED IF FOREX EXP IS ZERO.     *
     F*  B5980  - PRECIOUS METAL MARGIN INSTEAD OF FOREX MARGIN IS    *
     F*           USED TO CALCULATE MARGIN AMT ON EXPOSURE.           *
     F*  B5937  - TO OUTPUT EVENT CCY INSTEAD OF LB CCY FOR P/L       *
     F*  B5936  - MARGIN RECORDS WRONGLY SET UP AND OUTPUT            *
     F*  B5922  - FX & PM MARGIN INSTRUMENTS WRONGLY SET UP           *
     F*  SA9109 - LB MARGIN PRECENTAGES                               *
     F*  R01168 - WRITE A RECORD TO EXTRACT FILE LBEXCOPD             *
     F*  R0171  - TO OUTPUT EXPOSURE AMOUNTS                          *
     F*  R0162  - TO OUTPUT LIMIT AMOUNTS                             *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**
     F**      FILE DEFINITIONS
     F**     ------------------
     F**
     F*****LB*MARGIN*PERCENTAGES********************************** SA9109 S01498
     F***SDLBCSY0IF**E           K        DISK         KINFSR *PSS SA9109 S01498
     F************SDLBCSD0                          KRENAMESDLBCSF SA9109 S01498
     F**
     F*****BANK*DETAILS*FILE.*PREFIX*BJ.*******************************   S01498
     F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F*****PORTFOLIO*LENDING*ICD*FILE.*PREFIX*-*LB*********************   S01498
     F***SDLOMBPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F*****PORTFOLIO*LENDING*ICD*EXTENDED*FILE.*PREFIX*-*LB************   S01498
     F***SDLOMBX0IF**E                    DISK         KINFSR *PSSR       S01498
     F************SDLOMBD0                          KRENAMELOMBX0         S01498
     F*
     F*****DEALING*DATA.*PREFIX*-*BN***********************************   S01498
     F***SDDEALPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F**   RUN CONTROLS REPORT
     F***LB0620AUO***E             21     PRINTER      KINFDS ERF1DS      S01498
     FLB0620AUO   E             21     PRINTER      KINFDS SPOOLU         S01498
     F                                              KINFSR *PSSR
     F*
     F**   PORTFOLIO LENDING EXTRACT FILE. PREFIX - EE
     FLBEXTRL2UF  E           K        DISK         KINFSR *PSSR A
     F*                                                                   R01168
     F** PORTFOLIO EXPOSURE/COLLATERAL EXTRACT FILE. PREFIX - EX          R01168
     FLBEXCOPDO   E                    DISK         KINFSR *PSSR          R01168
     F*
     F**   PRINTER FILE
     F***LB0620P1O***E             22     PRINTER      KINFDS ERF2DS      S01498
     FLB0620P1O   E             22     PRINTER      KINFDS SPOOL      UC  S01498
     F                                              KINFSR *PSSR
     F*
     F***PORTFOLIO*LENDING*GROUPS.*PREFIX*GP***************************   S01498
     F***LBGROUL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** DEALING CUSTOMER LIMITS
     F***LIMILBJ1IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLIMIJ1IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F*****LIMITS*EXTENDED*FILE.*PREFIX*-*LI***************************   S01498
     F***LIMITBX0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F***LIMITS*DETAILS.*PREFIX*A2*************************************   S01498
     F***SDLIMTL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   JOINT CUSTOMER DETAILS  LB / SD. PREFIX - CU/BB
     F***SDLBCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBLBCSJ0IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F***INSTRUMENT*TYPES*-*PREFIX*PD**********************************   S01498
     F***SDPLINL4IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F*****CURRENCY*FILE.*PREFIX*-*A6**********************************   S01498
     F***SDCURRL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F*****CURRENCY*EXTENDED*FILE.*PREFIX*-*CY**********************      S01498
     F***SDCURRX0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F** FORWARD RATES FILE
     FFWDRT   IF  E           K        DISK         KINFSR *PSSR
     F*
     F** DEALS MASTER (DUPLICATE FILE)
     F***XDEALSL2IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBDEALL3IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F** DEALING EVENTS DETAIL FILE
     F***EVNXEDL3IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBEVNDL1IF  E           K        DISK         KINFSR *PSSR          S01498
     F/COPY WNCPYSRC,LB0620F001
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**                                                              *
     F** ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F**                 ------------------------                     *
     F**                                                              *
     F******20*********-*EOF*ON*SDLBCSY0*******************************   SA9109
     F**    21         - OVERFLOW INDICATOR ON LB0620AU               *
     F**    22         - OVERFLOW INDICATOR ON LB0620P1               *
     F**       24      - VALID EVENT TYPE SELECTED                    *
     F**       26      - LOOK UP INDICATOR FOR DATE ARRAY             *
     F**       27      - INDICATOR FOR 'OTHER DATE' VALUES            *
     F**       28      - INCOMING EVENT INDICATOR                     *
     F**       29      - OUTGOING EVENT INDICATOR                     *
     F**       30      - NEGATIVE EVENT INDICATOR                     *
     F**       31      - POSITIVE EVENT INDICATOR                     *
     F**       32      - DIFFERENCE IN NO. OF RECORDS INDICATOR       *
     F**       44      - TO PRINT LIMIT AMOUNT OR EXPOSURE            *
     F**       45      - PRECIOUS METAL INDICATOR                     *
     F**       46      - CHANGE OF DEAL NUMBER                        *
     F*        47      - ENHANCED DEALING LIMITS ON                   *   087631
     F**       51      - LB0620P1 open                                *   S01498
     F**                                                              *
     F*********61******-*READ*FAIL*ON*SDBANKPD*************************   S01498
     F*********62******-*READ*FAIL*ON*SDDEALPD*************************   S01498
     F*********63******-*READ*FAIL*ON*SDLOMBPD*************************   S01498
     F*********63******-*READ*FAIL*ON*SDLOMBX0*************************   S01498
     F*********64******-*CHAINFFAILOONSSDCURRL1************************   S01498
     F*********65******-*CHAINFFAILOONSSDPLINL4************************   S01498
     F*********66******-*CHAINFFAILOONSLBGROUL1************************   S01498
     F*********67******-*READ*FAIL*ON*EVNXEDL3*************************   S01498
     F**       67      - Read fail on LBEVNDL1                        *   S01498
     F*********69******-*CHAIN*FAIL*ON*XDEALSL2************************   S01498
     F**       69      - Chain fail on LBDEALL3                       *   S01498
     F**       70      - CHAIN FAIL ON FWDRT                          *
     F*********71******-*CHAIN*FAIL*ON*LIMILBJ1************************   S01498
     F**       71      - Chain fail on LBLIMIJ1                       *   S01498
     F*********72******-*CHAIN*FAIL*ON*SDLIMTL0************************   S01498
     F**       74      - CHAIN FAIL LBEXTRL2                          *
     F**       75      - CHANGE OF DEAL NUMBER                        *
     F*********76******-*READ*FAIL*ON*SDLBCSL0*************************   S01498
     F**       76      - READ FAIL ON LBLBCSJ0                        *   S01498
     F**                                                              *
     F**       98      - USED BY ZDATE2                               *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     E********************************************************************
     E*
     E** ARRAY FOR COPYRIGHT
     E                    CPY@    1   1 80
     E*****************************************************************
     E/EJECT
     E*****************************************************************
     E** ARRAY USED IN DATE CONVERSION
     E/COPY ZSRSRC,ZDATE2Z1
     E*****************************************************************
     E/EJECT
     E*****************************************************************
     E** ARRAY USED TO CONVERT NUMERIC AMOUNT TO CHARACTER
     E/COPY ZSRSRC,ZSEDITZ1
     E*****************************************************************
     E/EJECT
     E*****************************************************************
     E*
     E** ARRAY USED IN CURRENCY AMOUNT CONVERSION
     E                    POWER   1   7  7 3
     E*
     E** DATE ARRAY
     E                    DAT        26  5 0A
     E*
     E** RATE ARRAY
     E                    RAT        26 13 8
     E*
     E** NUMBER OF DAYS FORWARD ARRAY
     E******************* DFWW       25  3 0                              S01328
     E                    DFWW       25  5 0                              S01328
     E*
     E** FORWARD RATES ARRAY
     E                    RFWW       25 13 8
     E/COPY WNCPYSRC,LB0620E001
     E*
     E********************************************************************
     I/EJECT
     I*****************************************************************
     I*
     I*****RENAME*FIELDS*ON*XDEALSL2***********************************   S01498
     I**   Rename fields on LBDEALL3.                                     S01498
     IDEALSDBF
     I              RECI                            RECIX
     I              DLNO                            DLNOX
     I              CNUM                            CNUMX
     I              DTYP                            DTYPX
     I              DLST                            DLSTX
     I              DDAT                            DDATX                 R01168
     I              VDAT                            VDATX                 R01168
     I*
     I**   RENAME FIELDS ON FWDRT
     IFWDRTFEF
     I              RECI                            RECIF
     I              CHTP                            CHTPF
     I*
     I*****RENAME*FIELDS*ON*LIMILBJ1***********************************   S01498
     I**   Rename fields on LBLIMIJ1.                                     S01498
     I***LIMILBJF                                                         S01498
     ISDCLLMJF                                                            S01498
     I**************RECI                            RECIL                 S01498
     I**************CNUM                            CNUML                 S01498
     I**************CHTP                            CHTPL                 S01498
     I              DZCUST                          CNUML                 S01498
     I              DZTYLC                          CHTPL                 S01498
     I*
     I*****************************************************************
     I/EJECT
     I*****************************************************************
     I** DATA STRUCTURES FOR COPYRIGHT
     ICPYR@       DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*****************************************************************
     I/EJECT
     I*****************************************************************
     I** DATA STRUCTURE FOR ZSEDIT
     I/COPY ZSRSRC,ZSEDITZ2
     I*****************************************************************
     I/EJECT
     I*****************************************************************
     I*
     I**   PROGRAM DATA STRUCTURES
     I*
     I** Data Structure to split date into day month year
     I            DS
     I****************************************1   7 BJMRDT                S01498
     I                                        1   7 WWMRDT                S01498
     I                                        1   20WWDAY
     I                                        3   5 WWMNTH
     I                                        6   70WWYEAR
     I*
     I**   TO FILL DATE ARRAY
     IWWDS1       DS
     I******************                      1  50 DFW                   S01355
     I*************************************** 1  50 DFWC            S01355S01328
     I*********************************** P   1  50 DFWW                  S01328
     I                                        1  75 DFW                   S01328
     I                                    P   1  75 DFWW                  S01328
     I*
     I**   TO FILL FORWARD RATES ARRAY
     IWWDS2       DS
     I                                        1 175 RFW
     I                                    P   1 175 RFWW
     I*                                                                   R01168
     I**   SET UP DATA STRUCTURE FOR REFERENCE ON LBEXCOPD                R01168
     I            DS                                                      R01168
     I                                        1  16 WWEREF                R01168
     I                                        1   60DLNO                  R01168
     I*
     I**   PROGRAM STATUS DATA STRUCTURE
     IPSDS       SDS
     I                                      244 253 JOB
     I                                      254 263 USER
     I*
     I**   FILE INFORMATION DATA STRUCTURE
     I*
     ISPOOLU      DS                                                      S01498
     I                                       83  92 SFILEU                S01498
     I                                    B 123 1240SFNUMU                S01498
     I**   FOR OVERFLOW ON FILE CONTROLS
     I***ERF1DS******DS                                                   S01498
     I                                    B 367 3680LINE1
     I*                                                                   S01498
     ISPOOL       DS                                                      S01498
     I                                       83  92 SFILE                 S01498
     I                                    B 123 1240SFNUM                 S01498
     I*
     I**   FOR OVERFLOW ON REPORT
     I***ERF2DS******DS                                                   S01498
     I                                    B 367 3680LINE2
     I*
     I**   LOCAL DATA AREA
     I***LDA********UDS                            256                    S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I** Local Data Area                                                  S01498
     I*                                                                   S01498
     I**                                                                  B10035
      **Data*area*LZSTAT****************************************** B10035 S01498
     I*ZSTAT*****UDS***********                 256                 B1003533503
     I***LZSTAT******DS                            256             33503  S01498
     I***********                            11  11 SARS           B10035 S01498
     I***********                            19  19 MRGP           34690  S01498
     I***********                            21  21 LBIC           33530  S01498
     I*                                                                   S01498
     IRUNDAT    E DS                                                      S01498
     I** Standard data area layout for system flags and run date          S01498
     I*                                                                   S01498
     I@BANK     E DSSDBANKPD                                              S01498
     I** Dummy record format for access to Bank Details                   S01498
     I*                                                                   S01498
     I@CURR     E DSSDCURRPD                                              S01498
     I** Dummy record format for access to Currency Details               S01498
     I*                                                                   S01498
     I@DEAL     E DSSDDEALPD                                              S01498
     I** Dummy record format for access to Dealing ICD                    S01498
     I*                                                                   S01498
     I@LBCS     E DSSDLBCSPD                                              S01498
     I** Dummy record format for access to LB Customer Details            S01498
     I*                                                                   S01498
     I@PLIN     E DSSDPLINPD                                              S01498
     I** Dummy record format for access to Instrument Types               S01498
     I*                                                                   S01498
     I@LOMB     E DSSDLOMBPD                                              S01498
     I** Dummy record format for access to Portfolio Lending ICD          S01498
     I*                                                                   S01498
     I@GROU     E DSLBGROUPD                                              S01498
     I** Dummy record format for access to Portfolio Lending Groups       S01498
     I*                                                                   S01498
     I@LIMT     E DSSDLIMTPD                                              S01498
     I** Dummy record format for access to Limit Details                  S01498
     I*                                                                   S01498
     I@CLLM     E DSSDCLLMPD                                              S01498
     I** Dummy record format for access to Client Limits                  S01498
     I*                                                                   S01498
     ISCSARD    E DSSCSARDPD                                              087631
     I** Dummy record format for access to SWITCHABLE FEATURES            087631
     I*                                                                   087631
     IDSFDY     E DSDSFDY                                                 S01498
     I** First DS for access programs, short data structure               S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I** Second DS for access programs, long data structure               S01498
     I*                                                                   S01498
     I*****************************************************************
     C/EJECT
     C*****************************************************************
     C*
     C**   KEYS USED BY PROGRAM
     C**   --------------------
     C*
     C           WWEEK1    KLIST                           'LBEXTRL2'
     C                     KFLD           EECNUM
     C                     KFLD           EEINST
     C                     KFLD           EECCY
     C*
     C           WWEEK2    KLIST                           'LBEXTRL3'
     C                     KFLD           KKCNUM
     C                     KFLD           KKDLNO
     C                     KFLD           KKECCY
     C*
     C/COPY WNCPYSRC,LB0620C003
     C***********KLIMX0    KLIST                           'LIMITBX0      S01498
     C***********          KFLD           CNUML                           S01498
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C************NAMVAR   DEFN           LZSTAT                   33503  S01498
     C***********          IN   LZSTAT                             33503  S01498
     C*
     C**              START MAINLINE
     C**             ----------------
     C*
     C**   INITIAL PROCESSING
     C*
     C                     EXSR #A
     C*
     C**   MAIN PROCESSING
     C*
     C************LOVAL    SETLLSDLBCSL0                                  S01498
     C***********          READ SDLBCSL0                 76               S01498
     C           *LOVAL    SETLLLBLBCSJ0                                  S01498
     C                     READ LBLBCSJ0                 76               S01498
     C*
     C           *IN76     DOWEQ'0'
     C                     EXSR #B
     C***********          READ SDLBCSL0                 76               S01498
     C                     READ LBLBCSJ0                 76               S01498
     C                     END
     C*
     C**   TERMINATION PROCESSING
     C*
     C                     EXSR #C
     C*
     C**   END PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    INDEX TO SUBROUTINES                                      *
     C**   ----------------------                                     *
     C**                                                              *
     C**   #A      - PERFORMS INITIAL PROCESSING                      *
     C**                                                              *
     C**   #B      - MAIN PROCESSING                                  *
     C**   #BA     - SELECTS VALID EVENT TYPE.                        *
     C**   #BB     - CALCULATES REVALUATED AMOUNT FOR SELECTED CCY.   *
     C**   #BBA    - FILLS FORWARD RATE AND DATE ARRAYS FOR SELECTED  *
     C**             CURRENCY.                                        *
     C**   #BBB    - CALCULATES FORWARD RATE.                         *
     C**   #BBC    - CALCULATES REVALUATED AMOUNT.                    *
     C**   #BC     - CALCULATES THE PROFIT/LOSS AMOUNT.               *
     C**   #BD     - WRITES A DETAIL LINE TO FORWARD REGENERATION     *
     C**              REPORT.                                         *
     C**   #BE     - PROCESS CUSTOMER MARGINS.                        *
     C**   #BEA    - CALCULATES THE CUSTOMER MARGINS.                 *
     C**   #BEB    - OUTPUT DETAILS FOR MARGINS ON REGENERATION RPT.  *
     C**   #BEC    - WRITES RECORDS TO PORTFOLIO EXTRACT FILE         *
     C**             FOR MARGINS.                                     *
     C**   #BED    - PERFORMS CALCULATIONS FOR RECORD TO BE WRITTEN   *
     C**             TO NEW EXTRACT FILE LBEXCOPD                     *
     C**   #BEDA   - WRITES RECORDS TO NEW EXTRACT FILE LBEXCOPD      *
     C**   #BF     - WRITES RECORDS TO PORTFOLIO EXTRACT FILE         *
     C**             FOR UNREALISED PROFIT/LOSS.                      *
     C**   #BG     - WRITE RECORD TO PORTFOLIO EXTRACT FILE           *
     C**             FOR NET UNREALISED PROFIT/LOSS                   *
     C**   #BH     - PROCESS CUSTOMER MARGINS ON EXPOSURE             *
     C**   #BHA    - CALCULATES CUSTOMER MARGINS ON EXPOSURE          *
     C**   #BHB    - PERFORMS CALCULATIONS FOR RECORD TO BE WRITTEN   *
     C**             TO NEW EXTRACT FILE LBEXCOPD                     *
     C**   #BHBA   - WRITES RECORDS TO NEW EXTRACT FILE LBEXCOPD      *
     C**   #BI     - CALCULATES LIMIT WHEN MARGIN ON EXPOSURE         *
     C**   #BJ     - PERFORMS CALCULATIONS FOR RECORD TO BE WRITTEN   *
     C**             TO NEW EXTRACT FILE LBEXCOPD                     *
     C**   #BJA    - WRITES RECORDS TO NEW EXTRACT FILE LBEXCOPD      *
     C**                                                              *
     C**   #C      - PERFORMS TERMINATION PROCESSING.                 *
     C**                                                              *
     C**   #YA     - SETS UP CONSTANT FIELDS FOR PORTF.  EXTRACT FILE.*
     C**   #ZA     - PROCESS DATABASE ERRORS.                         *
     C**   SCONV   - CONVERTS AN AMOUNT FROM ONE CURRENCY TO ANOTHER. *
     C**   ZDATE2  - CONVERTS 5 FIG. DAY NUMBER TO DATE FORMAT.       *
     C**   ZSEDIT  - CONVERTS DECIMAL AMOUNT TO CHARACTER.            *
     C**   *PSSR   - PROGRAM ERROR HANDLING ROUTINE.                  *
     C**                                                              *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C** SUBROUTINE TO CONVERT DATE
     C/COPY ZSRSRC,ZDATE2Z2
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C** SUBROUTINE TO CONVERT NUMERIC AMOUNT TO CHARACTER
     C/COPY ZSRSRC,ZSEDITZ3
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #B        - THIS SUBROUTINE PERFORMS MAIN PROCESSING       *
     C**                                                              *
     C*****CALLS*****- #BA, #BB, #BC, #BD, #BE, #BF, #ZA              *   R01168
     C**   CALLS     - #BA, #BB, #BC, #BD, #BE, #BF, #BG, #BH, #BI    *   R01168
     C**               #BJ                                            *   R01168
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C           #B        BEGSR
     C*
     C                     Z-ADD*ZEROS    LINE2
     C                     Z-ADD*ZEROS    WWNETL
     C                     Z-ADD*ZEROS    WWNETP
     C/COPY WNCPYSRC,LB0620C004
     C                     Z-ADD*ZEROS    WWLIFX                          R0162
     C                     Z-ADD*ZEROS    WWLIPM                          R0162
     C                     Z-ADD*ZEROS    EEEXPS
     C                     Z-ADD*ZEROS    EECOLL                          R0162
     C                     Z-ADD*ZEROS    EELIMT                          R0162
     C*                                                                   R0162
     C***********          MOVE CUPNP8    KKCNUM  60               R0162  S01498
     C                     MOVE CUCUST    KKCNUM  6                       S01498
     C                     Z-ADD*ZERO     KKDLNO  60                      R0162
     C                     MOVE *BLANKS   KKECCY  3                       R0162
     C*                                                                   R0162
     C** CALCULATE LIMIT WHEN MARGIN ON EXPOSURE                          R0162
     C           LBMGLE    IFEQ 'E'                                       R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     EXSR #BI                                       R0162
     C                     END                                            R0162
     C*
     C** READ THE DEALING EVENTS DETAIL FILE
     C                     MOVE '0'       *IN67
     C***********WWEEK2    SETLLEVNXEDL3                                  S01498
     C***********          READ EVNXEDL3                 67               S01498
     C/COPY WNCPYSRC,LB0620C005
     C           WWEEK2    SETLLLBEVNDL1                                  S01498
     C                     READ LBEVNDL1                 67               S01498
     C/COPY WNCPYSRC,LB0620C006
     C*
     C***********CNUM      IFNE KKCNUM                                    S01498
     C           CUNR      IFNE KKCNUM                                    S01498
     C                     MOVE '1'       *IN67
     C                     END
     C*
     C***********          MOVE CUPNP8    RRCNUM                          S01498
     C                     MOVE CUCUST    RRCNUM                          S01498
     C                     MOVE BBCRNM    RRCRNM
     C                     MOVE BBCRTN    RRCRTN
     C/COPY WNCPYSRC,LB0620C007
     C*
     C** IF NO RECORDS FOUND DON'T WRITE ANYTHING
     C********** *IN67     IFEQ '0'                                       37505
     C******************** WRITEHEADER1                                   37505
     C******************** WRITEHEADER2                                   37505
     C******************** END                                            37505
     C*
     C***LOOP*WHILE*NOT*AT*END*OF*EVNXEDL3*****************************   S01498
     C** Loop while not at end of LBEVNDL1.                               S01498
     C           *IN67     DOWEQ'0'
     C*
     C** SAVE PREVIOUS RECORD CURRENCY FOR COMPARSION LATER
     C*                    MOVE WWECCY    WWPCCY
     C*
     C** SAVE DEFAULT PORTFOLIO EXTRACT KEY - EVENT CCY, CUSTOMER NO.
     C                     MOVE ECCY      WWECCY
     C***********          Z-ADDCNUM      WWCNUM                          S01498
     C                     MOVE CUNR      WWCNUM                          S01498
     C*
     C** WHILE EVENT CCY AND CUSTOMER NUMBER STAYS THE SAME AND NOT EOF
     C           ECCY      DOWEQWWECCY
     C***********CNUM      ANDEQWWCNUM                                    S01498
     C           CUNR      ANDEQWWCNUM                                    S01498
     C           *IN67     ANDEQ'0'
     C/COPY WNCPYSRC,LB0620C008
     C*
     C** SELECT ACTIVE RECORDS WITH EVENT DATE >= RUN DATE AND EVENT
     C** AMOUNT NOT EQUAL TO ZERO.
     C*
     C           RECI      IFEQ 'D'
     C           EDAT      ANDGEBJRDNB
     C           EAMT      ANDNE*ZEROS
     C           ETYP      IFEQ '11V1'
     C           ETYP      OREQ '11V2'
     C           ETYP      OREQ '12V1'
     C           ETYP      OREQ '12V2'
     C           ETYP      OREQ '13V1'
     C           ETYP      OREQ '13V2'
     C*
     C** SETUP KEY FOR CHAIN (CUSTOMER NO. 6A)
     C*
     C***********          MOVE CNUM      WWPNP8                          S01498
     C                     MOVE CUNR      WWPNP8                          S01498
     C***********                                                         R01168
     C***IF*PORTFOLIO LENDING CUSTOMER DOES EXIST                         R01168
     C************IN68     IFEQ '0'                                       R01168
     C*
     C** SAVE PARENT REFERENCE
     C                     MOVE BBPCNB    WWPARE
     C*
     C***CHAIN*TO*XDEALSL2*TO*CHECK*LAST*CHANGE*TYPE*WAS*NOT*'C'*******   S01498
     C** Chain to LBDEALL3 to check last change type was not 'C'.         S01498
     C*
     C           DLNO      IFNE WWDLNO
     C*
     C                     Z-ADDDLNO      WWDLNO  60
     C                     MOVE '1'       *IN46
     C***********DLNO      CHAINXDEALSL2             69                   S01498
     C           DLNO      CHAINLBDEALL3             69                   S01498
     C*
     C                     ELSE
     C*
     C                     MOVE '0'       *IN46
     C*
     C                     END
     C*
     C** IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' THEN DBERROR
     C           *IN69     IFEQ '1'
     C           CHTP      OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD14        DBASE            *****************
     C                     MOVE *BLANKS   DBFILE           *               *
     C***********          MOVEL'XDEALSL2'DBFILE           *  DBERROR  14 S01498
     C                     MOVE 'LBDEALL3'DBFILE           *  DBERROR  14 S01498
     C                     MOVE *BLANKS   DBKEY            *               *
     C                     MOVELDLNO      DBKEY            *****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C*
     C                     ELSE
     C*
     C** IF LAST CHANGE TYPE IS NOT EQUAL TO 'C' (CLOSED DEAL)
     C           CHTP      IFNE 'C'
     C*
     C** SELECT VALID EVENT TYPES FOR FORWARD REVALUATION OF
     C**  INTERESTS INDICATOR.
     C                     EXSR #BA
     C*
     C** IF A VALID EVENT TYPE HAS BEEN SELECTED
     C           *IN24     IFEQ '1'
     C/COPY WNCPYSRC,LB0620C039
     C*
     C** CALCULATE REVALUATED AMOUNTS FOR SELECTED EVENT
     C                     EXSR #BB
     C*
     C** CALCULATE PROFIT/LOSS
     C                     EXSR #BC
     C*                                                                   R01168
     C***WRITE*RECORDS*TO*NEW*EXTRACT FILE LBEXCOPD                 R01168B07893
     C/COPY WNCPYSRC,LB0620C009
     C                     EXSR #BJ                                 R01168B07893
     C/COPY WNCPYSRC,LB0620C010
     C** IF NO RECORDS FOUND DON'T WRITE ANYTHING
     C           *IN67     IFEQ '0'                                       37505
     C*                                                                   S01498
     C**  Open LB0620P1.                                                  S01498
     C*                                                                   S01498
     C           *IN51     IFEQ '0'                                       S01498
     C                     OPEN LB0620P1                                  S01498
     C                     EXSR RCFP1                                     S01498
     C                     WRITEHEADER1                                   37505
     C                     WRITEHEADER2                                   37505
     C                     SETON                     51                   S01498
     C                     END                                            S01498
     C                     END                                            37505
     C*
     C** PRINT DETAIL LINE ON FORWARD REGENERATION REPORT
     C                     EXSR #BD
     C*                                                                   B5986
     C                     MOVE 'Y'       SW      1                       B5986
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C***********                                                         R01168
     C***********          END                                            R01168
     C*
     C                     END
     C*
     C                     END
     C*
     C** READ NEXT RECORD FROM DEALS FILE
     C***********          READ EVNXEDL3                 67               S01498
     C/COPY WNCPYSRC,LB0620C011
     C                     READ LBEVNDL1                 67               S01498
     C/COPY WNCPYSRC,LB0620C012
     C*
     C***********CNUM      IFNE KKCNUM                                    S01498
     C           CUNR      IFNE KKCNUM                                    S01498
     C*
     C           *IN67     IFEQ '0'
     C                     MOVE '1'       *IN67
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C** IF CUSTOMER HAS CHANGED OR EOF
     C***********CNUM      IFNE KKCNUM                                    S01498
     C           CUNR      IFNE KKCNUM                                    S01498
     C           *IN67     OREQ '1'
     C           SW        IFEQ 'Y'                                       B5986
     C                     MOVE ' '       SW                              B5986
     C*
     C** PROCESS CUSTOMER MARGINS DEPENDING ON EXPOSURE OR LIMIT
     C           LBMGLE    IFEQ 'L'
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     MOVE '1'       *IN44
     C                     EXSR #BE
     C                     ELSE
     C           WWEBCE    IFNE *ZERO
     C           WWPBCE    ORNE *ZERO
     C           WWLIFX    ORNE *ZERO                                     R0162
     C           WWLIPM    ORNE *ZERO                                     R0162
     C                     MOVE '0'       *IN44
     C                     EXSR #BH
     C                     END
     C                     END
     C*
     C** WRITE RECORDS TO PORTFOLIO LENDING EXTRACT FILE
     C                     EXSR #BF
     C*
     C** WRITE RECORD FOR NET UNREALISED PROFIT/LOSS
     C/COPY WNCPYSRC,LB0620C013
     C                     EXSR #BG
     C/COPY WNCPYSRC,LB0620C014
     C*
     C                     Z-ADD*ZERO     WWEBCE
     C                     Z-ADD*ZERO     WWPBCE
     C                     Z-ADD*ZERO     WWEXUP
     C                     Z-ADD*ZERO     WWEXUL
     C                     Z-ADD*ZERO     WWPMUP
     C                     Z-ADD*ZERO     WWPMUL
     C*
     C                     END
     C                     END                                            B5986
     C*
     C           #B0       ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BA       - THIS SUBROUTINE CHECKS THE FORWARD REVALUATION *
     C**               OF INTERESTS INDICATOR AND SELECTS VALID EVENT *
     C**               TYPES.                                         *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #B                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BA       BEGSR
     C*
     C** SET OFF VALID EVENT TYPE INDICATOR
     C                     MOVE '0'       *IN24
     C*
     C** FORWARD REVALUATION OF INTERESTS INDICATOR = 'N'
     C           BNFRDI    IFEQ 'N'
     C*
     C           ETYP      IFEQ '11V1'
     C           ETYP      OREQ '11V2'
     C           ETYP      OREQ '12V1'
     C           ETYP      OREQ '12V2'
     C           ETYP      OREQ '13V1'
     C           ETYP      OREQ '13V2'
     C*
     **  SET ON VALID EVENT TYPE INDICATOR
     C                     MOVE '1'       *IN24
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C** FORWARD REVALUATION OF INTERESTS INDICATOR = 'Y'
     C           BNFRDI    IFEQ 'Y'
     C*
     C           ETYP      IFEQ '11V1'
     C           ETYP      OREQ '11V2'
     C           ETYP      OREQ '12V1'
     C           ETYP      OREQ '12V2'
     C           ETYP      OREQ '13V1'
     C           ETYP      OREQ '13V2'
     C           ETYP      OREQ '14V1'
     C           ETYP      OREQ '14V2'
     C           ETYP      OREQ '21I1'
     C*
     **  SET ON VALID EVENT TYPE INDICATOR
     C                     MOVE '1'       *IN24
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C           #BA0      ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BB       - THIS SUBROUTINE CALCULATES THE REVALUATED      *
     C**               AMOUNT FOR THE SELECTED EVENT.                 *
     C**                                                              *
     C**   CALLS     - #BBA, #BBB, #BBC                               *
     C**                                                              *
     C**   CALLED BY - #B                                             *
     C**                                                              *
     C*****************************************************************
     C           #BB       BEGSR
     C*
     C** INITIALISE TEMPORARY VARIABLES FOR THIS SUBROUTINE
     C                     Z-ADD*ZEROS    WWTMP1 138
     C                     Z-ADD*ZEROS    WWTMP2  50
     C                     Z-ADD*ZEROS    WWTMP3  50
     C                     Z-ADD*ZEROS    WWTMP4 188
     C                     Z-ADD*ZEROS    WWTMP5 138
     C                     Z-ADD*ZEROS    WWRVAM 188
     C                     Z-ADD*ZEROS    WWRAT  138
     C                     Z-ADD*ZEROS    WWPOW  159
     C*
     C** CHECK CURRENT ARRAYS ARE FILLED FROM EVENT CURRENCY AND IF NOT
     C** FILL FORWARD ARRAYS FOR THIS CURRENCY
     C           WWECCY    IFNE WWPCCY
     C                     MOVE WWECCY    WWPCCY
     C                     EXSR #BBA
     C                     ELSE                                           33150
     C                     Z-ADD#WDECP    WWDECP                          33150
     C                     END
      *
     C                     MOVE XXPMRT    WWPMRT
     C           WWPMRT    IFNE 'Y'
     C*
     C**   ACCESS CURRENCY EXTENDED FILE
     C*
     C***********OTHC      CHAINSDCURRX0             64                   S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM OTHC      @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR
     C*
     C************IN64     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD28        DBASE            ***************
     C***********          MOVEL'SDCURRX0'DBFILE           * DBERROR 025 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 025 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELWWECCY    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C**   SAVE PRECIOUS METAL INDICATOR
     C*
     C***********          MOVE CYPMRT    WWPMRT  1                       S01498
     C                     MOVE A6PMRT    WWPMRT  1                       S01498
     C                     END
     C                     END
     C*
     C** MOVE EVENT DATE INTO DATE WORK FIELD
     C                     Z-ADDEDAT      WWDATE
     C*
     C** CALCULATE FORWARD RATE FOR EVENT DATE
     C                     EXSR #BBB
     C*
     C** CALCULATE REVALUATED AMOUNT FOR EVENT DATE
     C                     EXSR #BBC
     C*
     C** IF OPTION DEALS
     C           ETYP      IFEQ '12V1'
     C           ETYP      OREQ '12V2'
     C*
     C** MOVE OTHER DATE INTO DATE WORK FIELD
     C                     Z-ADDOTHD      WWDATE
     C*
     C** IF OTHER DATE IS BEFORE RUN DATE (FIRST ELEMENT IN DATE ARRAY)
     C           WWDATE    IFLT DAT,1
     C*
     C** USE FIRST ELEMENT FROM RATE ARRAY AS FORWARD RATE
     C                     Z-ADDRAT,1     WWRAT
     C*
     C** SET ON OTHER DATE INDICATOR
     C                     MOVE '1'       *IN27
     C*
     C** CALCULATE REVALUATED AMOUNT FOR OTHER DATE
     C                     EXSR #BBC
     C*
     C                     ELSE
     C*
     C** SET ON OTHER DATE INDICATOR
     C                     MOVE '1'       *IN27
     C*
     C** CALCULATE FORWARD RATE FOR OTHER DATE
     C                     EXSR #BBB
     C*
     C** CALCULATE REVALUATED AMOUNT FOR OTHER DATE
     C                     EXSR #BBC
     C*
     C                     END
     C*
     C                     END
     C*
     C           #BB0      ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BBA      - THIS SUBROUTINE FILLS THE FORWARD RATE AND     *
     C**               DATE ARRAYS FOR THE SELECTED CURRENCY          *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - #BB                                            *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BBA      BEGSR
     C*
     C** INITIALISE ARRAYS
     C                     Z-ADD*ZEROS    DAT
     C                     Z-ADD*ZEROS    RAT
     C*
     C** INITIALISE LAST ELEMENT IN DATE ARRAY
     C                     Z-ADD26        WWLAST
     C*
     C** ACCESS FOWARD RATES FILE WITH CURRENT DEAL CURRENCY
     C           WWECCY    CHAINFWDRT                70
     C*
     C** PROCESS ONLY ACTIVE RECORDS
     C           *IN70     IFEQ '0'
     C           RECIF     ANDEQ'D'
     C           CHTPF     ANDNE'D'
     C******************** MOVELDFW       DFWC                      S01355S01328
     C*
     C** PUT TODAYS DATE IN FIRST ELEMENT OF ARRAY
     C                     Z-ADDBJRDNB    DAT,1
     C                     Z-ADD2         L
     C                     Z-ADD1         P
     C*
     C** IF FORWARD DATE ARRAY IS EMPTY
     C           DFWW,P    IFEQ *ZEROS
     C                     Z-ADD1         WWLAST
     C*
     C                     ELSE
     C*
     C** WHILE A VALID DATE EXISTS IN FORWARD DATE ARRAY USE THESE
     C**  VALUES TO FILL DATE ARRAY
     C           L         DOWLE26
     C           DFWW,P    ANDNE*ZEROS
     C           DFWW,P    ADD  BJRDNB    DAT,L
     C                     ADD  1         L
     C           L         IFNE 27
     C           L         SUB  1         P
     C                     END
     C                     END
     C*
     C** IF FORWARD DATE ARRAY NOT FULL NOTE POSITION OF LAST
     C**   VALID DATE
     C           DFWW,25   IFEQ *ZEROS
     C                     Z-ADDP         WWLAST
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C** ACCESS CURRENCIES FILE WITH REQUIRED CURRENCY
     C***********WWECCY    CHAINSDCURRL1             64                   S01498
     C*
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWECCY    @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*                                                                   S01498
     C** IF NO RECORD FOUND OR LAST CHANGE TYPE = 'D' - DBERROR
     C************IN64     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD15        DBASE            *****************
     C***********          MOVEL'SDCURRL1'DBFILE           *              S01498
     C                     MOVE 'SDCURRPD'DBFILE           *              S01498
     C                     MOVE *BLANKS   DBKEY            *  DBERROR  015 *
     C                     MOVELWWECCY    DBKEY            *               *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        *****************
     C                     ELSE
     C*
     C**   ACCESS CURRENCY EXTENDED FILE
     C*
     C***********WWECCY    CHAINSDCURRX0             64                   S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWECCY    @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR
     C*
     C************IN64     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C***********          Z-ADD28        DBASE            ***************092542
     C                     Z-ADD27        DBASE            ***************092542
     C***********          MOVEL'SDCURRX0'DBFILE           * DBERROR 025 *S01498
     C***********          MOVE 'SDCURRPD'DBFILE           * DBERROR 02598092542
     C                     MOVE 'SDCURRPD'DBFILE           * DBERROR 027 *092542
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELWWECCY    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C**   SAVE PRECIOUS METAL INDICATOR
     C*
     C***********          MOVE CYPMRT    XXPMRT  1                LB2000 S01498
     C                     MOVE A6PMRT    XXPMRT  1                       S01498
     C                     END
     C*
     C**   SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C**   FOR ROUTINE SCONV
     C           A6SPRT    IFEQ 0
     C                     DUMP
     C                     END
      *
     C                     Z-ADDA6SPRT    WWSPRT
     C                     Z-ADDA6NBDP    WWDECP
     C                     Z-ADDA6NBDP    #WDECP                          33150
     C                     MOVE A6MDIN    WWMDIV
     C*
     C**  FILL FORWARD RATE ARRAY FOR REQUIRED CURRENCY
     C                     Z-ADDA6SPRT    RAT,1
     C                     Z-ADD2         L
     C           L         DOWLE26
     C           L         SUB  1         P
     C                     Z-ADDRFWW,P    RAT,L
     C                     ADD  1         L
     C                     END
     C                     END
     C*
     C           #BBA0     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BBB      - THIS SUBROUTINE CALCULATES THE FORWARD RATE.   *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #BB                                            *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BBB      BEGSR
     C*
     C** LOOK UP DATE ARRAY FOR CURRENT DATE
     C           WWDATE    LOKUPDAT,Y                    26
     C*
     C** IF WORK DATE DOES NOT MATCH A DATE IN THE DATE ARRAY
     C           *IN26     IFEQ '0'
     C                     Z-ADD1         N
     C           WWDATE    DOWGTDAT,N
     C           N         ANDLTWWLAST
     C                     ADD  1         N
     C                     END
     C           N         SUB  1         M
     C*
     C** IF DATE BETWEEN TWO DATES ON ARRAY
     C           WWDATE    IFLT DAT,N
     C*
     C** USE TEMPORARY VARIABLES TO CALCULATE RATE
     C           RAT,N     SUB  RAT,M     WWTMP1
     C           WWDATE    SUB  DAT,M     WWTMP2
     C           DAT,N     SUB  DAT,M     WWTMP3
     C           WWTMP1    MULT WWTMP2    WWTMP4
     C           WWTMP4    DIV  WWTMP3    WWTMP5
     C           RAT,M     ADD  WWTMP5    WWRAT
     C*
     C                     ELSE
     C*
     C** IF WORK DATE AFTER LAST DATE IN ARRAY
     C                     MOVE RAT,N     WWRAT
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C** EVENT DATE MATCHES A DATE IN THE ARRAY
     C                     Z-ADDRAT,Y     WWRAT
     C*
     C                     END
     C*
     C** IF NO RATE RETRIEVED FROM FORWARD RATES FILE USE SPOT RATE
     C           WWRAT     IFEQ *ZEROS
     C                     Z-ADDWWSPRT    WWRAT
     C                     END
     C*
     C** DECIDE IF RATE IS FOR EVENT DATE OR OTHER DATE
     C           *IN27     IFEQ '1'
     C*
     C** RATE IS FOR OTHER DATE
     C                     Z-ADDWWRAT     WWORAT
     C*
     C                     ELSE
     C*
     C** RATE IS FOR EVENT DATE
     C                     Z-ADDWWRAT     WWERAT
     C*
     C                     END
     C*
     C           #BBB0     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BBC      - THIS SUBROUTINE CALCULATES THE REVALUATED      *
     C**               AMOUNT.                                        *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #BB                                            *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BBC      BEGSR
     C*
     C** EVENT AMOUNT IS SPECIFIED FOR THE BANK
     C** REVERSE SIGN TO HAVE CUSTOMER'S EVENT AMOUNT
     C                     Z-SUBEAMT      EAMT
     C*
     C** CALCULATE REFERENCE NUMBER FOR POWER ARRAY
     C           WWDECP    SUB  WWDPI     K       10
     C           K         ADD  4         K
     C*
     C** CALCULATE REVALUATED AMOUNT
     C           WWMDIV    IFEQ 'M'
     C*
     C** APPLY POWER OF 10
     C           WWRAT     DIV  POWER,K   WWPOW
     C           EAMT      MULT WWPOW     WWRVAM
     C*
     C                     ELSE
     C*
     C*
     C** APPLY POWER OF 10
     C           WWRAT     MULT POWER,K   WWPOW
     C           WWPOW     IFNE 0
     C           EAMT      DIV  WWPOW     WWRVAM
     C                     ELSE
     C                     DUMP
     C                     Z-ADD0         WWRVAM
     C                     END
     C*
     C                     END
     C*
     C** DECIDE IF REVALUATED AMOUNT IS FOR EVENT DATE OR OTHER DATE
     C           *IN27     IFEQ '1'
     C*
     C** REVALUATED AMOUNT IS FOR OTHER DATE
     C                     Z-ADDWWRVAM    WWRVOT    H
     C*
     C** SET OFF INDICATOR FOR OTHER DATE
     C                     MOVE '0'       *IN27
     C*
     C                     ELSE
     C*
     C** REVALUATED AMOUNT IS FOR EVENT DATE
     C                     Z-ADDWWRVAM    WWRVEV    H
     C*
     C                     END
     C*
     C           #BBC0     ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BC       - THIS SUBROUTINE CALCULATES THE PROFIT/ LOSS    *
     C**               AMOUNT                                         *
     C**                                                              *
     C**   CALLS     - SCONV                                          *
     C**                                                              *
     C**   CALLED BY - #B                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BC       BEGSR
     C*
     C** INITIALISE INCOMING/OUTGOING, POSITIVE/NEGATIVE INDICATORS
     C                     MOVE '0'       *IN28
     C                     MOVE '0'       *IN29
     C                     MOVE '0'       *IN30
     C                     MOVE '0'       *IN31
     C*
     C** INITIALISE VARIABLES FOR EVENT DATE AND OTHER DATE
     C**  PROFIT/LOSS AMOUNTS
     C                     Z-ADD*ZEROS    WWEPLA 150
     C                     Z-ADD*ZEROS    WWOPLA 150
     C*
     C** IF EVENT IS INCOMING
     C           ETYP      IFEQ '11V1'
     C           ETYP      OREQ '12V1'
     C           ETYP      OREQ '13V1'
     C           ETYP      OREQ '14V3'
     C           ETYP      OREQ '14V4'
     C           ETYP      OREQ '21I1'
     C           INOI      ANDEQ'I'
     C*
     C** SET ON INCOMING EVENT INDICATOR
     C                     MOVE '1'       *IN28
     C*
     C                     ELSE
     C*
     C** SET ON OUTGOING EVENT INDICATOR
     C                     MOVE '1'       *IN29
     C*
     C                     END
     C*
     C** SET UP VALUES FOR NEGATIVE EVENT AMOUNT
     C           EAMT      IFLT *ZEROS
     C                     Z-SUBWWRVEV    WWRVEV
     C                     Z-SUBWWRVOT    WWRVOT
     C                     END
     C*
     C** IF EVENT IS OUTGOING/POSITIVE OR INCOMING/NEGATIVE
     C           *IN29     IFEQ '1'
     C           EAMT      ANDGE*ZEROS
     C           *IN28     OREQ '1'
     C           EAMT      ANDLT*ZEROS
     C*
     C** SET ON NEGATIVE EVENT INDICATOR
     C                     MOVE '1'       *IN30
     C*
     C                     ELSE
     C*
     C** SET ON POSITIVE EVENT INDICATOR
     C                     MOVE '1'       *IN31
     C*
     C                     END
     C*
     C** FOR NON-OPTION DEAL EVENTS
     C           ETYP      IFNE '12V1'
     C           ETYP      ANDNE'12V2'
     C*
     C** CALCULATE PROFIT/LOSS AMOUNT FOR POSITIVE EVENT
     C           *IN31     IFEQ '1'
     C           WWRVEV    SUB  DBCE      WWPLAM
     C*
     C                     ELSE
     C** CALCULATE PROFIT/LOSS AMOUNT FOR NEGATIVE EVENT
     C           *IN30     IFEQ '1'
     C           DBCE      SUB  WWRVEV    WWPLAM
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C** FOR POSITIVE OPTION DEAL EVENTS
     C           *IN31     IFEQ '1'
     C*
     C*  CALCULATE PROFIT/LOSS AMOUNT FOR EVENT DATE
     C           WWRVEV    SUB  DBCE      WWEPLA
     C*
     C** CALCULATE PROFIT/LOSS AMOUNT FOR OTHER DATE
     C           WWRVOT    SUB  DBCE      WWOPLA
     C*
     C                     ELSE
     C*
     C** FOR NEGATIVE OPTION DEAL EVENTS
     C           *IN30     IFEQ '1'
     C*
     C*  CALCULATE PROFIT/LOSS AMOUNT FOR EVENT DATE
     C           DBCE      SUB  WWRVEV    WWEPLA
     C*
     C** CALCULATE PROFIT/LOSS AMOUNT FOR OTHER DATE
     C           DBCE      SUB  WWRVOT    WWOPLA
     C*
     C                     END
     C*
     C                     END
     C*
     C** DECIDE WHICH IS THE LEAST PROFIT OR GREATEST LOSS
     C           WWOPLA    IFGT WWEPLA
     C                     Z-ADDWWEPLA    WWPLAM
     C                     ELSE
     C                     Z-ADDWWOPLA    WWPLAM
     C                     END
     C*
     C                     END
     C*
     C** CONVERT P/L AMOUNT FROM BASE CURRENCY TO PORTFOLIO CURRENCY
     C                     Z-ADDWWPLAM    WWAMTI
     C                     EXSR SCONV
     C*
     C** IF CONVERTED PROFIT/LOSS AMOUNT IS POSITIVE
     C           WWAMTO    IFGE *ZEROS
     C                     Z-ADDWWAMTO    WWAMTP 150
     C*
     C** SET UP RIGHTMOST POSITION OF EVENT TYPE
     C*
     C** ACCUMULATE RUNNING TOTAL FOR UNREALISED PROFIT
     C*
     C           WWPMRT    IFEQ 'N'
     C                     ADD  WWAMTP    WWEXUP
     C                     ADD  WWRVEV    WWEBCE 150
     C                     MOVE '0'       *IN45
     C                     ELSE
     C                     ADD  WWAMTP    WWPMUP
     C                     ADD  WWRVEV    WWPBCE 150
     C                     MOVE '1'       *IN45
     C                     END
     C*
     C                     ELSE
     C                     Z-SUBWWAMTO    WWAMTP
     C*
     C** ACCUMULATE RUNNING TOTAL FOR UNREALISED LOSS
     C*
     C           WWPMRT    IFEQ 'N'
     C                     ADD  WWAMTP    WWEXUL
     C                     ADD  WWRVEV    WWEBCE
     C                     MOVE '0'       *IN45
     C                     ELSE
     C                     ADD  WWAMTP    WWPMUL
     C                     ADD  WWRVEV    WWPBCE
     C                     MOVE '1'       *IN45
     C                     END
     C*
     C                     END
     C/COPY WNCPYSRC,LB0620C015
     C*
     C           #BC0      ENDSR
     ******************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BD          - THIS SUBROUTINE WRITES A DETAIL LINE TO    *
     C**                   THE FORWARD REGENERATION REPORT.           *
     C**                                                              *
     C**    CALLS        - ZDATE2, ZSEDIT                             *
     C**                                                              *
     C**    CALLED BY    - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BD       BEGSR
     C*
     C** MOVE VARIABLE VALUES INTO REPORT FIELDS
     C*
     C** CUSTOMER NUMBER
     C                     MOVE ECCY      RRECCY
     C*
     C** VALUE DATE
     C                     Z-ADDEDAT      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RREDAT
     C*
     C** DEAL NUMBER
     C                     MOVE DLNO      RRDLNO
     C*
     C** DEAL TYPE
     C                     MOVE DTYP      RRDTYP
     C*
     C** DEAL SUBTYPE
     C                     MOVE DLST      RRDLST
     C*
     C** EVENT AMOUNT
     C                     Z-ADDEAMT      ZFLD15
     C                     Z-ADDWWDECP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RREAMT
     C*
     C** EVENT AMOUNT SIGN
     C           *IN30     IFEQ '1'
     C                     MOVE '-'       RREVSG
     C                     ELSE
     C           *IN31     IFEQ '1'
     C                     MOVE '+'       RREVSG
     C                     END
     C                     END
     C*
     C** DEALT EQUIVALENT
     C                     Z-ADDDBCE      ZFLD15
     C                     Z-ADDWWDPI     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRDBCE
     C*
     C** RATE
     C                     MOVE WWERAT    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRERAT
     C*
     C** REVALUED EQUIVALENT
     C                     Z-ADDWWRVEV    ZFLD15
     C                     Z-ADDWWDPI     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRRVEV
     C*
     C** PROFIT/LOSS AMOUNT
     C                     Z-ADDWWAMTP    ZFLD15
     C*****                Z-ADDWWDPI     ZDECS                           B10523
     C                     Z-ADDWWDPO     ZDECS                           B10523
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRPLAM
     C*
     C** PROFIT/LOSS AMOUNT SIGN
     C           WWAMTO    IFGE *ZEROS
     C                     MOVE '+'       RRPLSG
     C                     ELSE
     C                     MOVE '-'       RRPLSG
     C                     END
     C*
     C** CHECK FOR OVERFLOW AND IF NECESSARY OUTPUT HEADINGS
     C           LINE2     IFGE 60
     C           *IN67     ANDEQ'0'                               37505
     C                     WRITEHEADER1
     C                     WRITEHEADER2
     C                     END
     C*
     C** PRINT DETAIL LINE
     C                     WRITEDETAIL
     C*
     C           #BD0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BE          - THIS SUBROUTINE CALCULATES CUSTOMER        *
     C**                   MARGINS.                                   *
     C**                                                              *
     C**    CALLS        - #ZA, SCONV                                 *
     C**                                                              *
     C**    CALLED BY    - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BE       BEGSR
     C*
     C** INITIALISE RECORDS-SELECTED-ON-LIMITS-FILE FLAG
     C*
     C                     MOVE 'N'       WWRSLF  1
     C                     MOVE 'N'       WWLIMI  1
     C*
     C** READ FIRST RECORD
     C*
     C***********KKCNUM    CHAINLIMILBJ1             71                   S01498
     C           KKCNUM    CHAINLBLIMIJ1             71                   S01498
     C*
     C** SAVE CUSTOMER
     C*
     C                     MOVE BBPCNB    WWPARE
     C*
     C***IF*ACTIVE*&*FX*LIMIT*EXPIRY*DATE*>*EVENT*CONTROL*DATE****        B08157
     C** IF ACTIVE, OBTAIN METAL LIMITS                                   B08157
     C*
     C           *IN71     IFEQ '0'
     C***********RECIL     ANDEQ'D'                                       S01498
     C**         FLED      ANDGTBJDNWD                                    B08157
     C*                                                                   B10035
     C***********SARS      IFEQ 'Y'                                B10035 S01498
     C*
     C** ACCESS DEALING LIMITS EXTENDED FILE TO GET PRECIOUS METALS LIMITS
     C***********KLIMX0    CHAINLIMITBX0             65                   S01498
     C*
     C                     CALL 'AOCLLMR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM CNUML     @KEY1   6                       S01498
     C                     PARM 'S'       @KEY2   1                       S01498
     C***********          PARM BBBRCD    @KEY3   3                 S01498086863
     C                     PARM 'SYS'     @KEY3   3                       086863
     C           @CLLM     PARM @CLLM     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND
     C*
     C************IN65     IFEQ '1'                        ************** S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD29        DBASE            *             *
     C***********          MOVEL'LIMTBX0 'DBFILE           * DBERROR 029 *S01498
     C                     MOVE 'SDCLLMPD'DBFILE           * DBERROR 029 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C***********          MOVELFLTY      DBKEY            ************** S01498
     C***********          MOVELDZFXLT    DBKEY            *********S01498086863
     C                     MOVELCNUML     DBKEY            ************** 086863
     C                     MOVE 'SSYS'    DBKEY                           086863
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C***********          END                                     B10035 S01498
     C*
     C** RECORDS SELECTED ON LIMITS FILE
     C*
     C                     MOVE 'Y'       WWRSLF
     C*
     C                     END
     C*
     C           *IN71     IFEQ '1'
     C           WWEBCE    ANDNE*ZERO
     C           *IN71     OREQ '1'
     C           WWPBCE    ANDNE*ZERO
     C*
     C                     MOVE 'Y'       WWRSLF
     C*
     C                     END
     C*
     C** WRITE HEADER
     C*
     C           LINE2     IFGE 52
     C                     WRITEHEADER1
     C                     END
     C*
     C           WWRSLF    IFEQ 'Y'
     C*
     C           WWEBCE    IFEQ *ZERO
     C           WWPBCE    ANDEQ*ZERO
     C                     WRITEHEADER1
     C                     END
     C                     WRITEHEADER4
     C*
     C** CALCULATE MARGIN
     C                     EXSR #BEA
     C*
     C** WRITE END OF REPORT LINES
     C                     EXSR #BEB
     C*                                                                   R01168
     C** WRITE RECORDS TO NEW EXTRACT FILE LBEXCOPD                       R01168
     C                     EXSR #BED                                      R01168
     C*
     C** WRITE RECORD TO EXTRACT FILE
     C*
     C                     EXSR #BEC
     C*
     C                     END
     C*
     C***IF*NO*RECORDS*SELECTED*ON*LIMITS*FILE*-*OUTPUT*NULL*REPORT****   S01498
     C*
     C***********WWRSLF    IFEQ 'N'                                       S01498
     C***********WWEBCE    ANDNE*ZERO                                     S01498
     C***********WWRSLF    OREQ 'N'                                       S01498
     C***********WWPBCE    ANDNE*ZERO                                     S01498
     C***********          WRITENODETLS                                   S01498
     C***********          END                                            S01498
     C*
     C                     MOVE 'Y'       WWLIMI
     C*
     C           #BE0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BEA         - THIS SUBROUTINE CALCULATES CUSTOMER        *
     C**                   MARGINS.                                   *
     C**                                                              *
     C**    CALLS        - #ZA, SCONV                                 *
     C**                                                              *
     C**    CALLED BY    - #BE                                        *
     C**                                                              *
     C*****************************************************************
     C           #BEA      BEGSR
     C*
     C** INITIALISE LOCAL VARIABLES
     C                     Z-ADD*ZEROS    WWLIMT 152
     C                     Z-ADD*ZEROS    WWLIMX 150
     C                     Z-ADD*ZEROS    WWLIMP 150
     C                     Z-ADD*ZEROS    WWNETL 150
     C                     Z-ADD*ZEROS    WWNETP 150
     C                     Z-ADD*ZEROS    WWPRC1  32
     C                     Z-ADD*ZEROS    WWPRC2  32
     C                     Z-ADD*ZEROS    WWPRC3  32                      SA9109
     C                     Z-ADD*ZEROS    WWPRCM  32                      B08157
     C                     MOVE *BLANKS   WWLTYP  3
     C*                                                                   B08157
     C           *IN71     IFEQ '0'
     C*
     C** MOVE FX LIMIT TYPE INTO 3 ALPHA FIELD
     C***********FLTY      IFNE 0                                  B08157 S01498
     C***********          MOVE FLTY      WWLTYP                          S01498
     C           DZFXLT    IFNE '000'                                     S01498
     C           DZFXLT    ANDNE*BLANKS                                   086863
     C                     MOVE DZFXLT    WWLTYP                          S01498
     C*
     C** ACCESS LIMITS FILE USING LIMIT TYPE
     C***********WWLTYP    CHAINSDLIMTL0             72                   S01498
     C*
     C                     CALL 'AOLIMTR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWLTYP    @LMTY   3                       S01498
     C           @LIMT     PARM @LIMT     DSSDY                           S01498
     C*                                                                   S01498
     C** IF NO RECORD FOUND OR LAST CHANGE TYPE = 'D' THEN DBERROR
     C************IN72     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A2TYLC    OREQ 'D'
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD17        DBASE            ***************
     C                     MOVE *BLANKS   DBFILE           *             *
     C***********          MOVEL'SDLIMTL0'DBFILE           * DBERROR 017 *S01498
     C                     MOVE 'SDLIMTPD'DBFILE           * DBERROR 017 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELWWLTYP    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C*
     C** CALCULATE PERCENTAGE LIMIT FOR FIRST PERIOD
     C           A2PL1P    DIV  100       WWPRC1
     C                     END                                            B08157
     C*                                                                   B08157
     C** MOVE PM LIMIT TYPE INTO 3 ALPHA FIELD                            B08157
     C***********LIPLTY    IFNE 0                                  B08157 S01498
     C***********          MOVE LIPLTY    WWLTYP                   B08157 S01498
     C           S01433    IFEQ 'Y'                                       087631
     C           DZPLTY    IFNE '000'                                     S01498
     C           DZPLTY    ANDNE*BLANKS                                   086863
     C                     MOVE DZPLTY    WWLTYP                          S01498
     C*                                                                   B08157
     C** ACCESS LIMITS FILE USING LIMIT TYPE                              B08157
     C***********WWLTYP    CHAINSDLIMTL0             72            B08157 S01498
     C*                                                                   B08157
     C                     CALL 'AOLIMTR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWLTYP    @LMTY   3                       S01498
     C           @LIMT     PARM @LIMT     DSSDY                           S01498
     C*                                                                   S01498
     C** IF NO RECORD FOUND OR LAST CHANGE TYPE = 'D' THEN DBERROR        B08157
     C************IN72     IFEQ '1'                                B08157 S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A2TYLC    OREQ 'D'                                       B08157
     C           *LOCK     IN   LDA                                       S01498
     C***********          Z-ADD17        DBASE            ********B08157 092542
     C                     Z-ADD13        DBASE            ***************092542
     C                     MOVE *BLANKS   DBFILE           *             *B08157
     C***********          MOVEL'SDLIMTL0'DBFILE           * DBERR B08157 S01498
     C***********          MOVE 'SDLIMTPD'DBFILE           * DBERROR 01798092542
     C                     MOVE 'SDLIMTPD'DBFILE           * DBERROR 013 *092542
     C                     MOVE *BLANKS   DBKEY            *             *B08157
     C                     MOVELWWLTYP    DBKEY            ***************B08157
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       B08157
     C                     END                                            B08157
     C*                                                                   B08157
     C** CALCULATE PERCENTAGE LIMIT FOR FIRST PERIOD                      B08157
     C           A2PL1P    DIV  100       WWPRCM                          B08157
     C                     END                                            B08157
     C                     ELSE                                           087631
     C                     Z-ADD*ZEROS    WWPRCM                          087631
     C                     END                                            087631
     C*                                                                   B08157
     C                     ELSE
     C***********          Z-ADD*ZERO     FAMM                            S01498
     C***********          Z-ADD*ZERO     LIPSAM                          S01498
     C                     Z-ADD*ZERO     DZFXFA                          087376
     C                     Z-ADD*ZERO     DZFLAM                          087631
     C                     Z-ADD*ZERO     DZPFAM                          S01498
     C***********          Z-ADD*ZERO     DZPSAM                    S01498087376
     C                     END
     C*
     C** USE TO CALCULATE LIMIT
     C***********FAMM      MULT WWPRC1    WWLIMT                          S01498
     C***********DZPFAM    MULT WWPRC1    WWLIMT                    S01498087376
     C           S01433    IFEQ 'Y'                                       087631
     C           DZFXFA    MULT WWPRC1    WWLIMT                          087376
     C                     ELSE                                           087631
     C           DZFLAM    MULT WWPRC1    WWLIMT                          087631
     C                     END                                            087631
     C*
     C** MULTIPLY BY 1000 TO MATCH FILE
     C                     MULT 1000      WWLIMT
     C*
     C** LIMIT IS WITHOUT DECIMALS IN LIMIT FILE;
     C** CHANGE LIMIT DEPENDING ON BANK NBR OF DECIMALS
     C***        WWDPI     IFEQ 1                                         B10526
     C           WWDPL     IFEQ 1                                         B10526
     C                     MULT 10        WWLIMT
     C                     ELSE
     C***        WWDPI     IFEQ 2                                         B10526
     C           WWDPL     IFEQ 2                                         B10526
     C                     MULT 100       WWLIMT
     C                     ELSE
     C***        WWDPI     IFEQ 3                                         B10526
     C           WWDPL     IFEQ 3                                         B10526
     C                     MULT 1000      WWLIMT
     C                     END
     C                     END
     C                     END
     C*
     C** CONVERT LIMIT FROM BASE CURRENCY TO PORTFOLIO CURRENCY
     C***                  Z-ADDWWDPI     WWDECP                          B10526
     C                     Z-ADDWWDPL     WWDECP                          B10526
     C** CONVERT FX LIMIT FROM DEALING CCY INTO PORTFOLIO CCY             B10526
     C** I = DEALING CURRENCY; O = PORTFOLIO CURRENCY                     B10526
     C                     Z-ADDWWSRI     WWSRII 138                      B10526
     C                     Z-ADDWWDPI     WWDPII  10                      B10526
     C                     MOVE WWMDI     WWMDII  1                       B10526
     C                     Z-ADDWWSRL     WWSRI                           B10526
     C                     Z-ADDWWDPL     WWDPI                           B10526
     C                     MOVE WWMDL     WWMDI                           B10526
     C                     Z-ADDWWLIMT    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    WWLIMX
     C** REPLACE INPUT AND OUTPUT CCY'S FOR FURTHER PROCESSING            B10526
     C** I = BASE CURRENCY; O = PORTFOLIO CURRENCY                        B10526
     C                     Z-ADDWWSRII    WWSRI                           B10526
     C                     Z-ADDWWDPII    WWDPI                           B10526
     C                     MOVE WWMDII    WWMDI                           B10526
     C*
     C** ACCESS MARGIN PERC. EXTENSION FILE TO OBTAIN PERC. FOR CLIENT    SA9109
     C*                                                                   SA9109
     C************LOVAL    SETLLSDLBCSY0                           SA9109 S01498
     C***********RRCNUM    CHAINSDLBCSY0             20            SA9109 S01498
     C*                                                                   SA9109
     C                     CALL 'AOLBCSR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM RRCNUM    @CUSN  10                       S01498
     C           @LBCS     PARM @LBCS     DSSDY                           S01498
     C*                                                                   S01498
     C** IF NOT FOUND, THEN IT IS A DATABASE ERROR                        SA9109
     C*                                                                   SA9109
     C************IN20     IFEQ '1'                                SA9109 S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD36        DBASE            ***************SA9109
     C***********          MOVEL'SDLBCSY0'DBFILE           * DBERR SA9109 S01498
     C                     MOVE 'SDLBCSPD'DBFILE           * DBERROR 036 *S01498
     C                     MOVE *BLANKS   DBKEY            ***************SA9109
     C                     MOVELRRCNUM    DBKEY                           SA9109
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       SA9109
     C                     END                                            SA9109
     C** CALCULATE PERCENTAGE FOREX MARGIN
     C*
     C           LBFXCP    DIV  100       WWPRC2
     C***********LBFORX    DIV  100       WWPRC3                   SA9109 S01498
     C           CUFORX    DIV  100       WWPRC3                          S01498
     C*
     C** CALCULATE FOREX MARGIN AS AN EXPOSURE
     C           WWLIMX    MULT WWPRC2    WWEXMA
     C***********WWLIMX    MULT WWPRC3    WWLBFX                    SA9109095719
     C                     Z-ADDWWLIMX    WWLBFX                          095719
     C*
     C** USE TO CALCULATE LIMIT
     C**         LIPSAM    MULT WWPRC1    WWLIMT                          B08157
     C***********LIPSAM    MULT WWPRCM    WWLIMT                   B08157 S01498
     C***********DZPSAM    MULT WWPRCM    WWLIMT                    S01498087376
     C           S01433    IFEQ 'Y'                                       087631
     C           DZPFAM    MULT WWPRCM    WWLIMT                          087376
     C*
     C** MULTIPLY BY 1000 TO MATCH FILE
     C                     MULT 1000      WWLIMT
     C*
     C** LIMIT IS WITHOUT DECIMALS IN LIMIT FILE;
     C** CHANGE LIMIT DEPENDING ON BANK NBR OF DECIMALS
     C           WWDPI     IFEQ 1
     C                     MULT 10        WWLIMT
     C                     ELSE
     C           WWDPI     IFEQ 2
     C                     MULT 100       WWLIMT
     C                     ELSE
     C           WWDPI     IFEQ 3
     C                     MULT 1000      WWLIMT
     C                     END
     C                     END
     C                     END
     C*
     C** CONVERT LIMIT FROM BASE CURRENCY TO PORTFOLIO CURRENCY
     C                     Z-ADDWWDPI     WWDECP
     C                     Z-ADDWWLIMT    WWAMTI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    WWLIMP
     C*
     C** CALCULATE PERCENTAGE PRECIOUS METALS MARGIN
     C*
     C           LBPMCP    DIV  100       WWPRC2
     C***********LBFORP    DIV  100       WWPRC3                   SA9109 S01498
     C           CUFORP    DIV  100       WWPRC3                          S01498
     C*
     C** CALCULATE PRECIOUS METALS MARGIN AS AN EXPOSURE
     C           WWLIMP    MULT WWPRC2    WWXPMA
     C           WWLIMP    MULT WWPRC3    WWLBFP                          B7855
     C                     ELSE                                           087631
     C                     Z-ADD*ZEROS    WWXPMA                          087631
     C                     Z-ADD*ZEROS    WWLBFP                          087631
     C                     Z-ADD*ZEROS    WWLIMP                          087631
     C                     END                                            087631
     C*
     C           #BEA0     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BEB         - THIS SUBROUTINE OUTPUTS DETAILS FOR        *
     C**                   MARGINS.                                   *
     C**                                                              *
     C**    CALLS        - #ZA, SCONV                                 *
     C**                                                              *
     C**    CALLED BY    - #BE                                        *
     C**                                                              *
     C*****************************************************************
     C           #BEB      BEGSR
     C*
     C** OUTPUT REPORT
     C*
     C                     MOVE BJCYCD    RRECCY
     C*
     C** FX MARGIN INST
     C*
     C                     MOVE LBFXMA    R3FXMA
     C*
     C** FX LIMIT
     C*
     C*****                Z-ADDWWLIMX    ZFLD15                          B10523
     C                     Z-ADDWWOPNF    ZFLD15                          B10523
     C*****                Z-ADDWWDPO     ZDECS                           B10523
     C                     Z-ADDWWDPI     ZDECS                           B10523
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3LIMX
     C*
     C** FX MARGIN %
     C*
     C*********************MOVE LBFXCP    R3FXCP                          SA9109
     C***********          MOVE LBFORX    R3FXCP                   SA9109 S01498
     C***********          MOVE CUFORX    R3FXCP                   S01498 080375
     C                     Z-ADDCUFORX    R3FXCP                          080375
     C*
     C** FX MARGIN
     C*
     C*********************Z-ADDWWEXMA    ZFLD15                          SA9109
     C                     Z-ADDWWLBFX    ZFLD15                          SA9109
     C*****                Z-ADDWWDPO     ZDECS                           B10523
     C                     Z-ADDWWDPI     ZDECS                           B10523
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3EXMA
     C*
     C** UNREALISED LOSS
     C*
     C                     Z-ADDWWEXUL    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3EXUL
     C*
     C** UNREALISED PROFIT
     C*
     C                     Z-ADDWWEXUP    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3EXUP
     C*
     C** NET FX UNREALISED LOSS
     C*
     C           WWEXUP    SUB  WWEXUL    WWNETL
     C                     Z-ADDWWNETL    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3NETL
     C*
     C** NET FX UNREALISED LOSS SIGN
     C*
     C           WWNETL    IFLT *ZERO
     C                     MOVE '-'       R3FPLS
     C                     ELSE
     C                     MOVE '+'       R3FPLS
     C                     END
     C*
     C** PM MARGIN INST
     C*
     C           S01433    IFEQ 'Y'                                       087631
     C                     MOVE LBPMMA    R3PMMA
     C                     ELSE                                           087631
     C                     MOVE *BLANKS   R3PMMA                          087631
     C                     END                                            087631
     C*
     C** PM LIMIT
     C*
     C                     Z-ADDWWLIMP    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3LIMP
     C*
     C** PM MARGIN %
     C*
     C*********************MOVE LBPMCP    R3PMCP                          SA9109
     C***********          MOVE LBFORP    R3PMCP                   SA9109 S01498
     C***********          MOVE CUFORP    R3PMCP                   S01498 080375
     C           S01433    IFEQ 'Y'                                       087631
     C                     Z-ADDCUFORP    R3PMCP                          080375
     C                     ELSE                                           087631
     C                     Z-ADD*ZEROS    R3PMCP                          087631
     C                     END                                            087631
     C*
     C** PM MARGIN
     C*
     C*********************Z-ADDWWXPMA    ZFLD15                          SA9109
     C                     Z-ADDWWLBFP    ZFLD15                          SA9109
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3XPMA
     C*
     C** UNREALISED LOSS
     C*
     C                     Z-ADDWWPMUL    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3PMUL
     C*
     C** UNREALISED PROFIT
     C*
     C                     Z-ADDWWPMUP    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3PMUP
     C*
     C** NET PM UNREALISED LOSS
     C*
     C           WWPMUP    SUB  WWPMUL    WWNETP
     C                     Z-ADDWWNETP    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R3NETP
     C*
     C** PM NET FX UNREALISED LOSS SIGN
     C*
     C           WWNETP    IFLT *ZERO
     C                     MOVE '-'       R3PPLS
     C                     ELSE
     C                     MOVE '+'       R3PPLS
     C                     END
     C*
     C** PRINT DETAIL LINE
     C                     WRITEDETAIL3
     C*
     C           #BEB0     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BEC         - THIS SUBROUTINE WRITES RECORDS TO PORTFOLIO*
     C**                   EXTRACT FILE FOR MARGINS                   *
     C**                                                              *
     C**    CALLS        - #ZA, SCONV                                 *
     C**                                                              *
     C**    CALLED BY    - #BE                                        *
     C**                                                              *
     C*****************************************************************
     C           #BEC      BEGSR
     C*
     C** IF MARGIN INSTRUMENT EXPOSURE IS NOT ZERO
     C           WWEXMA    IFNE *ZEROS
     C*
     C** SET UP FIELDS FOR MARGIN INSTRUMENT
     C           WWLIMI    IFEQ 'Y'
     C                     MOVE '@OF'     EEINST
     C                     ELSE
     C                     MOVE LBFXMA    EEINST
     C                     END
     C**                   Z-ADDWWEXMA    EEEXPS                          B07909
     C*****                Z-ADDWWLBFX    EEEXPS                    B07909B10524
     C                     Z-ADDWWLBFX    WWAMTI                          B10524
     C                     EXSR SCONV                                     B10524
     C***********          Z-ADDWWAMTO    EEEXPS                    B10524095719
     C           WWAMTO    MULT WWPRC3    EEEXPS                          095719
     C*****                Z-ADDWWLBFX    EEMARG                    SA9109B10524
     C***********          Z-ADDWWAMTO    EEMARG                    B10524095719
     C           WWAMTO    MULT WWPRC3    EEMARG                          095719
     C***********          Z-ADDLBFORX    EEMGPC                   SA9109 S01498
     C                     Z-ADDCUFORX    EEMGPC                          S01498
     C                     Z-ADD0         EECOLL
     C                     MOVE WWGRMA    EELCGR
     C                     MOVE WWGSMA    EELCGS
     C                     MOVE WWCIMA    EECIFL
     C           EEINST    IFEQ LBLIFX                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIFX    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C*                                                                   R0170
     C** OUTPUT EXPOSURE IF MARGIN CALCULATED ON EXPOSURE                 R0170
     C           LBMGLE    IFEQ 'E'                                       R0170
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIMX    EEEXPO                          R0170
     C                     ELSE                                           R0170
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C                     END                                            R0170
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C*
     C** CHECK TO SEE IF KEY ALREADY EXISTS ON FILE
     C           WWEEK1    CHAINLBEXTRL2             74
     C*
     C           *IN74     IFEQ '1'
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         WWRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C                     ELSE
     C*
     C**                   Z-ADDWWEXMA    EEEXPS                          B07909
     C*****                Z-ADDWWLBFX    EEEXPS                    B07909B10524
     C*****                Z-ADDWWLBFX    EEMARG                    SA9109B10524
     C***********          Z-ADDWWAMTO    EEEXPS                    B10524095719
     C***********          Z-ADDWWAMTO    EEMARG                    B10524095719
     C           WWAMTO    MULT WWPRC3    EEEXPS                          095719
     C           WWAMTO    MULT WWPRC3    EEMARG                          095719
     C***********          Z-ADDLBFORX    EEMGPC                   SA9109 S01498
     C                     Z-ADDCUFORX    EEMGPC                          S01498
     C                     UPDATLBEXTRD0
     C*
     C                     END
     C*
     C** INITIALISE MARGIN AMOUNT FOR NEXT CUSTOMER
     C                     Z-ADD*ZEROS    WWEXMA
     C                     Z-ADD*ZEROS    WWLBFX                          SA9109
     C*
     C                     END
     C*
     C** IF MARGIN INSTRUMENT EXPOSURE IS NOT ZERO
     C           WWXPMA    IFNE *ZEROS
     C           S01433    ANDEQ'Y'                                       087631
     C*
     C** SET UP FIELDS FOR MARGIN INSTRUMENT
     C           WWLIMI    IFEQ 'Y'
     C                     MOVE '@OP'     EEINST
     C                     ELSE
     C                     MOVE LBPMMA    EEINST
     C                     END
     C**                   Z-ADDWWXPMA    EEEXPS                          B07909
     C                     Z-ADDWWLBFP    EEEXPS                          B07909
     C                     Z-ADDWWLBFP    EEMARG                          SA9109
     C***********          Z-ADDLBFORP    EEMGPC                   SA9109 S01498
     C                     Z-ADDCUFORP    EEMGPC                          S01498
     C                     Z-ADD0         EECOLL
     C                     MOVE WWGRPA    EELCGR
     C                     MOVE WWGSPA    EELCGS
     C                     MOVE WWCIPA    EECIFL
     C           EEINST    IFEQ LBLIPM                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIPM    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C*                                                                   R0170
     C** OUTPUT EXPOSURE IF MARGIN CALCULATED ON EXPOSURE                 R0170
     C           LBMGLE    IFEQ 'E'                                       R0170
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIMP    EEEXPO                          R0170
     C                     ELSE                                           R0170
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C                     END                                            R0170
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C*
     C** CHECK TO SEE IF KEY ALREADY EXISTS ON FILE
     C           WWEEK1    CHAINLBEXTRL2             74
     C*
     C           *IN74     IFEQ '1'
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         WWRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C                     ELSE
     C*
     C**                   Z-ADDWWXPMA    EEEXPS                          B07909
     C                     Z-ADDWWLIPM    EELIMT                          043724
     C                     Z-ADDWWLBFP    EEEXPS                          B07909
     C                     Z-ADDWWLBFP    EEMARG                          SA9109
     C***********          Z-ADDLBFORP    EEMGPC                   SA9109 S01498
     C                     Z-ADDCUFORP    EEMGPC                          S01498
     C                     UPDATLBEXTRD0
     C*
     C                     END
     C*
     C** INITIALISE MARGIN AMOUNT FOR NEXT CUSTOMER
     C                     Z-ADD*ZEROS    WWXPMA
     C                     Z-ADD*ZEROS    WWLBFP                          SA9109
     C*
     C                     END
     C*
     C           #BEC0     ENDSR
     C/EJECT                                                              R01168
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BED         - PERFORMS CALCULATIONS TO WRITE RECORD TO   *   R01168
     C**                   NEW EXTRACT FILE LBEXCOPD                  *   R01168
     C**                                                              *   R01168
     C**    CALLS        - #BEDA                                      *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BE                                        *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BED      BEGSR                                          R01168
     C*                                                                   R01168
     C                     MOVE LBFXMA    EXINST                          R01168
     C                     MOVE WWGRMA    EXLCGR                          R01168
     C                     Z-ADDWWGSMA    EXLCGS                          R01168
     C                     MOVE *BLANKS   EXREF                           R01168
     C                     MOVE WWLIMX    WWREF  13                       R01168
     C                     MOVELWWREF     EXREF                           R01168
     C*                                                                   R01168
     C** IF WWEXMA IS GREATER THAN OR EQUAL TO ZERO                       R01168
     C*          WWEXMA    IFGE 0                                  R01168 B7855
     C           WWLBFX    IFGE 0                                         B7855
     C                     MOVE 'E'       EXEXCO                          R01168
     C*                    Z-ADDWWEXMA    EXAMNT                   R01168 B7855
     C*****                Z-ADDWWLBFX    EXAMNT                   B7855  B10524
     C                     Z-ADDWWLBFX    WWAMTI                          B10524
     C                     EXSR SCONV                                     B10524
     C                     Z-ADDWWAMTO    EXAMNT                          B10524
     C*                                                                   R01168
     C                     ELSE                                           R01168
     C*                                                                   R01168
     C                     MOVE 'C'       EXEXCO                          R01168
     C*                    Z-SUBWWEXMA    EXAMNT                   R01168 B7855
     C*****                Z-SUBWWLBFX    EXAMNT                   B7855  B10524
     C                     Z-SUBWWLBFX    WWAMTI                          B10524
     C                     EXSR SCONV                                     B10524
     C                     Z-ADDWWAMTO    EXAMNT                          B10524
     C*                                                                   R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS AND WRITE A RECORD TO LBEXCOPD           R01168
     C                     EXSR #BEDA                                     R01168
     C*                                                                   R01168
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO LBEXCOPD                    R01168
     C                     ADD  1         WWRECW                          R01168
     C*                                                                   R01168
     C** IF WWXPMA IS GREATER THAN ZERO                                   R01168
     C*          WWXPMA    IFGT 0                                  R01168 B7855
     C           WWLBFP    IFGT 0                                         B7855
     C           S01433    ANDEQ'Y'                                       087631
     C                     MOVE LBPMMA    EXINST                          R01168
     C                     MOVE WWGRPA    EXLCGR                          R01168
     C                     Z-ADDWWGSPA    EXLCGS                          R01168
     C                     MOVE *BLANKS   EXREF                           R01168
     C                     MOVE WWLIMP    WWREF  13                       R01168
     C                     MOVELWWREF     EXREF                           R01168
     C                     MOVE 'E'       EXEXCO                          R01168
     C*                    Z-ADDWWXPMA    EXAMNT                   R01168 B7855
     C                     Z-ADDWWLBFP    EXAMNT                          B7855
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS AND WRITE A RECORD TO LBEXCOPD           R01168
     C                     EXSR #BEDA                                     R01168
     C*                                                                   R01168
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO LBEXCOPD                    R01168
     C                     ADD  1         WWRECW                          R01168
     C*                                                                   R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BEDA        - THIS SUBROUTINE WRITES RECORDS TO NEW      *   R01168
     C**                   EXTRACT FILE LBEXCOPD                      *   R01168
     C**                                                              *   R01168
     C**    CALLS        -                                            *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BED                                       *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BEDA     BEGSR                                          R01168
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS                                          R01168
     C                     MOVE 'D'       EXRECI                          R01168
     C                     Z-ADDWWDAY     EXDLUP                          R01168
     C                     MOVE WWMNTH    EXMLUP                          R01168
     C                     Z-ADDWWYEAR    EXYLUP                          R01168
     C                     TIME           EXTLUP                          R01168
     C                     Z-ADDBJRDNB    EXORED                          R01168
     C***********          Z-ADDWWCNUM    EXCNUM                   R01168 S01498
     C                     MOVE WWCNUM    EXCNUM                          S01498
     C                     MOVE BBPCNB    EXPCNB                          R01168
     C                     MOVE '20'      EXREGE                          R01168
     C***********          MOVE LBCCY     EXCCY                    R01168 S01498
     C                     MOVE LBCYCD    EXCCY                           S01498
     C                     Z-ADD0         EXDDAT                          R01168
     C                     Z-ADD0         EXVDAT                          R01168
     C                     Z-ADD0         EXMDAT                          R01168
     C                     Z-ADD0         EXRLDT                          R01168
     C*                                                                   R01168
     C           EXINST    IFNE LBFXUP                                    B7826
     C           EXINST    ANDNELBFXUL                                    B7826
     C           EXINST    ANDNELBPMUP                                    B7826
     C           EXINST    ANDNELBPMUL                                    B7826
     C                     WRITELBEXCOPF                                  R01168
     C                     END                                            B7826
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BF          - THIS SUBROUTINE WRITES RECORDS TO PORTFOLIO*
     C**                   EXTRACT FILE FOR UNREALISED PROFIT/LOSS    *
     C**                                                              *
     C**    CALLS        - #YA                                        *
     C**                                                              *
     C**    CALLED BY    - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BF       BEGSR
     C*
     C*
     C** IF UNREALISED PROFIT INSTRUMENT EXPOSURE OR UNREALISED LOSS
     C**   INSTRUMENT EXPOSURE IS NOT ZERO
     C           WWEXUP    IFNE *ZEROS
     C           WWEXUL    ORNE *ZEROS
     C*
     C** SET UP FIELDS FOR UNREALISED PROFIT INSTRUMENT
     C                     MOVE LBFXUP    EEINST
     C                     Z-ADD0         EEEXPS
     C/COPY WNCPYSRC,LB0620C016
     C                     Z-ADD0         EEMARG                          SA9109
     C/COPY WNCPYSRC,LB0620C017
     C                     Z-ADD0         EEMGPC                          SA9109
     C           EEINST    IFEQ LBLIFX                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIFX    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C/COPY WNCPYSRC,LB0620C018
     C                     Z-ADDWWEXUP    EECOLL
     C/COPY WNCPYSRC,LB0620C019
     C                     MOVE WWGRUP    EELCGR
     C                     MOVE WWGSUP    EELCGS
     C                     MOVE WWCIUP    EECIFL
     C/COPY WNCPYSRC,LB0620C020
     C                     Z-SUBEECOLL    WWNETL
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C/COPY WNCPYSRC,LB0620C021
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C*
     C** CHECK TO SEE IF KEY ALREADY EXISTS ON FILE
     C           WWEEK1    CHAINLBEXTRL2             74
     C*
     C           *IN74     IFEQ '1'
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         WWRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C                     ELSE
     C*
     C                     ADD  WWEXUP    EECOLL
     C                     UPDATLBEXTRD0
     C*
     C                     END
     C*
     C** SET UP FIELDS FOR UNREALISED LOSS INSTRUMENT
     C                     MOVE LBFXUL    EEINST
     C                     Z-ADDWWEXUL    EEEXPS
     C                     Z-ADD0         EECOLL
     C                     Z-ADD0         EEMARG                          SA9109
     C                     Z-ADD0         EEMGPC                          SA9109
     C           EEINST    IFEQ LBLIFX                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIFX    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C                     MOVE WWGRUL    EELCGR
     C                     MOVE WWGSUL    EELCGS
     C                     MOVE WWCIUL    EECIFL
     C                     ADD  EEEXPS    WWNETL
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C*
     C** CHECK TO SEE IF KEY ALREADY EXISTS ON FILE
     C           WWEEK1    CHAINLBEXTRL2             74
     C*
     C           *IN74     IFEQ '1'
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         WWRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C                     ELSE
     C*
     C                     ADD  WWEXUL    EEEXPS
     C                     UPDATLBEXTRD0
     C*
     C                     END
     C/COPY WNCPYSRC,LB0620C022
     C                     END
     C*
     C** IF UNREALISED PROFIT INSTRUMENT EXPOSURE OR UNREALISED LOSS
     C**   INSTRUMENT EXPOSURE IS NOT ZERO
     C           S01433    IFEQ 'Y'                                       087631
     C           WWPMUP    IFNE *ZEROS
     C           WWPMUL    ORNE *ZEROS
     C*
     C** SET UP FIELDS FOR UNREALISED PROFIT INSTRUMENT
     C                     MOVE LBPMUP    EEINST
     C                     Z-ADD0         EEEXPS
     C/COPY WNCPYSRC,LB0620C023
     C                     Z-ADD0         EEMARG                          SA9109
     C                     Z-ADD0         EEMGPC                          SA9109
     C                     Z-ADDWWPMUP    EECOLL
     C/COPY WNCPYSRC,LB0620C024
     C                     MOVE WWGRPP    EELCGR
     C                     MOVE WWGSPP    EELCGS
     C                     MOVE WWCIPP    EECIFL
     C/COPY WNCPYSRC,LB0620C025
     C                     Z-SUBEECOLL    WWNETP
     C/COPY WNCPYSRC,LB0620C026
     C           EEINST    IFEQ LBLIPM                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIPM    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C/COPY WNCPYSRC,LB0620C027
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C*
     C** CHECK TO SEE IF KEY ALREADY EXISTS ON FILE
     C           WWEEK1    CHAINLBEXTRL2             74
     C*
     C           *IN74     IFEQ '1'
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         WWRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C                     ELSE
     C*
     C                     ADD  WWPMUP    EECOLL
     C                     UPDATLBEXTRD0
     C*
     C                     END
     C*
     C** SET UP FIELDS FOR UNREALISED LOSS INSTRUMENT
     C                     MOVE LBPMUL    EEINST
     C                     Z-ADDWWPMUL    EEEXPS
     C                     Z-ADD0         EECOLL
     C                     Z-ADD0         EEMARG                          SA9109
     C                     Z-ADD0         EEMGPC                          SA9109
     C           EEINST    IFEQ LBLIPM                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIPM    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C                     MOVE WWGRPL    EELCGR
     C                     MOVE WWGSPL    EELCGS
     C                     MOVE WWCIPL    EECIFL
     C                     ADD  EEEXPS    WWNETP
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C*
     C** CHECK TO SEE IF KEY ALREADY EXISTS ON FILE
     C           WWEEK1    CHAINLBEXTRL2             74
     C*
     C           *IN74     IFEQ '1'
     C*
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO PORTFOLIO EXTRACT FILE
     C                     ADD  1         WWRECS
     C*
     C** WRITE RECORD TO PORTFOLIO EXTRACT FILE
     C                     WRITELBEXTRD0
     C                     ELSE
     C*
     C                     ADD  WWPMUL    EEEXPS
     C                     UPDATLBEXTRD0
     C*
     C                     END
     C/COPY WNCPYSRC,LB0620C028
     C                     END
     C                     END                                            087631
     C*
     C           #BF0      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BG          - THIS SUBROUTINE WRITES RECORD  TO PORTFOLIO*
     C**                   EXTRACT FILE FOR NET UNREALISED P/L        *
     C**                                                              *
     C**    CALLS        -                                            *
     C**                                                              *
     C**    CALLED BY    - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BG       BEGSR
     C*
     C** ACCESS FOREX UNREALISED PROFILT/LOSS INSTRUMENT
     C***********LBFXMC    CHAINSDPLINL4             65                   S01498
     C*
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBFXMC    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD32        DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 032 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 032 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBFXMC    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIUL
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C** GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD33        DBASE            *             *
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROR 033 *S01498
     C                     MOVE 'LBGROUPD'DBFILE           * DBERROR 033 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELPDLOMG    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRUL
     C                     MOVE GPLCGS    WWGSUL
     C                     END
     C*
     C                     END
     C*
     C** ACCESS PRECIOUS METALS  UNREALISED PROFILT/LOSS INSTRUMENT
     C***********LBPMMC    CHAINSDPLINL4             65                   S01498
     C           S01433    IFEQ 'Y'                                       087631
     C*
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBPMMC    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD34        DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 034 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 034 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBPMMC    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIPL
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C** GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD35        DBASE            *             *
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROR 035 *S01498
     C                     MOVE 'LBGROUPD'DBFILE           * DBERROR 035 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELPDLOMG    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRPL
     C                     MOVE GPLCGS    WWGSPL
     C                     END
     C*
     C                     END
     C                     ELSE                                           087631
     C                     MOVE *BLANKS   WWCIPL                          087631
     C                     MOVE *BLANKS   WWGRPL                          087631
     C                     MOVE *BLANKS   WWGSPL                          087631
     C                     END                                            087631
     C*
     C** SET UP FIELDS FOR NET UNREALISE P/L INSTRUMENT
     C                     MOVE LBFXMC    EEINST
     C           WWNETL    IFGT 0
     C                     Z-ADDWWNETL    EEEXPS
     C                     Z-ADD0         EECOLL
     C                     ELSE
     C                     Z-ADD0         EEEXPS
     C** IF NET UNREALISED P/L IS A PROFIT, DO NOT SHOW THIS AS
     C** CLOLLATERAL.
     C                     Z-ADD0         EECOLL
     C                     END
     C                     Z-ADD0         EEMARG                          SA9109
     C                     Z-ADD0         EEMGPC                          SA9109
     C                     MOVE WWGRUL    EELCGR
     C                     MOVE WWGSUL    EELCGS
     C                     MOVE WWCIUL    EECIFL
     C           EEINST    IFEQ LBLIFX                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIFX    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C**
     C** ADD A RECORD IN EXTRACT FILE
     C           EEEXPS    IFNE *ZERO
     C                     ADD  1         WWRECS
     C                     WRITELBEXTRD0
     C**                                                                  B07893
     C*  WRITE TO LBEXCOPD FOR NET UNREALISED P/L                         B07893
     C                     MOVE LBFXMC    EXINST                          B07893
     C                     MOVE EELCGR    EXLCGR                          B07893
     C                     MOVE EELCGS    EXLCGS                          B07893
     C                     MOVE 'E'       EXEXCO                          B07893
     C                     Z-ADDWWNETL    EXAMNT                          B07893
     C                     MOVEL*BLANKS   EXREF                           B10521
     C/COPY WNCPYSRC,LB0620C029
     C                     EXSR #BJA                                      B07893
     C/COPY WNCPYSRC,LB0620C030
     C**                                                                  B07893
     C                     END
     C*
     C** SET UP FIELDS FOR NET UNREALISED P/L INSTRUMENT
     C           S01433    IFEQ 'Y'                                       087631
     C                     MOVE EEPCNB    WWPARE
     C                     MOVE LBPMMC    EEINST
     C           WWNETP    IFGT 0
     C                     Z-ADDWWNETP    EEEXPS
     C                     Z-ADD0         EECOLL
     C                     ELSE
     C                     Z-ADD0         EEEXPS
     C** IF NET UNREALISED P/L IS A PROFIT, DO NOT SHOW THIS AS
     C** COLLATERAL.
     C                     Z-SUB0         EECOLL
     C                     END
     C                     Z-ADD0         EEMARG                          SA9109
     C                     Z-ADD0         EEMGPC                          SA9109
     C                     MOVE WWGRPL    EELCGR
     C                     MOVE WWGSPL    EELCGS
     C                     MOVE WWCIPL    EECIFL
     C           EEINST    IFEQ LBLIPM                                    R0162
     C***********LBIC      ANDEQ'Y'                                33503  S01498
     C                     Z-ADDWWLIPM    EELIMT                          R0162
     C                     ELSE                                           R0162
     C                     Z-ADD*ZERO     EELIMT                          R0162
     C                     END                                            R0162
     C                     Z-ADD*ZERO     EEEXPO                          R0170
     C*
     C** CALL SUBROUTINE TO SET UP CONSTANT FIELDS FOR EXTRACT FILE
     C                     EXSR #YA
     C*
     C** ADD A RECORD IN EXTRACT FILE
     C           EEEXPS    IFNE *ZERO
     C                     ADD  1         WWRECS
     C                     WRITELBEXTRD0
     C**                                                                  B07893
     C*  WRITE TO LBEXCOPD FOR NET UNREALISED P/L                         B07893
     C                     MOVE LBPMMC    EXINST                          B07893
     C                     MOVE EELCGR    EXLCGR                          B07893
     C                     MOVE EELCGS    EXLCGS                          B07893
     C                     MOVE 'E'       EXEXCO                          B07893
     C                     Z-ADDWWNETP    EXAMNT                          B07893
     C                     EXSR #BJA                                      B07893
     C**                                                                  B07893
     C                     END
     C                     END                                            087631
     C*
     C           #BG0      ENDSR
     C*****************************************************************
     C*
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BH          - THIS SUBROUTINE PROCESS CUSTOMER           *
     C**                   MARGINS ON EXPOSURE                        *
     C**                                                              *
     C******CALLS********- #BHA, #BEB, #BEC, SCONV, #ZA               *   R01168
     C**    CALLS        - #BHA, #BHB, #BEB, #BEC, SCONV, #ZA         *   R01168
     C**                                                              *
     C**    CALLED BY    - #B                                         *
     C**                                                              *
     C*****************************************************************
     C           #BH       BEGSR
     C*
     C/COPY WNCPYSRC,LB0620C031
     C           WWEBCE    DIV  2         WWOPNF 150
     C           WWPBCE    DIV  2         WWOPNP 150
     C/COPY WNCPYSRC,LB0620C032
     C*
     C** WRITE HEADER
     C           LINE2     IFGE 52
     C                     WRITEHEADER1
     C                     END
     C                     WRITEHEADER4
     C*
     C** CALCULATES CUSTOMER MARGINS
     C***********MRGP      IFEQ 'Y'                                34690  S01498
     C                     EXSR #BHA
     C***********          END                                     34690  S01498
     C*                                                                   R01168
     C** WRITE RECORD TO NEW EXTRACT FILE LBEXCOPD                        R01168
     C                     EXSR #BHB                                      R01168
     C*
     C** WRITE END OF REPORT LINES
     C                     EXSR #BEB
     C*
     C** WRITE RECORDS TO EXTRACT FILE
     C                     EXSR #BEC
     C*
     C                     ENDSR
     C*****************************************************************
     C*
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #BHA         - THIS SUBROUTINE CALCULATES CUSTOMER        *
     C**                   MARGINS ON EXPOSURE                        *
     C**                                                              *
     C**    CALLS        -                                            *
     C**                                                              *
     C**    CALLED BY    - #BH                                        *
     C**                                                              *
     C*****************************************************************
     C           #BHA      BEGSR
     C*                                                                   B5986
     C** ACCESS MARGIN PERC. EXTENSION FILE TO OBTAIN PERC. FOR CLIENT    B5986
     C*                                                                   B5986
     C************LOVAL    SETLLSDLBCSY0                           B5986  S01498
     C***********RRCNUM    CHAINSDLBCSY0             20            B5986  S01498
     C*                                                                   B5986
     C                     CALL 'AOLBCSR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM RRCNUM    @CUSN  10                       S01498
     C           @LBCS     PARM @LBCS     DSSDY                           S01498
     C*                                                                   S01498
     C** IF NOT FOUND, THEN IT IS A DATABASE ERROR                        B5986
     C*                                                                   B5986
     C************IN20     IFEQ '1'                                B5986  S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD37        DBASE            ***************B5986
     C***********          MOVEL'SDLBCSY0'DBFILE           * DBERR B5986  S01498
     C                     MOVE 'SDLBCSPD'DBFILE           * DBERROR 037 *S01498
     C                     MOVE *BLANKS   DBKEY            ***************B5986
     C                     MOVELRRCNUM    DBKEY                           B5986
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       B5986
     C                     END                                            B5986
     C*
     C* FOREX MARGIN
     C           WWOPNF    IFNE 0
     C**                                                           SA9109 B5986
     C** ACCESS MARGIN PERC. EXTENSION FILE TO OBTAIN PERC. FOR CLIENT109 B5986
     C**                                                           SA9109 B5986
     C**         *LOVAL    SETLLSDLBCSY0                           SA9109 B5986
     C**         RRCNUM    CHAINSDLBCSY0             20            SA9109 B5986
     C**                                                           SA9109 B5986
     C** IF NOT FOUND, THEN IT IS A DATABASE ERROR                 SA9109 B5986
     C**                                                           SA9109 B5986
     C**         *IN20     IFEQ '1'                                SA9109 B5986
     C**                   Z-ADD37        DBASE            ***************B5986
     C**                   MOVEL'SDLBCSY0'DBFILE           * DBERROR 037 *B5986
     C**                   MOVE *BLANKS   DBKEY            ***************B5986
     C**                   MOVELRRCNUM    DBKEY                    SA9109 B5986
     C**                   EXSR #ZA                                SA9109 B5986
     C**                   END                                     SA9109 B5986
     C*
     C* CALCULATE PERCENTAGE FOREX MARGIN
     C           LBFXCP    DIV  100       WWPRC2
     C*          LBFORP    DIV  100       WWPRC3                   SA9109 B5980
     C***********LBFORX    DIV  100       WWPRC3                   B5980  S01498
     C           CUFORX    DIV  100       WWPRC3                          S01498
     C*
     C* CALCULATE FOREX MARGIN AS AN EXPOSURE
     C           WWOPNF    MULT WWPRC2    WWEXMA
     C***********WWOPNF    MULT WWPRC3    WWLBFX                    SA9109095719
     C                     Z-ADDWWOPNF    WWLBFX                          095719
     C                     Z-ADD0         WWEXMC
     C*
     C                     END
     C*
     C* PRECIOUS METALS MARGIN
     C           WWOPNP    IFNE 0
     C           S01433    ANDEQ'Y'                                       087631
     C*
     C* CALCULATE PERCENTAGE FOREX MARGIN
     C           LBPMCP    DIV  100       WWPRC2
     C***********LBFORP    DIV  100       WWPRC3                   SA9109 S01498
     C           CUFORP    DIV  100       WWPRC3                          S01498
     C*
     C* CALCULATE FOREX MARGIN AS AN EXPOSURE
     C           WWOPNP    MULT WWPRC2    WWXPMA
     C           WWOPNP    MULT WWPRC3    WWLBFP                          SA9109
     C                     Z-ADD0         WWXPMC
     C*
     C                     END
     C*
     C* INITIALISE FIELDS
     C***********          Z-ADDKKCNUM    CNUML                    R0162  S01498
     C                     MOVE KKCNUM    CNUML                           S01498
     C*****                Z-ADDWWOPNF    WWLIMX                          B10524
     C                     Z-ADDWWOPNF    WWAMTI                          B10524
     C                     EXSR SCONV                                     B10524
     C                     Z-ADDWWAMTO    WWLIMX                          B10524
     C                     Z-ADD0         WW3XUL
     C                     Z-ADD0         WW3XUP
     C                     Z-ADD0         WWNETL
     C*****                Z-ADDWWOPNP    WWLIMP                          B10524
     C                     Z-ADDWWOPNP    WWAMTI                          B10524
     C                     EXSR SCONV                                     B10524
     C                     Z-ADDWWAMTO    WWLIMP                          B10524
     C                     Z-ADD0         WW3MUL
     C                     Z-ADD0         WW3MUP
     C                     Z-ADD0         WWNETP
     C*
     C           #BH0      ENDSR
     C*****************************************************************   R0162
     C/EJECT                                                              R01168
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BHB         - PERFORMS CALCULATIONS FOR RECORD TO BE     *   R01168
     C**                   WRITTEN TO NEW EXTRACT FILE LBEXCOPD       *   R01168
     C**                                                              *   R01168
     C**    CALLS        - #BHBA                                      *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BH                                        *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BHB      BEGSR                                          R01168
     C*                                                                   R01168
     C/COPY WNCPYSRC,LB0620C033
     C           WWEXMA    IFNE 0                                  R01168 B5936
     C*                                                            R01168 B5936
     C                     MOVE *BLANKS   EXREF                           R01168
     C                     MOVE WWLIMX    WWREF                           R01168
     C                     MOVELWWREF     EXREF                           R01168
     C*                                                                   R01168
     C***********CYPMRT    IFEQ 'N'                                R01168 B5936
     C*********************MOVE '@OF'     EXINST                   R01168 B5922
     C                     MOVE LBFXMA    EXINST                   R01168 B5922
     C                     MOVE WWGRMA    EXLCGR                          R01168
     C                     Z-ADDWWGSMA    EXLCGS                          R01168
     C*                                                                   R01168
     C** IF WWEXMA IS GREATER THAN OR EQUAL TO ZERO                       R01168
     C*          WWEXMA    IFGE 0                                  R01168 B7855
     C           WWLBFX    IFGE 0                                         B7855
     C                     MOVE 'E'       EXEXCO                          R01168
     C*                    Z-ADDWWEXMA    EXAMNT                   R01168 B7855
     C***                  Z-ADDWWLBFX    EXAMNT                   B7855  B10524
     C                     Z-ADDWWLBFX    WWAMTI                          B10524
     C                     EXSR SCONV                                     B10524
     C                     Z-ADDWWAMTO    EXAMNT                          B10524
     C*                                                                   R01168
     C                     ELSE                                           R01168
     C*                                                                   R01168
     C                     MOVE 'C'       EXEXCO                          R01168
     C*                    Z-SUBWWEXMA    EXAMNT                   R01168 B7855
     C***                  Z-SUBWWLBFX    EXAMNT                   B7855  B10524
     C                     Z-SUBWWLBFX    WWAMTI                          B10524
     C                     EXSR SCONV                                     B10524
     C                     Z-ADDWWAMTO    EXAMNT                          B10524
     C                     END                                            R01168
     C*                                                            R01168 B5936
     C** SET UP REMAINING FIELDS AND WRITE A RECORD TO LBEXCOPD    R01168 B5936
     C                     EXSR #BHBA                              R01168 B5936
     C*                                                            R01168 B5936
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO LBEXCOPD             R01168 B5936
     C                     ADD  1         WWRECW                   R01168 B5936
     C*                                                            R01168 B5936
     C                     END                                     R01168 B5936
     C/COPY WNCPYSRC,LB0620C034
     C*                                                                   R01168
     C***********                                                  R01168 B5936
     C***********          ELSE                                    R01168 B5936
     C***********                                                  R01168 B5936
#BHB C***********CYPMRT    IFEQ 'Y'                                R01168 B5936
     C*********************MOVE '@OP'     EXINST                   R01168 B5922
     C*                                                            R01168 B5936
     C*          WWXPMA    IFNE 0                                  R01168 B7855
     C           WWLBFP    IFNE 0                                         B7855
     C           S01433    ANDEQ'Y'                                       087631
     C*                                                            R01168 B5936
     C                     MOVE *BLANKS   EXREF                    R01168 B5936
     C                     MOVE WWLIMP    WWREF                    R01168 B5936
     C                     MOVELWWREF     EXREF                    R01168 B5936
     C*                                                            R01168 B5936
     C                     MOVE LBPMMA    EXINST                   R01168 B5922
     C                     MOVE WWGRPA    EXLCGR                          R01168
     C                     Z-ADDWWGSPA    EXLCGS                          R01168
     C*                                                                   R01168
     C** IF WWEXMA IS GREATER THAN OR EQUAL TO ZERO                       R01168
     C*          WWXPMA    IFGE 0                                  R01168 B7855
     C           WWLBFP    IFGE 0                                         B7855
     C                     MOVE 'E'       EXEXCO                          R01168
     C*                    Z-ADDWWXPMA    EXAMNT                   R01168 B7855
     C                     Z-ADDWWLBFP    EXAMNT                          B7855
     C*                                                                   R01168
     C                     ELSE                                           R01168
     C*                                                                   R01168
     C                     MOVE 'C'       EXEXCO                          R01168
     C*                    Z-SUBWWXPMA    EXAMNT                   R01168 B7855
     C                     Z-SUBWWLBFP    EXAMNT                          B7855
     C                     END                                            R01168
     C*                                                                   R01168
     C***********          END                                     R01168 B5936
     C***********                                                  R01168 B5936
     C***********          END                                     R01168 B5936
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS AND WRITE A RECORD TO LBEXCOPD           R01168
     C                     EXSR #BHBA                                     R01168
     C*                                                                   R01168
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO LBEXCOPD                    R01168
     C                     ADD  1         WWRECW                          R01168
     C*                                                            R01168 B5936
     C                     END                                     R01168 B5936
     C*                                                                   R01168
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BHBA        - THIS SUBROUTINE WRITES RECORDS TO NEW      *   R01168
     C**                   EXTRACT FILE LBEXCOPD                      *   R01168
     C**                                                              *   R01168
     C**    CALLS        -                                            *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BHB                                       *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BHBA     BEGSR                                          R01168
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS                                          R01168
     C                     MOVE 'D'       EXRECI                          R01168
     C                     Z-ADDWWDAY     EXDLUP                          R01168
     C                     MOVE WWMNTH    EXMLUP                          R01168
     C                     Z-ADDWWYEAR    EXYLUP                          R01168
     C                     TIME           EXTLUP                          R01168
     C                     Z-ADDBJRDNB    EXORED                          R01168
     C***********          Z-ADDWWCNUM    EXCNUM                   R01168 S01498
     C                     MOVE WWCNUM    EXCNUM                          S01498
     C                     MOVE BBPCNB    EXPCNB                          R01168
     C                     MOVE '20'      EXREGE                          R01168
     C***********          MOVE LBCCY     EXCCY                    R01168 S01498
     C                     MOVE LBCYCD    EXCCY                           S01498
     C                     Z-ADD0         EXDDAT                          R01168
     C                     Z-ADD0         EXVDAT                          R01168
     C                     Z-ADD0         EXMDAT                          R01168
     C                     Z-ADD0         EXRLDT                          R01168
     C*                                                                   R01168
     C/COPY WNCPYSRC,LB0620C035
     C           EXINST    IFNE LBFXUP                                    B7826
     C           EXINST    ANDNELBFXUL                                    B7826
     C           EXINST    ANDNELBPMUP                                    B7826
     C           EXINST    ANDNELBPMUL                                    B7826
     C                     WRITELBEXCOPF                                  R01168
     C                     END                                            B7826
     C/COPY WNCPYSRC,LB0620C036
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT                                                              R0162
     C*****************************************************************   R0162
     C**                                                              *   R0162
     C**    #BI          - THIS SUBROUTINE CALCULATES LIMIT WHEN      *   R0162
     C**                   MARGIN ON EXPOSURE                         *   R0162
     C**                                                              *   R0162
     C**    CALLS        - #ZA, SCONV                                 *   R0162
     C**                                                              *   R0162
     C**    CALLED BY    - #B                                         *   R0162
     C**                                                              *   R0162
     C*****************************************************************   R0162
     C           #BI       BEGSR                                          R0162
     C*                                                                   R0162
     C** READ FIRST RECORD                                                R0162
     C*                                                                   R0162
     C***********KKCNUM    CHAINLIMILBJ1             71            R0162  S01498
     C           KKCNUM    CHAINLBLIMIJ1             71                   S01498
     C*                                                                   R0162
     C** IF ACTIVE & FX LIMIT EXPIRY DATE > EVENT CONTROL DATE            R0162
     C*                                                                   R0162
     C           *IN71     IFEQ '0'                                       R0162
     C***********RECIL     ANDEQ'D'                                R0162  S01498
     C********** FLED      ANDGTBJDNWD                              R0162 043724
     C*                                                                   B10035
     C***********SARS      IFEQ 'Y'                                B10035 S01498
     C*                                                                   R0162
     C** ACCESS DEALING LIMITS EXTENDED FILE TO GET PRECIOUS METALS LIMITSR0162
     C***********KLIMX0    CHAINLIMITBX0             65            R0162  S01498
     C*                                                                   R0162
     C                     CALL 'AOCLLMR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM CNUML     @KEY1   6                       S01498
     C                     PARM 'S'       @KEY2   1                       S01498
     C***********          PARM BBBRCD    @KEY3   3                 S01498086863
     C                     PARM 'SYS'     @KEY3   3                       086863
     C           @CLLM     PARM @CLLM     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND                                              R0162
     C*                                                                   R0162
     C************IN65     IFEQ '1'                        ******* R0162  S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C*********************Z-ADD29        DBASE            *        R0162*B10035
     C                     Z-ADD30        DBASE            *             *B10035
     C*********************MOVEL'LIMTBX0 'DBFILE           * DBERROR 029 *R0162
     C***********          MOVEL'LIMTBX0 'DBFILE           * DBERR B10035 S01498
     C                     MOVE 'SDCLLMPD'DBFILE           * DBERROR 030 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *R0162
     C***********          MOVELFLTY      DBKEY            ******* R0162  S01498
     C***********          MOVELDZFXLT    DBKEY            *********S01498086863
     C                     MOVELCNUML     DBKEY            ************** 086863
     C                     MOVE 'SSYS'    DBKEY                           086863
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R0162
     C                     END                                            R0162
     C***********          END                                     B10035 S01498
     C*                                                                   R0162
     C** INITIALISE LOCAL VARIABLES                                       R0162
     C                     Z-ADD*ZEROS    WWLIMT 152                      R0162
     C                     Z-ADD*ZEROS    WWLIFX                          043724
     C                     Z-ADD*ZEROS    WWLIPM                          043724
     C                     Z-ADD*ZEROS    WWPRC1  32                      R0162
     C                     Z-ADD*ZEROS    WWPRC2  32                      R0162
     C                     Z-ADD*ZEROS    WWPRC3  32                      SA9109
     C                     Z-ADD*ZEROS    WWPRCM  32                      043724
     C                     MOVE *BLANKS   WWLTYP  3                       R0162
     C*                                                                   R0162
     C** MOVE FX LIMIT TYPE INTO 3 ALPHA FIELD                            R0162
     C***********FLTY      IFNE 0                                  043724 S01498
     C***********          MOVE FLTY      WWLTYP                   R0162  S01498
     C           DZFXLT    IFNE '000'                                     S01498
     C           DZFXLT    ANDNE*BLANKS                                   086863
     C                     MOVE DZFXLT    WWLTYP                          S01498
     C*                                                                   R0162
     C** ACCESS LIMITS FILE USING LIMIT TYPE                              R0162
     C***********WWLTYP    CHAINSDLIMTL0             72            R0162  S01498
     C*                                                                   R0162
     C                     CALL 'AOLIMTR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWLTYP    @LMTY   3                       S01498
     C           @LIMT     PARM @LIMT     DSSDY                           S01498
     C*                                                                   S01498
     C** IF NO RECORD FOUND OR LAST CHANGE TYPE = 'D' THEN DBERROR        R0162
     C************IN72     IFEQ '1'                                R0162  S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A2TYLC    OREQ 'D'                                       R0162
     C           *LOCK     IN   LDA                                       S01498
     C***********          Z-ADD17        DBASE            *********R0162 092542
     C                     Z-ADD16        DBASE            ***************092542
     C                     MOVE *BLANKS   DBFILE           *             *R0162
     C***********          MOVEL'SDLIMTL0'DBFILE           * DBERR R0162  S01498
     C***********          MOVE 'SDLIMTPD'DBFILE           * DBERROR 01798092542
     C                     MOVE 'SDLIMTPD'DBFILE           * DBERROR 016 *092542
     C                     MOVE *BLANKS   DBKEY            *             *R0162
     C                     MOVELWWLTYP    DBKEY            ***************R0162
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R0162
     C                     END                                            R0162
     C*                                                                   R0162
     C** CALCULATE PERCENTAGE LIMIT FOR FIRST PERIOD                      R0162
     C           A2PL1P    DIV  100       WWPRC1                          R0162
     C                     END                                            043724
     C*                                                                   R0162
     C** MOVE PM LIMIT TYPE INTO 3 ALPHA FIELD                            043724
     C***********LIPLTY    IFNE 0                                  043724 S01498
     C***********          MOVE LIPLTY    WWLTYP                   043724 S01498
     C           S01433    IFEQ 'Y'                                       087631
     C           DZPLTY    IFNE '000'                                     S01498
     C***********DZFXLT    ANDNE*BLANKS                            086863 092542
     C           DZPLTY    ANDNE*BLANKS                                   092542
     C                     MOVE DZPLTY    WWLTYP                          S01498
     C*                                                                   043724
     C** ACCESS LIMITS FILE USING LIMIT TYPE                              043724
     C***********WWLTYP    CHAINSDLIMTL0             72            043724 S01498
     C*                                                                   043724
     C                     CALL 'AOLIMTR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM WWLTYP    @LMTY   3                       S01498
     C           @LIMT     PARM @LIMT     DSSDY                           S01498
     C*                                                                   S01498
     C** IF NO RECORD FOUND OR LAST CHANGE TYPE = 'D' THEN DBERROR        043724
     C************IN72     IFEQ '1'                                043724 S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A2TYLC    OREQ 'D'                                       043724
     C           *LOCK     IN   LDA                                       S01498
     C***********          Z-ADD17        DBASE            ********043724 092542
     C                     Z-ADD18        DBASE            ***************092542
     C                     MOVE *BLANKS   DBFILE           *             *043724
     C***********          MOVEL'SDLIMTL0'DBFILE           * DBERR 043724 S01498
     C***********          MOVE 'SDLIMTPD'DBFILE           * DBERROR 01798092542
     C                     MOVE 'SDLIMTPD'DBFILE           * DBERROR 018 *092542
     C                     MOVE *BLANKS   DBKEY            *             *043724
     C***********          MOVELLIPLTY    DBKEY            ******* 043724 S01498
     C                     MOVELDZPLTY    DBKEY            ************** S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       043724
     C                     END                                            043724
     C*                                                                   043724
     C** CALCULATE PERCENTAGE LIMIT FOR FIRST PERIOD                      043724
     C           A2PL1P    DIV  100       WWPRCM                          043724
     C                     END                                            043724
     C                     ELSE                                           087631
     C                     Z-ADD*ZEROS    WWPRCM                          087631
     C                     END                                            087631
     C*                                                                   043724
     C                     ELSE                                           043724
     C***********          Z-ADD*ZERO     FAMM                     043724 S01498
     C***********          Z-ADD*ZERO     LIPSAM                   043724 S01498
     C                     Z-ADD*ZERO     DZFXFA                          087376
     C                     Z-ADD*ZERO     DZFLAM                          087631
     C                     Z-ADD*ZERO     DZPFAM                          S01498
     C***********          Z-ADD*ZERO     DZPSAM                    S01498087376
     C                     END                                            043724
     C*                                                                   043724
     C** USE TO CALCULATE LIMIT                                           R0162
     C***********FAMM      MULT WWPRC1    WWLIMT                   R0162  S01498
     C***********DZPFAM    MULT WWPRC1    WWLIMT                    S01498087376
     C           S01433    IFEQ 'Y'                                       087631
     C           DZFXFA    MULT WWPRC1    WWLIMT                          087376
     C                     ELSE                                           087631
     C           DZFLAM    MULT WWPRC1    WWLIMT                          087631
     C                     END                                            087631
     C*                                                                   R0162
     C** MULTIPLY BY 1000 TO MATCH FILE                                   R0162
     C                     MULT 1000      WWLIMT                          R0162
     C*                                                                   R0162
     C** LIMIT IS WITHOUT DECIMALS IN LIMIT FILE;                         R0162
     C** CHANGE LIMIT DEPENDING ON BANK NBR OF DECIMALS                   R0162
     C***        WWDPI     IFEQ 1                                    R0162B10526
     C           WWDPL     IFEQ 1                                         B10526
     C                     MULT 10        WWLIMT                          R0162
     C                     ELSE                                           R0162
     C***        WWDPI     IFEQ 2                                    R0162B10526
     C           WWDPL     IFEQ 2                                         B10526
     C                     MULT 100       WWLIMT                          R0162
     C                     ELSE                                           R0162
     C***        WWDPI     IFEQ 3                                    R0162B10526
     C           WWDPL     IFEQ 3                                         B10526
     C                     MULT 1000      WWLIMT                          R0162
     C                     END                                            R0162
     C                     END                                            R0162
     C                     END                                            R0162
     C*                                                                   R0162
     C** CONVERT LIMIT FROM BASE CURRENCY TO PORTFOLIO CURRENCY           R0162
     C***                  Z-ADDWWDPI     WWDECP                     R0162B10526
     C                     Z-ADDWWDPL     WWDECP                          B10526
     C** CONVERT FX LIMIT FROM DEALING CCY INTO PORTFOL CCY               B10526
     C** I = DEALING CURRENCY; O = PORTFOLIO CURRENCY                     B10526
     C                     Z-ADDWWSRI     WWSRII                          B10526
     C                     Z-ADDWWDPI     WWDPII                          B10526
     C                     MOVE WWMDI     WWMDII                          B10526
     C                     Z-ADDWWSRL     WWSRI                           B10526
     C                     Z-ADDWWDPL     WWDPI                           B10526
     C                     MOVE WWMDL     WWMDI                           B10526
     C                     Z-ADDWWLIMT    WWAMTI                          R0162
     C                     EXSR SCONV                                     R0162
     C                     Z-ADDWWAMTO    WWLIFX 150                      R0162
     C** REPLACE INPUT AND OUTPUT CCY'S FOR FURTHER PROCESSING            B10526
     C** I = BASE CURRENCY; O = PORTFOLIO CURRENCY                        B10526
     C                     Z-ADDWWSRII    WWSRI                           B10526
     C                     Z-ADDWWDPII    WWDPI                           B10526
     C                     MOVE WWMDII    WWMDI                           B10526
     C*                                                                   R0162
     C** USE TO CALCULATE LIMIT                                           R0162
     C***********LIPSAM    MULT WWPRC1    WWLIMT                    R0162 043724
     C***********LIPSAM    MULT WWPRCM    WWLIMT                   043724 S01498
     C***********DZPSAM    MULT WWPRCM    WWLIMT                    S01498087376
     C           S01433    IFEQ 'Y'                                       087631
     C           DZPFAM    MULT WWPRCM    WWLIMT                          087376
     C*                                                                   R0162
     C** MULTIPLY BY 1000 TO MATCH FILE                                   R0162
     C                     MULT 1000      WWLIMT                          R0162
     C*                                                                   R0162
     C** LIMIT IS WITHOUT DECIMALS IN LIMIT FILE;                         R0162
     C** CHANGE LIMIT DEPENDING ON BANK NBR OF DECIMALS                   R0162
     C           WWDPI     IFEQ 1                                         R0162
     C                     MULT 10        WWLIMT                          R0162
     C                     ELSE                                           R0162
     C           WWDPI     IFEQ 2                                         R0162
     C                     MULT 100       WWLIMT                          R0162
     C                     ELSE                                           R0162
     C           WWDPI     IFEQ 3                                         R0162
     C                     MULT 1000      WWLIMT                          R0162
     C                     END                                            R0162
     C                     END                                            R0162
     C                     END                                            R0162
     C*                                                                   R0162
     C** CONVERT LIMIT FROM BASE CURRENCY TO PORTFOLIO CURRENCY           R0162
     C                     Z-ADDWWDPI     WWDECP                          R0162
     C                     Z-ADDWWLIMT    WWAMTI                          R0162
     C                     EXSR SCONV                                     R0162
     C                     Z-ADDWWAMTO    WWLIPM 150                      R0162
     C                     ELSE                                           087631
     C                     Z-ADD*ZEROS    WWLIPM                          087631
     C                     END                                            087631
     C*                                                                   R0162
     C******************** END                                      R0162 043724
     C*                                                                   R0162
     C           #BI0      ENDSR                                          R0162
     C*****************************************************************
     C*
     C/EJECT
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BJ          - PERFORMS CALCULATIONS TO WRITE RECORD TO   *   R01168
     C**                   NEW EXTRACT FILE LBEXCOPD                  *   R01168
     C**                                                              *   R01168
     C**    CALLS        - #BJA                                       *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #B                                         *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BJ       BEGSR                                          R01168
     C*                                                                   R01168
     C** IF WWAMTO IS GREATER THAN OR EQUAL TO ZERO                       R01168
     C           WWAMTO    IFGE 0                                         R01168
     C                     MOVE 'C'       EXEXCO                          R01168
     C                     Z-ADDWWAMTO    EXAMNT                          R01168
     C*                                                                   R01168
     C** IF WWPMRT IS 'N'                                                 R01168
     C           WWPMRT    IFEQ 'N'                                       R01168
     C           S01433    ORNE 'Y'                                       087631
     C                     MOVE LBFXUP    EXINST                          R01168
     C                     MOVE WWGRUP    EXLCGR                          R01168
     C                     Z-ADDWWGSUP    EXLCGS                          R01168
     C                     ELSE                                           R01168
     C*                                                                   R01168
     C                     MOVE LBPMUP    EXINST                          R01168
     C                     MOVE WWGRPP    EXLCGR                          R01168
     C                     Z-ADDWWGSPP    EXLCGS                          R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C                     ELSE                                           R01168
     C           WWAMTO    IFLT 0                                         R01168
     C                     MOVE 'E'       EXEXCO                          R01168
     C                     Z-SUBWWAMTO    EXAMNT                          R01168
     C*                                                                   R01168
     C** IF WWPMRT IS 'N'                                                 R01168
     C           WWPMRT    IFEQ 'N'                                       R01168
     C           S01433    ORNE 'Y'                                       087631
     C                     MOVE LBFXUL    EXINST                          R01168
     C                     MOVE WWGRUL    EXLCGR                          R01168
     C                     Z-ADDWWGSUL    EXLCGS                          R01168
     C                     ELSE                                           R01168
     C*                                                                   R01168
     C                     MOVE LBPMUL    EXINST                          R01168
     C                     MOVE WWGRPL    EXLCGR                          R01168
     C                     Z-ADDWWGSPL    EXLCGS                          R01168
     C                     END                                            R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS AND WRITE A RECORD TO LBEXCOPD           R01168
     C                     EXSR #BJA                                      R01168
     C*                                                                   R01168
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO LBEXCOPD                    R01168
     C                     ADD  1         WWRECW                          R01168
     C*                                                                   R01168
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BJA         - THIS SUBROUTINE WRITES RECORDS TO NEW      *   R01168
     C**                   EXTRACT FILE LBEXCOPD                      *   R01168
     C**                                                              *   R01168
     C**    CALLS        -                                            *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BJ                                        *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BJA      BEGSR                                          R01168
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS                                          R01168
     C                     MOVE 'D'       EXRECI                          R01168
     C                     Z-ADDWWDAY     EXDLUP                          R01168
     C                     MOVE WWMNTH    EXMLUP                          R01168
     C                     Z-ADDWWYEAR    EXYLUP                          R01168
     C                     TIME           EXTLUP                          R01168
     C                     Z-ADDBJRDNB    EXORED                          R01168
     C***********          Z-ADDWWCNUM    EXCNUM                   R01168 S01498
     C                     MOVE WWCNUM    EXCNUM                          S01498
     C                     MOVE '20'      EXREGE                          R01168
     C***********          MOVE LBCCY     EXCCY                    R01168 B5937
     C**                   MOVE WWECCY    EXCCY                     B5937 B07893
     C***********          MOVE LBCCY     EXCCY             B5937  B07893 S01498
     C                     MOVE LBCYCD    EXCCY                           S01498
     C**                   MOVE WWEREF    EXREF                     R01168B07893
     C**                   Z-ADDDDATX     EXDDAT                    R01168B07893
     C**                   Z-ADDVDATX     EXVDAT                    B01168B07893
     C                     MOVE *BLANKS   EXREF                           B08237
     C                     Z-ADD0         EXDDAT                          B08237
     C                     Z-ADD0         EXVDAT                          B08237
     C                     Z-ADD0         EXMDAT                          R01168
     C                     Z-ADD0         EXRLDT                          R01168
     C                     MOVE BBPCNB    EXPCNB                          B07893
     C*                                                                   R01168
     C/COPY WNCPYSRC,LB0620C001
     C           EXINST    IFNE LBFXUP                                    B7826
     C           EXINST    ANDNELBFXUL                                    B7826
     C           EXINST    ANDNELBPMUP                                    B7826
     C           EXINST    ANDNELBPMUL                                    B7826
     C                     WRITELBEXCOPF                                  R01168
     C                     END                                            B7826
     C/COPY WNCPYSRC,LB0620C002
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #C           - TERMINATION PROCESSING                     *
     C**                                                              *
     C**    CALLS        - ZSEDIT                                     *
     C**                                                              *
     C**    CALLED BY    - MAINLINE                                   *
     C**                                                              *
     C*****************************************************************
     C*
     C           #C        BEGSR
     C*
     C** PRINT HEADINGS ON OVERFLOW
     C           *IN51     IFEQ '1'                                       S01498
     C           LINE2     IFGE 56
     C                     WRITEHEADER1
     C                     END
     C*
     C** OUTPUT 'END OF REPORT'
     C                     WRITEENDRPT
     C                     CLOSELB0620P1                                  S01498
     C                     END                                            S01498
     C*
     C                     Z-ADDWWRECS    ZFLD15
     C                     Z-ADD*ZEROS    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRRECS
     C*                                                                   R01168
     C                     Z-ADDWWRECW    ZFLD15                          R01168
     C                     Z-ADD*ZEROS    ZDECS                           R01168
     C                     MOVE 'J'       ZECODE                          R01168
     C                     EXSR ZSEDIT                                    R01168
     C                     MOVE ZOUT21    RRRECW                          R01168
     C*
     C** INITIALISE LINE NUMBER AND OUTPUT RUN CONTROLS
     C                     Z-ADD*ZEROS    LINE1
     C                     WRITEFCNTLS1
     C                     WRITEFCNTLS3
     C*                                                                   S01498
     C** If no records to report, output 'No details' to audit.           S01498
     C*                                                                   S01498
     C           *IN51     IFEQ '0'                                       S01498
     C                     WRITENODTLS                                    S01498
     C                     END                                            S01498
     C*
     C           #C0       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    #YA          - THIS SUBROUTINE SETS UP CONSTANT FIELDS    *
     C**                   FOR PORTFOLIO EXTRACT FILE                 *
     C**                                                              *
     C**    CALLS        - NONE                                       *
     C**                                                              *
     C**    CALLED BY    - #BF                                        *
     C**                                                              *
     C*****************************************************************
     C*
     C           #YA       BEGSR
     C*
     C** FORMAT CONSTANT FIELDS
     C                     MOVE 'D'       EERECI
     C***********          Z-ADDKKCNUM    EECNUM                          S01498
     C***********          MOVE LBCCY     EECCY                           S01498
     C                     MOVE KKCNUM    EECNUM                          S01498
     C                     MOVE LBCYCD    EECCY                           S01498
     C*********************Z-ADD*ZEROS    EELIMT                          R0162
     C                     Z-ADD*ZEROS    EEACCD
     C                     Z-ADD*ZEROS    EEACCC
     C                     MOVE *BLANKS   EESESN
     C                     Z-ADD*ZEROS    EECLPC
     C                     Z-ADD*ZEROS    EESEPC
     C                     Z-ADD*ZEROS    EEINPC
     C                     Z-ADD*ZEROS    EECTPC
     C                     Z-ADD*ZEROS    EEBPWR
     C                     MOVE WWPARE    EEPCNB
     C                     Z-ADDBJDNWD    EEORED
     C                     Z-ADDBJDNWD    EELCD
     C                     TIME           EETLUP
     C                     Z-ADDWWDAY     EEDLUP
     C                     MOVE WWMNTH    EEMLUP
     C                     Z-ADDWWYEAR    EEYLUP
     C                     MOVE 'I'       EECHTP
     C*
     C           #YA0      ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**  SCONV - Converts an amount from one currency to another.       *
     C**                                                                 *
     C**  Input Fields - WWAMTI 15/0 amount in input currency            *
     C**                 WWSRI  13/8 spot rate for input currency        *
     C**                 WWSRO  13/8 spot rate for output currency       *
     C**                 WWDPI  1/0  no. of decimals for input currency  *
     C**                 WWDPO  1/0  no. of decimals for output currency *
     C**                 WWMDI  1    mult/div indicator for input curr.  *
     C**                 WWMDO  1    mult/div indicator for output curr. *
     C**                                                                 *
     C**  Arrays       - POWER  powers of 10                             *
     C**                                                                 *
     C**  Output Fields- WWAMTO 15/0 output amount converted to new curr *
     C**                                                                 *
     C**  CALLS    - NONE                                                *
     C**                                                                 *
     C********************************************************************
     C           SCONV     BEGSR                           **  SCONV    **
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDWWAMTI    WWAMTI 150
     C                     Z-ADD0         WWAMTO 150
     C           *LIKE     DEFN A6SPRT    WWSRI
     C           *LIKE     DEFN A6SPRT    WWSRO
     C           *LIKE     DEFN A6NBDP    WWDPI
     C           *LIKE     DEFN A6NBDP    WWDPO
     C           *LIKE     DEFN A6MDIN    WWMDI
     C           *LIKE     DEFN A6MDIN    WWMDO
     C*
     C           WWDPO     SUB  WWDPI     Z       10
     C           Z         ADD  4         Z
     C*
     C           WWMDI     IFNE WWMDO
     C*
     C** MULT/DIV INDICATORS DIFFERENT
     C           WWSRI     MULT WWSRO     WWRATE 159H
     C                     ELSE
     C*
     C** MULT/DIV INDICATORS THE SAME
     C           WWSRO     IFEQ 0
     C                     GOTO SC0
     C                     END
     C           WWSRI     DIV  WWSRO     WWRATE    H
     C                     END
     C*
     C           WWMDI     IFEQ 'D'
     C           WWRATE    IFEQ 0
     C                     GOTO SC0
     C                     END
     C           POWER,Z   DIV  WWRATE    WWRATE    H
     C                     ELSE
     C           POWER,Z   MULT WWRATE    WWRATE    H
     C                     END
     C*
     C           WWAMTI    MULT WWRATE    WWAMTO    H
     C*
     C           SC0       ENDSR                           **  SC0      **
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #A        - THIS SUBROUTINE PERFORMS INTIAL PROCESSING     *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #A        BEGSR
     C*                                                                   S01498
     C**  Copyright statement                                             S01498
     C*                                                                   S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*                                                                   S01498
     C**  Read in DTAARA/RUNDAT to get multibranching indicator           S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           RUNDAT                          S01498
     C                     IN   RUNDAT                                    S01498
     C           AGMBIN    IFEQ 'Y'                                       S01498
     C                     MOVE '1'       *IN39                           S01498
     C                     END                                            S01498
     C*
     C**   INITIALISE DB ERROR FIELDS AND STORE PROGRAM NAME FOR
     C**   DB ERROR FIELD.
     C*
     C           *NAMVAR   DEFN           LDA                             S01498
     C*                                                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'LB0620'  DBPGM
     C                     OUT  LDA                                       S01498
     C*
     C**   DEFINE WORK FIELDS
     C           *LIKE     DEFN A6SPRT    WWSPRT
     C           *LIKE     DEFN A6NBDP    WWDECP
     C           *LIKE     DEFN A6NBDP    #WDECP                          33150
     C           *LIKE     DEFN A6MDIN    WWMDIV
     C************LIKE     DEFN CNUM      WWCNUM                          S01498
     C************LIKE     DEFN CNUM      WKCNUM                          S01498
     C           *LIKE     DEFN CUNR      WWCNUM                          S01498
     C           *LIKE     DEFN CUNR      WKCNUM                          S01498
     C           *LIKE     DEFN LBFXUP    WKINST
     C           *LIKE     DEFN ECCY      WWECCY
     C           *LIKE     DEFN ECCY      WWPCCY
     C           *LIKE     DEFN EDAT      WWDATE
     C           *LIKE     DEFN PDCSHI    WWCIUP
     C           *LIKE     DEFN PDCSHI    WWCIUL
     C           *LIKE     DEFN PDCSHI    WWCIMA
     C           *LIKE     DEFN PDCSHI    WWCIMC
     C           *LIKE     DEFN PDCSHI    WWCIPP
     C           *LIKE     DEFN PDCSHI    WWCIPL
     C           *LIKE     DEFN PDCSHI    WWCIPA
     C           *LIKE     DEFN PDCSHI    WWCIPC
     C           *LIKE     DEFN GPLCGR    WWGRUP
     C           *LIKE     DEFN GPLCGR    WWGRUL
     C           *LIKE     DEFN GPLCGR    WWGRMA
     C           *LIKE     DEFN GPLCGR    WWGRMC
     C           *LIKE     DEFN GPLCGR    WWGRPP
     C           *LIKE     DEFN GPLCGR    WWGRPL
     C           *LIKE     DEFN GPLCGR    WWGRPA
     C           *LIKE     DEFN GPLCGR    WWGRPC
     C           *LIKE     DEFN GPLCGS    WWGSUP
     C           *LIKE     DEFN GPLCGS    WWGSUL
     C           *LIKE     DEFN GPLCGS    WWGSMA
     C           *LIKE     DEFN GPLCGS    WWGSMC
     C           *LIKE     DEFN GPLCGS    WWGSPP
     C           *LIKE     DEFN GPLCGS    WWGSPL
     C           *LIKE     DEFN GPLCGS    WWGSPA
     C           *LIKE     DEFN GPLCGS    WWGSPC
     C           *LIKE     DEFN EEEXPS    WWEXUP
     C           *LIKE     DEFN EEEXPS    WWEXUL
     C           *LIKE     DEFN EEEXPS    WWPMUP
     C           *LIKE     DEFN EEEXPS    WWPMUL
     C           *LIKE     DEFN EEEXPS    WW3XUP
     C           *LIKE     DEFN EEEXPS    WW3XUL
     C           *LIKE     DEFN EEEXPS    WW3MUP
     C           *LIKE     DEFN EEEXPS    WW3MUL
     C           *LIKE     DEFN EEEXPS    WWEXMA
     C           *LIKE     DEFN EEMARG    WWLBFX                          SA9109
     C           *LIKE     DEFN EEMARG    WWLBFP                          SA9109
     C           *LIKE     DEFN EEEXPS    WWXPMA
     C           *LIKE     DEFN EEEXPS    WWEXMC
     C           *LIKE     DEFN EEEXPS    WWXPMC
     C           *LIKE     DEFN BBCUST    WWPNP8
     C           *LIKE     DEFN BBPCNB    WWPARE
     C*
     C**   INITIALISE WORK FIELDS
     C                     Z-ADD*ZEROS    WWSPRT
     C                     Z-ADD*ZEROS    WWDECP
     C                     Z-ADD*ZEROS    WWGSUP
     C                     Z-ADD*ZEROS    WWGSUL
     C                     Z-ADD*ZEROS    WWGSMA
     C                     Z-ADD*ZEROS    WWGSMC
     C                     Z-ADD*ZEROS    WWGSPP
     C                     Z-ADD*ZEROS    WWGSPL
     C                     Z-ADD*ZEROS    WWGSPA
     C                     Z-ADD*ZEROS    WWGSPC
     C***********          Z-ADD*ZEROS    WWCNUM                          S01498
     C**********           MOVE *ZEROS    WWCNUM                                       S01498 CSD027
     C                     MOVE *BLANKS   WWCNUM                                              CSD027
     C                     Z-ADD*ZEROS    WWDATE
     C                     Z-ADD*ZEROS    WW3XUP
     C                     Z-ADD*ZEROS    WW3XUL
     C                     Z-ADD*ZEROS    WW3MUP
     C                     Z-ADD*ZEROS    WW3MUL
     C                     Z-ADD*ZEROS    WWEXUP
     C                     Z-ADD*ZEROS    WWEXUL
     C                     Z-ADD*ZEROS    WWPMUP
     C                     Z-ADD*ZEROS    WWPMUL
     C                     Z-ADD*ZEROS    WWEXMA
     C                     Z-ADD*ZEROS    WWXPMA
     C                     Z-ADD*ZEROS    WWLBFX                          SA9109
     C                     Z-ADD*ZEROS    WWLBFP                          SA9109
     C                     Z-ADD*ZEROS    WWEXMC
     C                     Z-ADD*ZEROS    WWXPMC
     C                     Z-ADD*ZEROS    WWRVEV 150
     C                     Z-ADD*ZEROS    WWRVOT 150
     C                     Z-ADD*ZEROS    WWERAT 138
     C                     Z-ADD*ZEROS    WWORAT 138
     C                     Z-ADD*ZEROS    WWPLAM 150
     C                     Z-ADD*ZEROS    WWRECS  50
     C                     Z-ADD*ZEROS    WWRECW  50                      R01168
     C                     Z-ADD*ZEROS    WWLAST  20
     C                     MOVE *BLANKS   WWMDIV
     C                     MOVE *BLANKS   WWCIUP
     C                     MOVE *BLANKS   WWCIUL
     C                     MOVE *BLANKS   WWCIMA
     C                     MOVE *BLANKS   WWCIMC
     C                     MOVE *BLANKS   WWCIPP
     C                     MOVE *BLANKS   WWCIPL
     C                     MOVE *BLANKS   WWCIPA
     C                     MOVE *BLANKS   WWCIPC
     C                     MOVE *BLANKS   WWGRUP
     C                     MOVE *BLANKS   WWGRUL
     C                     MOVE *BLANKS   WWGRMA
     C                     MOVE *BLANKS   WWGRMC
     C                     MOVE *BLANKS   WWGRPA
     C                     MOVE *BLANKS   WWGRPC
     C                     MOVE *BLANKS   WWECCY
     C                     MOVE *BLANKS   WWPCCY
     C                     MOVE *BLANKS   WWPNP8
     C                     MOVE *BLANKS   WWEREF                          R01168
     C*
     C**   INITIALISE VARIOUS ARRAY ELEMENTS
     C                     Z-ADD1         L       20
     C                     Z-ADD1         M       20
     C                     Z-ADD1         N       20
     C                     Z-ADD1         P       20
     C                     Z-ADD1         Y       20
     C*
     C**   INITIALISE LINE COUNTER
     C                     Z-ADD*ZEROS    LINE2
     C*
     C**   SET OFF ALL INDICATORS
     C                     MOVEA'00000000'*IN,21
     C                     MOVEA'0000'    *IN,29
     C                     MOVEA'00000000'*IN,61
     C                     MOVEA'00000'   *IN,69
     C                     MOVE '0'       *IN98
     C*
     C**   ACCESS ICD RECORD 1 TO GET RUN DATE, TITLE, BASE CURRENCY
     C**    AND DATE FORMAT INDICATOR
     C*
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 61               S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM '*MSG    '@RTCD   7                       S01498
     C                     PARM '*FIRST  '@OPTN   7                       S01498
     C           @BANK     PARM @BANK     DSFDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR LAST-CHANGE-TYPE = 'D' (DELETED)
     C*
     C************IN61     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           BJTYLC    OREQ 'D'                        ****************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD1         DBASE            *              *
     C***********          MOVEL'SDBANKPD'DBFILE           * DBERROR  001 S01498
     C                     MOVE 'SDBANKPD'DBFILE           * DBERROR  001 S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ****************
     C                     END
     C*                                                                   S01498
     C                     MOVE BJMRDT    WWMRDT                          S01498
     C*
     C**   DECIDE DATE FORMAT
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ELSE
     C           BJDFIN    IFEQ 'D'
     C                     MOVE '0'       *IN98
     C                     END
     C                     END
     C*
     C**   EVENT CONTROL DATE = DATE OF NEXT WORKING DAY MINUS 1
     C           BJDNWD    SUB  1         BJDNWD
     C*
     C**   ACCESS DEALING DATA FILE TO GET FORWARD REVALUATION OF
     C**     INTERESTS INDICATOR
     C*
     C***********1         SETLLSDDEALPD                                  S01498
     C***********          READ SDDEALPD                 62               S01498
     C*                                                                   S01498
     C**********           CALL 'AODEALR0'                                S01498              CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM '*MSG    '@RTCD   7                       S01498
     C                     PARM '*FIRST  '@OPTN   7                       S01498
     C********** @DEAL     PARM @DEAL     DSFDY                           S01498              CGL029
     C           @DEAL     PARM @DEAL     DSSDY                                               CGL029
     C*
     C**   IF RECORD NOT FOUND OR LAST-CHANGE-TYPE = 'D' (DELETED)
     C*
     C************IN62     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           BNTYLC    OREQ 'D'                        ****************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD2         DBASE            *              *
     C***********          MOVEL'SDDEALPD'DBFILE           * DBERROR  002 S01498
     C                     MOVE 'SDDEALPD'DBFILE           * DBERROR  002 S01498
     C                     MOVE *BLANKS   DBKEY            *              *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ****************
     C                     END
     C*                                                                   B10526
     C**   ACCESS SDCURRL1 RECORD                                         B10526
     C***********BNCYCD    CHAINSDCURRL1             99            B10526 S01498
     C*                                                                   B10526
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM BNCYCD    @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*                                                                   S01498
     C**   IF NOT FOUND THEN DB ERROR                                     B10526
B2   C************IN99     IFEQ '1'                                B10526 S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'                                       B10526
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE '012'     DBASE                           B10526
     C                     MOVE *BLANKS   DBFILE           ***************B10526
     C***********          MOVEL'SDCURRL1'DBFILE           ** DBER B10526 S01498
     C                     MOVE 'SDCURRPD'DBFILE           ** DBERROR 012 S01498
     C                     MOVELBNCYCD    DBKEY            ***************B10526
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       B10526
     C                     ELSE                                           B10526
     C                     Z-ADDA6SPRT    WWSRL  138                      B10526
     C                     Z-ADDA6NBDP    WWDPL   10                      B10526
     C                     MOVE A6MDIN    WWMDL   1                       B10526
     C                     END                                            B10526
     C*                                                                   087631
     C**  Access SAR details file to see if EXTENDED DEALING LIMITS       087631
     C**  is installed.                                                   087631
     C*                                                                   087631
     C                     CALL 'AOSARDR0'                                087631
     C                     PARM *BLANKS   @RTCD                           087631
     C                     PARM '*VERIFY' @OPTN                           087631
     C                     PARM 'S01433'  @SARD   6                       087631
     C           SCSARD    PARM SCSARD    DSFDY                           087631
      *                                                                   087631
     C           @RTCD     IFEQ *BLANK                                    087631
     C                     MOVE 'Y'       S01433  1                       087631
     C                     SETON                     47                   087631
     C                     END                                            087631
     C/COPY WNCPYSRC,LB0620C037
     C*
     C**   ACCESS PORTFOLIO LENDING ICD TO GET PORTFOLIO CURRENCY, FOREX
     C**   MARGIN %, PREDEFINED FOREX UNREALISED PROFIT, UNREALISED
     C**   LOSS, FOREX MARGIN AND FOREX MARGIN CALL.
     C*
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 63               S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM '*MSG    '@RTCD   7                       S01498
     C                     PARM '*FIRST  '@OPTN   7                       S01498
     C           @LOMB     PARM @LOMB     DSFDY                           S01498
     C*
     C**   IF RECORD NOT FOUND OR RECORD-ID = '*' THEN DB ERROR
     C*
     C************IN63     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           LBRECI    OREQ '*'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C***********          Z-ADD3         DBASE            *             *092542
     C                     Z-ADD26        DBASE            *             *092542
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 003 *S01498
     C***********          MOVE 'SDLOMBPD'DBFILE           * DBERROR 00398092542
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 026 *092542
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
     C*
     C**   IF RECORD FOUND ACCESS PORTFOLIO LENDING ICD EXTENDED FILE
     C                     ELSE
     C***********LBIC      IFEQ 'Y'                                33503  S01498
     C*
     C***********1         SETLLSDLOMBX0                                  S01498
     C***********          READ SDLOMBX0                 63               S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM '*MSG    '@RTCD   7                       S01498
     C                     PARM '*FIRST  '@OPTN   7                       S01498
     C           @LOMB     PARM @LOMB     DSFDY                           S01498
     C*
     C**   IF RECORD NOT FOUND THEN DB ERROR
     C*
     C************IN63     IFEQ '1'                        ************** S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            *             *
     C***********          MOVEL'SDLOMBX0'DBFILE           * DBERROR 003 *S01498
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 003 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
     C*
     C*    IF RECORD FOUND CHECK PREDEFINED INSTRUMENTS ARE NOT BLANK
     C                     ELSE
     C*
     C*    FOREX UNREALISED PROFIT
     C           LBFXUP    IFEQ *BLANKS
     C                     SETON                     40
     C                     MOVE 'FXUP'    DBKEY
     C                     END
     C*
     C*    FOREX UNREALISED LOSS
     C           LBFXUL    IFEQ *BLANKS
     C                     SETON                     40
     C                     MOVE 'FXUL'    DBKEY
     C                     END
     C*
     C*    FOREX MARGIN
     C           LBFXMA    IFEQ *BLANKS
     C                     SETON                     40
     C                     MOVE 'FXMA'    DBKEY
     C                     END
     C*
     C*    PRECIOUS METALS UNREALISED PROFIT
     C           S01433    IFEQ 'Y'                                       087631
     C           LBPMUP    IFEQ *BLANKS
     C                     SETON                     40
     C                     MOVE 'PMUP'    DBKEY
     C                     END
     C*
     C*    PRECIOUS METALS UNREALISED LOSS
     C           LBPMUL    IFEQ *BLANKS
     C                     SETON                     40
     C                     MOVE 'PMUL'    DBKEY
     C                     END
     C*
     C*    PRECIOUS METALS MARGIN
     C           LBPMMA    IFEQ *BLANKS
     C                     SETON                     40
     C                     MOVE 'PMMA'    DBKEY
     C                     END
     C                     END                                            087631
     C*
     C*    IF ANY OF THE PREDEFINED INSTRUMENTS ARE MISSING
     C*    OUTPUT ERROR REPORT AND DB ERROR
     C           *IN40     IFEQ '1'
     C***********          WRITEHEADER3                                   S01498
     C***********          WRITEDETAIL2                                   S01498
     C***********          WRITEENDRPT                                    S01498
     C*                                                    ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD19        DBASE            *             *
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 019 *S01498
     C                     MOVE 'SDLOMBPD'DBFILE           * DBERROR 019 *S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                        ***************
     C                     END
     C*
     C                     END
     C***********          END                                     33503  S01498
     C*
     C                     END
     C/COPY WNCPYSRC,LB0620C038
     C*
     C**   ACCESS CURRENCY CODES FILE TO GET SPOT RATE, NUMBER OF
     C**   DECIMAL PLACES AND MULTIPLY/DIVIDE INDICATOR FOR PORTFOLIO CCY
     C*
     C***********LBCCY     CHAINSDCURRL1             64                   S01498
     C*
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBCYCD    @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*                                                                   S01498
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR
     C*
     C************IN64     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'                        *****************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            *               *
     C***********          MOVEL'SDCURRL1'DBFILE           *  DBERROR  04 S01498
     C                     MOVE 'SDCURRPD'DBFILE           *  DBERROR  04 S01498
     C                     MOVE *BLANKS   DBKEY            *               *
     C***********          MOVELLBCCY     DBKEY            ************** S01498
     C                     MOVELLBCYCD    DBKEY            ************** S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C**   SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C**   FOR ROUTINE SCONV
     C*
     C                     Z-ADDA6SPRT    WWSRO
     C                     Z-ADDA6NBDP    WWDPO
     C                     MOVE A6MDIN    WWMDO
     C                     END
     C*
     C**   ACCESS CURRENCY CODES FILE TO GET SPOT RATE, NUMBER OF
     C**   DECIMAL PLACES AND MULTIPLY/DIVIDE INDICATOR FOR BASE CCY
     C*
     C***********BJCYCD    CHAINSDCURRL1             64                   S01498
     C*
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM BJCYCD    @CYCD   3                       S01498
     C           @CURR     PARM @CURR     DSSDY                           S01498
     C*                                                                   S01498
     C**   IF RECORD NOT FOUND OR LAST CHANGE TYPE ='D' THEN DB ERROR
     C*
     C************IN64     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           A6TYLC    OREQ 'D'                        *****************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD5         DBASE            *               *
     C***********          MOVEL'SDCURRL1'DBFILE           *  DBERROR  05 S01498
     C                     MOVE 'SDCURRPD'DBFILE           *  DBERROR  05 S01498
     C                     MOVE *BLANKS   DBKEY            *               *
     C                     MOVELBJCYCD    DBKEY            *****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C**   SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C**   FOR ROUTINE SCONV
     C*
     C                     Z-ADDA6SPRT    WWSRI
     C                     Z-ADDA6NBDP    WWDPI
     C                     MOVE A6MDIN    WWMDI
     C                     END
     C*
     C** MOVE CURRENCIES INTO WORKFIELD                                   B10523
     C                     MOVELBJCYCD    BJCYC1                          B10523
     C                     MOVELBJCYCD    BJCYC2                          B10523
     C                     MOVELBJCYCD    BJCYC3                          B10523
     C                     MOVELBJCYCD    BJCYC4                          B10523
     C***********          MOVELLBCCY     LBCCY1                   B10523 S01498
     C***********          MOVELLBCCY     LBCCY2                   B10523 S01498
     C***********          MOVELLBCCY     LBCCY3                   B10523 S01498
     C***********          MOVELLBCCY     LBCCY4                   B10523 S01498
     C                     MOVELLBCYCD    LBCCY1                          S01498
     C                     MOVELLBCYCD    LBCCY2                          S01498
     C                     MOVELLBCYCD    LBCCY3                          S01498
     C                     MOVELLBCYCD    LBCCY4                          S01498
     C*                                                                   B10523
     C** ACCESS INSTRUMENT TYPES FILE TO GET PORTFOLIO LENDING GROUP FOR
     C** FOREX UNREALISED PROFIT.
     C***********LBFXUP    CHAINSDPLINL4             65                   S01498
     C*
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBFXUP    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD6         DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 006 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 006 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBFXUP    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIUP
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C**  GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE.
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        *****************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD7         DBASE            *               *
     C***********          MOVEL'LBGROUL1'DBFILE           *  DBERROR  07 S01498
     C                     MOVE 'LBGROUPD'DBFILE           *  DBERROR  07 S01498
     C                     MOVE *BLANKS   DBKEY            *               *
     C                     MOVELPDLOMG    DBKEY            *****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRUP
     C                     MOVE GPLCGS    WWGSUP
     C                     END
     C*
     C                     END
     C*
     C** ACCESS INSTRUMENT TYPES FILE TO GET PORTFOLIO LENDING GROUP FOR
     C** PREDEFINED FOREX UNREALISED LOSS.
     C***********LBFXUL    CHAINSDPLINL4             65                   S01498
     C*
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBFXUL    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD8         DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 008 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 008 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBFXUL    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIUL
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C**  GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE.
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        *****************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD9         DBASE            *               *
     C***********          MOVEL'LBGROUL1'DBFILE           *  DBERROR  09 S01498
     C                     MOVE 'LBGROUPD'DBFILE           *  DBERROR  09 S01498
     C                     MOVE *BLANKS   DBKEY            *               *
     C                     MOVELPDLOMG    DBKEY            *****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRUL
     C                     MOVE GPLCGS    WWGSUL
     C                     END
     C*
     C                     END
     C*
     C** ACCESS INSTRUMENT TYPES FILE TO GET PORTFOLIO LENDING GROUP FOR
     C** FOREX MARGIN.
     C***********LBFXMA    CHAINSDPLINL4             65                   S01498
     C*
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBFXMA    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD10        DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 010 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 010 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBFXMA    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIMA
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C**  GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE.
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        *****************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD11        DBASE            *               *
     C***********          MOVEL'LBGROUL1'DBFILE           *  DBERROR  11 S01498
     C                     MOVE 'LBGROUPD'DBFILE           *  DBERROR  11 S01498
     C                     MOVE *BLANKS   DBKEY            *               *
     C                     MOVELPDLOMG    DBKEY            *****************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRMA
     C                     MOVE GPLCGS    WWGSMA
     C                     END
     C*
     C                     END
     C*
     C** ACCESS INSTRUMENT TYPES FILE TO GET PORTFOLIO LENDING GROUP FOR
     C** PRECIOUS METALS UNREALISED PROFIT
     C***********LBPMUP    CHAINSDPLINL4             65                   S01498
     C*
     C           S01433    IFEQ 'Y'                                       087631
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBPMUP    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD20        DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 020 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 020 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBPMUP    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIPP
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C**  GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE.
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD21        DBASE            *
     C***********          MOVEL'LBGROUL1'DBFILE           *  DBERROR  21 S01498
     C                     MOVE 'LBGROUPD'DBFILE           *  DBERROR  21 S01498
     C                     MOVE *BLANKS   DBKEY            *
     C                     MOVELPDLOMG    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRPP
     C                     MOVE GPLCGS    WWGSPP
     C                     END
     C*
     C                     END
     C*
     C** ACCESS INSTRUMENT TYPES FILE TO GET PORTFOLIO LENDING GROUP FOR
     C** PRECIOUS METALS UNREALISED LOSS
     C***********LBPMUL    CHAINSDPLINL4             65                   S01498
     C*
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBPMUL    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD22        DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 022 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 022 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBPMUL    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIPL
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C**  GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE.
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD23        DBASE            *
     C***********          MOVEL'LBGROUL1'DBFILE           *  DBERROR  23 S01498
     C                     MOVE 'LBGROUPD'DBFILE           *  DBERROR  23 S01498
     C                     MOVE *BLANKS   DBKEY            *
     C                     MOVELPDLOMG    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRPL
     C                     MOVE GPLCGS    WWGSPL
     C                     END
     C*
     C                     END
     C*
     C** ACCESS INSTRUMENT TYPES FILE TO GET PORTFOLIO LENDING GROUP FOR
     C** PRECIOUS METALS MARGIN
     C***********LBPMMA    CHAINSDPLINL4             65                   S01498
     C*
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM LBPMMA    @INNR   3                       S01498
     C           @PLIN     PARM @PLIN     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN65     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           PDRECI    OREQ '*'
     C           PDCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD24        DBASE            *             *
     C***********          MOVEL'SDPLINL4'DBFILE           * DBERROR 024 *S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 024 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBPMMA    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE CASH INSTRUMENT FLAG INTO WORK FIELD
     C                     MOVE PDCSHI    WWCIPA
     C*
     C** USE RETRIEVED PORTFOLIO LENDING GROUP CODE TO ACESS LBGROUL1 TO
     C**  GET PORTFOLIO LENDING GROUP AND PORTFOLIO LENDING SEQUENCE.
     C***********PDLOMG    CHAINLBGROUL1             66                   S01498
     C*
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM '*MSG   ' @RTCD   7                       S01498
     C                     PARM '*KEY   ' @OPTN   7                       S01498
     C                     PARM PDLOMG    @LCGR   3                       S01498
     C           @GROU     PARM @GROU     DSSDY                           S01498
     C*                                                                   S01498
     C** IF RECORD NOT FOUND, RECORD ID = '*' OR LAST CHANGE TYPE = 'D'
     C*
     C************IN66     IFEQ '1'                                       S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           GPRECI    OREQ '*'
     C           GPCHTP    OREQ 'D'                        ***************
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD25        DBASE            *
     C***********          MOVEL'LBGROUL1'DBFILE           *  DBERROR  25 S01498
     C                     MOVE 'LBGROUPD'DBFILE           *  DBERROR  25 S01498
     C                     MOVE *BLANKS   DBKEY            *
     C                     MOVELPDLOMG    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C                     MOVE GPLCGR    WWGRPA
     C                     MOVE GPLCGS    WWGSPA
     C                     END
     C*
     C                     END
     C                     ELSE                                           087631
     C                     MOVE *BLANKS   WWCIPP                          087631
     C                     MOVE *BLANKS   WWCIPL                          087631
     C                     MOVE *BLANKS   WWCIPA                          087631
     C                     MOVE *BLANKS   WWGRPP                          087631
     C                     MOVE *BLANKS   WWGSPP                          087631
     C                     MOVE *BLANKS   WWGRPL                          087631
     C                     MOVE *BLANKS   WWGSPL                          087631
     C                     MOVE *BLANKS   WWGRPA                          087631
     C                     MOVE *BLANKS   WWGSPA                          087631
     C                     END                                            087631
     C*
     C                     EXSR RCFAU                                     S01498
     C*                                                                   S01498
     C           #A0       ENDSR
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZA       - PROCESS DATABASE ERRORS                        *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #A                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZA       BEGSR
     C*
     C                     WRITEFCNTLS1
     C*                                                                   S01498
     C           *IN40     IFEQ '1'                                       S01498
     C                     WRITEMISSING                                   S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEFCNTLS2
     C*                                                                   S01498
     C           *IN51     IFEQ '1'                                       S01498
     C                     WRITEDBERROR                                   S01498
     C                     END                                            S01498
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     DUMP                                           S01498
     C                     RETRN
     C*
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************   S01498
     C*                                                                   S01498
     C*  RCFP1 -- Subroutine to register P1 report via RCF                S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C           RCFP1     BEGSR                            ** RCFP1 **   S01498
     C*                                                                   S01498
     C**  Ensure report spool file is recorded by RCF.                    S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUM     ZSNUM   60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ     5                       S01498
     C                     PARM *BLANKS   @PARM   3                       S01498
     C                     PARM           SFILE                           S01498
     C                     PARM           ZSNUM                           S01498
     C                     PARM           ZSERR   1                       S01498
     C*                                                                   S01498
     C**  Error during ZSFILE processing, return to calling program.      S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ENDSR                                          S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C/EJECT                                                              S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C*  RCFAU -- Subroutine to register AU report via RCF                S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C           RCFAU     BEGSR                            ** RCFAU **   S01498
     C*                                                                   S01498
     C**   Ensure audit spool file is recorded by RCF.                    S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUMU    ZSNUMU  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ                             S01498
     C                     PARM *BLANKS   @PARM                           S01498
     C                     PARM           SFILEU                          S01498
     C                     PARM           ZSNUMU                          S01498
     C                     PARM           ZSERR                           S01498
     C*                                                                   S01498
     C**  Error during ZSFILE processing, return to calling program.      S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ENDSR                                          S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C/EJECT                                                              S01498
     C*****************************************************************
     C**                                                              *
     C**   *PSSR     - PROGRAM ERROR HANDLING ROUTINE                 *
     C**                                                              *
     C**   CALLS     -                                                *
     C**                                                              *
     C**   CALLED BY -                                                *
     C**                                                              *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C           #PSSR0    ENDSR
     C*****************************************************************
      /EJECT
**  CPY@
(c) Finastra International Limited 2001
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   POWER - POWERS OF 10 FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
