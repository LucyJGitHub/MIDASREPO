     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Securities trading regeneration')             *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                             *
     F*                                                               *
     F*  LB0650 - Securities Trading Regeneration                     *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD057247           Date 01Feb21               *
      *  Prev Amend No. MD050604           Date 21Feb20               *
      *                 MD046248           Date 27Oct17               *
      *                 226449             Date 24Jun15               *
      *                 MD034776           Date 08Jul15               *
      *                 AR1067108          Date 11Dec12               *
      *                 AR1001183A         Date 20Nov12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 194370             Date 12Jul01               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun01               *
      *                 CSE031             Date 06Dec01               *
      *                 180707             Date 25Jul00               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CAP137             Date 07Feb00               *
      *                 CAP039             Date 29Mar00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 130862             Date 18Oct98               *
     F*                 CSE005             Date 04Feb97               *
     F*                 094397             Date 25Oct95               *
     F*                 092961             DATE 04OCT95               *
     F*                 080761             DATE 28DEC94               *
     F*                 S01498             DATE 11AUG94               *
     F*                 057917             DATE 25JUN93               *
     F*                 51611              DATE 04MAR93               *
     F*                 38835              DATE 27APR92               *
     F*                 B10664             DATE 11DEC91               *
     F*                 B08206             DATE 30AUG91               *
     F*                 B9926              DATE 23OCT90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD057247 - Multiple calls of UTCHOBJEX for several COB com-  *
      *             ponents - Securities module.                      *
      *           - Moved the call of AOSARDR0 from /copy ZLCDZ1.     *
      *  MD050604 - Average price of position changed incorrectly.    *
      *           - Recompiled due to changes in copy source ZCNSDZ1. *
      *  MD046248 - Finastra Rebranding                               *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  MD034776 - Reverse AR1001183A to allow negative interest     *
      *             rate. (Recompile)                                 *
      *  AR1067108 - PMC1140 Component failed during Clean COB        *
      *              Applied fix AR1001183A                           *
      *  AR1001183A- Coupon rate was still used in computation of     *
      *              interest instead of using the details in FRN tab *
      *              (Reopen) (Recompile)                             *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  194370 - Recompile after change on copy sources ZYLDZ2,      *
      *           For securities with divisor basis = '5' and first   *
      *           coupon date > valuation date (rundate + 1), set     *
      *           event control date to first coupon date before      *
      *           processing SR/ZDYYR. This is to ensure that the     *
      *           correct hypothetical last and next coupon dates are *
      *           used in deriving the price/yield rate.              *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed ZYLDZ2.                      *
      *  CSE031 - Coupon Fixing for Floating Rate Notes.              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  180707 - No Position Settlements generated. Recompile over   *
      *           changes in /COPY ZNCDZ3.                            *
      *  CAP137 - Conversion of SE Security inputs into modular       *
      *           structure to use as APIs.                           *
      *           Recompiled over changed in LF/LBCPOSL1/C (PF/SECTYD)*
      *  CAP039 - Conversion of SD inputs into modular structure to   *
      *           use as APIs. SECURITY CUSTOMER DETAILS API          *
     A*           Recompiled over changed LF/LBLLBCSJC (PF/SDSECSPD)  *
     F*  130862 - Recompiled over ZLCDZ1 & ZDAYSZ2 changes.           *
     F*  CSE005 - Effect of holidays on FRN Coupon Dates              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  094397 - Should call ZSFILE once have spool file number      *
     F*  092961 - Recompile over ZDAYSZ2 for 086491                   *
     F*           Wrong number of days calculated for day basis 1     *
     F*           when start or end day is last day of February.      *
     F*  080761 - Borrowing percentage printed is wrong               *
     A*  S01498 - Portfolio Lending Upgrade to Release 10             *
     F*  057917 - FOR COUNTRIES WITH TRADE DATE ACCOUNTING, THE TRADE *
     F*           DATE POSITION MUST BE USED.                         *
     F*  51611  - /COPY ZNCDZ2 AND ZYLDZ1 MISSING                     *
     F*  38835  - IMPROVE NARRATIVE FOR SECURITIES                    *
     F*  B10664 - IF BORROWING POWER WEIGHTING OF 0 IS ENTERED FOR    *
     F*           A SECURITY, THE INSTRUMENT WEIGHTING WAS USED       *
     F*  B08206 - INCORRECT PRICE FOR DISCOUNT/YIELD SECURITIES       *
     F*  B9926  - EXPOSURES SHORT POSITIONS                           *
     F*                                                               *
     F* NOTE FROM INCORPORATION : program rewritten in switzerland (?)*
     F* ***********************   killing all previous comments.      *
     F*                           No comment...                       *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F** C R E A T I O N     P A R A M E T E R S                      *
     F**                                                              *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**
     F**      FILE DEFINITIONS
     F**     ------------------
     F*
     F*****Bank*Details********************-*Prefix*BJ***********         S01498
     F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F***********                                                         S01498
     F*****portfolio*lending*I.C.D************-*Prefix*LB********         S01498
     F***SDLOMBPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F**   Run Controls Report
     F***LB0650AUO***E             21     PRINTER      KINFDS ERF2DS      S01498
     FLB0650AUO   E             21     PRINTER      KINFDS SPOOLU         S01498
     F                                              KINFSR *PSSR
     F*
     F**   Regeneration details report
     F***LB0650P0O***E             19     PRINTER      KINFDS ERF3DS      S01498
     FLB0650P1O   E             19     PRINTER      KINFDS SPOOL      UC  S01498
     F                                              KINFSR *PSSR
     F*
     F*****Currencies**********************-*Prefix*A6***********         S01498
     F***SDCURRL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   Clients Details                 - Prefix BB or CU
     F***SDLBCSLCIF**E           K        DISK         KINFSR *PSSR B7921 S01498
     FLBLBCSJCIF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   Customer Positions              - No Prefix
     F***CPOSNDL1IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBCPOSL1IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   portfolio lending Extract          - Prefix EE
     FLBEXTRL5UF  E           K        DISK
     F            LBEXTRD0                          KRENAMELBEXTRD5
     F                                              KINFSR *PSSR
     F*
     F**   Borrowing Power                 - Prefix BP
     FLBBPWRL1IF  E           K        DISK
     F            LBBPWRD0                          KRENAMELBBPWRD1
     F                                              KINFSR *PSSR
     F*
     F**   Borrowing Power                 - Prefix BP
     FLBBPWRL2IF  E           K        DISK
     F            LBBPWRD0                          KRENAMELBBPWRD2
     F                                              KINFSR *PSSR
     F*
     F**   Borrowing Power                 - Prefix BP
     FLBBPWRL3IF  E           K        DISK
     F            LBBPWRD0                          KRENAMELBBPWRD3
     F                                              KINFSR *PSSR
     F*
     F**   Borrowing Power                 - Prefix BP
     FLBBPWRL4IF  E           K        DISK
     F            LBBPWRD0                          KRENAMELBBPWRD4
     F                                              KINFSR *PSSR
     F*
     F**   Borrowing Power                 - Prefix BP
     FLBBPWRL5IF  E           K        DISK
     F            LBBPWRD0                          KRENAMELBBPWRD5
     F                                              KINFSR *PSSR
     F*
     F**   portfolio lending Groups           - Prefix GP / PD
     F**   Join of LBGROUPD and SDPLINPD
     FLBINSTL0IF  E           K        DISK         KINFSR *PSSR
     F*
     F**   portfolio lending Extract File     - Prefix EE
     FLBEXTRPDO   E           K        DISK         KINFSR *PSSR A
     F*                                                                   R01168
     F**   Portfolio Exposure/Collateral File - Prefix EX                 R01168
     FLBEXCOPDO   E                    DISK         KINFSR *PSSR          R01168
     F*                                                                   R01168
     F**   Security Diary                                                 B08206
     FSEDEV   IF  E           K        DISK         KINFSR *PSSR          B08206
     F*                                                                   S01498
     F**   Security Events by Type/Desc/Date (used by Subr. ZACCZ)        S01498
     FSECEO   IF  E           K        DISK         KINFSR *PSSR          S01498
     F            SNDEVDF                           KRENAMESNDEVDO        S01498
     F            SEDEVDF                           KRENAMESEDEVDO        S01498
     F*                                                                   S01498
     I*****************************************************************
     F/EJECT
     F*****************************************************************
     F**                                                              *
     F** ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F**                 ------------------------                     *
     F**                                                              *
     F*********19******-*Overflow indicator*on*LB0650P0****************   S01498
     F**       19      - Overflow indicator on LB0650P1               *   S01498
     F**       20      - Record found on LBEXTRL5                     *
     F**                                                              *
     F**       21      - Overflow indicator on LB0650AU               *
     F**                                                              *
     F**       23      - File Error                                   *
     F**       25      - Setll record match                           *
     F*********29******-*End*of*file*on*Read*SDLBCSLC************* B7921  S01498
     F**       29      - End of file on Read LBLBCSJC                 *   S01498
     F**       68      - End of file                                  *
     F**       69      - End of file                                  *
     F**                                                              *
     F**       51      - File identifier - CUSTOMER POSITIONS         *
     F**                                                              *
     F**                                                              *   R01168
     F*****************************************************************
     I/EJECT
     E********************************************************************
     E*
     E**   ARRAY FOR COPYRIGHT
     E*
     E                    CPY@    1   1 80
     E*
     E** SCONV S/R ARRAY FOR POWERS OF 10
     E*
     E                    POWER   1   7  7 3
     E*
     E** ARRAY FOR POWERS OF TEN USED IN COLLATERAL/EXPOSURE CALC.
     E*
     E                    POWER8  1   8  8 4
     E*  ARRAYS FOR INSTRUMENT GROUPS
     E                    AINN      200  3                                B08040
     E                    ACSH      200  1                                B08040
     E                    AGRP      200  3                                B08040
     E                    AGRS      200  2 0                              B08040
     E***ARRAYS*FOR*CURRENCIES***********************************         S01498
     E***********         CYCD      200  3                         B08040 S01498
     E***********         NBDP      200  1 0                       B08040 S01498
     E***********         RKSQ      200  3 0                       B08040 S01498
     E***********         SPRT      200 13 8                       B08040 S01498
     E***********         MDIN      200  1                         B08040 S01498
     E*  ARRAYS FOR INSTRUMENT BORROWING POWER
     E                    AINS      200  3                                B08040
     E                    AINP      200  3 0                              B08040
     E********************************************************************
     E/EJECT
     E*****************************************************************
     E/COPY ZSRSRC,ZSEDITZ1
     E/COPY ZSRSRC,ZNCDZ1                                                 B08206
     E/COPY ZSRSRC,ZDATE2Z1                                               B08206
     E/COPY ZSRSRC,ZDAYSZ1                                                B08206
     E/COPY ZSRSRC,ZACCRZ0                                                S01498
     E*****************************************************************
     E/EJECT
     I*****************************************************************
     I/COPY ZSRSRC,ZSEDITZ2
     I*****************************************************************
     I/EJECT
     I*
     I**   DATA STRUCTURE FOR COMPILATION - COPYRIGHT INSERTION
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*
     I** Data Structure to split date into day month year
     I            DS
     I***********                             1   7 BJMRDT                S01498
     I                                        1   7 WWMRDT                S01498
     I                                        1   20WWDAY
     I                                        3   5 WWMNTH
     I                                        6   70WWYEAR
     I*
     I**   FOR OVERFLOW
     I***ERF2DS**    DS                                                   S01498
     ISPOOL       DS                                                      S01498
     I                                       83  92 SFILE                 S01498
     I**********                            123 1240SFNUM           S01498094397
     I                                    B 123 1240SFNUM                 094397
     I                                    B 367 3680LINE1
     I*
     I**   FOR OVERFLOW
     I***ERF3DS**    DS                                                   S01498
     ISPOOLU      DS                                                      S01498
     I                                       83  92 SFILEU                S01498
     I***********                           123 1240SFNUMU          S01498094397
     I                                    B 123 1240SFNUMU                094397
     I                                    B 367 3680LINE2
     I*
     I**  LOCAL DATA AREA FOR DATA BASE ERRORS
     I***LDA********UDS                            256                    S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*                                                                   S01498
     ISDBANK    E DSSDBANKPD                                              S01498
     I**  Midas  Bank details                                          S01498
     I*                                                                   S01498
     ISDLOMB    E DSSDLOMBPD                                              S01498
     I**  Midas  Portfolio Lending ICD details                         S01498
     I*                                                                   S01498
     ISDCURR    E DSSDCURRPD                                              S01498
     I**  Midas  Currencies details                                    S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I**  Long data structure                                             S01498
     I*                                                                   S01498
     IDSFDY     E DSDSFDY                                                 S01498
     I**  Short data structure                                            S01498
     I/COPY WNCPYSRC,LB0650I001
     I*                                                                   S01498
      /COPY ZSRSRC,ZNCDZ2                                                  51611
      /COPY ZSRSRC,ZYLDZ1                                                  51611
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                                   S01498
     C** Define PLISTS                                                    S01498
     C*  =============                                                    S01498
     C*                                                                   S01498
     C**  Parameter list for access program AOCURRR0                      S01498
     C*                                                                   S01498
     C           PLCURR    PLIST                                          S01498
     C                     PARM *BLANKS   P@RTCD  7                       S01498
     C                     PARM '*KEY  '  P@OPTN  7                       S01498
     C                     PARM           P@CYCD  3                       S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*
     C** DEFINE KLISTS
     C*  =============
     C*
     C** KLIST FOR LBEXTRL5 AND LBBPWRL2
     C*
     C           KL1       KLIST
     C                     KFLD           WWCNUM
     C                     KFLD           WWSESN
     C*
     C** KLIST FOR BORROWING POWER FILE - LBBPWRL1
     C*
     C           KL3       KLIST
     C                     KFLD           WWCNUM
     C                     KFLD           INNR
     C*                                                                   S01498
     C**  Define local data area                                          S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           LDA                             S01498
     C*
     C*
     C*****************************************************************
     C*
     C**              START MAINLINE
     C**             ----------------
     C*
     C* INIT DE 12 FIELDS EMPLOYEES DANS SECTYD A LEUMI
     C* SECTYD N'A PAS ETE CHANGE POUR JYSKE, CES FIELDS SONT
     C*INITIALISEES A BLANC OU ZERO
     C*
     C                     Z-ADD0         CPNR   117
     C                     Z-ADD0         ECD     50
     C                     Z-ADD0         FCPN    50
     C                     Z-ADD0         ISSD    50
     C                     Z-ADD0         ITLD    50
     C                     Z-ADD0         MATY    50
     C                     Z-ADD0         IADJ    30
     C                     MOVE *BLANK    DYBS    1
     C                     MOVE *BLANK    SYBS    2
     C                     MOVE *BLANK    STBS    1
     C                     MOVE *BLANK    DVBS    1
     C                     MOVE *BLANK    SESN   10
     C**   INITIAL PROCESSING
     C*
     C                     EXSR #A
     C*
     C**   MAIN PROCESSING
     C*
     C                     EXSR #B
     C*
     C**   TERMINATION PROCESSING
     C*
     C                     EXSR #C
     C*
     C**   END PROGRAM
     C*
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    INDEX TO SUBROUTINES                                      *
     C**   ----------------------                                     *
     C**                                                              *
     C**                                                              *
     C**   #B      - Main processing                                  *
     C**                                                              *
     C**   #BA     - Calculate Collateral & Borrowing power           *
     C**   #BAA    - Deduce Borrowing Power %                         *
     C**
     C**   #C      - Termination process                              *
     C**   #A      - Performs initial processing                      *
     C**   P01     - WRITE RECORD TO EXPOSURE/COLLATERAL FILE         *   R01168
     C**   SCONV   - Converts an amount from one currency to another  *
     C**   ZSEDIT  - Convert amount for output                        *
     C*    ZPRCI   - OUTPUT PRICE AS % PRICE                              B08206
     C*                                                               *
     C**   #ZA     - Process Database Errors                          *
     C**   #ZB     - Write Records to Portfolio Extract Detail File   *
     C**   #ZC     - Update/Write to Portfolio Extract Detail File    *
     c**   #ZE     - Calculate Collateral/Exposure                    *
     C**                                                              *
     C**   *PSSR   - Program error handling routine                   *
     C**                                                              *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #B        - MAIN PROCESSING                                *
     C**                                                              *
     C**   CALLS     - #BA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #B        BEGSR
     C*
     C***READ*FIRST*RECORD*ON*SDLBCSLC***************************  B7921  S01498
     C***********                                                         S01498
     C************LOVAL    SETLLSDLBCSLC                           B7921  S01498
     C***********          READ SDLBCSLC                 29        B7921  S01498
     C*                                                                   S01498
     C**  Read first record on LBLBCSJC                                   S01498
     C*                                                                   S01498
     C           *LOVAL    SETLLLBLBCSJC                                  S01498
     C                     READ LBLBCSJC                 29               S01498
     C*
     C** LOOP WHILE NOT END OF FILE
     C*
     C           *IN29     DOWEQ'0'
     C*
     C** SAVE THE CUSTOMER NUMBER & PARENT CUSTOMER NUMBER
     C*
     C                     MOVE BBCUST    WWCUST
     C                     MOVE BBPCNB    WWPCNB
     C**********           MOVE WWCUST    WWCNUM  60                                          CSD027
     C                     MOVE WWCUST    WWCNUM  6                                           CSD027
     C*
     C** READ ALL RECORDS ON CPOSNDL1 FOR CURRENT CUSTOMER
     C*
     C***********WWCNUM    SETLLCPOSNDL1                                  S01498
     C***********WWCNUM    READECPOSNDL1                 69               S01498
     C           WWCNUM    SETLLLBCPOSL1                                  S01498
     C           WWCNUM    READELBCPOSL1                 69               S01498
     C*                                                                   S01498
     C           *IN69     DOWEQ'0'
     C*
     C** SAVE THE SECURITY SHORTNAME
     C*
     C                     MOVE CSSC      WWSESN
     C*                                                                   B9926
     C*  DO NOT PROCESS ZERO POSITIONS                                    B9926
     C**         CSNV      IFNE 0                                    R0132057917
     C           CSNT      IFNE 0                                         057917
     C*
     C** SAVE NOMINAL TRADE DATE BASIS AS THE POSITION
     C*
     C**                   Z-ADDCSNV      WWPOST                     R0132057917
     C                     Z-ADDCSNT      WWPOST                          057917
     C*
     C** CALCULATE THE PORTFOLIO COLLATERAL & BORROWING POWER
     C*
     C                     EXSR #BA
     C*                                                                   B9926
     C                     END                                            B9926
     C*
     C** COUNT OF RECORDS READ FROM CUSTOMER POSITIONS
     C*
     C                     ADD  1         RRCPOS
     C*
     C***READ*NEXT*RECORD*FROM*CPOSNDL1**************************         S01498
     C**  Read next record from LBCPOSL1                                  S01498
     C*
     C***********WWCNUM    READECPOSNDL1                 69               S01498
     C           WWCNUM    READELBCPOSL1                 69               S01498
     C*
     C                     END
     C*
     C***READ*NEXT*RECORD*ON*SDLBCSLC****************************  B7921  S01498
     C***********                                                         S01498
     C***********          READ SDLBCSLC                 29        B7921  S01498
     C*                                                                   S01498
     C**  Read next record on LBLBCSJC                                    S01498
     C*                                                                   S01498
     C                     READ LBLBCSJC                 29               S01498
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BA       - CALCULATE COLLATERAL & BORROWING POWER         *
     C**                                                              *
     C**   CALLS     - #BAA, #ZB, #ZE                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BA       BEGSR
     C*
     C** SAVE THE NOMINAL CURRENCY
     C*
     C                     MOVE NMCY      WWNMCY
     C*
     C** CALCULATE THE PORTFOLIO COLLATERAL
     C*
     C                     EXSR #ZE
     C                     MOVE WWFLD     WWCOLL
     C*
     C** CONVERT TO PORTFOLIO LENDING CURRENCY
     C*
     C                     Z-ADDWWCOLL    WWAMTI
     C                     Z-ADDA6SPRT    WWSRI
     C                     Z-ADDNMDP      WWDPI                           LB0000
     C                     MOVE A6MDIN    WWMDI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    WWCOLL
     C*
     C** SAVE COLLATERAL FOR USE ON REPORT
     C*
     C                     Z-ADDWWAMTO    W0COLL
     C*                                                                   B9926
     C** IF SHORT POSITION - GOES UNDER EXPOSURE (NOT REDUCED COLLAT.)    B9926
     C           WWCOLL    IFLE 0                                         B9926
     C                     Z-SUBWWCOLL    WWEXPS                          B9926
     C                     Z-SUBWWCOLL    W0EXPS                          B9926
     C                     Z-ADD0         WWCOLL                          B9926
     C                     Z-ADD0         W0COLL                          B9926
     C                     Z-ADD0         EECOLL                          B9926
     C                     Z-ADD0         EEBPWR                          B9926
     C                     Z-ADD0         EECLPC                          B9926
     C                     Z-ADD0         EESEPC                          B9926
     C                     Z-ADD0         EEINPC                          B9926
     C                     Z-ADD0         EECTPC                          B9926
     C                     END                                            B9926
     C*
     C** CHECK IF CUSTOMER NO./SECURITY REF. EXISTS
     C*
     C*  CALCULATE COLLATERAL / B. POWER ONLY FOR LONG POSITIONS          B9926
     C           WWCOLL    IFNE 0                                         B9926
     C*                                                                   B9926
     C** DEDUCE BORROWING POWER %
     C                     EXSR #BAA
     C*
     C** CHECK BORROWING POWER % DOES NOT EQUAL ZERO
     C*
     C           WWBRPC    IFEQ *ZEROS
     C                     Z-ADD0         EEBPWR                          B9926
     C                     Z-ADD0         W0BPWR                          B9926
     C                     Z-ADDWWCOLL    EECOLL                          B9926
     C                     ELSE                                           B9926
     C*
     C** CALCULATE THE BORROWING POWER PERCENTAGE
     C*
     C           WWBRPC    DIV  100       WWBPER  32
     C           WWCTPC    DIV  100       WWCPER  32
     C           WWBPER    MULT WWCPER    WWBPER
     C*
     C** CALCULATE THE BORROWING POWER
     C*
     C           WWCOLL    MULT WWBPER    EEBPWR
     C*
     C** CALC BORROWING POWER FOR USE ON REPORT
     C*
     C           W0COLL    MULT WWBPER    W0BPWR
     C*
     C** FORMAT COLLATERAL FIELD
     C*
     C                     Z-ADDWWCOLL    EECOLL
     C                     END                                            B9926
     C*                                                                   B9926
     C                     ELSE                                           B9926
     C*                                                                   B9926
     C*  ADD TO EXPOSURE FOR SHORT POSITIONS                              B9926
     C*                                                                   S01498
     C           KL1       CHAINLBEXTRL5             68                   S01498
     C*                                                                   S01498
     C           EEEXPS    ADD  WWEXPS    EEEXPS                          B9926
     C           *IN68     IFEQ '1'                                       B9926
     C                     SETOF                     20                   B9926
     C                     ELSE                                           B9926
     C                     SETON                     20                   B9926
     C                     END                                            B9926
     C                     END                                            B9926
     C*
     C** WRITE/UPDATE THE PORTFOLIO EXTRACT DETAIL FILE
     C*
     C           *IN20     IFEQ '1'
     C                     Z-ADDBJDNWD    EELCD
     C                     TIME           EETLUP
     C                     Z-ADDWWDAY     EEDLUP
     C                     MOVE WWMNTH    EEMLUP
     C                     Z-ADDWWYEAR    EEYLUP
     C                     UPDATLBEXTRD5
     C                     SETOF                     20
     C                     ELSE
     C                     EXSR #ZB
     C                     END
     C*
     C***OUTPUT*DETAIL*ON*LB0650P0*******************************         S01498
     C**  Output detail on LB0650P1                                       S01498
     C*
     C                     Z-ADDWWPOST    WWNAMT
     C                     EXSR #YA
     C*
     C** INITIALISE FIELDS
     C*
     C                     Z-ADD*ZEROS    WWBRPC
     C                     Z-ADD*ZEROS    WWCTPC
     C                     Z-ADD*ZEROS    WWCOLL
     C                     Z-ADD*ZEROS    WWEXPS                          B9926
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BAA      - DEDUCE BORROWING POWER % FOR NEW RECORDS       *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #BA                                            *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BAA      BEGSR
     C*
     C                     Z-ADD*ZEROS    EECOLL
     C                     Z-ADD*ZEROS    EESEPC
     C                     Z-ADD*ZEROS    EECLPC
     C                     Z-ADD*ZEROS    EEINPC
     C                     Z-ADD*ZEROS    EECTPC
     C                     Z-ADD*ZEROS    EEEXPS
     C*
     C** ACCESS THE BORROWING POWER FILE 4
     C*
     C           WWSESN    CHAINLBBPWRL4             68
     C           *IN68     IFEQ '0'
     C**         BPSEPC    ANDGT*ZEROS                                    B10664
     C*
     C** USE SECURITY REF. % AS THE BORROWING POWER %
     C*
     C                     Z-ADDBPSEPC    WWBRPC
     C                     Z-ADDBPSEPC    EESEPC
     C                     END
     C*
     C** ACCESS THE BORROWING POWER FILE 2
     C*
     C**         KL1       CHAINLBBPWRL2             68                   B10664
     C**         *IN68     IFEQ '0'                                       B10664
     C**         BPSEPC    ANDGT*ZEROS                                    B10664
     C           KL1       CHAINLBBPWRL2             69                   B10664
     C           *IN69     IFEQ '0'                                       B10664
     C*
     C** USE CLIENT % AS THE BORROWING POWER
     C*
     C                     Z-ADDBPSEPC    WWBRPC
     C                     Z-ADDBPSEPC    EECLPC
     C                     END
     C*
     C***CHECK*IF*PERCENTAGE IS FOUND                                     B10664
     C***                                                                 B10664
     C***        WWBRPC    IFEQ *ZEROS                                    B10664
     C*                                                                   B10664
     C** IF NO % FOUND FOR SECURITY OR CUSTOMER, USE INSTRUMENT           B10664
     C           *IN68     IFEQ '1'                                       B10664
     C           *IN69     ANDEQ'1'                                       B10664
     C*
     C** LOOK UP INSTRUMENT PERCENTAGE
     C                     Z-ADD1         B                               B08040
     C           INNR      LOKUPAINS,B                   68               B08040
     C           *IN68     IFEQ '1'                                    ***B08040
     C                     Z-ADDAINP,B    WWBRPC                          B08040
     C                     Z-ADDAINP,B    EEINPC                          B08040
     C                     END                                            B08040
     C*
     C** ACCESS BORROWING POWER FILE 1
     C*
     C           KL3       CHAINLBBPWRL1             68
     C           *IN68     IFEQ '0'
     C           EEINPC    ANDGT*ZEROS
     C*
     C** USE CLIENT % AS THE BORROWING %
     C*
     C                     Z-ADDEEINPC    WWBRPC
     C                     Z-ADDEEINPC    EECLPC
     C*
     C** USE CLIENT % AS THE BORROWING POWER %
     C*
     C                     END
     C                     END
     C*
     C** ACCESS THE BORROWING POWER FILE 5
     C*
     C           SCOR      CHAINLBBPWRL5             68
     C*
     C           *IN68     IFEQ '0'
     C           BPCTPC    ANDGT*ZEROS
     C                     Z-ADDBPCTPC    WWCTPC
     C                     ELSE
     C                     Z-ADD100       WWCTPC
     C                     END
     C*
     C** SAVE COUNTRY PERCENTAGE
     C*
     C                     Z-ADDWWCTPC    EECTPC
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZB       - WRITE TO PORTFOLIO EXTRACT DETAIL FILE         *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZB       BEGSR
     C*
     C** LOOK UP INSTRUMENT DETAILS
     C                     Z-ADD1         B                               B08040
     C           INNR      LOKUPAINN,B                   68               B08040
     C** ERROR                                                            B08040
     C           *IN68     IFEQ '0'                                    ***B08040
     C                     Z-ADD10        DBASE            ***************
     C***********          MOVEL'LBGROUL1'DBFILE           * DBERROR 100 *S01498
     C                     MOVE 'LBGROUL1'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELPDLOMG    DBKEY            ***************
     C                     EXSR #ZA
     C                     ELSE                                           B08040
     C*
     C                     MOVE INNR      EEINST                          B08040
     C                     MOVE ACSH,B    EECIFL                          B08040
     C                     MOVE AGRP,B    EELCGR                          B08040
     C                     Z-ADDAGRS,B    EELCGS                          B08040
     C                     END                                            B08040
     C*
     C** FORMAT REMAINING FIELDS
     C*
     C                     MOVE 'D'       EERECI
     C**********           Z-ADDWWCNUM    EECNUM                                              CSD027
     C                     MOVE WWCNUM    EECNUM                                              CSD027
     C                     MOVE WWNMCY    EECCY
     C                     Z-ADD*ZEROS    EELIMT
     C                     Z-ADD*ZEROS    EEACCD
     C                     Z-ADD*ZEROS    EEACCC
     C                     MOVE WWSESN    EESESN
     C                     MOVE WWPCNB    EEPCNB
     C                     Z-ADDBJDNWD    EEORED
     C                     Z-ADDBJDNWD    EELCD
     C                     TIME           EETLUP
     C                     Z-ADDWWDAY     EEDLUP
     C                     MOVE WWMNTH    EEMLUP
     C                     Z-ADDWWYEAR    EEYLUP
     C*
     C** WRITE RECORD TO LBEXTRPD
     C*
     C                     WRITELBEXTRD0
     C*
     C** MAINTAIN COUNT OF RECORDS ADDED TO LBEXTRPD
     C*
     C                     ADD  1         RRNRPD
     C*
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZC       - UPDATE PORTFOLIO EXTRACT DETAIL FILE           *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZC       BEGSR
     C*
     C** CHECK IF THE CUST NO./SECURITY REF. ALREADY EXISTS
     C*
     C           KL1       CHAINLBEXTRL5             68
     C           *IN68     IFEQ '0'
     C*
     C** RECORD EXISTS - UPDATE
     C*
     C                     ADD  WWEXPS    EEEXPS
     C                     Z-ADDBJDNWD    EELCD
     C                     TIME           EETLUP
     C                     Z-ADDWWDAY     EEDLUP
     C                     MOVE WWMNTH    EEMLUP
     C                     Z-ADDWWYEAR    EEYLUP
     C                     UPDATLBEXTRD5
     C                     ELSE
     C*
     C** RECORD NOT FOUND - ADD
     C*
     C                     Z-ADDWWEXPS    EEEXPS
     C                     Z-ADD*ZEROS    EECOLL
     C                     Z-ADD*ZEROS    EEBPWR
     C                     Z-ADD*ZEROS    EESEPC
     C                     Z-ADD*ZEROS    EEINPC
     C                     Z-ADD*ZEROS    EEBPWR
     C*
     C                     EXSR #ZB
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZE       - CALCULATE COLLATERAL                           *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZE       BEGSR
     C*
     C***FIND*CURRENCY*DETAILS***********************************         S01498
     C***********          Z-ADD1         B                        B08040 S01498
     C***********WWNMCY    LOKUPCYCD,B                   68        B08040 S01498
     C***ERROR***************************************************  B08040 S01498
     C************IN68     IFEQ '0'                                B08040 S01498
     C***********          Z-ADD4         DBASE            ***************S01498
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 044 *S01498
     C***********          MOVE *BLANKS   DBKEY            *             *S01498
     C***********          MOVELNMCY      DBKEY            ***************S01498
     C***********          EXSR #ZA                                       S01498
     C***********          ELSE                                    B08040 S01498
     C***********                                                         S01498
     C***********          Z-ADDSPRT,B    A6SPRT                   B08040 S01498
     C***********          MOVE MDIN,B    A6MDIN                   B08040 S01498
     C***********          Z-ADDNBDP,B    A6NBDP                   B08040 S01498
     C***********          END                                     B08040 S01498
     C*                                                                   S01498
     C**  Find Currency Details                                           S01498
     C*                                                                   S01498
     C                     MOVE WWNMCY    P@CYCD                          S01498
     C                     CALL 'AOCURRR0'PLCURR                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            ***************S01498
     C                     MOVE 'SDCURRPD'DBFILE           *DB ERROR 004 *S01498
     C                     MOVELWWNMCY    DBKEY            ***************S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       S01498
     C                     ENDIF                                          S01498
     C*
     C*
     C** INITIALISE FIELDS USED IN COLL CALCULATION
     C*
     C                     Z-ADD0         WWFLD  150
     C                     Z-ADD0         WWFLD0 150
     C                     Z-ADD0         WWFLD1 151
     C                     Z-ADD0         WWFLD2 152
     C                     Z-ADD0         WWFLD3 153
     C*
     C** SET INDICATOR FOR NUMBER OF DECIMAL PLACES
     C*
     C                     MOVEA'0000'    *IN,30
     C           30        ADD  A6NBDP    V       20
     C                     MOVEA'1'       *IN,V
     C*
     C** CALCULATE COLLATERAL
     C**   CHECK THE MARKET/NOMINAL VALUE
     C*
     C           LBCMNV    IFEQ 'M'
     C*
     C** SAVE PRICE FOR OUTPUT ON REPORT
     C*
     C** CONVERT THE MARKET PRICE FROM DISCOUNT/YIELD TO %                B08206
     C           STBS      IFEQ 'D'                                       B08206
     C           MKPR      ANDNE*ZERO                                     B08206
     C           STBS      OREQ 'Y'                                       B08206
     C           MKPR      ANDNE*ZERO                                     B08206
     C                     Z-ADDMKPR      ZPRCIN                          B08206
     C                     Z-ADDECD       ZFDATE                          B08206
     C                     EXSR ZPRCI                                     B08206
     C                     Z-ADDZPRCOT    WWPRIC                          B08206
     C                     ELSE                                           B08206
     C                     Z-ADDMKPR      WWPRIC
     C                     END                                            B08206
     C*
     C**   CALCULATE COLLATERAL:- POSITION X MARKET PRICE
     C*
     C**         WWPOST    MULT MKPR      WWFLD                           B08206
     C           WWPOST    MULT WWPRIC    WWFLD                           B08206
     C*
     C           PROT      IFEQ '8'
     C           WWFLD     MULT CFCT      WWFLD
     C                     END
     C*
     C           SPBS      IFEQ 'P'
     C           WWFLD     DIV  100       WWFLD     H
     C                     END
     C*
     C                     ELSE
     C*
     C** SAVE PRICE FOR OUTPUT ON REPORT
     C*
     C                     Z-ADDISSP      WWPRIC
     C*
     C**   CALCULATE COLLATERAL:- POSITION X ISSUE PRICE
     C*
     C   30      WWPOST    MULT ISSP      WWFLD0    H
     C   31      WWPOST    MULT ISSP      WWFLD1    H
     C   32      WWPOST    MULT ISSP      WWFLD2    H
     C   33      WWPOST    MULT ISSP      WWFLD3    H
     C*
     C**  IF PROCESSING TYPE IS 8, MULTIPLY COLL BY CURRENT FACTOR
     C*
     C           PROT      IFEQ '8'
     C   30      WWFLD0    MULT CFCT      WWFLD0
     C   31      WWFLD1    MULT CFCT      WWFLD1
     C   32      WWFLD2    MULT CFCT      WWFLD2
     C   33      WWFLD3    MULT CFCT      WWFLD3
     C                     END
     C*
     C*     IF PRICE BASIS IS P, DIVIDE COLL BY 100
     C*
     C           SPBS      IFEQ 'P'
     C   30      WWFLD0    DIV  100       WWFLD0    H
     C   31      WWFLD1    DIV  100       WWFLD1    H
     C   32      WWFLD2    DIV  100       WWFLD2    H
     C   33      WWFLD3    DIV  100       WWFLD3    H
     C                     END
     C*
     C   30                MOVE WWFLD0    WWFLD
     C   31                MOVE WWFLD1    WWFLD
     C   32                MOVE WWFLD2    WWFLD
     C   33                MOVE WWFLD3    WWFLD
     C*
     C** ALLOW FOR NOMINAL DECIMAL PLACES
     C*
     C           5         SUB  NMDP      J       10
     C           WWFLD     MULT POWER8,J  WWFLD     H
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #C        - TERMINATION PROCESS                            *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #C        BEGSR
     C*
     C***IF*NO*DETAILS*ON*LB0650P0*******************************         S01498
     C***********                                                         S01498
     C***********WWDOR0    IFEQ 'N'                                       S01498
     C***********          WRITENULL0                                     S01498
     C***********          END                                            S01498
     C*                                                                   S01498
     C**  Perform end processing for LB0650P1                             S01498
     C*                                                                   S01498
     C           WLOPN     IFEQ 'Y'                                       S01498
     C*
     C***OUTPUT*FOOTINGS*ON*LB0650P0*****************************         S01498
     C**  Output footing on LB0650P1                                      S01498
     C*
     C           LINE1     IFGT 55
     C                     WRITEHEADER0
     C                     END
     C*                                                                   S01498
     C                     WRITEFOOTING0
     C*                                                                   S01498
     C**  Ensure Report Spool File recorded by RCF                        S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUM     ZSNUM1  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ     5                       S01498
     C                     PARM *BLANK    SENTY   3                       S01498
     C                     PARM           SFILE                           S01498
     C                     PARM           ZSNUM1                          S01498
     C                     PARM           ZSERR   1                       S01498
     C*                                                                   S01498
     C** If an error occurred during ZSFILE processing,                   S01498
     C** return to the calling program.                                   S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C**  Close printer file LB0650P1                                     S01498
     C*                                                                   S01498
     C                     CLOSELB0650P1                                  S01498
     C                     MOVE *BLANK    WLOPN                           S01498
     C                     ENDIF                                          S01498
     C*
     C**   WRITE HEADINGS
     C*
     C                     WRITEHDRCTRL1
     C*
     C**   WRITE DETAILS & FOOTINGS
     C*
     C           WWDOR0    IFEQ 'N'                                       S01498
     C                     WRITENODTLS                                    S01498
     C*                                                                   S01498
     C                     ELSE                                           S01498
     C                     WRITEDTRCTRL1
     C                     ENDIF                                          S01498
     C*                                                                   S01498
     C** Ensure Audit Spool File recorded by RCF                          S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUMU    ZSNUM2  60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ                             S01498
     C                     PARM *BLANK    SENTY                           S01498
     C                     PARM           SFILEU                          S01498
     C                     PARM           ZSNUM2                          S01498
     C                     PARM           ZSERR                           S01498
     C*                                                                   S01498
     C** If an error occurred during ZSFILE processing,                   S01498
     C** return to the calling program.                                   S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #A        - THIS SUBROUTINE PERFORMS INITIAL PROCESSING    *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #A        BEGSR
     C*
     C** SRT OF ALL INDICATORS
     C*
     C                     MOVEA'00000000'*IN,21
     C                     MOVEA'00000000'*IN,29
     C                     MOVEA'000'     *IN,37
     C                     MOVEA'00000000'*IN,71
     C                     MOVE '0'       *IN98
     C*
     C*
     C**   INITIALISE DB ERROR FIELDS AND STORE PROGRAM NAME FOR
     C**   DB ERROR FIELD.
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'LB0650'  DBPGM
     C                     OUT  LDA                                       S01498
     C*
     C*****ACCESS*ICD*RECORD*1*TO*GET*RUN*DATE*&*TITLE***********         S01498
     C***********                                                         S01498
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 23               S01498
     C***********                                                         S01498
     C*****IF*RECORD*NOT*FOUND*OR*LAST-CHANGE-TYPE =*'D'*(DELETED)        S01498
     C***********                                                         S01498
     C************IN23     IFEQ '1'                                       S01498
     C***********BJTYLC    OREQ 'D'                                       S01498
     C***********          Z-ADD1         DBASE            ***************S01498
     C***********          MOVEL'SDBANKPD'DBFILE           * DBERROR 001 *S01498
     C***********          MOVE *BLANKS   DBKEY            *             *S01498
     C***********          EXSR #ZA                        ***************S01498
     C***********          ELSE                                           S01498
     C*                                                                   S01498
     C**  Access bank details                                             S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST'  P@OPTN                          S01498
     C           SDBANK    PARM SDBANK    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD1         DBASE            ***************S01498
     C                     MOVE 'SDBANKPD'DBFILE           *DB ERROR 001 *S01498
     C                     MOVEL'*FIRST'  DBKEY            ***************S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       S01498
     C                     ENDIF                                          S01498
     C*                                                                   S01498
     C**  Split date into day-month-year...                               S01498
     C*                                                                   S01498
     C                     MOVE BJMRDT    WWMRDT                          S01498
     C*
     C** EVENT CONTROL DATE = DATE OF NEXT WORKING DAY MINUS 1
     C*
     C           BJDNWD    SUB  1         BJDNWD
     C*                                                                   S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***ACCESS*PORTFOLIO*LENDING*ICD*TO*GET*PORTFOLIO*LENDING*CURRENCY   S01498
     C***********                                                         S01498
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 23               S01498
     C***********                                                         S01498
     C***IF*RECORD*NOT*FOUND*OR*RECORD-ID*=*'*'*THEN*DB*ERROR****         S01498
     C***********                                                         S01498
     C************IN23     IFEQ '1'                                       S01498
     C***********LBRECI    OREQ '*'                                       S01498
     C***********          Z-ADD2         DBASE            ***************S01498
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 002 *S01498
     C***********          MOVE *BLANKS   DBKEY            *             *S01498
     C***********          EXSR #ZA                        ***************S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***********                                                  B08040 S01498
     C***READ*THROUGH*SDCURRL0*SETTING*UP*ARRAY*OF*CURRENCIES****  B08040 S01498
     C***********          READ SDCURRL0                 72        B08040 S01498
     C***********          Z-ADD1         B       30               B08040 S01498
     C************IN72     DOWEQ'0'                                B08040 S01498
     C***SAVE*SPOT*RATE*ETC.*FOR*PORTFOLIO*LENDING*CURRENCY******         S01498
     C***********A6CYCD    IFEQ LBCCY                                     S01498
     C***********          Z-ADDA6SPRT    WWSRO                           S01498
     C***********          Z-ADDA6NBDP    WWDPO                           S01498
     C***********          MOVE A6MDIN    WWMDO                           S01498
     C***********          END                                            S01498
     C***********                                                         S01498
     C***********          MOVE A6CYCD    CYCD,B                   B08040 S01498
     C***********          Z-ADDA6SPRT    SPRT,B                   B08040 S01498
     C***********          MOVE A6MDIN    MDIN,B                   B08040 S01498
     C***********          Z-ADDA6NBDP    NBDP,B                   B08040 S01498
     C***********          ADD  1         B                        B08040 S01498
     C***********          READ SDCURRL0                 72        B08040 S01498
     C***********          END                                     B08040 S01498
     C*                                                                   S01498
     C**  Access Portfolio Lending ICD to get Portfolio Lending Ccy       S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM *BLANKS   P@RTCD                          S01498
     C                     PARM '*FIRST'  P@OPTN                          S01498
     C           SDLOMB    PARM SDLOMB    DSFDY                           S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD2         DBASE            ***************S01498
     C                     MOVE 'SDLOMBPD'DBFILE           *DB ERROR 002 *S01498
     C                     MOVEL'*FIRST'  DBKEY            ***************S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       S01498
     C                     ENDIF                                          S01498
     C*                                                                   S01498
     C**  Save Portfolio Lending Currency spot rate                       S01498
     C*                                                                   S01498
     C                     MOVE LBCYCD    P@CYCD                          S01498
     C                     CALL 'AOCURRR0'PLCURR                          S01498
     C*                                                                   S01498
     C           P@RTCD    IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            ***************S01498
     C                     MOVE 'SDCURRPD'DBFILE           *DB ERROR 004 *S01498
     C                     MOVELLBCYCD    DBKEY            ***************S01498
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       S01498
     C*                                                                   S01498
     C                     ELSE                                           S01498
     C                     Z-ADDA6SPRT    WWSRO                           S01498
     C                     Z-ADDA6NBDP    WWDPO                           S01498
     C                     MOVE A6MDIN    WWMDO                           S01498
     C                     ENDIF                                          S01498
      *                                                                                     MD057247
      ** Access Switchable Features file to determine if CSE031 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD  7                                         MD057247
     C                     PARM '*VERIFY' UOPTN   7                                         MD057247
     C                     PARM 'CSE031'  UUKEY   6                                         MD057247
     C                     PARM           UDSFDY 76                                         MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE031  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE031                                            MD057247
     C                     ENDIF                                                            MD057247
      *                                                                                     MD057247
      ** Access Switchable Features file to determine if CSE071 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD                                            MD057247
     C                     PARM '*VERIFY' UOPTN                                             MD057247
     C                     PARM 'CSE071'  UUKEY                                             MD057247
     C                     PARM           UDSFDY                                            MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE071  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE071                                            MD057247
     C                     ENDIF                                                            MD057247
     C*
     C*                                                                   B08040
     C** READ THROUGH LBINSTL0 SETTING UP ARRAY OF INSTRUMENT GROUPS      B08040
     C*                                                                   B08040
     C                     READ LBINSTL0                 72               B08040
     C***********          Z-ADD1         B                        B08040 S01498
     C                     Z-ADD1         B       30                      S01498
     C           *IN72     DOWEQ'0'                                       B08040
     C                     MOVE PDINNR    AINN,B                          B08040
     C                     MOVE PDCSHI    ACSH,B                          B08040
     C                     MOVE PDLOMG    AGRP,B                          B08040
     C                     Z-ADDGPLCGS    AGRS,B                          B08040
     C                     ADD  1         B                               B08040
     C                     READ LBINSTL0                 72               B08040
     C                     END                                            B08040
     C*
     C*                                                                   B08040
     C** READ THROUGH LBBPWRL3 SETTING UP ARRAY OF INSTRUMENT PERCENTS    B08040
     C*                                                                   B08040
     C                     READ LBBPWRL3                 72               B08040
     C                     Z-ADD1         B                               B08040
     C           *IN72     DOWEQ'0'                                       B08040
     C                     MOVE BPINST    AINS,B                          B08040
     C                     Z-ADDBPINPC    AINP,B                          B08040
     C                     ADD  1         B                               B08040
     C                     READ LBBPWRL3                 72               B08040
     C                     END                                            B08040
     C/COPY WNCPYSRC,LB0650C001
     C*                                                                   B08040
     C*
     C**   SET UP EDIT CODE FOR ZSEDIT
     C*
     C                     MOVE 'J'       ZECODE
     C*
     C**   DEFINE WORK FIELDS
     C*
     C           *LIKE     DEFN BBCUST    WWCUST
     C           *LIKE     DEFN EEPCNB    WWPCNB
     C           *LIKE     DEFN EEEXPS    WWEXPS
     C           *LIKE     DEFN EECOLL    WWCOLL
     C           *LIKE     DEFN EECTPC    WWCTPC
     C           *LIKE     DEFN EESEPC    WWBRPC
     C           *LIKE     DEFN EESESN    WWSESN
     C           *LIKE     DEFN CSNV      WWPOST
     C           *LIKE     DEFN NMCY      WWNMCY
     C*
     C** DEFINE WORKFIELDS FOR REPORT
     C*
     C           *LIKE     DEFN ISSP      WWPRIC
     C           *LIKE     DEFN CSNV      WWNAMT
     C           *LIKE     DEFN EECOLL    W0COLL
     C           *LIKE     DEFN EEEXPS    W0EXPS
     C           *LIKE     DEFN EEBPWR    W0BPWR
     C*
     C                     Z-ADD*ZEROS    WWPRIC
     C                     Z-ADD*ZEROS    W0COLL
     C                     Z-ADD*ZEROS    W0EXPS
     C                     Z-ADD*ZEROS    W0BPWR
     C*
     C**   INITIALISE COUNTER ACCUMULATION VARIABLES
     C*
     C                     Z-ADD*ZEROS    RRNRPD
     C                     Z-ADD*ZEROS    RRBKPD
     C                     Z-ADD*ZEROS    RRCPOS
     C                     Z-ADD*ZEROS    RRDPTM
     C                     Z-ADD*ZEROS    RRTRAD
     C                     Z-ADD*ZEROS    RRNOWR                          R01168
     C*
     C**   INITIALISE LINE COUNT
     C*
     C                     Z-ADD*ZEROS    LINE1
     C*
     C** INITIALISE FILE IDENTIFIERS & DETAILS OUTPUT FLAG
     C*
     C                     MOVE 'N'       WWDOR0  1
     C                     MOVEA'0000'    *IN,50           OFF 50-53
     C*
     C*****WRITE*HEADER*ON*LB0650P0******************************         S01498
     C***********                                                         S01498
     C***********          WRITEHEADER0                                   S01498
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #YA       - THIS SUBROUTINE OUTPUTS THE SECURITIES         *
     C**               TRADING REGENERATION DETAILS REPORT            *
     C**                                                              *
     C**   CALLS     - P01                                            *   R01168
     C**                                                              *
     C**   CALLED BY - #B                                             *
     C**                                                              *
     C*****************************************************************
     C           #YA       BEGSR
     C*                                                                   S01498
     C**  Open Spool file if not end of file                              S01498
     C*                                                                   S01498
     C           *IN29     IFEQ '0'                                       S01498
     C           WLOPN     ANDNE'Y'                                       S01498
     C                     OPEN LB0650P1                                  S01498
     C                     MOVE 'Y'       WLOPN   1                       S01498
     C                     WRITEHEADER0                                   S01498
     C                     ENDIF                                          S01498
     C*
     C***********LINE2     IFGT 55                                        S01498
     C           LINE1     IFGT 55                                        S01498
     C                     WRITEHEADER0
     C                     END
     C*
     C                     MOVE WWCNUM    R0CNUM
     C                     MOVE WWSESN    R0SESN
     C*
     C                     Z-ADDWWNAMT    ZFLD15
     C                     Z-ADDWWDPI     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0NAMT
     C*
     C                     Z-ADDWWPRIC    R0PRIC
     C                     MOVE WWNMCY    R0CCY
     C                     Z-ADDWWSRI     R0RATE
     C*
     C                     Z-ADDW0EXPS    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0EXPS
     C*
     C                     Z-ADDW0COLL    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0COLL
     C*
     C                     MOVE EEINST    R0INST
     C           WWBPER    MULT 100       WWBRPC                          080861
     C                     Z-ADDWWBRPC    R0PERC
     C*
     C                     Z-ADDW0BPWR    ZFLD15
     C                     Z-ADDWWDPO     ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    R0BPWR
     C*
     C                     WRITEDETAIL0
     C*                                                                   R01168
     C** WRITE RECORDS TO EXTRACT FILE PF/LBEXCOPD                        R01168
     C*                                                                   R01168
     C                     EXSR P01                                       R01168
     C*
     C** RESET WORKFIELDS
     C*
     C                     Z-ADD*ZEROS    WWPRIC
     C                     Z-ADD*ZEROS    W0COLL
     C                     Z-ADD*ZEROS    W0EXPS
     C                     Z-ADD*ZEROS    W0BPWR
     C                     MOVE 'Y'       WWDOR0
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**   P01       - WRITE RECORD TO EXPOSURE/COLLATERAL FILE       *   R01168
     C**                                                              *   R01168
     C**   CALLS     - #ZA                                            *   R01168
     C**                                                              *   R01168
     C**   CALLED BY - #YA                                            *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           P01       BEGSR                                          R01168
     C*                                                                   R01168
     C*                                                                   R01168
     C** IF WORK FIELD W0COLL IS NOT ZERO                                 R01168
     C*                                                                   R01168
     C           W0COLL    IFNE 0                                         R01168
     C                     MOVE 'C'       EXEXCO                          R01168
     C                     Z-ADDW0COLL    EXAMNT                          R01168
     C*                                                                   R01168
     C                     ELSE                                           R01168
     C*                                                                   R01168
     C                     MOVE 'E'       EXEXCO                          R01168
     C                     Z-ADDW0EXPS    EXAMNT                          R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C**   FORMAT REMAINING FIELDS FOR RECORD                             R01168
     C*                                                                   R01168
     C                     MOVE 'D'       EXRECI                          R01168
     C                     Z-ADDWWDAY     EXDLUP                          R01168
     C                     MOVE WWMNTH    EXMLUP                          R01168
     C                     Z-ADDWWYEAR    EXYLUP                          R01168
     C                     TIME           EXTLUP                          R01168
     C                     Z-ADDBJRDNB    EXORED                          R01168
     C**********           Z-ADDWWCNUM    EXCNUM                          R01168              CSD027
     C                     MOVE WWCNUM    EXCNUM                          R01168              CSD027
     C                     MOVE BBPCNB    EXPCNB                          R01168
     C                     MOVE '50'      EXREGE                          R01168
     C                     MOVE EEINST    EXINST                          R01168
     C                     MOVE WWNMCY    EXCCY                           R01168
     C                     MOVELWWSESN    EXREF                           R01168
     C                     MOVE EELCGR    EXLCGR                          B08040
     C                     Z-ADDEELCGS    EXLCGS                          B08040
     C                     MOVE '0'       EXDDAT                          R01168
     C                     MOVE '0'       EXVDAT                          R01168
     C                     MOVE '0'       EXMDAT                          R01168
     C                     MOVE '0'       EXRLDT                          R01168
     C*                                                                   38835
     C                     Z-ADDWWNAMT    ZFLD15                          38835
     C                     Z-ADDWWDPI     ZDECS                           38835
     C                     EXSR ZSEDIT                                    38835
     C                     MOVE ZOUT21    EXADAM                          38835
     C*                                                                   R01168
     C** WRITE RECORD TO PF/LBEXCOPD                                      R01168
     C*                                                                   R01168
     C                     WRITELBEXCOPF                                  R01168
     C*                                                                   R01168
     C** ADD 1 TO COUNTER OF RECORDS WRITTEN TO PF/LBEXCOPD               R01168
     C*                                                                   R01168
     C                     ADD  1         RRNOWR                          R01168
     C                     ENDSR                                          R01168
     C*                                                                   R01168
     C*****************************************************************   R01168
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**  SCONV - Converts an amount from one currency to another.       *
     C**                                                                 *
     C**  Input Fields - WWAMTI 15/0 amount in input currency            *
     C**                 WWSRI  13/8 spot rate for input currency        *
     C**                 WWSRO  13/8 spot rate for output currency       *
     C**                 WWDPI  1/0  no. of decimals for input currency  *
     C**                 WWDPO  1/0  no. of decimals for output currency *
     C**                 WWMDI  1    mult/div indicator for input curr.  *
     C**                 WWMDO  1    mult/div indicator for output curr. *
     C**                                                                 *
     C**  Arrays       - POWER  powers of 10                             *
     C**                                                                 *
     C**  Output Fields- WWAMTO 15/0 output amount converted to new curr *
     C**                                                                 *
     C**  CALLS    - NONE                                                *
     C**                                                                 *
     C********************************************************************
     C           SCONV     BEGSR                           **  SCONV    **
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDWWAMTI    WWAMTI 150
     C                     Z-ADD0         WWAMTO 150
     C           *LIKE     DEFN A6SPRT    WWSRI
     C           *LIKE     DEFN A6SPRT    WWSRO
     C           *LIKE     DEFN A6NBDP    WWDPI
     C           *LIKE     DEFN A6NBDP    WWDPO
     C           *LIKE     DEFN A6MDIN    WWMDI
     C           *LIKE     DEFN A6MDIN    WWMDO
     C*
     C           WWDPO     SUB  WWDPI     Z       10
     C           Z         ADD  4         Z
     C*
     C           WWMDI     IFNE WWMDO
     C*
     C** MULT/DIV INDICATORS DIFFERENT
     C           WWSRI     MULT WWSRO     WWRATE 159H
     C                     ELSE
     C*
     C** MULT/DIV INDICATORS THE SAME
     C           WWSRO     IFEQ 0
     C                     GOTO SC0
     C                     END
     C           WWSRI     DIV  WWSRO     WWRATE    H
     C                     END
     C*
     C           WWMDI     IFEQ 'D'
     C           WWRATE    IFEQ 0
     C                     GOTO SC0
     C                     END
     C           POWER,Z   DIV  WWRATE    WWRATE    H
     C                     ELSE
     C           POWER,Z   MULT WWRATE    WWRATE    H
     C                     END
     C*
     C           WWAMTI    MULT WWRATE    WWAMTO    H
     C*
     C           SC0       ENDSR                           **  SC0      **
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C/COPY ZSRSRC,ZSEDITZ3
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZA       - PROCESS DATABASE ERRORS                        *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #A                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZA       BEGSR
     C*
     C                     WRITEHDRCTRL1
     C                     WRITEDBERROR1
     C*                                                                   S01498
     C**  Report the database error in LB0650P1 if open                   S01498
     C*                                                                   S01498
     C           WLOPN     IFEQ 'Y'                                       S01498
     C                     WRITEDBERROR                                   S01498
     C                     CLOSELB0650P1                                  S01498
     C                     MOVE *BLANK    WLOPN                           S01498
     C                     END                                            S01498
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     EXSR *PSSR                                     S01498
     C                     RETRN
     C*
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   *PSSR     - PROGRAM ERROR HANDLING ROUTINE                 *
     C**                                                              *
     C**   CALLS     -                                                *
     C**                                                              *
     C**   CALLED BY -                                                *
     C**                                                              *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C                     ENDSR
     C*****************************************************************
     C/COPY ZSRSRC,ZPRCIZ1                                                B08206
     C/COPY ZSRSRC,ZDATE1Z2                                               B08206
     C/COPY ZSRSRC,ZDATE2Z2                                               B08206
     C/COPY ZSRSRC,ZDAYSZ2                                                B08206
     C/COPY ZSRSRC,ZDYYRZ3                                                B08206
     C/COPY ZSRSRC,ZNCDZ3                                                 B08206
     C/COPY ZSRSRC,ZLCDZ1                                                            B08206 MD057247
     C/COPY ZSRSRC,ZYLDIZ1                                                B08206
     C/COPY ZSRSRC,ZYLDZ2                                                 B08206
     C/COPY ZSRSRC,ZACCZZ1                                                S01498
     C/COPY ZSRSRC,ZACCRZ1                                                S01498
     C/COPY ZSRSRC,ZCNSDZ1                                                S01498
     C/COPY ZSRSRC,ZRATEZ1                                                S01498
     C/COPY ZSRSRC,ZCALCD                                                 S01498
     C/EJECT
**  Cpy@
(c) Finastra International Limited 2001
**  Array of powers of 10 for currency conversion S/R SCONV
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  Array of powers of ten used for Collateral/Exposure Calc.
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
