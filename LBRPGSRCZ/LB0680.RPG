     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LB Pledges regeneration')                        *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Lending Module                             *
     F*                                                               *
     F*  LB0680 - Pledges Regeneration                                *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. CLE134             Date 01Aug12               *
      *  Prev Amend No. CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027A            Date 17May06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 094908             Date 08May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 087628             Date 01Sep95               *
      *                 080768             Date 04Jan95               *
     F*                 S01498             DATE 11AUG94               *
     F*                 066036             DATE 20JUL93               *
     F*                 057730             DATE 05JUL93               *
     F*                 055763             DATE 26MAY93               *
     F*                 033955             DATE 07JAN91               *
     F*                 37532              DATE 23MAR92               *
     F*                 049421             DATE 12JUL93               *
     F*                 040592             DATE 03JUN92               *
     F*                 B10575             DATE 25OCT91               *
     F*                 B10574             DATE 22OCT91               *
     F*                 B08218             DATE 16OCT91               *
     F*                 B8175              DATE 16OCT91               *
     F*                 B9661              DATE 26SEP91               *
     F*                 001313             DATE 26SEP91               *
     F*                 B8002              DATE 24JUN91               *
     F*                 B7995              DATE 21JUN91               *
     F*                 B7970              DATE 13JUN91               *
     F*                 B7904              DATE 03JUN91               *
     F*                 B7874              DATE 29MAY91               *
     F*                 B7845              DATE 25MAY91               *
     F*                 B7837              DATE 23MAY91               *
     F*                 B7812              DATE 21MAY91               *
     F*                 B5751              DATE 21MAR91               *
     F*                 R5593              DATE 05MAR91               *
     F*                 R01168             DATE 21JAN91               *
     F*                 R0986              DATE 28NOV90               *
     F*                 R00308             DATE 15AUG90               *
     F*                 LB0006             DATE 25JUN90               *
     F*                 LB0003             DATE 20JUN90               *
     F*                 PD0055             DATE 31MAY90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CLE134 - Past Due Call Loan Processing (Recompile)           *
      *  CLE148 - Alpha Loan Reference                                *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027A- Conversion of cust. no. to alpha (post 103 build)   *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  094908 - Wrong positioning on commitment lines file.         *
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
     F*  087628 - Add branches to accounts                            *
     F*  080768  -  Private banking testing                           *
     F*  S01498  -  Portfolio Lending Upgrade to Release 10.          *
     F*  066036  -  FIXED PLEDGES STILL NOT ALWAYS OUTPUT CORRECTLY.  *
     F*             GENERAL PLEDGES NOT TAKEN INTO ACCOUNT.           *
     F*             PEAPPLY FIXES 52280 AND 55881.                    *
     F*  057730  -  FIXED PLEDGES NOT OUTPUT CORRECTLY.               *
     F*             STORED SEQUENCE NUMBERS RESET IN INCORRECT PLACE. *
     F*             ALLOW FIXED PLEDGES TO BE SPLIT - REMOVE B10575.  *
     F*  055763  -  PLEDGES MAY HAVE SAME CUSTOMER AND SAME ISSUER;   *
     F*             IN THIS CASE JUST ONE IS REGENERATED              *
     F*  033955  -  NO MODIFICATION IN THIS SOURCE                    *
     F*             ONLY PLEDGE RECORD MUST BE PROCESSED IN THIS PGM  *
     F*             IN LBC0680 OVRDBF FILE LBPLEGL9 WITH LBPLEGL0 W/C *
     F*             SELECT ONLY PLEDGE RECORDS                        *
     F*  37532   -  LIMITED PLEDGES ARE INCORRECTLY REPORTED IN       *
     F*             LOMBARD ENQUIRY IF THE PLEDGE CURRENCY IS NOT THE *
     F*             SAME AS THE LOMBARD CURRENCY                      *
     F*  049421  -  HEADER BOX STANDARDISATION                        *
     F*  040592  -  IF THE LOAN IS MATURED RESET PGUTSL TO 0.         *
     F*  B10575  -  DUPLICATE RECORDS FOUND IN EXTRACT FILE           *
     F*             PF/LBEXTRPD                                       *
     F*  B10574  -  SET PLEDGE AMOUNT TO ZERO WHEN UNALLOWED GEN      *
     F*             PLEDGE                                            *
     F*  B08218  -  USE CLOAN INSTEAD OF CLOANCL1                     *
     F*  B8175   -  LIMITED PLEDGES SHOWN IN INCORRECT CURRENCY       *
     F*  B9661   -  PARENT OF CUSTOMER FROM PLEDGES INPUT (LB0220)    *
     F*             MAY BE BLANK ---> REMOVE DBTE 05.                 *
     F*  001313  -  MATURED COMMITMENT LINE NOT TO BE USED            *
     F*  XXXXX   -  MANY UNMARKED CHANGES, MAINLY FOR FIXED/LIMITED   *
     F*             PLEDGE SOURCE MUST BE CLEANED LATER               *
     F*  B8002   -  SYSTEM CALCULATES NEGATIVE PLEDGES                *
     F*  B7995   -  FIXED PLEDGES MUST STAY IN ORIGINAL CURRENCY ON   *
     F*             LBPLEGPD, BUT UPDATE OTHER FILES IN PORTFOLIO CCY.*
     F*             SAME APPLIES FOR LIMITED PLEDGES.                 *
     F*             EXPLANATION :                                     *
     F*             FIXED - CUSTOMER PLEDGES A FIXED AMOUNT IN A SET  *
     F*                     CCY THE AMOUNT IS CONSTANT AND DOES NOT   *
     F*                     DEPEND ON COMMITMENT LINE / LENDING POWER *
     F*                     OF THE GIVER OF THE BORROWING REQUIREMENTS*
     F*                     OF THE RECEIVER.                          *
     F*             GENER.- CUSTOMER PLEDGES ALL HIS AVAILABLE ASSETS *
     F*                     TO ANOTHER CUSTOMER. THE PLEDGED AMOUNT   *
     F*                     HAS TO BE RECLACULATED EACH DAY ACCORDING *
     F*                     TO THE GIVER'S LENDING POWER AND THE      *
     F*                     RECEIVER'S BORROWING REQUIREMENTS. ALL    *
     F*                     CALCULATIONS ARE DONE IN PORTFOLIO CCY.   *
     F*             LIMIT - SAME AS GENERAL, EXCEPT THAT A MAXIMUM    *
     F*                     PLEDGE AMOUNT IN A CCY IS DEFINED.        *
     F*                                                               *
     F*  B7970  -  NO PLEDGES SHOULD BE CALCULATED IF NO COMM.LINE    *
     F*            EXISTS                                             *
     F*  B7904  -  FIXED PLEDGES INCORRECT                            *
     F*  B7874  -  AMOUNTS CALCULATION INCORRECT                      *
     F*  B7845  -  REPORT LAYOUT AMENDMENTS                           *
     F*  B7837  -  FIELDS ALWAYS SERVED FRO THE 3 PLEDGE TYPES        *
     F*  B7812  -  AMOUNTS INCORRECTLY SETUP                          *
     F*  B5721  -  WORK FIELDS DEFINED WITHOUT DECIMAL POSITIONS      *
     F*  R5593  -  AMOUNTS USED AND EFFECTIVE NOT CALCULATED          *
     F*  R01168 -  WRTE A RECORD TO EXTRACT FILE LBEXCOPD             *
     F*  R0986  - PARENT PROCESSING FOR PLEDGES.                      *
     F*  IF A PLEDGE IS WITHIN A FAMILY (IE THE CUSTOMER AND ISSUER   *
     F*  HAVE THE SAME PARENT), DO NOT OUTPUT THE PARENT NUMBER ONTO  *
     F*  LBEXTRPD. THIS MEANS THAT THE PLEDGE WILL NOT BE PICKED UP   *
     F*  WHEN CALCULATING THE PARENT'S POSITION.                      *
     F*  THIS ALSO MEANS THAT THERE MUST BE SEPARATE PLEDGE RECORDS   *
     F*  ON LBEXTRPD FOR PLEDGES IN AND NOT IN THE FAMILY. FOR THIS   *
     F*  REASON AN NEW LOGICAL IS CREATED                             *
     F*                                                               *
     F*  R00308 - OUTPUT NO DETAILS LINE ON LB0680 IF NO RECORDS      *
     F*          SELECTED                                             *
     F*  LB0006 - PLEDGE %                                            *
     F*  LB0003 - UPDATE TOTAL OF PLEDGES RECEIVED                    *
     F*  PD0055 - ADD LAST 2 ELEMENTS OF POWER ARRAY                  *
     F*                                                               *
     F*****************************************************************
     F** C R E A T I O N     P A R A M E T E R S                      *
     F**                                                              *
     F**                                                              *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F**
     F**      FILE DEFINITIONS
     F**     ------------------
     F*
     F**   Bank Details                    - Prefix BJ
     F***SDBANKPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F**   portfolio lending I.C.D            - Prefix LB
     F***SDLOMBPDIF**E                    DISK         KINFSR *PSSR       S01498
     F*
     F**   Instrument types file           - Prefix PD
     F***SDPLINL4IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   Groups file                     - Prefix GR
     F***LBGROUL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   portfolio lending Currency         - Prefix A6
     F***SDCURRL1IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   Pledges Details                 - Prefix PG
     FLBPLEGL9UF  E           K        DISK
     F            LBPLEGD0                          KRENAMELBPLEGD9
     F                                              KINFSR *PSSR
     F**   Pledges Details                 - Prefix PG                    LB0003
     FLBPLEGL4UF  E           K        DISK                               LB0003
     F            LBPLEGD0                          KRENAMELBPLEGD4       LB0003
     F                                              KINFSR *PSSR          LB0003
     F*
     F**   Loan Master Details             - No Prefix
     F*L0ANCL1IF**E***        K        DISK         KINFSR *PSSR          B08218
     FCLOAN   IF  E           K        DISK         KINFSR *PSSR          B08218
     F            CLOANHHF                          KIGNORE               B08218
     F            CLOANCKF                          KIGNORE               B08218
     F            CLOANZ1F                          KIGNORE               B08218
     F*
     F**   Clients Details                 - Prefix BB
     F***SDCUSTL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   Clients Details                 - Prefix BB & CU
     F***SDLBCSL0IF**E           K        DISK         KINFSR *PSSR       S01498
     F*
     F**   Facility Details File           - No Prefix
     F***FCLYFML2IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBFCLTL2IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   Accounts Master file            - No Prefix
     F***ACCNABL1IF**E           K        DISK         KINFSR *PSSR       S01498
     FLBACCNL1IF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   Commitment Line Authorisation   - Prefix CA
     FLBCOMAL2IF  E           K        DISK         KINFSR *PSSR
     F*
     F**   portfolio lending Extract Summary File     - Prefix ES
     FLBEXTSL1UF  E           K        DISK
     F            LBEXTSD0                          KRENAMELBEXTSD1
     F                                              KINFSR *PSSR
     F*
     F**   portfolio lending Extract Detail File     - Prefix EE
     F*BEXTRL2UF  E           K        DISK                      A        R0986
     FLBEXTRLCUF  E           K        DISK                      A        R0986
     F                                              KINFSR *PSSR
     F*                                                                   R01168
     F**   PORTFOLIO EXPOSURE/COLLATERAL EXTRACT FILE. PREFIX - EX        R01168
     FLBEXCOPDO   E                    DISK         KINFSR *PSSR          R01168
     F*
     F**   Portfolio Totals                - Prefix QC
     F***PMPOTTPPIF**E           K        DISK         KINFSR *PSSR       S01498
     FPMPOTTPDIF  E           K        DISK         KINFSR *PSSR          S01498
     F*
     F**   portfolio lending Extract File     - Prefix ES
     FLBEXTSPDO   E           K        DISK         KINFSR *PSSR A
     F*
     F**   Run Controls Report
     FLB0680AUO   E             21     PRINTER      KINFDS ERF1DS
     F                                              KINFSR *PSSR
     F*
     F**   Unallowed Pledges Report
     F***LB0680P1O***E             22     PRINTER      KINFDS ERF2DS      S01498
     FLB0680P2O   E             22     PRINTER      KINFDS ERF2DS     UC  S01498
     F                                              KINFSR *PSSR
     F*
     F**   Print Details
     F***LB0680P0O***E                    PRINTER      KINFDS ERF3DS      S01498
     FLB0680P1O   E                    PRINTER      KINFDS ERF3DS     UC  S01498
     F                                              KINFSR *PSSR
     F*
     I*****************************************************************
     F/EJECT
     F*****************************************************************
     F**                                                              *
     F** ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F**                 ------------------------                     *
     F**                                                              *
     F**       21      - Overflow indicator on LB0680AU               *
     F*********22******- Overflow indicator on LB0680P1               *   S01498
     F**       22      - Overflow indicator on LB0680P2               *   S01498
     F**                                                              *
     F**       20      - File Error                                   *
     F*********23******- File Error                                   *   S01498
     F**       24      - CHAIN on CLOANCL1                            *
     F**       25      - CHAIN on LBEXTSL1                            *
     F**       26      - CHAIN on LBCOMAL2                            *
     F*********27******- CHAIN on PMPOTTPP                            *   S01498
     F**       27      - CHAIN on PMPOTTPD                            *   S01498
     F*********28******- CHAIN on FCLYFML2                            *   S01498
     F**       28      - CHAIN on LBFCLTL2                            *   S01498
     F**       29      - End of file on Read LBPLEGL9                 *
     F**       30      - Record not selected for processing           *
     F**       31      - Print Heading Once                           *
     F**       35      - End of file on Read LBPLEGL4                 *   LB0003
     F**       40      - SDLBCSL0 accessed for current extract key    *
     F*********41******- CHAIN on SDLBCSL0                            *   S01498
     F*********42******- CHAIN on SDCUSTL0                            *   S01498
     F**       43      - Pledges allowed for the customer             *
     F**       44      - CHAIN on LBEXTRL2                            *
     F*********45******- CHAIN on SDPLINL4                            *   S01498
     F*********46******- CHAIN on LBGROUL1                            *   S01498
     F**       46      - MULTIBRANCHING INDICATOR                     *   S01498
     F**       47      - CHAIN on SDLBCSL0                            *
     F*********48******- CHAIN on ACCNABL1                            *   S01498
     F**       48      - CHAIN on LBACCNL1                            *   S01498
     F*********50******- RECORD WRITTEN ON LB0680P0                 R00308S01498
     F**       50      - RECORD WRITTEN ON LB0680P1                   *   S01498
     F**       69      - End of file                                  *
     F**                                                              *
     F*****************************************************************
     I/EJECT
     E********************************************************************
     E*
     E**   ARRAY FOR COPYRIGHT
     E*
     E                    CPY@    1   1 80
     E*
     E** SCONV S/R ARRAY FOR POWERS OF 10
     E*
     E                    POWER   1   7  7 3
     E*
     E********************************************************************
     E/EJECT
     I*****************************************************************
     I/EJECT
     I*
     I**   DATA STRUCTURE FOR COMPILATION - COPYRIGHT INSERTION
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*
     I**   PROGRAM STATUS DATA STRUCTURE
     IPSDS       SDS
     I                                      244 253 JOB
     I                                      254 263 USER
     I*
     I**   DATA STRUCTURE TO SPLIT USED TO SECURE FACILITY (5A)
     IWWDS        DS
     I                                        1   5 WWUTSF
     I                                        1   30WWFACT
     I                                        4   50WWFCNO
     I*
     I*****DATA*STRUCTURE*TO*REARRANGE*KEY*FOR*ACCNABL1****************   S01498
     I**   DATA STRUCTURE TO REARRANGE KEY FOR LBACCNL1                   S01498
     IKEYDS       DS
     I**********                              1  15 PGEREF                                    CGL029
     I                                        1  21 PGEREF                                    CGL029
     I**********                              1   60WWACNT                                    CSD027
     I                                        1   6 WWACNT                                    CSD027
     I                                        7   9 WWACCY
     I**********                             10  130WWACDE                                    CGL029
     I**********                             14  150WWASEQ                                    CGL029
     I                                       10  190WWACDE                                    CGL029
     I                                       20  210WWASEQ                                    CGL029
     I*
     I**   DATA STRUCTURE TO SPLIT DATE INTO DAY, MONTH, YEAR FORMAT
     IWWDMY       DS
     I                                        1   7 WWDATE
     I                                        1   20ESDLUP
     I                                        3   5 ESMLUP
     I                                        6   70ESYLUP
     I                                        1   20EEDLUP
     I                                        3   5 EEMLUP
     I                                        6   70EEYLUP
     I*                                                                   R01168
     I**   DATA STRUCTURE TO SET UP EXREF FIELD ON NEW EXTRACT FILE       R01168
     I            DS                                                      R01168
     I**********                              1  16 WWXREF                             R01168 CGL029
     I                                        1  22 WWXREF                                    CGL029
     I**********                              1   60WWISCN                             R01168 CSD027
     I                                        1   6 WWISCN                                    CSD027
     I                                        7   7 PGTYPE                R01168
     I                                        8  100PGBPSN                R01168
     I                                       11  130PGSEQN                R01168
     I                                       14  16 PGCODE                R01168
     I*                                                                   R01168
     I**   DATA STRUCTURE TO SET UP DATE FOR NEW EXTRACT FILE             R01168
     I            DS                                                      R01168
     I****************************************1   7 BJMRDT          R01168S01498
     I                                        1   7 EXDATE                S01498
     I                                        1   20WWDAY                 R01168
     I                                        3   5 WWMNTH                R01168
     I                                        6   70WWYEAR                R01168
     I**   DATA STRUCTURE TO SET UP ACCOUNT NUMBER                        080768
     I            DS                                                      080768
     I**********                              1  18 WWACCN                             080768 CGL029
     I                                        1  24 WWACCN                                    CGL029
     I                                        1   6 WWCNUT                080768
     I***********                             8  10 WWCCYT          080768087628
     I***********                            12  15 WWACOT          080768087628
     I***********                            17  18 WWSEQT          080768087628
     I                                        7   9 WWCCYT                087628
     I**********                             10  13 WWACOT                             087628 CGL029
     I**********                             14  15 WWSEQT                             087628 CGL029
     I**********                             16  18 WWBCHT                             087628 CGL029
     I                                       10  19 WWACOT                                    CGL029
     I                                       20  21 WWSEQT                                    CGL029
     I                                       22  24 WWBCHT                                    CGL029
     I*
     I**   FILE INFORMATION DATA STRUCTURE
     IERF1DS      DS
     I**
     I**   FOR OVERFLOW - RUN CONTROL
     I                                       83  92 SFILEU                S01498
     I                                    B 123 1240SFNUMU                S01498
     I                                    B 367 3680LINE
     I*
     IERF2DS      DS
     I**   FOR OVERFLOW - PRINT
     I                                       83  92 SFILE2                S01498
     I                                    B 123 1240SFNUM2                S01498
     I                                    B 367 3680LINE1
     I*
     IERF3DS      DS
     I**   FOR OVERFLOW - PRINT
     I                                       83  92 SFILE1                S01498
     I                                    B 123 1240SFNUM1                S01498
     I                                    B 367 3680LINE0
     I*
     I**  LOCAL DATA AREA FOR DATA BASE ERRORS
     I***LDA********UDS                            256                    S01498
     ILDA         DS                            256                       S01498
     I                                      132 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*                                                                   S01498
     IRUNDAT    E DS                                                      S01498
     I** Standard data area layout for system flags and run date          S01498
     I*                                                                   S01498
     ISDBANK    E DSSDBANKPD                                              S01498
     I** Dummy record format for access to Bank Details                   S01498
     I*                                                                   S01498
     ISDCURR    E DSSDCURRPD                                              S01498
     I** Dummy record format for access to Currency Details               S01498
     I*                                                                   S01498
     ISDLOMB    E DSSDLOMBPD                                              S01498
     I** Dummy record format for access to Portfolio Lending ICD          S01498
     I*                                                                   S01498
     ISDPLIN    E DSSDPLINPD                                              S01498
     I** Dummy record format for access to Instrument Types               S01498
     I*                                                                   S01498
     ILBGROU    E DSLBGROUPD                                              S01498
     I** Dummy record format for access to Portfolio Lending Groups       S01498
     I*                                                                   S01498
     ISDCUST    E DSSDCUSTPD                                              S01498
     I** Dummy record format for access to Customer Details               S01498
     I*                                                                   S01498
     ISDLBCS    E DSSDLBCSPD                                              S01498
     I** Dummy record format for access to Customer Details               S01498
     I*                                                                   S01498
     IDSFDY     E DSDSFDY                                                 S01498
     I** First DS for access programs, short data structure               S01498
     I*                                                                   S01498
     IDSSDY     E DSDSSDY                                                 S01498
     I** Second DS for access programs, long data structure               S01498
     I*                                                                   S01498
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*
     C** DEFINE KLISTS
     C*  =============
     C*
     C***KLIST*FOR*THE*PORTFOLIO*DETAILS*FILE*-*PMPOTTPP***************   S01498
     C** KLIST FOR THE PORTFOLIO DETAILS FILE - PMPOTTPD                  S01498
     C*
     C           KL1       KLIST
     C                     KFLD           PGISSB
     C                     KFLD           PGPORP
     C*
     C***KLIST*FOR*FACILITY*DETAILS*FILE*-*FCLYFML2********************   S01498
     C** KLIST FOR FACILITY DETAILS FILE - LBFCLTL2                       S01498
     C*
     C           KL3       KLIST
     C                     KFLD           PGCNUM
     C                     KFLD           WWFACT
     C                     KFLD           WWFCNO
     C*
     C***KLIST*FOR*PORTFOLIO*DETAILS*FILE*-*PMPOTTPP*******************   S01498
     C** KLIST FOR PORTFOLIO DETAILS FILE - PMPOTTPD                      S01498
     C*
     C           KL4       KLIST
     C                     KFLD           PGCNUM
     C                     KFLD           PGUTSP
     C*
     C** KLIST FOR LBCOMAL2  (ISSUER)
     C*
     C           KL5       KLIST
     C                     KFLD           PGISSB
     C                     KFLD           BJRDNB
     C*
     C** KLIST FOR LBCOMAL2  (CUSTOMER)
     C*
     C           KL6       KLIST
     C                     KFLD           WWCNUM
     C                     KFLD           BJRDNB
     C*
     C** KLIST FOR LBEXTRL2
     C*
     C           KL7       KLIST
     C                     KFLD           WWPNP8
     C                     KFLD           KCUST   6                      R0986
     C***                  KFLD           WWINST                          B10575
     C                     KFLD           LBPLEG                          B10575
     C                     KFLD           WWCCY
     C*
     C***KLIST*FOR*ACCNABL1********************************************   S01498
     C** KLIST FOR LBACCNL1                                               S01498
     C*
     C           KL8       KLIST
     C                     KFLD           WWACNT
     C                     KFLD           WWACDE
     C                     KFLD           WWASEQ
     C                     KFLD           WWACCY
     C                     KFLD           PGEBCH                          087628
     C*                                                                   R5593
     C** KLIST FOR LBPLEGL9                                               R5593
     C*                                                                   R5593
     C           KL9       KLIST                                          R5593
     C                     KFLD           WWCNUM                          R5593
     C                     KFLD           WWBPSN                          R5593
     C                     KFLD           WWSEQN                          R5593
     C*                                                                   R5593
     C** KLIST FOR LBPLEGL9                                               R5593
     C*                                                                   R5593
     C           KL10      KLIST                                          R5593
     C                     KFLD           WWCNUM                          R5593
     C                     KFLD           WWBPSR                          R5593
     C                     KFLD           WWSEQR                          R5593
     C*                                                                   B08218
     C** KLIST FOR CLOAN                                                  B08218
     C*                                                                   B08218
     C           KL11      KLIST                                          B08218
     C                     KFLD           PGUTSL                          B08218
     C                     KFLD           WWRECT  1                       B08218
     C*                                                                   055763
     C           KL12      KLIST                                          055763
     C                     KFLD           WWTEMP                          055763
     C                     KFLD           WWBPTE                          055763
     C                     KFLD           WWSETE                          055763
     C*
     C*****************************************************************
     C*
     C**              START MAINLINE
     C**             ----------------
     C*
     C**   INITIAL PROCESSING
     C*
     C                     EXSR #A
     C*
     C**   MAIN PROCESSING
     C*
     C                     EXSR #B
     C*
     C**   TERMINATION PROCESSING
     C*
     C                     EXSR #C
     C*
     C**   END PROGRAM
     C*
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**    INDEX TO SUBROUTINES                                      *
     C**   ----------------------                                     *
     C**                                                              *
     C**                                                              *
     C**   #B      - Main processing                                  *
     C**                                                              *
     C**   #BA     - Calculate the issuer available lending           *
     C**   #BB     - Print Line on the UNALLOWED PLEDGES REPORT       *
     C**   #BD     - Determines the amount which is pledged           *
     C**   #BE     - Checks if the pledge is allowed                  *
     C**   #BF     - Calculates the exposure needs of the customer    *
     C**                                                              *
     C**   #BG     - Splits pledges proportionally                    *
     C**   #BGA    - Update Portfolio Extract Summary File (Issuer)   *
     C**   #BGB    - Update Portfolio Extract Summary File (Customer) *
     C**   #BGC    - Update Portfolio Extract Detail File             *
     C**   #BGD    - PERFORMS CALCULATIONS TO WRITE RECORD TO NEW     *   R01168
     C**             EXTRACT FILE LBEXCOPD                            *   R01168
     C**   #BGDA   - WRITES RECORD TO NEW EXTRACT FILE LBEXCOPD       *   R01168
     C**   #BH     - Update Total of Pledges received                 *   LB0003
     C**                                                              *
     C**   #C      - Termination process                              *
     C**   #A      - Performs initial processing                      *
     C**   SCONV   - Converts an amount from one currency to another  *
     C**                                                              *
     C**   #ZA     - Process Database Errors                          *
     C**                                                              *
     C**   *PSSR   - Program error handling routine                   *
     C**                                                              *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #B        - MAIN PROCESSING                                *
     C**                                                              *
     C**   CALLS     - #BA, #BC, #BD, #BE, #BF, #BG, #BH              *   LB0003
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #B        BEGSR
     C*
     C** READ PLEDGES DETAIL FILE
     C*
     C           *LOVAL    SETLLLBPLEGL9
     C                     READ LBPLEGL9                 29
     C*                                                                   066036
     C                     Z-ADDPGBPSN    WWBPSR  30                      066036
     C                     Z-ADDPGSEQN    WWSEQR  30                      066036
     C*
     C** LOOP WHILE NOT END OF FILE
     C*
B1   C           *IN29     DOWEQ'0'
     C*                                                                   R5593
     C                     Z-ADD*ZEROS    WWAMTT                          R5593
     C*
     C                     SETOF                     40
     C*
     C** INITIALISE COUNT FOR NUMBER OF RECORDS SELECTED WITHIN KEY
     C*
     C                     Z-ADD*ZEROS    WWSLCT
     C*
     C** SETUP DEFAULT PORTFOLIO EXTRACT KEY - CUST. NO.
     C*
     C                     MOVE PGCNUM    WWCNUM
     C**********           MOVE PGISSB    WWISSR  60                                    R5593 CSD027
     C                     MOVE PGISSB    WWISSR  6                                           CSD027
     C                     Z-ADDPGBPSN    WWBPSN  30                      055763
     C                     Z-ADDPGSEQN    WWSEQN  30                      055763
     C*                                                                   057330
     C***********          Z-ADDPGBPSN    WWBPSR  30               057730 066036
     C***********          Z-ADDPGSEQN    WWSEQR  30               057730 066036
     C*                                                                   R5593
     C** CALCULATE THE EXPOSURE NEEDS OF THE CUSTOMER                     R5593
     C*                                                                   R5593
     C                     EXSR #BF                                       R5593
     C*
     C** LOOP UNTIL CHANGE OF KEY
     C*
B2   C           *IN29     DOWEQ'0'
     C           PGCNUM    ANDEQWWCNUM
     C           PGBPSN    ANDEQWWBPSN                                    055763
     C           PGSEQN    ANDEQWWSEQN                                    055763
     C*                                                                   R5593
     C                     Z-ADDPGBPSN    WWBPSN  30                      R5593
     C                     Z-ADDPGSEQN    WWSEQN  30                      R5593
     C*                                                                   R5593
     C** SPLIT PLEDGES PROPORTIONALLY                                     R5593
     C*                                                                   R5593
B3   C           PGISSB    IFNE WWISSR                                    R5593
     C*                                                                   R5593
     C**********           MOVE PGISSB    WWISSR  60                                   R5593 CSD027A
     C                     MOVE PGISSB    WWISSR  6                                          CSD027A
     C                     EXSR #BG                                       R5593
     C           KL9       CHAINLBPLEGL9             69                   R5593
     C*                                                                   057730
     C                     Z-ADDPGBPSN    WWBPSR  30                      057730
     C                     Z-ADDPGSEQN    WWSEQR  30                      057730
     C*                                                                   R5593
E3   C                     END                                            R5593
     C*
B3   C           PGTYPE    IFEQ 'P'
     C*
     C** INCREMENT NUMBER OF RECORDS SELECTED
     C*
     C                     ADD  1         RRPLEG
     C*
     C** ACCESS THE CLIENT MASTER & ACCOUNT CODES FILE ONCE ONLY
     C** FOR THIS CUSTOMER NUMBER/RECORD NUMBER
     C*
B4   C           *IN40     IFEQ '0'
     C                     SETON                     40
     C*
     C                     MOVE WWCNUM    WWCUST  6
     C***********WWCUST    CHAINSDLBCSL0             41                   S01498
     C*                                                                   S01498
     C                     CALL 'AOLBCSR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*KEY   ' @OPTN                           S01498
     C                     PARM WWCUST    @AENB                           S01498
     C           SDLBCS    PARM SDLBCS    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANKS                                   S01498
     C                     MOVE '1'       *IN41                           S01498
     C                     END                                            S01498
E4   C                     END
     C*
B4   C           *IN41     IFEQ '0'
     C*
     C** DETERMINE IF RECORD REQUIRES PROCESSING
     C*
B5   C           PGRECI    IFEQ 'D'
     C           PGAGRS    ANDEQ'Y'
     C           PGMATD    ANDGTBJDNWD
     C                     ADD  1         WWSLCT
     C*
     C** CALCULATE THE AVAILABLE LENDING OF THE ISSUER
     C*
     C                     EXSR #BA
     C*
     C** DETERMINE THE AMOUNT WHICH IS PLEDGED
     C*
     C                     EXSR #BD
     C*
     C** CHECK IF THE PLEDGE IS ALLOWED  (FIXED PLEDGES ALWAYS ALLOWED)   B07904
     C*
     C           PGCODE    IFNE 'FXD'                                     B07904
     C                     EXSR #BE
     C                     END                                            B07904
     C*
E5   C                     END
     C*
E4   C                     END
     C*
E3   C                     END
     C*                                                                   R5593
     C***********          Z-ADDPGBPSN    WWBPSR  30                R5593 057730
     C***********          Z-ADDPGSEQN    WWSEQR  30                R5593 057730
     C*
     C** READ NEXT RECORD ON LBPLEGL9
     C*
     C                     READ LBPLEGL9                 29
     C*
E2   C                     END
     C*
B2   C           WWSLCT    IFNE *ZEROS
     C*
     C** STORE CURRENT CUSTOMER NUMBER
     C*
     C                     MOVE PGCNUM    WWTEMP
     C                     Z-ADDPGBPSN    WWBPTE                          055763
     C                     Z-ADDPGSEQN    WWSETE                          055763
     C*********************                                               R5593
     C***CALCULATE*THE*EXPOSURE NEEDS OF THE CUSTOMER                     R5593
     C*********************                                               R5593
     C*********************EXSR #BF                                       R5593
     C*
     C** SPLIT PLEDGES PROPORTIONALLY
     C*
     C                     EXSR #BG
     C*
     C** PLEDGES DETAIL FILE MUST BE READ AGAIN AS ALL THE FILE
     C** VALUES WHERE OVERWRITTEN WHEN LBPLEGL9 WAS READ AGAIN
     C*
B3   C           *IN29     IFEQ '0'
     C********** WWTEMP    SETLLLBPLEGL9                                  055763
     C           KL12      SETLLLBPLEGL9                                  055763
     C                     READ LBPLEGL9                 29
     C*                                                                   R5593
     C                     Z-ADDPGBPSN    WWBPSR                          R5593
     C                     Z-ADDPGSEQN    WWSEQR                          R5593
E3   C                     END
     C*
E2   C                     END
     C*
E1   C                     END
     C*
     C** UPDATE TOTAL OF PLEDGES RECIEVED                                 LB0003
     C*                                                                   LB0003
     C                     EXSR #BH                                       LB0003
     C*                                                                   LB0003
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BA       - CALCULATE THE ISSUER AVAILABLE LENDING         *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BA       BEGSR
     C*
     C** RETRIEVE THE ISSUER AVAILABLE LENDING - THE LESSER
     C** OF THE FOLLOWING THREE CALCULATIONS
     C*
     C           PGISSB    CHAINLBEXTSL1             25
B1   C           *IN25     IFEQ '0'
     C*
     C** 1. LENDING POWER - TOTAL PLEDGES ISSUED/UTILISED
     C*
     C           ESLPWR    SUB  ESTPIU    WWLEND
     C*
     C           WWLEND    IFLT 0                                         LB0000
     C                     Z-ADD0         WWLEND                          LB0000
     C                     END                                            LB0000
     C*
     C** CHECK IF ACTIVE COMMITMENT LINE
     C*
     C*******    KL5       SETGTLBCOMAL2
     C           KL5       SETLLLBCOMAL2
     C                     READ LBCOMAL2                 26
     C*
B2   C           *IN26     IFEQ '0'
     C           PGISSB    ANDEQCACNUM
     C***********BJRDNB****ANDGECASTTD                                    001313
     C***********BJRDNB****ANDLECAEXPD                                    001313
     C           BJDNWD    ANDGECASTTD                                    001313
     C           BJDNWD    ANDLECAEXPD                                    001313
     C*
     C** 2. COMMITMENT LINE - OWN EXP. - TOTAL PLEDGES ISSUED/UTILISED
     C*
     C**                                                                  080768
     C** CONVERT COMMITMENT LINE AMOUNT IF CCY DIFFERENT                  080768
     C**                                                                  080768
     C           CACCY     IFNE LBCYCD                                    080768
     C                     CALL 'AOCURRR0'                                080768
     C                     PARM 'BLANKS'  @RTCD                           080768
     C                     PARM '*KEY   ' @OPTN                           080768
     C                     PARM CACCY     @AJCD                           080768
     C           SDCURR    PARM SDCURR    DSSDY                           080768
     C*                                                                   080768
     C           @RTCD     IFNE *BLANKS                                   080768
     C           *LOCK     IN   LDA                                       080768
     C                     Z-ADD15        DBASE            ***************080768
     C                     MOVE 'SDCURRPD'DBFILE           * DB ERROR 15 *080768
     C                     MOVELCACCY     DBKEY            ***************080768
     C                     OUT  LDA                                       080768
     C                     EXSR #ZA                                       080768
     C                     ELSE                                           080768
     C*                                                                   080768
     C** CONVERT PLEDGE AMOUNT TO PORTFOLIO EXTRACT CURRENCY              080768
     C*                                                                   080768
     C                     Z-ADDCACMTL    WWAMTI                          080768
     C                     Z-ADDA6SPRT    WWSRI                           080768
     C                     Z-ADDA6NBDP    WWDPI                           080768
     C                     MOVE A6MDIN    WWMDI                           080768
     C                     EXSR SCONV                                     080768
     C                     Z-ADDWWAMTO    CACMTL                          080768
     C                     END                                            080768
     C                     END                                            080768
     C           CACMTL    SUB  ESOWEX    WWTLND
     C           WWTLND    SUB  ESTPIU    WWTLND
     C*
     C           WWTLND    IFLT 0                                         LB0000
     C                     Z-ADD0         WWTLND                          LB0000
     C                     END                                            LB0000
     C*
     C           WWTLND    IFLT WWLEND
     C                     Z-ADDWWTLND    WWLEND
     C                     END
     C*
     C** SAVE COMMITMENT LINE AMMOUNT FOR LATER USE
     C*
     C                     Z-ADDCACMTL    WWCMTL
     C*
     C                     ELSE                                           B07970
     C*                                                                   B07970
     C** IF NO COMMITMENT LINE, AVAILABLE LENDING IS ZERO                 B07970
     C                     Z-ADD0         WWLEND                          B07970
     C                     Z-ADD0         WWCMTL                          B07970
     C                     Z-ADD0         CACMTL                          B07970
E2   C                     END
     C*
     C** 3. TOT. PLEDGES RCVD. - OWN EXP. - TOT. PLEDGES ISSUED/UTIL.
     C*
     C           ESLPWR    SUB  ESOWEX    WWTLND
     C           WWTLND    SUB  ESTPIU    WWTLND
     C*
     C           CUINBP    IFNE 'N'
     C           WWTLND    ADD  ESTPRD    WWTLND
     C                     END
     C*
     C           WWTLND    IFLT 0                                         LB0000
     C                     Z-ADD0         WWTLND                          LB0000
     C                     END                                            LB0000
     C*
     C           WWTLND    IFLT WWLEND
     C                     Z-ADDWWTLND    WWLEND
     C                     END
     C*
X1   C                     ELSE
     C*
     C** ISSUER AVAILABLE LENDING AMOUNT EQUALS ZERO
     C*
     C                     Z-ADD0         WWLEND
     C*
E1   C                     END
     C*
     C** SAVE VALUES                                                      LB0000
     C*                                                                   LB0000
     C                     MOVE PGCNUM    RRCNUM
     C                     MOVE PGISSB    RRISSB
     C                     MOVE PGBPSN    RRBPSN
     C                     MOVE PGSEQN    RRSEQN
     C                     MOVE PGCODE    RRCODE
     C                     MOVE PGALLW    RRALLW
     C***********          Z-ADDPGUTSL    RRUTSL                          B7845
     C********** PGUTSL    IFNE *ZEROS                                                  B7845 CLE148
     C           PGUTSL    IFNE *BLANKS                                                       CLE148
     C                     MOVE PGUTSL    RRUTSL                          B7845
     C                     ELSE                                           B7845
     C                     MOVE *BLANKS   RRUTSL                          B7845
     C                     END                                            B7845
     C                     MOVE PGUTSF    RRUTSF
     C                     MOVE PGUTSP    RRUTSP
     C**                   MOVE PGPORP    RRPORP                          B07995
     C           WWLEND    DIV  100       R01       H                     LB0000
     C           ESLPWR    DIV  100       R02       H                     LB0000
     C           ESTPIU    DIV  100       R03       H                     LB0000
     C           CACMTL    DIV  100       R04       H                     LB0000
     C           ESTPIU    DIV  100       R05       H                     LB0000
     C           CACMTL    DIV  100       R06       H                     LB0000
     C           ESOWEX    DIV  100       R07       H                     LB0000
     C           ESTPIU    DIV  100       R08       H                     LB0000
     C           ESLPWR    DIV  100       R09       H                     LB0000
     C           ESTPRD    DIV  100       R10       H                     LB0000
     C                     Z-ADDESOWEX    WR11   130                      LB0000
     C                     ADD  ESTPIU    WR11                            LB0000
     C           WR11      DIV  100       R11       H                     LB0000
     C*                                                                   LB0000
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BB       - THIS SUBROUTINE PRINTS A LINE OF DETAILS ON    *
     C**               THE EXCEPTION REPORT FOR THE UNALLOWED PLEDGE  *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BB       BEGSR
     C*
     C** PRINT HEADINGS ONCE
     C*
     C           *IN31     IFEQ '0'
     C                     OPEN LB0680P2                                  S01498
     C                     EXSR RCFP2                                     S01498
     C                     WRITEHEADER1
     C                     WRITEHEADER2
     C                     SETON                     31
     C                     END
     C*
     C** REPRINT HEADING IF NEW PAGE REQUIRED
     C*
     C           LINE1     IFGT 55
     C                     WRITEHEADER1
     C                     WRITEHEADER2
     C                     END
     C*
     C** PRINT DETAIL LINE
     C*
     C**********           Z-ADDPGCNUM    RRCNUM                                              CSD027
     C                     MOVE PGCNUM    RRCNUM                                              CSD027
     C                     Z-ADDPGSEQN    RRSEQN
     C                     WRITEDETAILF
     C*
     C                     ADD  1         WWPRNT
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BD       - DETERMINE THE AMOUNT WHICH IS PLEDGED          *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BD       BEGSR
     C*
     C** CHECK THE PLEDGE CODE
     C*
B1   C           PGCODE    IFEQ 'FXD'
     C*
     C** FIXED PLEDGE
     C*
     C                     Z-ADDPGPLED    WWPLED
     C                     Z-ADDWWPLED    WWPLDO 150                      B07995
X1   C                     ELSE
     C*
B2   C           PGCODE    IFEQ 'LMT'
     C*
     C** LIMITED PLEDGE
     C**    CHECK PLEDGE AMOUNT AGAINST ISSUER AVAILABLE LENDING
     C*
     C*  SAVE LIMIT AMOUNT IN ORIGINAL CCY
     C                     Z-ADDPGPLED    WWPLED                          B08175
     C                     Z-ADDWWPLED    WWPLDO 150                      B07995
     C*                                                                   066036
     C           PGPLED    SUB  PGPLEU    XXPLED                          066036
     C                     SUB  XXPLED    WWPLED                          066036
     C*                                                                   066036
     C*  CANNOT COMPARE HERE AS THE CURRENCIES ARE DIFFERENT              B07995
B3   C**         PGPLED    IFGT WWLEND                                    B07995
     C**                   Z-ADDWWLEND    WWPLED                          B07995
     C**                   ELSE                                           B07995
     C**                   Z-ADDPGPLED    WWPLED                          B07995
E3   C**                   END                                            B07995
     C*******                                                             LB0006
     C******CHECK IF PERCENTAGE EXISTS                                    LB0006
     C*******                                                             LB0006
B3   C*******    PGPLEP    IFNE *ZEROS                                    LB0006
     C*******    PGPLEP    DIV  100       WWPLPC  32                      LB0006
     C*******                                                             LB0006
     C******REDUCE PLEDGE AMOUNT BY PERCENTAGE                            LB0006
     C*******                                                             LB0006
     C*******    WWPLED    MULT WWPLPC    WWLESS                          LB0006
     C*******    WWPLED    SUB  WWLESS    WWPLED                          LB0006
E3   C*******              END                                            LB0006
     C*
X2   C                     ELSE
     C*
B3   C           PGCODE    IFEQ 'GEN'
     C*
     C** GENERALISED PLEDGE
     C**    CHECK THE PORTFOLIO PLEDGED
     C*
B4   C           PGPORP    IFEQ *BLANKS
     C           WWLEND    IFGE 0                                         B08002
     C                     Z-ADDWWLEND    WWPLED
     C                     ELSE                                           B08002
     C                     Z-ADD0         WWPLED                          B08002
     C                     END                                            B08002
X4   C                     ELSE
     C*
     C**    ACCESS THE PORTFOLIO TOTALS FILE
     C*
     C***********KL1       CHAINPMPOTTPP             27                   S01498
     C           KL1       CHAINPMPOTTPD             27                   S01498
B5   C           *IN27     IFEQ '0'
     C*
     C**     TRADE DATE POSITIVE LESS NEGATIVE ASSETS
     C*
     C           QCPTPA    SUB  QCPTNA    WWPLED
E5   C                     END
E4   C                     END
     C*******                                                             LB0006
     C******CHECK IF PERCENTAGE EXISTS                                    LB0006
     C*******                                                             LB0006
B4   C*******    PGPLEP    IFNE *ZEROS                                    LB0006
     C*******    PGPLEP    DIV  100       WWPLPC  32                      LB0006
     C*******                                                             LB0006
     C******REDUCE PLEDGE AMOUNT BY PERCENTAGE                            LB0006
     C*******                                                             LB0006
     C*******    WWPLED    MULT WWPLPC    WWLESS                          LB0006
     C*******    WWPLED    SUB  WWLESS    WWPLED                          LB0006
E4   C*******              END                                            LB0006
     C*
E3   C                     END
E2   C                     END
E1   C                     END
     C*
     C*
     C** ACCESS CURRENCY FILE FOR PLEDGE CURRENCY
     C           WWPLED    IFNE 0                                         B08002
     C***********PGCCY     CHAINSDCURRL1             69                   S01498
     C*****************************************************************   S01498
     C***IF*RECORD*NOT*FOUND*OR*LAST-CHANGE-TYPE*=*'D'*THEN*DB*ERROR***   S01498
     C*****************************************************************   S01498
B1   C************IN69     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*KEY   ' @OPTN                           S01498
     C                     PARM PGCCY     @AJCD                           S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD4         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 004 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELPGCCY     DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
X1   C                     ELSE
     C*
     C** CONVERT PLEDGE AMOUNT TO PORTFOLIO EXTRACT CURRENCY
     C*
     C                     Z-ADDWWPLED    WWAMTI
     C                     Z-ADDA6SPRT    WWSRI
     C                     Z-ADDA6NBDP    WWDPI
     C                     MOVE A6MDIN    WWMDI
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    WWPLED
E1   C                     END
     C                     END                                            B08002
     C*
     C** SAVE VALUES                                                      LB0000
     C*                                                                   LB0000
     C           PGCODE    IFEQ 'FXD'                                     B7837
     C** SAVE FIXED PLEDGE AMOUNT - PORTFOLIO CURRENCY                    B07995
     C                     Z-ADDWWAMTO    WWPLFX 150                      B07995
     C           PGPLED    DIV  100       R12       H                     LB0000
     C           WWAMTO    DIV  100       R22       H                     LB0000
     C                     ELSE                                           B7837
     C                     Z-ADD*ZEROS    R12                             B7837
     C                     END                                            B7837
     C*                                                                   B7837
     C           PGCODE    IFEQ 'LMT'                                     B7837
     C                     Z-ADDWWAMTO    WWPLFX 150                      B08175
     C*  IF LENDING POWER IS GREATER THAN THE PLEDGE LIMIT,               B07995
     C*  SET PLEDGE AMOUNT TO LIMIT AMOUNT                                B07995
     C           WWLEND    IFGE 0                                         B08002
     C           WWPLFX    IFGT WWLEND                                    B07995
     C                     Z-ADDWWLEND    WWPLED                          B07995
     C                     ELSE                                           B07995
     C                     Z-ADDWWPLFX    WWPLED                          B07995
     C                     END                                            B07995
     C                     ELSE                                           B08002
     C                     Z-ADD0         WWPLED                          B08002
     C                     END                                            B08002
     C*  SAVE LIMITED PLEDGE AMOUNT - PORTFOLIO CURRENCY                  B07995
     C                     Z-ADDWWPLED    WWPLFX 150                      B07995
     C           PGPLED    DIV  100       R13       H                     LB0000
     C           WWLEND    DIV  100       R14       H                     LB0000
     C                     ELSE                                           B7837
     C                     Z-ADD*ZEROS    R13                             B7837
     C                     Z-ADD*ZEROS    R14                             B7837
     C                     END                                            B7837
     C*                                                                   B7837
     C***********PGCODE    IFEQ 'GEN'                               B7837 B7845
     C***********PGPORP    IFNE *BLANK                              R5593 B7845
     C***********WWPLED    DIV  100       R15       H               LB0000B7845
     C***********          ELSE                                     R5593 B7845
     C***********          Z-ADD*ZEROS    R15                       R5593 B7845
     C***********          END                                      R5593 B7845
     C***********WWLEND    DIV  100       R16       H               LB0000B7845
     C***********          ELSE                                     B7837 B7845
     C***********          Z-ADD*ZEROS    R15                       B7837 B7845
     C***********          Z-ADD*ZEROS    R16                       B7837 B7845
     C***********          END                                      B7837 B7845
     C***********          MOVELPGPORP    FLD02                     LB0000B7845
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BE       - CHECK IF THE PLEDGE IS TO BE ALLOWED           *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BE       BEGSR
     C*
     C** CHECK THE AVAILABLE LENDING AMOUNT AGAINST PLEDGED AMOUNT
     C*
     C***********WWLEND    IFGE WWPLED                                    066036
     C***********WWLEND    ANDNE*ZEROS                                    066036
     C*                                                                   066036
     C           WWLEND    IFGT *ZEROS                                    066036
     C*                                                                   066036
     C           WWEXPS    ANDGT*ZEROS                                    066036
     C*
     C** THE PLEDGE IS ALLOWED
     C*
     C                     MOVE *BLANKS   PGALLW
     C*
     C*******SAVE THE AMOUNT WHICH IS PLEDGED                             B7812
     C*******                                                             B7812
     C*******              Z-ADDWWPLED    PGPLED                          B7812
     C*
     C**     CHECK IF A NON-SECURED PLEDGE
     C*
     C********** PGUTSL    IFEQ *ZEROS                                                        CLE148
     C           PGUTSL    IFEQ *BLANKS                                                       CLE148
     C           PGUTSF    ANDEQ*BLANKS
     C           PGUTSP    ANDEQ*BLANKS
     C*
     C** NON-SECURED PLEDGE - MAINTAIN TOTAL PLEDGE AMOUNT FOR CUST.
     C*
     C           WWPLED    IFGT WWLEND                                    066036
     C                     Z-ADDWWLEND    WWPLED                          066036
     C                     END                                            066036
     C*                                                                   066036
     C                     ADD  WWPLED    WWTPLG
     C                     END
     C*
     C                     ELSE
     C*
     C** THE PLEDGE IS NOT ALLOWED
     C**     PRINT DETAILS ON THE UNALLOWED PLEDGE REPORT
     C*
     C                     EXSR #BB
     C*
     C** UPDATE THE CURRENT PLEDGE RECORD - FLAG THE ALLOWED FIELD
     C                     MOVE 'N'       PGALLW
     C***ZEROISE THE UTILISED AMOUNT                                B07995B10574
     C***                  Z-ADD0         PGPLEU                    B07995B10574
     C***        PGTYPE    IFEQ 'GEN'                                     B10574
     C***        PGCODE    IFEQ 'GEN'                                     B10574
     C***                  Z-ADD0         PGPLED                    B07995B10574
     C***                  END                                            B10574
     C*
     C                     END
     C*                                                                   B10574
     C** RESET PLEDGE AMOUNT TO ZERO IF UNALLOWED GENERALISED PLEDGE      B10574
     C           PGCODE    IFEQ 'GEN'                                     B10574
     C           PGALLW    ANDEQ'N'                                       B10574
     C                     Z-ADD0         PGPLED                          B10574
     C                     Z-ADD0         PGPLEU                          B10574
     C                     END                                            B10574
     C*
     C** UPFDATE THE PLEDGE RECORD
     C*
     C                     UPDATLBPLEGD9
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BF       - CALCULATE THE EXPOSURE NEEDS OF THE CUSTOMER   *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BF       BEGSR
     C*
     C** ACCESS THE PORTFOLIO EXTRACT SUMMARY FILE
     C*
     C** INITIALISE FIELDS USED WHEN CALCULATING EXPOSURE NEEDS
     C*
     C                     Z-ADD0         WWTEXP
     C                     Z-ADD0         WWBPWR
     C                     Z-ADD0         WWEXPS
     C*
     C           WWCNUM    CHAINLBEXTSL1             69
     C           *IN69     IFEQ '0'
     C*
     C** CALCULATE THE TOTAL EXPOSURE
     C*
     C           ESOWEX    ADD  ESTPIU    WWTEXP
     C*
     C** CALCULATE THE TOTAL BORROWING POWER
     C*
     C           CUINBP    IFEQ 'N'
     C                     Z-ADDESLPWR    WWBPWR
     C                     ELSE
     C           ESLPWR    ADD  ESTPRD    WWBPWR
     C                     END
     C*
     C** CALCULATE THE EXPOSURE NEEDS OF THE CUSTOMER
     C*
     C           WWTEXP    IFGT WWBPWR                                    B7812
     C           WWTEXP    SUB  WWBPWR    WWEXPS
     C                     ELSE                                           B7812
     C                     Z-ADD0         WWEXPS                          B7812
     C                     END                                            B7812
     C*
     C                     ELSE
     C*
     C** THE EXPOSURE NEEDS OF THE CUSTOMER ARE EQUAL TO ZERO
     C*
     C                     Z-ADD0         WWEXPS
     C*
     C                     END
     C*
     C** SAVE VALUES                                                      LB0000
     C*                                                                   LB0000
     C           WWEXPS    DIV  100       R17       H                     LB0000
     C           ESOWEX    ADD  ESTPIU    WR18   130                      LB0000
     C           WR18      DIV  100       R18       H                     LB0000
     C           WWBPWR    DIV  100       R19       H                     LB0000
     C*                                                                   LB0000
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BG       - SPLIT PLEDGES PROPORTIONALLY                   *
     C**                                                              *
     C*****CALLS*****- NONE                                           *   R01168
     C**   CALLS     - #BGD                                           *   R01168
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BG       BEGSR
     C*
     C** RETRIEVE ALL RECORDS FROM LBPLEGL9 FOR THE CUSTOMER
     C*
     C***********WWCNUM    CHAINLBPLEGL9             69                   R5593
     C           KL10      CHAINLBPLEGL9             69                   R5593
     C                     SETOF                     43
     C                     SETOF                     79                   080768
     C*                                                                   B10575
     C** DO NOT SPLIT 'FIXED' PLEDGES ? (DUPLICATED RECORDS FOUND IN      B10575
     C** BOTH LBEXTRPD & LBEXCOPD; WRONG TOTAL AMOUNT FOUND IN LBEXTSPD)  B10575
     C           PGCODE    IFEQ 'FXD'                                     B10575
     C                     MOVELPGCODE    WWCODE                          B10575
     C                     END                                            B10575
     C*
     C** SAVE CURRENT CUSTOMER NUMBER NAME
     C*
     C                     MOVE PGCNUM    WWCNUM
     C                     MOVE PGISSB    WWISSB                          R5593
     C                     MOVE PGCCY     WWCCY                           B10575
     C*
     C** LOOP FOR CURRENT CUSTOMER
     C*
     C           *IN69     DOWEQ'0'
     C           PGCNUM    ANDEQWWCNUM
     C           PGBPSN    ANDEQWWBPSN                                    055763
     C           PGSEQN    ANDEQWWSEQN                                    055763
     C           PGISSB    IFEQ WWISSB                                    R5593
     C*
     C** CHECK THAT THE PLEDGE IS ALLOWED
     C*
     C           PGALLW    IFNE 'N'
     C           PGRECI    ANDEQ'D'
     C           PGAGRS    ANDEQ'Y'
     C           PGMATD    ANDGTBJDNWD
     C*
     C** *IN43  - AT LEAST ONE PLEDGE ALLOWED FOR THE CUSTOMER
     C*
     C           *IN43     IFEQ '0'
     C                     MOVE '1'       *IN43
     C                     END
     C*                                                                   066036
     C** CALCULATE THE AVAILABLE LENDING OF THE ISSUER                    066036
     C*                                                                   066036
     C                     EXSR #BA                                       066036
     C*                                                                   066036
     C** DETERMINE THE AMOUNT WHICH IS PLEDGED                            066036
     C*                                                                   CH0620
     C                     EXSR #BD                                       066036
     C*
     C** CHECK IF RECORD IS USED TO SECURE
     C*
     C********** PGUTSL    IFNE *ZEROS                                                        CLE148
     C           PGUTSL    IFNE *BLANKS                                                       CLE148
     C*
     C** USED TO SECURE/LOAN
     C*
     C****       PGUTSL    CHAINCLOANCL1             24                   B08218
     C                     MOVE 'A'       WWRECT                          B08218
     C           KL11      CHAINCLOAN                24                   B08218
     C           *IN24     IFEQ '0'
     C*
     C** EFFECTIVE AMOUNT = CURRENT PRINCIPAL AMOUNT
     C*
     C                     Z-ADDCPAM      WWEAMT
     C                     ELSE                                           040592
     C**********           Z-ADD0         PGUTSL                                       040952 CLE148
     C                     MOVEL*BLANK    PGUTSL                                              CLE148
     C                     END
     C                     ELSE
     C*
     C           PGUTSF    IFNE *BLANKS
     C*
     C** USED TO SECURE/FACILITY - SPLIT INTO FACILITY TYPE & NUMBER
     C*
     C                     MOVE PGUTSF    WWUTSF
     C*
     C***********KL3       CHAINFCLYFML2             28                   S01498
     C           KL3       CHAINLBFCLTL2             28                   S01498
     C           *IN28     IFEQ '0'
     C*
     C** EFFECTIVE AMOUNT = FACILITY AMOUNT
     C*
     C                     Z-ADDFAMT      WWEAMT
     C                     END
     C                     ELSE
     C*
     C           PGUTSP    IFNE *BLANKS
     C*
     C** USED TO SECURE/PORTFOLIO
     C*
     C***********KL4       CHAINPMPOTTPP             27                   S01498
     C           KL4       CHAINPMPOTTPD             27                   S01498
     C           *IN27     IFEQ '0'
     C*
     C** EFFECTIVE AMOUNT = TRADE DATE POSITIVE - NEGATIVE AMOUNTS
     C*
     C           QCPTPA    SUB  QCPTNA    WWEAMT
     C                     END
     C*
     C                     ELSE
     C*
     C           PGETYP    IFEQ 'A'
     C*
     C** USED TO SECURE/ACCOUNT
     C*
     C***********KL8       CHAINACCNABL1             48                   S01498
     C           KL8       CHAINLBACCNL1             48                   S01498
     C*
     C** EFFECTIVE AMOUNT = CLEARED BALANCE
     C*
     C           *IN48     IFEQ '0'
     C                     MOVE '1'       *IN79                           080768
     C                     MOVE *BLANKS   WWACCN                          080768
     C                     MOVELWWACNT    WWCNUT                          080768
     C                     MOVELWWACCY    WWCCYT                          080768
     C                     MOVELWWASEQ    WWSEQT                          080768
     C                     MOVELWWACDE    WWACOT                          080768
     C           *IN46     IFEQ '1'                                       087628
     C                     MOVELPGEBCH    WWBCHT                          087628
     C                     ELSE                                           087628
     C                     MOVEL*BLANKS   WWBCHT                          087628
     C                     END                                            087628
     C                     MOVELWWACCN    RRACCN                          080768
     C                     Z-ADDCLBL      PGPLEU
     C**                                                                  080768
     C** CONVERT AMOUNT TO PORTFOLIO LENDING CCY                          080768
     C**                                                                  080768
     C           WWACCY    IFNE LBCYCD                                    080768
     C                     CALL 'AOCURRR0'                                080768
     C                     PARM 'BLANKS'  @RTCD                           080768
     C                     PARM '*KEY   ' @OPTN                           080768
     C                     PARM WWACCY    @AJCD                           080768
     C           SDCURR    PARM SDCURR    DSSDY                           080768
     C*                                                                   080768
     C           @RTCD     IFNE *BLANKS                                   080768
     C           *LOCK     IN   LDA                                       080768
     C                     Z-ADD16        DBASE            ***************080768
     C                     MOVE 'SDCURRPD'DBFILE           * DB ERROR 16 *080768
     C                     MOVELWWACCY    DBKEY            ***************080768
     C                     OUT  LDA                                       080768
     C                     EXSR #ZA                                       080768
     C                     ELSE                                           080768
     C*                                                                   080768
     C** CONVERT PLEDGE AMOUNT TO PORTFOLIO EXTRACT CURRENCY              080768
     C*                                                                   080768
     C                     Z-ADDCLBL      WWAMTI                          080768
     C                     Z-ADDA6SPRT    WWSRI                           080768
     C                     Z-ADDA6NBDP    WWDPI                           080768
     C                     MOVE A6MDIN    WWMDI                           080768
     C                     EXSR SCONV                                     080768
     C                     Z-ADDWWAMTO    WWEXPS                          080768
     C                     END                                            080768
     C                     END                                            080768
     C                     END
     C*
     C                     ELSE
     C*                                                                   LB0000
     C** EFFECTIVE AMOUNT IS TO BE COMPARED                               LB0000
     C**    TO THE ISSUER AVAILABLE LENDING                               LB0000
     C           WWEXPS    IFGT WWLEND                                    LB0000
     C                     Z-ADDWWLEND    WWEXX  130                      LB0000
     C                     ELSE                                           LB0000
     C                     Z-ADDWWEXPS    WWEXX                           LB0000
     C                     END                                            LB0000
     C*
     C** RECORD IS NOT A USED TO SECURE PLEDGE
     C**    CALCULATE THE EFFECTIVE AMOUNT WHICH IS PLEDGED
     C**       CHECK FOR DIVIDE BY ZERO
     C*
     C***********WWTPLG    IFNE *ZEROS                                    R5593
     C***********WWEXPS    ANDGT*ZEROS                                    R5593
     C***********PGPLED    DIV  WWTPLG    WWEAMT                          R5593
     C*******    WWEAMT    MULT WWEXPS    WWEAMT                   LB0000 R5593
     C***********WWEAMT    MULT WWEXX     WWEAMT                   LB0000 R5593
     C***********PGPLED    MULT WWEXX     WWEAMT                   LB0000 R5593
     C***********WWEAMT    DIV  WWTPLG    WWEAMT                          R5593
     C*********************END                                            R5593
     C*                                                                   R5593
     C           PGCODE    IFEQ 'GEN'                                     B7874
     C           WWLEND    IFGT 0                                         B08002
     C                     Z-ADDWWLEND    PGPLED                          B7874
     C                     ELSE                                           B08002
     C                     Z-ADD0         PGPLED                          B08002
     C                     END                                            B08002
     C                     END                                            B7874
     C*                                                                   B7874
     C           PGPLED    IFGT WWEXX                                     R5593
     C                     Z-ADDWWEXX     WWEAMT                          R5593
     C                     ELSE                                           R5593
     C                     Z-ADDPGPLED    WWEAMT                          R5593
     C                     END                                            R5593
     C*                                                                   R5593
     C**         PGCODE    IFEQ 'LMT'                               B7874 B08175
     C**         WWEAMT    ANDGTWWPLFX                              B7874 B08175
     C**                   Z-ADDWWPLFX    WWEAMT                    B7874 B08175
     C**                   END                                      B7874 B08175
     C*                                                                   R5593
     C           PGCODE    IFEQ 'FXD'                                     B7874
     C**                   Z-ADDPGPLED    WWEAMT                          B7874
     C                     Z-ADDWWPLFX    WWEAMT                          B7874
     C                     END                                            B7874
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*                                                                   R5593
     C** SUBTRACT THE PLEDGES RECEIVED FROM THE AMOUNT NEEDED             R5593
     C*                                                                   R5593
     C                     SUB  WWAMTT    R17                             R5593
     C           R17       IFLT *ZERO                                     R5593
     C                     Z-ADD*ZERO     R17                             R5593
     C                     END                                            R5593
     C*                                                                   R5593
     C** ADD THE PLEDGES RECEIVED TO THE BORROWING POWER                  R5593
     C*                                                                   R5593
     C                     ADD  WWAMTT    R19                             R5593
     C*                                                                   R5593
     C           WWEAMT    DIV  100       R20       H                     R5593
     C*                                                                   R5593
     C** IF THE AMOUNT NEEDED IS LESS THAN THE AMOUNT AVAILABLE USE       R5593
     C** ONLY THE NECESSARY PART                                          R5593
     C*                                                                   R5593
     C           R20       IFLT *ZERO                                     B7812
     C                     Z-ADD*ZERO     R20                             B7812
     C                     Z-ADD*ZERO     WWEAMT                          B7812
     C                     END                                            B7812
     C           R17       IFLT R20                                       R5593
     C                     Z-ADDR17       R20                             R5593
     C           R20       MULT 100       WWEAMT                          R5593
     C                     END                                            R5593
     C*                                                                   R5593
     C           PGCODE    IFEQ 'FXD'                                     B7874
     C**                   Z-ADDPGPLED    WWEAMT                     B7874B07995
     C**                   Z-ADDPGPLED    R20                        B7874B07995
     C                     Z-ADDWWPLDO    WWEAMT                          B07995
     C                     Z-ADDWWPLDO    R20                             B07995
     C                     END                                            B7874
     C*
     C** EFFECTIVE AMOUNT FOR THE CUSTOMER
     C                     Z-ADDWWEAMT    PGPLEU
     C*                                                                   LB0006
     C** CHECK IF PERCENTAGE EXISTS                                       LB0006
     C*                                                                   LB0006
     C           PGPLEP    IFNE *ZEROS                                    LB0006
     C           PGPLEP    DIV  100       WWPLPC  32                      LB0006
     C*                                                                   LB0006
     C** CURRENT PLEDGE IS COVERING % EXPOSURE                            LB0006
     C*                                                                   LB0006
     C           PGPLEU    MULT WWPLPC    PGPLEU    H                     LB0006
     C                     Z-ADDPGPLEP    RRPER1                          080768
     C                     Z-ADDPGPLEP    RRPER2                          080768
     C                     ELSE                                           080768
     C                     Z-ADD100       RRPER1                          080768
     C                     Z-ADD100       RRPER2                          080768
     C*                                                                   LB0006
     C                     END                                            LB0006
     C**                                                                  080768
     C** CONVERT AMOUNT USED (REPORT USAGE ONLY)                          080768
     C**                                                                  080768
     C           PGCCY     IFNE LBCYCD                                    080768
     C                     CALL 'AOCURRR0'                                080768
     C                     PARM 'BLANKS'  @RTCD                           080768
     C                     PARM '*KEY   ' @OPTN                           080768
     C                     PARM PGCCY     @AJCD                           080768
     C           SDCURR    PARM SDCURR    DSSDY                           080768
     C*                                                                   080768
     C           @RTCD     IFNE *BLANKS                                   080768
     C           *LOCK     IN   LDA                                       080768
     C                     Z-ADD14        DBASE            ***************080768
     C                     MOVE 'SDCURRPD'DBFILE           * DB ERROR 14 *080768
     C                     MOVELPGCCY     DBKEY            ***************080768
     C                     OUT  LDA                                       080768
     C                     EXSR #ZA                                       080768
     C                     ELSE                                           080768
     C*                                                                   080768
     C** CONVERT PLEDGE AMOUNT TO PORTFOLIO EXTRACT CURRENCY              080768
     C*                                                                   080768
     C                     Z-ADDPGPLEU    WWAMTI                          080768
     C                     Z-ADDA6SPRT    WWSRI                           080768
     C                     Z-ADDA6NBDP    WWDPI                           080768
     C                     MOVE A6MDIN    WWMDI                           080768
     C                     EXSR SCONV                                     080768
     C                     Z-ADDWWAMTO    WWPLEU                          080768
     C                     END                                            080768
     C                     ELSE                                           080768
     C                     Z-ADDPGPLEU    WWPLEU 130                      080768
     C                     END                                            080768
     C*
     C** SAVE VALUES                                                      LB0000
     C*                                                                   LB0000
     C***********PGPLED    DIV  100       R21       H              LB0000 R5593
     C***********WWEXX     DIV  100       R22       H              LB0000 R5593
     C***********WWTPLG    DIV  100       R23       H              LB0000 R5593
     C***********PGPLEU    DIV  100       R24       H              LB0000 080768
     C           WWPLEU    DIV  100       R24       H                     080768
     C***********PGPLEP    IFEQ 0                                  LB0000 B7845
     C***********          Z-ADD100       RRPLEP                   LB0000 B7845
     C***********          ELSE                                    LB0000 B7845
     C***********          Z-ADDPGPLEP    RRPLEP                   LB0000 B7845
     C***********          END                                     LB0000 B7845
     C*                                                                   LB0000
     C** PRINT DETAILS OF CALCULATIONS                                    LB0000
     C*                                                                   LB0000
     C                     ADD  R20       WWAMTT                          B7812
     C           WWPLED    DIV  100       R20       H                     B7812
     C*                                                                   S01498
     C           *IN50     IFEQ '0'                                       S01498
     C                     OPEN LB0680P1                                  S01498
     C                     EXSR RCFP1                                     S01498
     C                     END                                            S01498
     C                     WRITEHEADER0                                   LB0000
     C           PGCODE    IFEQ 'FXD'                                     B07995
     C                     MOVEL'"FXD"'   RRTYP2                          080768
     C                     MOVE '1'       *IN77                           B07995
     C                     ELSE                                           B07995
     C                     MOVE '0'       *IN77                           B07995
     C           PGCODE    IFEQ 'GEN'                                     080768
     C                     MOVEL'"GEN"'   RRTYP1                          080768
     C                     ELSE                                           080768
     C                     MOVEL'"LMT"'   RRTYP1                          080768
     C                     END                                            080768
     C                     END                                            B07995
     C                     WRITEDETAIL0                                   R00308
     C                     MOVE '1'       *IN50                           R00308
     C*********************ADD  R20       WWAMTT                    R5593 B7812
     C*                                                                   LB0000
     C** TOTAL EFFECTIVE AMOUNT & PLEDGE AMOUNT FOR THE CUSTOMER
     C           PGCODE    IFEQ 'FXD'                                     B7874
     C           PGCODE    OREQ 'LMT'                                     37532
     C                     ADD  WWPLFX    WWTEFF
     C                     ADD  WWPLFX    WWTPLD                          B7812
     C                     ELSE                                           B7874
     C                     ADD  WWEAMT    WWTEFF
     C*********************ADD  PGPLED    WWTPLD                          B7812
     C                     ADD  WWPLED    WWTPLD                          B7812
     C                     END                                            B7874
     C*
     C** UPDATE THE PORTFOLIO EXTRACT SUMMARY FILE (FOR ISSUER)
     C*
     C                     EXSR #BGA
     C*                                                                   R0986
     C*  IN #BGA WE HAVE ACCESSED THE PARENT OF THE ISSUER. STORE IT.     R0986
     C                     MOVE BBPCNB    ISSPAR  6                       R0986
     C*                                                                   R0986
     C** ACCESS SDCUSTL0 FOR THE PARENT OF THE CUSTOMER                   R0986
     C*                                                                   R0986
     C                     MOVE PGCNUM    WWCUST  6                       R0986
     C***********WWCUST    CHAINSDCUSTL0             42              R0986S01498
     C*                                                                   S01498
     C                     CALL 'AOCUSTR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*KEY    '@OPTN                           S01498
     C                     PARM WWCUST    @AENB  10                       S01498
     C                     PARM *BLANKS   @KYST   7                       S01498
     C           SDCUST    PARM SDCUST    DSSDY                           S01498
     C*                                                                   S01498
     C************IN42*****IFEQ '1'                                  R0986B9661
     C*********************Z-ADD5         DBASE       ***************R0986B9661
     C*********************MOVEL'SDCUSTL0'DBFILE      * DBERROR 005 *R0986B9661
     C*********************MOVE *BLANKS   DBKEY       *             *R0986B9661
     C*********************MOVELWWCUST    DBKEY       ***************R0986B9661
     C*********************EXSR #ZA                                  R0986B9661
     C*********************END                                       R0986B9661
     C***STORE*PARENT*OF*CUSTOMER                                    R0986B9661
     C*  STORE PARENT OF CUSTOMER, FOUND OR NOT                           B9661
     C                     MOVE BBPCNB    CUSPAR  6                       R0986
     C*
     C** UPDATE PORTFOLIO EXTRACT DETAIL FILE FOR CUSTOMER
     C                     MOVE 'C'       WWEXTT  1
     C**********           Z-ADDPGCNUM    WWPNP8                          LB0000              CSD027
     C                     MOVE PGCNUM    WWPNP8                          LB0000              CSD027
     C                     EXSR #BGC
     C*                                                                   R01168
     C** WRITE RECORD TO NEW EXTRACT FILE LBEXCOPD FOR COLLATERAL         R01168
     C** OF BENEFICIARY                                                   R01168
     C                     EXSR #BGD                                      R01168
     C*
     C** UPDATE PORTFOLIO EXTRACT DETAIL FILE FOR ISSUER
     C                     MOVE 'I'       WWEXTT
     C**********           Z-ADDPGISSB    WWPNP8                          LB0000              CSD027
     C                     MOVE PGISSB    WWPNP8                          LB0000              CSD027
     C                     EXSR #BGC
     C*                                                                   R01168
     C** WRITE RECORD TO NEW EXTRACT FILE LBEXCOPD FOR EXPOSURE           R01168
     C** OF ISSUER                                                        R01168
     C                     EXSR #BGD                                      R01168
     C*********************                                               R01168
     C*********************END                                            R01168
     C*
     C** CONVERT PLEDGE AMOUNT TO PLEDGE CURRENCY FOR LIMITED PLEDGES
     C*  AS LBPLEGPD MUST BE UPDATED IN PLEDGE CURRENCY
     C           PGTYPE    IFEQ 'LMT'
     C*
     C                     Z-ADDPGPLEU    WWAMTI
     C                     Z-ADDWWSRO     WWSRI
     C                     Z-ADDWWDPO     WWDPI
     C                     MOVE WWMDO     WWMDI
     C                     Z-ADDA6SPRT    WWSRO
     C                     Z-ADDA6NBDP    WWDPO
     C                     MOVE A6MDIN    WWMDO
     C                     EXSR SCONV
     C                     Z-ADDWWAMTO    PGPLEU
     C** REPLACE FOR FUTURE USE
     C                     Z-ADDWWSRI     WWSRO
     C                     Z-ADDWWDPI     WWDPO
     C                     MOVE WWMDI     WWMDO
     C                     END                                            R01168
     C*                                                                   B10574
     C** RESET PLEDGE AMOUNT TO ZERO IF UNALLOWED GENERALISED PLEDGE      B10574
     C           PGCODE    IFEQ 'GEN'                                     B10574
     C           PGALLW    ANDEQ'N'                                       B10574
     C                     Z-ADD0         PGPLED                          B10574
     C                     Z-ADD0         PGPLEU                          B10574
     C                     END                                            B10574
     C*
     C                     UPDATLBPLEGD9
     C*                                                                   R01168
     C                     END                                            R01168
     C                     END                                            R5593
     C*
     C                     READ LBPLEGL9                 69
     C*                                                                   B10575
     C***DO*NOT*SPLIT*'FIXED'*PLEDGES*?*(DUPLICATED*RECORDS*FOUND*IN******B10575
     C***BOTH*LBEXTRPD*&*LBEXCOPD;*WRONG*TOTAL*AMOUNT*FOUND*IN*LBEXTSPD)**B10575
     C***********WWCODE    IFEQ 'FXD'                              B10575 057730
     C***********          SETON                     69            B10575 057730
     C***********          END                                     B10575 057730
     C*
     C                     END
     C*
     C** UPDATE THE PORTFOLIO EXTRACT SUMMARY FILE (FOR CUSTOMER)
     C*
     C           *IN43     IFEQ '1'
     C                     EXSR #BGB
     C                     END
     C*
     C** INITIALISE ACCUMULATION FIELDS: READY FOR NEXT CUSTOMER NO
     C*
     C                     Z-ADD*ZEROS    WWTLND
     C                     Z-ADD*ZEROS    WWTPLG
     C                     Z-ADD*ZEROS    WWCMTL
     C                     Z-ADD*ZEROS    WWTEFF
     C                     Z-ADD*ZEROS    WWTPLD
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BGA      - UPDATE PORTFOLIO EXTRACT SUMMARY FILE (ISSUER) *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BGA      BEGSR
     C*
     C** ACCESS THE PORTFOLIO EXTRACT SUMMARY FILE FOR THE ISSUER
     C*
     C           PGISSB    CHAINLBEXTSL1             25
     C           *IN25     IFEQ '0'
     C*
     C** RECORD EXISTS FOR THE CUSTOMER
     C*
     C**                   ADD  PGPLED    ESTPID
     C***********PGCODE    IFEQ 'FXD'                                     B7812
     C***********          ADD  PGPLED    ESTPIU                          B7812
     C***********          ELSE                                           B7812
     C           PGCODE    IFEQ 'FXD'                                     B7874
     C           PGCODE    OREQ 'LMT'                                     37532
     C**                   ADD  PGPLED    ESTPIU                     B7874B07995
     C                     ADD  WWPLFX    ESTPIU                          B07995
     C                     ADD  WWPLFX    ESTPID
     C                     ELSE                                           B7874
     C                     ADD  WWEAMT    ESTPIU
     C                     ADD  PGPLED    ESTPID
     C                     END                                            B7874
     C***********          END                                            B7812
     C                     MOVE 'A'       ESCHTP
     C                     Z-ADDBJDNWD    ESLCD
     C                     TIME           ESTLUP
     C                     MOVE BJMRDT    WWDATE
     C*
     C** UPDATE THE PORTFOLIO EXTRACT SUMMARY FILE
     C*
     C                     UPDATLBEXTSD1
     C*
     C                     ELSE
     C*
     C** NO RECORD EXISTS FOR THE ISSUER - FORMAT FIELDS
     C*
     C**********           Z-ADDPGISSB    ESCNUM                                              CSD027
     C                     MOVE PGISSB    ESCNUM                                              CSD027
     C*
     C                     Z-ADD*ZEROS    ESTPRD
     C                     Z-ADD*ZEROS    ESTPRV
     C**                   Z-ADDPGPLED    ESTPID
     C***********PGCODE    IFEQ 'FXD'                                     B7812
     C***********          Z-ADDPGPLED    ESTPIU                          B7812
     C***********          ELSE                                           B7812
     C           PGCODE    IFEQ 'FXD'                                     B7874
     C           PGCODE    OREQ 'LMT'                                     37532
     C**                   ADD  PGPLED    ESTPIU                     B7874B07995
     C                     Z-ADDWWPLFX    ESTPID
     C                     Z-ADDWWPLFX    ESTPIU                          B07995
     C                     ELSE                                           B7874
     C                     Z-ADDPGPLED    ESTPID
     C                     Z-ADDWWEAMT    ESTPIU
     C                     END                                            B7874
     C***********          END                                            B7812
     C*
     C** ACCESS SDCUSTL0 FOR THE ISSUER
     C*
     C                     MOVE PGISSB    WWCUST  6
     C***********WWCUST    CHAINSDCUSTL0             42                   S01498
     C************IN42     IFEQ '1'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOCUSTR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*KEY    '@OPTN                           S01498
     C                     PARM WWCUST    @AENB  10                       S01498
     C                     PARM *BLANKS   @KYST   7                       S01498
     C           SDCUST    PARM SDCUST    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD5         DBASE            ***************
     C***********          MOVEL'SDCUSTL0'DBFILE           * DBERROR 005 *S01498
     C                     MOVE 'SDCUSTPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELWWCUST    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     END
     C*
     C** FORMAT REMAINING FIELDS
     C*
     C                     MOVE 'D'       ESRECI
     C*
     C                     Z-ADD*ZEROS    ESOWEX
     C                     Z-ADD*ZEROS    ESOWCO
     C                     Z-ADD*ZEROS    ESLPWR
     C                     Z-ADD*ZEROS    ESTACD
     C                     Z-ADD*ZEROS    ESTACC
     C*
     C                     Z-ADD*ZEROS    ESTLMT
     C                     MOVE *BLANKS   ESCIFL
     C                     MOVE BBPCNB    ESPCNB
     C*
     C                     MOVE 'I'       ESCHTP
     C                     Z-ADDBJDNWD    ESORED
     C                     Z-ADDBJDNWD    ESLCD
     C                     TIME           ESTLUP
     C                     MOVE BJMRDT    WWDATE
     C*
     C** WRITE RECORDS TO LBEXTSPD
     C** COUNT OF NO. OF RECORDS WRITTEN TO LBEXTSPD
     C*
     C                     WRITELBEXTSD0
     C*
     C*********************ADD  1         RREXTR                          R01168
     C                     ADD  1         RREXTS                          R01168
     C*
     C                     END
     C*
     C** INITIALISE EFFECTIVE AMOUNT FIELD FOR NEXT ISSUER
     C*
     C                     Z-ADD*ZEROS    WWEAMT
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BGB      - UPDATE PORTFOLIO EXTRACT SUMMARY FILE (CUSTOMER)
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #BC                                            *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BGB      BEGSR
     C*
     C** ACCESS THE PORTFOLIO EXTRACT SUMMARY FILE FOR THE CUSTOMER
     C*
     C           WWCNUM    CHAINLBEXTSL1             25
     C           *IN25     IFEQ '0'
     C*
     C** RECORD EXISTS FOR THE CUSTOMER
     C*
     C                     ADD  WWTPLD    ESTPRD
     C                     ADD  WWTEFF    ESTPRV
     C                     MOVE 'A'       ESCHTP
     C                     Z-ADDBJDNWD    ESLCD
     C                     TIME           ESTLUP
     C                     MOVE BJMRDT    WWDATE
     C*
     C** UPDATE THE PORTFOLIO EXTRACT SUMMARY FILE
     C*
     C                     UPDATLBEXTSD1
     C*
     C                     ELSE
     C*
     C** ACCESS LBCOMAL2 FOR THE COMMITMENT LINE AMOUNT
     C*
     C***********KL6       SETGTLBCOMAL2                                  094908
     C           KL6       SETLLLBCOMAL2                                  094908
     C                     READ LBCOMAL2                 26
     C*
     C** CHECK IF ACTIVE COMMITMENT LINE
     C*
     C           *IN26     IFEQ '0'
     C           WWCNUM    ANDEQCACNUM
     C***********BJRDNB****ANDGECASTTD                                    001313
     C***********BJRDNB****ANDLECAEXPD                                    001313
     C           BJDNWD    ANDGECASTTD                                    001313
     C           BJDNWD    ANDLECAEXPD                                    001313
     C                     Z-ADDCACMTL    ESCMTL
     C                     ELSE                                           B07970
     C                     Z-ADD0         ESCMTL                          B07970
     C                     Z-ADD0         CACMTL                          B07970
     C                     END
     C*
     C** NO RECORD EXISTS FOR THE CUSTOMER - FORMAT FIELDS
     C*
     C**********           Z-ADDWWCNUM    ESCNUM                                              CSD027
     C                     MOVE WWCNUM    ESCNUM                                              CSD027
     C*
     C                     Z-ADDWWTPLD    ESTPRD
     C                     Z-ADDWWTEFF    ESTPRV
     C                     Z-ADD*ZEROS    ESTPID
     C                     Z-ADD*ZEROS    ESTPIU
     C*
     C** FORMAT REMAINING FIELDS
     C*
     C                     MOVE 'D'       ESRECI
     C*
     C                     Z-ADD*ZEROS    ESOWEX
     C                     Z-ADD*ZEROS    ESOWCO
     C                     Z-ADD*ZEROS    ESLPWR
     C                     Z-ADD*ZEROS    ESTACD
     C                     Z-ADD*ZEROS    ESTACC
     C*
     C                     Z-ADD*ZEROS    ESTLMT
     C                     MOVE *BLANKS   ESCIFL
     C                     MOVE BBPCNB    ESPCNB
     C*
     C                     MOVE 'I'       ESCHTP
     C                     Z-ADDBJDNWD    ESORED
     C                     Z-ADDBJDNWD    ESLCD
     C                     TIME           ESTLUP
     C                     MOVE BJMRDT    WWDATE
     C*
     C** WRITE RECORDS TO LBEXTSPD
     C** COUNT OF NO. OF RECORDS WRITTEN TO LBEXTSPD
     C*
     C                     WRITELBEXTSD0
     C*
     C*********************ADD  1         RREXTR                          R01168
     C                     ADD  1         RREXTS                          R01168
     C*
     C                     END
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #BGC      - UPDATE PORTFOLIO EXTRACT DETAIL FILE           *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY -                                                *
     C**                                                              *
     C*****************************************************************
     C*
     C           #BGC      BEGSR
     C*
     C*  IF PARENTS ARE THE SAME (IE INTRA-FAMILY PLEDGE), UPDATE         R0986
     C*  THE RECORD WITHOUT PARENT DETAILS.                               R0986
     C*  IF NOT UPDATE THE RECORD WITH PARENT DETAILS                     R0986
     C           ISSPAR    IFNE CUSPAR                                    R0986
     C           WWEXTT    IFEQ 'C'                                       R0986
     C                     MOVE CUSPAR    KCUST                           R0986
     C                     ELSE                                           R0986
     C                     MOVE ISSPAR    KCUST                           R0986
     C                     END                                            R0986
     C                     ELSE                                           R0986
     C                     MOVE *BLANKS   KCUST                           R0986
     C                     END                                            R0986
     C*                                                                   R0986
     C**         KL7       CHAINLBEXTRL2             44                   R0986
     C           KL7       CHAINLBEXTRLC             44                   R0986
     C*
     C                     MOVE BJMRDT    WWDATE
     C                     Z-ADDBJDNWD    EELCD
     C                     TIME           EETLUP
     C*
     C           *IN44     IFEQ '0'
     C*
     C** UPDATE EXISTING RECORD
     C                     MOVE 'A'       EECHTP
     C*
     C** IF CUSTOMER RECORD
     C           WWEXTT    IFEQ 'C'
     C*
     C** COLLATERAL = EXISTING COLLATERAL + EFFECTIVE AMOUNT
     C           PGCODE    IFEQ 'FXD'                                     B8002
     C           PGCODE    OREQ 'LMT'                                     37532
     C           EECOLL    ADD  WWPLFX    EECOLL                          B8002
     C           EEBPWR    ADD  WWPLFX    EEBPWR                          B8002
     C                     ELSE                                           B8002
     C           EECOLL    ADD  PGPLEU    EECOLL
     C           EEBPWR    ADD  PGPLEU    EEBPWR                          B7874
     C                     END                                            B8002
     C                     ELSE
     C*
     C** IF ISSUER
     C*
     C**  EXPOSURE = EXISTING EXPOSURE + 'EXPOSURE'
     C** 'EXPOSURE' = EFFECTIVE AMOUNT IF PGCODE <> 'FIX'
     C** 'EXPOSURE' = AMOUNT WHICH IS PLEDGED IF PGCODE = 'FIX'
     C***********PGCODE    IFEQ 'FIX'                                     B7812
     C***********EEEXPS    ADD  PGPLED    EEEXPS                          B7812
     C***********          ELSE                                           B7812
     C           PGCODE    IFEQ 'FXD'                                     B7874
     C           PGCODE    OREQ 'LMT'                                     37532
     C**         EEEXPS    ADD  PGPLED    EEEXPS                     B7874B07995
     C           EEEXPS    ADD  WWPLFX    EEEXPS                          B07995
     C                     ELSE                                           B7874
     C           EEEXPS    ADD  PGPLEU    EEEXPS
     C                     END                                            B7874
     C***********          END                                            B7812
     C*
     C                     END
     C*
     C*
     C                     UPDATLBEXTRD0
     C*
     C                     ELSE
     C*
     C**  ADD NEW RECORD
     C*
     C****GET GROUP CODE FOR PREDEFINED INSTRUMENT                        R01168
     C***********LBPLEG    CHAINSDPLINL4             45                   R01168
     C************IN45     IFEQ '1'                                       R01168
     C**************       Z-ADD6         DBASE            ***************R01168
     C**************       MOVEL'SDPLINL4'DBFILE           * DBERROR 006 *R01168
     C**************       MOVE *BLANKS   DBKEY            *             *R01168
     C**************       MOVELLBPLEG    DBKEY            ***************R01168
     C**************       EXSR #ZA                                       R01168
     C**************       END                                            R01168
     C**************                                                      R01168
     C****GET GROUP SEQUENCE                                              R01168
     C***********PDLOMG    CHAINLBGROUL1             46                   R01168
     C************IN46     IFEQ '1'                                       R01168
     C**************       Z-ADD7         DBASE            ***************R01168
     C**************       MOVEL'LBGROUL1'DBFILE           * DBERROR 007 *R01168
     C**************       MOVE *BLANKS   DBKEY            *             *R01168
     C**************       MOVELPDLOMG    DBKEY            ***************R01168
     C**************       EXSR #ZA                                       R01168
     C**************       END                                            R01168
     C*
     C*   GET PARENT NUMBER
     C*   NO LONGER NEEDED AS PARENTS ALREADY FOUND                       R0986
     C**                   MOVE WWPNP8    WWCUSK  6                       R0986
     C**         WWCUSK    CHAINSDLBCSL0             47                   R0986
     C*******    *IN47     IFEQ '1'                                       LB0000
     C*******              Z-ADD8         DBASE            ***************LB0000
     C*******              MOVEL'SDLBCSL0'DBFILE           * DBERROR 008 *LB0000
     C*******              MOVE *BLANKS   DBKEY            *             *LB0000
     C*******              MOVELWWCUSK    DBKEY            ***************LB0000
     C*******              EXSR #ZA                                       LB0000
     C*******              END                                            LB0000
     C*
     C*
     C                     MOVE 'D'       EERECI
     C                     Z-ADDBJDNWD    EEORED
     C                     MOVE 'I'       EECHTP
     C*
     C**********           Z-ADDWWPNP8    EECNUM                                              CSD027
     C                     MOVE WWPNP8    EECNUM                                              CSD027
     C                     MOVE LBPLEG    EEINST
     C                     MOVE PGCCY     EECCY
     C*
     C*
     C                     Z-ADD0         EELIMT
     C                     Z-ADD0         EEACCD
     C                     Z-ADD0         EEACCC
     C                     MOVE *BLANKS   EESESN
     C                     Z-ADD0         EECLPC
     C                     Z-ADD0         EESEPC
     C                     Z-ADD0         EEINPC
     C                     Z-ADD0         EECTPC
     C**************       MOVE GPLCGR    EELCGR                          R01168
     C**************       Z-ADDGPLCGS    EELCGS                          R01168
     C                     MOVE WWLCGR    EELCGR                          R01168
     C                     Z-ADDWWLCGS    EELCGS                          R01168
     C***********          Z-ADD0         EEBPWR                          B7874
     C***********          MOVE 0         EEBPWR                          B7874
     C**                                                                  R0986
     C**  IF INTRA-FAMILY PLEDGE, DO NOT OUTPUT PARENT NUMBER             R0986
     C**                   MOVE BBPCNB    EEPCNB                          R0986
     C           ISSPAR    IFEQ CUSPAR                                    R0986
     C                     MOVE *BLANKS   EEPCNB                          R0986
     C                     ELSE                                           R0986
     C           WWEXTT    IFEQ 'C'                                       R0986
     C                     MOVE CUSPAR    EEPCNB                          R0986
     C                     ELSE                                           R0986
     C                     MOVE ISSPAR    EEPCNB                          R0986
     C                     END                                            R0986
     C                     END                                            R0986
     C                     MOVE *BLANKS   EECIFL
     C*
     C** IF CUSTOMER RECORD
     C           WWEXTT    IFEQ 'C'
     C                     Z-ADD0         EEEXPS
     C*
     C** COLLATERAL = EFFECTIVE AMOUNT
     C           PGCODE    IFEQ 'FXD'                                     B8002
     C           PGCODE    OREQ 'LMT'                                     37532
     C                     Z-ADDWWPLFX    EECOLL                          B8002
     C                     Z-ADDWWPLFX    EEBPWR                          B8002
     C                     ELSE                                           B8002
     C                     Z-ADDPGPLEU    EECOLL
     C                     Z-ADDPGPLEU    EEBPWR                          B7874
     C                     END                                            B8002
     C                     ELSE
     C*
     C** IF ISSUER
     C                     Z-ADD0         EECOLL
     C                     Z-ADD0         EEBPWR                          B7874
     C*
     C** 'EXPOSURE' = EFFECTIVE AMOUNT IF PGCODE <> 'FIX'
     C** 'EXPOSURE' = AMOUNT WHICH IS PLEDGED IF PGCODE = 'FIX'
     C***********PGCODE    IFEQ 'FIX'                                     B7812
     C***********          Z-ADDPGPLED    EEEXPS                          B7812
     C***********          ELSE                                           B7812
     C           PGCODE    IFEQ 'FXD'                                     B7874
     C           PGCODE    OREQ 'LMT'                                     37532
     C**                   Z-ADDPGPLED    EEEXPS                     B7874B07995
     C                     Z-ADDWWPLFX    EEEXPS                          B07995
     C                     ELSE                                           B7874
     C                     Z-ADDPGPLEU    EEEXPS
     C                     END                                            B7874
     C***********          END                                            B7812
     C*
     C                     END
     C*
     C                     WRITELBEXTRD0
     C*                                                                   R01168
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO LBEXTRPD                    R01168
     C                     ADD  1         RREXTR                          R01168
     C*
     C                     END
     C*
     C*
     C                     ENDSR
     C/EJECT                                                              R01168
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**   #BGD      - PERFORMS CALCULATIONS TO WRITE RECORD TO       *   R01168
     C**             - NEW EXTRACT FILE LBEXCOPD                      *   R01168
     C**                                                              *   R01168
     C**   CALLS     - #BGDA                                          *   R01168
     C**                                                              *   R01168
     C**   CALLED BY - #BG                                            *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C*                                                                   R01168
     C           #BGD      BEGSR                                          R01168
     C           WWEXTT    IFEQ 'C'                                       R01168
     C**********           Z-ADDPGCNUM    EXCNUM                                       R01168 CSD027
     C                     MOVE PGCNUM    EXCNUM                                              CSD027
     C                     MOVE 'C'       EXEXCO                          R01168
     C           PGCODE    IFEQ 'FXD'                                     B08002
     C           PGCODE    OREQ 'LMT'                                     37532
     C                     Z-ADDWWPLFX    EXAMNT                          B08002
     C                     ELSE                                           B08002
     C                     Z-ADDPGPLEU    EXAMNT                          R01168
     C                     END                                            B08002
     C**********           Z-ADDPGISSB    WWISCN                                       R01168 CSD027
     C                     MOVE PGISSB    WWISCN                                              CSD027
     C                     MOVE WWXREF    EXREF                           R01168
     C*                                                                   R01168
     C           CUSPAR    IFEQ ISSPAR                                    R01168
     C                     MOVE *BLANKS   EXPCNB                          R01168
     C                     ELSE                                           R01168
     C                     MOVE CUSPAR    EXPCNB                          R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C                     ELSE                                           R01168
     C*                                                                   R01168
     C**********           Z-ADDPGISSB    EXCNUM                                       R01168 CSD027
     C                     MOVE PGISSB    EXCNUM                                              CSD027
     C                     MOVE 'E'       EXEXCO                          R01168
     C**********           Z-ADDPGCNUM    WWISCN                                       R01168 CSD027
     C                     MOVE PGCNUM    WWISCN                                              CSD027
     C                     MOVE WWXREF    EXREF                           R01168
     C*                                                                   R01168
     C           CUSPAR    IFEQ ISSPAR                                    R01168
     C                     MOVE *BLANKS   EXPCNB                          R01168
     C                     ELSE                                           R01168
     C                     MOVE ISSPAR    EXPCNB                          R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C***********PGCODE    IFEQ 'FIX'                              R01168 B7812
     C***********          Z-ADDPGPLED    EXAMNT                   R01168 B7812
     C***********          ELSE                                    R01168 B7812
     C           PGCODE    IFEQ 'FXD'                              B7874  B08002
     C           PGCODE    OREQ 'LMT'                                     37532
     C**                   Z-ADDPGPLED    EXAMNT                     B7874B07995
     C**                   Z-ADDPGPLED    EXAMNT                   B07995 B08002
     C                     Z-ADDWWPLFX    EXAMNT                   B07995 B08002
     C                     ELSE                                    B7874  B08002
     C                     Z-ADDPGPLEU    EXAMNT                          R01168
     C                     END                                     B7874  B08002
     C***********          END                                     R01168 B7812
     C*                                                                   R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS AND WRITE A RECORD TO LBEXCOPD           R01168
     C                     EXSR #BGDA                                     R01168
     C*                                                                   R01168
     C** ADD 1 TO COUNT OF RECORDS WRITTEN TO LBEXCOPD                    R01168
     C                     ADD  1         RREXCO                          R01168
     C*                                                                   R01168
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT                                                              R01168
     C*****************************************************************   R01168
     C**                                                              *   R01168
     C**    #BGDA        - THIS SUBROUTINE WRITES RECORDS TO NEW      *   R01168
     C**                   EXTRACT FILE LBEXCOPD                      *   R01168
     C**                                                              *   R01168
     C**    CALLS        - NONE                                       *   R01168
     C**                                                              *   R01168
     C**    CALLED BY    - #BGD                                       *   R01168
     C**                                                              *   R01168
     C*****************************************************************   R01168
     C           #BGDA     BEGSR                                          R01168
     C*                                                                   R01168
     C** SET UP REMAINING FIELDS                                          R01168
     C                     MOVE 'D'       EXRECI                          R01168
     C                     Z-ADDWWDAY     EXDLUP                          R01168
     C                     MOVE WWMNTH    EXMLUP                          R01168
     C                     Z-ADDWWYEAR    EXYLUP                          R01168
     C                     TIME           EXTLUP                          R01168
     C                     Z-ADDBJRDNB    EXORED                          R01168
     C                     MOVE '80'      EXREGE                          R01168
     C                     MOVE WWLCGR    EXLCGR                          R01168
     C                     Z-ADDWWLCGS    EXLCGS                          R01168
     C                     MOVE LBPLEG    EXINST                          R01168
     C                     MOVE PGCCY     EXCCY                           R01168
     C                     Z-ADD0         EXDDAT                          R01168
     C                     Z-ADD0         EXVDAT                          R01168
     C                     Z-ADD0         EXMDAT                          R01168
     C                     Z-ADD0         EXRLDT                          R01168
     C*                                                                   R01168
     C** WRITE A RECORD TO NEW EXTRACT FILE LBEXCOPD                      R01168
     C                     WRITELBEXCOPF                                  R01168
     C                     ENDSR                                          R01168
     C*****************************************************************   R01168
     C/EJECT                                                              LB0003
     C*****************************************************************   LB0003
     C**                                                              *   LB0003
     C**   #BH       - UPDATE TOTAL OF PLEDGES RECEIVED               *   LB0003
     C**                                                              *   LB0003
     C**   CALLS     - NONE                                           *   LB0003
     C**                                                              *   LB0003
     C**   CALLED BY - #B                                             *   LB0003
     C**                                                              *   LB0003
     C*****************************************************************   LB0003
     C*                                                                   LB0003
     C           #BH       BEGSR                                          LB0003
     C*                                                                   LB0003
     C** READ PLEDGES DETAIL FILE                                         LB0003
     C*                                                                   LB0003
     C**********           Z-ADD*ZEROS    WWISSB  60                             LB0003 R5593 CSD027
     C                     MOVE *BLANKS   WWISSB  6                                           CSD027
     C           *LOVAL    SETLLLBPLEGL4                                  LB0003
     C                     READ LBPLEGL4                 35               LB0003
     C*                                                                   LB0003
     C** LOOP WHILE NOT END OF FILE                                       LB0003
     C*                                                                   LB0003
B1   C           *IN35     DOWEQ'0'                                       LB0003
     C*                                                                   LB0003
     C** SAVE PLEDGE RECEIVED                                             LB0003
     C*                                                                   LB0003
     C                     Z-ADDPGPLED    SAVPLE 130                      LB0003
     C*                                                                   LB0003
     C** RETRIEVE ISSUER'S AVAILABLE LENDING                              LB0003
     C*                                                                   LB0003
B2   C           PGISSB    IFNE WWISSB                                    LB0003
     C**********           MOVE PGISSB    WWISSB  60                                   LB0003 CSD027
     C                     MOVE PGISSB    WWISSB  6                                           CSD027
     C*                                                                   LB0003
     C                     EXSR #BA                                       LB0003
     C*                                                                   LB0003
E2   C                     END                                            LB0003
     C*                                                                   LB0003
     C***ADJUST PLEDGE RECEIVED AMOUNT                                    LB0003
     C******DEPENDING OF ISSUER'S AVAILABLE LENDING                       LB0003
     C***********                                                         LB0003
     C***********WWLEND    IFLE 0                                         LB0003
     C***********          Z-ADDPGPLEU    PGPLED                          LB0003
     C***********          ELSE                                           LB0003
     C***********WWLEND    ADD  PGPLEU    PGPLED                          LB0003
     C***********                                                         LB0003
     C*                                                                   B10574
     C** RESET PLEDGE AMOUNT TO ZERO IF UNALLOWED GENERALISED PLEDGE      B10574
     C           PGCODE    IFEQ 'GEN'                                     B10574
     C           PGALLW    ANDEQ'N'                                       B10574
     C                     Z-ADD0         PGPLED                          B10574
     C                     Z-ADD0         PGPLEU                          B10574
     C                     END                                            B10574
     C*                                                                   LB0003
     C** UPDAT PLEDGE RECORD                                              LB0003
     C*                                                                   LB0003
     C                     UPDATLBPLEGD4                                  LB0003
     C*                                                                   LB0003
     C** UPDAT PORTFOLIO EXTRACT SUMMARY RECORD FOR THE CUSTOMER          LB0003
     C*                                                                   LB0003
     C           WWPGRE    IFGT 0                                         LB0003
     C*                                                                   LB0003
     C           PGCNUM    CHAINLBEXTSL1             25                   LB0003
     C           *IN25     IFEQ '0'                                       LB0003
     C*                                                                   LB0003
     C           SAVPLE    SUB  PGPLED    WWPGRE 130                      LB0003
     C                     SUB  WWPGRE    ESTPRD                          LB0003
     C*                                                                   LB0003
     C                     UPDATLBEXTSD1                                  LB0003
     C*                                                                   LB0003
     C                     END                                            LB0003
     C                     END                                            LB0003
     C*                                                                   LB0003
     C** READ NEXT RECORD ON LBPLEGL4                                     LB0003
     C*                                                                   LB0003
     C                     READ LBPLEGL4                 35               LB0003
     C*                                                                   LB0003
     C                     END                                            LB0003
     C*                                                                   LB0003
     C                     ENDSR                                          LB0003
     C*                                                                   LB0003
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #C        - TERMINATION PROCESS                            *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #C        BEGSR
     C*
     C                     SETOF                     36
     C*                                                                  R00308
     C************IN50     IFEQ '0'                                 R00308S01498
     C***********          WRITEHEADER0                             R00308S01498
     C***********          WRITENULL0                               R00308S01498
     C***********          END                                      R00308S01498
     C*                                                                   S01498
     C           *IN50     IFEQ '1'                                       S01498
     C                     WRITEFOOTING0                                 R00308
     C                     CLOSELB0680P1                                  S01498
     C                     END                                            S01498
     C*
     C** Print 'No Details to Report' If no missing instruments
     C*
     C***********WWPRNT    IFEQ *ZEROS                                    S01498
     C***********          WRITEHEADER1                                   S01498
     C***********          WRITEHEADER2                                   S01498
     C***********          WRITENULL1                                     S01498
     C***********          WRITEFOOTING1                                  S01498
     C***********          ELSE                                           S01498
     C*
     C           *IN31     IFEQ '1'                                       S01498
     C           LINE1     IFGT 55
     C                     WRITEHEADER1
     C                     WRITEHEADER2
     C                     END
     C*
     C                     WRITEFOOTING1
     C                     CLOSELB0680P2                                  S01498
     C                     END
     C*
     C** PRODUCE RUN CONTROLS
     C*
     C                     WRITEHDRCTRL1
     C                     WRITEDTRCTRL1
     C*                                                                   S01498
     C           *IN31     IFEQ '0'                                       S01498
     C           *IN50     ANDEQ'0'                                       S01498
     C                     WRITELB0680AN                                  S01498
     C                     END                                            S01498
     C*
     C                     ENDSR
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #A        - THIS SUBROUTINE PERFORMS INTIAL PROCESSING     *
     C**                                                              *
     C**   CALLS     - #ZA                                            *
     C**                                                              *
     C**   CALLED BY - MAINLINE                                       *
     C**                                                              *
     C*****************************************************************
     C*
     C           #A        BEGSR
     C*                                                                   S01498
     C**  Copyright statement                                             S01498
     C*                                                                   S01498
     C                     MOVEACPY@      ACT@   80                       S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           LDA                             S01498
     C           *LOCK     IN   LDA                                       S01498
     C*                                                                   S01498
     C           *NAMVAR   DEFN           RUNDAT                          S01498
     C                     IN   RUNDAT                                    S01498
     C           AGMBIN    IFEQ 'Y'                                       S01498
     C                     MOVE '1'       *IN46                           S01498
     C                     END                                            S01498
     C*
     C** SRT OF ALL INDICATORS
     C*
     C                     MOVEA'00000000'*IN,21
     C                     MOVEA'00000000'*IN,29
     C                     MOVEA'000'     *IN,37
     C                     MOVEA'00000000'*IN,71
     C                     MOVE '0'       *IN98
     C*
     C*
     C**   INITIALISE DB ERROR FIELDS AND STORE PROGRAM NAME FOR
     C**   DB ERROR FIELD.
     C*
     C           *LOCK     IN   LDA                                       S01498
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'LB0680'  DBPGM
     C                     OUT  LDA                                       S01498
     C*                                                                   S01498
     C** CALL ZSFILE FOR AUDIT REPORT                                     S01498
     C*                                                                   S01498
     C                     EXSR RCFAU                                     S01498
     C*
     C**   ACCESS ICD RECORD 1 TO GET RUN DATE & TITLE
     C*
     C***********1         SETLLSDBANKPD                                  S01498
     C***********          READ SDBANKPD                 23               S01498
     C*****************************************************************   S01498
     C*****IF*RECORD*NOT*FOUND*OR*LAST-CHANGE-TYPE*=*'D'*(DELETED)*****   S01498
     C*****************************************************************   S01498
     C************IN23     IFEQ '1'                                       S01498
     C***********BJTYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOBANKR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD   7                       S01498
     C                     PARM '*FIRST'  @OPTN   7                       S01498
     C           SDBANK    PARM SDBANK    DSFDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD1         DBASE            ***************
     C***********          MOVEL'SDBANKPD'DBFILE           * DBERROR 001 *S01498
     C                     MOVE 'SDBANKPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     OUT  LDA                        ***************S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** EVENT CONTROL DATE = DATE OF NEXT WORKING DAY MINUS 1
     C*
     C           BJDNWD    SUB  1         BJDNWD
     C                     MOVE BJMRDT    EXDATE                          S01498
     C                     END
     C*
     C** ACCESS PORTFOLIO LENDING ICD TO GET PORTFOLIO LENDING CURRENCY
     C*
     C***********1         SETLLSDLOMBPD                                  S01498
     C***********          READ SDLOMBPD                 23               S01498
     C******************************************************************  S01498
     C***IF*RECORD*NOT*FOUND*OR*RECORD-ID*=*'*'*THEN*DB*ERROR***********  S01498
     C******************************************************************  S01498
     C************IN23     IFEQ '1'                                       S01498
     C***********LBRECI    OREQ '*'                                       S01498
     C***********LBPLEG    OREQ *BLANKS                                   S01498
     C*                                                                   S01498
     C                     CALL 'AOLOMBR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*FIRST'  @OPTN                           S01498
     C           SDLOMB    PARM SDLOMB    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANK                                    S01498
     C           LBPLEG    OREQ *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD2         DBASE            ***************
     C***********          MOVEL'SDLOMBPD'DBFILE           * DBERROR 002 *S01498
     C                     MOVE 'SDLOMBPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     OUT  LDA                        ***************S01498
     C                     EXSR #ZA
     C                     END
     C*                                                                   R01168
     C*   ACCESS INSTRUMENT TYPES FILE                                    R01168
     C***********LBPLEG    CHAINSDPLINL4             45             R01168S01498
     C************IN45     IFEQ '1'                                 R01168S01498
     C*                                                                   S01498
     C                     CALL 'AOPLINR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*KEY   ' @OPTN                           S01498
     C                     PARM LBPLEG    @AJCD   3                       S01498
     C           SDPLIN    PARM SDPLIN    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD6         DBASE            ***************R01168
     C***********          MOVEL'SDPLINL4'DBFILE           *        R01168S01498
     C                     MOVE 'SDPLINPD'DBFILE           * DBERROR 006 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *R01168
     C                     MOVELLBPLEG    DBKEY            ***************R01168
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R01168
     C                     END                                            R01168
     C*                                                                   R01168
     C*   ACCESS GROUPS FILE TO GET GROUPS SEQUENCE                       R01168
     C***********PDLOMG    CHAINLBGROUL1             46             R01168S01498
     C************IN46     IFEQ '1'                                 R01168S01498
     C*                                                                   S01498
     C                     CALL 'AOGROUR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*KEY   ' @OPTN                           S01498
     C                     PARM PDLOMG    @AJCD                           S01498
     C           LBGROU    PARM LBGROU    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD7         DBASE            ***************R01168
     C***********          MOVEL'LBGROUL1'DBFILE           *        R01168S01498
     C                     MOVE 'LBGROUPD'DBFILE           * DBERROR 007 *S01498
     C                     MOVE *BLANKS   DBKEY            *             *R01168
     C                     MOVELPDLOMG    DBKEY            ***************R01168
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA                                       R01168
     C                     END                                            R01168
     C*
     C** ACCESS CURRENCY CODES FILE FOR NUMBER OF DECIMAL PLACES / SPOT
     C** RATE / CURRENCY (PORTFOLIO LENDING CURRENCY)
     C*
     C***********LBCCY     CHAINSDCURRL1             69                   S01498
     C*****************************************************************   S01498
     C***IF*RECORD*NOT*FOUND*OR*LAST*CHANGE*TYPE*=*'D'*THEN*DB*ERROR***   S01498
     C*****************************************************************   S01498
     C************IN69     IFEQ '1'                                       S01498
     C***********A6TYLC    OREQ 'D'                                       S01498
     C*                                                                   S01498
     C                     CALL 'AOCURRR0'                                S01498
     C                     PARM 'BLANKS'  @RTCD                           S01498
     C                     PARM '*KEY   ' @OPTN                           S01498
     C                     PARM LBCYCD    @AJCD                           S01498
     C           SDCURR    PARM SDCURR    DSSDY                           S01498
     C*                                                                   S01498
     C           @RTCD     IFNE *BLANKS                                   S01498
     C           *LOCK     IN   LDA                                       S01498
     C                     Z-ADD3         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DBERROR 003 *S01498
     C                     MOVE 'SDCURRPD'DBFILE           *             *S01498
     C                     MOVE *BLANKS   DBKEY            *             *
     C                     MOVELLBCYCD    DBKEY            ***************
     C                     OUT  LDA                                       S01498
     C                     EXSR #ZA
     C                     ELSE
     C*
     C** SAVE SPOT RATE / NO. OF DECIMAL PLACES / MULT/DIV INDICATOR
     C** FOR ROUTINE #SCONV
     C*
     C                     Z-ADDA6SPRT    WWSRO
     C                     Z-ADDA6NBDP    WWDPO
     C                     MOVE A6MDIN    WWMDO
     C                     END
     C*
     C**   DEFINE WORK FIELDS
     C*
     C           *LIKE     DEFN EECNUM    WWPNP8
     C***        *LIKE     DEFN EEINST    WWCCY                           B10575
     C***        *LIKE     DEFN EECCY     WWINST                          B10575
     C           *LIKE     DEFN EECCY     WWCCY                           B10575
     C           *LIKE     DEFN PGCODE    WWCODE                          B10575
     C           *LIKE     DEFN CNUM      WWCNUM                          LB0000
     C           *LIKE     DEFN WWCNUM    WWTEMP
     C           *LIKE     DEFN WWBPSN    WWBPTE                          055763
     C           *LIKE     DEFN WWSEQN    WWSETE                          055763
     C           *LIKE     DEFN RRPLEG    WWPRNT
     C           *LIKE     DEFN WWPRNT    WWSLCT
     C           *LIKE     DEFN ESLPWR    WWBPWR
     C********** *LIKE     DEFN ESTPRV    WWEAMT                          B5751
     C********** *LIKE     DEFN ESTPRV    WWAMTT                    R5593 B5751
     C           *LIKE     DEFN WWBPWR    WWEXPS                          LB0000
     C           *LIKE     DEFN ESTPIU    WWLEND
     C           *LIKE     DEFN ESTPRD    WWPLED                          LB0000
     C           *LIKE     DEFN WWEXPS    WWTEXP
     C           *LIKE     DEFN WWLEND    WWTLND
     C           *LIKE     DEFN WWPLED    WWTPLG
     C           *LIKE     DEFN WWTPLG    WWLESS
     C           *LIKE     DEFN CACMTL    WWCMTL
     C           *LIKE     DEFN ESTPRV    WWTEFF                          LB0000
     C           *LIKE     DEFN ESTPRD    WWTPLD
     C           *LIKE     DEFN GPLCGR    WWLCGR                          R01168
     C           *LIKE     DEFN GPLCGS    WWLCGS                          R01168
     C           *LIKE     DEFN PGPLED    XXPLED                          066036
     C*                                                                   B5751
     C                     Z-ADD*ZEROS    WWEAMT 152                      B5751
     C                     Z-ADD*ZEROS    WWAMTT 152                R5593 B5751
     C*                                                                   R01168
     C** SET UP WORK FIELDS FOR PORTFOLIO LENDING GROUP CODE              R01168
     C** AND SEQUENCE                                                     R01168
     C                     MOVE GPLCGR    WWLCGR                          R01168
     C                     Z-ADDGPLCGS    WWLCGS                          R01168
     C*
     C**   INITIALISE COUNTER ACCUMULATION VARIABLES
     C*
     C                     Z-ADD*ZEROS    RREXTR
     C                     Z-ADD*ZEROS    RREXCO                          R01168
     C                     Z-ADD*ZEROS    RREXTS                          R01168
     C                     Z-ADD*ZEROS    RRPLEG
     C*
     C**   INITIALISE TOTALS WORK FIELD
     C*
     C                     Z-ADD*ZEROS    WWEXPS
     C*
     C**   INITIALISE LINE COUNT
     C*
     C                     Z-ADD*ZEROS    LINE1
     C*
     C                     MOVE '0'       *IN50                          R00308
     C*                                                                  R00308
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C**  SCONV - Converts an amount from one currency to another.       *
     C**                                                                 *
     C**  Input Fields - WWAMTI 15/0 amount in input currency            *
     C**                 WWSRI  13/8 spot rate for input currency        *
     C**                 WWSRO  13/8 spot rate for output currency       *
     C**                 WWDPI  1/0  no. of decimals for input currency  *
     C**                 WWDPO  1/0  no. of decimals for output currency *
     C**                 WWMDI  1    mult/div indicator for input curr.  *
     C**                 WWMDO  1    mult/div indicator for output curr. *
     C**                                                                 *
     C**  Arrays       - POWER  powers of 10                             *
     C**                                                                 *
     C**  Output Fields- WWAMTO 15/0 output amount converted to new curr *
     C**                                                                 *
     C**  CALLS    - NONE                                                *
     C**                                                                 *
     C********************************************************************
     C           SCONV     BEGSR                           **  SCONV    **
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDWWAMTI    WWAMTI 150
     C                     Z-ADD0         WWAMTO 150
     C           *LIKE     DEFN A6SPRT    WWSRI
     C           *LIKE     DEFN A6SPRT    WWSRO
     C           *LIKE     DEFN A6NBDP    WWDPI
     C           *LIKE     DEFN A6NBDP    WWDPO
     C           *LIKE     DEFN A6MDIN    WWMDI
     C           *LIKE     DEFN A6MDIN    WWMDO
     C*
     C           WWDPO     SUB  WWDPI     Z       10
     C           Z         ADD  4         Z
     C*
     C           WWMDI     IFNE WWMDO
     C*
     C** MULT/DIV INDICATORS DIFFERENT
     C           WWSRI     MULT WWSRO     WWRATE 159H
     C                     ELSE
     C*
     C** MULT/DIV INDICATORS THE SAME
     C           WWSRO     IFEQ 0
     C                     GOTO SC0
     C                     END
     C           WWSRI     DIV  WWSRO     WWRATE    H
     C                     END
     C*
     C           WWMDI     IFEQ 'D'
     C           WWRATE    IFEQ 0
     C                     GOTO SC0
     C                     END
     C           POWER,Z   DIV  WWRATE    WWRATE    H
     C                     ELSE
     C           POWER,Z   MULT WWRATE    WWRATE    H
     C                     END
     C*
     C           WWAMTI    MULT WWRATE    WWAMTO    H
     C*
     C           SC0       ENDSR                           **  SC0      **
     C/EJECT                                                              S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C*  RCFP1 -- SUBROUTINE TO REGISTER P1 PRINTER FILE VIA RCF          S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C           RCFP1     BEGSR                            ** RCFP1 **   S01498
     C*                                                                   S01498
     C** ENSURE REPORT SPOOL FILE RECORDED BY RCF                         S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUM1    SFNUM   60                      S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ     5                       S01498
     C                     PARM *BLANKS   SENTY   3                       S01498
     C                     PARM           SFILE1                          S01498
     C                     PARM           SFNUM                           S01498
     C                     PARM           ZSERR   1                       S01498
     C*                                                                   S01498
     C** ERROR IN ZSFILE PROCESSING                                       S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ENDSR                                          S01498
     C*****************************************************************   S01498
     C/EJECT                                                              S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C*  RCFP2 -- SUBROUTINE TO REGISTER P2 PRINTER FILE VIA RCF          S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C           RCFP2     BEGSR                            ** RCFP1 **   S01498
     C*                                                                   S01498
     C** ENSURE REPORT SPOOL FILE RECORDED BY RCF                         S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUM2    SFNUM                           S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ                             S01498
     C                     PARM *BLANKS   SENTY                           S01498
     C                     PARM           SFILE2                          S01498
     C                     PARM           SFNUM                           S01498
     C                     PARM           ZSERR                           S01498
     C*                                                                   S01498
     C** ERROR IN ZSFILE PROCESSING                                       S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ENDSR                                          S01498
     C*****************************************************************   S01498
     C/EJECT                                                              S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C*  RCFAU -- SUBROUTINE TO REGISTER AU PRINTER FILE VIA RCF          S01498
     C*                                                                   S01498
     C*****************************************************************   S01498
     C*                                                                   S01498
     C           RCFAU     BEGSR                            ** RCFAU **   S01498
     C*                                                                   S01498
     C** ENSURE AUDIT SPOOL FILE RECORDED BY RCF                          S01498
     C*                                                                   S01498
     C                     Z-ADDSFNUMU    ZSNUMU  60                      S01498
     C*                                                                   S01498
     C                     CALL 'ZSFILE'                                  S01498
     C                     PARM           SEQ                             S01498
     C                     PARM *BLANKS   SENTY                           S01498
     C                     PARM           SFILEU                          S01498
     C                     PARM           ZSNUMU                          S01498
     C                     PARM *BLANK    ZSERR                           S01498
     C*                                                                   S01498
     C           ZSERR     IFEQ 'Y'                                       S01498
     C*                                                                   S01498
     C**  ERROR DURING ZSFILE PROCESSING, RETURN TO CALLING PROGRAM       S01498
     C*                                                                   S01498
     C                     SETON                     U7U8LR               S01498
     C                     RETRN                                          S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     ENDSR                                          S01498
     C*****************************************************************   S01498
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   #ZA       - PROCESS DATABASE ERRORS                        *
     C**                                                              *
     C**   CALLS     - NONE                                           *
     C**                                                              *
     C**   CALLED BY - #A                                             *
     C**                                                              *
     C*****************************************************************
     C*
     C           #ZA       BEGSR
     C*
     C           *IN31     IFEQ '1'                                       S01498
     C           LINE1     IFGT 55                                        S01498
     C                     WRITEHEADER1                                   S01498
     C                     WRITEHEADER2                                   S01498
     C                     END                                            S01498
     C                     WRITELB0680E2                                  S01498
     C                     CLOSELB0680P2                                  S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C           *IN50     IFEQ '1'                                       S01498
     C                     WRITEHEADER0                                   S01498
     C                     WRITELB0680E1                                  S01498
     C                     CLOSELB0680P1                                  S01498
     C                     END                                            S01498
     C*                                                                   S01498
     C                     WRITEHDRCTRL1
     C                     WRITEDBERROR1
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C**                                                              *
     C**   *PSSR     - PROGRAM ERROR HANDLING ROUTINE                 *
     C**                                                              *
     C**   CALLS     -                                                *
     C**                                                              *
     C**   CALLED BY -                                                *
     C**                                                              *
     C*****************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C                     ENDSR
     C*****************************************************************
     C/EJECT
**  Cpy@
(c) Misys International Banking Systems Ltd. 2001
**  Array of powers of 10 for currency conversion S/R SCONV
0000001
0000010
0000100
0001000
0010000
0100000
1000000
