0001 H        1                                                           S01117
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Facilities Extract for LE Portfolio(1)')      *
0001 H***********                                                         S01117
0002 F********************************************************************
0003 F*                                                                  *
     F*  Midas - Customer Lending Module
0005 F*                                                                  *
0006 F*       LE0730 - FACILITIES EXTRACT FOR LENDING PORTFOLIO (1)      *
0007 F*                                                                  *
      *  (c) Misys International Banking Systems Ltd. 2001            *
0009 F*                                                                  *
      *  Last Amend No. CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *  Prev Amend No. 260507             Date 01Jun09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 243804             Date 15Nov06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 193603             Date 31Aug01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 S01270             Date 22Mar91               *
      *                 S01194             Date 15Jan90               *
     F*                      S01117              DATE 22/08/89           *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*                                                                  *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  260507 - Unnecessary accesses to AOBRCHR1.                   *
      *           Keep an array which holds branch codes used. Check  *
      *           if branch is found at the array else, check in      *
      *           branch codes file via AOBRCHR1.                     *
      *  243804 - Originating branch is not used and causes DB error  *
      *           10 when it is blank. Orignally coded as BUG8868.    *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type                              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  193603 - Take negative facility amounts into consideration   *
     F*       S01270 - CUSTOMER LENDING CHANGES                          *S01270
     F*       S01194 - STANDING DATA CHANGES.                            *S01194
     F*       S01117 - MULTIBRANCHING                                    *
     F*                                                                  *
0012 F********************************************************************
0011 F*                                                                  *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
0013 FFCLTY   IP  F     256 10AI     2 DISK
0014 F*TABLE***IF  F      96 12AI     2 DISK                              S01194
0015 F*CLINT***IF  F     256  7AI     2 DISK                              S01194
0016 FFPORTH2 O   F      96            DISK
0016 F***FPORTFP O   F      96            DISK                                                CGL029
     F*FPORTFP*O***F*****122            DISK                                           CGL029 CLE042
     FFPORTFP O   F     126            DISK                                                   CLE042
0016 FFPORTT2 O   F      96            DISK
0017 F*E0730P1O***F     132            PRINTER                     S01124 S01117
     FLE0730AUO   F     132     OA     PRINTER                            S01117
0011 F*                                                                  *
0018 F* 01            FCLTY LIVE/EXPIRED RECORD A
0019 F* 02            FCLTY REVERSED
     F********20      ACCESS CLINT DETAILS ON FIRST LIVE FCLTY FOR CUST   S01194
0020 F*       40      FIRST CYCLE
0021 F*       41      PARENT
0022 F*       42      CHILD
0023 F*       43      LONER
0024 F*       90-99   STANDARD SUBROUTINES
0025 F*       U7,U8   STANDARD MIDAS USAGE
     E                    CPY@    1   1 80
     E                    ##BR      999  3               Branch codes                         260507
     E                    ##BC      999  3               Company codes                        260507
     E                    ##BI      999  6               BICN                                 260507
      *                                                                                       260507
0026 F*             L1 - CUSTOMER NUMBER
0027 I*
0028 I*    FACILITY FILE - DETAIL 1
0029 I*
0030 IFCLTY   NS  01   1 CD  13 CA
0031 I       OR   01   1 CE  13 CA
0032 I       OR   02   1 CC  13 CA
0033 I       OR   02   1 CR  13 CA
0034 I                                        1   1 RECI
0035 I**********                              2   70CNUM  L1                                  CSD027
0035 I                                        2   7 CNUM  L1                                  CSD027
0036 I                                        8  100FACT
0037 I                                       11  120FCNO
0038 I                                       13  13 RCTP
0039 I***********                            14  160BRCD                  S01117
0039 I                                       14  16 BRCA                  S01117
0040 I                                       17  17 FCTI
0041 I                                       18  20 FCCY
0042 I                                    P  21  270FAMT
0043 I                                    P  28  300OVPC
0044 I                                    P  31  330DTAP
0045 I                                    P  34  360DTEX
0046 I                                       37  37 RVCR
0047 I                                       38  38 SECI
0048 I                                       39  39 MCCY
0049 I                                       40  40 MCSI
0050 I                                       41  41 NACD
0051 I                                       42  43 CRSK
0052 I                                    P  44  460DLFS
0053 I                                    P  47  527NOMR
0054 I                                    P  53  550RVDT
0055 I                                       56  56 RVFR
0056 I                                       57  580RVDY
0057 I                                       59  93 NAR1
0058 I                                       94 128 NAR2
0059 I                                      129 163 NAR3
0060 I                                      164 198 NAR4
0061 I                                    P 199 2050MTDH
0062 I                                    P 206 2120MTDL
0063 I                                    P 213 2190MTDA
0064 I                                    P 220 2270QTDA
0065 I                                    P 228 2350YTDA
0066 I                                      236 237 ACOF
     I                                      238 240 ORBR                  S01117
     I                                    P 242 2440RVCD                  S01270
0067 I                                    P 247 2490ORED
0068 I                                    P 250 2520LCD
0069 I                                      253 253 CHTP
0070 I                                    P 254 2560TNLU
0071 I*
0072 I* FACILITY FILE - TRAILER
0073 I*
0074 I        NS       1 CT
0075 I                                        1   1 RECI
0076 I**********                              2   70CNUM                                      CSD027
0076 I                                        2   7 CNUM                                      CSD027
0077 I                                        8  100FACT
0078 I                                       11  120FCNO
0079 I                                       13  13 RCTP
0080 I                                    P  17  190NORE
0081 I                                    P  20  220FLSZ
0082 I                                    P  23  250NLRB
0083 I                                    P  26  280NINS
0084 I                                    P  29  310NDEL
0085 I                                    P  32  340NLRA
0086 I                                    P  35  420VLBF
0087 I                                    P  43  440VLBL
0088 I                                    P  45  520VRIF
0089 I                                    P  53  540VRIL
0090 I                                    P  55  620VRDF
0091 I                                    P  63  640VRDL
0092 I                                    P  65  720VRAF
0093 I                                    P  73  740VRAL
0094 I                                    P  75  820VLAF
0095 I                                    P  83  840VLAL
0096 I                                    P 250 2520LCD
0097 I                                      253 253 CHTP
0098 I                                    P 254 2560TNLU
0099 I        NS
0100 I*
0101 I*****TABLE*FILE*-*INSTALLATION*CONTROL*DATA*RECORD*1.               S01194
0102 I**********                                                          S01194
0103 I*TABLE***NS       2 C0   3 C1  12 C1                                S01194
0104 I*******AND      13 C0                                               S01194
0105 I**********                              1   1 RECI                  S01194
0106 I**********                             12  130RCDE                  S01194
0107 I**********                             14  66 TITL                  S01194
0108 I**********                             67  67 DATF                  S01194
0109 I***********                            68  700DFBR                  S01194
0110 I**********                             74  74 MODI1                 S01194
0111 I**********                             75  75 MODI2                 S01194
0112 I**********                             76  76 MODI3                 S01194
0113 I**********                          P  77  790RUND                  S01194
0114 I**********                             80  86 RUNA                  S01194
0115 I**********                             87  870SFLG                  S01194
0116 I********NS                                                          S01194
0117 I**********                                                          S01194
0118 I*****CLIENT*FILE*-*CUSTOMER*STANDING*DATA*RECORD.                   S01194
0119 I**********                                                          S01194
0120 I*CLINT***NS       8 CA                                              S01194
0121 I**********                              1   1 RECI                  S01194
0122 I**********                              2   70CNUM                  S01194
0123 I**********                              8   8 RCDT                  S01194
0124 I**********                              9  28 CRNM                  S01194
0125 I**********                             29  38 CTWN                  S01194
0126 I**********                             39  48 CSNM                  S01194
0127 I**********                             49  56 CASK                  S01194
0128 I**********                             57  68 TELX                  S01194
0129 I**********                             69  80 CSID                  S01194
0130 I**********                             81  82 ACOC                  S01194
0131 I**********                             83  83 CBSI                  S01194
0132 I**********                             84  85 CCTZ                  S01194
0133 I**********                             86  87 CLOC                  S01194
0134 I**********                             88  930CPAR                  S01194
0135 I*****FIELD*NAME*CHANGED FOR PROGRAM                                 S01194
0136 I**********                             94  960BRCDA                 S01194
0137 I**********                             97  980LINS                  S01194
0138 I**********                             99 1010LIND                  S01194
0139 I**********                          P 102 1040DASU                  S01194
0140 I**********                          P 105 1070CDIC                  S01194
0141 I**********                          P 108 1100DADE                  S01194
0142 I**********                            111 111 CMIN                  S01194
0143 I**********                            112 112 CTYP                  S01194
0144 I**********                            113 124 TELF                  S01194
0145 I**********                            125 133 CHID                  S01194
0146 I**********                            134 136 CHAB                  S01194
0147 I**********                          P 250 2520LCD                   S01194
0148 I**********                            253 253 CHTP                  S01194
0149 I**********                          P 254 2560TNLU                  S01194
0150 I********NS                                                          S01194
     I**********                                                          S01194
     ISDBRCH    E DSSDBRCHPD                                              S01117
     I** EXTERNAL DS FOR BRANCHES DETAILS                                 S01117
     I**                                                                  S01117
     I              A8CMCD                          CMPYM                 S01194
0151 I**                                                                  S01194
     ISDBANK    E DSSDBANKPD                                              S01194
      **  EXTERNAL DS FOR BANK DETAILS                                    S01194
     I              BJURPT                          TITL                  S01194
     I              BJDFIN                          DATF                  S01194
     I              BJMRDT                          RUNA                  S01194
     ISDCUST    E DSSDCUSTPD                                              S01194
      **  EXTERNAL DS FOR CUSTOMER DETAILS                                S01194
     I              BBACOC                          ACOC                  S01194
     I              BBPCNB                          CPAR                  S01194
     I              QQDFAC                          QQDFA1                                    CGL029
      *                                                                   S01194
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   S01194
     IDSSDY     E DSDSSDY                                                 S01194
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE                S01194
     I*                                                                   S01194
      **                                                                  S01194
0152 I*****DATA*STRUCTURE*-*KEY*TO*CLINT*FILE                             S01194
0153 I**********                                                          S01194
0154 I**********  DS                                                      S01194
0155 I**********                              1   7 CLIKEY                S01194
0156 I**********                              1   60CNUM                  S01194
0157 I**   LOCAL DATA AREA FOR DATABASE ERROR IDENTIFICATION
0158 ILDA        UDS                            256
0159 I***********                           134 138 DBFILE                S01117
0160 I***********                           139 167 DBKEY                 S01117
0161 I***********                           168 175 DBPGM                 S01117
0162 I***********                           176 1770DBASE                 S01117
0159 I                                      134 141 DBFILE                S01117
0160 I                                      142 170 DBKEY                 S01117
0161 I                                      171 180 DBPGM                 S01117
0162 I                                      181 1830DBASE                 S01117
     I*                                                                   S01117
     I*    FILE INFORMATION DATA STRUCTURE                                S01117
      *
     C** PARAMETER LIST FOR PROGRAM 'AOBANKR0'                            S01194
     C           PLISTA    PLIST                                          S01194
     C                     PARM '*MSG   ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C** PARAMETER LIST FOR PROGRAM 'AOCUSTR0'                            S01194
     C*                                                                   S01194
     C           PLIST1    PLIST                                          S01194
     C                     PARM '*MSG   ' @RTCD                           S01194
     C                     PARM '*KEY   ' @OPTN                           S01194
     C                     PARM           CKEY   10                       S01194
     C                     PARM '       ' KEYSTS  7                       S01194
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
     C*                                                                   S01194
     C**********           MOVEACPY@      BIS@   80                                           260507
0163 C**
0164 C**   FIRST CYCLE CALCS
0165 C**
0166 C   40                GOTO ENDFC
0167 C                     SETON                     40
     C                     MOVEACPY@      BIS@   80                                           260507
     C                     Z-ADD0         ##BNDX  40                                          260507
     C           *LIKE     DEFN ##BNDX    B                                                   260507
     C           *LIKE     DEFN ##BNDX    ##BSV                                               260507
0211 C**********           EXSR ZSYSTM                                    S01194
0199 C***99*****           SETON                     U7U8LR**DATABASE 01**S01194
0200 C***99*****           Z-ADD1         DBASE                           S01194
0201 C***99*****           MOVE ZTABKY    DBKEY                           S01194
0202 C***99*****           MOVE 'TABLE'   DBFILE                          S01194
     C                     CALL 'AOBANKR0'PLISTA                          S01194
     C           @RTCD     IFNE *BLANKS                                   S01194
0199 C                     SETON                     U7U8LR**DATABASE 01**S01194
0200 C                     Z-ADD1         DBASE                           S01194
0202 C                     MOVE 'SDBANKPD'DBFILE                          S01194
     C                     GOTO END                                       S01194
     C                     END                                            S01194
     C*                                                                   S01194
     C*    CHECK SYSTEM DATE FORMAT, DDMMYY OR MMDDYY.                    S01194
     C           DATF      COMP 'M'                      98MMDDYY, 98 ON  S01194
     C**                                                                  S01117
0173 C**
0174 C**   SET UP HASH FIELDS
0175 C**
0176 C                     Z-ADD1         EXTCNT  50
0177 C                     Z-ADD1         COUNT2  50
0178 C                     Z-ADD0         HASHF  150
0179 C                     Z-ADD0         HASHL   30
0180 C**********           MOVE 'A'       CLIKEY                          S01194
0181 C           ENDFC     TAG                             ** ENDFC TAG **
0182 C**
0183 C**   MAIN PROCESSING
0184 C**
     C   L1                SETON                     20
0185 C  N01N02             GOTO END
0186 C           COUNT2    ADD  2         COUNT2
0187 C  N01                GOTO END
     C*                                                                   S01117
     C** To get COMPANY OF ORIGINATING BRANCH (COOB) :                    S01117
     C*                                                                   S01117
     C           ORBR      IFEQ '   '                                                         243804
     C                     MOVELBRCA      ORBR                                                243804
     C                     ENDIF                                                              243804
      *                                                                                       243804
      ** Check whether details for Branch already in array                                    260507
      *                                                                                       260507
     C                     MOVELORBR      ##KB                                                260507
     C                     EXSR ##CHKB                                                        260507
      *                                                                                       260507
      ** If branch is in the array then use the details                                       260507
      *                                                                                       260507
     C           ##FIC     IFEQ 'Y'                                                           260507
     C                     EXSR ##SETB                                                        260507
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** If branch is not in the array then get details from DB                               260507
      *                                                                                       260507
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM ORBR      @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     SETON                     U7U8LR               S01117
     C                     MOVEL'SDBRCHPD'DBFILE                          S01117
     C                     MOVEL@DSNB     DBKEY            ************** S01117
     C                     MOVEL@OPTN     DBOPTN  7        *DBASE 10 **** S01117
     C                     Z-ADD10        DBASE            ************** S01117
     C                     EXSR *PSSR                                     S01117
     C                     GOTO END                                       S01117
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** Details found on the DB so add them to the array                                     260507
      ** if the array still has room                                                          260507
      *                                                                                       260507
     C                     EXSR ##ADDB                                                        260507
     C                     END                                            S01117
     C                     ENDIF                                                              260507
     C*                                                                   S01117
     C                     MOVE CMPYM     COOB    3                       S01117
     C*                                                                   S01117
     C** To get COMPANY OF BOOKING BRANCH (CMPYM) :                       S01117
     C*                                                                   S01117
      ** Check whether details for Branch already in array                                    260507
      *                                                                                       260507
     C                     MOVELBRCA      ##KB                                                260507
     C                     EXSR ##CHKB                                                        260507
      *                                                                                       260507
      ** If branch is in the array then use the details                                       260507
      *                                                                                       260507
     C           ##FIC     IFEQ 'Y'                                                           260507
     C                     EXSR ##SETB                                                        260507
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** If branch is not in the array then get details from DB                               260507
      *                                                                                       260507
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM BRCA      @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     SETON                     U7U8LR               S01117
     C                     MOVEL'SDBRCHPD'DBFILE                          S01117
     C                     MOVEL@DSNB     DBKEY            ************** S01117
     C                     MOVEL@OPTN     DBOPTN  7        *DBASE 11 **** S01117
     C                     Z-ADD11        DBASE            ************** S01117
     C                     EXSR *PSSR                                     S01117
     C                     GOTO END                                       S01117
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** Details found on the DB so add them to the array                                     260507
      ** if the array still has room                                                          260507
      *                                                                                       260507
     C                     EXSR ##ADDB                                                        260507
     C                     END                                            S01117
     C                     ENDIF                                                              260507
0188 C**
0189 C**   PERFORM HASH TOTALLING
0190 C**
0191 C                     Z-ADDHASHF     ZZTOTI
0192 C                     Z-ADDHASHL     ZZTOTD
0193 C                     MOVE FAMT      ZZAMT
     C           ZZAMT     IFLT 0                                                             193603
     C                     Z-SUBZZAMT     ZZAMT                                               193603
     C                     END                                                                193603
0194 C                     EXSR GLZADD
0195 C                     Z-ADDZZTOTI    HASHF
0196 C                     Z-ADDZZTOTD    HASHL
0197 C**
0198 C**   ACCESS CLIENT FILE IF CHANGE OF CUSTOMER
0199 C**
     C  N20                GOTO HASH
     C                     SETOF                     20
0201 C                     SETOF                     414243
0202 C                     SETOF                     99
0203 C********** CLIKEY    CHAINCLINT                99                   S01194
0204 C**N99***** RECI      COMP 'D'                  9999                 S01194
0205 C***99*****           SETON                     U7U8LR               S01194
0206 C***99*****           MOVE 'CLINT'   DBFILE                          S01194
0207 C***99*****           MOVE CLIKEY    DBKEY                           S01194
0208 C***99*****           Z-ADD2         DBASE            DBASE 2        S01194
0209 C***99*****           GOTO END                                       S01194
     C                     MOVELCNUM      CKEY                            S01194
     C                     CALL 'AOCUSTR0'PLIST1                          S01194
     C           @RTCD     IFNE *BLANKS                                   S01194
0205 C                     SETON                     U7U8LR               S01194
0206 C                     MOVE 'SDCUSTPD'DBFILE                          S01194
0207 C                     MOVE CKEY      DBKEY                           S01194
0208 C                     Z-ADD2         DBASE            DBASE 2        S01194
0209 C                     GOTO END                                       S01194
     C                     END                                            S01194
0210 C**
0211 C**   DETERMINE WHETHER PARENT,CHILD OR LONER
0212 C**
0213 C**********           TESTB'2'       CMIN           41               S01194
     C           BBPAIN    COMP 'P'                      41               S01194
0214 C********** CPAR      COMP 0                    42                   S01194
0214 C           CPAR      COMP *BLANKS              4242                 S01194
0215 C  N41N42             SETON                     43
0216 C**
0217 C**   SET UP FIELDS FOR OUTPUT
0218 C**
0219 C***41*****           MOVE CNUM      CPARP   60                                          CSD027
0219 C   41                MOVE CNUM      CPARP   6                                           CSD027
0220 C   41                MOVE ACOF      ACOCP   2
0221 C   42                MOVE ACOF      ACOCC   2
0222 C***42*****           MOVE CPAR      CPARC   60                                          CSD027
0223 C***42*****           MOVE CNUM      CNUMC   60                                          CSD027
0222 C   42                MOVE CPAR      CPARC   6                                           CSD027
0223 C   42                MOVE CNUM      CNUMC   6                                           CSD027
0224 C   42                MOVE CPAR      CPARP
0225 C   42                SETON                     41
0226 C  N42                GOTO HASH
0227 C**
0228 C**   IF A CHILD CHAIN TO CLINT FOR PARENT'S A/C OFFICER
0229 C**
0230 C**********           MOVELCPAR      CLIKEY                          S01194
0231 C**********           SETOF                     99                   S01194
0232 C********** CLIKEY    CHAINCLINT                99                   S01194
0233 C**N99***** RECI      COMP 'D'                  9999                 S01194
0234 C***99*****           SETON                     U7U8LR               S01194
0235 C***99*****           MOVE 'CLINT'   DBFILE                          S01194
0236 C***99*****           MOVE CLIKEY    DBKEY                           S01194
0237 C***99*****           Z-ADD3         DBASE            DBASE 3        S01194
0238 C***99*****           GOTO END                                       S01194
0230 C                     MOVELCPAR      CKEY                            S01194
     C                     CALL 'AOCUSTR0'PLIST1                          S01194
     C           @RTCD     IFNE *BLANKS                                   S01194
     C                     MOVE CKEY      DBKEY                        ***S01194
     C                     MOVE 'SDCUSTPD'DBFILE           ***************S01194
0237 C                     Z-ADD3         DBASE            DBASE 3        S01194
0234 C                     SETON                     U7U8LR               S01194
0238 C                     GOTO END                                       S01194
     C                     END                                            S01194
0239 C**
0240 C                     MOVE ACOC      ACOCP
0241 C**
0242 C**   PERFORM HASH TOTALLING FOR RECORDS EXTRACTED
0243 C**
0244 C           HASH      TAG                             ** HASH TAG ***
0245 C                     EXSR HASTOT
0246 C   42                EXSR HASTOT
0247 C**
0248 C           END       TAG                             ** END TAG ****
0249 C**
0250 C**   LAST RECORD CALCS
0251 C**
0252 CLR         EXTCNT    ADD  1         EXTCNT
0253 CLR         COUNT2    ADD  1         COUNT2
0254 CLRNU8      COUNT2    COMP NORE                 U8U8
0255 CLRNU8      HASHF     COMP VLAF                 U8U8
0256 CLRNU8      HASHL     COMP VLAL                 U8U8
0257 CLR U7                MOVE 'LE0730'  DBPGM
     CLR U7 U8             EXSR *PSSR                                     S01117
0258 C********************************************************************
      /EJECT                                                                                  260507
      ********************************************************************                    260507
      *                                                                  *                    260507
      * ##CHKB - Subroutine to check the Branch in the arrays            *                    260507
      *                                                                  *                    260507
      ********************************************************************                    260507
     C           ##CHKB    BEGSR                                                              260507
      *                                                                                       260507
     C           *LIKE     DEFN A8BRCD    ##KB                                                260507
      *                                                                                       260507
      ** Set off the branch found indicator                                                   260507
      *                                                                                       260507
     C                     MOVEL*BLANK    ##FIC   1                                           260507
      *                                                                                       260507
      ** Save the state of indicator 30 so it can be reset at the end                         260507
      ** of the SR as it may be used elsewhere in the code                                    260507
      *                                                                                       260507
     C           *IN30     IFEQ *ON                                                           260507
     C                     MOVEL'Y'       #IN30   1                                           260507
     C                     ELSE                                                               260507
     C                     MOVEL'N'       #IN30                                               260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
     C                     SETOF                         30                                   260507
      *                                                                                       260507
      ** Restore the saved value of B                                                         260507
      *                                                                                       260507
     C                     Z-ADD##BSV     B                                                   260507
      *                                                                                       260507
      ** Check whether details for Branch already in array                                    260507
      *                                                                                       260507
      ** Is this the same as the last LOKUP, if so we can bypass                              260507
      ** the LOKUP                                                                            260507
      ** Defend against B being 0                                                             260507
      *                                                                                       260507
     C           B         IFEQ 0                                                             260507
     C                     Z-ADD1         B                                                   260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** If the branch being checked is the same then use these                               260507
      ** details rather than doing a LOKUP                                                    260507
      *                                                                                       260507
     C           ##KB      IFEQ ##BR,B                                                        260507
      *                                                                                       260507
      ** Found, so seton 30                                                                   260507
      *                                                                                       260507
     C                     SETON                         30                                   260507
     C                     ELSE                                                               260507
     C                     Z-ADD1         B                                                   260507
     C           ##KB      LOKUP##BR,B                   30                                   260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** Save the last update to B                                                            260507
      *                                                                                       260507
     C           *IN30     IFEQ *ON                                                           260507
     C                     Z-ADDB         ##BSV                                               260507
      *                                                                                       260507
      ** Set the indicator to show the data was found                                         260507
      *                                                                                       260507
     C                     MOVEL'Y'       ##FIC                                               260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** Reset the state of indicator 30.                                                     260507
      *                                                                                       260507
     C           #IN30     IFEQ 'Y'                                                           260507
     C                     MOVEL*ON       *IN30                                               260507
     C                     ELSE                                                               260507
     C                     MOVEL*OFF      *IN30                                               260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
     C                     ENDSR                                                              260507
      ********************************************************************                    260507
      /EJECT                                                                                  260507
      ********************************************************************                    260507
      *                                                                  *                    260507
      * ##SETB - Sets up the SDBRCHPD fields used in the code from the   *                    260507
      *          arrays                                                  *                    260507
      *                                                                  *                    260507
      ********************************************************************                    260507
     C           ##SETB    BEGSR                                                              260507
      *                                                                                       260507
     C                     MOVEL##BR,B    A8BRCD                                              260507
     C                     MOVEL##BC,B    CMPYM                                               260507
     C                     MOVEL##BI,B    A8BICN                                              260507
      *                                                                                       260507
     C                     ENDSR                                                              260507
      *                                                                                       260507
      ********************************************************************                    260507
      /EJECT                                                                                  260507
      ********************************************************************                    260507
      *                                                                  *                    260507
      * ##ADDB - Adds the SDBRCHPD fields used in the code to the arrays *                    260507
      *                                                                  *                    260507
      ********************************************************************                    260507
     C           ##ADDB    BEGSR                                                              260507
      *                                                                                       260507
      ** If there is still room in the array then add the details                             260507
      *                                                                                       260507
     C           ##BNDX    IFLT 999                                                           260507
     C                     ADD  1         ##BNDX                                              260507
     C                     Z-ADD##BNDX    B                                                   260507
     C                     MOVELA8BRCD    ##BR,B                                              260507
     C                     MOVELCMPYM     ##BC,B                                              260507
     C                     MOVELA8BICN    ##BI,B                                              260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** Update ##BSV so next call to ##CHKB checks this latest addition                      260507
      ** to the array first                                                                   260507
      *                                                                                       260507
     C                     Z-ADDB         ##BSV                                               260507
      *                                                                                       260507
     C                     ENDSR                                                              260507
      ********************************************************************                    260507
      /EJECT                                                                                  260507
      ********************************************************************                    260507
0259 C*                                                                  *
0260 C*    HASTOT SR. TO ACCUMULATE HASH TOTALS OF RECORDS OUTPUT        *
0261 C           HASTOT    BEGSR                           ** HASTOT BEGSR
0262 C**
0263 C           EXTCNT    ADD  1         EXTCNT
0264 C                     Z-ADDEXTWHN    ZZTOTI
0265 C                     Z-ADDEXTDC     ZZTOTD
0266 C                     MOVE FAMT      ZZAMT
     C           ZZAMT     IFLT 0                                                             193603
     C                     Z-SUBZZAMT     ZZAMT                                               193603
     C                     END                                                                193603
0267 C                     EXSR GLZADD
0268 C                     Z-ADDZZTOTI    EXTWHN 150
0269 C                     Z-ADDZZTOTD    EXTDC   30
0270 C**
0271 C                     ENDSR
0272 C*                                                                  *
0273 C********************************************************************
0274 C********************************************************************
0275 C* SUBROUTINE TO ADD AN AMOUNT (ZZAMT) TO THE TOTAL (ZZTOTI,ZZTOTD)
0276 C*   IND '99' IS SET BY AN OVERFLOW ERROR
0277 C*
0278 CSR         GLZADD    BEGSR                           *** GLZADD ****
0279 C*
0280 CSR                   Z-ADDZZAMT     ZZAMT  153     91-DEFINE ZZAMT
0281 CSR 91                GOTO ZZAEND                     AMT = 0.BYPASS
0282 C*
0283 C* SPLIT ZZAMT INTO INTEGER AND DECIMAL FIELDS
0284 CSR                   Z-ADDZZAMT     ZZAMTI 150       INTEGER FIELD
0285 CSR                   MOVE ZZAMT     ZZAMTD  30       DECIMAL FIELD
0286 C* BOTH ZZAMTI AND ZZAMTD CONTAIN A 'SIGN' ZONE NOW
0287 C*
0288 CSR                   EXSR GLZSUM
0289 CSR         ZZAEND    ENDSR                           ** ZZAEND TAG *
0290 C*
0291 C********************************************************************
0292 C********************************************************************
0293 C* SUBROUTINE TO CARRY OUT THE ADDITION FOR SUBROUTINES -
0294 C*                        GLZADD, GLZSUB, GLZCMP.
0295 C*          PARAMETERS PASSED -
0296 C*                     I/P ZZAMTI ZZAMTD
0297 C*                     O/P ZZTOTI ZZTOTD ZZNEGD IND 96 IND 99.
0298 C*
0299 CSR         GLZSUM    BEGSR                           *** GLZSUM ****
0300 C*
0301 CSR                   Z-ADDZZTOTI    ZZTOTI 150       DEFINE ZZTOTI
0302 CSR                   Z-ADDZZTOTD    ZZTOTD  30       DEFINE ZZTOTD
0303 CSR                   SETOF                     919293
0304 CSR                   SETOF                     949599
0305 C*
0306 C*    DETERMINE SIGN OF ZZAMTI & D,   92 IF NEG
0307 CSR         ZZAMTI    COMP 0                      9293
0308 CSR 93      ZZAMTD    COMP 0                      9293
0309 CSR 93                GOTO ZZSEND                     ZERO BYPASS
0310 C*
0311 C*    DETERMINE SIGN OF ZZTOTI & D, 91 IF NEG.
0312 CSR         ZZTOTI    COMP 0                      9193
0313 CSR 93      ZZTOTD    COMP 0                      9193
0314 C*
0315 C*    IF ZZTOTAL IS ZERO, RETURN ZZAMOUNT.
0316 CSR 93                Z-ADDZZAMTI    ZZTOTI
0317 CSR 93                Z-ADDZZAMTD    ZZTOTD
0318 CSR 93                GOTO ZZSEND                     ZERO BYPASS
0319 C*    IF SIGNS DIFFER BYPASS OVERFLOW CHECKS.
0320 CSR 91N92
0321 CORN91 92             GOTO ZZOFPS
0322 C*
0323 CSR         ZZAMTD    ADD  ZZTOTD    ZZWK2   40
0324 CSR         ZZWK2     COMP 999                  93    '93' = CARRY
0325 CSRN93      ZZWK2     COMP -999                   93    INTO INTEGER.
0326 C*
0327 CSR 93N92   ZZAMTI    ADD  1         ZZWK3  150       ADD 'CARRY' +VE
0328 CSR    93 92ZZAMTI    SUB  1         ZZWK3            SUB 'CARRY' -VE
0329 CSR 93      ZZTOTI    ADD  ZZWK3     ZZWK3
0330 CSRN93      ZZTOTI    ADD  ZZAMTI    ZZWK3
0331 C*
0332 C* IF THE MODULUS OF ZZWK3 IS LT MOD. ZZTOTI THEN O/F HAS OCCURED
0333 CSRN92      ZZWK3     COMP ZZTOTI                 99  -92 MEANS NOS.
0334 CSR 92      ZZWK3     COMP ZZTOTI               99     NEGATIVE
0335 CSRN99                Z-ADDZZWK2     ZZTOTD
0336 CSRN99                Z-ADDZZWK3     ZZTOTI
0337 C*
0338 C* IF O/F ZEROIZE ZZAMT , IND '99' SET AND ZZTOT FIELDS LEFT INTACT.
0339 CSR 99                Z-ADD0         ZZAMT  153
0340 CSR                   GOTO ZZSEND
0341 C*
0342 C* THE 'SIGNS' ARE DIFFERENT
0343 CSR         ZZOFPS    TAG                             ** ZZOFPS TAG**
0344 C* IF ZZAMT WAS NEGATIVE, MAKE IT POS. TO COMP WITH ZZTOT
0345 C*
0346 CSR 92                Z-SUBZZAMTI    ZZAMTI 150
0347 CSR 92                Z-SUBZZAMTD    ZZAMTD  30
0348 C*
0349 C* IF ZZTOT WAS NEGATIVE, MAKE IT POS. TO COMP WITH ZZAMT.
0350 C*
0351 CSR 91                Z-SUBZZTOTI    ZZTOTI
0352 CSR 91                Z-SUBZZTOTD    ZZTOTD
0353 C* BOTH ZZAMT AND ZZTOT ARE NOW POSITIVE.
0354 C*
0355 CSR         ZZTOTI    COMP ZZAMTI               93  95
0356 CSR 95      ZZTOTD    COMP ZZAMTD               93  95
0357 C*
0358 C* IF ZZTOT EQ. ZZAMT RETURN ZERO.
0359 CSR 95                Z-ADD0         ZZTOTI
0360 CSR 95                Z-ADD0         ZZTOTD
0361 CSR 95                GOTO ZZSEND
0362 C*
0363 C* IF ZZTOT GT. ZZAMT.
0364 CSR 93      ZZAMTD    COMP ZZTOTD               94
0365 CSR 93 94   ZZTOTI    SUB  1         ZZTOTI
0366 CSR 93 94   ZZTOTD    ADD  1000      ZZWK2
0367 CSR 93      ZZTOTI    SUB  ZZAMTI    ZZTOTI
0368 CSR 93 94   ZZWK2     SUB  ZZAMTD    ZZTOTD
0369 CSR 93N94   ZZTOTD    SUB  ZZAMTD    ZZTOTD
0370 C*
0371 C*
0372 C* IF ZZAMT GT. ZZTOT.
0373 CSRN93      ZZTOTD    COMP ZZAMTD               94
0374 CSRN93 94   ZZAMTI    SUB  1         ZZWK3  150
0375 CSRN93 94   ZZAMTD    ADD  1000      ZZWK2
0376 CSRN93 94   ZZWK3     SUB  ZZTOTI    ZZTOTI
0377 CSRN93N94   ZZAMTI    SUB  ZZTOTI    ZZTOTI
0378 CSRN93 94   ZZWK2     SUB  ZZTOTD    ZZTOTD
0379 CSRN93N94   ZZAMTD    SUB  ZZTOTD    ZZTOTD
0380 C*
0381 C* REVERSE SIGN OF ZZTOT IF LARGER I/P FIELDS WERE NEGATIVE
0382 CSR                   SETOF                     94
0383 CSR 93 91
0384 CORN93 92             SETON                     94
0385 CSR 94                Z-SUBZZTOTI    ZZTOTI
0386 CSR 94                Z-SUBZZTOTD    ZZTOTD
0387 C**
0388 C**   RESTORE SIGN OF ZZAMTI & ZZAMTD IF IT WAS REVERSED.
0389 CSR 92                Z-SUBZZAMTI    ZZAMTI
0390 CSR 92                Z-SUBZZAMTD    ZZAMTD
0391 CSR         ZZSEND    TAG                             ** ZZSEND TAG *
0392 C**
0393 C**   IF ZZTOTD IS ZERO, AND ZZTOTI IS NEG. SET UP ZZNEGD.
0394 CSR                   SETOF                     96
0395 CSR         ZZTOTD    COMP 0                        91
0396 CSR 91      ZZTOTI    COMP 0                      96
0397 CSR 96                MOVE '.000-'   ZZNEGD  5
0398 CSR                   ENDSR                             ** ENDSR **
0399 C********************************************************************
0400 C********************************************************************
0401 C**
0469 C*****ZSYSTM*SR.*TO*CHAIN TO THE INSTALLATION CONTROL DATA RECORD.   S01194
0470 C**********                                                          S01194
0471 C********** ZSYSTM    BEGSR                           *** ZSYSTM *** S01194
0472 C**********                                                          S01194
0473 C*****SET*UP*KEY*FOR*INSTALLATION CONTROL RECORD.                    S01194
0474 C**********           MOVEL'01      'ZTABKY 12                       S01194
0475 C**********           MOVE '  10'    ZTABKY                          S01194
0476 C**********                                                          S01194
0477 C********** ZTABKY    CHAINTABLE                99    ON NOT THERE   S01194
0478 C**N99***** RECI      COMP 'D'                  9999  ON, IS DELETED S01194
0479 C**********                                                          S01194
0480 C*****CHECK*SYSTEM*DATE FORMAT, DDMMYY OR MMDDYY.                    S01194
0481 C********** DATF      COMP 'M'                      98MMDDYY, 98 ON  S01194
0482 C**********                                                          S01194
0483 C**********           ENDSR                                          S01194
0417 C**
0418 C**
0419 C********************************************************************
     C********************************************************************S01117
     C*                                                                   S01117
     C*  *PSSR --- SUBROUTINE TO HANDLE ABNORMAL ERROR CONDITIONS         S01117
     C*                                                                   S01117
     C*  CALLED FROM: AFTER ABNORMAL OPERATION OCCURS                     S01117
     C*                                                                   S01117
     C*  CALLS: NOTHING                                                   S01117
     C*                                                                   S01117
     C********************************************************************S01117
     C*                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C                     ENDSR                           ** *PSSR **    S01117
     C*                                                                   S01117
     C********************************************************************S01117
0420 O**
0421 O**   CUSTOMER FORTFOLIO EXTRACT FILE
0422 O**
0423 OFPORTH2 H        1P
0424 O                                    1 'H'
0425 O**
0426 O**
0427 OFPORTFP D        01 41NU7
0428 O                                    1 'D'
0429 O                         ACOCP      3
0430 O                         CPARP      9
0431 O                                   18 '999999P6G'
0432 O                         FCCY      21
0433 O                         FAMT      29P
0434 O**********               FACT      32                                                   CGL029
0435 O**********                         33 '-'                                               CGL029
0436 O**********               FCNO      35                                                   CGL029
0437 O                         DTEX      38P
0438 O                                   47 'F'
0439 O***********              BRCD      50                               S01117
0439 O                         BRCA      50                               S01117
0440 O                       42          63 'C'
     O                         CMPYM     70                               S01117
     O                         ORBR      73                               S01117
     O                         COOB      76                               S01117
     O                         FACT      99                                                   CGL029
     O                                  100 '-'                                               CGL029
     O                         FCNO     102                                                   CGL029
0441 O**
0442 O**   CHILD RECORD
0443 O**
0444 O        D        01 42NU7
0445 O                                    1 'D'
0446 O                         ACOCC      3
0447 O                         CPARC      9
0448 O                         CNUMC     15
0449 O                                   18 'C6G'
0450 O                         FCCY      21
0451 O                         FAMT      29P
0452 O**********               FACT      32                                                   CGL029
0453 O**********                         33 '-'                                               CGL029
0454 O**********               FCNO      35                                                   CGL029
0455 O                         DTEX      38P
0456 O                                   47 'F'
0457 O***********              BRCD      50                               S01117
0457 O                         BRCA      50                               S01117
     O                         CMPYM     70                               S01117
     O                         ORBR      73                               S01117
     O                         COOB      76                               S01117
     O                         FACT      99                                                   CGL029
     O                                  100 '-'                                               CGL029
     O                         FCNO     102                                                   CGL029
0458 O**
0458 O**  LONER RECORD
0459 O**
0460 O        D        01 43NU7
0461 O                                    1 'D'
     O                         ACOF       3
0463 O**********                          9 '000000'                                          CSD027
     O                                    9 '      '                                          CSD027
0464 O                         CNUM      15
0465 O                                   18 'L6G'
0466 O                         FCCY      21
0467 O                         FAMT      29P
0468 O**********               FACT      32                                                   CGL029
0469 O**********                         33 '-'                                               CGL029
0470 O**********               FCNO      35                                                   CGL029
0471 O                         DTEX      38P
0472 O                                   47 'F'
0473 O***********              BRCD      50                               S01117
0473 O                         BRCA      50                               S01117
     O                         CMPYM     70                               S01117
     O                         ORBR      73                               S01117
     O                         COOB      76                               S01117
     O                         FACT      99                                                   CGL029
     O                                  100 '-'                                               CGL029
     O                         FCNO     102                                                   CGL029
0474 OFPORTT2 T        LR
0475 O                                    1 'T'
0476 O                         EXTCNT     4P
0477 O                         EXTWHN    12P
0478 O                         EXTDC     14P
0479 O**
0480 O**   CONTROL REPORT
0481 O**
0482 O*E0730P1T***03   LR U7                                     S01124   S01117
     OLE0730AUT   03   LR U7                                              S01117
0483 O                                   51 '*** REFERENCE LE0730'
0484 O                                   71 '- DATABASE ERROR AT'
0485 O***********              DBASE     74                               S01117
0485 O                         DBASE     75                               S01117
0486 O        T   05   LR U7
0487 O                                   37 'FILENAME'
0488 O***********              DBFILE    43                               S01117
0489 O***********                        48 'KEY'                         S01117
0490 O***********              DBKEY     78                               S01117
0488 O                         DBFILE    46                               S01117
0489 O                                   51 'KEY'                         S01117
0490 O                         DBKEY     81                               S01117
0491 O        T 3      LR
0492 O***********                        22 'REFERENCE LE0730'            S01117
0492 O                                   24 'REFERENCE LE0730AU'          S01117
0493 O                         TITL      89
0494 O                                  104 'DATE'
0495 O                         RUNA     112
0496 O                                  127 'PAGE    1'
0497 O        T 2      LR
0498 O                                   56 'FACILITIES EXTRACT FOR C'
0499 O                                   80 'USTOMER LENDING PORTFOLI'
0500 O                                  100 'O(1) - FILE CONTROLS'
0501 O        T 1      LR
0502 O                                   56 '------------------------'
0503 O                                   80 '------------------------'
0504 O                                  100 '--------------------'
0505 O        T 3      LR
0506 O                                   28 'S/FCLTY - RUN CONTROLS'
0507 O                                   59 'NUMBER'
0508 O                                   84 'VALUE'
0509 O        T 1      LR
0510 O                                   28 '----------------------'
0511 O                                   59 'OF RECORDS'
0512 O                                   84 'OF RECORDS'
0513 O        T 2      LR
0514 O                                   29 'TOTAL RECORDS ON FILE'
0515 O                      NU7NORE  3   59
0516 O                      NU7VLAF  4   81
0517 O                      NU7VLAL      84
0518 O        T 2      LR
0519 O                                   29 'TOTAL RECORDS ON FILE'
0520 O                                   42 '- CALCULATED'
0521 O                         COUNT23   59
0522 O                         HASHF 4   81
0523 O                         HASHL     84
0524 O                   NU7 U8         111 '***   DIFFERENCE   ***'
0525 O        T 3      LR
0526 O                                   28 'S/FPORT - RUN CONTROLS'
0527 O        T 1      LR
0528 O                                   28 '----------------------'
0529 O        T 2      LR
0530 O                                   29 'TOTAL RECORDS ON FILE'
0531 O                         EXTCNT3   59
0532 O                         EXTWHN4   81
0533 O                         EXTDC     84
0534 O********T*3      LR                                                 S01117
0535 O***********                        76 '*** END OF REPORT ***'       S01117
** CPY@   **      OBJECT COPYRIGHT
(c) Misys International Banking Systems Ltd. 2001
