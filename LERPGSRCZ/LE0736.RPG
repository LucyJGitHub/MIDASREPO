0001 H        1                                                           S01117
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas Deals Extract for Lending Portfolio')            *
0001 H***********                                                         S01117
0002 F********************************************************************
0003 F*                                                                  *
     F*  Midas  Customer Lending Module
0005 F*                                                                  *
0006 F*       LE0736 - DEALS EXTRACT FOR LENDING PORTFOLIO               *
0007 F*                                                                  *
      *  (c) Finastra International Limited 2001                      *
0009 F*                                                                  *
      *  Last Amend No. MD041994           Date 28Apr20               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      *                 CDL099             Date 06Oct17               *
      *                 CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 260507             Date 01Jun09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 BUG12845           Date 06Dec06               *
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 07Jul06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CDL038             Date 10May05               *
      *                 CSW037A            Date 02May05               *
      *                 CDL028             Date 07Feb05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 BHF118             Date 11Jun90               *
      *                 S01194             Date 15Jan90               *
     F*                      S01117           DATE  23/08/89             *
     F*                      S01119           DATE  17/06/87             *
     F*                      S01124           DATE  00/00/00             *
     F*                                                                  *
0012 F********************************************************************
     F*                                                                  *
      *  MD041994 - COB components LEC08 10012 and LEC08 10003 failed *
      *             due to closed customer. Do not process DBERR when *
      *             when customer is closed.                          *
      *           - Applied for MD-55209                              *
      *  MD046248 - Finastra Rebranding                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  260507 - Unnecessary accesses to AOBRCHR1.                   *
      *           Keep an array which holds branch codes used. Check  *
      *           if branch is found at the array else, check in      *
      *           branch codes file via AOBRCHR1.                     *
      *  BUG12845 - [PT][COB]D2SNG - LEC08 10012                      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type                              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CDL028 - Automatic Rate Interpolations (Recompile)           *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*       BHF118 - INDICATOR 20 NEVER SET ON                         *BHF118
     F*       S01194 - STANDING DATA CHANGES.                            *S01194
     F*       S01117 - MULTIBRANCHING                                    *
     F*       S01119 - CHANGE TO DEALS FILE TO ALLOW FOR FRA/IRS         *
     F*                                                                  *
0012 F********************************************************************
0013 F**
0014 F*EALS***IP**F*****400**6AI*****2*DISK                               S01119
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
0014 F*EALS***IP**F     600  6AI     2 DISK                      S01119   S01117
0014 FDEALS   IP  F    1075  6AI     2 DISK                               S01117
0015 F*TABLE***IF  F      96 12AI     2 DISK                              S01194
0016 F*CLINT***IF  F     256  7AI     2 DISK                              S01194
0017 F*FPORTFP*O***F******96            DISK                                                  CLE042
     FFPORTFP O   F     126            DISK                                                   CLE042
0017 FFPORTT2 O   F      96            DISK
0018 F*PRINT  O   F     132            PRINTER                            S01124
0018 F*E0736P1O***F     132            PRINTER                   S01124   S01117
0018 FLE0736AUO   F     132            PRINTER                            S01117
0019 F* ID F  C  H  L    FUNCTION OF INDICATORS
0020 F* 01            DEALS FILE - DETAIL RECORD
0021 F* 02                       - TRAILER
0022 F* 03            DEALS FILE - DETAIL RECORD - NOT EXTRACTED
0023 F**04******      CLINT FILE - DETAIL RECORD                          S01194
0024 F*    20 PARENT NO. ZERO
0025 F*       30      FIRST CYCLE INDICATOR
0026 F*       31       DEALS RECORD TO BE EXTRACTED
0027 F*       32      WORK INDICATOR
0028 F*       90-99   STANDARD SUBROUTINES
0029 F*       U7,U8   STANDARD MIDAS USAGE
0030 E                    TABDTP 12  12  2               * DEAL TYPES
     E                    CPY@    1   1 80
0031 E**
     E                    ##BR      999  3               Branch codes                         260507
     E                    ##BC      999  3               Company codes                        260507
     E                    ##BI      999  6               BICN                                 260507
      *                                                                                       260507
0032 I**
0033 I**  DEALS FILE DETAIL RECORD
0034 IDEALS   NS  01   1 CD   8 CC
0035 I*******OR**      1 CD   8 CD                                        S01117
0036 I                                        2   7 DLNO
0037 I**********                             11  160CNUM                                    BUG12845
0037 I                                       11  16 CNUM                                    BUG12845
0038 I***********                            17  19 BRCD                  S01117
0038 I                                       17  19 BRCA                  S01117
0039 I                                       20  21 DTYP
0040 I                                       46  48 CCY
0041 I                                    P  49  550AMT
     I                                      112 1160FAC         66
     I                                      112 1140FACT
     I                                      115 1160FCNO
     I                                     10571059 ORBR                  S01117
     I        NS  01   1 CD   8 CD                                        S01117
     I                                        2   7 DLNO                  S01117
     I**********                             11  160CNUM                             S01117 BUG12845
     I                                       11  16 CNUM                                    BUG12845
     I                                       17  19 BRCA                  S01117
     I                                       20  21 DTYP                  S01117
     I                                       46  48 CCY                   S01117
     I                                    P  49  550AMT                   S01117
     I                                      112 1160FAC         66        S01117
     I                                      112 1140FACT                  S01117
     I                                      115 1160FCNO                  S01117
     I                                     10371039 ORBR                  S01117
0042 I**
0043 I**  DEALS FILE - TRAILER
0044 I**
0045 I        NS  02   1 CT
0046 I                                    P  32  340NLRA
0047 I                                    P  65  720VLAF
0048 I                                    P  73  740VLAL
0049 I**
0050 I**  DEALS FILE - DETAIL RECORD - NOT EXTRACTED
0051 I**
     I        NS  03   1 CD   8 CG                                        S01119
     I                                    P  57  630AMT                   S01119
0052 I        NS  03   1 CD
0053 I                                    P  49  550AMT
0054 I**
0055 I**  DEALS FILE CATCHALL
0056 I        NS
0057 I*
0058 I*****TABLE*FILE*-*INSTALLATION*CONTROL*DATA*RECORD*1.               S01194
0059 I**********                                                          S01194
0060 I*TABLE***NS       2 C0   3 C1  12 C1                                S01194
0061 I*******AND      13 C0                                               S01194
0062 I**********                              1   1 RECI                  S01194
0063 I**********                              2   30RECT                  S01194
0064 I**********                             12  130RCDE                  S01194
0065 I**********                             14  66 TITL                  S01194
0066 I**********                             67  67 DATF                  S01194
0067 I***********                            68  700DFBR                  S01194
0068 I**********                             74  74 MODI1                 S01194
0069 I**********                             75  75 MODI2                 S01194
0070 I**********                             76  76 MODI3                 S01194
0071 I**********                          P  77  790RUND                  S01194
0072 I**********                             80  86 RUNA                  S01194
0073 I**********                             87  870SFLG                  S01194
0074 I**********                          P  90  920LCD                   S01194
0075 I**********                             93  93 CHTP                  S01194
0076 I**********                          P  94  960TNLU                  S01194
0077 I**********                                                          S01194
0078 I****TABLES*FILE*CATCHALL                                            S01194
0079 I**********                                                          S01194
0080 I********NS                                                          S01194
0081 I**********                                                          S01194
0082 I*****CLIENT*FILE*-*CUSTOMER*STANDING*DATA*RECORD.                   S01194
0083 I*
0084 I*CLINT***NS  04   1 CD   8 CA                                       S01194
0121 I**********                              1   1 RECI                  S01194
0122 I**********                              2   70CNUM                  S01194
0123 I**********                              8   8 RCDT                  S01194
0124 I**********                              9  28 CRNM                  S01194
0125 I**********                             29  38 CTWN                  S01194
0126 I**********                             39  48 CSNM                  S01194
0127 I**********                             49  56 CASK                  S01194
0128 I**********                             57  68 TELX                  S01194
0129 I**********                             69  80 CSID                  S01194
0130 I**********                             81  82 ACOC                  S01194
0131 I**********                             83  83 CBSI                  S01194
0132 I**********                             84  85 CCTZ                  S01194
0133 I**********                             86  87 CLOC            20    S01194
0134 I**********                             88  930CPAR                  S01194
0135 I*****FIELD*NAME*CHANGED FOR PROGRAM                                 S01194
0099 I***********                            94  960BRCDA                 S01194
0137 I**********                             97  980LINS                  S01194
0138 I**********                             99 1010LIND                  S01194
0139 I**********                          P 102 1040DASU                  S01194
0140 I**********                          P 105 1070CDIC                  S01194
0141 I**********                          P 108 1100DADE                  S01194
0142 I**********                            111 111 CMIN                  S01194
0143 I**********                            112 112 CTYP                  S01194
0144 I**********                            113 124 TELF                  S01194
0145 I**********                            125 133 CHID                  S01194
0146 I**********                            134 136 CHAB                  S01194
0147 I**********                          P 250 2520LCD                   S01194
0111 I**********                            253 253 CHTP                  S01194
0112 I**********                          P 254 2560TNLU                  S01194
0113 I**********                                                          S01194
0114 I****CLINT*CATCHALL                                                  S01194
0115 I**********                                                          S01194
0116 I********NS                                                          S01194
     I*                                                                   S01117
     ISDBRCH    E DSSDBRCHPD                                              S01117
     I** EXTERNAL DS FOR BRANCHES DETAILS                                 S01117
     I**                                                                  S01117
     I              A8CMCD                          CMPYM                 S01194
0117 I**
     ISDBANK    E DSSDBANKPD                                              S01194
      **  EXTERNAL DS FOR BANK DETAILS                                    S01194
     I              BJURPT                          TITL                  S01194
     I              BJMRDT                          RUNA                  S01194
     I              BJDFIN                          DATF                  S01194
     ISDCUST    E DSSDCUSTPD                                              S01194
     I              QQDFAC                          #DFAC1                                    CGL029
      **  EXTERNAL DS FOR CUSTOMER DETAILS                                S01194
      *                                                                   S01194
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   S01194
     IDSSDY     E DSDSSDY                                                 S01194
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE                S01194
     I*                                                                   S01194
      **                                                                  S01194
0118 I****DATA*STRUCTURE*FOR*CLINT*FILE*-*CHILD                           S01194
0119 I**********  DS                                                      S01194
0120 I**********                              1   7 CLNKEY                S01194
0121 I**********                              1   60CNUM                  S01194
0122 I**********                              7   7 A                     S01194
0123 I**********                                                          S01194
0124 I** DATA STRUCTURE FOR FLIO EXTRACT DETAILS
0125 I            DS
0126 I                                        1   8 CLNDET
0127 I                                        1   2 ACOC
0128 I***********                             3   80CPAR                                      CSD027
0128 I                                        3   8 CPAR                                      CSD027
0129 I**   LOCAL DATA AREA FOR DATABASE ERROR IDENTIFICATION
0130 ILDA        UDS                            256
0131 I***********                           134 138 DBFILE                S01117
0132 I***********                           139 167 DBKEY                 S01117
0133 I***********                           168 175 DBPGM                 S01117
0134 I***********                           176 1770DBASE                 S01117
0131 I                                      134 141 DBFILE                S01117
0132 I                                      142 170 DBKEY                 S01117
0133 I                                      171 180 DBPGM                 S01117
0134 I                                      181 1830DBASE                 S01117
     C** PARAMETER LIST FOR PROGRAM 'AOBANKR0'                            S01194
     C           PLISTA    PLIST                                          S01194
     C                     PARM '*MSG   ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C** PARAMETER LIST FOR PROGRAM 'AOCUSTR0'                            S01194
     C*                                                                   S01194
     C           PLIST1    PLIST                                          S01194
     C                     PARM '*MSG   ' @RTCD                           S01194
     C                     PARM '*KEY   ' @OPTN                           S01194
     C                     PARM           CKEY   10                       S01194
     C                     PARM '*CNUM  ' KEYSTS  7                       S01194
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
     C*                                                                   S01194
     C**********           MOVEACPY@      BIS@   80                                           260507
0135 C**
0136 C**  FIRST CYCLE-OBTAIN INST. CONTRTOL DATA RECORD 1
0137 C   30                GOTO ENDFC
0138 C                     SETON                     30
     C                     MOVEACPY@      BIS@   80                                           260507
     C                     Z-ADD0         ##BNDX  40                                          260507
     C           *LIKE     DEFN ##BNDX    B                                                   260507
     C           *LIKE     DEFN ##BNDX    ##BSV                                               260507
0139 C**
0211 C**********           EXSR ZSYSTM                                    S01194
0199 C***99*****           SETON                     U7U8LR**DATABASE 01**S01194
0200 C***99*****           Z-ADD1         DBASE                           S01194
0201 C***99*****           MOVE ZTABKY    DBKEY                           S01194
0202 C***99*****           MOVE 'TABLE'   DBFILE                          S01194
0203 C***99*****           GOTO END                                       S01194
     C                     CALL 'AOBANKR0'PLISTA                          S01194
     C           @RTCD     IFNE *BLANKS                                   S01194
0199 C                     SETON                     U7U8LR**DATABASE 01**S01194
0200 C                     Z-ADD1         DBASE                           S01194
0202 C                     MOVE 'SDBANKPD'DBFILE                          S01194
0203 C                     GOTO END                                       S01194
     C                     END                                            S01194
     C*
     C*    CHECK SYSTEM DATE FORMAT, DDMMYY OR MMDDYY.                    S01194
     C           DATF      COMP 'M'                      98MMDDYY, 98 ON  S01194
     C**                                                                  S01194
0147 C**********           MOVE 'A'       A                               S01194
0148 C                     Z-ADD0         ZERO5   50
0149 C           ENDFC     TAG                             * ENDFC TAG
0150 C**
0151 C**  SKIP PROCESSING FOR NON-DETAIL RECORDS
0152 C                     SETOF                     31
0153 C  N01
0154 CANN03                GOTO END
     C*                                                                   S01117
     C** To get COMPANY OF ORIGINATING BRANCH (COOB) :                    S01117
     C*                                                                   S01117
     C           *IN01     IFEQ '1'                                       S01117
      *                                                                                       260507
      ** Check whether details for Branch already in array                                    260507
      *                                                                                       260507
     C                     MOVELORBR      ##KB                                                260507
     C                     EXSR ##CHKB                                                        260507
      *                                                                                       260507
      ** If branch is in the array then use the details                                       260507
      *                                                                                       260507
     C           ##FIC     IFEQ 'Y'                                                           260507
     C                     EXSR ##SETB                                                        260507
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** If branch is not in the array then get details from DB                               260507
      *                                                                                       260507
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM ORBR      @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     SETON                     U7U8LR               S01117
     C                     MOVEL'SDBRCHPD'DBFILE                          S01117
     C                     MOVEL@DSNB     DBKEY            ************** S01117
     C                     MOVEL@OPTN     DBOPTN  7        *DBASE 10 **** S01117
     C                     Z-ADD10        DBASE            ************** S01117
     C                     EXSR *PSSR                                     S01117
     C                     GOTO END                                       S01117
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** Details found on the DB so add them to the array                                     260507
      ** if the array still has room                                                          260507
      *                                                                                       260507
     C                     EXSR ##ADDB                                                        260507
     C                     END                                            S01117
     C                     ENDIF                                                              260507
     C*                                                                   S01117
     C                     MOVE CMPYM     COOB    3                       S01117
     C*                                                                   S01117
     C** To get COMPANY OF BOOKING BRANCH (CMPYM) :                       S01117
     C*                                                                   S01117
      ** Check whether details for Branch already in array                                    260507
      *                                                                                       260507
     C                     MOVELBRCA      ##KB                                                260507
     C                     EXSR ##CHKB                                                        260507
      *                                                                                       260507
      ** If branch is in the array then use the details                                       260507
      *                                                                                       260507
     C           ##FIC     IFEQ 'Y'                                                           260507
     C                     EXSR ##SETB                                                        260507
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** If branch is not in the array then get details from DB                               260507
      *                                                                                       260507
     C**********           CALL 'AOBRCHR0'                                S01117              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM BRCA      @DSNB   3                       S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01117              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     SETON                     U7U8LR               S01117
     C                     MOVEL'SDBRCHPD'DBFILE                          S01117
     C                     MOVEL@DSNB     DBKEY            ************** S01117
     C                     MOVEL@OPTN     DBOPTN  7        *DBASE 11 **** S01117
     C                     Z-ADD11        DBASE            ************** S01117
     C                     EXSR *PSSR                                     S01117
     C                     GOTO END                                       S01117
     C                     ELSE                                                               260507
      *                                                                                       260507
      ** Details found on the DB so add them to the array                                     260507
      ** if the array still has room                                                          260507
      *                                                                                       260507
     C                     EXSR ##ADDB                                                        260507
     C                     END                                            S01117
     C                     ENDIF                                                              260507
     C                     END                                            S01117
     C*                                                                   S01117
0155 C**  ACCUMULATE TOTALS OF ALL LIVE RECORDS
0156 C           TOTCNT    ADD  1         TOTCNT  50
0157 C                     MOVE AMT       ZZAMT
0158 C                     Z-ADDTOTWHN    ZZTOTI
0159 C                     Z-ADDTOTDC     ZZTOTD
0160 C                     EXSR GLZADD
0161 C**
0162 C                     Z-ADDZZTOTI    TOTWHN 150
0163 C                     Z-ADDZZTOTD    TOTDC   30
0164 C**
0165 C   03                GOTO END
0166 C**
0167 C**  SEE IF DEAL TYPE MATCHES WITH ONE OF THE DEAL TYPES TO
0168 C**  BE EXTRACTED
0169 C           DTYP      LOKUPTABDTP                   31
0170 C**
0171 C  N31                GOTO END
0172 C****CHECK*FOR*EXISTENCE*OF*CUST.*ON*CLINT*FILE                      S01194
0173 C**********           EXSR CLNCHN                                    S01194
0174 C**N04*****           SETON                     U7U8LRD/B ERROR      S01194
0175 C**N04*****           MOVE 'CLINT'   DBFILE                          S01194
0176 C**N04*****           MOVE CLNKEY    DBKEY                           S01194
0177 C**N04*****           Z-ADD2         DBASE            DBASE 2        S01194
0178 C**N04*****           GOTO END                                       S01194
     C*                                                                   S01194
0172 C**  CHECK FOR EXISTENCE OF CUST. ON SDCUSTPD                        S01194
     C                     MOVELCNUM      CKEY                            S01194
     C                     CALL 'AOCUSTR0'PLIST1                          S01194
     C           @RTCD     IFNE *BLANKS                                   S01194
     C           @RTCD     ANDNE'*CUSCLS'                                                   MD041994
0205 C                     SETON                     U7U8LR               S01194
0206 C                     MOVE 'SDCUSTPD'DBFILE                          S01194
0207 C                     MOVE CKEY      DBKEY                           S01194
0208 C                     Z-ADD2         DBASE            DBASE 2        S01194
0209 C                     GOTO END                                       S01194
     C                     END                                            S01194
     C                     MOVE BBACOC    ACOC                            S01194
     C                     MOVE BBPCNB    CPAR                            S01194
     C*                                                                   S01194
0179 C                     MOVE CLNDET    SAVDET  8        * SAVE CHILD/
0180 C                     MOVE CNUM      SAVNUM  60       * LONER DETS
0181 C**
0182 C**  KEEP COUNT AND HASH OF EXTRACTED DETAILS
0183 C                     EXSR HASTOT
     C***********CPAR      COMP 0                        20               BHF118              CSD027
     C           CPAR      COMP *BLANKS                  20                                   CSD027
0184 C   20                GOTO END
0185 C** EXTRACT PARENT ACOC
0186 C**************       SETOF                     0432                 S01194
0187 C***********          MOVE CPAR      SAVPAR  60       * SAVE PARNT NO                    CSD027
     C                     MOVE CPAR      SAVPAR  6        * SAVE PARNT NO                    CSD027
0188 C**********           MOVE 'A'       PARKEY  7                       S01194
0189 C**********           MOVELCPAR      PARKEY                          S01194
0190 C********** PARKEY    CHAINCLINT                32                   S01194
0191 C**N04*****           SETON                     U7U8LR               S01194
0192 C**N04*****           MOVE 'CLINT'   DBFILE                          S01194
0193 C**N04*****           MOVE PARKEY    DBKEY                           S01194
0194 C**N04*****           Z-ADD3         DBASE            DBASE 3        S01194
0195 C**N04*****           GOTO END                                       S01194
0230 C                     MOVELCPAR      CKEY                            S01194
     C                     CALL 'AOCUSTR0'PLIST1                          S01194
     C           @RTCD     IFNE *BLANKS                                   S01194
     C           @RTCD     ANDNE'*CUSCLS'                                                   MD041994
     C                     MOVE CKEY      DBKEY                        ***S01194
     C                     MOVE 'SDCUSTPD'DBFILE           ***************S01194
0237 C                     Z-ADD3         DBASE            DBASE 3        S01194
0234 C                     SETON                     U7U8LR               S01194
0238 C                     GOTO END                                       S01194
     C                     END                                            S01194
     C                     MOVE BBACOC    ACOC                            S01194
     C                     MOVE BBPCNB    CPAR                            S01194
     C*                                                                   S01194
0196 C                     MOVE SAVPAR    CLNDET
0197 C                     MOVE SAVNUM    CNUM
0198 C                     SETOF                     20
0199 C                     EXSR HASTOT
0200 C**
0201 C**
0202 C           END       TAG                               * END TAG
0203 C**
0204 C**  LR CALCULATIONS- TOTALS BALANCE CHECK
0205 CLR         EXTCNT    ADD  1         EXTCNT
0206 CLRNU8      TOTCNT    COMP NLRA                 U8U8
0207 CLRNU8      TOTWHN    COMP VLAF                 U8U8
0208 CLRNU8      TOTDC     COMP VLAL                 U8U8
0209 CLR U7                MOVE 'LE0736'  DBPGM
      *                                                                   S01117
     CLR U7 U8             EXSR *PSSR                                     S01117
0211 C********************************************************************
      /EJECT                                                                                  260507
      ********************************************************************                    260507
      *                                                                  *                    260507
      * ##CHKB - Subroutine to check the Branch in the arrays            *                    260507
      *                                                                  *                    260507
      ********************************************************************                    260507
     C           ##CHKB    BEGSR                                                              260507
      *                                                                                       260507
     C           *LIKE     DEFN A8BRCD    ##KB                                                260507
      *                                                                                       260507
      ** Set off the branch found indicator                                                   260507
      *                                                                                       260507
     C                     MOVEL*BLANK    ##FIC   1                                           260507
      *                                                                                       260507
      ** Save the state of indicator 30 so it can be reset at the end                         260507
      ** of the SR as it may be used elsewhere in the code                                    260507
      *                                                                                       260507
     C           *IN30     IFEQ *ON                                                           260507
     C                     MOVEL'Y'       #IN30   1                                           260507
     C                     ELSE                                                               260507
     C                     MOVEL'N'       #IN30                                               260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
     C                     SETOF                         30                                   260507
      *                                                                                       260507
      ** Restore the saved value of B                                                         260507
      *                                                                                       260507
     C                     Z-ADD##BSV     B                                                   260507
      *                                                                                       260507
      ** Check whether details for Branch already in array                                    260507
      *                                                                                       260507
      ** Is this the same as the last LOKUP, if so we can bypass                              260507
      ** the LOKUP                                                                            260507
      ** Defend against B being 0                                                             260507
      *                                                                                       260507
     C           B         IFEQ 0                                                             260507
     C                     Z-ADD1         B                                                   260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** If the branch being checked is the same then use these                               260507
      ** details rather than doing a LOKUP                                                    260507
      *                                                                                       260507
     C           ##KB      IFEQ ##BR,B                                                        260507
      *                                                                                       260507
      ** Found, so seton 30                                                                   260507
      *                                                                                       260507
     C                     SETON                         30                                   260507
     C                     ELSE                                                               260507
     C                     Z-ADD1         B                                                   260507
     C           ##KB      LOKUP##BR,B                   30                                   260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** Save the last update to B                                                            260507
      *                                                                                       260507
     C           *IN30     IFEQ *ON                                                           260507
     C                     Z-ADDB         ##BSV                                               260507
      *                                                                                       260507
      ** Set the indicator to show the data was found                                         260507
      *                                                                                       260507
     C                     MOVEL'Y'       ##FIC                                               260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** Reset the state of indicator 30.                                                     260507
      *                                                                                       260507
     C           #IN30     IFEQ 'Y'                                                           260507
     C                     MOVEL*ON       *IN30                                               260507
     C                     ELSE                                                               260507
     C                     MOVEL*OFF      *IN30                                               260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
     C                     ENDSR                                                              260507
      ********************************************************************                    260507
      /EJECT                                                                                  260507
      ********************************************************************                    260507
      *                                                                  *                    260507
      * ##SETB - Sets up the SDBRCHPD fields used in the code from the   *                    260507
      *          arrays                                                  *                    260507
      *                                                                  *                    260507
      ********************************************************************                    260507
     C           ##SETB    BEGSR                                                              260507
      *                                                                                       260507
     C                     MOVEL##BR,B    A8BRCD                                              260507
     C                     MOVEL##BC,B    CMPYM                                               260507
     C                     MOVEL##BI,B    A8BICN                                              260507
      *                                                                                       260507
     C                     ENDSR                                                              260507
      *                                                                                       260507
      ********************************************************************                    260507
      /EJECT                                                                                  260507
      ********************************************************************                    260507
      *                                                                  *                    260507
      * ##ADDB - Adds the SDBRCHPD fields used in the code to the arrays *                    260507
      *                                                                  *                    260507
      ********************************************************************                    260507
     C           ##ADDB    BEGSR                                                              260507
      *                                                                                       260507
      ** If there is still room in the array then add the details                             260507
      *                                                                                       260507
     C           ##BNDX    IFLT 999                                                           260507
     C                     ADD  1         ##BNDX                                              260507
     C                     Z-ADD##BNDX    B                                                   260507
     C                     MOVELA8BRCD    ##BR,B                                              260507
     C                     MOVELCMPYM     ##BC,B                                              260507
     C                     MOVELA8BICN    ##BI,B                                              260507
     C                     ENDIF                                                              260507
      *                                                                                       260507
      ** Update ##BSV so next call to ##CHKB checks this latest addition                      260507
      ** to the array first                                                                   260507
      *                                                                                       260507
     C                     Z-ADDB         ##BSV                                               260507
      *                                                                                       260507
     C                     ENDSR                                                              260507
      ********************************************************************                    260507
      /EJECT                                                                                  260507
      ********************************************************************                    260507
0212 C****CLNCH*SUBR.*TO*OBTAIN*CLIENT*DETAILS                            S01194
0213 C*SR*****    CLNCHN    BEGSR                           **  CLNCHN  **S01194
0214 C**********                                                          S01194
0215 C**********           SETOF                     3204                 S01194
0216 C********** CLNKEY    CHAINCLINT                32                   S01194
0217 C**********                                                          S01194
0218 C**********           ENDSR                                          S01194
0219 C********************************************************************
0220 C**
0221 C********************************************************************
0222 C**  HASTOT SUBR. TO ACCUMULATE TOTALS OF EXTRACTED RECORDS
0223 C**  2 FOR CHILD , 1 FOR LONER
0224 C**
0225 CSR         HASTOT    BEGSR                           **  HASTOT   **
0226 C           EXTCNT    ADD  1         EXTCNT  50
0227 C                     Z-ADDEXTWHN    ZZTOTI
0228 C                     Z-ADDEXTDC     ZZTOTD
0229 C                     EXSR GLZADD
0230 C**
0231 C                     Z-ADDZZTOTI    EXTWHN 150
0232 C                     Z-ADDZZTOTD    EXTDC   30
0233 C**
0234 C                     ENDSR
0235 C********************************************************************
0236 C********************************************************************
0237 C**
0469 C*****ZSYSTM*SR.*TO*CHAIN TO THE INSTALLATION CONTROL DATA RECORD.   S01194
0470 C**********                                                          S01194
0471 C********** ZSYSTM    BEGSR                           *** ZSYSTM *** S01194
0472 C**********                                                          S01194
0473 C*****SET*UP*KEY*FOR*INSTALLATION CONTROL RECORD.                    S01194
0474 C**********           MOVEL'01      'ZTABKY 12                       S01194
0475 C**********           MOVE '  10'    ZTABKY                          S01194
0476 C**********                                                          S01194
0477 C********** ZTABKY    CHAINTABLE                99    ON NOT THERE   S01194
0478 C**N99***** RECI      COMP 'D'                  9999  ON, IS DELETED S01194
0479 C**********                                                          S01194
0480 C*****CHECK*SYSTEM*DATE FORMAT, DDMMYY OR MMDDYY.                    S01194
0481 C********** DATF      COMP 'M'                      98MMDDYY, 98 ON  S01194
0482 C**********                                                          S01194
0483 C**********           ENDSR                                          S01194
0253 C**
0254 C**
0255 C********************************************************************
0256 C********************************************************************
0257 C* SUBROUTINE TO ADD AN AMOUNT (ZZAMT) TO THE TOTAL (ZZTOTI,ZZTOTD)
0258 C*   IND '99' IS SET BY AN OVERFLOW ERROR
0259 C*
0260 CSR         GLZADD    BEGSR                           *** GLZADD ****
0261 C*
0262 CSR                   Z-ADDZZAMT     ZZAMT  153     91-DEFINE ZZAMT
0263 CSR 91                GOTO ZZAEND                     AMT = 0.BYPASS
0264 C*
0265 C* SPLIT ZZAMT INTO INTEGER AND DECIMAL FIELDS
0266 CSR                   Z-ADDZZAMT     ZZAMTI 150       INTEGER FIELD
0267 CSR                   MOVE ZZAMT     ZZAMTD  30       DECIMAL FIELD
0268 C* BOTH ZZAMTI AND ZZAMTD CONTAIN A 'SIGN' ZONE NOW
0269 C*
0270 CSR                   EXSR GLZSUM
0271 CSR         ZZAEND    ENDSR                           ** ZZAEND TAG *
0272 C*
0273 C********************************************************************
0274 C********************************************************************
0275 C* SUBROUTINE TO CARRY OUT THE ADDITION FOR SUBROUTINES -
0276 C*                        GLZADD, GLZSUB, GLZCMP.
0277 C*          PARAMETERS PASSED -
0278 C*                     I/P ZZAMTI ZZAMTD
0279 C*                     O/P ZZTOTI ZZTOTD ZZNEGD IND 96 IND 99.
0280 C*
0281 CSR         GLZSUM    BEGSR                           *** GLZSUM ****
0282 C*
0283 CSR                   Z-ADDZZTOTI    ZZTOTI 150       DEFINE ZZTOTI
0284 CSR                   Z-ADDZZTOTD    ZZTOTD  30       DEFINE ZZTOTD
0285 CSR                   SETOF                     919293
0286 CSR                   SETOF                     949599
0287 C*
0288 C*    DETERMINE SIGN OF ZZAMTI & D,   92 IF NEG
0289 CSR         ZZAMTI    COMP 0                      9293
0290 CSR 93      ZZAMTD    COMP 0                      9293
0291 CSR 93                GOTO ZZSEND                     ZERO BYPASS
0292 C*
0293 C*    DETERMINE SIGN OF ZZTOTI & D, 91 IF NEG.
0294 CSR         ZZTOTI    COMP 0                      9193
0295 CSR 93      ZZTOTD    COMP 0                      9193
0296 C*
0297 C*    IF ZZTOTAL IS ZERO, RETURN ZZAMOUNT.
0298 CSR 93                Z-ADDZZAMTI    ZZTOTI
0299 CSR 93                Z-ADDZZAMTD    ZZTOTD
0300 CSR 93                GOTO ZZSEND                     ZERO BYPASS
0301 C*    IF SIGNS DIFFER BYPASS OVERFLOW CHECKS.
0302 CSR 91N92
0303 CORN91 92             GOTO ZZOFPS
0304 C*
0305 CSR         ZZAMTD    ADD  ZZTOTD    ZZWK2   40
0306 CSR         ZZWK2     COMP 999                  93    '93' = CARRY
0307 CSRN93      ZZWK2     COMP -999                   93    INTO INTEGER.
0308 C*
0309 CSR 93N92   ZZAMTI    ADD  1         ZZWK3  150       ADD 'CARRY' +VE
0310 CSR    93 92ZZAMTI    SUB  1         ZZWK3            SUB 'CARRY' -VE
0311 CSR 93      ZZTOTI    ADD  ZZWK3     ZZWK3
0312 CSRN93      ZZTOTI    ADD  ZZAMTI    ZZWK3
0313 C*
0314 C* IF THE MODULUS OF ZZWK3 IS LT MOD. ZZTOTI THEN O/F HAS OCCURED
0315 CSRN92      ZZWK3     COMP ZZTOTI                 99  -92 MEANS NOS.
0316 CSR 92      ZZWK3     COMP ZZTOTI               99     NEGATIVE
0317 CSRN99                Z-ADDZZWK2     ZZTOTD
0318 CSRN99                Z-ADDZZWK3     ZZTOTI
0319 C*
0320 C* IF O/F ZEROIZE ZZAMT , IND '99' SET AND ZZTOT FIELDS LEFT INTACT.
0321 CSR 99                Z-ADD0         ZZAMT  153
0322 CSR                   GOTO ZZSEND
0323 C*
0324 C* THE 'SIGNS' ARE DIFFERENT
0325 CSR         ZZOFPS    TAG                             ** ZZOFPS TAG**
0326 C* IF ZZAMT WAS NEGATIVE, MAKE IT POS. TO COMP WITH ZZTOT
0327 C*
0328 CSR 92                Z-SUBZZAMTI    ZZAMTI 150
0329 CSR 92                Z-SUBZZAMTD    ZZAMTD  30
0330 C*
0331 C* IF ZZTOT WAS NEGATIVE, MAKE IT POS. TO COMP WITH ZZAMT.
0332 C*
0333 CSR 91                Z-SUBZZTOTI    ZZTOTI
0334 CSR 91                Z-SUBZZTOTD    ZZTOTD
0335 C* BOTH ZZAMT AND ZZTOT ARE NOW POSITIVE.
0336 C*
0337 CSR         ZZTOTI    COMP ZZAMTI               93  95
0338 CSR 95      ZZTOTD    COMP ZZAMTD               93  95
0339 C*
0340 C* IF ZZTOT EQ. ZZAMT RETURN ZERO.
0341 CSR 95                Z-ADD0         ZZTOTI
0342 CSR 95                Z-ADD0         ZZTOTD
0343 CSR 95                GOTO ZZSEND
0344 C*
0345 C* IF ZZTOT GT. ZZAMT.
0346 CSR 93      ZZAMTD    COMP ZZTOTD               94
0347 CSR 93 94   ZZTOTI    SUB  1         ZZTOTI
0348 CSR 93 94   ZZTOTD    ADD  1000      ZZWK2
0349 CSR 93      ZZTOTI    SUB  ZZAMTI    ZZTOTI
0350 CSR 93 94   ZZWK2     SUB  ZZAMTD    ZZTOTD
0351 CSR 93N94   ZZTOTD    SUB  ZZAMTD    ZZTOTD
0352 C*
0353 C*
0354 C* IF ZZAMT GT. ZZTOT.
0355 CSRN93      ZZTOTD    COMP ZZAMTD               94
0356 CSRN93 94   ZZAMTI    SUB  1         ZZWK3  150
0357 CSRN93 94   ZZAMTD    ADD  1000      ZZWK2
0358 CSRN93 94   ZZWK3     SUB  ZZTOTI    ZZTOTI
0359 CSRN93N94   ZZAMTI    SUB  ZZTOTI    ZZTOTI
0360 CSRN93 94   ZZWK2     SUB  ZZTOTD    ZZTOTD
0361 CSRN93N94   ZZAMTD    SUB  ZZTOTD    ZZTOTD
0362 C*
0363 C* REVERSE SIGN OF ZZTOT IF LARGER I/P FIELDS WERE NEGATIVE
0364 CSR                   SETOF                     94
0365 CSR 93 91
0366 CORN93 92             SETON                     94
0367 CSR 94                Z-SUBZZTOTI    ZZTOTI
0368 CSR 94                Z-SUBZZTOTD    ZZTOTD
0369 C**
0370 C**   RESTORE SIGN OF ZZAMTI & ZZAMTD IF IT WAS REVERSED.
0371 CSR 92                Z-SUBZZAMTI    ZZAMTI
0372 CSR 92                Z-SUBZZAMTD    ZZAMTD
0373 CSR         ZZSEND    TAG                             ** ZZSEND TAG *
0374 C**
0375 C**   IF ZZTOTD IS ZERO, AND ZZTOTI IS NEG. SET UP ZZNEGD.
0376 CSR                   SETOF                     96
0377 CSR         ZZTOTD    COMP 0                        91
0378 CSR 91      ZZTOTI    COMP 0                      96
0379 CSR 96                MOVE '.000-'   ZZNEGD  5
0380 CSR                   ENDSR                             ** ENDSR **
0381 C********************************************************************
     C********************************************************************S01117
     C*                                                                   S01117
     C*  *PSSR --- SUBROUTINE TO HANDLE ABNORMAL ERROR CONDITIONS         S01117
     C*                                                                   S01117
     C*  CALLED FROM: AFTER ABNORMAL OPERATION OCCURS                     S01117
     C*                                                                   S01117
     C*  CALLS: NOTHING                                                   S01117
     C*                                                                   S01117
     C********************************************************************S01117
     C*                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C                     ENDSR                           ** *PSSR **    S01117
     C*                                                                   S01117
     C********************************************************************S01117
0382 O**  FPORT EXTRACT RECORDS - DEALS DETAILS
0383 OFPORTFP D        31 20NLR
0384 O** UTILISED FOR LONER
0385 O                                    1 'D'
0386 O                         SAVDET     9
0387 O                         CNUM      15
0388 O                                   16 'L'
0389 O                                   17 '4'
     O                 66                17 '2'
0390 O                                   18 'U'
0391 O                         CCY       21
0392 O                         AMT       29P
     O                 66      FACT      32
     O                 66                33 '-'
     O                 66      FCNO      35
0393 O                         ZERO5     38P
0394 O                         DTYP      40
0395 O                         DLNO      46
0396 O                                   47 'D'
0397 O***********              BRCD      50                               S01117
0397 O                         BRCA      50                               S01117
     O                         CMPYM     70                               S01117
     O                         ORBR      73                               S01117
     O                         COOB      76                               S01117
0398 O** UTILISED FOR CHILD
0399 O        D        31N20NLR
0400 O                                    1 'D'
0401 O                         SAVDET     9
0402 O                         CNUM      15
0403 O                                   16 'C'
0404 O                                   17 '4'
     O                 66                17 '2'
0405 O                                   18 'U'
0406 O                         CCY       21
0407 O                         AMT       29P
     O                 66      FACT      32
     O                 66                33 '-'
     O                 66      FCNO      35
0408 O                         ZERO5     38P
0409 O                         DTYP      40
0410 O                         DLNO      46
0411 O                                   47 'D'
0412 O***********              BRCD      50                               S01117
0412 O                         BRCA      50                               S01117
     O                         CMPYM     70                               S01117
     O                         ORBR      73                               S01117
     O                         COOB      76                               S01117
0413 O**  UTILISED FOR PARENT
0414 O        D        31N20NLR
0415 O                                    1 'D'
0416 O                         CLNDET     9
0417 O                                   15 '999999'
0418 O                                   16 'P'
0419 O                                   17 '4'
     O                 66                17 '2'
0420 O                                   18 'U'
0421 O                         CCY       21
0422 O                         AMT       29P
     O                 66      FACT      32
     O                 66                33 '-'
     O                 66      FCNO      35
0423 O                         ZERO5     38P
0424 O                         DTYP      40
0425 O                         DLNO      46
0426 O                                   47 'D'
0427 O***********              BRCD      50                               S01117
0427 O                         BRCA      50                               S01117
     O                         CMPYM     70                               S01117
     O                         ORBR      73                               S01117
     O                         COOB      76                               S01117
0428 O**  FPORT TRAILER
0429 OFPORTT2 T        LRNU7
0430 O                                    1 'T'
0431 O                         EXTCNT     4P
0432 O                         EXTWHN    12P
0433 O                         EXTDC     14P
0434 O**
0435 O**   CONTROL REPORT
0436 O**
0437 O*PRINT  T  203   LR U7                                              S01124
0437 O*E0736P1T**203   LR U7                                     S01124   S01117
     OLE0736AUT  203   LR U7                                              S01117
0438 O***********                        22 'REFERENCE LE0736'            S01117
0438 O                                   24 'REFERENCE LE0736AU'          S01117
0439 O                         TITL      89
0440 O                                  104 'DATE'
0441 O                         RUNA     112
0442 O                                  122 'PAGE'
0443 O                         PAGE  Z  127
0444 O        T  1     LR U7
0445 O                                   68 'DEALS EXTRACT FOR CUSTOM'
0446 O                                   88 'ER LENDING PORTFOLIO'
0447 O        T  3     LR U7
0448 O                                   68 '------------------------'
0449 O                                   88 '--------------------'
0450 O        T 32     LR U7
0451 O                                   51 '*** REFERENCE LE0736'
0452 O                                   71 '- DATABASE ERROR AT'
0453 O***********              DBASE     74                               S01117
0453 O                         DBASE     75                               S01117
0454 O        T        LR U7
0455 O                                   37 'FILENAME'
0456 O***********              DBFILE    43                               S01117
0457 O***********                        48 'KEY'                         S01117
0458 O***********              DBKEY     78                               S01117
0456 O                         DBFILE    46                               S01117
0457 O                                   51 'KEY'                         S01117
0458 O                         DBKEY     81                               S01117
0459 O        T   03   LR
0460 O***********                        22 'REFERENCE LE0736'            S01117
0460 O                                   24 'REFERENCE LE0736AU'          S01117
0461 O                         TITL      89
0462 O                                  104 'DATE'
0463 O                         RUNA     112
0464 O                                  122 'PAGE'
0465 O                         PAGE  Z  127
0466 O        T 2      LR
0467 O                                   60 'DEALS EXTRACT FOR CUSTOM'
0468 O                                   84 'ER LENDING PORTFOLIO - F'
0469 O                                   96 'ILE CONTROLS'
0470 O        T 1      LR
0471 O                                   60 '------------------------'
0472 O                                   84 '------------------------'
0473 O                                   96 '------------'
0474 O        T 3      LR
0475 O                                   28 'S/DEALS - RUN CONTROLS'
0476 O                                   59 'NUMBER'
0477 O                                   84 'VALUE'
0478 O        T 1      LR
0479 O                                   28 '----------------------'
0480 O                                   59 'OF RECORDS'
0481 O                                   84 'OF RECORDS'
0482 O        T 2      LR
0483 O                                   29 'TOTAL RECORDS ON FILE'
0484 O                      NU7NLRA  3   59
0485 O                      NU7VLAF  4   81
0486 O                      NU7VLAL      84
0487 O        T 2      LR
0488 O                                   29 'TOTAL RECORDS ON FILE'
0489 O                                   42 '- CALCULATED'
0490 O                         TOTCNT3   59
0491 O                         TOTWHN4   81
0492 O                         TOTDC     84
0493 O                   NU7 U8         111 '***   DIFFERENCE   ***'
0494 O        T 3      LR
0495 O                                   28 'S/FPORT - RUN CONTROLS'
0496 O        T 1      LR
0497 O                                   28 '----------------------'
0498 O        T 2      LR
0499 O                                   29 'RECORDS ADDED TO FILE'
0500 O                         EXTCNT3   59
0501 O                         EXTWHN4   81
0502 O                         EXTDC     84
0503 O********T*3      LR                                                 S01117
0504 O***********                        76 '*** END OF REPORT ***'       S01117
** TABDTP - DEAL TYPES TO BE EXTRACTED
IPCLLNDLTIBDTBDATABPC1C2
** CPY@   **      OBJECT COPYRIGHT
(c) Finastra International Limited 2001
