     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Funding participant details maintenance')     *
      *****************************************************************
      *                                                               *
      *  Midas - Customer Lending Module                              *
      *                                                               *
      *  LE2021 - Funding Participant Details Maintenance             *
      *                                                               *
      *  Function:  This program allows entry and maintenance of the  *
      *             of the funding participant members within a       *
      *             syndicate.                                        *
      *             This could be run in any of the four modes        *
      *             available, depending on the parameter passed to it*
      *                                                               *
      *               1. Interactive ('I') - The program is called    *
      *             from LE2020, facilities input. Data is processed  *
      *             through a screen in the standard way.             *
      *                                                               *
      *               2. Interactive Enquiry ('E') - The program is   *
      *             called from LE0170, facilities enquiry. It may    *
      *             also be called from LE2020, where it is appropriate
      *             to restrict the action to enquiry. Data is        *
      *             processed through a screen in the standard way.   *
      *                                                               *
      *               3. Record ('R') - Run interactively but updates *
      *             are done to a new 'test harness' file (LE2021PD)  *
      *                                                               *
      *               4. Mode 'P' - Play - The program is run         *
      *             interactively or in batch through a Midas test    *
      *             environment. Data is read in from the 'test       *
      *             harness' file written in mode 'R'. Updates will   *
      *             be done as in mode 'I'.                           *
      *                                                               *
      *               5. Mode 'B' - Batch - The program is run in     *
      *             batch, called by a communications control program.*
      *             Data which has been entered via a PC front end    *
      *             is received from a message queue and passed to    *
      *             the program as a parameter. Updates to the Midas  *
      *             database will be done as appropriate to the       *
      *             contents of the parameter and a message will be   *
      *             returned to the control program.                  *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. CSD103             Date 10Aug20               *
      *  Prev Amend no. MD046248           Date 27Oct17               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CLE064             Date 06Dec10               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 CRE026             Date 24May06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CLE106             Date 11Mar05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 28Oct03               *
      *                 CAP073             Date 08Aug02               *
      *                 CLE029             Date 04Sep02               *
      *                 CLE034             Date 05May03               *
      *                 CLE031             Date 03Feb03               *
      *                 CLE028             Date 27Jun02               *
      * Midas Release 4.01.03 ----------------------------------------*
      *                 202456             Date 06Jan03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 28Jun02               *
      *                 203191             Date 20Feb02               *
      *                 CLE023             Date 19Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 178424             Date 10May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CRT004             Date 04May00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 162883             Date 01Jul99               *
      *                 161257             Date 21Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 160630             Date 19May99               *
      *                 157594             Date 07Apr99               *
      *                 157593             Date 30Mar99               *
      *                 157004             Date 23Mar99               *
      *                 155949             Date 01Mar99               *
      *                 156044             Date 26Feb99               *
      *                 154799             Date 24Feb99               *
      *                 CLE008             Date 27Nov98               *
      *                 155147             Date 18Feb99               *
      *                 154560             Date 09Feb99               *
      *                 153782             Date 26Jan99               *
      *                 153666             Date 22Jan99               *
      *                 148851             Date 13Jan99               *
      *                 148847             Date 18Jan99               *
      *                 148844             Date 14Jan99               *
      *                 148722             Date 15Feb99               *
      *                 154591             Date 11Feb99               *
      *                 148191             Date 19Nov98               *
      *                 147261             Date 27Jan99               *
      *                 143614             Date 28Sep98               *
      *                 121971             Date 09Jun98               *
      *                 142389             Date 06Dec98               *
      *                 141483             Date 18Feb99               *
      *                 140835             Date 16Feb99               *
      *                 135152             Date 11Feb99               *
      *                 134494             Date 10Feb99               *
      *                 CEU004             Date 29Mar98               *
      *                 126517             Date 17Feb98               *
      *                 130237             Date 10Feb98               *
      *                 127729             Date 04Dec97               *
      *                 127641             Date 17Nov97               *
      *                 CLE005             Date 22May97               *
      *                 123857             Date 27Oct97               *
      *                 124480             Date 22Oct97               *
      *                 123801             Date 06Oct97               *
      *                 123390             Date 24SEP97               *
      *                 122615             Date 04SEP97               *
      *                 122105             Date 29AUG97               *
      *                 122052             Date 21AUG97               *
      *                 121988             Date 20AUG97               *
      *                 121783             Date 14AUG97               *
      *                 120525             Date 14JUL97               *
      *                 120468             Date 09JUL97               *
      *                 119925             Date 30JUN97               *
      *                 119892             Date 30JUN97               *
      *                 CLE004  *CREATE    Date 14JAN97               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CSD103 - LIBOR Deregulation - Common Layer/Standing Data     *
      *  MD046248 - Finastra Rebranding                               *
      *  CLE134 - Past Due Call Loan Processing (Recompile)           *
      *  CLE148 - Alpha Loan Reference                                *
      *  CLE064 - Enhancement of Lending Frequencies (Recompile)      *
      *  CRE026 - Consumer Banking                                    *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  CLE106 - Syndication Manager (Recompile)                     *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Parameter Mismatch                                  *
      *  CAP073 - Conversion of MN inputs into modular structure to   *
      *           use as APIs. Facility input Transaction Details     *
      *  CLE029 - Addition of Severity code and Limit ID to FCLTYFM   *
      *  CLE034 - Lending Enhancements for Phase 1 Priority 1A        *
      *           (recompile).                                        *
      *  CLE031 - Lending Enhancements.                               *
      *  CLE028 - Flat Rate Personal Loans (Rule of 78s)              *
      *  202456 - Participant facilities not closed correctly         *
      *  CPK015 - Release 4.01 Packaging:                             *
      *           - A default timestamp string is required for WRITE. *
      *  203191 - Default participant facility currency from its      *
      *           Prime facility.                                     *
      *  CLE023 - Lending Facility History Improvements.              *
      *  178424 - Upon pressing F21 when enquiring or amending an     *
      *           expired syndicated facility, system encounters a    *
      *           database error.  Also changed the logical file used *
      *           to access syndicated members of a prime facility so *
      *           as to be able to read both live and expired syndi-  *
      *           cated members.                                      *
      *  CRT004 - Cashier Midas TCP/IP interface.                     *
      *             Recompiled over SDBRCHPD Changes                  *
      *  162883 - Incorrect defaulting of TR funding participants     *
      *           when branch of CA is different with TR.             *
      *  161257 - Incorrect defaulting of account officer for         *
      *           funding/internal facility and the bank is the       *
      *           agent                                               *
      *  160630 - The error on syndicate share when the amount/       *
      *           percentage is greater than the portion left on the  *
      *           syndicate should have different error message.      *
      *  157594 - Validation added to VLDSHR to cross check whether   *
      *           changes in internal funding on a facility leads to  *
      *           risk being oversold.                                *
      *  157593 - If a funding participant is created against a       *
      *           tranche, then this funding participant should not   *
      *           be linked to any CA facility.                       *
      *  157004 - Condition the default closing date of the funding   *
      *           participant so that it's within the range of the    *
      *           approval date and the expiry date. Additional fix   *
      *           is to move the fields from the PC Msg input file to *
      *           the participant facility file.                      *
      *  155949 - Fund. Part. amount incorrectly calculated in Batch. *
      *  156044 - Wrong Name and Address Code returned to Loan Manager*
      *  154799 - Recompiled due to changes in /COPY,ZACCH            *
      *  CLE008 - Switchable Feature For Loan Administrator Id        *
      *           Recompiled due to changes in FCLTYFM                *
      *  155147 - Recompiled due to changes in LE2021DF.              *
      *  154560 - Secured indicator shown as '8' instead of 'Y', and  *
      *           Amending and Authorising User were not updated      *
      *           accordingly.                                        *
      *  153782 - PCRF field not setup correctly when creating Fun-   *
      *           ding Participants.                                  *
      *  153666 - Alt name/address code must be amendable.            *
      *  148851 - For TR, funding participants not defaulting from CA *
      *           at setup                                            *
      *  148847 - Screen handling/workflow is wrong after second      *
      *           screen.                                             *
      *  148844 - Value date should not be earlier than Joining date. *
      *  148722 - Availibility run date input incorrectly             *
      *  154591 - Incorrect setup of run dates for tranche participant*
      *  148191 - Wrong Agent can be accessed if facility is amended  *
      *           from non-syndicated to syndicated.                  *
      *  147261 - Add Assignment or Participation indicator           *
      *  143614 - Need to cope with a direct amendment of a           *
      *           participant facility on Loan Manager.               *
      *  121971 - Funding Participant is not allowed to be the        *
      *           Syndicate Agent.                                    *
      *  142389 - LE0300 file out of balance                          *
      *  141483 - Facility Start Date for new syndicate member set    *
      *           before joining date                                 *
      *  140835 - Funding Participant Enquiry Layout and showing      *
      *           names could be better.                              *
      *  135152 - There needs to be a separate standard settlement    *
      *           instruction transaction type for Lending - use of   *
      *           'MM' is not sufficiently flexible                   *
      *  134494 - Cannot close funding participants from the PC.      *
      *  CEU004 - LE Settlement Ccy conversion Upgrade to DBA R2.0    *
      *  126517 - Settlement details are not being written to the     *
      *           data base.                                          *
      *  130237 - Recompile due to changed LEF1MFPD                   *
      *  127729 - OOB in LE0300 due to reversal                       *
      *  127641 - Participant Facility deleted though a loan          *
      *           is attached to its Prime Facility                   *
      *  CLE005 - Customer Lending Enhancements - Tranche 3           *
      *  123857 - F12 from subfile should take you to Facilities      *
      *           Maintenance                                         *
      *         - F3 should exit facilities maintenance program       *
      *  124480 - Allow percentage/amount to be zero.                 *
      *  123801 - Return exact settlement detail error in batch mode  *
      *  123390 - Amending 2 funding participant facilites from the   *
      *           PC dumps if the larger share is sent first. Remove  *
      *           validation of share amount for batch mode.          *
      *  122615 - Authorise participant facilities                    *
      *  122105 - In batch mode the prime facility may be deleted     *
      *           before the participant, giving database error 2.    *
      *  122052 - Name of message file not set up correctly.          *
      *  121988 - Cannot amend a facility from the PC because Funding *
      *           Part fails on validation of available amount        *
      *  121783 - Call new access object AOBRCHR1 instead of AOBRCHR0 *
      *           (uses the long data structure DSSDY)                *
      *  120525 - Facility sequence number allocation.                *
      *  120468 - Include a DUMP in SRBERR subroutine for Batch and   *
      *           Play modes.                                         *
      *  119925 - Show facilty sequence number as part of the message *
      *  119892 - Rename SPARE to SPARF                               *
      *  CLE004 - Customer Lending Enhancements - Syndications.       *
      *                                                               *
      *****************************************************************
      *                                                               *
      *    F U N C T I O N   O F   I N D I C A T O R S                *
      *                                                               *
      *    03      F3 PRESSED EXIT PROGRAM
      *    05      F5 PRESSED Refresh screen
      *    09      F9 PRESSED GO TO ADD MODE
      *    10      F10 PRESSED to Reverse
      *    12      F12 PRESSED GOTO PREVIOUS SCREEN
      *    14      F14 Pressed go to settlement screen
      *    25      Message subfile
      *    29      READC and CHAIN Subfile record
      *    30      Subfile display (SFLDSP)
      *    31      SFLDSPCTL
      *    32      SFLEND(*MORE)
      *    33      Subfile clear (SLFCLR)
      *    35      SFLNXTCHG
      *    40      Invalid subfile selection
      *    41      Invalid Syndicate member
      *    42      Invalid introducing customer
      *    43      Invalid joining date
      *    44      Invalid Share type
      *    45      Invalid Share (amount/percentage)
      *    46      Invalid skim interest rate
      *    47      Invalid skim interest rate sign
      *    48      Invalid skim fees rate
      *    49      Invalid skim fees rate sign
      *    50      Invalid facility type
      *    51      Invalid value date
      *    52      Invalid recourse indicator
      *    55      Protect Fields
      *    56      Enable F10
      *    60      No Records Found in Subfile
      *    61      Enquiry Mode
      *    70      READ and/or CHAIN Files
      *    71      READE FCLTY
      *    90-99   Used by standard subroutine
      *****************************************************************
      *                   Index to subroutines                        *
      *                   ~~~~~~~~~~~~~~~~~~~~                        *
      *  INITPR  -  Initial processing                                *
      *  BLDSFL  -  Build Subfile                                     *
      *  REVIEW  -  Intractive processing                             *
      *  MAPFLD  -  Map the input data read from the transmitted msg  *
      *  VLDSFL  -  Validate subfile selection                        *
      *  VLDALL  -  Validate subfile selection (Insert, amend, reverse*
      *  VLDENQ  -  Validate subfile selection for enquiry            *
      *  PROSEL  -  Process Enter from subfile screen                 *
      *  ENQRYS  -  Process enquiry screen                            *
      *  REVERS  -  Process Reverse  screen                           *
      *  AMENDS  -  Process Amend screen                              *
      *  POPSCR  -  Move fields to screen                             *
      *  ENTER2  -  Enter key pressed from detail screen in reverse mode
      *  VLDDET  -  Validate Syndicate member details                 *
      *  VLDCUS  -  Validate Syndicate Member                         *
      *  VLDFCT  -  Validate Facility Type                            *
      *  VLDINC  -  Validate Introducing Customer                     *
      *  VLDJDT  -  Validate Joining Date                             *
      *  VLDVDT  -  Validate Value Date                               *
      *  VLDSHR  -  Validate Share (Amount/Percentage)                *
      *  VLDRCI  -  Validate Recourse Indicator                       *
      *  VLDSKM  -  Validate Skim Interest Rate                       *
      *  SR2410  -  Validate settlement details                       *
      *  SRWNDW  -  Window processing subroutine                      *
      *  UPDFLE  -  Update facility filoe                             *
      *  CALCSO  -  Calculate total share                             *
      *  CALCAV  -  Calculate available share                         *
      *  WRITER  -  Process third detail screen                       *
      *  AMENDR  -  Update Facility File                              *
      *  REVERR  -  Reverse a record                                  *
      *  LOADFM  -  Load details to Facility file                     *
      *  UPDTRL  -  Update trailer                                    *
      *  FEXSET  -  Setup details for settlement screen               *
      *  MFSSCR  -  Move field to settlement screnn (SETLIAB)         *
      *  SHRTNM  -  Setup SETLIAZ (used in SD2410)                    *
      *  INITIS  -  Clear settlement screen for insert                *
      *  SRZADD  -  Adds an amount (ZZAMT) to the total (ZZTOTI,ZZTOTD)
      *  SRZSUM  -  Carries out the addition of the amounts           *
      *  CF03    -  Terminate program                                 *
      *  CF05    -  Refresh screen                                    *
      *  CF09    -  Insert a record                                   *
      *  CF10    -  Confirm deletion of a record                      *
      *  CF12    -  Previous screen                                   *
      *  CF14    -  Settlement screen                                 *
      *  CLRSC   -  Clear Screen fields for insert                    *
      *  CLEARM  -  Clears message from the program message queue     *
      *  ZASNMS  -  Sends message to the program message queue        *
      *  SRBERR  -  Format batch error details                        *
      *  *PSSR   -  Error handling subroutine                         *
      *  SRF1FM  -  Move values from PC Msg file to facility file.    *   157004
      *****************************************************************
      *
      ** Facilities file
     FLEFCLTL0IF  E           K        DISK         KINFSR *PSSR
     F            FCLTYFMF                          KRENAMEFCLTL0
     FFCLTYL2 IF  E           K        DISK         KINFSR *PSSR          154591
      *
      ** Funding Participant Details file
     FLEFCLTL2IF  E           K        DISK         KINFSR *PSSR
     F            FCLTYFMF                          KRENAMEFCLTL2
      *                                                                   178424
      ** Live/Expired Funding Participant Details file                    178424
      *                                                                   178424
     FLEFCLTLBIF  E           K        DISK         KINFSR *PSSR          178424
     F            FCLTYFMF                          KRENAMEFCLTLB         178424
      *
      **
     FLEREF   IF  E           K        DISK         KINFSR *PSSR
      *
      ** Funding Participant Play/Record file
     FLE2021PDUF  E           K        DISK         KINFSR *PSSR A    UC
      *
      ** Facilities Details file
     FFCLTY   UF  E           K        DISK         KINFSR *PSSR A
     F                                              KCOMIT
      *
      **  Risk Participant Details File                                   157594
     FLEPARTL1IF  E           K        DISK         KINFSR *PSSR          157594
     F                                              KCOMIT                157594
     F/COPY WNCPYSRC,LE2021F001
      *                                                                   157594
      **
     FLE2021DFCF  E                    WORKSTN      KINFSR *PSSR      UC
     F                                        RRN1  KSFILE LE2021S1
     FCLOANL6 IF  E           K        DISK         KINFSR *PSSR                              202456
      *
      *****************************************************************
      /EJECT
      *
      ** Compile Time Arrays
      *  ~~~~~~~~~~~~~~~~~~~
     E                    STAMP   1   1 26                                                    CPK015
      ** Array containing dummy timestamp                                                     CPK015
      ** Array containing Copyright statement
     E                    CPY@    1   1 80
      *
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZHOLE                                                  154591
      *
      ** Run Time Arrays
      *  ~~~~~~~~~~~~~~~
      *
     E/COPY ZSRSRC,ZALIGNZ1
      *
      /SPACE 3
      **
     ILEREFD1F                                                            127641
     I              RECI                            RFRECI                127641
     I              CNUM                            RFCNUM                127641
     I              FACT                            RFFACT                127641
     I              FCNO                            RFFCNO                127641
      *                                                                   127641
     ICLOANCLF                                                                                CLE034
     I              TMST                            CLTMST                                    CLE034
     IA@CPY       DS
     I* Copyright array
     I                                        1  80 CPY@
     ILDA       E DSLDA                         256
     I              SPARE                           SPARF                 119892
      *                                                                   154591
      ** Data area to read previous run date                              154591
     IJNSTAT      DS                            200                       154591
     I                                    P 103 1050PRUN                  154591
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
      *                                     134 141 DBFILE
      *                                     142 170 DBKEY
      *                                     171 180 DBPGM
      *                                     181 1830DBASE
      *
     IPSDS       SDS
      *
      ** Program Status Data Structure - gives Job/Workstation name and
      ** User ID
      *
     I                                     *PROGRAM ##PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
      **  Job date/time
     IJBDTTM      DS
     I                                        1   60##JDT
     I                                        1   20##JYY
     I                                        3   40##JMM
     I                                        5   60##JDD
     I                                        7  120##JTM
     I                                        7   80##JHH
     I                                        9  100##JNN
     I                                       11  120##JSS
      *
      ** First DS for access programs, short data structure
     IDSFDY     E DSDSFDY
      *
      ** Second DS for access programs, long data structure
     IDSSDY     E DSDSSDY
      *
      ** Bank Details
     ISDBANK    E DSSDBANKPD
      *
      ** Branch Code Details
     ISDBRCH    E DSSDBRCHPD
      *
      ** Currency Details
     ISDCURR    E DSSDCURRPD
      *
      ** Customer Details
     ISDCUST    E DSSDCUSTPD
     I              QQDFAC                          Q1DFAC                                    CGL029
      *
      ** Facility Type Details, read by access program.
     ISDFACT    E DSSDFACTPD
      *                                                                   153666
      ** Alternate Name and Addresses                                     153666
     ISDALTN    E DSSDALTNPD                                              153666
      *
      ** data structure for passing a parameter to synon screen
      ** handling program.
     ISETLIB    EIDSSETLIAB
      *
      ** data structure for passing a parameter to synon screen
      ** handling program.
     ISETLIZ    E DSSETLIAZ
     I@PARM3    E DSSDSETLPD                                              222373
      *                                                                   222373
      *
      ** IN Message Format
     IP#INMF    E DSLEF1MFPD
     I              QQPONS                          Q1PONS                                    CGL029
     I              QQRONS                          Q1RONS                                    CGL029
      *
      ** OUT Message Format
     IP#OUMF    E DSLEF2MFPD
      *
      * DS for calculating PC reference                                   153782
     ILEALLO    E DSLEALLO                                                153782
      *                                                                   153782
     I            DS
      ** Separate date values
     I                                        1   6 WDATE
     I                                        1   2 WDAT1
     I                                        3   4 WDAT2
     I                                        5   6 WDAT3
      *
     I            DS
      ** Date format for test harness file
     I                                        1   8 WTDAT
     I                                        1   2 WTDT1
     I I            '/'                       3   3 WFIL1
     I                                        4   5 WTDT2
     I I            '/'                       6   6 WFIL2
     I                                        7   8 WTDT3
      *
     I            DS
      ** Separate time values
     I                                        1   60WTIME
     I                                        1   2 WTIM1
     I                                        3   4 WTIM2
     I                                        5   6 WTIM3
      *
     I            DS
      ** Time format for test harness file
     I                                        1   8 WTTIM
     I                                        1   2 WTTM1
     I I            ':'                       3   3 WFIL3
     I                                        4   5 WTTM2
     I I            ':'                       6   6 WFIL4
     I                                        7   8 WTTM3
      *
     IFCTMSG      DS                                                      119925
     I                                        1   6 D#CNUM                119925
     I                                        7   9 D#FACT                119925
     I                                       10  11 D#FCNO                119925
      *
     I/COPY ZSRSRC,ZTNLU1Z1
     I/COPY ZSRSRC,ZHOLI                                                  154591
      *
      ** Data to be passed to window program
     I/COPY QWINDSRC,LE2021GDTA
      *
      /EJECT
      * ===============================================================
      **                  D E F I N I T I O N S
      * ===============================================================
      *
      ** PARAMETER Lists
      ** ~~~~~~~~~~~~~~~
     C           *ENTRY    PLIST
     C                     PARM           P#MODE  1        Batch/Interacti
     C                     PARM           P#INMF           IN Message format
     C                     PARM           P#OUMF           OUT Message format
      *
      ** Define Fields
      ** ~~~~~~~~~~~~~
      *
      ** Key Lists
      ** ~~~~~~~~~
      *
      ** Key list to access Prime Facility
     C           K#LTL0    KLIST
     C                     KFLD           K#CNUM
     C                     KFLD           K#FACT
     C                     KFLD           K#FCNO
      *
      ** Key list to access Funding Participant Details For a prime
      ** Facility
     C           K#LTL2    KLIST
     C                     KFLD           K#BRCA
     C                     KFLD           K#PMFC
     C                     KFLD           K#PMFT
     C                     KFLD           K#PMFN
      *
      ** Key list to check if a member is already exists
     C           K#LTL3    KLIST
     C                     KFLD           K#BRCA
     C                     KFLD           K#PMFC
     C                     KFLD           K#PMFT
     C                     KFLD           K#PMFN
     C                     KFLD           K#CNUM
      *
      ** Key list to access Facilty file by customer & facility type
     C           K#LTL4    KLIST
     C                     KFLD           K#CNUM
     C                     KFLD           K#FACT
     C                     KFLD           K4FCNO                          120525
      *                                                                   157594
      **  Key list to access Risk Participant Details File                157594
     C           K#LTL5    KLIST                                          157594
     C                     KFLD           K#BRCA                          157594
     C**********           KFLD           K#CUNO  60                                   157594 CSD027
     C                     KFLD           K#CUNO  6                                           CSD027
     C                     KFLD           K#CUFA  30                      157594
     C                     KFLD           K#CFNO  20                      157594
      *
      ** Key list to access a Member Facility
     C           K#FCTY    KLIST
     C                     KFLD           K#CNUM
     C                     KFLD           K#FACT
     C                     KFLD           K#FCNO
     C                     KFLD           K#RCTP
      *                                                                   154591
      ** Key list to access Facility Detail B  Rec for Funding            154591
      ** Participant                                                      154591
     C           K#FCT2    KLIST                                          154591
     C                     KFLD           W#BRCA  3                       154591
     C**********           KFLD           W#PMFC  60                                   154591 CSD027
     C                     KFLD           W#PMFC  6                                           CSD027
     C                     KFLD           W#PMFT  30                      154591
     C                     KFLD           W#PMFN  20                      154591
      *
      * ===============================================================
      *
      *                M A I N        P R O C E S S I N G
      *
      * ===============================================================
      *
      ** Initialisation
     C                     EXSR INITPR
      *
      ** Interactive, Record and Interactive Enquiry
     C           P#MODE    IFEQ 'I'
     C           P#MODE    OREQ 'R'
     C           P#MODE    OREQ 'E'
      *
      ** Build Subfile
     C                     EXSR BLDSFL
      *
      ** Display Screen
     C                     EXSR REVIEW
      *
     C                     ENDIF
      *
      ** Batch
     C           P#MODE    IFEQ 'B'
      *
      ** Map incoming data into the screen fields
     C                     EXSR MAPFLD
      *
      ** Validate Detail from Parameter
     C           W#ACTN    IFEQ 'I'
     C           W#ACTN    OREQ 'A'
     C                     EXSR VLDDET
     C                     ELSE
     C                     EXSR UPDFLE
     C                     ENDIF
      *
      ** Set up details of returned message format
     C                     MOVE F1MSGT    F2MSGT
     C                     MOVE F1TRUS    F2TRUS
     C                     MOVE F1TRWS    F2TRWS
     C                     MOVE F1TNRF    F2TNRF
     C                     MOVE F1TRSN    F2TRSN
     C                     MOVE F1ACTN    F2ACTN
     C                     MOVE F1TRDS    F2TRDS
     C                     MOVE F1TRTS    F2TRTS
     C                     MOVE F1NRBA    F2NRBA
     C                     MOVE F1CNUM    F2CNUM
     C                     MOVE F1FACT    F2FACT
     C***********W#FCNO    ADD  1         W#FCN   20                      120525
     C***********          MOVE W#FCN     F2FCNO                          120525
     C           W#ACTN    IFEQ 'I'                                       134494
     C                     MOVE K4FCNO    F2FCNO                          120525
     C                     ELSE                                           134494
     C                     MOVE F1FCNO    F2FCNO                          134494
     C                     ENDIF                                          134494
      *
     C                     ENDIF
      *
      ** Play
     C           P#MODE    IFEQ 'P'
      *
     C                     READ LE2021PD                 70
     C           *IN70     DOWEQ*OFF
      *
      ** Validate Detail from Parameter
     C                     EXSR VLDDET
      *
     C                     READ LE2021PD                 70
      *
     C                     ENDDO
      *
     C                     ENDIF
      *
      **  Terminate program
     C                     EXSR CF03
      *
      /EJECT
      *****************************************************************
      * REVIEW   : Process Intractive processing                      *
      * Called by: Main routine                                       *
      * Calls    : CF03, CF05, CF09, PROSEL                           *
      *****************************************************************
     C           REVIEW    BEGSR
      *
      **  Clear Message subfile
     C                     EXSR CLEARM
      *
      ** Continue to redisplay the screen if *IN30 remains off
     C           *IN03     DOWEQ*OFF
     C           *IN12     ANDEQ*OFF                                      123857
      *
     C                     WRITELE2021F2                   Header
     C                     WRITELE2021F5                   Function Keys
     C                     WRITE#MSGCTL                    Messages
     C   60                WRITELE2021F4                   No Records  s
     C                     EXFMTLE2021C1                   Subfile Control
      *
      **  Clear Message subfile
     C                     EXSR CLEARM
      *
      **  this is used in CF05 (refresh)
     C                     MOVE 'SFL'     W#F5MD  3
      *
      **  F3  - Exit
     C           *IN03     CASEQ'1'       CF03
      *                                   ****
      **  F5 - Refresh
     C           *IN05     CASEQ'1'       CF05
      *
      **  F9 - Add
     C           *IN09     CASEQ'1'       CF09
      *                                                                   123857
      **  F12 - Previuos                                                  123857
     C           *IN12     CASEQ'1'       CF03                            123857
      *                                   ****
      **  Enter Key Processing
     C                     CAS            PROSEL
      *                                   ******
      *
     C                     ENDCS
      *
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * BLDSFL   : Build subfile                                      *
      * Called by: Main routine, CF05                                 *
      * Calls    : None.                                              *
      *****************************************************************
     C           BLDSFL    BEGSR
      *
     C                     Z-ADD*ZEROS    RRN1    40
     C                     Z-ADD*ZEROS    W#TFAM 150
     C                     Z-ADD*ZEROS    W#TSHP 150
     C                     MOVE 'N'       W#FLAG
      *
      *                                                                   157594
     C                     Z-ADD*ZEROS    W#EXPS                          157594
      **  Clear subfile
     C                     MOVEA'0001'    *IN,30
     C                     WRITELE2021C1
      *
      **  Read all syndicate ,members
     C********** K#LTL2    SETLLLEFCLTL2                                  178424
     C********** K#LTL2    READELEFCLTL2                 70               178424
     C           K#LTL2    SETLLLEFCLTLB                                  178424
     C           K#LTL2    READELEFCLTLB                 70               178424
      *
     C           *IN70     DOWEQ*OFF
      *
     C                     MOVE *BLANKS   S#SEL
     C                     MOVE *OFF      *IN40
      *
     C                     MOVELCNUM      S#CNUM           Member Number
      *
      ** Share Amount/Percentage
      *  ~~~~~~~~~~~~~~~~~~~~~~~
     C           SHTP      IFEQ 'A'
      *
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE FAMT      ZFIELD
     C                     Z-ADDA6NBDP    ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    S#SHAR
      * SHTP = 'P'
     C                     ELSE
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE SHPC      ZFIELD
     C                     Z-ADD12        ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    S#SHAR
     C                     ENDIF
      *
      **  Add to total amounts
     C                     ADD  FAMT      W#TFAM
     C                     ADD  SHPC      W#TSHP
      *
      ** Share Type
      *  ~~~~~~~~~~
     C                     MOVE SHTP      S#SHTP
      *
      ** Customer Shortname
      ** ~~~~~~~~~~~~~~~~~~
      *  Access the Customer Details file
      *
     C                     MOVE CNUM      P#MNUM  6
     C                     CALL 'AOCUSTR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM P#MNUM    @CNUM  10
     C                     PARM           @CNST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD6         DBASE
     C                     MOVEL'SDCUSTPD'DBFILE
     C                     MOVELP#MNUM    DBKEY
     C                     MOVEL'LE2021'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
      *
     C                     ELSE
     C                     MOVE BBCSSN    S#CSSN           Short Name
     C                     ENDIF
      *
      ** Facility
      ** ~~~~~~~~
     C                     MOVE FACT      S#FACT
     C                     MOVE FCNO      S#FCNO
      *
      ** Joining Date
      ** ~~~~~~~~~~~~
     C                     MOVE JDTE      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     S#JDTE
      *
      ** Value Date
      ** ~~~~~~~~~~
     C                     MOVE VDTC      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     S#VDTC
      *
      *  Populate Hidden Fields
      ** ~~~~~~~~~~~~~~~~~~~~~~
     C                     MOVE TNLU      H#TNLU
     C                     MOVE INUM      H#INUM
     C                     MOVE RCSI      H#RCSI
     C                     MOVE PASI      H#PASI                          147261
     C                     MOVE SKIR      H#SKIR
     C                     MOVE SKIS      H#SKIS
     C                     MOVE SKFR      H#SKFR
     C                     MOVE SKFS      H#SKFS
     C                     MOVE SHPC      H#SHPC
     C                     MOVE FAMT      H#FAMT
      *
      ** Save value of participations sold externally                     157594
      *                                                                   157594
     C           PRTR      IFEQ 'P'                                       157594
     C                     ADD  FAMT      W#EXPS 130                      157594
     C                     ENDIF                                          157594
      *                                                                   157594
     C                     MOVE RSTM      H#RSTM
     C                     MOVE RONS      H#RONS
     C                     MOVE RIBN      H#RIBN
     C                     MOVE RIBA      H#RIBA
     C                     MOVE ROBN      H#ROBN
     C                     MOVE ROCN      H#ROCN
     C                     MOVE PSTM      H#PSTM
     C                     MOVE PONS      H#PONS
     C                     MOVE PIBN      H#PIBN
     C                     MOVE PIBA      H#PIBA
     C                     MOVE POBN      H#POBN
     C                     MOVE POCN      H#POCN
     C                     MOVE CVMR      H#CVMR
     C                     MOVE RCRN      H#RCRN
     C                     MOVE RCRA      H#RCRA
     C                     MOVE RVNO      H#RVNO
     C                     MOVE AWBN      H#AWBN
     C                     MOVE AWBA      H#AWBA
     C                     MOVE BENN      H#BENN
     C                     MOVE BENA      H#BENA
     C                     MOVE DTP1      H#DTP1
     C                     MOVE DTP2      H#DTP2
     C                     MOVE DTP3      H#DTP3
     C                     MOVE DTP4      H#DTP4
     C                     MOVE DCHG      H#DCHG
     C                     MOVE BTB1      H#BTB1
     C                     MOVE BTB2      H#BTB2
     C                     MOVE BTB3      H#BTB3
     C                     MOVE BTB4      H#BTB4
     C                     MOVE BTB5      H#BTB5
     C                     MOVE BTB6      H#BTB6
     C                     MOVE OMDB      H#POBR
     C                     MOVE OSDB      H#ROBR
     C                     MOVE NACD      H#NACD                          153666
      *                                                                   CEU004
      ** If CEU004 is on Move Settlement Currency and 'In' Currency       CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           CLE031    OREQ 'Y'                                                           CLE031
     C                     MOVE SCCY      H#SCCY                          CEU004
     C                     MOVE ICCY      H#ICCY                          CEU004
     C                     ENDIF                                          CEU004
      *
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE COAG      H#COAG                                              CLE031
     C                     MOVE FCAG      H#FCAG                                              CLE031
     C                     MOVE PHAG      H#PHAG                                              CLE031
     C                     MOVE SCAG      H#SCAG                                              CLE031
      *                                                                                       CLE031
     C           REXR      IFEQ 0                                                             CLE031
     C                     MOVE *BLANKS   H#REXR                                              CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD                                              CLE031
     C                     MOVE REXR      ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZEDIT                                                         CLE031
     C                     MOVE ZFIELD    H#REXR                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     MOVE REXI      H#REXI                                              CLE031
     C                     MOVE PSCY      H#PSCY                                              CLE031
      *                                                                                       CLE031
     C           PEXR      IFEQ 0                                                             CLE031
     C                     MOVE *BLANKS   H#PEXR                                              CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD                                              CLE031
     C                     MOVE PEXR      ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZEDIT                                                         CLE031
     C                     MOVE ZFIELD    H#PEXR                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     MOVE PEXI      H#PEXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ADD  1         RRN1
      *
     C                     WRITELE2021S1
     C********** K#LTL2    READELEFCLTL2                 70               178424
     C           K#LTL2    READELEFCLTLB                 70               178424
      *
     C                     ENDDO
      *
      ** Set on subfile display indicators.
     C           RRN1      IFGT 0
     C                     MOVEA'1110'    *IN,30
      *
      ** Format  total % SOld
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE W#TSHP    ZFIELD
     C                     Z-ADD12        ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    S#SOLD
      *  Records found
     C                     MOVE *OFF      *IN60                        oun
      *  Position subfile
     C                     Z-ADD1         ##SFRC           Position page
      *
     C                     ELSE
      *  Records not found
      *
     C                     MOVEA'0100'    *IN,30
     C                     MOVE *ON       *IN60                        Rec
     C                     Z-ADD0         ##SFRC           Position page
     C                     ENDIF
      *
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * MAPFLD   : Map the input data read from the transmitted msg   *
      * Called by: Main routine                                       *
      * Calls    : None                                               *
      *****************************************************************
     C           MAPFLD    BEGSR
      *
      **  Map the input data read from the teansmitted message.
     C********** F1ACTN    IFEQ 'C'                                                    134494 202456
     C**********           MOVE 'R'       W#ACTN                                       134494 202456
     C**********           ELSE                                                        134494 202456
     C                     MOVE F1ACTN    W#ACTN
     C**********           ENDIF                                                       134494 202456
      *                                                                   134494
     C                     MOVE F1CNUM    S#CNUM
     C                     MOVE F1CNUM    S#CSSN
     C                     MOVE F1FACT    S#FACT
     C                     MOVE F1FCNO    S#FCNO
     C                     MOVELF1INUM    S#INUM
      *
     C                     MOVELF1VDTC    S#VDTC
     C                     MOVE F1VDTC    W#TWO   2
     C                     MOVE W#TWO     S#VDTC
      *
     C                     MOVELF1JDTE    S#JDTE
     C                     MOVE F1JDTE    W#TWO
     C                     MOVE W#TWO     S#JDTE
      *
     C                     MOVE F1SHTP    S#SHTP
     C           F1SHTP    IFEQ 'P'
     C                     MOVE F1SHPC    S#SHAR
     C                     ELSE
     C                     MOVE F1FAMT    S#SHAR
     C                     ENDIF
     C                     MOVE F1RCSI    S#RCSI
     C                     MOVE F1PASI    S#PASI                          147261
     C                     MOVE F1SKIR    S#SKIR
     C                     MOVE F1SKIS    S#SKIS
     C                     MOVE F1SKFR    S#SKFR
     C                     MOVE F1SKFS    S#SKFS
     C                     MOVE F1NACD    S#NACD                          156044
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE F1COAG    S#COAG                                              CLE031
     C                     MOVE F1FCAG    S#FCAG                                              CLE031
     C                     MOVE F1PHAG    S#PHAG                                              CLE031
     C                     MOVE F1SCAG    S#SCAG                                              CLE031
     C                     ENDIF                                                              CLE031
      *
      **  Settlement details.
     C                     MOVE F1RSTM    H#RSTM
     C                     MOVE F1RONS    H#RONS
     C                     MOVE F1RIBN    H#RIBN
     C                     MOVE F1RIBA    H#RIBA
     C                     MOVE F1ROBN    H#ROBN
     C                     MOVE F1ROCN    H#ROCN
     C                     MOVE F1PSTM    H#PSTM
     C                     MOVE F1PONS    H#PONS
     C                     MOVE F1PIBN    H#PIBN
     C                     MOVE F1PIBA    H#PIBA
     C                     MOVE F1POBN    H#POBN
     C                     MOVE F1POCN    H#POCN
     C                     MOVE F1CVMR    H#CVMR
     C                     MOVE F1RCRN    H#RCRN
     C                     MOVE F1RCRA    H#RCRA
     C                     MOVE F1RVNO    H#RVNO
     C                     MOVE F1AWBN    H#AWBN
     C                     MOVE F1AWBA    H#AWBA
     C                     MOVE F1BENN    H#BENN
     C                     MOVE F1BENA    H#BENA
     C                     MOVE F1DTP1    H#DTP1
     C                     MOVE F1DTP2    H#DTP2
     C                     MOVE F1DTP3    H#DTP3
     C                     MOVE F1DTP4    H#DTP4
     C                     MOVE F1DCHG    H#DCHG
     C                     MOVE F1BTB1    H#BTB1
     C                     MOVE F1BTB2    H#BTB2
     C                     MOVE F1BTB3    H#BTB3
     C                     MOVE F1BTB4    H#BTB4
     C                     MOVE F1BTB5    H#BTB5
     C                     MOVE F1BTB6    H#BTB6
     C                     MOVE F1OMDB    H#POBR
     C                     MOVE F1OSDB    H#ROBR
      *                                                                   CEU004
      ** If CEU004 is on Move Settlement Currency and 'In' Currency       CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           CLE031    OREQ 'Y'                                                           CLE031
     C                     MOVE F1SCCY    H#SCCY                          CEU004
     C                     MOVE F1ICCY    H#ICCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
      *                                                                                       CLE031
     C                     MOVE F1REXR    H#REXR                                              CLE031
     C           F1REXR    IFNE *BLANKS                                                       CLE031
     C                     MOVE *BLANKS   ZFIELD                                              CLE031
     C                     MOVE F1REXR    ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     Z-ADD5         ZADIG                                               CLE031
     C                     MOVE *OFF      *IN99                                               CLE031
     C                     EXSR ZALIGN                                                        CLE031
     C                     Z-ADD*ZEROS    WSEXR  138                                          CLE031
     C                     MOVELZFIELD    WSEXR                                               CLE031
     C           *IN99     IFEQ *ON                                                           CLE031
     C           WSEXR     OREQ *ZEROS                                                        CLE031
     C                     MOVE *BLANKS   H#REXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE F1REXI    H#REXI                                              CLE031
     C           F1REXI    IFEQ 'N'                                                           CLE031
     C                     MOVE *BLANKS   H#REXI                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE F1PSCY    H#PSCY                                              CLE031
     C                     MOVE F1PEXR    H#PEXR                                              CLE031
     C           F1PEXR    IFNE *BLANKS                                                       CLE031
     C                     MOVE F1PEXR    ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     Z-ADD5         ZADIG                                               CLE031
     C                     MOVE *OFF      *IN99                                               CLE031
     C                     EXSR ZALIGN                                                        CLE031
     C                     Z-ADD*ZEROS    WSEXR                                               CLE031
     C                     MOVELZFIELD    WSEXR                                               CLE031
     C           *IN99     IFEQ *ON                                                           CLE031
     C           WSEXR     OREQ *ZEROS                                                        CLE031
     C                     MOVE *BLANKS   H#PEXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE F1PEXI    H#PEXI                                              CLE031
     C           F1PEXI    IFEQ 'N'                                                           CLE031
     C                     MOVE *BLANKS   H#PEXI                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * UPDFLE   : Update facility file                               *
      * Called by: CF10, VLDDET                                       *
      * CallS    : WRITER, AMENDR, REVERR, UPDTRL                     *
      *****************************************************************
     C           UPDFLE    BEGSR
      *
      ** Record Mode 'R'
      *
     C           P#MODE    IFEQ 'R'
      *
      * Write the contents of the detail screen.
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     WDATE
     C                     MOVE WDAT1     WTDT1
     C                     MOVE WDAT2     WTDT2
     C                     MOVE WDAT3     WTDT3
     C                     MOVE WTDAT     DTST
      *
     C                     TIME           WTIME
     C                     MOVE WTIM1     WTTM1
     C                     MOVE WTIM2     WTTM2
     C                     MOVE WTIM3     WTTM3
     C                     MOVE WTTIM     TMST
      *
      *
     C                     MOVE *BLANKS   RMSV
     C                     MOVE *BLANKS   RMID
     C                     MOVE *BLANKS   RMTY
      *                                                                   CEU004
      ** If CEU004 is on Move Settlement Currency and 'In' Currency       CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           CLE031    OREQ 'Y'                                                           CLE031
     C                     MOVE PMPSCY    PMSCCY                          CEU004
     C                     MOVE PMIC72    PMICCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
     C                     WRITELE2021D0
      *
     C                     ENDIF
      *
      **  Write facility record
     C           W#ACTN    IFEQ 'I'
     C                     EXSR WRITER
     C                     ENDIF
      *
      **  Update facility record
     C           W#ACTN    IFEQ 'A'
     C                     EXSR AMENDR
     C                     ENDIF
      *
      ****Reverse*facility*record********************************                             202456
      **  Reverse or Close facility record                                                    202456
     C           W#ACTN    IFEQ 'R'
     C           W#ACTN    OREQ 'C'                                                           202456
      *                                                                   127641
      **  Check if a loan is attached to the participant                  127641
      **  facility's prime                                                127641
      *                                                                   127641
     C                     EXSR CHKPRI                                    127641
      *                                                                   127641
     C                     MOVE S#CNUM    K#CNUM
     C                     MOVE S#FACT    K#FACT
     C                     MOVE S#FCNO    K#FCNO
     C********** K#LTL0    SETLLLEREF                    70                                   202456
     C********** *IN70     IFEQ *OFF                                                          202456
      *                                                                                       202456
     C           K#LTL0    CHAINCLOANCLF             70                                       202456
     C           *IN70     IFEQ *ON                                                           202456
     C           W#ACTN    IFEQ 'R'                                                           202456
     C                     EXSR REVERR
     C                     ELSE                                                               202456
     C                     EXSR CLOSER                                                        202456
     C                     ENDIF                                                              202456
      *                                                                                       202456
     C                     ELSE
     C                     MOVE 'Y'       W#ERR2
      *
      **  Display Message
     C                     MOVEL'LEP0025' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Update trailer
     C           W#ERR2    IFNE 'Y'
      *
     C                     EXSR UPDTRL
      *
     C           P#MODE    IFEQ 'I'
     C           P#MODE    OREQ 'R'
     C                     EXSR BLDSFL
      *
      **  Clear Screen
     C           W#ACTN    IFEQ 'I'
     C                     EXSR CLRSC
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Commit the database changes
     C           P#MODE    IFNE 'B'
     C                     COMIT
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * WRITER   : Write a record to facility file                    *
      * Called by: UPDFLE                                             *
      * Calls    : LOADFM                                             *
      *****************************************************************
     C           WRITER    BEGSR
      *
      **  Write record type 'A'
     C                     EXSR LOADFM
     C           W#ERR5    IFNE 'Y'                                       120525
     C                     Z-ADDBJRDNB    ORED                            142389
     C                     MOVEASTAMP,1   STMP             Default Timestamp                  CPK015
     C                     WRITEFCLTYFMF
      *
      **  Write record type 'B'
      **  Chain to prime facility record so details can be defaulted.
     C                     MOVE F1PMFC    K#CNUM
     C                     MOVE F1PMFT    K#FACT
     C                     MOVE F1PMFN    K#FCNO
     C                     MOVE 'B'       K#RCTP
     C           K#FCTY    CHAINFCLTY                70
     C                     MOVE S#CNUM    CNUM
     C                     MOVE S#FACT    FACT
     C***********W#FCNO    ADD  1         FCNO                            120525
     C                     MOVE K4FCNO    FCNO                            120525
     C                     Z-ADDNATN      TNLU
     C                     Z-ADDBJRDNB    ORED                            142389
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE W#ACTN    CHTP
      *
     C                     Z-ADD0         TOTD
     C                     Z-ADD0         CAMD
     C                     Z-ADD0         CEXP                                                CLE023
     C                     Z-ADD0         PEXP
     C                     Z-ADD0         OAM1
     C                     Z-ADD0         OAM2
     C                     Z-ADD0         OAM3
     C                     Z-ADD0         OAM4
     C                     Z-ADD0         OAM5
     C                     Z-ADD0         OAM6
     C                     Z-ADD0         OAM7
     C                     Z-ADD0         OAM8
     C                     Z-ADD0         OAM9
     C                     Z-ADD0         OA10
      *
     C                     MOVEASTAMP,1   STMP             Default Timestamp                  CPK015
     C                     WRITEFCLTYFNF
     C/COPY WNCPYSRC,LE2021C001
      *
     C           P#MODE    IFNE 'P'
     C           P#MODE    ANDNE'B'
      *
      **  Clear Message subfile (to add a new record)
     C                     EXSR CLEARM
      *
      **  Display Message (Record added)
     C                     MOVEL'LEP0021' ZAMSID
     C                     MOVELCNUM      D#CNUM                          119925
     C                     MOVELFACT      D#FACT                          119925
     C***********          MOVELFCNNO     D#FCNO                   119925 120525
     C                     MOVE K4FCNO    D#FCNO                          120525
     C                     MOVELFCTMSG    ZAMSDA                          119925
     C                     EXSR ZASNMS
      *
     C                     ENDIF
      *                                                                   120525
     C                     ENDIF                                          120525
      *
     C                     ENDSR
      *
      /EJECT
      *****************************************************************
      * AMENDR   : Update Facility File                               *
      * Called by: UPDFLE                                             *
      * Calls    : LOADFM                                             *
      *****************************************************************
     C           AMENDR    BEGSR
      *
      **  Set up K#FCTY
     C           *LIKE     DEFN FACT      K#FACT
     C           *LIKE     DEFN FCNO      K#FCNO
     C           *LIKE     DEFN FCNO      K4FCNO                          120525
     C           *LIKE     DEFN RCTP      K#RCTP
      *
     C                     MOVE S#CNUM    K#CNUM
     C                     MOVE S#FACT    K#FACT
     C                     MOVE S#FCNO    K#FCNO
     C                     MOVE 'A'       K#RCTP
     C           K#FCTY    CHAINFCLTY                70
     C           P#MODE    IFEQ 'B'
     C                     MOVE TNLU      H#TNLU
     C                     ENDIF
      *
      ** Determine if record has been updated by another workstation
     C           *IN70     IFEQ *OFF
     C           H#TNLU    ANDEQTNLU
      *
      ** Save facility amount before updating it to use in updating
      ** trailer
     C           *LIKE     DEFN FAMT      W#SAVF
     C                     Z-ADDFAMT      W#SAVF
     C                     EXSR LOADFM
     C                     UPDATFCLTYFMF
      *
     C                     MOVE 'B'       K#RCTP
     C           K#FCTY    CHAINFCLTY                70
     C                     Z-ADDNATN      TNLU
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE W#ACTN    CHTP
     C                     UPDATFCLTYFNF
      *
     C           P#MODE    IFNE 'P'
     C           P#MODE    ANDNE'B'
      *
      **  Display Message (Record updated)
     C                     MOVEL'LEP0022' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ELSE
      *
     C                     MOVE 'Y'       W#ERR2
     C                     MOVEL'LEP0026' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ENDIF
      *
      **  Move to previous screen
     C                     MOVE *ON       *IN12
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * REVERR   : Reverse a record                                   *
      * Called by: UPDFLE                                             *
      * Calls    : None                                               *
      *****************************************************************
     C           REVERR    BEGSR
      *
     C                     MOVE S#CNUM    K#CNUM
     C                     MOVE S#FACT    K#FACT
     C                     MOVE S#FCNO    K#FCNO
     C                     MOVE 'A'       K#RCTP
     C           K#FCTY    CHAINFCLTY                70
      *
     C           P#MODE    IFEQ 'B'
     C                     MOVE TNLU      H#TNLU
     C                     ENDIF
      *
      ** Determine if record has been updated by another workstation
     C           *IN70     IFEQ *OFF
     C           H#TNLU    ANDEQTNLU
      *
     C                     Z-ADDFAMT      W#SAVF
     C                     MOVE 'R'       RECI
     C                     Z-ADDNATN      TNLU
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE W#ACTN    CHTP
     C                     UPDATFCLTYFMF
      *
     C                     MOVE 'B'       K#RCTP
     C           K#FCTY    CHAINFCLTY                70
     C                     MOVE 'R'       RECI                            127729
     C                     Z-ADDNATN      TNLU
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE W#ACTN    CHTP
     C                     UPDATFCLTYFNF
      *
     C                     ELSE
      *
     C                     MOVE 'Y'       W#ERR2
      *
      **  Display Message
     C                     MOVEL'LEP0026' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************                       202456
      * CLOSER   : Close a record                                     *                       202456
      * Called by: UPDFLE                                             *                       202456
      * Calls    : None                                               *                       202456
      *****************************************************************                       202456
     C           CLOSER    BEGSR                                                              202456
      *                                                                                       202456
     C                     MOVE S#CNUM    K#CNUM                                              202456
     C                     MOVE S#FACT    K#FACT                                              202456
     C                     MOVE S#FCNO    K#FCNO                                              202456
     C                     MOVE 'A'       K#RCTP                                              202456
     C           K#FCTY    CHAINFCLTY                70                                       202456
      *                                                                                       202456
     C           P#MODE    IFEQ 'B'                                                           202456
     C                     MOVE TNLU      H#TNLU                                              202456
     C                     ENDIF                                                              202456
      *                                                                                       202456
      ** Determine if record has been updated by another workstation                          202456
     C           *IN70     IFEQ *OFF                                                          202456
     C           H#TNLU    ANDEQTNLU                                                          202456
      *                                                                                       202456
     C           P#MODE    IFNE 'B'                                                           202456
     C           FAMT      IFNE 0                                                             202456
     C           SHPC      ORNE 0                                                             202456
     C                     MOVE 'Y'       W#ERR2                                              202456
     C                     MOVEL'LEF0126' ZAMSID                                              202456
     C                     EXSR ZASNMS                                                        202456
     C                     ENDIF                                                              202456
      *                                                                                       202456
     C                     ELSE                                                               202456
      *                                                                                       202456
     C                     Z-ADDFAMT      W#SAVF                                              202456
     C                     MOVE 'C'       RECI                                                202456
     C                     Z-ADDNATN      TNLU                                                202456
     C                     Z-ADDBJRDNB    LCD                                                 202456
     C                     MOVE W#ACTN    CHTP                                                202456
     C                     UPDATFCLTYFMF                                                      202456
      *                                                                                       202456
     C                     MOVE 'B'       K#RCTP                                              202456
     C           K#FCTY    CHAINFCLTY                70                                       202456
     C                     MOVE 'C'       RECI                                                202456
     C                     Z-ADDNATN      TNLU                                                202456
     C                     Z-ADDBJRDNB    LCD                                                 202456
     C                     MOVE W#ACTN    CHTP                                                202456
     C                     UPDATFCLTYFNF                                                      202456
     C                     ENDIF                                                              202456
      *                                                                                       202456
     C                     ELSE                                                               202456
      *                                                                                       202456
     C                     MOVE 'Y'       W#ERR2                                              202456
      *                                                                                       202456
      **  Display Message                                                                     202456
     C                     MOVEL'LEP0026' ZAMSID                                              202456
     C                     EXSR ZASNMS                                                        202456
      *                                                                                       202456
     C                     ENDIF                                                              202456
      *                                                                                       202456
     C                     ENDSR                                                              202456
      /EJECT                                                                                  202456
      *****************************************************************
      * UPDTRL   : Update trailer                                     *
      * Called by: UPDFLE                                             *
      * Calls    : SRZADD                                             *
      *****************************************************************
     C           UPDTRL    BEGSR
      *
      ** Update the file controls on LF/FCLTY
     C**********           Z-ADD999999    K#CNUM                                              CSD027
     C                     MOVE '999999'  K#CNUM                                              CSD027
     C                     Z-ADD999       K#FACT
     C                     Z-ADD99        K#FCNO
     C                     MOVE 'Z'       K#RCTP
     C           K#FCTY    CHAINFCLTY                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C           RECI      ANDNE'T'
     C           *LOCK     IN   LDA
     C                     MOVEL'FCLTY   'DBFILE
     C                     Z-ADD7         DBASE
     C                     MOVE K#CNUM    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     SELEC
      *
      **  Inserts
     C           W#ACTN    WHEQ 'I'
     C                     ADD  2         NORE
     C                     ADD  2         NINS
     C                     ADD  2         NLRA
      *
      ** Set up amount fields
     C           FAMT      DIV  1000      ZZAMT  153
      *
     C                     Z-ADDVRIF      ZZTOTI
     C                     Z-ADDVRIL      ZZTOTD
     C                     EXSR SRZADD
     C                     Z-ADDZZTOTI    VRIF
     C                     Z-ADDZZTOTD    VRIL
      *
      **  Save it to calculate totals
     C                     Z-ADDFAMT      ZAMT   150
      *
      **  Amend
     C           W#ACTN    WHEQ 'A'
      *
     C                     Z-ADDVRAF      ZZTOTI
     C                     Z-ADDVRAL      ZZTOTD
     C           FAMT      SUB  W#SAVF    W#ADJ  150
     C                     MOVE W#ADJ     ZZAMT
     C           W#ADJ     DIV  1000      ZZAMT  153
     C                     EXSR SRZADD
     C                     Z-ADDZZTOTI    VRAF
     C                     Z-ADDZZTOTD    VRAL
      *
     C                     Z-ADDW#ADJ     ZAMT
      *
      **  Reverse
     C           W#ACTN    WHEQ 'R'
     C           W#ACTN    OREQ 'C'                                                           202456
      *
      **  Only update number of live records
     C                     ADD  2         NDEL
     C                     SUB  2         NLRA
      *
      ** Set up amount fields
     C           W#SAVF    DIV  1000      ZZAMT  153
      *
     C                     Z-ADDVRDF      ZZTOTI
     C                     Z-ADDVRDL      ZZTOTD
     C                     EXSR SRZADD
     C                     Z-ADDZZTOTI    VRDF
     C                     Z-ADDZZTOTD    VRDL
      *
     C                     Z-SUBW#SAVF    ZAMT
      *
     C                     ENDSL
      *
      ** Calcualte Totals
     C           ZAMT      DIV  1000      ZZAMT
     C                     Z-ADDVLAF      ZZTOTI
     C                     Z-ADDVLAL      ZZTOTD
     C                     EXSR SRZADD
     C                     Z-ADDZZTOTI    VLAF
     C                     Z-ADDZZTOTD    VLAL
      *
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE W#ACTN    CHTP
     C                     Z-ADDNATN      TNLU
     C                     UPDATFCLTYZZF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRZADD   : Adds an amount (ZZAMT) to the total (ZZTOTI,ZZTOTD)*
      * Called by: UPDTRL                                             *
      * Calls    : SRZSUM                                             *
      *****************************************************************
     C           SRZADD    BEGSR
      *
      ** Split ZZAMT into integer and decimal fields
      *
     C                     Z-ADDZZAMT     ZZAMTI 150
     C                     MOVE ZZAMT     ZZAMTD  30
      *
      ** Both ZZAMTI and ZZAMTD contain a 'sign' zone now
      *
     C                     EXSR SRZSUM
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRZSUM   : Carries out the addition of the amounts            *
      * Called by: SRZADD                                             *
      * Calls    : None                                               *
      *****************************************************************
     C           SRZSUM    BEGSR
      *
      ** Save values of indicators to be used in the program
     C                     MOVE *IN91     WIN91   1
     C                     MOVE *IN92     WIN92   1
     C                     MOVE *IN93     WIN93   1
     C                     MOVE *IN94     WIN94   1
     C                     MOVE *IN95     WIN95   1
     C                     MOVEA'00000'   *IN,91
     C                     MOVE '0'       *IN99
      *
     C                     DO
      *
      ** Determine sign of ZZAMTI and ZZAMTD, 92 IF NEG
      ** If both are zero, bypass processing
      *
     C           ZZAMTI    IFEQ *ZEROS
     C           ZZAMTD    ANDEQ*ZEROS
     C                     LEAVE
     C                     ELSE
     C           ZZAMTI    IFLT *ZEROS
     C           ZZAMTD    ORLT *ZEROS
     C                     MOVE '1'       *IN92
     C                     ENDIF
     C                     ENDIF
      *
      ** Determine sign of ZZTOTI and ZZTOTD, 91 IF NEG.
      ** If ZZTOTAL is ZERO, return ZZAMOUNT.
      *
     C           ZZTOTI    IFEQ *ZEROS
     C           ZZTOTD    ANDEQ*ZEROS
     C                     Z-ADDZZAMTI    ZZTOTI 150
     C                     Z-ADDZZAMTD    ZZTOTD  30
     C                     LEAVE
     C                     ELSE
     C           ZZTOTI    IFLT *ZEROS
     C           ZZTOTD    ORLT *ZEROS
     C                     MOVE '1'       *IN91
     C                     ENDIF
     C                     ENDIF
      *
      ** If signs differ, bypass overflow checks
      *
     C           *IN91     IFEQ '0'
     C           *IN92     ANDEQ'0'
     C           *IN91     OREQ '1'
     C           *IN92     ANDEQ'1'
      *
     C           ZZAMTD    ADD  ZZTOTD    ZZWK2   40
     C           ZZWK2     IFGT 999
     C           ZZWK2     ORLE 999
     C           ZZWK2     ANDLT-999
      *
     C           *IN92     IFEQ '0'
     C           ZZAMTI    ADD  1         ZZWK3  150
     C                     ELSE
     C           ZZAMTI    SUB  1         ZZWK3
     C                     ENDIF
     C           ZZTOTI    ADD  ZZWK3     ZZWK3
      *
     C                     ELSE
     C           ZZTOTI    ADD  ZZAMTI    ZZWK3
     C                     ENDIF
      *
      ** If the modulus of ZZWK3 is less than the modulus of ZZTOTI,
      ** then overflow has occurred
      *
     C           *IN92     IFEQ '0'
     C           ZZWK3     COMP ZZTOTI                 99
     C                     ELSE
     C           ZZWK3     COMP ZZTOTI               99
     C                     ENDIF
      *
      ** If overflow occurs, zeroise ZZAMT
      *
     C           *IN99     IFEQ '1'
     C                     Z-ADD0         ZZAMT  153
     C                     ELSE
     C                     Z-ADDZZWK2     ZZTOTD
     C                     Z-ADDZZWK3     ZZTOTI
     C                     ENDIF
     C                     LEAVE
     C                     ENDIF
      *
      ** the signs are different
      *
     C           *IN91     IFEQ '1'
     C           *IN92     ANDEQ'0'
     C           *IN91     OREQ '0'
     C           *IN92     ANDEQ'1'
      *
      ** If ZZAMT was negative, make it positive to compare with ZZTOT
      *
     C           *IN92     IFEQ '1'
     C                     Z-SUBZZAMTI    ZZAMTI 150
     C                     Z-SUBZZAMTD    ZZAMTD  30
     C                     ENDIF
      *
      ** If ZZTOT was negative, make it positive to compare with ZZAMT
      *
     C           *IN91     IFEQ '1'
     C                     Z-SUBZZTOTI    ZZTOTI
     C                     Z-SUBZZTOTD    ZZTOTD
     C                     ENDIF
      *
      ** Both ZZAMT and ZZTOT are now positive
      ** If ZZTOT equals ZZAMT, return zero
      *
     C                     MOVE '0'       *IN93
     C           ZZTOTI    IFEQ ZZAMTI
     C           ZZTOTD    ANDEQZZAMTD
     C                     Z-ADD0         ZZTOTI
     C                     Z-ADD0         ZZTOTD
     C                     LEAVE                                          142389
     C                     ELSE
     C           ZZTOTI    IFGT ZZAMTI
     C           ZZTOTD    OREQ ZZAMTD
     C                     MOVE '1'       *IN93
     C                     ENDIF
     C                     ENDIF
      *
      ** If ZZTOT greater than ZZAMT
      *
     C           *IN93     IFEQ '1'
     C           ZZAMTD    IFGT ZZTOTD
     C           ZZTOTI    SUB  1         ZZTOTI
     C           ZZTOTD    ADD  1000      ZZWK2
     C           ZZTOTI    SUB  ZZAMTI    ZZTOTI
     C           ZZWK2     SUB  ZZAMTD    ZZTOTD
     C                     ELSE
     C           ZZTOTI    SUB  ZZAMTI    ZZTOTI
     C           ZZTOTD    SUB  ZZAMTD    ZZTOTD
     C                     ENDIF
      *
      ** If ZZAMT greater than ZZAMT
      *
     C                     ELSE
     C           ZZTOTD    IFGT ZZAMTD
     C           ZZAMTI    SUB  1         ZZWK3  150
     C           ZZAMTD    ADD  1000      ZZWK2
     C           ZZWK3     SUB  ZZTOTI    ZZTOTI
     C           ZZWK2     SUB  ZZTOTD    ZZTOTD
     C                     ELSE
     C           ZZAMTI    SUB  ZZTOTI    ZZTOTI
     C           ZZAMTD    SUB  ZZTOTD    ZZTOTD
     C                     ENDIF
     C                     ENDIF
      *
      ** Reverse sign of ZZTOT if larger input fields were negative
      *
     C           *IN93     IFEQ '1'
     C           *IN91     ANDEQ'1'
     C           *IN93     OREQ '0'
     C           *IN92     ANDEQ'1'
     C                     Z-SUBZZTOTI    ZZTOTI
     C                     Z-SUBZZTOTD    ZZTOTD
     C                     ENDIF
      *
      ** Restore sign of ZZAMTI & ZZAMTD if reversed
      *
     C           *IN92     IFEQ '1'
     C                     Z-SUBZZAMTI    ZZAMTI
     C                     Z-SUBZZAMTD    ZZAMTD
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** If ZZTOTD is zero, and ZZTOTI is negative, setup  ZZNEGD
      *
     C           ZZTOTD    IFEQ *ZEROS
     C           ZZTOTI    ANDLT*ZEROS
     C                     MOVE '.000-'   ZZNEGD  5
     C                     ENDIF
      *
      ** Restore previous indicator values
      *
     C                     MOVE WIN91     *IN91
     C                     MOVE WIN92     *IN92
     C                     MOVE WIN93     *IN93
     C                     MOVE WIN94     *IN94
     C                     MOVE WIN95     *IN95
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CF03     : Exit program                                       *
      * Called by: PROSEL, REVIEW, CF05, CF09, ENQRYS, REVERS, AMENDS *
      * Calls    : None.                                              *
      *****************************************************************
     C           CF03      BEGSR
      *
      ** Close SD2400 program and end this program's processing
     C           P#MODE    IFNE 'B'
     C           P#MODE    ANDNE'P'
     C                     MOVE 'T'       PMTERM
     C                     CALL 'SD2400'
     C                     PARM           @RTCD
     C                     PARM           SETLIB
     C                     PARM           SETLIZ
     C                     PARM           @DLNUM  6                       222373
     C                     PARM           @PARM3                          222373
     C                     ENDIF
      *                                                                   123857
     C           P#MODE    IFNE 'B'                                       123857
     C************IN12     ANDEQ*OFF                               123857 148847
     C           *IN12     IFEQ *OFF                                      148847
     C                     MOVE 'T'       F2MSGS                          123857
     C                     ELSE                                           148847
     C           WENTR     IFEQ 'N'                                       148847
     C                     MOVE 'P'       F2MSGS                          148847
     C                     ENDIF                                          148847
     C                     ENDIF                                          148847
     C                     ENDIF                                          123857
      *
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CF05     : Refresh Screen                                     *
      * Called by: REVIEW, CF09, AMENDS                               *
      * Calls    : BLDSFL, CLRSC, POPSCR.                             *
      *****************************************************************
     C           CF05      BEGSR
      *
      ** Clear Message subfile
     C                     EXSR CLEARM
      *
      ** If it is in Subfile Mode
     C           W#F5MD    IFEQ 'SFL'
      *
      ** Clear Selection field
     C           *IN60     IFEQ *OFF
     C           1         CHAINLE2021S1             29
     C           *IN29     DOWEQ*OFF
     C                     MOVE ' '       S#SEL
     C                     MOVE *OFF      *IN40            RI & PC
     C                     MOVE *OFF      *IN35            SFLNXTCHG
     C                     UPDATLE2021S1
     C                     READCLE2021S1                 29
     C                     ENDDO
     C                     ENDIF
      *
      ** Position to first page
     C                     Z-ADD1         ##SFRC           SFLRCDNBR
      *
     C                     ELSE
      *
      ** If it is in Insert Mode
     C           W#F5MD    IFEQ 'INS'
     C                     EXSR CLRSC
     C                     SETOF                     414243
     C                     SETOF                     444546
     C                     SETOF                     474849
     C                     SETOF                     505152
     C                     SETOF                     53                   147261
     C                     MOVE *OFF      *IN19                           153666
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE *OFF      *IN62                                               CLE031
     C                     MOVE *OFF      *IN63                                               CLE031
     C                     MOVE *OFF      *IN64                                               CLE031
     C                     MOVE *OFF      *IN65                                               CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ELSE
      *
      ** If it is in Amend Mode
     C           W#F5MD    IFEQ 'UPD'
     C                     SETOF                     414243
     C                     SETOF                     444546
     C                     SETOF                     474849
     C                     SETOF                     505152
     C                     SETOF                     53                   147261
     C                     MOVE *OFF      *IN19                           153666
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE *OFF      *IN62                                               CLE031
     C                     MOVE *OFF      *IN63                                               CLE031
     C                     MOVE *OFF      *IN64                                               CLE031
     C                     MOVE *OFF      *IN65                                               CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     EXSR POPSCR
      *
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CF09     : Insert a record                                    *
      * Called by: REVIEW                                             *
      * Calls    : CLRSC, CF03, CF05, CF12, CF14, VLDDET              *
      *****************************************************************
     C           CF09      BEGSR
      *
      **  Clear Screen
     C                     EXSR CLRSC
      *
     C                     MOVE 'I'       W#ACTN
     C                     MOVE *OFF      *IN55            Dont Protrct
     C                     MOVE *OFF      *IN56            Disable F10
     C                     MOVE *OFF      *IN12
     C                     MOVE 'Y'       W#VSET
      *
     C                     MOVE 'INS'     W#F5MD  3
      *
     C           *IN03     DOWEQ*OFF
     C           *IN12     ANDEQ*OFF
      *
     C                     WRITELE2021F2                   Header
     C                     WRITELE2021F1                   Function Keys
     C                     WRITE#MSGCTL                    Messages
     C                     EXFMTLE2021F3                   Screen
      *
      **  Clear Message subfile
     C                     EXSR CLEARM
      *
      **  F3  - Exit
     C           *IN03     CASEQ'1'       CF03
      *                                   ****
      **  F5  - Refresh
     C           *IN05     CASEQ'1'       CF05
      *                                   ****
      **  F12 - Previous
     C           *IN12     CASEQ'1'       CF12
      *                                   ****
      **  F14 - Settlements
     C           *IN14     CASEQ'1'       CF14
      *                                   ****
      **  Enter Key Processing
     C                     CAS            VLDDET
      *                                   ******
     C                     ENDCS
      *
     C                     ENDDO
      *
     C                     MOVE *OFF      *IN09
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CF10     : Process third detail screen                        *
      **Called*by**REVERS**********************************************
      * Called by: REVERS, CLOSES                                     *                       202456
      * Calls    : UPDFLE                                             *
      *****************************************************************
     C           CF10      BEGSR
      *
      ** Clear Message subfile
     C                     EXSR CLEARM
      ** Update facility file
     C                     EXSR UPDFLE
      *
     C           W#ERR2    IFNE 'Y'
      *
      **  Display Message (Record reversed)
      *
     C           P#MODE    IFNE 'P'
     C           P#MODE    ANDNE'B'
     C           W#ACTN    IFEQ 'R'                                                           202456
      *
     C                     MOVEL'LEP0023' ZAMSID
     C                     ELSE                                                               202456
     C                     MOVEL'LEF0104' ZAMSID                                              202456
     C                     ENDIF                                                              202456
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CF12     : Previous screen                                    *
      * Called by: ENQRYS, AMENDS, REVERS, CF09                       *
      * Calls    : None.                                              *
      *****************************************************************
     C           CF12      BEGSR
      *
      ** Clear Message subfile
     C                     EXSR CLEARM
      *
     C                     SETOF                     414243
     C                     SETOF                     444546
     C                     SETOF                     474849
     C                     SETOF                     505152
     C                     SETOF                     53                   147261
     C                     MOVE *OFF      *IN19                           153666
     C                     MOVE 'N'       W#FLAG
      *
     C           *IN60     IFEQ *OFF
     C           W#ACTN    ANDNE'I'
     C           W#RRN1    CHAINLE2021S1             29
     C                     MOVE *ON       *IN35
     C                     MOVE *ON       *IN40
     C                     UPDATLE2021S1
     C                     ENDIF
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE *OFF      *IN62                                               CLE031
     C                     MOVE *OFF      *IN63                                               CLE031
     C                     MOVE *OFF      *IN64                                               CLE031
     C                     MOVE *OFF      *IN65                                               CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CF14     : Extended Settlement Details                        *
      * Called by: ENQRYS, AMENDS, REVERS, CF09                       *
      * Calls    : FEXSET                                             *
      *****************************************************************
     C           CF14      BEGSR
      *
     C                     MOVE 'Y'       W#CF14  1
      *
      ** Setup parameters for call to SETLIB
     C           W#FLAG    IFEQ 'N'
     C                     EXSR FEXSET
     C                     ENDIF
     C                     MOVE *BLANKS   PMTERM
      *
     C                     CALL 'SD2400'
     C                     PARM           @RTCD
     C                     PARM           SETLIB
     C                     PARM           SETLIZ
     C                     PARM           @DLNUM  6                       222373
     C                     PARM           @PARM3                          222373
      *
      ** Terminate program if database error returned
     C           PMDBSE    IFNE *ZERO
     C           *LOCK     IN   LDA
     C                     MOVELPMDBFL    DBFILE
     C                     MOVE PMDBSE    DBASE
     C                     MOVELPMDBKY    DBKEY
     C                     MOVELPMDPGM    DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           PMCMDP    IFEQ '03'
     C                     MOVE '1'       *IN03
     C                     MOVE '0'       *IN14
      *
     C                     ELSE
     C           PMCMDP    IFEQ '12'
     C           W#ACTN    ANDNE'R'
     C           W#ACTN    ANDNE'E'
      *
      ** SETTLEMENT DETAIL VALID OR F12 IS PRESSED W/OUT VALIDATION
      ** (I.E. ENTER NOT PRESSED IN THE SETTLEMENT SCREEEN)
      *
     C           PMSDTV    IFEQ 'Y'
     C           PMSDTV    OREQ 'N'
     C           PMERCD    ANDEQ*BLANKS
     C                     MOVE 'Y'       W#VSET  1
     C                     MOVE 'Y'       W#FLAG  1
     C                     ENDIF
      *
      ** SETTLEMENT DETAIL IN ERROR
     C           PMERCD    IFNE *BLANKS
     C                     MOVE 'N'       W#VSET
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     MOVE 'N'       PMFRST
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CLRSC    : Clear Screen fields                                *
      * Called by: WRITER, CF05, CF09                                 *
      * Calls    : None                                               *
      *****************************************************************
     C           CLRSC     BEGSR
      *
     C                     MOVE *BLANK    S#CSSN
     C                     MOVE *BLANK    S#INUM
     C                     MOVE *BLANK    S#FACT
     C                     MOVE *BLANK    S#VDTC
     C                     MOVE *BLANK    S#JDTE
     C                     MOVE *BLANK    S#SHTP
     C                     MOVE *BLANK    S#SHAR
     C                     MOVE *BLANK    S#RCSI
     C                     MOVE *BLANK    S#PASI                          147261
     C                     MOVE *BLANK    S#SKIR
     C                     MOVE *BLANK    S#SKIS
     C                     MOVE *BLANK    S#SKFR
     C                     MOVE *BLANK    S#SKFS
     C                     MOVE *BLANK    S#SRNM                          140835
     C                     MOVE *BLANK    S#SRTN                          140835
     C                     MOVE *BLANK    S#IRNM                          140835
     C                     MOVE *BLANK    S#IRTN                          140835
     C                     MOVE *BLANK    S#NACD                          153666
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE *BLANK    S#COAG                                              CLE031
     C                     MOVE *BLANK    S#FCAG                                              CLE031
     C                     MOVE *BLANK    S#PHAG                                              CLE031
     C                     MOVE *BLANK    S#SCAG                                              CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * FEXSET   : Setup details for settlement screen                *
      * Called by: CF14                                               *
      * Calls    : MFSSCR, INITIS                                     *
      *****************************************************************
     C           FEXSET    BEGSR
      *
      ** SETUP DETAILS FOR SETTLEMENT SCREEN IF FIRST TIME PASS THROUGH
      ** EXTENDED SETTLEMENT SCREEN.
      *
     C                     MOVE W#ACTN    PMACTC
     C***********          MOVE 'MMLD'    PMCPGM                          135152
     C                     MOVE 'LEND'    PMCPGM                          135152
     C                     Z-ADD0         PMDBSE
     C                     MOVE *BLANKS   PMERCD
     C                     MOVE 'Y'       PMFRST
     C                     Z-ADDBJRDNB    PMRUND
      *
      ** DETERMINE IF PAY & RECEIVE SETTLEMENT SCREEN WILL BE
      ** PROTECTED.
      *
     C           W#ACTN    IFEQ 'E'
     C           W#ACTN    OREQ 'R'
     C           W#ACTN    OREQ 'C'                                                           202456
     C                     MOVE 'Y'       PMPRCV
     C                     MOVE 'Y'       PMPPAY
     C                     ELSE
     C                     MOVE 'N'       PMPRCV
     C                     MOVE 'N'       PMPPAY
     C                     ENDIF
      *
      ** MOVE FILE VALUES TO SD2400 PARAMETERS TO BE
      ** DISPALYED ON SETTLEMENT SCREEN FOR AMEND OR REVERSE.
      ** INITIALIZE SD2400 PARAMETERS FOR INSERT.
      *
     C           W#ACTN    IFEQ 'A'
     C           W#ACTN    OREQ 'E'
     C           W#ACTN    OREQ 'R'
     C           W#ACTN    OREQ 'I'                                       126517
     C           W#ACTN    OREQ 'C'                                                           202456
     C           P#MODE    ANDEQ'B'                                       126517
     C                     EXSR MFSSCR
     C                     ELSE
     C           W#ACTN    IFEQ 'I'
     C           P#MODE    ANDEQ'I'
     C           P#MODE    OREQ 'R'
     C                     EXSR INITIS
     C                     ENDIF
     C                     ENDIF
      *
     C                     MOVE S#CNUM    PMCSNM
     C                     MOVE S#BRCA    PMBRCA
     C                     MOVE S#FCCY    PMRCCY
     C                     MOVE S#FCCY    PMPCCY
     C                     MOVE *BLANK    PMFFND
     C                     MOVE *BLANK    PMCMDP
      *
      ** FOR INSERT CLEAR OUT ERROR CODES FOR EVERY ENTRY TO
      ** EXTENDED SETTLEMENT (I.E. SD2400 TREATS EVERY ENTRY
      ** TO THE SETTLEMENT SCREEN AS IF IT'S THE FIRST
      ** TIME FOR INSERT
      *
     C           W#ACTN    IFEQ 'I'
     C                     MOVE *BLANKS   PMERCD
     C                     ENDIF
      *
      ** VALIDATION ONLY FLAG
      *
     C           PMFRST    IFEQ 'N'
     C                     MOVE 'Y'       PMVALO
     C                     ELSE
     C                     MOVE 'N'       PMVALO
     C                     ENDIF
      *
      ** SETTLEMENT DETAIL VALID FLAG, DATE OF RECEIPT AND PAYMENT.
      *
     C           W#ACTN    IFEQ 'E'
     C           W#ACTN    OREQ 'R'
     C                     MOVE 'Y'       PMSDTV
     C                     Z-ADD0         PMDTRC
     C                     Z-ADD0         PMDTPY
     C                     ENDIF
      *
     C           W#ACTN    IFEQ 'I'
     C           W#ACTN    OREQ 'A'
     C                     MOVE 'N'       PMSDTV
     C                     ENDIF
      *
      ** SET UP DATE OF RECEIPT
     C                     Z-ADDBJRDNB    PMDTRC
      *
      ** SET UP DATE OF PAYMENT
     C                     Z-ADDBJRDNB    PMDTPY
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * MFSSCR   : Move field to settlement screnn (SETLIAB)          *
      * Called by: FEXSET                                             *
      * Calls    : SHRTNM                                             *
      *****************************************************************
     C           MFSSCR    BEGSR
      *
     C                     Z-ADDH#RSTM    PMRSTM
     C                     MOVE H#RONS    PMRONS
     C                     MOVE H#RIBN    PARIBN
     C                     MOVE H#RIBA    PMRIBA
      *
     C********** H#ROBN    IFNE 0                                                             CSD027
     C           H#ROBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE H#ROBN    PAROBN
     C                     ELSE
     C                     MOVE *BLANKS   PAROBN
     C                     ENDIF
      *
     C********** H#ROCN    IFNE 0                                                             CSD027
     C           H#ROCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE H#ROCN    PAROCN
     C                     ELSE
     C                     MOVE *BLANKS   PAROCN
     C                     ENDIF
      *
     C                     Z-ADDH#PSTM    PMPSTM
     C                     MOVE H#PONS    PMPONS
     C                     MOVE H#PIBN    PAPIBN
     C                     MOVE H#PIBA    PMPIBA
      *
     C********** H#POBN    IFNE 0                                                             CSD027
     C           H#POBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE H#POBN    PAPOBN
     C                     ELSE
     C                     MOVE *BLANKS   PAPOBN
     C                     ENDIF
      *
     C********** H#POCN    IFNE 0                                                             CSD027
     C           H#POCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE H#POCN    PAPOCN
     C                     ELSE
     C                     MOVE *BLANKS   PAPOCN
     C                     END
      *
     C                     MOVE H#CVMR    PMCVMR
     C                     MOVE H#RCRN    PARCRN
     C                     MOVE H#RCRA    PMRCRA
     C                     MOVE H#RVNO    PARVNO
     C                     MOVE H#AWBN    PAAWBN
     C                     MOVE H#AWBA    PMAWBA
     C                     MOVE H#BENN    PABENN
     C                     MOVE H#BENA    PMBENA
     C                     MOVE H#DTP1    PMDTP1
     C                     MOVE H#DTP2    PMDTP2
     C                     MOVE H#DTP3    PMDTP3
     C                     MOVE H#DTP4    PMDTP4
     C                     MOVE H#DCHG    PMDCHG
     C                     MOVE H#BTB1    PMBTB1
     C                     MOVE H#BTB2    PMBTB2
     C                     MOVE H#BTB3    PMBTB3
     C                     MOVE H#BTB4    PMBTB4
     C                     MOVE H#BTB5    PMBTB5
     C                     MOVE H#BTB6    PMBTB6
      *                                                                   126517
     C           H#PSTM    IFEQ 05                                        126517
     C                     MOVE H#POBR    PMPOBR
     C                     ELSE                                           126517
     C                     MOVE *BLANKS   PMPOBR                          126517
     C                     ENDIF                                          126517
      *                                                                   126517
     C           H#RSTM    IFEQ 05                                        126517
     C                     MOVE H#ROBR    PMROBR
     C                     ELSE                                           126517
     C                     MOVE *BLANKS   PMROBR                          126517
     C                     ENDIF                                          126517
      *                                                                   CEU004
      ** If CEU004 is on, PMRSCY not BLANKS move H#SCCY to PMRSCY         CEU004
      ** If PMRSCY is BLANKS move PMPSCY to H#SCCY.                       CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           CLE031    OREQ 'Y'                                                           CLE031
     C                     MOVE H#SCCY    PMRSCY                          CEU004
     C                     MOVE H#SCCY    PMPSCY                          CEU004
     C                     MOVE H#ICCY    PMIC72                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE H#SCCY    PMRSCY                                              CLE031
     C                     MOVE H#REXR    PMREXR                                              CLE031
     C                     MOVE H#REXI    PMREXI                                              CLE031
     C                     MOVE H#PSCY    PMPSCY                                              CLE031
     C                     MOVE H#PEXR    PMPEXR                                              CLE031
     C                     MOVE H#PEXI    PMPEXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *
      ** Setup SETLIAZ fields
     C                     EXSR SHRTNM
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * INITIS   : Clear settlement screen for insert                 *
      * Called by: FEXSET                                             *
      * Calls    : None                                               *
      *****************************************************************
     C           INITIS    BEGSR
      *
     C                     Z-ADD0         PMRSTM
     C                     MOVE *BLANKS   PMRONS
     C                     MOVE *BLANKS   PARIBN
     C                     MOVE *BLANKS   PMRIBN
     C                     MOVE *BLANKS   PMRIBA
     C                     MOVE *BLANKS   PAROBN
     C                     MOVE *BLANKS   PMROBN
     C                     MOVE *BLANKS   PAROCN
     C                     MOVE *BLANKS   PMROCN
     C                     Z-ADD0         PMPSTM
     C                     MOVE *BLANKS   PMPONS
     C                     MOVE *BLANKS   PAPIBN
     C                     MOVE *BLANKS   PMPIBN
     C                     MOVE *BLANKS   PMPIBA
     C                     MOVE *BLANKS   PAPOBN
     C                     MOVE *BLANKS   PMPOBN
     C                     MOVE *BLANKS   PAPOCN
     C                     MOVE *BLANKS   PMPOCN
     C                     MOVE *BLANKS   PMCVMR
     C                     MOVE *BLANKS   PARCRN
     C                     MOVE *BLANKS   PMRCRN
     C                     MOVE *BLANKS   PMRCRA
     C                     MOVE *BLANKS   PARVNO
     C                     MOVE *BLANKS   PMRVNO
     C                     MOVE *BLANKS   PAAWBN
     C                     MOVE *BLANKS   PMAWBN
     C                     MOVE *BLANKS   PMAWBA
     C                     MOVE *BLANKS   PABENN
     C                     MOVE *BLANKS   PMBENN
     C                     MOVE *BLANKS   PMBENA
     C                     MOVE *BLANKS   PMDTP1
     C                     MOVE *BLANKS   PMDTP2
     C                     MOVE *BLANKS   PMDTP3
     C                     MOVE *BLANKS   PMDTP4
     C                     MOVE *BLANKS   PMDCHG
     C                     MOVE *BLANKS   PMBTB1
     C                     MOVE *BLANKS   PMBTB2
     C                     MOVE *BLANKS   PMBTB3
     C                     MOVE *BLANKS   PMBTB4
     C                     MOVE *BLANKS   PMBTB5
     C                     MOVE *BLANKS   PMBTB6
     C                     MOVE *BLANKS   PMPOBR
     C                     MOVE *BLANKS   PMROBR
      *                                                                   CEU004
      ** If CEU004 is on Initialise the fields PMRSCY,PMPSCY and PMIC72   CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           CLE031    OREQ 'Y'                                                           CLE031
     C                     MOVE *BLANKS   PMRSCY                          CEU004
     C                     MOVE *BLANKS   PMPSCY                          CEU004
     C                     MOVE *BLANKS   PMIC72                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE *ZERO     PMREXR                                              CLE031
     C                     MOVE *BLANKS   PMREXI                                              CLE031
     C                     MOVE *BLANKS   PMPSCY                                              CLE031
     C                     MOVE *ZERO     PMPEXR                                              CLE031
     C                     MOVE *BLANKS   PMPEXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SHRTNM   : Setup SETLIAZ (used in SD2410)                     *
      * Called by: MFSSCR                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           SHRTNM    BEGSR
      *
      ** COUNTERPARTY PAY INSTRUCTIONS.
     C                     MOVE *BLANKS   PMRIBN
     C                     MOVELPARIBN    PMRIBN
      *
      ** RCPT - RCPT - ORDERING BANK NO.
     C                     MOVE *BLANKS   PMROBN
     C                     MOVELPAROBN    PMROBN
      *
      ** RCPT - ORDERING CUSTOMER NO.
     C                     MOVE *BLANKS   PMROCN
     C                     MOVELPAROCN    PMROCN
      *
      ** PAY - INTERMEDIARY BANK NO.
     C                     MOVE *BLANKS   PMPIBN
     C                     MOVELPAPIBN    PMPIBN
      *
      ** PAY - ORDERING BANK NO.
      *
     C                     MOVE *BLANKS   PMPOBN
     C                     MOVELPAPOBN    PMPOBN
      *
      ** PAY - ORDERING CUSTOMER NO.
      *
     C                     MOVE *BLANKS   PMPOCN
     C                     MOVELPAPOCN    PMPOCN
      *
      ** RECEIVER CORRESPONDENT NO.
      *
     C                     MOVE *BLANKS   PMRCRN
     C                     MOVELPARCRN    PMRCRN
      *
      ** RECEIVER NUMBER
      *
     C                     MOVE *BLANKS   PMRVNO
     C                     MOVELPARVNO    PMRVNO
      *
      ** COUNTERPARTY RECEIVE INSTRUCTIONS.
      *
     C                     MOVE *BLANKS   PMAWBN
     C                     MOVELPAAWBN    PMAWBN
      *
      ** FOR ACCOUNT OF INSTRUCTIONS.
      *
     C                     MOVE *BLANKS   PMBENN
     C                     MOVELPABENN    PMBENN
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * PROSEL   : Process Enter from subfile screen                  *
      * Called by: REVIEW                                             *
      * Calls    : VLDSFL, ENQRYS, REVERS, AMENDS                     *
      *****************************************************************
     C           PROSEL    BEGSR
      *
      **  Process selction only if records exist on subfile
     C           *IN60     IFEQ *OFF
      *
      **  Clear Message subfile
     C                     EXSR CLEARM
      *
      **  Validate all changes in subfile
     C                     EXSR VLDSFL
      *
      **  If no errors execute valid option subroutine
     C           W#ERR1    IFEQ 'N'
      *
     C                     SELEC
     C           W#ACTN    WHEQ 'E'
     C                     EXSR ENQRYS
     C           W#ACTN    WHEQ 'R'
     C                     EXSR REVERS
     C           W#ACTN    WHEQ 'A'
     C                     EXSR AMENDS
     C           W#ACTN    WHEQ 'C'                                                           202456
     C                     EXSR CLOSES                                                        202456
     C                     ENDSL
      *                                                                   123857
     C                     MOVE *OFF      *IN12                           123857
      *
     C                     ENDIF
     C                     ENDIF
      *                                                                   123857
     C           F1ACTN    IFEQ 'X'                                       123857
     C           *IN60     IFEQ *ON                                       123857
     C           W#CNT1    OREQ *ZEROS                                    123857
     C                     MOVE *ON       *IN12                           123857
     C                     MOVE 'Y'       WENTR                           148847
     C                     EXSR CF03                                      123857
     C                     ENDIF                                          123857
     C                     ENDIF                                          123857
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDSFL   : Validate subfile selection                         *
      * Called by: PROSEL                                             *
      * Calls    : VLDENQ, VLDALL                                     *
      *****************************************************************
     C           VLDSFL    BEGSR
      *
     C                     MOVE 'N'       W#ERR1  1
     C                     Z-ADD*ZEROS    W#CNT1  30
      *
      **  Read all changed records
     C                     READCLE2021S1                 70
     C           *IN70     DOWEQ*OFF
      *
     C           P#MODE    IFEQ 'E'
     C                     EXSR VLDENQ
     C                     ELSE
     C                     EXSR VLDALL
     C                     ENDIF
      *
     C           S#SEL     IFEQ ' '
     C                     MOVE *OFF      *IN40            RI & PC
     C                     MOVE *OFF      *IN35            SFLNXTCHG
     C                     ELSE
     C                     MOVE *ON       *IN35            SFLNXTCHG
     C                     MOVE *ON       *IN40            RI & PC
     C                     ADD  1         W#CNT1
     C                     ENDIF
      *
     C           S#SEL     IFNE ' '
     C                     Z-ADDRRN1      W#RRN1  40       Save it
     C                     Z-ADDRRN1      ##SFRC           Position page
     C                     MOVE S#SEL     W#ACTN  1        Save it
     C                     ENDIF
      *
     C                     UPDATLE2021S1
      *
      **  Read next changed record
     C                     READCLE2021S1                 70
      *
     C                     ENDDO
      *
      **  More than one selection
     C           W#CNT1    IFGT 1
      *
     C                     MOVE 'Y'       W#ERR1  1
      *
      **  Display Message
     C                     MOVEL'LEP0027' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ELSE
      *
      **  No selection made therefore do nothing
     C           W#CNT1    IFEQ 0
     C                     MOVEL'Y'       W#ERR1           Error
     C                     ENDIF
     C                     ENDIF
      *
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDALL   : Validate subfile selection                         *
      *            (Insert, Amend, Dlete and Enquire                  *
      * Called by: VLDSFL                                             *
      * Calls    : None.                                              *
      *****************************************************************
      *    VLDALL - Validate input for Enquiry, Amend and Insert
     C           VLDALL    BEGSR
      *
      **  Only 'A' 'E' or 'R' can be used to make a valid selection
     C           S#SEL     IFNE 'E'
     C           S#SEL     ANDNE'A'
     C           S#SEL     ANDNE'R'
     C           S#SEL     ANDNE'C'                                                           202456
     C           S#SEL     ANDNE' '
      *
     C                     MOVE *ON       *IN40            RI & PC
      *
      **  Display Message if not already displayed
     C           W#ERR1    IFEQ 'N'
     C                     MOVEL'LEP0003' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVEL'Y'       W#ERR1           Error
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDENQ   : Validate subfile selection for Enquiry             *
      * Called by: VLDSFL                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDENQ    BEGSR
      *
      **  Only 'E' can be used to make a valid selection
     C           S#SEL     IFNE 'E'
     C           S#SEL     ANDNE' '
      *
     C                     MOVE *ON       *IN40            RI & PC
      *
      **  Display Message if not already displayed
     C           W#ERR1    IFEQ 'N'
     C                     MOVEL'LEP0002' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVEL'Y'       W#ERR1           Error
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT                                                              127641
      *****************************************************************   127641
      * CHKPRI   : Check if a loan is attached to the prime           *   127641
      * Called by: VLDALL                                             *   127641
      * Calls    : None                                               *   127641
      *****************************************************************   127641
     C           CHKPRI    BEGSR                                          127641
      *                                                                   127641
     C                     MOVE 'N'       W#ERR3  1                       127641
      *                                                                   127641
     C                     MOVE S#PMFC    K#CNUM                          127641
     C                     MOVE S#PMFT    K#FACT                          127641
     C                     MOVE S#PMFN    K#FCNO                          127641
      *                                                                   127641
     C           K#LTL0    SETLLLEREF                                     127641
     C           K#LTL0    READELEREF                    80               127641
      *                                                                   127641
     C           *IN80     DOWEQ'0'                                       127641
      *                                                                   127641
     C           RFRECI    IFEQ 'D'                                       127641
     C                     MOVE 'Y'       W#ERR3                          127641
     C                     LEAVE                                          127641
     C                     ENDIF                                          127641
     C           K#LTL0    READELEREF                    80               127641
     C                     ENDDO                                          127641
      *                                                                   127641
     C           W#ERR3    IFEQ 'Y'                                       127641
     C                     MOVEL'LEP0203' ZAMSID                          127641
     C                     MOVE 'Y'       W#ERR2                          127641
     C                     EXSR ZASNMS                                    127641
     C                     ENDIF                                          127641
      *                                                                   127641
     C                     ENDSR                                          127641
      /EJECT
      *****************************************************************
      * ENQRYS   : Process enquiry screen                             *
      * Called by: PROSEL                                             *
      * Calls    : POPSCR, CF03, CF12, CF14                           *
      *****************************************************************
     C           ENQRYS    BEGSR
      *
      **  Move File fields to screen
     C                     EXSR POPSCR
      *
     C                     MOVE *OFF      *IN12
     C                     MOVE *ON       *IN55            Protect Fields
     C                     MOVE *OFF      *IN56            Disable F10
      *
      **  Display screen until F12 or F3 pressed
     C           *IN03     DOWEQ*OFF
     C           *IN12     ANDEQ*OFF
      *
     C                     WRITELE2021F1                   Function Keys
     C                     WRITE#MSGCTL                    Messages
     C                     EXFMTLE2021F3                   Screen
      *
      **  Clear Message subfile
     C                     EXSR CLEARM
      *
      **  F3  - Exit
     C           *IN03     CASEQ'1'       CF03
      *                                   ****
      **  F12- Previous
     C           *IN12     CASEQ'1'       CF12
      *                                   ****
      **  F14 - Settlements
     C           *IN14     CASEQ'1'       CF14
      *                                   ****
      **  Procsee Window
     C                     CAS            SRWNDW
      *                                   ******
     C                     ENDCS
      *
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * POPSCR   : Move fields to screen                              *
      * Called by: REVERS, AMENDS, ENQRYS, CF05                       *
      * Calls    : None.                                              *
      *****************************************************************
     C           POPSCR    BEGSR
      *
      **  Chain to subfile
     C           W#RRN1    CHAINLE2021S1             70
      *
     C                     MOVELS#CNUM    S#CSSN    P
      *                                                                   140835
      **  Access the Customer Details file                                140835
      *                                                                   140835
     C                     CALL 'AOCUSTR0'                                140835
     C                     PARM '       ' @RTCD                           140835
     C                     PARM '*KEY   ' @OPTN                           140835
     C                     PARM S#CNUM    @CNUM                           140835
     C                     PARM           @CNST                           140835
     C           SDCUST    PARM SDCUST    DSSDY                           140835
     C                     MOVELBBCRNM    S#SRNM                          140835
     C                     MOVELBBCRTN    S#SRTN                          140835
      *                                                                   140835
      **  Introduced by
      *
      **  Access the Customer Details file
     C                     CALL 'AOCUSTR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM H#INUM    @CNUM  10
     C                     PARM           @CNST   7
     C           SDCUST    PARM SDCUST    DSSDY
     C                     MOVELBBCUST    S#INUM    P
     C                     MOVELBBCRNM    S#IRNM                          140835
     C                     MOVELBBCRTN    S#IRTN                          140835
      *
      **  Recourse Indicator
     C                     MOVE H#RCSI    S#RCSI
      *                                                                   147261
      **  Assignment/Participation indicator                              147261
     C                     MOVE H#PASI    S#PASI                          147261
      *
      **  Interest Skim
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE H#SKIR    ZFIELD
     C                     Z-ADD7         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    S#SKIR
     C                     MOVE H#SKIS    S#SKIS
      *
      **  Fees Skim
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE H#SKFR    ZFIELD
     C                     Z-ADD7         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    S#SKFR
     C                     MOVE H#SKFS    S#SKFS
      *                                                                   153666
      **  Alternate Name & Address Code                                   153666
     C                     MOVE H#NACD    S#NACD                          153666
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE H#COAG    S#COAG                                              CLE031
     C                     MOVE H#FCAG    S#FCAG                                              CLE031
     C                     MOVE H#PHAG    S#PHAG                                              CLE031
     C                     MOVE H#SCAG    S#SCAG                                              CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * REVERS   : Process deletion screen                            *
      * Called by: PROSEL                                             *
      * Calls    : POPSCR, CF03, CF10, CF12, CF14, ENTER2             *
      *****************************************************************
     C           REVERS    BEGSR
      *
     C                     MOVE *OFF      *IN10
     C                     MOVE *OFF      *IN12
     C                     MOVE *ON       *IN55            Protect Fiel
     C                     MOVE *ON       *IN56            Enable F10
      *
      **  Move File fields to screen
     C                     EXSR POPSCR
      *
      **  Display screen until
     C           *IN03     DOWEQ*OFF
     C           *IN12     ANDEQ*OFF
     C           *IN10     ANDEQ*OFF
      *
     C                     WRITELE2021F1                   Function Keys
     C                     WRITE#MSGCTL                    Messages
     C                     EXFMTLE2021F3                   Screen
      *
      **  Clear Message subfile
     C                     EXSR CLEARM
      *
      **  F3  - Exit
     C           *IN03     CASEQ'1'       CF03
      *                                   ****
      **  F10- Revers
     C           *IN10     CASEQ'1'       CF10
      *                                   ****
      **  F12- Previuos
     C           *IN12     CASEQ'1'       CF12
      *                                   ****
      **  F14 - Settlements
     C           *IN14     CASEQ'1'       CF14
      *                                   ****
      **  Enter Key Processing
     C                     CAS            ENTER2
      *
     C                     ENDCS
      *
     C                     ENDDO
      *
      *
     C                     ENDSR
      /EJECT
      *****************************************************************                       202456
      * CLOSES   : Process close screen                               *                       202456
      * Called by: PROSEL                                             *                       202456
      * Calls    : POPSCR, CF03, CF10, CF12, CF14, ENTER2             *                       202456
      *****************************************************************                       202456
     C           CLOSES    BEGSR                                                              202456
      *                                                                                       202456
     C                     MOVE *OFF      *IN10                                               202456
     C                     MOVE *OFF      *IN12                                               202456
     C                     MOVE *ON       *IN55            Protect Fiel                       202456
     C                     MOVE *ON       *IN56            Enable F10                         202456
      *                                                                                       202456
      **  Move File fields to screen                                                          202456
     C                     EXSR POPSCR                                                        202456
      *                                                                                       202456
      **  Display screen until                                                                202456
     C           *IN03     DOWEQ*OFF                                                          202456
     C           *IN12     ANDEQ*OFF                                                          202456
     C           *IN10     ANDEQ*OFF                                                          202456
      *                                                                                       202456
     C                     WRITELE2021F1                   Function Keys                      202456
     C                     WRITE#MSGCTL                    Messages                           202456
     C                     EXFMTLE2021F3                   Screen                             202456
      *                                                                                       202456
      **  Clear Message subfile                                                               202456
     C                     EXSR CLEARM                                                        202456
      *                                                                                       202456
      **  F3  - Exit                                                                          202456
     C           *IN03     CASEQ'1'       CF03                                                202456
      *                                   ****                                                202456
      **  F10- Close                                                                          202456
     C           *IN10     CASEQ'1'       CF10                                                202456
      *                                   ****                                                202456
      **  F12- Previuos                                                                       202456
     C           *IN12     CASEQ'1'       CF12                                                202456
      *                                   ****                                                202456
      **  F14 - Settlements                                                                   202456
     C           *IN14     CASEQ'1'       CF14                                                202456
      *                                   ****                                                202456
      **  Enter Key Processing                                                                202456
     C                     CAS            ENTER2                                              202456
      *                                                                                       202456
     C                     ENDCS                                                              202456
      *                                                                                       202456
     C                     ENDDO                                                              202456
      *                                                                                       202456
      *                                                                                       202456
     C                     ENDSR                                                              202456
      /EJECT                                                                                  202456
      *****************************************************************
      * ENTER2   :                                                    *
      * Called by: REVERS                                             *
      * Calls    : NONE.                                              *
      *****************************************************************
     C           ENTER2    BEGSR
      *
      **  Display Message
     C           W#ACTN    IFEQ 'R'                                                           202456
     C                     MOVEL'LEP0024' ZAMSID
     C                     ELSE                                                               202456
     C                     MOVEL'LEP0045' ZAMSID                                              202456
     C                     ENDIF                                                              202456
     C                     EXSR ZASNMS
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDDET   : Validate Syndicate member details                  *
      * Called by: Main routine, CF09                                 *
      * Calls    : VLDCUS, VLDFCT, VLDINC, VLDJDT, VLDVDT, VLDSHR,    *
      *            VLDRCI, VLDSKM, SR2410, SRWNDW, UPDFLE             *
      *****************************************************************
     C           VLDDET    BEGSR
      *
     C                     MOVE 'N'       W#ERR2  1        Error
      *
     C           P#MODE    IFNE 'B'
     C           P#MODE    ANDNE'P'
      *
      ** Setof invalid error indicators
     C                     SETOF                     414243
     C                     SETOF                     444546
     C                     SETOF                     474849
     C                     SETOF                     505152
     C                     SETOF                     53                   147261
     C                     MOVE *OFF      *IN19                           153666
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE *OFF      *IN62                                               CLE031
     C                     MOVE *OFF      *IN63                                               CLE031
     C                     MOVE *OFF      *IN64                                               CLE031
     C                     MOVE *OFF      *IN65                                               CLE031
     C                     ENDIF                                                              CLE031
      *
      ** Clear Message subfile
     C                     EXSR CLEARM
      *
     C                     ENDIF
      *
     C           W#ACTN    IFEQ 'I'
      *
      ** Validate Syndicate Member
     C                     EXSR VLDCUS
      *
      ** Validate Facility Type
     C                     EXSR VLDFCT
      *                                                                   141483
      **  Validate Joining Date                                           141483
      *                                                                   141483
     C                     EXSR VLDJDT                                    141483
     C                     ENDIF
      *
      **  Validate Introducing Customer
     C                     EXSR VLDINC
      ***********                                                         141483
      ****Validate Joining Date                                           141483
     C***********          EXSR VLDJDT                                    141483
      *
      **  Validate Value Date
     C                     EXSR VLDVDT
      *
      **  Validate Share
     C                     EXSR VLDSHR
      *
      **  Validate Recourse Indicator
     C                     EXSR VLDRCI
      *                                                                   147261
      **  Validate Assignment/Participation indicator                     147261
     C                     EXSR VLDAPI                                    147261
      *
      **  Validate Skim
     C                     EXSR VLDSKM
      *                                                                   153666
      **  Validate Alternate Name and Address Code                        153666
     C                     EXSR VLDALT                                    153666
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     EXSR VLCOAG                                                        CLE031
     C                     EXSR VLFCAG                                                        CLE031
     C                     EXSR VLPHAG                                                        CLE031
     C                     EXSR VLSCAG                                                        CLE031
     C                     ENDIF                                                              CLE031
      *
      **  Validate settlement details
     C           P#MODE    IFEQ 'P'
     C           P#MODE    OREQ 'B'
     C                     EXSR SR2410
     C                     ENDIF
      *
      **
     C           W#ERR2    IFEQ 'N'
     C           W#VSET    ANDEQ'Y'
      *
     C           P#MODE    IFEQ 'I'
     C           P#MODE    OREQ 'R'
     C                     EXSR SRWNDW
     C                     ENDIF
      *
     C                     EXSR UPDFLE
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDCUS   : Validate Syndicate Member                          *
      * Called by: VLDDET                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDCUS    BEGSR
      *                                                                   140835
     C                     MOVE *BLANKS   S#SRNM                          140835
     C                     MOVE *BLANKS   S#SRTN                          140835
      *
      **  Validate Syndicate Member
      *
      **  Check if the Syndicate member has been entered
     C           S#CSSN    IFEQ *BLANKS
      *
     C                     MOVE 'Y'       W#ERR2           Error
     C                     MOVE *ON       *IN41            RI & PC
      *
      **  Display Message
     C                     MOVEL'LEP0004' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ELSE
      *
      ** Access the Customer Details file
     C                     CALL 'AOCUSTR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM S#CSSN    @CNUM  10
     C                     PARM           @CNST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      **  Display Message
     C           @RTCD     IFNE *BLANKS
     C                     MOVEL'LEP0005' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN41            RI & PC
      *
     C                     ELSE
      *
     C                     MOVE *BLANKS   S#CSSN
     C                     MOVELBBCUST    S#CSSN    P
     C                     MOVELBBCRNM    S#SRNM                          140835
     C                     MOVELBBCRTN    S#SRTN                          140835
     C           *LIKE     DEFN A8SYCU    W#SYCU                          121971
     C                     MOVELBBCUST    W#SYCU                          121971
      *
      * Check if already exists
     C           *LIKE     DEFN CNUM      K#CNUM
     C                     MOVE BBCUST    K#CNUM
     C                     MOVELBBCUST    S#CNUM
     C           K#LTL3    CHAINLEFCLTL2             70
     C           *IN70     IFEQ *OFF
     C                     MOVE 'Y'       W#ERR2           Error
     C                     MOVE *ON       *IN41            RI & PC
      *
      **  Display Message
     C                     MOVEL'LEP0006' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ENDIF
      *
      * Not Parent
     C           BBPAIN    IFEQ 'P'
     C                     MOVE 'Y'       W#ERR2           Error
     C                     MOVE *ON       *IN41            RI & PC
      *
      **  Display Message
     C                     MOVEL'LEP0028' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ENDIF
      *                                                                   121971
      * Funding Participant is not allowed to be the Syndicate agent      121971
      *                                                                   121971
     C           A8SYCU    IFEQ W#SYCU                                    121971
     C                     MOVE 'Y'       W#ERR2                          121971
     C                     MOVE *ON       *IN41                           121971
     C                     MOVEL'LEP0040' ZAMSID                          121971
     C                     EXSR ZASNMS                                    121971
     C                     ENDIF                                          121971
      *
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDFCT   : Validate Facility Type                             *
      * Called by: VLDDET                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDFCT    BEGSR
      *
      **  Check if the Facility Type has been entered
     C           S#FACT    IFEQ *BLANKS
      *
     C                     MOVE 'Y'       W#ERR2           Error
     C                     MOVE *ON       *IN50            RI & PC
      *
      **  Display Message
     C                     MOVEL'LEP0009' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ELSE
      *
     C                     CALL 'AOFACTR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY'    @OPTN
     C                     PARM           S#FACT
     C           SDFACT    PARM SDFACT    DSFDY
      *
      ** Record not found.
     C           @RTCD     IFNE *BLANKS
     C                     MOVEL'LEP0008' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN50            RI & PC
     C                     ELSE
      *
     C                     MOVELAMFCTY    S#FACT
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDINC   : Validate Introducing Customer                      *
      * Called by: VLDDET                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDINC    BEGSR
      *                                                                   140835
     C                     MOVE *BLANKS   S#IRNM                          140835
     C                     MOVE *BLANKS   S#IRTN                          140835
      *
     C           S#INUM    IFEQ *BLANKS
      *
      ** Access the Customer Details file
     C                     CALL 'AOCUSTR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM S#ANUM    @CNUM  10
     C                     PARM           @CNST   7
     C           SDCUST    PARM SDCUST    DSSDY
     C                     MOVE *BLANKS   S#INUM
     C                     MOVELBBCUST    S#INUM    P
     C                     MOVELBBCRNM    S#IRNM                          140835
     C                     MOVELBBCRTN    S#IRTN                          140835
      *
     C                     ELSE
      *
      ** Access the Customer Details file
     C                     CALL 'AOCUSTR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM S#INUM    @CNUM  10
     C                     PARM           @CNST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      **  Display Message
     C           @RTCD     IFNE *BLANKS
     C                     MOVEL'LEP0010' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN42            RI & PC
     C                     ELSE
     C                     MOVE *BLANKS   S#INUM                          S01194
     C                     MOVELBBCUST    S#INUM    P
     C                     MOVELBBCRNM    S#IRNM                          140835
     C                     MOVELBBCRTN    S#IRTN                          140835
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDJDT   : Validate Joining Date                              *
      * Called by: VLDDET                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDJDT    BEGSR
      *
     C           S#JDTE    IFEQ *BLANKS
      *
      ** Dfault to the system date
     C                     MOVE BJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     S#JDTE
      *
      ** convert to Midas date format
     C                     MOVE *OFF      *IN99
     C                     MOVE S#JDTE    ZDATE
     C                     EXSR ZDATE1
      *
     C                     ELSE
      *
      ** convert to Midas date format
     C                     MOVE *OFF      *IN99
     C                     MOVE S#JDTE    ZDATE
     C                     EXSR ZDATE1
     C           *IN99     IFEQ *ON                        invalid
      *
      **  Display Message
     C                     MOVEL'LEP0011' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN43            RI & PC
      *
     C                     ELSE                            Valid
     C           ZDAYNO    IFGT BJRDNB                     GT than Run dat
      *
      **  Display Message
     C                     MOVEL'LEP0011' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN43            RI & PC
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
     C           *LIKE     DEFN ZDAYNO    W#DAYN
     C                     MOVE ZDAYNO    W#DAYN
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDVDT   : Validate Value Date                                *
      * Called by: VLDDET                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDVDT    BEGSR
      *
     C           S#VDTC    IFEQ *BLANKS
      *
      ** Dfault to the system date
     C                     MOVE BJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     S#VDTC
      *
     C                     ELSE
      *
      ** convert to Midas date format
     C                     MOVE *OFF      *IN99
     C                     MOVE S#VDTC    ZDATE
     C                     EXSR ZDATE1
     C           *IN99     IFEQ *ON                        invalid
      *
      **  Display Message
     C                     MOVEL'LEP0012' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN51            RI & PC
      *
     C                     ELSE                            Valid
      *                                                                   148844
     C           JDTE      IFNE 0                                         148844
     C           W#ACTN    ANDEQ'A'                                       148844
     C                     Z-ADDJDTE      W#DAYN                          148844
     C                     ENDIF                                          148844
      *                                                                   148844
     C           ZDAYNO    IFGT BJRDNB                     GT than Run dat
     C           ZDAYNO    ORLT W#DAYN                                 dat
      *
      **  Display Message
     C                     MOVEL'LEP0012' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN51            RI & PC
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDSHR   : Validate Share (Amount/Percentage)                 *
      * Called by: VLDDET                                             *
      * Calls    : CALCSO, CALCAV                                     *
      *****************************************************************
     C           VLDSHR    BEGSR
      *
      **  Validate the Share Type
     C           S#SHTP    IFNE 'P'
     C           S#SHTP    ANDNE'A'
      *
      **  Display Message
     C                     MOVEL'LEP0013' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN44            RI & PC
      *
     C                     ELSE
      *
      **  Validate Share
     C           S#SHAR    IFEQ *BLANKS
      *
      **  Display Message
     C                     MOVEL'LEP0014' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN45            RI & PC
      *
     C                     ELSE
      *
     C           S#SHTP    IFEQ 'P'
     C                     Z-ADD3         ZADIG
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SHAR    ZFIELD
     C                     Z-ADD12        ZADEC
     C                     MOVE *OFF      *IN99
     C                     EXSR ZALIGN
      *
     C                     ELSE
     C           S#SHTP    IFEQ 'A'
     C           13        SUB  A6NBDP    ZADIG
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SHAR    ZFIELD
     C                     Z-ADDA6NBDP    ZADEC
     C                     MOVE *OFF      *IN99
     C                     EXSR ZALIGN
      *
     C                     ENDIF
     C                     ENDIF
      *
     C           ZFIELD    IFEQ *BLANK
     C           *IN99     OREQ *ON
      *
      **  Display Message
     C                     MOVEL'LEP0014' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN45            RI & PC
      *
     C                     ELSE
      *
      *  Save share for a later calculation
     C           *LIKE     DEFN SHPC      W#SHRC
     C                     Z-ADD0         W#SHRC
     C                     MOVE ZFIELD    W#SHRC
     C***********W#SHRC    IFEQ 0                                         124480
      ***********                                                         124480
      ****Display*Message******************************************       124480
     C***********          MOVEL'LEP0014' ZAMSID                          124480
     C***********          MOVE 'Y'       W#ERR2           Error   120468 124480
     C***********          EXSR ZASNMS                                    124480
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C***********          MOVE *ON       *IN45            RI & PC        124480
     C***********          ENDIF                                          124480
      *
      **  Calculate share amount/percentage if in batch or play mode
     C           P#MODE    IFEQ 'B'
     C           P#MODE    OREQ 'P'
     C                     EXSR CALCSO
     C                     ENDIF
      *
      **  Calculate available share amount/perecntage
     C                     EXSR CALCAV
      *                                                                   157594
      ** Obtain details of current Risk Particpations against prime       157594
      ** facility to determine portion which has already been sold.       157594
      *                                                                   157594
     C                     Z-ADDW#EXPS    W#PTST 130                      157594
     C                     Z-ADD*ZEROS    W#PTSA                          157594
     C                     Z-ADD*ZEROS    W#PTSO                          157594
      *                                                                   157594
     C                     MOVE F1PMFC    K#CUNO                          157594
     C                     MOVE F1PMFT    K#CUFA                          157594
     C                     MOVE F1PMFN    K#CFNO                          157594
      *                                                                   157594
     C                     Z-ADD0         W#SHAM 130                      157594
      *                                                                   157594
     C           K#LTL5    SETLLLEPARTL1                                  157594
     C           K#LTL5    READELEPARTL1                 70               157594
      *                                                                   157594
     C           *IN70     DOWEQ'0'                                       157594
     C                     ADD  SHAM      W#SHAM                          157594
     C           K#LTL5    READELEPARTL1                 70               157594
     C                     ENDDO                                          157594
      *                                                                   157594
      ** W#SHAM equals total risk sold and should not exceed internally   157594
      ** funded portion of facililty                                      157594
      *                                                                   157594
     C           S#SHTP    IFEQ 'P'                                       157594
     C                     MOVE W#FAMT    P#PAMT 13                       157594
     C                     MOVE W#SHRC    P#SHPC 15                       157594
     C                     MOVE *BLANKS   P#FAMT 13                       157594
     C                     MOVE S#SHTP    P#SHTP  1                       157594
     C                     CALL 'LE2024'                                  157594
     C                     PARM           P#PAMT                          157594
     C                     PARM           P#SHPC                          157594
     C                     PARM           P#FAMT                          157594
     C                     PARM           P#SHTP                          157594
      *                                                                   157594
     C                     MOVE P#FAMT    W#PTSO 130                      157594
     C                     ELSE                                           157594
     C                     MOVE W#SHRC    W#PTSO                          157594
     C                     ENDIF                                          157594
      *                                                                   157594
     C           W#ACTN    IFEQ 'I'                                       157594
     C           S#CNUM    ANDNEA8BICN                                    157594
     C                     ADD  W#PTSO    W#PTST                          157594
     C                     ENDIF                                          157594
      *                                                                   157594
     C           W#ACTN    IFEQ 'A'                                       157594
     C           S#CNUM    ANDNEA8BICN                                    157594
     C                     ADD  W#PTSO    W#PTST                          157594
     C                     MOVE S#CNUM    K#CNUM                          157594
     C           K#LTL3    CHAINLEFCLTL2             84                   157594
     C                     SUB  FAMT      W#PTST                          157594
     C                     ENDIF                                          157594
      *                                                                   157594
      ** Calculate amount of facility that has not been sold              157594
      *                                                                   157594
     C           W#FAMT    SUB  W#PTST    W#PTSA 130                      157594
      *                                                                   157594
      ** Ensure that Risk sold is not greater than retained facility      157594
      *                                                                   157594
     C           W#SHAM    IFGT W#PTSA                                    157594
      *                                                                   157594
      **  Warning may already have been issued or amount changed          157594
      *                                                                   157594
     C           W01       IFNE 'Y'                                       157594
     C           W#AMSV    ORNE W#PTSO                                    157594
      *                                                                   157594
      **  Display Message                                                 157594
      *                                                                   157594
     C                     MOVEL'LEP0042' ZAMSID                          157594
     C                     MOVE 'Y'       W#ERR2           Error          157594
     C                     EXSR ZASNMS                                    157594
     C                     MOVE *ON       *IN45            RI & PC        157594
     C                     MOVE 'Y'       W01                             157594
     C                     Z-ADDW#PTSO    W#AMSV 130                      157594
      *                                                                   157594
     C                     ELSE                                           157594
     C                     MOVE *BLANK    W01     1                       157594
      *                                                                   157594
     C                     ENDIF                                          157594
     C                     ENDIF                                          157594
      *                                                                   157594
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT                                                              153666
      *****************************************************************   153666
      * VLDALT   : Validate Alternate Name and Address Code           *   153666
      * Called by: VLDDET                                             *   153666
      * Calls    : None                                               *   153666
      *****************************************************************   153666
     C           VLDALT    BEGSR                                          153666
      *                                                                   153666
      **  Must be valid name & address record on SDALTNPD                 153666
     C           S#NACD    IFEQ *BLANKS                                   153666
     C           S#NACD    OREQ 'B'                                       153666
     C                     MOVE 'B'       S#NACD                          153666
      *                                                                   153666
     C                     ELSE                                           153666
      *                                                                   153666
     C***********          MOVELS#CSSN    WCUST   6                153666 156044
     C                     MOVELS#CNUM    WCUST   6                       156044
     C                     MOVELS#NACD    WADCD   1                       153666
     C                     CALL 'AOALTNR0'                                153666
     C                     PARM '*BLANKS' @RTCD                           153666
     C                     PARM '*VERIFY' @OPTN                           153666
     C                     PARM           WCUST                           153666
     C                     PARM           WADCD                           153666
     C           SDALTN    PARM SDALTN    DSFDY                           153666
      *                                                                   153666
     C           @RTCD     IFNE *BLANKS                                   153666
     C                     MOVEL'LEP0204' ZAMSID                          153666
     C                     MOVE 'Y'       W#ERR2                          153666
     C                     EXSR ZASNMS                                    153666
     C                     MOVE *ON       *IN19                           153666
     C                     ENDIF                                          153666
     C                     ENDIF                                          153666
      *                                                                   153666
     C                     ENDSR                                          153666
      /EJECT                                                                                  CLE031
      *****************************************************************                       CLE031
      * VLCOAG   : Validate Co-Agent                                  *                       CLE031
      * Called by: VLDDET                                             *                       CLE031
      * Calls    : None                                               *                       CLE031
      *****************************************************************                       CLE031
     C           VLCOAG    BEGSR                                                              CLE031
      *                                                                                       CLE031
     C                     SELEC                                                              CLE031
      *                                                                                       CLE031
     C           S#COAG    WHEQ *BLANK                                                        CLE031
     C           S#COAG    OREQ 'N'                                                           CLE031
     C                     MOVE 'N'       WCOAG                                               CLE031
      *                                                                                       CLE031
     C           S#COAG    WHNE 'Y'                                                           CLE031
     C           S#COAG    ANDNE'N'                                                           CLE031
     C                     MOVEL'LEP0300' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN62                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
      *                                                                                       CLE031
     C           S#COAG    WHEQ 'Y'                                                           CLE031
     C**********           MOVELS#ANUM    WCANUM  60                                   CLE031 CSD027
     C                     MOVELS#ANUM    WCANUM  6                                           CSD027
     C           A8SYCU    IFNE WCANUM                                                        CLE031
     C                     MOVEL'LEP0301' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN62                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE 'Y'       WCOAG   1                                           CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSL                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSR                                                              CLE031
      /EJECT                                                                                  CLE031
      *****************************************************************                       CLE031
      * VLFCAG   : Validate Facility Agent                            *                       CLE031
      * Called by: VLDDET                                             *                       CLE031
      * Calls    : None                                               *                       CLE031
      *****************************************************************                       CLE031
     C           VLFCAG    BEGSR                                                              CLE031
      *                                                                                       CLE031
     C                     SELEC                                                              CLE031
      *                                                                                       CLE031
     C           S#FCAG    WHEQ *BLANKS                                                       CLE031
     C           S#FCAG    OREQ 'N'                                                           CLE031
     C                     MOVE 'N'       WFCAG                                               CLE031
      *                                                                                       CLE031
     C           S#FCAG    WHNE 'Y'                                                           CLE031
     C           S#FCAG    ANDNE'N'                                                           CLE031
     C                     MOVEL'LEP0302' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN63                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
      *                                                                                       CLE031
     C           S#FCAG    WHEQ 'Y'                                                           CLE031
     C                     MOVELS#ANUM    WCANUM                                              CLE031
     C           A8SYCU    IFNE WCANUM                                                        CLE031
     C                     MOVEL'LEP0303' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN63                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE 'Y'       WFCAG   1                                           CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSL                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSR                                                              CLE031
      /EJECT                                                                                  CLE031
      *****************************************************************                       CLE031
      * VLPHAG   : Validate Paying/Handling Agent                     *                       CLE031
      * Called by: VLDDET                                             *                       CLE031
      * Calls    : None                                               *                       CLE031
      *****************************************************************                       CLE031
     C           VLPHAG    BEGSR                                                              CLE031
      *                                                                                       CLE031
     C                     SELEC                                                              CLE031
      *                                                                                       CLE031
     C           S#PHAG    WHEQ *BLANKS                                                       CLE031
     C           S#PHAG    OREQ 'N'                                                           CLE031
     C                     MOVE 'N'       WPHAG                                               CLE031
      *                                                                                       CLE031
     C           S#PHAG    WHNE 'Y'                                                           CLE031
     C           S#PHAG    ANDNE'N'                                                           CLE031
     C                     MOVEL'LEP0304' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN64                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
      *                                                                                       CLE031
     C           S#PHAG    WHEQ 'Y'                                                           CLE031
     C                     MOVELS#ANUM    WCANUM                                              CLE031
     C           A8SYCU    IFNE WCANUM                                                        CLE031
     C                     MOVEL'LEP0305' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN64                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE 'Y'       WPHAG   1                                           CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSL                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSR                                                              CLE031
      /EJECT                                                                                  CLE031
      *****************************************************************                       CLE031
      * VLSCAG   : Validate Security Agent                            *                       CLE031
      * Called by: VLDDET                                             *                       CLE031
      * Calls    : None                                               *                       CLE031
      *****************************************************************                       CLE031
     C           VLSCAG    BEGSR                                                              CLE031
      *                                                                                       CLE031
     C                     SELEC                                                              CLE031
      *                                                                                       CLE031
     C           S#SCAG    WHEQ *BLANKS                                                       CLE031
     C           S#SCAG    OREQ 'N'                                                           CLE031
     C                     MOVE 'N'       WSCAG                                               CLE031
      *                                                                                       CLE031
     C           S#SCAG    WHNE 'Y'                                                           CLE031
     C           S#SCAG    ANDNE'N'                                                           CLE031
     C                     MOVEL'LEP0306' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN65                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
      *                                                                                       CLE031
     C           S#SCAG    WHEQ 'Y'                                                           CLE031
     C                     MOVELS#ANUM    WCANUM                                              CLE031
     C           A8SYCU    IFNE WCANUM                                                        CLE031
     C                     MOVEL'LEP0307' ZAMSID                                              CLE031
     C                     MOVE 'Y'       W#ERR2                                              CLE031
     C                     MOVE *ON       *IN65                                               CLE031
     C                     EXSR ZASNMS                                                        CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE 'Y'       WSCAG   1                                           CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSL                                                              CLE031
      *                                                                                       CLE031
     C                     ENDSR                                                              CLE031
      /EJECT
      *****************************************************************
      * CALCSO   : Calculate total share                              *
      * Called by: VLDSHR                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           CALCSO    BEGSR
      *
     C                     Z-ADD0         W#TFAM
     C                     Z-ADD0         W#TSHP
      *
     C           K#LTL2    SETLLLEFCLTL2
     C           K#LTL2    READELEFCLTL2                 70
      *
     C           *IN70     DOWEQ*OFF
     C                     ADD  FAMT      W#TFAM
     C                     ADD  SHPC      W#TSHP
     C           K#LTL2    READELEFCLTL2                 70
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CALCAV   : Calculate available share                          *
      * Called by: VLDSHR                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           CALCAV    BEGSR
      *
      *
     C           P#MODE    IFEQ 'B'
     C           P#MODE    OREQ 'P'
     C***********          MOVE S#CNUM    K#PMFC                          121988
     C                     MOVE S#CNUM    K#CNUM                          121988
     C                     MOVE S#FACT    K#FACT
     C                     MOVE S#FCNO    K#FCNO
     C           K#LTL0    CHAINLEFCLTL0             70
     C                     MOVE FAMT      H#FAMT
     C                     MOVE SHPC      H#SHPC
     C                     ENDIF
      *
      **   Calculate available share amount
     C           *LIKE     DEFN FAMT      W#AVAM
     C           W#FAMT    SUB  W#TFAM    W#AVAM
      *
     C           W#ACTN    IFEQ 'A'
     C           W#AVAM    ADD  H#FAMT    W#AVAM
     C                     ENDIF
      *
      **   Calculate available share percentage
     C                     MOVEL1         W#100N 150
      *
     C           *LIKE     DEFN SHPC      W#AVPC
     C           W#100N    SUB  W#TSHP    W#AVPC
      *
     C           W#ACTN    IFEQ 'A'
     C           W#AVPC    ADD  H#SHPC    W#AVPC
     C                     ENDIF
      *
     C           S#SHTP    IFEQ 'A'
     C           P#MODE    ANDNE'B'                                       123390
     C           W#SHRC    IFGT W#AVAM
      *
      **  Display Message
     C***********          MOVEL'LEP0014' ZAMSID                          160630
     C                     MOVEL'LEP0043' ZAMSID                          160630
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN45            RI & PC
     C                     ENDIF
      *
     C                     ELSE
      *
     C           S#SHTP    IFEQ 'P'
     C           P#MODE    ANDNE'B'                                       123390
     C           W#SHRC    IFGT W#AVPC
      *
      **  Display Message
     C***********          MOVEL'LEP0014' ZAMSID                          160630
     C                     MOVEL'LEP0043' ZAMSID                          160630
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN45            RI & PC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * VLDRCI   : Validate recourse indicator                        *
      * Called by: VLDDET                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDRCI    BEGSR
      *
      **  Validate Recourse Indicator
     C           S#RCSI    IFEQ *BLANKS
     C                     MOVE 'N'       S#RCSI
      *
     C                     ELSE
      *
     C           S#RCSI    IFNE 'Y'
     C           S#RCSI    ANDNE'N'
     C                     MOVEL'LEP0019' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN52            RI & PC
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT                                                              147261
      *****************************************************************   147261
      * VLDAPI   : Validate Participation/Assignment indicator        *   147261
      * Called by: VLDDET                                             *   147261
      * Calls    : None.                                              *   147261
      *****************************************************************   147261
     C           VLDAPI    BEGSR                                          147261
      *                                                                   147261
      **  Validate Participation/Assignment indicator                     147261
     C           S#PASI    IFEQ *BLANKS                                   147261
     C                     MOVE 'P'       S#PASI                          147261
      *                                                                   147261
     C                     ELSE                                           147261
      *                                                                   147261
     C           S#PASI    IFNE 'A'                                       147261
     C           S#PASI    ANDNE'P'                                       147261
     C                     MOVEL'LEP0041' ZAMSID                          147261
     C                     MOVE 'Y'       W#ERR2           Error          147261
     C                     EXSR ZASNMS                                    147261
     C                     MOVE *ON       *IN53                           147261
     C                     ENDIF                                          147261
      *                                                                   147261
     C                     ENDIF                                          147261
      *                                                                   147261
     C                     ENDSR                                          147261
      /EJECT
      *****************************************************************
      * VLDSKM   : Validate Skim                                      *
      * Called by: VLDDET                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           VLDSKM    BEGSR
      *
      **  Validate Skim Interest Rate
     C           S#SKIR    IFNE *BLANK
      *
     C                     Z-ADD4         ZADIG
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SKIR    ZFIELD
     C                     Z-ADD7         ZADEC
     C                     MOVE *OFF      *IN99
     C                     EXSR ZALIGN
      *
     C           *IN99     IFEQ *ON
     C                     MOVEL'LEP0015' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN46            RI & PC
     C                     ELSE
     C           *LIKE     DEFN SKIR      W#SKIR
     C                     MOVE ZFIELD    W#SKIR
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Validate Skim Interest Rate Sign
     C           S#SKIS    IFEQ *BLANK
     C           S#SKIR    ANDNE*BLANK
     C           W#SKIR    ANDNE*ZEROS
     C                     MOVE '-'       S#SKIS
     C                     ELSE
     C           S#SKIS    IFNE '+'
     C           S#SKIS    ANDNE'-'
     C           S#SKIS    ANDNE*BLANKS
     C                     MOVEL'LEP0016' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN47            RI & PC
     C                     ENDIF
     C                     ENDIF
      *
      **  Validate Skim Fees Rate
     C           S#SKFR    IFNE *BLANK
     C                     Z-ADD4         ZADIG
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SKFR    ZFIELD
     C                     Z-ADD7         ZADEC
     C                     MOVE *OFF      *IN99
     C                     EXSR ZALIGN
     C           *IN99     IFEQ *ON
     C                     MOVEL'LEP0017' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN48            RI & PC
     C                     ELSE
     C           *LIKE     DEFN SKFR      W#SKFR
     C                     MOVE ZFIELD    W#SKFR
     C                     ENDIF
     C                     ENDIF
      *
      **  Validate Skim Fees Rate Sign
     C           S#SKFS    IFEQ *BLANK
     C           S#SKFR    ANDNE*BLANK
     C           W#SKFR    ANDNE*ZEROS
     C                     MOVE '-'       S#SKFS
     C                     ELSE
     C           S#SKFS    IFNE '+'
     C           S#SKFS    ANDNE'-'
     C           S#SKFS    ANDNE*BLANKS
     C                     MOVEL'LEP0018' ZAMSID
     C                     MOVE 'Y'       W#ERR2           Error          120468
     C                     EXSR ZASNMS
     C***********          MOVE 'Y'       W#ERR2           Error          120468
     C                     MOVE *ON       *IN49            RI & PC
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * LOADFM   : Load details to Facility file                      *
      * Called by: AMENDR, WRITER, REVERR                             *
      * Calls    : LE2024                                             *
      *****************************************************************
      *
     C           LOADFM    BEGSR
      *
     C           W#ACTN    IFEQ 'I'
      *
      **   Facility sequence number
     C                     MOVE S#CNUM    K#CNUM
     C                     MOVE S#FACT    K#FACT
     C***********          Z-ADD0         K#FCNO                          120525
     C                     Z-ADD1         K4FCNO                          120525
     C                     MOVE *BLANKS   K#RCTP
     C                     MOVE 'N'       W#EXIT  1                       120525
     C                     MOVE 'N'       W#ERR5  1                       120525
     C           K#LTL4    SETLLFCLTY                    70
      *
     C************IN70     IFEQ *OFF                                      120525
     C************LIKE     DEFN FCNO      W#FCNO                          120525
     C***********          Z-ADD0         W#FCNO                          120525
     C***********          ELSE                                           120525
     C***********K#LTL4    SETGTFCLTY                                     120525
     C***********K#LTL4    REDPEFCLTY                    70               120525
     C***********          Z-ADDFCNO      W#FCNO                          120525
     C***********          ENDIF                                          120525
      *                                                                   120525
     C           W#EXIT    DOWNE'Y'                                       120525
      *                                                                   120525
     C           *IN70     IFEQ *OFF                                      120525
     C                     MOVE 'Y'       W#EXIT                          120525
     C                     ELSE                                           120525
     C           K4FCNO    IFNE 99                                        120525
     C                     ADD  1         K4FCNO                          120525
     C           K#LTL4    SETLLFCLTY                    70               120525
     C                     ELSE                                           120525
     C                     MOVE 'Y'       W#EXIT                          120525
     C                     MOVE 'Y'       W#ERR5                          120525
     C                     ENDIF                                          120525
     C                     ENDIF                                          120525
      *                                                                   120525
     C                     ENDDO                                          120525
      *                                                                   120525
     C           W#ERR5    IFNE 'Y'                                       120525
      *
      **  Chain to prime facility record so details can be defaulted.
     C                     MOVE F1PMFC    K#CNUM
     C                     MOVE F1PMFT    K#FACT
     C                     MOVE F1PMFN    K#FCNO
     C                     MOVE 'A'       K#RCTP
     C           K#FCTY    CHAINFCLTY                70
      *
     C                     MOVE S#CNUM    CNUM
     C                     MOVE S#FACT    FACT
     C***********W#FCNO    ADD  1         FCNO                            120525
     C                     Z-ADDK4FCNO    FCNO                            120525
      *
     C                     MOVE F1PMFC    PMFC
     C                     MOVE F1PMFT    PMFT
     C                     MOVE F1PMFN    PMFN
      *
     C                     Z-ADD0         MTDH
     C                     Z-ADD0         MTDL
     C                     Z-ADD0         MTDA
     C                     Z-ADD0         QTDA
     C                     Z-ADD0         YTDA
     C**********           Z-ADD0         ANUM                                         143614 CSD027
     C                     MOVE *BLANKS   ANUM                                                CSD027
      *                                                                   141483
      ** Set joining date                                                 141483
      *                                                                   141483
     C                     MOVE S#JDTE    ZDATE                           141483
     C                     EXSR ZDATE1                                    141483
     C                     MOVE ZDAYNO    JDTE                            141483
      *                                                                   141483
      ** Start Date should be defaulted to the later of prime facility    141483
      ** start date or the participant joining date                       141483
      *                                                                   141483
     C           JDTE      IFGT DTAP                                      141483
     C                     MOVE JDTE      DTAP                            141483
     C                     ENDIF                                          141483
      *                                                                   157004
      ** Closing date should be within the range of the approval date     157004
      ** and the expiry date.                                             157004
      *                                                                   157004
     C           P#MODE    IFEQ 'B'                                       157004
     C                     MOVE F1CDTE    WDATE2                          157004
     C                     MOVELF1CDTE    ZDATE                           157004
     C                     MOVE WDATE2    ZDATE                           157004
     C                     EXSR ZDATE1                                    157004
     C           ZDAYNO    IFNE 0                                         157004
     C                     Z-ADDZDAYNO    CDTE                            157004
     C                     ENDIF                                          157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C           CDTE      IFLT DTAP                                      157004
     C                     Z-ADDDTAP      CDTE                            157004
     C                     ENDIF                                          157004
      *
     C           P#MODE    IFEQ 'B'
     C                     MOVE F1PCOB    PCOB
     C                     ELSE
     C                     MOVE *BLANKS   PCOB
     C                     ENDIF
      *
     C           P#MODE    IFNE 'B'
     C           W#ACTN    ANDEQ'I'
     C                     MOVELA8MQSM    W#1ST3  3
     C***********          MOVELW#1ST3    PCRF      P                     153782
     C********** *NAMVAR   DEFN           LEALLO                                       153782 CLE148
     C********** *LOCK     IN   LEALLO                                                 153782 CLE148
     C********** PCLAST    ADD  1         PCNEXT  80                                   153782 CLE148
     C                     CALL 'LEALLO'                                                      CLE148
     C                     PARM *BLANKS   PRTCD   7                                           CLE148
     C                     PARM 'Y'       PUPDT   1                                           CLE148
     C                     PARM *BLANKS   PCLAST                                              CLE148
     C                     PARM *BLANKS   PCNEXT  8                                           CLE148
      *                                                                                       CLE148
     C                     MOVE PCNEXT    W1ST11 11                       153782
     C                     MOVELW#1ST3    W1ST11                          153782
     C                     MOVELW1ST11    PCRF                            153782
     C                     MOVE '0001'    PCRF                            153782
     C**********           Z-ADDPCNEXT    PCLAST                                       153782 CLE148
     C**********           OUT  LEALLO                                                 153782 CLE148
     C                     ELSE
     C           P#MODE    IFEQ 'B'
     C                     MOVE F1TNRF    PCRF
     C                     ENDIF
     C                     ENDIF
      *
      **   Participant facility Indicator
     C           A8BICN    IFEQ S#CNUM
     C                     MOVE 'I'       PRTR
     C                     ELSE
     C                     MOVE 'P'       PRTR
     C                     ENDIF
      *                                                                   157593
      ** There should be no C/A facility for the funding participant      157593
      ** if the participant is created against a tranche facility.        157593
      *                                                                   157593
     C           TRCA      IFEQ 'TR'                                      157593
     C                     MOVE *BLANKS   TRCA                            157593
     C**********           Z-ADD0         CANM                                         157593 CSD027
     C                     MOVE *BLANKS   CANM                                                CSD027
     C                     Z-ADD0         CAFT                            157593
     C                     Z-ADD0         CAFN                            157593
     C                     ENDIF                                          157593
      *                                                                   120525
     C                     ELSE                                           120525
     C                     MOVEL'LEF0110' ZAMSID                          120525
     C                     EXSR ZASNMS                                    120525
     C                     ENDIF                                          120525
      *
     C                     ENDIF
      *                                                                   157004
     C           P#MODE    IFEQ 'B'                                       157004
     C                     EXSR SRF1FM                                    157004
     C                     ENDIF                                          157004
      *
      ** For an agent primary facility, default the account officer of    161257
      ** the primary facility customer onto internal facilities           161257
      *                                                                   161257
     C           WPRTR     IFEQ 'A'                                       161257
     C           PRTR      ANDEQ'I'                                       161257
      *                                                                   161257
     C                     MOVELF1PMFC    PCNUM                           161257
     C                     CALL 'AOCUSTR0'                                161257
     C                     PARM *BLANKS   PRTCD   7                       161257
     C                     PARM '*KEY   ' POPTN   7                       161257
     C                     PARM           PCNUM  10                       161257
     C                     PARM           PCNST   7                       161257
     C           SDCUST    PARM SDCUST    DSSDY                           161257
     C           PRTCD     IFNE *BLANKS                                   161257
     C           *LOCK     IN   LDA                                       161257
     C                     Z-ADD9         DBASE            ************   161257
     C                     MOVEL'SDCUSTPD'DBFILE           * DBERR 09 *   161257
     C                     MOVELF1PMFC    DBKEY            ************   161257
     C                     MOVEL'LE2021'  DBPGM                           161257
     C                     OUT  LDA                                       161257
     C                     EXSR *PSSR                                     161257
     C                     ELSE                                           161257
     C                     MOVELBBACOC    ACOF                            161257
     C                     ENDIF                                          161257
      *                                                                   161257
     C                     ENDIF                                          161257
      *                                                                   161257
     C                     EXSR ZTNLU1
     C                     Z-ADDNATN      TNLU
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE W#ACTN    CHTP
      *
     C                     MOVELS#INUM    INUM
      *
      ***convert*to Midas date format                                     141483
     C***********          MOVE S#JDTE    ZDATE                           141483
     C***********          EXSR ZDATE1                                    141483
     C***********          MOVE ZDAYNO    JDTE                            141483
      *
      ** convert to Midas date format
     C                     MOVE S#VDTC    ZDATE
     C                     EXSR ZDATE1
     C                     MOVE ZDAYNO    VDTC
      *
     C                     MOVE S#SHTP    SHTP
      *
     C           P#MODE    IFNE 'B'                                       155949
     C           S#SHTP    IFEQ 'A'
     C           13        SUB  A6NBDP    ZADIG
     C                     Z-ADDA6NBDP    ZADEC
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SHAR    ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    FAMT
      *
      *  Calculate percentage
     C                     MOVE W#FAMT    P#PAMT 13
     C                     MOVE *BLANKS   P#SHPC 15
     C                     MOVE ZFIELD    P#FAMT 13
     C                     MOVE S#SHTP    P#SHTP  1
     C                     CALL 'LE2024'
     C                     PARM           P#PAMT
     C                     PARM           P#SHPC
     C                     PARM           P#FAMT
     C                     PARM           P#SHTP
      *
     C                     MOVE P#SHPC    SHPC
      *
     C                     ELSE
      *
     C                     Z-ADD3         ZADIG
     C                     Z-ADD12        ZADEC
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SHAR    ZFIELD
     C                     MOVE *OFF      *IN99
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SHPC
      *
      **  Calculate Amount
     C                     MOVE W#FAMT    P#PAMT 13
     C                     MOVE ZFIELD    P#SHPC 15
     C                     MOVE *BLANKS   P#FAMT 13
     C                     MOVE S#SHTP    P#SHTP  1
     C                     CALL 'LE2024'
     C                     PARM           P#PAMT
     C                     PARM           P#SHPC
     C                     PARM           P#FAMT
     C                     PARM           P#SHTP
      *
     C                     MOVE P#FAMT    FAMT
      *
     C                     ENDIF
     C                     ELSE                                           155949
      *                                                                   155949
      * Amount calculated by PC                                           155949
      *                                                                   155949
     C                     MOVE *BLANKS   S#SHAR                          155949
     C                     MOVE F1FAMT    S#SHAR                          155949
     C           13        SUB  A6NBDP    ZADIG                           155949
     C                     Z-ADDA6NBDP    ZADEC                           155949
     C                     MOVE *BLANK    ZFIELD                          155949
     C                     MOVE S#SHAR    ZFIELD                          155949
     C                     EXSR ZALIGN                                    155949
     C                     MOVE ZFIELD    FAMT                            155949
      *                                                                   155949
      * Percentage calculated by PC                                       155949
      *                                                                   155949
     C                     MOVE *BLANKS   S#SHAR                          155949
     C                     MOVE F1SHPC    S#SHAR                          155949
     C                     Z-ADD3         ZADIG                           155949
     C                     Z-ADD12        ZADEC                           155949
     C                     MOVE *BLANK    ZFIELD                          155949
     C                     MOVE S#SHAR    ZFIELD                          155949
     C                     MOVE *OFF      *IN99                           155949
     C                     EXSR ZALIGN                                    155949
     C                     MOVE ZFIELD    SHPC                            155949
      *                                                                   155949
     C                     MOVE F1SHTP    SHTP                            155949
     C                     ENDIF                                          155949
      *
     C                     MOVE S#RCSI    RCSI
      *                                                                   147261
     C                     MOVE S#PASI    PASI                            147261
      *
     C                     Z-ADD4         ZADIG
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SKIR    ZFIELD
     C                     Z-ADD7         ZADEC
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SKIR
     C           SKIR      IFEQ 0
     C                     MOVE *BLANKS   SKIS
     C                     ELSE
     C                     MOVE S#SKIS    SKIS
     C                     ENDIF
      *
     C                     Z-ADD4         ZADIG
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE S#SKFR    ZFIELD
     C                     Z-ADD7         ZADEC
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SKFR
     C           SKFR      IFEQ 0
     C                     MOVE *BLANKS   SKFS
     C                     ELSE
     C                     MOVE S#SKFS    SKFS
     C                     ENDIF
      *                                                                   122615
     C                     MOVE 'A'       FSTS                            122615
      *
     C           P#MODE    IFEQ 'B'                                       154560
     C                     MOVE F1IUSR    IUSR                            154560
     C                     MOVE F1XUSR    XUSR                            154560
     C                     MOVE F1AUSR    AUSR                            154560
     C                     ELSE                                           154560
      *                                                                   154560
     C           W#ACTN    IFEQ 'A'                                       154560
     C                     MOVE USER      AUSR                            154560
     C                     ELSE                                           154560
     C                     MOVE USER      IUSR                            154560
     C                     MOVE USER      XUSR                            154560
     C                     ENDIF                                          154560
      *                                                                   154560
     C                     ENDIF                                          154560
      *                                                                   153666
      ** Name & Address Code                                              153666
     C                     MOVE S#NACD    NACD                            153666
      *                                                                   153666
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE WCOAG     COAG                                                CLE031
     C                     MOVE WFCAG     FCAG                                                CLE031
     C                     MOVE WPHAG     PHAG                                                CLE031
     C                     MOVE WSCAG     SCAG                                                CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
      ** Settlement details
     C           W#CF14    IFEQ 'Y'
     C           P#MODE    OREQ 'B'
     C           P#MODE    OREQ 'P'
     C                     EXSR PRSETT
     C                     MOVE 'N'       W#CF14
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * PRSETT   : Load settlemnt details into file                   *
      * Called by: LOADFM                                             *
      * Calls    : None.                                              *
      *****************************************************************
     C           PRSETT    BEGSR
      *
     C                     MOVE PMROBR    OSDB
     C                     MOVE PMPOBR    OMDB
     C                     MOVE PMPSTM    PSTM
     C                     MOVE PMRSTM    RSTM
     C                     MOVE PMPONS    PONS
     C                     MOVE PMRONS    RONS
      *
     C                     MOVELPMRIBA    RIBA
     C                     MOVELPAAWBN    AWBN
     C                     MOVELPARIBN    RIBN
     C                     MOVELPABENN    BENN
     C                     MOVELPMBTB1    BTB1
     C                     MOVELPMBTB2    BTB2
     C                     MOVELPMBTB3    BTB3
     C                     MOVELPMBTB4    BTB4
     C                     MOVELPMBTB5    BTB5
     C                     MOVELPMBTB6    BTB6
     C                     MOVE PMCVMR    CVMR
     C                     MOVE PAROBN    ROBN
     C                     MOVE PAROCN    ROCN
     C                     MOVE PAPOBN    POBN
     C                     MOVE PAPOCN    POCN
     C                     MOVE PAPIBN    PIBN
     C                     MOVE PMPIBA    PIBA
     C                     MOVE PARCRN    RCRN
     C                     MOVE PMRCRA    RCRA
     C                     MOVE PARVNO    RVNO
     C                     MOVE PMAWBA    AWBA
     C                     MOVE PMBENA    BENA
     C                     MOVE PMDTP1    DTP1
     C                     MOVE PMDTP2    DTP2
     C                     MOVE PMDTP3    DTP3
     C                     MOVE PMDTP4    DTP4
     C                     MOVE PMDCHG    DCHG
      *                                                                   CEU004
      ** If CEU004 is on Move Settlement Currency and 'In' Currency       CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           CLE031    OREQ 'Y'                                                           CLE031
     C           P#MODE    IFEQ 'P'                                       CEU004
     C                     MOVE PMSCCY    SCCY                            CEU004
     C                     MOVE PMICCY    ICCY                            CEU004
     C                     ELSE                                           CEU004
     C                     MOVE PMPSCY    SCCY                            CEU004
     C                     MOVE PMIC72    ICCY                            CEU004
     C                     ENDIF                                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
      *                                                                                       CLE031
     C                     MOVE PMRSCY    SCCY                                                CLE031
     C           PMREXR    IFEQ *ZERO                                                         CLE031
     C                     Z-ADD0         REXR                                                CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD 16                                           CLE031
     C                     MOVE PMREXR    ZFIELD                                              CLE031
     C                     MOVE *BLANKS   ZAFLD  16                                           CLE031
     C                     Z-ADD5         ZADIG                                               CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZALIGN                                                        CLE031
     C                     MOVE ZFIELD    WZREX0 130                                          CLE031
     C           WZREX0    DIV  100000000 WZREX8 138                                          CLE031
     C                     Z-ADDWZREX8    REXR                                                CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     MOVE PMREXI    REXI                                                CLE031
     C                     MOVE PMPSCY    PSCY                                                CLE031
      *                                                                                       CLE031
     C           PMPEXR    IFEQ *ZERO                                                         CLE031
     C                     Z-ADD0         PEXR                                                CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD 16                                           CLE031
     C                     MOVE PMPEXR    ZFIELD                                              CLE031
     C                     MOVE *BLANKS   ZAFLD  16                                           CLE031
     C                     Z-ADD5         ZADIG                                               CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZALIGN                                                        CLE031
     C                     MOVE ZFIELD    WZPEX0 130                                          CLE031
     C           WZPEX0    DIV  100000000 WZPEX8 138                                          CLE031
     C                     Z-ADDWZPEX8    PEXR                                                CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     MOVE PMPEXI    PEXI                                                CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * AMENDS   : Process Amednd Screen                              *
      * Called by: PROSEL                                             *
      * Calls    : POPSCR, CF03, CF05, CF12, CF14, VLDDET             *
      *****************************************************************
     C           AMENDS    BEGSR
      *
      **  Move File fields to screen
     C                     EXSR POPSCR
      *
     C                     MOVE *OFF      *IN55            Dont Protrct
     C                     MOVE *OFF      *IN56            Disable F10
     C                     MOVE *OFF      *IN12
     C                     MOVE 'UPD'     W#F5MD  3
      *  Valid settlement details
     C                     MOVE 'Y'       W#VSET
      *
      **  Display screen until F03 or F12 pressed
     C           *IN03     DOWEQ*OFF
     C           *IN12     ANDEQ*OFF
      *
     C                     WRITELE2021F1                   Function Keys
     C                     WRITE#MSGCTL                    Messages
     C                     EXFMTLE2021F3                   Screen
      *
      **  Clear Message subfile
     C                     EXSR CLEARM
      *
      *
      **  F3  - Exit
     C           *IN03     CASEQ'1'       CF03
      *                                   ****
      **  F5  - Refresh
     C           *IN05     CASEQ'1'       CF05
      *                                   ****
      **  F12 - Previous
     C           *IN12     CASEQ'1'       CF12
      *                                   ****
      **  F14 - Settlements
     C           *IN14     CASEQ'1'       CF14
      *                                   ****
      **  Enter Key Processing
     C                     CAS            VLDDET
      *                                   ******
     C                     ENDCS
      *
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SR2410   : Validate settlement details (Batch or Play)        *
      * Called by: VLDDET                                             *
      * Calls    : FEXSET                                             *
      *****************************************************************
     C           SR2410    BEGSR
      *
      ** Set up fields on call to SD2410 for settlement validation
      ** Process settlement branch only if method 05 and multibranching
      *
     C                     EXSR FEXSET
     C                     MOVE 'Y'       W#VSET
      *
     C                     CALL 'SD2410'
     C                     PARM           SETLIB
     C                     PARM           SETLIZ
     C                     PARM           @PARM3                          222373
      *
      ** Terminate program if database error returned
      *
     C           PMDBSE    IFNE *ZERO
     C           *LOCK     IN   LDA
     C                     MOVELPMDBFL    DBFILE
     C                     Z-ADDPMDBSE    DBASE
     C                     MOVELPMDBKY    DBKEY
     C                     MOVELPMDPGM    DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Settlement detail in error
     C           PMERCD    IFNE *BLANKS
     C***********          MOVEL'LEP0029' ZAMSID                          123801
     C           3         SUBSTPMERCD:1  WSERR   3                       123801
     C                     MOVEL'ESM0'    ZAMSID                          123801
     C                     MOVE WSERR     ZAMSID                          123801
     C                     MOVEL'DRSMM   'ZAMSGF                          123801
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRWNDW   : Window processing subroutine                       *
      * Called by: ENQRYS, VLDDET                                     *
      * Calls    : None                                               *
      *****************************************************************
     C           SRWNDW    BEGSR
      *
     C/COPY WNCPYSRC,LE2021MOV1
      *
      **  Call window manager WN0010
     C                     CALL 'WN0010'
     C                     PARM 'LE2021'  #PGM   10
     C                     PARM           KEY     2
     C                     PARM W#ACTN    ACTION  1
     C                     PARM           DATA
     C                     PARM *BLANK    #RTRN   7
     C******               PARM           SPARF 256                       119892
     C                     PARM           SPARE 256                       119892
      *
      ** Process return code
     C           #RTRN     IFNE *BLANK
     C                     MOVEL#RTRN     ZAMSID
     C***********          MOVEL'WNMSGF'  ZAMSGF                          122052
     C                     MOVEL'WNMSGF  'ZAMSGF                          122052
     C                     EXSR ZASNMS
     C                     MOVEL'LERMSGF' ZAMSGF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * INITPR   : Initial Processing                                 *
      * Called by: Main routine                                       *
      * Calls    : None.                                              *
      *****************************************************************
     C           INITPR    BEGSR
      *
      **   Define the LDA for error handling
     C           *NAMVAR   DEFN           LDA
     C           *NAMVAR   DEFN           JNSTAT                          154591
      *
      **   Subfile indicators
     C                     MOVE *ON       *IN25
     C                     Z-ADD1         ##SFRC           SFLRCDNBR
      *
      **   SETLIAZ Parameters
     C                     MOVE 'Y'       PMRETP
     C                     MOVE 'Y'       PMRETS
      *
      ** Access Bank Detailes
      *  ~~~~~~~~~~~~~~~~~~~~
     C                     CALL 'AOBANKR0'
     C                     PARM '       ' @RTCD   7        B:Return Code
     C                     PARM '*FIRST ' @OPTN   7        I:Option
     C           SDBANK    PARM SDBANK    DSFDY            O:Format
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE
     C                     Z-ADD1         DBASE
     C                     MOVEL@OPTN     DBKEY
     C                     MOVEL'LE2021'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      ***  Check System Date Format, DDMMYY (*IN98 off)
      ***                            MMDDYY (*IN98 on).
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     END
      *
     C                     MOVE BJMRDT    S#RUNA           Midas run date
      *
      ** Access the Facility in LEFCLTL0 (Prime facility)
      *  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     C                     MOVE F1PMFC    K#CNUM
     C                     MOVE F1PMFT    K#FACT
     C                     MOVE F1PMFN    K#FCNO
     C***********K#LTL0    CHAINLEFCLTL0             70                   122105
     C           K#LTL0    CHAINFCLTYFMF            N70                   122105
      *
     C           *IN70     IFEQ *ON
     C           FSTS      ORNE 'C'                                       122105
     C           FSTS      ANDNE'A'                                       122105
     C           FSTS      ANDNE'R'                                       122105
     C********** P#MODE    ORNE 'B'                                122105 178424
     C********** RECI      ANDNE'D'                                122105 178424
     C           P#MODE    OREQ 'B'                                       122105
     C           F1TRSN    ANDEQ'0001'                                    122105
     C           RECI      ANDNE'D'                                       122105
     C           *LOCK     IN   LDA
     C***********          MOVEL'LEFCLTL0'DBFILE                          122105
     C                     MOVEL'FCLTYFM 'DBFILE                          122105
     C                     Z-ADD2         DBASE
     C                     MOVE K#CNUM    DBKEY
     C                     MOVEL'LE2021'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
      *
     C                     ELSE
      *  Save prime facility amount
     C           *LIKE     DEFN FAMT      W#FAMT
     C                     Z-ADDFAMT      W#FAMT           Prim facility
      *
     C           *LIKE     DEFN BRCA      K#BRCA
     C           *LIKE     DEFN PMFC      K#PMFC
     C           *LIKE     DEFN PMFT      K#PMFT
     C           *LIKE     DEFN PMFN      K#PMFN
      *
      ** Set up LEFCLTL2 Key (K#LTL2)
     C                     MOVE BRCA      K#BRCA           Branch
     C                     MOVE F1PMFC    K#PMFC           Facility Type
     C                     MOVE F1PMFT    K#PMFT
     C                     MOVE F1PMFN    K#PMFN
     C                     MOVELACOF      WACOF   2                       161257
     C                     MOVELPRTR      WPRTR   1                       161257
      *
     C                     ENDIF
      *                                                                   CLE005
      **  Access Switchable SAR details for the existence of CLE005       CLE005
      **  (Tranche 3)                                                     CLE005
     C                     CALL 'AOSARDR0'                                CLE005
     C                     PARM *BLANK    @RTCD                           CLE005
     C                     PARM '*VERIFY' @OPTN                           CLE005
     C                     PARM 'CLE005'  @SARD   6                       CLE005
      *                                                                   CLE005
     C           @RTCD     IFEQ *BLANK                                    CLE005
     C                     MOVE 'Y'       CLE005  1                       CLE005
     C                     ELSE                                           CLE005
     C                     MOVE 'N'       CLE005                          CLE005
     C                     ENDIF                                          CLE005
      *                                                                   CLE005
     C                     CALL 'AOSARDR0'                                157004
     C                     PARM *BLANK    WRTCD   7                       157004
     C                     PARM '*VERIFY' WOPTN   7                       157004
     C                     PARM 'CLE006'  WSARD   6                       157004
      *                                                                   157004
     C           WRTCD     IFEQ *BLANK                                    157004
     C                     MOVE 'Y'       CLE006  1                       157004
     C                     ELSE                                           157004
     C                     MOVE 'N'       CLE006                          157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     CALL 'AOSARDR0'                                157004
     C                     PARM *BLANK    WRTCD                           157004
     C                     PARM '*VERIFY' WOPTN                           157004
     C                     PARM 'CLE008'  WSARD                           157004
      *                                                                   157004
     C           WRTCD     IFEQ *BLANK                                    157004
     C                     MOVE 'Y'       CLE008  1                       157004
     C                     ELSE                                           157004
     C                     MOVE 'N'       CLE008                          157004
     C                     ENDIF                                          157004
     C/COPY WNCPYSRC,LE2021C003
      *                                                                   157004
     C                     MOVE *BLANKS   P#PAMT                          148851
      *                                                                   148851
      ** Defaults funding participants on a tranche from the funding      148851
      ** participant details of a credit agreement                        148851
      *                                                                   148851
     C           CLE005    IFEQ 'Y'                                       CLE005
     C           P#MODE    ANDNE'B'                                       CLE005
     C           F1ACTN    ANDEQ'A'                                       CLE005
     C           F1TRCA    IFEQ 'TR'                                      CLE005
     C           F1SYIN    ANDEQ'Y'                                       CLE005
     C                     MOVELF1BRCA    K#BRCA                          CLE005
     C                     MOVELF1CNUM    K#PMFC                          CLE005
     C                     MOVELF1FACT    K#PMFT                          CLE005
     C                     MOVELF1FCNO    K#PMFN                          CLE005
     C                     MOVE FCCY      WCCY    3                       154591
     C           K#LTL2    SETLLLEFCLTL2                                  CLE005
     C           K#LTL2    READELEFCLTL2                 70               CLE005
     C                     ENDIF                                          CLE005
      *                                                                   CLE005
      ** Default members                                                  CLE005
      *                                                                   CLE005
     C           *IN70     IFEQ '1'                                       CLE005
      *                                                                   154591
     C                     IN   JNSTAT                                    154591
      *                                                                   154591
     C                     MOVELF1CANM    K#CNUM                          CLE005
     C                     MOVELF1CAFT    K#FACT                          CLE005
     C                     MOVELF1CAFN    K#FCNO                          CLE005
     C           K#LTL0    SETLLLEFCLTL0                                  CLE005
     C           K#LTL0    READELEFCLTL0                 70               CLE005
     C                     MOVE BRCA      K#BRCA                          CLE005
     C                     MOVE CNUM      K#PMFC                          CLE005
     C                     MOVE FACT      K#PMFT                          CLE005
     C                     MOVE FCNO      K#PMFN                          CLE005
      *                                                                   CLE005
      **   Facility sequence number                                       CLE005
      *                                                                   CLE005
     C           K#LTL2    SETLLLEFCLTL2                                  CLE005
     C           K#LTL2    READELEFCLTL2                 70               CLE005
     C                     MOVE 'N'       W#EXIT  1                       CLE005
     C                     MOVE 'N'       W#ERR5  1                       CLE005
     C                     MOVE CNUM      K#CNUM                          CLE005
     C                     MOVE FACT      K#FACT                          CLE005
     C                     Z-ADD1         K#FCNO                          CLE005
      *                                                                   CLE005
     C           *IN70     DOWEQ'0'                                       CLE005
      *                                                                   161257
      ** For an agent primary facility, default the account officer of    161257
      ** the primary facility customer onto internal facilities and agent 161257
      ** account officer onto funding facilities.                         161257
      *                                                                   161257
     C           WPRTR     IFEQ 'A'                                       161257
     C           PRTR      IFEQ 'P'                                       161257
     C                     MOVELWACOF     ACOF                            161257
     C                     ELSE                                           161257
     C                     MOVE F1PMFC    PCNUM                           161257
     C                     CALL 'AOCUSTR0'                                161257
     C                     PARM *BLANKS   PRTCD                           161257
     C                     PARM '*KEY   ' POPTN                           161257
     C                     PARM           PCNUM                           161257
     C                     PARM           PCNST                           161257
     C           SDCUST    PARM SDCUST    DSSDY                           161257
     C           PRTCD     IFNE *BLANKS                                   161257
     C           *LOCK     IN   LDA                                       161257
     C                     Z-ADD11        DBASE            ************   161257
     C                     MOVEL'SDCUSTPD'DBFILE           * DBERR 11 *   161257
     C                     MOVELF1PMFC    DBKEY            ************   161257
     C                     MOVEL'LE2021'  DBPGM                           161257
     C                     OUT  LDA                                       161257
     C                     EXSR *PSSR                                     161257
     C                     ELSE                                           161257
     C                     MOVELBBACOC    ACOF                            161257
     C                     ENDIF                                          161257
     C                     ENDIF                                          161257
     C                     ENDIF                                          161257
      *                                                                   161257
      ** If branch of Credit agreement is different with tranche,         162883
      ** default it to branch of tranche facility.  Also, if              162883
      ** participant is internal, default the internal customer           162883
      ** reference to the BICN of the tranche facility branch.            162883
      *                                                                   162883
     C           F1BRCA    IFNE BRCA                                      162883
     C                     MOVE F1BRCA    BRCA                            162883
      *                                                                   162883
     C           PRTR      IFEQ 'I'                                       162883
     C                     CALL 'AOBRCHR1'                                162883
     C                     PARM '       ' @RTCD                           162883
     C                     PARM '*KEY   ' @OPTN                           162883
     C                     PARM BRCA      @BRCA   3                       162883
     C           SDBRCH    PARM SDBRCH    DSSDY                           162883
      *                                                                   162883
     C           @RTCD     IFNE *BLANK                                    162883
     C           *LOCK     IN   LDA                                       162883
     C                     Z-ADD12        DBASE            ************   162883
     C                     MOVEL'SDBRCHPD'DBFILE           * DBERR 12 *   162883
     C                     MOVELBRCA      DBKEY            ************   162883
     C                     MOVEL'LE2021'  DBPGM                           162883
     C                     OUT  LDA                                       162883
     C                     EXSR *PSSR                                     162883
     C                     ENDIF                                          162883
      *                                                                   162883
     C                     MOVE A8BICN    CNUM                            162883
     C                     MOVE CNUM      K#CNUM                          162883
     C                     ENDIF                                          162883
      *                                                                   162883
     C                     ENDIF                                          162883
      *                                                                   162883
     C           K#LTL0    SETLLFCLTY                    71               CLE005
      *                                                                   CLE005
     C                     MOVE BRCA      W#BRCA                          154591
     C                     MOVE CNUM      W#PMFC                          154591
     C                     MOVE FACT      W#PMFT                          154591
     C                     Z-ADDFCNO      W#PMFN                          154591
     C           W#EXIT    DOWNE'Y'                                       CLE005
     C           *IN71     IFEQ '0'                                       CLE005
     C                     MOVE 'Y'       W#EXIT                          CLE005
     C                     ELSE                                           CLE005
     C           K#FCNO    IFNE 99                                        CLE005
     C                     ADD  1         K#FCNO                          CLE005
     C           K#LTL0    SETLLFCLTY                    71               CLE005
     C                     ELSE                                           CLE005
     C                     MOVE 'Y'       W#EXIT                          CLE005
     C                     MOVE 'Y'       W#ERR5                          CLE005
     C                     ENDIF                                          CLE005
     C                     ENDIF                                          CLE005
      *                                                                   CLE005
     C                     ENDDO                                          CLE005
      *                                                                   CLE005
     C                     MOVE '0'       *IN71                           CLE005
     C           W#ERR5    IFEQ 'N'                                       CLE005
      *                                                                   CLE005
      **  Write record type 'A'                                           CLE005
      *                                                                   CLE005
     C                     Z-ADDK#FCNO    FCNO                            CLE005
     C**********           Z-ADDF1CNUM    PMFC                                         CLE005 CSD027
     C                     MOVE F1CNUM    PMFC                                                CSD027
     C                     Z-ADDF1FACT    PMFT                            CLE005
     C                     Z-ADDF1FCNO    PMFN                            CLE005
     C                     MOVE *BLANKS   TRCA                            148851
     C                     Z-ADDBJRDNB    ORED                            148851
     C                     MOVE F1FCCY    FCCY                                                203191
     C                     MOVE F1FAMT    P#PAMT                          148851
     C                     MOVE SHPC      P#SHPC                          148851
     C                     MOVE *BLANKS   P#FAMT                          148851
     C                     MOVE 'P'       P#SHTP                          148851
      *                                                                   148851
     C                     CALL 'LE2024'                                  148851
     C                     PARM           P#PAMT                          148851
     C                     PARM           P#SHPC                          148851
     C                     PARM           P#FAMT                          148851
     C                     PARM           P#SHTP                          148851
     C                     MOVE P#FAMT    FAMT                            148851
      *                                                                   148851
     C                     MOVEASTAMP,1   STMP             Default Timestamp                  CPK015
     C                     WRITEFCLTYFMF                                  CLE005
     C/COPY WNCPYSRC,LE2021C002
      *                                                                   CLE005
      **  Write record type 'B'                                           CLE005
      *                                                                   CLE005
     C           K#FCT2    CHAINFCLTYL2              20                   154591
     C                     EXSR SRRUND                                    154591
     C                     EXSR ZTNLU1                                    154591
     C                     Z-ADDK#FCNO    FCNO                            154591
     C                     MOVE 'B'       RCTP                            CLE005
     C                     Z-ADDNATN      TNLU                            CLE005
     C                     Z-ADDBJRDNB    LCD                             CLE005
     C                     Z-ADDBJRDNB    ORED                            154591
     C                     MOVE F1ACTN    CHTP                            CLE005
      *                                                                   CLE005
     C                     Z-ADD0         TOTD                            CLE005
     C                     Z-ADD0         CAMD                            CLE005
     C                     Z-ADD0         CEXP                                                CLE023
     C                     Z-ADD0         PEXP                            CLE005
     C                     Z-ADD0         OAM1                            CLE005
     C                     Z-ADD0         OAM2                            CLE005
     C                     Z-ADD0         OAM3                            CLE005
     C                     Z-ADD0         OAM4                            CLE005
     C                     Z-ADD0         OAM5                            CLE005
     C                     Z-ADD0         OAM6                            CLE005
     C                     Z-ADD0         OAM7                            CLE005
     C                     Z-ADD0         OAM8                            CLE005
     C                     Z-ADD0         OAM9                            CLE005
     C                     Z-ADD0         OA10                            CLE005
      *                                                                   CLE005
     C                     MOVEASTAMP,1   STMP             Default Timestamp                  CPK015
     C                     WRITEFCLTYFNF                                  CLE005
     C                     MOVE 'I'       W#ACTN                          CLE005
     C                     EXSR UPDTRL                                    CLE005
     C                     COMIT                                          CLE005
     C                     MOVE 'A'       W#ACTN                          CLE005
     C                     ENDIF                                          CLE005
     C           K#LTL2    READELEFCLTL2                 70               CLE005
     C                     MOVE CNUM      K#CNUM                          CLE005
     C                     MOVE FACT      K#FACT                          CLE005
     C                     Z-ADD1         K#FCNO                          CLE005
     C                     MOVE 'N'       W#EXIT  1                       CLE005
     C                     MOVE 'N'       W#ERR5  1                       CLE005
      *                                                                   CLE005
     C                     ENDDO                                          CLE005
      *                                                                   CLE005
     C                     ENDIF                                          CLE005
     C                     ENDIF                                          CLE005
     C                     MOVE F1BRCA    K#BRCA                          148851
     C                     MOVE F1PMFC    K#PMFC                          148851
     C                     MOVE F1PMFT    K#PMFT                          148851
     C                     MOVE F1PMFN    K#PMFN                          148851
     C**********           Z-ADDF1ANUM    ANUM                                         148851 CSD027
     C                     MOVE F1ANUM    ANUM                                                CSD027
     C                     MOVE F1BRCA    BRCA                            162883
      *                                                                   CEU004
      **  Access Switchable SAR details for the existence of CEU004       CEU004
      *                                                                   CEU004
     C                     CALL 'AOSARDR0'                                CEU004
     C                     PARM *BLANK    @RTCD                           CEU004
     C                     PARM '*VERIFY' @OPTN                           CEU004
     C                     PARM 'CEU004'  @SARD                           CEU004
     C           @RTCD     IFEQ *BLANKS                                   CEU004
     C                     MOVE 'Y'       CEU004  1                       CEU004
     C                     ELSE                                           CEU004
     C                     MOVE 'N'       CEU004                          CEU004
     C           @RTCD     IFNE '*NRF    '                                CEU004
     C           *LOCK     IN   LDA                                       CEU004
     C                     MOVEL'SCSARDPD'DBFILE           ************   CEU004
     C                     Z-ADD42        DBASE            * DBERR 42 *   CEU004
     C                     MOVEL'CEU004'  DBKEY            ************   CEU004
     C                     OUT  LDA                                       CEU004
     C                     EXSR *PSSR                                     CEU004
     C                     ENDIF                                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
      ** Check if Flat Rate Personal Loans (Rule of 78s) is installed                         CLE028
      *                                                                                       CLE028
     C                     CALL 'AOSARDR0'                                                    CLE028
     C                     PARM '       ' @RTCD                                               CLE028
     C                     PARM '*VERIFY' @OPTN                                               CLE028
     C                     PARM 'CLE028'  @SARD                                               CLE028
      *                                                                                       CLE028
      ** Handle Database Error                                                                CLE028
      *                                                                                       CLE028
     C           @RTCD     IFNE *BLANKS                                                       CLE028
     C           @RTCD     ANDNE'*NRF   '                                                     CLE028
     C           *LOCK     IN   LDA                                                           CLE028
     C                     MOVEL'SCSARDPD'DBFILE                                              CLE028
     C                     Z-ADD43        DBASE                                               CLE028
     C                     MOVEL'CLE028'  DBKEY                                               CLE028
     C                     MOVEL'LE2021'  DBPGM                                               CLE028
     C                     OUT  LDA                                                           CLE028
     C                     EXSR *PSSR                                                         CLE028
     C                     ENDIF                                                              CLE028
      *                                                                                       CLE028
      ** CLE028 is installed                                                                  CLE028
      *                                                                                       CLE028
     C           @RTCD     IFEQ *BLANKS                                                       CLE028
     C                     MOVE 'Y'       CLE028  1                                           CLE028
     C                     ELSE                                                               CLE028
     C                     MOVE 'N'       CLE028                                              CLE028
     C                     ENDIF                                                              CLE028
      *
      **  Access Switchable SAR details for the existence of CLE031                           CLE031
      *                                                                                       CLE031
     C                     MOVE 'Y'       CLE031  1                                           CLE031
     C                     MOVE *OFF      *IN66                                               CLE031
     C                     CALL 'AOSARDR0'                                                    CLE031
     C                     PARM *BLANK    @RTCD                                               CLE031
     C                     PARM '*VERIFY' @OPTN                                               CLE031
     C                     PARM 'CLE031'  @SARD                                               CLE031
     C           @RTCD     IFEQ *BLANKS                                                       CLE031
     C                     MOVE 'Y'       CLE031                                              CLE031
     C                     MOVE *ON       *IN66                                               CLE031
     C                     ELSE                                                               CLE031
     C           @RTCD     IFNE '*NRF    '                                                    CLE031
     C           *LOCK     IN   LDA                                                           CLE031
     C                     MOVEL'SCSARDPD'DBFILE                                              CLE031
     C                     Z-ADD43        DBASE                                               CLE031
     C                     MOVEL'CLE031'  DBKEY                                               CLE031
     C                     OUT  LDA                                                           CLE031
     C                     EXSR *PSSR                                                         CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
      ** Access the branch codes Record
      *  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     C***********          CALL 'AOBRCHR0'                                121783
     C                     CALL 'AOBRCHR1'                                121783
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM BRCA      @BRCA   3
     C***********SDBRCH    PARM SDBRCH    DSFDY                           121783
     C           SDBRCH    PARM SDBRCH    DSSDY                           121783
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     Z-ADD3         DBASE
     C                     MOVELBRCA      DBKEY
     C                     MOVEL'LE2021'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Access the currency details, using AOCURRR0 for the currency
      ** defined on the Facility record to pick up the currency decimal
      ** places.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM FCCY      @CCY    3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCURRPD'DBFILE
     C                     Z-ADD4         DBASE
     C                     MOVELFCCY      DBKEY
     C                     MOVEL'LE2021'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Access the Customer Details file
      *
     C                     MOVE F1PMFC    @CNUM
     C                     CALL 'AOCUSTR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @CNUM  10
     C                     PARM           @CNST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD5         DBASE
     C                     MOVEL'SDCUSTPD'DBFILE
     C                     MOVELF1PMFC    DBKEY
     C                     MOVEL'LE2021'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE                                           140835
     C                     MOVELBBCRNM    S#PRNM           Report Name    140835
     C                     MOVELBBCRTN    S#PRTN           Report Town    140835
     C                     ENDIF
      *
      **  Populate screen header
     C                     MOVE ANUM      S#ANUM           Agent Name
     C                     MOVE BRCA      S#BRCA           Branch
     C                     MOVE FCCY      S#FCCY           Currency
     C                     MOVE F1PMFC    S#PMFC           Facility Custom
     C                     MOVE F1PMFT    S#PMFT           Facility No
     C                     MOVE F1PMFN    S#PMFN           Facility No
     C                     MOVE *BLANK    ZFIELD
     C                     MOVE W#FAMT    ZFIELD
     C                     Z-ADDA6NBDP    ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    S#FAMT
      *
      ** Open Display file LE2021DF
      *  ~~~~~~~~~~~~~~~~~~~~~~~~~~
     C           P#MODE    IFEQ 'I'
     C           P#MODE    OREQ 'R'
     C           P#MODE    OREQ 'E'
     C                     OPEN LE2021DF
     C                     ENDIF
      *
      ** Open the Facilities Play/Record file LE2021PD
      *  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     C           P#MODE    IFEQ 'R'
     C           P#MODE    OREQ 'P'
     C                     OPEN LE2021PD
     C                     ENDIF
      *
      ** Access the Customer Details file                                 140835
      *                                                                   140835
     C           P#MODE    IFNE 'B'                                       148191
     C                     MOVE *BLANKS   @CNUM                           140835
     C                     MOVE ANUM      @CNUM                           140835
     C                     CALL 'AOCUSTR0'                                140835
     C                     PARM '       ' @RTCD                           140835
     C                     PARM '*KEY   ' @OPTN                           140835
     C                     PARM           @CNUM                           140835
     C                     PARM           @CNST                           140835
     C           SDCUST    PARM SDCUST    DSSDY                           140835
      *                                                                   140835
     C           @RTCD     IFNE *BLANKS                                   140835
     C           *LOCK     IN   LDA                                       140835
     C                     Z-ADD8         DBASE                           140835
     C                     MOVEL'SDCUSTPD'DBFILE                          140835
     C                     MOVELANUM      DBKEY                           140835
     C                     MOVEL'LE2021'  DBPGM                           140835
     C                     OUT  LDA                                       140835
     C                     EXSR *PSSR                                     140835
     C                     ELSE                                           140835
     C                     MOVELBBCRNM    S#CRNM           Report Name
     C                     ENDIF                                          140835
     C                     ENDIF                                          148191
      *
     C                     MOVEL'LERMSGF 'ZAMSGF
     C                     MOVE USER      S#USER
     C                     MOVE WSID      S#WSID
     C                     MOVE BJMRDT    S#RUNA
      *
     C           P#MODE    IFEQ 'E'
     C                     MOVE *ON       *IN61
     C                     ENDIF
      *                                                                   148847
     C                     MOVE 'N'       WENTR   1                       148847
      *
     C                     ENDSR
      /EJECT                                                              154591
      *****************************************************************   154591
      *  SRRUND - Subroutine that computes the 10 working days        *   154591
      *  Called by: INITPR                                            *   154591
      *  Calls    : ZFWDT                                             *   154591
      *****************************************************************   154591
     C           SRRUND    BEGSR                                          154591
      *                                                                   154591
      **  Determine 'DRAWN AMOUNT' days and read data area JNSTAT         154591
      **  for previous run date                                           154591
      *                                                                   154591
     C                     Z-ADDPRUN      ZDAYNO                          154591
     C                     MOVE WCCY      ZCCY                            154591
     C                     MOVE *BLANKS   ZLOC                            154591
      *                                                                   154591
     C***********          Z-ADD1         ZNRDYS                   154591 148722
     C***********          EXSR ZFWDT                              154591 148722
     C***********          Z-ADDZDYNBR    ZDAYNO                   154591 148722
     C***********          Z-ADDZDYNBR    RUN0                     154591 148722
     C                     Z-ADDPRUN      RUN0                            148722
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN1                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN2                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN3                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN4                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN5                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN6                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN7                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN8                            154591
      *                                                                   154591
     C                     Z-ADD1         ZNRDYS                          154591
     C                     EXSR ZFWDT                                     154591
     C                     Z-ADDZDYNBR    ZDAYNO                          154591
     C                     Z-ADDZDYNBR    RUN9                            154591
      *                                                                   154591
     C                     ENDSR                                          154591
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR                           ** *PSSR SR **
      *
     C           @RUN      IFEQ *BLANK
      *
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C                     MOVE *ON       *INU7
     C                     MOVE *ON       *INU8
     C                     MOVE *ON       *INLR
     C                     MOVE 'D'       F2MSGS
      *
     C           P#MODE    IFNE 'P'
     C           P#MODE    ANDNE'B'
     C                     CALL 'DBERRCTL'
     C                     ENDIF
      *
     C                     RETRN
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      /EJECT
      *****************************************************************
      *  ZASNMS - Sends messages to the program's message queue       *
      *  Called by: Almost all screens with validation                *
      *  Calls    : None                                              *
      *****************************************************************
     C           ZASNMS    BEGSR
      *
     C           P#MODE    IFEQ 'B'
     C           P#MODE    OREQ 'P'
     C                     EXSR SRBERR
      *
     C                     ELSE
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message Id.
     C                     PARM           ZAMSGF 10        Message file.
     C                     PARM           ZAMSDA132        Message data.
     C                     PARM           ZAMSTP  7        Message type.
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRBERR  -  Set up batch error details                         *
      * Called by: ZASNMS - Sends messages to the program msgq        *
      * Calls    : None                                               *
      *****************************************************************
     C           SRBERR    BEGSR
      *
     C                     CALL 'Y2RVMGC'
     C                     PARM           @RTCD
     C                     PARM           ZAMSID           Message Id.
     C                     PARM           ZAMSGF           Message file.
     C                     PARM           ZAMSDA           Message data.
     C                     PARM           ZAMSTX132        Messge text
      *                                                                   120468
      *  Include DUMP here for problems during batch and play modes.      120468
      *                                                                   120468
     C           W#ERR2    IFEQ 'Y'                                       120468
     C                     DUMP                                           120468
     C                     ENDIF                                          120468
      *
      ** If batch mode, set up details of returned message format
      ** otherwise update message severity/id/text of test harness file
      *
     C           P#MODE    IFEQ 'B'
     C                     MOVE F1MSGT    F2MSGT
     C                     MOVE F1TRUS    F2TRUS
     C                     MOVE F1TRWS    F2TRWS
     C                     MOVE F1TNRF    F2TNRF
     C                     MOVE F1TRSN    F2TRSN
     C                     MOVE F1ACTN    F2ACTN
     C                     MOVE F1TRDS    F2TRDS
     C                     MOVE F1TRTS    F2TRTS
     C                     MOVE F1NRBA    F2NRBA
     C                     MOVEL'E'       F2MSGS
     C                     MOVELZAMSID    F2MSGI
     C                     MOVELZAMSTX    F2MSTX
     C                     MOVE F1CNUM    F2CNUM
     C                     MOVE F1FACT    F2FACT
     C                     MOVE F1FCNO    F2FCNO
     C                     MOVE *ON       *INLR
     C                     RETRN
      *  Play Mode
     C                     ELSE
     C                     MOVEL'E'       RMSV
     C                     MOVELZAMSID    RMID
     C                     MOVELZAMSTX    RMTY
     C                     UPDATLE2021D0
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CLEARM  -  Clears the message queue                           *
      * Called by: All validation subroutines                         *
      * Calls    : Y2CLMSC                                            *
      *****************************************************************
     C           CLEARM    BEGSR
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
     C                     ENDSR
      ********************************************************************
      /EJECT                                                              157004
      *****************************************************************   157004
      *  SRF1FM  -  Move values from PC Msg file to facility file.    *   157004
      *  Called by: LOADFM                                            *   157004
      *  Calls    : ZDATE1, ZALIGN                                    *   157004
      *****************************************************************   157004
     C           SRF1FM    BEGSR                                          157004
      *                                                                   157004
     C                     MOVE F1BRCA    BRCA                            157004
     C                     MOVE F1ORBR    ORBR                            157004
     C                     MOVE F1FCTI    FCTI                            157004
     C                     MOVE F1FCCY    FCCY                            157004
     C                     MOVE F1RVCR    RVCR                            157004
     C                     MOVE F1SECI    SECI                            157004
     C                     MOVE F1MCCY    MCCY                            157004
     C                     MOVE F1MCSI    MCSI                            157004
     C                     MOVE F1MBFC    MBFC                            157004
     C                     MOVE F1CRSK    CRSK                            157004
     C                     MOVE F1RVFR    RVFR                            157004
     C                     MOVE F1RVDY    RVDY                            157004
     C                     MOVE F1NAR1    NAR1                            157004
     C                     MOVE F1NAR2    NAR2                            157004
     C                     MOVE F1NAR3    NAR3                            157004
     C                     MOVE F1NAR4    NAR4                            157004
     C                     MOVE F1ACOF    ACOF                            157004
      *                                                                   157004
     C                     MOVE F1OVPC    ZFIELD                          157004
     C                     Z-ADD2         ZADIG                           157004
     C                     Z-ADD3         ZADEC                           157004
     C                     EXSR ZALIGN                                    157004
     C           ZFIELD    IFNE *BLANKS                                   157004
     C                     MOVE ZFIELD    OVPC                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     MOVE F1NOMR    ZFIELD                          157004
     C                     Z-ADD4         ZADIG                           157004
     C                     Z-ADD7         ZADEC                           157004
     C                     EXSR ZALIGN                                    157004
     C           ZFIELD    IFNE *BLANKS                                   157004
     C                     MOVE ZFIELD    NOMR                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     MOVE F1DTEX    WDATE2  2                       157004
     C                     MOVELF1DTEX    ZDATE                           157004
     C                     MOVE WDATE2    ZDATE                           157004
     C                     EXSR ZDATE1                                    157004
     C           ZDAYNO    IFNE 0                                         157004
     C                     Z-ADDZDAYNO    DTEX                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     MOVE F1DLFS    WDATE2                          157004
     C                     MOVELF1DLFS    ZDATE                           157004
     C                     MOVE WDATE2    ZDATE                           157004
     C                     EXSR ZDATE1                                    157004
     C           ZDAYNO    IFNE 0                                         157004
     C                     Z-ADDZDAYNO    DLFS                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     MOVE F1RVDT    WDATE2                          157004
     C                     MOVELF1RVDT    ZDATE                           157004
     C                     MOVE WDATE2    ZDATE                           157004
     C                     EXSR ZDATE1                                    157004
     C           ZDAYNO    IFNE 0                                         157004
     C                     Z-ADDZDAYNO    RVDT                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C           CLE006    IFEQ 'Y'                                       157004
      *                                                                   157004
     C                     MOVE F1SYIN    SYIN                            157004
      *                                                                                       CLE028
      ** If Flat Rate Personal Loans (Rule of 78s) is installed,                              CLE028
      ** 6th possible drawing type is recognized.                                             CLE028
      *                                                                                       CLE028
     C           CLE028    IFEQ 'Y'                                                           CLE028
     C                     MOVE F1DTPX    DTPX                                                CLE028
     C                     ENDIF                                                              CLE028
      *                                                                                       CLE028
     C                     MOVE F1DTPS    DTPS                            157004
     C                     MOVE F1RTPS    RTPS                            157004
     C                     MOVE F1RLPD    RLPD                            157004
     C                     MOVE F1DICB    DICB                            157004
     C                     MOVE F1CSEL    CSEL                            157004
     C                     MOVE F1ALCY    ALCY                            157004
     C                     MOVE F1LPTP    LPTP                            157004
     C                     MOVE F1LPBR    LPBR                            157004
     C                     MOVE F1LPPS    LPPS                            157004
     C                     MOVE F1DFTP    DFTP                            157004
     C                     MOVE F1DFST    DFST                            157004
      *                                                                   157593
      ** There should be no C/A facility for the funding participant      157593
      ** if the participant is created against a tranche facility.        157593
      *                                                                   157593
     C           F1TRCA    IFEQ 'TR'                                      157593
     C                     MOVE *BLANKS   TRCA                            157593
     C**********           Z-ADD0         CANM                                         157593 CSD027
     C                     MOVE *BLANKS   CANM                                                CSD027
     C                     Z-ADD0         CAFT                            157593
     C                     Z-ADD0         CAFN                            157593
     C                     ELSE                                           157593
     C                     MOVE F1TRCA    TRCA                            157004
     C                     MOVE F1CANM    CANM                            157004
     C                     MOVE F1CAFT    CAFT                            157004
     C                     MOVE F1CAFN    CAFN                            157004
     C                     ENDIF                                          157593
     C                     MOVE F1ACSQ    ACSQ                            157004
     C                     MOVE F1SYCP    SYCP                            157004
     C                     MOVE F1CMDI    CMDI                            157004
     C                     MOVE F1SCCY    SCCY                            157004
     C                     MOVE F1ICCY    ICCY                            157004
      *                                                                   157004
     C                     MOVE F1COMD    WDATE2                          157004
     C                     MOVELF1COMD    ZDATE                           157004
     C                     MOVE WDATE2    ZDATE                           157004
     C                     EXSR ZDATE1                                    157004
     C           ZDAYNO    IFNE 0                                         157004
     C                     Z-ADDZDAYNO    COMD                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     MOVE F1AVLD    WDATE2                          157004
     C                     MOVELF1AVLD    ZDATE                           157004
     C                     MOVE WDATE2    ZDATE                           157004
     C                     EXSR ZDATE1                                    157004
     C           ZDAYNO    IFNE 0                                         157004
     C                     Z-ADDZDAYNO    AVLD                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     MOVE F1LPAM    ZFIELD                          157004
     C                     Z-ADD13        ZADIG                           157004
     C                     Z-ADD0         ZADEC                           157004
     C                     EXSR ZALIGN                                    157004
     C           ZFIELD    IFNE *BLANKS                                   157004
     C                     MOVE ZFIELD    LPAM                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     MOVE F1CAXR    ZFIELD                          157004
     C                     Z-ADD5         ZADIG                           157004
     C                     Z-ADD8         ZADEC                           157004
     C                     EXSR ZALIGN                                    157004
     C           ZFIELD    IFNE *BLANKS                                   157004
     C                     MOVE ZFIELD    CAXR                            157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C                     ENDIF                                          157004
      *                                                                   157004
     C           CLE008    IFEQ 'Y'                                       157004
     C                     MOVE F1LAID    LAID                            157004
     C                     ENDIF                                          157004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE F1COAG    COAG                                                CLE031
     C                     MOVE F1FCAG    FCAG                                                CLE031
     C                     MOVE F1PHAG    PHAG                                                CLE031
     C                     MOVE F1SCAG    SCAG                                                CLE031
     C                     ENDIF                                                              CLE031
      *                                                                   157004
     C                     ENDSR                                          157004
      *****************************************************************   157004
      /EJECT                                                              154591
     C/COPY ZSRSRC,ZFWDT                                                  154591
      /EJECT                                                              154591
     C/COPY ZSRSRC,ZACCH                                                  154591
      /EJECT
     C/COPY ZSRSRC,ZALIGNZ2L
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZEDITZ2L
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
** STAMP - Dummy timestamp                                                                    CPK015
0001-01-01-00.00.00.000000                                                                    CPK015
** CPY@
(c) Finastra International Limited 2001
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
