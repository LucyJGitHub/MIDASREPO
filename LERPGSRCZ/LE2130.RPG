     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Transfer of principal input')                 *
      *****************************************************************
      *                                                               *
      *  Midas - Customer Lending Module                              *
      *                                                               *
      *  LE2130 - Transfer of Principal Input                         *
      *                                                               *
      *  Function:  This is a new program used to define the transfer *
      *             of principal between loans.  This may be used to  *
      *             perform either consolidation (by moving principal *
      *             of several loans to one loan) or splitting (by    *
      *             moving principal of one loan to several others).  *
      *             This is capable of running in three modes:        *
      *               1. Interactive ('I') - called from the Midas    *
      *                    Transaction Input menu                     *
      *               2. Record ('R') - Run interactively but updates *
      *                    are done to a new 'test harness' file      *
      *               3. Play ('P') - Run interactively but data is   Z
      *                    read from the 'test harness' file          *
      *                                                               *
      *  Called By: LEC2130 - Principal Transfer Input CLP            *
      *  Calls    : LE2030  - Loan Details Input                      *
      *             LE2040  - Loan Amendments Input                   *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. CLE172             Date 01Oct20               *
      *  Prev Amend No. CSD103             Date 10Aug20               *
      *                 MD046248           Date 27Oct17               *
      *                 CLE148             Date 23Jul12               *
      *                 CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 244314A            Date 20Dec06               *
      *                 244314             Date 11Dec06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 218331             Date 19Sep06               *
      *                 241213             Date 30Aug06               *
      *                 238525             Date 30Aug06               *
      *                 240968             Date 10Jul06               *
      *                 CSD031             Date 10Apr06               *
      *                 BUG8832            Date 03Oct05               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 BUG9850            Date 12Jan06               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 29Oct03               *
      *                 CPK017             Date 14Sep03               *
      *                 CLE034             Date 05May03               *
      *                 CAS006             Date 21Jan03               *
      *                 CAS005             Date 16Dec02               *
      *                 213957             Date 15Jan03               *
      *                 CLE028             Date 27Jun02               *
      * Midas Release 4.01.03 ----------------------------------------*
      *                 212149             Date 25Nov02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 202587             Date 19Feb02               *
      *                 202391             Date 25Feb02               *
      *                 CAS001             Date 23Nov01               *
      *                 197084             Date 11Sep01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 202440             Date 29Jan02               *
      *                 CLE014             Date 20Mar01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 186137             Date 16Feb01               *
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CRT004             DATE 04MAY00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 162648             Date 18Jun99               *
      *                 160635             Date 19May99               *
      *                 159256             Date 11May99               *
      *                 158600 (BT0683)    Date 14Apr98               *
      *                 158597 (BT0900)    Date 23Jun98               *
      *                 156990             Date 15Mar99               *
      *                 156764             Date 10Mar99               *
      *                 155721             Date 24Feb99               *
      *                 155279             Date 16Feb99               *
      *                 154220             Date 28Jan99               *
      *                 152892             Date 13Jan99               *
      *                 152618             Date 12Jan99               *
      *                 146373             Date 03Nov98               *
      *                 144924             Date 23Oct98               *
      *                 144096             Date 30Oct98               *
      *                 144090             Date 12Oct98               *
      *                 140823             Date 16Sep98               *
      *                 139308             Date 26Oct98               *
      *                 138865             Date 21Sep98               *
      *                 135749             Date 02Jun98               *
      *                 135349             Date 02Feb99               *
      *                 135143             Date 25May98               *
      *                 131253             Date 25May98               *
      *                 CLE005             Date 22May97               *
      *                 123857             Date 24Oct97               *
      *                 124483             Date 16Oct97               *
      *                 123998             Date 16Oct97               *
      *                 123227             Date 19Sep97               *
      *                 123214             Date 19Sep97               *
      *                 123096             Date 17SEP97               *
      *                 122614             Date 04SEP97               *
      *                 122052             Date 21AUG97               *
      *                 121783             Date 20AUG97               *
      *                 CLE004 *CREATE     Date 02Dec96               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CLE172 - LIBOR Deregulation - Lending                        *
      *           (Recompile)                                         *
      *  CSD103 - LIBOR Deregulation - Common Layer/Standing Data     *
      *  MD046248 - Finastra Rebranding                               *
      *  CLE148 - Alpha Loan Reference                                *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus                                          *
      *  244314A- Incorrectly defined system value for 244314         *
      *  244314 - If system value CLAuthSameORED = 'Y', then allow    *
      *           original input user to re-authorise a transaction   *
      *           that was previously authorised and has been amended *
      *           by a second user.                                   *
      *  218331 - Incorrect validation of principal amount.           *
      *  241213 - Applied partial fix of 238525.                      *
      *  238525 - Decimal data error: unsuccessful creation of loan,  *
      *           correct definition of PONS and RONS.                *
      *  240968 - If system value CLAuthORED = 'Y', when authorising  *
      *           do not check insert user is different to authorise  *
      *           user if status is 'R'                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  BUG8832- Necessary changes missed by CGL029                  *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  BUG9850- Unsuccessful creation of Loan via Prin Transfer     *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Parameter Mismatch                                  *
      *  CPK017 - Midas Plus Packaging.                               *
      *  CLE034 - Lending Enhancements.                               *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  CAS005 - Enahancements to CAS001, CAS002 and CAS004          *
      *           (Recompile)                                         *
      *  213957 - Principal Transfer error due to incorrect facility  *
      *  CLE028 - Flat Rate Personal Loans (Rule of 78s)              *
      *  212149 - Principal transfer allows invalid 'transfer to'     *
      *           customer.                                           *
      *  202587 - Problems authorising a principal transfer. Reset    *
      *           DBPGM to LE2130 after calling LE2030 or LE2040.     *
      *  202391 - Principal transfer fails: CHIN='D' on original      *
      *           loan. Pass parameter of blank to LE2030 if original *
      *           loan is not attached to a base rate.                *
      *  CAS001 - Net Present Value (NPV) Accounting                  *
      *  197084 - Changed the condition for field BPAURV by comparing *
      *           it to 'Y' instead of 'N'                            *
      *  202440 - OVRDBF LEILAMLX before and after call to LE2040.    *
      *           Required by CAP061.                                 *
      *  CLE014 - Customer Driven Lending Enhancements                *
      *  186137 - Re-initialise *IN45 upon processing of an existing  *
      *           principal transfer record through subfile screen.   *
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
      *  CRT004 - Cashier Midas TCP/IP interface.                     *
      *             Recompiled over SDBRCHPD Changes                  *
      *  162648 - Invalid settlement receipt currency message returned*
      *           if principal transfer to a new loan.                *
      *  160635 - Transfer of principal gives CPF2469 if new loan is  *
      *           selected                                            *
      *  159256 - Send interactive warning message if syndicated      *
      *           loan is amended via Midas.                          *
      *  158600 - Same date checks must be applied to receiving loan  *
      *           as are already applied to originating loan          *
      *  158597 - Various problems in 131253                          *
      *  156990 - Additional validation for transfer of principal     *
      *           in different loan processing types.                 *
      *  156764 - Transaction itself should not be included in        *
      *           calculating principal of originating loan.          *
      *  155721 - Not able to create a new loan from an existing part *
      *           sold to the new loan created by the principal       *
      *           transfer                                            *
      *  155279 - No warning if principal exceeded on principal       *
      *           transfer                                            *
      *  154220 - Cannot input principal transfer due to error        *
      *           on rollover date                                    *
      *  152892 - LE2030 writes to ltrix before transaction is        *
      *           authorised; pass flag to remedy this.               *
      *           Same problem as 144096.                             *
      *  152618 - Mirror loan number not being passed for type 'PTPU'.*
      *  146373 - Loan Amendment Maintenance shows misleading         *
      *           settlement instructions.                            *
      *  144924 - When inserting a transfer for a part sold and crea- *
      *           ting a new loan, get an error in Receiving Customer *
      *           even if it is the same customer as the originating  *
      *           loan.                                               *
      *  144096 - LE2040 writes to ltrix before transaction is        *
      *           authorised; pass flag to remedy this.               *
      *  144090 - Input of prin trf when the outstanding loan amount  *
      *           is less than the amount transferred after repay     *
      *  140823 - New loan created should have the same rollover and  *
      *           interest details as the original loan               *
      *  139308 - Cannot Amend or Reverse PTMN.                       *
      *  138865 - Cannot change original loan when transfer principal *
      *           on parts sold                                       *
      *  135749 - There should be warning when PT has PS.             *
      *  135349 - Amount sold is not being updated when a principal   *
      *           transfer of the part sold amount occured.           *
      *  135143 - Cannot Amend or Reverse PTMN.                       *
      *  131253 - Accept amendment when CLE005 is *ON and RATF in     *
      *           CLOANCL is 'Y' even if RECI is 'M'.                 *
      *  123998 - Texts should be coming from message subfile         *
      *  CLE005 - Customer Lending Enhancements - Tranche 3           *
      *  123857 - Authorisation to allow F11 or not depending on ICD. *
      *  124483 - Future dated principal transfer should have deal    *
      *           date set as rundate instead of value date           *
      *  123998 - Texts should be coming from message subfile         *
      *  123227 - Principal transfer authorisation to call LE2030     *
      *  123214 - Value date passed as blank for JPY                  *
      *  123096 - Assignment/Participant flag set up incorrectly      *
      *           when passed to LE2030 for creation of new loan      *
      *  122614 - Set message type to 'PTFT'                          *
      *  122052 - Name of message file not set up correctly.          *
      *  121783 - Call new access object AOBRCHR1 instead of AOBRCHR0 *
      *           (uses the long data structure DSSDY)                *
      *  CLE004 - Customer Lending Enhancements - Syndications.       *
      *                                                               *
      *****************************************************************
     FLE2130DFCF  E                    WORKSTN                        UC
     F                                        SRRN  KSFILE LE2130S0
      *
     FLE2130PDUF  E                    DISK         KINFSR *PSSR A    UC
      *
     FLOAMS   IF  E           K        DISK         KINFSR *PSSR
     F            LOAMSDHF                          KIGNORE
     F            LOAMSZ1F                          KIGNORE
      *
     FCLOAN   IF  E           K        DISK
     F            CLOANHHF                          KIGNORE
     F            CLOANZ1F                          KIGNORE
      *
     FLELOAML0IF  E           K        DISK
     F            LOAMSDKF                          KRENAMELELOAMD0
      *
     FLELOAML1IF  E           K        DISK
     F            LOAMSDKF                          KRENAMELELOAMD1
      *                                                                   135749
     FPSOLD   IF  E           K        DISK                               135749
     F            CLOANCLF                          KRENAMEPSOLDFF        135749
      *
     FFCLTY   IF  E           K        DISK         KINFSR *PSSR      UC  159256
     F            FCLTYHHF                          KIGNORE               159256
     F            FCLTYZZF                          KIGNORE               159256
      ** Customer Lending Facility file                                   159256
      *                                                                   159256
      /EJECT
      *****************************************************************
      *                                                               *
      *    F U N C T I O N   O F   I N D I C A T O R S                *
      *                                                               *
      *    21           Invalid action code                           *
      *    22           Invalid originating loan                      *
      *    23           Invalid value date                            *
      *    24           Invalid sequence number                       *
      *    25           Invalid review from loan                      *
      *    26           Invalid review from value date                *
      *    27           Invalid review from sequence number           *
      *    28           Invalid unauthorised selection                *
      *    29           Invalid receiving loan                        *
      *    30           Invalid new loan indicator                    *
      *    31           Invalid receiving customer                    *
      *    32           Invalid transfer amount                       *
      *    33           Authorise request                             *
      *    34           Reverse request                               *
      *    35           Protect detail fields                         *
      *    36           Invalid branch                                *
      *    37           SAR CLE002 is installed                       *
      *    38           Insert from subfile screen is requested       *
      *    39           New loan inserted                             *
      *    40           New transfer principal from inserted          *
      *    41           New transfer principal to inserted            *
      *    42           Amend request                                 *
      *    43           F11 to authorise not required                 *   123857
      *    44           Invalid Original Loan of Receiving Loan       *   138865
      *    45           Non-display Original Loan of Receiving Loan   *   138865
      *    70           End of file indicator                         *
      *    73           No more changed record                        *
      *    74           Rollup for subfile                            *
      *    75           Message subfile end                           *
      *    76           Subfile next change                           *
      *    77           No record in subfile                          *
      *    78           Subfile clear                                 *
      *    79           Subfile end                                   *
      *    98           Date format is MMDDYY                         *
      *                                                               *
      *****************************************************************
      /EJECT
     E                    CPY@    1   1 80
      ** Copyright statement
     E***********         WSTAT   1   4 16                                123998
      ***Loan*status                                                      123998
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZDATE9Z1
     E/COPY ZSRSRC,ZEDITZ1
     E/COPY ZSRSRC,ZFRPEDZ1
     E/COPY ZSRSRC,ZHOLE                                                  CLE014
     E                    CMD     1   2 60               QCMD'S                               202440
      *
      /EJECT
      *
     ILE2130D0
      ** Rename fields with different attributes from LOAMS
     I              LNRF                            LNRFH
     I              VDAT                            VDATH
     I              LASN                            LASNH
     I              CNUM                            CNUMH
     I              CCY                             CCYH
     I              ROLN                            ROLNH
     I              RORC                            RORCH
     I              NRLI                            NRLIH
     I              PRAM                            PRAMH
     I              OLNO                            OLNOH                 138865
      *
     ICLOANCLF
      ** Rename important fields similar to other files
     I              RECI                            RECIL                 131253
     I              LNRF                            LNRFL
     I              CNUM                            CNUML
     I              BRCA                            BRCAL
     I              VDAT                            VDATL
     I              CCY                             CCYL
     I              TMST                            TMSTL                                     CPK017
      *
     ICLOANCKF                                                                                CPK017
      ** Rename important fields similar to other files                                       CPK017
     I              TMST                            TMSTK                                     CPK017
      *                                                                                       CPK017
     ILOAMSDKF
      ** Rename important fields similar to other files
     I              LNRF                            LNRFK
     I              VDAT                            VDATK
     I              TMST                            TMSTK                                     CPK017
      *                                                                                       CPK017
     IPSOLDFF                                                                                 CPK017
      ** Rename important fields similar to other files                                       CPK017
     I              TMST                            TMSTP                                     CPK017
      *                                                                                       CPK017
      *                                                                                       CPK017
     ILELOAMD0                                                                                CPK017
      ** Rename important fields similar to other files                                       CPK017
     I              TMST                            TMST0                                     CPK017
      *                                                                                       CPK017
     ILELOAMD1                                                                                CPK017
      ** Rename important fields similar to other files                                       CPK017
     I              TMST                            TMST1                                     CPK017
      *                                                                                       CPK017
     IFCLTYFMF                                                            159256
      ** Rename fields                                                    159256
     I              RECI                            RECIF                 159256
     I              CNUM                            CNUMF                 159256
     I              FACT                            FACTF                 159256
     I              FCNO                            FCNOF                 159256
     I              RCTP                            RCTPF                 159256
     I              BRCA                            BRCDF                 159256
     I              FCTI                            FCTIF                 159256
     I              FCCY                            FCCYF                 159256
     I              FAMT                            FAMTF                 159256
     I              OVPC                            OVPCF                 159256
     I              DTAP                            DTAPF                 159256
     I              DTEX                            DTEXF                 159256
     I              RVCR                            RVCRF                 159256
     I              SECI                            SECIF                 159256
     I              MCCY                            MCCYF                 159256
     I              MCSI                            MCSIF                 159256
     I              NACD                            NACDF                 159256
     I              CRSK                            CRSKF                 159256
     I              DLFS                            DLFSF                 159256
     I              NOMR                            NOMRF                 159256
     I              RVDT                            RVDTF                 159256
     I              RVFR                            RVFRF                 159256
     I              RVDY                            RVDYF                 159256
     I              NAR1                            NAR1F                 159256
     I              NAR2                            NAR2F                 159256
     I              NAR3                            NAR3F                 159256
     I              NAR4                            NAR4F                 159256
     I              MTDH                            MTDHF                 159256
     I              MTDL                            MTDLF                 159256
     I              MTDA                            MTDAF                 159256
     I              QTDA                            QTDAF                 159256
     I              YTDA                            YTDAF                 159256
     I              ACOF                            ACOFF                 159256
     I              ORED                            OREDF                 159256
     I              LCD                             LCDF                  159256
     I              CHTP                            CHTPF                 159256
     I              TNLU                            TNLUF                 159256
     I              RCSI                            RCSIF                 159256
     I              SCCY                            SCCYL                 159256
     IA@CPY       DS
      * Copyright array
     I                                        1  80 CPY@
     I/COPY ZSRSRC,ZHOLI                                                  CLE014
      *
     ILDA         DS                            256
      ** Local data area for database error details
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I                                      184 256 DBTXT
      *
     IPSDS       SDS
      ** Program Status Data Structure - gives Job/Workstation name and
      ** User ID
     I                                     *PROGRAM ##PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
     I*INPL*******DS                           1289                       162648
     I**********PINPL       DS                           1297                          162648 CAS001
     I***PINPL*******DS                           1309                                 CAS001 CLE028
     I***PINPL**     DS                           1326                                CLE028 BUG9850
     IPINPL     E DSLEN1MFPD                                                                 BUG9850
      ** Transmitted message format for loans
     I                                        1   4 LMTYP
     I                                        5  20 LTUSR
     I                                       21  36 LTWID
     I                                       37  51 LTREF
     I                                       52  55 LTSEQ
     I                                       56  56 LTACT
     I                                       57  64 LTDAT
     I                                       65  72 LTTIM
     I                                       73  75 LNPSO
     I                                       76  80 LFILL
     I                                       80  80 LPTIN                 152892
     I                                       81  86 LLNRF
     I                                       87  92 LCNMR
     I                                       93  95 LBRCA
     I                                       96  98 LORBR
     I                                       99 100 LLTYP
     I                                      101 102 LSUTP
     I                                      103 110 LDDAT
     I                                      111 118 LSTDT
     I                                      119 126 LMDAT
     I                                      127 132 LFCUS
     I                                      133 135 LFACT
     I                                      136 137 LFCNO
     I                                      138 140 LCCY
     I                                      141 154 LCPAM
     I                                      155 155 LAUTO
     I                                      156 156 LAPMI
     I                                      157 158 LBOKC
     I                                      159 162 LPTFR
     I                                      163 166 LPRFC
     I                                      167 168 LLASQ
     I                                      169 169 LINTC
     I                                      170 170 LADDI
     I                                      171 171 LCALC
     I                                      172 173 LBRTT
     I                                      174 185 LRTSP
     I                                      186 186 LSPIN
     I                                      187 187 LCHIN
     I                                      188 195 LMARG
     I                                      196 196 LNEGV
     I                                      197 197 LRDFC
     I                                      198 198 LWTIN
     I                                      199 210 LWTRT
     I                                      211 211 LINFQ
     I                                      212 213 LINDY
     I                                      214 221 LNIDT
     I                                      222 222 LREPT
     I                                      223 236 LRPAM
     I                                      237 237 LRPFQ
     I                                      238 239 LRPDY
     I                                      240 247 LRPDT
     I                                      248 250 LLIND
     I                                      251 255 LFRBC
     I                                      256 257 LCRSK
     I                                      258 259 LACOF
     I                                      260 260 LNACD
     I                                      261 261 LFEEI
     I                                      262 262 LDOCI
     I                                      263 263 LSECI
     I                                      264 298 LNAR1
     I                                      299 333 LNAR2
     I                                      334 368 LNAR3
     I                                      369 403 LNAR4
     I                                      404 404 LBMDI
     I                                      405 418 LBCXR
     I                                      419 419 LFMDI
     I                                      420 433 LFCXR
     I                                      434 439 LRECE
     I                                      440 445 LCOCU
     I                                      446 453 LOMDT
     I                                      454 454 LRLFQ
     I                                      455 456 LRLDY
     I                                      457 464 LRLDT
     I                                      465 465 LBTIN
     I                                      466 467 LBLDY
     I                                      468 468 LRCSI
     I                                      469 474 LORGB
     I                                      475 480 LORLN
     I                                      481 492 LFSRP
     I                                      493 493 LFSGN
     I                                      494 497 LFPRC
     I                                      498 527 LSPI1
     I                                      528 557 LSPI2
     I                                      558 587 LSPI3
     I                                      588 589 LPSTM
     I**********                            590 592 LOSDB                                    BUG8832
     I**********                            590 604 LPONS                                    BUG8832
     I                                      590 592 QOSDB                                    BUG8832
     I                                      590 604 QPONS                                    BUG8832
     I                                      605 612 LRVNO
     I                                      613 613 LCVMR
     I                                      614 619 LPOCN
     I                                      620 625 LPOBN
     I                                      626 633 LRCRN
     I                                      634 668 LRCRA
     I                                      669 676 LPIBN
     I                                      677 711 LPIBA
     I                                      712 719 LAWBN
     I                                      720 754 LAWBA
     I                                      755 762 LBENN
     I                                      763 797 LBENA
     I                                      798 799 LRSTM
     I**********                            800 802 LOMDB                                    BUG8832
     I**********                            800 814 LRONS                                    BUG8832
     I                                      800 802 QOMDB                                    BUG8832
     I                                      800 814 QRONS                                    BUG8832
     I                                      815 820 LROCN
     I                                      821 826 LROBN
     I                                      827 834 LRIBN
     I                                      835 869 LRIBA
     I                                      870 904 LDTP1
     I                                      905 939 LDTP2
     I                                      940 974 LDTP3
     I                                      9751009 LDTP4
     I                                     10101012 LDCHG
     I                                     10131047 LBTB1
     I                                     10481082 LBTB2
     I                                     10831117 LBTB3
     I                                     11181152 LBTB4
     I                                     11531187 LBTB5
     I                                     11881222 LBTB6
     I                                     12231223 LLNKS
     I                                     12241224 LGASS
     I                                     12251226 LDFTP
     I                                     12271228 LDFST
     I                                     12291229 LMCRA
     I                                     12301243 LFCRA
     I                                     12441244 LPDDI
     I                                     12451245 LPTDI
     I                                     12461247 LGDPR
     I                                     12481249 LGDIN
     I                                     12501250 LGPRT
     I                                     12511256 LTOLN
     I                                     12571266 LIUSR
     I                                     12671276 LAUSR
     I                                     12771286 LXUSR
     I                                     12871289 LPCOB
     I                                     12901292 LSCCY                 162648
     I                                     12931295 LICCY                 162648
     I                                     12961296 LRISK                 162648
     I                                     12971297 LCPSI                 162648
     I                                     13001304 LYLDC                                     CAS001
     I                                     13051309 LFYLD                                     CAS001
     I                                     13751377 LOSDB                                    BUG8832
     I                                     13751395 LPONS                                    BUG8832
     I                                     13961398 LOMDB                                    BUG8832
     I                                     13961416 LRONS                                    BUG8832
     I                                     14171428 LBASR                                     CER020
     I                                     14291429 LPPTF                                     CER020
     I                                     14301432 LLOIC                                     CER020
      *                                                                   159256
      ** FCLKEY                                                           159256
      *                                                                   159256
     I            DS                                                      159256
     I**********                              1   60WFCUS                              159256 CSD027
     I                                        1   6 WFCUS                                     CSD027
     I                                        7   90WFTYP                 159256
     I                                       10  110WFSEQ                 159256
     I                                       12  12 WRCDT1                159256
     I                                        1  12 FCLKEY                159256
      *                                                                   159256
      *
     I/COPY WNCPYSRC,LE2130I001
     IPOUTL       DS                            172
     I/COPY WNCPYSRC,LE2130I002
      ** Returned message format for loans
     I                                        1   4 LRMTP
     I                                        5  20 LRTUS
     I                                       21  36 LRTWS
     I                                       37  51 LRTRF
     I                                       52  55 LRTSQ
     I                                       56  56 LRTAC
     I                                       57  64 LRTDT
     I                                       65  72 LRTTM
     I                                       73  75 LRPAR
     I                                       76  80 LRFIL
     I                                       81  81 LRMSV
     I                                       82  88 LRMID
     I                                       89 166 LRMTX
     I                                      167 172 LRLON
     I/COPY WNCPYSRC,LE2130I003
      *
     IPINPA       DS                            940
      ** Transmitted message format for loan amendments
     I                                        1   4 AMTYP
     I                                        5  20 ATUSR
     I                                       21  36 ATWST
     I                                       37  51 ATREF
     I                                       52  55 ATSEQ
     I                                       56  56 ATACT
     I                                       57  64 ATDAT
     I                                       65  72 ATTIM
     I                                       73  75 ANPAR
     I                                       76  78 ANNLR
     I                                       79  80 AFILL
     I                                       80  80 APTIN                 144096
     I                                       81  86 ALOAN
     I                                       87  94 AVDAT
     I                                       95  97 AAMSQ
     I                                       98 103 ACSNO
     I                                      104 106 ACURR
     I                                      107 120 APRAM
     I                                      121 122 ABSRT
     I                                      123 134 ARTSP
     I                                      135 135 ASTAC
     I                                      136 143 AMATD
     I                                      144 145 ALTYP
     I                                      146 147 ALSTP
     I                                      148 159 AFRAT
     I                                      160 249 ASPEI
     I                                      160 189 ASPI1
     I                                      190 219 ASPI2
     I                                      220 249 ASPI3
     I                                      250 251 APSTM
     I                                      252 266 APONS
     I                                      267 274 ARVNO
     I                                      275 275 ACVMR
     I                                      276 281 APOCN
     I                                      282 287 APOBN
     I                                      288 295 ARCRN
     I                                      296 330 ARCRA
     I                                      331 338 APIBN
     I                                      339 373 APIBA
     I                                      374 381 AAWBN
     I                                      382 416 AAWBA
     I                                      417 424 ABENN
     I                                      425 459 ABENA
     I                                      460 461 ARSTM
     I                                      462 476 ARONS
     I                                      477 482 AROCN
     I                                      483 488 AROBN
     I                                      489 496 ARIBN
     I                                      497 531 ARIBA
     I                                      532 671 ADTPA
     I                                      532 566 ADTP1
     I                                      567 601 ADTP2
     I                                      602 636 ADTP3
     I                                      637 671 ADTP4
     I                                      672 674 ADCHG
     I                                      675 884 ABTBA
     I                                      675 709 ABTB1
     I                                      710 744 ABTB2
     I                                      745 779 ABTB3
     I                                      780 814 ABTB4
     I                                      815 849 ABTB5
     I                                      850 884 ABTB6
     I                                      885 886 ADFTP
     I                                      887 888 ADFST
     I                                      889 889 ANRLI
     I                                      890 895 AROLN
     I                                      896 898 AROSN
     I                                      899 901 AROBR
     I                                      902 907 ARORC
     I                                      908 917 AIUSR
     I                                      918 927 AAUSR
     I                                      928 937 AXUSR
     I                                      938 940 APCOB
      *
     IPOUTA       DS                            192
      ** Return message format for loan amendments
     I                                        1   4 ARMTP
     I                                        5  20 ARTUS
     I                                       21  36 ARTWS
     I                                       37  51 ARTRF
     I                                       52  55 ARTSQ
     I                                       56  56 ARTAC
     I                                       57  64 ARTDT
     I                                       65  72 ARTTM
     I                                       73  75 ARPAR
     I                                       76  78 ARNLN
     I                                       79  80 ARFIL
     I                                       81  81 ARMSV
     I                                       82  88 ARMID
     I                                       89 166 ARMTX
     I                                      167 172 ARLON
     I                                      173 180 ARVDT
     I                                      181 183 ARMSQ
     I                                      184 189 ARRLN
     I                                      190 192 ARRAS
      *
     I            DS
      ** Data structure for review fields
     I                                        1  16 SREVW
     I                                        1   6 SRLON
     I                                        7  12 SRVDT
     I                                       13  15 SRSEQ
     I                                       16  16 SRAUT
      *
     I            DS
      ** Data structure for facility
     I**********                              1  110WRFAC                                     CSD027
     I**********                              1   60FCUS                                      CSD027
     I                                        1  11 WRFAC                                     CSD027
     I                                        1   6 FCUS                                      CSD027
     I                                        7   90FTYP
     I                                       10  110FSEQ
      *
     I            DS
      ** Date format for test harness file
     I                                        1   8 WTDAT
     I                                        1   2 WTDT1
     I I            '/'                       3   3 WFIL1
     I                                        4   5 WTDT2
     I I            '/'                       6   6 WFIL2
     I                                        7   8 WTDT3
      *
     I            DS
      ** Time format for test harness file
     I                                        1   8 WTTIM
     I                                        1   2 WTTM1
     I I            ':'                       3   3 WFIL3
     I                                        4   5 WTTM2
     I I            ':'                       6   6 WFIL4
     I                                        7   8 WTTM3
      *
     I            DS
      ** Separate date values
     I                                        1   6 WDATE
     I                                        1   2 WDAT1
     I                                        3   4 WDAT2
     I                                        5   6 WDAT3
      *
     I            DS
      ** Separate time values
     I                                        1   60WTIME
     I                                        1   2 WTIM1
     I                                        3   4 WTIM2
     I                                        5   6 WTIM3
      *
     I            DS
      ** Format amount returned by standard subroutine
     I                                        1  22 ZOUT22
     I                                        1  21 ZOUT21
     I                                        1  20 ZOUT20
      *
     I            DS
     I** 'Transfer Principal to' key DS
     I                                        1  16 WLKEY
     I**********                              1   60WLNRF                                     CLE148
     I                                        1   6 WLNRF                                     CLE148
     I                                        7  110WVDAT
     I                                       12  140WLASN
     I I            'PT'                     15  16 WAMTP
      *
     I/COPY QWINDSRC,LE2130GDTA
      ** Data to be passed to window program
      *
     ISCSARD    E DSSCSARDPD
      ** SAR details
      *
     ISDBANK    E DSSDBANKPD
      ** Bank details
      *
     ISDBRCH    E DSSDBRCHPD
      ** Branch details
      *
     ISDCLND    E DSSDCLNDPD
      ** Customer Lending ICD
      *
     ISDCURR    E DSSDCURRPD
      ** Currency details
      *
     ISDCUST    E DSSDCUSTPD
     I              QQDFAC                          Q1DFAC                                    CGL029
      ** Customer details
      *
     ISDMMOD    E DSSDMMODPD
      ** Midas modules details
      *
     IDSFDY     E DSDSFDY
      ** Short data structure for access objects
      *
     IDSSDY     E DSDSSDY
      ** Long data structure for access objects
      *
     ISVAL1       DS                            200                                           240968
     I                                        1   1 SVAL11                                    240968
     ISVAL2       DS                            200                                           244314
     I                                        1   1 SVAL21                                    244314
      ** DS for AOSVALR0                                                                      240968
      *                                                                                       240968
     I              'CLAuthORED'          C         SVALKK                                    240968
     I              'CLAuthSameORED'      C         SVALKJ                                   244314A
     I/COPY ZSRSRC,ZDATE9Z2
     I/COPY ZSRSRC,ZFRPEDZ2
      /EJECT
      *****************************************************************
      *                   Index to subroutines                        *
      *  Main routine                                                 *
      *  SRINIT  -  Initial processing                                *
      *  SRPLAY  -  Batch processing in play mode                     *
      *  SRSTRT  -  Validate initial screen                           *
      *  SRVKEY  -  Validate key fields                               *
      *  SRVDAT  -  Validate value date                               *
      *  SRSFIL  -  Subfile processing                                *
      *  SRVSUB  -  Validate subfile entries                          *
      *  SRSPRO  -  Process each subfile request                      *
      *  SRDETL  -  Process detail screen                             *
      *  SRVALD  -  Validate detail screen                            *
      *  SRLOAD  -  Load subfile records                              *
      *  SRFMTS  -  Format screen fields for interactive/record mode  *
      *  SRFMTR  -  Format receving loan details for non-insert       *
      *  SRCURR  -  Get currency details                              *
      *  SRCUST  -  Get customer details                              *
      *  SRVREV  -  Validate review from entries                      *
      *  SRAUTH  -  Validate authorisation action                     *
      *  SRCAUT  -  Check if user is authorised to the action         *
      *  SRNEWL  -  Update newly created loans                        *
      *  SR2030  -  Format parameter fields for LE2030                *
      *  SRUPDR  -  Update records in files                           *
      *  SR2040  -  Format parameter fields for LE2040                *
      *  SRRCRD  -  Write to test harness file when in record mode    *
      *  CLEAR   -  Clears message from the program message queue     *
      *  SRWARN  -  Display warning message if loan is syndicated     *   159256
      *  ZASNMS  -  Sends message to the program message queue        *
      *  SRBERR  -  Set up batch error details                        *
      *  *PSSR   -  Error handling subroutine                         *
      *****************************************************************
      *
      ** Perform initial processing
      *
     C                     EXSR SRINIT
      *
      ** Perform different detailed processing
      *
     C           WFMT      DOWNE*BLANK
     C           WFMT      CASEQ'F0'      SRSTRT
     C           WFMT      CASEQ'S0'      SRSFIL
     C           WFMT      CASEQ'D1'      SRDETL
     C           WFMT      CASEQ'WR'      SRNEWL
     C           WFMT      CASEQ'UP'      SRUPDR
     C                     ENDCS
     C                     ENDDO
      *
      ** End program processing
      *
     C                     MOVE '1'       *INLR
      /EJECT
      *****************************************************************
      * SRINIT  -  Initial Processing                                 *
      * Called by: Main routine                                       *
      * Calls    : SRPLAY - Batch processing in play mode             *
      *****************************************************************
     C           SRINIT    BEGSR
      *
      ** Set up copyright parameter
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ** Receive entry parameters
      *
     C           *ENTRY    PLIST
     C                     PARM           PMODE   1
      *
      ** Define data areas
      *
     C           *NAMVAR   DEFN           LDA
      *
      ** Key list for CLOAN
      *
     C           WKLON     KLIST
     C**********           KFLD           WALON   60                                          CLE148
     C                     KFLD           WALON   6                                           CLE148
     C                     KFLD           WEPAR   1
      *
      ** Key list for LOAMS
      *
     C           WKLAM     KLIST
     C**********           KFLD           WLNRF   60                                          CLE148
     C                     KFLD           WLNRF   6                                           CLE148
     C                     KFLD           WVDAT   50
     C                     KFLD           WLASN   30
      *                                                                   159256
      ** Key to FCLTY                                                     159256
      *                                                                   159256
     C           KFCLT     KLIST                                          159256
     C                     KFLD           WFCUS                           159256
     C                     KFLD           WFTYP                           159256
     C                     KFLD           WFSEQ                           159256
     C                     KFLD           WRCDT1                          159256
      *
      ** Initialise LDA
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'LE2130  'DBPGM
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVE *BLANKS   DBTXT
     C                     OUT  LDA
      *
      ** Retrieve bank details
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   PRTCD   7
     C                     PARM '*FIRST ' POPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           ************
     C                     Z-ADD1         DBASE            * DBERR 01 *
     C                     MOVEL'*FIRST'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ENDIF
     C                     ENDIF
      *
      ** Retrieve midas module details
      *
     C                     CALL 'AOMMODR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*FIRST ' POPTN
     C           SDMMOD    PARM SDMMOD    DSFDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDMMODPD'DBFILE           ************
     C                     Z-ADD2         DBASE            * DBERR 02 *
     C                     MOVEL'*FIRST'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Retrieve lending ICD
      *
     C                     CALL 'AOCLNDR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*FIRST ' POPTN
     C           SDCLND    PARM SDCLND    DSFDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCLNDPD'DBFILE           ************
     C                     Z-ADD3         DBASE            * DBERR 03 *
     C                     MOVEL'*FIRST'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                                       240968
     C                     CALL 'AOSVALR0'                                                    240968
     C                     PARM           PRTCD                                               240968
     C                     PARM SVALKK    SVALK1 20                                           240968
     C                     PARM           SVAL1 200                                           240968
     C**********           PARM *BLANK    SVALK2 20                                    240968 244314
     C                     PARM SVALKJ    SVALK2 20                                           244314
     C                     PARM           SVAL2 200                                           240968
     C                     PARM *BLANK    SVALK3 20                                           240968
     C                     PARM           SVAL3 200                                           240968
     C                     PARM *BLANK    SVALK4 20                                           240968
     C                     PARM           SVAL4 200                                           240968
     C                     PARM *BLANK    SVALK5 20                                           240968
     C                     PARM           SVAL5 200                                           240968
     C                     PARM *BLANK    SVALK6 20                                           240968
     C                     PARM           SVAL6 200                                           240968
     C                     PARM *BLANK    SVALK7 20                                           240968
     C                     PARM           SVAL7 200                                           240968
     C                     PARM *BLANK    SVALK8 20                                           240968
     C                     PARM           SVAL8 200                                           240968
     C                     PARM *BLANK    SVALK9 20                                           240968
     C                     PARM           SVAL9 200                                           240968
     C                     PARM *BLANK    SVALK0 20                                           240968
     C                     PARM           SVAL10200                                           240968
      *                                                                                       240968
     C           PRTCD     IFNE *BLANK                                                        240968
     C           *LOCK     IN   LDA                                                           240968
     C                     MOVEL'*KEY    'DBKEY                                               240968
     C                     MOVEL'SDSVALPD'DBFILE           ***************                    240968
     C                     Z-ADD005       DBASE            * DBERROR 005 *                    240968
     C                     OUT  LDA                        ************* *                    240968
     C                     EXSR *PSSR                                                         240968
     C                     ENDIF                                                              240968
     C                     MOVE SVAL11    ATHR    1                                           240968
     C                     MOVE SVAL21    ATHS    1                                           244314
      *                                                                   123857
      ** Determine if F11 is necessary for authorisation                  123857
      *                                                                   123857
     C                     MOVE '0'       *IN43                           123857
     C           BPAURV    IFEQ 'Y'                                       123857
     C                     MOVE '1'       *IN43                           123857
     C                     ENDIF                                          123857
      *
      ** Determine if Customer Lending Enhancements - Authorisation
      ** feature is installed
      *
     C                     MOVE 'CLE002'  PSARD
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           PSARD   6
     C           SCSARD    PARM SCSARD    DSFDY
     C           PRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CLE002  1
     C                     MOVE '1'       *IN37
     C                     ELSE
     C                     MOVE 'N'       CLE002
     C           PRTCD     IFNE '*NRF    '
     C           *LOCK     IN   LDA
     C                     MOVEL'SCSARDPD'DBFILE           ************
     C                     Z-ADD4         DBASE            * DBERR 04 *
     C                     MOVEL'CLE002'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *                                                                   CLE005
      ** Determine if Customer Lending Enhancements - Tranche 3           CLE005
      ** feature is installed                                             CLE005
      *                                                                   CLE005
     C                     MOVE 'CLE005'  PSARD                           CLE005
     C                     CALL 'AOSARDR0'                                CLE005
     C                     PARM *BLANKS   PRTCD                           CLE005
     C                     PARM '*KEY   ' POPTN                           CLE005
     C                     PARM           PSARD                           CLE005
     C           SCSARD    PARM SCSARD    DSFDY                           CLE005
     C           PRTCD     IFEQ *BLANKS                                   CLE005
     C                     MOVE 'Y'       CLE005  1                       CLE005
     C                     ELSE                                           CLE005
     C                     MOVE 'N'       CLE005                          CLE005
     C           PRTCD     IFNE '*NRF    '                                CLE005
     C           *LOCK     IN   LDA                                       CLE005
     C                     MOVEL'SCSARDPD'DBFILE           ************   CLE005
     C                     Z-ADD18        DBASE            * DBERR 18 *   CLE005
     C                     MOVEL'CLE005'  DBKEY            ************   CLE005
     C                     OUT  LDA                                       CLE005
     C                     EXSR *PSSR                                     CLE005
     C                     ENDIF                                          CLE005
     C                     ENDIF                                          CLE005
     C/COPY WNCPYSRC,LE2130C001
      *                                                                   CLE014
      ** Determine if CLE014 is installed                                 CLE014
      *                                                                   CLE014
     C                     CALL 'AOSARDR0'                                CLE014
     C                     PARM '       ' PRTCD                           CLE014
     C                     PARM '*VERIFY' POPTN                           CLE014
     C                     PARM 'CLE014'  PSARD                           CLE014
     C           SCSARD    PARM SCSARD    DSSDY                           CLE014
      *                                                                   CLE014
      ** Handle Database Error                                            CLE014
      *                                                                   CLE014
     C           PRTCD     IFNE *BLANKS                                   CLE014
     C           PRTCD     ANDNE'*NRF   '                                 CLE014
     C           *LOCK     IN   LDA                                       CLE014
     C                     MOVE 'SCSARDPD'DBFILE                          CLE014
     C                     MOVELPSARD     DBKEY                           CLE014
     C                     Z-ADD33        DBASE                           CLE014
     C                     OUT  LDA                                       CLE014
     C                     EXSR *PSSR                                     CLE014
     C                     ENDIF                                          CLE014
      *                                                                   CLE014
      ** CLE014 is installed                                              CLE014
      *                                                                   CLE014
     C           PRTCD     IFEQ *BLANKS                                   CLE014
     C                     MOVE 'Y'       CLE014  1                       CLE014
     C                     ELSE                                           CLE014
     C                     MOVE 'N'       CLE014                          CLE014
     C                     ENDIF                                          CLE014
      *                                                                                       202440
      **  Check if SAR CAP061 is installed                                                    202440
      *                                                                                       202440
     C                     CALL 'AOSARDR0'                                                    202440
     C                     PARM *BLANKS   PRTCD                                               202440
     C                     PARM '*KEY   ' POPTN                                               202440
     C                     PARM 'CAP061'  PSARD                                               202440
     C           SCSARD    PARM SCSARD    DSFDY                                               202440
      *                                                                                       202440
     C           PRTCD     IFEQ *BLANKS                                                       202440
     C                     MOVE 'Y'       CAP061  1                                           202440
     C                     ELSE                                                               202440
     C                     MOVE 'N'       CAP061                                              202440
     C           PRTCD     IFNE '*NRF    '                                                    202440
     C           *LOCK     IN   LDA                                                           202440
     C                     MOVEL'SCSARDPD'DBFILE           ************                       202440
     C                     Z-ADD11        DBASE            * DBERR 11 *                       202440
     C                     MOVEL'CAP061'  DBKEY            ************                       202440
     C                     OUT  LDA                                                           202440
     C                     EXSR *PSSR                                                         202440
     C                     ENDIF                                                              202440
     C                     ENDIF                                                              202440
      *                                                                                       CAS001
      **  Access Switchable SAR details for the existence of CAS001                           CAS001
      *                                                                                       CAS001
     C                     CALL 'AOSARDR0'                                                    CAS001
     C                     PARM *BLANKS   PRTCD                                               CAS001
     C                     PARM '*VERIFY 'POPTN                                               CAS001
     C                     PARM 'CAS001'  PSARD                                               CAS001
     C           SCSARD    PARM SCSARD    DSSDY                                               CAS001
      *                                                                                       CAS001
     C           PRTCD     IFNE *BLANKS                                                       CAS001
     C           PRTCD     ANDNE'*NRF   '                                                     CAS001
     C           *LOCK     IN   LDA                                                           CAS001
     C                     MOVEL'SCSARDPD'DBFILE                                              CAS001
     C                     Z-ADD30        DBASE                                               CAS001
     C                     MOVEL'CAS001'  DBKEY                                               CAS001
     C                     OUT  LDA                                                           CAS001
     C                     EXSR *PSSR                                                         CAS001
     C                     ENDIF                                                              CAS001
      *                                                                                       CAS001
     C           PRTCD     IFEQ *BLANKS                                                       CAS001
     C                     MOVE 'Y'       CAS001  1                                           CAS001
     C                     ELSE                                                               CAS001
     C                     MOVE 'N'       CAS001                                              CAS001
     C                     ENDIF                                                              CAS001
      *                                                                                       CLE028
      ** Determine if Flat Rate Personal Loans (Rule of 78s) is                               CLE028
      ** installed                                                                            CLE028
      *                                                                                       CLE028
     C                     CALL 'AOSARDR0'                                                    CLE028
     C                     PARM *BLANKS   PRTCD                                               CLE028
     C                     PARM '*VERIFY' POPTN                                               CLE028
     C                     PARM 'CLE028'  PSARD                                               CLE028
      *                                                                                       CLE028
     C           PRTCD     IFEQ *BLANKS                                                       CLE028
     C                     MOVE 'Y'       CLE028  1                                           CLE028
     C                     ELSE                                                               CLE028
     C                     MOVE 'N'       CLE028                                              CLE028
      *                                                                                       CLE028
     C           PRTCD     IFNE '*NRF    '                                                    CLE028
     C           *LOCK     IN   LDA                                                           CLE028
     C                     MOVEL'SCSARDPD'DBFILE                                              CLE028
     C                     Z-ADD39        DBASE                                               CLE028
     C                     MOVEL'CLE028'  DBKEY                                               CLE028
     C                     OUT  LDA                                                           CLE028
     C                     EXSR *PSSR                                                         CLE028
     C                     ENDIF                                                              CLE028
     C                     ENDIF                                                              CLE028
      *
      ** Set up message file for screen error messages
      ** Set up fields for screen heading
      *
     C                     MOVEL'LERMSGF 'ZAMSGF
     C                     MOVE USER      SUSER
     C                     MOVE WSID      SWSID
     C                     MOVE BJMRDT    SRUNA
      *
      ** Check mode of processing
      *
     C                     SELEC
     C           PMODE     WHEQ 'I'
     C                     OPEN LE2130DF
     C                     MOVE 'F0'      WFMT
     C           PMODE     WHEQ 'R'
     C                     OPEN LE2130DF
     C                     OPEN LE2130PD
     C                     MOVE 'F0'      WFMT
     C           PMODE     WHEQ 'P'
     C                     OPEN LE2130PD
     C                     EXSR SRPLAY
     C                     ENDSL
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRPLAY  -  Batch processing in play mode                      *
      * Called by: SRINIT - Initial processing                        *
      * Calls    : SRVKEY - Validate key fields                       *
      *            SRFMTR - Format receiving loan details             *
      *            SRCURR - Get currency details                      *
      *            SRVALD - Validate detail screen                    *
      *            SRNEWL - Update newly created loan                 *
      *            SRUPDR - Update records in files                   *
      *****************************************************************
     C           SRPLAY    BEGSR
      *
     C                     READ LE2130PD                 70
     C           *IN70     DOWEQ'0'
      *
      ** Move test harness fields to screen fields
      *
     C                     MOVE ACTN      SACTN
     C                     MOVE LNRFH     SLNRF
     C                     MOVE VDATH     SVDAT
     C                     MOVE LASNH     SLASN
     C                     MOVE CNUMH     SCNUM
     C                     MOVE CCYH      SCURR
     C                     MOVE ROLNH     SROLN
     C                     MOVE RORCH     SRORC
     C                     MOVE NRLIH     SNRLI
     C                     MOVE PRAMH     SPRAM
     C                     MOVE OLNOH     SOLNO                           138865
     C                     MOVEA'00000000'*IN,21
     C                     MOVE '0'       *IN36
     C                     MOVE '0'       *IN44                           138865
      *
      ** If valid action code, validate key fields
      *
     C           SACTN     IFNE *BLANK
     C           SACTN     ANDNE'A'
     C           SACTN     ANDNE'X'
     C           SACTN     ANDNE'R'
     C           SACTN     ANDNE'I'
     C                     MOVE '1'       *IN21
     C                     MOVEL'LET0011' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     EXSR SRVKEY
      *
      ** Format detail fields for authorisation/reversals
      *
     C                     MOVE CCYL      SCURR
     C                     MOVE CCYL      PCURR
     C                     EXSR SRCURR
     C                     MOVE A6MDIN    WMDIN
     C                     Z-ADDA6NBDP    WNBDP
     C                     Z-ADDA6SPRT    WSPRT
     C           SACTN     IFEQ 'X'
     C           SACTN     OREQ 'R'
     C                     EXSR SRFMTR
     C                     ENDIF
      *
      ** Validate detail entries
      *
     C           SACTN     IFNE 'R'
     C                     EXSR SRVALD
     C                     ENDIF
      *
      ** Update files
      *
     C           SACTN     IFEQ 'X'
     C           SNRLI     OREQ 'N'
     C                     EXSR SRUPDR
     C                     ELSE
     C                     EXSR SRNEWL
     C                     ENDIF
      *
      ** Read next test harness record
      *
     C                     READ LE2130PD                 70
     C                     ENDDO
      *
     C                     COMIT
     C                     MOVE *BLANKS   WFMT
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRSTRT  -  Validate initial screen                            *
      * Called by: Main routine                                       *
      * Calls    : SRVKEY - Validate key fields                       *
      *            SRVREV - Validate review fields                    *
      *****************************************************************
     C           SRSTRT    BEGSR
      *
      ** Clear screen fields
      *
     C           *IN38     IFEQ '0'
     C                     MOVE *BLANKS   SACTN
     C                     ENDIF
     C                     MOVE *BLANKS   SLNRF
     C                     MOVE *BLANKS   SVDAT
     C                     MOVE *BLANKS   SLASN
     C                     MOVE *BLANKS   SRLON
     C                     MOVE *BLANKS   SRVDT
     C                     MOVE *BLANKS   SRSEQ
     C                     MOVE 'N'       SRAUT
     C                     MOVE *BLANK    WWARN   1
     C                     Z-ADD0         WAMNT                           144090
     C                     MOVEA'00000000'*IN,21
     C                     MOVE '0'       *IN36
     C                     MOVE '0'       *IN44                           138865
     C                     EXSR CLEAR
      *
      ** Process screen until valid entries are input or F3 or F12
      ** is pressed
      *
     C                     WRITELE2130F0
     C           WFMT      DOUNE'F0'
     C                     WRITELE2130C1
     C                     EXFMTLE2130F1
     C                     MOVEA'00000000'*IN,21
     C                     MOVEA'000'     *IN,39
     C                     MOVE '0'       *IN36
     C                     MOVE '0'       *IN45                           138865
     C                     EXSR CLEAR
     C                     Z-ADD0         W#CNT                           135749
      *
     C                     SELEC
      *
      ** F3 is pressed, end processing
      *
     C           *INKC     WHEQ '1'
     C                     MOVE *BLANK    WFMT
     C                     LEAVE
      *
      ** F12 is pressed, return to subfile screen
      *
     C           *INKL     WHEQ '1'
     C                     MOVE 'S0'      WFMT
      *
      ** ENTER key is pressed
      *
     C                     OTHER
     C           SACTN     IFNE *BLANK
      *
      ** If valid action code, validate key fields
      *
     C           SACTN     IFNE 'A'
     C           SACTN     ANDNE'X'
     C           SACTN     ANDNE'R'
     C           SACTN     ANDNE'I'
     C           SACTN     ANDNE'E'
     C                     MOVE '1'       *IN21
     C                     MOVEL'LET0001' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     EXSR SRVKEY
     C                     ENDIF
      *
      ** Blank action code, validate review from fields
      *
     C                     ELSE
     C                     EXSR SRVREV
     C                     ENDIF
      *
     C                     ENDSL
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVKEY  -  Validate key fields                                *
      * Called by: SRSTRT - Validate initial screen                   *
      *            SRPLAY - Batch processing in play mode             *
      * Calls    : SRCAUT - Check if user is authorised to the action *
      *            SRAUTH - Validate authorisation action             *
      *            SRVDAT - Validate value date                       *
      *            SRFMTS - Format screen fields                      *
      *            SRWARN - Display warning message if loan is synd.  *   159256
      *****************************************************************
     C           SRVKEY    BEGSR
      *
      ** Originating loan is mandatory and must be a live loan
      *
     C                     MOVE SLNRF     WALON
     C                     MOVE 'A'       WEPAR
     C           WKLON     CHAINCLOAN                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C***********RECI      ANDNE'D'                                       131253
     C           RECIL     ANDNE'D'                                       131253
     C           SLNRF     OREQ *BLANK
     C                     MOVE '1'       *IN22
     C                     MOVEL'LET0002' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C**********           Z-ADDWRFAC     WOFAC  110                                          CSD027
     C                     MOVE WRFAC     WOFAC  11                                           CSD027
     C                     Z-ADDCPAM      WORAM  130
     C                     MOVE CCYL      WOCCY   3
     C                     EXSR SRCATP                                    156990
     C                     MOVE WTYP      WTYP1   1                       156990
      *                                                                   138865
      ** Save customer no. of originating loan for validation             144924
      ** subroutine                                                       144924
      *                                                                   144924
     C**********           MOVE CNUML     W#CNUM  60                                   144924 CSD027
     C                     MOVE CNUML     W#CNUM  6                                           CSD027
      *                                                                   144924
      ** Check if Originating Loan is a Parts Sold                        138865
      *                                                                   138865
     C           PTYP      IFEQ 66                                        138865
     C           PTYP      OREQ 67                                        138865
     C           PTYP      OREQ 69                                        138865
     C           PTYP      OREQ 72                                        138865
     C                     MOVE '1'       *IN45                           138865
     C                     MOVE OLNO      WOLNO   6                       138865
     C                     ENDIF                                          138865
     C/COPY WNCPYSRC,LEH00620
      *                                                                   138865
     C                     ENDIF
      *                                                                                       CLE028
      ** When CLE028 is installed, principal transfers are not allowed                        CLE028
      ** from and to flat rate personal loans                                                 CLE028
      *                                                                                       CLE028
     C           CLE028    IFEQ 'Y'                                                           CLE028
     C           *IN70     ANDEQ*OFF                                                          CLE028
     C           PTYP      ANDEQ80                                                            CLE028
     C                     MOVE '1'       *IN22                                               CLE028
     C                     MOVEL'LET0402' ZAMSID                                              CLE028
     C                     EXSR ZASNMS                                                        CLE028
     C                     ENDIF                                                              CLE028
      *
      ** Action must be valid for the user
      *
     C                     EXSR SRCAUT
      *
      ** Validate value date
      *
     C                     EXSR SRVDAT
      *
      ** Transfer sequence number must be blank for insert
      ** and must be a valid numeric for non-insert
      *
     C           SACTN     IFEQ 'I'
     C           SLASN     ANDNE*BLANKS
     C                     MOVE '1'       *IN24
     C                     MOVEL'LET0030' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     MOVELSLASN     WNUM4   40
     C                     MOVELWNUM4     WALF3   3
     C           SLASN     IFNE *BLANKS
     C           SLASN     ANDNEWALF3
     C                     MOVE '1'       *IN24
     C                     MOVEL'LET0010' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *                                                                   144090
     C           WERRF     IFEQ *BLANKS                                   144090
     C                     Z-ADD0         WAMT1                           144090
     C                     Z-ADD0         WAMT2                           144090
     C                     Z-ADD0         WAMT3                           155721
     C                     Z-ADD0         WAMT4                           155721
     C                     MOVE SLASN     WWLASN  30                      156764
     C           *LOVAL    SETLLLOAMS                                     144090
     C           WALON     CHAINLOAMS                46                   144090
     C           *IN46     DOWEQ'0'                                       144090
      *                                                                   156764
      ** If record read is the current transaction, do not include in     156764
      ** calculation of the principal of the originating loan             156764
      *                                                                   156764
     C           SACTN     IFNE 'I'                                       156764
     C           VDATK     ANDEQZDAYNO                                    156764
     C           LASN      ANDEQWWLASN                                    156764
     C                     MOVE 'N'       WINCL   1                       156764
     C                     ELSE                                           156764
     C                     MOVE 'Y'       WINCL                           156764
     C                     ENDIF                                          156764
      *                                                                   156764
     C           RECI      IFEQ 'D'                                       144090
     C           AMTP      ANDEQ'MR'                                      144090
     C           RECI      OREQ 'D'                                       144090
     C           AMTP      ANDEQ'RE'                                      144090
     C           AUTO      ANDEQ'Y'                                       144090
     C           RECI      OREQ 'D'                                       155279
     C           AMTP      ANDEQ'PF'                                      155279
     C           WINCL     ANDEQ'Y'                                       156764
     C********** VDATK     IFLE ZDAYNO                                                 144090 218331
     C           VDATK     IFLE WSVVD                                                         218331
     C                     ADD  PRAM      WAMT1                           144090
     C                     ELSE                                           144090
     C                     ADD  PRAM      WAMT2                           144090
     C                     ENDIF                                          144090
     C                     ENDIF                                          144090
      *                                                                   155721
     C           RECI      IFEQ 'D'                                       155721
     C           AMTP      ANDEQ'PI'                                      155721
     C           RECI      OREQ 'D'                                       155721
     C           AMTP      ANDEQ'PT'                                      155721
     C           VDATK     IFLE ZDAYNO                                    155721
     C                     ADD  PRAM      WAMT3                           155721
     C                     ELSE                                           155721
     C                     ADD  PRAM      WAMT4                           155721
     C                     ENDIF                                          155721
     C                     ENDIF                                          155721
      *                                                                   155721
     C                     READ LOAMS                    46               144090
     C           WALON     IFNE LNRFK                                     144090
     C                     LEAVE                                          144090
     C                     ENDIF                                          144090
     C                     ENDDO                                          144090
     C                     MOVE 'A'       WEPAR                                               238525
     C           WKLON     CHAINCLOAN                70                   144090
     C           *IN70     IFEQ '1'                                                           238525
     C           *LOCK     IN   LDA                                                           238525
     C                     MOVEL'CLOAN   'DBFILE           ************                       238525
     C                     Z-ADD20        DBASE            * DBERR 20 *                       238525
     C                     MOVELWALON     DBKEY            ************                       238525
     C                     OUT  LDA                                                           238525
     C                     EXSR *PSSR                                                         238525
     C                     ENDIF                                                              238525
     C                     ENDIF                                          144090
      *
      ** If not insert, key fields must refer to a 'Principal Transfer'
      *
     C           SACTN     IFNE 'I'
     C           WERRF     ANDEQ*BLANK
     C                     MOVE SLNRF     WLNRF
     C                     Z-ADDZDAYNO    WVDAT
     C                     MOVE SLASN     WLASN
     C           WKLAM     CHAINLOAMS                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C           AMTP      ANDNE'PF'
     C                     MOVEA'1111'    *IN,21
     C                     MOVEL'LET0026' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C           RECI      IFEQ 'R'                                       139308
     C           SACTN     ANDNE'E'                                       139308
     C                     MOVEA'1111'    *IN,21                          139308
     C                     MOVEL'LET0312' ZAMSID                          139308
     C                     EXSR ZASNMS                                    139308
     C                     ENDIF                                          139308
     C                     ENDIF
      *
      ** Determine if authorisation request is valid
      *
     C           WERRF     IFEQ *BLANK
     C           SACTN     IFEQ 'X'
     C                     EXSR SRAUTH
     C                     ENDIF
      *
      ***Reversals*and*amendments*are*only*allowed*on*the*date*of*****    135143
      ***entry********************************************************    135143
      ** Allow reversals and amendments                                   135143
      *
     C***********SACTN     IFEQ 'A'                                       135143
     C***********SACTN     OREQ 'R'                                       135143
     C***********ORED      IFNE BJRDNB                                    135143
     C***********          MOVEA'1111'    *IN,21                          135143
     C***********          MOVEL'LET0028' ZAMSID                          135143
     C***********          EXSR ZASNMS                                    135143
     C***********          ENDIF                                          135143
     C***********          ENDIF                                          135143
     C                     ENDIF
      *                                                                   159256
      ** Issue warning if changing a syndicated transaction.              159256
      *                                                                   159256
     C           SACTN     IFNE 'E'                                       159256
     C           SACTN     ANDNE*BLANK                                    159256
     C                     EXSR SRWARN                                    159256
     C           WE232     IFNE *BLANK                                    159256
     C                     MOVEA'11'      *IN,21                          159256
     C                     ENDIF                                          159256
     C                     ENDIF                                          159256
      *
      ** If no error format detail screen for interactive/record modes
      *
     C           WERRF     IFEQ *BLANK
     C           WE232     ANDEQ*BLANK                                    159256
     C           PMODE     ANDNE'P'
     C                     MOVE 'F0'      WWRTRN  2
     C                     EXSR SRFMTS
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVDAT  -  Validate value date                                *
      * Called by: SRVKEY - Validate key fields                       *
      * Calls    : None                                               *
      *****************************************************************
     C           SRVDAT    BEGSR
      *
      ** Must be entered, and in valid date format used by the system
      *
     C                     MOVE SVDAT     ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    WSVVD   50
     C           *IN99     IFEQ '1'
     C           SVDAT     OREQ *BLANKS
     C                     MOVE '1'       *IN23
     C                     MOVEL'LET0007' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C           *IN22     IFEQ '0'
     C           *IN23     ANDEQ'0'
      *
      ** For discount loans, value date must be a rollover date
      *
     C           PTYP      IFEQ 63
      *
      ** Backvaluation is allowed only on the exact last rollover date
      ** or a backvalued rollover date
      *
     C                     MOVE '1'       *IN70
     C           WSVVD     IFLT BJRDNB
     C           WSVVD     ANDNELRLD
     C                     MOVE '1'       *IN70
     C                     ENDIF
      *
      ** Forward value is allowed if it is exactly the rollover or
      ** next rollover date
      *
     C           WSVVD     IFNE NROD
     C           WSVVD     ANDNERLDT
     C           *IN70     ANDEQ'1'
     C                     MOVE '1'       *IN23
     C                     MOVEL'LET0024' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** For non-discount loans, value date must be within the
      ** life of the loan
      *
     C                     ELSE
     C           WSVVD     IFLT VDATL
     C           WSVVD     ORGT MDAT
     C           MDAT      ANDNE*ZEROS
     C                     MOVE '1'       *IN23
     C                     MOVEL'LET0024' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *                                                                   CLE014
     C           CLE014    IFEQ 'Y'                                       CLE014
     C                     MOVE *IN70     WIN70                           CLE014
     C                     MOVE SLNRF     WALON                           CLE014
     C                     MOVE 'B'       WEPAR                           CLE014
     C           WKLON     CHAINCLOAN                70                   CLE014
      *                                                                   CLE014
     C           RLDT      IFNE *ZERO                                     CLE014
     C           CCYL      ANDNENCCY                                      CLE014
      *                                                                   CLE014
      ** Back value is not allowed if a back-valued multi-currency        CLE014
      ** rollover before the value date is existing for a particular      CLE014
      ** loan.                                                            CLE014
      *                                                                   CLE014
     C           RLDT      IFLT BJRDNB                                    CLE014
     C           WSVVD     ANDLTBJRDNB                                    CLE014
     C           WSVVD     ANDGTRLDT                                      CLE014
     C                     MOVE *ON       *IN23                           CLE014
     C                     MOVEL'LET0400' ZAMSID                          CLE014
     C                     EXSR ZASNMS                                    CLE014
     C                     ELSE                                           CLE014
      *                                                                   CLE014
      ** Check if value date falls between the multi-currency rollover    CLE014
      ** date and the next working day.                                   CLE014
      *                                                                   CLE014
     C                     Z-ADDRLDT      WRLDT   50                      CLE014
     C                     EXSR SRCNWD                                    CLE014
     C           WSVVD     IFGT RLDT                                      CLE014
     C           WSVVD     ANDLTWNMCD                                     CLE014
     C                     MOVE *ON       *IN23                           CLE014
     C                     MOVEL'LET0401' ZAMSID                          CLE014
     C                     EXSR ZASNMS                                    CLE014
     C                     ENDIF                                          CLE014
     C                     ENDIF                                          CLE014
     C                     ENDIF                                          CLE014
      *                                                                   CLE014
     C                     MOVE WIN70     *IN70                           CLE014
     C                     ENDIF                                          CLE014
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************   CLE014
      /EJECT                                                              CLE014
      *****************************************************************   CLE014
      *                                                               *   CLE014
      * SRCNWD  -  Check if value date is inst multi-currency roll -  *   CLE014
      *            over date                                          *   CLE014
      *                                                               *   CLE014
      * Called by: SRVDAT subroutine                                  *   CLE014
      *                                                               *   CLE014
      * Calls:                                                        *   CLE014
      * ZFWDT    - Find nth working day from a given date             *   CLE014
      *                                                               *   CLE014
      *****************************************************************   CLE014
     C           SRCNWD    BEGSR                                          CLE014
      *                                                                   CLE014
     C                     Z-ADDWRLDT     ZDAYNO                          CLE014
     C                     MOVE BJLCCY    ZCCY                            CLE014
     C                     MOVE *BLANKS   ZLOC                            CLE014
     C                     Z-ADD1         ZNRDYS                          CLE014
     C                     EXSR ZFWDT                                     CLE014
     C                     Z-ADDZDYNBR    WNMCD   50                      CLE014
      *                                                                   CLE014
     C                     ENDSR                                          CLE014
      *                                                                   CLE014
      *****************************************************************   CLE014
      /EJECT
      *****************************************************************
      * SRSFIL  -  Subfile processing                                 *
      * Called by: Main processing                                    *
      * Calls    : SRVREV - Validate review fields                    *
      *            SRLOAD - Load subfile records                      *
      *            SRVSUB - Validate subfile entries                  *
      *            SRSPRO - Process each subfile request              *
      *****************************************************************
     C           SRSFIL    BEGSR
      *
     C                     MOVE 'S0'      WWRTRN
     C                     MOVE *BLANK    WWARN
     C                     EXSR SRLOAD
      *
     C           WFMT      DOUNE'S0'
     C                     WRITELE2130F3
     C                     WRITELE2130C1
     C                     EXFMTLE2130C0
     C                     MOVE '0'       *IN38
     C                     MOVEA'0000'    *IN,25
     C                     MOVE '0'       *IN45                           186137
     C                     EXSR CLEAR
      *
     C                     SELEC
      *
      ** ... F3 is pressed, end processing
      *
     C           *INKC     WHEQ '1'
     C                     MOVE *BLANK    WFMT
      *
      ** ... F12 is pressed, return to initial screen
      *
     C           *INKL     WHEQ '1'
     C                     MOVE 'F0'      WFMT
      *
      ** ... F9 is pressed, process insert request
      *
     C           *INKI     WHEQ '1'
     C                     MOVE 'F0'      WFMT
     C                     MOVE 'I'       SACTN
     C                     MOVE '1'       *IN38
      *
      ** ... F5 is pressed, re-display screen with refreshed details
      ** ... New review from fields entered, load fields from review
      ** ... Rollup key is pressed, load next page of records
      *
     C           *INKE     WHEQ '1'
     C           *IN74     OREQ '1'
     C           WREVW     ORNE SREVW
     C           WREVW     IFNE SREVW
     C                     EXSR SRVREV
     C                     ENDIF
     C           WERRF     IFEQ *BLANKS
     C                     EXSR SRLOAD
     C                     ENDIF
      *
      ** ... ENTER key is pressed, validate and process subfile entries
      *
     C                     OTHER
     C                     EXSR SRVSUB
     C           WERRF     IFEQ *BLANK
     C                     EXSR SRSPRO
     C                     ENDIF
     C                     ENDSL
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVSUB  -  Validate subfile entries                           *
      * Called by: SRSFIL - Subfile processing                        *
      * Calls    : SRCAUT - Check user authority                      *
      *            SRAUTH - Validate authorisation action             *
      *****************************************************************
     C           SRVSUB    BEGSR
      *
     C                     MOVE 'Y'       WFRST   1
      *
     C           *IN77     IFEQ '0'
     C                     READCLE2130S0                 73
     C                     ELSE
     C                     MOVE '1'       *IN73
     C                     ENDIF
      *
     C           *IN73     DOWEQ'0'
     C                     MOVE '0'       *IN76
     C                     MOVE '0'       *IN21
      *
      ** Action code must be A,X,R, or E
      *
     C           SLSEL     IFNE *BLANK
     C           SLSEL     ANDNE'A'
     C           SLSEL     ANDNE'X'
     C           SLSEL     ANDNE'R'
     C           SLSEL     ANDNE'E'
     C                     MOVE '1'       *IN21
     C                     MOVEL'LET0011' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** Action must be valid for the user
      *
     C           SLSEL     IFNE *BLANK
     C                     MOVE SBRCH     BRCAL
     C                     MOVE SLSEL     SACTN
     C                     EXSR SRCAUT
     C                     ENDIF
      *
      ** Determine if authorisation request is valid
      *
     C           SLSEL     IFEQ 'X'
     C                     MOVE SIUSR     IUSR
     C                     MOVE SAUSR     AUSR
     C                     MOVE SASTS     ASTS
     C                     EXSR SRAUTH
     C                     ENDIF
      *
      ***Reversals*and*amendments*are*only*allowed*on*the*date*of***      135143
      ***entry******************************************************      135143
      ** Allow reversals and amendments                                   135143
      *
     C***********SLSEL     IFEQ 'A'                                       135143
     C***********SLSEL     OREQ 'R'                                       135143
     C***********SORED     IFNE BJRDNB                                    135143
     C***********          MOVE '1'       *IN21                           135143
     C***********          MOVEL'LET0028' ZAMSID                          135143
     C***********          EXSR ZASNMS                                    135143
     C***********          ENDIF                                          135143
     C***********          ENDIF                                          135143
      *
      ** Force record to be read again
      *
     C           WERRF     IFNE *BLANK
     C           WFRST     ANDEQ'Y'
     C                     Z-ADDSRRN      SRNBR
     C                     MOVE *BLANK    WFRST
     C                     ENDIF
     C           SLSEL     IFNE *BLANK
     C           WERRF     ORNE *BLANK
     C                     MOVE '1'       *IN76
     C                     ENDIF
      *
     C                     UPDATLE2130S0
     C                     READCLE2130S0                 73
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRSPRO  -  Process each subfile request                       *
      * Called by: SRSFIL - Subfile processing                        *
      * Calls    : SRFMTS - Format screen fields                      *
      *            SRDETL - Process first detail screen               *
      *            SRNEWL - Update newly created loan                 *
      *            SRUPDR - Update records in files                   *
      *****************************************************************
     C           SRSPRO    BEGSR
      *
     C                     Z-ADD1         SRRN
      *
     C           *IN77     IFEQ '0'
     C                     READCLE2130S0                 73
     C                     ELSE
     C                     MOVE '1'       *IN73
     C                     ENDIF
      *
     C           *IN73     DOWEQ'0'
      *
      ** Get originating loan details
      *
     C                     MOVE SSLON     WALON
     C                     MOVE 'A'       WEPAR
     C           WKLON     CHAINCLOAN                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C***********RECI      ANDNE'D'                                       131253
     C           RECIL     ANDNE'D'                                       131253
     C                     MOVE '1'       *IN21
     C                     MOVE '1'       *IN76
     C                     MOVEL'LET0025' ZAMSID
     C                     EXSR ZASNMS
     C                     UPDATLE2130S0
     C                     Z-ADDSRRN      SRNBR
     C                     LEAVE
     C                     ELSE                                           138865
      *                                                                   138865
      ** Check if Originating Loan is a Parts Sold                        138865
      *                                                                   138865
     C           PTYP      IFEQ 66                                        138865
     C           PTYP      OREQ 67                                        138865
     C           PTYP      OREQ 69                                        138865
     C           PTYP      OREQ 72                                        138865
     C                     MOVE '1'       *IN45                           138865
     C                     MOVE OLNO      WOLNO   6                       138865
     C                     ENDIF                                          138865
      *                                                                   138865
     C                     ENDIF
      *                                                                   144090
     C           WERRF     IFEQ *BLANKS                                   144090
     C                     Z-ADD0         WAMT1  150                      144090
     C                     Z-ADD0         WAMT2  150                      144090
     C                     Z-ADD0         WAMT3  150                      155721
     C                     Z-ADD0         WAMT4  150                      155721
     C                     MOVE SSSEQ     WWLASN                          156764
     C           *LOVAL    SETLLLOAMS                                     144090
     C           WALON     CHAINLOAMS                46                   144090
     C           *IN46     DOWEQ'0'                                       144090
      *                                                                   156764
      ** If record read is the current transaction, do not include in     156764
      ** calculation of the principal of the originating loan             156764
      *                                                                   156764
     C           SACTN     IFNE 'I'                                       156764
     C           VDATK     ANDEQSHVDT                                     156764
     C           LASN      ANDEQWWLASN                                    156764
     C                     MOVE 'N'       WINCL                           156764
     C                     ELSE                                           156764
     C                     MOVE 'Y'       WINCL                           156764
     C                     ENDIF                                          156764
      *                                                                   156764
     C           RECI      IFEQ 'D'                                       144090
     C           AMTP      ANDEQ'MR'                                      144090
     C           RECI      OREQ 'D'                                       144090
     C           AMTP      ANDEQ'RE'                                      144090
     C           AUTO      ANDEQ'Y'                                       144090
     C           RECI      OREQ 'D'                                       155279
     C           AMTP      ANDEQ'PF'                                      155279
     C           WINCL     ANDEQ'Y'                                       156764
     C           VDATK     IFLE SHVDT                                     144090
     C                     ADD  PRAM      WAMT1                           144090
     C                     ELSE                                           144090
     C                     ADD  PRAM      WAMT2                           144090
     C                     ENDIF                                          144090
     C                     ENDIF                                          144090
      *                                                                   155721
     C           RECI      IFEQ 'D'                                       155721
     C           AMTP      ANDEQ'PI'                                      155721
     C           RECI      OREQ 'D'                                       155721
     C           AMTP      ANDEQ'PT'                                      155721
     C           VDATK     IFLE SHVDT                                     155721
     C                     ADD  PRAM      WAMT3                           155721
     C                     ELSE                                           155721
     C                     ADD  PRAM      WAMT4                           155721
     C                     ENDIF                                          155721
     C                     ENDIF                                          155721
      *                                                                   155721
     C                     READ LOAMS                    46               144090
     C           WALON     IFNE LNRFK                                     144090
     C                     LEAVE                                          144090
     C                     ENDIF                                          144090
     C                     ENDDO                                          144090
     C           WKLON     CHAINCLOAN                70                   144090
     C                     ENDIF                                          144090
      *
      ** Get principal transfer details
      *
     C                     MOVE SSLON     WLNRF
     C                     Z-ADDSHVDT     WVDAT
     C                     MOVE SSSEQ     WLASN
     C           WKLAM     CHAINLOAMS                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C           RECI      ANDNE'D'
     C           SLSEL     ANDNE'E'
     C                     MOVE '1'       *IN21
     C                     MOVE '1'       *IN76
     C                     MOVEL'LET0026' ZAMSID
     C                     EXSR ZASNMS
     C                     UPDATLE2130S0
     C                     Z-ADDSRRN      SRNBR
     C                     LEAVE
     C                     ENDIF
      *
      ** Format detail screen fields
      *
     C                     MOVE SLSEL     SACTN
     C                     MOVE SSLON     SLNRF
     C                     MOVE SADAT     SVDAT
     C                     MOVE SSSEQ     SLASN
     C                     EXSR SRFMTS
      *
      ** Process selected subfile record
      *
     C           WFMT      DOUEQ*BLANKS
     C           WFMT      OREQ 'F0'
     C           WFMT      OREQ 'S0'
     C           WFMT      CASEQ'D1'      SRDETL
     C           WFMT      CASEQ'WR'      SRNEWL
     C           WFMT      CASEQ'UP'      SRUPDR
     C                     ENDCS
     C                     ENDDO
      *
      ** If F3 is pressed, end processing
      ** If F12 is pressed, cancel processing on the said record
      *
     C                     SELEC
     C           WFMT      WHEQ *BLANKS
     C                     LEAVE
     C           *INKL     WHEQ '1'
     C                     MOVE *BLANK    SLSEL
     C                     UPDATLE2130S0
     C                     Z-ADDSRRN      SRNBR
     C                     LEAVE
     C                     OTHER
     C                     MOVE *BLANK    SLSEL
     C                     UPDATLE2130S0
     C                     Z-ADDSRRN      SRNBR
     C                     ENDSL
      *
     C                     READCLE2130S0                 73
     C                     ENDDO
      *
      ** Re-load subfile after each successful update
      *
     C           WERRF     IFEQ *BLANK
     C           *INKL     ANDEQ'0'
     C           WFMT      ANDNE*BLANK
     C                     EXSR SRLOAD
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRDETL  -  Process first detail screen                        *
      * Called by: Main routine                                       *
      *            SRSRPO - Subfile processing                        *
      * Calls    : SRVALD - Validate detail screen                    *
      *            SRWARN - Display warning message if loan is synd.  *   159256
      *****************************************************************
     C           SRDETL    BEGSR
      *
      ** Perform detail screen processing until F3 or F12 is pressed
      ** or record being processed is valid
      *
      ** Issue warning if loan is a syndicated loan (if called from       159256
      ** subfile processing).                                             159256
      *                                                                   159256
     C           SACTN     IFNE 'E'                                       159256
     C           SACTN     ANDNE'I'                                       159256
     C           WWRTRN    ANDEQ'S0'                                      159256
     C                     EXSR SRWARN                                    159256
     C                     ENDIF                                          159256
      *                                                                   159256
     C           WFMT      DOUNE'D1'
     C                     WRITELE2130C1
     C                     EXFMTLE2130F2
     C                     MOVEA'0000'    *IN,29
     C                     EXSR CLEAR
      *
     C                     SELEC
      *
      ** F3 is pressed, end processing
      *
     C           *INKC     WHEQ '1'
     C                     MOVE *BLANK    WFMT
      *
      ** F12 is pressed, return to initial or subfile screen
      *
     C           *INKL     WHEQ '1'
     C           WWRTRN    IFEQ 'S0'
     C           *IN38     OREQ '1'
     C                     MOVE 'S0'      WFMT    2
     C                     ELSE
     C                     MOVE 'F0'      WFMT
     C                     ENDIF
      *
      ** F10 is pressed, delete record
      *
     C           *INKJ     WHEQ '1'
     C           SACTN     IFNE 'R'
     C                     MOVEL'LET0012' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C           SNRLI     IFEQ 'Y'
     C                     MOVE 'WR'      WFMT
     C                     ELSE
     C                     MOVE 'UP'      WFMT
     C                     ENDIF
     C                     ENDIF
      *
      ** F11 is pressed, authorise loan
      *
     C           *INKK     WHEQ '1'
     C           SACTN     IFNE 'X'
     C                     MOVEL'LET0013' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     EXSR SRVALD
     C           WERRF     IFEQ *BLANK
     C           SNRLI     IFEQ 'Y'                                       123227
     C                     MOVE 'WR'      WFMT                            123227
     C                     ELSE                                           123227
     C                     MOVE 'UP'      WFMT
     C                     ENDIF                                          123227
     C                     ENDIF
     C                     ENDIF
      *
      ** Enter key is pressed
      *
     C                     OTHER
     C                     SELEC
      *
      ** ... Instruct user to press F10 to delete the record
      *
     C           SACTN     WHEQ 'R'
     C                     MOVEL'LET0014' ZAMSID
     C                     EXSR ZASNMS
      *
      ** ... Instruct user to press F11 to authorise the record
      *
     C           SACTN     WHEQ 'X'
     C********** BPAURV    IFEQ 'N'                                                    123857 197084
     C           BPAURV    IFNE 'Y'                                                           197084
     C                     MOVEL'LET0015' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE                                           123857
     C                     EXSR SRVALD                                    135749
     C           WERRF     IFEQ *BLANK                                    123857
     C           SNRLI     IFEQ 'Y'                                       123857
     C                     MOVE 'WR'      WFMT                            123857
     C                     ELSE                                           123857
     C                     MOVE 'UP'      WFMT                            123857
     C                     ENDIF                                          123857
     C                     ENDIF                                          123857
     C                     ENDIF                                          123857
      *
      ** ... validate fields and proceed with updates for insert/amend
      *
     C           SACTN     WHEQ 'I'
     C           SACTN     OREQ 'A'
     C                     EXSR SRVALD
     C           WERRF     IFEQ *BLANKS
     C           SNRLI     IFEQ 'Y'
     C                     MOVE 'WR'      WFMT
     C                     ELSE
     C                     MOVE 'UP'      WFMT
     C                     ENDIF
     C                     ENDIF
      *
      ** ... for enquiry, proceed to detail/subfile screen
      *
     C                     OTHER
     C           WWRTRN    IFEQ 'S0'
     C                     MOVE 'S0'      WFMT
     C                     ELSE
     C                     MOVE 'F0'      WFMT
     C                     ENDIF
     C                     ENDSL
      *
     C                     ENDSL
     C                     ENDDO
      *
      ** Perform window processing for successful detail processing
      *
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
      *
     C/COPY WNCPYSRC,LE2130MOV1
      *
      **  Call window manager WN0010
      *
     C                     CALL 'WN0010'
     C                     PARM 'LE2130'  #PGM   10
     C                     PARM           KEY     2
     C                     PARM SACTN     ACTION  1
     C                     PARM           DATA
     C                     PARM *BLANK    #RTRN   7
     C                     PARM           SPARE 256
      *
      ** Process return code
      *
     C                     SELEC
     C           #RTRN     WHEQ 'Y2U9999'
     C                     MOVE *BLANK    WFMT
     C           #RTRN     WHEQ 'USR0790'
     C                     MOVE 'D1'      WFMT
     C           #RTRN     WHNE *BLANKS
     C                     MOVEL#RTRN     ZAMSID
     C***********          MOVEL'WNMSGF'  ZAMSGF                          122052
     C                     MOVEL'WNMSGF  'ZAMSGF                          122052
     C                     EXSR ZASNMS
     C                     MOVEL'LERMSGF 'ZAMSGF
     C                     ENDSL
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVALD  -  Validate detail screen                             *
      * Called by: SRDETL - Process detail screen                     *
      *            SRPLAY - Batch processing in play mode             *
      * Calls    : None                                               *
      *****************************************************************
     C           SRVALD    BEGSR
      *
     C                     MOVEA'0000'    *IN,29
     C                     MOVE '0'       *IN36
     C                     MOVE '0'       *IN44                           138865
      *                                                                   135749
      *  Issue a warning message if originating loan has PS's attached    135749
      *  to it.                                                           135749
     C           W#CNT     IFEQ 0                                         135749
      *                                                                   135749
     C**********           MOVE SLNRF     W#OLNO  60                                   135749 CSD027
     C                     MOVE SLNRF     W#OLNO  6                                           CSD027
     C           W#OLNO    CHAINPSOLD                80                   135749
      *                                                                   135749
     C           *IN80     IFEQ *OFF                                      135749
     C                     MOVEL'LET0305' ZAMSID                          135749
     C                     EXSR ZASNMS                                    135749
     C                     ADD  1         W#CNT   20                      135749
     C                     ENDIF                                          135749
      *                                                                   135749
     C                     ENDIF                                          135749
      *
      ** For insert, validate all fields
      ** Otherwise, validate transfer amount only
      *
     C           SACTN     IFEQ 'I'
      *
      ** VALIDATE NEW LOAN INDICATOR
      ** ... defaults to N, must be Y or N when entered
      *
     C           SNRLI     IFEQ *BLANK
     C                     MOVE 'N'       SNRLI
     C                     ELSE
     C           SNRLI     IFNE 'Y'
     C           SNRLI     ANDNE'N'
     C                     MOVE '1'       *IN30
     C                     MOVEL'LET0016' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** VALIDATE RECEIVING LOAN
      ** ... must be blank for new loans as the system will assign
      ** an automatic loan number
      *
     C           SNRLI     IFEQ 'Y'
     C           SROLN     IFNE *BLANKS
     C                     MOVE '1'       *IN29
     C                     MOVEL'LET0031' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     MOVE SCURR     WCURR
      *
      ** ... for existing loans, must be entered, existing in the
      ** system and does not equal originating loan
      *
     C                     ELSE
      *
     C           SROLN     IFEQ *BLANKS
     C                     MOVE '1'       *IN29
     C                     MOVEL'LET0017' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     MOVE SROLN     WALON
     C                     MOVE WEPAR     WRTYP   1                                           213957
     C                     MOVE 'A'       WEPAR                                               212149
     C           WKLON     CHAINCLOAN                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C***********RECI      ANDNE'D'                                       131253
     C           RECIL     ANDNE'D'                                       131253
      *                                                                   131253
     C           RECIL     IFNE 'M'                                       131253
     C           RATF      ORNE 'Y'                                       131253
     C           CLE005    ORNE 'Y'                                       131253
     C                     MOVE '1'       *IN29
     C                     MOVEL'LET0018' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *                                                                                       CLE028
     C                     ELSE                                                               CLE028
      *                                                                                       CLE028
      ** When CLE028 is installed, principal transfers are not allowed                        CLE028
      ** from and to flat rate personal loans                                                 CLE028
      *                                                                                       CLE028
     C           CLE028    IFEQ 'Y'                                                           CLE028
     C           PTYP      ANDEQ80                                                            CLE028
     C                     MOVE '1'       *IN29                                               CLE028
     C                     MOVEL'LET0402' ZAMSID                                              CLE028
     C                     EXSR ZASNMS                                                        CLE028
     C                     ENDIF                                                              CLE028
      *                                                                                       CLE028
     C                     ENDIF                                          131253
     C                     MOVE CCYL      WCURR   3
     C                     EXSR SRCATP                                    156990
     C                     MOVE WTYP      WTYP2   1                       156990
      *                                                                   131253
      *                                                                   158600
     C                     ENDIF
      *                                                                   158600
     C           PTYP      IFEQ 63                                        158600
      *                                                                   158600
      ** Backvaluation is allowed only on the exact last rollover date    158600
      ** or a backvalued rollover date                                    158600
      *                                                                   158600
     C                     MOVE '1'       *IN70                           158600
     C           WSVVD     IFLT BJRDNB                                    158600
     C           WSVVD     ANDNELRLD                                      158600
     C                     MOVE '1'       *IN70                           158600
     C                     ENDIF                                          158600
      *                                                                   158600
      ** Forward value is allowed if it is exactly the rollover or        158600
      ** next rollover date                                               158600
      *                                                                   158600
     C           WSVVD     IFNE NROD                                      158600
     C           WSVVD     ANDNERLDT                                      158600
     C           *IN70     ANDEQ'1'                                       158600
     C                     MOVE '1'       *IN29                           158600
     C                     MOVEL'LET9001' ZAMSID                          158600
     C                     EXSR ZASNMS                                    158600
     C                     ENDIF                                          158600
      *                                                                   158600
      ** For non-discount loans, value date must be within the            158600
      ** life of the loan                                                 158600
      *                                                                   158600
     C                     ELSE                                           158600
     C           WSVVD     IFLT VDATL                                     158600
     C           WSVVD     ORGT MDAT                                      158600
     C           MDAT      ANDNE*ZEROS                                    158600
     C                     MOVE '1'       *IN29                           158600
     C                     MOVEL'LET9001' ZAMSID                          158600
     C                     EXSR ZASNMS                                    158600
     C                     ENDIF                                          158600
     C                     ENDIF                                          158600
      *                                                                   158600
     C           WTYP1     IFNE WTYP2                                     156990
     C                     MOVE '1'       *IN29                           156990
     C                     MOVEL'LET0315' ZAMSID                          156990
     C                     EXSR ZASNMS                                    156990
     C                     ENDIF                                          156990
      *
     C           SROLN     IFEQ SLNRF
     C                     MOVE '1'       *IN29
     C                     MOVEL'LET0042' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** If receiving loan is an existing loan, transfer should occur
      ** only for same syndicates.  Also, it should not be allowed
      ** between a syndicated and a non-syndicated loan.
      ** This means facilities should be the same.
      *
     C           *IN29     IFEQ '0'
     C           *IN30     ANDEQ'0'
     C           WOFAC     ANDNEWRFAC
     C                     MOVE '1'       *IN29
     C                     MOVEL'LET0029' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** Currency must be the same as that of the originating loan
      *
     C           WCURR     IFNE WOCCY
     C                     MOVE '1'       *IN29
     C                     MOVEL'LET0045' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00621
      *                                                                                       213957
     C                     MOVE WRTYP     WEPAR                                               213957
      *
      ** VALIDATE BRANCH
      ** ... if blank, defaulted to the branch of the originating loan
      ** for new loans, or to the branch of the receiving loan for
      ** existing loan
      *
     C           SBRCA     IFEQ *BLANK
     C                     MOVE BRCAL     SBRCA
     C                     ELSE
     C***********          CALL 'AOBRCHR0'                                121783
     C                     CALL 'AOBRCHR1'                                121783
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM SBRCA     PBRCA   3
     C           SDBRCH    PARM SDBRCH    DSSDY                           121783
     C***********SDBRCH    PARM SDBRCH    DSFDY                           121783
     C           PRTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN36
     C                     MOVEL'LET0043' ZAMSID
     C                     EXSR ZASNMS
     C           PRTCD     IFEQ '*NOSEL  '
     C                     MOVE *BLANKS   SBRCA
     C                     ENDIF
     C                     ELSE
     C                     MOVE A8BRCD    SBRCA
     C                     ENDIF
     C                     ENDIF
     C                     MOVE SBRCA     WROBR   3
      *
      ** ... branch input must also be valid for the user
      *
     C           *IN36     IFEQ '0'
     C                     Z-ADD*ZERO     @ERR
     C                     CALL 'ZVACTBU'
     C                     PARM SACTN     @ZACTN
     C                     PARM SBRCA     @ZBR
     C                     PARM           @ERR
     C           @ERR      IFEQ 1
     C                     MOVE '1'       *IN36
     C                     MOVEL'LET0303' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C           @ERR      IFEQ 2
     C                     MOVE '1'       *IN36
     C                     MOVEL'LET0304' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** ... if transfer is to an existing loan, branch must equal
      ** the receiving loan's branch
      *
     C           *IN36     IFEQ '0'
     C           SNRLI     ANDEQ'N'
     C           SBRCA     ANDNEBRCAL
     C                     MOVE '1'       *IN36
     C                     MOVEL'LET0044' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** VALIDATE RECEIVING CUSTOMER
      ** ... a mandatory field
      *
     C           SRORC     IFEQ *BLANKS
     C                     MOVE '1'       *IN31
     C                     MOVEL'LET0027' ZAMSID
     C                     EXSR ZASNMS
      *
      ** ... must exist in the system
      *
     C                     ELSE
     C                     MOVE SRORC     PCUST
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           PCUST
     C                     PARM *BLANKS   PKYST
     C           SDCUST    PARM SDCUST    DSSDY
     C           PRTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN31
     C                     MOVEL'LET0020' ZAMSID
     C                     EXSR ZASNMS
     C           PRTCD     IFEQ '*NOSEL  '
     C                     MOVE *BLANKS   SRORC
     C                     ENDIF
     C                     ELSE
     C                     MOVE *BLANKS   SRORC
     C                     MOVELBBCUST    SRORC
     C**********           MOVELBBCUST    WRORC   60                                          CSD027
     C                     MOVELBBCUST    WRORC   6                                           CSD027
     C                     ENDIF
     C                     ENDIF
      *
      ** ... generate a warning message when transferring to a new
      ** loan, if originating and receiving customers are different
      *
     C           *IN31     IFEQ '0'
     C           SNRLI     IFEQ 'Y'
     C***********WRORC     ANDNECNUML                                     144924
     C           WRORC     ANDNEW#CNUM                                    144924
     C***********SNRLI     ANDEQ'Y'                                       144924
      *
     C           WWARN     IFEQ *BLANK
     C           WWARN     OREQ 'Y'
     C           WRORC     ANDNEW1RCN
     C**********           Z-ADDWRORC     W1RCN   60                                          CSD027
     C                     MOVE WRORC     W1RCN   6                                           CSD027
     C                     MOVE 'Y'       WWARN
     C                     MOVE '1'       *IN31
     C                     MOVEL'LET0021' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** ... if transfer is to an existing loan, customers of
      ** originating and receiving loans must be the same
      *
     C           SNRLI     IFEQ 'N'
     C           WRORC     ANDNECNUML
     C                     MOVE '1'       *IN31
     C                     MOVEL'LET0032' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *                                                                   138865
      ** VALIDATE ORIGINAL LOAN OF RECEIVING PARTS SOLD                   138865
      ** ... perform validation only if field is displayed                138865
      *                                                                   138865
     C           *IN45     IFEQ '1'                                       138865
     C           SNRLI     IFEQ 'Y'                                       138865
      *                                                                   138865
      ** ... if receiving loan is a new loan generate warning message     138865
      ** if its Original Loan is blank ...                                138865
      *                                                                   138865
     C           SOLNO     IFEQ *BLANKS                                   138865
      *                                                                   138865
     C           *IN44     IFEQ '0'                                       138865
     C           WWARN     IFEQ *BLANKS                                   138865
     C           WWARN     OREQ 'Y'                                       138865
     C           SOLNO     ANDEQ*BLANKS                                   138865
     C                     MOVE 'Y'       WWARN                           138865
     C                     MOVE '1'       *IN44                           138865
     C                     MOVE WOLNO     SOLNO                           138865
     C                     MOVEL'LET0306' ZAMSID                          138865
     C                     EXSR ZASNMS                                    138865
     C                     ENDIF                                          138865
     C                     ENDIF                                          138865
      *                                                                   138865
     C                     ELSE                                           138865
      *                                                                   138865
      ** ... if Original Loan is entered, it should be a 'live' loan      138865
      ** on the system and must be linked to the same facility as the     138865
      ** original loan of the 'from' loan number ...                      138865
      *                                                                   138865
     C                     MOVE SOLNO     WALON                           138865
     C           WKLON     CHAINCLOAN                70                   138865
     C           *IN70     IFEQ '1'                                       138865
     C           *IN70     OREQ '0'                                       138865
     C           RECIL     ANDNE'D'                                       138865
     C                     MOVE '1'       *IN44                           138865
     C                     MOVEL'LET0307' ZAMSID                          138865
     C                     EXSR ZASNMS                                    138865
     C                     ELSE                                           138865
     C           WOFAC     IFNE WRFAC                                     138865
     C                     MOVE '1'       *IN44                           138865
     C                     MOVEL'LET0308' ZAMSID                          138865
     C                     EXSR ZASNMS                                    138865
     C                     ENDIF                                          138865
     C                     ENDIF                                          138865
      *                                                                   138865
     C                     ENDIF                                          138865
      *                                                                   138865
     C                     ELSE                                           138865
      *                                                                   138865
      ** ... Original Loan must not be entered if Receiving Loan is       138865
      ** not a new loan ...                                               138865
      *                                                                   138865
     C           SOLNO     IFNE *BLANKS                                   138865
     C                     MOVE '1'       *IN44                           138865
     C                     MOVEL'LET0309' ZAMSID                          138865
     C                     EXSR ZASNMS                                    138865
     C                     ENDIF                                          138865
      *                                                                   138865
     C                     ENDIF                                          138865
     C                     ENDIF                                          138865
      *
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00622
      *
      ** VALIDATE TRANSFER AMOUNT
      *
     C           SPRAM     IFNE *BLANKS
     C                     MOVE *BLANKS   PSCRF
     C                     MOVE SPRAM     PSCRF
     C                     Z-ADDWNBDP     PNDEC
     C           13        SUB  WNBDP     PNDIG
     C                     CALL 'ZALIGN'
     C                     PARM *BLANKS   PRTCD
     C                     PARM           PSCRF  16
     C                     PARM           PNDEC   10
     C                     PARM           PNDIG   20
     C                     PARM *BLANKS   PRVAL  16
     C                     MOVE PRVAL     WSVAM  130
     C                     ENDIF
      *
      ** ... a valid non-zero amount not exceeding the current
      ** oustanding amount of the originating loan must be entered
      *
     C           PRTCD     IFNE *BLANKS
     C           SPRAM     OREQ *BLANKS
     C           WSVAM     OREQ *ZEROS
     C                     MOVE '1'       *IN32
     C                     MOVEL'LET0022' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     ADD  WAMT3     WORAM                           155721
     C                     Z-ADD*ZEROS    WAMT3                           155721
     C           WSVAM     IFGT WORAM
     C                     MOVE '1'       *IN32
     C                     MOVEL'LET0023' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE                                           144090
     C           WORAM     SUB  WAMT1     WDIFF  150                      144090
     C           WSVAM     IFGT WDIFF                                     144090
     C                     MOVE '1'       *IN32                           144090
     C                     MOVEL'LET0310' ZAMSID                          144090
     C                     EXSR ZASNMS                                    144090
     C                     ELSE                                           144090
     C                     ADD  WAMT4     WDIFF                           155721
     C                     SUB  WAMT2     WDIFF                           144090
     C                     Z-ADD*ZEROS    WAMT4                           155721
     C           WWARN     IFEQ *BLANKS                                   144090
     C           WSVAM     ANDGTWDIFF                                     144090
     C           WWARN     OREQ 'Y'                                       144090
     C           WSVAM     ANDNEWAMNT                                     144090
     C           WSVAM     ANDGTWDIFF                                     144090
     C                     Z-ADDWSVAM     WAMNT  130                      144090
     C                     MOVEL'Y'       WWARN                           144090
     C                     MOVE '1'       *IN32                           144090
     C                     MOVEL'LET0311' ZAMSID                          144090
     C                     EXSR ZASNMS                                    144090
     C                     ENDIF                                          144090
     C                     ENDIF                                          144090
     C                     ENDIF
     C                     ENDIF
      *
     C**********           Z-ADD*ZEROS    WLOANO  60                                   155721 CLE148
     C**********           Z-ADD*ZEROS    WLOANR  60                                   155721 CLE148
     C                     MOVEL*BLANKS   WLOANO  6                                           CLE148
     C                     MOVEL*BLANKS   WLOANR  6                                           CLE148
     C                     MOVE 'N'       WPARTF  1                       135349
     C                     MOVE 'N'       WPARTT  1                       135349
     C                     MOVE SLNRF     WALON                           135349
     C                     MOVE 'A'       WEPAR                                               238525
     C           WKLON     CHAINCLOAN                70                   135349
     C           *IN70     IFEQ '0'                                                           238525
     C**********           MOVE MLNR      MLNRO   60                                   135349 CLE148
     C                     MOVE MLNR      MLNRO   6                                           CLE148
     C                     ELSE                                                               238525
     C           *LOCK     IN   LDA                                                           238525
     C                     MOVEL'CLOAN   'DBFILE           ************                       238525
     C                     Z-ADD19        DBASE            * DBERR 19 *                       238525
     C                     MOVELWALON     DBKEY            ************                       238525
     C                     OUT  LDA                                                           238525
     C                     EXSR *PSSR                                                         238525
     C                     ENDIF                                                              238525
      *                                                                   135349
      ** Check if the originating loan is a parts sold or a parts pur -   135349
      ** chased                                                           135349
      *                                                                   135349
     C           PTYP      IFEQ 66                                        135349
     C           PTYP      OREQ 67                                        135349
     C           PTYP      OREQ 69                                        135349
     C           CLE005    ANDEQ'Y'                                       135349
     C           PTYP      OREQ 72                                        135349
     C           CLE005    ANDEQ'Y'                                       135349
     C********** MLNRO     ORNE 0                                                      135349 CLE148
     C           MLNRO     ORNE *BLANKS                                                       CLE148
      *                                                                   135349
      ** If loan is a parts purchased, Move mirror loan to original       135349
      ** loan work field else, move the original number of the origi      135349
      ** nating loan.                                                     135349
      *                                                                   135349
     C********** MLNRO     IFNE 0                                                      135349 CLE148
     C           MLNRO     IFNE *BLANKS                                                       CLE148
     C                     MOVE MLNRO     WALON                           135349
     C                     ELSE                                           135349
     C                     MOVE OLNO      WALON                           135349
     C                     ENDIF                                          135349
      *                                                                   155721
     C                     MOVE WALON     WLOANO                          155721
      *                                                                   135349
     C                     MOVE 'A'       WEPAR                           135349
     C           WKLON     CHAINCLOAN                70                   135349
     C                     Z-ADDPSAM      WOOPSM 130                      135349
      *                                                                   155721
      ** Check for principal increases of all parts solds of this loan    155721
      ** which could possibly affect the parts sold amount as of this     155721
      ** day                                                              155721
      *                                                                   155721
     C**********           MOVE WLOANO    WPARTS  60                                   155721 CSD027
     C                     MOVE WLOANO    WPARTS  6                                           CSD027
     C                     EXSR SRPSTR                                    155721
      *                                                                   155721
     C                     ADD  WAMTS     WOOPSM                          155721
     C                     MOVE 'Y'       WPARTF                          135349
     C                     ENDIF                                          135349
      *                                                                   135349
     C           SROLN     IFNE *BLANK                                    135349
     C                     MOVE SROLN     WALON                           135349
     C           WKLON     CHAINCLOAN                70                   135349
     C**********           MOVE MLNR      MLNRR   60                                   135349 CLE148
     C                     MOVE MLNR      MLNRR   6                                           CLE148
     C                     ENDIF                                          135349
      *                                                                   135349
      ** Check if the receiving loan is a parts sold or a parts pur -     135349
      ** chased                                                           135349
      *                                                                   135349
     C           PTYP      IFEQ 66                                        135349
     C           SROLN     ANDNE*BLANK                                    135349
     C           PTYP      OREQ 67                                        135349
     C           SROLN     ANDNE*BLANK                                    135349
     C           PTYP      OREQ 69                                        135349
     C           CLE005    ANDEQ'Y'                                       135349
     C           SROLN     ANDNE*BLANK                                    135349
     C           PTYP      OREQ 72                                        135349
     C           CLE005    ANDEQ'Y'                                       135349
     C           SROLN     ANDNE*BLANK                                    135349
     C********** MLNRR     ORNE 0                                                      135349 CLE148
     C           MLNRR     ORNE *BLANKS                                                       CLE148
     C           SROLN     ANDNE*BLANK                                    135349
     C           SNRLI     OREQ 'Y'                                       135349
     C           SOLNO     ANDNE*BLANK                                    135349
      *                                                                   135349
      ** If loan is a parts purchased, Move mirror loan to original       135349
      ** loan work field else, move the original loan number of the       135349
      ** receiving loan.                                                  135349
      *                                                                   135349
     C********** MLNRR     IFNE 0                                                      135349 CLE148
     C           MLNRR     IFNE *BLANKS                                                       CLE148
     C                     MOVE MLNRR     WALON                           135349
     C                     ELSE                                           135349
     C           SOLNO     IFNE *BLANK                                    135349
     C                     MOVE SOLNO     WALON                           135349
     C                     ELSE                                           135349
     C                     MOVE OLNO      WALON                           135349
     C                     ENDIF                                          135349
     C                     ENDIF                                          135349
      *                                                                   155721
     C                     MOVE WALON     WLOANR                          155721
      *                                                                   135349
     C                     MOVE 'A'       WEPAR                           135349
     C           WKLON     CHAINCLOAN                70                   135349
     C                     Z-ADDCPAM      WORCPM 130                      135349
     C                     Z-ADDPSAM      WORPSM 130                      135349
      *                                                                   155721
      ** Check all loan amendments of all parts sold by this loan         155721
      ** which could possibly affect the parts sold amount and prin-      155721
      ** cipal amount as of today.                                        155721
      *                                                                   155721
     C                     MOVE WLOANR    WPARTS                          155721
     C                     EXSR SRPSTR                                    155721
     C**********           MOVE WLOANR    WLOAN   60                                   155721 CLE148
     C                     MOVE WLOANR    WLOAN   6                                           CLE148
     C                     EXSR SRLNTR                                    155721
      *                                                                   155721
     C                     ADD  WAMTS     WORPSM                          155721
     C                     ADD  WAMTL     WORCPM                          155721
      *                                                                   155721
     C           WLOANO    IFEQ WLOANR                                    155721
     C                     Z-ADDWSVAM     WRSUM  130                      155721
     C                     ELSE                                           155721
     C           WORPSM    ADD  WSVAM     WRSUM  130                      135349
     C                     ENDIF                                          155721
      *                                                                   155721
     C                     MOVE 'Y'       WPARTT                          135349
     C                     ENDIF                                          135349
      *                                                                   135349
      ** If ps or pp transaction and insert, check if the transfer        135349
      ** amount plus the receiving loan part sold amount will exceed      135349
      ** the original current principal amount.                           135349
      *                                                                   135349
     C           SACTN     IFEQ 'I'                                       135349
     C           WPARTF    ANDEQ'Y'                                       135349
     C           SACTN     OREQ 'I'                                       135349
     C           WPARTT    ANDEQ'Y'                                       135349
      *                                                                   135349
     C           WPARTF    IFEQ 'Y'                                       135349
      *                                                                   135349
      ** Amount greater than the current sold amount of the origi         135349
      ** nating loan send an error message                                135349
      *                                                                   135349
     C           WSVAM     IFGT WOOPSM                                    135349
     C                     MOVE '1'       *IN32                           135349
     C                     MOVEL'LET0314' ZAMSID                          135349
     C                     EXSR ZASNMS                                    135349
     C                     ENDIF                                          135349
     C                     MOVE 'N'       WPARTF                          155721
     C                     ENDIF                                          135349
      *                                                                   135349
     C           WPARTT    IFEQ 'Y'                                       135349
      *                                                                   135349
      ** Amount greater than the current principal amount of the recei    135349
      ** ving loan send an error message.                                 135349
      *                                                                   135349
     C           WRSUM     IFGT WORCPM                                    135349
     C                     MOVE '1'       *IN32                           135349
     C                     MOVEL'LET0313' ZAMSID                          135349
     C                     EXSR ZASNMS                                    135349
     C                     ENDIF                                          135349
     C                     MOVE 'N'       WPARTT                          155721
     C                     ENDIF                                          135349
      *                                                                   135349
     C                     ENDIF                                          135349
      *                                                                   135349
      ** Else, If amend and still a ps or pp transaction, restore         135349
      ** first the receiving loan ps amount then check if the transfer    135349
      ** amount plus the receiving ps amount will exceed the original     135349
      ** loan current principal amount                                    135349
      *                                                                   135349
     C           SACTN     IFEQ 'A'                                       135349
     C           WPARTF    ANDEQ'Y'                                       135349
     C           SACTN     OREQ 'A'                                       135349
     C           WPARTT    ANDEQ'Y'                                       135349
      *                                                                   135349
     C***********WOOPSM    ADD  WPRAMS    WSOLD  130               135349 155721
      *                                                                   135349
     C           WPARTF    IFEQ 'Y'                                       135349
      *                                                                   155721
      ** If original loan of the originating is different as receiving's  155721
      ** original loan, restore the original amount of part sold.         155721
      *                                                                   155721
     C           WLOANO    IFEQ WLOANR                                    155721
     C********** WLOANR    OREQ 0                                                      155721 CLE148
     C           WLOANR    OREQ *BLANKS                                                       CLE148
     C                     Z-ADDWOOPSM    WSOLD                           155721
     C                     ELSE                                           155721
     C           WOOPSM    ADD  WPRAMS    WSOLD  130                      155721
     C                     ENDIF                                          155721
      *                                                                   135349
      ** Amount greater than the current sold amount of the origi -       135349
      ** nating loan send an error message                                135349
      *                                                                   135349
     C           WSVAM     IFGT WSOLD                                     135349
     C                     MOVE '1'       *IN32                           135349
     C                     MOVEL'LET0314' ZAMSID                          135349
     C                     EXSR ZASNMS                                    135349
     C                     ENDIF                                          135349
     C                     MOVE 'N'       WPARTF                          155721
     C                     ENDIF                                          135349
      *                                                                   135349
     C***********WORPSM    SUB  WPRAMS    WORPSM                   135349 155721
     C***********          ADD  WSVAM     WORPSM                   135349 155721
      ***********                                                  135349 155721
     C           WPARTT    IFEQ 'Y'                                       135349
      *                                                                   155721
      ** If original loan of the originating is different as receiving's  155721
      ** original loan, sum of transfer and restored ps amount of the     155721
      ** receiving original loan must not be greater than its principal   155721
      ** amount.                                                          155721
      *                                                                   155721
     C           WLOANO    IFEQ WLOANR                                    155721
     C                     Z-ADDWSVAM     WORPSM                          155721
     C                     ELSE                                           155721
     C           WORPSM    SUB  WPRAMS    WORPSM                          155721
     C                     ADD  WSVAM     WORPSM                          155721
     C                     ENDIF                                          155721
      *                                                                   135349
      ** Amount greater than the current principal amount of the recei-   135349
      ** ving loan send an error message                                  135349
      *                                                                   135349
     C           WORPSM    IFGT WORCPM                                    135349
     C                     MOVE '1'       *IN32                           135349
     C                     MOVEL'LET0313' ZAMSID                          135349
     C                     EXSR ZASNMS                                    135349
     C                     ENDIF                                          135349
     C                     MOVE 'N'       WPARTT                          155721
     C                     ENDIF                                          135349
      *                                                                   135349
     C                     ENDIF                                          135349
      *                                                                   135349
     C                     ENDSR
      /EJECT
      *****************************************************************   155721
      *                                                               *   155721
      * SRPSTR  -  Checks for loan's other transaction which could    *   155721
      *            affect the part sold amount                        *   155721
      *                                                               *   155721
      * Called by: SRVALD - Validation Subroutine                     *   155721
      *                                                               *   155721
      * Calls    : None                                               *   155721
      *                                                               *   155721
      *****************************************************************   155721
      *                                                                   155721
     C           SRPSTR    BEGSR                                          155721
      *                                                                   155721
     C                     Z-ADD*ZEROS    WAMTS  130                      155721
      *                                                                   155721
     C           WPARTS    SETLLPSOLD                                     155721
     C           WPARTS    READEPSOLD                    70               155721
      *                                                                   155721
     C           *IN70     DOWEQ'0'                                       155721
      *                                                                   155721
     C**********           MOVE LNRF      WPSLN   60                                   155721 CLE148
     C                     MOVE LNRF      WPSLN   6                                           CLE148
      *                                                                   155721
     C           WPSLN     SETLLLOAMS                                     155721
     C           WPSLN     READELOAMS                    46               155721
      *                                                                   155721
     C           *IN46     DOWEQ'0'                                       155721
     C           VDATK     ANDLEWSVVD                                     155721
      *                                                                   155721
     C           RECI      IFEQ 'D'                                       155721
     C           AMTP      ANDEQ'PI'                                      155721
     C                     ADD  PRAM      WAMTS                           155721
     C                     ENDIF                                          155721
      *                                                                   155721
     C           WPSLN     READELOAMS                    46               155721
     C                     ENDDO                                          155721
      *                                                                   155721
     C           WPARTS    READEPSOLD                    70               155721
     C                     ENDDO                                          155721
      *                                                                   155721
     C                     ENDSR                                          155721
      *                                                                   155721
      *****************************************************************   155721
      *                                                               *   155721
      * SRLNTR  -  Checks for loan's other transaction which could    *   155721
      *            affect the principal amount                        *   155721
      *                                                               *   155721
      * Called by: SRVALD - Validation Subroutine                     *   155721
      *                                                               *   155721
      * Calls    : None                                               *   155721
      *                                                               *   155721
      *****************************************************************   155721
      *                                                                   155721
     C           SRLNTR    BEGSR                                          155721
      *                                                                   155721
     C                     Z-ADD*ZEROS    WAMTL  130                      155721
      *                                                                   155721
     C           WLOAN     SETLLLOAMS                                     155721
     C           WLOAN     READELOAMS                    46               155721
      *                                                                   155721
     C           *IN46     DOWEQ'0'                                       155721
     C           VDATK     ANDLEWSVVD                                     155721
      *                                                                   155721
     C           RECI      IFEQ 'D'                                       155721
     C           AMTP      IFEQ 'PI'                                      155721
     C           AMTP      OREQ 'PT'                                      155721
     C                     ADD  PRAM      WAMTL                           155721
     C                     ENDIF                                          155721
      *                                                                   155721
     C           AMTP      IFEQ 'RE'                                      155721
     C           AMTP      OREQ 'MR'                                      155721
     C           AMTP      OREQ 'PF'                                      155721
     C                     SUB  PRAM      WAMTL                           155721
     C                     ENDIF                                          155721
     C                     ENDIF                                          155721
      *                                                                   155721
     C           WLOAN     READELOAMS                    46               155721
     C                     ENDDO                                          155721
      *                                                                   155721
     C                     ENDSR                                          155721
      *                                                                   155721
      /EJECT
      *****************************************************************
      * SRLOAD  -  Load subfile records                               *
      * Called by: SRSFIL - Subfile processing                        *
      * Calls    : SRCURR - Get currency details                      *
      *****************************************************************
     C           SRLOAD    BEGSR
      *
     C                     Z-ADD*ZEROS    WSCTR   40
     C                     MOVE '0'       *IN21
      *
      ** Retrieve details from either of 2 files, depending on input
      ** Position start of read on review from fields, only if
      ** rollup is not pressed
      *
     C           *IN74     IFEQ '0'
     C           WREVW     ORNE SREVW
     C                     Z-ADD*ZEROS    SRRN    40
     C                     MOVE '1'       *IN78
     C                     WRITELE2130C0
     C                     MOVEA'000'     *IN,76
      *
     C                     MOVE SRLON     WLNRF
     C                     MOVE SRVDT     ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    WVDAT
     C                     MOVE SRSEQ     WLASN
     C           SRAUT     IFEQ 'Y'
     C           WKLAM     SETLLLELOAMD1
     C                     READ LELOAMD1                 79
     C                     ELSE
     C           WKLAM     SETLLLELOAMD0
     C                     READ LELOAMD0                 79
     C                     ENDIF
      *
     C                     ELSE
     C                     Z-ADDWSRRN     SRRN
     C                     ENDIF
      *
      ** Load upto 10 records of principal transfer for the page
      ** A principal transfer generates a pair of records, but only
      ** display the 'principal from' amendment and only when the user
      ** is authorised to the booking branch
      *
     C           *IN79     DOWEQ'0'
     C           WSCTR     ANDLT10
      *
     C           AMTP      IFEQ 'PF'
     C                     Z-ADD*ZERO     @ERR
     C           BGMBIN    IFEQ 'Y'
     C                     CALL 'ZVBBU'
     C                     PARM BRCA      @ZBR
     C                     PARM           @ERR
     C                     ENDIF
      *
     C           @ERR      IFEQ *ZERO
     C                     MOVE *BLANKS   SLSEL
     C                     MOVE BRCA      SBRCH
     C                     Z-ADDVDAT      SHVDT
     C                     Z-ADDORED      SORED
     C                     MOVE IUSR      SIUSR
     C                     MOVE AUSR      SAUSR
     C                     MOVE ASTS      SASTS
      *
     C                     MOVE LNRF      SSLON
     C                     Z-ADDVDAT      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    SSVDT
     C                     MOVE ZDATE     SADAT
     C                     MOVE LASN      SSSEQ
     C                     MOVE ROLN      SSRLN
     C                     MOVE NRLI      SSNEW
      *
     C                     MOVE CCY       PCURR
     C                     Z-ADD6         WDBSE   30
     C                     EXSR SRCURR
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE PRAM      ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE ZOUT21    SSAMT
      *
     C                     SELEC
     C           RECI      WHEQ 'R'                                       139308
     C                     MOVEL'LET0049' ZAMSID                          139308
     C           ASTS      WHEQ 'C'
     C***********          MOVELWSTAT,1   SSSTS                           123998
     C                     MOVEL'LET0046' ZAMSID                          123998
     C           ASTS      WHEQ 'R'
     C***********          MOVELWSTAT,2   SSSTS                           123998
     C                     MOVEL'LET0047' ZAMSID                          123998
     C           ASTS      WHEQ 'A'
     C***********          MOVELWSTAT,3   SSSTS                           123998
     C                     MOVEL'LET0048' ZAMSID                          123998
     C           ASTS      WHEQ 'D'
     C***********          MOVELWSTAT,4   SSSTS                           123998
     C                     MOVEL'LET0049' ZAMSID                          123998
     C                     ENDSL
     C                     EXSR SRTEXT                                    123998
     C                     MOVELZAMSTX    SSSTS                           123998
     C                     MOVE *BLANKS   ZAMSID                          123998
      *
     C                     ADD  1         WSCTR
     C                     ADD  1         SRRN
     C                     WRITELE2130S0
     C                     ENDIF
     C                     ENDIF
      *
      ** Read next record to be loaded
      *
     C           SRAUT     IFEQ 'Y'
     C                     READ LELOAMD1                 79
     C                     ELSE
     C                     READ LELOAMD0                 79
     C                     ENDIF
     C                     ENDDO
      *
      ** If 10 records have been loaded and not yet end of file, read
      ** an extra valid record for the proper display of rollup function
      *
     C           *IN79     DOWEQ'0'
      *
     C           AMTP      IFEQ 'PF'
     C                     Z-ADD*ZERO     @ERR
     C           BGMBIN    IFEQ 'Y'
     C                     CALL 'ZVBBU'
     C                     PARM BRCA      @ZBR
     C                     PARM           @ERR
     C                     ENDIF
     C                     ENDIF
      *
     C           AMTP      IFEQ 'PF'
     C           @ERR      ANDEQ*ZERO
     C                     LEAVE
     C                     ENDIF
      *
     C           SRAUT     IFEQ 'Y'
     C                     READ LELOAMD1                 79
     C                     ELSE
     C                     READ LELOAMD0                 79
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** Save last RRN recorded and last review fields
      *
     C                     Z-ADDSRRN      WSRRN   40
     C                     Z-ADDSRRN      SRNBR
     C                     MOVE SREVW     WREVW  16
      *
      ** If subfile has no records to display, inform user
      *
     C           SRRN      IFEQ *ZEROS
     C                     MOVE '1'       *IN77
     C                     MOVEL'LET0019' ZAMSID
     C                     EXSR ZASNMS
     C                     WRITELE2130F0
     C                     ENDIF
     C                     WRITELE2130F3
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRFMTS  -  Format screen fields for interactive/record mode   *
      * Called by: SRVKEY - Validate key fields                       *
      *            SRSFIL - Subfile processing                        *
      * Calls    : SRCUST - Get customer details                      *
      *            SRCURR - Get currency details                      *
      *            SRFMTR - Format receiving loan details             *
      *****************************************************************
     C           SRFMTS    BEGSR
      *
      ** Protect screen fields for enquiry, reverse and authorise
      *
     C                     MOVEA'000'     *IN,33
     C                     MOVE '0'       *IN42
     C                     SELEC
     C           SACTN     WHEQ 'A'
     C                     MOVE '1'       *IN42
     C           SACTN     WHEQ 'E'
     C                     MOVE '1'       *IN35
     C           SACTN     WHEQ 'R'
     C                     MOVE '1'       *IN34
     C                     MOVE '1'       *IN35
     C           SACTN     WHEQ 'X'
     C                     MOVE '1'       *IN33
     C                     MOVE '1'       *IN35
     C                     ENDSL
      *
      ** Format originating loan details
      *
     C           SACTN     IFNE 'I'
     C                     MOVE CCY       CCYL
     C                     MOVE CNUM      CNUML
     C                     ENDIF
      *
     C                     MOVE CCYL      SCURR
     C                     MOVE *BLANKS   PCUST
     C                     MOVELCNUML     PCUST
     C                     Z-ADD9         WDBSE
     C                     EXSR SRCUST
     C                     MOVE BBCSSN    SCNUM
      *
     C                     MOVE CCYL      PCURR
     C                     Z-ADD5         WDBSE
     C                     EXSR SRCURR
     C                     MOVE A6MDIN    WMDIN   1
     C                     Z-ADDA6NBDP    WNBDP   10
     C                     Z-ADDA6SPRT    WSPRT  138
     C                     Z-ADDCPAM      WORAM
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE CPAM      ZFLD15
     C                     Z-ADDWNBDP     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C           CPAM      IFLT *ZEROS
     C                     MOVE ZOUT21    SOAMT
     C                     ELSE
     C                     MOVE ZOUT20    SOAMT
     C                     ENDIF
      *
      ** Format receiving loan details
      *
     C           SACTN     IFEQ 'I'
     C                     MOVE *BLANKS   SSTAT
     C                     MOVE *BLANKS   SROLN
     C                     MOVE *BLANKS   SNRLI
     C                     MOVE *BLANKS   SBRCA
     C                     MOVE *BLANKS   SRORC
     C                     MOVE *BLANKS   SPRAM
     C                     MOVE *BLANKS   SOLNO                           138865
      *
     C                     ELSE
     C                     SELEC
     C           RECI      WHEQ 'R'                                       139308
     C                     MOVEL'LET0049' ZAMSID                          139308
     C           ASTS      WHEQ 'C'
     C***********          MOVELWSTAT,1   SSTAT                           123998
     C                     MOVEL'LET0046' ZAMSID                          123998
     C           ASTS      WHEQ 'R'
     C***********          MOVELWSTAT,2   SSTAT                           123998
     C                     MOVEL'LET0047' ZAMSID                          123998
     C           ASTS      WHEQ 'A'
     C***********          MOVELWSTAT,3   SSTAT                           123998
     C                     MOVEL'LET0048' ZAMSID                          123998
     C           ASTS      WHEQ 'D'
     C***********          MOVELWSTAT,4   SSTAT                           123998
     C                     MOVEL'LET0049' ZAMSID                          123998
     C                     ENDSL
     C                     EXSR SRTEXT                                    123998
     C                     MOVELZAMSTX    SSTAT                           123998
     C                     MOVE *BLANKS   ZAMSID                          123998
      *
     C                     EXSR SRFMTR
     C                     ENDIF
      *
      ** Prepare for detail screen display
      *
     C                     EXSR CLEAR
     C                     MOVEA'0000'    *IN,29
     C                     MOVE 'D1'      WFMT
      *
     C                     ENDSR
      /EJECT                                                              123998
      *****************************************************************   123998
      * SRTEXT  -  Set up text from message file                      *   123998
      * Called by: All subroutines setting of texts                   *   123998
      * Calls    : None                                               *   123998
      *****************************************************************   123998
     C           SRTEXT    BEGSR                                          123998
      *                                                                   123998
     C                     CALL 'Y2RVMGC'                                 123998
     C                     PARM *BLANKS   PRTCD                           123998
     C                     PARM           ZAMSID           Message Id.    123998
     C                     PARM           ZAMSGF           Message file.  123998
     C                     PARM           ZAMSDA           Message data.  123998
     C                     PARM           ZAMSTX           Messge text    123998
      *                                                                   123998
     C                     ENDSR                                          123998
      /EJECT
      *****************************************************************
      * SRFMTR  -  Format receiving loan details for non-insert       *
      * Called by: SRPLAY - Batch processing in play mode             *
      *            SRFMTS - Format screen fields                      *
      * Calls    : SRCUST - Get customer details                      *
      *****************************************************************
     C           SRFMTR    BEGSR
      *
      ** Format receiving loan details
      *
     C                     MOVE ROLN      SROLN
     C                     MOVE NRLI      SNRLI
     C                     MOVE ROBR      SBRCA
      *
     C                     Z-ADD10        WDBSE
     C                     MOVE *BLANKS   PCUST
     C                     MOVELRORC      PCUST
     C                     EXSR SRCUST
     C                     MOVE BBCSSN    SRORC
      *
     C                     Z-ADDPRAM      WSVAM
     C                     Z-ADDWSVAM     WPRAMS 130                      135349
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE PRAM      ZFLD15
     C                     Z-ADDWNBDP     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C           PRAM      IFLT *ZEROS
     C                     MOVE ZOUT21    SPRAM
     C                     ELSE
     C                     MOVE ZOUT20    SPRAM
     C                     ENDIF
      *                                                                   138865
      ** Retrieve Original Loan for Transfers made on Parts Sold          138865
      *                                                                   138865
     C           *IN45     IFEQ '1'                                       138865
     C                     MOVE SROLN     WALON                           138865
     C           WKLON     CHAINCLOAN                70                   138865
     C           *IN70     IFEQ '0'                                       138865
     C           RECIL     ANDEQ'D'                                       138865
     C                     MOVE OLNO      SOLNO                           138865
     C                     ENDIF                                          138865
     C                     ENDIF                                          138865
      *
      ** Save fields for later update of 'PF' record
      *
     C                     MOVE LASN      WAMSQ   3
     C                     Z-ADDVDATK     WSVVD
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRCURR  -  Get currency details                               *
      * Called by: SRFMTS - Format screen fields                      *
      *            SRPLAY - Batch processing in play mode             *
      * Calls    : None                                               *
      *****************************************************************
     C           SRCURR    BEGSR
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           PCURR   3
     C           SDCURR    PARM SDCURR    DSSDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCURRPD'DBFILE           ************
     C                     Z-ADDWDBSE     DBASE            * DBERR XX *
     C                     MOVELPCURR     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRCUST  -  Get customer details                               *
      * Called by: SRFMTS - Format screen fields                      *
      *            SRFMTR - Format receiving loan details             *
      * Calls    : None                                               *
      *****************************************************************
     C           SRCUST    BEGSR
      *
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           PCUST  10
     C                     PARM *BLANKS   PKYST   7
     C           SDCUST    PARM SDCUST    DSSDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCUSTPD'DBFILE           ************
     C                     Z-ADDWDBSE     DBASE            * DBERR XX *
     C                     MOVELPCUST     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVREV  -  Validate review from entries                       *
      * Called by: SRSTRT - Validate initial screen                   *
      *            SRSFIL - Subfile processing                        *
      * Calls    : None                                               *
      *****************************************************************
     C           SRVREV    BEGSR
      *
      ** Originating loan number must be numeric
      *
     C           SRLON     IFNE *BLANKS
     C                     MOVELSRLON     WNUM7   70
     C                     MOVELWNUM7     WALF6   6
     C           SRLON     IFNE WALF6
     C                     MOVE '1'       *IN25
     C                     MOVEL'LET0009' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** Value date must be a valid numeric date
      *
     C           SRVDT     IFNE *BLANKS
     C                     MOVE SRVDT     ZDATE
     C                     EXSR ZDATE1
     C           *IN99     IFEQ '1'
     C                     MOVE '1'       *IN26
     C                     MOVEL'LET0007' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** Transfer sequence number must be numeric
      *
     C           SRSEQ     IFNE *BLANKS
     C                     MOVELSRSEQ     WNUM4   40
     C                     MOVELWNUM4     WALF3   3
     C           SRSEQ     IFNE WALF3
     C                     MOVE '1'       *IN27
     C                     MOVEL'LET0010' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** Authorisation field must be Y or N
      *
     C           SRAUT     IFEQ *BLANK
     C                     MOVE 'N'       SRAUT
     C                     ELSE
     C           SRAUT     IFNE 'Y'
     C           SRAUT     ANDNE'N'
     C                     MOVE '1'       *IN28
     C                     MOVEL'LET0008' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
     C           WERRF     IFEQ *BLANK
     C                     MOVE 'S0'      WFMT
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRAUTH  -  Validate authorisation action                      *
      * Called by: SRVKEY - Validate key fields                       *
      *            SRVSUB - Validate subfile entries                  *
      * Calls    : None                                               *
      *****************************************************************
     C           SRAUTH    BEGSR
      *
      ** If authorisation feature (CLE002) is not installed
      ** authorisation action is not allowed
      *
     C           CLE002    IFEQ 'N'
     C                     MOVEA'11'      *IN,21
     C                     MOVEL'LET0003' ZAMSID
     C                     EXSR ZASNMS
      *
      ** If authorisation feature is installed,
      **   (1) authorisation must be set as needed in order to continue
      **   (2) authorising user must be different from the insert and
      **         amend users
      **   (3) status of loan must be complete or requiring re-authori-
      **         sation
      *
     C                     ELSE
      *
     C           BPTPAU    IFNE 'Y'
     C                     MOVEA'11'      *IN,21
     C                     MOVEL'LET0004' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C/COPY WNCPYSRC,LE2130C002
      * If system value CLAuthORED = 'Y' and status is 'R' then allow authorise user          240968
      * to be same as orignal insert user                                                     240968
      * Or system value CLAuthSameORED = 'Y' and status is 'R' then allow authorise user      244314
      * to be same as orignal insert user                                                     244314
     C           ATHR      IFEQ 'Y'                                                           240968
     C           ASTS      ANDEQ'R'                                                           240968
     C           ATHS      OREQ 'Y'                                                           244314
     C           ASTS      ANDEQ'R'                                                           244314
     C           USER      IFEQ AUSR                                                          240968
     C                     MOVEA'11'      *IN,21                                              240968
     C                     MOVEL'LET0005' ZAMSID                                              240968
     C                     EXSR ZASNMS                                                        240968
     C                     ENDIF                                                              240968
     C                     ELSE                                                               240968
     C           USER      IFEQ IUSR
     C           USER      OREQ AUSR
     C                     MOVEA'11'      *IN,21
     C                     MOVEL'LET0005' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF                                                              240968
     C/COPY WNCPYSRC,LE2130C003
     C           ASTS      IFNE 'C'
     C           ASTS      ANDNE'R'
     C                     MOVEA'11'      *IN,21
     C                     MOVEL'LET0006' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRCAUT  -  Check if user is authorised to the action          *
      * Called by: SRVKEY - Validate key fields                       *
      *            SRVSUB - Validate subfile entries                  *
      * Calls    : None                                               *
      *****************************************************************
     C           SRCAUT    BEGSR
      *
      ** For single branch system, check if user is authorised to the
      ** action
      *
     C                     Z-ADD*ZERO     @ERR
     C           BGMBIN    IFEQ 'N'
     C                     CALL 'ZVACTU'
     C                     PARM SACTN     @ZACTN
     C                     PARM           @ERR
     C           @ERR      IFNE *ZERO
     C                     MOVEA'11'      *IN,21
     C                     MOVEL'LET0302' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** For multibranching system, branch code must be valid for
      ** the user
      *
     C                     ELSE
     C                     CALL 'ZVACTBU'
     C                     PARM SACTN     @ZACTN  1
     C                     PARM BRCAL     @ZBR    3
     C                     PARM           @ERR    10
     C           @ERR      IFEQ 1
     C                     MOVEA'11'      *IN,21
     C                     MOVEL'LET0303' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C           @ERR      IFEQ 2
     C                     MOVEA'11'      *IN,21
     C                     MOVEL'LET0304' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRNEWL  -  Update newly created loan                          *
      * Called by: Main processing                                    *
      *            SRPLAY - Batch processing in play mode             *
      *            SRSPRO - Process each subfile request              *
      * Calls    : SR2030 - Format LE2030 parameter fields            *
      *            SRUPDR - Update records in files                   *
      *****************************************************************
     C           SRNEWL    BEGSR
      *
      ** For reversal action, transfers must be deleted first
      *
     C           SACTN     IFEQ 'R'
     C                     EXSR SRUPDR
     C                     ENDIF
      *
      ** Format parameter fields
      *
     C           WERRF     IFEQ *BLANK
      *
      ** For insert, retrieve originating loan details
      ** For amend/reverse, retrieve receiving loan details
      *
     C           SACTN     IFEQ 'I'
     C                     MOVE SLNRF     WALON
     C                     ELSE
     C                     MOVE SROLN     WALON
     C                     ENDIF
     C                     MOVE 'A'       WEPAR
      *
     C           WKLON     CHAINCLOAN                70
     C                     MOVE *IN70     WIN70   1
     C****                 MOVE RECI      WRECI   1                       158597
     C                     MOVE RECIL     WRECI   1                       158597
     C                     MOVE 'B'       WEPAR
     C           WKLON     CHAINCLOAN                70
     C           *IN70     IFEQ '1'
     C***********RECI      ORNE 'D'                                       131253
     C           RECIL     ORNE 'D'                                       131253
     C           WIN70     OREQ '1'
     C           WRECI     ORNE 'D'
      *
     C           SACTN     IFEQ 'I'
     C                     MOVE '1'       *IN29
     C                     MOVEL'LET0037' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C           *LOCK     IN   LDA
     C                     MOVEL'CLOAN   'DBFILE           ************
     C                     Z-ADD13        DBASE            * DBERR 13 *
     C                     MOVELWALON     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
     C                     EXSR SR2030
     C                     ENDIF
      *
      ** Call maintenance program that will update CLOAN
      *
     C           WERRF     IFEQ *BLANK
     C                     MOVE 'B'       PTMOD
     C                     CALL 'LE2030'
     C                     PARM           PTMOD   1
     C***********          PARM *BLANKS   PTYPE   4                       122614
     C                     PARM 'PTFT'    PTYPE   4                       122614
     C                     PARM           PINPL
     C                     PARM           POUTL
     C                     PARM           PTMST  26                       222373
     C/COPY WNCPYSRC,LE2130C004
      *
      ** Check returned message format
      ** If no error, proceed to update of transfer for non-reversals
      ** Else, display returned error message
      *
     C                     MOVEL'LE2130  'DBPGM                                               202587
     C           LRMSV     IFNE 'E'
     C           LRMSV     ANDNE'D'                                       123214
     C           LRLON     ORNE *BLANKS
     C           SACTN     IFEQ 'I'
     C                     MOVE '1'       *IN39
     C                     MOVE LRLON     SLALC
     C                     MOVE LRLON     SROLN
     C                     ENDIF
     C           SACTN     IFNE 'R'
     C                     EXSR SRUPDR
     C                     ENDIF
      *
      ** Display unsuccessful update for interactive/record mode
      *
     C                     ELSE
     C                     ROLBK
     C           PMODE     IFNE 'P'
     C                     SELEC
     C           SACTN     WHEQ 'I'
     C                     MOVEL'LET0033' ZAMSID
     C           SACTN     WHEQ 'A'
     C                     MOVEL'LET0034' ZAMSID
     C           SACTN     WHEQ 'R'
     C                     MOVEL'LET0035' ZAMSID
     C           SACTN     WHEQ 'X'
     C                     MOVEL'LET0036' ZAMSID
     C                     ENDSL
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** Commit changes if no error and reversal
      ** Otherwise, display error message from called program
      *
     C           WERRF     IFEQ *BLANK
     C           SACTN     IFEQ 'R'
     C           PMODE     ANDNE'P'
     C                     COMIT
     C                     ENDIF
     C                     ELSE
     C                     MOVE LRMID     ZAMSID
     C                     MOVELLRMID     WMSG    3                       160635
     C           WMSG      IFEQ 'ESM'                                     160635
     C                     MOVEL'DRSMM   'ZAMSGF                          160635
     C                     ENDIF                                          160635
     C                     EXSR ZASNMS
     C                     MOVEL'LERMSGF' ZAMSGF                          160635
     C                     MOVE 'D1'      WFMT
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SR2030  -  Format parameter fields for LE2030                 *
      * Called by: SRNEWL - Insert records in files                   *
      * Calls    : SRCURR - Get currency details                      *
      *****************************************************************
     C           SR2030    BEGSR
      *
     C                     CLEARPINPL
     C                     CLEARPOUTL
      *
      ** Format transaction header
      *
     C                     SELEC
     C           PTYP      WHEQ 61
     C           PTYP      OREQ 62
     C           PTYP      OREQ 63
     C           PTYP      OREQ 70
     C                     MOVE 'LOAN'    LMTYP
     C           PTYP      WHEQ 64
     C           PTYP      OREQ 65
     C           PTYP      OREQ 68                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
     C           PTYP      OREQ 71                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
     C                     MOVE 'PTPU'    LMTYP
     C           PTYP      WHEQ 66
     C           PTYP      OREQ 67
     C           PTYP      OREQ 69                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
     C           PTYP      OREQ 72                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
     C                     MOVE 'PTSO'    LMTYP
     C                     ENDSL
      *
     C                     MOVELUSER      LTUSR
     C                     MOVELWSID      LTWID
     C                     MOVE SACTN     LTACT
     C                     Z-ADDBJRDNB    @@DAYN  50
     C                     EXSR ZDATE9
     C                     MOVE @@YR      LTDAT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LTDAT
     C                     TIME           WTIME
     C                     MOVE WTIM1     WTTM1
     C                     MOVE WTIM2     WTTM2
     C                     MOVE WTIM3     WTTM3
     C                     MOVE WTTIM     LTTIM
     C                     MOVE 'T'       LPTIN                           152892
      *
      ** Format detail fields
      ** New loan will be created with exact details from the
      ** originating loan except for some fields
      *
     C           LTACT     IFEQ 'I'
     C                     MOVE WRORC     LCNMR
     C                     ELSE
     C                     MOVE LNRFL     LLNRF
     C                     MOVE CNUML     LCNMR
     C                     ENDIF
     C                     MOVE SBRCA     LBRCA
     C                     MOVE ORBR      LORBR
     C                     MOVE LTYP      LLTYP
     C                     MOVE SUTP      LSUTP
      *
      ** Deal and value date will equal value date of transfer
      ** Deal date will equal rundate if value date is in the future      124483
      *
     C           LTACT     IFEQ 'I'
     C           WSVVD     IFLE BJRDNB                                    124483
     C                     Z-ADDWSVVD     @@DAYN
     C                     ELSE                                           124483
     C                     Z-ADDBJRDNB    @@DAYN                          124483
     C                     ENDIF                                          124483
     C                     ELSE
     C                     Z-ADDDDAT      @@DAYN
     C                     ENDIF
     C                     EXSR ZDATE9
     C                     MOVE @@YR      LDDAT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4   4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LDDAT
      *
     C           LTACT     IFEQ 'I'
     C                     Z-ADDWSVVD     @@DAYN
     C                     ELSE
     C                     Z-ADDVDATL     @@DAYN
     C                     ENDIF
     C                     EXSR ZDATE9
     C                     Z-ADD@@DAYN    WSTRT   50                      154220
     C                     MOVE @@YR      LSTDT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4   4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LSTDT
      *
      ** For discount loans, maturity date will equal next rollover
      ** date on insert, else get maturity date of originating loan
      *
     C           PTYP      IFEQ 63
     C           LTACT     ANDEQ'I'
     C                     Z-ADDNROD      WMDAT   50
     C                     ELSE
     C                     Z-ADDMDAT      WMDAT
     C                     ENDIF
      *
     C           WMDAT     IFNE *ZEROS
     C                     Z-ADDWMDAT     @@DAYN
     C                     EXSR ZDATE9
     C                     MOVE @@YR      LMDAT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4   4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LMDAT
     C                     ENDIF
      ***********                                                         140823
      ***Interest, rollover and repayment details are to be left          140823
      ***blank*on insert                                                  140823
      ***********                                                         140823
      *                                                                   140823
      ** Interest and rollover details should be the same as original     140823
      ** loan                                                             140823
      *                                                                   140823
     C***********LTACT     IFNE 'I'                                       140823
      *
      ** Check if Value Date is less than Interest Date                   154220
      *                                                                   154220
     C           WSTRT     IFLT NIDT                                      154220
     C                     MOVE IPFR      LINFQ
     C           IFDY      IFNE *ZEROS
     C                     MOVE IFDY      LINDY
     C                     ENDIF
     C           NIDT      IFNE *ZEROS
     C                     Z-ADDNIDT      @@DAYN
     C                     EXSR ZDATE9
     C                     MOVE @@YR      LNIDT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4   4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LNIDT
     C                     ENDIF
     C                     ENDIF                                          154220
      *
      ** Check if Value Date is less than Rollover Date                   154220
      *                                                                   154220
     C           WSTRT     IFLT RLDT                                      154220
     C                     MOVE RLFQ      LRLFQ
     C           RLDY      IFNE *ZEROS
     C                     MOVE RLDY      LRLDY
     C                     ENDIF
     C           RLDT      IFNE *ZEROS
     C                     Z-ADDRLDT      @@DAYN
     C                     EXSR ZDATE9
     C                     MOVE @@YR      LRLDT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4   4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LRLDT
     C                     ENDIF
     C                     ENDIF                                          154220
      *
      ** Repayment details should be left blank on insert                 140823
      *                                                                   140823
     C           LTACT     IFNE 'I'                                       140823
     C           RAMT      IFNE *ZEROS
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE RAMT      ZFLD15
     C                     Z-ADDWNBDP     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE ZOUT20    LRPAM
     C                     ENDIF
      *
     C                     MOVE RFRQ      LRPFQ
     C           RDYN      IFNE *ZEROS
     C                     MOVE RDYN      LRPDY
     C                     ENDIF
     C           NRPD      IFNE *ZEROS
     C                     Z-ADDNRPD      @@DAYN
     C                     EXSR ZDATE9
     C                     MOVE @@YR      LRPDT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4   4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LRPDT
     C                     ENDIF
      *
     C           FCRA      IFNE *ZEROS
     C                     MOVE FCCY      PCURR
     C                     Z-ADD7         WDBSE
     C                     EXSR SRCURR
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE FCRA      ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE ZOUT20    LFCRA
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     MOVE FCUS      LFCUS
     C                     MOVE FTYP      LFACT
     C                     MOVE FSEQ      LFCNO
     C                     MOVE CCYL      LCCY
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE '0'       ZFLD15
     C                     Z-ADDWNBDP     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C***********          MOVE ZOUT20    LCPAM                           123214
     C                     MOVE ZOUT21    LCPAM                           123214
     C                     MOVE AUTO      LAUTO
     C                     MOVE APMI      LAPMI
     C                     MOVE BOKC      LBOKC
     C                     MOVE PTFR      LPTFR
     C                     MOVE PRFC      LPRFC
     C                     MOVE LASQ      LLASQ
     C                     MOVE INTC      LINTC
     C                     MOVE ADDI      LADDI
     C                     MOVE ICBS      LCALC
     C********** BRTT      IFNE *ZEROS                                                        CSD103
     C           BRTT      IFNE *BLANKS                                                       CSD103
     C                     MOVE BRTT      LBRTT
     C                     ENDIF
      *
     C           RTSP      IFNE *ZEROS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE RTSP      ZFIELD
     C                     Z-ADD7         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    LRTSP
     C                     ENDIF
      *
     C                     MOVE SPIN      LSPIN
     C                     MOVE CHIN      LCHIN
      *
     C********** BRTT      IFEQ *ZEROS                                                 202391 CSD103
     C           BRTT      IFEQ *BLANKS                                                       CSD103
     C                     MOVE *BLANKS   LCHIN                                               202391
     C                     ENDIF                                                              202391
      *                                                                                       202391
     C           MARG      IFNE *ZEROS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE MARG      ZFIELD
     C                     Z-ADD5         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    LMARG
     C                     ENDIF
     C           MARG      IFLT *ZEROS
     C                     MOVE 'Y'       LNEGV
     C                     ENDIF
      *
     C                     MOVE RDFC      LRDFC
     C                     MOVE WTIN      LWTIN
     C           WTRT      IFNE *ZEROS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE WTRT      ZFIELD
     C                     Z-ADD7         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    LWTRT
     C                     ENDIF
      *
     C           REPT      IFNE *ZEROS
     C                     MOVE REPT      LREPT
     C                     ENDIF
      *
     C********** LIND      IFNE *ZEROS                                                        CER020
     C           LOIC      IFNE *BLANKS                                                       CER020
     C**********           MOVE LIND      LLIND                                               CER020
     C                     MOVE LOIC      LLIND                                               CER020
     C                     ENDIF
     C           FRBC      IFNE *ZEROS
     C                     MOVE FRBC      LFRBC
     C                     ENDIF
     C                     MOVE CRSK      LCRSK
     C                     MOVE ACOF      LACOF
     C                     MOVE NACD      LNACD
      *
     C                     TESTB'2'       RELI           70
     C           *IN70     IFEQ '1'
     C                     MOVE 'Y'       LFEEI
     C                     ELSE
     C                     MOVE 'N'       LFEEI
     C                     ENDIF
      *
     C                     TESTB'1'       RELI           70
     C           *IN70     IFEQ '1'
     C                     MOVE 'Y'       LDOCI
     C                     ELSE
     C                     MOVE 'N'       LDOCI
     C                     ENDIF
      *
     C                     TESTB'0'       RELI           70
     C           *IN70     IFEQ '1'
     C                     MOVE 'Y'       LSECI
     C                     ELSE
     C                     MOVE 'N'       LSECI
     C                     ENDIF
      *
     C                     MOVE NAR1      LNAR1
     C                     MOVE NAR2      LNAR2
     C                     MOVE NAR3      LNAR3
     C                     MOVE NAR4      LNAR4
      *
     C           BJCYCD    IFNE CCYL
     C           LTACT     ANDEQ'I'
     C           LTACT     ORNE 'I'
     C                     MOVE BMDI      LBMDI
     C           BCXR      IFNE *ZEROS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE BCXR      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    LBCXR
     C                     ENDIF
     C                     ENDIF
      *
     C           FCCY      IFNE CCYL
     C           LTACT     ANDEQ'I'
     C           LTACT     ORNE 'I'
     C                     MOVE FMDI      LFMDI
     C           FCXR      IFNE *ZEROS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE FCXR      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    LFCXR
     C                     ENDIF
     C                     ENDIF
      *
     C********** RECE      IFNE *ZEROS                                                        CSD027
     C           RECE      IFNE *BLANKS                                                       CSD027
     C                     MOVE RECE      LRECE
     C                     ENDIF
     C********** COCU      IFNE *ZEROS                                                        CSD027
     C           COCU      IFNE *BLANKS                                                       CSD027
     C                     MOVE COCU      LCOCU
     C                     ENDIF
     C           OMDT      IFNE *ZEROS
     C                     Z-ADDOMDT      @@DAYN
     C                     EXSR ZDATE9
     C                     MOVE @@YR      LOMDT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4   4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     LOMDT
     C                     ENDIF
      *
     C                     MOVE BTIN      LBTIN
     C                     MOVE BLDY      LBLDY
     C                     MOVE RCSI      LRCSI
      *
     C           LMTYP     IFEQ 'PTPU'
     C                     MOVE OLNO      LORGB
     C                     MOVE MLNR      LORLN                           152618
     C                     ENDIF
     C           LMTYP     IFEQ 'PTSO'
     C***********          MOVE OLNO      LORLN                           138865
     C                     MOVE SOLNO     LORLN                           138865
     C                     ENDIF
      *
     C           FSRP      IFNE *ZEROS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE FSRP      ZFIELD
     C                     Z-ADD7         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    LFSRP
     C                     ENDIF
     C                     MOVE FSGN      LFSGN
     C                     MOVE FPRC      LFPRC
      *
     C                     MOVE SPI1      LSPI1
     C                     MOVE SPI2      LSPI2
     C                     MOVE SPI3      LSPI3
      *
     C                     MOVE PSTM      LPSTM
     C                     MOVE OSDB      LOSDB
     C                     MOVE PONS      LPONS
     C                     MOVE RVNO      LRVNO
     C                     MOVE CVMR      LCVMR
     C                     MOVE POCN      LPOCN
     C                     MOVE POBN      LPOBN
     C                     MOVE RCRN      LRCRN
     C                     MOVE RCRA      LRCRA
     C                     MOVE PIBN      LPIBN
     C                     MOVE PIBA      LPIBA
     C                     MOVE AWBN      LAWBN
     C                     MOVE AWBA      LAWBA
     C                     MOVE BENN      LBENN
     C                     MOVE BENA      LBENA
      *
     C                     MOVE RSTM      LRSTM
     C                     MOVE OMDB      LOMDB
     C                     MOVE RONS      LRONS
     C                     MOVE ROCN      LROCN
     C                     MOVE ROBN      LROBN
     C                     MOVE RIBN      LRIBN
     C                     MOVE RIBA      LRIBA
      *
     C                     MOVE DTP1      LDTP1
     C                     MOVE DTP2      LDTP2
     C                     MOVE DTP3      LDTP3
     C                     MOVE DTP4      LDTP4
      *
     C                     MOVE DCHG      LDCHG
      *
     C                     MOVE BTB1      LBTB1
     C                     MOVE BTB2      LBTB2
     C                     MOVE BTB3      LBTB3
     C                     MOVE BTB4      LBTB4
     C                     MOVE BTB5      LBTB5
     C                     MOVE BTB6      LBTB6
     C                     MOVE SCCY      LSCCY                           162648
     C                     MOVE ICCY      LICCY                           162648
      *
     C                     MOVE LNKS      LLNKS
     C***********          MOVE 'N'       LGASS                           123096
     C                     MOVE GASS      LGASS                           123096
     C                     MOVE DFTP      LDFTP
     C                     MOVE DFST      LDFST
     C                     MOVE MCRA      LMCRA
      *
     C                     MOVE PDDI      LPDDI
     C                     MOVE PTDI      LPTDI
     C                     MOVE GDPR      LGDPR
     C                     MOVE GDIN      LGDIN
     C                     MOVE 'Y'       LGPRT
     C           LTACT     IFEQ 'I'
     C                     MOVE LNRFL     LTOLN
     C                     MOVE USER      LIUSR
     C                     ELSE
     C                     MOVE TOLN      LTOLN
     C           LTACT     IFEQ 'A'
     C                     MOVE USER      LAUSR
     C                     ENDIF
     C           LTACT     IFEQ 'X'                                       123227
     C                     MOVE USER      LXUSR                           123227
     C                     ENDIF                                          123227
     C                     ENDIF
      *                                                                                       CAS001
      ** When CAS001 enhancement is installed                                                 CAS001
      *                                                                                       CAS001
     C           CAS001    IFEQ 'Y'                                                           CAS001
     C                     MOVE FSYLDC    LYLDC                                               CAS001
     C                     MOVE FSFYLD    LFYLD                                               CAS001
     C                     ENDIF                                                              CAS001
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRUPDR  -  Update records in files                            *
      * Called by: Main processing                                    *
      *            SRPLAY - Batch processing in play mode             *
      *            SRSPRO - Process each subfile request              *
      *            SRNEWL - Insert records in files                   *
      * Calls    : SR2040 - Format parameter fields for LE2040        *
      *            SRRCRD - Write to test harness file in record mode *
      *****************************************************************
     C           SRUPDR    BEGSR
      *
      ** CREATE/UPDATE A 'TRANSFER PRINCIPAL FROM' RECORD
      *
      ** This is an amendment to the originating loan, so retrieve
      ** originating loan's details for insert (only when receiving
      ** loan is not a new loan, as new loans have been processed in   )
      ** SR/SRNEWL
      *
     C           SACTN     IFEQ 'I'
     C           SNRLI     IFEQ 'N'
     C                     MOVE SLNRF     WALON
     C                     MOVE 'A'       WEPAR
     C           WKLON     CHAINCLOAN                70
     C                     MOVE *IN70     WIN70   1
     C****                 MOVE RECI      WRECI   1                       158597
     C                     MOVE RECIL     WRECI   1                       158597
     C                     MOVE 'B'       WEPAR
     C           WKLON     CHAINCLOAN                70
      *
     C           *IN70     IFEQ '1'
     C***********RECI      ORNE 'D'                                       131253
     C           RECIL     ORNE 'D'                                       131253
     C           WIN70     OREQ '1'
     C           WRECI     ORNE 'D'
     C           *LOCK     IN   LDA
     C                     MOVEL'CLOAN   'DBFILE           ************
     C                     Z-ADD14        DBASE            * DBERR 14 *
     C                     MOVELWALON     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
     C**********           Z-ADDCNUML     WORCN   60                                          CSD027
     C                     MOVE CNUML     WORCN   6                                           CSD027
     C                     MOVE BRCAL     WORBR   3
      *
      ** For non-insert, access existing 'PF' record details
      *
     C                     ELSE
     C                     MOVE SLNRF     WLNRF
     C                     Z-ADDWSVVD     WVDAT
     C                     MOVE WAMSQ     WLASN
     C           WKLAM     CHAINLOAMS                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C           AMTP      ANDNE'PF'
     C           *LOCK     IN   LDA
     C                     MOVEL'LOAMS   'DBFILE           ************
     C                     Z-ADD17        DBASE            * DBERR 17 *
     C                     MOVELWLKEY     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C**********           Z-ADDCNUM      WORCN                                               CSD027
     C                     MOVE CNUM      WORCN                                               CSD027
     C                     MOVE ROSN      STOSQ
     C**********           Z-ADDRORC      WRORC                                               CSD027
     C                     MOVE RORC      WRORC                                               CSD027
     C                     MOVE ROBR      WROBR
     C                     ENDIF
      *
     C                     MOVE 'LAPF'    WMTYP   4
     C                     EXSR SR2040
      *
      ** CREATE/UPDATE A 'TRANSFER PRINCIPAL TO' RECORD
      *
     C           WERRF     IFEQ *BLANK
      *
      ** This is an amendment to the receiving loan, so retrieve
      ** receiving loan's details for insert (only when receiving loan
      ** is not a new loan, as new loans have been processed in
      ** SR/SRNEWL
      *
     C           SACTN     IFEQ 'I'
     C           SNRLI     IFEQ 'N'
     C                     MOVE SROLN     WALON
     C                     MOVE 'A'       WEPAR
     C           WKLON     CHAINCLOAN                70
     C                     MOVE *IN70     WIN70   1
     C                     MOVE RECIL     WRECI   1                       131253
     C***********          MOVE RECI      WRECI   1                       131253
     C                     MOVE 'B'       WEPAR
     C           WKLON     CHAINCLOAN                70
      *
     C           *IN70     IFEQ '1'
     C***********RECI      ORNE 'D'                                       131253
     C           RECIL     ORNE 'D'                                       131253
     C           WIN70     OREQ '1'
     C           WRECI     ORNE 'D'
     C           *LOCK     IN   LDA
     C                     MOVEL'CLOAN   'DBFILE           ************
     C                     Z-ADD15        DBASE            * DBERR 15 *
     C                     MOVELWALON     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
     C                     MOVE '1'       *IN40
     C                     MOVE ARMSQ     SFRSQ
      *
      ** For non-insert, access existing 'PT' record details
      *
     C                     ELSE
     C                     MOVE ROLN      WLNRF
     C                     Z-ADDVDATK     WVDAT
     C                     MOVE ROSN      WLASN
     C           WKLAM     CHAINLOAMS                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C           AMTP      ANDNE'PT'
     C           *LOCK     IN   LDA
     C                     MOVEL'LOAMS   'DBFILE           ************
     C                     Z-ADD12        DBASE            * DBERR 12 *
     C                     MOVELWLKEY     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C           SACTN     IFEQ 'R'
     C                     Z-ADDPRAM      WSVAM
     C                     ENDIF
     C                     MOVE CCY       WCURR
     C                     MOVE LASN      WAMSQ
     C                     MOVE ROSN      SFRSQ
     C                     MOVE ROBR      WORBR
     C                     ENDIF
      *
     C                     MOVE 'LAPT'    WMTYP
     C                     EXSR SR2040
     C                     ENDIF
      *
      ** On insert, update receiving sequence number of 'transfer
      ** principal from'
      *
     C           SACTN     IFEQ 'I'
     C           WERRF     ANDEQ*BLANK
     C                     MOVE SLNRF     WLNRF
     C                     Z-ADDWSVVD     WVDAT
     C                     MOVE SFRSQ     WLASN
     C           WKLAM     CHAINLOAMS                70
     C           *IN70     IFEQ '1'
     C           *IN70     OREQ '0'
     C           AMTP      ANDNE'PF'
     C           *LOCK     IN   LDA
     C                     MOVEL'LOAMS   'DBFILE           ************
     C                     Z-ADD16        DBASE            * DBERR 16 *
     C                     MOVELWLKEY     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     MOVE '1'       *IN41
     C                     MOVE ARMSQ     STOSQ
     C                     MOVE 'A'       SACTN
     C                     MOVE SFRSQ     WAMSQ
     C                     MOVE 'LAPF'    WMTYP
     C                     EXSR SR2040
     C                     MOVE 'I'       SACTN
     C                     ENDIF
      *
      ** If error, display error message
      ** If not play mode, commit changes (except on reversals of
      ** new loans
      ** If record mode, write screen details to test harness file
      *
     C           WERRF     IFNE *BLANKS
     C                     MOVE 'D1'      WFMT
      *
     C                     ELSE
     C           PMODE     IFNE 'P'
     C           SNRLI     IFEQ 'N'
     C           SNRLI     OREQ 'Y'
     C           SACTN     ANDNE'R'
     C                     COMIT
     C                     ENDIF
     C                     ENDIF
      *
     C           PMODE     IFEQ 'R'
     C                     EXSR SRRCRD
     C                     ENDIF
     C           SACTN     IFEQ 'I'
     C                     MOVE 'F0'      WFMT
     C                     ELSE
     C                     MOVE WWRTRN    WFMT
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SR2040  -  Format parameter fields for LE2040                 *
      * Called by: SRUPDR - Update records in files                   *
      * Calls    : None                                               *
      *****************************************************************
     C           SR2040    BEGSR
      *
     C                     CLEARPINPA
     C                     CLEARPOUTA
      *
      ** Format transaction header
      *
     C                     MOVE WMTYP     AMTYP
     C                     MOVELUSER      ATUSR
     C                     MOVELWSID      ATWST
     C                     MOVE SACTN     ATACT
     C                     Z-ADDBJRDNB    @@DAYN
     C                     EXSR ZDATE9
     C                     MOVE @@YR      ATDAT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     ATDAT
     C                     TIME           WTIME
     C                     MOVE WTIM1     WTTM1
     C                     MOVE WTIM2     WTTM2
     C                     MOVE WTIM3     WTTM3
     C                     MOVE WTTIM     ATTIM
     C                     MOVE 'T'       APTIN                           144096
      *
      ** 'Transfer principal from' is an amendment to the originating
      ** loan, while 'Transfer principal to' is an amendment to the
      ** receiving loan
      *
     C           AMTYP     IFEQ 'LAPF'
     C                     MOVE SLNRF     ALOAN
     C                     MOVE WORCN     ACSNO
     C                     MOVE SROLN     AROLN
     C                     MOVE WRORC     ARORC
     C                     MOVE STOSQ     AROSN
     C                     MOVE WROBR     AROBR
     C                     MOVE SCURR     ACURR
     C                     ELSE
     C                     MOVE SROLN     ALOAN
     C                     MOVE WRORC     ACSNO
     C                     MOVE SLNRF     AROLN
     C                     MOVE WORCN     ARORC
     C                     MOVE SFRSQ     AROSN
     C                     MOVE WORBR     AROBR
     C                     MOVE WCURR     ACURR
     C                     ENDIF
      *
     C           SACTN     IFEQ 'I'
     C                     Z-ADDWSVVD     @@DAYN
     C                     ELSE
     C                     Z-ADDVDATK     @@DAYN
     C                     MOVE WAMSQ     AAMSQ
     C                     ENDIF
     C                     EXSR ZDATE9
     C                     MOVE @@YR      AVDAT
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL@@Z71M    WDAT4
     C                     MOVE @@Z71D    WDAT4
     C                     ELSE
     C                     MOVEL@@Z71D    WDAT4
     C                     MOVE @@Z71M    WDAT4
     C                     ENDIF
     C                     MOVELWDAT4     AVDAT
      *
      ** For 'transfer principal to', convert amount to receiving loan's
      ** currency, if it is different from the originating loan's ccy
      *
     C                     Z-ADDWSVAM     WPRAM  130
      *
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WPRAM     ZFLD15
     C                     Z-ADDWNBDP     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE ZOUT20    APRAM
     C                     MOVE SNRLI     ANRLI
      *
      ** Format settlement details
      *
     C***********          MOVE SPI1      ASPI1                           146373
     C***********          MOVE SPI2      ASPI2                           146373
     C***********          MOVE SPI3      ASPI3                           146373
      *
     C***********          MOVE PSTM      APSTM                           146373
     C***********          MOVE PONS      APONS                           146373
     C***********          MOVE RVNO      ARVNO                           146373
     C***********          MOVE CVMR      ACVMR                           146373
     C***********          MOVE POCN      APOCN                           146373
     C***********          MOVE POBN      APOBN                           146373
     C***********          MOVE RCRN      ARCRN                           146373
     C***********          MOVE RCRA      ARCRA                           146373
     C***********          MOVE PIBN      APIBN                           146373
     C***********          MOVE PIBA      APIBA                           146373
     C***********          MOVE AWBN      AAWBN                           146373
     C***********          MOVE AWBA      AAWBA                           146373
     C***********          MOVE BENN      ABENN                           146373
     C***********          MOVE BENA      ABENA                           146373
      *
     C***********          MOVE RSTM      ARSTM                           146373
     C***********          MOVE RONS      ARONS                           146373
     C***********          MOVE ROCN      AROCN                           146373
     C***********          MOVE ROBN      AROBN                           146373
     C***********          MOVE RIBN      ARIBN                           146373
     C***********          MOVE RIBA      ARIBA                           146373
      *
     C***********          MOVE DTP1      ADTP1                           146373
     C***********          MOVE DTP2      ADTP2                           146373
     C***********          MOVE DTP3      ADTP3                           146373
     C***********          MOVE DTP4      ADTP4                           146373
     C***********          MOVE DCHG      ADCHG                           146373
      *
     C***********          MOVE BTB1      ABTB1                           146373
     C***********          MOVE BTB2      ABTB2                           146373
     C***********          MOVE BTB3      ABTB3                           146373
     C***********          MOVE BTB4      ABTB4                           146373
     C***********          MOVE BTB5      ABTB5                           146373
     C***********          MOVE BTB6      ABTB6                           146373
      *
     C                     MOVE DFTP      ADFTP
     C                     MOVE DFST      ADFST
      *                                                                   123227
     C                     SELEC                                          123227
     C           SACTN     WHEQ 'I'                                       123227
     C                     MOVELUSER      AIUSR                           123227
     C           SACTN     WHEQ 'A'                                       123227
     C                     MOVELUSER      AAUSR                           123227
     C********** SACTN     WHEQ 'A'                                                    123227 202587
     C           SACTN     WHEQ 'X'                                                           202587
     C                     MOVELUSER      AXUSR                           123227
     C                     ENDSL                                          123227
      *
      ** Call maintenance program that will update LOAMS
      *
     C           CAP061    IFEQ 'Y'                                                           202440
     C                     Z-ADD56        MSGLEN 155                                          202440
     C                     MOVEACMD,1     PCMD   60                                           202440
     C                     CALL 'QCMDEXC'                                                     202440
     C                     PARM           PCMD                                                202440
     C                     PARM           MSGLEN                                              202440
     C                     ENDIF                                                              202440
      *                                                                                       202440
     C                     MOVE 'B'       PTMOD
     C                     CALL 'LE2040'
     C                     PARM           PTMOD
     C                     PARM           PINPA
     C                     PARM           POUTA
     C                     PARM           PTMST  26                                           CLE034
      *
     C                     MOVEL'LE2130  'DBPGM                                               202587
     C           CAP061    IFEQ 'Y'                                                           202440
     C                     Z-ADD56        MSGLEN 155                                          202440
     C                     MOVEACMD,2     PCMD   60                                           202440
     C                     CALL 'QCMDEXC'                                                     202440
     C                     PARM           PCMD                                                202440
     C                     PARM           MSGLEN                                              202440
     C                     ENDIF                                                              202440
      *                                                                                       202440
     C           ARMSV     IFEQ 'E'
     C                     SELEC
     C           SACTN     WHEQ 'I'
     C                     MOVEL'LET0038' ZAMSID
     C           SACTN     WHEQ 'A'
     C                     MOVEL'LET0039' ZAMSID
     C           SACTN     WHEQ 'R'
     C                     MOVEL'LET0040' ZAMSID
     C           SACTN     WHEQ 'X'
     C                     MOVEL'LET0041' ZAMSID
     C                     ENDSL
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRRCRD  -  Write to test harness file when in record mode     *
      * Called by: SRUPDR - Update records in files                   *
      * Calls    : None                                               *
      *****************************************************************
     C           SRRCRD    BEGSR
      *
      ** Format test harness file fields
      *
     C                     CLEARLE2130D0
      *
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     WDATE
     C                     MOVE WDAT1     WTDT1
     C                     MOVE WDAT2     WTDT2
     C                     MOVE WDAT3     WTDT3
     C                     MOVE WTDAT     DTST
     C                     TIME           WTIME
     C                     MOVE WTIM1     WTTM1
     C                     MOVE WTIM2     WTTM2
     C                     MOVE WTIM3     WTTM3
     C                     MOVE WTTIM     TMST
      *
     C                     MOVE SACTN     ACTN
     C                     MOVE SLNRF     LNRFH
     C                     MOVE SVDAT     VDATH
     C           SACTN     IFNE 'I'
     C                     MOVE SLASN     LASNH
     C                     ENDIF
      *
      ** Write amendment details for insert and amend only
      ** Authorisation and reversal need key fields and action only
      *
     C           SACTN     IFEQ 'I'
     C           SACTN     OREQ 'A'
     C           SACTN     IFEQ 'A'
     C                     MOVELSROLN     ROLNH
     C                     ENDIF
     C                     MOVE SCNUM     CNUMH
     C                     MOVE SCURR     CCYH
     C                     MOVELSRORC     RORCH
     C                     MOVELSNRLI     NRLIH
     C                     MOVELSPRAM     PRAMH
     C                     MOVELSOLNO     OLNOH                           138865
     C                     ENDIF
      *
      ** Write to test harness file
      *
     C                     WRITELE2130D0               70
      *
     C                     ENDSR
      /EJECT                                                              156990
      *****************************************************************   156990
      *  SRCATP  -  Categories Processing Type of Loan                *   156990
      *  Called by: SRVKEY - Validate key fields                      *   156990
      *             SRVALD - Validate detail screen                   *   156990
      *  Calls    : None                                              *   156990
      *****************************************************************   156990
     C           SRCATP    BEGSR                                          156990
      *                                                                   156990
     C                     MOVE ' '       WTYP    1                       156990
      *                                                                   156990
     C                     SELEC                                          156990
      *                                                                   156990
      ** Ordinary loan & part. purch.                                     156990
     C           PTYP      WHEQ 61                                        156990
     C           PTYP      OREQ 62                                        156990
     C           PTYP      OREQ 63                                        156990
     C           PTYP      OREQ 64                                        156990
     C           PTYP      OREQ 65                                        156990
     C           PTYP      OREQ 68                                        156990
     C                     MOVE '1'       WTYP                            156990
      *                                                                   156990
      ** Part sold                                                        156990
     C           PTYP      WHEQ 66                                        156990
     C           PTYP      OREQ 67                                        156990
     C           PTYP      OREQ 69                                        156990
     C                     MOVE '2'       WTYP                            156990
      *                                                                   156990
      ** Guarantee & Risk part purch                                      156990
     C           PTYP      WHEQ 70                                        156990
     C           PTYP      OREQ 71                                        156990
     C                     MOVE '3'       WTYP                            156990
      *                                                                   156990
      ** Risk part sold                                                   156990
     C           PTYP      WHEQ 72                                        156990
     C                     MOVE '4'       WTYP                            156990
     C                     ENDSL                                          156990
      *                                                                   156990
     C                     ENDSR                                          156990
      /EJECT
      *****************************************************************
      * CLEAR   -  Clears the message queue                           *
      * Called by: All validation subroutines                         *
      * Calls    : Y2CLMSC                                            *
      *****************************************************************
     C           CLEAR     BEGSR
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
     C                     MOVE *BLANK    WERRF   1
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *  ZASNMS - Sends messages to the program's message queue       *
      *  Called by: Almost all screens with validation                *
      *  Calls    : SRBERR - Set up batch error details               *
      *****************************************************************
     C           ZASNMS    BEGSR
      *
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message Id.
     C                     PARM           ZAMSGF 10        Message file.
     C                     PARM           ZAMSDA132        Message data.
     C                     PARM           ZAMSTP  7        Message type.
     C                     MOVE 'Y'       WERRF
      *
     C           PMODE     IFEQ 'P'
     C                     EXSR SRBERR
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRBERR  -  Set up batch error details                         *
      * Called by: ZASNMS - Sends messages to the program msgq        *
      * Calls    : None                                               *
      *****************************************************************
     C           SRBERR    BEGSR
      *
     C                     CALL 'Y2RVMGC'
     C                     PARM           PRTCD
     C                     PARM           ZAMSID           Message Id.
     C                     PARM           ZAMSGF           Message file.
     C                     PARM           ZAMSDA           Message data.
     C                     PARM           ZAMSTX132        Messge text
      *
     C                     MOVE 'E'       RMSV
     C                     MOVELZAMSID    RMID
     C                     MOVELZAMSTX    RMTX
     C                     UPDATLE2130D0
      *
     C                     ROLBK
     C           *LOCK     IN   LDA
     C                     MOVEL'LERMSGF 'DBFILE           ************
     C                     Z-ADD8         DBASE            * DBERR 08 *
     C                     MOVELZAMSID    DBKEY            ************
     C                     MOVELZAMSTX    DBTXT
     C                     OUT  LDA
      *
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      /EJECT
      *****************************************************************   159256
      * SRWARN   - Send a warning message if a syndicated loan is     *   159256
      *            being amended, reversed or authorised directly on  *   159256
      *            Midas as Loan Manager should be used to take       *   159256
      *            advantage of the autogeneration process.           *   159256
      * Called by: SRVKEY, SRDETL                                     *   159256
      * Calls    : None                                               *   159256
      *****************************************************************   159256
     C           SRWARN    BEGSR                                          159256
      *                                                                   159256
     C           PMODE     IFEQ 'I'                                       159256
      *                                                                   159256
      ** Only issue the warning once for the same transaction.            159256
      *                                                                   159256
     C           WE232     IFEQ *BLANK                                    159256
     C           WE232     OREQ 'Y'                                       159256
     C           SLNRF     ANDNEW1LNRF                                    159256
     C                     MOVELSLNRF     W1LNRF  6                       159256
      *                                                                   159256
      ** Warn if participation linked to a syndicate                      159256
      *                                                                   159256
     C           PTYP      IFEQ 64                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C           PTYP      OREQ 65                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C           PTYP      OREQ 66                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C           PTYP      OREQ 67                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C           PTYP      OREQ 68                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C           PTYP      OREQ 69                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C           PTYP      OREQ 71                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C           PTYP      OREQ 72                                        159256
     C           LNKS      ANDEQ'Y'                                       159256
     C                     MOVE 'LEM0232' ZAMSID                          159256
     C                     EXSR ZASNMS                                    159256
     C                     MOVE 'Y'       WE232   1                       159256
     C                     MOVE 'Y'       WWARN                           159256
      *                                                                   159256
     C                     ELSE                                           159256
      *                                                                   159256
     C                     MOVE *BLANKS   WE232                           159256
      *                                                                   159256
      ** Warn if loan or direct participation purchased but facility      159256
      ** is syndicated.                                                   159256
      *                                                                   159256
     C           PTYP      IFEQ 61                                        159256
     C           PTYP      OREQ 62                                        159256
     C           PTYP      OREQ 63                                        159256
     C           PTYP      OREQ 64                                        159256
     C           LNKS      ANDNE'Y'                                       159256
     C           PTYP      OREQ 65                                        159256
     C           LNKS      ANDNE'Y'                                       159256
     C           PTYP      OREQ 68                                        159256
     C           LNKS      ANDNE'Y'                                       159256
     C           PTYP      OREQ 70                                        159256
     C           PTYP      OREQ 71                                        159256
     C           LNKS      ANDNE'Y'                                       159256
      *                                                                   159256
     C                     MOVE 'A'       WRCDT1                          159256
     C                     MOVE FCUS      WFCUS                           159256
     C                     MOVE FTYP      WFTYP                           159256
     C                     MOVE FSEQ      WFSEQ                           159256
      *                                                                   159256
     C                     OPEN FCLTY                                     159256
     C           KFCLT     CHAINFCLTY                57                   159256
     C           SYIN      IFEQ 'Y'                                       159256
     C                     MOVE 'LEM0232' ZAMSID                          159256
     C                     EXSR ZASNMS                                    159256
     C                     MOVE 'Y'       WE232                           159256
     C                     MOVE 'Y'       WWARN                           159256
     C                     ENDIF                                          159256
     C                     CLOSEFCLTY                                     159256
     C                     ENDIF                                          159256
      *                                                                   159256
     C                     ENDIF                                          159256
     C                     ELSE                                           159256
      *                                                                   159256
     C                     MOVE *BLANKS   WE232                           159256
     C                     ENDIF                                          159256
      *                                                                   159256
     C                     ENDIF                                          159256
      *                                                                   159256
     C                     ENDSR                                          159256
      *                                                                   159256
      *****************************************************************
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *****************************************************************
     C           *PSSR     BEGSR
      *
     C                     ROLBK
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C           PMODE     IFEQ 'I'
     C           PMODE     OREQ 'R'
     C                     CALL 'DBERRCTL'
     C                     ENDIF
     C                     ENDIF
      *
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE9Z3
      /EJECT
     C/COPY ZSRSRC,ZEDITZ2
      /EJECT
     C/COPY ZSRSRC,ZFRPEDZ3
      /EJECT
     C/COPY ZSRSRC,ZFWDT                                                  CLE014
      /EJECT                                                              CLE014
     C/COPY ZSRSRC,ZACCH                                                  CLE014
      /EJECT                                                              CLE014
** CPY@  **      Copyright statement
(c) Finastra International Limited 2001
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
** CMD ** System commands
OVRDBF FILE(LEILAMLX) TOFILE(LEILAML2) SHARE(*NO)                                             202440
DLTOVR FILE(LEILAMLX)                                                                         202440
