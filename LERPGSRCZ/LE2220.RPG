     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Fee settlements and adjustments input')       *
      *****************************************************************
      *                                                               *
      *  Midas - Customer Lending Module                              *
      *                                                               *
      *  LE2220 - Fee Settlements and Adjustments Input               *
      *                                                               *
      *  Function:  This is a new program for Fee Settlements and     *
      *             Adjustments input.  This could be run in any of   *
      *             the four modes available, depending on the        *
      *             parameter passed to it.                           *
      *               1. Interactive ('I') - called from the Midas    *
      *                    Transaction Input menu                     *
      *               2. Record ('R') - Run interactively but updates *
      *                    are done to a new 'test harness' file      *
      *               3. Play ('P') - Run interactively but data is   *
      *                    read from the 'test harness' file          *
      *               4. Batch ('B') - Run in batch and called by a   *
      *                    communications control program             *
      *                                                               *
      *  Called By: LEC2220A - Fee Settlements Input                  *
      *             LEC2220B - Fee Adjustments Input                  *
      *  Calls    : SD2400 - Extended Settlements                     *
      *             SD2410 - Settlement Details Validation            *
      *             AOOUFAU0 - Update LE position files               *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. AR674226           Date 04Dec19               *
      *  Prev Amend No. CER050             Date 16Jun19               *
      *                 MD046248           Date 27Oct17               *
      *                 AR996895           Date 25Nov12               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CLE139             Date 06Dec10               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246141             Date 26Mar07               *
      *                 CAS016             Date 28Feb06               *
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 227717             Date 07Jun04               *
      *                 227710             Date 21May04               *
      *                 CLE038             Date 11May04               *
      *                 CIR013             Date 25Apr05               *
      *                 CAS009             Date 16May05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 29Oct03               *
      *                 CSF002             Date 11Aug03               *
      *                 219786             Date 17Jul03               *
      *                 219142             Date 24Jun03               *
      *                 219066             Date 20Jun03               *
      *                 CLE034             Date 05May03               *
      *                 CLE033             Date 09Apr03               *
      *                 CLE031             Date 04Feb03               *
      *                 CSD015             Date 14Oct02               *
      * Midas Release 4.01.03 ----------------------------------------*
      *                 208487             Date 17Mar03               *
      *                 201328             Date 27Nov02               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 205912             Date 06Jun02               *
      *                 205734             Date 06Jun02               *
      *                 204452             Date 02May02               *
      *                 204351             Date 02May02               *
      *                 205399             Date 02May02               *
      *                 204434             Date 25Apr02               *
      *                 202826             Date 25Apr02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun01               *
      *                 200289             Date 19Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 194509             Date 19Jun01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CLE013             Date 11Dec00               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CRT004             Date 04May00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 180573             Date 21Jun00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CLE009             Date 08Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 159695             Date 20May99               *
      *                 157580             Date 03May99               *
      *                 155772             Date 05Mar99               *
      *                 155931             Date 02Mar99               *
      *                 154799             Date 24Feb99               *
      *                 151295             Date 18Feb99               *
      *                 141453             Date 17Feb99               *
      *                 146488             Date 12Feb99               *
      *                 141474             Date 09Sep98               *
      *                 140815             Date 12Feb99               *
      *                 140611             Date 12Feb99               *
      *                 135446             Date 11Feb99               *
      *                 135152             Date 11Feb99               *
      *                 134284             Date 10Feb99               *
      *                 CEU004             Date 02Feb98               *
      *                 128566             Date 07Jan98               *
      *                 CLE005 *Create     Date 22May97               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  AR674226 - Manual transaction reached 999. Increase the size *
      *             of utilisation sequence no. and transaction       *
      *             sequence. (Child: AR674227)                       *
      *           - Applied for MD054782.                             *
      *  CER050 - Annualised Percentage Rate (Recompile)              *
      *  MD046248 - Finastra Rebranding                               *
      *  AR996895 - Incorrect accrual interest calculation.           *
      *             (Child:AR996897) (Recompile)                      *
      *  CLE134 - Past Due Call Loan Processing                       *
      *  CLE148 - Alpha Loan Reference                                *
      *  CLE139 - Lending Fee Capitalisation (Recompile)              *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *            to Midas Plus (Recompile)                          *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  246141 - Recompiled due to changes in ZINTDYZ2               *
      *  CAS016 - IAS18 EIR Recalculation (Fee Amortisation Over      *
      *           Whole Period) -Recompile.                           *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  227717 - Decimal places were not set up for amounts sent     *
      *           by batch                                            *
      *  227710 - If F3 is pressed in the settlement programs, ensure *
      *           that all database changes are rolled back.          *
      *  CLE038 - Lending Enhancement for Nordea: Allocation by Amount*
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over ZINTDY.                              *
      *  CAS009 - EIR/AC Accounting (Recompile)                       *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Parameter Mismatch                                  *
      *  CSF002 - Global layer.                                       *
      *           - Replace previous ZBACT* parameters with the new   *
      *             unique code.                                      *
      *  219786 - If interactive and a fee settlement for an internal *
      *           field, settlement allocation field is always No     *
      *  219142 - In batch mode, *PSSR was not setting up info to tell*
      *           LE2010M that it has had a dberr                     *
      *           U7 and U8 being setup incorrectly if an error.      *
      *           Change parameters to be based on file structures    *
      *           Check for database error correctly from SD2410      *
      *           Reset message file after errors from SD2410         *
      *           Always set up settlement fields if in batch         *
      *  219066   Settlement allocations on LESTALPD has blank PC Ref.*
      *  CLE034 - Lending Enhancements.                               *
      *  CLE033 - Settlement method 09 - recompiled                   *
      *  CLE031 - Lending Enhancements.                               *
      *  CSD015 - Midas Compliance Watch - Watch List Checking        *
      *  208487 - Error msg 'record updated by another workstation'   *
      *           during amend/delete/authorise Fee adjustment.       *
      *  201328 - Rename WFEEAD fields with FA prefix, to match the   *
      *           LEFEEAD fields, to ensure the correct settlement    *
      *           instructions are being passed to AOOUFAU0. Also use *
      *           correct amount when Write Off amount is amended.    *
      *  205912 - Record locking occurs on LF/LEFEEDL1 when a new Fee *
      *           Settlement is inserted.  Unable to authorise thru   *
      *           another session while the inserting job is still in *
      *           the entry screen.  Amended chain operations to      *
      *           prevent record lock on the said file.               *
      *           Continuation of 202581.                             *
      *         - Save the transaction number before any new chain to *
      *           LEFEEAxx to avoid error LER0071 later in the pgm.   *
      *  205734 - Insert of fee adjustment on the day of fee next     *
      *           payment date should not be allowed due to current   *
      *           problem in LER135.                                  *
      *  204452 - Recompiled due to changed PF/LEFEED.                *
      *  204351 - Incorrect total accrued to date for newly inserted  *
      *           fees based on actual amounts when there is a        *
      *           movement for the facility in PF/FACHISA.            *
      *  205399 - Fee Amount Due / Past Due should be adjusted by the *
      *           amounts of any existing settlements on LEFEEAD.     *
      *  204434 - Insert of full payment not allowed when the last    *
      *           record read by the system is either 'P'artial or    *
      *           'W'rite off settlement.                             *
      *  202826 - Amended validation of fee settlement input.         *
      *  CPK015 - A default timestamp string is required for          *
      *           file LEFEEA* writes.                                *
      *  200289 - Expand facility history sequence field (STFSEQ)     *
      *           from 2N to 3N.                                      *
      *  194509 - Amended Transactions go to Re-auth and then complete*
      *  CLE013 - Customer Lending Fees Enhancement - Phase 1         *
      *  CRT004 - Cashier Midas TCP/IP interface.                     *
      *             Recompiled over SDBRCHPD Changes                  *
      *  180573 - Original message IDs have subsequently been over-   *
      *           written for new programs.                           *
      *  CLE009 - LE I/C Swift Message Generation for Fees            *
      *  159695 - LER170, orig sett date is showing date in future    *
      *  157580 - Recompile due to changes in LE2220DF.               *
      *  155772 - SSTS should be set to 'A' when reversed.  Also,     *
      *           return code parameter when calling AOOUFAU0 should  *
      *           not be set to blank in order not to overwrite the   *
      *           value set previously by batch mode.                 *
      *  155931 - Settlement branch is cleared when f12 is the        *
      *           first action on the extended settlement screen.     *
      *  154799 - Recompiled due to changes in /COPY,ZACCH            *
      *  151295 - Problems authorising repayment schedules            *
      *           Recompiled due to changes in ZCHKH                  *
      *  141453 - Recompiled due to changes in PF/LEFEED              *
      *  141474 - Value for parameter MSGID not a valid name for      *
      *           non-authorised fee settlement                       *
      *  146488 - Allocates UTN for inputs from Midas.  Produces      *
      *           error message when same settlement is entered from  *
      *           both Midas and Loan Manager.                        *
      *  140815 - User should be able to use Customer Shortname on    *
      *           input of Fee Adjustment                             *
      *  140611 - Accrued to date should be up to today.              *
      *  135446 - Rollback should only be issued from LE2010 for      *
      *           batch mode.                                         *
      *  135152 - There needs to be a separate standard settlement    *
      *           instruction transaction type for Lending - use of   *
      *           'MM' is not sufficiently flexible                   *
      *  134284 - Use first parameter of positions update program     *
      *           to suppress rollback in batch mode.                 *
      *  CEU004 - LE Settlement Ccy Conversion Upgrade to DBA R2.0    *
      *  128566 - Extended settlement is available only for non-      *
      *           internal fee settlement                             *
      *  CLE005 - Customer Lending Enhancements - Others (T3)         *
      *                                                               *
      *****************************************************************
     FLE2220DFCF  E                    WORKSTN                        UC
     F                                        SRRN  KSFILE LE2220S0
     F/COPY WNCPYSRC,LEH00772
      *
     FLE2220PDUF  E                    DISK         KINFSR *PSSR A    UC
      *
     FLEFEEAL0UF  E           K        DISK         KINFSR *PSSR A
     F                                              KCOMIT
     F            LEFEEADF                          KRENAMELEFEEAD0
      *
     FLEFEEAL2UF  E           K        DISK         KINFSR *PSSR A
     F                                              KCOMIT
     F            LEFEEADF                          KRENAMELEFEEAD2
      *
     FLEFEEAZ UF  E                    DISK         KINFSR *PSSR A
     F                                              KCOMIT
      *
     FLEFEEAL1IF  E           K        DISK
     F            LEFEEADF                          KRENAMELEFEEAD1
      *
     FLEFEEAL3IF  E           K        DISK
     F            LEFEEADF                          KRENAMELEFEEAD3
      *
     F**********LEFEEDL1IF  E           K        DISK                     CLE009
     FLEFEEDL1UF  E           K        DISK                               CLE009
     FFACHISH IF  E           K        DISK                               140611
     FFACHSAL1IF  E           K        DISK                               140611
     FFCLTYL1 IF  E           K        DISK                               140611
     FSDCURRPDIF  E           K        DISK                               140611
      *                                                                                       CSD015
     FSDCWHTL1IF  E           K        DISK                                                   CSD015
      ** Compliance Watch Hit List by Function Type/Identifier/Branch                         CSD015
      *                                                                                       CSD015
     F/COPY WNCPYSRC,LE2220F001
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *    F U N C T I O N   O F   I N D I C A T O R S                *
      *                                                               *
      *    11           CLE034 is installed                           *                       CLE034
      *    12           Invalid Settlement Allocation                 *                       CLE034
      *    21           Fee adjustment input                          *
      *    22           Fee settlement input                          *
      *    23           SAR CLE002 is installed                       *
      *    24           Insert action                                 *
      *    25           Delete action                                 *
      *    26           Authorise action                              *
      *    27           Allow and enable F14                          *
      *    28           Protect screen fields for actions A, D and X  *
      *    29           Allow rollup/rolldown on subfile              *
      *    30           Invalid action                                *
      *    31           Invalid customer                              *
      *    32           Invalid facility                              *
      *    33           Invalid fee sequence                          *
      *    34           Invalid value date                            *
      *    35           Invalid review from customer                  *
      *    36           Invalid review from facility                  *
      *    37           Invalid review from fee sequence              *
      *    38           Invalid requiring authorisation field         *
      *    39           Invalid adjustment amount                     *
      *    40           Invalid adjustment sign                       *
      *    41           Invalid settlement amount                     *
      *    42           Invalid write off/full/partial                *
      *    50           Work indicator (TESTN)                        *
      *    51           Work indicator (TESTN)                        *
      *    70           Write/update error                            *
      *    71           EOF on fee settlement/adjustment file         *
      *    72           EOF on test harness file                      *
      *    73           EOF on changed subfile records                *
      *    75           Message subfile end                           *
      *    76           Subfile next change                           *
      *    77           No record in subfile                          *
      *    78           Subfile clear                                 *
      *    79           Subfile end                                   *
      *    98           Date format is MMDDYY                         *
      *    99           Standard subroutine indicator                 *
      *                                                               *
      *****************************************************************
      /EJECT
     E                    CPY@    1   1 80
     E                    STAMP   1   1 26                                                    CPK015
     E                    POWER   1   7  7 3             POWER ARRAY      140611
     E                    TABCAL  6   6  1 0 TABCBS  5 0 CALC.BASES       140611
     E                    FEAM        5 11 0A            FEE AMOUNTS      140611
     E                    FAM         5 13 0A            FEE AMOUNTS      140611
     E                    FRT         5  7 5A            FEE RATES        140611
     E                    FPC         5  6 3A            FEE PERCENTAGE   140611
     E                    CURR      150  3               ALL CCYS         140611
     E                    CSPT      150 13 8             SPOT RATES/CCY   140611
     E                    MTDV      150  1               M/D INDICATOR/CCY140611
     E                    CCDP      150  1 0             DEC PLACES/CCY   140611
     E                    CCNO      150  2 0             SORT SEQ.NO/CCY  140611
     E                    WPAM       10 13 0A            AMOUNT DUE (less payments)           204434
      ** Copyright statement
      *
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZDATE9Z1
     E/COPY ZSRSRC,ZEDITZ1                                                                    CLE031
     E/COPY ZSRSRC,ZFRPEDZ1
     E/COPY ZSRSRC,ZHOLE
     E                    OPTAG   1  13 25                                                    CSD015
     E                    CLTAG   1  13 25                                                    CSD015
      ** Watch List fields Open and Close tags                                                CSD015
      *                                                                                       CSD015
      /EJECT
     ILE2220D0                                                                                CGL029
     I              QQPONS                          Q2PONS                                    CGL029
     I              QQRONS                          Q2RONS                                    CGL029
      *                                                                   CLE009
     ILEFEEDF                                                             CLE009
     I              OSDB                            FEOSDB                CLE009
     I              XUSR                            FEXUSR                CLE009
     I              PCRF                            FEPCRF                CLE009
     I              RSTM                            FERSTM                CLE009
     I              RONS                            FERONS                CLE009
     I              RIBN                            FERIBN                CLE009
     I              RIBA                            FERIBA                CLE009
     I              ROBN                            FEROBN                CLE009
     I              ROCN                            FEROCN                CLE009
     I              LSWS                            FELSWS                CLE009
     I              LSWC                            FELSWC                CLE009
     I/COPY WNCPYSRC,LE2220I002
      *
     ILEFEEAD0
      ** Rename fields for to start with 'FA' for consistency
     I              SSTS                            FASSTS
     I              IUSR                            FAIUSR
     I              AUSR                            FAAUSR
     I              XUSR                            FAXUSR
     I              PCRF                            FAPCRF
     I              PTFI                            FAPTFI
     I              OSDB                            FAOSDB
     I              OMDB                            FAOMDB
     I              RSTM                            FARSTM
     I              RONS                            FARONS
     I              RIBN                            FARIBN
     I              RIBA                            FARIBA
     I              ROBN                            FAROBN
     I              ROCN                            FAROCN
     I              PSTM                            FAPSTM
     I              PONS                            FAPONS
     I              PIBN                            FAPIBN
     I              PIBA                            FAPIBA
     I              POBN                            FAPOBN
     I              POCN                            FAPOCN
     I              RCRN                            FARCRN
     I              RCRA                            FARCRA
     I              RVNO                            FARVNO
     I              AWBN                            FAAWBN
     I              AWBA                            FAAWBA
     I              BENN                            FABENN
     I              BENA                            FABENA
     I              DTP1                            FADTP1
     I              DTP2                            FADTP2
     I              DTP3                            FADTP3
     I              DTP4                            FADTP4
     I              DCHG                            FADCHG
     I              BTB1                            FABTB1
     I              BTB2                            FABTB2
     I              BTB3                            FABTB3
     I              BTB4                            FABTB4
     I              BTB5                            FABTB5
     I              BTB6                            FABTB6
     I              CVMR                            FACVMR
     I              PCOB                            FAPCOB
      *                                                                   141474
     ILEFEEAD1                                                            141474
      ** Rename fields for to start with 'FA' for consistency             141474
     I              SSTS                            FASSTS                141474
     I              IUSR                            FAIUSR                141474
     I              AUSR                            FAAUSR                141474
     I              XUSR                            FAXUSR                141474
     I              PCRF                            FAPCRF                141474
     I              PTFI                            FAPTFI                141474
     I              OSDB                            FAOSDB                141474
     I              OMDB                            FAOMDB                141474
     I              RSTM                            FARSTM                141474
     I              RONS                            FARONS                141474
     I              RIBN                            FARIBN                141474
     I              RIBA                            FARIBA                141474
     I              ROBN                            FAROBN                141474
     I              ROCN                            FAROCN                141474
     I              PSTM                            FAPSTM                141474
     I              PONS                            FAPONS                141474
     I              PIBN                            FAPIBN                141474
     I              PIBA                            FAPIBA                141474
     I              POBN                            FAPOBN                141474
     I              POCN                            FAPOCN                141474
     I              RCRN                            FARCRN                141474
     I              RCRA                            FARCRA                141474
     I              RVNO                            FARVNO                141474
     I              AWBN                            FAAWBN                141474
     I              AWBA                            FAAWBA                141474
     I              BENN                            FABENN                141474
     I              BENA                            FABENA                141474
     I              DTP1                            FADTP1                141474
     I              DTP2                            FADTP2                141474
     I              DTP3                            FADTP3                141474
     I              DTP4                            FADTP4                141474
     I              DCHG                            FADCHG                141474
     I              BTB1                            FABTB1                141474
     I              BTB2                            FABTB2                141474
     I              BTB3                            FABTB3                141474
     I              BTB4                            FABTB4                141474
     I              BTB5                            FABTB5                141474
     I              BTB6                            FABTB6                141474
     I              CVMR                            FACVMR                141474
     I              PCOB                            FAPCOB                141474
      *
     ILEFEEAD2
      ** Rename fields for to start with 'FA' for consistency
     I              SSTS                            FASSTS
     I              IUSR                            FAIUSR
     I              AUSR                            FAAUSR
     I              XUSR                            FAXUSR
     I              PCRF                            FAPCRF
     I              PTFI                            FAPTFI
     I              OSDB                            FAOSDB
     I              OMDB                            FAOMDB
     I              RSTM                            FARSTM
     I              RONS                            FARONS
     I              RIBN                            FARIBN
     I              RIBA                            FARIBA
     I              ROBN                            FAROBN
     I              ROCN                            FAROCN
     I              PSTM                            FAPSTM
     I              PONS                            FAPONS
     I              PIBN                            FAPIBN
     I              PIBA                            FAPIBA
     I              POBN                            FAPOBN
     I              POCN                            FAPOCN
     I              RCRN                            FARCRN
     I              RCRA                            FARCRA
     I              RVNO                            FARVNO
     I              AWBN                            FAAWBN
     I              AWBA                            FAAWBA
     I              BENN                            FABENN
     I              BENA                            FABENA
     I              DTP1                            FADTP1
     I              DTP2                            FADTP2
     I              DTP3                            FADTP3
     I              DTP4                            FADTP4
     I              DCHG                            FADCHG
     I              BTB1                            FABTB1
     I              BTB2                            FABTB2
     I              BTB3                            FABTB3
     I              BTB4                            FABTB4
     I              BTB5                            FABTB5
     I              BTB6                            FABTB6
     I              CVMR                            FACVMR
     I              PCOB                            FAPCOB
      *                                                                   141474
     ILEFEEAD3                                                            141474
      ** Rename fields for to start with 'FA' for consistency             141474
     I              SSTS                            FASSTS                141474
     I              IUSR                            FAIUSR                141474
     I              AUSR                            FAAUSR                141474
     I              XUSR                            FAXUSR                141474
     I              PCRF                            FAPCRF                141474
     I              PTFI                            FAPTFI                141474
     I              OSDB                            FAOSDB                141474
     I              OMDB                            FAOMDB                141474
     I              RSTM                            FARSTM                141474
     I              RONS                            FARONS                141474
     I              RIBN                            FARIBN                141474
     I              RIBA                            FARIBA                141474
     I              ROBN                            FAROBN                141474
     I              ROCN                            FAROCN                141474
     I              PSTM                            FAPSTM                141474
     I              PONS                            FAPONS                141474
     I              PIBN                            FAPIBN                141474
     I              PIBA                            FAPIBA                141474
     I              POBN                            FAPOBN                141474
     I              POCN                            FAPOCN                141474
     I              RCRN                            FARCRN                141474
     I              RCRA                            FARCRA                141474
     I              RVNO                            FARVNO                141474
     I              AWBN                            FAAWBN                141474
     I              AWBA                            FAAWBA                141474
     I              BENN                            FABENN                141474
     I              BENA                            FABENA                141474
     I              DTP1                            FADTP1                141474
     I              DTP2                            FADTP2                141474
     I              DTP3                            FADTP3                141474
     I              DTP4                            FADTP4                141474
     I              DCHG                            FADCHG                141474
     I              BTB1                            FABTB1                141474
     I              BTB2                            FABTB2                141474
     I              BTB3                            FABTB3                141474
     I              BTB4                            FABTB4                141474
     I              BTB5                            FABTB5                141474
     I              BTB6                            FABTB6                141474
     I              CVMR                            FACVMR                141474
     I              PCOB                            FAPCOB                141474
      *
     IA@CPY       DS
      * Copyright array
     I                                        1  80 CPY@
      *
     ILDA         DS                            256
      ** Local data area for database error details
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I                                      184 256 DBTXT
      *
     IPSDS       SDS
      ** Program Status Data Structure - gives Job/Workstation name and
      ** User ID
     I                                     *PROGRAM ##PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
     ICMTTXT      DS                            179
      ** Data structure for setup of commitment text
     I                                        1   50WCNATN
     I                                        6   7 WCMDID
     I                                        8  15 WCPGMN
     I                                       16  18 WCWSID
     I                                       19  240WCTIME
     I                                       25  25 WCACTN
     I                                       26  35 WCUSER
     I                                       51 179 WCSCRN
      *
     I**PINPP*******DS                           1024                                         219142
     IPINPP     E DSLEF5MFPD                                                                  219142
      ** Transmitted message format
     I                                        1   4 PMTYP
     I                                        5  20 PTUSR
     I                                       21  36 PTWID
     I                                       37  51 PTREF
     I                                       52  55 PTSEQ
     I                                       56  56 PTACT
     I                                       57  64 PTDAT
     I                                       65  72 PTTIM
     I                                       73  76 PNBAT
     I                                       77  80 PFILL
     I                                       81  86 PCNUM
     I                                       87  89 PFACT
     I                                       90  91 PFCNO
     I                                       92  93 PFSEQ
     I                                       94  95 PVDT1
     I                                       96  97 PVDT2
     I                                       94 101 PVDAT
     I                                      102 115 PSADJ
     I                                      116 116 PSIGN
     I                                      117 117 PTYPE
     I                                      118 119 PPSTM
     I                                      120 134 PPONS
     I                                      135 142 PRVNO
     I                                      143 143 PCVMR
     I                                      144 149 PPOCN
     I                                      150 155 PPOBN
     I                                      156 163 PRCRN
     I                                      164 198 PRCRA
     I                                      199 206 PRIBN
     I                                      207 241 PRIBA
     I                                      242 249 PAWBN
     I                                      250 284 PAWBA
     I                                      285 292 PBENN
     I                                      293 327 PBENA
     I                                      328 329 PRSTM
     I                                      330 344 PRONS
     I                                      345 350 PROCN
     I                                      351 356 PROBN
     I                                      357 364 PPIBN
     I                                      365 399 PPIBA
     I                                      400 434 PDTP1
     I                                      435 469 PDTP2
     I                                      470 504 PDTP3
     I                                      505 539 PDTP4
     I                                      540 542 PDCHG
     I                                      543 577 PBTB1
     I                                      578 612 PBTB2
     I                                      613 647 PBTB3
     I                                      648 682 PBTB4
     I                                      683 717 PBTB5
     I                                      718 752 PBTB6
     I                                      753 762 PIUSR
     I                                      763 772 PAUSR
     I                                      773 782 PXUSR
     I                                      783 785 PPCOB
     I                                      786 788 PSCCY                 CEU004
     I                                      789 791 PICCY                 CEU004
     I                                      792 805 PREXR                                     CLE031
     I                                      806 806 PREXI                                     CLE031
     I                                      807 809 PPSCY                                     CLE031
     I                                      810 823 PPEXR                                     CLE031
     I                                      824 824 PPEXI                                     CLE031
     I                                      825 825 PSTAL                                     CLE034
      *
     I***POUTP*******DS                            192                                        219142
     IPOUTP     E DSLEF6MFPD                                                                  219142
      ** Returned message format
     I                                        1   4 PRMTP
     I                                        5  20 PRTUS
     I                                       21  36 PRTWS
     I                                       37  51 PRTRF
     I                                       52  55 PRTSQ
     I                                       56  56 PRTAC
     I                                       57  64 PRTDT
     I                                       65  72 PRTTM
     I                                       73  76 PRRBT
     I                                       77  80 PRFIL
     I                                       81  81 PRMSV
     I                                       82  88 PRMID
     I                                       89 166 PRMTX
     I                                      167 172 PRCNO
     I                                      173 175 PRFTP
     I                                      176 177 PRFNO
     I                                      178 179 PRFSQ
     I                                      180 187 PRVDT
     I*                                                                   140611
     I            DS                                                      140611
     I** Fee amounts data structure                                       140611
     I                                    P   1  300FEAM                  140611
     I                                    P   1   60FEAMT1                140611
     I                                    P   7  120FEAMT2                140611
     I                                    P  13  180FEAMT3                140611
     I                                    P  19  240FEAMT4                140611
     I                                    P  25  300FEAMT5                140611
     I*                                                                   140611
     I            DS                                                      140611
     I** Fee rates data structure                                         140611
     I                                    P   1  205FRT                   140611
     I                                    P   1   45FEFRT1                140611
     I                                    P   5   85FEFRT2                140611
     I                                    P   9  125FEFRT3                140611
     I                                    P  13  165FEFRT4                140611
     I                                    P  17  205FEFRT5                140611
     I*                                                                   140611
     I            DS                                                      140611
     I                                        1   50FEFACL                140611
     I                                        1   5 FACNO                 140611
     I                                        1   30FTYP                  140611
     I                                        4   50FSEQ                  140611
     I*                                                                   140611
     I            DS                                                      140611
     I                                        1  14 WUKEY                 140611
     I                                        1   3 WUBRCA                140611
     I**********                              4   90WUCNUM                             140611 CSD027
     I                                        4   9 WUCNUM                                    CSD027
     I                                       10  140WUFREF                140611
     I                                       10  120WUFACT                140611
     I                                       13  140WUFCNO                140611
      ** Fee amount due lee amount paid                                                       204434
      *                                                                                       204434
     I            DS                                                                          204434
     I                                    P   1  700WPAM                                      204434
     I                                    P   1   70WPAM1                                     204434
     I                                    P   8  140WPAM2                                     204434
     I                                    P  15  210WPAM3                                     204434
     I                                    P  22  280WPAM4                                     204434
     I                                    P  29  350WPAM5                                     204434
     I                                    P  36  420WPAM6                                     204434
     I                                    P  43  490WPAM7                                     204434
     I                                    P  50  560WPAM8                                     204434
     I                                    P  57  630WPAM9                                     204434
     I                                    P  63  700WPAM10                                    204434
      *                                                                                       CSD015
     IPXML        DS                           9999                                           CSD015
      ** 2ND PARAMETER in XML Format for Compliance Engine Program                            CSD015
      *                                                                                       CSD015
     I/COPY WNCPYSRC,LE2220I001
      *
     ISETLIB    E DSSETLIAB
     I              QQPONS                          Q1PONS                                    CGL029
     I              QQRONS                          Q1RONS                                    CGL029
      ** Data structure for passing a parameter to synon screen
      ** handling program.
      *
     ISETLIZ    E DSSETLIAZ
      ** Data structure for passing a parameter to synon screen
      ** handling program.
     I@PARM3    E DSSDSETLPD                                              222373
      *
     IZ#BSTS    E DSZ#BST
      ** Before image of update to LE position files
      *
     IZ#ASTS    E DSZ#AST
      ** After image of update to LE position files
      *
     IZ#WSTS    E DSZ#WST
      ** Work file of update to LE position files
      *
     IWFEEAD    E DSLEFEEAD
      ** Data structure to hold the fee settlement/adjustment record
      ** Rename fields for to start with 'FA' for consistency                                 201328
     I              SSTS                            FASSTS                                    201328
     I              IUSR                            FAIUSR                                    201328
     I              AUSR                            FAAUSR                                    201328
     I              XUSR                            FAXUSR                                    201328
     I              PCRF                            FAPCRF                                    201328
     I              PTFI                            FAPTFI                                    201328
     I              OSDB                            FAOSDB                                    201328
     I              OMDB                            FAOMDB                                    201328
     I              RSTM                            FARSTM                                    201328
     I              RONS                            FARONS                                    201328
     I              RIBN                            FARIBN                                    201328
     I              RIBA                            FARIBA                                    201328
     I              ROBN                            FAROBN                                    201328
     I              ROCN                            FAROCN                                    201328
     I              PSTM                            FAPSTM                                    201328
     I              PONS                            FAPONS                                    201328
     I              PIBN                            FAPIBN                                    201328
     I              PIBA                            FAPIBA                                    201328
     I              POBN                            FAPOBN                                    201328
     I              POCN                            FAPOCN                                    201328
     I              RCRN                            FARCRN                                    201328
     I              RCRA                            FARCRA                                    201328
     I              RVNO                            FARVNO                                    201328
     I              AWBN                            FAAWBN                                    201328
     I              AWBA                            FAAWBA                                    201328
     I              BENN                            FABENN                                    201328
     I              BENA                            FABENA                                    201328
     I              DTP1                            FADTP1                                    201328
     I              DTP2                            FADTP2                                    201328
     I              DTP3                            FADTP3                                    201328
     I              DTP4                            FADTP4                                    201328
     I              DCHG                            FADCHG                                    201328
     I              BTB1                            FABTB1                                    201328
     I              BTB2                            FABTB2                                    201328
     I              BTB3                            FABTB3                                    201328
     I              BTB4                            FABTB4                                    201328
     I              BTB5                            FABTB5                                    201328
     I              BTB6                            FABTB6                                    201328
     I              CVMR                            FACVMR                                    201328
     I              PCOB                            FAPCOB                                    201328
      *
     ISCRN      E DSLE2220DF
      ** Screen details for commitment text
      *                                                                   146488
     ILEALLO    E DSLEALLO                                                146488
      * DS for calculating PC reference                                   146488
      *
     I            DS
      ** Date format for test harness file
     I                                        1   8 WTDAT
     I                                        1   2 WTDT1
     I I            '/'                       3   3 WFIL1
     I                                        4   5 WTDT2
     I I            '/'                       6   6 WFIL2
     I                                        7   8 WTDT3
      *
     I            DS
      ** Time format for test harness file
     I                                        1   8 WTTIM
     I                                        1   2 WTTM1
     I I            ':'                       3   3 WFIL3
     I                                        4   5 WTTM2
     I I            ':'                       6   6 WFIL4
     I                                        7   8 WTTM3
      *
     I            DS
      ** Separate date values
     I                                        1   6 WDATE
     I                                        1   2 WDAT1
     I                                        3   4 WDAT2
     I                                        5   6 WDAT3
      *
     I            DS
      ** Separate time values
     I                                        1   60WTIME
     I                                        1   2 WTIM1
     I                                        3   4 WTIM2
     I                                        5   6 WTIM3
      *
     I            DS
     I                                        1  14 SREVW
     I                                        1   6 SRCUS
     I                                        7   9 SRFAC
     I                                       10  11 SRFNO
     I                                       12  13 SRFSQ
     I                                       14  14 SRAUT
      *
     I            DS
      ** Format amount returned by standard subroutine
     I                                        1  22 ZOUT22
     I                                        1  21 ZOUT21
     I                                        1  20 ZOUT20
      *
     I/COPY QWINDSRC,LE2220GDTA
      ** Data to be passed to window program
      *
     ISCSARD    E DSSCSARDPD
      ** SAR details
      *
     ISDBANK    E DSSDBANKPD
      ** Bank details
      *
     ISDCLND    E DSSDCLNDPD
      ** Customer Lending ICD
      *
     ISDCURR    E DSSDCURRPD
      ** Currency details
      *
     ISDCUST    E DSSDCUSTPD
      ** Customer details
      *
     ISDFEE     E DSSDFEEPD
      ** Fee codes details
      *
     ISDMMOD    E DSSDMMODPD
      ** Midas Modules details
      *
     ISDRETL    E DSSDRETLPD
      ** Retail details
      *
     ISDBRCH    E DSSDBRCHPD                                              146488
     I              QQDFAC                          Q1DFAC                                    CGL029
      ** External DS for Branch Codes                                     146488
      *                                                                   146488
     IDSFDY     E DSDSFDY
      ** Short data structure for access objects
      *
     IDSSDY     E DSDSSDY
      ** Long data structure for access objects
     IRUNDAT    E DSRUNDAT                                                140611
      ** Data Area giving Installation Control Details                    140611
      *
     ISDWLCC    E DSSDWLCCPD                                                                  CSD015
      ** Midas Functions for Watch List Checking Details File                                 CSD015
      *                                                                                       CSD015
     ISDCWCD    E DSSDCWCDPD                                                                  CSD015
      ** Midas SD Watch List Configuration Data File                                          CSD015
      *                                                                                       CSD015
     IPSDWLT    E DSSDWLTOPD                                                                  CSD015
      ** Watch List Transaction details file                                                  CSD015
      *                                                                                       CSD015
     ISC24X7    E DSSC24X7                                                                    CSD015
      ** 24X7 Data area                                                                       CSD015
      *                                                                                       CSD015
     ISDSTAT    E DSSDSTAT                                                                    CSD015
      ** SDSTAT Data area                                                                     CSD015
      *                                                                                       CSD015
     I/COPY ZSRSRC,ZDAT10Z1
     I/COPY ZSRSRC,ZFRPEDZ2
     I/COPY ZSRSRC,ZHOLI
     I/COPY ZSRSRC,ZTNLU1Z1
     I/COPY ZSRSRC,ZINTDYZ1                                               CLE013
     I/COPY ZSRSRC,ZDATE9Z2                                               CLE013
      /EJECT
      *****************************************************************
      *                   Index to subroutines                        *
      *  Main routine                                                 *
      *  SRINIT  -  Initial processing                                *
      *  SRBTCH  -  Batch processing for play/batch mode              *
      *  SRBTSC  -  Format screen fields for batch/play mode          *
      *  SR2410  -  Validate settlement screen for batch/play mode    *
      *  SRSTRT  -  Validate initial screen                           *
      *  SRVKEY  -  Validate key fields                               *
      *  SRSFIL  -  Subfile processing                                *
      *  SRVSUB  -  Validate subfile entries                          *
      *  SRSPRO  -  Process each subfile request                      *
      *  SRINSC  -  Format screen fields for interactive/record mode  *
      *  SRLOAD  -  Load subfile records                              *
      *  SRVREV  -  Validate review from entries                      *
      *  SRAUTH  -  Validate authorisation action                     *
      *  SRCAUT  -  Check if user is authorised to the action         *
      *  SRFSET  -  Read all settlements for the fee                  *
      *  SRDTL1  -  Process detail screen                             *
      *  SRVALD  -  Validate detail screen                            *
      *  SRVFES  -  Validate fee settlement                           *
      *  SRVFEA  -  Validate fee adjustment                           *
      *  SRDTL2  -  Extended settlement processing                    *
      *  SREXST  -  Format fields for extended settlement             *
      *  SRMFSC  -  Move file values to settlement screen             *
      *  SRINST  -  Initialise settlement fields on insert            *
      *  SRBPEX  -  Format extended settlement fields for batch/play  *
      *  SRSHNM  -  Move customer number to shortname counterpart     *
      *  SRCHOL  -  Check if value date is a holiday                  *
      *  SRINSR  -  Insert new fee and fee adjustments/settlements    *
      *  SRUPDR  -  Update existing fee adjustments/settlements       *
      *  SRSWRI  -  Update Fees File                                  *   CLE009
      *  SRMVST  -  Update settlement fields                          *
      *  SRRCRD  -  Write to test harness file when in record mode    *
      *  SRSHDW  -  Update shadow files                               *
      *  SRCMTX  -  Commit file updates                               *
      *  CLEAR   -  Clears message from the program message queue     *
      *  ZASNMS  -  Sends message to the program message queue        *
      *  SRBERR  -  Set up batch error details                        *
      *  *PSSR   -  Error handling subroutine                         *
      *****************************************************************
      *
      ** Perform initial processing
      *
     C                     EXSR SRINIT
      *
      ** Perform different detailed processing
      *
     C           WFMT      DOWNE*BLANK
     C           WFMT      CASEQ'F0'      SRSTRT
     C           WFMT      CASEQ'S0'      SRSFIL
     C           WFMT      CASEQ'D1'      SRDTL1
     C           WFMT      CASEQ'D2'      SRDTL2
     C           WFMT      CASEQ'WR'      SRINSR
     C           WFMT      CASEQ'UP'      SRUPDR
     C                     ENDCS
     C                     ENDDO
      *
      ** Close SD2400 program for interactive/record mode and end
      ** this programs processing
      *
     C                     MOVE 'T'       PMTERM
     C                     CALL 'SD2400'
     C                     PARM *BLANKS   PRTCD
     C                     PARM           SETLIB
     C                     PARM           SETLIZ
     C                     PARM           PLNRF
     C                     PARM           @PARM3                          222373
     C           PMODE     IFNE 'B'                                                           227710
     C           PMODE     ANDNE'P'                                                           227710
     C                     ROLBK                                                              227710
     C                     ENDIF                                                              227710
      *
     C                     MOVE '1'       *INLR
      /EJECT
      *****************************************************************
      * SRINIT  -  Initial Processing                                 *
      * Called by: Main routine                                       *
      * Calls    : SRBTCH - Batch processing for batch/play modes     *
      *****************************************************************
     C           SRINIT    BEGSR
      *
      ** Set up copyright parameter
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ** Receive entry parameters
      *
     C           *ENTRY    PLIST
     C                     PARM           PMODE   1
     C                     PARM           PFTYP   1
     C                     PARM           PINPP
     C                     PARM           POUTP
     C                     PARM           PTMST  26                                           CLE034
      *
      ** Define data area
      *
     C           *NAMVAR   DEFN           LDA
     C           *NAMVAR   DEFN           RUNDAT                          140611
     C                     IN   RUNDAT                                    140611
      *
      ** Initialise LDA
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'LE2220  'DBPGM
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVE *BLANKS   DBTXT
     C                     OUT  LDA
      *
      ** Key list for fee details and fee adjustment (LEFEED, LEFEEAL0)
      *
     C           WKFEE     KLIST
     C**********           KFLD           WCNUM   60                                          CSD027
     C                     KFLD           WCNUM   6                                           CSD027
     C                     KFLD           WFACL   50
     C**********           KFLD           WLOAN   60                                          CLE148
     C                     KFLD           WLOAN   6                                           CLE148
     C                     KFLD           WFSEQ   20
      *
      ** Key list for fee settlement (LEFEEAL2)
      *
     C           WKFES     KLIST
     C                     KFLD           WCNUM
     C                     KFLD           WFACL
     C                     KFLD           WLOAN
     C                     KFLD           WFSEQ
     C                     KFLD           WVDAT   50
     C*                                                                   140611
     C** Set up KLIST for accessing Facility file                         140611
     C*                                                                   140611
     C           FACKEY    KLIST                                          140611
     C**********           KFLD           FECNUM  60                                   140611 CSD027
     C                     KFLD           FECNUM  6                                           CSD027
     C                     KFLD           FTYP    30                      140611
     C                     KFLD           FSEQ    20                      140611
     C*                                                                   140611
     C*                                                                   140611
     C** Define key list for read of FACHSAL1 file - full key.            140611
     C*                                                                   140611
     C           HSAKY1    KLIST                                          140611
     C                     KFLD           FECNUM                          140611
     C                     KFLD           FEFACL                          140611
     C                     KFLD           STDATE                          140611
     C                     KFLD           STFSEQ                          140611
     C*                                                                   140611
     C** Define key list for read of FACHSAL1 file - partial key.         140611
     C*                                                                   140611
     C           HSAKY2    KLIST                                          140611
     C                     KFLD           FECNUM                          140611
     C                     KFLD           FEFACL                          140611
     C*                                                                   140611
     C** Define key list for read of FCLTYL1 file.                        140611
     C*                                                                   140611
     C           KFCLTY    KLIST                                          140611
     C                     KFLD           WUBRCA                          140611
     C                     KFLD           WUCNUM                          140611
     C                     KFLD           WUFACT                          140611
     C                     KFLD           WUFCNO                          140611
      *                                                                                       CSD015
      **  Used for SDCWHTL1                                                                   CSD015
      *                                                                                       CSD015
     C           KCWHT     KLIST                                                              CSD015
     C                     KFLD           K3FUNT  8                                           CSD015
     C                     KFLD           K3IDEN 40                                           CSD015
     C                     KFLD           K3BRCH  3                                           CSD015
      *
      ** Retrieve bank details
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   PRTCD   7
     C                     PARM '*FIRST ' POPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           ************
     C                     Z-ADD1         DBASE            * DBERR 01 *
     C                     MOVEL'*FIRST'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ENDIF
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     WTODY   60
     C                     ENDIF
      *
      ** Retrieve midas module details
      *
     C                     CALL 'AOMMODR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*FIRST ' POPTN
     C           SDMMOD    PARM SDMMOD    DSFDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDMMODPD'DBFILE           ************
     C                     Z-ADD2         DBASE            * DBERR 02 *
     C                     MOVEL'*FIRST'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Retrieve retail details if Retail 2 or Interest on
      ** Accounts modules are switched on
      *
     C           BGRTBN    IFEQ 'Y'
     C           BGIOAC    OREQ 'Y'
     C                     CALL 'AORETLR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*FIRST ' POPTN
     C           SDRETL    PARM SDRETL    DSFDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDRETLPD'DBFILE           ************
     C                     Z-ADD3         DBASE            * DBERR 03 *
     C                     MOVEL'*FIRST'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
      ** Retrieve lending ICD
      *
     C                     CALL 'AOCLNDR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*FIRST ' POPTN
     C********** SDCLND    PARM SDCLND    DSFDY                                               CLE134
     C           SDCLND    PARM SDCLND    DSSDY                                               CLE134
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCLNDPD'DBFILE           ************
     C                     Z-ADD4         DBASE            * DBERR 04 *
     C                     MOVEL'*FIRST'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C010
      *
      ** Determine if Customer Lending Enhancements - Authorisation
      ** feature is installed
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM 'CLE002'  PSARD   6
     C           SCSARD    PARM SCSARD    DSFDY
     C           PRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CLE002  1
     C                     MOVE '1'       *IN23
     C                     ELSE
     C                     MOVE 'N'       CLE002
     C                     MOVE '0'       *IN23
     C           PRTCD     IFNE '*NRF    '
     C           *LOCK     IN   LDA
     C                     MOVEL'SCSARDPD'DBFILE           ************
     C                     Z-ADD5         DBASE            * DBERR 05 *
     C                     MOVEL'CLE002'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
      ** Determine if Customer Lending Enhancements - Syndication
      ** feature is installed
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM 'CLE004'  PSARD
     C           SCSARD    PARM SCSARD    DSFDY
     C           PRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CLE004  1
     C                     ELSE
     C                     MOVE 'N'       CLE004
     C           PRTCD     IFNE '*NRF    '
     C           *LOCK     IN   LDA
     C                     MOVEL'SCSARDPD'DBFILE           ************
     C                     Z-ADD6         DBASE            * DBERR 06 *
     C                     MOVEL'CLE004'  DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *                                                                   CEU004
      **  Determine if LE Settlement Ccy Conversion Upgrade to R2.0       CEU004
      **  feature is installed                                            CEU004
      *                                                                   CEU004
     C                     CALL 'AOSARDR0'                                CEU004
     C                     PARM *BLANKS   PRTCD                           CEU004
     C                     PARM '*KEY   ' POPTN                           CEU004
     C                     PARM 'CEU004'  PSARD                           CEU004
     C           SCSARD    PARM SCSARD    DSFDY                           CEU004
     C           PRTCD     IFEQ *BLANKS                                   CEU004
     C                     MOVE 'Y'       CEU004  1                       CEU004
     C                     ELSE                                           CEU004
     C                     MOVE 'N'       CEU004                          CEU004
     C           PRTCD     IFNE '*NRF    '                                CEU004
     C           *LOCK     IN   LDA                                       CEU004
     C                     MOVEL'SCSARDPD'DBFILE           ************   CEU004
     C                     Z-ADD11        DBASE            * DBERR 11 *   CEU004
     C                     MOVEL'CEU004'  DBKEY            ************   CEU004
     C                     OUT  LDA                                       CEU004
     C                     EXSR *PSSR                                     CEU004
     C                     ENDIF                                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                   CLE009
      ** Access SAR details file to see if Customer Lending               CLE009
      ** Enhancements is installed                                        CLE009
      *                                                                   CLE009
     C                     CALL 'AOSARDR0'                                CLE009
     C                     PARM *BLANK    PRTCD                           CLE009
     C                     PARM '*KEY   ' POPTN                           CLE009
     C                     PARM 'CLE007'  PSARD   6                       CLE009
     C           SCSARD    PARM SCSARD    DSFDY                           CLE009
      *                                                                   CLE009
     C           PRTCD     IFEQ *BLANK                                    CLE009
     C                     CALL 'AOSARDR0'                                CLE009
     C                     PARM *BLANKS   PRTCD                           CLE009
     C                     PARM '*KEY   ' POPTN                           CLE009
     C                     PARM 'CLE009'  PSARD   6                       CLE009
     C           SCSARD    PARM SCSARD    DSFDY                           CLE009
      *                                                                   CLE009
     C           PRTCD     IFEQ *BLANKS                                   CLE009
     C                     MOVE 'Y'       CLE009  1                       CLE009
     C                     ELSE                                           CLE009
     C                     MOVE 'N'       CLE009                          CLE009
      *                                                                   CLE009
     C           PRTCD     IFNE '*NRF    '                                CLE009
     C           *LOCK     IN   LDA                                       CLE009
     C                     MOVEL'SCSARDPD'DBFILE           ************   CLE009
     C                     Z-ADD27        DBASE            * DBERR 27 *   CLE009
     C                     MOVEL'CLE009'  DBKEY            ************   CLE009
     C                     OUT  LDA                                       CLE009
     C                     EXSR *PSSR                                     CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C                     ENDIF                                          CLE009
     C                     ELSE                                           CLE009
      *                                                                   CLE009
     C           PRTCD     IFNE '*NRF   '                                 CLE009
     C           *LOCK     IN   LDA                                       CLE009
     C                     MOVEL'SCSARDPD'DBFILE           ************   CLE009
     C                     Z-ADD28        DBASE            * DBERR 28 *   CLE009
     C                     MOVEL'CLE007'  DBKEY            ************   CLE009
     C                     OUT  LDA                                       CLE009
     C                     EXSR *PSSR                                     CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C                     ENDIF                                          CLE009
     C/COPY WNCPYSRC,LE2220C001
      *                                                                                       CSD015
      ** Determine if CSC011 enhancement is installed                                         CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSC011  1                                           CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*VERIFY' POPTN                                               CSD015
     C                     PARM 'CSC011'  PSARD                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
      ** Database Error (return code other than *NRF)                                         CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE *BLANKS                                                       CSD015
     C           PRTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVEL'CSC011'  DBKEY                                               CSD015
     C                     MOVEL'LE2220'  DBPGM                                               CSD015
     C                     Z-ADD30        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSC011                                              CSD015
     C           *NAMVAR   DEFN           SC24X7                                              CSD015
     C                     IN   SC24X7                                                        CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           *NAMVAR   DEFN           SDSTAT                                              CSD015
     C                     IN   SDSTAT                                                        CSD015
      *                                                                                       CSD015
      ** Determine if CSD015 enhancement is installed                                         CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSD015  1                                           CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*VERIFY' POPTN                                               CSD015
     C                     PARM 'CSD015'  PSARD                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
      ** Database Error (return code other than *NRF)                                         CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE *BLANKS                                                       CSD015
     C           PRTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVEL'CSD015'  DBKEY                                               CSD015
     C                     MOVEL'LE2220'  DBPGM                                               CSD015
     C                     Z-ADD31        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSD015                                              CSD015
      *                                                                                       CSD015
      ** Access Compliance Watch Configuration file to get the                                CSD015
      ** Private Customer Industry Codes                                                      CSD015
      *                                                                                       CSD015
     C                     CALL 'AOCWCDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*FIRST ' POPTN                                               CSD015
     C           SDCWCD    PARM SDCWCD    DSSDY                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE *BLANKS                                                       CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SDCWCDPD'DBFILE                                              CSD015
     C                     Z-ADD32        DBASE                                               CSD015
     C                     MOVEL'LE2220'  DBPGM                                               CSD015
     C                     MOVELPOPTN     DBKEY                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if function code is being monitored by compliance watch.                       CSD015
      *                                                                                       CSD015
     C                     CALL 'AOWLCCR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*KEY   ' POPTN                                               CSD015
     C                     PARM 'LENDING' PFUNC   8                                           CSD015
     C           SDWLCC    PARM SDWLCC    DSFDY                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE '*NRF    '                                                    CSD015
     C           PRTCD     ANDNE*BLANKS                                                       CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SDWLCCPD'DBFILE                                              CSD015
     C                     Z-ADD33        DBASE                                               CSD015
     C                     MOVELPFUNC     DBKEY                                               CSD015
     C                     MOVEL'LE2220'  DBPGM                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Access SAR Details to see if Concord Interface Development (CCF001)                  CSD015
      ** is installed.                                                                        CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CCF001  1                                           CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*VERIFY' POPTN                                               CSD015
     C                     PARM 'CCF001'  PSARD                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
      ** Database Error (return code other than *NRF)                                         CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE *BLANKS                                                       CSD015
     C           PRTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVEL'CCF001'  DBKEY                                               CSD015
     C                     MOVEL'LE2220'  DBPGM                                               CSD015
     C                     Z-ADD34        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CCF001                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      *                                                                                       CLE031
      ** Determine if CLE031 enhancement is on                                                CLE031
      *                                                                                       CLE031
     C                     MOVE 'N'       CLE031  1                                           CLE031
     C                     CALL 'AOSARDR0'                                                    CLE031
     C                     PARM *BLANKS   PRTCD                                               CLE031
     C                     PARM '*KEY   ' POPTN                                               CLE031
     C                     PARM 'CLE031'  PSARD                                               CLE031
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE031
      *                                                                                       CLE031
     C           PRTCD     IFEQ *BLANKS                                                       CLE031
     C                     MOVE 'Y'       CLE031                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C           PRTCD     IFNE *BLANKS                                                       CLE031
     C           PRTCD     ANDNE'*NRF    '                                                    CLE031
     C           *LOCK     IN   LDA                                                           CLE031
     C                     MOVEL'SCSARDPD'DBFILE                                              CLE031
     C                     Z-ADD29        DBASE                                               CLE031
     C                     MOVEL'CLE031'  DBKEY                                               CLE031
     C                     OUT  LDA                                                           CLE031
     C                     EXSR *PSSR                                                         CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE034
      ** Determine if CLE034 enhancement is on                                                CLE034
      *                                                                                       CLE034
     C                     MOVE 'N'       CLE034  1                                           CLE034
     C                     MOVE *OFF      *IN11                                               CLE034
     C                     CALL 'AOSARDR0'                                                    CLE034
     C                     PARM *BLANKS   PRTCD                                               CLE034
     C                     PARM '*KEY   ' POPTN                                               CLE034
     C                     PARM 'CLE034'  PSARD                                               CLE034
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE034
      *                                                                                       CLE034
     C           PRTCD     IFEQ *BLANKS                                                       CLE034
     C                     MOVE 'Y'       CLE034                                              CLE034
     C                     MOVE *ON       *IN11                                               CLE034
     C           PTMST     IFEQ *BLANKS                                                       CLE034
     C                     MOVELSTAMP,1   PTMST                                               CLE034
     C                     ENDIF                                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C           PRTCD     IFNE *BLANKS                                                       CLE034
     C           PRTCD     ANDNE'*NRF    '                                                    CLE034
     C           *LOCK     IN   LDA                                                           CLE034
     C                     MOVEL'SCSARDPD'DBFILE                                              CLE034
     C                     Z-ADD30        DBASE                                               CLE034
     C                     MOVEL'CLE034'  DBKEY                                               CLE034
     C                     OUT  LDA                                                           CLE034
     C                     EXSR *PSSR                                                         CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
      ** Past Due call Loans                                                                  CLE134
      *                                                                                       CLE134
     C                     CALL 'AOSARDR0'                                                    CLE134
     C                     PARM *BLANKS   PRTCD                                               CLE134
     C                     PARM '*KEY   ' POPTN                                               CLE134
     C                     PARM 'CLE134'  PSARD                                               CLE134
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE134
     C           PRTCD     IFEQ *BLANKS                                                       CLE134
     C                     MOVE 'Y'       CLE134  1                                           CLE134
     C                     ELSE                                                               CLE134
     C                     MOVE 'N'       CLE134                                              CLE134
     C                     ENDIF                                                              CLE134
      *
      ** Set up message file for screen error messages
      ** Determine if for fee settlement or fee adjustment
      *
     C                     MOVEL'LERMSGF 'ZAMSGF
     C                     MOVE USER      SUSER
     C                     MOVE WSID      SWSID
     C                     MOVE BJMRDT    SRUNA
     C                     MOVE 'N'       SRAUT
     C                     MOVE *ALL'0'   WVAL1   9
     C                     SELEC
     C           PFTYP     WHEQ 'A'
     C                     MOVEA'10'      *IN,21
     C           PFTYP     WHEQ 'S'
     C                     MOVEA'01'      *IN,21
     C                     ENDSL
     C*                                                                   140611
     C***  Set up currency arrays                                         140611
     C*                                                                   140611
     C                     Z-ADD0         X       30                      140611
     C                     READ SDCURRPD                 17               140611
     C*                                                                   140611
     C           *IN17     DOWEQ'0'                                       140611
     C*                                                                   140611
     C           X         IFLE 150                                       140611
     C           X         ADD  1         X                               140611
     C                     MOVE A6CYCD    CURR,X                          140611
     C                     Z-ADDA6SPRT    CSPT,X                          140611
     C                     MOVELA6MDIN    MTDV,X                          140611
     C                     Z-ADDA6NBDP    CCDP,X                          140611
     C                     Z-ADDA6SSNB    CCNO,X                          140611
     C                     END                                            140611
     C*                                                                   140611
     C                     READ SDCURRPD                 17               140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C**********           Z-ADD99        STFSEQ  20                                   140611 200289
     C**********           Z-ADD999       STFSEQ  30                                 200289 AR674226
     C                     Z-ADD9999      STFSEQ  40                                        AR674226
     C                     Z-ADD0         WOPCT   63                      140611
     C                     Z-ADD0         WOAMT  130                      140611
     C                     Z-ADD0         WFPC    63                      140611
     C                     Z-ADD0         WFAM   130                      140611
     C                     Z-ADD0         WTOT   130                      140611
     C                     Z-ADD0         WRK63   63                      140611
     C                     Z-ADD0         WRK15  150                      140611
     C                     Z-ADD0         WRK153 153                      140611
     C                     Z-ADD0         WRK155 155                      140611
      *                                                                   140611
      *                                                                   140611
      *
      ** Check mode of processing
      *
     C                     SELEC
     C           PMODE     WHEQ 'I'
     C                     OPEN LE2220DF
     C                     MOVE 'F0'      WFMT    2
     C           PMODE     WHEQ 'R'
     C                     OPEN LE2220DF
     C                     OPEN LE2220PD
     C                     MOVE 'F0'      WFMT
     C           PMODE     WHEQ 'P'
     C                     OPEN LE2220PD
     C                     EXSR SRBTCH
     C           PMODE     WHEQ 'B'
     C                     EXSR SRBTCH
     C                     ENDSL
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRBTCH  -  Batch processing for play/batch mode               *
      * Called by: SRINIT - Initial processing                        *
      * Calls    : SRBTSC - Format screen fields for play/batch mode  *
      *            SRVKEY - Validate key fields                       *
      *            SRVALD - Validate details fields                   *
      *            SR2410 - Validate settlement fields                *
      *            SRINSR - Insert new fee settlement/adjustment      *
      *            SRUPDR - Update existing fee settlement/adjustment *
      *****************************************************************
     C           SRBTCH    BEGSR
      *
     C                     MOVE '0'       *IN72
     C           PMODE     IFEQ 'P'
     C                     READ LE2220PD                 72
     C                     ENDIF
      *
      ** Process all 'test harness' records or the one
      ** record transmitted from PC
      *
     C           *IN72     DOWEQ'0'
      *
      ** Format key fields, then validate them
      *
     C                     EXSR SRBTSC
     C                     EXSR SRVKEY
      *
      ** Override detail screen fields for insert/amend
      *
     C           SACTN     IFEQ 'I'
     C           SACTN     OREQ 'A'
      *
     C           PFTYP     IFEQ 'A'
     C           PMODE     IFEQ 'P'
     C                     MOVE S2FADJ    SFADJ
     C                     MOVE S2SIGN    SSIGN
     C                     ELSE
     C                     MOVE PSADJ     SFADJ
     C                     MOVE PSIGN     SSIGN
     C                     ENDIF
      *
     C                     ELSE
     C           PMODE     IFEQ 'P'
     C                     MOVE S2FSET    SFSET
     C                     MOVE S2TYPE    STYPE
     C                     ELSE
     C                     MOVE PSADJ     SFSET
     C                     MOVE PTYPE     STYPE
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Validate detail screen fields if not delete
      ** Then, proceed with updates
      *
     C           SACTN     IFNE 'D'
     C                     EXSR SRVALD
     C           PFTYP     IFEQ 'S'
     C                     EXSR SR2410
     C                     ENDIF
     C                     ENDIF
      *
     C           SACTN     IFEQ 'I'
     C                     EXSR SRINSR
     C                     ELSE
     C                     EXSR SRUPDR
     C                     ENDIF
      *
      ** If in batch mode, terminate processing
      ** Otherwise, read next 'test harness' record
      *
     C           PMODE     IFEQ 'B'
     C                     LEAVE
     C                     ELSE
     C                     READ LE2220PD                 72
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** All successful processing, end and return to calling pgm
      *
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRBTSC  -  Format screen fields for batch/play mode           *
      * Called by: SRBTCH - Batch processing                          *
      * Calls    : None                                               *
      *****************************************************************
     C           SRBTSC    BEGSR
      *
      ** FORMAT FIELDS FROM 'TEST HARNESS' RECORD
      *
     C           PMODE     IFEQ 'P'
     C                     MOVE S1CNUM    SCNUM
     C                     MOVE S1FACT    SFACT
     C                     MOVE S1FCNO    SFCNO
     C                     MOVE S1FSEQ    SFSEQ
     C                     MOVE S1VDAT    SVDAT
     C                     MOVE S1ACTN    SACTN
     C/COPY WNCPYSRC,LEH00773
      *
      ** Determine if for fee adjustment or fee settlement
      ** and format fields appropriately
      *
     C           S1VDAT    IFEQ *BLANK
     C                     MOVE 'A'       PFTYP
     C                     MOVEA'10'      *IN,21
     C                     ELSE
     C                     MOVE 'S'       PFTYP
     C                     MOVEA'01'      *IN,21
     C                     ENDIF
      *
     C                     ELSE
      *
      ** FORMAT FIELDS FROM RECORD PASSED BY PC
      *
     C                     MOVE PTACT     SACTN
     C                     MOVE PCNUM     SCNUM
     C                     MOVE PFACT     SFACT
     C                     MOVE PFCNO     SFCNO
     C                     MOVE PFSEQ     SFSEQ
     C                     MOVE PSTAL     SFSTAL                                              CLE034
     C/COPY WNCPYSRC,LEH00774
      *
     C                     MOVE PVDAT     ZWYYYY
     C           BJDFIN    IFEQ 'M'
     C                     MOVE PVDT1     ZWMTH
     C                     MOVE PVDT2     ZWDAY
     C                     ELSE
     C                     MOVE PVDT1     ZWDAY
     C                     MOVE PVDT2     ZWMTH
     C                     ENDIF
     C                     EXSR ZDAT10
     C                     Z-ADDZZMDNO    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     SVDAT
      *
      ** For SPF Validation
      *
     C                     MOVELPTUSR     @USER  10
     C**********           Z-ADD1         @ZMGRP  40                                          CSF002
     C**********           MOVE 'FSET'    @ZICDE  4                                           CSF002
     C                     MOVEL'00000'   @UNQCD 10                                           CSF002
     C                     MOVE '02002'   @UNQCD                                              CSF002
      *
      ** Setup returned message format
      *
     C                     CLEARPOUTP
     C                     MOVE PMTYP     PRMTP
     C                     MOVE PTUSR     PRTUS
     C                     MOVE PTWID     PRTWS
     C                     MOVE PTREF     PRTRF
     C                     MOVE PTSEQ     PRTSQ
     C                     MOVE PTACT     PRTAC
     C                     MOVE PTDAT     PRTDT
     C                     MOVE PTTIM     PRTTM
     C                     MOVE PNBAT     PRRBT
     C                     MOVE PCNUM     PRCNO
     C                     MOVE PFACT     PRFTP
     C                     MOVE PFCNO     PRFNO
     C                     MOVE PFSEQ     PRFSQ
     C                     MOVE PVDAT     PRVDT
      *
      ** Determine if for fee adjustent or fee settlement
      ** and format fields appropriately
      *
     C***********PVDAT     IFEQ *BLANK                                    146488
     C***********          MOVE 'A'       PFTYP                           146488
     C           PFTYP     IFEQ 'A'                                       146488
     C                     MOVEA'10'      *IN,21
     C                     ELSE
     C***********          MOVE 'S'       PFTYP                           146488
     C                     MOVEA'01'      *IN,21
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SR2410  -  Validate settlement details in batch/play mode     *
      * Called by: SRBTCH - Batch processing                          *
      * Calls    : SREXST - Format filds for extended settlement      *
      *            SRCHOL - Check if value date is a holiday          *
      *****************************************************************
     C           SR2410    BEGSR
      *
      ** Setup fields on call to SD2410 for settlement validation
      *
     C                     EXSR SREXST
      *
      ** Protect settle instructions if outside of backvalue period.
      ** This means that some fields will not be validated
      *
     C           PMRUND    SUB  PMBVPD    WSTART  50
     C           PMDTPY    IFLT WSTART
     C           PMDTPY    ANDNE0
     C                     MOVE 'Y'       PMPPAY
     C                     ENDIF
     C           PMDTRC    IFLT WSTART
     C           PMDTRC    ANDNE0
     C                     MOVE 'Y'       PMPRCV
     C                     ENDIF
      *
      ** Call settlement validation program
      *
     C/COPY WNCPYSRC,LE2220C002
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           SFSTAL    ANDEQ'Y'                                                           CLE034
      *                                                                                       CLE034
     C                     MOVE *BLANKS   PWVDAT  5                                           CLE034
     C                     MOVE WVDAT     PWVDAT                                              CLE034
     C                     MOVE SCNUM     PCNUM                                               CLE034
     C                     MOVE WFACL     PFACL                                               CLE034
     C                     MOVE SFSEQ     PFASQ                                               CLE034
      *                                                                                       CLE034
     C                     CALL 'LE2230'                                                      CLE034
     C                     PARM 'FSET'    PWTYP   4                                           CLE034
     C                     PARM *BLANKS   SFLNRF  6                                           CLE034
     C                     PARM           PWVDAT                                              CLE034
     C                     PARM *BLANKS   PSEQN   3                                           CLE034
     C                     PARM           PCNUM                                               CLE034
     C                     PARM           PFACL                                               CLE034
     C                     PARM           PFASQ                                               CLE034
     C                     PARM           SETLIB                                              CLE034
     C                     PARM           SETLIZ                                              CLE034
     C                     PARM           PMODE                                               CLE034
     C                     PARM           PTMST                                               CLE034
     C                     PARM *BLANKS   PERRF   1                                           CLE034
     C                     PARM *BLANKS   PWARN   1                                           CLE034
     C                     PARM *BLANKS   PSNOS   1                                           CLE034
     C                     PARM *BLANKS   PSAMD   1                                           CLE034
     C                     PARM *BLANKS   PNDET   1                                           CLE034
     C                     PARM *BLANKS   PRCCY  60                                           CLE034
     C                     PARM *BLANKS   PRLOC  60                                           CLE034
     C                     PARM *BLANKS   PPCCY  60                                           CLE034
     C                     PARM *BLANKS   PPLOC  60                                           CLE034
     C                     PARM           FAPCRF                                              CLE034
     C                     PARM *BLANKS   PORED   5                                           CLE038
     C                     PARM *ZERO     PAAMT  130                                          CLE038
      *                                                                                       CLE034
     C                     ELSE                                                               CLE034
      *                                                                                       CLE034
     C                     CALL 'SD2410'
     C                     PARM           SETLIB
     C                     PARM           SETLIZ
     C                     PARM           @PARM3                          222373
      *                                                                                       CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C/COPY WNCPYSRC,LE2220C003
      *
      ** Terminate program if database error returned
      *
     C                     MOVE PMDBSE    WKDBSE  2                                           219142
     C           PMDBSE    IFNE *ZERO
     C           WKDBSE    ANDNE*BLANKS                                                       219142
     C           *LOCK     IN   LDA
     C                     MOVELPMDBFL    DBFILE           ************
     C                     Z-ADDPMDBSE    DBASE            * DBERR XX *
     C                     MOVELPMDBKY    DBKEY            ************
     C                     MOVELPMDPGM    DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Settlement detail not in error, proceed with holiday checking
      ** if not for delete
      *
     C           PMERCD    IFEQ *BLANKS
     C           SACTN     IFNE 'D'
     C                     EXSR SRCHOL
     C                     ENDIF
      *
      ** Settlement detail in error
      *
     C                     ELSE
     C           3         SUBSTPMERCD:1  WSERR   3
     C                     MOVEL'ESM0'    ZAMSID
     C                     MOVE WSERR     ZAMSID
     C                     MOVEL'DRSMM   'ZAMSGF
     C                     EXSR ZASNMS
     C                     MOVEL'LERMSGF 'ZAMSGF                                              219142
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRSTRT  -  Process initial screen                             *
      * Called by: Main routine                                       *
      * Calls    : SRVKEY - Validate key fields                       *
      *            SRVREV - Validate review fields                    *
      *****************************************************************
     C           SRSTRT    BEGSR
      *
      ** Clear screen fields
      *
     C           *IN24     IFEQ '0'
     C                     MOVE *BLANKS   SACTN
     C                     ENDIF
     C                     MOVE *BLANKS   SCNUM
     C                     MOVE *BLANKS   SFACT
     C                     MOVE *BLANKS   SFCNO
     C                     MOVE *BLANKS   SFSEQ
     C                     MOVE *BLANKS   SVDAT
     C                     MOVE *BLANKS   SRCUS
     C                     MOVE *BLANKS   SRFAC
     C                     MOVE *BLANKS   SRFNO
     C                     MOVE *BLANKS   SRFSQ
     C/COPY WNCPYSRC,LEH00775
     C                     MOVEAWVAL1     *IN,30
     C                     EXSR CLEAR
      *
      ** Process screen until valid entries are input or F3 or F12
      ** is pressed
      *
     C                     WRITELE2220F0
     C           WFMT      DOUNE'F0'
     C                     WRITELE2220C1
     C                     EXFMTLE2220F1
     C                     EXSR CLEAR
     C                     MOVEAWVAL1     *IN,30
     C/COPY WNCPYSRC,LEH00776
      *
     C                     SELEC
      *
      ** F3 is pressed, end processing
      *
     C           *INKC     WHEQ '1'
     C                     MOVE *BLANK    WFMT
      *
      ** F12 is pressed, return to subfile
      *
     C           *INKL     WHEQ '1'
     C                     MOVE 'S0'      WFMT
      *
      ** ENTER key is pressed
      ** Validate key fields if action code is entered,
      ** Otherwise, validate review from fields
      *
     C                     OTHER
     C           SACTN     IFNE *BLANK
     C                     EXSR SRVKEY
     C                     ELSE
     C                     EXSR SRVREV
     C                     ENDIF
      *
     C                     ENDSL
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVKEY  -  Validate key fields                                *
      * Called by: SRSTRT - Validate initial screen                   *
      *            SRBTCH - Batch processing for batch/play modes     *
      * Calls    : SRCAUT - Check if user is authorised to the action *
      *            SRAUTH - Validate authorisation action             *
      *            SRINSC - Format screen fields                      *
      *            SRFSET - Read all settlements for the fee          *
      *****************************************************************
     C           SRVKEY    BEGSR
      *
      ** Valid action codes are I,E,A,D and 'X'
      *
     C           SACTN     IFNE 'I'
     C           SACTN     ANDNE'E'
     C           SACTN     ANDNE'A'
     C           SACTN     ANDNE'D'
     C           SACTN     ANDNE'X'
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0172' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** Customer number must be entered
      *
     C           SCNUM     IFEQ *BLANKS
     C           SCNUM     OREQ *ZEROS
     C                     MOVE '1'       *IN31
     C                     MOVEL'LER0006' ZAMSID
     C                     EXSR ZASNMS
      *
      ** It must also be existing in the system
      *
     C                     ELSE
     C                     MOVELSCNUM     PCUST
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           PCUST  10
     C                     PARM *BLANKS   PKYST   7
     C           SDCUST    PARM SDCUST    DSSDY
     C           PRTCD     IFNE *BLANKS
     C                     MOVE '1'       *IN31
     C                     MOVEL'LER0007' ZAMSID
     C                     EXSR ZASNMS
     C           PRTCD     IFEQ '*NOSEL  '
     C                     MOVE *BLANKS   SCNUM
     C                     ENDIF
     C                     ELSE
     C***********          MOVE BBCUST    SCNUM                           140815
     C                     MOVE BBCUST    SCNUM     P                     140815
     C                     ENDIF
     C                     ENDIF
      *
      ** Facility must be entered and numeric
      *
     C/COPY WNCPYSRC,LEH00777
     C                     MOVE '0'       WTST3   4
     C                     MOVELSFACT     WTST3
     C                     TESTN          WTST3      50
     C                     MOVE '0'       WTST2   3
     C                     MOVELSFCNO     WTST2
     C                     TESTN          WTST2      51
     C           *IN50     IFEQ '0'
     C           *IN51     OREQ '0'
     C                     MOVE '1'       *IN32
     C                     MOVEL'LER0008' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00778
      *
      ** Fee sequence must be entered and numeric
      *
     C                     MOVE '0'       WTST2   3
     C                     MOVELSFSEQ     WTST2
     C                     TESTN          WTST2      50
     C           *IN50     IFEQ '0'
     C                     MOVE '1'       *IN33
     C                     MOVEL'LER0014' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00779
      *
      ** For fee settlement, if value date is entered, it must
      ** be in the format used by the system; otherwise, it
      ** will default to the rundate
      *
     C           PFTYP     IFEQ 'S'
     C           SVDAT     IFEQ *BLANKS
     C                     MOVE WTODY     SVDAT
     C                     Z-ADDBJRDNB    WVDAT
     C                     ELSE
     C                     MOVE SVDAT     ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    WVDAT
     C           *IN99     IFEQ '1'
     C                     MOVE '1'       *IN34
     C                     MOVEL'LER0159' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** Fee details must exist as live
      *
     C                     DO
     C                     MOVE SCNUM     WCNUM
     C/COPY WNCPYSRC,LEH00780
     C                     MOVELSFACT     WFACL
     C                     MOVE SFCNO     WFACL
     C/COPY WNCPYSRC,LEH00781
     C**********           Z-ADD*ZEROS    WLOAN                                               CLE148
     C                     MOVEL*BLANKS   WLOAN                                               CLE148
     C/COPY WNCPYSRC,LEH00782
     C                     MOVE SFSEQ     WFSEQ
     C********** WKFEE     CHAINLEFEEDL1             71                                       205912
     C           WKFEE     CHAINLEFEEDL1            N71                                       205912
     C           *IN71     IFEQ '1'
     C           FERECI    ORNE 'D'
     C                     MOVEA'1111'    *IN,30
     C/COPY WNCPYSRC,LEH00783
     C                     MOVEL'LER0073' ZAMSID
     C                     EXSR ZASNMS
     C                     LEAVE
     C                     ENDIF
      *                                                                                       205734
     C           *IN71     IFEQ '0'                                                           205734
     C           FERECI    ANDEQ'D'                                                           205734
     C           SACTN     ANDEQ'I'                                                           205734
     C           PFTYP     ANDEQ'A'                                                           205734
     C           FENPYD    ANDEQBJRDNB                                                        205734
     C                     MOVEA'11111'   *IN,30                                              205734
     C                     MOVEL'LER1182' ZAMSID                                              205734
     C                     EXSR ZASNMS                                                        205734
     C                     ENDIF                                                              205734
      *
     C/COPY WNCPYSRC,LEH00784
      ** Only one fee settlement per value date can be inserted.
      ** If an authorised full payment has been made to the fee or the
      ** current total amount past due is zero, settlement not allowed.
      ** If not insert, settlement must already be existing
      *
     C           PFTYP     IFEQ 'S'
     C                     EXSR SRFSET
     C           WKFES     CHAINLEFEEAL2            N71
      *
     C********** SACTN     IFEQ 'A'                                                           202826
     C********** FASSTS    ANDEQ'A'                                                           202826
     C**********           ADD  FASADJ    WCPAM                                               202826
     C**********           ENDIF                                                              202826
      *                                                                                       202826
      ** Display error code only for INSERT                                                   202826
      *                                                                                       202826
     C           SACTN     IFEQ 'I'                                                           202826
     C           WCPAM     IFEQ *ZEROS
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00785
     C                     MOVEL'LER0179' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF                                                              202826
      *
     C           SACTN     IFEQ 'I'
     C           *IN71     IFEQ '0'
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00786
     C                     MOVEL'LER0187' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ELSE
     C           *IN71     IFEQ '1'
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00787
     C                     MOVEL'LER0188' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** Only one adjustment per fee is allowed.  If not insert,
      ** adjustment must already be existing.
      *
     C                     ELSE
     C           WKFEE     CHAINLEFEEAL0            N71
     C           SACTN     IFEQ 'I'
     C           *IN71     IFEQ '0'
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00788
     C                     MOVEL'LER0189' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ELSE
     C           *IN71     IFEQ '1'
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00789
     C                     MOVEL'LER0190' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Adjustment/settlement cannot be used for fixed fees
      ** nor for non-calculated types
      *
     C           SACTN     IFNE 'E'
     C           FEFAMT    IFNE *ZEROS
     C/COPY WNCPYSRC,LEH00790
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00791
     C                     MOVEL'LER0068' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C           FECALT    IFEQ *BLANKS
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00792
     C                     MOVEL'LER0069' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
     C           WERRF     IFNE *BLANK
     C                     LEAVE
     C                     ENDIF
      *
      ** Value date of fee settlement must be earlier than or equal
      ** to rundate and later than fee period start date
      *
     C           SACTN     IFEQ 'I'
     C           PFTYP     ANDEQ'S'
     C           WVDAT     IFGT BJRDNB
     C           WVDAT     ORLE FEPSTD
     C                     MOVE '1'       *IN34
     C                     MOVEL'LER0160' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** Determine if user has the necessary authority to the action
      ** and/or branch and/or menu item for interactive/record modes
      *
     C                     EXSR SRCAUT
      *
      ** Determine if authorisation request is valid
      *
     C           SACTN     IFEQ 'X'
     C                     EXSR SRAUTH
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** If no error, proceed to detail screen processing
      ** Format detail screen fields
      *
     C           WERRF     IFEQ *BLANK
     C                     MOVE 'D1'      WFMT
     C                     MOVE 'F0'      WWRTRN  2
     C                     EXSR SRINSC
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRSFIL  -  Subfile processing                                 *
      * Called by: Main processing                                    *
      * Calls    : SRLOAD - Load subfile records                      *
      *            SRVREV - Validate review fields                    *
      *            SRVSUB - Validate subfile entries                  *
      *            SRSPRO - Process each subfile request              *
      *****************************************************************
     C           SRSFIL    BEGSR
      *
     C                     MOVE 'S0'      WWRTRN
     C                     EXSR SRLOAD
      *
      ** Process until F3, F12 or F9 is pressed
      *
     C           WFMT      DOUNE'S0'
     C                     WRITELE2220F3
     C                     WRITELE2220C1
     C/COPY WNCPYSRC,LEH00793
     C                     EXFMTLE2220C0
     C/COPY WNCPYSRC,LEH00794
     C                     MOVE *BLANK    SACTN
     C                     MOVE '0'       *IN24
     C                     MOVEA'0000'    *IN,35
     C           *IN77     IFEQ '0'
     C                     EXSR CLEAR
     C                     ENDIF
      *
     C                     SELEC
      *
      ** ... F3 is pressed, end processing
      *
     C           *INKC     WHEQ '1'
     C                     MOVE *BLANK    WFMT
      *
      ** ... F12 is pressed, return to initial screen
      *
     C           *INKL     WHEQ '1'
     C                     MOVE 'F0'      WFMT
      *
      ** ... F9 is pressed, process insert request
      *
     C           *INKI     WHEQ '1'
     C                     MOVE 'F0'      WFMT
     C                     MOVE 'I'       SACTN
     C                     MOVE '1'       *IN24
     C                     EXSR CLEAR
      *
      ** ... F5 is pressed, re-display screen with refreshed details
      *
     C           *INKE     WHEQ '1'
     C/COPY WNCPYSRC,LEH00795
     C                     MOVE WREVW     SREVW
     C/COPY WNCPYSRC,LEH00796
     C                     EXSR SRLOAD
      *
      ** ... New review from fields entered, validate review fields
      ** and load new subfile records starting from it
      *
     C           WREVW     WHNE SREVW
     C/COPY WNCPYSRC,LEH00797
     C                     EXSR SRVREV
     C           WERRF     IFEQ *BLANKS
     C                     EXSR SRLOAD
     C                     ENDIF
      *
      ** ... ENTER key is pressed, validate and process subfile
      ** entries, if any
      *
     C           *IN77     WHEQ '0'
     C                     EXSR SRVSUB
     C           WERRF     IFEQ *BLANK
     C                     EXSR SRSPRO
     C                     ENDIF
     C                     ENDSL
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVSUB  -  Validate subfile entries                           *
      * Called by: SRSFIL - Subfile processing                        *
      * Calls    : SRCAUT - Check user authority                      *
      *            SRAUTH - Validate authorisation action             *
      *            SRFSET - Read all settlements for the fee          *
      *****************************************************************
     C           SRVSUB    BEGSR
      *
     C                     MOVE 'Y'       WFRST   1
     C                     Z-ADD1         A       30                                          204434
     C/COPY WNCPYSRC,LEH00798
     C                     READCLE2220S0                 73
     C/COPY WNCPYSRC,LEH00799
      *
     C           *IN73     DOWEQ'0'
     C                     MOVE '0'       *IN76
     C                     MOVE '0'       *IN30
      *
      ** Action code must be A,X,D, or E
      *
     C           SLSEL     IFNE *BLANK
     C           SLSEL     ANDNE'A'
     C           SLSEL     ANDNE'X'
     C           SLSEL     ANDNE'D'
     C           SLSEL     ANDNE'E'
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0173' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** Action must be valid for the user
      *
     C           WERRF     IFEQ *BLANK
     C           SLSEL     ANDNE*BLANK
     C                     MOVE SBRCH     FEBRCA
     C                     MOVE SLSEL     SACTN
     C                     EXSR SRCAUT
     C                     ENDIF
      *
      ** Determine if authorisation request is valid
      *
     C           SLSEL     IFEQ 'X'
     C                     MOVE SIUSR     FAIUSR
     C                     MOVE SAUSR     FAAUSR
     C                     MOVE SSTAT     FASSTS
     C                     EXSR SRAUTH
     C                     ENDIF
      *
      ** If an authorised full payment has been made to the fee or the
      ** current total amount past due is zero, settlement not accepted
      *
     C           PFTYP     IFEQ 'S'
     C           SLSEL     IFEQ 'A'
     C           SLSEL     OREQ 'X'
     C                     MOVE SSCNO     WCNUM
     C                     MOVELSSFAC     WFACL
     C                     MOVE SSFNO     WFACL
     C/COPY WNCPYSRC,LEH00800
     C**********           Z-ADD*ZEROS    WLOAN                                               CLE148
     C                     MOVEL*BLANKS   WLOAN                                               CLE148
     C/COPY WNCPYSRC,LEH00801
     C                     MOVE SSFEE     WFSEQ
     C                     Z-ADDSSVDT     WVDAT
      *
     C           WKFEE     CHAINLEFEEDL1             71
     C           *IN71     IFEQ '1'
     C           FERECI    ORNE 'D'
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0073' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     EXSR SRFSET
     C                     Z-ADDWCPAM     WPAM,A                                              204434
     C                     ADD  1         A                                                   204434
      *                                                                                       204434
     C********** SLSEL     IFEQ 'A'                                                           202826
     C********** SSTAT     ANDEQ'A'                                                           202826
     C**********           ADD  SSADJ     WCPAM                                               202826
     C**********           ENDIF                                                              202826
     C           SACTN     IFEQ 'I'                                                           202826
     C           WCPAM     IFEQ *ZEROS
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00802
     C                     MOVEL'LER0179' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF                                                              202826
      *
     C                     ENDIF
     C                     ENDIF
      *
      ** If error exists, next display would be on the 1st error
      ** Force record to be read again on error or action code valid
      *
     C           WERRF     IFNE *BLANK
     C           WFRST     ANDEQ'Y'
     C                     Z-ADDSRRN      SRNBR
     C                     MOVE *BLANK    WFRST
     C                     ENDIF
     C           SLSEL     IFNE *BLANK
     C           WERRF     ORNE *BLANK
     C                     MOVE '1'       *IN76
     C                     ENDIF
      *
     C/COPY WNCPYSRC,LEH00803
     C                     UPDATLE2220S0
     C                     READCLE2220S0                 73
     C/COPY WNCPYSRC,LEH00804
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRSPRO  -  Process each subfile request                       *
      * Called by: SRSFIL - Subfile processing                        *
      * Calls    : SRINSC - Format screen fields                      *
      *            SRDTL1 - Process first detail screen               *
      *            SRDTL2 - Process extended settlement screen        *
      *            SRNEWL - Update newly created loan                 *
      *            SRUPDR - Update records in files                   *
      *****************************************************************
     C           SRSPRO    BEGSR
      *
      ** Do initial read of changed subfile records
      *
     C                     Z-ADD1         SRRN
     C/COPY WNCPYSRC,LEH00805
     C                     READCLE2220S0                 73
     C/COPY WNCPYSRC,LEH00806
      *
     C           *IN73     DOWEQ'0'
      *
      ** Access fee details
      *
     C                     MOVE SLSEL     SACTN
     C                     MOVE SSCNO     SCNUM
     C                     MOVE SSFAC     SFACT
     C                     MOVE SSFNO     SFCNO
     C                     MOVE SSFEE     SFSEQ
     C                     MOVE *BLANKS   SVDAT
     C           SSVDT     IFNE *ZEROS
     C                     MOVE SSVDT     ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     SVDAT
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00807
      *
     C                     MOVE SSCNO     WCNUM
     C                     MOVELSSFAC     WFACL
     C                     MOVE SSFNO     WFACL
     C/COPY WNCPYSRC,LEH00808
     C**********           Z-ADD*ZEROS    WLOAN                                               CLE148
     C                     MOVEL*BLANKS   WLOAN                                               CLE148
     C/COPY WNCPYSRC,LEH00809
     C                     MOVE SSFEE     WFSEQ
     C                     Z-ADDSSVDT     WVDAT
      *
     C           WKFEE     CHAINLEFEEDL1             71
     C           *IN71     IFEQ '1'
     C           FERECI    ORNE 'D'
     C                     MOVE '1'       *IN30
     C                     MOVE '1'       *IN76
     C                     MOVEL'LER0073' ZAMSID
     C                     EXSR ZASNMS
     C/COPY WNCPYSRC,LEH00810
     C                     UPDATLE2220S0
     C/COPY WNCPYSRC,LEH00811
     C                     MOVE SRRN      SRNBR
     C                     LEAVE
     C                     ENDIF
      *
      ** Access fee adjustment/settlement details
      *
     C           PFTYP     IFEQ 'S'
     C           WKFES     CHAINLEFEEAL2            N71
     C                     ELSE
     C           WKFEE     CHAINLEFEEAL0            N71
     C                     ENDIF
     C           *IN71     IFEQ '1'
     C                     MOVE '1'       *IN30
     C                     MOVE '1'       *IN76
     C                     MOVEL'LER0075' ZAMSID
     C                     EXSR ZASNMS
     C/COPY WNCPYSRC,LEH00812
     C                     UPDATLE2220S0
     C/COPY WNCPYSRC,LEH00813
     C                     MOVE SRRN      SRNBR
     C                     LEAVE
     C                     ENDIF
      *
      ** Format detail screen fields
      *
     C                     EXSR SRINSC
      *
      ** Process selected subfile record
      *
     C           WFMT      DOUEQ*BLANKS
     C           WFMT      OREQ 'F0'
     C           WFMT      OREQ 'S0'
     C           WFMT      CASEQ'D1'      SRDTL1
     C           WFMT      CASEQ'D2'      SRDTL2
     C           WFMT      CASEQ'WR'      SRINSR
     C           WFMT      CASEQ'UP'      SRUPDR
     C                     ENDCS
     C                     ENDDO
      *
      ** After one subfile record has been processed
      *
     C                     SELEC
      *
      ** If F3 is pressed, end processing
      *
     C           WFMT      WHEQ *BLANK
     C                     LEAVE
      *
      ** If F12 is pressed, cancel processing on the said record
      *
     C           *INKL     WHEQ '1'
     C                     MOVE *BLANK    SLSEL
     C/COPY WNCPYSRC,LEH00814
     C                     UPDATLE2220S0
     C/COPY WNCPYSRC,LEH00815
     C                     Z-ADDSRRN      SRNBR
     C                     LEAVE
      *
      ** If errors exist during update, inform user
      *
     C           WERRF     WHNE *BLANKS
     C                     MOVE '1'       *IN76
     C                     MOVE '1'       *IN30
     C/COPY WNCPYSRC,LEH00816
     C                     UPDATLE2220S0
     C/COPY WNCPYSRC,LEH00817
     C                     Z-ADDSRRN      SRNBR
     C                     LEAVE
      *
      ** If successful processing, proceed to next subfile record
      *
     C                     OTHER
     C                     MOVE *BLANK    SLSEL
     C/COPY WNCPYSRC,LEH00818
     C                     UPDATLE2220S0
     C/COPY WNCPYSRC,LEH00819
     C                     ENDSL
      *
     C/COPY WNCPYSRC,LEH00820
     C                     READCLE2220S0                 73
     C/COPY WNCPYSRC,LEH00821
     C                     ENDDO
      *
      ** Re-load subfile after all successful updates
      *
     C           WERRF     IFEQ *BLANK
     C           *INKL     ANDEQ'0'
     C           WFMT      ANDNE*BLANK
     C                     EXSR SRLOAD
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRINSC  -  Format screen details for interactive/record mode  *
      * Called by: SRVKEY - Validate key fields                       *
      *            SRSPRO - Process each subfile request              *
      * Calls    : None                                               *
      *****************************************************************
     C           SRINSC    BEGSR
      *
      ** FORMAT FEE DETAILS FOR DISPLAY ONLY
      *
     C                     MOVE *BLANK    WWAR1   1
     C                     MOVE *BLANK    WWAR2   1
     C                     MOVE *BLANK    WPTFI   1
     C                     MOVE *BLANKS   SFTYP
     C                     MOVE '0'       *IN34
      *                                                                                       208487
      ** Save TNLU for later validation                                                       208487
     C                     Z-ADDFATNLU    WTNLU   50                                          208487
      *
      ** Set up participant fee narrative
      *
     C           CLE004    IFEQ 'Y'
     C           SACTN     IFEQ 'I'
     C                     MOVE PTFI      WPTFI
     C                     ELSE
     C                     MOVE FAPTFI    WPTFI
     C                     ENDIF
     C                     SELEC
     C           WPTFI     WHEQ *BLANK
     C                     MOVEL'LER0205' ZAMSID
     C           WPTFI     WHEQ 'P'
     C                     MOVEL'LER0206' ZAMSID
     C           WPTFI     WHEQ 'I'
     C                     MOVEL'LER0207' ZAMSID
     C                     ENDSL
     C                     EXSR SRTEXT
     C                     MOVELZAMSTX    SFTYP
     C                     MOVE *BLANKS   ZAMSID
      *
     C                     ENDIF
      *
     C                     MOVE FEFCCY    SFCCY
     C                     MOVE FEFCOD    SFCOD
      *
      ** Get fee narrative from fee codes file
      *
     C                     MOVE FEFCOD    PFCOD
     C                     CALL 'AOFEER0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           PFCOD   2
     C           SDFEE     PARM SDFEE     DSFDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDFEEPD 'DBFILE           ************
     C                     Z-ADD7         DBASE            * DBERR 07 *
     C                     MOVELPFCOD     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVE AUFENV    SFENV
      *
      ** Get fee currency decimal places
      *
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM FEFCCY    PCURR   3
     C           SDCURR    PARM SDCURR    DSSDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCURRPD'DBFILE           ************
     C                     Z-ADD8         DBASE            * DBERR 08 *
     C                     MOVELPCURR     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Format fee amount past due for settlements or
      ** total accrued to date for adjustments
      *
     C                     Z-ADD*ZEROS    ZFLD15
      *                                                                   140611
     C                     Z-ADDA6NBDP    ZDECS                           140611
     C           A6NBDP    ADD  4         P       10                      140611
      *                                                                   140611
     C                     Z-ADDFATNLU    WTNLU   50                                          CLE034
     C           PFTYP     IFEQ 'S'
     C***********          Z-ADDFEAMTP    ZFLD15                          140611
     C***********          ELSE                                           140611
     C***********FEADAT    ADD  FEAMTA    ZFLD15                          140611
     C***********          ADD  FELPAM    ZFLD15                          140611
      ***********                                                  140611 146488
      ** If this is a full settlement then the outstanding amount,        140611
      ** adjustment amount and past due amount should be blank and        140611
      ** the total accrued to date should be taken from the fees          140611
      ** master file.                                                     140611
      ***********                                                  140611 146488
     C***********FATYPE    IFEQ 'F'                                140611 146488
      ***********                                                  140611 146488
     C***  Non- calculated fees                                           140611
     C***********                                                  140611 146488
     C***********FECALT    IFEQ '  '                               140611 146488
     C***********                                                  140611 146488
     C***********FEPEND    IFLE BJRDNB                             140611 146488
     C***********FEPEND    OREQ 0                                  140611 146488
     C***********FEPYON    ANDEQ*BLANK                             140611 146488
     C***********          Z-ADDFEFAMT    ZFLD15                   140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C***  Add extra day to accruals                                      140611
     C***********                                                  140611 146488
     C***********FEPSTD    IFNE BJRDNB                             140611 146488
     C***********BJRDNB    SUB  FEPSTD    FLATDS  50               140611 146488
     C***********FLATDS    SUB  1         FLATDS                   140611 146488
     C***********FEADAT    DIV  FLATDS    FLATAM 130H              140611 146488
     C***********FLATDS    ADD  1         FLATDS                   140611 146488
     C***********FLATAM    MULT FLATDS    FLATAM                   140611 146488
     C***********          Z-ADDFLATAM    ZFLD15                   140611 146488
     C***********          ELSE                                    140611 146488
     C***********          Z-ADDFEADAT    ZFLD15                   140611 146488
     C***********          END                                     140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
      ***********                                                  140611 146488
     C***********                                                  140611 146488
     C** For calculated fees based on averages need to calculate          140611
     C** what the value would be if today was payment date                140611
     C***********                                                  140611 146488
     C***********FECALT    IFEQ '01'                               140611 146488
     C***********FECALT    OREQ '02'                               140611 146488
     C***********FECALT    OREQ '03'                               140611 146488
     C***********FECALT    OREQ '11'                               140611 146488
     C***********FECALT    OREQ '12'                               140611 146488
     C***********FECALT    OREQ '13'                               140611 146488
     C***********FECALT    OREQ '21'                               140611 146488
     C***********                                                  140611 146488
     C***********          EXSR AVCALC                             140611 146488
     C***********                                                  140611 146488
     C***********          Z-ADDWFEE      ZFLD15                   140611 146488
     C***********          ADD  FEAMTP    ZFLD15                   140611 146488
     C***********                                                  140611 146488
     C***********ZFLD15    IFEQ *ZEROS                             140611 146488
     C***********          MOVE *BLANKS   SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C*********** amount fees                                      140611 146488
     C***********                                                  140611 146488
     C***********          EXSR AVCALC                             140611 146488
     C***********WFEE      ADD  FEADAT    WFEE                     140611 146488
     C***********          ADD  FELPAM    WFEE                     140611 146488
     C***********          ADD  FEAMTP    WFEE                     140611 146488
     C***********                                                  140611 146488
     C***********WFEE      IFEQ *ZEROS                             140611 146488
     C***********          MOVE *BLANKS   SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C** For a calculated fee the accrued amount should be adjusted       140611
     C** for amounts outstanding and settled                              140611
     C***********                                                  140611 146488
     C***********          Z-ADDWFEE      ZFLD15                   140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          END                                     140611 146488
     C***********          END                                     140611 146488
      ***********                                                  140611 146488
      ***********is a partial settlement set up screen fields      140611 146488
      ** accordingly.                                                     140611
      ***********                                                  140611 146488
     C***********FATYPE    IFEQ 'P'                                140611 146488
      ***********                                                  140611 146488
      **  Set up screen detail fee accrued to date amount                 140611
      ***********                                                  140611 146488
     C***  Non- calculated fees                                           140611
     C***********                                                  140611 146488
     C***********FECALT    IFEQ '  '                               140611 146488
     C***********                                                  140611 146488
     C***********FEPEND    IFLE BJRDNB                             140611 146488
     C***********          Z-ADDFEFAMT    ZFLD15                   140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C***  Add extra day to accruals                                      140611
     C***********                                                  140611 146488
     C***********FEPSTD    IFNE BJRDNB                             140611 146488
     C***********BJRDNB    SUB  FEPSTD    FLATDS  50               140611 146488
     C***********FLATDS    SUB  1         FLATDS                   140611 146488
     C***********FEADAT    DIV  FLATDS    FLATAM 130H              140611 146488
     C***********FLATDS    ADD  1         FLATDS                   140611 146488
     C***********FLATAM    MULT FLATDS    FLATAM                   140611 146488
     C***********          Z-ADDFLATAM    ZFLD15                   140611 146488
     C***********          ELSE                                    140611 146488
     C***********          Z-ADDFEADAT    ZFLD15                   140611 146488
     C***********          END                                     140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
      ***********                                                  140611 146488
     C***********                                                  140611 146488
     C** For calculated fees based on averages need to calculate          140611
     C** what the value would be if today was payment date                140611
     C***********                                                  140611 146488
     C***********FECALT    IFEQ '01'                               140611 146488
     C***********FECALT    OREQ '02'                               140611 146488
     C***********FECALT    OREQ '03'                               140611 146488
     C***********FECALT    OREQ '11'                               140611 146488
     C***********FECALT    OREQ '12'                               140611 146488
     C***********FECALT    OREQ '13'                               140611 146488
     C***********FECALT    OREQ '21'                               140611 146488
     C***********                                                  140611 146488
     C***********          EXSR AVCALC                             140611 146488
     C***********                                                  140611 146488
     C***********          Z-ADDWFEE      ZFLD15                   140611 146488
     C***********          ADD  FEAMTP    ZFLD15                   140611 146488
     C***********                                                  140611 146488
     C***********ZFLD15    IFEQ *ZEROS                             140611 146488
     C***********          MOVE *BLANKS   SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C***  Actual amount fees                                             140611
     C***********                                                  140611 146488
     C***********          EXSR AVCALC                             140611 146488
     C***********WFEE      ADD  FEADAT    WFEE                     140611 146488
     C***********          ADD  FELPAM    WFEE                     140611 146488
     C***********          ADD  FEAMTP    WFEE                     140611 146488
     C***********                                                  140611 146488
     C***********WFEE      IFEQ *ZEROS                             140611 146488
     C***********          MOVE *BLANKS   SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C** For a calculated fee the accrued amount should be adjusted       140611
     C** for amounts outstanding and settled                              140611
     C***********                                                  140611 146488
     C***********          Z-ADDWFEE      ZFLD15                   140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          END                                     140611 146488
      ***********                                                  140611 146488
     C***********          END                                     140611 146488
      ***********                                                  140611 146488
     C***********          END                                     140611 146488
      ***********                                                  140611 146488
     C***********          END                                     140611 146488
      ***********                                                  140611 146488
      ** A write off can be for the whole amount or part of the           140611
      ** amount.                                                          140611
      ***********                                                  140611 146488
     C***********FATYPE    IFEQ 'W'                                140611 146488
      ***********                                                  140611 146488
     C***  Non- calculated fees                                           140611
      ***********                                                  140611 146488
     C***********FECALT    IFEQ '  '                               140611 146488
      ***********                                                  140611 146488
     C***********FEPEND    IFLE BJRDNB                             140611 146488
     C***********FEPEND    OREQ 0                                  140611 146488
     C***********FEPYON    ANDEQ*BLANK                             140611 146488
     C***********          Z-ADDFEFAMT    ZFLD15                   140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C***  Add extra day to accruals                                      140611
     C***********                                                  140611 146488
     C***********FEPSTD    IFNE BJRDNB                             140611 146488
     C***********BJRDNB    SUB  FEPSTD    FLATDS  50               140611 146488
     C***********FLATDS    SUB  1         FLATDS                   140611 146488
     C***********FEADAT    DIV  FLATDS    FLATAM 130H              140611 146488
     C***********FLATDS    ADD  1         FLATDS                   140611 146488
     C***********FLATAM    MULT FLATDS    FLATAM                   140611 146488
     C***********          Z-ADDFLATAM    ZFLD15                   140611 146488
     C***********          ELSE                                    140611 146488
     C***********          Z-ADDFEADAT    ZFLD15                   140611 146488
     C***********          END                                     140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
      ***********                                                  140611 146488
     C***********                                                  140611 146488
     C** For calculated fees based on averages need to calculate          140611
     C** what the value would be if today was payment date                140611
     C***********                                                  140611 146488
     C***********FECALT    IFEQ '01'                               140611 146488
     C***********FECALT    OREQ '02'                               140611 146488
     C***********FECALT    OREQ '03'                               140611 146488
     C***********FECALT    OREQ '11'                               140611 146488
     C***********FECALT    OREQ '12'                               140611 146488
     C***********FECALT    OREQ '13'                               140611 146488
     C***********FECALT    OREQ '21'                               140611 146488
     C***********                                                  140611 146488
     C***********          EXSR AVCALC                             140611 146488
     C***********                                                  140611 146488
     C***********          Z-ADDWFEE      ZFLD15                   140611 146488
     C***********          ADD  FEAMTP    ZFLD15                   140611 146488
     C***********                                                  140611 146488
     C***********ZFLD15    IFEQ *ZEROS                             140611 146488
     C***********          MOVE *BLANKS   SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C***********          EXSR ZFRPED                             140611 146488
     C***********          MOVE ZOUT25    SAMTP                    140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C*********** amount fees                                      140611 146488
     C***********                                                  140611 146488
     C***********          EXSR AVCALC                             140611 146488
     C***********WFEE      ADD  FEADAT    WFEE                     140611 146488
     C***********          ADD  FELPAM    WFEE                     140611 146488
     C***********          ADD  FEAMTP    WFEE                     140611 146488
     C***********                                                  140611 146488
     C***********WFEE      IFEQ *ZEROS                             140611 146488
     C***********          MOVE *BLANKS   SAMTP                    140611 146488
     C***********          ELSE                                    140611 146488
     C***********                                                  140611 146488
     C** For a calculated fee the accrued amount should be adjusted       140611
     C** for amounts outstanding and settled                              140611
     C*                                                                   140611
     C***********          Z-ADDWFEE      ZFLD15                   140611 146488
     C**********           Z-ADDFEAMTP    ZFLD15                                       146488 205399
      *                                                                                       205399
      * Save values of Fee adjustment being actioned.                                         205399
     C                     MOVE FATYPE    W#TYPE  1        Saved FATYPE                       205399
     C                     Z-ADDFASADJ    W#FSET 150       Saved FASADJ                       205399
     C                     MOVE FASTAL    W#STAL  1        Saved FASTAL                       CLE034
      **********                                                                       205912 208487
      ***Save*TNLU for later validation                                                205912 208487
      **********                                                                       205912 208487
     C**********           Z-ADDFATNLU    WTNLU   50                                   205912 208487
      *                                                                                       205399
      *  Check if there is a full settlement against this fee:                                205399
     C                     Z-ADD0         WFULL                                               205399
     C           WKFEE     SETLLLEFEEAL2                                                      205399
     C           *IN71     DOUEQ'1'                                                           205399
     C           WKFEE     READELEFEEAL2            N    71                                   205399
      *                                                                                       205399
     C           *IN71     IFEQ '1'                                                           205399
     C                     ITER                                                               205399
     C                     ENDIF                                                              205399
      *                                                                                       205399
     C           FATYPE    IFEQ 'F'                                                           205399
     C                     ADD  1         WFULL                                               205399
     C                     ENDIF                                                              205399
      *                                                                                       205399
     C                     ENDDO                                                              205399
      *                                                                                       205399
      * If settlements already exist for this fee, the value of FEAMTP                        205399
      * should be adjusted before displaying on the screen.                                   205399
     C                     Z-ADDFEAMTP    W#FEAM 150                                          205399
     C           WKFEE     SETLLLEFEEAL2                                                      205399
     C           *IN71     DOUEQ'1'                                                           205399
     C           WKFEE     READELEFEEAL2            N    71                                   205399
      *                                                                                       205399
     C           *IN71     IFEQ '1'                                                           205399
     C                     ITER                                                               205399
     C                     ENDIF                                                              205399
      *                                                                                       205399
     C                     SUB  FASADJ    W#FEAM                                              205399
      *                                                                                       205399
      **  Subtract all amounts when action is 'I' for insert, but                             205399
      ** for other actions, add back in the settlement being acioned.                         205399
      *                                                                                       205399
     C           SACTN     IFEQ 'E'                                                           205399
     C           SACTN     OREQ 'A'                                                           205399
     C           SACTN     OREQ 'X'                                                           205399
     C           SACTN     OREQ 'D'                                                           205399
     C           WVDAT     IFEQ FAVDAT                                                        205399
     C           WFULL     IFEQ 0                                                             205399
      * If a full payment has been made to the fee, this will reduce                          205399
      * the outstanding amount to zero, although previously input                             205399
      * settlements will still be actioned first.                                             205399
     C           WFULL     ORGE 1                                                             205399
     C           FATYPE    ANDEQ'F'                                                           205399
     C                     ADD  FASADJ    W#FEAM                                              205399
     C                     ELSE                                                               205399
      **  Else, there's a full settlement but it's not being actioned.                        205399
     C                     Z-ADDFASADJ    W#FEAM                                              205399
     C                     LEAVE                                                              205399
     C                     ENDIF                                                              205399
     C                     ENDIF                                                              205399
     C                     ENDIF                                                              205399
     C                     ENDDO                                                              205399
      **  Restore values of Fee adjustment being actioned.                                    205399
     C                     MOVE W#TYPE    FATYPE           Saved FATYPE                       205399
     C                     Z-ADDW#FSET    FASADJ           SAVED FASADJ                       205399
     C                     MOVE W#STAL    FASTAL           Saved FASTAL                       CLE034
      *                                                                                       205399
      **  Output Fee Amount Past Due to screen field:                                         205399
     C                     Z-ADDW#FEAM    ZFLD15                                              205399
     C                     EXSR ZFRPED                                    140611
     C                     MOVE ZOUT25    SAMTP                           140611
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          END                                     140611 146488
     C***********                                                  140611 146488
     C***********          END                                     140611 146488
      ***********                                                  140611 146488
     C***********          END                                     140611 146488
      *                                                                   140611
     C*                                                                   140611
      *END OF FIRST BIT OF CHANGE                                         140611
     C                     ELSE                                           140611
      *                                                                   140611
      ** If this is an adjustment record.                                 140611
      *                                                                   140611
      **  Set up screen detail fee accrued to date amount                 140611
      *                                                                   140611
     C***  Non- calculated fees                                           140611
     C*                                                                   140611
     C           FECALT    IFEQ '  '                                      140611
     C*                                                                   140611
     C           FEPEND    IFLE BJRDNB                                    140611
     C                     Z-ADDFEFAMT    ZFLD15                          140611
     C                     ELSE                                           140611
     C*                                                                   140611
     C***  Add extra day to accruals                                      140611
     C*                                                                   140611
     C           FEPSTD    IFNE BJRDNB                                    140611
     C           BJRDNB    SUB  FEPSTD    FLATDS  50                      140611
     C           FLATDS    SUB  1         FLATDS                          140611
     C           FEADAT    DIV  FLATDS    FLATAM 130H                     140611
     C           FLATDS    ADD  1         FLATDS                          140611
     C           FLATAM    MULT FLATDS    FLATAM                          140611
     C                     Z-ADDFLATAM    ZFLD15                          140611
     C                     ELSE                                           140611
     C                     Z-ADDFEADAT    ZFLD15                          140611
     C                     END                                            140611
     C                     END                                            140611
     C*                                                                   140611
     C                     EXSR ZFRPED                                    140611
     C                     MOVE ZOUT25    SAMTP                           140611
     C                     ELSE                                           140611
      *                                                                   140611
     C*                                                                   140611
     C** For calculated fees based on averages need to calculate          140611
     C** what the value would be if today was payment date                140611
     C*                                                                   140611
     C           FECALT    IFEQ '01'                                      140611
     C           FECALT    OREQ '02'                                      140611
     C           FECALT    OREQ '03'                                      140611
     C           FECALT    OREQ '11'                                      140611
     C           FECALT    OREQ '12'                                      140611
     C           FECALT    OREQ '13'                                      140611
     C           FECALT    OREQ '21'                                      140611
     C*                                                                   140611
     C                     EXSR AVCALC                                    140611
     C*                                                                   140611
     C                     Z-ADDWFEE      ZFLD15                          140611
     C**********           ADD  FEAMTP    ZFLD15                          140611              204351
     C*                                                                   140611
     C           ZFLD15    IFEQ *ZEROS                                    140611
     C                     MOVE *BLANKS   SAMTP                           140611
     C                     ELSE                                           140611
     C*                                                                   140611
     C                     EXSR ZFRPED                                    140611
     C                     MOVE ZOUT25    SAMTP                           140611
     C                     END                                            140611
     C*                                                                   140611
     C                     ELSE                                           140611
     C*                                                                   140611
     C***  Actual amount fees                                             140611
     C*                                                                   140611
     C                     EXSR AVCALC                                    140611
     C           WFEE      ADD  FEADAT    WFEE                            140611
     C                     ADD  FELPAM    WFEE                            140611
     C**********           ADD  FEAMTP    WFEE                            140611              204351
     C*                                                                   140611
     C           WFEE      IFEQ *ZEROS                                    140611
     C                     MOVE *BLANKS   SAMTP                           140611
     C                     ELSE                                           140611
     C*                                                                   140611
     C** For a calculated fee the accrued amount should be adjusted       140611
     C** for amounts outstanding and settled                              140611
     C*                                                                   140611
     C                     Z-ADDWFEE      ZFLD15                          140611
     C                     EXSR ZFRPED                                    140611
     C                     MOVE ZOUT25    SAMTP                           140611
     C                     END                                            140611
      *                                                                   140611
     C                     END                                            140611
      *                                                                   140611
     C                     END                                            140611
      *                                                                   140611
     C                     ENDIF
     C**********           Z-ADDA6NBDP    ZDECS                           140611
     C**********           MOVE 'J'       ZECODE                          140611
     C**********           EXSR ZFRPED                                    140611
     C**********           MOVE ZOUT21    SAMTP                           140611
      *
      ** Determine due date
      *
     C***********          SELEC                                          159695
     C***********FEDIND    WHEQ *BLANK                                    159695
     C           FEDIND    IFNE *BLANK                                    159695
     C                     Z-ADDFEDDAT    WSADD   50
     C                     ELSE                                           159695
     C                     SELEC                                          159695
     C           FEPYON    WHEQ 'E'
     C                     Z-ADDFEPEND    WSADD
     C           FEPYON    WHEQ 'N'
     C                     Z-ADDFENPYD    WSADD
     C                     ENDSL
     C                     ENDIF                                          159695
      *
      ** FORMAT FEE ADJUSTMENT/SETTLEMENT DETAILS
      *
     C                     MOVE *BLANKS   SFSTS
     C                     MOVE *BLANKS   SFADJ
     C                     MOVE *BLANKS   SSIGN
     C                     MOVE *BLANKS   SFSET
     C                     MOVE *BLANKS   STYPE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVEA'0000'    *IN,25
      *
      ** ... for settlement, if value date equals fee past due date
      ** upon insert, set settlement amount to fee amount past due
      *
     C           SACTN     IFEQ 'I'
     C           PFTYP     ANDEQ'S'
     C           WVDAT     ANDEQFEDDAT
     C                     Z-ADDWCPAM     ZFLD15
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE ZOUT20    SFSET
     C                     ENDIF
      *
     C           SACTN     IFNE 'I'
      *
      ** ... fee status in narrative format
      *
     C                     SELEC
     C           FASSTS    WHEQ 'C'
     C                     MOVEL'LER0194' ZAMSID
     C           FASSTS    WHEQ 'R'
     C                     MOVEL'LER0195' ZAMSID
     C           FASSTS    WHEQ 'A'
     C                     MOVEL'LER0196' ZAMSID
     C                     ENDSL
     C                     EXSR SRTEXT
     C                     MOVELZAMSTX    SFSTS
     C                     MOVE *BLANKS   ZAMSID
      *
     C                     Z-ADDFASADJ    ZFLD15
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
      *
      ** ... for settlement, settlement amount and type;
      ** for adjustment, adjustment amount and sign
      *
     C           PFTYP     IFEQ 'S'
     C                     MOVE ZOUT20    SFSET
     C                     MOVE FATYPE    STYPE
     C                     MOVE FASTAL    SFSTAL                                              CLE034
     C                     Z-ADDFAVDAT    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     SVDAT
     C                     ELSE
     C                     MOVE ZOUT20    SFADJ
     C                     MOVE FASIGN    SSIGN
     C                     ENDIF
      *
      ** Set up indicators for the action codes
      *
     C                     SELEC
     C           SACTN     WHEQ 'D'
     C                     MOVE '1'       *IN25
     C                     MOVE '1'       *IN28
     C                     MOVE '0'       *IN16                                               202826
     C           SACTN     WHEQ 'X'
      *
      **  Enable F11 only if BPAURV is not activated
      *
     C           BPAURV    IFNE 'Y'
     C                     MOVE '1'       *IN26
     C                     ENDIF
      *
     C                     MOVE '1'       *IN28
     C                     MOVE '0'       *IN16                                               202826
     C           SACTN     WHEQ 'E'
     C                     MOVE '1'       *IN28
     C                     MOVE '0'       *IN16                                               202826
     C           SACTN     WHEQ 'A'                                                           202826
     C                     MOVE '1'       *IN16                                               202826
     C                     ENDSL
      *
     C                     ENDIF
      *
      ***Save*TNLU*for*later*validation***                                                    205912
      ***                                                                                     205912
     C**********           Z-ADDFATNLU    WTNLU   50                                          205912
      *
      ** For fee settlements, allow F14 (settlements) for non-internal
      ** participant fees
      *
     C           PFTYP     IFEQ 'S'
     C           WPTFI     IFNE 'I'
     C           PMODE     OREQ 'B'                                                           219142
     C                     MOVE '1'       *IN27
     C                     MOVE 'Y'       WFPAS
     C                     ENDIF
      *
      ** If amending an authorised fee settlement, add back
      ** the settlement amount to the current total fee past due
      *
     C***********SACTN     IFEQ 'A'                                       146488
     C***********FASSTS    ANDEQ'A'                                       146488
     C***********          ADD  FASADJ    WCPAM                           146488
     C***********          ENDIF                                          146488
     C                     ENDIF
     C                     MOVE 'D1'      WFMT
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRLOAD  -  Load subfile records                               *
      * Called by: SRSFIL - Subfile processing                        *
      * Calls    : None                                               *
      *****************************************************************
     C           SRLOAD    BEGSR
      *
     C                     MOVEA'00'      *IN,29
     C                     MOVE '0'       *IN76
     C                     MOVE *BLANKS   SLSEL
     C                     EXSR CLEAR
     C                     MOVE SREVW     WREVW  14
     C/COPY WNCPYSRC,LEH00822
      *
      ** Clear the message subfile
      *
     C                     Z-ADD*ZEROS    SRRN    40
     C                     MOVE '1'       *IN78
     C/COPY WNCPYSRC,LEH00823
     C                     WRITELE2220C0
     C/COPY WNCPYSRC,LEH00824
     C                     MOVEA'000'     *IN,76
      *
      ** For fee settlements, load records from LEFEEAL3 if req.
      ** authorisation is 'Y', otherwise from LEFEEAL2
      *
     C                     MOVE SRCUS     WCNUM
     C                     MOVELSRFAC     WFACL
     C                     MOVE SRFNO     WFACL
     C/COPY WNCPYSRC,LEH00825
     C**********           Z-ADD*ZEROS    WLOAN                                               CLE148
     C                     MOVEL*BLANKS   WLOAN                                               CLE148
     C/COPY WNCPYSRC,LEH00826
     C                     MOVE SRFSQ     WFSEQ
     C                     Z-ADD*ZEROS    WVDAT
      *
     C           PFTYP     IFEQ 'S'
     C           SRAUT     IFEQ 'Y'
     C           WKFES     SETLLLEFEEAL3
     C                     READ LEFEEAL3                 79
     C                     ELSE
     C           WKFES     SETLLLEFEEAL2
     C                     READ LEFEEAL2            N    79
     C                     ENDIF
      *
     C                     ELSE
      *
      ** For fee adjustments, load records from LEFEEAL1 if req.
      ** authorisation is 'Y', otherwise from LEFEEAL0
      *
     C           SRAUT     IFEQ 'Y'
     C           WKFEE     SETLLLEFEEAL1
     C                     READ LEFEEAL1                 79
     C                     ELSE
     C           WKFEE     SETLLLEFEEAL0
     C                     READ LEFEEAL0            N    79
     C                     ENDIF
     C                     ENDIF
      *
      ** Load all records at one time only
      *
     C           *IN79     DOWEQ'0'
      *
     C                     Z-ADD*ZERO     @ERR
     C           BGMBIN    IFEQ 'Y'
     C                     MOVE FABRCA    @ZBR
     C           PMODE     IFEQ 'B'
     C                     CALL 'ZBBBU'
     C                     PARM           @ZBR
     C                     PARM           @USER
     C                     PARM           @ERR
     C                     ELSE
     C                     CALL 'ZVBBU'
     C                     PARM           @ZBR
     C                     PARM           @ERR
     C                     ENDIF
     C                     ENDIF
      *
      ** Display records only when the user is authorised to
      ** that branch
      *
     C           @ERR      IFEQ *ZERO
      *
     C                     MOVE FABRCA    SBRCH
     C                     MOVE FAIUSR    SIUSR
     C                     MOVE FAAUSR    SAUSR
     C                     MOVE FASSTS    SSTAT
     C                     Z-ADDFAVDAT    SSVDT
     C                     Z-ADDFASADJ    SSADJ
      *
     C                     MOVE FACNUM    SSCNO
     C                     MOVELFAFACL    SSFAC
     C                     MOVE FAFACL    SSFNO
     C                     MOVE FAFSEQ    SSFEE
     C                     MOVE *BLANKS   SSDUE
     C           FAVDAT    IFNE *ZEROS
     C                     Z-ADDFAVDAT    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    SSDUE
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00827
      *
     C                     MOVE FAFCCY    SSCCY
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM FAFCCY    PCURR
     C           SDCURR    PARM SDCURR    DSSDY
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCURRPD'DBFILE           ************
     C                     Z-ADD9         DBASE            * DBERR 09 *
     C                     MOVELPCURR     DBKEY            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           FASIGN    IFEQ '-'
     C                     Z-SUBFASADJ    FASADJ
     C                     ENDIF
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE FASADJ    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE ZOUT21    SSAMT
     C/COPY WNCPYSRC,LE2220C013
      *
     C                     SELEC
     C           FASSTS    WHEQ 'C'
     C                     MOVEL'LER0194' ZAMSID
     C           FASSTS    WHEQ 'R'
     C                     MOVEL'LER0208' ZAMSID
     C           FASSTS    WHEQ 'A'
     C                     MOVEL'LER0196' ZAMSID
     C                     ENDSL
     C                     EXSR SRTEXT
     C                     MOVELZAMSTX    SSSTS
     C                     MOVE *BLANKS   ZAMSID
      *
     C                     ADD  1         SRRN
     C/COPY WNCPYSRC,LEH00828
     C                     WRITELE2220S0
     C/COPY WNCPYSRC,LEH00829
     C                     ENDIF
      *
      ** Read next record to be loaded
      *
     C           PFTYP     IFEQ 'S'
     C           SRAUT     IFEQ 'Y'
     C                     READ LEFEEAL3                 79
     C                     ELSE
     C                     READ LEFEEAL2            N    79
     C                     ENDIF
      *
     C                     ELSE
      *
     C           SRAUT     IFEQ 'Y'
     C                     READ LEFEEAL1                 79
     C                     ELSE
     C                     READ LEFEEAL0            N    79
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** Inform user if subfile has no records to display
      ** and display 'Page keys' if rollup/rolldown is allowed
      *
     C           SRRN      IFEQ *ZEROS
     C                     MOVE '1'       *IN77
     C                     MOVEL'LER0170' ZAMSID
     C                     EXSR ZASNMS
     C                     WRITELE2220F0
     C                     ELSE
     C                     Z-ADD1         SRNBR
     C           SRRN      IFGT 10
     C                     MOVE '1'       *IN29
     C                     ENDIF
     C                     ENDIF
      *
     C                     WRITELE2220F3
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVREV  -  Validate review from entries                       *
      * Called by: SRSTRT - Validate initial screen                   *
      *            SRSFIL - Subfile processing                        *
      * Calls    : None                                               *
      *****************************************************************
     C           SRVREV    BEGSR
      *
     C                     EXSR CLEAR
     C                     MOVEA'0000'    *IN,35
     C/COPY WNCPYSRC,LEH00830
      *
      ** Customer number must be numeric when entered
      *
     C**********           MOVE '0'       WTST6   7                                           CSD027
     C**********           MOVELSRCUS     WTST6                                               CSD027
     C**********           TESTN          WTST6      50                                       CSD027
     C********** SRCUS     IFNE *BLANKS                                                       CSD027
     C********** *IN50     ANDEQ'0'                                                           CSD027
     C**********           MOVE '1'       *IN35                                               CSD027
     C**********           MOVEL'LER0007' ZAMSID                                              CSD027
     C**********           EXSR ZASNMS                                                        CSD027
     C**********           ENDIF                                                              CSD027
      *
      ** Facility must be numeric when entered
      ** If facility number is entered, so must facility type be
      *
     C/COPY WNCPYSRC,LEH00831
     C                     MOVE '0'       WTST3
     C                     MOVELSRFAC     WTST3
     C                     TESTN          WTST3      50
     C                     MOVE '0'       WTST2
     C                     MOVELSRFNO     WTST2
     C                     TESTN          WTST2      51
     C           SRFAC     IFNE *BLANKS
     C           *IN50     ANDEQ'0'
     C           SRFNO     ORNE *BLANKS
     C           *IN51     ANDEQ'0'
     C           SRFAC     OREQ *BLANKS
     C           SRFNO     ANDNE*BLANKS
     C                     MOVE '1'       *IN36
     C                     MOVEL'LER0008' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00832
      *
      ** Fee sequence must be numeric when entered
      *
     C                     MOVE '0'       WTST2   3
     C                     MOVELSRFSQ     WTST2
     C                     TESTN          WTST2      50
     C           SRFSQ     IFNE *BLANKS
     C           *IN50     ANDEQ'0'
     C                     MOVE '1'       *IN37
     C                     MOVEL'LER0014' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00833
      *
      ** Require authorisation must be 'Y' or 'N' when entered
      *
     C           SRAUT     IFNE *BLANK
     C           SRAUT     ANDNE'Y'
     C           SRAUT     ANDNE'N'
     C                     MOVE '1'       *IN38
     C                     MOVEL'LER0177' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C           SRAUT     IFEQ *BLANK
     C                     MOVE 'N'       SRAUT
     C                     ENDIF
      *
      ** If there are no errors, prepare for subfile processing
      *
     C           WERRF     IFEQ *BLANKS
     C                     MOVE 'S0'      WFMT
     C                     MOVE SRCUS     WCNUM
     C                     MOVELSRFAC     WFACL
     C                     MOVE SRFNO     WFACL
     C                     MOVE SRFSQ     WFSEQ
     C/COPY WNCPYSRC,LEH00834
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRAUTH  -  Validate authorisation action                      *
      * Called by: SRVKEY - Validate key fields                       *
      *            SRVSUB - Validate subfile entries                  *
      * Calls    : None                                               *
      *****************************************************************
     C           SRAUTH    BEGSR
      *
      ** If authorisation feature (CLE002) is not installed
      ** authorisation action is not allowed
      *
     C           CLE002    IFEQ 'N'
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0161' ZAMSID
     C                     EXSR ZASNMS
      *
      ** If authorisation feature is installed,
      **   (1) authorisation must be set as needed in order to continue
      **   (2) authorising user must be different from the insert and
      **         amend users
      **   (3) status of loan must be complete or requiring re-authori-
      **         sation
      *
     C                     ELSE
      *
     C           BPFSAU    IFNE 'Y'
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0162' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C/COPY WNCPYSRC,LE2220C008
     C           USER      IFEQ FAIUSR
     C           USER      OREQ FAAUSR
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0163' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C009
     C           FASSTS    IFNE 'C'
     C           FASSTS    ANDNE'R'
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0164' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C014
      *                                                                                       CSD015
      ** If Compliance Watch Enhancement (CSD015) is installed and Watch                      CSD015
      ** List Checking Applied...                                                             CSD015
      ** If 24x7 Midas Availability is not installed or it is installed and                   CSD015
      ** in the main system...                                                                CSD015
      ** Determine  if there is a pending case.                                               CSD015
      ** If there no pending case or case has been temporarily released,                      CSD015
      ** continue normal processing.  Otherwise send error message.                           CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           CSD015
      *                                                                                       CSD015
     C           CSC011    IFEQ 'N'                                                           CSD015
     C           CSC011    OREQ 'Y'                                                           CSD015
     C           LIBR      ANDEQS1MAIN                                                        CSD015
     C                     MOVEL'LEFEEAD' K3FUNT                                              CSD015
      *                                                                                       CSD015
     C********** FALOAN    IFEQ *ZERO                                                  CSD015 CLE148
     C           FALOAN    IFEQ *BLANKS                                                       CLE148
     C                     MOVELFACNUM    WFCNUM  6                                           CSD015
     C                     MOVELFAFACL    WFFACL  5                                           CSD015
     C                     MOVELFAFSEQ    WFFSEQ  2                                           CSD015
     C                     MOVELFAVDAT    WFVDAT  5                                           CSD015
     C           WFCNUM    CAT  WFFACL    WIDEN  11                                           CSD015
     C           WIDEN     CAT  WFFSEQ    WKIDEN 13                                           CSD015
     C           WKIDEN    CAT  WFVDAT    K3IDEN                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVELFALOAN    WFLOAN  6                                           CSD015
     C           WFLOAN    CAT  WFFSEQ    K3IDEN                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVELFABRCA    K3BRCH                                              CSD015
      *                                                                                       CSD015
     C           KCWHT     CHAINSDCWHTL1             71                                       CSD015
      *                                                                                       CSD015
     C           *IN71     IFEQ *OFF                                                          CSD015
     C           W3TREL    ANDNE'Y'                                                           CSD015
     C                     MOVE *ON       *IN30                                               CSD015
     C                     MOVEL'LEL0564' ZAMSID                                              CSD015
     C                     EXSR ZASNMS                                                        CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRCAUT  -  Check if user is authorised to the action          *
      * Called by: SRVKEY - Validate key fields                       *
      *            SRVSUB - Validate subfile entries                  *
      * Calls    : None                                               *
      *****************************************************************
     C           SRCAUT    BEGSR
      *
      ** For single branch system, check if user is authorised to the
      ** action
      *
     C                     Z-ADD*ZERO     @ERR
     C                     MOVE SACTN     @ZACTN
     C           BGMBIN    IFEQ 'N'
      *
     C           PMODE     IFEQ 'B'
     C                     CALL 'ZBACTU'
     C                     PARM           @ZACTN
     C                     PARM           @USER
     C**********           PARM           @ZMGRP                                              CSF002
     C**********           PARM           @ZICDE                                              CSF002
     C                     PARM           @UNQCD                                              CSF002
     C                     PARM           @ERR
     C                     ELSE
     C                     CALL 'ZVACTU'
     C                     PARM           @ZACTN
     C                     PARM           @ERR
     C                     ENDIF
      *
     C           @ERR      IFNE *ZERO
     C                     MOVE '1'       *IN30
     C                     MOVEL'LER0123' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** For multibranching system, check if user is authorised to
      ** the action code or any action codes for the menu item and branch
      *
     C           BGMBIN    IFEQ 'Y'
      *
     C                     MOVE FEBRCA    @ZBR
     C           PMODE     IFEQ 'B'
     C                     CALL 'ZBACTBU'
     C                     PARM           @ZACTN
     C                     PARM           @ZBR
     C                     PARM           @USER
     C**********           PARM           @ZMGRP                                              CSF002
     C**********           PARM           @ZICDE                                              CSF002
     C                     PARM           @UNQCD                                              CSF002
     C                     PARM           @ERR
     C                     ELSE
     C                     CALL 'ZVACTBU'
     C                     PARM           @ZACTN  1
     C                     PARM           @ZBR    3
     C                     PARM           @ERR    10
     C                     ENDIF
      *
     C           @ERR      IFNE *ZEROS
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00835
     C           @ERR      IFEQ 1
     C                     MOVEL'LER0121' ZAMSID
     C                     ENDIF
     C           @ERR      IFEQ 2
     C                     MOVEL'LER0122' ZAMSID
     C                     ENDIF
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRFSET  -  Read all settlements for the fee                   *
      * Called by: SRVKEY - Validate key fields                       *
      *            SRVSUB - Validate subfile entries                  *
      * Calls    : None                                               *
      *****************************************************************
     C           SRFSET    BEGSR
      *
      ** Read all authorised settlements for the fee
      *
     C                     Z-ADDFEAMTP    WCPAM  130
     C                     Z-ADD0         WPART                                               202826
     C                     Z-ADD0         WWRITE                                              202826
     C                     Z-ADD0         WFULL   20                                          202826
     C           WKFEE     SETLLLEFEEAL2
     C           *IN71     DOUEQ'1'
     C           WKFEE     READELEFEEAL2            N    71
      *
     C           *IN71     IFEQ '1'
     C********** FASSTS    ORNE 'A'                                                           202826
     C                     ITER
     C                     ENDIF
      *
     C           FATYPE    IFEQ 'P'                                                           202826
     C                     ADD  1         WPART   20                                          202826
     C                     ELSE                                                               202826
     C           FATYPE    IFEQ 'W'                                                           202826
     C                     ADD  1         WWRITE  20                                          202826
     C                     ELSE                                                               202826
     C           FATYPE    IFEQ 'F'                                                           202826
     C                     ADD  1         WFULL                                               202826
     C                     ENDIF                                                              202826
     C                     ENDIF                                                              202826
     C                     ENDIF                                                              202826
      ** If an authorised full payment has been made to the fee, no more
      ** fee settlement can be input
      *
     C           FATYPE    IFEQ 'F'
     C********** SACTN     ANDNE'A'                                                           202826
     C           SACTN     ANDEQ'I'                                                           202826
     C                     MOVEA'11111'   *IN,30
     C/COPY WNCPYSRC,LEH00836
     C                     MOVEL'LER0178' ZAMSID
     C                     EXSR ZASNMS
     C                     LEAVE
     C                     ENDIF
      *
      ** Determine the current total amount past due
      *
      ** Subtract amount only when transactions is insert                                     202826
      *                                                                                       202826
     C           SACTN     IFEQ 'I'                                                           202826
      *                                                                                       202826
     C           SACTN     OREQ 'A'                                                           202826
     C           WVDAT     ANDNEFAVDAT                                                        202826
      *                                                                                       202826
      ** This is for P-F combination, when F is being authorised.                             202826
      *                                                                                       202826
     C           SACTN     OREQ 'X'                                                           202826
     C           WVDAT     ANDNEFAVDAT                                                        202826
     C           FATYPE    ANDEQ'P'                                                           202826
      *                                                                                       202826
      ** This is for W-F combination, when F is being authorised.                             202826
      *                                                                                       202826
     C           SACTN     OREQ 'X'                                                           202826
     C           WVDAT     ANDNEFAVDAT                                                        202826
     C           FATYPE    ANDEQ'W'                                                           202826
     C                     SUB  FASADJ    WCPAM
     C                     ENDIF                                                              202826
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRDTL1  -  Process first detail screen                        *
      * Called by: Main routine                                       *
      *            SRSPRO - Subfile processing                        *
      * Calls    : SRVALD - Validate detail screen                    *
      *            SRCHOL - Check if value date is a holiday          *
      *****************************************************************
     C           SRDTL1    BEGSR
      *
      ** Perform detail screen processing until F3 or F12 is pressed
      ** or record being processed is valid
      *
     C                     MOVE *BLANK    WVAUT   1
     C           WFMT      DOUNE'D1'
     C                     WRITELE2220C1
     C                     EXFMTLE2220F2
      *
      **  Enable *INKK if BPAURV is activated
      *
     C           SACTN     IFEQ 'X'
     C           BPAURV    ANDEQ'Y'
     C                     MOVE '1'       *INKK
     C                     ENDIF
      *
     C                     EXSR CLEAR
     C                     MOVEA'0000'    *IN,39
     C                     MOVE '0'       *IN34
      *
     C                     SELEC
      *
      ** F3 is pressed, end processing
      *
     C           *INKC     WHEQ '1'
     C                     MOVE *BLANK    WFMT
      *
      ** F12 is pressed, return to initial or subfile screen
      *
     C           *INKL     WHEQ '1'
     C           WWRTRN    IFEQ 'S0'
     C           *IN24     OREQ '1'
     C                     MOVE 'S0'      WFMT
     C                     ELSE
     C                     MOVE 'F0'      WFMT
     C                     ENDIF
      *
      ** F10 is pressed, delete record
      *
     C           *INKJ     WHEQ '1'
     C           SACTN     IFNE 'D'
     C                     MOVEL'LER0165' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     MOVE 'UP'      WFMT
     C                     ENDIF
      *
      ** F11 is pressed, authorise fee settlement/adjustment
      *
     C           *INKK     WHEQ '1'
     C           SACTN     IFNE 'X'
     C                     MOVEL'LER0166' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     EXSR SRVALD
     C                     ENDIF
      *
      ** F14 is pressed, do settlement processing
      *
     C           *INKN     WHEQ '1'
     C           SACTN     IFEQ 'I'
     C           SACTN     OREQ 'A'
     C           SACTN     OREQ 'X'
     C                     EXSR SRVALD
     C                     ENDIF
     C           WERRF     IFEQ *BLANK
     C           WWARN     ANDEQ*BLANK
     C                     MOVE 'D2'      WFMT
     C                     ENDIF
      *
      ** Enter key is pressed
      *
     C                     OTHER
     C                     SELEC
      *
      ** ... Instruct user to press F10 to delete the record
      *
     C           SACTN     WHEQ 'D'
     C                     MOVEL'LER0167' ZAMSID
     C                     EXSR ZASNMS
      *
      ** ... Validate and show all warning errors, then instruct
      ** user to press F11 to authorise the record when no severe
      ** error is encountered
      *
     C           SACTN     WHEQ 'X'
     C           PFTYP     IFEQ 'S'
     C           WPTFI     ANDNE'I'
     C                     EXSR SRCHOL
     C                     ENDIF
     C                     EXSR SRVALD
     C           WERRF     IFEQ *BLANK
     C                     MOVEL'LER0168' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE 'D1'      WFMT
     C                     ENDIF
      *
      ** ... validate fields for insert and amend
      ** if no error and participant fee indicator is not 'I',
      ** proceed to settlement validation; if participant indicator
      ** is 'I', proceed to updates
      *
     C           SACTN     WHEQ 'I'
     C           SACTN     OREQ 'A'
     C                     EXSR SRVALD
      *
      ** ... for enquiry, proceed to detail or subfile screen
      *
     C                     OTHER
     C           WWRTRN    IFEQ 'S0'
     C                     MOVE 'S0'      WFMT
     C                     ELSE
     C                     MOVE 'F0'      WFMT
     C                     ENDIF
     C                     ENDSL
      *
     C                     ENDSL
     C                     ENDDO
      *
      ** Perform window processing for successful detail processing
      *
     C           *INKC     IFEQ '0'
     C           *INKL     ANDEQ'0'
      *
     C/COPY WNCPYSRC,LE2220MOV1
      *
      **  Call window manager WN0010
      *
     C                     CALL 'WN0010'
     C                     PARM 'LE2220'  #PGM   10
     C                     PARM           KEY     2
     C                     PARM SACTN     ACTION  1
     C                     PARM           DATA
     C                     PARM *BLANK    #RTRN   7
     C                     PARM           SPARE 256
      *
      ** Process return code
      *
     C                     SELEC
     C           #RTRN     WHEQ 'Y2U9999'
     C                     MOVE *BLANK    WFMT
     C           #RTRN     WHEQ 'USR0790'
     C                     MOVE 'D1'      WFMT
     C           #RTRN     WHNE *BLANKS
     C                     MOVEL#RTRN     ZAMSID
     C                     MOVEL'WNMSGF'  ZAMSGF
     C                     EXSR ZASNMS
     C                     MOVEL'LERMSGF 'ZAMSGF
     C                     ENDSL
      *
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVALD  -  Validate detail screen                             *
      * Called by: SRDTL1 - Process detail screen                     *
      *            SRBTCH - Batch processing                          *
      * Calls    : SRVFES - Validate fee settlement                   *
      *            SRVFEA - Validate fee adjustment                   *
      *****************************************************************
     C           SRVALD    BEGSR
      *
     C                     MOVEA'0000'    *IN,39
     C                     MOVE *OFF      *IN12                                               CLE034
      *
     C           PFTYP     IFEQ 'S'
     C                     EXSR SRVFES
     C                     ELSE
     C                     EXSR SRVFEA
     C                     ENDIF
      *                                                                                       CLE034
      ** Validate Settlement Allocation                                                       CLE034
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
      *                                                                                       CLE034
     C           SFSTAL    IFEQ *BLANK                                                        CLE034
     C                     MOVE 'N'       SFSTAL                                              CLE034
     C                     ELSE                                                               CLE034
     C           SFSTAL    IFNE 'Y'                                                           CLE034
     C           SFSTAL    ANDNE'N'                                                           CLE034
     C                     MOVE *ON       *IN12                                               CLE034
     C                     MOVEL'LER0234' ZAMSID                                              CLE034
     C                     EXSR ZASNMS                                                        CLE034
     C                     ENDIF                                                              CLE034
     C           SFSTAL    IFEQ 'Y'                                                           219786
     C           WPTFI     ANDEQ'I'                                                           219786
     C           PMODE     ANDNE'B'                                                           219786
     C                     MOVEL'N'       SFSTAL                                              219786
     C                     ENDIF                                                              219786
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C                     ENDIF                                                              CLE034
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVFES  -  Validate fee settlement                            *
      * Called by: SRVALD - Validate detail screen                    *
      * Calls    : None                                               *
      *****************************************************************
     C           SRVFES    BEGSR
      *
     C                     MOVEA'00000'   *IN,30
     C/COPY WNCPYSRC,LEH00837
     C           SRRN      IFGT 0                                                             204434
     C           A         ANDGT0                                                             204434
     C                     Z-ADDSRRN      A                                                   204434
     C                     Z-ADDWPAM,A    WCPAM                                               204434
     C                     ENDIF                                                              204434
      *
      ** If blank, defaults to total fee amount past due
      *
     C                     MOVE *BLANKS   PRTCD
     C           SFSET     IFEQ *BLANKS
     C                     Z-ADDWCPAM     WFSET  130
     C                     Z-ADDWCPAM     ZFLD15
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE ZOUT20    SFSET
      *
      ** Settlement amount must be valid in fee currency
      *
     C                     ELSE
     C                     MOVE *BLANKS   PSCRF
     C                     MOVE SFSET     PSCRF
     C                     Z-ADD1         X                                                   227717
     C           FEFCCY    LOKUPCURR,X                   52                                   227717
     C           *IN52     IFEQ '1'                                                           227717
     C                     Z-ADDCCDP,X    A6NBDP                                              227717
     C                     END                                                                227717
     C                     Z-ADDA6NBDP    PNDEC
     C           13        SUB  A6NBDP    PNDIG
     C                     CALL 'ZALIGN'
     C                     PARM           PRTCD
     C                     PARM           PSCRF  16
     C                     PARM           PNDEC   10
     C                     PARM           PNDIG   20
     C                     PARM *BLANKS   PRVAL  16
     C                     MOVE PRVAL     WFSET
     C                     ENDIF
      *
     C           PRTCD     IFNE *BLANKS
     C           WFSET     OREQ *ZEROS
     C           STYPE     ANDNE'P'
     C                     MOVE '1'       *IN41
     C                     MOVEL'LER0191' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** Must be write off, full or partial settlement
      *
     C           STYPE     IFNE 'W'
     C           STYPE     ANDNE'F'
     C           STYPE     ANDNE'P'
     C                     MOVE '1'       *IN42
     C                     MOVEL'LER0078' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     Z-ADD*ZEROS    WFTYP                                               204434
     C**********           Z-ADD*ZEROS    WSCNUM                                       204434 CSD027
     C                     MOVE *BLANKS   WSCNUM                                              CSD027
     C                     Z-ADD*ZEROS    WSFSEQ                                              204434
      *                                                                                       204434
      ** move screen variables to numeric variable for comparison                             204434
      *                                                                                       204434
     C           SFACT     IFNE *BLANKS                                                       204434
     C           SFCNO     ANDNE*BLANKS                                                       204434
     C           SCNUM     ANDNE*BLANKS                                                       204434
     C                     MOVELSFACT     WFTYP   50                                          204434
     C                     MOVE SFCNO     WFTYP                                               204434
     C**********           MOVE SCNUM     WSCNUM  60                                   204434 CSD027
     C                     MOVE SCNUM     WSCNUM  6                                           CSD027
     C                     MOVE SFSEQ     WSFSEQ  20                                          204434
     C                     ENDIF                                                              204434
      *                                                                                       202826
      ** If partial payment already inserted, a full payment should not be allowed            202826
      ** with value date less than the fee's past due date.                                   202826
      *                                                                                       202826
     C           STYPE     IFEQ 'F'                                                           202826
     C           FATYPE    ANDEQ'P'                                                           202826
     C           FAVDAT    ANDGTWVDAT                                                         202826
     C           WSCNUM    ANDEQFACNUM                                                        204434
     C           WFTYP     ANDEQFAFACL                                                        204434
     C           WSFSEQ    ANDEQFAFSEQ                                                        204434
     C           STYPE     OREQ 'F'                                                           202826
     C           FATYPE    ANDEQ'W'                                                           202826
     C           FAVDAT    ANDGTWVDAT                                                         202826
     C           WSCNUM    ANDEQFACNUM                                                        204434
     C           WFTYP     ANDEQFAFACL                                                        204434
     C           WSFSEQ    ANDEQFAFSEQ                                                        204434
     C                     MOVE '1'       *IN42                                               202826
     C                     MOVEL'LER0302' ZAMSID                                              202826
     C                     EXSR ZASNMS                                                        202826
     C                     ENDIF                                                              202826
      *
      ** For full settlement, issue a warning message if
      ** not the full fee amount past due is being settled
      ** whether it is less or greater than it
      *
     C                     SELEC
     C           STYPE     WHEQ 'F'
     C           WFSET     IFNE WCPAM
     C           *IN41     ANDEQ'0'
     C           WWAR1     IFEQ *BLANK
     C           WWAR1     OREQ 'Y'
     C           WFSET     ANDNEWSSET
     C                     Z-ADDWFSET     WSSET  130
     C                     MOVE 'Y'       WWAR1
     C                     MOVE 'W'       WESEV   1
     C                     MOVE '1'       *IN41
      *
     C           WFSET     IFLT WCPAM
     C                     MOVEL'LER0180' ZAMSID
     C                     ENDIF
     C           WFSET     IFGT WCPAM
     C                     MOVEL'LER0181' ZAMSID
     C                     ENDIF
      *
     C                     EXSR ZASNMS
     C                     MOVE *BLANK    WESEV
     C                     ENDIF
     C                     ENDIF
      *
      ** For partial settlement, an amount less than the amount
      ** due must be entered
      *
     C           STYPE     WHEQ 'P'
     C           WFSET     IFEQ *ZEROS
     C********** WFSET     ORGE WCPAM                                                         202826
     C           WFSET     ORGE WCPAM                                                         202826
     C           WPART     ANDEQ0                                                             202826
      *                                                                                       202826
      ** P-P combination                                                                      202826
      *                                                                                       202826
     C           WFSET     ORGE WCPAM                                                         202826
     C           WPART     ANDGE1                                                             202826
     C           WWRITE    ANDEQ0                                                             202826
     C           WFULL     ANDEQ0                                                             202826
      *                                                                                       202826
      ** P-F combination                                                                      202826
      *                                                                                       202826
     C           WFSET     ORGT WCPAM                                                         202826
     C           WPART     ANDGE1                                                             202826
     C           WWRITE    ANDEQ0                                                             202826
     C           WFULL     ANDGT0                                                             202826
      *                                                                                       202826
      ** P and W combination                                                                  202826
      *                                                                                       202826
     C           WFSET     ORGT WCPAM                                                         202826
     C           WPART     ANDGE1                                                             202826
     C           WWRITE    ANDGT0                                                             202826
     C                     MOVE '1'       *IN42
     C                     MOVEL'LER0079' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** An amount to be written off must not be greater than the
      ** amount due
      *
     C           STYPE     WHEQ 'W'
     C           WFSET     IFGT WCPAM
     C           WWRITE    ANDEQ0                                                             202826
      *                                                                                       202826
      ** W-W combination                                                                      202826
      *                                                                                       202826
     C           WFSET     ORGT WCPAM                                                         202826
     C           WWRITE    ANDGE1                                                             202826
     C           WPART     ANDEQ0                                                             202826
     C           WFULL     ANDEQ0                                                             202826
      *                                                                                       202826
      ** W-F combination                                                                      202826
      *                                                                                       202826
     C           WFSET     ORGT WCPAM                                                         202826
     C           WWRITE    ANDGE1                                                             202826
     C           WPART     ANDEQ0                                                             202826
     C           WFULL     ANDGT0                                                             202826
      *                                                                                       202826
      ** W-P combination                                                                      202826
      *                                                                                       202826
     C           WFSET     ORGT WCPAM                                                         202826
     C           WWRITE    ANDGE1                                                             202826
     C           WPART     ANDGT0                                                             202826
     C                     MOVE '1'       *IN42
     C                     MOVEL'LER0080' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDSL
      *
      ** If there are no errors, prepare for next processing
      ** Either updates or settlement processing (first time
      ** or not but settlement errors are outstanding)
      *
     C           WERRF     IFEQ *BLANK
     C           WWARN     ANDEQ*BLANK
     C           SACTN     IFEQ 'I'
     C                     MOVE 'WR'      WFMT
     C                     ELSE
     C                     MOVE 'UP'      WFMT
     C           *INKK     IFEQ '1'
     C           WPTFI     ANDNE'I'                                       128566
     C                     MOVE 'D2'      WFMT
     C                     ENDIF
     C                     ENDIF
      *
     C           WPTFI     IFNE 'I'
     C           *INKK     ANDEQ'0'
     C           WFPAS     IFEQ 'Y'
     C           WFPAS     OREQ *BLANKS
     C           PMERCD    ANDNE*BLANKS
     C                     MOVE 'D2'      WFMT
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRVFEA  -  Validate fee adjustment                            *
      * Called by: SRVALD - Validate detail screen                    *
      * Calls    : None                                               *
      *****************************************************************
     C           SRVFEA    BEGSR
      *
      ** Fee adjustment amount is mandatory
      *
     C                     Z-ADD*ZEROS    WFADJ  130
     C           SFADJ     IFNE *BLANKS
     C                     MOVE *BLANKS   PSCRF
     C                     MOVE SFADJ     PSCRF
     C                     Z-ADDA6NBDP    PNDEC
     C           13        SUB  A6NBDP    PNDIG
     C                     CALL 'ZALIGN'
     C                     PARM *BLANKS   PRTCD
     C                     PARM           PSCRF  16
     C                     PARM           PNDEC   10
     C                     PARM           PNDIG   20
     C                     PARM *BLANKS   PRVAL  16
     C                     MOVE PRVAL     WFADJ
     C                     ENDIF
     C           PRTCD     IFNE *BLANKS
     C           WFADJ     OREQ *ZEROS
     C                     MOVE '1'       *IN39
     C                     MOVEL'LER0192' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** Fee adjustment sign must be '+' or '-' when entered
      ** Defaults to '+' if blank
      *
     C           SSIGN     IFNE *BLANKS
     C           SSIGN     ANDNE'+'
     C           SSIGN     ANDNE'-'
     C                     MOVE '1'       *IN40
     C                     MOVEL'LER0169' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C           SSIGN     IFEQ *BLANK
     C                     MOVE '+'       SSIGN
     C                     ENDIF
      *
      ** If there are no errors, prepare for next processing
      *
     C           WERRF     IFEQ *BLANK
     C           SACTN     IFEQ 'I'
     C                     MOVE 'WR'      WFMT
     C                     ELSE
     C                     MOVE 'UP'      WFMT
     C************INKK     IFEQ '1'                                       128566
     C***********          MOVE 'D2'      WFMT                            128566
     C***********          ENDIF                                          128566
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRDTL2  -  Extended settlement processing                     *
      * Called by: Main routine                                       *
      *            SRSPRO - Subfile processing                        *
      * Calls    : SREXST - Format fields for extended settlement     *
      *            SRCHOL - Check valued date for holiday             *
      *****************************************************************
     C           SRDTL2    BEGSR
      *
      ** Process settlement screen until F12 or F3 is pressed from
      ** SD2400
      *
     C           WFMT      DOUNE'D2'
     C                     EXSR SREXST
     C                     MOVE *BLANKS   PMTERM
     C/COPY WNCPYSRC,LE2220C004
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           SFSTAL    ANDEQ'Y'                                                           CLE034
      *                                                                                       CLE034
     C                     MOVE *BLANKS   PWVDAT  5                                           CLE034
     C                     MOVE WVDAT     PWVDAT                                              CLE034
     C                     MOVE SCNUM     PCNUM                                               CLE034
     C                     MOVE WFACL     PFACL                                               CLE034
     C                     MOVE SFSEQ     PFASQ                                               CLE034
      *                                                                                       CLE034
     C                     CALL 'LE2230'                                                      CLE034
     C                     PARM 'FSET'    PWTYP                                               CLE034
     C                     PARM *BLANKS   SFLNRF                                              CLE034
     C                     PARM           PWVDAT  5                                           CLE034
     C                     PARM *BLANKS   PSEQN   3                                           CLE034
     C                     PARM           PCNUM                                               CLE034
     C                     PARM           PFACL                                               CLE034
     C                     PARM           PFASQ                                               CLE034
     C                     PARM           SETLIB                                              CLE034
     C                     PARM           SETLIZ                                              CLE034
     C                     PARM           PMODE                                               CLE034
     C                     PARM           PTMST                                               CLE034
     C                     PARM *BLANKS   PERRF   1                                           CLE034
     C                     PARM *BLANKS   PWARN   1                                           CLE034
     C                     PARM *BLANKS   PSNOS   1                                           CLE034
     C                     PARM *BLANKS   PSAMD   1                                           CLE034
     C                     PARM *BLANKS   PNDET   1                                           CLE034
     C                     PARM *BLANKS   PRCCY  60                                           CLE034
     C                     PARM *BLANKS   PRLOC  60                                           CLE034
     C                     PARM *BLANKS   PPCCY  60                                           CLE034
     C                     PARM *BLANKS   PPLOC  60                                           CLE034
     C                     PARM           FAPCRF                                              CLE034
     C                     PARM *BLANKS   PORED                                               CLE038
     C                     PARM *ZERO     PAAMT                                               CLE038
      *                                                                                       CLE034
     C                     ELSE                                                               CLE034
      *                                                                                       CLE034
     C                     CALL 'SD2400'
     C                     PARM *BLANKS   PRTCD
     C                     PARM           SETLIB
     C                     PARM           SETLIZ
     C                     PARM           PLNRF   6
     C                     PARM           @PARM3                          222373
      *                                                                                       CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C/COPY WNCPYSRC,LE2220C005
      *
      ** Terminate program if database error returned
      *
     C                     SELEC
     C           PMDBSE    WHNE *ZERO
     C           *LOCK     IN   LDA
     C                     MOVELPMDBFL    DBFILE           ************
     C                     Z-ADDPMDBSE    DBASE            * DBERR XX *
     C                     MOVELPMDBKY    DBKEY            ************
     C                     MOVELPMDPGM    DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
      *
      ** F3 is pressed, exit program
      *
     C           PMCMDP    WHEQ '03'
     C                     MOVE *BLANK    WFMT
     C           PMODE     IFNE 'B'                                                           227710
     C           PMODE     ANDNE'P'                                                           227710
     C                     ROLBK                                                              227710
     C                     ENDIF                                                              227710
      *
      ** F12 is pressed, return to previous screen
      *
     C           PMCMDP    WHEQ '12'
     C                     EXSR CLEAR
     C                     MOVE *BLANK    WFPAS   1
      *
      ** Settlement detail not in error or F12 is pressed without
      ** validation
      ** If action is insert, amend or authorise, check for holiday
      ** Otherwise, return to previous screen
      *
     C           PMSDTV    IFEQ 'Y'
     C           PMSDTV    OREQ 'N'
     C           PMERCD    ANDEQ*BLANKS
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           PMSDTV    ANDEQ'N'                                                           CLE034
     C           PMERCD    ANDEQ*BLANKS                                                       CLE034
     C                     MOVE 'N'       SFSTAL                                              CLE034
     C                     ENDIF                                                              CLE034
     C           SACTN     IFEQ 'I'
     C           SACTN     OREQ 'A'
     C           SACTN     OREQ 'X'
     C                     EXSR SRCHOL
     C                     ELSE
     C                     MOVE 'D1'      WFMT
     C           *INKK     IFEQ '1'
     C                     MOVE 'UP'      WFMT
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** Display message informing the user that errors exist in sett
      *
     C           PMERCD    IFNE *BLANKS
     C                     MOVE 'D1'      WFMT
     C                     MOVEL'LER0176' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDSL
     C           SACTN     IFNE 'X'
     C                     MOVE 'N'       PMFRST
     C                     ENDIF
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SREXST  -  Format fields for extended settlement              *
      * Called by: SRDTL2 - Extended settlements processing           *
      * Calls    : SRBPEX - Format ext sett fields for batch/play     *
      *            SRMFSC - Move file values to settlement screen     *
      *            SRDTSC - Move previously validated sett values     *
      *            SRINST - Initialise extended sett fields to blanks *
      *****************************************************************
     C           SREXST    BEGSR
      *
      ** Processing for first entry on the settlement screen for
      ** the record
      *
     C           WFPAS     IFEQ 'Y'
     C                     CLEARSETLIB
     C                     CLEARSETLIZ
      *
     C                     MOVE SACTN     PMACTC
     C***********          MOVE 'MMLD'    PMCPGM                          135152
     C                     MOVE 'LEND'    PMCPGM                          135152
     C                     MOVE 'Y'       PMFRST
     C                     Z-ADDBJRDNB    PMRUND
     C                     Z-ADDBJBVPD    PMBVPD
     C                     MOVE SCNUM     PMCSNM
     C                     MOVE FEBRCA    PMBRCA
     C                     MOVE SFCCY     PMRCCY
     C                     MOVE SFCCY     PMPCCY
     C                     Z-ADDWVDAT     PMDTRC
     C                     Z-ADDWVDAT     PMDTPY
      *
      ** ... settlement detail valid flag
      *
     C           SACTN     IFEQ 'E'
     C           SACTN     OREQ 'X'
     C           SACTN     OREQ 'D'
     C                     MOVE 'Y'       PMSDTV
     C                     ELSE
     C                     MOVE 'N'       PMSDTV
     C                     ENDIF
      *
      ** ... retail function flags
      *
     C           BGRTBN    IFEQ 'Y'
     C                     MOVE 'Y'       PMRETP
     C                     ENDIF
     C           BMRANR    IFEQ 'Y'
     C                     MOVE 'Y'       PMRETS
     C                     ENDIF
     C                     MOVE BMACCD    PMPCYA
      *
      ** ... pay and and receive settlement inputs will be protected
      ** on enquiry, authorisation and deletion; also on amend of a
      ** write off
      *
     C           SACTN     IFEQ 'E'
     C           SACTN     OREQ 'X'
     C           SACTN     OREQ 'D'
     C           SACTN     OREQ 'A'
     C           STYPE     ANDEQ'W'
     C                     MOVE 'Y'       PMPRCV
     C                     MOVE 'Y'       PMPPAY
     C                     ELSE
      *
      ** ... otherwise, prepare for receive settlement input for
      ** normal fees or pay settlement input for participant fees
      *
     C           WPTFI     IFEQ *BLANK
     C                     MOVE 'N'       PMPRCV
     C                     MOVE 'Y'       PMPPAY
     C                     ELSE
     C                     MOVE 'Y'       PMPRCV
     C                     MOVE 'N'       PMPPAY
     C                     ENDIF
     C                     ENDIF
      *
      ** ... for insert in non-batch mode, initialise SD2400 parm
      ** otherwise, move file or data structure values to SD2400
      ** parameters to be displayed for settlement screen
      *
     C           PMODE     IFEQ 'I'
     C           PMODE     OREQ 'R'
     C           SACTN     IFEQ 'I'
     C                     EXSR SRINST
     C                     ELSE
     C                     EXSR SRMFSC
     C                     ENDIF
      *
      ** For batch/play processing, get from test harness file or
      ** transmitted message format
      *
     C                     ELSE
     C                     EXSR SRBPEX
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Field to be set up on every entry to the settlement screen
      *
      ** ... validation only flag
      *
     C           PMFRST    IFEQ 'N'
     C                     MOVE 'Y'       PMVALO
     C                     ELSE
     C                     MOVE 'N'       PMVALO
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRMFSC  -  Move file values to settlement screen              *
      * Called by: SREXST - Format extended settlement fields         *
      * Calls    : SRSHNM - Move customer name to shortname           *
      *****************************************************************
     C           SRMFSC    BEGSR
      *
      ** If participant fee ind is blank, format receive settlement
      *
     C           WPTFI     IFEQ *BLANK
     C                     Z-ADDFARSTM    PMRSTM
     C                     MOVE FARONS    PMRONS
     C                     MOVE FARIBN    PARIBN
     C                     MOVE FARIBA    PMRIBA
     C********** FAROBN    IFNE *ZEROS                                                        CSD027
     C           FAROBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAROBN    PAROBN
     C                     ENDIF
     C********** FAROCN    IFNE *ZEROS                                                        CSD027
     C           FAROCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAROCN    PAROCN
     C                     ENDIF
     C***********PMRSTM    IFEQ 5                                         155931
     C                     MOVE FAOSDB    PMROBR
     C***********          ENDIF                                          155931
      *                                                                   CEU004
      **  Set-up Settlement Currency                                      CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE FASCCY    PMRSCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE FASCCY    PMRSCY                                              CLE031
     C           FEREXR    IFEQ 0                                                             CLE031
     C                     MOVE *BLANK    PMREXR                                              CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD                                              CLE031
     C                     MOVE FEREXR    ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZEDIT                                                         CLE031
     C                     MOVE ZFIELD    PMREXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE FEREXI    PMREXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *
      ** If participant fee ind is P, format pay settlement
      *
     C                     ELSE
     C                     Z-ADDFAPSTM    PMPSTM
     C                     MOVE FAPONS    PMPONS
     C                     MOVE FAPIBN    PAPIBN
     C                     MOVE FAPIBA    PMPIBA
     C********** FAPOBN    IFNE *ZEROS                                                        CSD027
     C           FAPOBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAPOBN    PAPOBN
     C                     ENDIF
     C********** FAPOCN    IFNE *ZEROS                                                        CSD027
     C           FAPOCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAPOCN    PAPOCN
     C                     ENDIF
     C***********PMPSTM    IFEQ 5                                         155931
     C                     MOVE FAOMDB    PMPOBR
     C***********          ENDIF                                          155931
      *
     C                     MOVE FACVMR    PMCVMR
     C                     MOVE FARCRN    PARCRN
     C                     MOVE FARCRA    PMRCRA
     C                     MOVE FARVNO    PARVNO
     C                     MOVE FAAWBN    PAAWBN
     C                     MOVE FAAWBA    PMAWBA
     C                     MOVE FABENN    PABENN
     C                     MOVE FABENA    PMBENA
     C                     MOVE FADTP1    PMDTP1
     C                     MOVE FADTP2    PMDTP2
     C                     MOVE FADTP3    PMDTP3
     C                     MOVE FADTP4    PMDTP4
     C                     MOVE FADCHG    PMDCHG
     C                     MOVE FABTB1    PMBTB1
     C                     MOVE FABTB2    PMBTB2
     C                     MOVE FABTB3    PMBTB3
     C                     MOVE FABTB4    PMBTB4
     C                     MOVE FABTB5    PMBTB5
     C                     MOVE FABTB6    PMBTB6
      *                                                                   CEU004
      **  Set-up Settlement Ccy for Pay and Receive and IN Ccy for 72     CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE FASCCY    PMPSCY                          CEU004
     C                     MOVE FAICCY    PMIC72                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE FAPSCY    PMPSCY                                              CLE031
     C           FEPEXR    IFEQ 0                                                             CLE031
     C                     MOVE *BLANK    PMPEXR                                              CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD                                              CLE031
     C                     MOVE FEPEXR    ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZEDIT                                                         CLE031
     C                     MOVE ZFIELD    PMPEXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE FEPEXI    PMPEXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                   CEU004
     C                     ENDIF
      *
     C                     EXSR SRSHNM
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRINST  -  Initialise settlement fields on insert             *
      * Called by: SREXST - Format extended settlement fields         *
      * Calls    : SRSHNM - Move customer name to shortname           *
      *****************************************************************
     C           SRINST    BEGSR
      *
      ** Format receive settlement instructions, with details
      ** from the fee master file, if participant fee ind is blank
      *
     C           WPTFI     IFEQ *BLANK
     C                     Z-ADDRSTM      PMRSTM
     C                     MOVE RONS      PMRONS
     C                     MOVE RIBN      PARIBN
     C                     MOVE RIBA      PMRIBA
     C***********RSTM      IFEQ 5                                         155931
     C                     MOVE OSDB      PMROBR
     C***********          ENDIF                                          155931
     C********** ROBN      IFNE *ZEROS                                                        CSD027
     C           ROBN      IFNE *BLANKS                                                       CSD027
     C                     MOVE ROBN      PAROBN
     C                     ENDIF
     C********** ROCN      IFNE *ZEROS                                                        CSD027
     C           ROCN      IFNE *BLANKS                                                       CSD027
     C                     MOVE ROCN      PAROCN
     C                     ENDIF
      *                                                                   CEU004
      **  Set up Settlement Currency                                      CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE FESCCY    PMRSCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE FESCCY    PMRSCY                                              CLE031
     C           FEREXR    IFEQ 0                                                             CLE031
     C                     MOVE *BLANK    PMREXR                                              CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD                                              CLE031
     C                     MOVE FEREXR    ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZEDIT                                                         CLE031
     C                     MOVE ZFIELD    PMREXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE FEREXI    PMREXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *
      ** Format pay settlement instructions, with details from
      ** the fee master file, if participant fee ind is 'P'
      *
     C                     ELSE
      *
     C                     MOVE PSTM      PMPSTM
     C                     MOVE PONS      PMPONS
     C                     MOVE PIBN      PAPIBN
     C                     MOVE PIBA      PMPIBA
     C********** POBN      IFNE *ZEROS                                                        CSD027
     C           POBN      IFNE *BLANKS                                                       CSD027
     C                     MOVE POBN      PAPOBN
     C                     ENDIF
     C********** POCN      IFNE *ZEROS                                                        CSD027
     C           POCN      IFNE *BLANKS                                                       CSD027
     C                     MOVE POCN      PAPOCN
     C                     ENDIF
     C***********PSTM      IFEQ 5                               155931
     C                     MOVE OMDB      PMPOBR
     C***********          ENDIF                                155931
      *
     C                     MOVE CVMR      PMCVMR
     C                     MOVE RCRN      PARCRN
     C                     MOVE RCRA      PMRCRA
     C                     MOVE RVNO      PARVNO
     C                     MOVE AWBN      PAAWBN
     C                     MOVE AWBA      PMAWBA
     C                     MOVE BENN      PABENN
     C                     MOVE BENA      PMBENA
     C                     MOVE DTP1      PMDTP1
     C                     MOVE DTP2      PMDTP2
     C                     MOVE DTP3      PMDTP3
     C                     MOVE DTP4      PMDTP4
     C                     MOVE DCHG      PMDCHG
     C                     MOVE BTB1      PMBTB1
     C                     MOVE BTB2      PMBTB2
     C                     MOVE BTB3      PMBTB3
     C                     MOVE BTB4      PMBTB4
     C                     MOVE BTB5      PMBTB5
     C                     MOVE BTB6      PMBTB6
      *                                                                   CEU004
      **  Set up Settlement Currency and In Ccy for Field 72              CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE FESCCY    PMPSCY                          CEU004
     C                     MOVE FEICCY    PMIC72                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE FEPSCY    PMPSCY                                              CLE031
     C           FEPEXR    IFEQ 0                                                             CLE031
     C                     MOVE *BLANK    PMPEXR                                              CLE031
     C                     ELSE                                                               CLE031
     C                     MOVE *BLANKS   ZFIELD                                              CLE031
     C                     MOVE FEPEXR    ZFIELD                                              CLE031
     C                     Z-ADD8         ZADEC                                               CLE031
     C                     EXSR ZEDIT                                                         CLE031
     C                     MOVE ZFIELD    PMPEXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE FEPEXI    PMPEXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                   CEU004
     C                     ENDIF
      *
     C                     EXSR SRSHNM
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRBPEX  -  Format extended settlement fields for batch/play   *
      * Called by: SREXST - Format fields for extended settlement     *
      * Calls    : SRSHNM - Move customer name to shortname           *
      *****************************************************************
     C           SRBPEX    BEGSR
      *
      ** Format settlement fields from PC interface for batch mode
      *
     C           PMODE     IFEQ 'B'
      *
      ** ... receive settlement for participant fee = blank
      *
     C           WPTFI     IFEQ *BLANK
     C                     MOVE PRSTM     PMRSTM
     C           PRSTM     IFEQ *BLANKS                                                       219142
     C                     MOVEL'00'      PMRSTM                                              219142
     C                     ENDIF                                                              219142
     C                     MOVE PRONS     PMRONS
     C                     MOVE PRIBN     PARIBN
     C                     MOVE PRIBA     PMRIBA
     C********** PROBN     IFNE *ZEROS                                                        CSD027
     C           PROBN     IFNE *BLANKS                                                       CSD027
     C                     MOVE PROBN     PAROBN
     C                     ENDIF
     C********** PROCN     IFNE *ZEROS                                                        CSD027
     C           PROCN     IFNE *BLANKS                                                       CSD027
     C                     MOVE PROCN     PAROCN
     C                     ENDIF
     C                     MOVELPRONS     PMROBR
      *                                                                   CEU004
      **  Set-up Settlement Currency                                      CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE PSCCY     PMRSCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE PSCCY     PMRSCY                                              CLE031
     C                     MOVE PREXR     PMREXR                                              CLE031
     C           PREXR     IFNE *BLANKS                                                       CLE031
     C                     MOVE *BLANKS   PSCRF                                               CLE031
     C                     MOVE PREXR     PSCRF                                               CLE031
     C                     Z-ADD8         PNDEC                                               CLE031
     C                     Z-ADD5         PNDIG                                               CLE031
     C                     CALL 'ZALIGN'                                                      CLE031
     C                     PARM           PRTCD                                               CLE031
     C                     PARM           PSCRF                                               CLE031
     C                     PARM           PNDEC                                               CLE031
     C                     PARM           PNDIG                                               CLE031
     C                     PARM *BLANKS   PRVAL                                               CLE031
     C                     Z-ADD*ZEROS    WSEXR                                               CLE031
     C                     MOVELPRVAL     WSEXR                                               CLE031
     C           PRTCD     IFNE *BLANKS                                                       CLE031
     C           WSEXR     OREQ *ZEROS                                                        CLE031
     C                     MOVE *BLANKS   PMREXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE PREXI     PMREXI                                              CLE031
     C           PREXI     IFEQ 'N'                                                           CLE031
     C                     MOVE *BLANKS   PMREXI                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
      *
      ** ... pay settlement for participant fee = 'P'
      *
     C                     ELSE
     C                     MOVE PPSTM     PMPSTM
     C           PPSTM     IFEQ *BLANKS                                                       219142
     C                     MOVEL'00'      PMPSTM                                              219142
     C                     ENDIF                                                              219142
     C                     MOVE PPONS     PMPONS
     C                     MOVE PPIBN     PAPIBN
     C                     MOVE PPIBA     PMPIBA
     C********** PPOBN     IFNE *ZEROS                                                        CSD027
     C           PPOBN     IFNE *BLANKS                                                       CSD027
     C                     MOVE PPOBN     PAPOBN
     C                     ENDIF
     C********** PPOCN     IFNE *ZEROS                                                        CSD027
     C           PPOCN     IFNE *BLANKS                                                       CSD027
     C                     MOVE PPOCN     PAPOCN
     C                     ENDIF
      *
     C                     MOVE PCVMR     PMCVMR
     C                     MOVE PRCRN     PARCRN
     C                     MOVE PRCRA     PMRCRA
     C                     MOVE PRVNO     PARVNO
     C                     MOVE PAWBN     PAAWBN
     C                     MOVE PAWBA     PMAWBA
     C                     MOVE PBENN     PABENN
     C                     MOVE PBENA     PMBENA
     C                     MOVE PDTP1     PMDTP1
     C                     MOVE PDTP2     PMDTP2
     C                     MOVE PDTP3     PMDTP3
     C                     MOVE PDTP4     PMDTP4
     C                     MOVE PDCHG     PMDCHG
     C                     MOVE PBTB1     PMBTB1
     C                     MOVE PBTB2     PMBTB2
     C                     MOVE PBTB3     PMBTB3
     C                     MOVE PBTB4     PMBTB4
     C                     MOVE PBTB5     PMBTB5
     C                     MOVE PBTB6     PMBTB6
     C                     MOVELPPONS     PMPOBR
      *                                                                   CEU004
      **  Set-up Settlement Currency and IN Ccy for Field 72              CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE PSCCY     PMPSCY                          CEU004
     C                     MOVE PICCY     PMIC72                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE PPSCY     PMPSCY                                              CLE031
     C                     MOVE PPEXR     PMPEXR                                              CLE031
     C           PPEXR     IFNE *BLANKS                                                       CLE031
     C                     MOVE *BLANKS   PSCRF                                               CLE031
     C                     MOVE PPEXR     PSCRF                                               CLE031
     C                     Z-ADD8         PNDEC                                               CLE031
     C                     Z-ADD5         PNDIG                                               CLE031
     C                     CALL 'ZALIGN'                                                      CLE031
     C                     PARM           PRTCD                                               CLE031
     C                     PARM           PSCRF                                               CLE031
     C                     PARM           PNDEC                                               CLE031
     C                     PARM           PNDIG                                               CLE031
     C                     PARM *BLANKS   PRVAL                                               CLE031
     C                     Z-ADD*ZEROS    WSEXR  138                                          CLE031
     C                     MOVELPRVAL     WSEXR                                               CLE031
     C           PRTCD     IFNE *BLANKS                                                       CLE031
     C           WSEXR     OREQ *ZEROS                                                        CLE031
     C                     MOVE *BLANKS   PMPEXR                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     MOVE PPEXI     PMPEXI                                              CLE031
     C           PPEXI     IFEQ 'N'                                                           CLE031
     C                     MOVE *BLANKS   PMPEXI                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                   CEU004
     C                     ENDIF
      *
     C                     ELSE
      *
      ** Format fields from 'test harness' file for play mode
      *
      ** ... receive settlement for participant fee = blank
      *
     C           WPTFI     IFEQ *BLANK
     C                     MOVE S3RSTM    PMRSTM
     C                     MOVE S3RONS    PMRONS
     C                     MOVE S3RIBN    PARIBN
     C                     MOVE S3RIBA    PMRIBA
     C********** S3ROBN    IFNE *ZEROS                                                        CSD027
     C           S3ROBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE S3ROBN    PAROBN
     C                     ENDIF
     C********** S3ROCN    IFNE *ZEROS                                                        CSD027
     C           S3ROCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE S3ROCN    PAROCN
     C                     ENDIF
     C                     MOVELS3RONS    PMROBR
      *                                                                   CEU004
      **  Set-up Settlement Currency                                      CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE S3SCCY    PMRSCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE S3SCCY    PMRSCY                                              CLE031
     C                     MOVE S3REXR    PMREXR                                              CLE031
     C                     MOVE S3REXI    PMREXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *
      ** ... pay settlement for participant fee = 'P'
      *
     C                     ELSE
     C                     MOVE S3PSTM    PMPSTM
     C                     MOVE S3PONS    PMPONS
     C                     MOVE S3PIBN    PAPIBN
     C                     MOVE S3PIBA    PMPIBA
     C********** S3POBN    IFNE *ZEROS                                                        CSD027
     C           S3POBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE S3POBN    PAPOBN
     C                     ENDIF
     C********** S3POCN    IFNE *ZEROS                                                        CSD027
     C           S3POCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE S3POCN    PAPOCN
     C                     ENDIF
      *
     C                     MOVE S3CVMR    PMCVMR
     C                     MOVE S3RCRN    PARCRN
     C                     MOVE S3RCRA    PMRCRA
     C                     MOVE S3RVNO    PARVNO
     C                     MOVE S3AWBN    PAAWBN
     C                     MOVE S3AWBA    PMAWBA
     C                     MOVE S3BENN    PABENN
     C                     MOVE S3BENA    PMBENA
     C                     MOVE S3DTP1    PMDTP1
     C                     MOVE S3DTP2    PMDTP2
     C                     MOVE S3DTP3    PMDTP3
     C                     MOVE S3DTP4    PMDTP4
     C                     MOVE S3DCHG    PMDCHG
     C                     MOVE S3BTB1    PMBTB1
     C                     MOVE S3BTB2    PMBTB2
     C                     MOVE S3BTB3    PMBTB3
     C                     MOVE S3BTB4    PMBTB4
     C                     MOVE S3BTB5    PMBTB5
     C                     MOVE S3BTB6    PMBTB6
     C                     MOVELS3PONS    PMPOBR
      *                                                                   CEU004
      **  Set-up Settlement Currency and IN Ccy for Field 72              CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE S3SCCY    PMPSCY                          CEU004
     C                     MOVE S3ICCY    PMIC72                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE S3PSCY    PMPSCY                                              CLE031
     C                     MOVE S3PEXR    PMPEXR                                              CLE031
     C                     MOVE S3PEXI    PMPEXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                   CEU004
     C                     ENDIF
     C                     ENDIF
      *
     C                     EXSR SRSHNM
      *
      ** Set up settlement branch only for sett method 05
      *
     C           WPTFI     IFEQ *BLANK
     C           PMRSTM    IFNE 5
     C                     MOVE *BLANKS   PMROBR
     C                     ENDIF
     C                     ELSE
     C           PMPSTM    IFNE 5
     C                     MOVE *BLANKS   PMPOBR
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRSHNM  -  Move customer number to its shortname counterpart  *
      * Called by: SRMFSC - Move file values to settlement screen     *
      *            SRINST - Format settlement fields for insert       *
      *            SRBPEX - Format extended fields for batch/play     *
      * Calls    : None                                               *
      *****************************************************************
     C           SRSHNM    BEGSR
      *
      ** Counterparty pay instructions
     C                     MOVELPARIBN    PMRIBN
      *
      ** Receipt - ordering bank number
     C                     MOVELPAROBN    PMROBN
      *
      ** Receipt - ordering customer number
     C                     MOVELPAROCN    PMROCN
      *
      ** Pay - intermediary bank number
     C                     MOVELPAPIBN    PMPIBN
      *
      ** Pay - ordering bank number
     C                     MOVELPAPOBN    PMPOBN
      *
      ** Pay - ordering customer number
     C                     MOVELPAPOCN    PMPOCN
      *
      ** Receiver correspondent number
     C                     MOVELPARCRN    PMRCRN
      *
      ** Receiver number
     C                     MOVELPARVNO    PMRVNO
      *
      ** Counterparty receiver instructions
     C                     MOVELPAAWBN    PMAWBN
      *
      ** For account of instructions
     C                     MOVELPABENN    PMBENN
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRCHOL  -  Check if value date is a holiday                   *
      * Called by: SRDTL1 - Process detail screen                     *
      *            SRDTL2 - Extended settlement processing            *
      *            SR2410 - Check if value date is a holiday          *
      * Calls    : None                                               *
      *****************************************************************
     C           SRCHOL    BEGSR
      *
     C                     MOVE *BLANK    WNOST   1
      *                                                                                       CLE034
     C                     DO                                                                 CLE034
      *                                                                                       CLE034
      ** If switchable feature is on and Settlement Allocation                                CLE034
      ** is 'Y'                                                                               CLE034
      *                                                                                       CLE034
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C           SFSTAL    ANDEQ'Y'                                                           CLE034
     C           PNDET     IFEQ 'Y'                                                           CLE034
     C                     LEAVE                                                              CLE034
     C                     ENDIF                                                              CLE034
     C           PSNOS     IFEQ 'Y'                                                           CLE034
     C                     MOVE 'Y'       WNOST                                               CLE034
     C                     ENDIF                                                              CLE034
     C                     ENDIF                                                              CLE034
     C           CLE034    IFEQ 'N'                                                           CLE034
     C           CLE034    OREQ 'Y'                                                           CLE034
     C           SFSTAL    ANDNE'Y'                                                           CLE034
      *
      ** Determine if for settlements 01, 07 and 08, value date is
      ** a holiday in fee currency; or for settlement not 01, 07 nor
      ** 08, if value date is a holiday in local currency
      *
     C                     DO
      *
      ** Holiday checks are done only on non-zero settlements
      ** Proceed to updates if zero settlement
      *
     C           WPTFI     IFEQ *BLANK
     C           PMRSTM    ANDEQ*ZEROS
     C           WPTFI     OREQ 'P'
     C           PMPSTM    ANDEQ*ZEROS
     C                     LEAVE
     C                     ENDIF
      *
      ** Determine if settlement is through nostro
      *
     C           WPTFI     IFEQ *BLANK
     C           PMRSTM    IFEQ 1
     C           PMRSTM    OREQ 7
     C           PMRSTM    OREQ 8
     C                     MOVE 'Y'       WNOST
     C                     ENDIF
     C                     ELSE
     C           PMPSTM    IFEQ 1
     C           PMPSTM    OREQ 7
     C           PMPSTM    OREQ 8
     C                     MOVE 'Y'       WNOST
     C                     ENDIF
     C                     ENDIF
      *                                                                   CEU004
      **  IF CEU004 is swtiched on, save the value of settlement currency CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           WPTFI     IFEQ *BLANKS                                   CEU004
     C                     MOVE PMRSCY    WSCCY   3                       CEU004
     C                     ENDIF                                          CEU004
     C           WPTFI     IFEQ 'P'                                       CEU004
     C                     MOVE PMPSCY    WSCCY                           CEU004
     C                     ENDIF                                          CEU004
     C                     ENDIF                                          CEU004
     C                     ENDDO                                                              CLE034
      *                                                                                       CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
      *
      ** If settled through nostro, check against fee currency,
      ** otherwise, against local currency
      *
     C                     Z-ADDWVDAT     ZDAYNO
     C                     MOVE *BLANK    ZLOC
     C           WNOST     IFEQ 'Y'
     C                     MOVE SFCCY     ZCCY
      *                                                                   CEU004
      **  Setup Settlement Currency if CEU004 is switched on              CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           WSCCY     ANDNE*BLANKS                                   CEU004
     C                     MOVE WSCCY     ZCCY                            CEU004
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
     C                     ELSE
     C                     MOVE BJLCCY    ZCCY
     C                     ENDIF
      *
     C                     EXSR ZCHKH
      *
      ** If value date is a holiday in local or fee currency
      ** display detail screen to inform user
      *
     C           ZIND      IFEQ 'H'
     C           WWAR2     ANDEQ*BLANK
     C           WNOST     IFEQ 'Y'
     C                     MOVEL'LER0174' ZAMSID
      *                                                                   CEU004
      **  Generate Message ID if CEU004 is switched on                    CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C           WSCCY     ANDNE*BLANKS                                   CEU004
     C***********          MOVEL'LER0218' ZAMSID                                       CEU004 180573
     C                     MOVEL'LER0228' ZAMSID                                              180573
     C                     ENDIF                                          CEU004
      *                                                                   CEU004
     C                     ELSE
     C                     MOVEL'LER0175' ZAMSID
     C                     ENDIF
     C                     MOVE 'W'       WESEV
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN34
     C                     MOVE 'D1'      WFMT
     C                     MOVE *BLANK    WESEV
     C                     MOVE 'Y'       WWAR2
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** Proceed to updates if no error encountered
      *
     C           WWARN     IFEQ *BLANK
     C                     SELEC
     C           SACTN     WHEQ 'X'
     C           *INKN     ANDEQ'1'
     C                     MOVE 'D1'      WFMT
     C           SACTN     WHEQ 'I'
     C                     MOVE 'WR'      WFMT
     C                     OTHER
     C                     MOVE 'UP'      WFMT
     C                     ENDSL
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRINSR  -  Insert new fee adjustment/settlement               *
      * Called by: Main routine                                       *
      *            SRBTCH - Batch processing for batch/play modes     *
      *            SRSPRO - Process each subfile request              *
      * Calls    : SRMVST - Update settlement fields                  *
      *            SRRCRD - Write to 'test harness' file              *
      *            SRSHDW - Update shadow files                       *
      *            SRSWRI - Update Fees File                          *   CLE009
      *****************************************************************
     C           SRINSR    BEGSR
      *                                                                                       CSD015
      ** Check if Watch List Checking Engine needs to be called                               CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       WATCH   1                                           CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           CSD015
     C           CSC011    IFEQ 'N'                                                           CSD015
     C           CSC011    OREQ 'Y'                                                           CSD015
     C           LIBR      ANDEQS1MAIN                                                        CSD015
     C                     EXSR SRCHCK                                                        CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *
      ** Determine if record had been inserted by another user
      *
     C           PFTYP     IFEQ 'S'
     C           WKFES     CHAINLEFEEAL2            N71
     C                     ELSE
     C           WKFEE     CHAINLEFEEAL0            N71
     C                     ENDIF
      *
     C           *IN71     IFEQ '0'
     C                     MOVE 'D1'      WFMT
     C                     MOVEL'LER0071' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** Proceed with updates if no error, format LEFEEAD fields
      *
     C           WERRF     IFEQ *BLANK
     C                     CLEARLEFEEAD0
     C                     CLEARLEFEEAD2
     C                     EXSR ZTNLU1
      *
     C           PFTYP     IFEQ 'S'
     C                     MOVE 'S'       FARECI
     C                     MOVE STYPE     FATYPE
     C                     Z-ADDWFSET     FASADJ
     C                     MOVE '+'       FASIGN
     C                     Z-ADDWVDAT     FAVDAT
     C                     MOVE SFSTAL    FASTAL                                              CLE034
     C                     ELSE
     C                     MOVE 'A'       FARECI
     C                     MOVE SSIGN     FASIGN
     C                     Z-ADDWFADJ     FASADJ
     C                     ENDIF
      *
      ** Format fields common to both settlement and adjustment
      *
     C                     Z-ADDNATN      FATNLU
     C                     MOVE SACTN     FAACTN
     C                     MOVE SCNUM     FACNUM
     C                     MOVELSFACT     FAFACL
     C                     MOVE SFCNO     FAFACL
     C                     MOVE FEBRCA    FABRCA
     C/COPY WNCPYSRC,LEH00838
     C**********           Z-ADD*ZEROS    FALOAN                                              CLE148
     C                     MOVEL*BLANKS   FALOAN                                              CLE148
     C/COPY WNCPYSRC,LEH00839
     C                     MOVE SFSEQ     FAFSEQ
     C                     Z-ADDWSADD     FASADD
     C                     MOVE SFCCY     FAFCCY
     C           PMODE     IFEQ 'B'
     C                     MOVE PIUSR     FAIUSR
     C                     ELSE
     C                     MOVE USER      FAIUSR
     C                     ENDIF
      *
      ** Status is authorised if CLE002 is not installed or if
      ** authorisation of fee settlement/adjustment is not allowed
      ** Otherwise, it will just be complete
      ** Transactions in batch mode are always authorised
      *
     C           CLE002    IFEQ 'N'
     C           BPFSAU    OREQ 'N'
     C           PMODE     OREQ 'B'
     C                     MOVE 'A'       FASSTS
     C                     ELSE
     C                     MOVE 'C'       FASSTS
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C015
      *
     C           CLE004    IFEQ 'Y'
     C                     MOVE WPTFI     FAPTFI
     C                     ENDIF
     C           PMODE     IFEQ 'B'
     C                     MOVE PTREF     FAPCRF
     C                     MOVE PPCOB     FAPCOB
      *
      ** Mode is not 'B', set up transaction reference.                   146488
     C                     ELSE                                           146488
     C                     CALL 'AOBRCHR1'                                146488
     C                     PARM *BLANKS   @RTCD   7                       146488
     C                     PARM '*KEY   ' @OPTN   7                       146488
     C                     PARM FEBRCA    @BRCA   3                       146488
     C           SDBRCH    PARM SDBRCH    DSSDY                           146488
     C           @RTCD     IFNE *BLANKS                                   146488
     C           *LOCK     IN   LDA                                       146488
     C                     Z-ADD19        DBASE                           146488
     C                     MOVEL'SDBRCHPD'DBFILE                          146488
     C                     MOVELBRCA      DBKEY                           146488
     C                     MOVEL'LE2220'  DBPGM                           146488
     C                     OUT  LDA                                       146488
     C                     EXSR *PSSR                                     146488
     C                     ELSE                                           146488
     C                     MOVELA8MQSM    W#1ST3  3                       146488
     C********** *NAMVAR   DEFN           LEALLO                                       146488 CLE148
     C********** *LOCK     IN   LEALLO                                                 146488 CLE148
     C********** PCLAST    ADD  1         PCNEXT  80                                   146488 CLE148
     C                     CALL 'LEALLO'                                                      CLE148
     C                     PARM *BLANKS   PRTCD   7                                           CLE148
     C                     PARM 'Y'       PUPDT   1                                           CLE148
     C                     PARM *BLANKS   PCLAST                                              CLE148
     C                     PARM *BLANKS   PCNEXT  8                                           CLE148
     C                     MOVE PCNEXT    W1ST11 11                       146488
     C                     MOVELW#1ST3    W1ST11                          146488
     C                     MOVELW1ST11    FAPCRF                          146488
     C                     MOVE '0001'    FAPCRF                          146488
     C**********           Z-ADDPCNEXT    PCLAST                                       146488 CLE148
     C**********           OUT  LEALLO                                                 146488 CLE148
     C                     ENDIF                                          146488
     C                     ENDIF
      *
      ** Format extended settlement fields for non-internal
      ** participant fee settlement
      *
     C           PFTYP     IFEQ 'S'
     C           FAPTFI    ANDNE'I'
     C                     EXSR SRMVST
     C                     ENDIF
      *                                                                   CLE009
      *** If CLE009 is installed                                          CLE009
      *                                                                   CLE009
     C           CLE009    IFEQ 'Y'                                       CLE009
     C                     EXSR SRSWRI                                    CLE009
     C                     ENDIF                                          CLE009
      *
      ** Write to fee settlement/adjustment file, then update trailer
      *
     C           PFTYP     IFEQ 'S'
     C                     MOVEASTAMP,1   STMP             Default Timestamp                  CPK015
      *                                                                                       CSD015
      ** Call Watch List Checking Engine program                                              CSD015
      *                                                                                       CSD015
     C           WATCH     IFEQ 'Y'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     WRITELEFEEAD2               70
     C                     ELSE
     C                     MOVEASTAMP,1   STMP             Default Timestamp                  CPK015
      *                                                                                       CSD015
      ** Call Watch List Checking Engine program                                              CSD015
      *                                                                                       CSD015
     C           WATCH     IFEQ 'Y'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     WRITELEFEEAD0               70
     C                     ENDIF
      *
     C           1         CHAINLEFEEAZ              71
     C                     ADD  1         FANINT
     C                     ADD  1         FANORE
     C           *IN71     IFEQ '0'
     C                     UPDATLEFEEAZF               70
     C                     ELSE
     C                     MOVE 'Z'       FARECI
     C                     WRITELEFEEAZF               70
     C                     ENDIF
      *
      ** If in record mode, write to 'test harness' file
      *
     C           PMODE     IFEQ 'R'
     C                     EXSR SRRCRD
     C                     ENDIF
      *
      ** Update shadow files for non-write off fee settlements
      *
     C                     CLEARZ#BSTS
     C                     MOVELWFEEAD    Z#ASTS
     C                     EXSR SRSHDW
      *                                                                                       219066
      ** After LEFEEAD has been written to, need to update the                                219066
      ** settlement allocations table.                                                        219066
      *                                                                                       219066
     C           PFTYP     IFEQ 'S'                                                           219066
     C           CLE034    ANDEQ'Y'                                                           219066
     C           SACTN     ANDEQ'I'                                                           219066
     C           SFSTAL    ANDEQ'Y'                                                           219066
      *                                                                                       219066
     C                     MOVE *BLANKS   PFVDAT  5                                           219066
     C                     MOVE FAVDAT    PFVDAT                                              219066
     C                     MOVE FAFSEQ    PFASQ   2                                           219066
     C                     MOVE FAFACL    PFACL   5                                           219066
     C                     MOVE FACNUM    PCNUM   6                                           219066
      *                                                                                       219066
     C                     CALL 'AOSTALU0'                                                    219066
     C                     PARM PMODE     PRTCD                                               219066
     C                     PARM 'FSET  '  PWTYP                                               219066
     C                     PARM 'U'       PACTN   1                                           219066
     C                     PARM *BLANKS   PFLOAN  6                                           219066
     C                     PARM           PFVDAT                                              219066
     C                     PARM *BLANKS   PSEQN                                               219066
     C                     PARM           PCNUM                                               219066
     C                     PARM           PFACL                                               219066
     C                     PARM           PFASQ                                               219066
     C                     PARM           PTMST                                               219066
     C                     PARM           FAPCRF                                              219066
      *                                                                                       219066
     C                     ENDIF                                                              219066
      *
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C006
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRUPDR  -  Update existing fee adjustment/settlement          *
      * Called by: Main routine                                       *
      *            SRBTCH - Batch processing for batch/play modes     *
      *            SRSPRO - Subfile processing                        *
      * Calls    : SRMVST - Update settlement fields                  *
      *            SRRCRD - Write to 'test harness' file              *
      *            SRSHDW - Update shadow files                       *
      *            SRSWRI - Update Fees File                          *   CLE009
      *****************************************************************
     C           SRUPDR    BEGSR
      *
      ** Determine if record had been updated by another user
      *
     C           PFTYP     IFEQ 'S'
     C           WKFES     CHAINLEFEEAL2             71
     C                     ELSE
     C           WKFEE     CHAINLEFEEAL0             71
     C                     ENDIF
      *
     C           *IN71     IFEQ '1'
     C           FATNLU    ORNE WTNLU
     C                     MOVE 'D1'      WFMT
     C                     MOVEL'LER0071' ZAMSID
     C                     EXSR ZASNMS
     C           *IN71     IFEQ '0'
     C           PFTYP     IFEQ 'S'
     C                     EXCPTRELFE2
     C                     ELSE
     C                     EXCPTRELFE0
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *                                                                                       CSD015
      ** Check if Watch List Checking Engine program needs to be called                       CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       WATCH                                               CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           CSD015
     C           CSC011    IFEQ 'N'                                                           CSD015
     C           CSC011    OREQ 'Y'                                                           CSD015
     C           LIBR      ANDEQS1MAIN                                                        CSD015
     C                     EXSR SRCHCK                                                        CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *
      ** Proceed with updates if no error, format LEFEEAD fields
      *
     C           WERRF     IFEQ *BLANK
     C                     CLEARZ#BSTS
     C                     CLEARZ#ASTS
     C           SACTN     IFEQ 'A'                                                           201328
     C           FATYPE    ANDEQ'W'                                                           201328
     C                     Z-ADD0         FASADJ                                              201328
     C                     ENDIF                                                              201328
     C                     MOVELWFEEAD    Z#BSTS
     C                     EXSR ZTNLU1
     C                     Z-ADDNATN      FATNLU
     C                     MOVE SACTN     FAACTN
     C                     SELEC
      *
      ** Amend processing
      *
     C           SACTN     WHEQ 'A'
     C           PFTYP     IFEQ 'S'
     C                     MOVE STYPE     FATYPE
     C                     Z-ADDWFSET     FASADJ
     C           FAPTFI    IFNE 'I'
     C                     EXSR SRMVST
     C                     ENDIF
     C                     ELSE
     C                     MOVE SSIGN     FASIGN
     C                     Z-ADDWFADJ     FASADJ
     C                     ENDIF
     C           PMODE     IFEQ 'B'
     C                     MOVE PAUSR     FAAUSR
     C                     ELSE
     C                     MOVE USER      FAAUSR
     C                     ENDIF
     C           STYPE     IFEQ 'W'                                                           201328
     C                     Z-ADD0         FASADJ                                              201328
     C                     ENDIF                                                              201328
      *
      ** Status will be authorised if CLE002 is not installed
      ** or if authorisation of fee settlement/adjustment is not allowed
      ** Otherwise, it could be complete or requring re-authorisation
      ** Transactions in batch mode are always authorised
      *
     C           CLE002    IFEQ 'N'
     C           BPFSAU    OREQ 'N'
     C           PMODE     OREQ 'B'
     C                     MOVE 'A'       FASSTS
     C                     ELSE
     C           FASSTS    IFEQ 'A'
     C           FASSTS    OREQ 'R'                                       194509
     C                     MOVE 'R'       FASSTS
     C                     ELSE
     C                     MOVE 'C'       FASSTS
     C                     ENDIF
     C                     ENDIF
      *
      ** Authorisation processing
      *
     C           SACTN     WHEQ 'X'
     C                     MOVE 'A'       FASSTS
     C           PMODE     IFEQ 'B'
     C                     MOVE PXUSR     FAXUSR
     C                     ELSE
     C                     MOVE USER      FAXUSR
     C                     ENDIF
      *
      ** Deletion processing
      *
     C           SACTN     WHEQ 'D'
     C                     MOVE '*'       FARECI
     C***********          MOVE 'D'       FASSTS                          155772
     C                     MOVE 'A'       FASSTS                          155772
     C                     Z-ADD0         FASADJ                                              201328
     C                     ENDSL
      *
     C           PMODE     IFEQ 'B'
     C                     MOVE PTREF     FAPCRF
     C                     ENDIF
      *
      ** Update fee settlements/adjustments file,
      ** Then update trailer if not authorisation
      *
     C                     MOVELWFEEAD    Z#ASTS
      *                                                                   CLE009
      *** If CLE009 is installed                                          CLE009
      *                                                                   CLE009
     C           CLE009    IFEQ 'Y'                                       CLE009
     C                     EXSR SRSWRI                                    CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C           CLE034    IFEQ 'Y'                                                           CLE034
     C                     MOVE SFSTAL    FASTAL                                              CLE034
     C                     ENDIF                                                              CLE034
      *                                                                                       CLE034
     C           PFTYP     IFEQ 'S'
      *                                                                                       CSD015
      ** Call Watch List Checking Engine program                                              CSD015
      *                                                                                       CSD015
     C           WATCH     IFEQ 'Y'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     UPDATLEFEEAD2               70
     C                     ELSE
      *                                                                                       CSD015
      ** Call Watch List Checking Engine program                                              CSD015
      *                                                                                       CSD015
     C           WATCH     IFEQ 'Y'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     UPDATLEFEEAD0               70
     C                     ENDIF
      *
     C           SACTN     IFNE 'X'
     C           1         CHAINLEFEEAZ              71
     C                     SELEC
     C           SACTN     WHEQ 'A'
     C                     ADD  1         FANAMD
     C           SACTN     WHEQ 'D'
     C                     ADD  1         FANDEL
     C                     ENDSL
      *
     C           *IN71     IFEQ '0'
     C                     UPDATLEFEEAZF               70
     C                     ELSE
     C                     MOVE 'Z'       FARECI
     C                     WRITELEFEEAZF               70
     C                     ENDIF
     C                     ENDIF
      *
      ** If in record mode, write to 'test harness' file
      *
     C           PMODE     IFEQ 'R'
     C                     EXSR SRRCRD
     C                     ENDIF
      *
      ** Update shadow files if not authorisation of non-
      ** write off fee settlements
      *
     C                     EXSR SRSHDW
      *                                                                                       CLE034
      ** After LEFEEAD has been written to, need to update the                                CLE034
      ** settlement allocations table.                                                        CLE034
      *                                                                                       CLE034
     C           PFTYP     IFEQ 'S'                                                           CLE034
     C           CLE034    ANDEQ'Y'                                                           CLE034
     C           SACTN     ANDEQ'D'                                                           CLE034
     C           SFSTAL    ANDEQ'Y'                                                           CLE034
      *                                                                                       CLE034
     C                     MOVE *BLANKS   PFVDAT  5                                           CLE034
     C                     MOVE FAVDAT    PFVDAT                                              CLE034
     C                     MOVE FAFSEQ    PFASQ   2                                           CLE034
     C                     MOVE FAFACL    PFACL   5                                           CLE034
     C                     MOVE FACNUM    PCNUM   6                                           CLE034
      *                                                                                       CLE034
     C                     CALL 'AOSTALU0'                                                    CLE034
     C                     PARM PMODE     PRTCD                                               CLE034
     C                     PARM 'FSET  '  PWTYP                                               CLE034
     C                     PARM 'D'       PACTN   1                                           CLE034
     C                     PARM *BLANKS   PFLOAN  6                                           CLE034
     C                     PARM           PFVDAT                                              CLE034
     C                     PARM *BLANKS   PSEQN                                               CLE034
     C                     PARM           PCNUM                                               CLE034
     C                     PARM           PFACL                                               CLE034
     C                     PARM           PFASQ                                               CLE034
     C                     PARM           PTMST                                               CLE034
     C                     PARM           FAPCRF                                              CLE034
      *                                                                                       CLE034
     C                     ENDIF                                                              CLE034
      *
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C007
      *
     C                     ENDSR
     C/COPY WNCPYSRC,LE2220C016
      /EJECT                                                              CLE009
      *****************************************************************   CLE009
      * SRSWRI  -  Update Fees File                                   *   CLE009
      * Called by: SRINSR - Insert new fee settlement/adjustment      *   CLE009
      *            SRUPDR - Update existing fee settlement/adjustment *   CLE009
      * Calls    : None                                               *   CLE009
      *****************************************************************   CLE009
     C           SRSWRI    BEGSR                                          CLE009
      *                                                                   CLE009
      *** If the type is settlement                                       CLE009
      *                                                                   CLE009
     C           PFTYP     IFEQ 'S'                                       CLE009
      *                                                                   CLE009
      *** If action code is insert                                        CLE009
      *                                                                   CLE009
     C           SACTN     IFEQ 'I'                                       CLE009
     C                     MOVE *BLANKS   FASTTI                          CLE009
      *                                                                   CLE009
      *** If authorisations switchable feature is off,or authorisations   CLE009
      *** switchable feature is on and fee settlements authorisations     CLE009
      *** is not required                                                 CLE009
      *                                                                   CLE009
     C           CLE002    IFEQ 'N'                                       CLE009
     C           CLE002    OREQ 'Y'                                       CLE009
     C           BPFSAU    ANDEQ'N'                                       CLE009
     C                     MOVE *BLANKS   FASWRI                          CLE009
     C                     ELSE                                           CLE009
     C                     MOVE 'I'       FASWRI                          CLE009
     C                     ENDIF                                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
      *** If action code is amend and the settlement date bill/telex      CLE009
      *** indicator is 'Y' and swift message regeneration indicator is    CLE009
      *** not 'I' and not 'B'                                             CLE009
      *                                                                   CLE009
     C           SACTN     IFEQ 'A'                                       CLE009
     C           FASTTI    ANDEQ'Y'                                       CLE009
     C           FASWRI    ANDNE'I'                                       CLE009
     C           FASWRI    ANDNE'B'                                       CLE009
      *                                                                   CLE009
      *** If authorisations switchable feature is off,or authorisations   CLE009
      *** switchable feature is on and fee settlements authorisations     CLE009
      *** is not required                                                 CLE009
      *                                                                   CLE009
     C           CLE002    IFEQ 'N'                                       CLE009
     C           CLE002    OREQ 'Y'                                       CLE009
     C           BPFSAU    ANDEQ'N'                                       CLE009
     C                     MOVE 'A'       FASWRI                          CLE009
     C                     ELSE                                           CLE009
     C                     MOVE 'B'       FASWRI                          CLE009
     C                     ENDIF                                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
      *** If action code is delete and the settlement date bill/telex     CLE009
      *** indicator is 'Y'                                                CLE009
      *                                                                   CLE009
     C           SACTN     IFEQ 'D'                                       CLE009
     C           FASTTI    ANDEQ'Y'                                       CLE009
     C                     MOVE 'R'       FASWRI                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
      *** If action code is authorise                                     CLE009
      *                                                                   CLE009
     C           SACTN     IFEQ 'X'                                       CLE009
      *                                                                   CLE009
     C           FASWRI    IFEQ 'I'                                       CLE009
     C                     MOVE *BLANKS   FASWRI                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C           FASWRI    IFEQ 'B'                                       CLE009
     C                     MOVE 'A'       FASWRI                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C                     ENDIF                                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
      *** If the type is adjustment                                       CLE009
      *                                                                   CLE009
     C           PFTYP     IFEQ 'A'                                       CLE009
      *                                                                   CLE009
      *** If the fee is a confirmed fee                                   CLE009
      *                                                                   CLE009
     C           FEAUTO    IFEQ 'Y'                                       CLE009
     C           FEAUTO    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
     C           FEAUT2    OREQ 'C'                                                           CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                   CLE009
      *** If payment on is blank or start, and start pay/receive telex    CLE009
      *** indicator for fees is 'Y' or payment on is end and end pay/     CLE009
      *** receive telex indicator for fees is 'Y' or payment on is next   CLE009
      *** and next pay/receive telex indicator for fees is 'Y'            CLE009
      *                                                                   CLE009
     C           FEPYON    IFEQ *BLANKS                                   CLE009
     C           FESPTI    ANDEQ'Y'                                       CLE009
     C           FEPYON    OREQ 'S'                                       CLE009
     C           FESPTI    ANDEQ'Y'                                       CLE009
     C           FEPYON    OREQ 'E'                                       CLE009
     C           FEEPTI    ANDEQ'Y'                                       CLE009
     C           FEPYON    OREQ 'N'                                       CLE009
     C           FEPPTI    ANDEQ'Y'                                       CLE009
      *                                                                   CLE009
      *** If swift message regeneration indicator for fees is not 'I'     CLE009
      *** and not 'B' and not 'H'                                         CLE009
      *                                                                   CLE009
     C           FESWRI    IFNE 'I'                                       CLE009
     C           FESWRI    ANDNE'B'                                       CLE009
     C           FESWRI    ANDNE'H'                                       CLE009
      *                                                                   CLE009
     C                     MOVE *BLANKS   CHGIND  1                       CLE009
      *                                                                   CLE009
      *** If authorisations switchable feature is off,or authorisations   CLE009
      *** switchable feature is on and fee settlements authorisations     CLE009
      *** is not required                                                 CLE009
      *                                                                   CLE009
     C           CLE002    IFEQ 'N'                                       CLE009
     C           CLE002    OREQ 'Y'                                       CLE009
     C           BPFSAU    ANDEQ'N'                                       CLE009
      *                                                                   CLE009
      *** If action code is insert or amend                               CLE009
      *                                                                   CLE009
     C           SACTN     IFEQ 'I'                                       CLE009
     C           SACTN     OREQ 'A'                                       CLE009
     C                     MOVE 'Y'       CHGIND                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C                     ELSE                                           CLE009
      *                                                                   CLE009
      *** If action code is authorise                                     CLE009
      *                                                                   CLE009
     C           SACTN     IFEQ 'X'                                       CLE009
     C                     MOVE 'Y'       CHGIND                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
      *** If action code is delete                                        CLE009
      *                                                                   CLE009
     C           SACTN     IFEQ 'D'                                       CLE009
     C                     MOVE 'Y'       CHGIND                          CLE009
     C                     ENDIF                                          CLE009
      *                                                                   CLE009
     C           CHGIND    IFEQ 'Y'                                       CLE009
     C           WKFEE     CHAINLEFEEDL1             71                                       205912
     C                     MOVE 'A'       FELCHT                          CLE009
     C                     Z-ADDBJRDNB    FELCHD                          CLE009
     C                     MOVE 'A'       FESWRI                          CLE009
      *                                                                   CLE009
      *** Update fees file                                                CLE009
      *                                                                   CLE009
     C                     UPDATLEFEEDF                                   CLE009
     C                     ENDIF                                          CLE009
     C                     ENDIF                                          CLE009
     C                     ENDIF                                          CLE009
     C                     ENDIF                                          CLE009
     C                     ENDIF                                          CLE009
     C                     ENDSR                                          CLE009
      /EJECT
      *****************************************************************
      * SRMVST  -  Update settlement fields                           *
      * Called by: SRINSR - Insert new fee settlement/adjustment      *
      *            SRUPDR - Update existing fee settlement/adjustment *
      * Calls    : None                                               *
      *****************************************************************
     C           SRMVST    BEGSR
      *
      ** Update receive settlement details for blank participant fee
      *
     C           WPTFI     IFEQ *BLANK
      *
     C                     MOVE PMRSTM    FAMETH
     C                     MOVE PMRONS    FAOURS
     C                     MOVE PARIBN    FATHER
     C                     MOVE PMROBR    FAOSBR
      *
     C                     MOVE PMROBR    FAOSDB
     C                     MOVE PMRSTM    FARSTM
     C                     MOVE PMRONS    FARONS
     C                     MOVE PARIBN    FARIBN
     C                     MOVE PMRIBA    FARIBA
     C                     MOVE PAROBN    FAROBN
     C                     MOVE PAROCN    FAROCN
      *
      ** Update pay settlement details for participant fee 'P'
      *
     C                     ELSE
      *
     C                     MOVE PMPSTM    FAMETH
     C                     MOVE PMPONS    FAOURS
     C                     MOVE PAPIBN    FATHER
     C                     MOVE PMPOBR    FAOSBR
      *
     C                     MOVE PMPOBR    FAOMDB
     C                     MOVE PMPSTM    FAPSTM
     C                     MOVE PMPONS    FAPONS
     C                     MOVE PAPIBN    FAPIBN
     C                     MOVE PMPIBA    FAPIBA
     C                     MOVE PAPOBN    FAPOBN
     C                     MOVE PAPOCN    FAPOCN
     C                     MOVE PARCRN    FARCRN
     C                     MOVE PMRCRA    FARCRA
     C                     MOVE PMRVNO    FARVNO
     C                     MOVE PAAWBN    FAAWBN
     C                     MOVE PMAWBA    FAAWBA
     C                     MOVE PABENN    FABENN
     C                     MOVE PMBENA    FABENA
     C                     MOVE PMDTP1    FADTP1
     C                     MOVE PMDTP2    FADTP2
     C                     MOVE PMDTP3    FADTP3
     C                     MOVE PMDTP4    FADTP4
     C                     MOVE PMDCHG    FADCHG
     C                     MOVE PMBTB1    FABTB1
     C                     MOVE PMBTB2    FABTB2
     C                     MOVE PMBTB3    FABTB3
     C                     MOVE PMBTB4    FABTB4
     C                     MOVE PMBTB5    FABTB5
     C                     MOVE PMBTB6    FABTB6
     C                     MOVE PMCVMR    FACVMR
     C                     ENDIF
      *                                                                   CEU004
      **  Set-up Settlement Ccy and IN Ccy for Field 72                   CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE WSCCY     FASCCY                          CEU004
     C                     MOVE PMIC72    FAICCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C           WPTFI     IFEQ *BLANK                                                        CLE031
     C                     Z-ADD0         WSEXR0 130                                          CLE031
     C                     Z-ADD0         WSEXR8 138                                          CLE031
     C                     MOVE PMRSCY    FASCCY                                              CLE031
     C                     MOVE PMREXI    FAREXI                                              CLE031
     C                     MOVE *BLANK    PSCRF                                               CLE031
     C                     MOVE PMREXR    PSCRF                                               CLE031
     C                     Z-ADD8         PNDEC                                               CLE031
     C                     Z-ADD5         PNDIG                                               CLE031
     C                     CALL 'ZALIGN'                                                      CLE031
     C                     PARM *BLANK    PRTCD                                               CLE031
     C                     PARM           PSCRF                                               CLE031
     C                     PARM           PNDEC                                               CLE031
     C                     PARM           PNDIG                                               CLE031
     C                     PARM *BLANKS   PRVAL                                               CLE031
      *                                                                                       CLE031
     C           PRTCD     IFEQ *BLANK                                                        CLE031
     C                     MOVE PRVAL     WSEXR0                                              CLE031
     C           WSEXR0    DIV  100000000 WSEXR8                                              CLE031
     C                     Z-ADDWSEXR8    FAREXR                                              CLE031
     C                     ELSE                                                               CLE031
     C           *LOCK     IN   LDA                                                           CLE031
     C                     MOVEL'ZALIGN  'DBFILE                                              CLE031
     C                     Z-ADD30        DBASE                                               CLE031
     C                     MOVELPSCRF     DBKEY                                               CLE031
     C                     OUT  LDA                                                           CLE031
     C                     EXSR *PSSR                                                         CLE031
     C                     ENDIF                                                              CLE031
      *                                                                                       CLE031
     C                     ELSE                                                               CLE031
      *                                                                                       CLE031
     C                     Z-ADD0         WSEXR0                                              CLE031
     C                     Z-ADD0         WSEXR8                                              CLE031
     C                     MOVE PMPSCY    FAPSCY                                              CLE031
     C                     MOVE PMPEXI    FAPEXI                                              CLE031
     C                     MOVE *BLANK    PSCRF                                               CLE031
     C                     MOVE PMPEXR    PSCRF                                               CLE031
     C                     Z-ADD8         PNDEC                                               CLE031
     C                     Z-ADD5         PNDIG                                               CLE031
     C                     CALL 'ZALIGN'                                                      CLE031
     C                     PARM *BLANK    PRTCD                                               CLE031
     C                     PARM           PSCRF                                               CLE031
     C                     PARM           PNDEC                                               CLE031
     C                     PARM           PNDIG                                               CLE031
     C                     PARM *BLANKS   PRVAL                                               CLE031
      *                                                                                       CLE031
     C           PRTCD     IFEQ *BLANK                                                        CLE031
     C                     MOVE PRVAL     WSEXR0                                              CLE031
     C           WSEXR0    DIV  100000000 WSEXR8                                              CLE031
     C                     Z-ADDWSEXR8    FAPEXR                                              CLE031
     C                     ELSE                                                               CLE031
     C           *LOCK     IN   LDA                                                           CLE031
     C                     MOVEL'ZALIGN  'DBFILE                                              CLE031
     C                     Z-ADD31        DBASE                                               CLE031
     C                     MOVELPSCRF     DBKEY                                               CLE031
     C                     OUT  LDA                                                           CLE031
     C                     EXSR *PSSR                                                         CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRRCRD  -  Write to test harness file when in record mode     *
      * Called by: SRINSR - Insert new fee settlement/adjustment      *
      *            SRUPDR - Update existing fee settlement/adjustment *
      * Calls    : None                                               *
      *****************************************************************
     C           SRRCRD    BEGSR
      *
     C                     CLEARLE2220D0
      *
      ** Format header
      *
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     WDATE
     C                     MOVE WDAT1     WTDT1
     C                     MOVE WDAT2     WTDT2
     C                     MOVE WDAT3     WTDT3
     C                     MOVE WTDAT     DTST
     C                     TIME           WTIME
     C                     MOVE WTIM1     WTTM1
     C                     MOVE WTIM2     WTTM2
     C                     MOVE WTIM3     WTTM3
     C                     MOVE WTTIM     TMST
      *
      ** Write details for insert and amend only
      ** Authorisation and deletion need key fields and action only
      *
     C                     MOVE SCNUM     S1CNUM
     C                     MOVE SFACT     S1FACT
     C                     MOVE SFCNO     S1FCNO
     C                     MOVE SFSEQ     S1FSEQ
     C                     MOVE SVDAT     S1VDAT
     C                     MOVE SACTN     S1ACTN
     C/COPY WNCPYSRC,LEH00840
      *
     C           SACTN     IFEQ 'I'
     C           SACTN     OREQ 'A'
     C                     MOVE SFADJ     S2FADJ
     C                     MOVE SSIGN     S2SIGN
     C                     MOVE SFSET     S2FSET
     C                     MOVE STYPE     S2TYPE
      *
      ** Format settlement fields for non-internal participant fees
      *
     C           PFTYP     IFEQ 'S'
     C           WPTFI     ANDNE'I'
      *
     C           WPTFI     IFEQ *BLANK
     C                     MOVE FARSTM    S3RSTM
     C                     MOVE FARONS    S3RONS
     C                     MOVE FARIBN    S3RIBN
     C                     MOVE FARIBA    S3RIBA
     C********** FAROBN    IFNE *ZEROS                                                        CSD027
     C           FAROBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAROBN    S3ROBN
     C                     ENDIF
     C********** FAROCN    IFNE *ZEROS                                                        CSD027
     C           FAROCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAROCN    S3ROCN
     C                     ENDIF
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE FASCCY    S3SCCY                                              CLE031
     C                     MOVE FAREXR    S3REXR                                              CLE031
     C                     MOVE FAREXI    S3REXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *
     C                     ELSE
     C                     MOVE FAPSTM    S3PSTM
     C                     MOVE FAPONS    S3PONS
     C                     MOVE FAPIBN    S3PIBN
     C                     MOVE FAPIBA    S3PIBA
     C********** FAPOBN    IFNE *ZEROS                                                        CSD027
     C           FAPOBN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAPOBN    S3POBN
     C                     ENDIF
     C********** FAPOCN    IFNE *ZEROS                                                        CSD027
     C           FAPOCN    IFNE *BLANKS                                                       CSD027
     C                     MOVE FAPOCN    S3POCN
     C                     ENDIF
     C                     MOVE FARCRN    S3RCRN
     C                     MOVE FARCRA    S3RCRA
     C                     MOVE FARVNO    S3RVNO
     C                     MOVE FAAWBN    S3AWBN
     C                     MOVE FAAWBA    S3AWBA
     C                     MOVE FABENN    S3BENN
     C                     MOVE FABENA    S3BENA
     C                     MOVE FADTP1    S3DTP1
     C                     MOVE FADTP2    S3DTP2
     C                     MOVE FADTP3    S3DTP3
     C                     MOVE FADTP4    S3DTP4
     C                     MOVE FADCHG    S3DCHG
     C                     MOVE FABTB1    S3BTB1
     C                     MOVE FABTB2    S3BTB2
     C                     MOVE FABTB3    S3BTB3
     C                     MOVE FABTB4    S3BTB4
     C                     MOVE FABTB5    S3BTB5
     C                     MOVE FABTB6    S3BTB6
     C                     MOVE FACVMR    S3CVMR
     C                     ENDIF
      *                                                                   CEU004
      **  Format Settlement Currency and IN Ccy for Field 72              CEU004
      *                                                                   CEU004
     C           CEU004    IFEQ 'Y'                                       CEU004
     C                     MOVE FASCCY    S3SCCY                          CEU004
     C                     MOVE FAICCY    S3ICCY                          CEU004
     C                     ENDIF                                          CEU004
      *                                                                                       CLE031
     C           CLE031    IFEQ 'Y'                                                           CLE031
     C                     MOVE FAPSCY    S3SCCY                                              CLE031
     C                     MOVE FAPEXR    S3PEXR                                              CLE031
     C                     MOVE FAPEXI    S3PEXI                                              CLE031
     C                     ENDIF                                                              CLE031
      *                                                                   CEU004
     C                     ENDIF
      *
     C                     SELEC
     C           SACTN     WHEQ 'I'
     C                     MOVE USER      SFIUSR
     C           SACTN     WHEQ 'A'
     C                     MOVE USER      SFAUSR
     C           SACTN     WHEQ 'X'
     C                     MOVE USER      SFXUSR
     C                     ENDSL
      *
     C                     ENDIF
      *
      ** Write to test harness file
      *
     C                     WRITELE2220D0               71
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRSHDW  -  Update shadow files                                *
      * Called by: SRINSR - Insert new fee settlement/adjustment      *
      *            SRSPRO - Update existing fee settlement/adjustment *
      * Calls    : SRCMTX - Commit file updates                       *
      *****************************************************************
     C           SRSHDW    BEGSR
      *
      ** Do on-line updates to PRONO, MEMOS, OLPOS and RSACMTPD
      ** for non-write off fee settlements, not in authorise mode
      *
     C           SACTN     IFNE 'X'
     C           PFTYP     ANDEQ'S'
     C           STYPE     ANDNE'W'
     C           SACTN     OREQ 'A'                                                           201328
     C           STYPE     ANDEQ'W'                                                           201328
     C           PFTYP     ANDEQ'S'                                                           201328
      *                                                                   134284
      *  Suppress rollback in batch mode                                  134284
      *                                                                   134284
     C           PMODE     IFEQ 'B'                                       134284
     C                     MOVE '*LEBTCH' PRTCD                           134284
     C                     ELSE                                           134284
     C                     MOVE *BLANKS   PRTCD                           134284
     C                     ENDIF                                          134284
      *
     C                     CALL 'AOOUFAU0'
     C***********          PARM *BLANKS   PRTCD                           155772
     C                     PARM           PRTCD                           155772
     C                     PARM           Z#BSTS
     C                     PARM           Z#ASTS
     C                     PARM           Z#WSTS
      *
     C           PRTCD     IFEQ '*ERROR*'
     C                     EXSR *PSSR
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C011
     C                     ENDIF
     C/COPY WNCPYSRC,LE2220C012
      *
      ** Commit updates if not in batch mode
      *
     C           PMODE     IFNE 'B'
     C                     EXSR SRCMTX
     C                     ENDIF
      *
      ** Return to initial or subfile screen
      *
     C                     MOVE WWRTRN    WFMT
     C           *IN24     IFEQ '1'
     C                     MOVE 'S0'      WFMT
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRCMTX  -  Commit file updates                                *
      * Called by: SRSHDW - Update shadow files                       *
      * Calls    : None                                               *
      *****************************************************************
     C           SRCMTX    BEGSR
      *
     C                     Z-ADDNATN      WCNATN
     C                     MOVE 'LE'      WCMDID
     C                     MOVEL'LE2220'  WCPGMN
     C                     MOVE WSID      WCWSID
     C                     TIME           WCTIME
     C                     MOVE SACTN     WCACTN
     C                     MOVE USER      WCUSER
     C                     MOVE SCRN      WCSCRN
      *
     C                     COMIT
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * CLEAR   -  Clears the message queue                           *
      * Called by: All validation subroutines                         *
      * Calls    : Y2CLMSC                                            *
      *****************************************************************
     C           CLEAR     BEGSR
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
     C                     MOVE *BLANK    WERRF   1
     C                     MOVE *BLANK    WWARN   1
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRTEXT  -  Set up text from message file                      *
      * Called by: All subroutines setting of texts                   *
      * Calls    : None                                               *
      *****************************************************************
     C           SRTEXT    BEGSR
      *
     C                     CALL 'Y2RVMGC'
     C                     PARM *BLANKS   PRTCD
     C                     PARM           ZAMSID           Message Id.
     C                     PARM           ZAMSGF           Message file.
     C                     PARM           ZAMSDA           Message data.
     C                     PARM           ZAMSTX           Messge text
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *  ZASNMS - Sends messages to the program's message queue       *
      *  Called by: Almost all screens with validation                *
      *  Calls    : SRBERR - Set up batch error details               *
      *****************************************************************
     C           ZASNMS    BEGSR
      *
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message Id.
     C                     PARM           ZAMSGF 10        Message file.
     C                     PARM           ZAMSDA132        Message data.
     C                     PARM           ZAMSTP  7        Message type.
     C           WESEV     IFEQ *BLANK
     C                     MOVE 'Y'       WERRF
     C                     ELSE
     C                     MOVE 'Y'       WWARN
     C                     ENDIF
      *
     C           PMODE     IFEQ 'P'
     C           PMODE     OREQ 'B'
     C                     EXSR SRBERR
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRBERR  -  Set up batch error details                         *
      * Called by: ZASNMS - Sends messages to the program msgq        *
      * Calls    : None                                               *
      *****************************************************************
     C           SRBERR    BEGSR
      *
     C                     CALL 'Y2RVMGC'
     C                     PARM           PRTCD
     C                     PARM           ZAMSID           Message Id.
     C                     PARM           ZAMSGF           Message file.
     C                     PARM           ZAMSDA           Message data.
     C                     PARM           ZAMSTX132        Messge text
      *
     C           WESEV     IFEQ *BLANK
     C                     MOVE 'E'       WESEV
     C                     ENDIF
      *
      ** Set up return message fields
      *
     C           PMODE     IFEQ 'B'
     C                     MOVE WESEV     PRMSV
     C                     MOVELZAMSID    PRMID
     C                     MOVELZAMSTX    PRMTX
     C                     ELSE
     C                     MOVE WESEV     RMSV
     C                     MOVELZAMSID    RMID
     C                     MOVELZAMSTX    RMTX
     C                     ENDIF
      *
      ** If a fatal error occurred, end processing
      *
     C           WESEV     IFEQ 'E'
     C                     DUMP
      *
     C           PMODE     IFEQ 'P'
     C                     UPDATLE2220D0               71
     C                     ROLBK
     C                     ELSE
     C***********          ROLBK                                    135446
     C           *LOCK     IN   LDA
     C                     MOVEL'LERMSGF 'DBFILE           ************
     C                     Z-ADD10        DBASE            * DBERR 10 *
     C                     MOVELZAMSID    DBKEY            ************
     C                     MOVELZAMSTX    DBTXT
     C                     OUT  LDA
     C                     ENDIF
      *
     C***********          MOVE '1'       *INU7                                               219142
     C***********          MOVE '1'       *INU8                                               219142
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
     C********************************************************************140611
     C*                                                                   140611
     C*  AVCALC -- Calculation of fees based on average balances          140611
     C*                                                                   140611
     C*  CALLED FROM: Main Processing                                     140611
     C*                                                                   140611
     C*  CALLS: NOTHING                                                   140611
     C*                                                                   140611
     C********************************************************************140611
     C           AVCALC    BEGSR                                          140611
      *                                                                   140611
     C/COPY WNCPYSRC,LEH00841
      * Determine whether it is a facility record with original entry     140611
      * date not equal system date.                                       140611
      * ie. if facility record with original entry date not equal         140611
      *     system date then set on 43, otherwise set off 43.             140611
     C                     SETOF                     43                   140611
      *                                                                   140611
     C                     MOVE FEBRCA    WUBRCA                          140611
     C**********           Z-ADDFECNUM    WUCNUM                                       140611 CSD027
     C                     MOVE FECNUM    WUCNUM                                              CSD027
     C                     Z-ADDFEFACL    WUFREF                          140611
     C***********          DUMP                                    140611 146488
     C           KFCLTY    CHAINFCLTYFMF             44                   140611
     C           *IN44     IFEQ *ON                                       140611
     C           *LOCK     IN   LDA                                       140611
     C                     MOVEL'FCLTYL1' DBFILE    P                     140611
     C                     MOVEL'LE2220'  DBPGM     P                     140611
     C                     MOVELWUKEY     DBKEY     P      ************   140611
     C                     Z-ADD012       DBASE            * DBERR 12 *   140611
     C                     OUT  LDA                        ************   140611
     C                     EXSR *PSSR                                     140611
     C                     ELSE                                           140611
     C           ORED      IFNE AGRDNB                                    140611
     C                     SETON                     43                   140611
     C                     ENDIF                                          140611
     C                     ENDIF                                          140611
     C*                                                                   140611
     C** Obtain original facility details from facility history header.   140611
     C*                                                                   140611
     C           *IN43     IFEQ *ON                                       140611
     C           FACKEY    CHAINFACHISH              45                   140611
     C*                                                                   140611
     C           *IN45     IFEQ '1'                                       140611
     C           *LOCK     IN   LDA                                       140611
     C                     MOVEL'LER115'  DBPGM                           140611
     C                     MOVELFECNUM    DBKEY                           140611
     C                     MOVE FEFACL    DBKEY                           140611
     C                     MOVEL'FACHISH' DBFILE           ************   140611
     C                     Z-ADD17        DBASE            * DBERR 17 *   140611
     C                     OUT  LDA                        ************   140611
     C                     EXSR *PSSR                                     140611
     C                     END                                            140611
     C                     ENDIF                                          140611
     C*                                                                   140611
     C                     Z-ADD0         WAMT   130                      140611
     C                     Z-ADD0         WPCT    63                      140611
     C*                                                                   140611
     C***  Set up Start and End dates                                     140611
     C*                                                                   140611
     C                     Z-ADDFELPDT    STDATE  50     46               140611
     C   46                Z-ADDFEPSTD    STDATE                          140611
     C                     Z-ADDBJRDNB    ENDATE  50                      140611
     C           FEPEND    IFLE BJRDNB                                    140611
     C                     Z-ADDFEPEND    ENDATE                          140611
     C                     END                                            140611
     C*                                                                   140611
     C***  For Actual amount fees, need to accrue for today to add to     140611
     C***  accrued to date amount on file.                                140611
     C*                                                                   140611
     C           BJRDNB    IFNE FEPEND                                    140611
     C           BJRDNB    ANDNEFELPDT                                    140611
     C           FECALT    IFEQ '04'                                      140611
     C           FECALT    OREQ '05'                                      140611
     C           FECALT    OREQ '06'                                      140611
     C           FECALT    OREQ '14'                                      140611
     C           FECALT    OREQ '15'                                      140611
     C           FECALT    OREQ '16'                                      140611
     C           FECALT    OREQ '22'                                      140611
     C                     Z-ADDFELADT    STDATE                          140611
     C           STDATE    IFEQ 0                                         140611
     C                     Z-ADDFEPSTD    STDATE                          140611
     C                     END                                            140611
     C                     END                                            140611
     C                     END                                            140611
     C*                                                                   140611
     C** Obtain number of days to use.                                    140611
     C*                                                                   140611
     C********** ENDATE    SUB  STDATE    WDAYS   50               140611 CLE013
     C                     Z-ADDSTDATE    ZZBEG                           CLE013
     C                     Z-ADDENDATE    ZZEND                           CLE013
     C                     MOVE FECALC    ZZCALC                          CLE013
     C                     EXSR ZINTDY                                    CLE013
     C                     Z-ADDZZINDY    WDAYS   50                      CLE013
     C*                                                                   140611
     C** Get starting amount from facility history file                   140611
     C*                                                                   140611
     C**********           Z-ADD*ZERO     FACNUM                                       140611 CSD027
     C                     MOVE *BLANKS   FACNUM                                              CSD027
     C                     Z-ADD*ZERO     FAFCTY                          140611
     C                     Z-ADD*ZERO     FADATE                          140611
     C                     Z-ADD*ZERO     FAFSEQ                          140611
     C                     Z-ADD*ZERO     FATSEQ                                              200289
     C           HSAKY1    SETGTFACHSAL1             47                   140611
     C                     READPFACHSAL1                 45               140611
     C           FECNUM    IFEQ FACNUM                                    140611
     C           FEFACL    ANDEQFAFCTY                                    140611
     C********** STDATE    ANDEQFADATE                                    140611              204351
     C********** STFSEQ    ANDEQFAFSEQ                                                 140611 200289
     C********** STFSEQ    ANDEQFATSEQ                                                 200289 204351
     C*                                                                   140611
     C** Set up current facility amount from file.                        140611
     C*                                                                   140611
     C** Set up amount for accrual according to calculation type.         140611
     C** Calculation types 01 to 06 use available facility amount,        140611
     C** types 11 to 16 use outstanding facility amount and               140611
     C** types 21 and 22 use the current facility amount.                 140611
     C*                                                                   140611
     C           FECALT    IFEQ '01'                                      140611
     C           FECALT    OREQ '02'                                      140611
     C           FECALT    OREQ '03'                                      140611
     C           FECALT    OREQ '04'                                      140611
     C           FECALT    OREQ '05'                                      140611
     C           FECALT    OREQ '06'                                      140611
     C           FAUNDR    IFGE 0                                         140611
     C                     Z-ADDFAUNDR    AAMT   130                      140611
     C                     ELSE                                           140611
     C                     Z-ADD0         AAMT                            140611
     C                     END                                            140611
     C                     ELSE                                           140611
     C           FECALT    IFEQ '11'                                      140611
     C           FECALT    OREQ '12'                                      140611
     C           FECALT    OREQ '13'                                      140611
     C           FECALT    OREQ '14'                                      140611
     C           FECALT    OREQ '15'                                      140611
     C           FECALT    OREQ '16'                                      140611
     C                     Z-ADDFADRAM    AAMT                            140611
     C                     ELSE                                           140611
     C           FECALT    IFEQ '21'                                      140611
     C           FECALT    OREQ '22'                                      140611
     C                     Z-ADDFACFAM    AAMT                            140611
     C                     END                                            140611
     C                     END                                            140611
     C                     END                                            140611
     C                     ELSE                                           140611
     C                     Z-ADDFAMT      AAMT                            140611
     C                     ENDIF                                          140611
     C*                                                                   140611
     C** Initialise work fee field.                                       140611
     C*                                                                   140611
     C                     Z-ADD0         WFEE   130                      140611
     C                     Z-ADD0         WTOT                                                204351
     C                     MOVE '0'       *IN19   1                                           204351
     C*                                                                   140611
     C** Read file until date read is greater than date of end of         140611
     C** this accrual period.                                             140611
     C** NDAYS is the number of days in this accrual.                     140611
     C*                                                                   140611
     C                     MOVE '0'       *IN48                           140611
     C           *IN48     DOWEQ'0'                                       140611
     C           HSAKY2    READEFACHSAL1                 48               140611
     C*                                                                   140611
     C           *IN48     IFEQ '1'                                       140611
     C           FADATE    ORGT ENDATE                                    140611
     C                     Z-ADDENDATE    FADATE                          140611
     C                     MOVE '1'       *IN48                           140611
     C                     END                                            140611
     C*                                                                   140611
     C********** FADATE    SUB  STDATE    NDAYS   50               140611 CLE013
     C                     Z-ADDSTDATE    ZZBEG                           CLE013
     C                     Z-ADDFADATE    ZZEND                           CLE013
     C                     MOVE FECALC    ZZCALC                          CLE013
     C                     EXSR ZINTDY                                    CLE013
     C                     Z-ADDZZINDY    NDAYS   50                      CLE013
     C*                                                                   140611
     C           NDAYS     IFGT 0                                         140611
     C*                                                                   140611
     C** Average amount used (only does accrual once)                     140611
     C*                                                                   140611
      *                                                                                       204351
      ** limit the processing for fees based on average amount                                204351
      *                                                                                       204351
     C           FECALT    IFEQ '01'                                                          204351
     C           FECALT    OREQ '02'                                                          204351
     C           FECALT    OREQ '03'                                                          204351
     C           FECALT    OREQ '11'                                                          204351
     C           FECALT    OREQ '12'                                                          204351
     C           FECALT    OREQ '13'                                                          204351
     C           FECALT    OREQ '21'                                                          204351
     C                     MULT NDAYS     AAMT                            140611
     C                     DIV  WDAYS     AAMT      H                     140611
     C                     ADD  AAMT      WAMT                            140611
     C                     ELSE                                                               204351
     C                     Z-ADDAAMT      WAMT                                                204351
     C                     ENDIF                                                              204351
     C                     Z-ADDFADATE    STDATE                          140611
     C                     END                                            140611
     C*                                                                   140611
     C** Reset amount to accrue - comes from next record on amounts       140611
     C** file.                                                            140611
     C*                                                                   140611
     C           FECALT    IFEQ '01'                                      140611
     C           FECALT    OREQ '02'                                      140611
     C           FECALT    OREQ '03'                                      140611
     C           FECALT    OREQ '04'                                                          204351
     C           FECALT    OREQ '05'                                                          204351
     C           FECALT    OREQ '06'                                                          204351
     C           FAUNDR    IFGE 0                                         140611
     C                     Z-ADDFAUNDR    AAMT                            140611
     C                     ELSE                                           140611
     C                     Z-ADD0         AAMT                            140611
     C                     END                                            140611
     C                     ELSE                                           140611
     C           FECALT    IFEQ '11'                                      140611
     C           FECALT    OREQ '12'                                      140611
     C           FECALT    OREQ '13'                                      140611
     C           FECALT    OREQ '14'                                                          204351
     C           FECALT    OREQ '15'                                                          204351
     C           FECALT    OREQ '16'                                                          204351
     C                     Z-ADDFADRAM    AAMT                            140611
     C                     ELSE                                           140611
     C           FECALT    IFEQ '21'                                      140611
     C           FECALT    OREQ '22'                                                          204351
     C                     Z-ADDFACFAM    AAMT                            140611
     C                     END                                            140611
     C                     END                                            140611
     C                     END                                            140611
      *                                                                                       204351
     C           FECALT    IFEQ '04'                                                          204351
     C           FECALT    OREQ '05'                                                          204351
     C           FECALT    OREQ '06'                                                          204351
     C           FECALT    OREQ '14'                                                          204351
     C           FECALT    OREQ '15'                                                          204351
     C           FECALT    OREQ '16'                                                          204351
     C           FECALT    OREQ '22'                                                          204351
     C                     EXSR ACCRUE                                                        204351
     C                     ADD  WTOT      WFEE                                                204351
     C                     ENDIF                                                              204351
      *                                                                                       204351
     C                     END                                            140611
     C*                                                                   140611
     C           FECALT    IFEQ '01'                                                          204351
     C           FECALT    OREQ '02'                                                          204351
     C           FECALT    OREQ '03'                                                          204351
     C           FECALT    OREQ '11'                                                          204351
     C           FECALT    OREQ '12'                                                          204351
     C           FECALT    OREQ '13'                                                          204351
     C           FECALT    OREQ '21'                                                          204351
     C                     MOVE '1'       *IN19                                               204351
     C                     EXSR ACCRUE                                    140611
     C                     Z-ADDWTOT      WFEE                            140611
     C                     ENDIF                                                              204351
     C/COPY WNCPYSRC,LEH00842
     C*                                                                   140611
     C** Forward valued fees should have zero total accrued amount        140611
     C*                                                                   140611
     C           FEPSTD    IFGT BJRDNB                                    140611
     C                     Z-ADD0         WFEE                            140611
     C                     END                                            140611
     C*                                                                   140611
     C                     ENDSR                                          140611
     C/EJECT                                                              140611
     C*****************************************************************   140611
     C/TITLE SR/ACCRUE                                                    140611
     C*****************************************************************   140611
     C*                                                                   140611
     C*  ACCRUE - SUBROUTINE TO CALCULATE ACCRUAL AMOUNT                  140611
     C*                                                                   140611
     C*  CALLED FROM: AVCALC                                              140611
     C*                                                                   140611
     C*  CALLS: ZXRATE, ZCONV, LSTRAT, AOCURRR0                           140611
     C*                                                                   140611
     C*****************************************************************   140611
     C*                                                                   140611
     C           ACCRUE    BEGSR                                          140611
     C*                                                                   140611
     C                     Z-ADD0         WTOT                            140611
     C*                                                                   140611
     C** Calculate percentage if required.                                140611
     C** Use original facility amount for average.                        140611
     C*                                                                   140611
     C           FEPIND    IFNE 'A'                                       140611
     C   43      WAMT      DIV  FHOFAM    WRK155    H                     140611
     C  N43      WAMT      DIV  FAMT      WRK155    H                     140611
     C           WRK155    MULT 100       WPCT                            140611
     C   43                Z-ADDFHOFAM    WAMT                            140611
     C  N43                Z-ADDFAMT      WAMT                            140611
     C           WPCT      IFGT 100                                       140611
     C                     Z-ADD100       WPCT                            140611
     C                     END                                            140611
     C                     END                                            140611
     C*                                                                   140611
     C** Convert from facility to fee currency if required.               140611
     C** If exchange rate field on fees master file is blank              140611
     C** obtain cross-currency exchange rate for these                    140611
     C** two currencies from the standing data files otherwise use        140611
     C** exchange rate on fees master file.                               140611
     C*                                                                   140611
     C           FHFCCY    IFNE FEFCCY                                    140611
     C           *IN43     ANDEQ*ON                                       140611
     C           FCCY      ORNE FEFCCY                                    140611
     C           *IN43     ANDEQ*OFF                                      140611
     C                     Z-ADDWAMT      CAMT   130                      140611
     C           FEERAT    IFEQ 0                                         140611
     C   43                MOVE FHFCCY    INCCY   3                       140611
     C  N43                MOVE FCCY      INCCY                           140611
     C                     MOVE FEFCCY    OUTCCY  3                       140611
     C                     Z-ADD1         X                               140611
     C           INCCY     LOKUPCURR,X                   52               140611
     C           *IN52     IFEQ '1'                                       140611
     C                     MOVE MTDV,X    ZMDI1   1                       140611
     C                     Z-ADDCSPT,X    ZRATE1 138                      140611
     C                     Z-ADDCCDP,X    ZNBDP1  10                      140611
     C                     END                                            140611
     C*                                                                   140611
     C                     Z-ADD1         X                               140611
     C           OUTCCY    LOKUPCURR,X                   53               140611
     C           *IN53     IFEQ '1'                                       140611
     C                     MOVE MTDV,X    ZMDI2   1                       140611
     C                     Z-ADDCSPT,X    ZRATE2 138                      140611
     C                     Z-ADDCCDP,X    ZNBDP2  10                      140611
     C                     END                                            140611
     C*                                                                   140611
     C** Obtain cross exchange rate & cross multiply/divide indicator.    140611
     C*                                                                   140611
     C                     EXSR ZXRATE                                    140611
     C*                                                                   140611
     C** Set up input fields for conversion subroutine.                   140611
     C*                                                                   140611
     C                     Z-ADDZRATEX    ZEXCH  138                      140611
     C                     MOVE ZMDIX     ZMD     1                       140611
     C                     Z-ADDCAMT      ZAMTCI 150                      140611
     C                     MOVE INCCY     ZCCYI   3                       140611
     C                     MOVE OUTCCY    ZCCYO   3                       140611
     C                     Z-ADDZNBDP1    ZCDPI   10                      140611
     C                     Z-ADDZNBDP2    ZCDPO   10                      140611
     C*                                                                   140611
     C                     EXSR ZCONV                                     140611
     C*                                                                   140611
     C                     Z-ADDZAMTCO    CAMT                            140611
     C*                                                                   140611
     C** Exchange rate not blank                                          140611
     C*                                                                   140611
     C                     ELSE                                           140611
     C*                                                                   140611
     C                     CALL 'AOCURRR0'                                140611
     C                     PARM '*MSG   ' WRTCD   7                       140611
     C                     PARM '*KEY   ' WOPTN   7                       140611
     C                     PARM FHFCCY    WAJCD   3                       140611
     C           SDCURR    PARM SDCURR    DSSDY                           140611
     C           WRTCD     IFNE *BLANKS                                   140611
     C           *LOCK     IN   LDA                                       140611
     C                     MOVEL'LER115'  DBPGM                           140611
     C                     MOVEL'SDCURRPD'DBFILE           ************   140611
     C                     Z-ADD18        DBASE            * DBERR 18 *   140611
     C                     MOVELFHFCCY    DBKEY            ************   140611
     C                     OUT  LDA                                       140611
     C                     EXSR *PSSR                                     140611
     C                     END                                            140611
     C*                                                                   140611
     C** Set up currency decimal place power position.                    140611
     C*                                                                   140611
     C           A6NBDP    ADD  4         FD      10                      140611
     C*                                                                   140611
     C** Fee currency decimal places + 1.                                 140611
     C*                                                                   140611
     C                     Z-ADDP         TD      10                      140611
     C*                                                                   140611
     C** Adjust incoming amount for from CCY decimal places.              140611
     C*                                                                   140611
     C           CAMT      DIV  POWER,FD  WRK153                          140611
     C*                                                                   140611
     C** Exchange rate conversion.                                        140611
     C*                                                                   140611
     C           FEMDIN    IFEQ 'M'                                       140611
     C                     MULT FEERAT    WRK153                          140611
     C                     ELSE                                           140611
     C                     DIV  FEERAT    WRK153    H                     140611
     C                     END                                            140611
     C*                                                                   140611
     C** Adjust calculated amount for to currency decimal places.         140611
     C*                                                                   140611
     C           WRK153    MULT POWER,TD  CAMT                            140611
     C*                                                                   140611
     C                     END                                            140611
     C                     Z-ADDCAMT      WAMT                            140611
     C                     END                                            140611
     C*                                                                   140611
     C** Look up factor for division corresponding to calc. basis         140611
     C*                                                                   140611
     C                     MOVE '0'       *IN54                           140611
     C           FECALC    LOKUPTABCAL    TABCBS         54               140611
     C                     MOVE TABCBS    WCBS    50                      140611
     C*                                                                   140611
     C** TIERED CALCULATION:                                              140611
     C** ------------------                                               140611
     C*                                                                   140611
     C           FECALT    IFEQ '01'                                      140611
     C           FECALT    OREQ '04'                                      140611
     C           FECALT    OREQ '11'                                      140611
     C           FECALT    OREQ '14'                                      140611
     C*                                                                   140611
     C** Amount (not percentage)                                          140611
     C*                                                                   140611
     C           FEPIND    IFEQ 'A'                                       140611
     C*                                                                   140611
     C** Convert limit amounts for fee decimal places.                    140611
     C*                                                                   140611
     C           FEAM      MULT POWER,P   FAM                             140611
     C                     Z-ADD0         WFAM                            140611
     C                     Z-ADDWAMT      WOAMT                           140611
     C                     Z-ADD1         X                               140611
     C           WAMT      DOWGT0                                         140611
     C           X         ANDLT6                                         140611
     C*                                                                   140611
     C           WOAMT     IFLT FAM,X                                     140611
     C           FAM,X     OREQ 0                                         140611
     C           WAMT      MULT FRT,X     WRK15                           140611
     C                     ELSE                                           140611
     C           FAM,X     SUB  WFAM      WRK15                           140611
     C                     MULT FRT,X     WRK15                           140611
     C                     END                                            140611
     C                     ADD  WRK15     WTOT                            140611
     C                     SUB  FAM,X     WAMT                            140611
     C                     ADD  WFAM      WAMT                            140611
     C                     Z-ADDFAM,X     WFAM                            140611
     C*                                                                   140611
     C                     ADD  1         X                               140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C** Calculate final accrual amount.                                  140611
     C*                                                                   140611
     C           *IN19     IFEQ '1'                                                           204351
      *                                                                                       204351
      ** if based on average use WDAYS                                                        204351
      *                                                                                       204351
     C                     MULT WDAYS     WTOT                            140611
     C                     ELSE                                                               204351
     C                     MULT NDAYS     WTOT                                                204351
     C                     ENDIF                                                              204351
     C                     DIV  WCBS      WTOT      H                     140611
     C*                                                                   140611
     C                     ELSE                                           140611
     C*                                                                   140611
     C** - PERCENTAGE:                                                    140611
     C*                                                                   140611
     C           FEAM      DIV  1000      FPC                             140611
     C*                                                                   140611
     C                     Z-ADD0         WFPC                            140611
     C                     Z-ADDWPCT      WOPCT                           140611
     C                     Z-ADD1         X                               140611
     C           WPCT      DOWGT0                                         140611
     C           X         ANDLT6                                         140611
     C*                                                                   140611
     C           WOPCT     IFLT FPC,X                                     140611
     C           FPC,X     OREQ 0                                         140611
     C           WAMT      MULT WPCT      WRK15                           140611
     C                     ELSE                                           140611
     C           FPC,X     SUB  WFPC      WRK63                           140611
     C           WAMT      MULT WRK63     WRK15                           140611
     C                     END                                            140611
     C                     MULT FRT,X     WRK15                           140611
     C                     DIV  100       WRK15     H                     140611
     C                     ADD  WRK15     WTOT                            140611
     C                     SUB  FPC,X     WPCT                            140611
     C                     ADD  WFPC      WPCT                            140611
     C                     Z-ADDFPC,X     WFPC                            140611
     C*                                                                   140611
     C                     ADD  1         X                               140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C** Calculate final accrual amount.                                  140611
     C*                                                                   140611
     C           *IN19     IFEQ '1'                                                           204351
      *                                                                                       204351
     C                     MULT WDAYS     WTOT                            140611
     C                     ELSE                                                               204351
     C                     MULT NDAYS     WTOT                                                204351
     C                     ENDIF                                                              204351
     C                     DIV  WCBS      WTOT      H                     140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C** THRESHOLD CALCULATION:                                           140611
     C** ---------------------                                            140611
     C*                                                                   140611
     C           FECALT    IFEQ '02'                                      140611
     C           FECALT    OREQ '05'                                      140611
     C           FECALT    OREQ '12'                                      140611
     C           FECALT    OREQ '15'                                      140611
     C*                                                                   140611
     C** - AMOUNT:                                                        140611
     C*                                                                   140611
     C           FEPIND    IFEQ 'A'                                       140611
     C*                                                                   140611
     C** Convert limit amounts for fee decimal places.                    140611
     C*                                                                   140611
     C           FEAM      MULT POWER,P   FAM                             140611
     C*                                                                   140611
     C** Search amount array to find value larger or equal.               140611
     C*                                                                   140611
     C                     Z-ADD1         X                               140611
     C                     MOVE '0'       *IN54                           140611
     C*                                                                   140611
     C           WAMT      LOKUPFAM,X                54  54               140611
     C           *IN54     IFEQ '0'                                       140611
     C                     EXSR LSTRAT                                    140611
     C                     END                                            140611
     C*                                                                   140611
     C           *IN54     IFEQ '0'                                       140611
     C           Y         ANDEQ0                                         140611
     C                     MULT 0         WAMT                            140611
     C                     ELSE                                           140611
     C                     MULT FRT,X     WAMT                            140611
     C                     END                                            140611
     C*                                                                   140611
     C           *IN19     IFEQ '1'                                                           204351
      *                                                                                       204351
     C           WAMT      MULT WDAYS     WTOT                            140611
     C                     ELSE                                                               204351
     C           WAMT      MULT NDAYS     WTOT                                                204351
     C                     ENDIF                                                              204351
     C                     DIV  WCBS      WTOT      H                     140611
     C*                                                                   140611
     C                     ELSE                                           140611
     C*                                                                   140611
     C** - PERCENTAGE:                                                    140611
     C*                                                                   140611
     C           FEAM      DIV  1000      FPC                             140611
     C*                                                                   140611
     C** Search percentage array to find value larger or equal.           140611
     C*                                                                   140611
     C                     Z-ADD1         X                               140611
     C                     MOVE '0'       *IN54                           140611
     C           WPCT      LOKUPFPC,X                54  54               140611
     C           *IN54     IFEQ '0'                                       140611
     C                     EXSR LSTRAT                                    140611
     C                     END                                            140611
     C                     MULT WPCT      WAMT                            140611
     C*                                                                   140611
     C           *IN54     IFEQ '0'                                       140611
     C           Y         ANDEQ0                                         140611
     C                     MULT 0         WAMT                            140611
     C                     ELSE                                           140611
     C                     MULT FRT,X     WAMT                            140611
     C                     END                                            140611
     C*                                                                   140611
     C                     DIV  100       WAMT      H                     140611
     C           *IN19     IFEQ '1'                                                           204351
      *                                                                                       204351
     C           WAMT      MULT WDAYS     WTOT                            140611
     C                     ELSE                                                               204351
     C           WAMT      MULT NDAYS     WTOT                                                204351
     C                     ENDIF                                                              204351
     C                     DIV  WCBS      WTOT      H                     140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C** SINGLE CALCULATION:                                              140611
     C** ------------------                                               140611
     C*                                                                   140611
     C           FECALT    IFEQ '03'                                      140611
     C           FECALT    OREQ '06'                                      140611
     C           FECALT    OREQ '13'                                      140611
     C           FECALT    OREQ '16'                                      140611
     C           FECALT    OREQ '21'                                      140611
     C           FECALT    OREQ '22'                                      140611
     C*                                                                   140611
     C           WAMT      MULT FRT,1     WTOT                            140611
     C           *IN19     IFEQ '1'                                                           204351
      *                                                                                       204351
     C                     MULT WDAYS     WTOT                            140611
     C                     ELSE                                                               204351
     C                     MULT NDAYS     WTOT                                                204351
     C                     ENDIF                                                              204351
     C                     DIV  WCBS      WTOT      H                     140611
     C*                                                                   140611
     C                     END                                            140611
     C*                                                                   140611
     C                     ENDSR                                          140611
     C*                                                                   140611
     C********************************************************************140611
     C*                                                                   140611
     C*  LSTRAT SUBROUTINE TO FIND LAST RATE IN AMOUNT/%AGE ARRAY.        140611
     C*                                                                   140611
     C*  CALLED FROM:  ACCRUE                                             140611
     C*                                                                   140611
     C*  CALLS:  NOTHING                                                  140611
     C*                                                                   140611
     C*****************************************************************   140611
     C*                                                                   140611
     C           LSTRAT    BEGSR                                          140611
     C*                                                                   140611
     C                     Z-ADD5         Y       20                      140611
     C           Y         DOWGT0                                         140611
     C           FEAM,Y    IFEQ 0                                         140611
     C           FRT,Y     ANDNE0                                         140611
     C                     Z-ADDY         X                               140611
     C                     Z-ADD0         Y                               140611
     C                     END                                            140611
     C                     SUB  1         Y                               140611
     C                     END                                            140611
     C*                                                                   140611
     C                     ENDSR                                          140611
     C*                                                                   140611
      *****************************************************************                       CSD015
      /EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
      *  SRCHCK  - Check if Watch List Checking Engine Program needs  *                       CSD015
      *            to be called                                       *                       CSD015
      *                                                               *                       CSD015
      *  Called by: SRINSR, SRUPDR                                    *                       CSD015
      *  Calls    : None                                              *                       CSD015
      *****************************************************************                       CSD015
      *                                                                                       CSD015
     C           SRCHCK    BEGSR                                                              CSD015
      *                                                                                       CSD015
      ** Initialization                                                                       CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       W3UNCF  1                                           CSD015
     C                     MOVE 'N'       WRONSX  1                                           CSD015
     C                     MOVE 'N'       WRIBNX  1                                           CSD015
     C                     MOVE 'N'       WROBNX  1                                           CSD015
     C                     MOVE 'N'       WROCNX  1                                           CSD015
     C                     MOVE 'N'       WPONSX  1                                           CSD015
     C                     MOVE 'N'       WPIBNX  1                                           CSD015
     C                     MOVE 'N'       WPOBNX  1                                           CSD015
     C                     MOVE 'N'       WPOCNX  1                                           CSD015
     C                     MOVE 'N'       WRCRNX  1                                           CSD015
     C                     MOVE 'N'       WRVNOX  1                                           CSD015
     C                     MOVE 'N'       WAWBNX  1                                           CSD015
     C                     MOVE 'N'       WBENNX  1                                           CSD015
     C                     MOVE 'N'       WDTPXX  1                                           CSD015
      *                                                                                       CSD015
     C           SACTN     IFEQ 'A'                                                           CSD015
     C                     MOVEL'LEFESA'  K3FUNT                                              CSD015
      *                                                                                       CSD015
     C********** FALOAN    IFEQ *ZERO                                                  CSD015 CLE148
     C           FALOAN    IFEQ *BLANKS                                                       CLE148
     C                     MOVELFACNUM    WFCNUM                                              CSD015
     C                     MOVELFAFACL    WFFACL                                              CSD015
     C                     MOVELFAFSEQ    WFFSEQ                                              CSD015
     C           WFCNUM    CAT  WFFACL    WIDEN                                               CSD015
     C           WIDEN     CAT  WFFSEQ    K3IDEN                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVELFALOAN    WFLOAN                                              CSD015
     C           WFLOAN    CAT  WFFSEQ    K3IDEN                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVELFABRCA    K3BRCH                                              CSD015
      *                                                                                       CSD015
     C           KCWHT     CHAINSDCWHTL1             71                                       CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receipt Nostro                                                                       CSD015
      *                                                                                       CSD015
     C           PMRONS    IFNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PMRONS    ORNE FARONS                                                        CSD015
     C                     MOVE 'Y'       WRONSX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receipt Intermediary Bank + Account Line                                             CSD015
      *                                                                                       CSD015
     C           PARIBN    IFNE *BLANKS                                                       CSD015
     C           PMRIBA    ORNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PARIBN    ORNE FARIBN                                                        CSD015
     C           PARIBN    ANDNE*BLANKS                                                       CSD015
     C           PMRIBA    ORNE FARIBA                                                        CSD015
     C           PMRIBA    ANDNE*BLANKS                                                       CSD015
     C                     MOVE 'Y'       WRIBNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receipt Ordering Bank                                                                CSD015
      *                                                                                       CSD015
     C           PAROBN    IFNE *BLANKS                                                       CSD015
     C                     MOVELFAROBN    WAROBN  6                                           CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PAROBN    ORNE WAROBN                                                        CSD015
     C                     MOVE 'Y'       WROBNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receipt Ordering Customer                                                            CSD015
      *                                                                                       CSD015
     C           PAROCN    IFNE *BLANKS                                                       CSD015
     C                     MOVELFAROCN    WAROCN  6                                           CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PAROCN    ORNE WAROCN                                                        CSD015
     C                     MOVE 'Y'       WROCNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Nostro                                                                           CSD015
      *                                                                                       CSD015
     C           PMPONS    IFNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PMPONS    ORNE FAPONS                                                        CSD015
     C                     MOVE 'Y'       WPONSX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Intermediary Bank + Account Line                                                 CSD015
      *                                                                                       CSD015
     C           PAPIBN    IFNE *BLANKS                                                       CSD015
     C           PMPIBA    ORNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PAPIBN    ORNE FAPIBN                                                        CSD015
     C           PAPIBN    ANDNE*BLANKS                                                       CSD015
     C           PMPIBA    ORNE FAPIBA                                                        CSD015
     C           PMPIBA    ANDNE*BLANKS                                                       CSD015
     C                     MOVE 'Y'       WPIBNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Ordering Bank                                                                    CSD015
      *                                                                                       CSD015
     C           PAPOBN    IFNE *BLANKS                                                       CSD015
     C                     MOVELFAPOBN    WAPOBN  6                                           CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PAPOBN    ORNE WAPOBN                                                        CSD015
     C                     MOVE 'Y'       WPOBNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Ordering Customer                                                                CSD015
      *                                                                                       CSD015
     C           PAPOCN    IFNE *BLANKS                                                       CSD015
     C                     MOVELFAPOCN    WAPOCN  6                                           CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PAPOCN    ORNE WAPOCN                                                        CSD015
     C                     MOVE 'Y'       WPOCNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receiver Correspondent + Account Line                                                CSD015
      *                                                                                       CSD015
     C           PARCRN    IFNE *BLANKS                                                       CSD015
     C           PMRCRA    ORNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PARCRN    ORNE FARCRN                                                        CSD015
     C           PARCRN    ANDNE*BLANKS                                                       CSD015
     C           PMRCRA    ORNE FARCRA                                                        CSD015
     C           PMRCRA    ANDNE*BLANKS                                                       CSD015
     C                     MOVE 'Y'       WRCRNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receiver                                                                             CSD015
      *                                                                                       CSD015
     C           PARVNO    IFNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PARVNO    ORNE FARVNO                                                        CSD015
     C                     MOVE 'Y'       WRVNOX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Account with Bank + Account Line                                                     CSD015
      *                                                                                       CSD015
     C           PAAWBN    IFNE *BLANKS                                                       CSD015
     C           PMAWBA    ORNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PAAWBN    ORNE FAAWBN                                                        CSD015
     C           PAAWBN    ANDNE*BLANKS                                                       CSD015
     C           PMAWBA    ORNE FAAWBA                                                        CSD015
     C           PMAWBA    ANDNE*BLANKS                                                       CSD015
     C                     MOVE 'Y'       WAWBNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Beneficiary + Account Line                                                           CSD015
      *                                                                                       CSD015
     C           PABENN    IFNE *BLANKS                                                       CSD015
     C           PMBENA    ORNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PABENN    ORNE FABENN                                                        CSD015
     C           PABENN    ANDNE*BLANKS                                                       CSD015
     C           PMBENA    ORNE FABENA                                                        CSD015
     C           PMBENA    ANDNE*BLANKS                                                       CSD015
     C                     MOVE 'Y'       WBENNX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Details of Payment                                                                   CSD015
      *                                                                                       CSD015
     C           PMDTP1    IFNE *BLANKS                                                       CSD015
     C           PMDTP2    ORNE *BLANKS                                                       CSD015
     C           PMDTP3    ORNE *BLANKS                                                       CSD015
     C           PMDTP4    ORNE *BLANKS                                                       CSD015
     C           W3UNCF    IFEQ 'Y'                                                           CSD015
     C           PMDTP1    ORNE FADTP1                                                        CSD015
     C           PMDTP1    ANDNE*BLANKS                                                       CSD015
     C           PMDTP2    ORNE FADTP2                                                        CSD015
     C           PMDTP2    ANDNE*BLANKS                                                       CSD015
     C           PMDTP3    ORNE FADTP3                                                        CSD015
     C           PMDTP3    ANDNE*BLANKS                                                       CSD015
     C           PMDTP4    ORNE FADTP4                                                        CSD015
     C           PMDTP4    ANDNE*BLANKS                                                       CSD015
     C                     MOVE 'Y'       WDTPXX  1                                           CSD015
     C                     MOVE 'Y'       WATCH                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDSR                                                              CSD015
      *****************************************************************                       CSD015
      /EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
      *  SRWTCH  -                                                    *                       CSD015
      *                                                               *                       CSD015
      *  Called by: SRWRIT, SRUPDT                                    *                       CSD015
      *  Calls    : None                                              *                       CSD015
      *****************************************************************                       CSD015
      *                                                                                       CSD015
     C           SRWTCH    BEGSR                                                              CSD015
      *                                                                                       CSD015
      ** Set-up parameter for Compliance Engine Program                                       CSD015
      *                                                                                       CSD015
      ** 1st Parameter                                                                        CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANKS   W4IDEN                                              CSD015
     C                     MOVE *BLANKS   W4ITEM                                              CSD015
     C                     MOVE *BLANKS   W4BRCH                                              CSD015
     C                     MOVE *BLANKS   W4SYSM                                              CSD015
     C                     MOVE *BLANKS   W4FUNT                                              CSD015
     C                     MOVE *BLANKS   W4CUST                                              CSD015
     C                     Z-ADD*ZERO     W4DDAT                                              CSD015
     C                     Z-ADD*ZERO     W4VDAT                                              CSD015
     C                     Z-ADD*ZERO     W4MDAT                                              CSD015
     C                     MOVE *BLANKS   W4DEN1                                              CSD015
     C                     MOVE *BLANKS   W4DEN2                                              CSD015
     C                     Z-ADD*ZERO     W4AMT1                                              CSD015
     C                     Z-ADD*ZERO     W4AMT2                                              CSD015
      *                                                                                       CSD015
      ** Item code                                                                            CSD015
      *                                                                                       CSD015
     C                     MOVEL'LEFESA'  W4ITEM                                              CSD015
      *                                                                                       CSD015
      ** Identifier                                                                           CSD015
      *                                                                                       CSD015
     C********** FALOAN    IFEQ *ZERO                                                  CSD015 CLE148
     C           FALOAN    IFEQ *BLANKS                                                       CLE148
     C                     MOVELFACNUM    WFCNUM                                              CSD015
     C                     MOVELFAFACL    WFFACL                                              CSD015
     C                     MOVELFAFSEQ    WFFSEQ                                              CSD015
     C           WFCNUM    CAT  WFFACL    WIDEN                                               CSD015
     C           WIDEN     CAT  WFFSEQ    W4IDEN                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVELFALOAN    WFLOAN                                              CSD015
     C           WFLOAN    CAT  WFFSEQ    W4IDEN                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Branch                                                                               CSD015
      *                                                                                       CSD015
     C                     MOVELFABRCA    W4BRCH                                              CSD015
      *                                                                                       CSD015
      ** System                                                                               CSD015
      *                                                                                       CSD015
     C           CSC011    IFEQ 'Y'                                                           CSD015
     C                     MOVELS1MAIN    W4SYSM                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVELLIBR      W4SYSM                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Function Type                                                                        CSD015
      *                                                                                       CSD015
     C                     MOVEL'LEFEEAD' W4FUNT                                              CSD015
      *                                                                                       CSD015
      ** Counter Party Number                                                                 CSD015
      *                                                                                       CSD015
     C                     MOVELFACNUM    W4CNUM                                              CSD015
      *                                                                                       CSD015
      ** Counterparty Type                                                                    CSD015
      *                                                                                       CSD015
      *                                                                                       CSD015
      ** If Concord Interface Development is installed                                        CSD015
      **    If Corporate Customer is 'Y', set Counterparty Type to 'C'                        CSD015
      **    Else, Counterparty Type to 'I'                                                    CSD015
      *                                                                                       CSD015
     C           CCF001    IFEQ 'Y'                                                           CSD015
     C           BBCRPC    IFEQ 'Y'                                                           CSD015
     C                     MOVEL'C'       W4CTYP                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVEL'I'       W4CTYP                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
      ** ELSE,                                                                                CSD015
      **    If Local Industry Code is not blank and it is not equal to a                      CSD015
      **    any of the five Private Customer Industry Code, set CounterParty                  CSD015
      **    Type to 'C'                                                                       CSD015
      **     Else, set Counterparty Type to 'I'.                                              CSD015
      *                                                                                       CSD015
     C           BBLICD    IFNE *BLANKS                                                       CSD015
     C           BBLICD    ANDNEW1IND1                                                        CSD015
     C           BBLICD    ANDNEW1IND2                                                        CSD015
     C           BBLICD    ANDNEW1IND3                                                        CSD015
     C           BBLICD    ANDNEW1IND4                                                        CSD015
     C           BBLICD    ANDNEW1IND5                                                        CSD015
     C                     MOVEL'C'       W4CTYP                                              CSD015
     C                     ELSE                                                               CSD015
     C                     MOVEL'I'       W4CTYP                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Counter Party Name                                                                   CSD015
      *                                                                                       CSD015
     C           BBCRNM    CAT  BBCRTN    W4CUST                                              CSD015
      *                                                                                       CSD015
      ** Value Date                                                                           CSD015
      *                                                                                       CSD015
     C                     Z-ADDFASADD    W4VDAT                                              CSD015
      *                                                                                       CSD015
      ** Denomination Side 1 (W4DEN1)                                                         CSD015
      *                                                                                       CSD015
     C                     MOVELFAFCCY    W4DEN1                                              CSD015
      *                                                                                       CSD015
      ** Denomination Side 2                                                                  CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANKS   W4DEN2                                              CSD015
      *                                                                                       CSD015
      ** Amount Side 1 (W4AMT1)                                                               CSD015
      *                                                                                       CSD015
     C                     Z-ADDFASADJ    W4AMT1                                              CSD015
      *                                                                                       CSD015
      ** Amount Side 2 (W4AMT2)                                                               CSD015
      *                                                                                       CSD015
     C                     Z-ADD0         W4AMT2                                              CSD015
      *                                                                                       CSD015
      ** 2nd Parameter                                                                        CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANKS   PXML                                                CSD015
      *                                                                                       CSD015
      ** Receipt Nostro                                                                       CSD015
      *                                                                                       CSD015
     C           WRONSX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFARONS    PINP1                                               CSD015
     C           FASCCY    IFNE *BLANKS                                                       CSD015
     C                     MOVELFASCCY    PCCY                                                CSD015
     C                     ELSE                                                               CSD015
     C                     MOVELFAFCCY    PCCY                                                CSD015
     C                     ENDIF                                                              CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,1:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  CLTAG,1:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receipt Intermediary Bank + Account Line                                             CSD015
      *                                                                                       CSD015
     C           WRIBNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFARIBN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,2:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  FARIBA:0  PXML                                                CSD015
     C           PXML      CAT  CLTAG,2:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receipt Ordering Bank                                                                CSD015
      *                                                                                       CSD015
     C           WROBNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFAROBN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,3:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  CLTAG,3:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receipt Ordering Customer                                                            CSD015
      *                                                                                       CSD015
     C           WROCNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFAROCN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,4:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  CLTAG,4:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Nostro                                                                           CSD015
      *                                                                                       CSD015
     C           WPONSX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFAPONS    PINP1                                               CSD015
     C           FASCCY    IFNE *BLANKS                                                       CSD015
     C                     MOVELFASCCY    PCCY                                                CSD015
     C                     ELSE                                                               CSD015
     C                     MOVELFAFCCY    PCCY                                                CSD015
     C                     ENDIF                                                              CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,5:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  CLTAG,5:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Intermediary Bank + Account Line                                                 CSD015
      *                                                                                       CSD015
     C           WPIBNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFAPIBN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,6:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  FAPIBA:0  PXML                                                CSD015
     C           PXML      CAT  CLTAG,6:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Ordering Bank                                                                    CSD015
      *                                                                                       CSD015
     C           WPOBNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFAPOBN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,7:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  CLTAG,7:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Pay Ordering Customer                                                                CSD015
      *                                                                                       CSD015
     C           WPOCNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFAPOCN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,8:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  CLTAG,8:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receiver Correspondent + Account Line                                                CSD015
      *                                                                                       CSD015
     C           WRCRNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFARCRN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,9:0 PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  FARCRA:0  PXML                                                CSD015
     C           PXML      CAT  CLTAG,9:0 PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Receiver                                                                             CSD015
      *                                                                                       CSD015
     C           WRVNOX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFARVNO    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,10:0PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  CLTAG,10:0PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Account with Bank + Account Line                                                     CSD015
      *                                                                                       CSD015
     C           WAWBNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFAAWBN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,11:0PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  FAAWBA:0  PXML                                                CSD015
     C           PXML      CAT  CLTAG,11:0PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Beneficiary + Account Line                                                           CSD015
      *                                                                                       CSD015
     C           WBENNX    IFEQ 'Y'                                                           CSD015
     C                     MOVELFABENN    PINP1                                               CSD015
     C                     EXSR SRFRMT                                                        CSD015
     C           PXML      CAT  OPTAG,12:0PXML                                                CSD015
     C           PXML      CAT  POUT:0    PXML                                                CSD015
     C           PXML      CAT  FABENA:0  PXML                                                CSD015
     C           PXML      CAT  CLTAG,12:0PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Details of Payment                                                                   CSD015
      *                                                                                       CSD015
     C           WDTPXX    IFEQ 'Y'                                                           CSD015
     C           PXML      CAT  OPTAG,13:0PXML                                                CSD015
     C           PXML      CAT  FADTP1:0  PXML                                                CSD015
     C           PXML      CAT  FADTP2:1  PXML                                                CSD015
     C           PXML      CAT  FADTP3:1  PXML                                                CSD015
     C           PXML      CAT  FADTP4:1  PXML                                                CSD015
     C           PXML      CAT  CLTAG,13:0PXML                                                CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Send Transaction Details to Compliance Watch by Calling the                          CSD015
      ** Dummy program that will call the watch list enqine.                                  CSD015
      *                                                                                       CSD015
     C                     CALL 'SDWLCLOP'                                                    CSD015
     C                     PARM           PSDWLT                                              CSD015
     C                     PARM           PXML                                                CSD015
     C                     ENDSR                                                              CSD015
      *****************************************************************                       CSD015
      /EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
      *  SRFRMT  -                                                    *                       CSD015
      *                                                               *                       CSD015
      *  Called by: SRWTCH                                            *                       CSD015
      *  Calls    : SDCWLFMT                                          *                       CSD015
      *****************************************************************                       CSD015
      *                                                                                       CSD015
     C           SRFRMT    BEGSR                                                              CSD015
      *                                                                                       CSD015
     C                     CALL 'SDCWLFMT'                                                    CSD015
     C                     PARM           PRTCD                                               CSD015
     C                     PARM           PINP1  35                                           CSD015
     C                     PARM           PINP2  35                                           CSD015
     C                     PARM           PINP3  35                                           CSD015
     C                     PARM           PINP4  35                                           CSD015
     C                     PARM           PINP5  35                                           CSD015
     C                     PARM           PINP6  35                                           CSD015
     C                     PARM           PCCY    3                                           CSD015
     C                     PARM           POUT  216                                           CSD015
     C                     PARM           POUT2   6                                           CSD015
      *                                                                                       CSD015
      ** Initialize to blanks the input parameters.                                           CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANKS   PINP1                                               CSD015
     C                     MOVE *BLANKS   PINP2                                               CSD015
     C                     MOVE *BLANKS   PINP3                                               CSD015
     C                     MOVE *BLANKS   PINP4                                               CSD015
     C                     MOVE *BLANKS   PINP5                                               CSD015
     C                     MOVE *BLANKS   PINP6                                               CSD015
      *                                                                                       CSD015
     C                     ENDSR                                                              CSD015
      *****************************************************************
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *****************************************************************
     C           *PSSR     BEGSR
      *
     C           PMODE     IFNE 'B'                                 135446
     C                     ROLBK
     C                     ENDIF                                    135446
      *                                                             135446
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C           PMODE     IFEQ 'I'
     C           PMODE     OREQ 'R'
     C                     CALL 'DBERRCTL'
     C                     ENDIF
     C                     ENDIF
      *                                                                                       219142
     C           PMODE     IFEQ 'B'                                                           219142
     C           PMODE     OREQ 'P'                                                           219142
     C                     MOVE 'D'       PRMSV                                               219142
     C                     MOVEL'LEL0035 'ZAMSID                                              219142
     C                     EXSR ZASNMS                                                        219142
     C                     ENDIF                                                              219142
      *
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
     C/COPY ZSRSRC,ZACCH
      /EJECT
     C/COPY ZSRSRC,ZCHKH
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C/COPY ZSRSRC,ZDAT10Z2
      /EJECT
     C/COPY ZSRSRC,ZFRPEDZ3
      /EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
      /EJECT
     C/TITLE SR/ZXRATE                                                    140611
     C/COPY ZSRSRC,ZXRATEZ1                                               140611
     C/TITLE SR/ZCONV                                                     140611
     C/COPY ZSRSRC,ZCONVZ1                                                140611
     C/COPY ZSRSRC,ZINTDYZ2                                               CLE013
     C/COPY ZSRSRC,ZDATE9Z3                                               CLE013
      /EJECT                                                                                  CLE031
     C/COPY ZSRSRC,ZEDITZ2                                                                    CLE031
     OLEFEEAD0E                RELFE0
      *** Release LEFEEAL0 without updating it
     OLEFEEAD2E                RELFE2
      *** Release LEFEEAL2 without updating it
      /EJECT
** CPY@  **      Copyright statement
(c) Finastra International Limited 2001
** STAMP - Dummy timestamp                                                                    CPK015
0001-01-01-00.00.00.000000                                                                    CPK015
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION                       140611
0000001                                                                   140611
0000010                                                                   140611
0000100                                                                   140611
0001000                                                                   140611
0010000                                                                   140611
0100000                                                                   140611
1000000                                                                   140611
**   TABCAL/TABCBS - CALCULATION BASES.                                   140611
136500236000336000436500536000636600                                      140611
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
** OPTAG - OPEN TAGS for XML                                                                  CSD015
<Receipt Nostro>                                                                              CSD015
<Receipt Intermed Bank>                                                                       CSD015
<Receipt Ordering Bank>                                                                       CSD015
<Receipt Ordering Cust>                                                                       CSD015
<Payment Nostro>                                                                              CSD015
<Payment Intermed Bank>                                                                       CSD015
<Payment Ordering Bank>                                                                       CSD015
<Payment Ordering Cust>                                                                       CSD015
<Receiver Correspondent>                                                                      CSD015
<Receiver>                                                                                    CSD015
<Account With Bank>                                                                           CSD015
<Beneficiary>                                                                                 CSD015
<Details Of Payment>                                                                          CSD015
** CLTAG - CLOSE TAGS for XML                                                                 CSD015
</Receipt Nostro>                                                                             CSD015
</Receipt Intermed Bank>                                                                      CSD015
</Receipt Ordering Bank>                                                                      CSD015
</Receipt Ordering Cust>                                                                      CSD015
</Payment Nostro>                                                                             CSD015
</Payment Intermed Bank>                                                                      CSD015
</Payment Ordering Bank>                                                                      CSD015
</Payment Ordering Cust>                                                                      CSD015
</Receiver Correspondent>                                                                     CSD015
</Receiver>                                                                                   CSD015
</Account With Bank>                                                                          CSD015
</Beneficiary>                                                                                CSD015
</Details Of Payment>                                                                         CSD015
