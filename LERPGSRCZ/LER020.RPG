     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Facility update repayments non-RC fclty')     *
      *****************************************************************
      *                                                               *
      *  Midas - Customer Lending Module                              *
      *                                                               *
      *  LER020 - FACILITY UPDATE FOR REPAYMENTS ON NON-RC FACILITIES *
      *                                                               *
      *  Function:  This program updates non-revolving credit         *
      *  (COB)      facilities for loan repaid - adjusting the        *
      *             facility amount to take account of the new        *
      *             amount outstanding                                *
      *                                                               *
      *  Called By: LERC20                                            *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD050153           Date 17Mar23               *
      *  Prev Amend No. AR1078902          Date 17Mar23               *
      *                 MD060134           Date 22Jun22               *
      *                 CLE138             Date 02Nov21               *
      *                 CLE172             Date 01Oct20               *
      *                 CSD103             Date 10Aug20               *
      *                 MD056601           Date 02Oct20               *
      *                 AR674226           Date 04Dec19               *
      *                 MD055082           Date 16Jan20               *
      *                 MD052276           Date 16Jan19               *
      *                 MD051329           Date 18Jun18               *
      *                 MD050278           Date 08May18               *
      *                 AR1036834          Date 24Jun13               *
      *                 MD046248           Date 27Oct17               *
      *                 MD040535           Date 21Oct16               *
      *                 MD027755           Date 26Jan15               *
      *                 226483             Date 29Oct14               *
      *                 MD020563           Date 21May13               *
      *                 AR806351           Date 24Apr13               *
      *                 AR1097176          Date 22Mar13               *
      *                 CFC006             Date 06Aug12               *
      *                 AR1021983          Date 01Aug12               *
      *                 AR649939           Date 01Aug12               *
      *                 AR567487           Date 01Aug12               *
      *                 263840             Date 01Aug12               *
      *                 263413             Date 01Aug12               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 AR787620           Date 10Jun11               *
      *                 CLE064             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 BUG23388           Date 19Mar09               *
      *                 CSC042             Date 16Feb09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246032             Date 12Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 224974             Date 06Jun06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 225591             Date 08Jul04               *
      *                 CLE041             Date 11Oct04               *
      *                 CGL029             Date 01Sep03               *
      *                 CAS006             Date 21Jan03               *
      *                 CAS005             Date 16Dec02               *
      *                 CLE029             Date 04Sep02               *
      *                 CAP073             Date 08Aug02               *
      *                 CLE028             Date 27Jun02               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 208182             Date 11Sep02               *
      *                 208203             Date 11Sep02               *
      *                 199220             Date 26Apr02               *
      *                 204450             Date 25Apr02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CAP068             Date 25JUN02               *
      *                 203521             Date 27Mar02               *
      *                 CLE023             Date 19Nov01               *
      *                 193859             Date 19Nov01               *
      *                 193603             Date 31Aug01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 199588             Date 30Oct01               *
      *                 CLE014             Date 20Mar01               *
      *                 192329             Date 06Jun01               *
      *                 179594             Date 06Jun01               *
      *                 179077             Date 02Apr01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 162343             Date 17Jan00               *
      * Midas DBA 3.04 -----------------------------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 167172             Date 07Feb00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 161452             Date 16Jun99               *
      *                 159499             Date 20Apr99                *
      *                 159015             Date 14Apr99                *
      *                 154092             Date 18Mar99               *
      *                 156296             Date 01Mar99               *
      *                 144712             Date 16Nov98               *
      *                 134480             Date 22Sep98               *
      *                 146936             Date 09Nov98               *
      *                 110625   (97133)   Date 26Feb98               *
      *                 112590             Date 25Feb98               *
      *                 CLE005             Date 22May97               *
      *                 125188             Date 04Nov97                *
      *                 CLE004             Date 02Dec96               *
      *                     092501             DATE  11JAN96           *
      *                     087943             DATE   9JUN95           *
      *                     081634             DATE  12JAN95           *
      *                     S01518             DATE  03OCT94           *
      *                     052132             DATE  26APR93           *
      *                     E30169             DATE  07APR92           *
      *                     E30168             DATE  07APR92           *
      *                     E29401             DATE  07APR92           *
      *                                                                *
      *----------------------------------------------------------------*
      *                                                                *
      *  MD050153 - Incorrect current amount for principal transfer   *
      *             to the same non-revolving facility. Enhance fix   *
      *             AR1078902. Remove checking for GPRT and TOLN.     *
      *  AR1078902 - Principal Transfer enhancement. Transfer to a    *
      *              new loan under a different facility.             *
      *              (Child: AR1084471)                               *
      *            - Applied for MD050153                             *
      *  MD060134 - Indicator 30 is used in the program change        *
      *             FCLS indicator from 30 to 35                      *
      *  CLE138 - Class Codes for Facilities                          *
      *  CLE172 - LIBOR Deregulation - Lending (Recompile)            *
      *  CSD103 - LIBOR Deregulation - Common Layer/Standing Data     *
      *           (Recompile)                                         *
      *  MD056601 - Component LERC20 ran a long duration during COB.  *
      *             Redesign fix 203521 to improve performance:       *
      *             1. check if RC exists in HISACTL2 that coincides  *
      *             with BV loan repayment. If found then use the     *
      *             revolving credit change record, else:             *
      *             2. do a single read in FACHISA using HISUPD.      *
      *  AR674226 - Manual transaction reached 999. Increase the size *
      *             of utilisation sequence no. and transaction       *
      *             sequence. Recompile. (Child: AR674227)            *
      *           - Applied for MD054782.                             *
      *  MD055082 - Scenario 1.34 Drawn and facility amounts           *
      *             difference on LE3180P1                             *
      *  MD052276 - LER020 Update of file controls incorrect due to    *
      *             high order truncation causing LEC06 10011          *
      *             (LE0461) to fail in next CoB                       *
      *  MD051329 - Incorrect incorporation of MD040535               *
      *  MD050278 - LE: Manual Repayment missing from Facility        *
      *             History                                           *
      *  AR1036834 - PDCL repayments do not update facility details.  *
      *              Prevent output to ACTNPDK to trigger update of   *
      *              FM/FN on first run of LER020. (Child: AR1036835) *
      *  MD046248 - Finastra Rebranding                               *
      *  MD040535 - If the MR is auto-settle Y but loan is auto-settle*
      *             C then prevent output to LEACPDPD.                *
      *  MD027755 - Remove update of OAM,x due to fix MD024229 in     *
      *             LE0491 for expiring facilities.                   *
      *  226483 - Still a database error if facility reversed today   *
      *           Complete fix 167172 (for DBERROR 004).              *
      *         - Applied for MD030379.                               *
      *  MD020563 - CFC006 issues                                     *
      *  AR806351 - Negative MR's are not subject for funds pre-check *
      *             thus exclude output to ACTNPDK. (Child: AR806352) *
      *  AR1097176 - Accessing AOCOMR0 multiple times slows down the  *
      *              system                                           *
      *  CFC006 - COB Restructure - Remove reports from COB           *
      *  AR1021983 - Option C - Technical Enhancements Stated in POC  *
      *  AR649939 - Lending facility availability neg. value.         *
      *             Facility should not be reduced with MR for PDCL   *
      *             generated on Input Cycle. (Child: AR650139)       *
      *  AR567487 - Negative available amount in Outstanding          *
      *             Facilities by Customer Enquiry. AUTO must be      *
      *             be taken from Loan not Action. (Child: AR567488)  *
      *  263840 - Correct update of facility utilisation for PDCLs.   *
      *  263413 - Facility update issue                               *
      *  CLE134 - Past Due Call Loan Processing                       *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  AR787620 - Hooks Incorporation                               *
      *             WNCPYSRC,LEH00112                                 *
      *  CLE064 - Enhancement of Lending Frequencies (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus (Recompile)                              *
      *  BUG23388 - LEC07 & LEC10 (Applied fix 255932).               *
      *  255932 - On reversal, ensure correct repayment amount is     *
      *           retrieved and updated to Facility file -- for non-  *
      *           revolving facility. Reinstate part removed by 179594*
      *  CSC042 - COB performance fix - reinstate some of the code    *
      *           taken out by 199588. Use of Array to get Decimal    *
      *           places for a currency better than >100K calls to    *
      *           AOCURRR*
      *  246032 - Directly divide/multiply the facility exchange rate *
      *           against the action amount. Remove codes to get the  *
      *           reciprocal of the exchange rate as this causes      *
      *           rounding discrepancies. Apply R3.5 fix 207064.      *
      *  224974 - MCCY facility at maturity does not close exposure   *
      *           (rounding). Applied fix 147460.                     *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  225591 - Facility history changes for repayments due to      *
      *           rollover (recompile) Note changes are required      *
      *           here as the additional repayment records for        *
      *           rollovers are not on the action file.               *
      *  CLE041 - Collateralised Lending Phase 2B                     *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  CAS005 - Enahancements to CAS001, CAS002 and CAS004          *
      *           (Recompile)                                         *
      *  CLE029 - Addition of Severity code and Limit ID to FCLTYFM   *
      *  CAP073 - Conversion of MN inputs into modular structure to   *
      *           use as APIs. Facility input Transaction Details     *
      *  CLE028 - Flat Rate Personal Loans (Rule of 78s)              *
      *           (Recompile)                                         *
      *  208182 - WCAUP should be set to 'N' at the start of each     **
      *           cycle to prevent invalid update of CAs.             **
      *  208203 - Facility Amount reduced for a CA when a Loan is     **
      *           reversed on the input date. This should not happen. **
      *  199220 - Prevent the facility amount of a revolving credit   *
      *           facility decreased by maturity/repayment actions    *
      *           in which the value dates are holidays. This applies *
      *           to system with BKAPFQ equal to D.                   *
      *  204450 - Facility amount for a reactivated facility should   *
      *           equal reactivation amount or last facility amount.  *
      *  CAP068 - Recompiled for changes to FCLTYFM and FCLTYFN.      *
      *  203521 - Frequency repayments did not all reduced facility   *
      *           amount.  Wrong record being retrieved from FACHISA  *
      *           if facility is newly inserted.                      *
      *  CLE023 - Lending Facility History Improvements.              *
      *  193859 - Multi-ccy Rollover corrupts Facility amounts.       *
      *  193603 - File control out of balance in LE0700 when reversed *
      *           a loan including a manual repayment and closed the  *
      *           facility at the same day.  Hash totalling needs to  *
      *           be redone now that facility amounts can go negative.*
      *  199588 - Facility history should use fixed rate.             *
      *           Reverse part of fix for 162343 so that fixed FCXR   *
      *           rate is used when converting from loan currency to  *
      *           facility currency.                                  *
      *  CLE014 - Customer Driven Lending Enhancements                *
      *  192329 - Facility amount of a non-revolving credit agreement  *
      *           was reduced by a multi-currency rollover. Amended fix*
      *           146936. For AMTP = 'MC', must set up 'WCAUP', chain  *
      *           to CLOANCL not PETEMPLN as currency & amount have    *
      *           changed, & ensure amount on LECARDPD is negative.    *
      *  179594 - Remove PART OF fix 161452 as it causes problem with  *
      *           revolving facilities.  Apply fix 168305.             *
      *  179077 - Reinstate processing to zeroise facility amount if  *
      *           less than 0, unless CLE005 is installed, to prevent *
      *           situation where customer is shown as being          *
      *           overdrawn by the total of loans outstanding - amend *
      *           fix 159499.                                         *
      *  162343 - When considering MR, RE, MA, RV and MC actions for  *
      *           loans attached to a facility, use the current spot  *
      *           rate instead of using the facility exchange rate    *
      *           from the loan in all computations.                  *
      *  167172 - Reversed facilities have been moved from FCLTYFM to  *
      *           PEFCLFM - chain to PEFCLFL1 if not on FCLTY.         *
      *  161452 - Correct the processing which determines whether or   *
      *           not the facility was revolving on the action date.   *
      *           Also, assumption that the Credit Agreement history   *
      *           coincides with the Tranche, iro its revolving credit *
      *           indicator, is incorrect.                             *
      *  159499 - Remove code which zeroises a negative facility       *
      *           amount. Consistent with same change in LER032.       *
      *  159015 - Reversal of loan updates non-revolving facility      *
      *           incorrectlt and the loan records still show on the   *
      *           facility history report.                             *
      *           (apply changes to 097133)
      *  154092 - Suppress the update where the amendment is           *
      *           generated by assignment.                             *
      *  134480 - Facility amount reduced even if that is a revolving  *
      *           credit facility.                                     *
      *  156296 - Check whether record exists before updating EMXT4F1L*
      *  144712 - Change revolving to non-revolving, changes history  *
      *           Read PF/HISACT also to ensure that FAMT is updated  *
      *           correctly.                                          *
      *  146936 - Non-revolving credit facility overdrawn due to      *
      *           multi-ccy rollover.                                 *
      *  110625 - Update the facility amount of the non-revolving      *
      *           facility if a loan with repayment is reversed.       *
      *           APPLY 097133                                         *
      *  112590 - Update the OAMx fields if RUNx dates are greater    **
      *           than or equal to the facility expiry date.          **
      *  CLE005 - Customer Lending Enhancements - Others              *
      *  125188 - Principal transfer incorrectly processed             *
      *  CLE004 - Customer Lending Enhancements - Syndications         *
      *  092501 - HASH TOTAL UPDATED INCORRECTLY                       *
      *  087943 - If the facility being processed has an expiry date   *
      *           less than the ECD (perhaps because client has        *
      *           skipped working days), do not update the Exposure    *
      *           file; use the same date check as LE0485 which sets   *
      *           up file EMTX4F1, else DB error may occur.            *
      *  081634 - Remove code that sets Facility amount for Expired    *
      *           facility to 1 unit rather than 0, to avoid division  *
      *           by 0 in other programs as this will not happen.      *
      *  S01518 - BLI Lending SWIFT Enhancements.                      *
      *           Recompiled over amended PF/LOAMSDK whose format is  *
      *           used by LF/ACTN7L1.                                 *
      *  052132 - Overflow on every line after first page break. Set  *
      *           off overflow indicator once write header.            *
      *  E30169 - OAM from FCLTYFN incorrect for non-revolver          *
      *           Note only changed for F facilities as calc.          *
      *           different in LE0490.                                 *
      *  E30168 - Reduce facility availability for EM                  *
      *  E29401 - Ignore Parts Sold i.e. processing type 66 and 67     *
      *                                                                *
      ******************************************************************
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
      *                                                               *
      ******************************************************************
      *
     FFCLTY   UF  E           K        DISK
     F            FCLTYHHF                          KIGNORE
      * Facilities 'A' & 'B' records
      *
     FPEFCLFL1IF  E           K        DISK                               167172
     F            FCLTYFMF                          KRENAMEPEFCLFMF       167172
      * Closed/Reversed Facilities 'A' record                             167172
      *                                                                   167172
     FSDBANKPDIF  E           K        DISK
      * Bank Details
      *
     FSDGELRPDIF  E           K        DISK                                                   199220
      * General Ledger Details                                                                199220
      *                                                                                       199220
     FACTN7L1 IP  E           K        DISK
      * Actions Today
      *
     FHISUPD  IF  E           K        DISK
     F*********** HISACTF                           KIGNORE               144712
      ** Facility History Amounts
      *
     FPETEMPLNIF  E           K        DISK
      * Saved Copy of CLOANCL
      *
     FEMXT4F1LUF  E           K        DISK                           UC  E30168
      * Exposure facilities file                                          E30168
      *
     FLECARDPDO   E                    DISK         KINFSR *PSSR      UC  CLE005
      ** Credit Agreement Reduction Extract File                          CLE005
      *                                                                   CLE005
     FLETRAGL0IF  E           K        DISK                                                   CLE041
      ** Tranche-Aggregate Facilities Relationship                                            CLE041
      *                                                                                       CLE041
     FLEAGRDPDO   E                    DISK         KINFSR *PSSR      UC                      CLE041
      ** Aggregate Facility Reduction Extract File                                            CLE041
      *                                                                                       CLE041
     FCLOAN   IF  E           K        DISK                               146936
     F            CLOANCLF                          KRENAMECLOANCL        146936
     F            CLOANHHF                          KIGNORE               146936
     F            CLOANCKF                          KIGNORE               146936
     F            CLOANZ1F                          KIGNORE               146936
      *                                                                   146936
     F***SDCURRPDIF**E                    DISK                                         162343 199588
     FSDCURRPDIF  E                    DISK                           UC                      CSC042
     FLEACPDPDIF  E                    DISK         KINFSR *PSSR A                            CLE134
     F            LOAMSDKF                          KRENAMEACTNPDKF                           CLE134
     FLELOMKL5IF  E           K        DISK                                                 AR649939
     F            LOAMSDKF                          KRENAMELOMNEWF                          AR649939
     FHISACTL2IF  E           K        DISK                                                 MD056601
     F            HISACTF                           KRENAMEH2SACTF                          MD056601
     FLEFCLTLGIF  E           K        DISK         KINFSR *PSSR      UC                      CLE138
      ** LE Facility Extension Detail File                                                    CLE138
      *                                                                                       CLE138
     FCLOANFL2IF  E           K        DISK         KINFSR *PSSR                           AR1078902
     F            CLOANCLF                          KRENAMECLOANF2                         AR1078902
     F            LOAMSDKF                          KIGNORE                                AR1078902
     FLER020P1O   E             50     PRINTER      KINFDS SPOOL      UC
      * Main report of Facility Reductions due to Repayments
      *
     FLER020AUO   E                    PRINTER      KINFDS SPOOLU
      * Audit report of Facility Reductions due to Repayments
      *
     F*****************************************************************
     F*   FUNCTION OF INDICATORS
     F*
     F* 01    ON = NOT first cycle
     F* 02    Multibranching environment
     F**03****Currency*array*set*up*******************************                     162343 199588
     F* 10    LOAMSDK format read from ACTN7 file
      **11****Format*for*Facilities*History*Action*File***********  144712161452
      **12****Format*for*History*Action*File**********************  144712161452
      * 11    Format for Facilities History Action File                   179594
      * 12    Format for History Action File                              179594
      * 13    Record not found in HISUPD                              *   144712
     F**14****LOKUP*of*CURR*array*for*to*currency**********************                162343 199588
     F**15****LOKUP*of*CURR*array*for*from*currency********************                162343 199588
     F* 20    Detail report spool file open
     F* 50    Overflow on detail report
     F* 60    0 decimal places
     F* 61    1 decimal place
     F* 62    2 decimal places
     F* 63    3 decimal places
     F* 64    Revolving Cr ind on FCLTY different to that on HISUPD
     F* 80    CHAIN fail on FCLTY
     F* 81    CHAIN fail on PETEMPLN
     F* 83    No FCLTYZZ record found
     F* 99    Beg. of file on HISUPD, or No SDBANKPD record found
     F* U7&U8 Database error
     F*
     F*****************************************************************
     F*
     F* Subroutine Index
     F*
     F* B0000 - Initialisation subroutine
     F* C0000 - Subroutine to update facility records
     F* D0000 - Subroutine to update facility trailer & update records
     F* GETCCY- Subroutine to obtain currency details
     F*  SRCAUP  -  Credit Agreement Update Processing                *   CLE005
      ***SRCONV*-*Subroutine*to*convert*amount*to*another*currency*****                162343 199588
     F*  SRMOVE  -  Subroutine to move fields to PF/LECARDPD          *   CLE005
     F* ZSFILE- P1 report control by RCF
     F* ZSFAU - AU report control by RCF
      ***ZXRATE*-*Access*Holidays*for*Currency/Location****************                162343 199588
      ***ZCONV**-*Convert*Amount*to*Another Currency*******************                162343 199588
     F* *PSSR - Abnormal error handling subroutine
     F*
     F*****************************************************************
     F/EJECT
     E                    CPY@    1   1 80               Copyright Statement
     E**********          INT         6 15 0             ZHASH INTEGERS   000035
     E**********          DEC         6  3 0             ZHASH DECIMALS   000035
     E***********         POWR    1   7  7 3             POWERS OF TEN    162343
     E                    POWER   1   7  7 3             Powers of Ten    162343
     E**********          CURR      150  3               All CCYS                      162343 199588
     E**********          CSPT      150 13 8             Spot Rates/CCY                162343 199588
     E**********          MTDV      150  1               M/D Indicator/CCY             162343 199588
     E**********          CCDP      150  1 0             Dec Places/CCY                162343 199588
     E**********          CCNO      150  2 0             Sort Seq.No/CCY               162343 199588
     E                    CURR      150  3               All CCYS                             CSC042
     E                    CCDP      150  1 0             Dec Places/CCY                       CSC042
      *
     E/EJECT
      *
     I****FACHISAF    11                                            144712161452
     I****HISACTF     12                                            144712161452
      ***HISUPD*Formats*******************************************  144712161452
      *****                                                         144712161452
     IFACHISAF    11                                                      179594
     IHISACTF     12                                                      179594
      *  HISUPD Formats                                                   179594
      *                                                                   179594
     ILOAMSDKF    10
      * Format from ACTN7
     I******************                            BRCA  L1              00024
     I                                              FCLB  L1              00024
     I                                              FCUS  L1
     I                                              FTYP  L1
     I                                              FSEQ  L1
     IACTN1DNF
     I              FCUS                            FCUS2
     I              FACT                            FACT2
     I              FCNO                            FCNO2
      *
     ICLOANCLF                                                            CLE005
      ** Rename RAMT to avoid overriding of value                         CLE005
      *                                                                   CLE005
     I              RAMT                            LRAMT                 CLE005
     I              VDAT                            LVDAT                 CLE005
     I              AUTO                            LAUTO                                   AR567487
      *                                                                   146936
     ICLOANCL                                                             146936
      ** Rename FCCY And RAMT to avoid overriding of value                146936
      *                                                                   146936
     I              FCCY                            LFCCY                 146936
     I              RAMT                            LRAMT                 146936
      *                                                                                     AR649939
     ILOMNEWF                                                                               AR649939
     I              RECI                            RECI2                                   AR649939
     I              LNRF                            LNRF2                                   AR649939
     I              VDAT                            VDAT2                                   AR649939
     I              LASN                            LASN2                                   AR649939
     I              MRIN                            MRIN2                                   AR649939
     I              LTYP                            LTYP2                                   AR649939
     I              SUTP                            SUTP2                                   AR649939
     I              PTYP                            PTYP2                                   AR649939
     I              AMTP                            AMTP2                                   AR649939
     I              PRSQ                            PRSQ2                                   AR649939
     I              BRTT                            BRTT2                                   AR649939
     I              RTSP                            RTSP2                                   AR649939
     I              CCY                             CCY2                                    AR649939
     I              PRAM                            PRAM2                                   AR649939
     I              INTA                            INTA2                                   AR649939
     I              WTXA                            WTXA2                                   AR649939
     I              FEAM                            FEAM2                                   AR649939
     I              TAMT                            TAMT2                                   AR649939
     I              BRCA                            BRCA2                                   AR649939
     I              CNUM                            CNUM2                                   AR649939
     I              REPT                            REPT2                                   AR649939
     I              AUTO                            AUTO2                                   AR649939
     I              STAI                            STAI2                                   AR649939
     I              SETP                            SETP2                                   AR649939
     I              OSACQQ                          OSAC2Q                                  AR649939
     I              TSEN                            TSEN2                                   AR649939
     I              FACO                            FACO2                                   AR649939
     I              SPI1                            SPI12                                   AR649939
     I              SPI2                            SPI22                                   AR649939
     I              SPI3                            SPI32                                   AR649939
     I              LAIN                            LAIN2                                   AR649939
     I              BRTE                            BRTE2                                   AR649939
     I              SPIN                            SPIN2                                   AR649939
     I              CALC                            CALC2                                   AR649939
     I              WTIN                            WTIN2                                   AR649939
     I              LLAG                            LLAG2                                   AR649939
     I              LWOI                            LWOI2                                   AR649939
     I              XAVD                            XAVD2                                   AR649939
     I              XASQ                            XASQ2                                   AR649939
     I              FCUS                            FCUS2                                   AR649939
     I              FTYP                            FTYP2                                   AR649939
     I              FSEQ                            FSEQ2                                   AR649939
     I              RLON                            RLON2                                   AR649939
     I              FECD                            FECD2                                   AR649939
     I              PONI                            PONI2                                   AR649939
     I              ACTI                            ACTI2                                   AR649939
     I              CNFY                            CNFY2                                   AR649939
     I              TLXY                            TLXY2                                   AR649939
     I              CBLY                            CBLY2                                   AR649939
     I              INTC                            INTC2                                   AR649939
     I              NACD                            NACD2                                   AR649939
     I              ACBI                            ACBI2                                   AR649939
     I              ZZ001                           ZZ0012                                  AR649939
     I              LSWCC                           LSWC2                                   AR649939
     I              LSWSC                           LSWS2                                   AR649939
     I              OSBR                            OSBR2                                   AR649939
     I              FCLB                            FCLB2                                   AR649939
     I              LSMD                            LSMD2                                   AR649939
     I              REBT                            REBT2                                   AR649939
     I              ZZ034                           ZZ0342                                  AR649939
     I              ORED                            ORED2                                   AR649939
     I              LCD                             LCD2                                    AR649939
     I              CHTP                            CHTP2                                   AR649939
     I              TNLU                            TNLU2                                   AR649939
     I              RSTM                            RSTM2                                   AR649939
     I              RONSQQ                          RONS2Q                                  AR649939
     I              RIBN                            RIBN2                                   AR649939
     I              RIBA                            RIBA2                                   AR649939
     I              ROBN                            ROBN2                                   AR649939
     I              ROCN                            ROCN2                                   AR649939
     I              PSTM                            PSTM2                                   AR649939
     I              PONSQQ                          PONS2Q                                  AR649939
     I              PIBN                            PIBN2                                   AR649939
     I              PIBA                            PIBA2                                   AR649939
     I              POBN                            POBN2                                   AR649939
     I              POCN                            POCN2                                   AR649939
     I              RCRN                            RCRN2                                   AR649939
     I              RCRA                            RCRA2                                   AR649939
     I              RVNO                            RVNO2                                   AR649939
     I              AWBN                            AWBN2                                   AR649939
     I              AWBA                            AWBA2                                   AR649939
     I              BENN                            BENN2                                   AR649939
     I              BENA                            BENA2                                   AR649939
     I              DTP1                            DTP12                                   AR649939
     I              DTP2                            DTP22                                   AR649939
     I              DTP3                            DTP32                                   AR649939
     I              DTP4                            DTP42                                   AR649939
     I              DCHG                            DCHG2                                   AR649939
     I              BTB1                            BTB12                                   AR649939
     I              BTB2                            BTB22                                   AR649939
     I              BTB3                            BTB32                                   AR649939
     I              BTB4                            BTB42                                   AR649939
     I              BTB5                            BTB52                                   AR649939
     I              BTB6                            BTB62                                   AR649939
     I              CVMR                            CVMR2                                   AR649939
     I              FSRP                            FSRP2                                   AR649939
     I              FSGN                            FSGN2                                   AR649939
     I              FPRC                            FPRC2                                   AR649939
     I              COFA                            COFA2                                   AR649939
     I              IRCF                            IRCF2                                   AR649939
     I              FRCF                            FRCF2                                   AR649939
     I              DFTP                            DFTP2                                   AR649939
     I              DFST                            DFST2                                   AR649939
     I              MNSG                            MNSG2                                   AR649939
     I              GASS                            GASS2                                   AR649939
     I              GPRT                            GPRT2                                   AR649939
     I              NRLI                            NRLI2                                   AR649939
     I              ROLN                            ROLN2                                   AR649939
     I              ROSN                            ROSN2                                   AR649939
     I              ROBR                            ROBR2                                   AR649939
     I              RORC                            RORC2                                   AR649939
     I              PDGN                            PDGN2                                   AR649939
     I              GRIN                            GRIN2                                   AR649939
     I              RLCY                            RLCY2                                   AR649939
     I              PNAM                            PNAM2                                   AR649939
     I              PAST                            PAST2                                   AR649939
     I              ASTS                            ASTS2                                   AR649939
     I              IUSR                            IUSR2                                   AR649939
     I              AUSR                            AUSR2                                   AR649939
     I              XUSR                            XUSR2                                   AR649939
     I              PCRF                            PCRF2                                   AR649939
     I              PCOB                            PCOB2                                   AR649939
     I              MTPD                            MTPD2                                   AR649939
     I              PDDI                            PDDI2                                   AR649939
     I              PTDI                            PTDI2                                   AR649939
     I              SCCY                            SCCY2                                   AR649939
     I              ICCY                            ICCY2                                   AR649939
     I              ECIN                            ECIN2                                   AR649939
     I              REPI                            REPI2                                   AR649939
     I              CHDU                            CHDU2                                   AR649939
     I              INTN                            INTN2                                   AR649939
     I              FSPRAM                          FSPR2M                                  AR649939
     I              REXR                            REXR2                                   AR649939
     I              REXI                            REXI2                                   AR649939
     I              PSCY                            PSCY2                                   AR649939
     I              PEXR                            PEXR2                                   AR649939
     I              PEXI                            PEXI2                                   AR649939
     I              STAL                            STAL2                                   AR649939
     I              FRNT                            FRNT2                                   AR649939
     I              AFRT                            AFRT2                                   AR649939
     I              REPA                            REPA2                                   AR649939
     I              TMST                            TMST2                                   AR649939
     I              OSAC                            OSAC2                                   AR649939
     I              RONS                            RONS2                                   AR649939
     I              PONS                            PONS2                                   AR649939
     I              AUTH                            AUTH2                                   AR649939
     I              FRCY                            FRCY2                                   AR649939
     I              FRAM                            FRAM2                                   AR649939
     I              FINT                            FINT2                                   AR649939
     I              FTXA                            FTXA2                                   AR649939
     I              FTOT                            FTOT2                                   AR649939
     I              FPEN                            FPEN2                                   AR649939
     I              BASR                            BASR2                                   AR649939
     I              SLTP                            SLTP2                                   AR649939
     I              SLST                            SLST2                                   AR649939
     I              CLAS                            CLAS2                                   AR649939
     I              DFCL                            DFCL2                                   AR649939
     I              SLCL                            SLCL2                                   AR649939
      *                                                                                     MD056601
     IH2SACTF                                                                               MD056601
     I              BRCA                            B2CA                                    MD056601
     I              HACNUM                          H2CNUM                                  MD056601
     I              HAFCTY                          H2FCTY                                  MD056601
     I              HADATE                          H2DATE                                  MD056601
     I              HASEQ                           H2SEQ                                   MD056601
     I              HALOAN                          H2LOAN                                  MD056601
     I              HAACTN                          H2ACTN                                  MD056601
     I              HAAAMT                          H2AAMT                                  MD056601
     I              HAPART                          H2PART                                  MD056601
     I              HALCRF                          H2LCRF                                  MD056601
     I              GEDT                            G2DT                                    MD056601
     I              QQSQNO                          Q2SQNO                                  MD056601
     I              HAECIN                          H2ECIN                                  MD056601
     I              HARCIN                          H2RCIN                                  MD056601
     I              HAGASS                          H2GASS                                  MD056601
     I              HATRRC                          H2TRRC                                  MD056601
     I              HAOLRC                          H2OLRC                                  MD056601
     I              QQTSEQ                          Q2TSEQ                                  MD056601
     I              HALUCY                          H2LUCY                                  MD056601
     I              HALUAM                          H2LUAM                                  MD056601
     I              HAEXRT                          H2EXRT                                  MD056601
     I              HARTMD                          H2RTMD                                  MD056601
     I              HAPTYP                          H2PTYP                                  MD056601
     I              HARCSI                          H2RCSI                                  MD056601
     I              HALPFI                          H2LPFI                                  MD056601
     I              HADEAL                          H2DEAL                                  MD056601
     I              HAMCY                           H2MCY                                   MD056601
     I              HAACBR                          H2ACBR                                  MD056601
     I              HAACCU                          H2ACCU                                  MD056601
     I              HAACCY                          H2ACCY                                  MD056601
     I              HAACCD                          H2ACCD                                  MD056601
     I              HAACSQ                          H2ACSQ                                  MD056601
     I              HAACNO                          H2ACNO                                  MD056601
     I              HATTEO                          H2TTEO                                  MD056601
     I              HAPTEO                          H2PTEO                                  MD056601
     I              HAEXCY                          H2EXCY                                  MD056601
     I              HATVAL                          H2TVAL                                  MD056601
     I              HAWEIG                          H2WEIG                                  MD056601
     I              HAWCPC                          H2WCPC                                  MD056601
     I              HAINOF                          H2INOF                                  MD056601
     I              HAFXMT                          H2FXMT                                  MD056601
     I              HAFXPC                          H2FXPC                                  MD056601
     I              HARIND                          H2RIND                                  MD056601
     I              HASQNO                          H2SQNO                                  MD056601
     I              HATSEQ                          H2TSEQ                                  MD056601
      *                                                                                    AR1078902
     ICLOANF2                                                                              AR1078902
     I              RECI                            RECIL2                                 AR1078902
     I              LNRF                            LNRFL2                                 AR1078902
     I              BRCA                            BRCAL2                                 AR1078902
     I              FCUS                            FCUSL2                                 AR1078902
     I              FTYP                            FTYPL2                                 AR1078902
     I              FSEQ                            FSEQL2                                 AR1078902
     I              PSTM                            PSTML2                                 AR1078902
     I              RSTM                            RSTML2                                 AR1078902
     I              OSDB                            OSDBL2                                 AR1078902
     I              OMDB                            OMDBL2                                 AR1078902
     I              OSDA                            OSDAL2                                 AR1078902
     I              PONS                            PONSL2                                 AR1078902
     I              OMDA                            OMDAL2                                 AR1078902
     I              RONS                            RONSL2                                 AR1078902
     I              GPRT                            GPRTL2                                 AR1078902
     I              TOLN                            TOLNL2                                 AR1078902
     I              LPFI                            LPFIL2                                 AR1078902
     I              PTFC                            PTFCL2                                 AR1078902
     I              PTFT                            PTFTL2                                 AR1078902
     I              PTFN                            PTFNL2                                 AR1078902
      *
     I            DS
      *  Old Facility Amount
     I                                        1  130@DSAMT
     I                                        1  131@DSAM1
     I                                        1  132@DSAM2
     I                                        1  133@DSAM3
      *
     I            DS
      * Reduced Facility Amount
     I                                        1  130@DTAMT
     I                                        1  131@DTAM1
     I                                        1  132@DTAM2
     I                                        1  133@DTAM3
      *
     I            DS
      * Difference
     I                                        1  130@DUAMT
     I                                        1  131@DUAM1
     I                                        1  132@DUAM2
     I                                        1  133@DUAM3
      *
     IPRVKEY      DS
     I**********                              1   60@PFCUS                                    CSD027
     I                                        1   6 @PFCUS                                    CSD027
     I                                        7   90@PFTYP
     I                                       10  110@FSEQ
      *
     INEWKEY      DS
     I* Datastructure for facility key
     I**********                              1   60FCUS                                      CSD027
     I                                        1   6 FCUS                                      CSD027
     I                                        7   90FTYP
     I                                       10  110FSEQ
     I                                        7  110@FAC
     ISPOOL       DS
     I** File Information Data Structure
     I                                       83  92 SFILE
     I                                    B 123 1240SFNUM
     ISPOOLU      DS
     I** File Information Data Structure
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
     I*
     IPSDS       SDS
     I** Program Status
     I*
     I                                      244 253 JOB
     I                                      254 263 USER
      *
     **I/*OPY ZSRSRC,ZHASHZ2
      *
     ILDA       E DSLDA
      * Database Error DS
      *
     IRUNDAT    E DS
     I** Data area RUNDAT
     I              AGMBIN                          MBIN
      *
     IMMOD       UDS                            256                       E30168
     I                                        7   7 EMFLG                 E30168
      *                                                                   E30168
     ILERSTS    E DSLERSTS
     I              FACHISD                         HISDAY
     I              LERC2030                        RENAM1
     I              LERC135                         RENAM2
     I              LERC315                         RENAM3
     I              LERC425                         RENAM4
     I              EOYFLAG                         RENAM5
      *
     ISDBRCH    E DSSDBRCHPD
      ** External DS for branch name details
     I              A8BRNM                          BRNM
      *
     ISDCURR    E DSSDCURRPD
      ** External DS for currency details
      *                                                                   CLE004
     ISCSARD    E DSSCSARDPD                                              CLE004
      ** SAR File Details Accessed via Access Program AOSARDR0            CLE004
     I*
     IDSFDY     E DSDSFDY
     I** First DS for access programs, short data structure
     I*
     IDSSDY     E DSDSSDY
      ** Second DS for access programs, long data structure
      *
     I***/COPY*WNCPYSRC,LEH00965965***                                                        CFC006
     I/COPY WNCPYSRC,LEH00965                                                               MD020563
     I              'LER020001'           C         SECTN                                     CFC006
      *
     C/EJECT
     C************LIKE     DEFN FARCIN    W#RCIN                   161452 179594
     C************LIKE     DEFN FADATE    W#DATE                   161452 179594
      *
     C           KEY001    KLIST                           Key to
     C                     KFLD           FCUS             FCLTY
     C                     KFLD           FTYP
     C                     KFLD           FSEQ
     C                     KFLD           @RTP
      *
     C           HISKEY    KLIST                           Key to
     C**************       KFLD           BRCA             FACHISA       00024
     C                     KFLD           FCLB             FACHISA       00024
     C                     KFLD           FCUS
     C                     KFLD           @FAC
     C                     KFLD           VDAT
      ***********                                                  161452 179594
     C***********HISKY1    KLIST                                   161452 179594
     C***********          KFLD           FCLB                     161452 179594
     C***********          KFLD           FCUS                     161452 179594
     C***********          KFLD           @FAC                     161452 179594
     C***********          KFLD           W#DATE                   161452 179594
      *                                                                   144712
     C           KEY002    KLIST                           Key to         144712
     C                     KFLD           FCLB             HISUPD         144712
     C                     KFLD           FCUS                            144712
     C                     KFLD           @FAC                            144712
     C***********                                                  097133 159015
     C***********HSKEY     KLIST                                   097133 159015
     C***********          KFLD           FCLB                     097133 159015
     C***********          KFLD           FCUS                     097133 159015
     C***********          KFLD           @FAC                     097133 159015
      *
     C           KEY003    KLIST                           Key to         167172
     C                     KFLD           FCLB             PEFCLFM        167172
     C                     KFLD           FCUS                            167172
     C                     KFLD           FTYP                            167172
     C                     KFLD           FSEQ                            167172
      *                                                                                       CLE041
     C           KLFCLT    KLIST                                                              CLE041
     C                     KFLD           FCUS                                                CLE041
     C                     KFLD           FACT                                                CLE041
     C                     KFLD           FCNO                                                CLE041
      *                                                                                     AR649939
     C           KMANL     KLIST                                                            AR649939
     C                     KFLD           BRCA                                              AR649939
     C                     KFLD           LNRF                                              AR649939
     C                     KFLD           VDAT                                              AR649939
     C                     KFLD           LASN                                              AR649939
      *                                                                                       CLE138
     C           KLFEXT    KLIST                                                              CLE138
     C                     KFLD           BRCA                                                CLE138
     C                     KFLD           KCNUM                                               CLE138
     C                     KFLD           KFTYP                                               CLE138
     C                     KFLD           KFCNO                                               CLE138
      *
     C  N01                EXSR B0000                      initialisation
      ***********                                                  161452 179594
     C***********          MOVE 'N'       WCAUP                    161452 179594
     C                     MOVE 'N'       WCAUP                                               208182
     C                     MOVE 'N'       WAGUP                                               CLE041
      *
     C                     ADD  1         @REC    50       Rec count
     C**N10*****           GOTO AEXIT                                                         208203
     C  N10                GOTO AEXIT2                                                        208203
      *                                                                                       263413
      ** Save fields                                                                          263413
      *                                                                                       263413
     C                     Z-ADDPRAM      KPRAM                                               263413
     C                     Z-ADDINTA      KINTA                                               263413
     C                     Z-ADDTAMT      KTAMT                                               263413
      *
     C           RECI      IFNE 'D'
     C           GASS      OREQ 'A'                                       154092
     C                     SUB  1         @REC
     C                     GOTO AEXIT
     C                     END
      *                                                                   E29401
      * Ignore Parts Sold                                                 E29401
      *                                                                   E29401
     C           PTYP      IFEQ 66                                        E29401
     C           PTYP      OREQ 67                                        E29401
      *                                                                   CLE005
      ** If CLE005 is swtiched on, include processing types               CLE005
      ** 69 and 72 on the selection.                                      CLE005
      *                                                                   CLE005
     C           PTYP      OREQ 69                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
     C           PTYP      OREQ 72                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
      *                                                                   CLE005
     C                     SUB  1         @REC                            E29401
     C                     GOTO AEXIT                                     E29401
     C                     END                                            E29401
      *                                                                   CLE004
      ** If CLE004 is installed, check if loan is an internal parts       CLE004
      ** purchased                                                        CLE004
      *                                                                   CLE004
     C           CLE004    IFEQ 'Y'                                       CLE004
     C           PTYP      IFEQ 64                                        CLE004
     C           PTYP      OREQ 65                                        CLE004
      *                                                                   CLE005
      ** If CLE005 is swtiched on, include processing types               CLE005
      ** 68 and 71 on the selection.                                      CLE005
      *                                                                   CLE005
     C           PTYP      OREQ 68                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
     C           PTYP      OREQ 71                                        CLE005
     C           CLE005    ANDEQ'Y'                                       CLE005
      *                                                                   CLE005
      ** Retrieve loan details                                            CLE004
      *                                                                   CLE004
     C           LNRF      CHAINPETEMPLN             81                   CLE004
      *                                                                   CLE004
      ** If not found, db error processing                                CLE004
      *                                                                   CLE004
     C           *IN81     IFEQ '1'                                       CLE004
     C           *LOCK     IN   LDA                        ************   CLE004
     C                     Z-ADD10        DBASE            * DBERR 10 *   CLE004
     C                     MOVEL'CLOAN   'DBFILE           ************   CLE004
     C                     MOVELLNRF      DBKEY                           CLE004
     C                     MOVEL'LER020  'DBPGM                           CLE004
     C                     OUT  LDA                                       CLE004
     C                     EXSR *PSSR                                     CLE004
     C                     EXSR ZSFAU                                     CLE004
     C                     ENDIF                                          CLE004
      *                                                                   CLE004
      ** If loan is an internal parts purchased, do not process loan      CLE004
      ** action                                                           CLE004
      *                                                                   CLE004
     C           LPFI      IFEQ 'I'                                       CLE004
     C                     SUB  1         @REC                            CLE004
     C                     GOTO AEXIT                                     CLE004
     C                     ENDIF                                          CLE004
      *                                                                   CLE004
     C                     ENDIF                                          CLE004
     C                     ENDIF                                          CLE004
      *                                                                   E29401
      ** For PF events, retrieve transfer TO facility details                              AR1078902
      ** to determine if facility amount should be reduced.                                AR1078902
      *                                                                                    AR1078902
     C                     MOVE 'Y'       WPFREC  1                                        AR1078902
     C           AMTP      IFEQ 'PF'                                                       AR1078902
     C           ROLN      CHAINCLOANF2              70                                    AR1078902
     C           *IN70     IFEQ '0'                                                        AR1078902
     C           FCUSL2    ANDEQFCUS                                                       AR1078902
     C           FTYPL2    ANDEQFTYP                                                       AR1078902
     C           FSEQL2    ANDEQFSEQ                                                       AR1078902
     C********** GPRTL2    ANDEQ'Y'                                               AR1078902 MD050153
     C********** TOLNL2    ANDEQLNRF                                              AR1078902 MD050153
     C                     MOVE 'N'       WPFREC                                           AR1078902
     C                     ENDIF                                                           AR1078902
     C                     ENDIF                                                           AR1078902
      *                                                                                    AR1078902
     C           AMTP      IFEQ 'MR'
     C           AMTP      OREQ 'RE'
     C           AMTP      OREQ 'MA'
     C           AMTP      OREQ 'RV'                                      097133
     C/COPY WNCPYSRC,LER020C001
     C***********AMTP      OREQ 'PF'                               CLE004 125188
     C***********CLE004    ANDEQ'Y'                                CLE004 125188
     C           AMTP      OREQ 'PF'                                                       AR1078902
     C           WPFREC    ANDEQ'Y'                                                        AR1078902
      *
      ** IF PDCL and FAMU (Facility Amount Utilisation) is not Y, then                        CLE134
      ** skip process                                                                         CLE134
      *                                                                                       CLE134
     C           CLE134    IFEQ 'Y'                                                           CLE134
      *                                                                                     MD055082
      ** Retrieve loan details for Autosettle Indicator                                     MD055082
      *                                                                                     MD055082
     C           LNRF      CHAINPETEMPLN             81                                     MD055082
      *                                                                                     MD055082
      ** If not found, db error processing                                                  MD055082
      ** ************                                                                       MD055082
      ** * DBERR 13 *                                                                       MD055082
      ** ************                                                                       MD055082
      *                                                                                     MD055082
     C           *IN81     IFEQ '1'                                                         MD055082
     C           *LOCK     IN   LDA                                                         MD055082
     C                     Z-ADD13        DBASE                                             MD055082
     C                     MOVEL'PETEMPLN'DBFILE                                            MD055082
     C                     MOVELLNRF      DBKEY                                             MD055082
     C                     MOVEL'LER020  'DBPGM                                             MD055082
     C                     OUT  LDA                                                         MD055082
     C                     EXSR *PSSR                                                       MD055082
     C                     EXSR ZSFAU                                                       MD055082
     C                     ENDIF                                                            MD055082
      *                                                                                     MD055082
     C                     MOVELLTYP      WTYPE   1                                           CLE134
     C********** WTYPE     IFEQ 'X'                                                    CLE134 263840
     C********** WTYPE     OREQ 'Y'                                                    CLE134 263840
     C           WTYPE     IFEQ 'Y'                                                    CLE134 263840
     C           WTYPE     OREQ 'Z'                                                           CLE134
     C           FAMU      IFNE 'Y'                                                           CLE134
     C                     GOTO AEXIT                                                         CLE134
     C                     ENDIF                                                              CLE134
     C                     ENDIF                                                              CLE134
      *                                                                                     AR649939
     C           NEWCOB    IFEQ 'Y'                                                         AR649939
      *                                                                                     AR649939
      ** Chain LOMNEWF to check if inserted during IC, user not LE0457                      AR649939
      *                                                                                     AR649939
     C           KMANL     CHAINLOMNEWF              17                                     AR649939
     C           *IN17     IFEQ *OFF                                                        AR649939
     C********** IUSR2     ANDNE'LE0457'                                          AR649939 AR1021983
     C********** IUSR2     ANDNE'LE0473'                                          AR649939 AR1021983
     C           FRNT2     ANDNE'LE000457'                                                 AR1021983
     C           FRNT2     ANDNE'LE000473'                                                 AR1021983
     C                     GOTO AEXIT                                                       AR649939
     C                     ENDIF                                                            AR649939
     C                     ENDIF                                                            AR649939
      ****************************************************************             AR567487 MD055082
      ***Retrieve*Loan*details*for*Autosettle*Indicator***************             AR567487 MD055082
      ****************************************************************             AR567487 MD055082
     C********** LNRF      CHAINPETEMPLN             81                            AR567487 MD055082
      ****************************************************************             AR567487 MD055082
      ***If*not*found,*db*error*processing****************************             AR567487 MD055082
      ** *************************************************************             AR567487 MD055082
      ** * DBERR 13 **************************************************             AR567487 MD055082
      ** *************************************************************             AR567487 MD055082
      ****************************************************************             AR567487 MD055082
     C**********  IN81     IFEQ '1'                                                AR567487 MD055082
     C********** *LOCK     IN   LDA                                                AR567487 MD055082
     C**********           Z-ADD13        DBASE                                    AR567487 MD055082
     C**********           MOVEL'PETEMPLN'DBFILE                                   AR567487 MD055082
     C**********           MOVELLNRF      DBKEY                                    AR567487 MD055082
     C**********           MOVEL'LER020  'DBPGM                                    AR567487 MD055082
     C**********           OUT  LDA                                                AR567487 MD055082
     C**********           EXSR *PSSR                                              AR567487 MD055082
     C**********           EXSR ZSFAU                                              AR567487 MD055082
     C**********           ENDIF                                                   AR567487 MD055082
      *                                                                                    AR1036834
      ** On first run of component, if PDCL MR, RE or MA exists                            AR1036834
      ** in ACTN5 (meaning AR786878 is switched off)                                       AR1036834
      ** do update of facility amount to match update in FACHISA                           AR1036834
      ** and prevent output to ACTNPDK.                                                    AR1036834
      *                                                                                    AR1036834
     C                     MOVE 0         *IN30                                            AR1036834
     C           NEWCOB    IFEQ 'N'                                                        AR1036834
     C           LAUTO     ANDEQ'C'                                                        AR1036834
     C           AMTP      ANDNE'RV'                                                       AR1036834
     C           WTYPE     IFEQ 'X'                                                        AR1036834
     C           WTYPE     OREQ 'Y'                                                        AR1036834
     C           WTYPE     OREQ 'Z'                                                        AR1036834
     C                     MOVE '1'       *IN30                                            AR1036834
     C                     ENDIF                                                           AR1036834
     C                     ENDIF                                                           AR1036834
      *                                                                                     MD040535
     C**********           MOVE '0'       *IN30                                    MD040535 MD051329
     C           NEWCOB    IFEQ 'N'                                                         MD040535
     C           LAUTO     ANDEQ'C'                                                         MD040535
     C           AUTO      ANDNE'C'                                                         MD040535
     C           AMTP      ANDNE'RV'                                                        MD040535
     C           WTYPE     IFNE 'X'                                                         MD040535
     C           WTYPE     ANDNE'Y'                                                         MD040535
     C           WTYPE     ANDNE'Z'                                                         MD040535
     C                     MOVE '1'       *IN30                                             MD040535
     C                     ENDIF                                                            MD040535
     C                     ENDIF                                                            MD040535
      *                                                                                     MD050278
     C           NEWCOB    IFEQ 'N'                                                         MD050278
     C           LAUTO     ANDEQ'C'                                                         MD050278
     C           AUTO      ANDEQ'C'                                                         MD050278
     C           AMTP      ANDNE'RV'                                                        MD050278
      *                                                                                     MD050278
     C                     EXSR RTVSA                                                       MD050278
      *                                                                                     MD050278
     C           WTYPE     IFNE 'X'                                                         MD050278
     C           WTYPE     ANDNE'Y'                                                         MD050278
     C           WTYPE     ANDNE'Z'                                                         MD050278
     C           OATYP     ANDEQ'N'                                                         MD050278
     C                     MOVE '1'       *IN30                                             MD050278
     C                     ENDIF                                                            MD050278
     C                     ENDIF                                                            MD050278
      *                                                                                       CLE134
     C           NEWCOB    IFEQ 'N'                                                           CLE134
     C********** AUTO      ANDEQ'C'                                                  CLE134 AR567487
     C           LAUTO     ANDEQ'C'                                                         AR567487
     C           KPRAM     ANDGE0                                                           AR806351
     C           KINTA     ANDGE0                                                           AR806351
     C           *IN30     ANDEQ'0'                                                         MD040535
     C           AMTP      IFEQ 'MR'                                                          CLE134
     C           AMTP      OREQ 'RE'                                                          CLE134
     C           AMTP      OREQ 'MA'                                                          263413
     C                     Z-ADDKPRAM     PRAM                                                263413
     C                     Z-ADDKTAMT     TAMT                                                263413
     C                     Z-ADDKINTA     INTA                                                263413
     C                     WRITEACTNPDKF                                                      CLE134
     C                     GOTO AEXIT                                                         CLE134
     C                     ENDIF                                                              CLE134
     C                     ENDIF                                                              CLE134
      *                                                                                       CLE134
     C                     ENDIF                                                              CLE134
      *                                                                                       CLE134
     C           AMTP      IFEQ 'MA'
     C           AUTO      CABEQ'N'       AEXIT
     C                     END
      *                                                                   CLE005
     C           CLE005    IFEQ 'Y'                                       CLE005
     C                     MOVE 'Y'       WCAUP   1                       CLE005
     C                     MOVE 'Y'       WAGUP   1                                           CLE041
     C                     ENDIF                                          CLE005
      *
      * Check for live facility                                           167172
     C           PRVKEY    IFNE NEWKEY
     C                     MOVE NEWKEY    PRVKEY
     C           KEY001    CHAINFCLTY                80
      *
      * else check for closed/reversed facility                           167172
     C           *IN80     IFEQ '1'                                       167172
     C           KEY003    CHAINPEFCLFL1             80                   167172
      *                                                                   167172
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD1         DBASE            * DBERROR 001 *
     C                     MOVEL'FCLTY   'DBFILE           ***************
     C                     MOVELNEWKEY    DBKEY
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
      *                                                                   167172
      * If closed/reversed facility, skip processing for this record      167172
     C                     ELSE                                           167172
     C**********           GOTO AEXIT                                     167172              208182
     C                     GOTO AEXIT2                                                        208182
     C                     END                                            167172
     C                     END
      *C
     C                     END
      *
      * IF THE ACTION IS BACKVALUED, CHECK WHETHER THE FACILITY WAS
      * REVOLVING OR NONREVOLVING ON THE DATE OF THE TRANSACTION IN
      * ORDER TO DETERMINE WHETHER THE FACILITY NEEDS TO BE REDUCED
      *
     C           AMTP      IFNE 'RV'                                      097133
     C***********VDAT      IFLT BJRDNB                                    161452
     C***********VDAT      IFLE BJRDNB                             161452 179594
     C           VDAT      IFLT BJRDNB                                    179594
     C           VDAT      ORLE BKAPDT                                                        199220
     C           BKAPFQ    ANDEQ'D'                                                           199220
     C           VDAT      IFLT HISDAY
     C                     MOVE HISDAY    VDAT
     C                     END
     C***********HISKEY    SETGTHISUPD                                    144712
     C***********          READPHISUPD                   99               134480
     C***********HISKEY    REDPEHISUPD                   99        134480 144712
     C************IN99     IFEQ '1'                                       144712
     C***********RVCR      CABEQ'Y'       AEXIT                           144712
     C***********          ELSE                                           144712
     C************IN64     IFEQ '0'                                       144712
     C***********FARCIN    COMP RVCR                 6464                 144712
     C***********          END                                            144712
     C***********FARCIN    CABEQ'Y'       AEXIT                           144712
     C***********          END                                            144712
      ***********                                                  161452 179594
     C***********          MOVE RVCR      W#RCIN                   161452 179594
     C***********          MOVE *ZEROS    W#DATE                   161452 179594
      ***********                                                  161452 179594
      **Get*the*last*Revolving*Credit*Change*(on*history*action)***161452 179594
      **reading*backwards*from*the*value*date*of*the*current*action161452 179594
     C***********HISKEY    SETGTHISUPD                             161452 179594
     C***********KEY002    REDPEHISACTF                  13        161452 179594
      ***********                                                  161452 179594
     C************IN13     DOWEQ*OFF                               161452 179594
     C***********HAACTN    IFEQ 'RC'                               161452 179594
     C***********          MOVE HARCIN    W#RCIN                   161452 179594
     C***********          MOVE HADATE    W#DATE                   161452 179594
     C***********          LEAVE                                   161452 179594
     C***********          ENDIF                                   161452 179594
     C***********KEY002    REDPEHISACTF                  13        161452 179594
     C***********          ENDDO                                   161452 179594
      ***********                                                  161452 179594
      **If*no*RC*found*access*the*last*record*on*the*existing*histo161452 179594
      **prior*to*(and*including)*the*action*date.******************161452 179594
     C***********W#DATE    IFEQ *ZEROS                             161452 179594
     C***********HISKEY    SETGTHISUPD                             161452 179594
     C***********KEY002    REDPEFACHISAF                 13        161452 179594
     C************IN13     IFEQ *OFF                               161452 179594
     C***********          MOVE FARCIN    W#RCIN                   161452 179594
     C***********          ENDIF                                   161452 179594
      ***********                                                  161452 179594
      **Otherwise,*read*through*existing*history*from*after*this*da161452 179594
      **and*check*for*a*subsequent*RC.*****************************161452 179594
     C***********          ELSE                                    161452 179594
     C***********HISKY1    SETGTHISUPD                             161452 179594
     C***********KEY002    READEFACHISAF                 13        161452 179594
      ***********                                                  161452 179594
     C************IN13     DOWEQ*OFF                               161452 179594
     C***********FADATE    IFGT VDAT                               161452 179594
     C***********          LEAVE                                   161452 179594
     C***********          ENDIF                                   161452 179594
     C***********FAACTN    IFEQ 'RC'                               161452 179594
     C***********          MOVE FARCIN    W#RCIN                   161452 179594
     C***********          ENDIF                                   161452 179594
     C***********KEY002    READEFACHISAF                 13        161452 179594
     C***********          ENDDO                                   161452 179594
     C***********          ENDIF                                   161452 179594
      ***********                                                  161452 179594
     C***********W#RCIN    CABEQ'Y'       AEXIT                    161452 179594
      ***********                                                  161452 179594
     C***********HISKEY    SETLLHISUPD                              144712161452
     C***********          MOVEA'00'      *IN,11                    144712161452
     C***********          READ HISUPD                   13         144712161452
      ***********                                                   144712161452
     C************IN13     DOUEQ'1'                                 144712161452
      ***********                                                   144712161452
     C************IN11     IFEQ '1'                                 144712161452
     C***********          MOVE FAACTN    WKACTN  2                 144712161452
     C***********          MOVE FADATE    WKDATE  50                144712161452
     C***********          MOVE FARCIN    WKRCIN  1                 144712161452
     C***********          ENDIF                                    144712161452
      ***********                                                   144712161452
     C************IN12     IFEQ '1'                                 144712161452
     C***********          MOVE HAACTN    WKACTN  2                 144712161452
     C***********          MOVE HADATE    WKDATE  50                144712161452
     C***********          MOVE HARCIN    WKRCIN  1                 144712161452
     C***********          ENDIF                                    144712161452
      ***********                                                   144712161452
     C***********WKACTN    IFEQ 'RC'                                144712161452
     C***********          LEAVE                                    144712161452
     C***********          ENDIF                                    144712161452
      ***********                                                   144712161452
     C***********          MOVEA'00'      *IN,11                    144712161452
     C***********KEY002    READEHISUPD                   13         144712161452
     C***********          ENDDO                                    144712161452
      ***********                                                   144712161452
     C***********FCLB      IFEQ WKFCLB                              144712161452
     C***********FCUS      ANDEQWKFCUS                              144712161452
     C***********@FAC      ANDEQWK@FAC                              144712161452
      ***********                                                   144712161452
     C***********VDAT      IFGT WKDATE                              144712161452
     C***********WKRCIN    CABEQ'Y'       AEXIT                     144712161452
     C***********          ENDIF                                    144712161452
      ***********                                                   144712161452
     C***********VDAT      IFGT WKDAT2                              144712161452
     C***********VDAT      ANDLEWKDATE                              144712161452
     C***********WKRVCR    CABEQ'Y'       AEXIT                     144712161452
     C***********          ELSE                                     144712161452
     C***********RVCR      CABEQ'Y'       AEXIT                     144712161452
     C***********          ENDIF                                    144712161452
      ***********                                                   144712161452
     C***********          ELSE                                     144712161452
     C***********          MOVE FCLB      WKFCLB  3                 144712161452
     C***********          MOVE FCUS      WKFCUS  60                144712161452
     C***********          MOVE @FAC      WK@FAC  50                144712161452
     C***********          MOVE WKRCIN    WKRVCR  1                 144712161452
     C***********          MOVE WKDATE    WKDAT2  50                144712161452
     C***********RVCR      CABEQ'Y'       AEXIT                     144712161452
     C***********          ENDIF                                    144712161452
      ***********                                                   144712161452
     C***********          ELSE                                           161452
     C***********RVCR      CABEQ'Y'       AEXIT                           161452
     C                     MOVE 'N'       WRCCHG  1                                           203521
     C                     MOVE WKRCIN    WREVIN  1                                           203521
     C                     MOVE *BLANKS   WKFCLB  3                                           203521
     C**********           Z-ADD*ZEROS    WKFCUS  60                                   203521 CSD027
     C                     MOVE *BLANKS   WKFCUS  6                                           CSD027
     C                     Z-ADD*ZEROS    WK@FAC  50                                          203521
      ***********                                                                    203521 MD056601
      ***Read*through*HISUPD*to*retrieve*the*latest*RC*action*and*use**              203521 MD056601
      ***this*as*the*Revolving*credit*indicator************************              203521 MD056601
      ***********                                                                    203521 MD056601
     C********** HISKEY    SETLLHISUPD                                                 179594 203521
     C********** KEY002    SETLLHISUPD                                               203521 MD056601
     C**********           MOVEA'00'      *IN,11                                     179594 MD056601
     C**********           READ HISUPD                   13                            179594 203521
     C********** KEY002    READEHISUPD                   13                          203521 MD056601
     C********** *IN13     IFEQ '0'                                                  203521 MD056601
     C********** *IN11     IFEQ '1'                                                  203521 MD056601
     C**********           MOVE FADATE    WKDATE  50                                 203521 MD056601
     C**********           ELSE                                                      203521 MD056601
     C**********           MOVE HADATE    WKDATE                                     203521 MD056601
     C**********           ENDIF                                                     203521 MD056601
     C**********           ENDIF                                                     203521 MD056601
      **********                                                                     179594 MD056601
     C********** *IN13     DOUEQ'1'                                                    179594 203521
     C********** *IN13     DOWEQ'0'                                                  203521 MD056601
     C********** VDAT      ANDGEWKDATE                                               203521 MD056601
      **********                                                                     179594 MD056601
     C********** *IN11     IFEQ '1'                                                  179594 MD056601
     C**********           MOVE FAACTN    WKACTN  2                                  179594 MD056601
     C***********          MOVE FADATE    WKDATE  50                                   179594 203521
     C**********           MOVE FARCIN    WKRCIN  1                                  179594 MD056601
     C**********           MOVE BRCA      WKFCLB                                     203521 MD056601
     C**********           MOVE FACNUM    WKFCUS                                     203521 MD056601
     C**********           MOVE FAFCTY    WK@FAC                                     203521 MD056601
     C**********           ENDIF                                                     179594 MD056601
      **********                                                                     179594 MD056601
     C********** *IN12     IFEQ '1'                                                  179594 MD056601
     C**********           MOVE HAACTN    WKACTN  2                                  179594 MD056601
     C**********           MOVE HADATE    WKDATE  50                                   179594 203521
     C**********           MOVE HARCIN    WKRCIN  1                                  179594 MD056601
     C**********           MOVE BRCA      WKFCLB                                     203521 MD056601
     C**********           MOVE HACNUM    WKFCUS                                     203521 MD056601
     C**********           MOVE HAFCTY    WK@FAC                                     203521 MD056601
     C**********           ENDIF                                                     179594 MD056601
      **********                                                                     179594 MD056601
     C********** WKACTN    IFEQ 'RC'                                                 179594 MD056601
     C**********           LEAVE                                                       179594 203521
     C**********           MOVE 'Y'       WRCCHG                                     203521 MD056601
     C**********           MOVE WKRCIN    WREVIN                                     203521 MD056601
     C**********           ENDIF                                                     179594 MD056601
      **********                                                                     179594 MD056601
     C**********           MOVEA'00'      *IN,11                                     179594 MD056601
     C********** KEY002    READEHISUPD                   13                          179594 MD056601
     C********** *IN13     IFEQ '0'                                                  203521 MD056601
     C********** *IN11     IFEQ '1'                                                  203521 MD056601
     C**********           MOVE FADATE    WKDATE                                     203521 MD056601
     C**********           ELSE                                                      203521 MD056601
     C**********           MOVE HADATE    WKDATE                                     203521 MD056601
     C**********           ENDIF                                                     203521 MD056601
     C**********           ENDIF                                                     203521 MD056601
     C**********           ENDDO                                                     179594 MD056601
      *                                                                                     MD056601
     C           HISKEY    SETGTHISACTL2                                                    MD056601
     C           KEY002    REDPEHISACTL2                 18                                 MD056601
     C           *IN18     DOWEQ'0'                                                         MD056601
     C           H2ACTN    IFEQ 'RC'                                                        MD056601
     C                     MOVE B2CA      WKFCLB                                            MD056601
     C                     MOVE H2CNUM    WKFCUS                                            MD056601
     C                     MOVE H2FCTY    WK@FAC                                            MD056601
     C                     MOVE H2RCIN    WREVIN                                            MD056601
     C                     MOVE 'Y'       WRCCHG                                            MD056601
     C                     LEAVE                                                            MD056601
     C                     ENDIF                                                            MD056601
     C           KEY002    REDPEHISACTL2                 18                                 MD056601
     C                     ENDDO                                                            MD056601
      *                                                                                     MD056601
     C           WRCCHG    IFEQ 'N'                                                         MD056601
     C           HISKEY    SETGTHISUPD                                                      MD056601
     C           KEY002    REDPEFACHISAF                 19                                 MD056601
     C           *IN19     IFEQ '1'                                                         MD056601
     C           RVCR      CABEQ'Y'       AEXIT                                             MD056601
     C                     ELSE                                                             MD056601
     C                     MOVE FARCIN    WKRCIN  1                                         MD056601
     C                     MOVE BRCA      WKFCLB                                            MD056601
     C                     MOVE FACNUM    WKFCUS                                            MD056601
     C                     MOVE FAFCTY    WK@FAC                                            MD056601
     C                     ENDIF                                                            MD056601
     C                     ENDIF                                                            MD056601
      *                                                                   179594
     C           FCLB      IFEQ WKFCLB                                    179594
     C           FCUS      ANDEQWKFCUS                                    179594
     C           @FAC      ANDEQWK@FAC                                    179594
      *                                                                   179594
     C********** VDAT      IFGT WKDATE                                                 179594 203521
     C           WRCCHG    IFEQ 'Y'                                                           203521
     C           WREVIN    CABEQ'Y'       AEXIT                                               203521
     C                     ELSE                                                               203521
     C           WKRCIN    CABEQ'Y'       AEXIT                           179594
     C                     ENDIF                                          179594
      *                                                                   179594
     C********** VDAT      IFGT WKDAT2                                                 179594 203521
     C********** VDAT      ANDLEWKDATE                                                 179594 203521
     C********** WKRVCR    CABEQ'Y'       AEXIT                                        179594 203521
     C**********           ELSE                                                        179594 203521
     C********** RVCR      CABEQ'Y'       AEXIT                                        179594 203521
     C**********           ENDIF                                                       179594 203521
      *                                                                   179594
     C                     ELSE                                           179594
     C**********           MOVE FCLB      WKFCLB  3                                    179594 203521
     C**********           MOVE FCUS      WKFCUS  60                                   179594 203521
     C**********           MOVE @FAC      WK@FAC  50                                   179594 203521
     C**********           MOVE WKRCIN    WKRVCR  1                                    179594 203521
     C**********           MOVE WKDATE    WKDAT2  50                                   179594 203521
     C           RVCR      CABEQ'Y'       AEXIT                           179594
     C                     ENDIF                                          179594
      *                                                                   179594
     C                     ELSE                                           179594
     C           RVCR      CABEQ'Y'       AEXIT                           179594
     C                     END
     C                     ELSE                                           097133
     C*                                                                   097133
     C** For reversal, facility amount reduced by repayment of loan       097133
     C** should be updated.                                               097133
     C*                                                                   097133
     C***********HSKEY     SETLLHISUPD                             097133 159015
     C***********HSKEY     READEHISUPD                   99        097133 159015
     C           KEY002    SETLLHISUPD                                    159015
     C***********KEY002    READEHISUPD                   99         159015161452
     C***********KEY002    READEFACHISAF                 99        161452 179594
     C********** KEY002    READEHISUPD                   99                            179594 255932
     C           KEY002    READEFACHISAF                 99                                   255932
     C                     Z-ADD0         @AMNT  130                      097133
     C*                                                                   097133
     C** Retrieve the repayments done on the loan only if the facility    097133
     C** is non-revolving.                                                097133
      ***The*above*is*true*for*updates*to*the*current*facility.****161452 179594
      ***However,*if*this*is*a*tranche*write*to*lecardpd*at*this*po161452 179594
      ***ler022*will*decide*whether*the*credit*agreement*is*updated161452 179594
     C*                                                                   097133
     C           *IN99     DOWEQ'0'                                       097133
     C           LNRF      IFEQ FALOAN                                    097133
     C***********FARCIN    ANDEQ'N'                                 097133161452
     C***********FAGASS    ANDNE'A'                                161452 179594
     C           FARCIN    ANDEQ'N'                                       179594
     C           FAACTN    IFEQ 'MR'                                      097133
     C           FAACTN    OREQ 'RE'                                      097133
     C           FAACTN    OREQ 'PF'                                                       AR1078902
     C           FALCRF    ANDEQ'     Y'                                                   AR1078902
      ***********                                                  161452 179594
     C***********FARCIN    IFEQ 'N'                                161452 179594
     C                     ADD  FAAAMT    @AMNT                           097133
     C***********          ENDIF                                   161452 179594
     C***********TRCA      IFEQ 'TR'                               161452 179594
     C***********WCAUP     ANDEQ'Y'                                161452 179594
     C***********          MOVE FADATE    VDAT                     161452 179594
     C***********          EXSR SRCAUP                             161452 179594
     C***********          ENDIF                                   161452 179594
     C                     END                                            097133
      ***********                                                  161452 179594
     C                     END                                            097133
     C***********HSKEY     READEHISUPD                   99        097133 159015
     C***********KEY002    READEHISUPD                   99         159015161452
     C***********KEY002    READEFACHISAF                 99        161452 179594
     C********** KEY002    READEHISUPD                   99                            179594 255932
     C           KEY002    READEFACHISAF                 99                                   255932
     C                     END                                            097133
     C           @AMNT     IFNE 0                                         097133
     C                     Z-SUB@AMNT     PRAM                            097133
     C                     ELSE                                           097133
     C**********           GOTO AEXIT                                     097133              208182
     C                     GOTO AEXIT2                                                        208182
     C                     END                                            097133
     C                     END                                            097133
      *
     C           CCY       IFNE FCCY
     C***********AMTP      ANDNE'RV'                               161452 179594
     C           LNRF      CHAINPETEMPLN             81
      *
     C           *IN81     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD2         DBASE            * DBERROR 002 *
     C                     MOVEL'CLOAN   'DBFILE           ***************
     C                     MOVELLNRF      DBKEY
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
     C                     END
      *
      ** Get Facility Currency details
      *
     C                     MOVE FCCY      KEYCCY  3
     C                     EXSR GETCCY
     C                     MOVE A6NBDP    FCDP    10
      *
      ** Get Currency details
      *
     C                     MOVE CCY       KEYCCY
     C                     EXSR GETCCY
     C           FCDP      SUB  A6NBDP    DP      10
     C                     ADD  4         DP
      *****************************************************************                162349 199588
      ***Use*spot*rate*instead*of*facility*ccy*exchange*rate*in********                162343 199588
      ***converting*amount*to*it's*facility*currency.******************                162343 199588
      *****************************************************************                162343 199588
     C**********           EXSR SRCONV                                                 162343 199588
      *****************************************************************                162343 199588
     C***********FMDI      IFEQ 'D'                                       162343
     C***********FCXR      DIV  POWR,DP   FCXRT  159H                     162343
     C***********1         DIV  FCXRT     FCXRT                           162343
     C***********          ELSE                                           162343
     C***********FCXR      MULT POWR,DP   FCXRT     H                     162343
     C***********          END                                            162343
     C***********PRAM      MULT FCXRT     @AMT   130H                     162343
      *                                                                                       199588
     C           FMDI      IFEQ 'D'                                                           199588
     C           FCXR      DIV  POWER,DP  FCXRT  159H                                         199588
     C           PRAM      DIV  FCXRT     @AMT   130H                                         246032
     C********** 1         DIV  FCXRT     FCXRT                                        199588 224974
     C********** 1         DIV  FCXRT     FCXRT     H                                  224974 246032
     C                     ELSE                                                               199588
     C           FCXR      MULT POWER,DP  FCXRT     H                                         199588
     C           PRAM      MULT FCXRT     @AMT      H                                         246032
     C                     ENDIF                                                              199588
     C********** PRAM      MULT FCXRT     @AMT   130H                                  199588 246032
     C                     ELSE
     C                     Z-ADDPRAM      @AMT   130
     C                     END
     C/COPY WNCPYSRC,LEH01406
     C                     ADD  @AMT      @AMTA  130       Tot for fac.
     C/COPY WNCPYSRC,LEH01407
     C*
     C                     END
      *                                                                   146936
      ** Updat facility amount if there's a multi-ccy rollover            146936
      *                                                                   146936
     C           CEU020    IFEQ 'Y'                                       146936
     C           AMTP      ANDEQ'MC'                                      146936
     C           ECIN      ANDEQ'Y'                                       146936
     C           AMTP      OREQ 'MC'                                                          193859
      *                                                                   192329
     C           CLE005    IFEQ 'Y'                                       192329
     C                     MOVE 'Y'       WCAUP   1                       192329
     C                     MOVE 'Y'       WAGUP                                               CLE041
     C                     ENDIF                                          192329
      *                                                                   146936
     C           PRVKEY    IFNE NEWKEY                                    146936
     C                     MOVE NEWKEY    PRVKEY                          146936
     C           KEY001    CHAINFCLTY                80                   146936
      *                                                                   146936
     C           *IN80     IFEQ '1'                                       146936
     C           *LOCK     IN   LDA                        ************   146936
     C                     Z-ADD15        DBASE            * DBERR 15 *   146936
     C                     MOVEL'FCLTY   'DBFILE           ************   146936
     C                     MOVELNEWKEY    DBKEY                           146936
     C                     MOVEL'LER020  'DBPGM                           146936
     C                     SETON                     U7U8                 146936
     C                     OUT  LDA                                       146936
     C                     EXSR *PSSR                                     146936
     C                     EXSR ZSFAU                                     146936
     C                     ENDIF                                          146936
      *                                                                   146936
     C                     ENDIF                                          146936
      *                                                                   146936
      ** If the action is backvalued, check whether the facility was      146936
      ** revolving or nonrevolving on the date of the transaction in      146936
      ** order to determine whether the facility needs to be reduced      146936
      *                                                                   146936
     C           VDAT      IFLT BJRDNB                                    146936
     C           VDAT      IFLT HISDAY                                    146936
     C                     MOVE HISDAY    VDAT                            146936
     C                     ENDIF                                          146936
     C           HISKEY    SETGTHISUPD                                    146936
     C                     READPHISUPD                   99               146936
     C           *IN99     IFEQ '1'                                       146936
     C           RVCR      CABEQ'Y'       AEXIT                           146936
     C                     ELSE                                           146936
     C           *IN64     IFEQ '0'                                       146936
     C           FARCIN    IFNE RVCR                                      146936
     C                     MOVE '1'       *IN64                           146936
     C                     ENDIF                                          146936
     C                     ENDIF                                          146936
     C           FARCIN    CABEQ'Y'       AEXIT                           146936
     C                     ENDIF                                          146936
     C                     ELSE                                           146936
     C           RVCR      CABEQ'Y'       AEXIT                           146936
     C                     ENDIF                                          146936
      *                                                                   146936
     C           LNRF      CHAINCLOANCL              81                   146936
     C           *IN81     IFEQ '1'                                       146936
     C           *LOCK     IN   LDA                        ************   146936
     C                     Z-ADD16        DBASE            * DBERR 16 *   146936
     C                     MOVEL'CLOAN   'DBFILE           ************   146936
     C                     MOVELLNRF      DBKEY                           146936
     C                     MOVEL'LER020  'DBPGM                           146936
     C                     SETON                     U7U8                 146936
     C                     OUT  LDA                                       146936
     C                     EXSR *PSSR                                     146936
     C                     EXSR ZSFAU                                     146936
     C                     ENDIF                                          146936
      *                                                                   146936
     C           CCY       IFNE FCCY                                      146936
      *                                                                   146936
      ** Get Facility Currency details                                    146936
      *                                                                   146936
     C                     MOVE FCCY      KEYCCY                          146936
     C                     EXSR GETCCY                                    146936
     C                     MOVE A6NBDP    FCDP                            146936
      *                                                                   146936
      ** Get Currency details                                             146936
      *                                                                   146936
     C                     MOVE CCY       KEYCCY                          146936
     C                     EXSR GETCCY                                    146936
     C           FCDP      SUB  A6NBDP    DP                              146936
     C                     ADD  4         DP                              146936
      *****************************************************************                162343 199588
      ***Use*spot*rate*instead*of*facility*ccy*exchange*rate*in********                162343 199588
      ***converting*amount*to*it's*facility*currency.******************                162343 199588
      *****************************************************************                162343 199588
     C**********           EXSR SRCONV                                                 162343 199588
      *****************************************************************                162343 199588
     C***********FMDI      IFEQ 'D'                                146936 162343
     C***********FCXR      DIV  POWR,DP   FCXRT     H              146936 162343
     C***********1         DIV  FCXRT     FCXRT                    146936 162343
     C***********          ELSE                                    146936 162343
     C***********FCXR      MULT POWR,DP   FCXRT     H              146936 162343
     C***********          ENDIF                                   146936 162343
     C***********PRAM      MULT FCXRT     @AMT      H              146936 162343
      *                                                                                       199588
     C           FMDI      IFEQ 'D'                                                           199588
     C           FCXR      DIV  POWER,DP  FCXRT     H                                         199588
     C           PRAM      DIV  FCXRT     @AMT   130H                                         246032
     C********** 1         DIV  FCXRT     FCXRT                                        199588 224974
     C********** 1         DIV  FCXRT     FCXRT     H                                  224974 246032
     C                     ELSE                                                               199588
     C           FCXR      MULT POWER,DP  FCXRT     H                                         199588
     C           PRAM      MULT FCXRT     @AMT      H                                         246032
     C                     ENDIF                                                              199588
     C********** PRAM      MULT FCXRT     @AMT      H                                  199588 246032
     C                     ELSE                                           146936
     C                     Z-ADDPRAM      @AMT                            146936
     C                     ENDIF                                          146936
     C                     SUB  @AMT      @AMTA            Tot for fac.   146936
      *                                                                   146936
     C                     ENDIF                                          146936
      *
     C           AEXIT     TAG
      *                                                                   CLE005
      ** If CLE005 is switched on and Tranche/Credit Agreement            CLE005
      ** indicator = 'TR' and WCAUP = 'Y' execute SRCAUP                  CLE005
      *                                                                   CLE005
     C           TRCA      IFEQ 'TR'                                      CLE005
     C           WCAUP     ANDEQ'Y'                                       CLE005
     C***********CLE005    ANDEQ'Y'                                 CLE005161452
     C           CLE005    ANDEQ'Y'                                       179594
     C           GASS      ANDNE'A'                                       154092
     C***********AMTP      ANDNE'RV'                               161452 179594
     C           AMTP      ANDNE'RV'                                                          208203
      *                                                                   CLE005
     C***********          MOVE 'N'       WCAUP                     CLE005161452
     C                     MOVE 'N'       WCAUP                           179594
     C                     EXSR SRCAUP                                    CLE005
      *                                                                   CLE005
     C                     ENDIF                                          CLE005
      *                                                                                       CLE041
     C           CLE025    IFEQ 'Y'                                                           CLE041
     C           TRCA      ANDEQ'TR'                                                          CLE041
     C           WAGUP     ANDEQ'Y'                                                           CLE041
     C           AMTP      ANDNE'RV'                                                          CLE041
     C                     MOVE 'N'       WAGUP                                               CLE041
     C                     EXSR SRAGUP                                                        CLE041
     C                     ENDIF                                                              CLE041
      *                                                                   CLE005
     C           AEXIT2    TAG                                                                208203
      *
     CL1 01                EXSR C0000
     CL1                   MOVE '0'       *IN64
     CLR                   EXSR D0000
     CLR                   EXSR ZSFAU
      *
     C/EJECT
     C********************************************************************
     C*
     C*  B0000 - INITIALIZATION SUBROUTINE
     C*
     C*  CALLED FROM: MAIN PROCESSING
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C*
     C           B0000     BEGSR
      *                                                                                       CLE134
     C           *ENTRY    PLIST                                                              CLE134
     C                     PARM           WPNAM  10                                           CLE134
     C           1         SETLLLEACPDPD                                                      CLE134
     C*
     C** Copyright Statement
     C*
     C                     MOVEACPY@      BIS@   80
      *
      ** Initialise Sequence No. for RCF to blanks.
      *
     C                     MOVE *BLANKS   SEQ     5
     C*
     C** Define LDA.
     C*
     C           *NAMVAR   DEFN           LDA
     C*
     C** Read in Data Area RUNDAT.
     C*
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
     C*                                                                00024
     C** Read in Data Area LERSTS.                                     00024
     C*                                                                00024
     C           *NAMVAR   DEFN           LERSTS                       00024
     C                     IN   LERSTS                                 00024
      *
      ** Set On NOT First Cycle indicator
      *
     C                     MOVE '1'       *IN01
      *
     C                     READ SDBANKPD                 99
      *
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD3         DBASE            * DBERROR 003 *
     C                     MOVEL'SDBANKPD'DBFILE           ***************
     C                     MOVEL'BANK    'DBKEY
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
     C                     END
      *                                                                                       199220
     C                     READ SDGELRPD                 99                                   199220
      *                                                                                       199220
     C           *IN99     IFEQ '1'                                                           199220
     C           *LOCK     IN   LDA                        ***************                    199220
     C                     Z-ADD19        DBASE            * DBERROR 019 *                    199220
     C                     MOVEL'SDGELRPD'DBFILE           ***************                    199220
     C                     MOVEL'BANK    'DBKEY                                               199220
     C                     MOVEL'LER020  'DBPGM                                               199220
     C                     SETON                     U7U8                                     199220
     C                     OUT  LDA                                                           199220
     C                     EXSR *PSSR                                                         199220
     C                     EXSR ZSFAU                                                         199220
     C                     END                                                                199220
      *                                                                   CLE004
      ** Determine if Customer Lending Enhancements - Syndications        CLE004
      ** (CLE004) is installed                                            CLE004
      *                                                                   CLE004
     C                     CALL 'AOSARDR0'                                CLE004
     C                     PARM *BLANKS   @RTCD                           CLE004
     C                     PARM '*VERIFY' @OPTN                           CLE004
     C                     PARM 'CLE004'  PSARD   6                       CLE004
     C           SCSARD    PARM SCSARD    DSFDY                           CLE004
     C                     MOVE 'N'       CLE004  1                       CLE004
      *                                                                   CLE004
      ** If feature is on, set up SAR work flag                           CLE004
      *                                                                   CLE004
     C           @RTCD     IFEQ *BLANKS                                   CLE004
     C                     MOVE 'Y'       CLE004                          CLE004
     C                     ELSE                                           CLE004
      *                                                                   CLE004
      ** else, database error (return code other than *NRF)               CLE004
      *                                                                   CLE004
     C           @RTCD     IFNE '*NRF   '                                 CLE004
     C           *LOCK     IN   LDA                                       CLE004
     C                     MOVEL'LER020'  DBPGM                           CLE004
     C                     MOVEL'SCSARDPD'DBFILE           ************   CLE004
     C                     MOVEL'*VERIFY' DBKEY            * DBERR 09 *   CLE004
     C                     Z-ADD9         DBASE            ************   CLE004
     C                     OUT  LDA                                       CLE004
     C                     EXSR *PSSR                                     CLE004
     C                     EXSR ZSFAU                                     CLE004
     C                     ENDIF                                          CLE004
      *                                                                   CLE004
     C                     ENDIF                                          CLE004
      *                                                                   CLE005
      ** Check if SAR CLE005 is switched *ON.                             CLE005
      *                                                                   CLE005
     C                     CALL 'AOSARDR0'                                CLE005
     C                     PARM *BLANKS   @RTCD                           CLE005
     C                     PARM '*KEY   ' @OPTN                           CLE005
     C                     PARM 'CLE005 ' PSARD                           CLE005
     C           SCSARD    PARM SCSARD    DSFDY                           CLE005
     C           @RTCD     IFEQ *BLANK                                    CLE005
     C                     MOVE 'Y'       CLE005  1                       CLE005
     C                     ELSE                                           CLE005
     C                     MOVE 'N'       CLE005                          CLE005
     C           @RTCD     IFNE '*NRF    '                                CLE005
     C           *LOCK     IN   LDA                                       CLE005
     C                     MOVEL'LER020'  DBPGM                           CLE005
     C                     MOVEL'SCSARDPD'DBFILE           ************   CLE005
     C                     Z-ADD11        DBASE            * DBERR 11 *   CLE005
     C                     MOVEL'CLE005  'DBKEY            ************   CLE005
     C                     OUT  LDA                                       CLE005
     C                     EXSR *PSSR                                     CLE005
     C                     EXSR ZSFAU                                     CLE005
     C                     ENDIF                                          CLE005
     C                     ENDIF                                          CLE005
      *                                                                   146936
     C                     CALL 'AOSARDR0'                                146936
     C                     PARM *BLANKS   @RTCD                           146936
     C                     PARM '*KEY   ' @OPTN                           146936
     C                     PARM 'CEU020 ' PSARD                           146936
     C           SCSARD    PARM SCSARD    DSFDY                           146936
     C           @RTCD     IFEQ *BLANK                                    146936
     C                     MOVE 'Y'       CEU020  1                       146936
     C                     ELSE                                           146936
     C                     MOVE 'N'       CEU020                          146936
     C           @RTCD     IFNE '*NRF    '                                146936
     C           *LOCK     IN   LDA                                       146936
     C                     MOVEL'LER020'  DBPGM                           146936
     C                     MOVEL'SCSARDPD'DBFILE           ************   146936
     C                     Z-ADD14        DBASE            * DBERR 14 *   146936
     C                     MOVEL'CEU020  'DBKEY            ************   146936
     C                     OUT  LDA                                       146936
     C                     EXSR *PSSR                                     146936
     C                     EXSR ZSFAU                                     146936
     C                     ENDIF                                          146936
     C                     ENDIF                                          146936
      *                                                                   CLE014
      ** Determine if CLE014 is installed                                 CLE014
      *                                                                   CLE014
     C                     CALL 'AOSARDR0'                                CLE014
     C                     PARM '       ' PRTCD   7                       CLE014
     C                     PARM '*VERIFY' POPTN   7                       CLE014
     C                     PARM 'CLE014'  PSARD                           CLE014
     C           SCSARD    PARM SCSARD    DSSDY                           CLE014
      *                                                                   CLE014
      ** Handle Database Error                                            CLE014
      *                                                                   CLE014
     C           PRTCD     IFNE *BLANKS                                   CLE014
     C           PRTCD     ANDNE'*NRF   '                                 CLE014
     C           *LOCK     IN   LDA                                       CLE014
     C                     MOVE 'SCSARDPD'DBFILE                          CLE014
     C                     MOVEL'LER020'  DBPGM                           CLE014
     C                     MOVELPSARD     DBKEY                           CLE014
     C                     Z-ADD17        DBASE                           CLE014
     C                     OUT  LDA                                       CLE014
     C                     EXSR *PSSR                                     CLE014
     C                     ENDIF                                          CLE014
      *                                                                   CLE014
      ** CLE014 is installed                                              CLE014
      *                                                                   CLE014
     C           PRTCD     IFEQ *BLANKS                                   CLE014
     C                     MOVE 'Y'       CLE014  1                       CLE014
     C                     ELSE                                           CLE014
     C                     MOVE 'N'       CLE014                          CLE014
     C                     ENDIF                                          CLE014
      *                                                                                       CLE023
      ** Determine if CLE023 is installed                                                     CLE023
      *                                                                                       CLE023
     C                     CALL 'AOSARDR0'                                                    CLE023
     C                     PARM '       ' PRTCD                                               CLE023
     C                     PARM '*VERIFY' POPTN                                               CLE023
     C                     PARM 'CLE023'  PSARD                                               CLE023
     C           SCSARD    PARM SCSARD    DSSDY                                               CLE023
      *                                                                                       CLE023
      ** Handle Database Error                                                                CLE023
      *                                                                                       CLE023
     C           PRTCD     IFNE *BLANKS                                                       CLE023
     C           PRTCD     ANDNE'*NRF   '                                                     CLE023
     C           *LOCK     IN   LDA                                                           CLE023
     C                     MOVE 'SCSARDPD'DBFILE                                              CLE023
     C                     MOVEL'LER020'  DBPGM                                               CLE023
     C                     MOVELPSARD     DBKEY                                               CLE023
     C                     Z-ADD18        DBASE                                               CLE023
     C                     OUT  LDA                                                           CLE023
     C                     EXSR *PSSR                                                         CLE023
     C                     ENDIF                                                              CLE023
      *                                                                                       CLE023
      ** CLE023 is installed                                                                  CLE023
      *                                                                                       CLE023
     C           PRTCD     IFEQ *BLANKS                                                       CLE023
     C                     MOVE 'Y'       CLE023  1                                           CLE023
     C                     ELSE                                                               CLE023
     C                     MOVE 'N'       CLE023                                              CLE023
     C                     ENDIF                                                              CLE023
      *                                                                                       CLE041
      ** Determine if Credit Lines is installed                                               CLE041
      *                                                                                       CLE041
     C                     CALL 'AOSARDR0'                                                    CLE041
     C                     PARM '       ' PRTCD                                               CLE041
     C                     PARM '*VERIFY' POPTN                                               CLE041
     C                     PARM 'CLE025'  PSARD                                               CLE041
     C           SCSARD    PARM SCSARD    DSSDY                                               CLE041
      *                                                                                       CLE041
      ** Handle Database Error                                                                CLE041
      *                                                                                       CLE041
     C           PRTCD     IFNE *BLANKS                                                       CLE041
     C           PRTCD     ANDNE'*NRF   '                                                     CLE041
     C           *LOCK     IN   LDA                                                           CLE041
     C                     MOVE 'SCSARDPD'DBFILE                                              CLE041
     C                     MOVEL'LER020'  DBPGM                                               CLE041
     C                     MOVELPSARD     DBKEY                                               CLE041
     C                     Z-ADD20        DBASE                                               CLE041
     C                     OUT  LDA                                                           CLE041
     C                     EXSR *PSSR                                                         CLE041
     C                     ENDIF                                                              CLE041
      *                                                                                       CLE041
      ** CLE025 is installed                                                                  CLE041
      *                                                                                       CLE041
     C           PRTCD     IFEQ *BLANKS                                                       CLE041
     C                     MOVE 'Y'       CLE025  1                                           CLE041
     C                     ELSE                                                               CLE041
     C                     MOVE 'N'       CLE025                                              CLE041
     C                     ENDIF                                                              CLE041
     C/COPY WNCPYSRC,LEH00112
      *                                                                                       CLE138
      ** Determine if Class Codes for Facilities is installed                                 CLE138
      *                                                                                       CLE138
     C                     CALL 'AOSARDR0'                                                    CLE138
     C                     PARM '       ' PRTCD                                               CLE138
     C                     PARM '*VERIFY' POPTN                                               CLE138
     C                     PARM 'CLE138'  PSARD                                               CLE138
     C           SCSARD    PARM SCSARD    DSSDY                                               CLE138
      *                                                                                       CLE138
      ** Handle Database Error                                                                CLE138
      *                                                                                       CLE138
     C           PRTCD     IFNE *BLANKS                                                       CLE138
     C           PRTCD     ANDNE'*NRF   '                                                     CLE138
     C           *LOCK     IN   LDA                                                           CLE138
     C                     MOVE 'SCSARDPD'DBFILE                                              CLE138
     C                     MOVEL'LER020'  DBPGM                                               CLE138
     C                     MOVELPSARD     DBKEY                                               CLE138
     C                     Z-ADD21        DBASE                                               CLE138
     C                     OUT  LDA                                                           CLE138
     C                     EXSR *PSSR                                                         CLE138
     C                     ENDIF                                                              CLE138
      *                                                                                       CLE138
      ** CLE138 is installed                                                                  CLE138
      *                                                                                       CLE138
     C           PRTCD     IFEQ *BLANKS                                                       CLE138
     C                     OPEN LEFCLTLG                                                      CLE138
     C                     MOVE 'Y'       CLE138  1                                           CLE138
     C**********           MOVE *ON       *IN30                                      CLE138 MD060134
     C                     MOVE *ON       *IN35                                             MD060134
     C                     ELSE                                                               CLE138
     C                     MOVE 'N'       CLE138                                              CLE138
     C**********           MOVE *OFF      *IN30                                      CLE138 MD060134
     C                     MOVE *OFF      *IN35                                             MD060134
     C                     ENDIF                                                              CLE138
      *                                                                   CLE005
      ** If CLE005 is switched on, open LECARDPD.                         CLE005
      *                                                                   CLE005
     C           CLE005    IFEQ 'Y'                                       CLE005
     C                     OPEN LECARDPD                                  CLE005
     C                     ENDIF                                          CLE005
      *                                                                                       CLE041
      ** If CLE025 is switched on, open LEAGRDPD.                                             CLE041
      *                                                                                       CLE041
     C           CLE025    IFEQ 'Y'                                                           CLE041
     C                     OPEN LEAGRDPD                                                      CLE041
     C                     ENDIF                                                              CLE041
      *
     C                     MOVE 'A'       @RTP    1
      *
      *  Open file if EM present
      *
     C           EMFLG     IFEQ 'Y'                                       E30168
     C                     OPEN EMXT4F1L                                  E30168
     C                     END                                            E30168
      *                                                                                       CLE134
     C           *LIKE     DEFN PRAM      KPRAM                                               263413
     C           *LIKE     DEFN TAMT      KTAMT                                               263413
     C           *LIKE     DEFN TAMT      KINTA                                               263413
     C/COPY WNCPYSRC,LEH01408
      *                                                                                       263413
     C                     CALL 'AOSARDR0'                                                    CLE134
     C                     PARM *BLANKS   @RTCD                                               CLE134
     C                     PARM '*KEY   ' @OPTN                                               CLE134
     C                     PARM 'CLE134 ' PSARD                                               CLE134
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE134
     C           @RTCD     IFEQ *BLANK                                                        CLE134
     C                     MOVE 'Y'       CLE134  1                                           CLE134
     C                     ELSE                                                               CLE134
     C                     MOVE 'N'       CLE134                                              CLE134
     C                     ENDIF                                                              CLE134
      *                                                                                       CLE134
      ** Set NEWCOB flag                                                                      CLE134
      *                                                                                       CLE134
     C**********           MOVE 'N'       WFLAG   1                                  CLE134 AR567487
     C                     MOVE 'N'       NEWCOB  1                                           CLE134
     C           CLE134    IFEQ 'Y'                                                           CLE134
     C           WPNAM     ANDEQ'NEWCOB'                                                      CLE134
     C                     MOVE 'Y'       NEWCOB                                              CLE134
     C                     ENDIF                                                              CLE134
      *                                                                                       CLE134
     C***/COPY*WNCPYSRC,LER020C002***                                                         CFC006
     C/COPY WNCPYSRC,LER020C002                                                             MD020563
      *****************************************************************           AR1097176 MD020563
      ***Check*if*CFC006*is*switched**ON.******************************           AR1097176 MD020563
      *****************************************************************           AR1097176 MD020563
     C**********           MOVE 'N'       CFC006  1                               AR1097176 MD020563
     C**********           CALL 'AOSARDR0'                                        AR1097176 MD020563
     C**********           PARM *BLANKS   WRTCD   7                               AR1097176 MD020563
     C**********           PARM '*VERIFY' WOPTN   7                               AR1097176 MD020563
     C**********           PARM 'CFC006'  WSARD   6                               AR1097176 MD020563
     C********** SCSARD    PARM SCSARD    DSFDY                                   AR1097176 MD020563
      *****************************************************************           AR1097176 MD020563
     C********** WRTCD     IFEQ *BLANKS                                           AR1097176 MD020563
     C**********           MOVE 'Y'       CFC006                                  AR1097176 MD020563
     C**********           ENDIF                                                  AR1097176 MD020563
      *                                                                                       CFC006
      ** Enable output indicator for LER020P1                                                 CFC006
      *                                                                                       CFC006
     C                     MOVEL'N'       SUPFLG  1                                           CFC006
     C********** CFC006    IFEQ 'Y'                                               AR1097176 MD020563
     C                     CALL 'AOCOMR0'                                                     CFC006
     C                     PARM 'LERC20 ' PNAME  10                                           CFC006
     C                     PARM '*ALL '   PCSEQ   5                                           CFC006
     C                     PARM SECTN     PSCTN  50                                           CFC006
     C                     PARM *BLANKS   PRTCD                                               CFC006
      *                                                                                       CFC006
     C           PRTCD     IFEQ 'Y      '                                                     CFC006
     C                     MOVEL'Y'       SUPFLG                                              CFC006
     C                     ENDIF                                                              CFC006
     C**********           ENDIF                                                  AR1097176 MD020563
      *                                                                                       CFC006
     C*                                                                   E30168
      *  Set up ECD as Date of Next Working day - 1                       087943
      *                                                                   087943
     C           BJDNWD    SUB  1         ECD     50                      087943
      *                                                                   087943
     C* Set up CCY array                                                                      CSC042
     C                     Z-ADD0         X       30                                          CSC042
      * Save state of *IN03                                                                   CSC042
     C           *IN03     IFEQ *ON                                                           CSC042
     C                     MOVEL'Y'       INDC03  1                                           CSC042
     C                     ELSE                                                               CSC042
     C                     MOVEL'N'       INDC03  1                                           CSC042
     C                     END                                                                CSC042
     C                     SETOF                         03                                   CSC042
     C                     OPEN SDCURRPD                                                      CSC042
     C           *IN03     DOWEQ*OFF                                                          CSC042
     C                     READ SDCURRPD                 03                                   CSC042
     C           *IN03     IFEQ *OFF                                                          CSC042
     C           X         IFLE 150                                                           CSC042
     C                     ADD  1         X                                                   CSC042
     C                     MOVE A6CYCD    CURR,X                                              CSC042
     C                     Z-ADDA6NBDP    CCDP,X                                              CSC042
     C                     END                                                                CSC042
     C                     END                                                                CSC042
     C                     END                                                                CSC042
      * Restore 03 back to previous state                                                     CSC042
     C           INDC03    IFEQ 'Y'                                                           CSC042
     C                     SETON                     03                                       CSC042
     C                     ELSE                                                               CSC042
     C                     SETOF                     03                                       CSC042
     C                     END                                                                CSC042
     C                     CLOSESDCURRPD                                                      CSC042
      ***Set*up*currency*array*****************************************                162343 199588
      *****************************************************************                162343 199588
     C**********           Z-ADD0         X       30                                   162343 199588
     C**********           READ SDCURRPD                 03                            162343 199588
      **********                                                                       162343 199588
      ***Database*error*if*currency*file*empty*at*this*stage.**********                162343 199588
      **********                                                                       162343 199588
     C********** *IN03     IFEQ '1'                                                    162343 199588
     C********** *LOCK     IN   LDA                                                    162343 199588
     C**********           MOVEL'LER031  'DBPGM                                        162343 199588
     C**********           MOVEL'*READ   'DBKEY                                        162343 199588
     C**********           MOVE 'SDCURRPD'DBFILE           ************                162343 199588
     C**********           Z-ADD13        DBASE            * DBERR 13 *                162343 199588
     C**********           OUT  LDA                        ************                162343 199588
     C**********           EXSR *PSSR                                                  162343 199588
     C**********           ENDIF                                                       162343 199588
      **********                                                                       162343 199588
     C********** *IN03     DOWEQ'0'                                                    162343 199588
      **********                                                                       162343 199588
     C********** X         IFLE 150                                                    162343 199588
     C********** X         ADD  1         X                                            162343 199588
     C**********           MOVE A6CYCD    CURR,X                                       162343 199588
     C**********           Z-ADDA6SPRT    CSPT,X                                       162343 199588
     C**********           MOVELA6MDIN    MTDV,X                                       162343 199588
     C**********           Z-ADDA6NBDP    CCDP,X                                       162343 199588
     C**********           Z-ADDA6SSNB    CCNO,X                                       162343 199588
     C**********           ENDIF                                                       162343 199588
      **********                                                                       162343 199588
     C**********           READ SDCURRPD                 03                            162343 199588
      **********                                                                       162343 199588
     C**********           END                                                         162343 199588
      **********                                                                       162343 199588
     C                     ENDSR
      *
     C/EJECT
     C********************************************************************
     C*
     C*  C0000 - SUBROUTINE TO UPDATE FACILITY RECORDS
     C*
     C*  CALLED FROM: MAIN PROCESSING
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C*
     C           C0000     BEGSR
     C*
     C           @AMTA     CABEQ0         CEXIT            Adj is zero
     C           KEY001    CHAINFCLTY                80
      * If not found - check for closed/reversed facility                                     226483
     C           *IN80     IFEQ '1'                                                           226483
     C           KEY003    CHAINPEFCLFL1             80                                       226483
      *
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD4         DBASE            * DBERROR 004 *
     C                     MOVEL'FCLTY   'DBFILE           ***************
     C                     MOVELNEWKEY    DBKEY
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
      * If closed/reversed facility, skip processing for this record                          226483
     C                     ELSE                                                               226483
     C                     GOTO CEXIT                                                         226483
     C                     END
     C                     ENDIF                                                              226483
      *
     C                     ADD  FAMT      @VALB
     C                     Z-ADDFAMT      WFAMT  130                                          193603
     C           WFAMT     IFLT 0                                                             193603
     C                     Z-SUBWFAMT     WFAMT                                               193603
     C                     END                                                                193603
     C                     Z-ADDFAMT      @DSAMT           before value
      *                                                                                       204450
     C                     MOVE 'N'       REACTK  1                                           204450
     C           @AMTA     IFLT 0                                                             204450
     C           PAST      ANDEQ'Y'                                                           204450
     C           KEY002    CHAINHISACTF              16                                       204450
     C           *IN16     DOWEQ'0'                                                           204450
     C           HAACTN    IFEQ 'FR'                                                          204450
     C                     MOVE 'Y'       REACTK                                              204450
     C                     LEAVE                                                              204450
     C                     ENDIF                                                              204450
     C           KEY002    READEHISACTF                  16                                   204450
     C                     ENDDO                                                              204450
     C                     ENDIF                                                              204450
      *                                                                                       204450
     C           REACTK    IFEQ 'N'                                                           204450
     C           RECI      IFNE 'C'                                                           193603
     C                     SUB  @AMTA     FAMT
     C                     END                                                                193603
     C                     ENDIF                                                              204450
      *                                                                                       204450
     C********** FAMT      IFLE 0                                         081634
     C********** @DSAMT    SUB  1         @AMTA                           081634
     C**********           Z-ADD1         FAMT                            081634
     C***********FAMT      IFLT 0                                   081634159499
     C***********          Z-SUB@DSAMT    @AMTA                     081634092501
     C***********          Z-ADD@DSAMT    @AMTA                     092501159499
     C***********          Z-ADD0         FAMT                      081634159499
     C***********          END                                            159499
      *                                                                   179077
      ** Reinstate processing to zeroise facility amount if less than     179077
      ** 0, but condition on CLE005 not being installed.                  179077
      ** If CLE023 is installed, facility amount must be zeroised if                          CLE023
      ** it is less than zero.                                                                CLE023
      *                                                                   179077
     C           FAMT      IFLT 0                                         179077
     C           CLE005    ANDNE'Y'                                       179077
     C           FAMT      ORLT 0                                                             CLE023
     C           CLE023    ANDEQ'Y'                                                           CLE023
      *                                                                                       CLE023
      ** OAM must reflect the actual drawn amount when CLE023 is installed                    CLE023
      *                                                                                       CLE023
     C           CLE023    IFEQ 'N'                                                           CLE023
     C                     Z-ADD@DSAMT    @AMTA                           179077
     C                     ENDIF                                                              CLE023
     C                     Z-ADD0         FAMT                            179077
     C                     END                                            179077
     C*                                                                   179077
     C                     ADD  FAMT      @VALA             after
     C                     Z-ADDFAMT      NFAMT  130                                          193603
     C           NFAMT     IFLT 0                                                             193603
     C                     Z-SUBNFAMT     NFAMT                                               193603
     C                     END                                                                193603
     C********** WFAMT     SUB  NFAMT     NDIFF  130                                 193603 MD052276
     C**********           ADD  NDIFF     DIFTOT 130                                 193603 MD052276
     C           WFAMT     SUB  NFAMT     NDIFF  180                                        MD052276
     C                     ADD  NDIFF     DIFTOT 180                                        MD052276
     C                     Z-ADDFAMT      @DTAMT            value
     C                     UPDATFCLTYFMF
     C                     READ FCLTY                    80 'N' Record
      *
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD5         DBASE            * DBERROR 005 *
     C                     MOVEL'FCLTY   'DBFILE           ***************
     C                     MOVEL*BLANKS   DBKEY
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
     C                     END
      *
      *  Do not update array for C & F type facilities - D. Bigg          E30169
      *  said this is because they were getting updated twice.            E30169
      *  (ONLY TESTED FOR THESE but G should be the same)                 E30169
     C***********          SUB  @AMTA     OAM1                            E30169
     C***********          SUB  @AMTA     OAM2                            E30169
     C***********          SUB  @AMTA     OAM3                            E30169
     C***********          SUB  @AMTA     OAM4                            E30169
     C***********          SUB  @AMTA     OAM5                            E30169
     C***********          SUB  @AMTA     OAM6                            E30169
     C***********          SUB  @AMTA     OAM7                            E30169
     C***********          SUB  @AMTA     OAM8                            E30169
     C***********          SUB  @AMTA     OAM9                            E30169
     C***********          SUB  @AMTA     OA10                            E30169
     C*                                                                   112590
     C** Update OAMx field if RUNx field is equal or greater than         112590
     C** the facility expiry date.                                        112590
     C*                                                                   112590
     C********** RUN0      IFEQ DTEX                                      112590              204450
     C********** RUN0      ORGT DTEX                                      112590              204450
     C           RUN0      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM1                                       112590 MD027755
     C                     END                                            112590
     C********** RUN1      IFEQ DTEX                                      112590              204450
     C********** RUN1      ORGT DTEX                                      112590              204450
     C           RUN1      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM2                                       112590 MD027755
     C                     END                                            112590
     **********  RUN2      IFEQ DTEX                                      112590              204450
     **********  RUN2      ORGT DTEX                                      112590              204450
     C           RUN2      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM3                                       112590 MD027755
     C                     END                                            112590
     C********** RUN3      IFEQ DTEX                                      112590              204450
     C********** RUN3      ORGT DTEX                                      112590              204450
     C           RUN3      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM4                                       112590 MD027755
     C                     END                                            112590
     C********** RUN4      IFEQ DTEX                                      112590              204450
     C********** RUN4      ORGT DTEX                                      112590              204450
     C           RUN4      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM5                                       112590 MD027755
     C                     END                                            112590
     C********** RUN5      IFEQ DTEX                                      112590              204450
     C********** RUN5      ORGT DTEX                                      112590              204450
     C           RUN5      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM6                                       112590 MD027755
     C                     END                                            112590
     C********** RUN6      IFEQ DTEX                                      112590              204450
     C********** RUN6      ORGT DTEX                                      112590              204450
     C           RUN6      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM7                                       112590 MD027755
     C                     END                                            112590
     C********** RUN7      IFEQ DTEX                                      112590              204450
     C********** RUN7      ORGT DTEX                                      112590              204450
     C           RUN7      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM8                                       112590 MD027755
     C                     END                                            112590
     C********** RUN8      IFEQ DTEX                                      112590              204450
     C********** RUN8      ORGT DTEX                                      112590              204450
     C           RUN8      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OAM9                                       112590 MD027755
     C                     END                                            112590
     C********** RUN9      IFEQ DTEX                                      112590              204450
     C********** RUN9      ORGT DTEX                                      112590              204450
     C           RUN9      IFGT DTEX                                                          204450
     C**********           SUB  @AMTA     OA10                                       112590 MD027755
     C                     END                                            112590
      *                                                                                       204450
     C           REACTK    IFEQ 'N'                                                           204450
     C                     SUB  @AMTA     TOTD
     C                     ADD  @AMTA     @VALR            Accumulate
     C                     Z-ADD@AMTA     @DUAMT           difference
     C                     ELSE                                                               204450
     C                     Z-ADD0         @DUAMT                                              204450
     C                     ENDIF                                                              204450
      *                                                                                       204450
     C                     UPDATFCLTYFNF                   Update 'B'
      *                                                                   E30168
      *  Update exposure file if necessary                                E30168
      *                                                                   E30168
     C           EMFLG     IFEQ 'Y'                                       E30168
     C           RECI      ANDEQ'D'                                       E30168
     C           DTAP      ANDLEECD                                       087943
     C           ECD       ANDLTDTEX                                      087943
     C           EMKEY     KLIST                                          E30168
     C                     KFLD           MCUN                            E30168
     C                     KFLD           MFTP                            E30168
     C                     KFLD           MFN                             E30168
     C**********           Z-ADDFCUS      MCUN                                         E30168 CSD027
     C                     MOVE FCUS      MCUN                                                CSD027
     C                     Z-ADDFTYP      MFTP                            E30168
     C                     Z-ADDFSEQ      MFN                             E30168
     C           EMKEY     CHAINEMXT4F1F             99                   E30168
     C           *IN99     IFEQ *OFF                                      156296
     C                     Z-ADDFAMT      MCYA                            E30168
     C                     EXCPTEMCHG                                     E30168
     C                     ENDIF                                          156296
     C                     END                                            E30168
      *                                                                                       CLE138
      ** Retrieve facility extension details                                                  CLE138
      *                                                                                       CLE138
     C           CLE138    IFEQ 'Y'                                                           CLE138
     C                     MOVE CNUM      KCNUM   6                                           CLE138
     C                     MOVE FACT      KFTYP   3                                           CLE138
     C                     MOVE FCNO      KFCNO   2                                           CLE138
     C                     MOVE *BLANKS   FCLS    4                                           CLE138
      *                                                                                       CLE138
     C           KLFEXT    CHAINLEFCLTLG             82                                       CLE138
     C           *IN82     IFEQ '1'                                                           CLE138
     C           *LOCK     IN   LDA                                                           CLE138
     C                     Z-ADD22        DBASE                                               CLE138
     C                     MOVEL'LEFCLTLG'DBFILE                                              CLE138
     C                     MOVEL*BLANKS   DBKEY                                               CLE138
     C                     MOVEL'LER020  'DBPGM                                               CLE138
     C                     SETON                     U7U8                                     CLE138
     C                     OUT  LDA                                                           CLE138
     C                     EXSR *PSSR                                                         CLE138
     C                     EXSR ZSFAU                                                         CLE138
     C                     ELSE                                                               CLE138
     C                     MOVE FCXCLS    FCLS                                                CLE138
     C                     ENDIF                                                              CLE138
      *                                                                                       CLE138
     C                     ENDIF                                                              CLE138
      *
      ** Get Facility Currency details
      *
     C                     MOVE FCCY      KEYCCY
     C                     EXSR GETCCY
     C           A6NBDP    COMP 1                    626061 Dec Places
     C   62      A6NBDP    COMP 3                      6263
     C*
     C** If Level break on branch code and Multibranching On
     C** then obtain Branch Name for output.
     C*
     C           BRCA      IFNE STRBRC
     C***/COPY*WNCPYSRC,LEH00961***                                                           CFC006
     C/COPY WNCPYSRC,LEH00961                                                               MD020563
     C           SUPFLG    ANDNE'Y'                                                           CFC006
     C           MBIN      IFEQ 'Y'
     C                     MOVE '1'       *IN02            Multibranch
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM BRCA      @DSNB   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     MOVE '1'       *IN99            * DBERROR 006 *
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVELBRCA      DBKEY
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     Z-ADD006       DBASE
     C                     MOVE *BLANKS   BRNM
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
     C*
     C                     END
     C                     END
      *
      ** If Level Break on Branch then Write Trailer if spool
      ** file already open ...
      *
     C   20                WRITELER020T1
      *
      ** ... and Close and Open Spool file for next branch
      *
     C                     CLOSELER020P1
     C                     OPEN LER020P1
     C                     Z-ADD0         PAGE
      *
      ** Set On Spool file open flag
      *
     C                     MOVE '1'       *IN20
      *
      ** Ensure Report Spool File recorded by RCF.
      *
     C                     EXSR ZSFILE
      *
      ** Store Branch Code to allow for next check of level break
      *
     C                     MOVE BRCA      STRBRC  3
      *
      ** Write Header
      *
     C                     WRITELER020H1
      *
      ** END for level break on Branch Code
      *
     C                     END
      *
      ** If Overflow then Write Header
      *
     C           *IN50     IFEQ '1'
     C***/COPY*WNCPYSRC,LEH00962***                                                           CFC006
     C/COPY WNCPYSRC,LEH00962                                                               MD020563
     C           SUPFLG    ANDNE'Y'                                                           CFC006
     C                     WRITELER020H1
     C                     MOVE '0'       *IN50                           052132
     C                     END
      *
      ** Write Detail record on report
      *
     C***/COPY*WNCPYSRC,LEH00963***                                                           CFC006
     C/COPY WNCPYSRC,LEH00963                                                               MD020563
     C           SUPFLG    IFNE 'Y'                                                           CFC006
     C                     WRITELER020D1
     C***/COPY*WNCPYSRC,LEH00964***                                                           CFC006
     C/COPY WNCPYSRC,LEH00964                                                               MD020563
     C                     ENDIF                                                              CFC006
     C                     ADD  1         @REP
     C                     Z-ADD0         @AMTA
     C           CEXIT     ENDSR
      *
     C/EJECT
     C********************************************************************
     C*
     C*  D0000 - SUBROUTINE TO UPDATE FACILITY TRAILER & WRITE AUDIT
     C*
     C*  CALLED FROM: MAIN PROCESSING (IF LR INDICATOR ON)
     C*
     C*  CALLS: ZSFAU
     C*
     C********************************************************************
     C*
     C           D0000     BEGSR
     C*
     C           *IN01     CASEQ'0'       B0000
     C                     END
     C                     READ FCLTYZZF                 83
      *
     C           *IN83     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD7         DBASE            * DBERROR 007 *
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     MOVEL'FCLTYZZ 'DBFILE
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
     C                     END
      *
     C*********************Z-ADD1         Z                          00035
     C*********************Z-ADD1         S                          00035
     C***********@VALR*****DIV  1000      ZZAMT                      00035
     C*********************MOVE ZZAMT     ZZAMT                      00035
     C**  NOTE: THIS BIT OF CODE HAS BEEN REMOVED BECAUSE THE
     C**        UPDATING OF THE BEFORE VALUES OF THE TRAILER SEEMS
     C**        INAPPROPRIATE HERE BUT THIS NEEDS TO BE CHECKED
     C**        AT SYSTEM TEST - MAY IN FACT BE STOPPING FILE
     C**        CONTROL PROBLEMS.
     C**                   Z-ADDVLBF      ZZTOTI
     C**                   Z-ADDVLBL      ZZTOTD
     C**                   EXSR ZHASH
     C**                   Z-ADDZZTOTI    VLBF
     C**                   Z-ADDZZTOTD    VLBL
     C*********************                                           0035
     C*********************Z-ADDVLAF      ZZTOTI                      0035
     C*********************Z-ADDVLAL      ZZTOTD                      0035
     C*********************EXSR ZHASH                                 0035
     C*********************Z-ADDZZTOTI    VLAF                        0035
     C*********************Z-ADDZZTOTD    VLAL                        0035
     C*                                                               0035
     C* Adjust both the value before and the values after for the     0035
     C* the total amount reduced                                      0035
     C*                                                               0035
     C           VLBF      MULT 1000      WRKTOT 180                  0035
     C                     ADD  VLBL      WRKTOT                      0035
     C********** WRKTOT    SUB  @VALR     WRKTOT                                         0035 193603
     C           WRKTOT    SUB  DIFTOT    WRKTOT                                              193603
     C           WRKTOT    DIV  1000      VLBF                        0035
     C                     MVR            VLBL                        0035
     C           VLAF      MULT 1000      WRKTOT                      0035
     C                     ADD  VLAL      WRKTOT                      0035
     C********** WRKTOT    SUB  @VALR     WRKTOT                                         0035 193603
     C           WRKTOT    SUB  DIFTOT    WRKTOT                                              193603
     C           WRKTOT    DIV  1000      VLAF                        0035
     C                     MVR            VLAL                        0035
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE 'A'       CHTP
     C                     UPDATFCLTYZZF
      *
     C                     ENDSR
      *
     C/EJECT
     C********************************************************************
     C*
     C*  GETCCY - SUBROUTINE TO OBTAIN CURRENCY DETAILS (ACCESS OBJECT)
     C*
     C*  CALLED FROM: MAIN PROCESSING, C0000
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C*
     C           GETCCY    BEGSR
      *
     C**********           CALL 'AOCURRR0'                                                    CSC042
     C**********           PARM '*MSG   ' @RTCD   7                                           CSC042
     C**********           PARM '*KEY   ' @OPTN   7                                           CSC042
     C**********           PARM KEYCCY    @AJCD   3                                           CSC042
     C********** SDCURR    PARM SDCURR    DSSDY                                               CSC042
      *
     C********** @RTCD     IFNE *BLANKS                                                       CSC042
     C                     MOVELKEYCCY    ##KC                                                CSC042
     C                     EXSR ##CHKC                                                        CSC042
     C           ##FIC     IFEQ 'Y'                                                           CSC042
     C                     MOVE CURR,Q    A6CYCD                                              CSC042
     C                     Z-ADDCCDP,Q    A6NBDP                                              CSC042
     C                     ELSE                                                               CSC042
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD8         DBASE            * DBERROR 008 *
     C**********           MOVEL'SDCURRPD'DBFILE           ***************                    CSC042
     C**********           MOVE *BLANKS   DBKEY                                               CSC042
     C                     MOVEL'CURR,Q  'DBFILE                                              CSC042
     C                     MOVEL##KC      DBKEY                                               CSC042
     C                     MOVEL'LER020  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     EXSR ZSFAU
     C                     END
     C                     ENDSR
      *
      *****************************************************************                       CLE041
      /EJECT                                                                                  CLE041
      *****************************************************************                       CLE041
      *                                                               *                       CLE041
      * SRAGUP - Aggregate Facility Update Processing                 *                       CLE041
      *                                                               *                       CLE041
      *****************************************************************                       CLE041
     C           SRAGUP    BEGSR                                                              CLE041
      *                                                                                       CLE041
      ** Access aggregate facilities affected by the tranche                                  CLE041
     C           KLFCLT    SETLLLETRAGL0                                                      CLE041
     C           KLFCLT    READELETRAGL0                 14                                   CLE041
     C           *IN14     DOWEQ*OFF                                                          CLE041
      *                                                                                       CLE041
      ** write to LEAGRDPD                                                                    CLE041
     C                     EXSR SRMVAG                                                        CLE041
     C                     WRITELEAGRDD0                                                      CLE041
     C           KLFCLT    READELETRAGL0                 14                                   CLE041
     C                     ENDDO                                                              CLE041
      *                                                                                       CLE041
     C                     ENDSR                                                              CLE041
      *****************************************************************                       CLE041
      /EJECT                                                                                  CLE041
      *****************************************************************                       CLE041
      *                                                               *                       CLE041
      * SRMVAG - Move fields to file fields of LEAGRDPD               *                       CLE041
      *                                                               *                       CLE041
      *****************************************************************                       CLE041
     C           SRMVAG    BEGSR                                                              CLE041
      *                                                                                       CLE041
     C                     MOVE 'D'       AHRECI                                              CLE041
     C                     MOVE AGAGBR    AHAGBR                                              CLE041
     C                     MOVE AGAGNM    AHAGNM                                              CLE041
     C                     MOVE AGAGFT    AHAGFT                                              CLE041
     C                     MOVE AGAGFN    AHAGFN                                              CLE041
     C                     MOVE FCLB      AHTRBR                                              CLE041
     C                     MOVE FCUS      AHTRNM                                              CLE041
     C                     MOVE FACT      AHTRFT                                              CLE041
     C                     MOVE FCNO      AHTRFN                                              CLE041
     C                     MOVE FCCY      AHTRCY                                              CLE041
     C                     MOVE RVCR      AHTRRC                                              CLE041
     C                     MOVE @AMT      AHRAMT                                              CLE041
     C                     MOVE VDAT      AHVDAT                                              CLE041
     C                     MOVE AMTP      AHAMTP                                              CLE041
     C                     MOVE LNRF      AHLOAN                                              CLE041
     C                     MOVE 0         AHDEAL                                              CLE041
     C                     MOVE 0         AHUSEQ                                              CLE041
     C                     MOVE 0         AHMTID                                              CLE041
      *                                                                                       CLE041
     C                     ENDSR                                                              CLE041
      *****************************************************************                       CLE041
      /EJECT                                                                                  CSC042
     C********************************************************************                    CSC042
     C*                                                                                       CSC042
     C*  ##CHKC  - Check the currency details                                                 CSC042
     C*                                                                                       CSC042
     C********************************************************************                    CSC042
     C           ##CHKC    BEGSR                                                              CSC042
      *                                                                                       CSC042
     C           *LIKE     DEFN BJCYCD    ##KC                                                CSC042
     C           *LIKE     DEFN Q         ##QSV                                               CSC042
      *                                                                                       CSC042
      * Set off the currency found indicator                                                  CSC042
     C                     MOVEL*BLANK    ##FIC   1                                           CSC042
      *                                                                                       CSC042
      * Save the state of indicator 87 so it can be reset at the end                          CSC042
      * of the SR as it may be used elsewhere in the code                                     CSC042
     C           *IN87     IFEQ *ON                                                           CSC042
     C                     MOVEL'Y'       #IN87   1                                           CSC042
     C                     ELSE                                                               CSC042
     C                     MOVEL'N'       #IN87                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
     C                     SETOF                         87                                   CSC042
      *                                                                                       CSC042
      * Restore Q from ##QSV in case Q is used elsewhere in the code                          CSC042
     C                     Z-ADD##QSV     Q       40                                          CSC042
      *                                                                                       CSC042
      * Are we looking for the same details as the last time this                             CSC042
      * subroutine was called i.e. is Q already set correctly?                                CSC042
      * If so then use the data rather than do another LOKUP                                  CSC042
      * First make sure that we don't reference the 0th array element                         CSC042
     C           Q         IFEQ 0                                                             CSC042
     C                     Z-ADD1         Q                                                   CSC042
     C                     END                                                                CSC042
      * Now see if this search is same as last one performed                                  CSC042
      * If we have a match then seton 87 so the code after this                               CSC042
      * subroutine knows it can use Q directly                                                CSC042
     C           ##KC      IFEQ CURR,Q                                                        CSC042
     C                     SETON                         87                                   CSC042
     C                     ELSE                                                               CSC042
      * Otherwise hunt in the array and seton 87 if found                                     CSC042
     C                     Z-ADD1         Q                                                   CSC042
     C           ##KC      LOKUPCURR,Q                   87                                   CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * Save Q for next time                                                                  CSC042
     C           *IN87     IFEQ *ON                                                           CSC042
     C                     Z-ADDQ         ##QSV                                               CSC042
      * Set the indicator to show the data was found                                          CSC042
     C                     MOVEL'Y'       ##FIC                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * Reset the state of indicator 87.                                                      CSC042
     C           #IN87     IFEQ 'Y'                                                           CSC042
     C                     MOVEL*ON       *IN87                                               CSC042
     C                     ELSE                                                               CSC042
     C                     MOVEL*OFF      *IN87                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
     C                     ENDSR                                                              CSC042
      *                                                                                       CSC042
     C********************************************************************                    CSC042
      /EJECT                                                                                  CSC042
      /EJECT                                                              CLE005
      *****************************************************************   CLE005
      * SRCAUP  -  Credit Agreement Update Processing                 *   CLE005
      * Called by: Main Processing                                    *   CLE005
      * Calls    : SRMOVE - Move values to LECARDPD fields            *   CLE005
      *****************************************************************   CLE005
     C           SRCAUP    BEGSR                                          CLE005
      ***********                                                  161452 179594
      **For*a*reversal*the*amount*is*taken*from*the*facility*histor161452 179594
      **and*does*not*need*converting.******************************161452 179594
     C***********AMTP      IFEQ 'RV'                               161452 179594
     C***********          Z-SUBFAAAMT    @AMT                     161452 179594
     C***********          ELSE                                    161452 179594
      *                                                                   CLE005
     C********** CCY       IFNE FCCY                               CLE005 192329
      *                                                                   192329
      * If there's been a multi-currency rollover, PETEMPLN will          192329
      * contain the old currency amount, so check CLOANCL instead.        192329
     C           AMTP      IFNE 'MC'                                      192329
     C           LNRF      CHAINPETEMPLN             81                   CLE005
     C                     ELSE                                           192329
      * Multi-currency rollover:                                          192329
     C           LNRF      CHAINCLOANCL              81                   192329
     C                     ENDIF                                          192329
      *                                                                   CLE005
     C           *IN81     IFEQ '1'                                       CLE005
     C           *LOCK     IN   LDA                        ************   CLE005
     C                     Z-ADD12        DBASE            * DBERR 12 *   CLE005
     C                     MOVEL'CLOAN   'DBFILE           ************   CLE005
     C                     MOVELLNRF      DBKEY                           CLE005
     C                     MOVEL'LER020  'DBPGM                           CLE005
     C                     SETON                     U7U8                 CLE005
     C                     OUT  LDA                                       CLE005
     C                     EXSR *PSSR                                     CLE005
     C                     EXSR ZSFAU                                     CLE005
     C                     END                                            CLE005
      *                                                                   192329
     C           CCY       IFNE FCCY                                      192329
      *                                                                   CLE005
      ** Get Facility Currency details                                    CLE005
      *                                                                   CLE005
     C                     MOVE FCCY      KEYCCY  3                       CLE005
     C                     EXSR GETCCY                                    CLE005
     C                     MOVE A6NBDP    FCDP    10                      CLE005
      *                                                                   CLE005
      ** Get Currency details                                             CLE005
      *                                                                   CLE005
     C                     MOVE CCY       KEYCCY                          CLE005
     C                     EXSR GETCCY                                    CLE005
     C           FCDP      SUB  A6NBDP    DP      10                      CLE005
     C                     ADD  4         DP                              CLE005
      *****************************************************************                162343 199588
      ***Use*spot*rate*instead*of*facility*ccy*exchange*rate*in********                162343 199588
      ***converting*amount*to*it's*facility*currency.******************                162343 199588
      *****************************************************************                162343 199588
     C**********           EXSR SRCONV                                                 162343 199588
      **********                                                                       162343 199588
     C***********FMDI      IFEQ 'D'                                CLE005 162343
     C***********FCXR      DIV  POWR,DP   FCXRT  159H              CLE005 162343
     C***********1         DIV  FCXRT     FCXRT                    CLE005 162343
     C***********          ELSE                                    CLE005 162343
     C***********FCXR      MULT POWR,DP   FCXRT     H              CLE005 162343
     C***********          END                                     CLE005 162343
     C***********PRAM      MULT FCXRT     @AMT   130H              CLE005 162343
      *                                                                                       199588
     C           FMDI      IFEQ 'D'                                                           199588
     C           FCXR      DIV  POWER,DP  FCXRT  159H                                         199588
     C           PRAM      DIV  FCXRT     @AMT   130H                                         246032
     C********** 1         DIV  FCXRT     FCXRT                                        199588 224974
     C********** 1         DIV  FCXRT     FCXRT     H                                  224974 246032
     C                     ELSE                                                               199588
     C           FCXR      MULT POWER,DP  FCXRT     H                                         199588
     C           PRAM      MULT FCXRT     @AMT      H                                         246032
     C                     END                                                                199588
     C********** PRAM      MULT FCXRT     @AMT   130H                                  199588 246032
     C                     ELSE                                           CLE005
     C                     Z-ADDPRAM      @AMT   130                      CLE005
     C                     END                                            CLE005
     C***********          ENDIF                                   161452 179594
      * If Multi-currency rollover, amount should be negative.            192329
     C           AMTP      IFEQ 'MC'                                      192329
     C                     Z-SUB@AMT      @AMT                            192329
     C                     ENDIF                                          192329
      *                                                                   CLE005
      ** Move the values to LECARDPD. After writing to the file           CLE005
      ** restore the previous values of FCUS, FACT, FSEQ and RECI         CLE005
      *                                                                   CLE005
     C                     EXSR SRMOVE                                    CLE005
     C                     WRITELECARDPF                                  CLE005
      *                                                                   CLE005
     C**********           Z-ADDWTMFC     FCUS                                         CLE005 CSD027
     C                     MOVE WTMFC     FCUS                                                CSD027
     C                     Z-ADDWTMFT     FACT                            CLE005
     C**********           Z-ADDWTMFN     FSEQ                                         CLE005 CLE041
     C                     Z-ADDWTMFN     FCNO                                                CLE041
     C                     MOVE WTMRC     RECI                            CLE005
      *                                                                   CLE005
     C                     ENDSR                                          CLE005
      /EJECT                                                              CLE005
      *****************************************************************   CLE005
      * SRMOVE  -  Move fields to LECARDPD fields                     *   CLE005
      * Called by: SRCAUP                                             *   CLE005
      * Calls    : None                                               *   CLE005
      *****************************************************************   CLE005
     C           SRMOVE    BEGSR                                          CLE005
      *                                                                   CLE005
      ** Save the values of FCUS, FACT, FCNO and RECI                     CLE005
      *                                                                   CLE005
     C**********           Z-ADDFCUS      WTMFC   60                                   CLE005 CSD027
     C                     MOVE FCUS      WTMFC   6                                           CSD027
     C                     Z-ADDFACT      WTMFT   30                      CLE005
     C**********           Z-ADDFSEQ      WTMFN   20                                   CLE005 CLE041
     C                     Z-ADDFCNO      WTMFN   20                                          CLE041
     C                     MOVE RECI      WTMRC   1                       CLE005
      *                                                                   CLE005
     C                     MOVE FCUS      TRNM                            CLE005
     C                     MOVE FTYP      TRFT                            CLE005
     C                     MOVE FSEQ      TRFN                            CLE005
     C                     MOVE FCCY      TRCY                            CLE005
     C                     MOVE 'D'       RECI                            CLE005
      *                                                                   CLE005
     C                     MOVE CANM      FCUS                            CLE005
     C                     MOVE CAFT      FACT                            CLE005
     C                     MOVE CAFN      FCNO                            CLE005
     C/COPY WNCPYSRC,LEH01409
     C                     Z-ADD@AMT      RAMT                            CLE005
     C/COPY WNCPYSRC,LEH01410
      *                                                                   CLE014
      ** Output revolving credit indicator                                CLE014
      *                                                                   CLE014
     C           CLE014    IFEQ 'Y'                                       CLE014
     C                     MOVE RVCR      TRRC                            CLE014
     C                     ENDIF                                          CLE014
      *                                                                   CLE005
     C                     ENDSR                                          CLE005
     C/EJECT
      *****************************************************************                162343 199588
      **SRCONV*-**Convert*amount*to*another*currency*******************                162343 199588
      **Called*by:*Main*Processing,*SRCAUP*****************************                162343 199588
      **Calls****:*ZXRATE,*ZCONV***************************************                162343 199588
      *****************************************************************                162343 199588
      ***********                                                                      162343 199588
     C********** SRCONV    BEGSR                                                       162343 199588
      **********                                                                       162343 199588
      ***If*currencies*are*different*it*is*necessary*to*first*obtain***                162343 199588
      ***the*cross*exchange*rate*between*the*two*currencies*and*use****                162343 199588
      ***this*to*convert*to*appropriate*currency.*Thus,*spot*rate*is***                162343 199588
      ***used*instead*of*the*facility*exchange*rate*from*the*loan.*****                162343 199588
      **********                                                                       162343 199588
     C**********           Z-ADD1         X                                            162343 199588
     C********** CCY       LOKUPCURR,X                   15                            162343 199588
     C********** *IN15     IFEQ '1'                                                    162343 199588
     C**********           MOVE MTDV,X    ZMDI1   1                                    162343 199588
     C**********           Z-ADDCSPT,X    ZRATE1 138                                   162343 199588
     C**********           Z-ADDCCDP,X    ZNBDP1  10                                   162343 199588
     C**********           ELSE                                                        162343 199588
     C********** *LOCK     IN   LDA                                                    162343 199588
     C**********           MOVEL'LER020  'DBPGM                                        162343 199588
     C**********           MOVE 'SDCURRPD'DBFILE           ************                162343 199588
     C**********           Z-ADD17        DBASE            * DBERR 17 *                162343 199588
     C**********           MOVE CCY       DBKEY            ************                162343 199588
     C**********           OUT  LDA                                                    162343 199588
     C**********           EXSR *PSSR                                                  162343 199588
     C**********           ENDIF                                                       162343 199588
      **********                                                                       162343 199588
     C**********           Z-ADD1         X                                            162343 199588
     C********** FCCY      LOKUPCURR,X                   14                            162343 199588
     C********** *IN14     IFEQ '1'                                                    162343 199588
     C**********           MOVE MTDV,X    ZMDI2   1                                    162343 199588
     C**********           Z-ADDCSPT,X    ZRATE2 138                                   162343 199588
     C**********           Z-ADDCCDP,X    ZNBDP2  10                                   162343 199588
     C**********           ELSE                                                        162343 199588
     C********** *LOCK     IN   LDA                                                    162343 199588
     C**********           MOVEL'LER020  'DBPGM                                        162343 199588
     C**********           MOVE 'SDCURRPD'DBFILE           ************                162343 199588
     C**********           Z-ADD18        DBASE            * DBERR 18 *                162343 199588
     C**********           MOVE FCCY      DBKEY            ************                162343 199588
     C**********           OUT  LDA                                                    162343 199588
     C**********           EXSR *PSSR                                                  162343 199588
     C**********           ENDIF                                                       162343 199588
      **********                                                                       162343 199588
     C**********           Z-ADDPRAM      WEAMT  130                                   162343 199588
      **********                                                                       162343 199588
      ***Obtain*cross*exchange*rate*&*cross*multiply/divide*indicator**                162343 199588
      **********                                                                       162343 199588
     C**********           EXSR ZXRATE                                                 162343 199588
      **********                                                                       162343 199588
      ***Set*up*input*fields*for*conversion*SR*************************                162343 199588
      **********                                                                       162343 199588
     C**********           Z-ADDZRATEX    ZEXCH  138                                   162343 199588
     C**********           MOVE ZMDIX     ZMD     1                                    162343 199588
     C**********           Z-ADDWEAMT     ZAMTCI 150                                   162343 199588
     C**********           MOVE CCY       ZCCYI   3                                    162343 199588
     C**********           MOVE FCCY      ZCCYO   3                                    162343 199588
     C**********           Z-ADDZNBDP1    ZCDPI   10                                   162343 199588
     C**********           Z-ADDZNBDP2    ZCDPO   10                                   162343 199588
      **********                                                                       162343 199588
     C**********           EXSR ZCONV                                                  162343 199588
      **********                                                                       162343 199588
     C**********           Z-ADDZAMTCO    @AMT                                         162343 199588
      **********                                                                       162343 199588
     C**********           ENDSR                                                       162343 199588
     C***/EJECT*                                                                       162343 199588
     C********************************************************************
     C*
     C*  ZSFILE - SUBROUTINE TO ENSURE 'P1' SPOOL FILE RECORDED BY RCF
     C*
     C*  CALLED FROM: AFTER EACH OCCURRENCE OF OPEN LER020P1
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C*
     C           ZSFILE    BEGSR
     C*
     C                     Z-ADDSFNUM     ZSNUM   60
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ
     C                     PARM BRCA      SENTY   3
     C                     PARM           SFILE
     C                     PARM           ZSNUM
     C                     PARM           ZSERR   1
     C*
     C           ZSERR     IFEQ 'Y'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     END
     C*
     C                     ENDSR
      *
     C/EJECT
     C********************************************************************
     C*
     C*  ZSFAU - SUBROUTINE TO ENSURE AUDIT SPOOL FILE RECORDED BY RCF
     C*
     C*  CALLED FROM: AFTER EACH ERROR OR AT PGM TERMINATION
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C*
     C           ZSFAU     BEGSR
     C*
      *
      ** Open Audit report
      *
     C                     Z-ADD0         PAGE
     C                     Z-ADDSFNUMU    ZSNUMU  60
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILEU
     C                     PARM           ZSNUMU
     C                     PARM           ZSERR   1
     C*
     C           ZSERR     IFEQ 'Y'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     ELSE
     C*
      *
      ** Write Audit report header
      *
     C                     WRITELER020AH
     C*
     C* If an error has occurred output the database error format
     C*
     C           *INU7     IFEQ '1'
     C                     WRITEDBFMTAU
     C                     ELSE
      *
      ** Write No Details to report format if required ...
      *
     C           @REP      IFEQ 0
     C                     WRITELER020A2
     C                     ELSE
      *
      ** ... otherwise Write Audit report detail
      *
     C                     WRITELER020A1
     C                     END
     C                     END
     C                     END
      *
     C                     RETRN
     C                     ENDSR
      *
     C/EJECT
      ********************************************************************                  MD050278
      *                                                                  *                  MD050278
      *  RTVSA - RETRIEVE SETTLEMENT ACCOUNT DETAILS                     *                  MD050278
      *                                                                  *                  MD050278
      *  CALLED FROM: MAIN PROCESSING                                    *                  MD050278
      *                                                                  *                  MD050278
      *  CALLS: LE000458                                                 *                  MD050278
      *                                                                  *                  MD050278
      ********************************************************************                  MD050278
      *                                                                                     MD050278
     C           RTVSA     BEGSR                                                            MD050278
     C                     CALL 'LE000458'                                                  MD050278
     C                     PARM *BLANKS   RETCOD  7                                         MD050278
     C                     PARM           IACKEY 14                                         MD050278
     C                     PARM           CCY                                               MD050278
     C                     PARM           LNRF                                              MD050278
     C                     PARM *BLANKS   IFCNUM  6                                         MD050278
     C                     PARM *ZEROS    IFLOAN  60                                        MD050278
     C                     PARM *ZEROS    IFFACL  50                                        MD050278
     C                     PARM *ZEROS    IFSEQ   20                                        MD050278
     C                     PARM *ZEROS    IFCOD   20                                        MD050278
     C                     PARM           SCCY                                              MD050278
     C                     PARM           OSAC                                              MD050278
     C                     PARM           SETP                                              MD050278
  ** C                     PARM           OLNO                                              MD050278
     C                     PARM           OSBR                                              MD050278
      *                                                                                     MD050278
     C                     PARM *BLANKS   SEBRCA  3                                         MD050278
     C                     PARM *BLANKS   SECNUM  6                                         MD050278
     C                     PARM *BLANKS   SEACCY  3                                         MD050278
     C                     PARM *ZEROS    SEACOD 100                                        MD050278
     C                     PARM *ZEROS    SEACSQ  20                                        MD050278
     C                     PARM *BLANKS   OATYP   1                                         MD050278
     C           RETCOD    IFEQ '*ERROR*'                                                   MD050278
     C           *LOCK     IN   LDA                                                         MD050278
     C                     Z-ADD101       DBASE                                             MD050278
     C                     MOVEL*BLANKS   DBFILE                                            MD050278
     C                     MOVEL*BLANKS   DBKEY                                             MD050278
     C                     MOVEL'LER020  'DBPGM                                             MD050278
     C                     SETON                     U7U8                                   MD050278
     C                     OUT  LDA                                                         MD050278
     C                     EXSR *PSSR                                                       MD050278
     C                     EXSR ZSFAU                                                       MD050278
     C                     ENDIF                                                            MD050278
     C                     ENDSR                                                            MD050278
     C********************************************************************
     C*
     C*  *PSSR --- SUBROUTINE TO HANDLE ABNORMAL ERROR CONDITIONS
     C*
     C*  CALLED FROM: AFTER ABNORMAL OPERATION OCCURS
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C*
     C           *PSSR     BEGSR                           ** *PSSR **
     C*
     C           @RUN      IFEQ *BLANKS
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C                     END
     C                     SETON                     U7U8LR
     C                     ENDSR                           ** *PSSR **
     C*
     C********************************************************************
     C***/TITLE*SR/ZCONV**************************************************             162343 199588
     C***/COPY*ZSRSRC,ZCONVZ1*********************************************             162343 199588
     C***/TITLE*SR/ZXRATEZ1***********************************************             162343 199588
     C***/COPY*ZSRSRC,ZXRATEZ1********************************************             162343 199588
     *********/TITLE*SR/ZHASH****************
     C*/*****OPY*ZSRSRC,ZHASHZ3**************
     C********************************************************************
     OEMXT4F1FE                EMCHG                                      E30168
     O                         MCYA                                       E30168
** CPY@
(c) Finastra International Limited 2001
**  POWER  **      POWERS OF TEN                                          162343
0000001
0000010
0000100
0001000
0010000
0100000
1000000
