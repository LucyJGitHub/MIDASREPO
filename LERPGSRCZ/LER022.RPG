     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Credit agreement update due to repay')        *
      *****************************************************************
      *                                                               *
      *  Midas - Customer Lending Module                              *
      *                                                               *
      *  LER022 - Credit Agreement Update Due to Repayments           *
      *                                                               *
      *  Function:  This program reduces the facility amount of       *
      *  (COB)      non-revolving credit agreement due to the         *
      *             repayments done on the tranche facilities         *
      *             attached to it.                                   *
      *                                                               *
      *  Called By: LERC20 - Automatic Facility Update                *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. CLE148             Date 23Jul12               *
      *  Prev Amend No. AR787620           Date 10Jun11               *
      *                 CLE064             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246709             Date 31May07               *
      *                 246032             Date 12Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 240315             Date 15Jun06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CGL029             Date 01Sep03               *
      *                 CLE029             Date 04Sep02               *
      *                 CAP073             Date 08Aug02               *
      *                 CLE028             Date 27Jun02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CAP068             Date 25JUN02               *
      *                 CLE023             Date 19Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CLE014             Date 20Mar01               *
      *                 179594             Date 06Jun01               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 161452             Date 16Jun99               *
      *                 CLE005 *Create     Date 22May97               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  AR787620 - Hooks Incorporation                               *
      *             WNCPYSRC,LEH00139                                 *
      *             WNCPYSRC,LEH00140                                 *
      *  CLE064 - Enhancement of Lending Frequencies (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus (Recompile)                              *
      *  246709 - Recompiled due to changes in LF/LEFCLTL8            *
      *           Applied DBA3 fix 223736                             *
      *  246032 - Credit Agreement facility amount was reduced        *
      *           eventhough the related tranche is revolving.        *
      *           Applied R3.5 fix 207862. Same fix with 240315.      *
      *  240315 - Apply R4 fix 217688 to prevent revolving CA's       *
      *           facility amount from being reduced with repayment   *
      *           amount.                                             *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
      *  CLE029 - Addition of Severity code and Limit ID to FCLTYFM   *
      *  CAP073 - Conversion of MN inputs into modular structure to   *
      *           use as APIs. Facility input Transaction Details     *
      *  CLE028 - Flat Rate Personal Loans (Rule of 78s)              *
      *           (Recompile)                                         *
      *  CAP068 - Recompiled for changes to FCLTYFM and FCLTYFN.      *
      *  CLE023 - Lending Facility History Improvements. (Recompiled) *
      *  CLE014 - Customer Driven Lending Enhancements                *
      *  179594 - Remove PART OF fix 161452 as it causes problem with *
      *           revolving facilities.  Apply fix 168305.            *
      *  161452 - Correct the processing which determines whether or  *
      *           not the facility was revolving on the action date.  *
      *           LEFCLTL6 should be LEFCLTL8.                        *
      *  CLE005 - Customer Lending Enhancements - Others              *
      *                                                               *
      *****************************************************************
     FLECARDL0IF  E           K        DISK         KINFSR *PSSR
      ** Credit Agreement Reduction Extract
      *
     F****LEFCLTL6IF  E       K        DISK         KINFSR *PSSR          161452
     FLEFCLTL8IF  E           K        DISK         KINFSR *PSSR          161452
      ** Facility by Credit Agreement
      *
     FHISUPD  IF  E           K        DISK         KINFSR *PSSR
     F*********** HISACTF                           KIGNORE               161452
     F            HISACTF                           KIGNORE               179594
      ** Facility History Amounts
      *
     FFCLTY   UF  E           K        DISK         KINFSR *PSSR
     F            FCLTYHHF                          KIGNORE
     F            FCLTYFMF                          KRENAMEFCLTYFM2
     F            FCLTYFNF                          KRENAMEFCLTYFN2
      ** Facility
      *
     FEMXT4F1LUF  E           K        DISK         KINFSR *PSSR      UC
      ** Exposure Facility
      *
     FLER022P1O   E                    PRINTER                        UC
     F                                              KINFDS SPOOL1
     FLER022AUO   E                    PRINTER
     F                                              KINFDS SPOOLU
      /EJECT
      *****************************************************************
      *                                                               *
      *    F U N C T I O N   O F   I N D I C A T O R S                *
      *                                                               *
      *****21***********End*of*file*for*LEFCLTL6***********************   161452
      *    21           End of file for LEFCLTL8                      *   161452
      *    22           End of file for LECARDL0                      *
      *    23           Beginning of file for HISUPD                  *
      *    24           Chain to FCLTY                                *
      *    25           Record not found in FCLTY                     *
      *    26           End of file for FCLTYZZF                      *
      *                                                               *
      *    30           LER022P1 is open                              *
      *    31           Historic reporting indicator                  *
      *    37           Multibranching is on                          *
      *                                                               *
      *    98           Date Format: DDMMYY (off); MMDDYY (on)        *
      *                                                               *
      *****************************************************************
      /EJECT
     E                    CPY@    1   1 80
      ** Array containing Copyright statement
     E                    POWER   1   7  7 3
     E/COPY ZSRSRC,ZFRPEDZ1
      *
      /SPACE 3
     ILECARDPF
      ** Rename RAMT to avoid overriding of value
      *
     I              RECI                            CRECI
     I              CAXR                            CCAXR
     I              CMDI                            CCMDI
     I              CACY                            CCACY
      *
     ILDA       E DSLDA                         256
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
      **                                    134 141 DBFILE
      **       Defines:                     142 170 DBKEY
      **                                    171 180 DBPGM
      **                                    181 1830DBASE
      *
     IRUNDAT    E DS
      ** Rundat data area for system information
      *
     IMMOD       UDS                            256
      ** MMOD data area
     I                                        7   7 EMFLG
      *
     ILERSTS    E DSLERSTS
     I              FACHISD                         HISDAY
     I              LERC2030                        RENAM1
     I              LERC135                         RENAM2
     I              LERC315                         RENAM3
     I              LERC425                         RENAM4
     I              EOYFLAG                         RENAM5
      *
     INEWKEY      DS
      ** Current LECARDPD record read.
     I**********                              1   60FCUS                                      CSD027
     I                                        1   6 FCUS                                      CSD027
     I                                        7   90FACT
     I                                       10  110FCNO
      *
     IPRVKEY      DS
      ** Previous Facility record read.
     I**********                              1   60WFCUS                                     CSD027
     I                                        1   6 WFCUS                                     CSD027
     I                                        7   90WFACT
     I                                       10  110WFCNO
     I                                        7  110WHFAC
      *
     ISPOOL1      DS
      ** File Information Data Structure for LER022P1
     I                                       83  92 SFILE1
     I                                    B 123 1240SFNUM1
     I                                    B 188 1890OFLLN1
     I                                    B 367 3680PRTLN1
      *
     ISPOOLU      DS
      ** File Information Data Structure for LER022AU
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
     I            DS
      ** Format amount returned by standard subroutine
     I                                        1  22 ZOUT22
     I                                        4  21 ZOUT18
     I                                        4  20 ZOUT17
     I                                       21  21 ZNEG
      *
     ISDBANK    E DSSDBANKPD
      ** External data structures for Bank Details
      *
     ISDBRCH    E DSSDBRCHPD
      ** External data structures for Branch Details
      *
     ISDCURR    E DSSDCURRPD
      ** External data structures for Currency Details
      *
     IDSFDY     E DSDSFDY
      ** Short data structure for access objects
      *
     IDSSDY     E DSDSSDY
      ** Long data structure for access objects
      *
     ISCSARD    E DSSCSARDPD
      ** External data structures for SAR Details
      *
     I/COPY ZSRSRC,ZFRPEDZ2
      /EJECT
      *****************************************************************
      *                   Index to subroutines                        *
      *                                                               *
      *  Main routine                                                 *
      *  SRINIT - Initial Processing                                  *
      *  SRPROC - Detail Processing                                   *
      *  SRUPDF - Update Facility Processing                          *
      *  SRBRCH - Change of Branch Processing                         *
      *  SRTRLR - Facility trailer update and end of program          *
      *  SRAUDT - Print audit report                                  *
      *  SRFMTD - Format output details                               *
      *  SRCURR - Access currency details                             *
      *  SRP1RC - Write a detail record to LER022P1                   *
      *  SRP1EN - Write end of report in LER022P1                     *
      *  SRRCFP - Register the printer file via RCF                   *
      *  SRRCFA - Register the AU Printer File via RCF                *
      *  SRENDP - End of program processing                           *
      *  *PSSR  - Error handling subroutine                           *
      *                                                               *
      *****************************************************************
      *
      ** Perform initial processing
      *
     C                     EXSR SRINIT
      *
      ** Perform detail processing
      *
     C************LOVAL    SETLLLEFCLTL6                                  161452
     C***********          READ LEFCLTL6                 21               161452
     C           *LOVAL    SETLLLEFCLTL8                                  161452
     C                     READ LEFCLTL8                 21               161452
     C           *IN21     DOWEQ*OFF
      *
      ** Save facility details.
      *
     C                     MOVE CNUM      WFCUS
     C                     MOVE FACT      WFACT
     C                     MOVE FCNO      WFCNO
     C                     MOVE BRCA      WFBRC   3
     C                     MOVE FCCY      WFCCY   3
      *
     C           KEYCAR    SETLLLECARDL0
     C                     READ LECARDL0                 22
      *
      ** Do processing until record read in LECARDL0 is equal
      ** to the record read on LEFCLTL8.                                  161452
      ***to*the*record*read*on*LEFCLTL6.********************************* 161452
      *
     C           NEWKEY    DOWEQPRVKEY
     C           *IN22     ANDEQ*OFF
     C                     EXSR SRACTN
     C                     READ LECARDL0                 22
     C                     ENDDO
      *
      ** Update Facility if the amount is greater than zero (0).
      *
     C           WFAMT     IFNE *ZERO
     C                     EXSR SRUPDF
     C                     ENDIF
      *
     C***********          READ LEFCLTL6                 21               161452
     C                     READ LEFCLTL8                 21               161452
     C                     ENDDO
      *
      ** Perform trailer update and end of program processing
      *
     C                     EXSR SRTRLR
     C                     EXSR SRENDP
      *
      /EJECT
      *****************************************************************
      * SRINIT  -  Initial Processing                                 *
      * Called by: Main routine                                       *
      * Calls    : None                                               *
      *****************************************************************
     C           SRINIT    BEGSR
      *
      ** Set up copyright parameter
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ** Define LDA
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVEL'LER022'  DBPGM
     C                     MOVE *BLANKS   DBASE
     C                     OUT  LDA
      *
      ** Define LERSTS
      *
     C           *NAMVAR   DEFN           LERSTS
     C                     IN   LERSTS
      *
      ** Access RUNDAT for multibranching indicator
      *
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
      *
     C           AGMBIN    IFEQ 'Y'
     C                     MOVE '1'       *IN37
     C                     ENDIF
      ************                                                 161452 179594
     C************LIKE     DEFN FARCIN    W#RCIN                   161452 179594
     C************LIKE     DEFN FADATE    W#DATE                   161452 179594
      *
      ** Key list for LECARDL0
      *
     C           KEYCAR    KLIST
     C                     KFLD           WFCUS
     C                     KFLD           WFACT
     C                     KFLD           WFCNO
      *
      ** Key list for HISUPD
      *
     C           KEYHIS    KLIST
     C                     KFLD           WFBRC
     C                     KFLD           WFCUS
     C                     KFLD           WHFAC
     C                     KFLD           VDAT
      ***********                                                  161452 179594
     C***********K#HIS1    KLIST                                   161452 179594
     C***********          KFLD           WFBRC                    161452 179594
     C***********          KFLD           WFCUS                    161452 179594
     C***********          KFLD           WHFAC                    161452 179594
      ***********                                                  161452 179594
     C***********K#HIS2    KLIST                                   161452 179594
     C***********          KFLD           WFBRC                    161452 179594
     C***********          KFLD           WFCUS                    161452 179594
     C***********          KFLD           WHFAC                    161452 179594
     C***********          KFLD           W#DATE                   161452 179594
      *
      ** Key list for FCLTYFM
      *
     C           KEYFCL    KLIST
     C                     KFLD           WFCUS
     C                     KFLD           WFACT
     C                     KFLD           WFCNO
     C                     KFLD           WRCDT
      *
      ** Key list for EMXT4F1L
      *
     C           KEYEMX    KLIST
     C                     KFLD           MCUN
     C                     KFLD           MFTP
     C                     KFLD           MFN
      *
      ** Initialise work fields
      *
     C                     Z-ADD0         RQDLN1  30
     C                     Z-ADD0         DIFLN1  30
     C                     Z-ADD0         WFAMT  150
     C                     MOVE *BLANKS   WRECI   1
     C                     Z-ADD0         RCNTR
      *
      ** Call access program for bank details - Title, Run Date and
      ** Run Day Number
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG   ' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** Handle database error
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           ************
     C                     Z-ADD1         DBASE            * DBERR 01 *
     C                     OUT  LDA                        ************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Check system date format, DDMMYY (*IN98 off)
      **                           MMDDYY (*IN98 on).
      *
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ENDIF
     C/COPY WNCPYSRC,LEH01414
      *                                                                   CLE014
      ** Determine if CLE014 is installed                                 CLE014
      *                                                                   CLE014
     C                     CALL 'AOSARDR0'                                CLE014
     C                     PARM '       ' PRTCD   7                       CLE014
     C                     PARM '*VERIFY' POPTN   7                       CLE014
     C                     PARM 'CLE014'  PSARD   6                       CLE014
     C           SCSARD    PARM SCSARD    DSSDY                           CLE014
      *                                                                   CLE014
      ** Handle Database Error                                            CLE014
      *                                                                   CLE014
     C           PRTCD     IFNE *BLANKS                                   CLE014
     C           PRTCD     ANDNE'*NRF   '                                 CLE014
     C           *LOCK     IN   LDA                                       CLE014
     C                     MOVE 'SCSARDPD'DBFILE                          CLE014
     C                     MOVELPSARD     DBKEY                           CLE014
     C                     Z-ADD7         DBASE                           CLE014
     C                     OUT  LDA                                       CLE014
     C                     EXSR *PSSR                                     CLE014
     C                     ENDIF                                          CLE014
      *                                                                   CLE014
      ** CLE014 is installed                                              CLE014
      *                                                                   CLE014
     C           PRTCD     IFEQ *BLANKS                                   CLE014
     C                     MOVE 'Y'       CLE014  1                       CLE014
     C                     ELSE                                           CLE014
     C                     MOVE 'N'       CLE014                          CLE014
     C                     ENDIF                                          CLE014
     C/COPY WNCPYSRC,LEH00139
      *
      ** Open EM Facility Details File if EM module present.
      *
     C           EMFLG     IFEQ 'Y'
     C                     OPEN EMXT4F1L
     C                     END
      *
      ** Set up event control date
      *
     C           BJDNWD    SUB  1         WECDT   50
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRACTN  -  Loan Action Processing                             *
      * Called by: Main Routine                                       *
      * Calls    : SRCURR - Access currency details                   *
      *****************************************************************
     C           SRACTN    BEGSR
      *
      ** Only process action if facility is a non-revolving credit.
      ** If action is back-valued, check whether facility was revolving
      ** or non-revolving on the value date of the transaction in order
      ** to determine whether the facility needs to be reduced.
      *
     C***********          MOVE 'Y'       WUPDF   1                       161452
     C***********VDAT      IFLT BJRDNB                                    161452
     C***********VDAT      IFLE BJRDNB                             161452 179594
     C                     MOVE 'Y'       WUPDF   1                       179594
     C********** VDAT      IFLT BJRDNB                             179594 CLE014
     C********** VDAT      IFLE BJRDNB                                                 CLE014 240315
     C           VDAT      IFLT BJRDNB                                                        240315
      *
      ** Back-valuation is only allowed up to take-on date.
      *
     C           VDAT      IFLT HISDAY
     C                     MOVE HISDAY    VDAT
     C                     ENDIF
      ***********                                                         161452
      ***Access*last*facility*history*record*on*value*date*************** 161452
      ***********                                                         161452
     C***********KEYHIS    SETGTHISUPD                                    161452
     C***********          READPHISUPD                   23               161452
      ***********                                                         161452
      ***If*BOF*or*different*facility*reference,*check*facility*file***** 161452
      ***********                                                         161452
     C************IN23     IFEQ *ON                                       161452
     C***********WFCUS     ORNE FACNUM                                    161452
     C***********WHFAC     ORNE FAFCTY                                    161452
     C***********RVCR      IFEQ 'Y'                                       161452
     C***********          MOVE 'N'       WUPDF                           161452
     C***********          ENDIF                                          161452
     C***********          ELSE                                           161452
      ***********                                                         161452
      ***Seton*reporting*indicator*and*check*facility*history*file******* 161452
      ***********                                                         161452
     C************IN31     IFEQ '0'                                       161452
     C***********FARCIN    ANDNERVCR                                      161452
     C***********          MOVE '1'       *IN31                           161452
     C***********          ENDIF                                          161452
      ***********                                                         161452
     C***********FARCIN    IFEQ 'Y'                                       161452
     C***********          MOVE 'N'       WUPDF                           161452
     C***********          ENDIF                                          161452
     C***********          ENDIF                                          161452
      ***********                                                         161452
      ***If*Action*is*value*dated*on*run*date,*check*facility*file******* 161452
      ***********                                                         161452
     C***********          ELSE                                           161452
     C***********RVCR      IFEQ 'Y'                                       161452
     C***********          MOVE 'N'       WUPDF   1                       161452
     C***********          ENDIF                                          161452
      *                                                                   179594
      ** Access last facility history record on value date                179594
      *                                                                   179594
     C           KEYHIS    SETGTHISUPD                                    179594
     C                     READPHISUPD                   23               179594
      *                                                                   CLE014
     C                     MOVE RVCR      WKRVCR  1                       CLE014
      *                                                                   CLE014
     C           CLE014    IFEQ 'Y'                                       CLE014
     C           RVCR      ANDEQ'T'                                       CLE014
     C                     MOVE TRRC      WKRVCR                          CLE014
     C                     ENDIF                                          CLE014
      *                                                                   179594
      ** If BOF or different facility reference, check facility file      179594
      *                                                                   179594
     C           *IN23     IFEQ *ON                                       179594
     C           WFCUS     ORNE FACNUM                                    179594
     C           WHFAC     ORNE FAFCTY                                    179594
     C********** RVCR      IFEQ 'Y'                                179594 CLE014
     C           WKRVCR    IFEQ 'Y'                                       179594
     C                     MOVE 'N'       WUPDF                           179594
     C                     ENDIF                                          179594
     C                     ELSE                                           179594
      *                                                                   179594
      ** Seton reporting indicator and check facility history file        179594
      *                                                                   179594
     C           *IN31     IFEQ '0'                                       179594
     C           FARCIN    ANDNERVCR                                      179594
     C                     MOVE '1'       *IN31                           179594
     C                     ENDIF                                          179594
      *                                                                   179594
     C           FARCIN    IFEQ 'Y'                                       179594
     C           FARCIN    OREQ 'T'                                       CLE014
     C           WKRVCR    ANDEQ'Y'                                       CLE014
     C                     MOVE 'N'       WUPDF                           179594
     C                     ENDIF                                          179594
     C                     ENDIF                                          179594
      *                                                                   179594
      ** If Action is value dated on run date, check facility file        179594
      *                                                                   179594
     C                     ELSE                                           179594
      *                                                                                       240315
     C                     MOVE RVCR      WKRVCR                                              240315
      *                                                                                       240315
     C           RVCR      IFEQ 'T'                                                           240315
     C                     MOVE TRRC      WKRVCR                                              240315
     C                     ENDIF                                                              240315
     C********** RVCR      IFEQ 'Y'                                179594 CLE014
     C           WKRVCR    IFEQ 'Y'                                       179594
     C                     MOVE 'N'       WUPDF   1                       179594
     C                     ENDIF                                          179594
      ***********                                                  161452 179594
     C***********          MOVE RVCR      W#RCIN                   161452 179594
     C***********          MOVE *ZEROS    W#DATE                   161452 179594
      ***********                                                  161452 179594
      **Get*the*last*Revolving*Credit*Change*(on history action)***161452 179594
      **reading*backwards*from*the*value*date*of*the*current*action161452 179594
     C***********KEYHIS    SETGTHISUPD                             161452 179594
     C***********K#HIS1    REDPEHISACTF                  23        161452 179594
      ***********                                                  161452 179594
     C************IN23     DOWEQ*OFF                               161452 179594
     C***********HAACTN    IFEQ 'RC'                               161452 179594
     C***********          MOVE HARCIN    W#RCIN                   161452 179594
     C***********          MOVE HADATE    W#DATE                   161452 179594
     C***********          LEAVE                                   161452 179594
     C***********          ENDIF                                   161452 179594
     C***********K#HIS1    REDPEHISACTF                  23        161452 179594
     C***********          ENDDO                                   161452 179594
      ***********                                                  161452 179594
      **If*no*RC*found*access*the*last*record*on*the*existing*histo161452 179594
      **prior*to*(and*including)*the*action*date.*                 161452 179594
     C***********W#DATE    IFEQ *ZEROS                             161452 179594
     C***********KEYHIS    SETGTHISUPD                             161452 179594
     C***********K#HIS1    REDPEFACHISAF                 23        161452 179594
     C************IN23     IFEQ *OFF                               161452 179594
     C***********          MOVE FARCIN    W#RCIN                   161452 179594
     C***********          ENDIF                                   161452 179594
      ***********                                                  161452 179594
      **Otherwise,*read*through*existing*history*from*after*this*da161452 179594
      **and*check*for*a*subsequent*RC.*                            161452 179594
     C***********          ELSE                                    161452 179594
     C***********K#HIS2    SETGTHISUPD                             161452 179594
     C***********K#HIS1    READEFACHISAF                 23        161452 179594
      ***********                                                  161452 179594
     C************IN23     DOWEQ*OFF                               161452 179594
     C***********FADATE    IFGT VDAT                               161452 179594
     C***********          LEAVE                                   161452 179594
     C***********          ENDIF                                   161452 179594
     C***********FAACTN    IFEQ 'RC'                               161452 179594
     C***********          MOVE FARCIN    W#RCIN                   161452 179594
     C***********          ENDIF                                   161452 179594
     C***********K#HIS1    READEFACHISAF                 23        161452 179594
     C***********          ENDDO                                   161452 179594
     C***********          ENDIF                                   161452 179594
     C                     ENDIF
      *
      ** If facility currency is not equal to tranche facility
      ** currency, convert action-amount using credit agreement
      ** exchange rate.
      *
     C***********WUPDF     IFEQ 'Y'                                       161452
     C***********W#RCIN    IFEQ 'N'                                161452 179594
     C           WUPDF     IFEQ 'Y'                                       179594
     C           FCCY      IFNE TRCY
      *
      ** Get action amount currency decimal places
      *
     C                     MOVELTRCY      WCURR   3
     C                     EXSR SRCURR
     C                     Z-ADDA6NBDP    WNDP1   10
      *
      ** Get facility currency decimal places
      *
     C                     MOVELFCCY      WCURR
     C                     EXSR SRCURR
     C                     Z-ADDA6NBDP    WNDP2   10
      *
      ** Convert action amount to facility currency.
      *
     C                     Z-ADDCCAXR     ZEXCH  138
     C                     MOVE CCMDI     ZMD     1
     C                     Z-ADDRAMT      ZAMTCI 150
     C                     MOVE TRCY      ZCCYI   3
     C                     MOVE FCCY      ZCCYO   3
     C                     Z-ADDWNDP1     ZCDPI   10
     C                     Z-ADDWNDP2     ZCDPO   10
     C                     EXSR ZCONV
     C                     Z-ADDZAMTCO    WAMTA  150
      *
     C                     ELSE
     C                     Z-ADDRAMT      WAMTA
     C                     ENDIF
      *
      ** Accumulate action amounts.
      *
     C                     ADD  WAMTA     WFAMT
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRUPDF  -  Update Facility Processing                         *
      * Called by: Main Routine                                       *
      * Calls    : SRFMTD - Format output details                     *
      *            SRBRCH - Change of Branch Processing               *
      *            SRP1RC - Write a detail record to LER022P1         *
      *****************************************************************
     C           SRUPDF    BEGSR
      *
      ** Retrieve facility details
      *
     C                     MOVE 'A'       WRCDT   1
     C           KEYFCL    CHAINFCLTY                24
      *
      ** Handle database error
      *
     C           *IN24     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'FCLTY   'DBFILE           ************
     C                     Z-ADD2         DBASE            * DBERR 02 *
     C                     OUT  LDA                        ************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Reduce facility amount and accumulate total facility
      ** amount before reduction
      *
     C                     Z-ADDFAMT      WSAMT  130
     C                     ADD  FAMT      RVALB
     C/COPY WNCPYSRC,LEH01415
     C                     SUB  WFAMT     FAMT
     C/COPY WNCPYSRC,LEH01416
     C                     ADD  1         RCNTR
      *
     C           FAMT      IFLT 0
     C                     Z-ADD0         FAMT
     C                     Z-ADDWSAMT     WFAMT
     C                     ENDIF
      *
      ** Accumulate total facility amounts after reduction
      *
     C                     ADD  FAMT      RVALA
     C                     Z-ADDFAMT      WTAMT  130
      *
      ** Update facility amount
      *
     C                     UPDATFCLTYFM2
      *
     C                     READ FCLTY                    25
      *
     C           *IN25     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'FCLTY   'DBFILE           ************
     C                     Z-ADD3         DBASE            * DBERR 03 *
     C                     OUT  LDA                        ************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Update total drawn amount and accumulate total facility
      ** amounts reduced
      *
     C                     SUB  WFAMT     TOTD
     C                     ADD  WFAMT     RVALR
     C                     Z-ADDWFAMT     WUAMT  130
     C                     UPDATFCLTYFN2
      *
      ** Format details for output
      *
     C                     EXSR SRFMTD
      *
      ** Process change of branch
      *
     C           WFBRC     IFNE WSFBR
     C           *IN37     ANDEQ*ON
     C           *IN30     OREQ *OFF
     C           *IN37     ANDEQ*OFF
     C                     MOVELWFBRC     WSFBR   3
     C                     EXSR SRBRCH
     C                     ENDIF
      *
      ** Print detail record
      *
     C                     EXSR SRP1RC
      *
     C                     Z-ADD0         WFAMT
     C                     MOVE '0'       *IN31
      *
      ** Update exposure file if necessary
      *
     C           EMFLG     IFEQ 'Y'
     C           RECI      ANDEQ'D'
     C           DTAP      ANDLEWECDT
     C           WECDT     ANDLTDTEX
     C**********           Z-ADDWFCUS     MCUN                                                CSD027
     C                     MOVE WFCUS     MCUN                                                CSD027
     C                     Z-ADDWFACT     MFTP
     C                     Z-ADDWFCNO     MFN
     C           KEYEMX    CHAINEMXT4F1F             25
     C           *IN25     IFEQ '0'
     C                     Z-ADDFAMT      MCYA
     C                     EXCPTEMCHG
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRFMTD  -  Format output details                              *
      * Called by: SRUPDF - Update Facility Processing                *
      * Calls    : None                                               *
      *****************************************************************
     C           SRFMTD    BEGSR
      *
     C                     MOVELWFCUS     RCNUM
     C                     MOVELWFACT     RFACT
     C                     MOVELWFCNO     RFCNO
     C                     MOVELWFCCY     RFCCY
      *
      ** Get currency decimal places
      *
     C                     MOVELWFCCY     WCURR   3
     C                     EXSR SRCURR
     C                     Z-ADDA6NBDP    ZDECS
      *
      ** Format old facility amount
      *
     C                     MOVEL*BLANKS   RSAMT
     C                     Z-ADDWSAMT     ZFLD15
     C                     EXSR ZFRPED
     C           ZNEG      IFEQ '-'
     C                     MOVELZOUT18    RSAMT
     C                     ELSE
     C                     MOVELZOUT17    RSAMT
     C                     ENDIF
      *
      ** Format reduced facility amount
      *
     C                     MOVEL*BLANKS   RTAMT
     C                     Z-ADDWTAMT     ZFLD15
     C                     EXSR ZFRPED
     C           ZNEG      IFEQ '-'
     C                     MOVELZOUT18    RTAMT
     C                     ELSE
     C                     MOVELZOUT17    RTAMT
     C                     ENDIF
      *
      ** Format difference amount
      *
     C                     MOVEL*BLANKS   RUAMT
     C                     Z-ADDWUAMT     ZFLD15
     C                     EXSR ZFRPED
     C           ZNEG      IFEQ '-'
     C                     MOVELZOUT18    RUAMT
     C                     ELSE
     C                     MOVELZOUT17    RUAMT
     C                     ENDIF
     C/COPY WNCPYSRC,LEH00140
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRBRCH  -  Change of Branch Processing                        *
      * Called by: SRUPDF - Update Facility Processing                *
      * Calls    : SRP1EN - Write end of report in LER022P1           *
      *            SRRCFP - Register the printer file via RCF         *
      *****************************************************************
     C           SRBRCH    BEGSR
      *
      ** Print 'End of Report' of LER022P1 if necessary
      *
     C           *IN30     IFEQ '1'
     C                     EXSR SRP1EN
     C                     MOVE '0'       *IN30
     C                     ENDIF
      *
      ** Close and Open printer LER022P1
      *
     C           *IN30     IFEQ *OFF
     C           *IN37     ANDEQ*ON
     C                     CLOSELER022P1
     C                     ENDIF
     C                     OPEN LER022P1
     C                     MOVE '1'       *IN30
      *
      ** Register printer file to RCF
      *
     C                     MOVELSFILE1    SFILE
     C           *IN37     IFEQ *OFF
     C                     MOVE *BLANKS   SENTY
     C                     EXSR SRRCFP
     C                     ELSE
     C                     MOVELWFBRC     SENTY
     C                     EXSR SRRCFP
      *
      ** Get branch details using access object
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   PRTCD   7
     C                     PARM '*KEY    'POPTN   7
     C                     PARM WFBRC     PBRCD   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
      ** Handle database error
      *
     C           WRTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBRCHPD'DBFILE           ************
     C                     MOVELWFBRC     DBKEY            * DBERR 04 *
     C                     Z-ADD4         DBASE            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
      ** Print header details
      *
     C                     WRITELER022H1
     C                     MOVE BRCA      RBRCH
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRTRLR  -  Facility trailer update                            *
      * Called by: Main routine                                       *
      * Calls    : None                                               *
      *****************************************************************
     C           SRTRLR    BEGSR
      *
      ** Update trailer file if there are facilities reduced
      *
     C           RCNTR     IFNE 0
     C                     READ FCLTYZZF                 26
      *
     C           *IN26     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'*READ   'DBKEY            ************
     C                     MOVEL'FCLTYZZ 'DBFILE           * DBERR 05 *
     C                     Z-ADD5         DBASE            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Adjust both the value before and the values after for the
      ** total amount reduced
      *
     C           VLBF      MULT 1000      WKTOT  180
     C                     ADD  VLBL      WKTOT
     C           WKTOT     SUB  RVALR     WKTOT
     C           WKTOT     DIV  1000      VLBF
     C                     MVR            VLBL
     C           VLAF      MULT 1000      WKTOT
     C                     ADD  VLAL      WKTOT
     C           WKTOT     SUB  RVALR     WKTOT
     C           WKTOT     DIV  1000      VLAF
     C                     MVR            VLAL
     C                     Z-ADDBJRDNB    LCD
     C                     MOVE 'A'       CHTP
     C                     UPDATFCLTYZZF
      *
     C                     ENDIF
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRENDP  -  End of program processing                          *
      * Called by: Main routine                                       *
      * Calls    : SRAUDT - Print audit report                        *
      *            SRP1EN - Write end of report in LER022P1           *
      *****************************************************************
     C           SRENDP    BEGSR
      *
      ** Print 'End of Report' of LER022P1 if necessary
      ** before closing printer file.
      *
     C           *IN30     IFEQ '1'
     C                     EXSR SRP1EN
     C                     ENDIF
      *
     C                     CLOSELER022P1
      *
      ** Print audit report
      *
     C                     EXSR SRAUDT
      *
      ** End of program
      *
     C                     MOVE '1'       *INLR
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRAUDT  -  Print audit report                                 *
      * Called by: SRENDP - End of program processing                 *
      * Calls    : SRRCFA - Register the AU printer file via RCF      *
      *****************************************************************
     C           SRAUDT    BEGSR
      *
      ** Register Audit report to RCF
      *
     C                     EXSR SRRCFA
      *
      ** Output Report Header
      *
     C                     WRITELER022AH
      *
      ** If there is a db error, output the db error information
      *
     C           *INU7     IFEQ '1'
     C                     WRITEDBERRAU
     C                     ELSE
      *
      ** Or, if no records updated, Output "No Details" message.
      *
     C           RCNTR     IFEQ 0
     C                     WRITELER022A2
     C                     ELSE
     C                     WRITELER022A1
     C                     ENDIF
     C                     ENDIF
      *
      ** Close Audit printer file
      *
     C                     CLOSELER022AU
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRCURR  - Access currency details                             *
      * Called by: SRACTN - Loan Action Processing                    *
      *            SRFMTD - Format output details                     *
      * Calls    : None                                               *
      *****************************************************************
     C           SRCURR    BEGSR
      *
      **  Access SDCURRPD with access object
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANK  'PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM WCURR     PCURR   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** Handle database error
      *
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCURRPD'DBFILE           ************
     C                     MOVELWCURR     DBKEY            * DBERR 06 *
     C                     Z-ADD6         DBASE            ************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRP1RC  -  Write a detail record to LER022P1                  *
      * Called by: SRUPDF - Update Facility Processing                *
      * Calls    : None                                               *
      *****************************************************************
     C           SRP1RC    BEGSR
      *
      ** Check that sufficient lines remain for the Format. If not,
      ** write out the Main Headings on a new page
      *
     C                     Z-ADD1         RQDLN1
     C           OFLLN1    SUB  PRTLN1    DIFLN1
     C           DIFLN1    IFLE RQDLN1
     C                     WRITELER022H1
     C                     ENDIF
      *
      ** Write out Detail Record
      *
     C                     WRITELER022D1
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRP1EN  -  Write end of report in LER022P1                    *
      * Called by: SRBRCH - Change of Branch Processing               *
      * Calls    : None                                               *
      *****************************************************************
     C           SRP1EN    BEGSR
      *
      ** Check that sufficient lines remain for the Format. If not,
      ** write out the Main Headings on a new page
      *
     C                     Z-ADD4         RQDLN1
     C           OFLLN1    SUB  PRTLN1    DIFLN1
     C           DIFLN1    IFLE RQDLN1
     C                     WRITELER022H1
     C                     ENDIF
      *
      ** Write out Total Format
      *
     C                     WRITELER022T1
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRRCFP  -  Register the printer file via RCF                  *
      * Called by: SRBRCH - Change of Branch Processing               *
      * Calls    : None                                               *
      *****************************************************************
     C           SRRCFP    BEGSR
      *
      ** Ensure Report Spool File recorded by RCF
      *
     C                     Z-ADDSFNUM1    ZSNUM   60
      *
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM           SENTY   3
     C                     PARM           SFILE  10
     C                     PARM           ZSNUM
     C                     PARM           ZSERR   1
      *
      ** If Error occurs during ZSFILE processing, then return to the
      ** Calling Program
      *
     C           ZSERR     IFEQ 'Y'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * SRRCFA  -  Register the AU Printer File via RCF               *
      * Called by: SRAUDT - Print audit report                        *
      * Calls    : None                                               *
      *****************************************************************
     C           SRRCFA    BEGSR
      *
      ** Ensure Audit Spool File recorded by RCF
      *
     C                     Z-ADDSFNUMU    ZSNUMU  60
      *
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ
     C                     PARM *BLANKS   SENTY
     C                     PARM           SFILEU
     C                     PARM           ZSNUMU
     C                     PARM *BLANK    ZSERR
      *
      ** If Error occurs during ZSFILE processing, then return to the
      ** Calling Program
      *
     C           ZSERR     IFEQ 'Y'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
      ** Check to see that *PSSR has not already been called
      *
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     DUMP
     C                     END
      *
      ** If *PSSR already run, then just end the program here
      *
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
      *
      ** Print audit report
      *
     C                     EXSR SRAUDT
      *
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT
     C/COPY ZSRSRC,ZFRPEDZ3
      /EJECT
     OEMXT4F1FE                EMCHG
     O                         MCYA
      /EJECT
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**  POWER - Array of powers for currency conversion
0000001
0000010
0000100
0001000
0010000
0100000
1000000
