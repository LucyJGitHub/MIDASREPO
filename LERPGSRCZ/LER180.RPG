     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Lending fee accrual reports')                 *
      *****************************************************************
      *                                                               *
      *  Midas Customer Lending Module                                *
      *                                                               *
      *  LER180 - Outstanding Fees                                    *
      *                                                               *
      *  Function: This program reports fees outstanding during the COB
      *                                                               *
      *  Called By: LERC15                                            *
      *                                                               *
      *  (COB)                                                        *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. MD047993           Date 23Sep17               *
      *                 MD035545           Date 11Sep15               *      
      *                 MD037658           Date 19Feb16               *
      *                 MD046351           Date 23Aug17               *
      *                 MD026385           Date 25Apr14               *
      *                 AR894146           Date 06Feb13               *
      *                 AR996895           Date 25Nov12               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CLE073             Date 13May08               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      *                 CER047             Date 19May08               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 CSC042             Date 16Feb09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 CPK028             Date 25May07               *
      *                 246141             Date 26Mar07               *
      *                 246309             Date 09Mar07               *
      *                 246018             Date 26Feb07               *
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 26Sep06               *
      *                 212048             Date 06Jun06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CLE106             Date 27Apr05               *
      *                 CSW037A            Date 02May05               *
      *                 CIR013             Date 25Apr05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 CAS006             Date 21Jan03               *
      *                 CAS005             Date 16Dec02               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 204452             Date 03May02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 200289             Date 19Nov01               *
      *                 193475             Date 29Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CLE013             Date 11Dec00               *
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CLE009             Date 26Apr99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 158687             Date 13Apr99               *
      *                 156582             Date 25Mar99               *
      *                 152166             Date 21Jan99               *
      *                 147894             Date 04Dec98               *
      *                 141453             Date 17Feb99               *
     F*                 140840             Date 18Sep98               *
     F*                 138165             DATE 29SEP98               *
     F*                 138421             DATE 28SEP98               *
     F*                 CLE005             Date 22May97               *
     F*                 S01408             Date 06Sep96               *
     F*                 103019             Date 22May96               *
     F*                 101322             DATE 22MAY96               *
     F*                 100657             DATE 22MAY96               *
     F*                 100658             DATE 22MAY96               *
     F*                 100431             DATE 22MAY96               *
     F*                 100515             DATE 22MAY96               *
     F*                 085910             DATE 29MAY95               *
     F*                 085915             DATE 08MAY95               *
     F*                 085914             DATE 08MAY95                  *
     F*                 S01408             DATE 27JUN95                  *
     F*                 085677             DATE 29MAR95                  *
     F*                 085309             DATE 28MAR95                  *
     F*                 052703             DATE 27APR93                  *
     F*                 BH3518             DATE 08SEP92                  *
     F*                 BHBC01             DATE 03SEP92                  *
     F*                                                                  *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  MD047993 - Modified MD035545. Removed dependency on Accrue   *
      *             on Last Day indicator.                            *
      *  MD035545 - LE: Interest Calculation in Leap year. Consider   *
      *             Accrue on Last Day Indicator for method 6.        *      
      *  MD037658 - Define NDAYS/WDAYS w/decimal to cater calc basis 6*
      *  MD046351 - Rounding and truncation in fee accrual            *
      *             calculations due to mult/div using 15,9 fields    *
      *             being placed into 13,0/15,0 result fields.        *
      *  MD026385 - Many fields with unknown data 99.999999999.       *
      *           - Accrued amount are incorrect.                     *
      *  AR894146 - An array index not valid error was encountered    *
      *             during COB run thus Component LERC18 00001 failed.*
      *             The length of index T and variable T2 is increased*
      *             from 2 to 4. Applied part of fix 246309A.         *
      *             (Child: AR894147)                                 *
      *  AR996895 - Incorrect acrrual interest calculation            *
      *             (Child: AR996897) (Recompile)                     *
      *  CLE134 - Past Due Call Loan Processing                       *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  CLE073 - Calculated Loan Based Fees                          *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *            to Midas Plus (Recompile)                          *
      *  CER047 - German Features LF037-00 Reporting §24c             *
      *           (Recompile)                                         *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  CSC042 - COB Performance fix. Only access AOBRCHR0 on change of *
      *           branch rather than every record as input file sorted by*
      *           branch                                                 *
      *           Pgm sets up arrays of ccy details in first cycle and
      *           then ignores them and calls AOCURRR* >300K times
      *  CPK028 - @VCNUM field should be 6A                           *
      *  246141 - Recompiled due to changes in ZINTDYZ2               *
      *  246309 - Accruals should be grouped together for syndication.*
      *           Modified the sorting for LER180P1 :                 *
      *           1. Facility                                         *
      *           2. Fee Sequence                                     *
      *           3. Calculated Amount (Estimated Avg then Accrued)   *
      *           4. PTFI - Receivable, Internal, Payable             *
      *  246018 - Divide by zero error.                               *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  212048 - If calc method 6 then INT6DY contains the number    *
      *           of days from ZINTDY.                                *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type                              *
      *  CLE106 - Syndication Manager                                 *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over ZINTDY.                              *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  CAS005 - Enahancements to CAS001, CAS002 and CAS004          *
      *           (Recompile)                                         *
      *  204452 - Recompiled due to changed PF/LEFEED.                *
      *  200289 - Increase facility sequence number in FACHISA from   *
      *           2N to 3N.                                           *
      *  193475 - 'Receivable', 'Payable' or 'Internal' fee indicator *
      *           will only show on report if CLE006 is ON.           *
      *  CLE013 - Customer Lending Fees Enhancement - Phase 1         *
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
      *  CLE009 - LE I/C Swift Message Generation for Fees            *
      *           Recompiled due to changes in LEFEED                 *
      *  158687 - Header 'fee up to and including' should be 'fee and *
      *           past due up to and including' to be consistent with *
      *           the report details. Recompiled due to changes in    *
      *           LER180P1, P2, P3 and P4.                            *
      *  156582 - LER180, fee accrual report should subtract payables *
      *  152166 - Fees calculated as 2 days to next due date when it  *
      *           should be 1.                                        *
      *  147894 - LER180 Fee Currency is wrong                        *
      *           Recompiled due to changes in LER180P1               *
      *  141453 - Recompiled due to changes in PF/LEFEED              *
     F*  140840 - Payable Fees not deducted from accrued amount       *
     F*  138165 - Remove fix 101322.  Accrue on Last Day indicator    *
     F*           should not be considered in the computation of      *
     F*           payment due for average balance.  Applied fix       *
     F*           129834.                                             *
     F*  138421 - LER180P1 "From Date" should show FELPDT even if it  *
     F*           is equal to CODT.  Past Due amounts (FEAMTP and     *
     F*           FEPAMP) should not be included in the "Accrued      *
     F*           Amount" in LER180P1.                                *
     F*           This fix should always go together with fix 138165  *
     F*           and 123004(in LER135).                              *
     F*  CLE005 - Customer Lending Enhancements - Others (T3)         *
     F*  S01408 - Add hook LER180CCP2                                 *
     F*           Add hook LER180CCP3                                 *
     F*           Add hook LER180FFP1                                 *
     F*  103019 - If fee is due on next working day, use the          *
     F*           previous amounts in showing the accrued amount.     *
     F*           This is related to fix 100658.                      *
     F*  101322 - Take Accrue on Last Day indicator into account      *
     F*           when calculating the fee due amount.                *
     F*  100657 - Change the report format and text of LER180P1.      *
     F*           Change the narratives for the calculation types     *
     F*  100658 - Calculated amount and accrued amount are incorrect  *
     F*           for calculated fees.                                *
     F*  100431 - Fee currency name in headings getting corrupted     *
     F*           by subsequent chain to ccy file with facility ccy   *
     F*           Applied fix 092195.                                 *
     F*  100515 - Recompile program due to changes in LEFEED.         *
     F*  085910 - Correct printing of report to avoid overprinting.      *
     F*  085915 - Correct calculated/accrued amount printed in LER180    *
     F*           reports for amortised and accrued on fixed amount      *
     F*           fees.                                                  *
     F*  085914 - Suppress reporting of single payment (bullet) fees     *
     F*           in Loan Amortization report.                           *
     F*           Addition of core hook LER180CCP1                       *
     F*  S01408 - Addition of core hook LER180CCPG                       *
     F*  085677 - If there is no record found on CLOAN for a fee         *
     F*           attached to a Loan (not facility), because the loan    *
     F*           has matured; and historic retention period on LE ICD   *
     F*           is GT 0, chain to MLOAN instead.                       *
     F*  085309 - Set up 'P' before doing operation on array POWER       *
     F*  052703 - Fees due tomorrow not reported correctly               *
     F*  BH3518 - Formatting changes                                     *
     F*  BHBC01 - Fee narrative not picked up and pgm falls over         *
     F*                                                                  *
     F********************************************************************
      *------------------------------------------------------------------*
     FLEFEEAC IF  E           K        DISK
      * Lending Fees - by branch, currency, facility type, customer &
      * fee code
      *
     FFACHISH IF  E           K        DISK
     FFACHSAL1IF  E           K        DISK
     F***FEEKEY**IF**E           K        DISK                     052703 100658
     FFCLTY   IF  E           K        DISK
     F            FCLTYHHF                          KIGNORE
     F            FCLTYFNF                          KIGNORE
     F            FCLTYZZF                          KIGNORE
     FCLOAN   IF  E           K        DISK
     F            CLOANHHF                          KIGNORE
     F            CLOANCKF                          KIGNORE
     F            CLOANZ1F                          KIGNORE
     FMLOAN   IF  E           K        DISK                               085677
     F            CLOANCLF                          KRENAMEMLOANCLF       085677
     F***SDCURRPDIF  E           K        DISK                                                CSC042
     FSDCURRPDIF  E           K        DISK                           UC                      CSC042
     FLER180P1O   E             80     PRINTER      KINFDS SPOOL1     UC
      *
     FLER180P2O   E             81     PRINTER      KINFDS SPOOL2     UC
      *
     FLER180P3O   E             82     PRINTER      KINFDS SPOOL3     UC
      *
     FLER180P4O   E             83     PRINTER      KINFDS SPOOL4     UC
      *
     FLER180AUO   E                    PRINTER      KINFDS SPOOLU
      *
     F/COPY WNCPYSRC,LER180FFP1                                           S01408
      *****************************************************************
     F*
     F*   FUNCTION OF INDICATORS
     F*
     F* 01    First Cycle indicator
     F* 11    Output Fee rate rather than amount
     F* 12    Output Fee type rather than amount
     F* 13    Work indicator
     F* 14    Work indicator
     F* 16    Output Estimated Average amount                             100657
     F* 18    Read of FACHSAL1
     F* 19    Last Payment Date = 0
     F* 20    Work indicator
     F* 24    Multi Branch system
     F* 25    Work indicator
     F* 30    Number of Decimal Places = 0
     F* 31    Number of Decimal Places = 1
     F* 32    Number of Decimal Places = 2
     F* 33    Number of Decimal Places = 3
     F* 34    Number of Decimal Places = 0
     F* 35    Number of Decimal Places = 1
     F* 36    Number of Decimal Places = 2
     F* 37    Number of Decimal Places = 3
     F* 50    Fee Payable/Fee Receivable indicator                        CLE005
     F* 51    Fee Payable/Fee Receivable indicator                        CLE005
     F* 52    Fee Payable/Fee Receivable indicator                        CLE005
     F* 70    Work indicator
     F* 71    Work indicator
     F* 80    Overflow indicator - LER180P1
     F* 81    Overflow indicator - LER180P2
     F* 82    Overflow indicator - LER180P3
     F* 83    Overflow indicator - LER180P4
     F* 98    American Date Format
     F* 99    Access object error
     F* U7&U8 Database error handling
     F*
     F*****************************************************************
     F*
     F*  Subroutine Index
     F*
     F* INIT   - Initialisation subroutine
     F* SRFACY - Facility Fee Processing
     F* SRLOAN - Loan Fee Processing
     F* CHANGE - Change of branch/currency/facility type processing
     F* AVCALC - Calculation of average amount based fees to date
     F* ACCRUE - Actual calculation of fee for average amount
     F* AUDIT  - Audit Report subroutine
     F* LSTRAT - Search of fee rates for appropriate one to use
     F* *PSSR  - Abnormal error conditions
     F* ZXRATE - Midas standard subroutine
     F* ZCONV  - Midas standard subroutine
     F*
     F*****************************************************************
     F/EJECT
     E                    CPY@    1   1 80
     E                    POWER   1   7  7 3             POWER ARRAY
     E********************NARR    1   3 10               Fee Narratives   100657
     E                    NARR    1  17 10               Fee Narratives   100657
     E                    TABCAL  6   6  1 0 TABCBS  5 0 CALC.BASES
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZDATE9Z1                                               CLE013
     E                    FEAM        5 11 0A            FEE AMOUNTS
     E                    FAM         5 13 0A            FEE AMOUNTS
     E                    FRT         5  7 5A            FEE RATES
     E                    FPC         5  6 3A            FEE PERCENTAGE
     E                    CURR      150  3               ALL CCYS
     E                    CSPT      150 13 8             SPOT RATES/CCY
     E                    MTDV      150  1               M/D INDICATOR/CCY
     E                    CCDP      150  1 0             DEC PLACES/CCY
     E                    CCNO      150  2 0             SORT SEQ.NO/CCY
     E                    CYNM      150 14               Curr Name                            CSC042
     E                    AKY        10  1               A/C KEYS         052703
     E                    ARAC     5000150               FEE ACCRUALS DETAILS                 246309
     E                    ##BR      999  3               Branch Codes                         CSC042
     E                    ##BN      999 30               Branch Names                         CSC042
      *
     E/EJECT
      *                                                                   CLE005
      ** Rename NLRA field in CLOANZ1F Format in file MLOAN               CLE005
     ICLOANZ1F                                                            CLE005
     I              NLRA                            NLRAZ                 CLE005
      *                                                                   CLE005
      *                                                                   CLE005
      ** Fee Accruals and Past Due Details                                                    246309
     IDSFEAC      DS                                                                          246309
     I                                        1   50DFACL                                     246309
     I                                        1   30DFTYP                                     246309
     I                                        4   50DFSEQ                                     246309
     I                                        6   70DFESEQ                                    246309
     I                                        8   8 DVAMT                                     246309
     I                                        9   9 DLNAR                                     246309
     I**********                             10  150DCNUM                              246309 CPK028
     I                                       10  15 DCNUM                                     CPK028
     I                                       16  35 DBCRNM                                    246309
     I                                       36  37 DFCOD                                     246309
      * Amounts                                                                               246309
     I                                       38  50 DFAMTS                                    246309
     I                                       51  63 DFEEAM                                    246309
     I                                       64  76 DCALCD                                    246309
     I                                       77  89 DPOSTD                                    246309
      * Indicators                                                                            246309
     I                                       90  99 DINDS                                     246309
     I                                       90  90 DIN11                                     246309
     I                                       91  91 DIN12                                     246309
     I                                       92  92 DIN16                                     246309
     I                                       93  93 DIN30                                     246309
     I                                       94  94 DIN31                                     246309
     I                                       95  95 DIN32                                     246309
     I                                       96  96 DIN33                                     246309
     I                                       97  97 DIN50                                     246309
     I                                       98  98 DIN51                                     246309
     I                                       99  99 DIN52                                     246309
     I                                      100 100 DIN53                                     246309
      * Other Details                                                                         246309
     I                                      101 107 DBCRTN                                    246309
     I**********                            111 114 DFCCY                            246309 MD026385
     I                                      111 113 DFCCY                                   MD026385
     I                                      114 120 DRDATE                                    246309
     I                                      121 122 DECALT                                    246309
     I                                      126 135 DECOMT                                    246309
     I                                      136 142 DERATE                                    246309
      *                                                                                       246309
     I            DS                                                      BHBC01
     I                                        1   20WKFCOD                BHBC01
     I                                        1   2 WKFCOA                BHBC01
     I            DS
     I                                        1  130FEEAM0
     I                                        1  131FEEAM1
     I                                        1  132FEEAM2
     I                                        1  133FEEAM3
     I            DS
      ** Fee amounts data structure
     I                                    P   1  300FEAM
     I                                    P   1   60FEAMT1
     I                                    P   7  120FEAMT2
     I                                    P  13  180FEAMT3
     I                                    P  19  240FEAMT4
     I                                    P  25  300FEAMT5
      *
     I            DS
      ** Fee rates data structure
     I                                    P   1  205FRT
     I                                    P   1   45FEFRT1
     I                                    P   5   85FEFRT2
     I                                    P   9  125FEFRT3
     I                                    P  13  165FEFRT4
     I                                    P  17  205FEFRT5
      *
     I            DS
      ** Amounts data structure
     I                                        1  150FCTOTA
     I                                        1  150FCTOA0
     I                                        1  151FCTOA1
     I                                        1  152FCTOA2
     I                                        1  153FCTOA3
      *
     I            DS
      ** Amounts data structure
     I                                        1  150FCTOTM
     I                                        1  150FCTOM0
     I                                        1  151FCTOM1
     I                                        1  152FCTOM2
     I                                        1  153FCTOM3
      *
     I            DS                                                      BH3518
     I** Amounts data structure                                           BH3518
     I                                        1  150FATOA0                BH3518
     I                                        1  151FATOA1                BH3518
     I                                        1  152FATOA2                BH3518
     I                                        1  153FATOA3                BH3518
     I*                                                                   BH3518
     I            DS                                                      BH3518
     I** Amounts data structure                                           BH3518
     I                                        1  150FATOM0                BH3518
     I                                        1  151FATOM1                BH3518
     I                                        1  152FATOM2                BH3518
     I                                        1  153FATOM3                BH3518
     I*                                                                   BH3518
     I            DS
      ** Amounts data structure
     I                                        1  150CFTOTA
     I                                        1  150CFTOA0
     I                                        1  151CFTOA1
     I                                        1  152CFTOA2
     I                                        1  153CFTOA3
      *
     I            DS
      ** Amounts data structure
     I                                        1  150CFTOTM
     I                                        1  150CFTOM0
     I                                        1  151CFTOM1
     I                                        1  152CFTOM2
     I                                        1  153CFTOM3
     I*                                                                   BH3518
     I            DS                                                      BH3518
     I** Amounts data structure                                           BH3518
     I                                        1  150CATOA0                BH3518
     I                                        1  151CATOA1                BH3518
     I                                        1  152CATOA2                BH3518
     I                                        1  153CATOA3                BH3518
     I*                                                                   BH3518
     I            DS                                                      BH3518
     I** Amounts data structure                                           BH3518
     I                                        1  150CATOM0                BH3518
     I                                        1  151CATOM1                BH3518
     I                                        1  152CATOM2                BH3518
     I                                        1  153CATOM3                BH3518
      *
     I            DS
      ** Amounts data structure
     I                                        1  150CLTOTA
     I                                        1  150CLTOA0
     I                                        1  151CLTOA1
     I                                        1  152CLTOA2
     I                                        1  153CLTOA3
      *
     I            DS
      ** Amounts data structure
     I                                        1  150CLTOTM
     I                                        1  150CLTOM0
     I                                        1  151CLTOM1
     I                                        1  152CLTOM2
     I                                        1  153CLTOM3
     I*                                                                   BH3518
     I            DS                                                      BH3518
     I** Amounts data structure                                           BH3518
     I                                        1  150CXTOA0                BH3518
     I                                        1  151CXTOA1                BH3518
     I                                        1  152CXTOA2                BH3518
     I                                        1  153CXTOA3                BH3518
     I*                                                                   BH3518
     I            DS                                                      BH3518
     I** Amounts data structure                                           BH3518
     I                                        1  150CXTOM0                BH3518
     I                                        1  151CXTOM1                BH3518
     I                                        1  152CXTOM2                BH3518
     I                                        1  153CXTOM3                BH3518
      *
     I            DS
     I                                        1  130FAMT0
     I                                        1  131FAMT1
     I                                        1  132FAMT2
     I                                        1  133FAMT3
     I/COPY WNCPYSRC,LER180I002
      *
     I            DS
     I                                        1  130LAMT0
     I                                        1  131LAMT1
     I                                        1  132LAMT2
     I                                        1  133LAMT3
      *
     I            DS
     I                                        1  130CALCD0
     I                                        1  131CALCD1
     I                                        1  132CALCD2
     I                                        1  133CALCD3
      *
     I            DS
     I                                        1  130POSTD0
     I                                        1  131POSTD1
     I                                        1  132POSTD2
     I                                        1  133POSTD3
      *
     I            DS
     I                                        1   50FEFACL
     I                                        1   5 FACNO
     I                                        1   30FTYP
     I                                        1   3 WFTYP                 052703
     I                                        4   50FSEQ
     I                                        6   70FEFCOD                052703
     I                                        6   7 WFCOD                 052703
     ISPOOL1      DS
      ** File information data structure
     I                                       83  92 SFILE1
     I                                    B 123 1240SFNUM1
     I                                    B 367 3680LINE1
     ISPOOL2      DS
      ** File information data structure
     I                                       83  92 SFILE2
     I                                    B 123 1240SFNUM2
     I                                    B 367 3680LINE2
     ISPOOL3      DS
      ** File information data structure
     I                                       83  92 SFILE3
     I                                    B 123 1240SFNUM3
     I                                    B 367 3680LINE3
     ISPOOL4      DS
      ** File information data structure
     I                                       83  92 SFILE4
     I                                    B 123 1240SFNUM4
     I                                    B 367 3680LINE4
      *
     ISPOOLU      DS
      ** File information data structure
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
     IPSDS       SDS
     I** Program Status
     I                                      244 253 JOB
     I                                      254 263 USER
     ILDA       E DSLDA
      * Database error handling
      *
     ILESTAT    E DSLESTAT
      **  Data Structure to obtain control date
     I              FLSETUP                         SETUP
     I              HSTPROC                         HIST
      *
     IRUNDAT    E DSRUNDAT
      ** Data area RUNDAT
     I              AGMBIN                          MBIN
      *
     ISDBANK    E DSSDBANKPD
      ** Bank details
      *
     ISDFEE     E DSSDFEEPD
      ** External DS for fee code details
     I*
     ISDCURR    E DSSDCURRPD
      ** Currency Type
     I*
     ISDFACT    E DSSDFACTPD
      ** Facility Type
     I*
     ISDLOAN    E DSSDLOANPD
      ** Loan Type Sub types
      *
     ISDBRCH    E DSSDBRCHPD
      ** External DS for branch name details
     I              A8BRNM                          BRNM
      *
     ISDCUST    E DSSDCUSTPD
     I              QQDFAC                          #DFAC1                                    CGL029
     I** External DS for customer details
      *
     I***SDGELR****E*DSSDGELRPD*                                   101322 138165
     I***General*Ledger*Details*                                   101322 138165
     I**************************                                   101322 138165
     IDSFDY     E DSDSFDY
      ** First DS for access programs, short data structure
      *
     IDSSDY     E DSDSSDY
      ** Second DS for access programs, long data structure
      *
     ISDCLND    E DSSDCLNDPD                                              085677
      **  EXTERNAL DS FOR CUSTOMER LENDING DETAILS                        085677
     I/COPY WNCPYSRC,LER180I001
      *                                                                   CLE005
     ISCSARD    E DSSCSARDPD                                              CLE005
      ** Switchable Features File                                         CLE005
      *                                                                   CLE005
     I***SDGELR*   E DSSDGELRPD                                                    MD035545 MD047993
     I**********    QQACCD                          ACCDQQ                         MD035545 MD047993
      ***General*ledger*details****************************************            MD035545 MD047993
      *                                                                                     MD035545
     I              'LECalcBasis6LeapYear'C         WPARML                                  MD035545
     I/COPY ZSRSRC,ZINTDYZ1                                               CLE013
     I/COPY ZSRSRC,ZDATE9Z2                                               CLE013
     I/COPY ZSRSRC,ZDAT10Z1                                               CLE013
     F*****************************************************************
      *
     C/EJECT
      *
     C  N01                Z-ADD0         @REP1   50
     C  N01                Z-ADD0         @REP2   50
     C  N01                EXSR INIT
     C                     READ LEFEEAC                  70
     C           *IN70     DOWEQ'0'
     C/COPY WNCPYSRC,LER180C002
     C*
     C           FEPYON    IFNE ' '                                       085914
     C*
     C***  Only show active fees and past due fees
     C*
     C           FEPSTD    IFLE CODT
     C           FEPEND    ANDGECODT
     C           FERECI    ANDEQ'D'
     C           FEPSTD    ORLE CODT
     C           FEPEND    ANDEQ0
     C           FERECI    ANDEQ'D'
     C           FEPEND    ORLT CODT
     C           FEAMTP    ANDGT0
      *
      ** Save Current Facility Details for SR WRFEAC                                          246309
      *                                                                                       246309
     C                     Z-ADDFTYP      @VFAC   30                                          246309
     C                     Z-ADDFSEQ      @VSEQ   20                                          246309
     C**********           Z-ADDFECNUM    @VCNUM  60                                   246309 CPK028
     C                     MOVE FECNUM    @VCNUM  6                                           CPK028
     C                     MOVE FEFSEQ    @VFSEQ  20                                        MD026385
     C                     MOVE FEFCOD    @VFCOD  20                                        MD026385
     C                     MOVELFECALT    @VCALT  2                                         MD026385
     C*
     C*** Do totalling if branch, currency, or facility type changed
     C*
     C           SVBRC     IFNE FEBRCA
     C           SVCCY     ORNE FEFCCY
     C           SVFAC     ORNE FTYP
     C                     EXSR CHANGE
     C                     END
     C/COPY WNCPYSRC,LER180C006
     C*
     C           FEFACL    CASNE*ZEROS    SRFACY           Facility Fees
     C                     CAS            SRLOAN           Loan Fees
     C                     END
     C                     MOVE BRCA      SVBRC   3
     C                     MOVE FEFCCY    SVCCY   3
     C**********           Z-ADDFECNUM    SVNUM   60                                          CSD027
     C                     MOVE FECNUM    SVNUM   6                                           CSD027
     C                     Z-ADDFEFCOD    SVCOD   20
     C                     Z-ADDFTYP      SVFAC   30
     C                     MOVE FELTYP    SVLTYP  2
     C                     MOVE FESUTP    SVSUTP  2
     C                     MOVE FECLAS    SVCLAS  4                                           CLE042
     C*
     C                     END
     C*
     C                     END                                            085914
     C*
     C                     READ LEFEEAC                  70
     C*
     C                     END
     C*
     C                     Z-ADD0         FTYP
     C                     MOVE *BLANKS   FEFCCY
     C                     MOVE *BLANKS   FEBRCA
     C                     EXSR CHANGE
     C                     EXSR AUDIT
     C                     SETON                     LR
     C                     RETRN
      /EJECT                                                                                  CSC042
     C********************************************************************                    CSC042
     C*                                                                                       CSC042
     C*  ##CHKC  - Check the currency details                                                 CSC042
     C*                                                                                       CSC042
     C********************************************************************                    CSC042
     C           ##CHKC    BEGSR                                                              CSC042
      *                                                                                       CSC042
     C           *LIKE     DEFN BJCYCD    ##KC                                                CSC042
     C           *LIKE     DEFN Q         ##QSV                                               CSC042
      *                                                                                       CSC042
      * Set off the currency found indicator                                                  CSC042
     C                     MOVEL*BLANK    ##FIC   1                                           CSC042
      *                                                                                       CSC042
      * Save the state of indicator 87 so it can be reset at the end                          CSC042
      * of the SR as it may be used elsewhere in the code                                     CSC042
     C           *IN87     IFEQ *ON                                                           CSC042
     C                     MOVEL'Y'       #IN87   1                                           CSC042
     C                     ELSE                                                               CSC042
     C                     MOVEL'N'       #IN87                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
     C                     SETOF                         87                                   CSC042
      *                                                                                       CSC042
      * Restore Q from ##QSV in case Q is used elsewhere in the code                          CSC042
     C                     Z-ADD##QSV     Q       40                                          CSC042
      *                                                                                       CSC042
      * Are we looking for the same details as the last time this                             CSC042
      * subroutine was called i.e. is Q already set correctly?                                CSC042
      * If so then use the data rather than do another LOKUP                                  CSC042
      * First make sure that we don't reference the 0th array element                         CSC042
     C           Q         IFEQ 0                                                             CSC042
     C                     Z-ADD1         Q                                                   CSC042
     C                     END                                                                CSC042
      * Now see if this search is same as last one performed                                  CSC042
      * If we have a match then seton 87 so the code after this                               CSC042
      * subroutine knows it can use Q directly                                                CSC042
     C           ##KC      IFEQ CURR,Q                                                        CSC042
     C                     SETON                         87                                   CSC042
     C                     ELSE                                                               CSC042
      * Otherwise hunt in the array and seton 87 if found                                     CSC042
     C                     Z-ADD1         Q                                                   CSC042
     C           ##KC      LOKUPCURR,Q                   87                                   CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * Save Q for next time                                                                  CSC042
     C           *IN87     IFEQ *ON                                                           CSC042
     C                     Z-ADDQ         ##QSV                                               CSC042
      * Set the indicator to show the data was found                                          CSC042
     C                     MOVEL'Y'       ##FIC                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * Reset the state of indicator 87.                                                      CSC042
     C           #IN87     IFEQ 'Y'                                                           CSC042
     C                     MOVEL*ON       *IN87                                               CSC042
     C                     ELSE                                                               CSC042
     C                     MOVEL*OFF      *IN87                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
     C                     ENDSR                                                              CSC042
      *                                                                                       CSC042
     C********************************************************************                    CSC042
      /EJECT                                                                                  CSC042
     C********************************************************************                    CSC042
     C*                                                                                       CSC042
     C*  ##SETC  - Set up the currency details from array                                     CSC042
     C*                                                                                       CSC042
     C********************************************************************                    CSC042
      *                                                                                       CSC042
     C           ##SETC    BEGSR                                                              CSC042
      *                                                                                       CSC042
     C                     MOVE CURR,Q    A6CYCD                                              CSC042
     C                     MOVELCYNM,Q    A6CYNM                                              CSC042
     C                     MOVELMTDV,Q    A6MDIN                                              CSC042
     C                     Z-ADDCSPT,Q    A6SPRT                                              CSC042
     C                     Z-ADDCCDP,Q    A6NBDP                                              CSC042
     C                     Z-ADDCCNO,Q    A6SSNB                                              CSC042
      *                                                                                       CSC042
     C                     ENDSR                                                              CSC042
     C********************************************************************                    CSC042
      /EJECT
     C********************************************************************
     C*
     C*  INIT  --- Initialisation Subroutine
     C*
     C*  CALLED FROM: Main Processing
     C*
     C*  CALLS: Nothing
     C*
     C********************************************************************
     C           INIT      BEGSR
      *
     C                     MOVEA*ALL'9'   ARAC,1                                              246309
     C                     MOVEACPY@      BIS@   80
     C                     Z-ADD0         LINE1
     C                     Z-ADD0         LINE2
     C                     Z-ADD0         LINE3
     C                     Z-ADD0         LINE4
     C                     Z-ADD0         ##BNDX  40                                          CSC042
     C           *LIKE     DEFN ##BNDX    B                                                   CSC042
     C           *LIKE     DEFN ##BNDX    ##BSV                                               CSC042
      *                                                                                       CSC042
      *
      ** Define LDA
     C           *NAMVAR   DEFN           LDA
      *
      ** Lock in dataarea RUNDAT
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
      *
     C                     SETON                     01
     C                     Z-ADD0         FEEAM0
     C                     Z-ADD0         FAMT0
      *
      ** Access bank details
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'LER180'  DBPGM            *************
     C                     Z-ADD1         DBASE            * DBERR  01 *
     C                     MOVEL'*FIRST  'DBKEY            *************
     C                     MOVEL'SDBANKPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END
     C*                                                                   085677
     C***  ACCESS CUSTOMER LENDING DATA                                   085677
     C*                                                                   085677
     C                     CALL 'AOCLNDR0'                                085677
     C                     PARM '*MSG   ' @RTCD                           085677
     C                     PARM '*FIRST ' @OPTN                           085677
     C********** SDCLND    PARM SDCLND    DSFDY                                        085677 CLE134
     C           SDCLND    PARM SDCLND    DSSDY                                               CLE134
     C           @RTCD     IFNE *BLANK                                    085677
     C           *LOCK     IN   LDA                                       085677
     C                     MOVEL'LER180'  DBPGM            *************  085677
     C                     Z-ADD5         DBASE            * DBERR  05 *  085677
     C                     MOVEL'SDCLNDPD'DBFILE           *************  085677
     C                     SETON                     U7U8                 085677
     C                     OUT  LDA                                       085677
     C                     EXSR AUDIT                                     085677
     C                     EXSR *PSSR                                     085677
     C                     END                                            085677
     C****************************************************         101322 138165
     C***Access*SDGELRPD*for*Accrue*on*Last*Day*indicator*         101322 138165
     C****************************************************         101322 138165
     C***********          CALL 'AOGELRR0'                         101322 138165
     C***********          PARM '*MSG   ' @RTCD   7                101322 138165
     C***********          PARM '*FIRST ' @OPTN   7                101322 138165
     C***********SDGELR    PARM SDGELR    DSFDY                    101322 138165
     C***********@RTCD     IFNE *BLANKS                            101322 138165
     C************LOCK     IN   LDA                                101322 138165
     C***********          MOVEL'*READ   'DBKEY                    101322 138165
     C***********          MOVEL'LER180'  DBPGM            ********101322 138165
     C***********          MOVEL'SDGELRPD'DBFILE           * DBERR 101322 138165
     C***********          Z-ADD23        DBASE            ********101322 138165
     C***********          SETON                     U7U8          101322 138165
     C***********          OUT  LDA                                101322 138165
     C***********          EXSR *PSSR                              101322 138165
     C***********          END                                     101322 138165
     C/COPY WNCPYSRC,LEH00725
      *                                                                   CLE005
      ** Check if CLE005 is switched *ON.                                 CLE005
      *                                                                   CLE005
     C                     MOVE 'N'       CLE005  1                       CLE005
     C                     CALL 'AOSARDR0'                                CLE005
     C                     PARM *BLANKS   @RTCD   7                       CLE005
     C                     PARM '*VERIFY' @OPTN   7                       CLE005
     C                     PARM 'CLE005'  @SARD   6                       CLE005
     C           SCSARD    PARM SCSARD    DSFDY                           CLE005
      *                                                                   CLE005
     C           @RTCD     IFEQ *BLANKS                                   CLE005
     C                     MOVE 'Y'       CLE005                          CLE005
     C                     END                                            CLE005
      *                                                                   CLE005
     C           @RTCD     IFNE *BLANKS                                   CLE005
     C           @RTCD     ANDNE'*NRF  '                                  CLE005
     C           *LOCK     IN   LDA                                       CLE005
     C                     MOVEL'CLE005'  DBKEY                           CLE005
     C                     MOVEL'LER180'  DBPGM            ************   CLE005
     C                     MOVEL'SCSARDPD'DBFILE           * DBERR 19 *   CLE005
     C                     Z-ADD19        DBASE            ************   CLE005
     C                     SETON                     U7U8                 CLE005
     C                     OUT  LDA                                       CLE005
     C                     EXSR *PSSR                                     CLE005
     C                     END                                            CLE005
      *                                                                                       193475
      ** Check if CLE006 is switched *ON.                                                     193475
      *                                                                                       193475
     C                     MOVE 'N'       CLE006  1                                           193475
     C                     CALL 'AOSARDR0'                                                    193475
     C                     PARM *BLANKS   @RTCD   7                                           193475
     C                     PARM '*VERIFY' @OPTN   7                                           193475
     C                     PARM 'CLE006'  @SARD   6                                           193475
     C           SCSARD    PARM SCSARD    DSFDY                                               193475
      *                                                                                       193475
     C           @RTCD     IFEQ *BLANKS                                                       193475
     C                     MOVE 'Y'       CLE006                                              193475
     C                     END                                                                193475
      *                                                                                       193475
     C           @RTCD     IFNE *BLANKS                                                       193475
     C           @RTCD     ANDNE'*NRF  '                                                      193475
     C           *LOCK     IN   LDA                                                           193475
     C                     MOVEL'CLE006'  DBKEY                                               193475
     C                     MOVEL'LER180'  DBPGM            ************                       193475
     C                     MOVEL'SCSARDPD'DBFILE           * DBERR 24 *                       193475
     C                     Z-ADD24        DBASE            ************                       193475
     C                     SETON                     U7U8                                     193475
     C                     OUT  LDA                                                           193475
     C                     EXSR *PSSR                                                         193475
     C                     END                                                                193475
      *                                                                                       CLE073
      ** Check if CLE073 is switched *ON.                                                     CLE073
      *                                                                                       CLE073
     C                     MOVE 'N'       CLE073  1                                           CLE073
     C                     CALL 'AOSARDR0'                                                    CLE073
     C                     PARM *BLANKS   WRTCD   7                                           CLE073
     C                     PARM '*VERIFY' WOPTN   7                                           CLE073
     C                     PARM 'CLE073'  WSARD   6                                           CLE073
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE073
      *                                                                                       CLE073
     C           WRTCD     IFEQ *BLANKS                                                       CLE073
     C                     MOVE 'Y'       CLE073                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE134
      ** Check if CLE134 is switched *ON.                                                     CLE134
      *                                                                                       CLE134
     C                     MOVE 'N'       CLE134  1                                           CLE134
     C                     CALL 'AOSARDR0'                                                    CLE134
     C                     PARM *BLANKS   WRTCD   7                                           CLE134
     C                     PARM '*VERIFY' WOPTN   7                                           CLE134
     C                     PARM 'CLE134'  WSARD   6                                           CLE134
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE134
      *                                                                                       CLE134
     C           WRTCD     IFEQ *BLANKS                                                       CLE134
     C                     MOVE 'Y'       CLE134                                              CLE134
     C                     ENDIF                                                              CLE134
      *****************************************************************            MD035545 MD047993
      ***Access*general*ledger*details.********************************            MD035545 MD047993
      *****************************************************************            MD035545 MD047993
     C**********           CALL 'AOGELRR1'                                         MD035545 MD047993
     C**********           PARM '*DBERR ' WRTCD                                    MD035545 MD047993
     C**********           PARM '*FIRST ' WOPTN                                    MD035545 MD047993
     C********** SDGELR    PARM SDGELR    DSSDY                                    MD035545 MD047993
      *                                                                                     MD035545
      ** Retrieve system value setting.                                                     MD035545
      *                                                                                     MD035545
     C                     MOVELWPARML    P@OP01                                            MD035545
     C                     CALL 'AOSVALR0'                                                  MD035545
     C                     PARM *BLANKS   @RTCD                                             MD035545
     C                     PARM           P@OP01 20                                         MD035545
     C                     PARM           P@VL01200                                         MD035545
     C                     PARM           P@OP02 20                                         MD035545
     C                     PARM           P@VL02200                                         MD035545
     C                     PARM           P@OP03 20                                         MD035545
     C                     PARM           P@VL03200                                         MD035545
     C                     PARM           P@OP04 20                                         MD035545
     C                     PARM           P@VL04200                                         MD035545
     C                     PARM           P@OP05 20                                         MD035545
     C                     PARM           P@VL05200                                         MD035545
     C                     PARM           P@OP06 20                                         MD035545
     C                     PARM           P@VL06200                                         MD035545
     C                     PARM           P@OP07 20                                         MD035545
     C                     PARM           P@VL07200                                         MD035545
     C                     PARM           P@OP08 20                                         MD035545
     C                     PARM           P@VL08200                                         MD035545
     C                     PARM           P@OP09 20                                         MD035545
     C                     PARM           P@VL09200                                         MD035545
     C                     PARM           P@OP10 20                                         MD035545
     C                     PARM           P@VL10200                                         MD035545
      *                                                                                     MD035545
      ** If system value is not found then default value to 'N'.                            MD035545
      *                                                                                     MD035545
     C           @RTCD     IFNE '       '                                                   MD035545
     C                     MOVE 'N'       WCALC6                                            MD035545
     C                     ELSE                                                             MD035545
     C                     MOVELP@VL01    WCALC6                                            MD035545
     C********** WCALC6    IFEQ 'Y'                                                MD035545 MD047993
     C********** BKALDI    ANDEQ'Y'                                                MD035545 MD047993
     C**********           MOVE 'Y'       WCALC6                                   MD035545 MD047993
     C**********           ELSE                                                    MD035545 MD047993
     C**********           MOVE 'N'       WCALC6                                   MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
     C                     ENDIF                                                            MD035545
      *
      ***  Set up currency arrays
      *
     C                     Z-ADD0         X       30
     C                     OPEN SDCURRPD                                                      CSC042
     C                     READ SDCURRPD                 15
      *
     C           *IN15     DOWEQ'0'
      *
     C           X         IFLE 150
     C           X         ADD  1         X
     C                     MOVE A6CYCD    CURR,X
     C                     Z-ADDA6SPRT    CSPT,X
     C                     MOVELA6MDIN    MTDV,X
     C                     Z-ADDA6NBDP    CCDP,X
     C                     Z-ADDA6SSNB    CCNO,X
     C                     MOVELA6CYNM    CYNM,X                                              CSC042
     C                     END
      *
     C                     READ SDCURRPD                 15
      *
     C                     END
     C                     CLOSESDCURRPD                                                      CSC042
     C*
     C** Set up the control date for the report
     C*
      ** Define lending customer data area which holds control date
     C           *NAMVAR   DEFN           LESTAT
     C                     IN   LESTAT
     C*
      *
      ** Set Date Format Indicator *IN98  on if date format is MMDDYY
      *
     C           AGDFF     IFEQ 'M'
     C                     SETON                     98
     C                     END
     C           LKEYF     KLIST                                          052703
     C                     KFLD           LKBRCA  3                       052703
     C                     KFLD           LKCCY   3                       052703
     C                     KFLD           LKAKEY 10                       052703
     C*
     C***  Set up Report To date                                          BH3518
     C*                                                                   BH3518
     C           CODT      ADD  1         ZDAYNO                          BH3518
     C                     EXSR ZDATE2                                    BH3518
     C                     MOVE ZADATE    TODATE                          BH3518
     C*                                                                   BH3518
     C**********           Z-ADD99        STFSEQ  20                                          200289
     C                     Z-ADD999       STFSEQ  30                                          200289
     C/COPY WNCPYSRC,LER180C001
     C                     Z-ADD0         WOPCT   63
     C                     Z-ADD0         WOAMT  130
     C                     Z-ADD0         WFPC    63
     C                     Z-ADD0         WFAM   130
     C                     Z-ADD0         WTOT   130
     C                     Z-ADD0         WRK63   63
     C                     Z-ADD0         WRK15  150
     C                     Z-ADD0         WRK153 153
     C                     Z-ADD0         WRK155 155
     C                     Z-ADD0         FCTOTA
     C                     Z-ADD0         FCTOTM
     C                     Z-ADD0         CFTOTA
     C                     Z-ADD0         CFTOTM
     C                     Z-ADD0         CLTOTA
     C                     Z-ADD0         CLTOTM
     C                     Z-ADD0         FATOA0                          BH3518
     C                     Z-ADD0         FATOM0                          BH3518
     C                     Z-ADD0         CATOA0                          BH3518
     C                     Z-ADD0         CATOM0                          BH3518
     C                     Z-ADD0         CXTOA0                          BH3518
     C                     Z-ADD0         CXTOM0                          BH3518
     C                     Z-ADD0         POSTD0
     C                     Z-ADD0         CALCD0
     C                     Z-ADD0         LAMT0
     C*
     C** Set up KLIST for accessing Facility file
     C*
     C           FACKEY    KLIST
     C**********           KFLD           FECNUM  60                                          CSD027
     C                     KFLD           FECNUM  6                                           CSD027
     C                     KFLD           FTYP    30
     C                     KFLD           FSEQ    20
      *
      ** Define key list for read of FACHSAL1 file - full key.
      *
     C           HSAKY1    KLIST
     C                     KFLD           FECNUM
     C                     KFLD           FEFACL
     C                     KFLD           STDATE
     C                     KFLD           STFSEQ
      *
      ** Define key list for read of FACHSAL1 file - partial key.
      *
     C           HSAKY2    KLIST
     C                     KFLD           FECNUM
     C                     KFLD           FEFACL
     C/COPY WNCPYSRC,LER180CCP2                                           S01408
      *
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C*
     C*  SRFACY -- Facility Fee Processing & reporting
     C*
     C*  CALLED FROM: Main Processing
     C*
     C*  CALLS: AVCALC
     C*
     C********************************************************************
     C           SRFACY    BEGSR
     C                     ADD  1         @REP1
     C*                                                                   S01408
     C/COPY WNCPYSRC,LER180CCPG                                           S01408
     C*                                                                   S01408
      *                                                                   CLE005
      ** Set off 'Fee Payable/Fee Receivable' print indicators.           CLE005
      *                                                                   CLE005
     C                     SETOF                     505152               CLE005
     C                     MOVE '0'       *IN53   1                       156582
     C*
     C** Chain to the facility file for the facility amount
     C*
     C           FACKEY    CHAINFCLTY                71
     C           *IN71     IFEQ '0'
     C                     Z-ADDFAMT      FAMT0
     C*
     C**********           CALL 'AOCURRR0'             99                                     CSC042
     C**********           PARM '*MSG    '@RTCD                                               CSC042
     C**********           PARM '*KEY    '@OPTN                                               CSC042
     C**********           PARM FCCY      CURKEY  3                                           CSC042
     C********** SDCURR    PARM SDCURR    DSSDY                                               CSC042
      *
     C********** @RTCD     IFNE *BLANKS                                                       CSC042
     C                     MOVELFCCY      ##KC                                                CSC042
     C                     EXSR ##CHKC                                                        CSC042
     C           ##FIC     IFEQ 'Y'                                                           CSC042
     C                     EXSR ##SETC                                                        CSC042
     C                     ELSE                                                               CSC042
     C           *LOCK     IN   LDA                        ***************
     C                     MOVELFCCY      DBKEY            *  DBERR 02   *
     C                     Z-ADD2         DBASE            ***************
     C                     MOVEL'LER180  'DBPGM                        ***
     C**********           MOVEL'SDCURRPD'DBFILE                                              CSC042
     C                     MOVEL'CURR,Q  'DBFILE                                              CSC042
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END                             ** E001
      *
     C           A6NBDP    COMP 1                    363435
     C   36      A6NBDP    COMP 3                      3637
     C*
     C                     ELSE
     C* Database error processing
     C           *LOCK     IN   LDA                         ************
     C                     MOVELFECNUM    DBKEY             * DBERR 03 *
     C                     MOVE FACNO     DBKEY             ************
     C                     Z-ADD3         DBASE
     C                     MOVEL'LER180  'DBPGM
     C                     MOVEL'FCLTY   'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END
     C*
     C***  Set up 'From' date
     C*
     C***********FELPDT    IFLT CODT                               052703 138421
     C           FELPDT    IFLE CODT                                      138421
     C/COPY WNCPYSRC,LER180C003
     C                     Z-ADDFELPDT    ZDAYNO
     C                     ELSE                                           052703
     C                     Z-ADDFEPLPD    ZDAYNO                          052703
     C                     END                                            052703
     C           ZDAYNO    IFEQ 0
     C                     Z-ADDFEPSTD    ZDAYNO
     C                     END
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    FRDATE
     C*
     C                     SETOF                     1112
     C                     MOVE '0'       *IN16                           100657
     C                     Z-ADD0         FERATE
     C*
     C** Set up the fee amounts for reporting for the record just read
     C*
     C           FECALT    IFEQ '  '
     C*
     C** These are flat fees and should show the amount amortized/
     C** accrued to date and left to accrue
     C                     Z-ADDFEFAMT    FEEAM0
     C                     Z-ADDFEADAT    CALCD0
     C***********          ADD  FEAMTP    CALCD0                          085915
     C*                                                                   BH3518
     C***  Nothing goes in Accrued column if Bullet fee                   BH3518
     C*                                                                   BH3518
     C           FEPYON    IFEQ ' '                                       BH3518
     C                     Z-ADD0         POSTD0                          BH3518
     C                     ELSE                                           BH3518
     C                     Z-ADDFEADAT    POSTD0
     C***********          ADD  FEAMTP    POSTD0                          085915
     C                     END                                            BH3518
     C*
     C** Calculated fees wil be reported according to their calculation
     C** method
     C*
     C                     ELSE
     C***********FECALT    IFEQ '01'                                      100657
     C***********FECALT    OREQ '04'                                      100657
     C***********FECALT    OREQ '11'                                      100657
     C***********FECALT    OREQ '14'                                      100657
     C***********          MOVELNARR,1    FECOMT  9                       100657
     C***********          ELSE                                           100657
      ***********                                                         100657
     C***********FECALT    IFEQ '02'                                      100657
     C***********FECALT    OREQ '05'                                      100657
     C***********FECALT    OREQ '12'                                      100657
     C***********FECALT    OREQ '15'                                      100657
     C***********          MOVELNARR,2    FECOMT                          100657
     C***********          ELSE                                           100657
     C***********          MOVELNARR,3    FECOMT                          100657
     C***********          Z-ADDFEFRT1    FERATE                          100657
     C***********          SETON                     11                   100657
     C***********          END                                            100657
     C***********                                                         100657
     C***********          END                                            100657
     C*                                                                   100657
     C** Use new narrative for the calculated fee according to their      100657
     C** calculation type.                                                100657
     C*                                                                   100657
     C           FECALT    IFEQ '01'                                      100657
     C                     MOVELNARR,4    FECOMT 10                       100657
     C                     END                                            100657
     C           FECALT    IFEQ '02'                                      100657
     C                     MOVELNARR,5    FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '03'                                      100657
     C                     MOVELNARR,6    FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '04'                                      100657
     C                     MOVELNARR,7    FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '05'                                      100657
     C                     MOVELNARR,8    FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '06'                                      100657
     C                     MOVELNARR,9    FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '11'                                      100657
     C                     MOVELNARR,10   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '12'                                      100657
     C                     MOVELNARR,11   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '13'                                      100657
     C                     MOVELNARR,12   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '14'                                      100657
     C                     MOVELNARR,13   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '15'                                      100657
     C                     MOVELNARR,14   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '16'                                      100657
     C                     MOVELNARR,15   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '21'                                      100657
     C                     MOVELNARR,16   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '22'                                      100657
     C                     MOVELNARR,17   FECOMT                          100657
     C                     END                                            100657
     C           FECALT    IFEQ '03'                                      100657
     C           FECALT    OREQ '06'                                      100657
     C           FECALT    OREQ '13'                                      100657
     C           FECALT    OREQ '16'                                      100657
     C           FECALT    OREQ '21'                                      100657
     C           FECALT    OREQ '22'                                      100657
     C                     Z-ADDFEFRT1    FERATE                          100657
     C                     MOVE '1'       *IN11                           100657
     C                     END                                            100657
     C*
     C                     SETON                     12
     C                     Z-ADD0         FEEAM0
     C*
     C** Calculate the fee amount to be reported for fees based on
     C** actual amounts
     C*
     C           FECALT    IFEQ '04'
     C           FECALT    OREQ '05'
     C           FECALT    OREQ '06'
     C           FECALT    OREQ '14'
     C           FECALT    OREQ '15'
     C           FECALT    OREQ '16'
     C           FECALT    OREQ '22'
     C***********          Z-ADDFEADAT    CALCD0                          052703
     C***********          ADD  FELPAM    CALCD0                          052703
     C***********          ADD  FEAMTP    CALCD0                          052703
     C***********          Z-ADDFEADAT    POSTD0                          052703
     C***********          ADD  FELPAM    POSTD0                          052703
     C***********          ADD  FEAMTP    POSTD0                          052703
     C***********FELPDT    IFGE CODT                               052703 100658
     C***********          MOVE 'A'       AKY,4                    052703 100658
     C***********          MOVEAWFTYP     AKY,1                    052703 100658
     C***********          MOVEAWFCOD     AKY,8                    052703 100658
     C***********          MOVE 'F'       AKY,10                   052703 100658
     C***********          MOVEA'   '     AKY,5                    052703 100658
     C***********          MOVE ' '       AKY,6                    052703 100658
      ***********                                                  052703 100658
     C***********          MOVE FEBRCA    LKBRCA                   052703 100658
     C***********          MOVE FEFCCY    LKCCY                    052703 100658
     C***********          MOVEAAKY       LKAKEY                   052703 100658
     C***********LKEYF     CHAINFEEKEY               99            052703 100658
     C***********          Z-ADDLKADAT    CALCD0                   052703 100658
     C***********          Z-ADDLKADAT    POSTD0                   052703 100658
     C***********          ELSE                                    052703 100658
     C                     Z-ADDFEADAT    CALCD0                          052703
     C                     ADD  FELPAM    CALCD0                          052703
     C                     ADD  FEAMTP    CALCD0                          052703
     C           FELPDT    IFGT CODT                                      103019
     C                     Z-ADDFEADBP    CALCD0                          103019
     C                     ADD  FEPAMP    CALCD0                          103019
     C                     END                                            103019
     C                     Z-ADDFEADAT    POSTD0                          052703
      ** If Fee is a payment then subtract fee amount                     140840
     C           *IN50     IFEQ *ON                                       140840
     C                     SUB  FELPAM    POSTD0                          140840
     C                     SUB  FEAMTP    POSTD0                          140840
     C                     ELSE                                           140840
     C                     ADD  FELPAM    POSTD0                          052703
     C/COPY WNCPYSRC,LER180C004
     C***********          ADD  FEAMTP    POSTD0                   052703 138421
     C                     ENDIF                                          140840
     C/COPY WNCPYSRC,LER180C005
     C           FELPDT    IFGT CODT                                      103019
     C                     Z-ADDFEADBP    POSTD0                          103019
      ** If Fee is a payment then subtract fee amount                     140840
     C           *IN50     IFEQ *ON                                       140840
     C                     SUB  FEPAMP    POSTD0                          140840
     C                     ELSE                                           140840
     C***********          ADD  FEPAMP    POSTD0                   103019 138421
     C                     ENDIF                                          140840
     C                     END                                            103019
     C***********          END                                     052703 100658
     C***********                                                  052703 100658
     C/COPY WNCPYSRC,LER180CCP3                                           S01408
     C                     ELSE
     C*
     C** For calculated fees based on averages need to calculate
     C** what the value would be if today was payment date
     C*
     C                     MOVE '1'       *IN16                           100657
     C                     EXSR SETP                                      085309
     C                     EXSR AVCALC
     C                     Z-ADDWFEE      CALCD0
     C                     ADD  FELPAM    CALCD0                          CLE005
     C           FELPDT    IFGT CODT                                      100658
     C           FELPDT    OREQ CODT                                      100658
     C           FEAUTO    ANDEQ'N'                                       100658
     C                     ADD  FEPAMP    CALCD0                          100658
     C                     ELSE                                           100658
     C                     ADD  FEAMTP    CALCD0
     C                     END                                            100658
     C                     Z-ADDFEADAT    POSTD0
      ** If Fee is a payment then subtract fee amount                     140840
     C           *IN50     IFEQ *ON                                       140840
     C                     SUB  FELPAM    POSTD0                          140840
     C                     ELSE                                           140840
     C                     ADD  FELPAM    POSTD0
     C                     ENDIF                                          140840
     C           FELPDT    IFGT CODT                                      100658
     C           FELPDT    OREQ CODT                                      100658
     C           FEAUTO    ANDEQ'N'                                       100658
      ** If Fee is a payment then subtract fee amount                     140840
     C           *IN50     IFEQ *ON                                       140840
     C                     SUB  FEPAMP    POSTD0                          140840
     C                     ELSE                                           140840
     C***********          ADD  FEPAMP    POSTD0                   100658 138421
     C                     ENDIF                                          140840
     C                     ELSE                                           100658
      ** If Fee is a payment then subtract fee amount                     140840
     C           *IN50     IFEQ *ON                                       140840
     C                     SUB  FEAMTP    POSTD0                          140840
     C                     ELSE                                           140840
     C***********          ADD  FEAMTP    POSTD0                          138421
     C                     ENDIF                                          140840
     C                     END                                            100658
     C                     END
     C                     END
      *                                                                   156582
      ** Participation Sold Fee Accruals should be negated and            156582
      ** subtracted from the total                                        156582
      *                                                                   156582
     C                     SELEC                                          156582
     C           PTFI      WHEQ 'P'                                       156582
     C           PTFI      OREQ 'S'                                                           CLE106
     C           PTFI      OREQ 'R'                                                           CLE106
     C                     Z-SUBPOSTD0    POSTD0                          156582
     C           PTFI      WHEQ 'I'                                       156582
     C                     MOVE '1'       *IN53                           156582
     C                     ENDSL                                          156582
      *
     C           SVBRC     IFNE FEBRCA
     C                     MOVELFEBRCA    ##KB                                                CSC042
     C                     EXSR ##CHKB                                                        CSC042
      * If branch is in the array then use the details                                        CSC042
     C           ##FIC     IFEQ 'Y'                        *** B10                            CSC042
     C                     EXSR ##SETB                                                        CSC042
     C                     ELSE                            *** X10                            CSC042
     C**********           CALL 'AOBRCHR0'             99                                     CGL029
     C                     CALL 'AOBRCHR1'             99                                     CGL029
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM FEBRCA    @DSNB   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                                    *
     C                     MOVEL'LER180'  DBPGM             *************
     C                     MOVELFEBRCA    DBKEY             * DBERR 04 *
     C                     Z-ADD4         DBASE             ************
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     ELSE                                                               CSC042
      * Details found on the DB so add them to the array                                      CSC042
      * if the array still has room                                                           CSC042
     C                     EXSR ##ADDB                                                        CSC042
     C                     END
     C                     END                             *** E10                            CSC042
     C                     END
     C*
     C** Access the facility type table to get narrative for next
     C** facility type
     C*
     C           SVFAC     IFNE FTYP
     C           SVBRC     ORNE FEBRCA
     C           SVCCY     ORNE FEFCCY
     C*
     C                     CALL 'AOFACTR0'             99
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           FTYP
     C           SDFACT    PARM SDFACT    DSFDY
     C           @RTCD     IFNE *BLANKS                    B1
     C********** *LOCK     IN   LDA                         ************  BH3518
     C**********           MOVELFTYP      DBKEY             * DBERR 05 *  BH3518
     C**********           Z-ADD5         DBASE             ************  BH3518
     C**********           MOVEL'LER180  'DBPGM                           BH3518
     C**********           MOVEL'SDFACTPD'DBFILE                          BH3518
     C**********           SETON                     U7U8                 BH3518
     C**********           OUT  LDA                                       BH3518
     C**********           EXSR AUDIT                                     BH3518
     C**********           EXSR *PSSR                                     BH3518
     C*                                                                   BH3518
     C                     MOVE *ALL'*'   WFCNMO                          BH3518
     C                     MOVELFTYP      WFCNMO                          BH3518
     C                     ELSE                                           BH3518
     C                     MOVELAMFCNM    WFCNMO                          BH3518
     C                     END                             E1
     C                     END
     C*
     C                     EXSR SETP                                      085309
     C***********                                                         085309
     C***Check*the currency decimal places and name for the new ccy       085309
     C***********                                                         085309
     C***********SVCCY     IFNE FEFCCY                                    085309
     C***********SVBRC     ORNE FEBRCA                                    085309
     C***********                                                         085309
     C***********          CALL 'AOCURRR0'             99                 085309
     C***********          PARM '*MSG    '@RTCD                           085309
     C***********          PARM '*KEY    '@OPTN                           085309
     C***********          PARM FEFCCY    CURKEY  3                       085309
     C***********SDCURR    PARM SDCURR    DSSDY                           085309
      ***********                                                         085309
     C***********@RTCD     IFNE *BLANKS                                   085309
     C************LOCK     IN   LDA                        ***************085309
     C***********          MOVELFEFCCY    DBKEY            *  DBERR 06   *085309
     C***********          Z-ADD6         DBASE            ***************085309
     C***********          MOVEL'SDCURRPD'DBFILE                          085309
     C***********          MOVE 'LER180  'DBPGM                           085309
     C***********          SETON                     U7U8                 085309
     C***********          OUT  LDA                                       085309
     C***********          EXSR AUDIT                                     085309
     C***********          EXSR *PSSR                                     085309
     C***********          END                             ** E001        085309
      ***********                                                         085309
     C***********A6NBDP    COMP 1                    323031               085309
     C***32******A6NBDP    COMP 3                      3233               085309
     C***********          Z-ADDA6NBDP    DP      20                      085309
     C***********DP        ADD  4         P       10                      085309
     C***********                                                         085309
     C***********          END                                            085309
     C*
     C** Add the current fee amount into the currency running total and
     C** into the facility running total
     C*
     C           FEPYON    IFEQ 'N'
     C           FEPYON    OREQ 'E'
     C                     ADD  CALCD0    FCTOTA
     C                     ADD  CALCD0    CFTOTA
     C           PTFI      IFNE 'I'                                       156582
     C                     ADD  POSTD0    FATOA0                          BH3518
     C                     ADD  POSTD0    CATOA0                          BH3518
     C                     ENDIF                                          156582
     C                     ELSE
     C                     ADD  CALCD0    FCTOTM
     C                     ADD  CALCD0    CFTOTM
     C           PTFI      IFNE 'I'                                       156582
     C                     ADD  POSTD0    FATOM0                          BH3518
     C                     ADD  POSTD0    CATOM0                          BH3518
     C                     ENDIF                                          156582
     C                     END
      *
     C           SVNUM     IFNE FECNUM
     C                     MOVE FECNUM    @BBA    6
     C                     MOVELFECNUM    KEYC   10
      *
     C                     CALL 'AOCUSTR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           KEYC
     C                     PARM           KEYSTS  7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           @RTCD     IFNE *BLANKS                    B2
     C           *LOCK     IN   LDA                         ************
     C                     MOVELFECNUM    DBKEY             * DBERR 07 *
     C                     Z-ADD7         DBASE             ************
     C                     MOVEL'LER180  'DBPGM
     C                     MOVEL'SDCUSTPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END                             E2
      *
     C                     END                             E1
     C*
     C** If the new fee code is different from the last get the new
     C** fee narrative
     C*
     C           SVCOD     IFNE FEFCOD
     C**********           MOVE FEFCOD    AUFECD           Name of        BHBC01
     C                     Z-ADDFEFCOD    WKFCOD                          BHBC01
     C                     CALL 'AOFEER0'              99
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C**********           PARM AUFECD    FKEY    2                       BHBC01
     C                     PARM WKFCOA    FKEY    2                       BHBC01
     C           SDFEE     PARM SDFEE     DSFDY
      *
     C           @RTCD     IFNE *BLANKS                    B1
     C                     MOVE *ALL'*'   AUFENV
     C********** *LOCK     IN   LDA                         ************  BHBC01
     C**********           MOVELFEFCOD    DBKEY             * DBERR 08 *  BHBC01
     C**********           Z-ADD8         DBASE             ************  BHBC01
     C**********           MOVEL'LER180  'DBPGM                           BHBC01
     C**********           MOVEL'SDFEEPD 'DBFILE                          BHBC01
     C**********           SETON                     U7U8                 BHBC01
     C**********           OUT  LDA                                       BHBC01
     C**********           EXSR AUDIT                                     BHBC01
     C**********           EXSR *PSSR                                     BHBC01
     C                     END                             E1
     C                     END
      *
      ***  Force page change
      *
     C********** LINE1     IFGE 57
     C**********           SETON                     80
     C**********           END
     C*
     C********** LINE3     IFGE 57
     C**********           SETON                     82
     C**********           END
      *                                                                   CLE005
      ***If*Switchable*feature*CLE005*is*on,*Set*On*corresponding*Ind.*                CLE005 193475
      ** If Switchable feature CLE006 is ON, set ON corresponding Ind.                        193475
      ** to print the 'Fee Payable/Fee Receivable' Indicator              CLE005
      *                                                                   CLE005
     C********** CLE005    IFEQ 'Y'                                                    CLE005 193475
     C           CLE006    IFEQ 'Y'                                                           193475
      *                                                                   CLE005
     C                     SELEC                                          CLE005
     C           PTFI      WHEQ 'P'                                       CLE005
     C           PTFI      OREQ 'S'                                                           CLE106
     C           PTFI      OREQ 'R'                                                           CLE106
     C                     SETON                     50                   CLE005
     C           PTFI      WHEQ 'I'                                       CLE005
     C                     SETON                     51                   CLE005
     C           PTFI      WHEQ ' '                                       CLE005
     C                     SETON                     52                   CLE005
     C                     ENDSL                                          CLE005
      *                                                                   CLE005
     C                     ENDIF                                          CLE005
      *                                                                                       246309
      ** Save Details of Fee Accruals and Past Due for Resorting                              246309
      *                                                                                       246309
     C           FEPYON    IFEQ 'N'                                                           246309
     C                     CLEARDSFEAC                                                        246309
     C**********           ADD  1         T       20                                 246309 AR894146
     C                     ADD  1         T       40                                        AR894146
     C                     MOVELFEFACL    DFACL                                               246309
     C                     MOVELFEFSEQ    DFESEQ                                              246309
     C                     MOVELFCCY      DFCCY                                               246309
     C                     MOVELFRDATE    DRDATE                                              246309
     C                     MOVELFECALT    DECALT                                              246309
     C                     MOVELFERATE    DERATE                                              246309
     C                     MOVELFECOMT    DECOMT                                              246309
     C                     MOVELFECNUM    DCNUM                                               246309
     C                     MOVELBBCRNM    DBCRNM                                              246309
     C                     MOVELBBCRTN    DBCRTN                                              246309
     C                     MOVELFEFCOD    DFCOD                                               246309
      *                                                                                       246309
     C           CALCD0    IFEQ 0                                                             246309
     C           CALCD1    OREQ 0                                                             246309
     C           CALCD2    OREQ 0                                                             246309
     C           CALCD3    OREQ 0                                                             246309
     C                     MOVEL'A'       DVAMT                                               246309
     C                     ELSE                                                               246309
     C                     MOVEL'B'       DVAMT                                               246309
     C                     ENDIF                                                              246309
      * Amounts                                                                               246309
     C           *IN30     IFEQ '1'                                                           246309
     C                     MOVELFAMT0     DFAMTS                                              246309
     C                     MOVELFEEAM0    DFEEAM                                              246309
     C                     MOVELCALCD0    DCALCD                                              246309
     C                     MOVELPOSTD0    DPOSTD                                              246309
     C                     MOVEL'1'       DIN30                                               246309
     C                     ENDIF                                                              246309
     C           *IN31     IFEQ '1'                                                           246309
     C                     MOVELFAMT1     DFAMTS                                              246309
     C                     MOVELFEEAM1    DFEEAM                                              246309
     C                     MOVELCALCD1    DCALCD                                              246309
     C                     MOVELPOSTD1    DPOSTD                                              246309
     C                     MOVEL'1'       DIN31                                               246309
     C                     ENDIF                                                              246309
     C           *IN32     IFEQ '1'                                                           246309
     C                     MOVELFAMT2     DFAMTS                                              246309
     C                     MOVELFEEAM2    DFEEAM                                              246309
     C                     MOVELCALCD2    DCALCD                                              246309
     C                     MOVELPOSTD2    DPOSTD                                              246309
     C                     MOVEL'1'       DIN32                                               246309
     C                     ENDIF                                                              246309
     C           *IN33     IFEQ '1'                                                           246309
     C                     MOVELFAMT3     DFAMTS                                              246309
     C                     MOVELFEEAM3    DFEEAM                                              246309
     C                     MOVELCALCD3    DCALCD                                              246309
     C                     MOVELPOSTD3    DPOSTD                                              246309
     C                     MOVEL'1'       DIN33                                               246309
     C                     ENDIF                                                              246309
      * Indicators                                                                            246309
     C                     MOVEL*ALL'0'   DINDS                                               246309
     C                     MOVEL*IN11     DIN11                                               246309
     C                     MOVEL*IN12     DIN12                                               246309
     C                     MOVEL*IN16     DIN16                                               246309
     C                     MOVEL*IN30     DIN30                                             MD026385
     C                     MOVEL*IN31     DIN31                                             MD026385
     C                     MOVEL*IN32     DIN32                                             MD026385
     C                     MOVEL*IN33     DIN33                                             MD026385
     C                     MOVEL*IN50     DIN50                                               246309
     C                     MOVEL*IN51     DIN51                                               246309
     C                     MOVEL*IN52     DIN52                                               246309
     C                     MOVEL*IN53     DIN53                                               246309
      * PTFIs                                                                                 246309
      * Receivable                                                                            246309
     C           *IN52     IFEQ '1'                                                           246309
     C                     MOVEL'A'       DLNAR                                               246309
     C                     ENDIF                                                              246309
      * Internal                                                                              246309
     C           *IN51     IFEQ '1'                                                           246309
     C                     MOVEL'B'       DLNAR                                               246309
     C                     ENDIF                                                              246309
      * Payable                                                                               246309
     C           *IN50     IFEQ '1'                                                           246309
     C                     MOVEL'C'       DLNAR                                               246309
     C                     ENDIF                                                              246309
      *                                                                                       246309
      * Move DS to Array for later sorting                                                    246309
     C                     MOVELDSFEAC    ARAC,T                                              246309
     C                     ENDIF                                                              246309
      *                                                                                       246309
     C                     MOVELFEPYON    SVPYON  1                                           246309
     C*
     C** When branch code changes open new spool file
     C*
     C           MBIN      IFEQ 'Y'
     C***********FEBRCA    ANDNESTRBRC                                    085910
     C                     MOVE FEBRCA    STRBRC  3
     C                     MOVE '1'       *IN24
     C***********          SETOF                     8082                 085910
     C           P1OP      IFEQ 'Y'
     C           FEBRCA    ANDNE@SBRP1                                    085910
     C                     MOVE '0'       *IN80                           085910
     C                     CLOSELER180P1
     C                     MOVE ' '       P1OP
     C                     END
     C           P3OP      IFEQ 'Y'
     C           FEBRCA    ANDNE@SBRP3                                    085910
     C                     MOVE '0'       *IN82                           085910
     C                     CLOSELER180P3
     C                     MOVE ' '       P3OP
     C                     END
     C*
     C** If system is multibranching obtain branch name for output
     C*
     C                     MOVELFEBRCA    ##KB                                                CSC042
     C                     EXSR ##CHKB                                                        CSC042
      * If branch is in the array then use the details                                        CSC042
     C           ##FIC     IFEQ 'Y'                        *** B10                            CSC042
     C                     EXSR ##SETB                                                        CSC042
     C                     ELSE                            *** X10                            CSC042
     C**********           CALL 'AOBRCHR0'             99                                     CGL029
     C                     CALL 'AOBRCHR1'             99                                     CGL029
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM FEBRCA    @DSNB   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     MOVELFEBRCA    DBKEY            ** DBERR  09 **
     C                     Z-ADD9         DBASE            ***************
     C                     MOVEL'LER180'  DBPGM
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     ELSE                                                               CSC042
      * Details found on the DB so add them to the array                                      CSC042
      * if the array still has room                                                           CSC042
     C                     EXSR ##ADDB                                                        CSC042
     C                     END
     C                     END                             *** E10                            CSC042
     C*
     C                     END
     C*
     C***  Accruing Facility Fees
     C*
     C           MBIN      IFEQ 'Y'
     C*
     C           FEPYON    IFEQ 'N'
     C           FEPYON    OREQ 'E'
     C*
     C** File has been opened field
     C*
     C           P1OP      IFNE 'Y'
     C                     MOVE 'Y'       P1OP    1
     C                     OPEN LER180P1
     C                     MOVE FEBRCA    @SBRP1  3                       085910
     C                     Z-ADD0         PAGE
      *
      ** Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUM1    ZSNUM
     C*
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM FEBRCA    SENTY   3
     C                     PARM           SFILE1
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
     C*
     C** If error during ZSFILE processing, return to calling program
     C*
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C** Output header
     C*
     C                     WRITELER180A1
     C                     WRITELER180A2
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C***  Amortising Facility Fees
     C*
     C** File has been opened field
     C*
     C           P3OP      IFNE 'Y'
     C                     MOVE 'Y'       P3OP    1
     C                     OPEN LER180P3
     C                     MOVE FEBRCA    @SBRP3  3                       085910
     C                     Z-ADD0         PAGE3
     C*
     C** Ensure report spool file recorded by RCF
     C*
     C                     Z-ADDSFNUM3    ZSNUM
     C*
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM FEBRCA    SENTY   3
     C                     PARM           SFILE3
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
     C*
     C** If error during ZSFILE processing, return to calling program
     C*
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C** Output header
     C*
     C                     WRITELER180C1
     C                     WRITELER180C2
     C*
     C                     END
     C*
     C                     END
      *
      ** If system multibranching
     C                     END
      *
      ** If system is not multibranching set up single spool file
     C           MBIN      IFNE 'Y'
     C*
     C           P1OP      IFNE 'Y'
     C                     CLOSELER180P1
     C                     END
     C*
     C           P3OP      IFNE 'Y'
     C                     CLOSELER180P3
     C                     END
     C*
     C***  Accruing Facility Fees
     C*
     C           FEPYON    IFEQ 'N'
     C           FEPYON    OREQ 'E'
     C*
     C           P1OP      IFNE 'Y'
     C                     MOVE 'Y'       P1OP
     C                     SETOF                     80
     C                     OPEN LER180P1
     C                     Z-ADD0         PAGE
      *
      ** Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUM1    ZSNUM
      *
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILE1
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
      *
      ** If error during ZSFILE processing, return to calling program
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C** Output header
     C*
     C                     WRITELER180A1
     C                     WRITELER180A2
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C***  Amortising Facility Fees
     C*
     C           P3OP      IFNE 'Y'
     C                     MOVE 'Y'       P3OP
     C                     SETOF                     82
     C                     OPEN LER180P3
     C                     Z-ADD0         PAGE3
      *
      ** Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUM3    ZSNUM
      *
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILE3
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
      *
      ** If error during ZSFILE processing, return to calling program
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C** Output header
     C*
     C                     WRITELER180C1
     C                     WRITELER180C2
     C*
     C                     END
     C*
     C                     END
     C*
     C** MBIN IFNE 'Y' end
     C*
     C                     END
     C*
     C** If overflow indicator on, output another header
     C*
     C           *IN80     IFEQ '1'                        Print
     C*                                                                   085910
     C** Perform overflow on P1 only if the record being processed        085910
     C** is an accruing facility fee.                                     085910
     C           FEPYON    IFEQ 'N'                                       085910
     C           FEPYON    OREQ 'E'                                       085910
     C                     WRITELER180A1                   Header
     C                     WRITELER180A2
     C                     SETOF                     80
     C                     END
     C*                                                                   085910
     C                     END                                            085910
     C*                                                                   085910
     C           *IN82     IFEQ '1'                        Print
     C*                                                                   085910
     C** Perform overflow on P3 only if the record being processed        085910
     C** is an amortising facility fee.                                   085910
     C           FEPYON    IFNE 'N'                                       085910
     C           FEPYON    ANDNE'E'                                       085910
     C                     WRITELER180C1                   Header
     C                     WRITELER180C2
     C                     SETOF                     82
     C                     END
     C*                                                                   085910
     C                     END                                            085910
     C*
     C***  Accruing Facility Fees
     C*
     C           FEPYON    IFEQ 'N'
     C           FEPYON    OREQ 'E'
     C*
     C***********SVFAC     IFNE FTYP                               BH3518 085910
     C***********SVBRC     ORNE FEBRCA                             BH3518 085910
     C***********SVCCY     ORNE FEFCCY                             BH3518 085910
     C           @FACP1    IFNE FTYP                                      085910
     C           @CCYP1    ORNE FEFCCY                                    085910
     C           @BRCP1    ORNE FEBRCA                                    085910
     C                     Z-ADDFTYP      @FACP1  30                      085910
     C                     MOVE FEFCCY    @CCYP1  3                       085910
     C                     MOVE FEBRCA    @BRCP1  3                       085910
     C                     WRITELER180A7                                  BH3518
     C                     END                                            BH3518
     C*                                                                   BH3518
     C**********           WRITELER180A3                                                      246309
     C                     Z-ADD1         FCDET1
     C                     Z-ADD1         CYDET1
     C                     Z-ADD1         BRDET1
     C                     ELSE
     C*
     C***  Amortising Facility Fees
     C*
     C***********SVFAC     IFNE FTYP                               BH3518 085910
     C***********SVBRC     ORNE FEBRCA                             BH3518 085910
     C***********SVCCY     ORNE FEFCCY                             BH3518 085910
     C           @FACP3    IFNE FTYP                                      085910
     C           @CCYP3    ORNE FEFCCY                                    085910
     C           @BRCP3    ORNE FEBRCA                                    085910
     C                     Z-ADDFTYP      @FACP3  30                      085910
     C                     MOVE FEFCCY    @CCYP3  3                       085910
     C                     MOVE FEBRCA    @BRCP3  3                       085910
     C                     WRITELER180C7                                  BH3518
     C                     END                                            BH3518
     C*                                                                   BH3518
     C                     WRITELER180C3
     C                     Z-ADD1         FCDET3
     C                     Z-ADD1         CYDET3
     C                     Z-ADD1         BRDET3
     C                     END
     C*
     C           CEXIT     ENDSR
     C/EJECT
     C********************************************************************
     C*
     C*  SRLOAN -- Loan Fee Subroutine
     C*
     C*  CALLED FROM: Main Processing
     C*
     C*  CALLS: Nothing
     C*
     C********************************************************************
     C           SRLOAN    BEGSR
     C*
     C                     ADD  1         @REP2
      *                                                                   CLE005
      ** Set off 'Fee Payable/Fee Receivable' print indicators.           CLE005
      *                                                                   CLE005
     C                     SETOF                     505152               CLE005
     C                     MOVE '0'       *IN53                           156582
     C*
     C** Chain to the loan file for the loan amount
     C** If loan not found, and Historic Retention Period is not 0 (i.e.  085677
     C** loan is not dropped from the system at month end), check on      085677
     C** historic loans file, although the loan should not have been      085677
     C** matured if there are fees outstanding - this fix has been        085677
     C** applied in case there were any loans matured incorrectly         085677
     C** before fix 085677 was applied to LE0450.                         085677
     C*
     C           FELOAN    CHAINCLOAN                71
     C           *IN71     IFEQ '1'                                       085677
     C           BPHRPR    ANDGT0                                         085677
     C           FELOAN    CHAINMLOAN                71                   085677
     C                     ENDIF                                          085677
     C           *IN71     IFEQ '0'
     C                     Z-ADDCPAM      FAMT0
     C*
     C**********           CALL 'AOCURRR0'             99                                     CSC042
     C**********           PARM '*MSG    '@RTCD                                               CSC042
     C**********           PARM '*KEY    '@OPTN                                               CSC042
     C**********           PARM CCY       CURKEY  3                                           CSC042
     C********** SDCURR    PARM SDCURR    DSSDY                                               CSC042
      *
     C********** @RTCD     IFNE *BLANKS                                                       CSC042
     C                     MOVELCCY       ##KC                                                CSC042
     C                     EXSR ##CHKC                                                        CSC042
     C           ##FIC     IFEQ 'Y'                                                           CSC042
     C                     EXSR ##SETC                                                        CSC042
     C                     ELSE                                                               CSC042
     C           *LOCK     IN   LDA                        ***************
     C                     MOVELCCY       DBKEY            *  DBERR 21   *
     C                     Z-ADD21        DBASE            ***************
     C                     MOVEL'LER180  'DBPGM                        ***
     C**********           MOVEL'SDCURRPD'DBFILE                                              CSC042
     C                     MOVEL'CURR,Q  'DBFILE                                              CSC042
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END                             ** E001
      *
     C           A6NBDP    COMP 1                    363435
     C   36      A6NBDP    COMP 3                      3637
     C*
     C                     ELSE
     C* Database error processing
     C           *LOCK     IN   LDA                         ************
     C                     MOVELFELOAN    DBKEY             * DBERR 10 *
     C                     Z-ADD10        DBASE             ***********
     C                     MOVEL'LER180  'DBPGM
     C**********           MOVEL'FCLTY   'DBFILE                          085677
     C                     MOVEL'CLOAN   'DBFILE                          085677
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END
     C*
     C***  Set up 'From' date
     C*
     C           FELPDT    IFLT CODT                                      052703
     C                     Z-ADDFELPDT    ZDAYNO
     C                     ELSE                                           052703
     C                     Z-ADDFEPLPD    ZDAYNO                          052703
     C                     END                                            052703
     C           ZDAYNO    IFEQ 0
     C                     Z-ADDFEPSTD    ZDAYNO
     C                     END
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    FRDATE
      *                                                                                       CLE073
     C/COPY WNCPYSRC,LEH00726
      ** Set up Calculation type                                                              CLE073
      *                                                                                       CLE073
     C                     MOVE FECALT    OFCALT                                              CLE073
     C           CLE073    IFNE 'Y'                                                           CLE073
     C                     CLEAROFCALT                                                        CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C*
     C** Set up the fee amounts for reporting for the record just read
     C*
     C** Calculate the fee amount to be reported
     C*
     C                     Z-ADDCPAM      LAMT0
     C                     Z-ADDFEFAMT    FEEAM0
     C                     Z-ADDFEADAT    CALCD0
     C*                                                                   BH3518
     C***  Bullet fees should have nothing in accrued amount column       BH3518
     C*                                                                   BH3518
     C           FEPYON    IFEQ ' '                                       BH3518
     C                     Z-ADD0         POSTD0                          BH3518
     C                     ELSE                                           BH3518
     C                     Z-ADDFEADAT    POSTD0
     C                     END                                            BH3518
     C/COPY WNCPYSRC,LEH00727
      *                                                                                       CLE073
     C                     MOVE *OFF      *IN11                                               CLE073
     C                     Z-ADD0         FERATE                                              CLE073
      *                                                                                       CLE073
      ** Loans calculated fees                                                                CLE073
      *                                                                                       CLE073
     C********** CLE073    IFEQ 'Y'                                                    CLE073 CLE134
     C           FECALT    IFEQ '97'                                                          CLE073
     C           CLE073    ANDEQ'Y'                                                           CLE134
     C           FECALT    OREQ '98'                                                          CLE073
     C           CLE073    ANDEQ'Y'                                                           CLE134
     C           FECALT    OREQ '99'                                                          CLE073
     C           CLE073    ANDEQ'Y'                                                           CLE134
     C           FECALT    OREQ '90'                                                          CLE134
     C           CLE134    ANDEQ'Y'                                                           CLE134
      *                                                                                       CLE073
     C           FECALT    IFEQ '97'                                                          CLE073
     C           FECALT    OREQ '98'                                                          CLE073
     C                     Z-ADDFEFRT1    FERATE                                              CLE073
     C                     MOVE *ON       *IN11                                               CLE073
     C                     Z-ADD0         FEEAM0                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Set up CALCD0                                                                        CLE073
      *                                                                                       CLE073
     C                     ADD  FELPAM    CALCD0                                              CLE073
     C                     ADD  FEAMTP    CALCD0                                              CLE073
     C           FELPDT    IFGT CODT                                                          CLE073
     C                     Z-ADDFEADBP    CALCD0                                              CLE073
     C                     ADD  FEPAMP    CALCD0                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
      ** Set up POSTD0                                                                        CLE073
      *                                                                                       CLE073
     C           *IN50     IFEQ *ON                                                           CLE073
     C                     SUB  FELPAM    POSTD0                                              CLE073
     C                     SUB  FEAMTP    POSTD0                                              CLE073
     C                     ELSE                                                               CLE073
     C                     ADD  FELPAM    POSTD0                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C           FELPDT    IFGT CODT                                                          CLE073
     C                     Z-ADDFEADBP    POSTD0                                              CLE073
     C           *IN50     IFEQ *ON                                                           CLE073
     C                     SUB  FEPAMP    POSTD0                                              CLE073
     C                     ENDIF                                                              CLE073
     C                     ENDIF                                                              CLE073
      *                                                                                       CLE073
     C                     ENDIF                                                              CLE073
     C**********           ENDIF                                                       CLE073 CLE134
      *                                                                                       CLE073
      *                                                                   156582
      ** Participation Sold Fee Accruals should be negated and            156582
      ** subtracted from the total                                        156582
      *                                                                   156582
     C                     SELEC                                          156582
     C           PTFI      WHEQ 'P'                                       156582
     C           PTFI      OREQ 'S'                                                           CLE106
     C           PTFI      OREQ 'R'                                                           CLE106
     C                     Z-SUBPOSTD0    POSTD0                          156582
     C           PTFI      WHEQ 'I'                                       156582
     C                     MOVE '1'       *IN53                           156582
     C                     ENDSL                                          156582
     C*
     C           SVBRC     IFNE FEBRCA
     C                     MOVELFEBRCA    ##KB                                                CSC042
     C                     EXSR ##CHKB                                                        CSC042
      * If branch is in the array then use the details                                        CSC042
     C           ##FIC     IFEQ 'Y'                        *** B10                            CSC042
     C                     EXSR ##SETB                                                        CSC042
     C                     ELSE                            *** X10                            CSC042
     C**********           CALL 'AOBRCHR0'             99                                     CGL029
     C                     CALL 'AOBRCHR1'             99                                     CGL029
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM FEBRCA    @DSNB   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                                    *
     C                     MOVEL'LER180'  DBPGM             *************
     C                     MOVELFEBRCA    DBKEY             * DBERR 11 *
     C                     Z-ADD11        DBASE             ************
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     ELSE                                                               CSC042
      * Details found on the DB so add them to the array                                      CSC042
      * if the array still has room                                                           CSC042
     C                     EXSR ##ADDB                                                        CSC042
     C                     END
     C                     END                             *** E10                            CSC042
     C                     END
     C*
     C** Access the loan type sub type table to get narrative for next
     C** facility type
     C*
     C           SVLTYP    IFNE FELTYP
     C           SVSUTP    ORNE FESUTP
     C           SVCLAS    ORNE FECLAS                                                        CLE042
     C                     CALL 'AOLOANR0'             99
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           FELTYP
     C                     PARM           FESUTP
     C                     PARM           FECLAS                                              CLE042
     C           SDLOAN    PARM SDLOAN    DSFDY
     C           @RTCD     IFNE *BLANKS                    B1
     C           *LOCK     IN   LDA                         ************
     C                     MOVELFELTYP    DBKEY             * DBERR 12 *
     C                     CAT  FESUTP:1  DBKEY             ************                      CLE042
     C                     CAT  FECLAS:1  DBKEY                                               CLE042
     C*********************MOVE FESUTP    DBKEY             ************                      CLE042
     C                     Z-ADD12        DBASE
     C                     MOVEL'LER180  'DBPGM
     C                     MOVEL'SDLOANPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END                             E1
     C                     END
      *
     C*
     C** Check the currency decimal places and name for the new ccy
     C*
     C           SVCCY     IFNE FEFCCY
     C           SVBRC     ORNE FEBRCA
     C*
     C**********           CALL 'AOCURRR0'             99                                     CSC042
     C**********           PARM '*MSG    '@RTCD                                               CSC042
     C**********           PARM '*KEY    '@OPTN                                               CSC042
     C**********           PARM FEFCCY    CURKEY  3                                           CSC042
     C********** SDCURR    PARM SDCURR    DSSDY                                               CSC042
      *
     C********** @RTCD     IFNE *BLANKS                                                       CSC042
     C                     MOVELFEFCCY    ##KC                                                CSC042
     C                     EXSR ##CHKC                                                        CSC042
     C           ##FIC     IFEQ 'Y'                                                           CSC042
     C                     EXSR ##SETC                                                        CSC042
     C                     ELSE                                                               CSC042
     C           *LOCK     IN   LDA                        ***************
     C                     MOVELFEFCCY    DBKEY            *  DBERR 13   *
     C                     Z-ADD13        DBASE            ***************
     C**********           MOVEL'SDCURRPD'DBFILE                                              CSC042
     C                     MOVEL'CURR,Q  'DBFILE                                              CSC042
     C                     MOVE 'LER180  'DBPGM
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END                             ** E001
     C*
     C           A6NBDP    COMP 1                    323031
     C   32      A6NBDP    COMP 3                      3233
     C*                                                                   100431
     C** Store the fee ccy name for the report headings, to ensure that   100431
     C** it doesn't get corrupted by subsequent chains with               100431
     C** facility currency                                                100431
     C*                                                                   100431
     C                     MOVELA6CYCD    ULCYCD                                            MD026385
     C                     MOVELA6CYNM    ULCYNM                          100431
     C*
     C                     END
     C*
     C           FEPYON    IFEQ 'E'
     C                     ADD  CALCD0    CLTOTA
     C           PTFI      IFNE 'I'                                       156582
     C                     ADD  POSTD0    CXTOA0                          BH3518
     C                     ENDIF                                          156582
     C                     ELSE
     C                     ADD  CALCD0    CLTOTM
     C           PTFI      IFNE 'I'                                       156582
     C                     ADD  POSTD0    CXTOM0                          BH3518
     C                     ENDIF                                          156582
     C                     END
     C*
     C           SVNUM     IFNE FECNUM
     C                     MOVE FECNUM    @BBA    6
     C                     MOVELFECNUM    KEYC   10
     C*
     C                     CALL 'AOCUSTR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           KEYC
     C                     PARM           KEYSTS  7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           @RTCD     IFNE *BLANKS                    B2
     C           *LOCK     IN   LDA                         ************
     C                     MOVELFECNUM    DBKEY             * DBERR 14 *
     C                     Z-ADD14        DBASE             ************
     C                     MOVEL'LER180  'DBPGM
     C                     MOVEL'SDCUSTPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END                             E2
      *
     C                     END                             E1
     C*
     C** If the new fee code is different from the last get the new
     C** fee narrative
     C*
     C           SVCOD     IFNE FEFCOD
     C**********           MOVE FEFCOD    AUFECD           Name of        BHBC01
     C                     Z-ADDFEFCOD    WKFCOD                          BHBC01
     C                     CALL 'AOFEER0'              99
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C**********           PARM AUFECD    FKEY    2                       BHBC01
     C                     PARM WKFCOA    FKEY    2                       BHBC01
     C           SDFEE     PARM SDFEE     DSFDY
      *
     C           @RTCD     IFNE *BLANKS                    B1
     C                     MOVE *ALL'*'   AUFENV
     C********** *LOCK     IN   LDA                         ************  BHBC01
     C**********           MOVELFEFCOD    DBKEY             * DBERR 15 *  BHBC01
     C**********           Z-ADD15        DBASE             ************  BHBC01
     C**********           MOVEL'LER180  'DBPGM                           BHBC01
     C**********           MOVEL'SDFEEPD 'DBFILE                          BHBC01
     C**********           SETON                     U7U8                 BHBC01
     C**********           OUT  LDA                                       BHBC01
     C**********           EXSR AUDIT                                     BHBC01
     C**********           EXSR *PSSR                                     BHBC01
     C                     END                             E1
     C                     END
     C*
     C***  Force page change
     C*
     C********** LINE2     IFGE 57
     C**********           SETON                     81
     C**********           END
     C*
     C********** LINE4     IFGE 57
     C**********           SETON                     83
     C**********           END
      *                                                                   CLE005
      ***If*Switchable*feature*CLE005*is*on,*Set*On*corresponding*Ind.*                CLE005 193475
      ** If Switchable feature CLE006 is ON, set ON corresponding Ind.                        193475
      ** to print the 'Fee Payable/Fee Receivable' Indicator              CLE005
      *                                                                   CLE005
     C********** CLE005    IFEQ 'Y'                                                    CLE005 193475
     C           CLE006    IFEQ 'Y'                                                           193475
      *                                                                   CLE005
     C                     SELEC                                          CLE005
     C           PTFI      WHEQ 'P'                                       CLE005
     C           PTFI      OREQ 'S'                                                           CLE106
     C           PTFI      OREQ 'R'                                                           CLE106
     C                     SETON                     50                   CLE005
     C           PTFI      WHEQ 'I'                                       CLE005
     C                     SETON                     51                   CLE005
     C           PTFI      WHEQ ' '                                       CLE005
     C                     SETON                     52                   CLE005
     C                     ENDSL                                          CLE005
      *                                                                   CLE005
     C                     ENDIF                                          CLE005
     C*
     C** When branch code changes open new spool file
     C*
     C           MBIN      IFEQ 'Y'
     C***********FEBRCA    ANDNESTRBRC                                    085910
     C                     MOVE FEBRCA    STRBRC  3
     C                     MOVE '1'       *IN24
     C***********          SETOF                     8183                 085910
     C           P2OP      IFEQ 'Y'
     C           FEBRCA    ANDNE@SBRP2                                    085910
     C                     MOVE '0'       *IN81                           085910
     C                     CLOSELER180P2
     C                     MOVE ' '       P2OP
     C                     END
     C           P4OP      IFEQ 'Y'
     C           FEBRCA    ANDNE@SBRP4                                    085910
     C                     MOVE '0'       *IN83                           085910
     C                     CLOSELER180P4
     C                     MOVE ' '       P4OP
     C                     END
     C*
     C** If system is multibranching obtain branch name for output
     C*
     C                     MOVELFEBRCA    ##KB                                                CSC042
     C                     EXSR ##CHKB                                                        CSC042
      * If branch is in the array then use the details                                        CSC042
     C           ##FIC     IFEQ 'Y'                        *** B10                            CSC042
     C                     EXSR ##SETB                                                        CSC042
     C                     ELSE                            *** X10                            CSC042
     C**********           CALL 'AOBRCHR0'             99                                     CGL029
     C                     CALL 'AOBRCHR1'             99                                     CGL029
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM FEBRCA    @DSNB   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     MOVELFEBRCA    DBKEY            ** DBERR  16 **
     C                     Z-ADD16        DBASE            ***************
     C                     MOVEL'LER180'  DBPGM
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     SETON                     U7U8
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     ELSE                                                               CSC042
      * Details found on the DB so add them to the array                                      CSC042
      * if the array still has room                                                           CSC042
     C                     EXSR ##ADDB                                                        CSC042
     C                     END
     C                     END                             *** E10                            CSC042
     C*
     C                     END
     C*
     C***  Accruing Loan Fees
     C*
     C           MBIN      IFEQ 'Y'
     C*
     C           FEPYON    IFEQ 'E'
     C*
     C** File has been opened field
     C*
     C           P2OP      IFNE 'Y'
     C                     MOVE 'Y'       P2OP    1
     C                     OPEN LER180P2
     C                     MOVE FEBRCA    @SBRP2  3                       085910
     C                     Z-ADD0         PAGE2
      *
      ** Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUM2    ZSNUM
     C*
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM FEBRCA    SENTY   3
     C                     PARM           SFILE2
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
     C*
     C** If error during ZSFILE processing, return to calling program
     C*
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C** Output header
     C*
     C                     WRITELER180B1
     C                     WRITELER180B2
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C***  Amortising Loan Fees
     C*
     C** File has been opened field
     C*
     C           P4OP      IFNE 'Y'
     C                     MOVE 'Y'       P4OP    1
     C                     OPEN LER180P4
     C                     MOVE FEBRCA    @SBRP4  3                       085910
     C                     Z-ADD0         PAGE4
     C*
     C** Ensure report spool file recorded by RCF
     C*
     C                     Z-ADDSFNUM4    ZSNUM
     C*
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM FEBRCA    SENTY   3
     C                     PARM           SFILE4
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
     C*
     C** If error during ZSFILE processing, return to calling program
     C*
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C** Output header
     C*
     C                     WRITELER180D1
     C                     WRITELER180D2
     C*
     C                     END
     C*
     C                     END
      *
      ** If system multibranching
     C                     END
      *
      ** If system is not multibranching set up single spool file
     C           MBIN      IFNE 'Y'
     C*
     C           P2OP      IFNE 'Y'
     C                     CLOSELER180P2
     C                     END
     C*
     C           P4OP      IFNE 'Y'
     C                     CLOSELER180P4
     C                     END
     C*
     C***  Accruing Loan Fees
     C*
     C           FEPYON    IFEQ 'E'
     C*
     C           P2OP      IFNE 'Y'
     C                     MOVE 'Y'       P2OP
     C                     SETOF                     81
     C                     OPEN LER180P2
     C                     Z-ADD0         PAGE2
      *
      ** Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUM2    ZSNUM
      *
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILE2
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
      *
      ** If error during ZSFILE processing, return to calling program
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
      *
      ** Output header
     C                     WRITELER180B1
     C                     WRITELER180B2
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C***  Amortising Loan Fees
     C*
     C           P4OP      IFNE 'Y'
     C                     MOVE 'Y'       P4OP
     C                     SETOF                     83
     C                     OPEN LER180P4
     C                     Z-ADD0         PAGE4
      *
      ** Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUM4    ZSNUM
      *
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILE4
     C                     PARM           ZSNUM   60
     C                     PARM           ZSERR   1
      *
      ** If error during ZSFILE processing, return to calling program
     C           ZSERR     IFEQ 'Y'
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
      *
      ** Output header
     C                     WRITELER180D1
     C                     WRITELER180D2
      *
     C                     END
     C*
     C                     END
      *
      ** MBIN IFNE 'Y' end
     C                     END
     C*
     C** If overflow indicator on, output another header
     C*
     C           *IN81     IFEQ '1'                        Print
     C*                                                                   085910
     C** Perform overflow on P2 only if the record being processed        085910
     C** is an accruing loan fee.                                         085910
     C           FEPYON    IFEQ 'E'                                       085910
     C                     WRITELER180B1                   Header
     C                     WRITELER180B2
     C                     SETOF                     81
     C                     END
     C*                                                                   085910
     C                     END                                            085910
     C*                                                                   085910
     C           *IN83     IFEQ '1'                        Print
     C*                                                                   085910
     C** Perform overflow on P4 only if the record being processed        085910
     C** is an amortising loan fee.                                       085910
     C           FEPYON    IFNE 'E'                                       085910
     C                     WRITELER180D1                   Header
     C                     WRITELER180D2
     C                     SETOF                     83
     C                     END                                            085910
     C*                                                                   085910
     C                     END
     C*
     C***  Accruing Loan Fees
     C*
     C           FEPYON    IFEQ 'E'
     C*
     C                     WRITELER180B3
     C                     Z-ADD1         CYDET2
     C                     Z-ADD1         BRDET2
     C                     ELSE
     C*
     C***  Amortising Loan Fees
     C*
     C                     WRITELER180D3
     C                     Z-ADD1         CYDET4
     C                     Z-ADD1         BRDET4
     C                     END
     C*
     C                     ENDSR
     C*
     C/EJECT
      ********************************************************************                    CSC042
      *                                                                                       CSC042
      * ##CHKB - Subroutine to check the Branch in the arrays                                 CSC042
      *                                                                                       CSC042
     C           ##CHKB    BEGSR                                                              CSC042
      *                                                                                       CSC042
     C           *LIKE     DEFN A8BRCD    ##KB                                                CSC042
      *                                                                                       CSC042
      * Set off the branch found indicator                                                    CSC042
     C                     MOVEL*BLANK    ##FIC   1                                           CSC042
      *                                                                                       CSC042
      * Save the state of indicator 30 so it can be reset at the end                          CSC042
      * of the SR as it may be used elsewhere in the code                                     CSC042
     C           *IN30     IFEQ *ON                                                           CSC042
     C                     MOVEL'Y'       #IN30   1                                           CSC042
     C                     ELSE                                                               CSC042
     C                     MOVEL'N'       #IN30                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
     C                     SETOF                         30                                   CSC042
      *                                                                                       CSC042
      * Restore the saved Value of B                                                          CSC042
     C                     Z-ADD##BSV     B                                                   CSC042
      *                                                                                       CSC042
     C* Check whether details for Branch already in array                                     CSC042
      *                                                                                       CSC042
      * Is this the same as the last LOKUP, if so we can bypass                               CSC042
      * the LOKUP                                                                             CSC042
      * Defend against B being 0                                                              CSC042
     C           B         IFEQ 0                                                             CSC042
     C                     Z-ADD1         B                                                   CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * If the branch being checked is the same then use these                                CSC042
      * details rather than doing a LOKUP                                                     CSC042
     C           ##KB      IFEQ ##BR,B                                                        CSC042
      * Found so seton 30                                                                     CSC042
     C                     SETON                         30                                   CSC042
     C                     ELSE                                                               CSC042
     C                     Z-ADD1         B                                                   CSC042
     C           ##KB      LOKUP##BR,B                   30                                   CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * Save the last update to B                                                             CSC042
     C           *IN30     IFEQ *ON                                                           CSC042
     C                     Z-ADDB         ##BSV                                               CSC042
      * Set the indicator to show the data was found                                          CSC042
     C                     MOVEL'Y'       ##FIC                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * Reset the state of indicator 30.                                                      CSC042
     C           #IN30     IFEQ 'Y'                                                           CSC042
     C                     MOVEL*ON       *IN30                                               CSC042
     C                     ELSE                                                               CSC042
     C                     MOVEL*OFF      *IN30                                               CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
     C                     ENDSR                                                              CSC042
      ********************************************************************                    CSC042
      /EJECT                                                                                  CSC042
      ********************************************************************                    CSC042
      *                                                                                       CSC042
      * ##SETB - Sets up the SDBRCHPD fields used in the code from the                        CSC042
      * arrays                                                                                CSC042
      *                                                                                       CSC042
     C           ##SETB    BEGSR                                                              CSC042
      *                                                                                       CSC042
     C                     MOVEL##BR,B    A8BRCD                                              CSC042
     C                     MOVEL##BN,B    BRNM                                                CSC042
      *                                                                                       CSC042
     C                     ENDSR                                                              CSC042
      *                                                                                       CSC042
      ********************************************************************                    CSC042
      /EJECT                                                                                  CSC042
      ********************************************************************                    CSC042
      *                                                                                       CSC042
      * ##ADDB - Adds the SDBRCHPD fields used in the code to the                             CSC042
      * arrays                                                                                CSC042
      *                                                                                       CSC042
     C           ##ADDB    BEGSR                                                              CSC042
      *                                                                                       CSC042
      * If there is still room in the array then add the details                              CSC042
     C           ##BNDX    IFLT 999                                                           CSC042
     C                     ADD  1         ##BNDX                                              CSC042
     C                     Z-ADD##BNDX    B                                                   CSC042
     C                     MOVELA8BRCD    ##BR,B                                              CSC042
     C                     MOVELBRNM      ##BN,B                                              CSC042
     C                     END                                                                CSC042
      *                                                                                       CSC042
      * Update ##BSV  so next call to ##CHKB checks this latest adddition                     CSC042
      * to the array firss                                                                    CSC042
     C                     Z-ADDB         ##BSV                                               CSC042
      *                                                                                       CSC042
     C                     ENDSR                                                              CSC042
      ********************************************************************                    CSC042
      /EJECT                                                                                  CSC042
     C********************************************************************
     C*
     C*  CHANGE -- Check for change of facility, branch, or currency
     C*
     C*  CALLED FROM: Main Processing
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C           CHANGE    BEGSR
     C*
     C***  Facility type changed, or currency changed, or branch chgd
     C*
     C           SVFAC     IFNE FTYP
     C           SVFAC     ANDNE0                                                             246309
     C           SVCCY     ORNE FEFCCY
     C           SVCCY     ANDNE*BLANKS                                                       246309
     C           SVBRC     ORNE FEBRCA
     C           SVBRC     ANDNE*BLANKS                                                       246309
      *                                                                                       246309
     C                     EXSR WRFEAC                                                        246309
     C*
     C***  If details written to P1
     C*
     C           FCDET1    IFEQ 1
     C                     WRITELER180A5
     C                     Z-ADD0         FCDET1  20
     C                     Z-ADD0         FCTOTA 150
     C                     Z-ADD0         FATOA0 150                      BH3518
     C                     END
     C*
     C***  If details written to P3
     C*
     C           FCDET3    IFEQ 1
     C                     WRITELER180C5
     C                     Z-ADD0         FCDET3  20
     C                     Z-ADD0         FCTOTM 150
     C                     Z-ADD0         FATOM0 150                      BH3518
     C                     END
     C*
     C                     END
     C*
     C***  If currency changed, or branch changed
     C*
     C           SVCCY     IFNE FEFCCY
     C           SVBRC     ORNE FEBRCA
     C*
     C***  If details written to P1
     C*
     C           CYDET1    IFEQ 1
     C                     WRITELER180A6
     C                     Z-ADD0         CYDET1  20
     C                     ADD  CFTOTA    BRTOT  150
     C                     Z-ADD0         CFTOTA 150
     C                     Z-ADD0         CATOA0 150                      BH3518
     C*
     C***  For change of currency need new headers
     C*
     C           *IN70     IFEQ '0'
     C                     MOVE '1'       *IN80
     C                     END
     C*
     C                     END
     C*
     C***  If details written to P2
     C*
     C           CYDET2    IFEQ 1
     C                     WRITELER180B6
     C                     Z-ADD0         CYDET2  20
     C                     ADD  CLTOTA    BRTOT
     C                     Z-ADD0         CLTOTA 150
     C                     Z-ADD0         CXTOA0                          BH3518
     C*
     C***  For change of currency need new headers
     C*
     C           *IN70     IFEQ '0'
     C                     MOVE '1'       *IN81
     C                     END
     C*
     C                     END
     C*
     C***  If details written to P3
     C*
     C           CYDET3    IFEQ 1
     C                     WRITELER180C6
     C                     Z-ADD0         CYDET3  20
     C                     ADD  CFTOTM    BRTOT
     C                     Z-ADD0         CFTOTM 150
     C                     Z-ADD0         CATOM0 150                      BH3518
     C*
     C***  For change of currency need new headers
     C*
     C           *IN70     IFEQ '0'
     C                     MOVE '1'       *IN82
     C                     END
     C*
     C                     END
     C*
     C***  If details written to P4
     C*
     C           CYDET4    IFEQ 1
     C                     WRITELER180D6
     C                     Z-ADD0         CYDET4  20
     C                     ADD  CLTOTM    BRTOT
     C                     Z-ADD0         CLTOTM 150
     C                     Z-ADD0         CXTOM0                          BH3518
     C*
     C***  For change of currency need new headers
     C*
     C           *IN70     IFEQ '0'
     C                     MOVE '1'       *IN83
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C***  If branch changed
     C*
     C           SVBRC     IFNE FEBRCA
     C*
     C***  If details written to P1
     C*
     C           BRDET1    IFEQ 1
     C                     WRITELER180A4
     C                     Z-ADD0         BRDET1  20
     C                     END
     C*
     C***  If details written to P2
     C*
     C           BRDET2    IFEQ 1
     C                     WRITELER180B4
     C                     Z-ADD0         BRDET2  20
     C                     END
     C*
     C***  If details written to P3
     C*
     C           BRDET3    IFEQ 1
     C                     WRITELER180C4
     C                     Z-ADD0         BRDET3  20
     C                     END
     C*
     C***  If details written to P4
     C*
     C           BRDET4    IFEQ 1
     C                     WRITELER180D4
     C                     Z-ADD0         BRDET4  20
     C                     END
     C*
     C** Keep a branch total (in unconverted, mixed ccys) for no reason
     C*
     C                     ADD  BRTOT     ALLTOT 150
     C                     Z-ADD0         BRTOT
     C*
     C                     END
     C*
     C                     ENDSR
     C*
     C/EJECT
     C********************************************************************                    246309
     C*                                                                                       246309
     C*  WRFEAC -- Write newly sorted details of LER180P1                                     246309
     C*                                                                                       246309
     C*  CALLED FROM: CHANGE                                                                  246309
     C*                                                                                       246309
     C*  CALLS: Nothing                                                                       246309
     C*                                                                                       246309
     C********************************************************************                    246309
     C           WRFEAC    BEGSR                                                              246309
      *                                                                                       246309
     C           SVPYON    IFEQ 'N'                                                           246309
     C**********           Z-ADD1         T2      20                                 246309 AR894146
     C                     Z-ADD1         T2      40                                        AR894146
     C                     SORTAARAC                                                          246309
     C           T2        DOUGTT                                                             246309
     C                     CLEARDSFEAC                                                        246309
     C                     MOVELARAC,T2   DSFEAC                                              246309
      *                                                                                       246309
     C                     MOVELDIN11     *IN11                                               246309
     C                     MOVELDIN12     *IN12                                               246309
     C                     MOVELDIN16     *IN16                                               246309
     C                     MOVELDIN50     *IN50                                               246309
     C                     MOVELDIN51     *IN51                                               246309
     C                     MOVELDIN52     *IN52                                               246309
     C                     MOVELDIN53     *IN53                                               246309
      *                                                                                       246309
     C                     MOVELDFTYP     FTYP                                                246309
     C                     MOVELDFSEQ     FSEQ                                                246309
     C**********           MOVELDFESEQ    FEFSEQ                                     246309 MD026385
     C                     MOVE @VFSEQ    FEFSEQ                                            MD026385
     C                     MOVELDCNUM     FECNUM                                              246309
     C                     MOVELDBCRNM    BBCRNM                                              246309
     C                     MOVELDBCRTN    BBCRTN                                              246309
     C**********           MOVELDFCOD     FEFCOD                                     246309 MD026385
     C                     MOVE @VFCOD    FEFCOD                                            MD026385
     C                     MOVELDFCCY     FCCY                                                246309
     C                     MOVELDRDATE    FRDATE                                              246309
     C**********           MOVELDECALT    FECALT                                     246309 MD026385
     C                     MOVEL@VCALT    FECALT                                            MD026385
     C                     MOVELDERATE    FERATE                                              246309
     C                     MOVELDECOMT    FECOMT                                              246309
      *                                                                                       246309
     C           DIN30     IFEQ '1'                                                           246309
     C                     MOVELDFAMTS    FAMT0                                               246309
     C                     MOVELDFEEAM    FEEAM0                                              246309
     C                     MOVELDCALCD    CALCD0                                              246309
     C                     MOVELDPOSTD    POSTD0                                              246309
     C                     MOVEL'1'       *IN30                                               246309
     C                     ENDIF                                                              246309
     C           DIN31     IFEQ '1'                                                           246309
     C                     MOVELDFAMTS    FAMT1                                               246309
     C                     MOVELDFEEAM    FEEAM1                                              246309
     C                     MOVELDCALCD    CALCD1                                              246309
     C                     MOVELDPOSTD    POSTD1                                              246309
     C                     MOVEL'1'       *IN31                                               246309
     C                     ENDIF                                                              246309
     C           DIN32     IFEQ '1'                                                           246309
     C                     MOVELDFAMTS    FAMT2                                               246309
     C                     MOVELDFEEAM    FEEAM2                                              246309
     C                     MOVELDCALCD    CALCD2                                              246309
     C                     MOVELDPOSTD    POSTD2                                              246309
     C                     MOVEL'1'       *IN32                                               246309
     C                     ENDIF                                                              246309
     C           DIN33     IFEQ '1'                                                           246309
     C                     MOVELDFAMTS    FAMT3                                               246309
     C                     MOVELDFEEAM    FEEAM3                                              246309
     C                     MOVELDCALCD    CALCD3                                              246309
     C                     MOVELDPOSTD    POSTD3                                              246309
     C                     MOVEL'1'       DIN33                                               246309
     C                     ENDIF                                                              246309
      *                                                                                       246309
     C           FECNUM    IFNE '999999'                                                    MD026385
     C           DFCCY     ANDNE'999'                                                       MD026385
     C                     WRITELER180A3                                                      246309
     C                     MOVEL'1'       @PHDR   1                                           246309
     C                     MOVEL@VFAC     FTYP                                                246309
     C                     MOVEL@VSEQ     FSEQ                                                246309
     C                     ADD  1         T2                                                  246309
     C                     ENDIF                                                            MD026385
      *                                                                                       246309
     C*ryan                MOVEL*BLANKS   BBCRNM                                              246309
     C*ryan                MOVEL*BLANKS   BBCRTN                                              246309
      * Check Overflow                                                                        246309
     C           *IN80     IFEQ '1'                                                           246309
     C                     WRITELER180A1                                                      246309
     C                     WRITELER180A2                                                      246309
     C                     SETOF                     80                                       246309
     C                     ENDIF                                                              246309
      *                                                                                       246309
     C                     ENDDO                                                              246309
      *                                                                                       246309
     C                     Z-ADD0         T                                                   246309
     C                     MOVEA*ALL'9'   ARAC,1                                              246309
     C                     ENDIF                                                              246309
      *                                                                                       246309
     C                     Z-ADD0         T                                                   246309
     C                     Z-ADD0         T2                                                  246309
     C                     MOVEA*ALL'9'   ARAC,1                                              246309
     C                     MOVEL@VCNUM    FECNUM                                              246309
     C                     MOVEL@VFAC     FTYP                                                246309
     C                     MOVEL@VSEQ     FSEQ                                                246309
      *                                                                                       246309
     C                     ENDSR                                                              246309
     C********************************************************************
     C*
     C*  AVCALC -- Calculation of fees based on average balances
     C*
     C*  CALLED FROM: Main Processing
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C           AVCALC    BEGSR
      *
      ** Obtain original facility details from facility history header.
      *
     C           FACKEY    CHAINFACHISH              20
      *
     C           *IN20     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'LER180'  DBPGM
     C                     MOVELFECNUM    DBKEY
     C                     MOVE FEFACL    DBKEY
     C                     MOVEL'FACHISH' DBFILE           ************
     C                     Z-ADD17        DBASE            * DBERR 17 *
     C                     OUT  LDA                        ************
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END
     C*
     C                     Z-ADD0         WAMT   130
     C                     Z-ADD0         WPCT    63
     C*
     C***  Set up Start and End dates
     C*
     C                     MOVE '0'       *IN19                           100658
     C           FELPDT    IFLT CODT                                      052703
     C                     Z-ADDFELPDT    STDATE  50     19
     C                     ELSE                                           052703
     C                     Z-ADDFEPLPD    STDATE                          052703
     C           STDATE    IFEQ 0                                         100658
     C                     MOVE '1'       *IN19                           100658
     C                     END                                            100658
     C                     END                                            052703
     C   19                Z-ADDFEPSTD    STDATE
     C                     Z-ADDCODT      ENDATE  50
     C           FEPEND    IFLE CODT
     C                     Z-ADDFEPEND    ENDATE
     C                     END
      *
      ** Obtain number of days to use.
      *
     C********** ENDATE    SUB  STDATE    WDAYS   50                      CLE013
     C                     Z-ADDSTDATE    ZZBEG                           CLE013
     C                     Z-ADDENDATE    ZZEND                           CLE013
     C                     MOVE FECALC    ZZCALC                          CLE013
     C                     EXSR ZINTDY                                    CLE013
     C           FECALC    IFEQ 6                                                             212048
     C                     Z-ADDINT6DY    WDAYS                                               212048
     C                     ELSE                                                               212048
     C**********           Z-ADDZZINDY    WDAYS   50                                 CLE013 MD037658
     C                     Z-ADDZZINDY    WDAYS  159                                        MD037658
     C                     END                                                                212048
     C*
     C*************************************************************101322 138165
     C***Consider*the*Accrue*on*Last*Day*indicator*when*calculating101322 138165
     C***for the*due*amount****************************************101322 138165
     C*************************************************************101322 138165
     C***********FEPYON    IFEQ 'N'                                101322 138165
     C***********BKALDI    ANDNE'Y'                                101322 138165
     C***********FELPDT    IFEQ 0                                  101322 138165
     C***********FELPDT    ORGE CODT                               101322 138165
     C***********FEPLPD    ANDEQ0                                  101322 138165
     C***********          ADD  1         WDAYS                    101322 138165
     C***********          END                                     101322 138165
     C***********ENDATE    IFEQ FEPEND                             101322 138165
     C***********          SUB  1         WDAYS                    101322 138165
     C***********          END                                     101322 138165
     C***********          END                                     101322 138165
     C*
     C** Get starting amount from facility history file
     C*
     C           HSAKY1    SETGTFACHSAL1
     C                     READPFACHSAL1                 20
      *
      ** Set up current facility amount from file.
      *
      ** Set up amount for accrual according to calculation type.
      ** Calculation types 01 to 06 use available facility amount,
      ** types 11 to 16 use outstanding facility amount and
      ** types 21 and 22 use the current facility amount.
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '02'
     C           FECALT    OREQ '03'
     C           FAUNDR    IFGE 0
     C                     Z-ADDFAUNDR    AAMT   130
     C                     ELSE
     C                     Z-ADD0         AAMT
     C                     END
     C                     ELSE
     C           FECALT    IFEQ '11'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '13'
     C                     Z-ADDFADRAM    AAMT
     C                     ELSE
     C           FECALT    IFEQ '21'
     C                     Z-ADDFACFAM    AAMT
     C                     END
     C                     END
     C                     END
      *
      ** Initialise work fee field.
      *
     C                     Z-ADD0         WFEE   130
      *
      ** Read file until date read is greater than date of end of
      ** this accrual period.
      ** NDAYS is the number of days in this accrual.
      *
     C                     MOVE '0'       *IN18
     C           *IN18     DOWEQ'0'
     C           HSAKY2    READEFACHSAL1                 18
      *
     C           *IN18     IFEQ '1'
     C           FADATE    ORGT ENDATE
     C                     Z-ADDENDATE    FADATE
     C                     MOVE '1'       *IN18
     C                     END
      *
     C********** FADATE    SUB  STDATE    NDAYS   50                      CLE013
     C                     Z-ADDSTDATE    ZZBEG                           CLE013
     C                     Z-ADDFADATE    ZZEND                           CLE013
     C                     MOVE FECALC    ZZCALC                          CLE013
     C                     EXSR ZINTDY                                    CLE013
     C           FECALC    IFEQ 6                                                             212048
     C                     Z-ADDINT6DY    NDAYS                                               212048
     C                     ELSE                                                               212048
     C**********           Z-ADDZZINDY    NDAYS   50                                 CLE013 MD037658
     C                     Z-ADDZZINDY    NDAYS  159                                        MD037658
     C                     END                                                                212048
      *
     C***********                                                  101322 138165
     C***********FADATE    IFEQ ENDATE                             101322 138165
     C************IN18     ANDEQ'1'                                101322 138165
     C*************************************************************101322 138165
     C***Consider*the*Accrue*on*Last*Day*indicator*when*calculating101322 138165
     C***for*the*due*amount****************************************101322 138165
     C*************************************************************101322 138165
     C***********FEPYON    IFEQ 'N'                                101322 138165
     C***********BKALDI    ANDNE'Y'                                101322 138165
     C***********FELPDT    IFEQ 0                                  101322 138165
     C***********FELPDT    ORGE CODT                               101322 138165
     C***********FEPLPD    ANDEQ0                                  101322 138165
     C***********          ADD  1         NDAYS                    101322 138165
     C***********          END                                     101322 138165
     C***********ENDATE    IFEQ FEPEND                             101322 138165
     C***********          SUB  1         NDAYS                    101322 138165
     C***********          END                                     101322 138165
     C***********          END                                     101322 138165
     C***********          END                                     101322 138165
      *
     C           NDAYS     IFGT 0
      *
      ** Average amount used (only does accrual once)
      *
     C                     MULT NDAYS     AAMT
     C                     DIV  WDAYS     AAMT      H
     C                     ADD  AAMT      WAMT
     C                     Z-ADDFADATE    STDATE
     C                     END
      *
      ** Reset amount to accrue - comes from next record on amounts
      ** file.
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '02'
     C           FECALT    OREQ '03'
     C           FAUNDR    IFGE 0
     C                     Z-ADDFAUNDR    AAMT
     C                     ELSE
     C                     Z-ADD0         AAMT
     C                     END
     C                     ELSE
     C           FECALT    IFEQ '11'
     C           FECALT    OREQ '12'
     C           FECALT    OREQ '13'
     C                     Z-ADDFADRAM    AAMT
     C                     ELSE
     C           FECALT    IFEQ '21'
     C                     Z-ADDFACFAM    AAMT
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C/COPY WNCPYSRC,LER180C007
     C                     EXSR ACCRUE
     C                     Z-ADDWTOT      WFEE
     C                     ENDSR
     C/EJECT
      *****************************************************************
     C/TITLE SR/ACCRUE
      *****************************************************************
      *
      *  ACCRUE - SUBROUTINE TO CALCULATE ACCRUAL AMOUNT
      *
      *  CALLED FROM: AVCALC
      *
      *  CALLS: ZXRATE, ZCONV, LSTRAT, AOCURRR0
      *
      *****************************************************************
      *
     C           ACCRUE    BEGSR
      *
     C                     Z-ADD0         WTOT
      *
      ** Calculate percentage if required.
      ** Use original facility amount for average.
      *
     C           FEPIND    IFNE 'A'
     C           FHOFAM    IFGT 0                                                             246018
     C           FHOFAM    IFNE 0                                                             246309
     C           WAMT      DIV  FHOFAM    WRK155    H
     C                     ELSE                                                               246309
     C                     Z-ADD0         WRK155                                              246309
     C                     ENDIF                                                              246309
     C                     ELSE                                                               246018
     C                     Z-ADD0         WRK155                                              246018
     C                     ENDIF                                                              246018
     C           WRK155    MULT 100       WPCT
     C                     Z-ADDFHOFAM    WAMT
     C           WPCT      IFGT 100
     C                     Z-ADD100       WPCT
     C                     END
     C                     END
      *
      ** Convert from facility to fee currency if required.
      ** If exchange rate field on fees master file is blank
      ** obtain cross-currency exchange rate for these
      ** two currencies from the standing data files otherwise use
      ** exchange rate on fees master file.
      *
     C           FHFCCY    IFNE FEFCCY
     C                     Z-ADDWAMT      CAMT   130
     C           FEERAT    IFEQ 0
     C                     MOVE FHFCCY    INCCY   3
     C                     MOVE FEFCCY    OUTCCY  3
     C                     Z-ADD1         X
     C           INCCY     LOKUPCURR,X                   13
     C           *IN13     IFEQ '1'
     C                     MOVE MTDV,X    ZMDI1   1
     C                     Z-ADDCSPT,X    ZRATE1 138
     C                     Z-ADDCCDP,X    ZNBDP1  10
     C                     END
      *
     C                     Z-ADD1         X
     C           OUTCCY    LOKUPCURR,X                   14
     C           *IN14     IFEQ '1'
     C                     MOVE MTDV,X    ZMDI2   1
     C                     Z-ADDCSPT,X    ZRATE2 138
     C                     Z-ADDCCDP,X    ZNBDP2  10
     C                     END
      *
      ** Obtain cross exchange rate & cross multiply/divide indicator.
      *
     C                     EXSR ZXRATE
     C*                                                                   S01408
     C/COPY WNCPYSRC,LER180CCP1                                           S01408
     C*                                                                   S01408
      *
      ** Set up input fields for conversion subroutine.
      *
     C                     Z-ADDZRATEX    ZEXCH  138
     C                     MOVE ZMDIX     ZMD     1
     C                     Z-ADDCAMT      ZAMTCI 150
     C                     MOVE INCCY     ZCCYI   3
     C                     MOVE OUTCCY    ZCCYO   3
     C                     Z-ADDZNBDP1    ZCDPI   10
     C                     Z-ADDZNBDP2    ZCDPO   10
      *
     C                     EXSR ZCONV
      *
     C                     Z-ADDZAMTCO    CAMT
      *
      ** Exchange rate not blank
      *
     C                     ELSE
      *
     C**********           CALL 'AOCURRR0'                                                    CSC042
     C**********           PARM '*MSG   ' WRTCD   7                                           CSC042
     C**********           PARM '*KEY   ' WOPTN   7                                           CSC042
     C**********           PARM FHFCCY    WAJCD   3                                           CSC042
     C********** SDCURR    PARM SDCURR    DSSDY                                               CSC042
     C********** WRTCD     IFNE *BLANKS                                                       CSC042
     C                     MOVELFHFCCY    ##KC                                                CSC042
     C                     EXSR ##CHKC                                                        CSC042
     C           ##FIC     IFEQ 'Y'                                                           CSC042
     C                     EXSR ##SETC                                                        CSC042
     C                     ELSE                                                               CSC042
     C           *LOCK     IN   LDA
     C                     MOVEL'LER180'  DBPGM
     C**********           MOVEL'SDCURRPD'DBFILE           ************                       CSC042
     C                     MOVEL'CURR,Q  'DBFILE           ************                       CSC042
     C                     Z-ADD18        DBASE            * DBERR 18 *
     C                     MOVELFHFCCY    DBKEY            ************
     C                     OUT  LDA
     C                     EXSR AUDIT
     C                     EXSR *PSSR
     C                     END
      *
      ** Set up currency decimal place power position.
      *
     C           A6NBDP    ADD  4         FD      10
      *
      ** Fee currency decimal places + 1.
      *
     C                     Z-ADDP         TD      10
      *
      ** Adjust incoming amount for from CCY decimal places.
      *
     C           CAMT      DIV  POWER,FD  WRK153
      *
      ** Exchange rate conversion.
      *
     C           FEMDIN    IFEQ 'M'
     C                     MULT FEERAT    WRK153
     C                     ELSE
     C                     DIV  FEERAT    WRK153    H
     C                     END
      *
      ** Adjust calculated amount for to currency decimal places.
      *
     C           WRK153    MULT POWER,TD  CAMT
      *
     C                     END
     C                     Z-ADDCAMT      WAMT
     C                     END
      *
      ** Look up factor for division corresponding to calc. basis
      *
     C                     MOVE '0'       *IN25
     C           FECALC    LOKUPTABCAL    TABCBS         25
     C                     MOVE TABCBS    WCBS    50
      *
      ** TIERED CALCULATION:
      ** ------------------
      *
     C           FECALT    IFEQ '01'
     C           FECALT    OREQ '11'
      *
      ** Amount (not percentage)
      *
     C           FEPIND    IFEQ 'A'
      *
      ** Convert limit amounts for fee decimal places.
      *
     C           FEAM      MULT POWER,P   FAM
     C                     Z-ADD0         WFAM
     C                     Z-ADDWAMT      WOAMT
     C                     Z-ADD1         X
     C           WAMT      DOWGT0
     C           X         ANDLT6
      *
     C           WOAMT     IFLT FAM,X
     C           FAM,X     OREQ 0
     C           WAMT      MULT FRT,X     WRK15
     C                     ELSE
     C           FAM,X     SUB  WFAM      WRK15
     C                     MULT FRT,X     WRK15
     C                     END
     C                     ADD  WRK15     WTOT
     C                     SUB  FAM,X     WAMT
     C                     ADD  WFAM      WAMT
     C                     Z-ADDFAM,X     WFAM
      *
     C                     ADD  1         X
      *
     C                     END
      *                                                                   BH3451
      ** Calculate final accrual amount.                                  BH3451
      *                                                                   BH3451
     C**********           MULT WDAYS     WTOT                                       BH3451 MD046351
     C**********           DIV  WCBS      WTOT      H                                BH3451 MD046351
      *                                                                                     MD046351
     C           WTOT      MULT WDAYS     ZWK309 309                                        MD046351
     C                     DIV  WCBS      ZWK309    H                                       MD046351
     C                     Z-ADDZWK309    WTOT      H                                       MD046351
      *
     C                     ELSE
      *
      ** - PERCENTAGE:
      *
     C           FEAM      DIV  1000      FPC
      *
     C                     Z-ADD0         WFPC
     C                     Z-ADDWPCT      WOPCT
     C                     Z-ADD1         X
     C           WPCT      DOWGT0
     C           X         ANDLT6
      *
     C           WOPCT     IFLT FPC,X
     C           FPC,X     OREQ 0
     C           WAMT      MULT WPCT      WRK15
     C                     ELSE
     C           FPC,X     SUB  WFPC      WRK63
     C           WAMT      MULT WRK63     WRK15
     C                     END
     C                     MULT FRT,X     WRK15
     C                     DIV  100       WRK15     H
     C                     ADD  WRK15     WTOT
     C                     SUB  FPC,X     WPCT
     C                     ADD  WFPC      WPCT
     C                     Z-ADDFPC,X     WFPC
      *
     C                     ADD  1         X
      *
     C                     END
      *                                                                   BH3451
      ** Calculate final accrual amount.                                  BH3451
      *                                                                   BH3451
     C**********           MULT WDAYS     WTOT                                       BH3451 MD046351
     C**********           DIV  WCBS      WTOT      H                                BH3451 MD046351
      *                                                                                     MD046351
     C           WTOT      MULT WDAYS     ZWK309                                            MD046351
     C                     DIV  WCBS      ZWK309    H                                       MD046351
     C                     Z-ADDZWK309    WTOT      H                                       MD046351
      *
     C                     END
      *
     C                     END
      *
      ** THRESHOLD CALCULATION:
      ** ---------------------
      *
     C           FECALT    IFEQ '02'
     C           FECALT    OREQ '12'
      *
      ** - AMOUNT:
      *
     C           FEPIND    IFEQ 'A'
      *
      ** Convert limit amounts for fee decimal places.
      *
     C           FEAM      MULT POWER,P   FAM
      *
      ** Search amount array to find value larger or equal.
      *
     C                     Z-ADD1         X
     C                     MOVE '0'       *IN25
      *
     C           WAMT      LOKUPFAM,X                25  25
     C           *IN25     IFEQ '0'
     C                     EXSR LSTRAT
     C                     END
      *
     C           *IN25     IFEQ '0'
     C           Y         ANDEQ0
     C                     MULT 0         WAMT
     C                     ELSE
     C                     MULT FRT,X     WAMT
     C                     END
      *
     C********** WAMT      MULT WDAYS     WTOT                                              MD046351
     C**********           DIV  WCBS      WTOT      H                                       MD046351
      *                                                                                     MD046351
     C           WAMT      MULT WDAYS     ZWK309                                            MD046351
     C                     DIV  WCBS      ZWK309    H                                       MD046351
     C                     Z-ADDZWK309    WTOT      H                                       MD046351
      *
     C                     ELSE
      *
      ** - PERCENTAGE:
      *
     C           FEAM      DIV  1000      FPC
      *
      ** Search percentage array to find value larger or equal.
      *
     C                     Z-ADD1         X
     C                     MOVE '0'       *IN25
     C           WPCT      LOKUPFPC,X                25  25
     C           *IN25     IFEQ '0'
     C                     EXSR LSTRAT
     C                     END
     C                     MULT WPCT      WAMT
      *
     C           *IN25     IFEQ '0'
     C           Y         ANDEQ0
     C                     MULT 0         WAMT
     C                     ELSE
     C                     MULT FRT,X     WAMT
     C                     END
      *
     C                     DIV  100       WAMT      H
     C********** WAMT      MULT WDAYS     WTOT                                              MD046351
     C**********           DIV  WCBS      WTOT      H                                       MD046351
      *                                                                                     MD046351
     C           WAMT      MULT WDAYS     ZWK309                                            MD046351
     C                     DIV  WCBS      ZWK309    H                                       MD046351
     C                     Z-ADDZWK309    WTOT      H                                       MD046351
      *
     C                     END
      *
     C                     END
      *
      ** SINGLE CALCULATION:
      ** ------------------
      *
     C           FECALT    IFEQ '03'
     C           FECALT    OREQ '13'
     C           FECALT    OREQ '21'
      *
     C********** WAMT      MULT FRT,1     WTOT                                              MD046351
     C**********           MULT WDAYS     WTOT                                              MD046351
     C**********           DIV  WCBS      WTOT      H                                       MD046351
      *                                                                                     MD046351
     C           WAMT      MULT FRT,1     ZWK309                                            MD046351
     C                     MULT WDAYS     ZWK309                                            MD046351
     C                     DIV  WCBS      ZWK309    H                                       MD046351
     C                     Z-ADDZWK309    WTOT      H                                       MD046351
     C                     END
      *
     C                     ENDSR
      *
     C********************************************************************
     C*  SETP  --- Set up counter P for array POWER                       085309
     C*                                                                   085309
     C*  CALLED FROM: SRFACY                                              085309
     C*                                                                   085309
     C*  CALLS: NOTHING                                                   085309
     C*                                                                   085309
     C********************************************************************085309
     C           SETP      BEGSR                                          085309
     C*                                                                   085309
     C** Check the currency decimal places and name for the new ccy       085309
     C*                                                                   085309
     C**********           CALL 'AOCURRR0'             99                              085309 CSC042
     C**********           PARM '*MSG    '@RTCD                                        085309 CSC042
     C**********           PARM '*KEY    '@OPTN                                        085309 CSC042
     C**********           PARM FEFCCY    CURKEY  3                                    085309 CSC042
     C********** SDCURR    PARM SDCURR    DSSDY                                        085309 CSC042
      *                                                                   085309
     C********** @RTCD     IFNE *BLANKS                                                085309 CSC042
     C                     MOVELFEFCCY    ##KC                                                CSC042
     C                     EXSR ##CHKC                                                        CSC042
     C           ##FIC     IFEQ 'Y'                                                           CSC042
     C                     EXSR ##SETC                                                        CSC042
     C                     ELSE                                                               CSC042
     C           *LOCK     IN   LDA                        ***************085309
     C                     MOVELFEFCCY    DBKEY            *  DBERR 06   *085309
     C                     Z-ADD6         DBASE            ***************085309
     C**********           MOVEL'SDCURRPD'DBFILE                                       085309 CSC042
     C                     MOVEL'CURR,Q  'DBFILE                                              CSC042
     C                     MOVE 'LER180  'DBPGM                           085309
     C                     SETON                     U7U8                 085309
     C                     OUT  LDA                                       085309
     C                     EXSR AUDIT                                     085309
     C                     EXSR *PSSR                                     085309
     C                     END                             ** E001        085309
      *                                                                   085309
     C           A6NBDP    COMP 1                    323031               085309
     C   32      A6NBDP    COMP 3                      3233               085309
     C                     Z-ADDA6NBDP    DP      20                      085309
     C           DP        ADD  4         P       10                      085309
     C*                                                                   100431
     C** Store the fee ccy name for the report headings, to ensure that   100431
     C** it doesn't get corrupted by subsequent chains with               100431
     C** facility currency                                                100431
     C*                                                                   100431
     C                     MOVELA6CYCD    ULCYCD                                            MD026385
     C                     MOVELA6CYNM    ULCYNM                          100431
     C*                                                                   085309
     C                     ENDSR                                          085309
     C*
     C********************************************************************
     C*  AUDIT --- End of Report Subroutine
     C*
     C*  CALLED FROM: Main Processing
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C           AUDIT     BEGSR
      *
     C                     Z-ADD0         PAGE5
     C           @REP1     ADD  @REP2     @REP
      *
      ** Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUMU    ZSNUMU  60
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILEU
     C                     PARM           ZSNUMU
     C                     PARM           ZSERR
      *
     C           ZSERR     IFEQ 'Y'
      ** Error during ZSFILE processing, return to calling program
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
      *
     C                     WRITELER180E1
      *
      ** If an error output database error format
      *
     C           *INU7     IFEQ '1'
     C                     WRITEDBFMT
     C                     ELSE
      *
     C           @REP1     IFEQ 0                          Nothing to
     C           @REP2     ANDEQ0
     C                     WRITELER180E3                   Report
     C                     ELSE
     C*
     C** Detail format
     C*
     C                     WRITELER180E2
     C                     END
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *
      *  LSTRAT SUBROUTINE TO FIND LAST RATE IN AMOUNT/%AGE ARRAY.
      *
      *  CALLED FROM:  ACCRUE
      *
      *  CALLS:  NOTHING
      *
      *****************************************************************
      *
     C           LSTRAT    BEGSR
      *
     C                     Z-ADD5         Y       20
     C           Y         DOWGT0
     C           FEAM,Y    IFEQ 0
     C           FRT,Y     ANDNE0
     C                     Z-ADDY         X
     C                     Z-ADD0         Y
     C                     END
     C                     SUB  1         Y
     C                     END
      *
     C                     ENDSR
      *
     C********************************************************************
     C*
     C*  *PSSR --- SUBROUTINE TO HANDLE ABNORMAL ERROR CONDITIONS
     C*
     C*  CALLED FROM: AFTER ABNORMAL OPERATION OCCURS
     C*
     C*  CALLS: NOTHING
     C*
     C********************************************************************
     C*
     C           *PSSR     BEGSR                           ** *PSSR **
     C*
     C           @RUN      IFEQ *BLANKS
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C                     END
     C*
     C                     SETON                     U7U8LR
     C                     RETRN
     C*
     C                     ENDSR                           ** *PSSR **
     C*
     C********************************************************************
      *
     C/COPY ZSRSRC,ZXRATEZ1
      *
     C/COPY ZSRSRC,ZCONVZ1
      *
     C/COPY ZSRSRC,ZDATE2Z2
      *
     C/COPY ZSRSRC,ZINTDYZ2                                               CLE013
     C/COPY ZSRSRC,ZDATE9Z3                                               CLE013
     C/COPY ZSRSRC,ZDAT10Z2                                               CLE013
     C********************************************************************
** CPY@   **      OBJECT COPYRIGHT
(c) Finastra International Limited 2001
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
** NARR   ** FEE NARRATIVE
TIERED
THRESHLD
SINGLE
AVL/AVE/TR
AVL/AVE/TH
AVL/AVE/SI
AVL/ACT/TR
AVL/ACT/TH
AVL/ACT/SI
OUT/AVE/TR
OUT/AVE/TH
OUT/AVE/SI
OUT/ACT/TR
OUT/ACT/TH
OUT/ACT/SI
FAC/AVE/SI
FAC/ACT/SI
**   TABCAL/TABCBS - CALCULATION BASES.
136500236000336000436500536000636600
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN    CLE013
00366007310109601461                                                      CLE013
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR       CLE013
00000000310005900090001200015100181002120024300273003040033400365         CLE013
