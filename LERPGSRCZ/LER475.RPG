     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas LE Profitability enquiry')                       *
      *****************************************************************
      *                                                               *
      *  Midas Customer Lending Module                                *
      *                                                               *
      *  LER475 - Profitability Enquiry.                              *
      *                                                               *
      *  Function: Enquire on Profitability details by Business Group *
      *            at either Bank, Department, Account Officer or     *
      *            Customer level.                                    *
      *                                                               *
      *  Phase: Input Cycle.                                          *
      *                                                               *
      *  Called By: LERC47E - CL program to run Profitability Enquiry *
      *                                                               *
      *  Calls: GPCLRM   - Clear Program Subfile Message Queue        *
      *         GPADDM   - Add Message to Subfile Message Queue       *
      *         LERDATEF - Validate and convert date to day number    *
      *                    for first day of month.                    *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. CLE138             Date 02Nov21               *
      *  Prev Amend No. 250608             Date 19May22               *
      *                 MD046248           Date 27Oct17               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CLE106             Date 27Apr05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 CPK016             Date 03Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 11Oct00               *
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSD007             Date 28Aug00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 176443             Date 18Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 163668             Date 14Jul99               *
      *                 161257             Date 29Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 158560             Date 06Apr99               *
      *                 157377 (E46985)    Date 17Mar99               *
      *                 157376 (LONG1)     Date 17Mar99               *
      *                 156777             Date 09Mar99               *
      *                 156043             Date 05Feb99               *
      *                 148866             Date 24Feb99               *
      *                 148861             Date 24Feb99               *
      *                 141462             Date 24Feb99               *
      *                 117167             DATE 19FEB98               *
      *                 104036             DATE 19FEB98               *
      *                 066382             DATE 26APR96               *
      *                 BH3464             DATE 13AUG92               *
      *                 ALIEN1             DATE 13JUL92               *
      *                 BH3379             DATE 10JUL92               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CLE138 - Class Codes for Facilities                          *
      *  250608 - The Name should be over the type of loan on the     *
      *           summary of Agent section. (Recompile)               *
      *  MD046248 - Finastra Rebranding                               *
      *  CLE134 - Past Due Call Loan Processing (Recompile)           *
      *  CLE148 - Alpha Loan Reference                                *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type                              *
      *  CLE106 - Syndication Manager                                 *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CPK016 - Release 5 packaging.  Clash of field names.         *
      *  CSD006 - Use correct parameters for Access Objects           *
      *  CSD006 - Use correct parameters for Access Objects           *
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
      *  CSD007 - Customer Closing                                    *
      *  176443 - Avoid MCH3601 to be sent.                           *
      *           Pass correct parameter to AOCUSTR0.                 *
      *  163668 - Profitability showing on facility customer not on   *
      *           agent customer                                      *
      *  161257 - Further to 141462, show average balance for         *
      *           participants of the prime facility as negative.     *
      *  158560 - Yield/margin rate calculations do not include       *
      *           negative amounts, ie from parts sold.               *
      *  157377 - Change calculation of average aggregate balance     *
      *           dates from LERSTS instead of run date               *
      *  157376 - Output average balance fields as calculated in
      *           LER430 i.e. using actual days in year as opposed
      *           to days loan live in year. An addition to 052572
      *           in LER430/LER440 etc.
      *  156777 - Reset subfile indicators so that no details error   *
      *           is displayed correctly.                             *
      *  156043 - Payable fee showing on profitability as income      *
      *  148866 - Program amended to subtract Internal parts purchased*
      *           from Total Loans average balance. Also margin and   *
      *           yield totals amended to calculate proper amounts.   *
      *  148861 - Ensure Credit agreements are not double accounted   *
      *           on facilities totals.                               *
      *  141462 - Profitability is not being reflected properly when  *
      *           participants have a share of Fees and Margin. The   *
      *           solution for this is not to count Internal Parts    *
      *           Purch as part of profit and in case of fees,        *
      *           subtract participant share as it is done for margin.*
      *  117167 - Wrong Average Balance is being shown due to         *
      *           different definition of file field and screen field.*
      *           Change screen field to 15 0 then adjust the display *
      *           of fields to the subfile.                           *
      *  104036 - The temporary fields used in the accumulation of    *
      *           MTD and YTD margins for business group are not      *
      *           reset causing erroneous margin amounts in the       *
      *           enquiry screen for different customers.             *
      *  066382 - On the 1st day of the year : the from date should
      *           be 1jan of last year no. and days should be 365.
      *  BH3464 - Prevent output of lots of Retail Accounts lines.    *
      *           Add them up instead, and output one DR & one CR.    *
      *  ALIEN1 - For GL A/Cs, (Other Charges/Fees) account info. is  *
      *           output by account (multiple records) or             *
      *           consolidated (single record) for each customer.     *
      *  BH3379 - Access level does not work correctly                *
      *                                                               *
      *****************************************************************
     F***LEPEFCD*IF**E***        K        DISK                            157376
     FLENQLF0 IF  E           K        DISK
     F            LENQF                             KRENAMELENQF0
     FLENQLF1 IF  E           K        DISK
     F            LENQF                             KRENAMELENQF1
     FLENQLF2 IF  E           K        DISK
     F            LENQF                             KRENAMELENQF2
     FLENQLF3 IF  E           K        DISK                               141462
     F            LENQF                             KRENAMELENQF3         141462
     FLEFCLTL2IF  E           K        DISK         KINFSR *PSSR          141462
     FFCLTY   IF  E           K        DISK                               148861
     F            FCLTYFMF                          KRENAMEFCLTY1         148861
     F            FCLTYHHF                          KIGNORE               148861
     F            FCLTYZZF                          KIGNORE               148861
     F            FCLTYFNF                          KIGNORE               148861
     FCLOAN   IF  E           K        DISK                               141462
     F            CLOANHHF                          KIGNORE               141462
     F            CLOANCKF                          KIGNORE               141462
     F            CLOANZ1F                          KIGNORE               141462
     FMLOAN   IF  E           K        DISK                               141462
     F            CLOANHHF                          KIGNORE               141462
     F            CLOANZ1F                          KIGNORE               141462
     F            CLOANCKF                          KIGNORE               141462
     F            CLOANCLF                          KRENAMEMCLONCLF       141462
     FLER475DFCF  E                    WORKSTN
     F                                        RGMTD KSFILE LER475S1
     F                                        RGYTD KSFILE LER475S2
     F                                        RDMTD KSFILE LER475S3
     F                                        RDYTD KSFILE LER475S4
      ** MIDAS LE FACILITIES EXT FILE BY FACILITY                         CLE138
     FLEFCLTLHIF  E           K        DISK                               CLE138
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   01  - F1 pressed, output year to date figures.              *
     F*   02  - F2 pressed, output month to date figures.             *
     F*   03  - F3 pressed for exit.                                  *
     F*   04  - F4 pressed, output next record for selected level.    *
     F*   05  - F5 pressed, output detail record.                     *
     F*   06  - F6 pressed, output group record.                      *
     F*                                                               *
     F*   09  - '?' processing required by access program.            *
     F*                                                               *
     F*   10  - OFF = Perform first cycle calculations.               *
     F*                                                               *
     F*   11  - Customer number entered.                              *
     F*   12  - Account officer code entered.                         *
     F*   13  - Department code entered.                              *
     F*   14  - Account officer total requested.                      *
     F*   15  - Department total requested.                           *
     F*   16  - Bank total requested.                                 *
     F*                                                               *
     F*   19  - User not authorised to Profitability information.     *
     F*                                                               *
     F*   20  - Condition enabling & display of function key F1.      *
     F*   21  - Condition enabling & display of function key F2.      *
     F*   22  - Condition enabling & display of function key F5.      *
     F*   23  - Condition enabling & display of function key F6.      *
     F*   24  - Condition enabling & display of function key F4.      *
     F*                                                               *
     F*   25  - Last record found on LENQLF0 or LENQLF1.              *
     F*                                                               *
     F*   26  - Profitability enquiry by business group requested.    *
     F*   27  - Profitability enquiry by facility requested.          *
     F*                                                               *
     F*   30  - Enable SFLDSPCTL for group month to date subfile.     *
     F*   31  - Enable SFLEND for group month to date subfile.        *
     F*   32  - Enable SFLDSPCTL for detail month to date subfile.    *
     F*   33  - Enable SFLEND for detail month to date subfile.       *
     F*   34  - Enable SFLDSPCTL for group year to date subfile.      *
     F*   35  - Enable SFLEND for group year to date subfile.         *
     F*   36  - Enable SFLDSPCTL for detail month to date subfile     *
     F*   37  - Enable SFLEND for detail month to date subfile.       *
     F*   43  - Enable SFLDSP & SFLDSPCTL for message subfile.        *
     F*   44  - Enable SFLEND for message subfile.                    *
     F*                                                               *
     F*   45  - Error on customer number entered.                     *
     F*   46  - Error on account officer total entered.               *
     F*   47  - Error on department code / department total entered.  *
     F*   48  - Error on bank total entered.                          *
     F*                                                               *
     F*   50  - Enquiry type requested NOT customer level.            *
     F*                                                               *
     F*   60  - Error looking up month three character shortname.     *
     F*                                                               *
     F*   70  - Loan previously matured.                              *
     F*                                                               *
     F*   71  - Conditions output for group month to date.            *
     F*   72  - Conditions output for detail month to date.           *
     F*   73  - Conditions output for group year to date.             *
     F*   74  - Conditions output for detail year to date.            *
     F*                                                               *
     F*   89  - Record not found on READE for LENQLF0,1 or 2,         *
     F*         or CHAIN fail on LEPEFCD, or end of file on LER475D2. *
     F*                                                               *
     F*   99  - Error in ZDATE1 or ZDATE2 subroutines.                *
     F*                                                               *
     F*   U7  - Database error.                                       *
     F*   U8  - Database error.                                       *
     F*                                                               *
     F*   LR  - Last record indicator.                                *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*
     F*  S U B R O U T I N E   I N D E X
     F*
     F*  VALSR   - Validate input.
     F*  NEXTSR  - Find next customer, account officer or department.
     F*  CLRSFL  - Clear subfiles.
     F*  BLDSFL  - Build subfiles.
     F*  DSPSFL  - Display subfiles.
     F*  DETAIL  - Process detail & customer extract records.
     F*  GROUP   - Process group extract records.
     F*  LONDET  - Accumulate loan & facility totals.
     F*  FACTOT  - Calculate final totals for facility.
     F*  LONTOT  - Calculate final totals for loan/group.
     F*  MOVDTA  - Set up fields in subfiles.
     F*  REDET   - Add up Retail Accounts.                                BH3464
     F*  RETOT   - Output totals for Retail Accounts.                     BH3464
     F***AVLOAN**-*Calculate*days*for*average*loan*totals.                157376
     F*  ZEROS   - Zeroise totals for next display.
     F*  BLKLIN  - Output blank lines to subfiles.
     F*  FACNAM  - Get facility name.
     F*  LVL0    - Validate level 0 input.
     F*  LVL1    - Validate level 1 input.
     F*  LVL2    - Validate level 2 input.
     F*  CUSAC   - Get customer account officer name
     F*  CUSVAL  - Validate customer.
     F*  ACOVAL  - Validate account officer.
     F*  DPTVAL  - Validate department.
     F*  NWCUST  - Find new customer and industry names.
     F*  CUSNAM  - Get customer details.
     F*  NWDEPT  - Find new department name
     F*  INIT    - Perform first cycle calculations.
     F*
     F*  *PSSR   - Error processing routine - DUMPs and ends
     F*             (This is called automatically if an unexpected
     F*             error occurs).
     F*
     F*****************************************************************
     E/EJECT
     E/COPY ZSRSRC,ZDATE2Z1
     E                    MDAY       31  1 0             LOAN DAYS-MTH
     E                    YDAY      366  1 0             LOAN DAYS-YR
     E                    AMDAY      31  1               LOAN DAYS-MTH
     E                    AYDAY     366  1               LOAN DAYS-YR
     E                    TMDY       31  1 0             TOTAL DAYS-MTH
     E                    TYDY      366  1 0             TOTAL DAYS-YR
     E                    MMDY       31  1 0             MATRD.DAYS-MTH
     E                    MYDY      366  1 0             MATRD.DAYS-YR
     E                    MAV         9 15 0             MTD AV.BAL.
     E                    YAV         9 15 0             YTD AV.BAL.
     E                    CPY@    1   1 80               COPYRIGHT
     E                    MSG     1  21 22               MESSAGES
     E                    TOT     1   3 25               TOTAL NARRATIVES
     E/COPY ZSRSRC,ZFRPEDZ1                                               163668
     I/EJECT
     ILENQF0                                                              ALIEN1
     I              BRCA                            NQBRCA                ALIEN1
     ILENQF1                                                              ALIEN1
     I              BRCA                            NQBRCA                ALIEN1
     ILENQF2                                                              ALIEN1
     I              BRCA                            NQBRCA                ALIEN1
     IMCLONCLF                                                            141462
     I              CNUM                            LNCNUM                141462
     I              BRCA                            LNBRCA                141462
     I              MDAT                            LNMDAT                141462
     I              LNRF                            LNLNRF                141462
     I              FSEQ                            LNFSEQ                141462
     I              TOTN                            LNTOTN                                    CPK016
     ICLOANCLF                                                            141462
     I              CNUM                            LNCNUM                141462
     I              BRCA                            LNBRCA                141462
     I              MDAT                            LNMDAT                141462
     I              LNRF                            LNLNRF                141462
     I              FSEQ                            LNFSEQ                141462
     I              TOTN                            LNTOTN                                    CPK016
     IFCLTYFMF                                                            141462
     I              CNUM                            FCCNUM                141462
     I              BRCA                            FCBRCA                141462
     I*                                                                   ALIEN1
     IFCLTY1                                                              148861
     I              CNUM                            F1CNUM                148861
     I*                                                                   148861
     ILER475D2
     I                                              CNUM            11
     I                                              ACOF            12
     I                                              DEPT            13
     I                                              ATOT            14
     I                                              DTOT            15
     I                                              BTOT            16
     I            DS                                                      066382
     I*                                                                   066382
     I** Data structure for to date of display.                           066382
     I*                                                                   066382
     I                                        1   7 PDAT1                 066382
     I                                        1   5 PDM                   066382
     I                                        6   7 PYY                   066382
     I            DS                                                      066382
     I*                                                                   066382
     I** Data structure for from date of display.                         066382
     I*                                                                   066382
     I                                        1   7 FRDT                  066382
     I                                        1   5 FDM                   066382
     I                                        6   7 FYY                   066382
     I            DS
     I*
     I** Data structure for type of display.
     I*
     I                                        1   2 TYPE
     I                                        1   1 T1
     I                                        2   2 T2
     I            DS
     I*
     I** Split alpha date.
     I*
     I                                        1   7 ADAT
     I                                        3   5 MMM
     I                                        6   7 YY
     I            DS
     I*
     I* Split numeric date.
     I*
     I                                        1   6 NDAT
     I                                        1   2 DD
     I                                        3   6 MY
     I            DS
     I*
     I** Define facility number.
     I*
     ***********                              1   50FCN                   163668
     I**********                              1  110FCN                                163668 CSD027
     I                                        1  11 FCN                                       CSD027
     I                                        1   30NQFTYP
     I                                        4   50NQFSEQ
     I**********                              6  110NQFACL                             163668 CSD027
     I                                        6  11 NQFACL                                    CSD027
     I            DS
     I*
     I** Define saved facility number.
     I*
     I***********                             1   50SAVFCN                163668
     I**********                              1  110SAVFCN                             163668 CSD027
     I                                        1  11 SAVFCN                                    CSD027
     I                                        1   30SVFTYP
     I                                        4   50SVFSEQ
     I**********                              6  110SVFACL                             163668 CSD027
     I                                        6  11 SVFACL                                    CSD027
     I            DS                                                      ALIEN1
     I*                                                                   ALIEN1
     I** Define GL account details for narrative.                         ALIEN1
     I*                                                                   ALIEN1
     I**********                              1  15 FEEAC                              ALIEN1 CGL029
     I                                        1  21 FEEAC                                     CGL029
     I                                        1   3 NQBRCA                ALIEN1
     I                                        4   4 SLASH1                ALIEN1
     I                                        5   7 NQACCY                ALIEN1
     I                                        8   8 SLASH2                ALIEN1
     I**********                              9  120NQACOD                             ALIEN1 CGL029
     I**********                             13  13 SLASH3                             ALIEN1 CGL029
     I**********                             14  150NQACSQ                             ALIEN1 CGL029
     I                                        9  180NQACOD                                    CGL029
     I                                       19  19 SLASH3                                    CGL029
     I                                       20  210NQACSQ                                    CGL029
     I            DS
     I*
     I** Define facility details for narrative.
     I*
     I****************************************1  18 FNAME                                     CLE042
     I                                        1  22 FNAME                                     CLE042
     I                                        1  15 FCNM
     I                                       16  16 DASH1
     I                                       17  18 FSEQ
     I            DS
     I*
     I** Define loan details for narrative.
     I*
     I****************************************1  18 LNAME                                     CLE042
     I                                        1  22 LNAME                                     CLE042
     I                                        1   6 LCUS
     I                                        7   7 DASH2
     I                                        8  13 LNRF
     I                                       14  14 DASH3
     I                                       15  16 LTYP
     I                                       17  18 SUTP
     I                                       19  22 CLAS                                      CLE042
     I            DS
     I*
     I** Deal month to date averages data structure.
     I*
     I                                    P   1  720MAV
     I                                    P   1   80NQMAVA
     I                                    P   9  160NQMAVB
     I                                    P  17  240NQMAVC
     I                                    P  25  320NQMAVD
     I                                    P  33  400NQMAVE
     I                                    P  41  480NQMAVF
     I                                    P  49  560NQMAVG
     I                                    P  57  640NQMAVH
     I                                    P  65  720NQMAVI
     I            DS
     I*
     I** Deal year to date averages data structure.
     I*
     I                                    P   1  720YAV
     I                                    P   1   80NQYAVA
     I                                    P   9  160NQYAVB
     I                                    P  17  240NQYAVC
     I                                    P  25  320NQYAVD
     I                                    P  33  400NQYAVE
     I                                    P  41  480NQYAVF
     I                                    P  49  560NQYAVG
     I                                    P  57  640NQYAVH
     I                                    P  65  720NQYAVI
     INQMDAY      DS
     I*
     I** Month day array data structure.
     I*
     I                                        1  31 AMDAY
     INQYDAY      DS
     I*
     I** Year day array data structure.
     I*
     I                                        1 366 AYDAY
     IPSDS       SDS
     I*
     I** Program status data structure.
     I*
     I                                      244 253 JOB
     I                                      254 263 USER
     I            DS                                                      CLE138
     I*                                                                   CLE138
     I** Split up date for printing                                       CLE138
     I*                                                                   CLE138
     I                                        1   7 DBFKEY                CLE138
     I                                        1   3 PTYPA                 CLE138
     I                                        4   7 PFCLS                 CLE138
     ILDA       E DS
     I*
     I** Database error data structure.
     I*
     ILERSTS    E DS
     I*
     I** LERSTS Data area.
     I*
     I              FACHISD                         WHISST
     I              LERC2030                        LERC20
     I              LERC135                         LERC13
     I              LERC315                         LERC35
     I              LERC425                         LERC42
     I              EOYFLAG                         EOYFLG
     I*
     I                                      122 128 PDAT
     ISCSARD    E DSSCSARDPD                                              CSD007
      ** External Data Structure for Switchable Features                  CSD007
      *                                                                   CSD007
     ISDBANK    E DSSDBANKPD
     I*
     I** Bank Details, read by access program.
     ISDCURR    E DSSDCURRPD
     I*
     I** Currency Details, read by access program.
     ISDCUST    E DSSDCUSTPD
     I*
     I** Customer Details, read by access program.
     ISDINDS    E DSSDINDSPD
     I*
     I** Local Industry Details, read by access program.
     ISDACOF    E DSSDACOFPD
     I*
     I** Account Officer Details, read by access program.
     ISDDEPT    E DSSDDEPTPD
     I*
     I** Facility Type Details, read by access program.
     I/COPY WNCPYSRC,LER475I001
     ISDFACT    E DSSDFACTPD
     I*
     I** Department Details, read by access program.
     IDSFDY     E DSDSFDY
     I*
     I** Short data structure for access program.
     IDSSDY     E DSDSSDY
      *                                                                   CSD007
      ** Third DS for access programs, very long data structure           CSD007
     IDSLDY     E DSDSLDY                                                 CSD007
     I*
     I** Long data structure for access program.
     I/COPY ZSRSRC,ZFRPEDZ2                                               163668
     C/EJECT
     C*
     C** Perform initial processing.
     C*
     C           *IN10     CASEQ'0'       INIT
     C                     END
     C*
     C** If user not authorised to enquiry then output message and exit.
     C*
     C           *IN19     IFEQ '1'
     C                     WRITELER475D1
     C                     MOVEL'LER0126' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     MOVEA'11'      *IN,43
     C                     WRITELER475CM
     C                     EXFMTLER475D0
     C/COPY WNCPYSRC,LER475C001
     C                     SETON                     LR
     C                     RETRN
     C                     END
     C*
     C** Output selection screen.
     C*
     C                     WRITELER475D1
     C                     WRITELER475D0
     C                     WRITELER475D2
     C*
     C** Do while F3 not pressed.
     C*
     C           *IN03     DOWEQ'0'
     C*
     C** Read input from selection screen.
     C*
     C                     READ LER475D2                 89
     C*
     C** F3 pressed or user not authorised - exit from request.
     C*
     C           *IN03     IFEQ '1'
     C           ALVL      OREQ 9
     C/COPY WNCPYSRC,LER475C002
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     ELSE
     C*
     C** Clear screen message queue.
     C*
     C                     MOVEA'0000'    *IN,45
     C                     CALL 'GPCLRM'
     C                     MOVE *BLANKS   MSGID
     C*
     C** Perform processing dependant on which key pressed.
     C*
     C** If function key pressed no data must be entered.
     C*
     C                     MOVEA*IN,11    INTEST
     C                     MOVEA*IN,01    CKTEST
     C           CKTEST    IFNE '000000'
     C           INTEST    ANDNE'111111'
     C                     MOVEA'1111'    *IN,45
     C                     MOVEL'LER0116' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     EXSR DSPSFL
     C                     ELSE
     C*
     C** F1 pressed - get year to date figures.
     C*
     C           *IN01     IFEQ '1'
     C                     MOVE 'Y'       T1
     C                     EXSR DSPSFL
     C                     ELSE
     C*
     C** F2 pressed - get month to date figures.
     C*
     C           *IN02     IFEQ '1'
     C                     MOVE 'M'       T1
     C                     EXSR DSPSFL
     C                     ELSE
     C*
     C** F4 pressed - get next record of selected level.
     C*
     C           *IN04     IFEQ '1'
     C                     EXSR NEXTSR
     C                     EXSR DSPSFL
     C                     ELSE
     C*
     C** F5 pressed - get detail records.
     C*
     C           *IN05     IFEQ '1'
     C                     MOVE 'D'       T2
     C                     EXSR DSPSFL
     C                     ELSE
     C*
     C** F6 pressed - get group records.
     C*
     C           *IN06     IFEQ '1'
     C                     MOVE 'G'       T2
     C                     EXSR DSPSFL
     C                     ELSE
     C*
     C** Enter pressed - validate input.
     C*
     C                     EXSR VALSR
     C*
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C                     END
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  VALSR --- Subroutine to validate input.                      *
      *                                                               *
      *  CALLED FROM: Main processing.                                *
      *  CALLS: LVL0, LVL1, LVL2, CLRSFL, BLDSFL, DSPSFL              *
      *                                                               *
      *****************************************************************
     C*
     C           VALSR     BEGSR
     C*
     C** Entry of either full or only one of other fields allowed.
     C*
     C                     MOVEA*IN,11    INTEST
     C*
     C** If invalid combination input...
     C*
     C           INTEST    IFNE '011111'
     C           INTEST    ANDNE'101111'
     C           INTEST    ANDNE'110111'
     C           INTEST    ANDNE'111011'
     C           INTEST    ANDNE'111101'
     C           INTEST    ANDNE'111110'
     C*
     C** ...check for all blank...
     C*
     C           INTEST    IFEQ '111111'
     C                     MOVEL'LER0119' MSGID
     C                     ELSE
     C*
     C** ...or more than one entered.
     C*
     C                     MOVEL'LER0120' MSGID
     C                     END
     C*
     C** Output error message.
     C*
     C                     MOVEA'1111'    *IN,45
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     END
     C/COPY WNCPYSRC,LER475C003
     C*
     C** Perform additional validation.
     C*
     C           ALVL      CASEQ0         LVL0
     C                     END
     C           ALVL      CASEQ1         LVL1
     C                     END
     C           ALVL      CASEQ2         LVL2
     C                     END
     C*
     C** If no errors, get appropriate record for display.
     C*
     C           MSGID     IFEQ *BLANKS
     C*
     C                     EXSR CLRSFL
     C                     EXSR BLDSFL
     C                     EXSR DSPSFL
     C*
     C                     ELSE
     C           TYPE      IFEQ *BLANKS
     C*
     C** Condition output of the footer on there not being any errors
     C** so that output of message does not result in the rollup/
     C** rolldown message.
     C*
     C                     WRITELER475CM
     C                     WRITELER475D1
     C                     WRITELER475D2
     C                     ELSE
     C                     EXSR DSPSFL
     C                     END
     C                     END
     C*
     C** Reset '?' processing indicator.
     C*
     C                     MOVE '0'       *IN09
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  NEXTSR --- Find next customer, account officer or department *
      *                                                               *
      *  CALLED FROM: Main processing.                                *
      *  CALLS: NWCUST, NWACOF, NWDEPT, CLRSFL, BLDSFL                *
      *                                                               *
      *****************************************************************
     C*
     C           NEXTSR    BEGSR
     C*
     C** Read to get details of next record on file.
     C*
     C                     MOVE '0'       *IN25
     C*
     C           KRTYP     IFEQ 'C'
     C           LF0KEY    SETGTLENQLF0
     C                     READ LENQLF0                  25
     C                     ELSE
     C           LF1KEY    SETGTLENQLF1
     C                     READ LENQLF1                  25
     C                     END
     C*
     C** If not end of file, check if details match the level of user.
     C*
     C           *IN25     IFEQ '0'
     C*
     C           ALVL      IFEQ 0
     C           NQACOF    IFNE KACOF
     C                     MOVE '1'       *IN25
     C                     END
     C                     ELSE
     C           ALVL      IFEQ 1
     C           NQDEPT    IFNE KDEPT
     C                     MOVE '1'       *IN25
     C                     END
     C                     ELSE
     C           ALVL      IFEQ 2
     C           KRTYP     IFEQ 'C'
     C           NQRTYP    ANDNE'C'
     C           NQRTYP    ANDNE'F'
     C           KRTYP     ORNE 'C'
     C           NQRTYP    ANDNEKRTYP
     C                     MOVE '1'       *IN25
     C                     END
     C                     END
     C                     END
     C                     END
     C*
     C                     END
     C*
     C** Set up next record details if valid.
     C*
     C           *IN25     IFEQ '0'
     C*
     C           KRTYP     IFEQ 'C'
     C/COPY WNCPYSRC,LER475C004
     C                     MOVE NQDEPT    KDEPT
     C                     MOVE NQACOF    KACOF
     C                     MOVE NQCNUM    KCNUM
     C                     EXSR NWCUST
     C                     END
     C*
     C           KRTYP     IFEQ 'A'
     C/COPY WNCPYSRC,LER475C005
     C                     MOVE NQDEPT    KDEPT
     C                     MOVE NQACOF    KACOF
     C                     MOVE NQACOF    XACOF
     C                     EXSR NWACOF
     C                     END
     C*
     C           KRTYP     IFEQ 'D'
     C/COPY WNCPYSRC,LER475C006
     C                     MOVE NQDEPT    KDEPT
     C                     MOVE NQDEPT    XDEPT
     C                     EXSR NWDEPT
     C                     END
     C*
     C** If valid record read, build subfile.
     C** Otherwise, redisplay existing one with message.
     C*
     C                     EXSR CLRSFL
     C                     EXSR BLDSFL
     C*
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  CLRSFL --- Subroutine to clear subfiles.                     *
      *                                                               *
      *  CALLED FROM: VALSR, NEXTSR                                   *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           CLRSFL    BEGSR
     C*
     C                     MOVE '0'       *IN30
     C                     WRITELER475C1
     C*
     C                     MOVE '0'       *IN32
     C                     WRITELER475C2
     C*
     C                     MOVE '0'       *IN34
     C                     WRITELER475C3
     C*
     C                     MOVE '0'       *IN36
     C                     WRITELER475C4
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  BLDSFL --- Subroutine to build subfiles.                     *
      *                                                               *
      *  CALLED FROM: VALSR, NEXTSR                                   *
      *  CALLS: NWCUST, NWACOF, NWDEPT, ZEROS, GROUP, LONTOT, DETAIL  *
      *                                                               *
      *****************************************************************
     C*
     C           BLDSFL    BEGSR
     C*
     C** Blank out prompt fields.
     C*
     C                     MOVE *BLANKS   CNAME
     C                     MOVE *BLANKS   CTOWN
     C                     MOVE *BLANKS   INAME
     C                     MOVE *BLANKS   ANAME
     C                     MOVE *BLANKS   DNAME
     C                     MOVE *BLANKS   TOTN
     C*
     C** Set indicator to disable display of customer, account officer
     C** & local industry names if enquiry is not at customer level.
     C*
     C           KRTYP     IFNE 'C'
     C                     MOVE '1'       *IN50
     C                     ELSE
     C                     MOVE '0'       *IN50
     C                     END
     C*
     C** Set up narratives.
     C*
     C********** KCNUM     IFNE 0                                                             CSD027
     C           KCNUM     IFNE *BLANKS                                                       CSD027
     C                     EXSR NWCUST
     C                     ELSE
     C           KACOF     IFNE *BLANKS
     C                     MOVE KACOF     XACOF
     C                     EXSR NWACOF
     C                     MOVELTOT,1     TOTN
     C                     ELSE
     C           KDEPT     IFNE *BLANKS
     C                     MOVE KDEPT     XDEPT
     C                     EXSR NWDEPT
     C                     MOVELTOT,2     TOTN
     C                     MOVE DNAME     ANAME
     C                     MOVE *BLANKS   DNAME
     C                     ELSE
     C                     MOVELTOT,3     TOTN
     C                     MOVE *BLANKS   ANAME
     C                     MOVE *BLANKS   DNAME
     C                     END
     C                     END
     C                     END
     C*
     C** Zeroise work fields.
     C*
     C                     EXSR ZEROS
     C*
     C** Build group subfiles.
     C*
     C*                                                                   BH3379
     C** Save the current value first so that it can be reinstated for    BH3379
     C** the next record                                                  BH3379
     C*                                                                   BH3379
     C                     MOVE T2        SAVT2   1                       BH3379
     C                     MOVE 'G'       T2
     C*
     C** Set lower limits on appropriate file.
     C*
     C           KRTYP     IFEQ 'C'
     C           LF0KEY    SETLLLENQLF0
     C                     ELSE
     C           LF1KEY    SETLLLENQLF1
     C                     END
     C*
     C** Read all records from appropriate file.
     C*
     C                     MOVE '0'       *IN25
     C                     MOVE '0'       *IN89
     C                     Z-ADD0         RGYTD
     C                     Z-ADD0         RGMTD
     C*
     C           *IN89     DOWEQ'0'
     C*
     C           KRTYP     IFEQ 'C'
     C           LF0KEY    READELENQLF0                  89
     C                     ELSE
     C           LF1KEY    READELENQLF1                  89
     C                     END
     C*
     C** Write records to subfile, totalling for loans/facilities.
     C*
     C           *IN89     IFEQ '0'
     C*
     C** Do not process total records for business group zero.
     C*
     C           KRTYP     IFEQ 'C'
     C           NQRSEQ    ORNE 3
     C           NQGPID    ORNE 0
     C/COPY WNCPYSRC,LER475C007
     C*
     C                     EXSR GROUP
     C/COPY WNCPYSRC,LER475C008
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C** Calculate loan totals if not already done.
     C*
     C           SAVSEQ    IFEQ 3
     C                     MOVELMSG,8     NARR
     C                     EXSR LONTOT
     C                     END
     C*
     C** Calculate Retail Accounts totals if not already done.            BH3464
     C*                                                                   BH3464
     C           SAVSEQ    IFEQ 4                                         BH3464
     C                     MOVELMSG,9     NARR                            BH3464
     C                     EXSR RETOT                                     BH3464
     C                     END                                            BH3464
     C           SAVSEQ    IFEQ 5                                         BH3464
     C                     MOVELMSG,10    NARR                            BH3464
     C                     EXSR RETOT                                     BH3464
     C                     END                                            BH3464
     C*                                                                   BH3464
     C** Zeroise work fields.
     C*
     C                     EXSR ZEROS
     C*                                                                   156777
     C** Clear detail subfiles count irrespective of whether this         156777
     C** a customer record                                                156777
     C*                                                                   156777
     C                     Z-ADD0         RDYTD                           156777
     C                     Z-ADD0         RDMTD                           156777
     C*
     C** Build detail subfiles, only if customer entered.
     C*
     C           KRTYP     IFEQ 'C'
     C*
     C                     MOVE 'D'       T2
     C*
     C** Set lower limits on detail file.
     C*
     C           LF0KEY    SETLLLENQLF2
     C*
     C** Read all records.
     C*
     C                     MOVE '0'       *IN89
     C                     Z-ADD0         RDYTD
     C                     Z-ADD0         RDMTD
     C*
     C           *IN89     DOWEQ'0'
     C*
     C           LF0KEY    READELENQLF2                  89
     C*
     C** Write records to subfile, totalling for loans/facilities.
     C*
     C           *IN89     IFEQ '0'
     C/COPY WNCPYSRC,LER475C009
     C                     EXSR DETAIL
     C/COPY WNCPYSRC,LER475C010
     C                     END
     C*
     C                     END
     C*
     C** Calculate loan & facility totals if not already done.
     C*
     C********** SAVFCN    CASNE0         FACTOT                                              CSD027
     C           SAVFCN    CASNE*BLANKS   FACTOT                                              CSD027
     C                     END
     C*
     C                     END
     C*
     C** Only set up the default if there is no value already             BH3379
     C*                                                                   BH3379
     C           T1        IFEQ *BLANKS                                   BH3379
     C                     MOVE 'M'       T1                              BH3379
     C***********          MOVE 'MG'      TYPE                            BH3379
     C                     END                                            BH3379
     C           T1        IFEQ *BLANKS                                   BH3379
     C                     MOVE 'G'       T2                              BH3379
     C                     ELSE                                           BH3379
     C                     MOVE SAVT2     T2                              BH3379
     C                     END                                            BH3379
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  DSPSFL --- Subroutine to display subfiles.                   *
      *                                                               *
      *  CALLED FROM: Main processing, VALSR                          *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           DSPSFL    BEGSR
     C*
     C** Change all the output conditioning indicators to zero.
     C*
     C                     MOVEA'0000'    *IN,71
     C*
     C** Blank out prompt fields for display if no errors.
     C*
     C           MSGID     IFEQ *BLANKS
     C/COPY WNCPYSRC,LER475C011
     C                     MOVE *BLANKS   CNUM
     C                     MOVE *BLANKS   ACOF
     C                     MOVE *BLANKS   DEPT
     C                     MOVE *BLANKS   ATOT
     C                     MOVE *BLANKS   DTOT
     C                     MOVE *BLANKS   BTOT
     C                     END
     C*
     C** Set indicators and write formats.
     C*
     C                     MOVEA'000000'  *IN,01
     C           T2        IFEQ 'G'
     C                     MOVEA'10'      *IN,26
     C           KRTYP     IFEQ 'C'
     C                     MOVEA'10'      *IN,22
     C                     ELSE
     C                     MOVEA'00'      *IN,22
     C                     END
     C*
     C           KATOT     IFEQ 'Y'
     C           KDTOT     OREQ 'Y'
     C           KBTOT     OREQ 'Y'
     C                     MOVE '0'       *IN24
     C                     ELSE
     C                     MOVE '1'       *IN24
     C                     END
     C*
     C                     ELSE
     C                     MOVEA'010'     *IN,22
     C                     MOVEA'01'      *IN,26
     C                     END
     C*
     C                     WRITELER475CM
     C*
     C** Month to date subfile.
     C*
     C           T1        IFEQ 'M'
     C                     MOVEA'10'      *IN,20
     C                     MOVE MDAT      FRDT
     C                     Z-ADDMDAYS     DAYS
     C*
     C** Group records.
     C*
     C           T2        IFEQ 'G'
     C                     MOVE '1'       *IN30
     C*
     C** Check whether any details have been processed and condition
     C** the output of the display file accordingly.
     C*
     C           RGMTD     IFNE 0
     C                     MOVE '1'       *IN71
     C                     ELSE
     C                     MOVE '0'       *IN71
     C                     END
     C                     WRITELER475D1
     C                     WRITELER475C1
     C                     ELSE
     C*
     C** Detail records.
     C*
     C                     MOVE '1'       *IN34
     C*
     C** Check whether any details have been processed and condition
     C** the output of the display file accordingly.
     C*
     C           RDMTD     IFNE 0
     C                     MOVE '1'       *IN72
     C                     ELSE
     C                     MOVE '0'       *IN72
     C                     END
     C                     WRITELER475D1
     C                     WRITELER475C3
     C                     END
     C*
     C** Year to date subfile.
     C*
     C                     ELSE
     C                     MOVEA'01'      *IN,20
     C                     MOVE YDAT      FRDT
     C                     Z-ADDYDAYS     DAYS
     C                     MOVE PDAT      PDAT1                           066382
     C           PDM       IFEQ '31DEC'                                   066382
     C           FDM       IFEQ '01JAN'                                   066382
     C           FDM       OREQ ' 1JAN'                                   066382
     C                     Z-ADD365       DAYS                            066382
     C                     MOVE PYY       FYY                             066382
     C                     END                                            066382
     C                     END                                            066382
     C*
     C** Group records.
     C*
     C           T2        IFEQ 'G'
     C                     MOVE '1'       *IN32
     C*
     C** Check whether any details have been processed and condition
     C** the output of the display file accordingly.
     C*
     C           RGYTD     IFNE 0
     C                     MOVE '1'       *IN73
     C                     ELSE
     C                     MOVE '0'       *IN73
     C                     END
     C                     WRITELER475D1
     C                     WRITELER475C2
     C                     ELSE
     C*
     C** Detail records.
     C*
     C                     MOVE '1'       *IN36
     C*
     C** Check whether any details have been processed and condition
     C** the output of the display file accordingly.
     C*
     C           RDYTD     IFNE 0
     C                     MOVE '1'       *IN74
     C                     ELSE
     C                     MOVE '0'       *IN74
     C                     END
     C                     WRITELER475D1
     C                     WRITELER475C4
     C                     END
     C*
     C                     END
     C*
     C** Output no details to report format when the subfiles are empty.
     C*
     C           *IN71     IFEQ '0'
     C           *IN72     ANDEQ'0'
     C           *IN73     ANDEQ'0'
     C           *IN74     ANDEQ'0'
     C                     WRITELER475ND
     C                     END
     C                     WRITELER475D2
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  DETAIL --- Process detail & customer extract records.        *
      *                                                               *
      *  CALLED FROM: BLDSFL                                          *
      *  CALLS: FACTOT, BLKLIN, FACNAM, LONDET, MOVDTA                *
      *                                                               *
      *****************************************************************
     C*
     C           DETAIL    BEGSR
     C*
     C                     MOVE *BLANKS   NARR
     C                     MOVE '0'       *IN70
     C*
     C** Output loan & facility totals if facility number changed.
     C*
     C           FCN       IFNE SAVFCN
     C********** SAVFCN    ANDNE0                                                             CSD027
     C           SAVFCN    ANDNE*BLANKS                                                       CSD027
     C                     EXSR FACTOT
     C*                                                                   117167
     C** Check first if facility occupied a whole subfile page before     117167
     C** writing blank lines.                                             117167
     C*                                                                   117167
     C           RDMTD     IFLT 6                                         117167
     C                     EXSR BLKLIN
     C                     ELSE                                           117167
     C           RDMTD     IFGT 6                                         117167
     C           RDMTD     DIV  6         RQUOT   62                      117167
     C                     MOVE RQUOT     RTMP    2                       117167
     C                     MOVE RTMP      RWRK    22                      117167
     C           RWRK      IFNE 0                                         117167
     C                     EXSR BLKLIN                                    117167
     C                     END                                            117167
     C                     END                                            117167
     C                     END                                            117167
     C                     MOVE 'Y'       WCHG    1                       163668
     C                     END
     C*
     C** Set up fields for report dependant on extract record read.
     C*
     C***********          Z-ADDFCN       SAVFCN  50                      163668
     C**********           Z-ADDFCN       SAVFCN 110                                   163668 CSD027
     C                     MOVE FCN       SAVFCN 11                                           CSD027
     C*
     C** Facility detail records.
     C*
     C           NQRSEQ    IFEQ 1
     C           NQRTYP    ANDEQ'F'
     C                     EXSR FACNAM
     C                     EXSR LONDET
      *                                                                   161257
     C**********           Z-ADD*ZERO     MLNR                                         161257 CLE148
     C                     MOVEL*BLANKS   MLNR                                                CLE148
      *                                                                   161257
     C                     END
     C*
     C** Loan detail record.
     C** Only print details if loan still active.
     C*
     C           NQRSEQ    IFEQ 1
     C           NQRTYP    ANDEQ'L'
     C                     EXSR LONDET
     C           *IN70     IFEQ '0'
     C                     MOVE NQLCUS    LCUS
     C                     MOVE NQLNRF    LNRF
     C                     MOVE NQLTYP    LTYP
     C                     MOVE NQSUTP    SUTP
     C                     MOVE NQCLAS    CLAS                                                CLE042
     C                     MOVELLNAME     NARR
     C                     END
     C                     END
     C*
     C** Retail customer record.
     C*
     C           NQRSEQ    IFEQ 4
     C                     MOVELMSG,9     NARR
     C                     END
     C           NQRSEQ    IFEQ 5
     C                     MOVELMSG,10    NARR
     C                     END
     C*
     C** General Ledger customer record.
     C*
     C           NQRSEQ    IFEQ 6
     C           NQACCY    IFEQ *BLANKS                                   ALIEN1
     C                     MOVELMSG,11    NARR
     C                     ELSE                                           ALIEN1
     C                     MOVE *BLANKS   NARR                            ALIEN1
     C                     MOVELFEEAC     NARR                            ALIEN1
     C                     END                                            ALIEN1
     C                     END
     C*
     C** N.B. Dealing customer record narrative handled in MOVDTA.
     C*
     C** Do not print matured loans.
     C*
     C           *IN70     IFEQ '0'
     C                     EXSR MOVDTA
      *                                                                   163668
      ** Get all participant facilities related to the primary facility   163668
      *                                                                   163668
     C           WPRIM     IFEQ 'Y'                                       163668
     C           WCHG      ANDEQ'Y'                                       163668
     C           NQRTYP    ANDEQ'F'                                       163668
     C           NQRSEQ    ANDEQ1                                         163668
      *                                                                   163668
     C                     MOVE NQFACL    WCUST   6                       163668
     C                     CALL 'AOCUSTR0'                                163668
     C                     PARM *BLANKS   PRTCD                           163668
     C                     PARM '*KEY'    POPTN                           163668
     C                     PARM WCUST     PCUST                           163668
     C                     PARM           PKYST                           163668
     C           SDCUST    PARM SDCUST    DSSDY                           163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVEL*BLANKS   SMAVV                           163668
     C                     MOVEL*BLANKS   SYAVV                           163668
     C                     MOVELBBCRNM    NARR                            163668
     C                     MOVELBBCRTN    SMAVV                           163668
     C                     MOVELBBCRTN    SYAVV                           163668
     C                     Z-ADD0         MFEE                            163668
     C                     Z-ADD0         MMGN                            163668
     C                     Z-ADD0         MAYR                            163668
     C                     Z-ADD0         MAMR                            163668
     C                     Z-ADD0         YFEE                            163668
     C                     Z-ADD0         YMGN                            163668
     C                     Z-ADD0         YAYR                            163668
     C                     Z-ADD0         YAMR                            163668
     C           T2        IFEQ 'G'                                       163668
     C                     ADD  1         RGMTD                           163668
     C                     ADD  1         RGYTD                           163668
     C                     WRITELER475S1                                  163668
     C                     WRITELER475S2                                  163668
     C                     ELSE                                           163668
     C                     ADD  1         RDMTD                           163668
     C                     ADD  1         RDYTD                           163668
     C                     WRITELER475S3                                  163668
     C                     WRITELER475S4                                  163668
     C                     ENDIF                                          163668
     C           K#LTL2    SETLLLEFCLTL2                                  163668
     C           K#LTL2    READELEFCLTL2                 07               163668
     C           *IN07     DOWEQ'0'                                       163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVEL*BLANKS   SMAVV                           163668
     C                     MOVEL*BLANKS   SYAVV                           163668
     C**********           Z-ADDFCCNUM    KCUST                                        163668 CSD027
     C                     MOVE FCCNUM    KCUST                                               CSD027
     C                     Z-ADDFACT      KFTYP                           163668
     C                     Z-ADDFCNO      KFSEQ                           163668
     C           LF3KEY    CHAINLENQLF3              08                   163668
     C           *IN08     IFEQ '0'                                       163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVELFCCNUM    WFCTY  13                       163668
     C                     MOVE FACT      WFACT   4                       163668
     C                     MOVEL'/'       WFSEQ   3                       163668
     C                     MOVE FCNO      WFSEQ                           163668
     C                     MOVELWFACT     WFTYP   7                       163668
     C                     MOVE WFSEQ     WFTYP                           163668
     C                     MOVE WFTYP     WFCTY                           163668
     C                     MOVELWFCTY     NARR                            163668
     C           NQMAV2    IFNE 0                                         163668
     C                     Z-SUBNQMAV2    ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SMAVV                           163668
     C                     ENDIF                                          163668
     C           NQMFE2    DIV  100       MFEE      H                     163668
     C                     Z-SUBMFEE      MFEE                            163668
     C                     Z-SUBNQMMG2    MMGN                            163668
     C                     Z-SUBNQMAY2    MAYR                            163668
     C           NQYAV2    IFNE 0                                         163668
     C                     Z-SUBNQYAV2    ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SYAVV                           163668
     C                     ENDIF                                          163668
     C           NQYFE2    DIV  100       YFEE      H                     163668
     C                     Z-SUBYFEE      YFEE                            163668
     C                     Z-SUBNQYMG2    YMGN                            163668
     C                     Z-SUBNQYAY2    YAYR                            163668
      *                                                                   163668
      ** Write to subfile.                                                163668
      *                                                                   163668
     C           T2        IFEQ 'G'                                       163668
     C                     ADD  1         RGMTD                           163668
     C                     ADD  1         RGYTD                           163668
     C                     WRITELER475S1                                  163668
     C                     WRITELER475S2                                  163668
     C                     ELSE                                           163668
     C                     ADD  1         RDMTD                           163668
     C                     ADD  1         RDYTD                           163668
     C                     WRITELER475S3                                  163668
     C                     WRITELER475S4                                  163668
     C                     ENDIF                                          163668
     C                     ENDIF                                          163668
     C           K#LTL2    READELEFCLTL2                 07               163668
     C                     ENDDO                                          163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVEL*BLANKS   SMAVV                           163668
     C                     MOVEL*BLANKS   SYAVV                           163668
     C                     ENDIF                                          163668
      *                                                                   163668
     C                     MOVE 'N'       WCHG    1                       163668
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  GROUP --- Subroutine to process group extract records.       *
      *                                                               *
      *  CALLED FROM: BLDSFL                                          *
      *  CALLS: LONTOT, BLKLIN, FACNAM, LONDET, MOVDTA                *
      *                                                               *
      *****************************************************************
     C*
     C           GROUP     BEGSR
     C*
     C                     MOVE *BLANKS   NARR
     C                     MOVE *BLANKS   SMAVV                           163668
     C                     MOVE *BLANKS   SYAVV                           163668
     C*
     C** Output loan group totals if last loan group processed.
     C*
     C           SAVSEQ    IFEQ 3
     C           NQRSEQ    ANDNE3
     C                     MOVELMSG,8     NARR
     C                     EXSR LONTOT
     C                     EXSR BLKLIN
     C                     END
     C*
     C** Output Retail Accounts totals if last Retail Account processed   BH3464
     C*                                                                   BH3464
     C           SAVSEQ    IFEQ 4                                         BH3464
     C           NQRSEQ    ANDNE4                                         BH3464
     C                     MOVELMSG,9     NARR                            BH3464
     C                     EXSR RETOT                                     BH3464
     C                     END                                            BH3464
     C           SAVSEQ    IFEQ 5                                         BH3464
     C           NQRSEQ    ANDNE5                                         BH3464
     C                     MOVELMSG,10    NARR                            BH3464
     C                     EXSR RETOT                                     BH3464
     C                     END                                            BH3464
     C*                                                                   BH3464
     C** Set up fields for report dependant on extract record read.
     C*
     C                     Z-ADDNQRSEQ    SAVSEQ  20
     C*
     C** Facility detail/customer records.
     C*
     C           NQRSEQ    CASEQ1         FACNAM
     C                     END
      *                                                                   148861
     C                     MOVE 'N'       WPRTR                           163668
     C                     MOVE 'N'       WPRIM                           163668
     C           NQRSEQ    IFEQ 1                                         148861
     C           NQRTYP    IFEQ 'F'                                       148861
      *                                                                   161257
     C**********           Z-ADD*ZERO     MLNR                                         161257 CLE148
     C                     MOVEL*BLANKS   MLNR                                                CLE148
      *                                                                   148861
      ** Access facilities file to see if facility is a Credit Agreement  148861
      *                                                                   148861
     C***********          MOVELNQCNUM    K#FCUS                   148861 163668
     C                     MOVELNQFACL    K#FCUS                          163668
     C                     MOVELNQFTYP    K#FTYP                          148861
     C                     MOVELNQFSEQ    K#FSEQ                          148861
     C                     MOVE 'A'       K#RTYP                          148861
     C           K#FCTY    CHAINFCLTY1               54                   148861
      *                                                                   148861
      ** If record is a credit agreement do not display facitility amount 148861
      *                                                                   148861
     C           TRCA      IFEQ 'CA'                                      148861
     C                     Z-ADD0         NQMAVV                          148861
     C                     Z-ADD0         NQYAVV                          148861
     C                     ENDIF                                          148861
      *                                                                   161257
      ** If participant facility, subtract the participant values         161257
      ** at group level as well.                                          161257
      *                                                                   161257
     C           PRTR      IFEQ 'P'                                       161257
     C           PRTR      OREQ 'S'                                                           CLE106
     C           PRTR      OREQ 'R'                                                           CLE106
     C                     Z-SUBNQMFEE    NQMFEE                          161257
     C                     Z-SUBNQYFEE    NQYFEE                          161257
     C                     Z-SUBNQMAVV    NQMAVV                          161257
     C                     Z-SUBNQYAVV    NQYAVV                          161257
     C                     Z-SUBNQMAYR    NQMAYR                          161257
     C                     Z-SUBNQYAYR    NQYAYR                          161257
     C                     Z-SUBNQMAMR    NQMAMR                          161257
     C                     Z-SUBNQYAMR    NQYAMR                          161257
     C                     MOVE 'Y'       WPRTR                           163668
     C                     ENDIF                                          161257
     C                     ENDIF                                          148861
     C                     ENDIF                                          148861
      *                                                                   163668
     C                     MOVE 'N'       WFEE                            163668
     C           PRTR      IFEQ 'A'                                       163668
     C           PRTR      OREQ ' '                                       163668
     C********** ANUM      ANDNE0                                                      163668 CSD027
     C           ANUM      ANDNE*BLANKS                                                       CSD027
     C                     MOVE 'Y'       WFEE    1                       163668
     C                     Z-ADDNQMFEE    WMFEE  150                      163668
     C                     Z-ADDNQYFEE    WYFEE  150                      163668
     C                     ENDIF                                          163668
      *                                                                   148861
     C                     MOVELNQBRCA    K#BRCA                          161257
     C***********          MOVELNQCNUM    K#PMFC                   161257 163668
     C                     MOVELNQFACL    K#PMFC                          163668
     C                     MOVELNQFTYP    K#PMFT                          161257
     C                     MOVELNQFSEQ    K#PMFN                          161257
     C           K#LTL2    SETLLLEFCLTL2                                  161257
     C           K#LTL2    READELEFCLTL2                 51               161257
      *                                                                   161257
     C           *IN51     IFEQ '0'                                       163668
     C           *IN51     OREQ '1'                                       163668
     C           PRTR      ANDEQ'A'                                       163668
     C           *IN51     OREQ '1'                                       163668
     C           PRTR      ANDEQ' '                                       163668
     C********** ANUM      ANDNE0                                                      163668 CSD027
     C           ANUM      ANDNE*BLANKS                                                       CSD027
     C                     MOVEL'Y'       WPRIM                           163668
     C                     ENDIF                                          163668
      *                                                                   163668
     C           *IN51     DOWEQ*OFF                                      161257
      *                                                                   161257
     C           PRTR      IFEQ 'P'                                       161257
     C           PRTR      OREQ 'I'                                       161257
     C           PRTR      OREQ 'S'                                                           CLE106
     C           PRTR      OREQ 'R'                                                           CLE106
     C**********           Z-ADDFCCNUM    KCUST                                        161257 CSD027
     C                     MOVE FCCNUM    KCUST                                               CSD027
     C                     Z-ADDFACT      KFTYP                           161257
     C                     Z-ADDFCNO      KFSEQ                           161257
     C           LF3KEY    CHAINLENQLF3              52                   161257
      *                                                                   161257
     C           *IN52     IFEQ *OFF                                      161257
     C                     SUB  NQMMG2    FMMG                            161257
     C                     SUB  NQYMG2    FYMG                            161257
     C                     SUB  NQMFE2    FMFE                            161257
     C                     SUB  NQYFE2    FYFE                            161257
     C                     SUB  NQMMG2    NQMMGN                          161257
     C                     SUB  NQYMG2    NQYMGN                          161257
     C                     SUB  NQMFE2    NQMFEE                          161257
     C                     SUB  NQYFE2    NQYFEE                          161257
     C                     ENDIF                                          161257
      *                                                                   161257
     C                     ENDIF                                          161257
      *                                                                   161257
     C           K#LTL2    READELEFCLTL2                 51               161257
     C                     ENDDO                                          161257
      *                                                                   161257
     C           NQRSEQ    IFEQ 2
     C                     MOVELMSG,5     NARR
     C                     END
     C*
     C** Loan customer record.
     C*
     C           NQRSEQ    IFEQ 3
     C                     EXSR LONDET
     C                     MOVELNQGPNA    NARR
     C                     END
     C*
     C** Retail customer record.
     C*
     C           NQRSEQ    IFEQ 4
     C                     MOVELMSG,9     NARR
     C                     EXSR REDET                                     BH3464
     C                     END
     C           NQRSEQ    IFEQ 5
     C                     MOVELMSG,10    NARR
     C                     EXSR REDET                                     BH3464
     C                     END
     C*
     C** General Ledger customer record.
     C*
     C           NQRSEQ    IFEQ 6
     C           NQACCY    IFEQ *BLANKS                                   ALIEN1
     C                     MOVELMSG,11    NARR
     C                     ELSE                                           ALIEN1
     C                     MOVE *BLANKS   NARR                            ALIEN1
     C                     MOVELFEEAC     NARR                            ALIEN1
     C                     END                                            ALIEN1
     C                     END
     C*
     C** N.B. Dealing customer record narrative handled in MOVDTA.
     C*
     C***  Retail Accounts output in SR/RETOT                             BH3464
     C*                                                                   BH3464
     C           NQRSEQ    IFNE 4                                         BH3464
     C           NQRSEQ    ANDNE5                                         BH3464
     C                     EXSR MOVDTA
     C           WPRIM     IFEQ 'Y'                                       163668
     C           NQRTYP    ANDEQ'F'                                       163668
     C           NQRSEQ    ANDEQ1                                         163668
      *                                                                   163668
     C                     MOVE NQFACL    WCUST   6                       163668
     C                     CALL 'AOCUSTR0'                                163668
     C                     PARM *BLANKS   PRTCD                           163668
     C                     PARM '*KEY'    POPTN                           163668
     C                     PARM WCUST     PCUST                           163668
     C                     PARM           PKYST                           163668
     C           SDCUST    PARM SDCUST    DSSDY                           163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVEL*BLANKS   SMAVV                           163668
     C                     MOVEL*BLANKS   SYAVV                           163668
     C                     MOVELBBCRNM    NARR                            163668
     C                     MOVELBBCRTN    SMAVV                           163668
     C                     MOVELBBCRTN    SYAVV                           163668
     C                     Z-ADD0         MFEE                            163668
     C                     Z-ADD0         MMGN                            163668
     C                     Z-ADD0         MAYR                            163668
     C                     Z-ADD0         MAMR                            163668
     C                     Z-ADD0         YFEE                            163668
     C                     Z-ADD0         YMGN                            163668
     C                     Z-ADD0         YAYR                            163668
     C                     Z-ADD0         YAMR                            163668
     C           T2        IFEQ 'G'                                       163668
     C                     ADD  1         RGMTD                           163668
     C                     ADD  1         RGYTD                           163668
     C                     WRITELER475S1                                  163668
     C                     WRITELER475S2                                  163668
     C                     ELSE                                           163668
     C                     ADD  1         RDMTD                           163668
     C                     ADD  1         RDYTD                           163668
     C                     WRITELER475S3                                  163668
     C                     WRITELER475S4                                  163668
     C                     ENDIF                                          163668
     C           K#LTL2    SETLLLEFCLTL2                                  163668
     C           K#LTL2    READELEFCLTL2                 07               163668
     C           *IN07     DOWEQ'0'                                       163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVEL*BLANKS   SMAVV                           163668
     C                     MOVEL*BLANKS   SYAVV                           163668
     C**********           Z-ADDFCCNUM    KCUST                                        163668 CSD027
     C                     MOVE FCCNUM    KCUST                                               CSD027
     C                     Z-ADDFACT      KFTYP                           163668
     C                     Z-ADDFCNO      KFSEQ                           163668
     C           LF3KEY    CHAINLENQLF3              08                   163668
     C           *IN08     IFEQ '0'                                       163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVELFCCNUM    WFCTY  13                       163668
     C                     MOVE FACT      WFACT   4                       163668
     C                     MOVEL'/'       WFSEQ   3                       163668
     C                     MOVE FCNO      WFSEQ                           163668
     C                     MOVELWFACT     WFTYP   7                       163668
     C                     MOVE WFSEQ     WFTYP                           163668
     C                     MOVE WFTYP     WFCTY                           163668
     C                     MOVELWFCTY     NARR                            163668
     C           NQMAV2    IFNE 0                                         163668
     C                     Z-SUBNQMAV2    ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SMAVV                           163668
     C                     ENDIF                                          163668
     C           NQMFE2    DIV  100       MFEE      H                     163668
     C                     Z-SUBMFEE      MFEE                            163668
     C                     Z-SUBNQMMG2    MMGN                            163668
     C                     Z-SUBNQMAY2    MAYR                            163668
     C           NQYAV2    IFNE 0                                         163668
     C                     Z-SUBNQYAV2    ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SYAVV                           163668
     C                     ENDIF                                          163668
     C           NQYFE2    DIV  100       YFEE      H                     163668
     C                     Z-SUBYFEE      YFEE                            163668
     C                     Z-SUBNQYMG2    YMGN                            163668
     C                     Z-SUBNQYAY2    YAYR                            163668
      *                                                                   163668
      ** Write to subfile.                                                163668
      *                                                                   163668
     C           T2        IFEQ 'G'                                       163668
     C                     ADD  1         RGMTD                           163668
     C                     ADD  1         RGYTD                           163668
     C                     WRITELER475S1                                  163668
     C                     WRITELER475S2                                  163668
     C                     ELSE                                           163668
     C                     ADD  1         RDMTD                           163668
     C                     ADD  1         RDYTD                           163668
     C                     WRITELER475S3                                  163668
     C                     WRITELER475S4                                  163668
     C                     ENDIF                                          163668
     C                     ENDIF                                          163668
     C           K#LTL2    READELEFCLTL2                 07               163668
     C                     ENDDO                                          163668
     C                     MOVEL*BLANKS   NARR                            163668
     C                     MOVEL*BLANKS   SMAVV                           163668
     C                     MOVEL*BLANKS   SYAVV                           163668
     C                     ENDIF                                          163668
     C                     END                                            BH3464
     C*
     C** If facility total just written, write blank line.
     C*
     C           NQRSEQ    CASEQ2         BLKLIN
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  LONDET --- Subroutine to accumulate loan & facility totals.  *
      *                                                               *
      *  CALLED FROM: DETAIL, GROUP                                   *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           LONDET    BEGSR
     C*
     C** If facility, save fee & margin amounts for later.
     C*
     C                     MOVE 'N'       WPRTR   1                       163668
     C                     MOVE 'N'       WPRIM   1                       163668
     C           NQRTYP    IFEQ 'F'
      *                                                                   148861
      ** Access facilities file to see if facility is a Credit Agreement  148861
      *                                                                   148861
     C***********          MOVELNQCNUM    K#FCUS                   148861 163668
     C                     MOVELNQFACL    K#FCUS                          163668
     C                     MOVELNQFTYP    K#FTYP                          148861
     C                     MOVELNQFSEQ    K#FSEQ                          148861
     C                     MOVE 'A'       K#RTYP                          148861
     C           K#FCTY    CHAINFCLTY1               54                   148861
      *                                                                   148861
      ** If record is a credit agreement do not display facitility amount 148861
      *                                                                   148861
     C           TRCA      IFEQ 'CA'                                      148861
     C                     Z-ADD0         NQMAVV                          148861
     C                     Z-ADD0         NQYAVV                          148861
     C                     ENDIF                                          148861
      *                                                                   148861
     C           PRTR      IFEQ 'P'                                       156043
     C           PRTR      OREQ 'S'                                                           CLE106
     C           PRTR      OREQ 'R'                                                           CLE106
     C***********PRTR      OREQ 'I'                                 156043161257
     C                     Z-SUBNQMFEE    NQMFEE                          156043
     C                     Z-SUBNQYFEE    NQYFEE                          156043
     C                     Z-SUBNQMAVV    NQMAVV                          161257
     C                     Z-SUBNQYAVV    NQYAVV                          161257
     C                     Z-SUBNQMAYR    NQMAYR                          161257
     C                     Z-SUBNQYAYR    NQYAYR                          161257
     C                     Z-SUBNQMAMR    NQMAMR                          161257
     C                     Z-SUBNQYAMR    NQYAMR                          161257
     C                     MOVE 'Y'       WPRTR                           163668
     C                     ENDIF                                          156043
      *                                                                   163668
     C                     MOVE 'N'       WFEE                            163668
     C           PRTR      IFEQ 'A'                                       163668
     C           PRTR      OREQ ' '                                       163668
     C********** ANUM      ANDNE0                                                      163668 CSD027
     C           ANUM      ANDNE*BLANKS                                                       CSD027
     C                     MOVE 'Y'       WFEE    1                       163668
     C                     Z-ADDNQMFEE    WMFEE  150                      163668
     C                     Z-ADDNQYFEE    WYFEE  150                      163668
     C                     ENDIF                                          163668
      *                                                                   156043
     C                     Z-ADDNQMMGN    FMMG
     C                     Z-ADDNQYMGN    FYMG
     C                     Z-ADDNQMFEE    FMFE
     C                     Z-ADDNQYFEE    FYFE
      *                                                                   141462
     C                     MOVELNQBRCA    K#BRCA                          141462
     C***********          MOVELNQCNUM    K#PMFC                   141462 163668
     C                     MOVELNQFACL    K#PMFC                          163668
     C                     MOVELNQFTYP    K#PMFT                          141462
     C                     MOVELNQFSEQ    K#PMFN                          141462
     C           K#LTL2    SETLLLEFCLTL2                                  141462
     C           K#LTL2    READELEFCLTL2                 51               141462
      *                                                                   141462
     C           *IN51     IFEQ '0'                                       163668
     C           *IN51     OREQ '1'                                       163668
     C           PRTR      ANDEQ'A'                                       163668
     C           *IN51     OREQ '1'                                       163668
     C           PRTR      ANDEQ' '                                       163668
     C********** ANUM      ANDNE0                                                      163668 CSD027
     C           ANUM      ANDNE*BLANKS                                                       CSD027
     C                     MOVEL'Y'       WPRIM                           163668
     C                     ENDIF                                          163668
      *                                                                   163668
     C           *IN51     DOWEQ*OFF                                      141462
      *                                                                   141462
     C           PRTR      IFEQ 'P'                                       141462
     C           PRTR      OREQ 'I'                                       156043
     C           PRTR      OREQ 'S'                                                           CLE106
     C           PRTR      OREQ 'R'                                                           CLE106
     C**********           Z-ADDFCCNUM    KCUST                                        141462 CSD027
     C                     MOVE FCCNUM    KCUST                                               CSD027
     C                     Z-ADDFACT      KFTYP                           141462
     C                     Z-ADDFCNO      KFSEQ                           141462
     C           LF3KEY    CHAINLENQLF3              52                   141462
      *                                                                   141462
     C           *IN52     IFEQ *OFF                                      141462
     C                     SUB  NQMMG2    FMMG                            141462
     C                     SUB  NQYMG2    FYMG                            141462
     C                     SUB  NQMFE2    FMFE                            141462
     C                     SUB  NQYFE2    FYFE                            141462
     C                     SUB  NQMMG2    NQMMGN                          141462
     C                     SUB  NQYMG2    NQYMGN                          141462
     C                     SUB  NQMFE2    NQMFEE                          141462
     C                     SUB  NQYFE2    NQYFEE                          141462
     C                     ENDIF                                          141462
      *                                                                   141462
     C                     ENDIF                                          141462
      *                                                                   141462
     C           K#LTL2    READELEFCLTL2                 51               141462
     C                     ENDDO                                          141462
     C*
     C** If loan & detail build, accumulate loan amounts for totals.
     C*
     C                     ELSE
     C*
     C           T2        IFEQ 'D'
     C*
     C                     MOVE 'Y'       LNRD
     C*
     C** If loan previously matured, accumulate separate totals.
     C*
     C           NQMAVV    IFEQ 0
     C           NQMFEE    ANDEQ0
     C           NQMMGN    ANDEQ0
     C                     MOVE 'Y'       MATD
     C                     MOVE '1'       *IN70
     C                     ELSE
     C                     MOVE '0'       *IN70
     C                     END
     C*
     C                     ELSE
     C                     MOVE '0'       *IN70
     C                     END
     C*
     C** Move days into arrays.
     C*
     C                     MOVE AMDAY     MDAY
     C                     MOVE AYDAY     YDAY
     C*
     C** Set up loan totals for report.
     C*
     C** Set up day arrays, skip if all zero - month to date.
     C*
     C**********           XFOOTMDAY      MTOT    20                      157376
     C           MTOT      IFGT 0
     C*
     C                     Z-ADD1         X       20
     C           X         DOWLE31
     C           MDAY,X    IFEQ 1
     C                     Z-ADD1         TMDY,X
     C           *IN70     IFEQ '1'
     C                     Z-ADD1         MMDY,X
     C                     END
     C                     END
     C                     ADD  1         X
     C                     END
     C*
     C                     END
     C*
     C** Year to date.
     C*
     C**********           XFOOTYDAY      YTOT    30                      157376
     C           YTOT      IFGT 0
     C*
     C                     Z-ADD1         Y       30
     C           Y         DOWLE366
     C           YDAY,Y    IFEQ 1
     C                     Z-ADD1         TYDY,Y
     C           *IN70     IFEQ '1'
     C                     Z-ADD1         MYDY,Y
     C                     END
     C                     END
     C                     ADD  1         Y
     C                     END
     C*
     C                     END
      *                                                                   141462
     C           NQLNRF    CHAINCLOANCLF             53                   141462
     C           *IN53     IFEQ *ON                                       141462
     C           NQLNRF    CHAINMCLONCLF             53                   141462
     C                     ENDIF                                          141462
      *                                                                   141462
     C********** MLNR      IFEQ 0                                                      141462 CLE148
     C           MLNR      IFEQ *BLANKS                                                       CLE148
      *                                                                   156043
     C           LPFI      IFEQ 'P'                                       156043
     C           LPFI      OREQ 'S'                                                           CLE106
     C           LPFI      OREQ 'R'                                                           CLE106
     C                     Z-SUBNQMFEE    NQMFEE                          156043
     C                     Z-SUBNQYFEE    NQYFEE                          156043
     C                     ENDIF                                          156043
     C*
     C** Add aggregate, fees & margin in to overall totals.
     C*
     C***********          ADD  NQMAGG    TMAG                            148866
     C***********          ADD  NQYAGG    TYAG                            148866
     C                     ADD  NQMAVV    TMAV                            148866
     C                     ADD  NQYAVV    TYAV                            148866
     C                     ADD  NQMFEE    TMFE
     C                     ADD  NQYFEE    TYFE
     C                     ADD  NQMMGN    TMMG
     C                     ADD  NQYMGN    TYMG
     C*
     C** Add aggregate, fees & margin in to matured totals.
     C*
     C           *IN70     IFEQ '1'
     C***********          ADD  NQMAGG    MMAG                            148866
     C***********          ADD  NQYAGG    MYAG                            148866
     C                     ADD  NQMAVV    MMAV                            148866
     C                     ADD  NQYAVV    MYAV                            148866
     C                     ADD  NQMFEE    MMFE
     C                     ADD  NQYFEE    MYFE
     C                     ADD  NQMMGN    MMMG
     C                     ADD  NQYMGN    MYMG
     C                     END
     C*
     C                     ELSE                                           148866
     C*                                                                   148866
     C** Substract aggregate, fees & margin in to overall totals.         148866
     C*                                                                   148866
     C                     SUB  NQMAVV    TMAV                            148866
     C                     SUB  NQYAVV    TYAV                            148866
     C                     SUB  NQMFEE    TMFE                            148866
     C                     SUB  NQYFEE    TYFE                            148866
     C                     SUB  NQMMGN    TMMG                            148866
     C                     SUB  NQYMGN    TYMG                            148866
     C*                                                                   148866
     C** Add aggregate, fees & margin in to matured totals.               148866
     C*                                                                   148866
     C           *IN70     IFEQ '1'                                       148866
     C                     SUB  NQMAVV    MMAV                            148866
     C                     SUB  NQYAVV    MYAV                            148866
     C                     SUB  NQMFEE    MMFE                            148866
     C                     SUB  NQYFEE    MYFE                            148866
     C                     SUB  NQMMGN    MMMG                            148866
     C                     SUB  NQYMGN    MYMG                            148866
     C                     END                                            148866
     C*                                                                   148866
     C                     ENDIF                                          141462
     C*                                                                   148866
     C** Calculate Modulus Total for average balance                      148866
     C*                                                                   148866
     C                     ADD  NQMAVV    MODTOT                          158560
     C                     ADD  NQMAVV    YODTOT                          158560
     C           NQMAVV    IFLT 0                                         148866
     C********** MLNR      ORNE 0                                                      148866 CLE148
     C           MLNR      ORNE *BLANKS                                                       CLE148
     C           NQMAVV    MULT -1        WRK15                           148866
     C           NQMAMR    MULT WRK15     WRK154                          148866
     C                     ADD  WRK154    MARCAL                          148866
     C           NQMAVV    MULT -1        WRK15                           148866
     C           NQMAYR    MULT WRK15     WRK154                          148866
     C                     ADD  WRK154    YARCAL                          148866
     C                     ELSE                                           148866
     C***********          ADD  NQMAVV    MODTOT                    148866158560
     C           NQMAMR    MULT NQMAVV    WRK154                          148866
     C                     ADD  WRK154    MARCAL                          148866
     C***********          ADD  NQMAVV    YODTOT                    148866158560
     C           NQMAYR    MULT NQMAVV    WRK154                          148866
     C                     ADD  WRK154    YARCAL                          148866
     C                     ENDIF                                          148866
     C*                                                                   148866
     C*                                                                   148866
     C** Calculate Modulus Total for average balance for year             148866
     C*                                                                   148866
     C                     ADD  NQYAVV    MODTOY                          158560
     C                     ADD  NQYAVV    YODTOY                          158560
     C           NQYAVV    IFLT 0                                         148866
     C********** MLNR      ORNE 0                                                      148866 CLE148
     C           MLNR      ORNE *BLANKS                                                       CLE148
     C           NQYAVV    MULT -1        WRK15                           148866
     C           NQYAMR    MULT WRK15     WRK154                          148866
     C                     ADD  WRK154    MARCAY                          148866
     C           NQYAVV    MULT -1        WRK15                           148866
     C           NQYAYR    MULT WRK15     WRK154                          148866
     C                     ADD  WRK154    YARCAY                          148866
     C                     ELSE                                           148866
     C***********          ADD  NQYAVV    MODTOY                    148866158560
     C           NQYAMR    MULT NQYAVV    WRK154                          148866
     C                     ADD  WRK154    MARCAY                          148866
     C***********          ADD  NQYAVV    YODTOY                    148866158560
     C           NQYAYR    MULT NQYAVV    WRK154                          148866
     C                     ADD  WRK154    YARCAY                          148866
     C                     ENDIF                                          148866
      *                                                                   141462
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  FACTOT --- Subroutine to calculate final totals for facility *
      *                                                               *
      *  CALLED FROM: DETAIL                                          *
      *  CALLS: LONTOT, AVLOAN, ZEROS                                 *
      *                                                               *
      *****************************************************************
     C*
     C           FACTOT    BEGSR
     C*
     C** Calculate loan totals required.
     C*
     C           LNRD      IFEQ 'Y'
     C*
     C** Matured loan totals.
     C*
     C           MATD      IFEQ 'Y'
     C**********           XFOOTMMDY      MTOT                            157376
     C**********           XFOOTMYDY      YTOT                            157376
     C***********          Z-ADDMMAG      ZMAG                            148866
     C***********          Z-ADDMYAG      ZYAG                            148866
     C                     Z-ADDMMAV      ZMAV                            148866
     C                     Z-ADDMYAV      ZYAV                            148866
     C                     Z-ADDMMMG      ZMMG
     C                     Z-ADDMYMG      ZYMG
     C                     Z-ADDMMFE      ZMFE
     C                     Z-ADDMYFE      ZYFE
     C                     MOVELMSG,7     NARR
     C                     EXSR LONTOT
     C                     END
     C*
     C** Overall loan totals.
     C*
     C**********           XFOOTTMDY      MTOT                            157376
     C**********           XFOOTTYDY      YTOT                            157376
     C***********          Z-ADDTMAG      ZMAG                            148866
     C***********          Z-ADDTYAG      ZYAG                            148866
     C                     Z-ADDTMAV      ZMAV                            148866
     C                     Z-ADDTYAV      ZYAV                            148866
     C                     Z-ADDTMMG      ZMMG
     C                     Z-ADDTYMG      ZYMG
     C                     Z-ADDTMFE      ZMFE
     C                     Z-ADDTYFE      ZYFE
     C                     MOVELMSG,8     NARR
     C                     EXSR LONTOT
     C*
     C** Average loan totals.
     C*
     C**********           EXSR AVLOAN                                    157376
     C                     Z-ADD0         ZMMG
     C                     Z-ADD0         ZMFE
     C                     Z-ADD0         ZYMG
     C                     Z-ADD0         ZYFE
     C                     MOVELMSG,21    NARR
     C                     EXSR LONTOT
     C*
     C                     END
     C*
     C** Set up fee & margin total for facility & adjust for decimals.
     C*
     C                     ADD  FMFE      TMFE
     C                     ADD  FYFE      TYFE
     C                     ADD  FMMG      TMMG
     C                     ADD  FYMG      TYMG
     C*
     C           TMFE      DIV  100       MFEE      H
     C           TYFE      DIV  100       YFEE      H
     C           TMMG      DIV  100       MMGN      H
     C           TYMG      DIV  100       YMGN      H
     C*
     C** Write facility totals to subfile.
     C*
     C           WPRTR     IFEQ 'N'                                       163668
     C                     MOVELMSG,6     NARR
     C***********          MOVE SAVFCN    WRK6                            163668
     C                     MOVE SVFSEQ    WRK6                            163668
     C                     MOVELSAVFCN    WRK4
     C                     MOVE '/'       WRK4
     C                     MOVELWRK4      WRK6
     C                     MOVE WRK6      NARR
     C                     ADD  1         RDMTD
     C                     ADD  1         RDYTD
     C***********          Z-ADD0         MAVV                            163668
     C***********          Z-ADD0         YAVV                            163668
     C                     Z-ADD0         MAVV   150                      163668
     C                     Z-ADD0         YAVV   150                      163668
     C                     Z-ADD0         MAMR
     C                     Z-ADD0         YAMR
     C                     Z-ADD0         MAYR
     C                     Z-ADD0         YAYR
     C                     MOVE *BLANKS   SMAVV                           163668
     C                     MOVE *BLANKS   SYAVV                           163668
     C                     WRITELER475S3
     C                     WRITELER475S4
     C                     ENDIF                                          163668
     C                     MOVE ' '       LNRD
     C                     MOVE ' '       MATD
     C*
     C** Zeroise work fields.
     C*
     C                     EXSR ZEROS
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  LONTOT --- Calculate final totals for loan/group.            *
      *                                                               *
      *  CALLED FROM: BLDSFL, GROUP, FACTOT                           *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           LONTOT    BEGSR
     C*
     C** If group totals, set up fields for total calculations.
     C*
     C           T2        IFEQ 'G'
     C**********           XFOOTTMDY      MTOT                            157376
     C**********           XFOOTTYDY      YTOT                            157376
     C***********          Z-ADDTMAG      ZMAG                            148866
     C***********          Z-ADDTYAG      ZYAG                            148866
     C                     Z-ADDTMAV      ZMAV                            148866
     C                     Z-ADDTYAV      ZYAV                            148866
     C                     Z-ADDTMMG      ZMMG
     C                     Z-ADDTYMG      ZYMG
     C                     Z-ADDTMFE      ZMFE
     C                     Z-ADDTYFE      ZYFE
     C                     END
     C*
     C** Calculate month to date average balances.
     C*
     C***********MTOT      IFNE 0                                         148866
     C***********ZMAG      DIV  MTOT      MAVV      H                     148866
     C***********          ELSE                                           148866
     C***********          Z-ADD0         MAVV                            148866
     C***********          END                                            148866
     C                     Z-ADDZMAV      MAVV                            148866
     C*
     C** Calculate year to date average balances.
     C*
     C***********YTOT      IFNE 0                                         148866
     C***********ZYAG      DIV  YTOT      YAVV      H                     148866
     C***********          ELSE                                           148866
     C***********          Z-ADD0         YAVV                            148866
     C***********          END                                            148866
     C                     Z-ADDZYAV      YAVV                            148866
     C*
     C                     MOVE *BLANKS   SMAVV                           163668
     C                     MOVE *BLANKS   SYAVV                           163668
     C           MAVV      IFNE 0                                         163668
     C                     Z-ADDMAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SMAVV                           163668
     C                     ENDIF                                          163668
     C           YAVV      IFNE 0                                         163668
     C                     Z-ADDYAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SYAVV                           163668
     C                     ENDIF                                          163668
     C** Calculate month to date yield & margin rates.
     C*
     C***********ZMAG      IFNE 0                                         148866
     C           MODTOT    IFNE 0                                         148866
     C*
     C***********ZMMG      ADD  ZMFE      WRK15                           148866
     C***********WRK15     DIV  ZMAG      WRK158    H                     148866
     C***********WRK158    MULT CALCB     MAYR                            148866
     C           YARCAL    DIV  YODTOT    MAYR                            148866
     C                     Z-ADD0         YODTOT                          148866
     C                     Z-ADD0         YARCAL                          148866
     C*
     C***********ZMMG      DIV  ZMAG      WRK158    H                     148866
     C***********WRK158    MULT CALCB     MAMR                            148866
     C           MARCAL    DIV  MODTOT    MAMR                            148866
     C                     Z-ADD0         MODTOT                          148866
     C                     Z-ADD0         MARCAL                          148866
     C*
     C                     ELSE
     C                     Z-ADD0         MAYR
     C                     Z-ADD0         MAMR
     C                     END
     C*
     C** Calculate year to date yield & margin rates.
     C*
     C***********ZYAG      IFNE 0                                         148866
     C           MODTOY    IFNE 0                                         148866
     C***********ZYMG      ADD  ZYFE      WRK15                           148866
     C***********WRK15     DIV  ZYAG      WRK158    H                     148866
     C***********WRK158    MULT CALCB     YAYR                            148866
     C           YARCAY    DIV  YODTOY    YAYR                            148866
     C                     Z-ADD0         YODTOY                          148866
     C                     Z-ADD0         YARCAY                          148866
     C*
     C***********ZYMG      DIV  ZYAG      WRK158    H                     148866
     C***********WRK158    MULT CALCB     YAMR                            148866
     C           MARCAY    DIV  MODTOY    YAMR                            148866
     C                     Z-ADD0         MODTOY                          148866
     C                     Z-ADD0         MARCAY                          148866
     C                     ELSE
     C                     Z-ADD0         YAYR
     C                     Z-ADD0         YAMR
     C                     END
     C*
     C** Adjust fees & margins for decimals.
     C*
     C           ZMFE      DIV  100       MFEE      H
     C           ZYFE      DIV  100       YFEE      H
     C           ZMMG      DIV  100       MMGN      H
     C           ZYMG      DIV  100       YMGN      H
     C*
     C** Write loan totals to subfile.
     C*
     C           WPRTR     IFEQ 'N'                                       163668
     C           T2        IFEQ 'G'
     C                     ADD  1         RGMTD
     C                     ADD  1         RGYTD
     C                     WRITELER475S1
     C                     WRITELER475S2
     C                     ELSE
     C                     ADD  1         RDMTD
     C                     ADD  1         RDYTD
     C                     WRITELER475S3
     C                     WRITELER475S4
     C                     END
     C                     ENDIF                                          163668
     C                     Z-ADD0         SAVSEQ
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  MOVDTA --- Subroutine to set up fields in subfiles.          *
      *                                                               *
      *  CALLED FROM: DETAIL, GROUP                                   *
      *  CALLS: BLKLIN                                                *
      *                                                               *
      *****************************************************************
     C*
     C           MOVDTA    BEGSR
     C*
     C** Non-dealing records.
     C*
     C           NQRSEQ    IFNE 7
     C*
     C********** MLNR      IFEQ 0                                                      148866 CLE148
     C           MLNR      IFEQ *BLANKS                                                       CLE148
     C*                                                                   148866
     C                     Z-ADDNQMAVV    MAVV
     C                     Z-ADDNQYAVV    YAVV
     C           NQMFEE    DIV  100       MFEE      H
     C           NQYFEE    DIV  100       YFEE      H
     C           NQMMGN    DIV  100       MMGN      H
     C           NQYMGN    DIV  100       YMGN      H
     C                     Z-ADDNQMAYR    MAYR
     C                     Z-ADDNQYAYR    YAYR
     C                     Z-ADDNQMAMR    MAMR
     C                     Z-ADDNQYAMR    YAMR
     C                     ELSE                                           148866
     C*                                                                   148866
     C                     Z-SUBNQMAVV    MAVV                            148866
     C                     Z-SUBNQYAVV    YAVV                            148866
     C           NQMFEE    DIV  100       MFEE      H                     148866
     C                     Z-SUBMFEE      MFEE                            148866
     C           NQYFEE    DIV  100       YFEE      H                     148866
     C                     Z-SUBYFEE      YFEE                            148866
     C           NQMMGN    DIV  100       MMGN      H                     148866
     C                     Z-SUBMMGN      MMGN                            148866
     C           NQYMGN    DIV  100       YMGN      H                     148866
     C                     Z-SUBYMGN      YMGN                            148866
     C                     Z-SUBNQMAYR    MAYR                            148866
     C                     Z-SUBNQYAYR    YAYR                            148866
     C                     Z-SUBNQMAMR    MAMR                            148866
     C                     Z-SUBNQYAMR    YAMR                            148866
     C*                                                                   148866
     C                     ENDIF                                          148866
      *                                                                   163668
     C                     MOVE *BLANKS   SMAVV                           163668
     C                     MOVE *BLANKS   SYAVV                           163668
     C           MAVV      IFNE 0                                         163668
     C                     Z-ADDMAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SMAVV                           163668
     C                     ENDIF                                          163668
     C           YAVV      IFNE 0                                         163668
     C                     Z-ADDYAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SYAVV                           163668
     C                     ENDIF                                          163668
      *                                                                   163668
     C           WPRTR     IFEQ 'N'                                       163668
     C           WFEE      ANDEQ'Y'                                       163668
     C           NQRTYP    ANDEQ'F'                                       163668
     C           WMFEE     DIV  100       MFEE                            163668
     C           WYFEE     DIV  100       YFEE                            163668
     C                     ENDIF                                          163668
     C*
     C** Write to subfile.
     C*
     C           WPRTR     IFEQ 'N'                                       163668
     C           T2        IFEQ 'G'
     C                     ADD  1         RGMTD
     C                     ADD  1         RGYTD
     C                     WRITELER475S1
     C                     WRITELER475S2
     C                     ELSE
     C                     ADD  1         RDMTD
     C                     ADD  1         RDYTD
     C                     WRITELER475S3
     C                     WRITELER475S4
     C                     END
     C                     ENDIF                                          163668
     C*
     C                     ELSE
     C*
     C** Zeroise fields not used for dealing & write blank line.
     C*
     C                     Z-ADD0         MFEE
     C                     Z-ADD0         YFEE
     C                     Z-ADD0         MMGN
     C                     Z-ADD0         YMGN
     C                     Z-ADD0         MAYR
     C                     Z-ADD0         YAYR
     C                     Z-ADD0         MAMR
     C                     Z-ADD0         YAMR
     C                     EXSR BLKLIN
     C*
     C** Dealing records.
     C*
     C                     Z-ADD1         W
     C           W         DOWLT10
     C           YAV,W     IFNE 0
     C                     Z-ADDMAV,W     MAVV
     C                     Z-ADDYAV,W     YAVV
     C           W         ADD  11        Z
     C                     MOVELMSG,Z     NARR
     C                     MOVE *BLANKS   SMAVV                           163668
     C                     MOVE *BLANKS   SYAVV                           163668
     C           MAVV      IFNE 0                                         163668
     C                     Z-ADDMAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SMAVV                           163668
     C                     ENDIF                                          163668
     C           YAVV      IFNE 0                                         163668
     C                     Z-ADDYAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SYAVV                           163668
     C                     ENDIF                                          163668
     C*
     C** Write to subfile.
     C*
     C           WPRTR     IFEQ 'N'                                       163668
     C           T2        IFEQ 'G'
     C                     ADD  1         RGMTD
     C                     ADD  1         RGYTD
     C                     WRITELER475S1
     C                     WRITELER475S2
     C                     ELSE
     C                     ADD  1         RDMTD
     C                     ADD  1         RDYTD
     C                     WRITELER475S3
     C                     WRITELER475S4
     C                     END
     C                     ENDIF                                          163668
     C*
     C                     END
     C                     ADD  1         W
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
     C*****************************************************************   BH3464
     C*                                                               *   BH3464
     C*  REDET ---- Subroutine to set up fields in subfiles for Retail*   BH3464
     C*                                                               *   BH3464
     C*  CALLED FROM: GROUP                                           *   BH3464
     C*  CALLS:                                                       *   BH3464
     C*                                                               *   BH3464
     C*****************************************************************   BH3464
     C*                                                                   BH3464
     C           REDET     BEGSR                                          BH3464
     C*                                                                   BH3464
     C                     ADD  NQMAVV    REMAVV 150                      BH3464
     C                     ADD  NQYAVV    REYAVV 150                      BH3464
     C                     ADD  NQMFEE    REMFEE 150                      BH3464
     C                     ADD  NQYFEE    REYFEE 150                      BH3464
     C                     ADD  NQMMGN    REMMGN 150                      BH3464
     C                     ADD  NQYMGN    REYMGN 150                      BH3464
     C                     ADD  NQMAYR    REMAYR  64                      BH3464
     C                     ADD  NQYAYR    REYAYR  64                      BH3464
     C                     ADD  NQMAMR    REMAMR  64                      BH3464
     C                     ADD  NQYAMR    REYAMR  64                      BH3464
     C*                                                                   BH3464
     C                     ENDSR                                          BH3464
     C*                                                                   BH3464
      /EJECT
     C*****************************************************************   BH3464
     C*                                                               *   BH3464
     C*  RETOT ---- Subroutine to output final totals for Retail      *   BH3464
     C*                                                               *   BH3464
     C*  CALLED FROM: BLDSFL, GROUP                                   *   BH3464
     C*  CALLS:                                                       *   BH3464
     C*                                                               *   BH3464
     C*****************************************************************   BH3464
     C*                                                                   BH3464
     C           RETOT     BEGSR                                          BH3464
     C*                                                                   BH3464
     C                     Z-ADDREMAVV    MAVV                            BH3464
     C                     Z-ADDREYAVV    YAVV                            BH3464
     C                     MOVE *BLANKS   SMAVV                           163668
     C                     MOVE *BLANKS   SYAVV                           163668
     C           MAVV      IFNE 0                                         163668
     C                     Z-ADDMAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SMAVV                           163668
     C                     ENDIF                                          163668
     C           YAVV      IFNE 0                                         163668
     C                     Z-ADDYAVV      ZFLD15                          163668
     C                     EXSR ZFRPED                                    163668
     C                     MOVELZOUT25    SYAVV                           163668
     C                     ENDIF                                          163668
     C           REMFEE    DIV  100       MFEE      H                     BH3464
     C           REYFEE    DIV  100       YFEE      H                     BH3464
     C           REMMGN    DIV  100       MMGN      H                     BH3464
     C           REYMGN    DIV  100       YMGN      H                     BH3464
     C                     Z-ADDREMAYR    MAYR                            BH3464
     C                     Z-ADDREYAYR    YAYR                            BH3464
     C                     Z-ADDREMAMR    MAMR                            BH3464
     C                     Z-ADDREYAMR    YAMR                            BH3464
     C*                                                                   BH3464
     C** Write to subfile.                                                BH3464
     C*                                                                   BH3464
     C           WPRTR     IFEQ 'N'                                       163668
     C           T2        IFEQ 'G'                                       BH3464
     C                     ADD  1         RGMTD                           BH3464
     C                     ADD  1         RGYTD                           BH3464
     C                     WRITELER475S1                                  BH3464
     C                     WRITELER475S2                                  BH3464
     C                     ELSE                                           BH3464
     C                     ADD  1         RDMTD                           BH3464
     C                     ADD  1         RDYTD                           BH3464
     C                     WRITELER475S3                                  BH3464
     C                     WRITELER475S4                                  BH3464
     C                     END                                            BH3464
     C                     ENDIF                                          163668
     C*                                                                   BH3464
     C                     Z-ADD0         REMAVV                          BH3464
     C                     Z-ADD0         REYAVV                          BH3464
     C                     Z-ADD0         REMFEE                          BH3464
     C***********          Z-ADD0         REMFEE                   BH3464 104036
     C***********          Z-ADD0         REMFEE                   BH3464 104036
     C***********          Z-ADD0         REMFEE                   BH3464 104036
     C                     Z-ADD0         REYFEE                          104036
     C                     Z-ADD0         REMMGN                          104036
     C                     Z-ADD0         REYMGN                          104036
     C                     Z-ADD0         REMAYR                          BH3464
     C                     Z-ADD0         REYAYR                          BH3464
     C                     Z-ADD0         REMAMR                          BH3464
     C                     Z-ADD0         REYAMR                          BH3464
     C*                                                                   BH3464
     C                     ENDSR                                          BH3464
     C*                                                                   BH3464
      /EJECT
      *****************************************************************
      *                                                               *
      *  AVLOAN --- Calculate days for average loan totals.           *
      *                                                               *
      *  CALLED FROM: FACTOT                                          *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C********** AVLOAN    BEGSR                                          157376
     C**********                                                          157376
     C***Read*first level extract to get facility start & end dates.      157376
     C**********                                                          157376
     C********** KEYFCD    CHAINLEPEFCD              89                   157376
     C**********                                                          157376
     C***Calculate days facility live this year.                          157376
     C**********                                                          157376
     C********** FDFEDY    IFLT SMDY                                      157376
     C**********           Z-ADD0         MTOT                            157376
     C**********           ELSE                                           157376
     C**********                                                          157376
     C********** FDFSDY    IFGT SMDY                       START > SOM    157376
     C********** FDFEDY    IFLT PDAYS                      END < PDAT     157376
     C********** FDFEDY    SUB  FDFSDY    MTOT                            157376
     C**********           ELSE                            END *GE PDAT   157376
     C********** PDAYS     SUB  FDFSDY    MTOT                            157376
     C**********           END                                            157376
     C**********           ELSE                            START LE SOM   157376
     C********** FDFEDY    IFLT PDAYS                      END < PDAT     157376
     C********** FDFEDY    SUB  SMDY      MTOT                            157376
     C**********           ELSE                            END *GE PDAT   157376
     C********** PDAYS     SUB  SMDY      MTOT                            157376
     C**********           END                                            157376
     C**********           END                                            157376
     C**********           ADD  1         MTOT                            157376
     C**********                                                          157376
     C**********           END                                            157376
     C**********                                                          157376
     C***Calculate days facility live this year.                          157376
     C**********                                                          157376
     C********** FDFEDY    IFLT SYDY                                      157376
     C**********           Z-ADD0         YTOT                            157376
     C**********           ELSE                                           157376
     C**********                                                          157376
     C********** FDFSDY    IFGT SYDY                       START > SOY    157376
     C********** FDFEDY    IFLT PDAYS                      END < PDAT     157376
     C********** FDFEDY    SUB  FDFSDY    YTOT                            157376
     C**********           ELSE                            END *GE PDAT   157376
     C********** PDAYS     SUB  FDFSDY    YTOT                            157376
     C**********           END                                            157376
     C**********           ELSE                            START LE SOY   157376
     C********** FDFEDY    IFLT PDAYS                      END < PDAT     157376
     C********** FDFEDY    SUB  SYDY      YTOT                            157376
     C**********           ELSE                            END *GE PDAT   157376
     C********** PDAYS     SUB  SYDY      YTOT                            157376
     C**********           END                                            157376
     C**********           END                                            157376
     C**********           ADD  1         YTOT                            157376
     C**********                                                          157376
     C**********           END                                            157376
     C**********                                                          157376
     C**********           ENDSR                                          157376
     C*
      /EJECT
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZEROS --- Zeroise totals for next display.                   *
      *                                                               *
      *  CALLED FROM: BLDSFL, FACTOT                                  *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           ZEROS     BEGSR
     C*
     C** Zeroise accumulated totals.
     C*
     C                     Z-ADD0         SAVSEQ
     C**********           Z-ADD0         SAVFCN                                              CSD027
     C                     MOVE *BLANKS   SAVFCN                                              CSD027
     C***********          Z-ADD0         TMAG                            148866
     C***********          Z-ADD0         TYAG                            148866
     C                     Z-ADD0         TMAV                            148866
     C                     Z-ADD0         TYAV                            148866
     C                     Z-ADD0         TMMG
     C                     Z-ADD0         TYMG
     C                     Z-ADD0         TMFE
     C                     Z-ADD0         TYFE
     C                     Z-ADD0         TMDY
     C                     Z-ADD0         TYDY
     C***********          Z-ADD0         MMAG                            148866
     C***********          Z-ADD0         MYAG                            148866
     C                     Z-ADD0         MMAV                            148866
     C                     Z-ADD0         MYAV                            148866
     C                     Z-ADD0         MMMG
     C                     Z-ADD0         MYMG
     C                     Z-ADD0         MMFE
     C                     Z-ADD0         MYFE
     C                     Z-ADD0         MMDY
     C                     Z-ADD0         MYDY
     C                     Z-ADD0         FMMG
     C                     Z-ADD0         FYMG
     C                     Z-ADD0         FMFE
     C                     Z-ADD0         FYFE
     C                     MOVE *BLANKS   NARR
     C                     MOVE *BLANKS   SMAVV                           163668
     C                     MOVE *BLANKS   SYAVV                           163668
     C                     MOVE 'Y'       WCHG    1                       163668
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  BLKLIN --- Output blank lines to subfiles.                   *
      *                                                               *
      *  CALLED FROM: DETAIL, GROUP, MOVDTA                           *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           BLKLIN    BEGSR
     C*
     C** Set up RRN dependant on subfiles being built.
     C*
     C           WPRTR     IFEQ 'N'                                       163668
     C           T2        IFEQ 'G'
     C                     ADD  1         RGMTD
     C                     ADD  1         RGYTD
     C                     ELSE
     C                     ADD  1         RDMTD
     C                     ADD  1         RDYTD
     C                     END
     C                     ENDIF                                          163668
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  FACNAM --- Subroutine to get facility name.                  *
      *                                                               *
      *  CALLED FROM: DETAIL, GROUP                                   *
      *  CALLS: *PSSR after database error.                           *
      *                                                               *
      *****************************************************************
     C*
     C           FACNAM    BEGSR
     C*
     C                     MOVE NQFTYP    FTYPA   3
      *                                                                                       CLE138
      ** Get facility class from the extension file                                           CLE138
      *                                                                                       CLE138
     C                     MOVE *BLANKS   PFCLS                                               CLE138
     C           CLE138    IFEQ 'Y'                                                           CLE138
     C                     MOVE NQFTYP    @FACT                                               CLE138
     C                     MOVE NQLCUS    @CUST                                               CLE138
     C                     MOVE NQFSEQ    @SEQN                                               CLE138
     C           KFCLQ     CHAINLEFCLTLH             55                                       CLE138
     C           *IN55     IFEQ *OFF                                                          CLE138
     C                     MOVE FCXCLS    PFCLS                                               CLE138
     C                     ELSE                                                               CLE138
     C           *LOCK     IN   LDA                                                           CLE138
     C                     MOVEL'LER475  'DBPGM                                               CLE138
     C                     MOVEL'LEFCLTQD'DBFILE                                              CLE138
     C                     MOVE *BLANKS   DBKEY                                               CLE138
     C                     MOVELFTYPA     DBKEY                                               CLE138
     C                     Z-ADD011       DBASE                                               CLE138
     C                     OUT  LDA                                                           CLE138
     C                     EXSR *PSSR                                                         CLE138
     C                     ENDIF                                                              CLE138
     C                     ENDIF                                                              CLE138
     C*
     C                     CALL 'AOFACTR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM FTYPA     PTYPA   3
     C                     PARM           PFCLS   4                                           CLE138
     C           SDFACT    PARM SDFACT    DSFDY
     C*
     C** Record not found.
     C*
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'SDFACTPD'DBFILE
     C                     MOVE *BLANKS   DBKEY
     C**********           MOVELFTYPA     DBKEY                                              CLE138
     C                     MOVELDBFKEY    DBKEY                                              CLE138
     C                     Z-ADD001       DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C*
     C                     MOVELAMFCNM    FCNM
     C                     MOVE NQFSEQ    FSEQ
     C                     MOVELFNAME     NARR
     C*
     C                     ENDSR
     C/COPY WNCPYSRC,LER475C012
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  LVL0 --- Subroutine to validate level 0 input.               *
      *                                                               *
      *  CALLED FROM: VALSR                                           *
      *  CALLS: CUSVAL                                                *
      *                                                               *
      *****************************************************************
     C*
     C           LVL0      BEGSR
     C*
     C** Check total request is 'Y' or blank.
     C*
     C           ATOT      IFNE 'Y'
     C           ATOT      ANDNE' '
     C                     MOVE '1'       *IN46
     C                     MOVEL'LER0118' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     ELSE
     C*
     C** Account officer totals requested.
     C*
     C           ATOT      IFEQ 'Y'
     C           MSGID     ANDEQ*BLANKS
     C                     MOVE 'A'       KRTYP
     C                     MOVE USAC      KACOF
     C                     MOVE USRDPT    KDEPT
     C/COPY WNCPYSRC,LER475C013
     C**********           Z-ADD0         KCNUM                                               CSD027
     C                     MOVE *BLANKS   KCNUM                                               CSD027
     C                     END
     C*
     C                     END
     C*
     C** Customer details requested.
     C*
     C           CNUM      IFNE *BLANKS
     C                     EXSR CUSVAL
     C           PRTCD     IFEQ *BLANKS
     C           CUSACO    IFNE USAC
     C                     MOVE '1'       *IN45
     C                     MOVEL'LER0106' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     ELSE
     C                     MOVE 'C'       KRTYP
     C                     MOVE USAC      KACOF
     C                     MOVE USRDPT    KDEPT
     C/COPY WNCPYSRC,LER475C014
     C**********           Z-ADDCNUMN     KCNUM                                               CSD027
     C                     MOVE CNUMN     KCNUM                                               CSD027
     C                     END
     C                     END
     C                     END
     C*
     C** Set up total field for display subroutine.
     C*
     C           MSGID     IFEQ *BLANKS
     C           ATOT      IFEQ 'Y'
     C                     MOVE 'Y'       KATOT
     C                     ELSE
     C                     MOVE ' '       KATOT
     C                     END
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  LVL1 --- Subroutine to validate level 1 input.               *
      *                                                               *
      *  CALLED FROM: VALSR                                           *
      *  CALLS: ACOVAL, CUSVAL, CUSAC                                 *
      *                                                               *
      *****************************************************************
     C*
     C           LVL1      BEGSR
     C*
     C** Check total request is 'Y' or blank.
     C*
     C           DTOT      IFNE 'Y'
     C           DTOT      ANDNE' '
     C                     MOVE '1'       *IN47
     C                     MOVEL'LER0118' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     ELSE
     C*
     C** Department totals requested.
     C*
     C           DTOT      IFEQ 'Y'
     C           MSGID     ANDEQ*BLANKS
     C                     MOVE 'D'       KRTYP
     C                     MOVE USRDPT    KDEPT
     C/COPY WNCPYSRC,LER475C015
     C                     MOVE *BLANKS   KACOF
     C**********           Z-ADD0         KCNUM                                               CSD027
     C                     MOVE *BLANKS   KCNUM                                               CSD027
     C                     END
     C*
     C                     END
     C*
     C** Account officer details requested.
     C*
     C           ACOF      IFNE *BLANKS
     C                     EXSR ACOVAL
     C*
     C** Department not authorised to this account officer.
     C*
     C           PRTCD     IFEQ *BLANKS
     C           AZDPCD    IFNE USRDPT
     C                     MOVE '1'       *IN46
     C                     MOVEL'LER0108' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     END
     C           MSGID     IFEQ *BLANKS
     C                     MOVE 'A'       KRTYP
     C                     MOVE AZDPCD    KDEPT
     C/COPY WNCPYSRC,LER475C016
     C                     MOVE ACOF      KACOF
     C**********           Z-ADD0         KCNUM                                               CSD027
     C                     MOVE *BLANKS   KCNUM                                               CSD027
     C                     END
     C                     END
     C*
     C                     END
     C*
     C** Customer details requested.
     C*
     C           CNUM      IFNE *BLANKS
     C                     EXSR CUSVAL
     C*
     C** If account officer code blank on customer record then
     C** department not authorised to this customer.
     C*
     C           PRTCD     IFEQ *BLANKS
     C           CUSACO    IFEQ *BLANKS
     C                     MOVEL'LER0107' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     MOVE '1'       *IN45
     C                     ELSE
     C*
     C           CUSACO    IFNE USAC
     C                     EXSR CUSAC
     C*
     C** Department not authorised to this customer.
     C*
     C           PRTCD     IFEQ *BLANKS
     C           AZDPCD    IFNE USRDPT
     C                     MOVEL'LER0107' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     MOVE '1'       *IN45
     C                     END
     C                     END
     C*
     C                     END
     C*
     C                     END
     C                     END
     C*
     C***********          END                                            BH3379
     C*
     C           MSGID     IFEQ *BLANKS
     C                     MOVE 'C'       KRTYP
     C**********           Z-ADDCNUMN     KCNUM                                               CSD027
     C                     MOVE CNUMN     KCNUM                                               CSD027
     C                     MOVE USRDPT    KDEPT
     C/COPY WNCPYSRC,LER475C017
     C                     MOVE CUSACO    KACOF
     C                     END
     C                     END                                            BH3379
     C*
     C** Set up total field for display subroutine.
     C*
     C           MSGID     IFEQ *BLANKS
     C           DTOT      IFEQ 'Y'
     C                     MOVE 'Y'       KDTOT
     C                     ELSE
     C                     MOVE ' '       KDTOT
     C                     END
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  LVL2 --- Subroutine to validate level 2 input.               *
      *                                                               *
      *  CALLED FROM: VALSR                                           *
      *  CALLS: DPTVAL, ACOVAL, CUSVAL, CUSAC                         *
      *                                                               *
      *****************************************************************
     C*
     C           LVL2      BEGSR
     C*
     C** Check total request is 'Y' or blank.
     C*
     C           BTOT      IFNE 'Y'
     C           BTOT      ANDNE' '
     C                     MOVE '1'       *IN48
     C                     MOVEL'LER0118' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     ELSE
     C*
     C** Bank totals requested.
     C*
     C           BTOT      IFEQ 'Y'
     C           MSGID     ANDEQ*BLANKS
     C                     MOVE 'T'       KRTYP
     C                     MOVE *BLANKS   KACOF
     C                     MOVE *BLANKS   KDEPT
     C/COPY WNCPYSRC,LER475C018
     C**********           Z-ADD0         KCNUM                                               CSD027
     C                     MOVE *BLANKS   KCNUM                                               CSD027
     C                     END
     C                     END
     C*
     C** Department details requested.
     C*
     C           DEPT      IFNE *BLANKS
     C                     EXSR DPTVAL
     C           MSGID     IFEQ *BLANKS
     C                     MOVE 'D'       KRTYP
     C                     MOVE *BLANKS   KACOF
     C                     MOVE DEPT      KDEPT
     C/COPY WNCPYSRC,LER475C019
     C**********           Z-ADD0         KCNUM                                               CSD027
     C                     MOVE *BLANKS   KCNUM                                               CSD027
     C                     END
     C                     END
     C*
     C** Account officer details requested.
     C*
     C           ACOF      IFNE *BLANKS
     C                     EXSR ACOVAL
     C           MSGID     IFEQ *BLANKS
     C                     MOVE 'A'       KRTYP
     C                     MOVE AZDPCD    KDEPT
     C/COPY WNCPYSRC,LER475C020
     C                     MOVE ACOF      KACOF
     C**********           Z-ADD0         KCNUM                                               CSD027
     C                     MOVE *BLANKS   KCNUM                                               CSD027
     C                     END
     C                     END
     C*
     C** Customer details requested.
     C*
     C           CNUM      IFNE *BLANKS
     C                     EXSR CUSVAL
     C           MSGID     IFEQ *BLANKS
     C                     MOVE 'C'       KRTYP
     C**********           Z-ADDCNUMN     KCNUM                                               CSD027
     C                     MOVE CNUMN     KCNUM                                               CSD027
     C*
     C** If customer account officer code is blank then put *'s into
     C** account officer code and department code so that details
     C** can be picked up from LENQ for this customer.
     C*
     C           CUSACO    IFEQ *BLANKS
     C                     MOVE '**'      KACOF
     C                     MOVE '***'     KDEPT
     C/COPY WNCPYSRC,LER475C021
     C*
     C                     ELSE
     C                     MOVE CUSACO    KACOF
     C                     EXSR CUSAC
     C                     MOVE AZDPCD    KDEPT
     C/COPY WNCPYSRC,LER475C022
     C                     END
     C                     END
     C                     END
     C*
     C** Set up total field for display subroutine.
     C*
     C           MSGID     IFEQ *BLANKS
     C           BTOT      IFEQ 'Y'
     C                     MOVE 'Y'       KBTOT
     C                     ELSE
     C                     MOVE ' '       KBTOT
     C                     END
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  CUSAC --- Get customer account officer name.                 *
      *                                                               *
      *  CALLED FROM: LVL1, LVL2                                      *
      *  CALLS: *PSSR after database error.                           *
      *                                                               *
      *****************************************************************
     C*
     C           CUSAC     BEGSR
     C                     CALL 'AOACOFR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM CUSACO    PACOF   2
     C           SDACOF    PARM SDACOF    DSFDY
     C*
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'SDACOFPD'DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVELCUSACO    DBKEY
     C                     Z-ADD002       DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  CUSVAL --- Subroutine to validate customer.                  *
      *                                                               *
      *  CALLED FROM: LVL0, LVL1, LVL2                                *
      *  CALLS: CUSNAM                                                *
      *                                                               *
      *****************************************************************
     C*
     C           CUSVAL    BEGSR
     C*
     C** Check whether '?' processing is to be used.
     C*
     C                     MOVELCNUM      CNUMQ   1
     C           CNUMQ     IFEQ '?'
     C                     MOVE '1'       *IN09
     C                     END
     C*
     C                     MOVE *BLANKS   CNUMA
     C                     MOVELCNUM      CNUMA  10
     C                     EXSR CUSNAM
     C                     MOVE BBCUST    CNUMN
     C*
     C** If '?' processing is to be used move customer number selected
     C** into customer selection field.
     C*
     C           PRTCD     IFEQ *BLANKS
     C           *IN09     ANDEQ'1'
     C                     MOVEL*BLANKS   CNUM
     C                     MOVELBBCUST    CNUM
     C                     END
      ** If CSD007 is on, allow processing of a closed record (return     CSD007
      ** code '*NRF' and date deleted equal to zero).                     CSD007
      *                                                                   CSD007
     C           CSD007    IFEQ 'Y'                                       CSD007
     C           PRTCD     ANDEQ'*NRF'                                    CSD007
     C           BBDTDL    ANDEQ*ZERO                                     CSD007
      *                                                                   CSD007
     C                     ELSE                                           CSD007
     C*
     C           PRTCD     IFNE *BLANKS
     C                     MOVEL'LER0102' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     MOVE '1'       *IN45
     C                     ELSE
     C                     MOVE BBACOC    CUSACO
     C                     END
     C*
     C                     ENDIF                                          CSD007
      *                                                                   CSD007
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  ACOVAL --- Subroutine to validate account officer.           *
      *                                                               *
      *  CALLED FROM: LVL1, LVL2                                      *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           ACOVAL    BEGSR
     C*
     C** Check whether '?' processing is to be used.
     C*
     C           '?'       SCAN ACOF                     09
     C*
     C                     CALL 'AOACOFR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM ACOF      PACOF   2
     C           SDACOF    PARM SDACOF    DSFDY
     C*
     C** If '?' processing is to be used move account officer selected
     C** into account officer selection field.
     C*
     C           PRTCD     IFEQ *BLANKS
     C           *IN09     ANDEQ'1'
     C                     MOVELAZACOC    ACOF
     C                     END
     C*
     C           PRTCD     IFNE *BLANKS
     C                     MOVEL'LER0103' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     MOVE '1'       *IN46
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  DPTVAL --- Subroutine to validate department.                *
      *                                                               *
      *  CALLED FROM: LVL2                                            *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           DPTVAL    BEGSR
     C*
     C** Check whether '?' processing is to be used.
     C*
     C           '?'       SCAN DEPT                     09
     C*
     C                     CALL 'AODEPTR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM DEPT      PDEPT   3
     C           SDDEPT    PARM SDDEPT    DSFDY
     C*
     C** If '?' processing is to be used move department code selected
     C** into department selection field.
     C*
     C           PRTCD     IFEQ *BLANKS
     C           *IN09     ANDEQ'1'
     C                     MOVELAEDPCD    DEPT
     C                     END
     C*
     C           PRTCD     IFNE *BLANKS
     C                     MOVEL'LER0104' MSGID
     C                     CALL 'GPADDM'
     C                     PARM           MSGID
     C                     MOVE '1'       *IN47
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  NWCUST --- Subroutine to find new customer & industry names. *
      *                                                               *
      *  CALLED FROM: NEXTSR, BLDSFL                                  *
      *  CALLS: CUSNAM, NWACOF                                        *
      *                                                               *
      *****************************************************************
     C*
     C           NWCUST    BEGSR
     C*
     C                     MOVE *BLANKS   CNUMA
     C                     MOVELKCNUM     CNUMA
     C                     EXSR CUSNAM
     C           PRTCD     IFNE *BLANKS
     C*
     C                     MOVELMSG,1     CNAME
     C                     MOVELMSG,2     INAME
     C*
     C                     ELSE
     C*
     C                     MOVE *BLANKS   CNAME
     C                     MOVE *BLANKS   CTOWN
     C                     MOVELBBCRNM    CNAME
     C                     MOVELBBCRTN    CTOWN
     C                     BITON'1'       BBCSTY
     C                     CALL 'AOINDSR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM BBLICD    PLICD   3
     C           SDINDS    PARM SDINDS    DSFDY
     C*
     C           PRTCD     IFNE *BLANKS
     C                     MOVELAOLINA    INAME
     C                     ELSE
     C                     MOVELMSG,2     INAME
     C                     END
     C*
     C** Call account officer routine.
     C*
     C                     MOVE BBACOC    XACOF
     C                     EXSR NWACOF
     C*
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  CUSNAM --- Subroutine to get customer details.               *
      *                                                               *
      *  CALLED FROM: NWCUST                                          *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           CUSNAM    BEGSR
     C*
     C***********          CALL 'AOCUSTR0'                                CSD007
     C                     CALL 'AOCUSTR2'                                CSD007
     C                     PARM *BLANKS   PRTCD   7
     C                     PARM '*KEY'    POPTN   7
     C                     PARM CNUMA     PCUST  10
     C                     PARM           PKYST   7
     C***********SDCUST    PARM SDCUST    DSFDY                           176443
     C***********SDCUST    PARM SDCUST    DSSDY                    176443 CSD007
     C           SDCUST    PARM SDCUST    DSLDY                           CSD007
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  NWACOF --- Subroutine to find new account officer name.      *
      *                                                               *
      *  CALLED FROM: NEXTSR, BLDSFL                                  *
      *  CALLS: NWDEPT                                                *
      *                                                               *
      *****************************************************************
     C*
     C           NWACOF    BEGSR
     C*
     C                     CALL 'AOACOFR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM XACOF     PACOF   2
     C           SDACOF    PARM SDACOF    DSFDY
     C*
     C           PRTCD     IFNE *BLANKS
     C                     MOVELMSG,3     ANAME
     C                     ELSE
     C                     MOVELAZACON    ANAME
     C*
     C** Call department routine.
     C*
     C                     MOVE AZDPCD    XDEPT
     C                     EXSR NWDEPT
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  NWDEPT --- Subroutine to find new department name.           *
      *                                                               *
      *  CALLED FROM: NEXTSR, BLDSFL, NWACOF                          *
      *  CALLS: Nothing.                                              *
      *                                                               *
      *****************************************************************
     C*
     C           NWDEPT    BEGSR
     C*
     C                     CALL 'AODEPTR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM XDEPT     PDEPT   3
     C           SDDEPT    PARM SDDEPT    DSFDY
     C*
     C           PRTCD     IFNE *BLANKS
     C                     MOVELMSG,4     DNAME
     C                     ELSE
     C                     MOVELAEDPNM    DNAME
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      *  INIT --- Subroutine to perform first cycle calculations.     *
      *                                                               *
      *  CALLED FROM: MAIN                                            *
      *  CALLS: ZDATE2, ZDATE1, *PSSR after database error.           *
      *                                                               *
      *****************************************************************
     C*
     C           INIT      BEGSR
     C*
     C** Receive entry parameters.
     C*
     C           *ENTRY    PLIST
     C                     PARM           USAC    2
     C                     PARM           ALVL    10
     C*
     C                     MOVE '1'       *IN10
     C                     MOVEL'*'       MSGQ
     C*
     C                     MOVEACPY@      BISK   80
     C*
     C** Check that user is authorised to enquiry.                     .
     C*
     C           ALVL      IFEQ 9
     C                     MOVE '1'       *IN19
     C                     END
     C*
     C** Define local data area.
     C*
     C           *NAMVAR   DEFN           LDA
     C/COPY WNCPYSRC,LER475C023
      *                                                                   141462
      ** Define key list for LENQLF3                                      141462
      *                                                                   141462
     C           LF3KEY    KLIST                                          141462
     C**********           KFLD           KCUST   60                                   141462 CSD027
     C                     KFLD           KCUST   6                                           CSD027
     C                     KFLD           KFTYP   30                      141462
     C                     KFLD           KFSEQ   20                      141462
      *                                                                   141462
      ** Key list to access Funding Participant Details For a prime       141462
      ** Facility                                                         141462
      *                                                                   141462
     C           K#LTL2    KLIST                                          141462
     C                     KFLD           K#BRCA  3                       141462
     C**********           KFLD           K#PMFC  60                                   141462 CSD027
     C                     KFLD           K#PMFC  6                                           CSD027
     C                     KFLD           K#PMFT  30                      141462
     C                     KFLD           K#PMFN  20                      141462
      *                                                                   148861
      ** Key list to access Credit Agreement Details for a prime          148861
      ** Facility                                                         148861
      *                                                                   148861
     C           K#FCTY    KLIST                                          148861
     C**********           KFLD           K#FCUS  60                                   148861 CSD027
     C                     KFLD           K#FCUS  6                                           CSD027
     C                     KFLD           K#FTYP  30                      148861
     C                     KFLD           K#FSEQ  20                      148861
     C                     KFLD           K#RTYP  1                       148861
     C*
     C** Define key list for LENQLF0 & LENQLF2 (Customer records).
     C*
     C           LF0KEY    KLIST
     C/COPY WNCPYSRC,LER475C024
     C                     KFLD           KDEPT   3
     C                     KFLD           KACOF   2
     C**********           KFLD           KCNUM   60                                          CSD027
     C                     KFLD           KCNUM   6                                           CSD027
     C*
     C** Define key list for LENQLF1 (Total records).
     C*
     C           LF1KEY    KLIST
     C                     KFLD           KRTYP   1
     C/COPY WNCPYSRC,LER475C025
     C                     KFLD           KDEPT
     C                     KFLD           KACOF
     C*
     C** Define parameter list for LERDATEF (date to day no.)
     C*
     C           DATDAY    PLIST
     C                     PARM           GDATE   60
     C                     PARM           GDAYNO  50
     C                     PARM           GRTCD   1
     C*
     C** Define key list for LEPEFCD.
     C*
     C           KEYFCD    KLIST
     C                     KFLD           NQCNUM
     C                     KFLD           SVFTYP
     C                     KFLD           SVFSEQ
      *                                                                   CSD007
      ** Access Switchable Features file and check if CSD007              CSD007
      ** is switched on or not.                                           CSD007
      *                                                                   CSD007
     C                     CALL 'AOSARDR0'                                CSD007
     C                     PARM *BLANKS   @RTCD   7                       CSD007
     C                     PARM '*VERIFY' @OPTN   7                       CSD007
     C                     PARM 'CSD007'  @SARD   6                       CSD007
     C           SCSARD    PARM SCSARD    DSFDY                           CSD007
      *                                                                   CSD007
     C           @RTCD     IFEQ *BLANKS                                   CSD007
     C                     MOVE 'Y'       CSD007  1                       CSD007
     C                     ELSE                                           CSD007
     C                     MOVE 'N'       CSD007                          CSD007
      *                                                                   CSD007
      ** Database Error, if Return Code is not blanks or *NRF             CSD007
      *                                                                   CSD007
     C           @RTCD     IFNE '*NRF   '                                 CSD007
     C                     MOVEL'LER475  'DBPGM                           CSD007
     C                     MOVEL'SCSARDPD'DBFILE                          CSD007
     C                     Z-ADD09        DBASE                           CSD007
     C                     MOVEL'CSD007  'DBKEY                           CSD007
     C                     MOVE *ON       *INU7                           CSD007
     C                     MOVE *ON       *INU8                           CSD007
     C                     MOVE *ON       *INLR                           CSD007
     C                     EXSR *PSSR                                     CSD007
     C                     ENDIF                                          CSD007
     C                     ENDIF                                          CSD007
      *                                                                                       CLE138
      **  Define key list for Facility Extension file                                         CLE138
      *                                                                                       CLE138
     C           KFCLQ     KLIST                                                              CLE138
     C                     KFLD           @CUST   6                                           CLE138
     C                     KFLD           @FACT   3                                           CLE138
     C                     KFLD           @SEQN   2                                           CLE138
      *                                                                                       CLE138
      ** Determine if CLE138 feature is enabled                                               CLE138
      *                                                                                       CLE138
     C                     CALL 'AOSARDR0'                                                    CLE138
     C                     PARM *BLANKS   @RTCD                                               CLE138
     C                     PARM '*VERIFY' @OPTN                                               CLE138
     C                     PARM 'CLE138'  @SARD                                               CLE138
     C           SCSARD    PARM SCSARD    DSFDY                                               CLE138
      *                                                                                       CLE138
     C           @RTCD     IFEQ *BLANKS                                                       CLE138
     C                     MOVE 'Y'       CLE138  1                                           CLE138
     C                     ELSE                                                               CLE138
     C                     MOVE 'N'       CLE138                                              CLE138
      *                                                                                       CLE138
     C           @RTCD     IFNE '*NRF   '                                                     CLE138
     C                     MOVEL'LER475  'DBPGM                                               CLE138
     C                     MOVEL'SCSARDPD'DBFILE                                              CLE138
     C                     Z-ADD10        DBASE                                               CLE138
     C                     MOVEL'CLE138  'DBKEY                                               CLE138
     C                     MOVE *ON       *INU7                                               CLE138
     C                     MOVE *ON       *INU8                                               CLE138
     C                     MOVE *ON       *INLR                                               CLE138
     C                     EXSR *PSSR                                                         CLE138
     C                     ENDIF                                                              CLE138
     C                     ENDIF                                                              CLE138
     C*
     C** Define work fields.
     C*
     C                     MOVE 'Y'       WCHG    1                       163668
     C                     MOVE *BLANKS   USRDPT  3
     C                     MOVE *BLANKS   CUSACO  2
     C                     MOVE *BLANKS   MSGID   8
     C                     MOVE *BLANKS   INTEST  6
     C                     MOVE *BLANKS   CKTEST  6
     C                     MOVE *BLANKS   XACOF   2
     C                     MOVE *BLANKS   XDEPT   3
     C                     MOVE *BLANKS   WRK4    4
     C                     MOVE *BLANKS   WRK6    6
     C                     MOVE '/'       DASH1   1
     C                     MOVE '/'       DASH2   1
     C                     MOVE '/'       DASH3   1
     C                     MOVE '/'       SLASH1  1
     C                     MOVE '/'       SLASH2  1
     C                     MOVE '/'       SLASH3  1
     C                     MOVE *BLANK    LNRD    1
     C                     MOVE *BLANK    MATD    1
     C                     MOVE *BLANK    KATOT   1
     C                     MOVE *BLANK    KDTOT   1
     C                     MOVE *BLANK    KBTOT   1
     C***********          Z-ADD0         SAVFCN  50                      163668
     C**********           Z-ADD0         SAVFCN 110                                   163668 CSD027
     C                     MOVE *BLANKS   SAVFCN 11                                           CSD027
     C                     Z-ADD0         SVFTYP  30
     C                     Z-ADD0         SVFSEQ  20
     C                     Z-ADD0         WRK15  150
     C                     Z-ADD0         MODTOT 150                      148866
     C                     Z-ADD0         YODTOT 150                      148866
     C                     Z-ADD0         MODTOY 150                      148866
     C                     Z-ADD0         YODTOY 150                      148866
     C                     Z-ADD0         WRK154 154                      148866
     C                     Z-ADD0         WRK158 158
     C                     Z-ADD0         MARCAL 154                      148866
     C                     Z-ADD0         YARCAL 154                      148866
     C                     Z-ADD0         MARCAY 154                      148866
     C                     Z-ADD0         YARCAY 154                      148866
     C**********           Z-ADD0         CNUMN   60                                          CSD027
     C                     MOVE *BLANKS   CNUMN   6                                           CSD027
     C                     Z-ADD0         W       20
     C                     Z-ADD0         Z       20
     C                     Z-ADD0         RGMTD   50
     C                     Z-ADD0         RGYTD   50
     C                     Z-ADD0         RDMTD   50
     C                     Z-ADD0         RDYTD   50
     C                     Z-ADD0         ZDECS                           163668
     C                     MOVE *BLANK    ZECODE                          163668
     C************LIKE     DEFN NQMAGG    TMAG                            148866
     C************LIKE     DEFN NQMAGG    MMAG                            148866
     C************LIKE     DEFN NQMAGG    ZMAG                            148866
     C************LIKE     DEFN NQYAGG    TYAG                            148866
     C************LIKE     DEFN NQYAGG    MYAG                            148866
     C************LIKE     DEFN NQYAGG    ZYAG                            148866
     C           *LIKE     DEFN NQYAVV    TYAV                            148866
     C           *LIKE     DEFN NQYAVV    MYAV                            148866
     C           *LIKE     DEFN NQYAVV    ZYAV                            148866
     C           *LIKE     DEFN NQMAVV    TMAV                            148866
     C           *LIKE     DEFN NQMAVV    MMAV                            148866
     C           *LIKE     DEFN NQMAVV    ZMAV                            148866
     C           *LIKE     DEFN NQMMGN    TMMG
     C           *LIKE     DEFN NQMMGN    MMMG
     C           *LIKE     DEFN NQMMGN    ZMMG
     C           *LIKE     DEFN NQMMGN    FMMG
     C           *LIKE     DEFN NQYMGN    TYMG
     C           *LIKE     DEFN NQYMGN    MYMG
     C           *LIKE     DEFN NQYMGN    ZYMG
     C           *LIKE     DEFN NQYMGN    FYMG
     C           *LIKE     DEFN NQMFEE    TMFE
     C           *LIKE     DEFN NQMFEE    MMFE
     C           *LIKE     DEFN NQMFEE    ZMFE
     C           *LIKE     DEFN NQMFEE    FMFE
     C           *LIKE     DEFN NQYFEE    TYFE
     C           *LIKE     DEFN NQYFEE    MYFE
     C           *LIKE     DEFN NQYFEE    ZYFE
     C           *LIKE     DEFN NQYFEE    FYFE
     C*
     C** If user is authorised to the Profitability information then
     C** validate that user is a valid account officer.
     C** If so, get department code for user account officer.
     C*
     C           *IN19     IFEQ '0'
     C                     CALL 'AOACOFR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM USAC      PACOF   2
     C           SDACOF    PARM SDACOF    DSFDY
     C*
     C           PRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'SDACOFPD'DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVELUSAC      DBKEY
     C                     Z-ADD003       DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C                     MOVE AZDPCD    USRDPT
     C                     END
     C*
     C                     END
     C*
     C** Read in LERSTS data area.
     C*
     C           *NAMVAR   DEFN           LERSTS
     C                     IN   LERSTS
     C                     MOVE PDAT      ADAT    7
     C*
     C** Get month number of processing date.
     C*
     C                     Z-ADD1         MN      20
     C           MMM       LOKUPZMNM,MN                  60
     C*
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
     C*
     C** Should not do this check as all dates input to the routines       0108
     C** are in DDMMYY format and this does not matter for the report      0108
     C** as that uses the alpha date. This was causing an error in the     0108
     C** profitability calculations                                        0108
     C**                                                                   0108
     C***Check*date*format*for standard subroutine.                        0108
     C*********************                                                0108
     C***********BJDFIN****IFEQ 'M'                                        0108
     C*********************MOVE '1'       *IN98                            0108
     C*********************END                                             0108
     C                     MOVE '0'       *IN98                            0108
     C*
     C** Using previous end of year date from SDBANKPD
     C** calculate start of year date.
     C*
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'SDBANKPD'DBFILE
     C                     Z-ADD004       DBASE
     C                     MOVEL*BLANKS   DBKEY
     C                     MOVEL'BANK'    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C*
     C** If user is not authorised to the Profitability information
     C** then no further initial processing is required so exit
     C** subroutine.
     C*
     C           *IN19     IFEQ '0'
     C*
     C** Access SDCURRL0 using the base currency to retrieve the
     C** default calculation basis.
     C*
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY'    POPTN
     C                     PARM BJCYCD    PCYCD   3
     C***********SDCURR    PARM SDCURR    DSFDY                                               CSD006
     C           SDCURR    PARM SDCURR    DSSDY                                               CSD006
     C*
     C           PRTCD     IFNE *BLANKS
     C           A6DICB    OREQ *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'SDCURRPD'DBFILE
     C                     Z-ADD005       DBASE
     C                     MOVEL*BLANKS   DBKEY
     C                     MOVELBJCYCD    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C*
     C** Set up the correct number of days in the year from the
     C** default calculation basis.
     C*
     C                     ELSE
     C           A6DICB    IFEQ '1'
     C           A6DICB    OREQ '4'
     C                     Z-ADD365       CALCB   30
     C                     ELSE
     C           A6DICB    IFEQ '6'
     C                     Z-ADD366       CALCB
     C                     ELSE
     C                     Z-ADD360       CALCB
     C                     END
     C                     END
     C                     END
     C*
     C** Calculate start of year date.
     C*
     C           1         ADD  BJPEYD    ZDAYNO  50
     C                     Z-ADDZDAYNO    SYDY    50
     C                     EXSR ZDATE2
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'SDBANKPD'DBFILE
     C                     Z-ADD006       DBASE
     C                     MOVEL*BLANKS   DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE                                             0109
     C                     MOVE ZADATE    YDAT    7
     C                     END
     C*
     C** Store the day (DD) field of start of year date for later use.
     C*
     C                     MOVELZADATE    DSTORE  2
     C*
     C** Calculate processing & start of month date.
     C*
     C                     MOVELPDAT      DD
     C                     MOVELMN        MY
     C                     MOVE YY        MY
     C                     MOVE NDAT      ZDATE
     C                     EXSR ZDATE1
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'LERSTS  'DBFILE
     C                     Z-ADD007       DBASE
     C                     MOVEL*BLANKS   DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE                                             0109
     C                     MOVE ZADATE    YDAT    7
     C                     END
     C                     Z-ADDZDAYNO    PDAYS   50
     C*
     C** Calculate year to date number of days.
     C*
     C           PDAYS     SUB  SYDY      YDAYS   30
     C                     ADD  1         YDAYS
     C*
     C**  Flexible start of month.
     C*
     C                     MOVELPDAT      DD1     2
     C                     MOVE PDAT      TODT    7                         0109
     C*
     C**  If the DD field of the processing date is less than the
     C**  DD field of the start of month date then allow for
     C**  the use of the previous months calculations by
     C**  subtracting 1 from the month number.
     C*
     C           DD1       IFLT DSTORE
     C                     SUB  1         MN
     C*
     C**  If the resulting month number is zero then move 12
     C**  into the MN field and subtract 1 from the YY
     C**  field to return to the previous year.
     C*
     C           MN        IFEQ 0
     C                     Z-ADD12        MN
     C                     MOVE YY        YYN     20
     C                     SUB  1         YYN
     C                     MOVE YYN       YY
     C                     END
     C*
     C                     END
     C*
     C**  Flexible start of month.
     C*
     C                     MOVELDSTORE    ADAT
     C                     MOVE ZMNM,MN   MMM
     C                     MOVE ADAT      MDAT    7
     C*
     C** Move the appropriate values into the month and year fields
     C** for the date data structure.
     C*
     C                     MOVELMN        MY
     C*
     C** Convert the appropriate start of month date to Midas day
     C** format having retrieved the appropriate alphanumeric month
     C** from the array.
     C                     MOVE DSTORE    DD
     C*
     C                     MOVE NDAT      GDATE
     C                     CALL 'LERDATEF'DATDAY
     C           GRTCD     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'LER475  'DBPGM
     C                     MOVEL'LERSTS  'DBFILE
     C                     Z-ADD008       DBASE
     C                     MOVEL*BLANKS   DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     MOVE ZADATE    YDAT    7
     C                     END
     C                     Z-ADDGDAYNO    SMDY    50
     C           PDAYS     SUB  GDAYNO    MDAYS   20
     C                     ADD  1         MDAYS
     C*
      * Set up actual days in month/year fields for average balance       157376
      * calculations                                                      157376
     C********** BJRDNB    SUB  SMDY      MTOT    20                157376157377
     C                     Z-ADDMDAYS     MTOT    20                      157377
      *                                                                   157376
     C********** BJRDNB    SUB  BJPEYD    YTOT    30                157376157377
     C**********           SUB  1         YTOT                      157376157377
     C                     Z-ADDYDAYS     YTOT    30                      157377
     C*
     C** Initialise screen fields.
     C*
     C                     MOVE *BLANKS   CNUM
     C                     MOVE *BLANKS   ACOF
     C                     MOVE *BLANKS   DEPT
     C/COPY WNCPYSRC,LER475C026
     C                     MOVE *BLANKS   ATOT
     C                     MOVE *BLANKS   DTOT
     C                     MOVE *BLANKS   BTOT
     C*
     C** Set screen indicators & authority level.
     C*
     C                     MOVEA'00000000'*IN,20
     C                     MOVEA'01010101'*IN,30
     C                     MOVEA'110000'  *IN,43
     C           ALVL      COMP 1                    424041
     C*
     C** Set input indicators for field(s) not displayed.
     C*
     C           ALVL      IFEQ 0
     C                     MOVE '1'       *IN12
     C                     MOVEA'111'     *IN,14
     C                     END
     C           ALVL      IFEQ 1
     C                     MOVE '1'       *IN16
     C                     MOVEA'11'      *IN,13
     C                     END
     C           ALVL      IFEQ 2
     C                     MOVE '1'       *IN13
     C                     MOVE '1'       *IN15
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C*
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
     C/COPY ZSRSRC,ZDATE2Z2
     C/COPY ZSRSRC,ZFRPEDZ3                                               163668
      /EJECT
      *****************************************************************
      *                                                               *
      *  *PSSR --- Subroutine to handle abnormal error conditions     *
      *                                                               *
      *  CALLED FROM: After abnormal operation occurs                 *
      *  CALLS: DBERRCTL                                              *
      *                                                               *
      *****************************************************************
     C*
     C           *PSSR     BEGSR                           ** *PSSR **
     C*
     C** Ensure dump is executed only once
     C*
     C           KRUN      IFEQ *BLANK
     C                     MOVE 'Y'       KRUN    1
     C                     DUMP
     C                     END
     C*
     C** Call database error program
     C*
     C                     CALL 'DBERRCTL'
     C                     ENDSR
     C*
      *****************************************************************
      /COPY ZSRSRC,ZDATE2Z3
** CPY@   OBJECT COPYRIGHT
(c) Finastra International Limited 2001
**   MESSAGES - FOR UNKNOWN CODES & LINE NARRATIVES
* CUSTOMER UNKNOWN *
* INDUSTRY UNKNOWN *
* A/C OFFICER UNKNOWN*
* DEPARTMENT UNKNOWN *
TOTAL FACILITIES
FACILITY TOTAL
TOTAL MATURED LOANS
TOTAL LOANS
RETAIL ACCOUNTS - DR
RETAIL ACCOUNTS - CR
OTHER FEES/CHARGES
MM - LOANS
MM - DEPOSITS
MM - NAs INT.BEARING
MM - NAs NON-INT.BRG
FX - FX
FX - FRA
FX - IRS
FX - FUTURES
FX - OPTIONS
AVERAGE LOANS
**   TOTAL NARRATIVES
TOTAL FOR ACCOUNT OFFICER
     TOTAL FOR DEPARTMENT
TOTAL FOR ALL DEPARTMENTS
