     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MA Report archive contents')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Microfiche/Optical Disk Archiving Module
     F*                                                               *
     F*  MA0400P - REPORT ARCHIVE CONTENTS                            *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *  Prev Amend No. LN1093             Date 10Jan91               *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
     F*      LN1093 - PRINT BANK TITLE, DESCRIPTIONS OF REPORT AND    *
     F*               PRINT SUFFIX                                    *
     F*                                                               *
     F*****************************************************************
      *  C R E A T I O N     P A R A M E T E R S                      *
      *                                                               *
      *                                                               *
      *****************************************************************
     F*Permanent Archives       Initialise Program F-Spec
     F/COPY WNCPYSRC,MA0400PFPG
     FMAARCDL1IF  E           K        DISK
      * RTV: Archive Contents(daily)   Retrieval index
      *
     FFCREPTL1IF  E           K        DISK                               LN1093
      * RTV: Report Descriptions       Retrieval index                    LN1093
      *                                                                   LN1093
     FFCRSFXL1IF  E           K        DISK                               LN1093
      * RTV: Report Suffixes           Retrieval index                    LN1093
      *                                                                   LN1093
     FMA0400PMO   E             97     PRINTER
     F                                              KINFDS INFDS$
      * PRT: Report Archive Contents   Print file
      *
     FMA0400AUO   E                    PRINTER      KINFDS SPOOLU     UC  LN1093
      * PRT: Archive Contents Audit    Print file                         LN1093
     F*                                                                   LN1093
     E                    CPY@    1   1 80
     E*Permanent Archives       Initialise Program E-Spec
     E/COPY WNCPYSRC,MA0400PEPG
     E                    @CN     1   3 25               Long constants.
     I*Permanent Archives       Initialise Program I-Spec
     I/COPY WNCPYSRC,MA0400PIPG
      /EJECT
      * Data structures:-
     IPGMDS     ESDSY2PGDSP
      * Program data structure.
     IJBDTTM      DS
      * Job date/time.
     I                                        1   60##JDT
     I                                        1   20##JYY
     I                                        3   40##JMM
     I                                        5   60##JDD
     I                                        7  120##JTM
     I                                        7   80##JHH
     I                                        9  100##JNN
     I                                       11  120##JSS
     IINFDS$    E DSY2I$DSP
      * Printer file information data structure.
      *                                                                   LN1093
     ISPOOLU      DS                                                      LN1093
     I*                                                                   LN1093
     I** SPOOL INFORMATION DATA STRUCTURE FOR ZSFILE - AU REPORT          LN1093
     I*                                                                   LN1093
     I                                       83  92 SFILEU                LN1093
     I                                    B 123 1240SFNUMU                LN1093
     I*                                                                   LN1093
     IRSFXDS      DS
     I                                        1  10 EBRNAM
     I                                       11  20 EBRSFX
     I*
     IUUFDY     E DSDSFDY                                                 LN1093
     I*                                                                   LN1093
     I* 200 BYTE DATA STRUCTURE FOR INCOMING DATA ROM ACCESS PGM          LN1093
     I*                                                                   LN1093
     ID@BANK    E DSSDBANKPD                                              LN1093
     I*                                                                   LN1093
     I* BANK DETAILS DATA STRUCTURE FOR ASSIGNING DATA FROM ACCESS PGM    LN1093
      *                                                                   LN1093
     ILDA         DS                            256                       LN1093
     I*                                                                   LN1093
     I** LOCAL DATA AREA FOR DATABASE ERROR REPORTING                     LN1093
     I*                                                                   LN1093
     I                                      134 141 DBFILE                LN1093
     I                                      142 170 DBKEY                 LN1093
     I                                      171 180 DBPGM                 LN1093
     I                                      181 1830DBASE                 LN1093
     IRUNDAT      DS
     I                                        1   7 RUNA
     I                                    P   8  100RUND
     I                                       11  11 SSF
     I                                       12  12 DATF
     I                                       13  13 MBIN
      /EJECT
      * Parameter declarations.
     IP1PARM      DS
      * I:    Sequence Number
     I                                        1   5 P1RQSQ
     IP2PARM      DS
      * I:    Level
     I                                        1   1 P2LVL
     IP3PARM      DS
      * I:    Entity
     I                                        1   3 P3ETTY
      /EJECT
      *****************************************************************
     C           *ENTRY    PLIST                           Entry parameter
     C                     PARM           P0RTN   7        Return code
     C           P1RQSQ    PARM           WP0001  5        Sequence Number
     C           P2LVL     PARM           WP0002  1        Level
     C           P3ETTY    PARM           WP0003  3        Entity
      *****************************************************************
      * Initialise
     C                     EXSR ZZINIT
      *
      * Clear overflow indicator.
     C                     SETOF                     97
      * Establish starting position.
     C           *LOVAL    SETLL@EBREJR                    *
      * Read first record with user selection.
     C                     EXSR GARDRC
      * Print null report headings.
     C           W0EOF     IFEQ '1'
     C                     WRITE$PAGHDR
      * USER: Null report processing
      * 00/Copy member XX0400PNRP - Archive Contents(daily)  *
     C*Permanent Archives       Null Report Processing
     C/COPY WNCPYSRC,MA0400PNRP
     C                     WRITE$ENDRPT
     C                     ELSE
      * Request all headings.
     C                     MOVEL'Y'       L0      1        Page headings
     C                     MOVEL'Y'       L1      1        Archive ID
     C                     MOVEL'Y'       L2      1        Sequence Number
     C                     MOVEL'Y'       L3      1        Report name
      * Initialise final totals.
      * Print report body.
     C           W0EOF     DOWEQ'0'
      * Print headings.
     C                     EXSR BAPRHD
      * Print report detail line.
     C                     EXSR CAPRDT
      * Hold current values.
     C           *LIKE     DEFN EBARID    WZARID           Archive ID
     C                     MOVELEBARID    WZARID
     C           *LIKE     DEFN EBRQSQ    WZRQSQ           Sequence Number
     C                     MOVELEBRQSQ    WZRQSQ
     C           *LIKE     DEFN EBRNAM    WZRNAM           Report name
     C                     MOVELEBRNAM    WZRNAM
      * Read next record with user selection.
     C                     EXSR GARDRC
      * Determine level changes.
     C                     EXSR DALVCH
      * Print totals.
     C                     EXSR EAPRTT
      * Process necessary heading requests
     C                     EXSR FASGHD
     C                     END
     C                     WRITE$ENDRPT
     C                     END
      * Exit program.
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *****************************************************************
      /EJECT
     CSR         BAPRHD    BEGSR
      *================================================================
      * Print report Headers.
      *================================================================
      * Clear column headings control flag.
     C                     MOVEL*BLANK    BAPR    1
      *
     C           L0        IFEQ 'Y'
     C                     WRITE$PAGHDR
     C                     MOVEL'Y'       BAPR
     C                     END
      *
     C           L1        IFEQ 'Y'
      * Load format.
     C                     MOVELEBARID    $1ARID           Archive ID
     C                     END
      *
     C           L1        IFNE *BLANK
     C                     MOVEL'Y'       W0PFM
      * User: Process Archive ID headings.
      * 00/Copy member XX0400PLH0 - Archive Contents(daily)  *
     C*Permanent Archives       Print Level Heading 0
     C/COPY WNCPYSRC,MA0400PLH0
     C           W0PFM     IFEQ 'Y'
      * Print format.
     C                     WRITE$1KEYHDR
     C                     MOVEL'Y'       BAPR
     C                     END
     C                     END
      *
     C           L2        IFEQ 'Y'
      * Load format.
     C                     MOVELEBARID    $2ARID           Archive ID
     C                     MOVELEBRQSQ    $2RQSQ           Sequence Number
     C                     END
      *
     C           L2        IFNE *BLANK
     C                     MOVEL'Y'       W0PFM
      * User: Process Sequence Number headings.
      * 00/Copy member XX0400PLH2 - Archive Contents(daily)  *
     C*Permanent Archives       Print Level Heading 2
     C/COPY WNCPYSRC,MA0400PLH2
     C           W0PFM     IFEQ 'Y'
      * Print format.
     C                     WRITE$2KEYHDR
     C                     MOVEL'Y'       BAPR
     C                     END
     C                     END
      *
     C           L3        IFEQ 'Y'
      * Load format.
     C                     MOVELEBARID    $3ARID           Archive ID
     C                     MOVELEBRQSQ    $3RQSQ           Sequence Number
     C                     MOVELEBRNAM    $3RNAM           Report name
     C* chain to FCREPTL1 for report description                          LN1093
     C           EBRNAM    CHAIN@DXREIK              90                   LN1093
     C*                                                                   LN1093
      ** database error if not found                                      LN1093
     C*                                                                   LN1093
     C           *IN90     IFEQ '1'                                       LN1093
     C           *LOCK     IN   LDA                                       LN1093
     C                     MOVELEBRNAM    DBKEY                           LN1093
     C                     MOVEL'FCREPTL1'DBFILE           ***************LN1093
     C                     Z-ADD1         DBASE            * DB ERROR 001*LN1093
     C                     MOVEL'MA0400P' DBPGM            ***************LN1093
     C                     OUT  LDA                                       LN1093
     C                     EXSR ZWDBER                                    LN1093
     C                     END                                            LN1093
     C*                                                                   LN1093
     C* move report description to print line                             LN1093
     C                     MOVELDXRDSC    $3RDSC                          LN1093
     C                     END
      *
     C           L3        IFNE *BLANK
     C                     MOVEL'Y'       W0PFM
      * User: Process Report name headings.
      * 00/Copy member XX0400PLH1 - Archive Contents(daily)  *
     C*Permanent Archives       Print Level Heading 1
     C/COPY WNCPYSRC,MA0400PLH1
     C           W0PFM     IFEQ 'Y'
      * Print format.
     C                     WRITE$3KEYHDR
     C                     MOVEL'Y'       BAPR
     C                     END
     C                     END
      *
      *================================================================
     CSR         BAEXIT    ENDSR
      /EJECT
     CSR         CAPRDT    BEGSR
      *================================================================
      * Print report detail line.
      *================================================================
      * Load detail line.
     C                     MOVELEBARID    $RARID           Archive ID
     C                     MOVELEBRNAM    $RRNAM           Report name
     C                     MOVELEBRQSQ    $RRQSQ           Sequence Number
     C                     MOVELEBRSFX    $RRSFX           Print File Name
     C                     MOVELEBCFLG    $RCFLG           Collation Flag
     C                     MOVELEBACFL    $RACFL           archive flag
     C                     MOVEL'Y'       W0PFM
     C* chain to FCRSFXL1 for Print File Suffix description               LN1093
     C*                                                                   LN1093
     C           RSFXKY    CHAIN@DYREIO              90                   LN1093
     C*                                                                   LN1093
      ** database error if not found                                      LN1093
     C*                                                                   LN1093
     C           *IN90     IFEQ '1'                                       LN1093
     C           *LOCK     IN   LDA                                       LN1093
     C                     MOVELRSFXDS    DBKEY                           LN1093
     C                     MOVEL'FCRSFXL1'DBFILE           ***************LN1093
     C                     Z-ADD2         DBASE            * DB ERROR 002*LN1093
     C                     MOVEL'MA0400P' DBPGM            ***************LN1093
     C                     OUT  LDA                                       LN1093
     C                     EXSR ZWDBER                                    LN1093
     C                     END                                            LN1093
     C*                                                                   LN1093
     C* move suffix description to print line                             LN1093
     C                     MOVELDYPFTX    $RPFTX                          LN1093
     C*                                                                   LN1093
      * USER: Process detail record
      * 00/Copy member XX0400PPDR - Archive Contents(daily)  *
     C*Permanent Archives       Process Detail Record
     C/COPY WNCPYSRC,MA0400PPDR
     C           W0PFM     IFEQ 'Y'
      * Print column headings if required.
     C           BAPR      IFEQ 'Y'
     C                     WRITE$COLHDG
     C                     MOVEL*BLANK    BAPR
     C                     END
      * Convert fields to external form.
      * Print detail line.
     C                     WRITE$DTLRCD
     C                     END
      *================================================================
     CSR         CAEXIT    ENDSR
      /EJECT
     CSR         DALVCH    BEGSR
      *================================================================
      * Detect level changes.
      *================================================================
      * Clear all level breaks.
     C                     MOVEL*BLANK    L0               Page headings
     C                     MOVEL*BLANK    L1               Archive ID
     C                     MOVEL*BLANK    L2               Sequence Number
     C                     MOVEL*BLANK    L3               Report name
      * Clear heading length to print.
     C                     Z-ADD*ZERO     @$HDL
      *
      * End of file - Signal all level breaks.
     C           W0EOF     IFEQ '1'
     C                     MOVEL'Y'       L1
     C                     MOVEL'Y'       L2
     C                     MOVEL'Y'       L3
     C                     ELSE
     C           EBARID    IFNE WZARID                     Archive ID
      * Set on level break indicator.
     C                     MOVEL'Y'       L1
     C                     ADD  2         @$HDL
     C                     END
     C           EBRQSQ    IFNE WZRQSQ                     Sequence Number
     C           L1        OREQ 'Y'
      * Set on level break indicator.
     C                     MOVEL'Y'       L2
     C                     ADD  2         @$HDL
     C                     END
     C           EBRNAM    IFNE WZRNAM                     Report name
     C           L2        OREQ 'Y'
      * Set on level break indicator.
     C                     MOVEL'Y'       L3
     C                     ADD  2         @$HDL
     C                     END
      * Adjust for column headings.
     C           @$HDL     IFGT *ZERO
     C                     ADD  4         @$HDL
     C                     END
      *
     C                     END
      *================================================================
     CSR         DAEXIT    ENDSR
      /EJECT
     CSR         EAPRTT    BEGSR
      *================================================================
      * Print report Totals.
      *================================================================
      * Print level break totals as required
     C           L3        IFEQ 'Y'
      * User: Process Report name totals.
      * 00/Copy member XX0400PLT1 - Archive Contents(daily)  *
     C*Permanent Archives       Print Level Total 1
     C/COPY WNCPYSRC,MA0400PLT1
     C                     END
      *
     C           L2        IFEQ 'Y'
      * User: Process Sequence Number totals.
      * 00/Copy member XX0400PLT0 - Archive Contents(daily)  *
     C*Permanent Archives       Print Level Total 0
     C/COPY WNCPYSRC,MA0400PLT0
     C                     END
      *
     C           L1        IFEQ 'Y'
      * User: Process Archive ID totals.
      * 00?Copy member XX0400PLT2 - Archive Contents(daily)  *
     C*Permanent Archives       Print Level Total 2
     C/COPY WNCPYSRC,MA0400PLT2
     C                     END
      *
      * End of file - Print final totals.
     C           W0EOF     IFEQ '1'
      * USER: Process End of Report
      * 00/Copy member XX0400PPER - Archive Contents(daily)  *
     C*Permanent Archives       Process End Of Report
     C/COPY WNCPYSRC,MA0400PPER
     C                     END
      *
      *================================================================
     CSR         EAEXIT    ENDSR
      /EJECT
     CSR         FASGHD    BEGSR
      *================================================================
      * Signal required header formats.
      *================================================================
      * Cascade skip to new page requests upwards.
     C           L1        IFNE *BLANK
      * Request page headings.
     C                     MOVEL'Y'       L0
     C                     END
      *
     C           *IN97     IFNE '1'
     C           L0        ANDNE'Y'
      * Signal overflow if requested headings would cause
      * detail format to start past the overflow line.
     C           W0OFL     SUB  @$CLN     @$WRK
     C           @$WRK     IFLE @$HDL
     C                     SETON                     97
     C                     ELSE
      * Signal overflow if requested headings would cause
      * detail format to be printed past end of page
     C                     ADD  1         @$HDL
     C           W0PGL     SUB  @$CLN     @$WRK
     C           @$WRK     IFLE @$HDL
     C                     SETON                     97
     C                     END
     C                     END
     C                     END
      * Overflow detected.
     C           *IN97     IFEQ '1'
      * Request page headings.
     C                     MOVEL'Y'       L0
      * Request all formats which print on overflow.
     C                     SETOF                     97
     C                     END
      *================================================================
     CSR         FAEXIT    ENDSR
      /EJECT
     CSR         GARDRC    BEGSR
      *================================================================
      * Read next record with user selection.
      *================================================================
     C           W0RSL     DOUEQ'Y'
     C                     READ @EBREJR                  90*
     C                     MOVEL*IN90     W0EOF   1
      * Quit if no record read.
     C           W0EOF     CABEQ'1'       GAEXIT
      * Select record unless user action states otherwise.
     C                     MOVEL'Y'       W0RSL   1
      * USER: Record selection processing
      * 00/Copy member XX0400PRSP - Archive Contents(daily)  *
     C*Permanent Archives       Record Selection Proc.
     C/COPY WNCPYSRC,MA0400PRSP
     C                     END
      *================================================================
     CSR         GAEXIT    ENDSR
      /EJECT                                                              LN1093
     CSR         ZWDBER    BEGSR                                          LN1093
      *================================================================   LN1093
      * Database Error - Print Audit Report and Exit                      LN1093
      *================================================================   LN1093
     C                     OPEN MA0400AU                                  LN1093
     C                     Z-ADDSFNUMU    SFNUM1  60                      LN1093
     C                     CALL 'ZSFILE'                                  LN1093
     C                     PARM           P1RQSQ                          LN1093
     C                     PARM           P3ETTY                          LN1093
     C                     PARM           SFILEU                          LN1093
     C                     PARM SFNUM1    ZSFNO   60                      LN1093
     C                     PARM           PERR    1                       LN1093
     C                     WRITEDBERR                                     LN1093
     C                     SETON                     U7U8                 LN1093
     C                     EXSR ZXEXPG                                    LN1093
      *================================================================   LN1093
     CSR         ZWEXIT    ENDSR                                          LN1093
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program
      *================================================================
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct.
      *================================================================
      * Terminate program.
     C                     SETON                     LR
      *
      * Exit program.
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation.
      *================================================================
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
      * Setup job date/time.
     C                     Z-ADDUDATE     ##JDT            Job date.
     C                     TIME           ##JTM            Job time.
     C                     TIME           ##TME   60       Screen time.
     C* define LDA                                                        LN1093
     C           *NAMVAR   DEFN           LDA                             LN1093
      * Define work field run day number
     C                     Z-ADD*ZERO     WURUND  50
      * Define work field midas rundate
     C                     MOVEL*BLANK    WURUNA  7
      * Define work field Set Up Complete
     C                     MOVEL*BLANK    WUSSF   1
      * Define work field date format flag
     C                     MOVEL*BLANK    WUDATF  1
      * Define work field Multi-branching Indicator
     C                     MOVEL*BLANK    WUMBIN  1
      * Define work field Spool File No.(numeric)
     C                     Z-ADD*ZERO     WUAWNB  60
      * Define work field ZSFILE error
     C                     MOVEL*BLANK    WUAXST  1
     C                     MOVEL*BLANK    W0PFM   1
     C                     Z-ADD*ZERO     @$WRK   40
     C                     Z-ADD*ZERO     @$HDL   40
      * Define key list for FCRSFXL1                                      LN1093
     C           RSFXKY    KLIST                                          LN1093
     C                     KFLD           EBRNAM           report name    LN1093
     C                     KFLD           EBRSFX           print file nameLN1093
      * Adjust page length and overflow as necessary.
     C           @$PGL     SUB  2         W0PGL   40
     C           @$OFL     IFGE W0PGL
     C           W0PGL     SUB  2         W0OFL   40
     C                     ELSE
     C                     Z-ADD@$OFL     W0OFL
     C                     END
      * USER: Initialise program
      * Last Amd Hdr Box fc0400p - Archive Contents(daily)  *
      * get rundate - rundate  *
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
     C                     MOVE RUNA      ##RUNA
     C                     MOVE RUNA      WURUNA
     C                     MOVE RUND      WURUND
     C                     MOVE SSF       WUSSF
     C                     MOVE DATF      WUDATF
     C                     MOVE MBIN      WUMBIN
      * Copyright Statement - standard functions  *
     C                     MOVEACPY@      BIS@   80
      * Get Bank Title - standard functions  *                            LN1093
     C*                                                                   LN1093
     C** ACCESS BANK ICD FOR TITLE                                        LN1093
     C*                                                                   LN1093
     C                     CALL 'AOBANKR0'                   <BANK ICD>   LN1093
     C                     PARM '*MSG'    P@APRC  7          B:Return codeLN1093
     C                     PARM '*FIRST'  P@APOP  7          I:Option     LN1093
     C           D@BANK    PARM D@BANK    UUFDY              O:Rec.format LN1093
      * Bank ICD Access Program record format data structure              LN1093
     C           P@APRC    IFNE *BLANKS                                   LN1093
     C           *LOCK     IN   LDA                                       LN1093
     C                     MOVELP@APOP    DBKEY                           LN1093
     C                     MOVEL'SDBANKL1'DBFILE           ***************LN1093
     C                     Z-ADD3         DBASE            * DB ERROR 003*LN1093
     C                     MOVEL'MA0400P' DBPGM            ***************LN1093
     C                     OUT  LDA                                       LN1093
     C                     EXSR ZWDBER                                    LN1093
     C                     END                                            LN1093
      *                                                                   LN1093
     C                     MOVE BJURPT    ##TITL                          LN1093
      * Set Up Spool File Number - standard functions  *
     C                     Z-ADD@$FNB     WUAWNB
      * ZSFILE(Write Rpt Rqsts) - standard functions  *
     C                     CALL 'ZSFILE'               90  ZSFILE(Write Rp
     C                     PARM P1RQSQ    WQ0001  5        Sequence Number
     C                     PARM P3ETTY    WQ0002  3        Entity
     C                     PARM @CN,01    WQ0003 10        Spool File Name
     C                     PARM WUAWNB    WQ0004  60       Spool File No.(
     C           WUAXST    PARM *BLANK    WQ0005  1        ZSFILE error
      *
     C           *IN90     IFEQ '1'
      * Call to program ended in error.
     C                     MOVEL'Y2U0021' W0RTN   7
     C                     END
      *
      *CASE:     WRK.ZSFILE error is Error occured
     C           WUAXST    IFEQ @CN,02                     *IF
     C                     MOVEL@CN,03    P0RTN            *Return code
     C                     EXSR ZYEXPG
     C                     END                             *FI
      * 00/Copy member XX0400PFPG - Archive Contents(daily)  *
      * 00/Copy member XX0400PEPG - Archive Contents(daily)  *
      * 00/Copy member XX0400PIPG - Archive Contents(daily)  *
      * 00/Copy member XX0400PCPG - Archive Contents(daily)  *
     C*Permanent Archives       Initialise Program C-Spec
     C/COPY WNCPYSRC,MA0400PCPG
      * 00/Copy member XX0400POPG - Archive Contents(daily)  *
      *================================================================
     CSR         ZZEXIT    ENDSR
     O*Permanent Archives       Initialise Program O-Spec
     O/COPY WNCPYSRC,MA0400POPG
** CPY@
(c) Finastra International Limited 2001
** @CN Long constants used in program.
MA0400PM
Y
Y2U0004
