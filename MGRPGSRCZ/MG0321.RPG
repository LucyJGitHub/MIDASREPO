     H        1                           F
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MG Format secondary CD message')                 *
      *****************************************************************
      *                                                               *
      *  Midas - MESSAGE GENERATION                                   *
      *                                                               *
      *  MG0321 - FORMAT SECONDARY CERTIFICATE OF DEPOSIT             *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 255986             Date 29Aug08               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 27Oct03               *
      *                 222385             Date 23Oct03               *
      *                 221145             Date 08Sep03               *
      *                 219242             Date 01Jul03               *
      *                 219241             Date 01Jul03               *
      *                 CSD015             Date 14Oct02               *
      * Midas Release 4.01.01 ----------------------------------------*
      *                 CSW202             Date 20May02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSW025             Date 26Mar02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 197019             Date 02May01               *
      *                 183583             Date 11Jun01               *
      * Midas DBA 3.05 -----------------------------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 179792             Date 01Jun00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 141572             Date 21Sep98               *
     F*                 113352             DATE 13FEB97               *
     F*                 112798             DATE 30OCT97               *
     F*                 CSW096             DATE  3JUN96               *
     F*                 088544             DATE 20OCT95               *
     F*                 084320             DATE 07MAR95               *
     F*                 080096             DATE 12JAN95               *
     F*                 055058             DATE 19NOV93               *
     F*                 S01421             DATE 18AUG93               *
     F*                 E42086             DATE 10JLU92               *
     F*                 E40242             DATE 25JUN92               *
     F*                 E33129 (BH2648)    DATE 16DEC91               *
     F*                 E29588             DATE 29OCT91               *
     F*                                                               *
      *****************************************************************
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CLE148 - Alpha Loan Reference                                *
      *  255986 - Field 72 not appearing in MT320                     *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Parameter Mismatch.                                 *
      *  222385 - SWIFT msgs are Watch List checked regardless of     *
      *           configuration file setting                          *
      *  221145 - Compliance Watch WLC: Move compliance check to      *
      *           after COMIT to MGOMSGPD                             *
      *  219242 - Not possible to create MT103+ payment msg from      *
      *           non-FT transaction (Recompile)                      *
      *  219241 - Defaulting of "Details of Charges" assign a         *
      *           system value (Recompile)                            *
      *  CSD015 - Midas Compliance Watch - Watch List Checking        *
      *  CSW202 - SWIFT 2002 Standards Update                         *
      *  CSW025 - Midas Message Manager                               *
      *           - Pass original change type                         *
      *  197019 - Added parameter ZDBEI to ZM0050                     *
      *  183583 - Add extension file MGOEXTPD to store customer no.   *
      *           of field with SWIFT address.                        *
      *  CDL008 - Continuous Linked Settlement (Recompiled)           *
      *  179792 - Clarify hook names and add unique ones next to them.*
      *           Addition of core hook MG0321MKI1                    *
     F*  141572 - Setup CINDV (century flag) SVDT ( value date).      *
     F*  113352 - Set-up CIND (Century flag)  to correct year2000     *
     F*           display problem.                                    *
     F*  112798 - MTAGs 32R,32P, 34R, 34P set the wrong way round     *
     F*           for NAs.                                            *
     F*  CSW096 - SWIFT Changes November 1996.                        *
     F*           Add validation for field 22.                        *
     F*  088544 - Rename conflicting MGOREFL0 field TODY to resolve   *
     F*           enquiry problem.                                    *
     F*  084320 - Do not set on U7 for a non-fatal error, as this     *
     F*           will cause the controlling component to end         *
     F*           abnormally.                                         *
     F*  080096 - RECOMPILE BECAUSE COPY MEMBER MGCPYSRC,SWIFTTRANS   *
     F*           CHANGED                                             *
     F*  055058 - Move blank to CFPF before MGOREFPD record output.   *
     F*  S01421 - REPLACE THE SWIFT TRANSLATION TABLE WITH A          *
     F*           /COPY STATEMENT (SWIFTTRANS).                       *
     F*  E42086 - CATER FOR BLANK ADDRESS LINES                       *
     F*  E40242 - Recompiled due to changes to field ASEQ             *
     F*  E33129 - BROKER NAME COULD BE 3 OVER 35 LIMIT SO ADD         *
     F*           NEXT LINE FOR FIELD 72                              *
     F*  E29588 - POST COLLECTION SWIFT RATIONALISATION FIXES         *
     F*           o prevent a blank codeword for field 22             *
     F*                                                               *
     F*****************************************************************
     FMGF321PDUF  E                    DISK
     F                                              KCOMIT
     FMGOREFL0IF  E           K        DISK
     F            MGOREFD0                          KRENAMEMGREFL0
     FMGOREFPDO   E                    DISK
     F                                              KCOMIT
     FMGOMSGPDO   E                    DISK
     F                                              KCOMIT
     F/COPY WNCPYSRC,MG0321F001
     FMGOEXTPDO   E                    DISK                               183583
     F                                              KCOMIT                183583
     FMG0321P1O   E                    PRINTER                        UC
     FMG0321AUO   E                    PRINTER                        UC
      *
      ********************************************************************
      *
      * ID C  F  H  L    FUNCTION OF INDICATORS
      *
      *    10            EOF MGF321PD
      *    11            CHAIN to MGOREFL0 (TRN unique ?)
      *    15            Error in call to standard program (ZMxxxx)
      *    16            Error on delete of GDF record.
      *    19            LOKUP operation searching array (GNR, @WRK)
      *    20            LOKUP operation searching array (GNR, @WRK)
      *    21            LOKUP operation searching array (GNR)
      *    22            LOKUP operation for determining the codeword
      *    23            LOKUP operation for settlement code
      *    24            Error on call of MG5000
      *    25            CSW202 is intalled                                                   CSW202
      *    30            Feedback record not generated
      *    50            MG0321P1 open
      *    U7U8          Database error
      *
     F********************************************************************
     E                    CPY@    1   1 80               copyright
     E                    MSGA    1   8 60               message text
     E                    TABSLT  1  20 19               conds. for CWRD
     E                    TABRST  1  20  8               selected codeword
     E                    TABS96  1  16 19               conds. for CWRD  CSW096
     E                    TABR96  1  16  8               selected codewordCSW096
     E                    TABNST  1   5  2               settlement nostro
     E                    TABINT  1   5  2               settlemt internal
     E                    GNR        15  3               msg generated rel
     E                    @WRK       50  1               concatenate field
     E                    @BTB        6 35               Bank to Bank Info                    255986
      *
      **  Rename conflicting MGOREFL0 fields
      *
     IMGREFL0
     I              SYTM                            MSYTM
     I              NWRK                            MNWRK
     I              SECN                            MSECN
     I              NWSN                            MNWSN
     I              DECN                            MDECN
     I              NWDS                            MNWDS
     I              MGSG                            MMGSG
     I              MGST                            MMGST
     I              F57U                            MF57U
     I              LSCC                            MLSCC
     I              HRDT                            MHRDT
     I              MGDE                            MMGDE
     I              MGTM                            MMGTM
     I              LADT                            MLADT
     I              RELD                            MRELD
     I              RELT                            MRELT
     I              TODY                            MTODY                 088544
      *
     IMULT        DS                         40
     I                                        1   5 MTAG
     I                                        6  55 MFLD
     I                                       56 105 MERR
      **  Multiple occurrence data structure for message
      *
     IEXTN        DS                         20                           183583
     I                                        1   20MPSN                  183583
     I                                        3   7 MTG                   183583
     I                                        8  15 MCSI                  183583
      *                                                                   183583
      ** Multiple occurrence data structure for extension file            183583
      *                                                                   183583
     I            DS                                                      183583
     I                                        1   5 @MTG                  183583
     I                                        2   2 FLDTYP                183583
     I                                        4   4 FLDTAG                183583
      *                                                                   183583
      ** Field tag data structure                                         183583
      *                                                                   183583
     I@TRN        DS                         16
     I                                        1   2 @TR1
     I                                        3   8 @TR2
     I                                        9  110@TR3
     I                                       12  16 @TR4
      **  Data structure build transaction reference number
      *
     ISEARCH      DS                         19
     I                                        1   6 @MGST
     I                                        8  15 @LSCC
     I                                       17  17 @OF57
     I                                       19  19 @F57U
      **  Data structure to build key to determine codeword
      *
     IFLD3N       DS                         24
     I                                        1   6 ZSDATE
     I                                        7   9 ZSCCY
     I                                       10  24 ZSAMNT
      **  Data structure containing codeword for Fields 32n/34n
      *
     IERR3N       DS                         24
     I                                        1   3 ZCCY
     I                                        5  17 ZAMT
      **  Erroneous currency & amounts for Fields 32R/33P
      *
     I@MTAG       DS                          5
     I                                        1   1 COLON1
     I                                        2   3 FLDNO
     I                                        4   4 TAG
     I                                        5   5 COLON2
      **  Data structure constructing message field tag
      *
     IP@IN        DS                            256                       CSW096
     I                                        1   3 I@SNBR                CSW096
     I                                        4   9 I@DSCN                CSW096
     I                                       10  12 I@MTPY                CSW096
     I                                       13  140I@SETT                CSW096
     I                                       15  15 I@CONC                CSW096
     I                                       16  16 I@FTCS                CSW096
     I                                       17  18 I@MMOD                CSW096
      ** Data structure for input parameter                               CSW096
      *                                                                   CSW096
     IP@OUT       DS                            256                       CSW096
     I**********                              1   60O@CNSN                             CSW096 CSD027
     I                                        1   6 O@CNSN                                    CSD027
     I                                        7  18 O@SWSN                CSW096
     I                                       19  38 O@NWSN                CSW096
     I                                       39  49 O@SWDS                CSW096
     I                                       46  46 W@96CN                CSW096
     I                                       47  49 W@BIC                 CSW096
     I                                       50  69 O@NWDS                CSW096
     I                                       70  75 O@NWRK                CSW096
     I                                       76  76 O@MGSG                CSW096
     I                                       77  80 O@MGST                CSW096
     I                                       81  81 O@PAIN                CSW096
     I                                       82  87 O@PCNB                CSW096
     I                                       88  90 O@SPRS                CSW096
      ** Data structure for ouput parameter                               CSW096
      *
     ISDBANK    E DSSDBANKPD
      **  Data structure for bank file
      *
     ISDTRAD    E DSSDTRADPD
      **  Data structure for trading file
      *
     ISDCUST    E DSSDCUSTPD
      **  Data structure for customer file
      *
     ISDBRCH    E DSSDBRCHPD
     I              QQDFAC                          DFACQQ                                    CGL029
      **  Data structure for branch file
      *
     ISDBROK    E DSSDBROKPD
      **  Data structure for broker file
      *
     ISDMMOD    E DSSDMMODPD
      **  Data structure for module ICD file
      *
     ISDNOST    E DSSDNOSTPD
     I              QQACCD                          ACCDQQ                                    CGL029
      **  Data structure for nostro file
      *
     ISDMGME    E DSSDMGMEPD
      **  Data structure for message management data.
      *
     ISCSARD    E DSSCSARDPD                                                                  CSD015
      ** Switchable Features Data Structure                                                   CSD015
      *                                                                                       CSD015
     IWLTDS     E DSSDWLTOPD                                                                  CSD015
      ** Watch List Transaction Details Data Structure                                        CSD015
      *                                                                                       CSD015
     IPSTRNG      DS                           9999                                           CSD015
      ** SDWLCLOP Search String Parameter                                                     CSD015
      *                                                                                       CSD015
     ISDWLCC    E DSSDWLCCPD                                                                  222385
      ** Watch list checking details                                                          222385
      *                                                                                       222385
     IDSFDY     E DSDSFDY
      **  Short data structure for access programs
      *
     IDSSDY     E DSDSSDY
      **  Long data structure for access programs
      *
     ILDA         DS                            256
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
      **  Local data area
      *
     C/EJECT
      *****************************************************************
      *                   Index to subroutines                        *
      *   main process                                                *
      *   INIT  - Initial process                                     *
      *   INTF  - Initialise non-constant fields                      *
      ****ROUT**-*Determine*message*routing****************************   CSW096
      * SRROUT  - Determine message routing                           *   CSW096
      ****FILL**-*Fill*up*arrays*NGP*and*GNR***************************   CSW096
      *   FMTM  - Format message detail                               *
      *   CODE  - Calculate codeword for fields 21/22                 *
      *   FMT3N - Format date fields                                  *
      *   NAP57 - N/A purchase format of field 57                     *
      *   NAS57 - N/A sold format of field 57                         *
      *   FLD72 - Calculate field 72                                  *
      *   FSWAD - Format SWIFT address                                *
      *   REPT  - Print incorrectly generated messages                *
      *   OMSG  - Output correctly generated messages                 *
      *   WREF  - Write reference record to PF/MGOREFPD               *
      *   *PSSR - Error handling                                      *
      *                                                               *
      *   NOTE:   A multiple occurrence data structure is used to     *
      *           store up the records that make up the SWIFT message *
      *           before writing the whole message to file.           *
      *           To store the records of the message, you must       *
      *           first access an OCUR record, obtain the Message Tag *
      *           & Message field data values for this OCUR record,   *
      *           then go on to the next OCUR record and continue     *
      *           this process until the SWIFT message is complete.   *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *  Main Process                                                 *
      *  Calls  -  INIT  initial processing                           *
      *            INTF  initialise non-constant fields               *
      *************ROUT**determine*message*routing*********************   CSW096
      *            SRROUT  determine message routing                  *   CSW096
      *            FMTM  format message details                       *
      *            REPT  print incorrectly generated message          *
      *            OMSG  output correctly generated message           *
      *****************************************************************
      *
      ** Initial process
     C                     EXSR INIT
      *
      ** Read the first record from the MT321 extract file
      *
     C                     READ MGF321PD                 10
      *
      ** Do While records found on the MT321 extract file
      *
     C           *IN10     DOWEQ'0'
      *
      ** Initialise non-constant fields
     C                     EXSR INTF
      *
      ** Determine message routing
     C***********          EXSR ROUT                                      CSW096
     C                     EXSR SRROUT                                    CSW096
      *
      ** Format message detail
     C                     EXSR FMTM
      *
      ** Print incorrectly generated message
     C           @ERR      IFEQ 'Y'
     C                     EXSR REPT
     C                     ELSE
      *
      ** Output correctly generated message
     C                     EXSR OMSG
      *
      ** If confirmation matching switched on, generate feedback record
      **  (at present only produced for dealing)
      *
     C           BGCFMT    IFEQ 'Y'
     C           MGMODI    ANDEQ'DL'
     C                     EXSR CFMAT
     C                     END
      *
     C                     END
      *
      ** Delete the processed GDF record.
      *
     C                     DELETMGF321PD               16
      *
      **  Error on delete of record.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '020'     DBASE            * * * * * * * *
     C                     MOVELMGTNUM    DBKEY            *  DBERR 020  *
     C                     MOVEL'MGF321PD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Update sequence numbers on transaction record
      **  if no errors have occurred
      *
     C           @ERR      IFNE 'Y'
     C                     CALL 'MG5000'               24
     C                     PARM MGMODI    @MODI   2
     C                     PARM MGTNUM    @TRAN  15
     C                     PARM 'CE'      @PROG   2
     C                     PARM 'U'       @MODE   1
     C                     PARM *ZEROS    MGLSWC  30
     C                     PARM *ZEROS    MGLSWS  30
     C                     PARM *BLANKS   @ERCD   1
      *
      **  Error on access for sequence number
     C           @ERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Program missing on call
     C           *IN24     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '021'     DBASE            * * * * * * * *
     C                     MOVE 'MG5000'  DBKEY            *  DBERR 021  *
     C                     OUT  LDA                        * * * * * * * *
     C                     EXSR *PSSR
     C                     END
      *
     C                     END
     C           *LOCK     IN   LDA
     C                     MOVEL'MG0321  'DBPGM
     C                     OUT  LDA
      *
      **  COMIT all changes since no error on writing the message
      *
     C                     COMIT
      *                                                                   221145
      **  Call Compliance Watch:Watch List Checking                       221145
      *                                                                   221145
     C           CSD015    IFEQ 'Y'                                       221145
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDEQ'N'                                       221145
     C                     EXSR WLCDQ                                     221145
     C                     ENDIF                                          221145
      *
      ** Read next MT321 extract record
     C                     READ MGF321PD                 10
      *
     C                     END
      *
      **  Write end of report, only if printer file open
      *
     C           *IN50     IFEQ '1'
     C                     WRITEEOREPT
     C                     END
     C/COPY WNCPYSRC,MG0321C003
      *
     C                     SETON                     LR
     C/EJECT
      *****************************************************************
      *   INIT - inital process                                       *
      *   Called by - main process                                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           INIT      BEGSR
      *
     C                     MOVEACPY@      BIS@   80
      *
      **  Set up LDA
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVEL'MG0321'  DBPGM
     C                     MOVE *BLANKS   DBASE
     C                     OUT  LDA
      *
      **  Access SDBANKPD for report title
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           @RTCD     IFNE *BLANKS                               1
     C           *LOCK     IN   LDA
     C                     MOVE '001'     DBASE            * * * * * * * *
     C                     MOVEL'FIRST'   DBKEY            *  DBERR 001  *
     C                     MOVEL'SDBANKPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Access SDTRADPD for trading information
      *
     C                     CALL 'AOTRADR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDTRAD    PARM SDTRAD    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '002'     DBASE            * * * * * * * *
     C                     MOVEL'FIRST'   DBKEY            *  DBERR 002  *
     C                     MOVEL'SDTRADPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Access SDMMODPD for modules available
     C                     CALL 'AOMMODR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '003'     DBASE            * * * * * * * *
     C                     MOVEL'FIRST'   DBKEY            *  DBERR 003  *
     C                     MOVEL'SDMMODPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Access SDMGMEPD for message management data.
      *
     C                     CALL 'AOMGMER0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDMGME    PARM SDMGME    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '004'     DBASE            * * * * * * * *
     C                     MOVEL'FIRST'   DBKEY            *  DBERR 004  *
     C                     MOVEL'SDMGMEPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C/COPY WNCPYSRC,MG0321C007
      *
      **  Initialise constant fields
     C                     MOVE *LOVAL    CR      1
     C                     BITON'457'     CR
     C                     MOVE *LOVAL    LF      1
     C                     BITON'257'     LF
     C                     MOVELCR        CRLF    2
     C                     MOVE LF        CRLF
     C                     MOVE *BLANKS   @TR4
     C                     MOVE ':'       COLON1
     C                     MOVE ':'       COLON2
      *
      **  CRLF Control Character for message data records
     C                     MOVE CRLF      CTRC
      *
      **  Convert run date to YYMMDD, for Message Generation Date
     C                     CALL 'ZM0060'               15
     C                     PARM BJRDNB    ZMDAY   50
     C                     PARM           ZMDATE  6
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '005'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 005  *
     C                     MOVEL'ZM0060'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     MOVE ZMDATE    MGDE
      *                                                                   113352
      ** Set-up Message Generation  Century flag                          113352
      *                                                                   113352
     C                     MOVELMGDE      YY      20                      113352
     C           YY        IFLT 72                                        113352
     C                     MOVE '2'       CIND                            113352
     C                     ELSE                                           113352
     C                     MOVE '1'       CIND                            113352
     C                     ENDIF                                          113352
      *
      **  Convert history retention date to YYMMDD
     C           BJRDNB    ADD  ENDSMN    ZMDAY
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY
     C                     PARM           ZMDATE
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '006'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 006  *
     C                     MOVEL'ZM0060'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     MOVE ZMDATE    @HRDT   6
      *                                                                   CSW096
      **  Check if SWIFT Changes 1996 (CSW096) is installed               CSW096
      *                                                                   CSW096
     C                     CALL 'SWIFT96'                                 CSW096
     C                     PARM *BLANKS   @RTCD   7                       CSW096
      *                                                                   CSW096
     C           @RTCD     IFEQ 'CSW096'                                  CSW096
     C                     MOVE 'Y'       CSW096  1                       CSW096
     C                     ELSE                                           CSW096
     C                     MOVE 'N'       CSW096                          CSW096
     C                     ENDIF                                          CSW096
      *                                                                                       CSD015
      ** Check if CSD015 is enabled.                                                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD   7                                           CSD015
     C                     PARM '*VERIFY' POPTN   7                                           CSD015
     C                     PARM 'CSD015'  PSARN   6                                           CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSD015  1                                           CSD015
     C                     MOVEL'N'       W1EWLC                                              222385
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSD015                                              CSD015
      *                                                                                       222385
      ** Access AOWLCCR0 to check if function code MESSGENT is available                      222385
      *                                                                                       222385
     C                     CALL 'AOWLCCR0'                                                    222385
     C                     PARM *BLANKS   PRTCD                                               222385
     C                     PARM '*KEY'    POPTN                                               222385
     C                     PARM 'MESSGENT'PFUNC   8                                           222385
     C           SDWLCC    PARM SDWLCC    DSFDY                                               222385
      *                                                                                       222385
     C           PRTCD     IFNE *BLANKS                                                       222385
     C           PRTCD     ANDNE'*NRF'                                                        222385
     C                     MOVEL'SDWLCCPD'DBFILE                                              222385
     C                     MOVELPFUNC     DBKEY                                               222385
     C                     Z-ADD32        DBASE                                               222385
     C                     EXSR *PSSR                                                         222385
     C                     ENDIF                                                              222385
      *                                                                                       222385
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE '*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVELPSARN     DBKEY                                               CSD015
     C                     Z-ADD25        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if CSW025 is enabled.                                                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*VERIFY' POPTN                                               CSD015
     C                     PARM 'CSW025'  PSARN                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSW025  1                                           CSD015
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSW025                                              CSD015
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE '*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVELPSARN     DBKEY                                               CSD015
     C                     Z-ADD26        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      *                                                                                       CSW202
      ** Check if CSW202 is installed                                                         CSW202
      *                                                                                       CSW202
     C                     CALL 'SWIF2002'                                                    CSW202
     C                     PARM *BLANKS   PRTCD   7                                           CSW202
      *                                                                                       CSW202
     C           PRTCD     IFEQ 'CSW2002'                                                     CSW202
     C                     MOVE 'Y'       CSW202  1                                           CSW202
     C                     MOVE *ON       *IN25                                               CSW202
     C                     ELSE                                                               CSW202
     C                     MOVE 'N'       CSW202                                              CSW202
     C                     MOVE *OFF      *IN25                                               CSW202
     C                     ENDIF                                                              CSW202
     C/COPY WNCPYSRC,MG0321C004
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   INTF - Initalise non-constant fields                        *
      *   Called by - main process                                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           INTF      BEGSR
      *
     C                     MOVE *BLANKS   TRNO
     C                     MOVE '      '  NWRK
     C**********           Z-ADD0         SECN                                                CSD027
     C                     MOVE *BLANKS   SECN                                                CSD027
     C                     MOVE *BLANKS   NWSN
     C**********           Z-ADD0         DECN                                                CSD027
     C                     MOVE *BLANKS   DECN                                                CSD027
     C                     MOVE *BLANKS   MTRN
     C                     MOVE *BLANKS   NWDS
     C                     MOVE *BLANKS   MGSG
     C                     MOVE *BLANKS   MGST
     C                     MOVE *BLANKS   LSCC
     C                     MOVE *BLANKS   F57U
     C                     Z-ADD0         MGTM
     C                     Z-ADD0         LATM
     C                     MOVE *BLANKS   RELD
     C                     Z-ADD0         RELT
     C                     MOVE *BLANKS   AMTS
     C                     MOVE *BLANKS   SVDT
     C                     MOVE *BLANKS   CINDV                           141572
      *
     C                     MOVE *BLANKS   @TRN
     C                     MOVE *BLANKS   @ERR    1
      *
      **  Clear multiple occurrence data structure
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
      *
     C           X         DOWLE40
     C           MULT      ANDNE*BLANKS
     C                     MOVE *BLANKS   MULT
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END
      *                                                                   183583
      ** Clear multiple occurrence DS for the extension file.             183583
      *                                                                   183583
     C                     Z-ADD1         V       20                      183583
     C           V         OCUR EXTN                                      183583
     C           V         DOWLE10                                        183583
     C           MCSI      ANDNE*BLANKS                                   183583
     C                     Z-ADD*ZEROS    MPSN                            183583
     C                     MOVE *BLANKS   MTG                             183583
     C                     MOVE *BLANKS   MCSI                            183583
     C                     ADD  1         V                               183583
     C           V         OCUR EXTN                                      183583
     C                     ENDDO                                          183583
     C                     Z-ADD0         V                               183583
      *
      *
      **  Obtain sequence numbers from transaction record
     C                     CALL 'MG5000'               24
     C                     PARM MGMODI    @MODI   2
     C                     PARM MGTNUM    @TRAN  15
     C                     PARM 'CE'      @PROG   2
     C                     PARM *BLANKS   @MODE   1
     C                     PARM *ZEROS    MGLSWC  30
     C                     PARM *ZEROS    MGLSWS  30
     C                     PARM *BLANKS   @ERCD   1
      *
      **  Error on access for sequence number
     C           @ERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Program missing on call
     C           *IN24     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '007'     DBASE            * * * * * * * *
     C                     MOVE 'MG5000'  DBKEY            *  DBERR 007  *
     C                     OUT  LDA                        * * * * * * * *
     C                     EXSR *PSSR
     C                     END
     C           *LOCK     IN   LDA
     C                     MOVEL'MG0321  'DBPGM
     C                     OUT  LDA
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      ****ROUT*-*determine*message*routing*****************************   CSW096
      ****Called*by*-*main*process*************************************   CSW096
      ****Calls*-*FILL**fill*up*arrays*NGP*and*GNR*********************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********ROUT      BEGSR                                          CSW096
      ***********                                                         CSW096
      ****Access*SDCUSTPD*using*destination*customer*number***************CSW096
     C***********          MOVELMGCNUM    DECN                            CSW096
     C***********          MOVE *BLANKS   @KEY1                           CSW096
     C***********          MOVELMGCNUM    @KEY1                           CSW096
     C***********          CALL 'AOCUSTR0'                                CSW096
     C***********          PARM '*MSG   ' @RTCD                           CSW096
     C***********          PARM '*KEY   ' @OPTN                           CSW096
     C***********          PARM           @KEY1  10                       CSW096
     C***********          PARM *BLANKS   @KYST   7                       CSW096
     C***********SDCUST    PARM SDCUST    DSSDY                           CSW096
      ****Error***********************************************************CSW096
     C***********          MOVE *BLANKS   DSERR  50                       CSW096
     C***********@RTCD     IFNE *BLANKS                                   CSW096
     C***********          MOVE 'Y'       @ERR                            CSW096
     C***********          MOVELMSGA,2    DSERR  50                       CSW096
      ***********                                                         CSW096
     C***********          ELSE                                           CSW096
      ***********                                                         CSW096
      ****Fill*up*the*appropriate*array*information*from*PF/SDCUSTPD******CSW096
     C***********          EXSR FILL                                      CSW096
      ***********                                                         CSW096
      ****Is*default*status*for*MT321*messages*released*?*****************CSW096
     C***********'321'     LOKUPGNR                      19               CSW096
     C***********'32*'     LOKUPGNR                      20               CSW096
     C***********'3**'     LOKUPGNR                      21               CSW096
      ***********                                                         CSW096
     C************IN19     IFEQ '1'                                       CSW096
     C************IN20     OREQ '1'                                       CSW096
     C************IN21     OREQ '1'                                       CSW096
     C***********          MOVE 'RSND'    MGST                            CSW096
     C***********          MOVE '2'       MGSG                            CSW096
     C***********          ELSE                                           CSW096
     C***********          MOVE 'CRTD'    MGST                            CSW096
     C***********          MOVE '1'       MGSG                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Access*SDBRCHPD*using*branch*code*******************************CSW096
     C***********          CALL 'AOBRCHR0'                                CSW096
     C***********          PARM '*MSG   ' @RTCD                           CSW096
     C***********          PARM '*KEY   ' @OPTN                           CSW096
     C***********          PARM MGBRCA    @BRCD   3                       CSW096
     C***********SDBRCH    PARM SDBRCH    DSSDY                           CSW096
      ***********                                                         CSW096
      ***Branch*record*not*found*-*Error**********************************CSW096
     C***********@RTCD     IFNE *BLANKS                                   CSW096
     C************LOCK     IN   LDA                                       CSW096
     C***********          MOVE '008'     DBASE            * * * * * * * *CSW096
     C***********          MOVELMGBRCA    DBKEY            *  DBERR 008  *CSW096
     C***********          MOVEL'SDBRCHPD'DBFILE           * * * * * * * *CSW096
     C***********          OUT  LDA                                       CSW096
     C***********          EXSR *PSSR                                     CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      *****customer*number*of*sender**************************************CSW096
     C***********          MOVELA8BICN    SECN                            CSW096
      ***********                                                         CSW096
      ****Telex*interface*available***************************************CSW096
      ***********                                                         CSW096
     C***********BGMTMI    IFEQ 'Y'                                       CSW096
      ***********                                                         CSW096
      ****Default*network*is*Telex*&**************************************CSW096
      ****Telex*id*for*destination*customer*non-blank*********************CSW096
      ***********                                                         CSW096
     C***********BBDNW3    IFEQ 'TELEX'                                   CSW096
     C***********BBTXA1    ANDNE*BLANKS                                   CSW096
      ***********                                                         CSW096
      ****Destination*customer*address*(telex)****************************CSW096
     C***********          MOVELBBTXA1    NWDS                            CSW096
      ***********                                                         CSW096
      ****Access*SDCUSTPD*using*branch*internal*customer*number***********CSW096
     C***********          MOVE *BLANKS   @KEY1                           CSW096
     C***********          MOVELSECN      @KEY1                           CSW096
     C***********          CALL 'AOCUSTR0'                                CSW096
     C***********          PARM '*MSG   ' @RTCD                           CSW096
     C***********          PARM '*KEY   ' @OPTN                           CSW096
     C***********          PARM           @KEY1  10                       CSW096
     C***********          PARM *BLANKS   @KYST   7                       CSW096
     C***********SDCUST    PARM SDCUST    DSSDY                           CSW096
      ***********                                                         CSW096
      ***Customer*record*not*found*-*Error********************************CSW096
     C***********@RTCD     IFNE *BLANKS                                   CSW096
     C************LOCK     IN   LDA                                       CSW096
     C***********          MOVE '009'     DBASE            * * * * * * * *CSW096
     C***********          MOVEL@KEY1     DBKEY            *  DBERR 009  *CSW096
     C***********          MOVEL'SDCUSTPD'DBFILE           * * * * * * * *CSW096
     C***********          OUT  LDA                                       CSW096
     C***********          EXSR *PSSR                                     CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Senders*address*&*network***************************************CSW096
     C***********          MOVELBBTXA1    NWSN                            CSW096
     C***********          MOVEL'TELEX'   NWRK                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Network*or*Senders*address*blank*-*route*through*paper**********CSW096
      ***********                                                         CSW096
     C***********NWRK      IFEQ *BLANKS                                   CSW096
     C***********NWSN      OREQ *BLANKS                                   CSW096
      ***********                                                         CSW096
      ****Network*is*paper************************************************CSW096
     C***********          MOVE 'PAPER '  NWRK                            CSW096
      ***********                                                         CSW096
      ****If*the*ICD*option*for*free*format*confirmations*is*'Y'**********CSW096
      ****the*message*has*already*been*printed*,*hence*no*further*********CSW096
      ****print*out*is*needed.********************************************CSW096
     C***********ENFFCR    IFEQ 'Y'                                       CSW096
     C***********          MOVEL'PRTD'    MGST                            CSW096
     C***********          MOVE '3'       MGSG                            CSW096
     C***********          ELSE                                           CSW096
     C***********          MOVEL'RSND'    MGST                            CSW096
     C***********          MOVE '2'       MGSG                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****If*no*customer*error*then*output*the*address********************CSW096
     C***********DSERR     IFEQ *BLANKS                                   CSW096
     C***********          MOVELBBCRNM    NWDS                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Access*SDCUSTPD*using*branch*internal*customer*number***********CSW096
     C***********          MOVE *BLANKS   @KEY1                           CSW096
     C***********          MOVELSECN      @KEY1                           CSW096
     C***********          CALL 'AOCUSTR0'                                CSW096
     C***********          PARM '*MSG   ' @RTCD                           CSW096
     C***********          PARM '*KEY   ' @OPTN                           CSW096
     C***********          PARM           @KEY1  10                       CSW096
     C***********          PARM *BLANKS   @KYST   7                       CSW096
     C***********SDCUST    PARM SDCUST    DSSDY                           CSW096
      ***********                                                         CSW096
      ***Customer*record*not*found*-*Error********************************CSW096
     C***********@RTCD     IFNE *BLANKS                                   CSW096
     C************LOCK     IN   LDA                                       CSW096
     C***********          MOVE '010'     DBASE            * * * * * * * *CSW096
     C***********          MOVEL@KEY1     DBKEY            *  DBERR 010  *CSW096
     C***********          MOVEL'SDCUSTPD'DBFILE           * * * * * * * *CSW096
     C***********          OUT  LDA                                       CSW096
     C***********          EXSR *PSSR                                     CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Senders*address*defaults*to*report*name*************************CSW096
     C***********          MOVELBBCRNM    NWSN                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          ENDSR                                          CSW096
     C/EJECT                                                              CSW096
      *****************************************************************   CSW096
      *   SRROUT - determine message routing                          *   CSW096
      *   Called by - main process                                    *   CSW096
      *   Calls -                                                     *   CSW096
      *****************************************************************   CSW096
      *                                                                   CSW096
     C           SRROUT    BEGSR                                          CSW096
      *                                                                   CSW096
     C                     MOVE MGBRCA    I@SNBR                          CSW096
     C                     MOVE *BLANKS   I@DSCN                          CSW096
     C                     MOVE MGCNUM    I@DSCN                          CSW096
     C                     MOVE '321'     I@MTPY                          CSW096
     C                     MOVE 'N'       I@CONC                          CSW096
     C                     Z-ADD0         I@SETT                          CSW096
     C                     MOVE *BLANK    I@FTCS                          CSW096
     C                     MOVE MGMODI    I@MMOD                          CSW096
      *                                                                                       CSW202
     C           CSW202    IFEQ 'Y'                                                           CSW202
     C                     MOVE '322'     I@MTPY                                              CSW202
     C                     ENDIF                                                              CSW202
      *                                                                   CSW096
      *###################################################################CSW096
      *                                                                  #CSW096
      * Below are two copy sources intended for setting up the custom    #CSW096
      * parameter (P@ZZ) in the call to MG9900.                          #CSW096
      * One (MG9900CALL) is in ALL MG generation programs and is for use #CSW096
      * when a change is required to all of them.                        #CSW096
      * The*other*is*only*in*this*program**********                #CSW096179792
     C/COPY WNCPYSRC,MG9900CALL                                          #CSW096
      *                                                                   179792
      * The other (FT0640ROUT) is also to be found in other MG programs.  179792
     C/COPY WNCPYSRC,FT0640ROUT                                          #CSW096
      *                                                                   179792
      * But this'un (MG0321MKI1) is only in this program.                 179792
     C/COPY WNCPYSRC,MG0321MKI1                                           179792
      *                                                                  #CSW096
      *###################################################################CSW096
      *                                                                   CSW096
     C*********************CALL 'MG9900'                            CSW096CSW036
     C                     CALL 'MG9901'                                  CSW036
     C                     PARM *BLANKS   @RTCD                           CSW096
     C                     PARM           P@IN                            CSW096
     C                     PARM *BLANKS   P@OUT                           CSW096
     C                     PARM           P@ZZ  256                       CSW096
      *                                                                   CSW096
     C           @RTCD     IFNE *BLANKS                                   CSW096
     C           *LOCK     IN   LDA                                       CSW096
     C                     MOVE '092'     DBASE              * * * * * * *CSW096
     C                     MOVEL'*CALL  ' DBKEY              * DBERR 092 *CSW096
     C*********************MOVEL'MG9900'  DBFILE             * * * * * * *CSW096CSW036
     C                     MOVEL'MG9901'  DBFILE             * * * * * * *CSW036
     C                     OUT  LDA                                       CSW096
     C                     EXSR *PSSR                                     CSW096
     C                     ELSE                                           CSW096
     C                     MOVE O@NWRK    NWRK                            CSW096
     C**********           Z-ADDO@CNSN    SECN                                         CSW096 CSD027
     C                     MOVE O@CNSN    SECN                                                CSD027
     C                     MOVE O@NWSN    NWSN                            CSW096
     C**********           Z-ADDMGCNUM    DECN                                         CSW096 CSD027
     C                     MOVE MGCNUM    DECN                                                CSD027
     C/COPY WNCPYSRC,MG0321C008
     C                     MOVE O@NWDS    NWDS                            CSW096
     C                     MOVE O@MGSG    MGSG                            CSW096
     C                     MOVE O@MGST    MGST                            CSW096
     C                     END                                            CSW096
      *                                                                   CSW096
     C                     ENDSR                                          CSW096
     C/EJECT                                                              CSW096
      *****************************************************************   CSW096
      ****FILL*-*Fill*up*arrays*GNR************************************   CSW096
      ****Called*by*-*ROUT**determine*message*routing******************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********FILL      BEGSR                                          CSW096
      ***********                                                         CSW096
      ****Is*message*to*be*generated*as*released*?************************CSW096
     C***********          MOVE BBDS01    GNR,1                           CSW096
     C***********          MOVE BBDS02    GNR,2                           CSW096
     C***********          MOVE BBDS03    GNR,3                           CSW096
     C***********          MOVE BBDS04    GNR,4                           CSW096
     C***********          MOVE BBDS05    GNR,5                           CSW096
     C***********          MOVE BBDS06    GNR,6                           CSW096
     C***********          MOVE BBDS07    GNR,7                           CSW096
     C***********          MOVE BBDS08    GNR,8                           CSW096
     C***********          MOVE BBDS09    GNR,9                           CSW096
     C***********          MOVE BBDS10    GNR,10                          CSW096
     C***********          MOVE BBDS11    GNR,11                          CSW096
     C***********          MOVE BBDS12    GNR,12                          CSW096
     C***********          MOVE BBDS13    GNR,13                          CSW096
     C***********          MOVE BBDS14    GNR,14                          CSW096
     C***********          MOVE BBDS15    GNR,15                          CSW096
      ***********                                                         CSW096
     C***********          ENDSR                                          CSW096
     C/EJECT
      *****************************************************************
      *   FMTM - Format message detail                                *
      *   Called by - main process                                    *
      *   Calls     - CODE   determine codeword                       *
      *               FMT3N  format date fields                       *
      *               NAP57  N/A purchased format of field 57         *
      *               NAS57  N/A sold format of field 57              *
      *               FLD72  format field 72                          *
      *****************************************************************
      *
     C           FMTM      BEGSR
      *
      **  Field :20:  Transaction reference number
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
     C                     MOVE MGMODI    @TR1
     C                     MOVELMGTNUM    @TR2
     C           MGLSWS    ADD  1         @TR3
     C                     MOVE ':20: '   MTAG
     C                     MOVEL@TRN      MFLD
      *
      **  Store the TRN of the new confirmation message
     C                     MOVEL@TRN      @TRNO  16
      *
      **  Determine if the TRN is unique
      *
     C           @TRNO     CHAINMGREFL0              11
      *
      **  Cannot have duplicate keys, hence error
     C           *IN11     IFEQ '0'
     C                     MOVELMSGA,8    MERR
     C                     MOVE 'Y'       @ERR
     C                     END
      *
      **  Field :21:  Related reference
     C                     ADD  1         X
     C           X         OCUR MULT
      *
      **  Determine the message codeword
     C                     EXSR CODE
     C           CWRD      IFEQ 'NEW'
     C                     MOVEL'NEW'     MFLD
      *
     C                     ELSE
     C                     MOVE MGLSWC    @TR3
     C                     MOVEL@TRN      MFLD
     C                     END
      *
     C                     MOVE ':21: '   MTAG
      *
      **  Field :22:  Code/Common reference
     C                     ADD  1         X
     C           X         OCUR MULT
      *
      ** Construct Field 22  'codeword/common reference'
     C                     MOVE ':22: '   MTAG
      *                                                                   CSW096
     C                     MOVE *BLANKS   ZCREF                           CSW096
      *                                                                   CSW096
     C           O@SWSN    IFNE *BLANKS                                   CSW096
     C           O@SWDS    ANDNE*BLANKS                                   CSW096
      *                                                                   CSW096
     C                     MOVE MGYRAT    ZRATE                           CSW096
     C                     MOVELO@SWSN    ZSSWI                           CSW096
     C                     MOVELO@SWDS    ZDSWI                           CSW096
      *                                                                   CSW096
      **  Format SWIFT common reference                                   CSW096
      *                                                                   CSW096
     C                     CALL 'ZM0020'               15                 CSW096
     C                     PARM           ZSSWI  12                       CSW096
     C                     PARM           ZDSWI  12                       CSW096
     C                     PARM           ZRATE  138                      CSW096
     C                     PARM           ZCREF  16                       CSW096
      *                                                                   CSW096
     C           *IN15     IFEQ '1'                                       CSW096
     C           *LOCK     IN   LDA                                       CSW096
     C                     MOVE '010'     DBASE            * * * * * * * *CSW096
     C                     MOVEL'       ' DBKEY            *  DBERR 010  *CSW096
     C                     MOVEL'ZM0020'  DBFILE           * * * * * * * *CSW096
     C                     OUT  LDA                                       CSW096
     C                     EXSR *PSSR                                     CSW096
     C                     ENDIF                                          CSW096
      *                                                                   CSW096
     C                     ENDIF                                          CSW096
      *
      **  If change type indicates reversal, codeword equals 'CANCEL'
      *
     C           MGCHTP    IFEQ 'C'
     C                     MOVEL'CANCEL  'CWRD
     C                     END
     C                     Z-ADD1         I       20
     C                     MOVEA*BLANKS   @WRK
     C                     MOVEACWRD      @WRK,I
     C           ' '       LOKUP@WRK,I                   20
      *
     C                     MOVEA'/'       @WRK,I
     C                     ADD  1         I
     C           ZCREF     IFEQ *BLANKS                                   CSW096
     C                     MOVEA@TRNO     @WRK,I
     C                     ELSE                                           CSW096
     C                     MOVEAZCREF     @WRK,I                          CSW096
     C                     ENDIF                                          CSW096
     C                     MOVEA@WRK      MFLD
      *
      **  Codeword blank then error
     C           CWRD      IFEQ *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     MOVEAMSGA,7    MERR
     C                     END
      *
      **  Fields :3n :  Date fields
      *
     C                     EXSR FMT3N
      *
      **  Field 37 - Interest field.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE MGNIDT    ZMDAY
     C                     MOVE MGMDAT    ZMDAT
      *
     C                     MOVE *BLANKS   ZSF72
     C                     MOVELMGYRAT    ZINRT
     C                     MOVE MGNIDT    ZINPD
     C                     MOVE MGIPFR    ZINFC
     C                     MOVE MGICBS    ZCALC
     C                     CALL 'ZM0070'               15
     C                     PARM           ZINRT  117
     C                     PARM           ZINPD   50
     C                     PARM           ZMDAT   50
     C                     PARM           ZINFC   1
     C                     PARM           ZCALC   10
     C                     PARM           ZSTAG   1
     C                     PARM           @VAR   35
     C                     PARM           ZSF72  35
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '011'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 011  *
     C                     MOVEL'ZM0070'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     MOVE '37'      FLDNO
     C                     MOVE ZSTAG     TAG
     C                     MOVEL@MTAG     MTAG
     C                     MOVEL@VAR      MFLD
      *
      *
      **  Field :57:  Payment to
     C           MGPORS    IFEQ 'P'
      **  N/A purchased
     C                     EXSR NAP57
     C                     ELSE
      **  N/A sold
     C                     EXSR NAS57
     C                     END
      *
      **  Field :72:  Sender to receiver information
     C                     EXSR FLD72
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   CODE - Calculate codework                                   *
      *   Called by   FMTM - Format message                           *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           CODE      BEGSR
     C*
     C                     MOVE *BLANKS   CWRD    8
     C                     MOVE *BLANK    F57U
     C*
     C**  Transaction is a NA Purchased and Our Pay Nostro is non-blank
     C*
     C           MGPORS    IFEQ 'P'
     C           MGAWBN    ANDNE*BLANKS
     C*
     C**  OR a NA Sold and Our Receive Nostro is non-blank
     C           MGPORS    OREQ 'S'
     C           MGRONS    ANDNE*BLANKS
     C*
     C**  Known
     C                     MOVE 'K'       F57U
     C           CSW096    IFEQ 'Y'                                       CSW096
     C                     MOVE 'AMEND   'CWRD                            CSW096
     C                     ELSE                                           CSW096
     C                     MOVE 'COMPLETE'CWRD
     C                     ENDIF                                          CSW096
     C                     ELSE
     C*
     C**  Unknown
     C                     MOVE 'U'       F57U
     C                     MOVE 'AMEND   'CWRD
     C                     END
     C*
     C**  If sequence number zero (NEW message)
     C           MGLSWC    IFEQ 0
     C                     MOVEL'NEW     'CWRD
     C*
     C                     ELSE
     C*
     C**  The two table TABSLT and TABRST are used to create the
     C**  CONDITION and RESULT, as shown in the table below.
     C**  The position of the CONDITION on TABSLT, is the same
     C**  equivalent position for the RESULT on TABRST. Hence when
     C**  a LOKUP is performed on TABSLT, using the CONDITION as the
     C**  key, the equivalent positional RESULT value is placed
     C**  in TABRST.
     C**
     C**  To retrieve the first 3 fields for the CONDITION, the
     C**  last confrimation created for the Transaction number
     C**  is accessed.
     C**  <------------CONDITION-------------->  <--RESULT-->
     C**  Status   Old Code  Old F57U  New F57U     Code
     C**           LF/MGOREFL0
     C**  -----------------------------------------------------------------
      **      No record found            K        COMPLETE
      **      No record found            U        AMEND
      **  SENT     NEW          U        K        COMPLETE
      **  SENT     NEW          U        U        AMEND
      **  SENT     NEW          K        K        AMEND
      **  SENT     NEW          K        U        AMEND
      **  NONREC   NEW          U        K        NEW
      **  NONREC   NEW          U        U        NEW
      **  NONREC   NEW          K        K        NEW
      **  NONREC   NEW          K        U        NEW
      **  SENT     AMEND        U        K        COMPLETE
      **  SENT     AMEND        U        U        AMEND
      **  SENT     AMEND        K        K        AMEND
      **  SENT     AMEND        K        U        AMEND
      **  NONREC   AMEND        U        K        COMPLETE
      **  NONREC   AMEND        U        U        AMEND
      **  NONREC   AMEND        K        K        AMEND
      **  NONREC   AMEND        K        U        AMEND
      **  SENT     COMPLETE     K        K        AMEND
      **  SENT     COMPLETE     K        U        AMEND
      **  NONREC   COMPLETE     K        K        COMPLETE
      **  NONREC   COMPLETE     K        U        AMEND
      *
      *                                                                   CSW096
      **  For SWIFT Changes 1996, the two new tables TABS96 and           CSW096
      **  TABR96 are used to create the CONDITION and RESULT              CSW096
      **  as shown in the table below.  The position of the               CSW096
      **  CONDITION on TABS96, is the same equivalent position            CSW096
      **  for the RESULT on TABR96. Hence when a LOKUP is performed       CSW096
      **  on TABS96, using the CONDITION as the key, the equivalent       CSW096
      **  positional RESULT value is placed in TABR96.                    CSW096
      **                                                                  CSW096
      **  To retrieve the first 3 fields for the CONDITION, the           CSW096
      **  last confrimation created for the Transaction number            CSW096
      **  is accessed.                                                    CSW096
      **  <------------CONDITION-------------->  <--RESULT-->             CSW096
      **  Status   Old Code  Old F57U  New F57U     Code                  CSW096
      **           LF/MGOREFL0                                            CSW096
      **  ----------------------------------------------------------------CSW096
      **      No record found            K        AMEND                   CSW096
      **      No record found            U        AMEND                   CSW096
      **  SENT     NEW          U        K        AMEND                   CSW096
      **  SENT     NEW          U        U        AMEND                   CSW096
      **  SENT     NEW          K        K        AMEND                   CSW096
      **  SENT     NEW          K        U        AMEND                   CSW096
      **  NONREC   NEW          U        K        NEW                     CSW096
      **  NONREC   NEW          U        U        NEW                     CSW096
      **  NONREC   NEW          K        K        NEW                     CSW096
      **  NONREC   NEW          K        U        NEW                     CSW096
      **  SENT     AMEND        U        K        AMEND                   CSW096
      **  SENT     AMEND        U        U        AMEND                   CSW096
      **  SENT     AMEND        K        K        AMEND                   CSW096
      **  SENT     AMEND        K        U        AMEND                   CSW096
      **  NONREC   AMEND        U        K        AMEND                   CSW096
      **  NONREC   AMEND        U        U        AMEND                   CSW096
      **  NONREC   AMEND        K        K        AMEND                   CSW096
      **  NONREC   AMEND        K        U        AMEND                   CSW096
      *                                                                   CSW096
      **  Retrieve last confirmation for this tranaction number
     C                     MOVE MGLSWC    @TR3
     C           @TRN      CHAINMGREFL0              10
      *
      **  If a message found build the selection key
     C           *IN10     IFEQ '0'
      *
     C                     MOVE *BLANKS   SEARCH
      *
     C           MMGSG     IFEQ '2'
     C           MMGSG     OREQ '3'
     C                     MOVEL'SENT'    @MGST
     C                     ELSE
     C                     MOVEL'NONREC'  @MGST
     C                     END
     C*
     C                     MOVELMLSCC     @LSCC
     C                     MOVE MF57U     @OF57
     C                     MOVE F57U      @F57U
      *
      **  Use select table to point to the result table
      *                                                                   CSW096
     C           CSW096    IFEQ 'Y'                                       CSW096
     C           SEARCH    LOKUPTABS96    TABR96         22               CSW096
     C                     ELSE                                           CSW096
     C           SEARCH    LOKUPTABSLT    TABRST         22
     C                     ENDIF                                          CSW096
      *
      **  Key matches select table, outputs the corresponding
      **  result table value to 'TABRST'
     C           *IN22     IFEQ '1'
      *                                                                   CSW096
     C           CSW096    IFEQ 'Y'                                       CSW096
     C                     MOVE TABR96    CWRD                            CSW096
     C                     ELSE                                           CSW096
     C                     MOVE TABRST    CWRD
     C                     ENDIF                                          CSW096
      *                                                                   CSW096
     C                     ELSE                                           E29588
     C                     MOVEL'AMEND   'CWRD                            E29588
     C                     END
     C                     END
      *
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   FMT3N - Format date fields                                  *
      *   Called by - FMTM  format message details                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           FMT3N     BEGSR
      *
      **  Field :30:  Date contract agreed/amended
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE MGTDAT    ZMDAY
      *
      **  Convert Midas date to SWIFT date format
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '012'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 012  *
     C                     MOVEL'ZM0060'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     MOVE ':30: '   MTAG
     C                     MOVELZSDATE    MFLD
      *
      **  Field :32 :  value date, currency code, amount
     C                     ADD  1         X
     C           X         OCUR MULT
      **  Format value date to SWIFT standard
     C                     MOVE MGVDAT    ZMDAY
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY
     C                     PARM           ZSDATE
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '013'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 013  *
     C                     MOVEL'ZM0060'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Format currency and amount
     C                     MOVE MGCCY     ZCCY
     C                     MOVE MGCAMT    ZAMNT
     C                     CALL 'ZM0040'               15
     C                     PARM           ZAMNT  130
     C                     PARM           ZCCY    3
     C                     PARM           ZSAMNT 15
     C                     PARM           ZSCCY   3
     C                     PARM ' '       ZERR    1
     C                     PARM           ZSWDPC  1                                           222373
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '014'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 014  *
     C                     MOVEL'ZM0040'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Error - indicate erroneous fields;
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVELMGCAMT    ZAMT
     C                     MOVELERR3N     MFLD
     C                     MOVELMSGA,5    MERR
      *
     C                     ELSE
     C                     MOVELFLD3N     MFLD
     C                     END
      *
      **  N/A bought;   else  N/A sold
     C***********MGPORS    IFEQ 'P'                                       112798
     C           MGPORS    IFNE 'P'                                       112798
     C                     MOVE ':32R:'   MTAG
     C                     ELSE
     C                     MOVE ':32P:'   MTAG
     C                     END
      *
      **  Field :34 :  maturity date, currency code, total interest
      *
     C           MGMDAT    IFGT 0
     C                     ADD  1         X
     C           X         OCUR MULT
      **  Format maturity date to SWIFT standard
     C                     MOVE MGMDAT    ZMDAY
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY
     C                     PARM           ZSDATE
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '015'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 015  *
     C                     MOVEL'ZM0060'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Format currency and total interest amount
     C                     MOVE MGCCY     ZCCY
     C                     MOVE MGTOTI    ZAMNT
     C                     CALL 'ZM0040'               15
     C                     PARM           ZAMNT  130
     C                     PARM           ZCCY    3
     C                     PARM           ZSAMNT 15
     C                     PARM           ZSCCY   3
     C                     PARM ' '       ZERR    1
     C                     PARM           ZSWDPC                                              222373
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '016'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 016  *
     C                     MOVEL'ZM0040'  DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  N/A bought;   else  N/A sold
     C***********MGPORS    IFEQ 'P'                                       112798
     C           MGPORS    IFNE 'P'                                       112798
     C                     MOVE ':34P:'   MTAG
     C                     ELSE
     C                     MOVE ':34R:'   MTAG
     C                     END
      *
      ** Error - indicate erroneous fields;
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVELMGTOTI    ZAMT
     C                     MOVELERR3N     MFLD
     C                     MOVELMSGA,5    MERR
      *
     C                     ELSE
     C                     MOVELFLD3N     MFLD
     C                     END
      *
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   NAP57 - N/A Purchased format of field 57                    *
      *   Called by - FMTM   format message detail                    *
      *   Calls       FSWAD  format SWIFT address                     *
      *****************************************************************
      *
     C           NAP57     BEGSR
      *
      **  Field 57 has not been written yet
     C                     MOVE 'N'       FLD57O  1
      *
      **  Field :57:  A/C with institution non-blank
     C           MGAWBN    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGAWBN    ZDEST
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
      *
      **    A/C with Inst. blank
     C                     ELSE
      *
      **  Field 57 = pay nostro customer if settlement via '02' or '12'
     C           MGPSTM    IFEQ 02
     C           MGPSTM    OREQ 12
     C                     MOVELMGPONS    @NONB
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6
     C                     PARM MGCCY     @CYCD   3
     C**********           PARM *BLANKS   @ACCD   4                                           CGL029
     C                     PARM *BLANKS   @ACCD  10                                           CGL029
     C                     PARM *BLANKS   @ACSN   2
     C                     PARM           @NONB   2
     C                     PARM *BLANKS   @BRCD   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **  Nostro customer not found
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELMGPONS    HLD2    2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5    5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,3    MERR
     C                     MOVE ':57 :'   MTAG
     C                     ELSE
      *
      **  Format our Pay Nostro Customer Address
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
     C                     ELSE
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE ':57D:'   MTAG
     C                     MOVEL'UNKNOWN' MFLD
     C                     END
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   NAS57 - N/A Sold format of field 57                         *
      *   Called by - FMTM   Format message detail                    *
      *   Calls       FSWAD  format SWIFT address                     *
      *****************************************************************
      *
     C           NAS57     BEGSR
      *
      **  Field :57:  Payment to field
     C                     ADD  1         X
     C           X         OCUR MULT
      **  Test if settlement via nostro
     C                     MOVE MGRSTM    @STM    2
     C           @STM      LOKUPTABNST                   23
     C           MGRONS    IFNE *BLANKS
     C           *IN23     ANDEQ'1'
      *
     C                     MOVELMGRONS    @NSKYE
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @NSKYA  6
     C                     PARM MGCCY     @NSKYB  3
     C**********           PARM *BLANKS   @NSKYC  4                                           CGL029
     C                     PARM *BLANKS   @NSKYC 10                                           CGL029
     C                     PARM *BLANKS   @NSKYD  2
     C                     PARM           @NSKYE  2
     C                     PARM *BLANKS   @KEYF   3
     C                     PARM *BLANKS   @KEYG  10
     C                     PARM *BLANKS   @KEYH   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     MOVELMGRONS    MFLD
     C                     MOVELMSGA,3    MERR
     C                     MOVE ':57 :'   MTAG
     C                     ELSE
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     END
     C                     END
      *
      **  Test if settlement internal
     C                     MOVE MGRSTM    @STM
     C           @STM      LOKUPTABINT                   23
      *
     C           MGRONS    IFNE *BLANKS
     C           *IN23     ANDEQ'1'
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELSECN      ZDEST
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
      *
     C           MGRSTM    IFEQ 00
     C                     MOVE ':57D:'   MTAG
     C                     MOVEL'UNKNOWN' MFLD
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   FLD72 - Calculate field 72                                  *
      *   Called by - FMTM - Format message detail                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           FLD72     BEGSR
     C*
     C                     MOVEA*BLANKS   @WRK
     C*
     C**  Output /TELEX/
     C           MGBRKC    IFEQ 'TELX'
     C                     MOVEA'/TELEX/' @WRK,1
     C                     END
     C*
     C**  Output /PHON/
     C           MGBRKC    IFEQ 'PHON'
     C                     MOVEA'/PHON/'  @WRK,1
     C                     END
     C*
     C           MGBRKC    IFNE 'TELX'
     C           MGBRKC    ANDNE'PHON'
     C           MGBRKC    ANDNE'MAIL'
     C           MGBRKC    ANDNE'SWAP'
     C           MGBRKC    ANDNE*BLANKS
     C*
     C**  Access the broker file
     C                     CALL 'AOBROKR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM MGBRKC    @BROKY  4
     C           SDBROK    PARM SDBROK    DSFDY
     C** Error ?
     C           @RTCD     IFNE *BLANK
     C                     MOVE *BLANKS   @MERR  50
     C                     MOVE 'Y'       @ERR
     C                     MOVEAMGBRKC    @WRK,1
     C                     MOVELMSGA,4    @MERR
     C*
     C                     ELSE
     C                     MOVEA'/BROKER/'@WRK,1
     C                     MOVEAA9BKNM    @WRK,9
     C                     END
     C                     END
      *
      ** Maximum length of field is 35
     C                     MOVEA@WRK,36   @WRK15 15                       E33129
     C           @WRK15    IFNE *BLANK                                    E33129
     C                     Z-ADD36        J       20                      E33129
     C                     MOVEA*BLANK    @WRK,J                          E33129
     C                     END                                            E33129
      *
      **  Output Field :72: as constructed from above
     C           @WRK,1    IFNE *BLANK
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE ':72: '   MTAG
     C                     MOVEA@WRK      MFLD
     C                     MOVEL@MERR     MERR
     C                     MOVE 'Y'       LINE2   1
     C                     END
      *
      ** Wrap round to the next line the remainder of the BROKER info.    E33129
     C           @WRK15    IFNE *BLANK                                    E33129
     C                     MOVEA*BLANK    @WRK                            E33129
     C                     MOVEA'//'      @WRK,1                          E33129
     C                     MOVEA@WRK15    @WRK,3                          E33129
     C                     ADD  1         X                               E33129
     C           X         OCUR MULT                                      E33129
     C                     MOVEA@WRK      MFLD                            E33129
     C                     END                                            E33129
      *                                                                   E33129
     C           ZSF72     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C           LINE2     IFNE 'Y'
     C                     MOVE ':72: '   MTAG
     C                     MOVE 'Y'       LINE2                                               255986
     C                     END
      *
     C                     MOVELZSF72     MFLD
     C                     END
      *                                                                                       255986
      ** Check all six Bank to Bank Info fields and output any which                          255986
      ** contain data                                                                         255986
     C                     CLEAR@BTB                                                          255986
     C                     MOVELMGBTB1    @BTB,1                                              255986
     C                     MOVELMGBTB2    @BTB,2                                              255986
     C                     MOVELMGBTB3    @BTB,3                                              255986
     C                     MOVELMGBTB4    @BTB,4                                              255986
     C                     MOVELMGBTB5    @BTB,5                                              255986
     C                     MOVELMGBTB6    @BTB,6                                              255986
      *                                                                                       255986
     C           1         DO   6         CT6     10                                          255986
     C           @BTB,CT6  IFNE *BLANKS                                                       255986
     C                     ADD  1         X                                                   255986
     C           X         OCUR MULT                                                          255986
     C                     MOVE *BLANKS   MTAG                                                255986
      *                                                                                       255986
      **  If this is the first line of field 72 then set tag to ':72: '                       255986
     C           LINE2     IFEQ 'N'                                                           255986
     C                     MOVE ':72: '   MTAG                                                255986
     C                     MOVE 'Y'       LINE2                                               255986
     C                     ENDIF                                                              255986
     C                     MOVE *BLANKS   MFLD                                                255986
     C                     MOVE *BLANKS   MERR                                                255986
     C                     MOVEL@BTB,CT6  MFLD                                                255986
     C                     ENDIF                                                              255986
     C                     ENDDO                                                              255986
     C/COPY WNCPYSRC,MG0321C010
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   FSWAD - Format SWIFT address                                *
      *   Called by - NAP57   N/A purchase format of field 57         *
      *               NAS57   N/A sold format of field 57             *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           FSWAD     BEGSR
     C*
     C*********************CALL 'ZM0050'               15                 CSW036
     C                     CALL 'ZM0051'               15                 CSW036
     C                     PARM           ZDEST  12
     C                     PARM           ZSADD1 35
     C                     PARM           ZSADD2 35
     C                     PARM           ZSADD3 35
     C                     PARM           ZSADD4 35
     C                     PARM           ZSTAG   1
     C                     PARM           ZSTYPE  1
     C                     PARM ' '       ZERR    1
     C                     PARM *BLANK    ZDBEI   1                                           197019
      *
      **  Error on call (program not found)
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '017'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 017  *
     C*********************MOVEL'ZM0050'  DBFILE           * * * * * * * *CSW036
     C                     MOVEL'ZM0051'  DBFILE           * * * * * * * *CSW036
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C**  Error ?
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVE ZSTAG     TAG
     C                     MOVE @MTAG     MTAG
     C                     MOVELZDEST     MFLD
     C                     MOVELMSGA,6    MERR
     C                     ELSE
      **  Address 1
     C                     MOVELZSADD1    MFLD
      *
      **  SWIFT address;  Else full address
     C           ZSTAG     IFEQ 'A'
     C                     MOVE 'A'       TAG
     C                     MOVE @MTAG     MTAG
     C                     EXSR SEXTN                                     183583
      *
     C                     ELSE
     C                     MOVE 'D'       TAG
     C                     MOVE @MTAG     MTAG
      **  Address 2
     C           ZSADD2    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD2    MFLD
     C                     END                             Address 2      E42086
      **  Address 3
     C           ZSADD3    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD3    MFLD
     C                     END                             Address 3      E42086
      **  Address 4
     C           ZSADD4    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD4    MFLD
     C                     END                             Address 4
     C**********           END                             Address 3      E42086
     C**********           END                             Address 2      E42086
     C                     END                             Address 1
      *
     C                     END                             Error ?
     C*
     C                     ENDSR
      /EJECT                                                              183583
      *****************************************************************   183583
      *                                                               *   183583
      *   SEXTN - Store customer with SWIFT address to data structure *   183583
      *                                                               *   183583
      *   Called by: FSWAD                                            *   183583
      *   Calls    : None                                             *   183583
      *                                                               *   183583
      *****************************************************************   183583
      *                                                                   183583
     C           SEXTN     BEGSR                                          183583
      *                                                                   183583
     C                     MOVELMTAG      @MTG                            183583
     C           FLDTYP    IFEQ '5'                                       183583
     C           FLDTAG    ANDEQ'A'                                       183583
     C                     ADD  1         V                               183583
     C           V         OCUR EXTN                                      183583
     C                     Z-ADDX         MPSN                            183583
     C                     MOVEL@MTG      MTG                             183583
     C                     MOVELZDEST     MCSI                            183583
     C                     ENDIF                                          183583
      *                                                                   183583
     C           SEXT9     ENDSR                                          183583
     C/EJECT
      *****************************************************************
      *   REPT - print incorrectly generated messages                 *
      *   Called by - main process                                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           REPT      BEGSR
      *
      **  Open printer file for error report (if not already open)
     C           *IN50     IFEQ '0'
     C                     OPEN MG0321P1
     C                     SETON                     50                   084320
     C************         SETON                     50U7                 084320
     C                     END
      *
      **   Set up headings and sender/customer information
      **       for the error report
      *
     C**********           MOVELMGTNUM    TNUM    60                                          CLE148
     C                     MOVELMGTNUM    TNUM                                                CLE148
     C                     WRITEHEADER
     C                     WRITETEXT
      *
      **  Process multiple occurrence data structure
     C                     Z-ADD0         I       20
     C           I         DOWLEX
     C                     ADD  1         I
     C           I         OCUR MULT
     C                     WRITELINE
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   OMSG - output correctly generated messages                  *
      *   Called by - main process                                    *
      *   Calls     WREF  write reference record to PF/MGOREFPD       *
      *****************************************************************
      *
     C           OMSG      BEGSR
      *
      ** Write reference record  (PF/MGOREFPD)
     C                     EXSR WREF
      *
      **  Write multiple occurrence data structure to MGOMSGPD
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
      *
     C           X         DOWLE40
     C           MFLD      ANDNE*BLANKS
     C                     WRITEMGOMSGD0               06
      *
      **  Error on write to PF/MGOMSGPD (message data file)
     C           *IN06     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '018'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 018  *
     C                     MOVEL'MGOMSGPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C/COPY WNCPYSRC,MG0321C001
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END
      *                                                                   183583
      ** Write multiple occurrence data structure to MGOEXTPD             183583
      *                                                                   183583
     C                     Z-ADD1         V       20                      183583
     C           V         OCUR EXTN                                      183583
     C           V         DOWLE10                                        183583
     C           MCSI      ANDNE*BLANKS                                   183583
     C                     WRITEMGOEXTD0               06                 183583
      *                                                                   183583
      ** Error on write to PF/MGOEXTPD (message data extension file)      183583
      *                                                                   183583
     C           *IN06     IFEQ '1'                                       183583
     C           *LOCK     IN   LDA                                       183583
     C                     MOVE '022'     DBASE            ************** 183583
     C                     MOVEL'        'DBKEY            * DBERROR 22 * 183583
     C                     MOVEL'MGOEXTPD'DBFILE           ************** 183583
     C                     OUT  LDA                                       183583
     C                     EXSR *PSSR                                     183583
     C                     ENDIF                                          183583
     C                     ADD  1         V                               183583
     C           V         OCUR EXTN                                      183583
     C                     ENDDO                                          183583
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   CFMAT - produce confirmation matching feedback record       *
      *   Called by   Main process                                    *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           CFMAT     BEGSR
      *
     C                     CALL 'MG5001'
     C                     PARM TRNO      @TRNM  16
     C                     PARM MGBRCA    @BRCA   3
     C                     PARM *BLANK    @FEED   1
      *
     C           @FEED     IFEQ 'Y'
      *
     C           *IN50     IFEQ '0'
     C                     OPEN MG0321P1
     C                     SETON                     50U7
     C                     END
      *
      **   Set up headings and sender/customer information
      **       for the error report
     C                     MOVE '1'       *IN30
     C**********           MOVELMGTNUM    TNUM    60                                          CLE148
     C                     MOVELMGTNUM    TNUM                                                CLE148
     C                     WRITEHEADER
     C                     WRITETEXT
     C                     WRITEFEED
     C                     MOVE '0'       *IN30
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   WREF - Write reference record to PF/MGOREFPD                *
      *   Called by - OMSG  output message PF/MGOMSGPD                *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           WREF      BEGSR
      *
     C                     MOVE *BLANKS   SYTM
     C                     MOVE MGMODI    MODI
     C                     MOVE @TRNO     TRNO
     C                     MOVE *BLANKS   TRNF
     C                     MOVE *BLANKS   TRNM
     C                     MOVEL@TR2      MTRN
     C                     MOVE MGTTYP    TNTP
     C                     MOVE MGTSTP    SBTP
     C                     MOVE *BLANKS   EVTP
     C                     MOVEL*BLANKS   NWBN
     C                     MOVE '321'     MTPY
     C                     MOVE 'N'       MPRY
     C                     MOVELCWRD      LSCC
     C                     MOVEL*BLANKS   PTST
     C                     MOVEL*BLANKS   CARQ
     C                     MOVEL*BLANKS   MPDE
     C                     MOVEL@HRDT     HRDT
     C                     TIME           MGTM
     C                     MOVE BJMRDT    LADT
     C                     MOVE MGTM      LATM
      *                                                                                       CSW202
     C           CSW202    IFEQ 'Y'                                                           CSW202
     C                     MOVE '322'     MTPY                                                CSW202
     C                     ENDIF                                                              CSW202
      *
      ** Initiate the Midas Watch List Checking Engine if CSD015 is                           CSD015
      ** enabled and CSW025 is disabled.                                                      CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDEQ'N'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           MGST      IFEQ 'RSND'
     C                     MOVE BJMRDT    RELD
     C                     MOVE MGTM      RELT
     C                     END
      *
     C                     MOVEL*BLANKS   RUSR
     C                     MOVEL*BLANKS   RWSN
     C                     MOVEL*BLANKS   AMTS
     C                     MOVEL*BLANKS   AMTX
     C                     MOVEL*BLANKS   SVDT
     C                     MOVEL*BLANKS   CINDV                           141572
     C                     MOVEL*BLANKS   CCY
     C                     MOVEL*BLANKS   NSNO
     C                     MOVEL*BLANKS   SACN
     C                     MOVEL*BLANKS   AORR
     C                     MOVEL*BLANKS   DESI
      *
      **  Branch details
     C                     MOVE MGBRCA    BRCA
     C                     MOVE MGPOBR    OTHB
     C           OTHB      IFNE *BLANKS
     C                     MOVELMSGA,1    OTHT
     C                     END
     C                     MOVE MGROBR    RCBR
      *
     C                     MOVE *BLANKS   NETI
     C                     MOVE *BLANKS   DELC
     C                     MOVE *BLANKS   DYST
     C                     MOVE *BLANKS   RSID
     C                     MOVE *BLANKS   MSE1
     C                     MOVE *BLANKS   ELIN
     C                     MOVE *BLANKS   SSAC
     C                     MOVE *BLANKS   MIR
     C                     MOVE *BLANKS   TSKS
     C                     MOVE *BLANKS   CFPF                            055058
     C                     MOVE *BLANKS   TSKY
     C                     MOVE MGCHTP    AORR                                                CSW025
     C/COPY WNCPYSRC,MG0321C005
     C*
     C                     WRITEMGOREFD0               05
      *
      **  Error on write to PF/MGOREFPD (message reference file)
     C           *IN05     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '019'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 019  *
     C*********************MOVEL'ZM0050'  DBFILE           * * * * * * * *CSW036
     C                     MOVEL'ZM0051'  DBFILE           * * * * * * * *CSW036
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C*
     C/COPY WNCPYSRC,MG0321C002
     C                     ENDSR
     C/COPY WNCPYSRC,MG0321C006
     C/EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
      *                                                               *                       CSD015
      *  SRWTCH - Initiates the Midas Watch List Checking Engine.     *                       CSD015
      *                                                               *                       CSD015
      *****************************************************************                       CSD015
     C           SRWTCH    BEGSR                                                              CSD015
      *                                                                                       CSD015
      ** Check if the message is for automatic release.                                       CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       PARLS                                               CSD015
      *                                                                                       CSD015
     C           MGST      IFEQ 'RSND'                                                        CSD015
     C           NWRK      IFEQ 'SWIFT '                                                      CSD015
     C           NWRK      OREQ 'TELEX '                                                      CSD015
     C           NWRK      OREQ 'STTX  '                                                      CSD015
     C                     MOVE 'CRTD'    MGST                                                CSD015
     C                     MOVE '1'       MGSG                                                CSD015
     C                     MOVE 'Y'       PARLS   1                                           CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Initialise the Transaction Details parameter.                                        CSD015
      *                                                                                       CSD015
     C                     CLEARWLTDS                                                         CSD015
     C                     Z-ADD*ZERO     W4VDAT                                              CSD015
     C                     Z-ADD*ZERO     W4MDAT                                              CSD015
     C                     Z-ADD*ZERO     W4AMT1                                              CSD015
     C                     Z-ADD*ZERO     W4AMT2                                              CSD015
      *                                                                                       CSD015
     C                     MOVELTRNO      W4IDEN                                              CSD015
     C                     MOVELMTPY      W4ITEM                                              CSD015
     C                     MOVEL'MGOREF  'W4FUNT                                              CSD015
     C                     MOVELMGBRCA    W4BRCH                                              CSD015
     C                     MOVELDECN      W4CNUM                                              CSD015
     C                     Z-ADDBJRDNB    W4DDAT                                              CSD015
     C                     MOVE PARLS     W4ARLS                                              CSD015
      *                                                                                       CSD015
      ***Send*the*Transaction Details to the Compliance Engine.                        CSD015 221145
     C*********************CALL 'SDWLCLOP'                                             CSD015 221145
     C*********************PARM           WLTDS                                        CSD015 221145
     C*********************PARM *BLANKS   PSTRNG                                       CSD015 221145
      *                                                                                       CSD015
     C                     ENDSR                                                              CSD015
      *****************************************************************                       CSD015
     C/EJECT
      *****************************************************************                       221145
      *                                                               *                       221145
      *  WLCDQ - Submit information to Watch List Check Dtaq          *                       221145
      *                                                               *                       221145
      *****************************************************************                       221145
      *                                                                                       221145
     C           WLCDQ     BEGSR                                                              221145
      *                                                                                       221145
      *  Send transaction to compliance engine program                                        221145
      *                                                                                       221145
     C                     CALL 'SDWLCLOP'                                                    221145
     C                     PARM           WLTDS                                               221145
     C                     PARM *BLANKS   PSTRNG                                              221145
      *                                                                                       221145
      *                                                                                       221145
     C                     ENDSR                                                              221145
      *                                                                                       221145
     C/EJECT                                                                                  221145
      *****************************************************************
      *   *PSSR - error handling                                      *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
      *
      **  Write database error to report
     C                     OPEN MG0321AU
     C                     WRITEHEAD
     C                     WRITEDBERROR
      *
     C                     SETON                     U7U8LR
     C                     DUMP
     C                     RETRN
      *
     C                     ENDSR
     C/EJECT
     C/COPY WNCPYSRC,MG0321C009
      *
     C/COPY MGCPYSRC,SWIFTTRANS                                           BLI605
** CPY@   Object Copyright
(c) Finastra International Limited 2001
** MSGA   Messages
Settlement - pay
Customer details not found on SDCUSTPD
Nostro customer not found on SDNOSTPD
Broker code not found on SDBROKPD
ZM0040 (format ccy and amount) call ended in error
ZM0050 (format SWIFT address) call ended in error
Codeword was not found for this message
Duplicate TRN (ref.) key built for this message
** TABSLT - selection criteria for the codeword
SENT   NEW      U K
SENT   NEW      U U
SENT   NEW      K K
SENT   NEW      K U
NONREC NEW      U K
NONREC NEW      U U
NONREC NEW      K K
NONREC NEW      K U
SENT   AMEND    U K
SENT   AMEND    U U
SENT   AMEND    K K
SENT   AMEND    K U
NONREC AMEND    U K
NONREC AMEND    U U
NONREC AMEND    K K
NONREC AMEND    K U
SENT   COMPLETE K K
SENT   COMPLETE K U
NONREC COMPLETE K K
NONREC COMPLETE K U
** TABRST - Resulting codeword; corresponds to the selection criteria
COMPLETE
AMEND
AMEND
AMEND
NEW
NEW
NEW
NEW
COMPLETE
AMEND
AMEND
AMEND
COMPLETE
AMEND
AMEND
AMEND
AMEND
AMEND
COMPLETE
AMEND
** TABS96 - selection criteria for the codeword                           CSW096
SENT   NEW      U K                                                       CSW096
SENT   NEW      U U                                                       CSW096
SENT   NEW      K K                                                       CSW096
SENT   NEW      K U                                                       CSW096
NONREC NEW      U K                                                       CSW096
NONREC NEW      U U                                                       CSW096
NONREC NEW      K K                                                       CSW096
NONREC NEW      K U                                                       CSW096
SENT   AMEND    U K                                                       CSW096
SENT   AMEND    U U                                                       CSW096
SENT   AMEND    K K                                                       CSW096
SENT   AMEND    K U                                                       CSW096
NONREC AMEND    U K                                                       CSW096
NONREC AMEND    U U                                                       CSW096
NONREC AMEND    K K                                                       CSW096
NONREC AMEND    K U                                                       CSW096
** TABR96 - Resulting codeword; corresponds to the selection criteria     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
NEW                                                                       CSW096
NEW                                                                       CSW096
NEW                                                                       CSW096
NEW                                                                       CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
AMEND                                                                     CSW096
** TABNST - Codes indicating settlement via nostro
01
02
07
08
12
** TABINT - Codes indicating settlement via internal
03
04
05
06
14
