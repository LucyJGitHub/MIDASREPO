     H        1                           F
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MG Format FRA rate fix and settlement conf')     *
      *****************************************************************
      *                                                               *
      *  Midas - Message Generation Module                            *
      *                                                               *
      *  MG0341 - FORMAT FRA RATE FIX AND SETTLEMENT CONFIRMATION     *
      *                                                               *
      *  Function:  This program will format MT341 messages for       *
      *  (IC & COB)  output to SWIFT.                                 *
      *                                                               *
      *  Called By: DLC1921 - FRAIRS Rate Fixing                      *
      *             DLC0603 - Dealing COB Confirmations               *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CSW216             Date 14Mar16               *
      *                 CSW214             Date 25Nov14               *
      *                 244488             Date 19Aug14               *
      *                 MD023278           Date 11Nov13               *
      *                 MD023007           Date 24Oct13               *
      *                 MD023798           Date 26Nov13
      *                 MD022981           Date 12Nov13               *
      *                 MD022633A          Date 17Oct13               *
      *                 MD023009           Date 23Oct13               *
      *                 MD022733           Date 08Oct13               *
      *                 MD022633           Date 03Oct13               *
      *                 MD022526           Date 27Sep13               *
      *                 CSW213             Date 03Jun13               *
      *                 CLE148             Date 23Jul12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 238193             Date 23Aug06               *
      *                 CSD031             Date 10Apr06               *
      *                 226723             Date 02Mar06               *
      *                 BUG11283           Date 27Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 27Oct03               *
      *                 222385             Date 23Oct03               *
      *                 221145             Date 08Sep03               *
      *                 219242             Date 01Jul03               *
      *                 219241             Date 01Jul03               *
      *                 CSD015             Date 14Oct02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSW025             Date 26Mar02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CSW201             Date 02May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 190127             Date 28Feb01               *
      *                 184718             Date 19Jan01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 186533             Date 23Nov00               *
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CSW200             Date 21Aug00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 137909             Date 22Jul98               *
      *                 CSW005  *CREATE    Date 01AUG96               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CSW216 - SWIFT Changes 2016                                  *
      *  CSW214 - SWIFT Changes 2014                                  *
      *  244488 - Program is looking up currency code to access Swift *
      *           currency, but it has already been converted to      *
      *           have the Swift ccy code in the driver file . Need   *
      *           to access SDCURR by Swift code and retrieve CYCD    *
      *           before trying to format the ccy/amount.             *
      *  MD023278 - Incorrect value of tags 20 and 21 in MT341        *
      *  MD023007 - Inaccurate writing sequence on repeating fields   *
      *             of RPIF details in MT generation                  *
      *  MD023798 - Invalid format for tag 98D                        *
      *  MD022981 - Seq 15D without succeeding field tags generated   *
      *  MD022633A - Properly set-up the value for tags 22L and 91J   *
      *  MD023009 - MT300 Message 15E is out of sequence              *
      *  MD022733 - Incorrect value for tags 20 and 21 in MT341 during*
      *             Amend action                                      *
      *  MD022633 - Allow reporting details with '0' Transaction      *
      *             Identifier type for different reporting           *
      *             jurisdiction and reporting party ID combinations. *
      *  MD022526 - MT341 Missing 22U                                 *
      *  CSW213 - SWIFT Changes 2013                                  *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  238193 - Print "N" on field 37R when the settlement rate is  *
      *           negative.  Applied fix 226723.                      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  226723 - Print "N" on field 37R when the settlement rate is  *
      *           negative.                                           *
      *  BUG11283- Field 57D should be 'NONE' where no settlement     *
      *            taking place because amount is zero                *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Parameter Mismatch.                                 *
      *  222385 - SWIFT msgs are Watch List checked regardless of     *
      *           configuration file setting                          *
      *  221145 - Compliance Watch WLC: Move compliance check to      *
      *           after COMIT to MGOMSGPD                             *
      *  219242 - Not possible to create MT103+ payment msg from      *
      *           non-FT transaction (Recompile)                      *
      *  219241 - Defaulting of "Details of Charges" assign a         *
      *           system value (Recompile)                            *
      *  CSD015 - Midas Compliance Watch - Watch List Checking        *
      *  CSW025 - Midas Message Manager                               *
      *           - Pass original change type                         *
      *  CSW201 - SWIFT 2001 Standards Update                         *
      *  190127 - Related reference should contain tansaction         *
      *           reference of previous message of same type          *
      *  184718 - Setup CIND flag to correct Y2K display problems.    *
      *  186533 - Sign for 34E should only be conditioned on MGPORR   *
      *  CDL008 - Continuous Linked Settlement (Recompiled)           *
      *  CSW200 - Swift 2000 Changes                                  *
      *  137909 - Use the settlement currency if not blank for        *
      *           accessing nostro details. This is needed for tag    *
      *           57A.                                                *
      *  CSW005 - FRA/IRS MG34n and MG36n Message Generation.         *
      *                                                               *
      *****************************************************************
     FMGF341PDUF  E           K        DISK
     F                                              KCOMIT
     FMGOREFL0IF  E           K        DISK
     F            MGOREFD0                          KRENAMEMGREFL0
     FMGOREFPDO   E                    DISK
     F                                              KCOMIT
     FMGOMSGPDO   E                    DISK
     F                                              KCOMIT
     FDLRPIFL1IF  E           K        DISK                           UC                    MD022981
      *                                                                                       190127
      ** MG Transaction history file                                                          190127
     F***MGHISTL0UF  E           K        DISK                      A                  190127 CSW213
     FMGHISTL7UF  E           K        DISK                      A                            CSW213
     F            MGHISTD0                          KRENAMEMGHIST                             CSW213
     F                                              KCOMIT                                    190127
      *                                                                                       244488
      ** MG Transaction history file                                                          244488
     FSDCURRLDIF  E           K        DISK                                                   244488
     F                                              KCOMIT                                    244488
     F***MG0341P1O   E                    PRINTER                        UC                   CSW213
     FMG0341P1O   E             99     PRINTER                        UC                      CSW213
     FMG0341AUO   E                    PRINTER                        UC
     F/COPY WNCPYSRC,MG0341F001
      *****************************************************************
      *                                                               *
      * FUNCTION OF INDICATORS                                        *
      *                                                               *
      *    01            EOF MGF341PD                                 *
      *    05            Error on write to MGOREFPD.                  *
      *    06            Error on write to MGOMSGPD                   *
      *    11            Chain to MGOREFL0.                           *
      *    15            Error in call to standard program ZM0060     *
      *    16            Error on delete of GDF record.               *
      *    20            LOKUP operation searching array (GNR)        *
      *    21            LOKUP operation searching array (GNR)        *
      *    22            LOKUP operation searching array (GNR)        *
      *    23            Settlement method on TABNST/TABINT.          *
      *    25            Array 1st line filled ; fld72.               *
      *    26            Error on call of MG5000                      *
      *    27            ConCord Interface is ON.                     *
      *    28            Error in call to standard program ZM1190     *
      *    30            Feedback record not generated                *
      *    31            LOKUP operation searching array (@WRK)       *
      *    50            MG0341P1 open                                *
      *    U7U8          Database error                               *
      *                                                               *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                   Index to subroutines                        *
      *   main process                                                *
      *   INIT - Initial Process.                                     *
      *   INTF - Initialise non-constant fields.                      *
      *   SRROUT - Determine Message Routing.                         *
      *   FMTFLD - Format MT341 fields for output.                    *
      *   FSWAD- Format SWIFT Address.                                *
      *   DATES- Format the Date Fields.                              *
      *   RECV - Format Fields 53 ,56 and 57 (receive instructions)   *
      *   PAY  - Format Fields 53  56 and 57 (payment instructions)   *
      *   FLD72- Format Field 72.                                     *
      *   REPT - Print Incorrectly Generated Messages.                *
      *   OMSG - Output Correctly Generated Messages.                 *
      *   WREF - Write o/p reference to PF/MGOREFPD.                  *
      *   CFMAT - Generate feedback record if confo. matching is ON   *
      *   *PSSR- Error Handling.                                      *
      *                                                               *
      *****************************************************************
     E                    CPY@    1   1 80               copyright
     E                    MSGA    1   8 60               message text
     E                    TABNST  1   5  2               settlement nostro
     E                    TABINT  1   5  2               settle. internal
     E                    GNR        15  3               msg gen. released
     E                    @WRK       50  1               work array
     E                    S2RF        6 35               sender-recv. info
     E                    IX          4  1 0                                                MD023007
      *
     IMGREFL0
     I              SYTM                            MSYTM
     I              NWRK                            MNWRK
     I              SECN                            MSECN
     I              NWSN                            MNWSN
     I              DECN                            MDECN
     I              NWDS                            MNWDS
     I              MGSG                            MMGSG
     I              MGST                            MMGST
     I              F57U                            MF57U
     I              LSCC                            MLSCC
     I              HRDT                            MHRDT
     I              MGDE                            MMGDE
     I              MGTM                            MMGTM
     I              LADT                            MLADT
     I              RELD                            MRELD
     I              RELT                            MRELT
     I              CFPF                            MCFPF
     I              TODY                            MTODY
      *
      **  Rename conflicting MGOREFL0 fields
      *
     I            DS
     I                                        1  12 CSID
     I                                        9  11 @BIC
      *
      **  Data structure to test for BIC code
      *
     I***MULT***     DS                         95                                            CSW213
     IMULT        DS                        160                                               CSW213
     I                                        1   5 MTAG
     I                                        6  55 MFLD
     I                                       56 105 MERR
      *
      **  Multiple occurrence data structure for message
      *
     ILDA         DS                            256
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
      *
      **  Local data area
      *
     ICODEWD      DS                         22
     I                                        1   8 CWRD
     I                                       10  10 F57U
      **  Data structure containing codeword for the new message
      *
     IFLD3N       DS                         24
     I                                        1   6 ZSDATE
     I                                        7   9 ZSCCY
     I                                       10  24 ZSAMNT
      *
      **  Data structure containing codeword for fields 32/33.
      *
     IERR3N       DS                         24
     I                                        1   3 ZCCY
     I                                        5  170ZAMT
      *
      **  Erroneous currency & amounts for Fields 32/33
      *
     I@MTAG       DS                          5
     I                                        1   1 COLON1
     I                                        2   3 FLDNO
     I                                        4   4 TAG
     I                                        5   5 COLON2
      *
      **  Data structure constructing message field tag
      *
     IP@IN        DS                            256
     I                                        1   3 I@SNBR
     I                                        4   9 I@DSCN
     I                                       10  12 I@MTPY
     I                                       13  140I@SETT
     I                                       15  15 I@CONC
     I                                       16  16 I@FTCS
     I                                       17  18 I@MMOD
      ** Data structure for input parameter
      *
     IP@OUT       DS                            256
     I**********                              1   60O@CNSN                                    CSD027
     I                                        1   6 O@CNSN                                    CSD027
     I                                        7  18 O@SWSN
     I                                       19  38 O@NWSN
     I                                       39  49 O@SWDS
     I                                       46  46 W@96CN
     I                                       47  49 W@BIC
     I                                       50  69 O@NWDS
     I                                       70  75 O@NWRK
     I                                       76  76 O@MGSG
     I                                       77  80 O@MGST
     I                                       81  81 O@PAIN
     I                                       82  87 O@PCNB
     I                                       88  90 O@SPRS
      ** Data structure for ouput parameter
      *
     I@HREF       DS                         16                                               190127
     I                                        1   2 HSMODI                                    190127
     I                                        3   8 HSTRAN                                    190127
     I                                        9  11 HSSEQ                                     190127
      **  Data structure for related reference                                                190127
      *                                                                                       190127
      ** Data structure build transaction reference number                                    CSW213
     I@TRN1       DS                         16                                               CSW213
     I                                        1   2 @TRN11                                    CSW213
     I                                        3   8 @TRN21                                    CSW213
     I                                        9  14 @TRN31                                    CSW213
     I                                       15  160@TRN41                                    CSW213
     I                                        3  14 @TRNID                                    CSW213
      *                                                                                       CSW213
      **  Data structure for related reference CSW213                                         CSW213
     I@HREF1      DS                         16                                               CSW213
     I                                        1   2 H1MODI                                    CSW213
     I                                        3   8 H1TRAN                                    CSW213
     I                                        9  14 HSDEST                                    CSW213
     I                                       15  160@SSEQ                                     CSW213
      *                                                                                       CSW213
      ** Multiple occurence data structure                                                    CSW213
      *                                                                                       CSW213
     IRPPT        DS                          5                                               CSW213
     I                                        1  35 MGRJXX                                    CSW213
     I                                       36  41 MGRPXX                                    CSW213
     I                                       42  61 MGRNXX                                    CSW213
     I                                       62  71 MGRCXX                                    CSW213
     I                                       72  82 MGRSXX                                    CSW213
     I                                       83 102 MGRLXX                                    CSW213
     I                                      103 136 MGRAXX                                    CSW213
     I**********                            137 146 MGUTXX                             CSW213 CSW214
     I**********                            147 178 MGTNXX                             CSW213 CSW214
     I**********                            179 179 MGTIXX                             CSW213 CSW214
     I**********                            180 180 MGETXX                             CSW213 CSW214
     I**********                            137 156 MGUTXX                             CSW214 CSW216
     I**********                            157 188 MGTNXX                             CSW214 CSW216
     I**********                            189 189 MGTIXX                             CSW214 CSW216
     I**********                            190 190 MGETXX                             CSW214 CSW216
     I                                      137 166 MGUTXX                                    CSW216
     I                                      167 198 MGTNXX                                    CSW216
     I                                      199 199 MGTIXX                                    CSW216
     I                                      200 200 MGETXX                                    CSW216
      *                                                                                       CSW213
     ISDCSSW    E DSSDCSSWPD                                                                  CSW213
      *                                                                                       CSW213
      ** Data structure for Customer Extensions SWIFT Details                                 CSW213
      *                                                                                       CSW213
     ISDBANK    E DSSDBANKPD
      *
      **  External Data structure for bank details.
      *
     ISDTRAD    E DSSDTRADPD
      *
      **  External Data structure for trading file.
      *
     ISDCUST    E DSSDCUSTPD
      *
      **  External Data structure for customer details.
      *
     ISDBRCH    E DSSDBRCHPD
     I              QQDFAC                          DFACQQ                                    CGL029
      *
      **  External Data structure for branch details.
      *
     ISDMMOD    E DSSDMMODPD
      *
      **  External Data structure for module ICD file.
      *
     ISDNOST    E DSSDNOSTPD
     I              QQACCD                          ACCDQQ                                    CGL029
      *
      **  External Data structure for nostro details.
      *
     ISDMGME    E DSSDMGMEPD
      *
      **  Data structure for message management data.
      *
     ISCSARD    E DSSCSARDPD
      *
      **  Data structure for Switchable Features file
      *
     IDSFDY     E DSDSFDY
      *
      **  Short data structure for access programs
      *
     IDSSDY     E DSDSSDY
      *
      **  Long data structure for access programs
      *
     IWLTDS     E DSSDWLTOPD                                                                  CSD015
      ** Watch List Transaction Details Data Structure                                        CSD015
      *                                                                                       CSD015
     IPSTRNG      DS                           9999                                           CSD015
      ** SDWLCLOP Search String Parameter                                                     CSD015
     IDSLDY     E DSDSLDY                                                                     CSW213
      *                                                                                       CSW213
      **  Third data structure for access programs                                            CSW213
      *
     ISDWLCC    E DSSDWLCCPD                                                                  222385
      ** Watch list checking details                                                          222385
      *                                                                                       222385
      /EJECT
      *****************************************************************
      *   MAIN - main process                                         *
      *   Called by - none                                            *
      *   Calls - INIT    Initial Process.                            *
      *           INTF    Initialise non-constant fields.             *
      *           SRROUT Determine Message Routing.                   *
      *           FMTFLD  Format Message Detail for Output.           *
      *           REPT    Print Incorrectly Generated Messages.       *
      *           OMSG    Output Correctly Generated Messages.        *
      *****************************************************************
      *
      **  Transaction history key                                                             190127
     C           HSKEY     KLIST                                                              190127
     C                     KFLD           MGMODI                                              190127
     C                     KFLD           HSTRAN                                              190127
     C                     KFLD           HSDEST                                              CSW213
     C                     KFLD           HSMTPY                                              190127
      *
      ** Initial Processing.
      *
     C                     EXSR INIT
      *
      ** Read the first record from PF/MGF341PD.
      *
     C                     READ MGF341PD                 01
      *
      ** Do While record is found in file.
      *
     C           *IN01     DOWEQ'0'
      *
      ** Initialise output fields and format message level fields.
      *
     C                     EXSR INTF
      *
      ** Determine message routing.
      *
     C                     EXSR SRROUT
      *
      **  Format MT341 fields for output.
      *
     C           CSW200    IFEQ 'N'                                       CSW200
     C                     EXSR FMTFLD
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      ** Use the Swift 2000 changes                                       CSW200
      *                                                                   CSW200
     C                     EXSR FFLD2K                                    CSW200
      *                                                                   CSW200
     C                     ENDIF                                          CSW200
      *
      ** Print if error in generated message.
      *
     C           @ERR      IFEQ 'Y'
     C                     EXSR REPT
     C                     ELSE
      *
      ** Print if no error in generated message.
      *
     C                     EXSR OMSG
      *
      ** If confirmation matching is switched on, generate
      ** feedback record
      *
     C           BGCFMT    IFEQ 'Y'
     C                     EXSR CFMAT
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Delete record after completion of processing.
      *
     C                     DELETMGF341PD               16
      *
      **  Error on delete of record.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '017'     DBASE              * * * * * * *
     C                     MOVELMGTNUM    DBKEY              * DBERR 017 *
     C                     MOVEL'MGF341PD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Update sequence numbers on transaction record
      **  if no errors have occurred
      *
     C           @ERR      IFNE 'Y'
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     CALL 'MG5000'               24                                     CSW213
     C                     PARM MGTTYP    @MODI   2                                           CSW213
     C                     PARM MGTNUM    @TRAN  15                                           CSW213
     C                     PARM 'CE'      @PROG   2                                           CSW213
     C                     PARM 'U'       @MODE   1                                           CSW213
     C                     PARM *ZEROS    MGLSWC  30                                          CSW213
     C                     PARM *ZEROS    MGLSWS  30                                          CSW213
     C                     PARM *BLANKS   @ERCD   1                                           CSW213
     C                     ELSE                                                               CSW213
     C                     CALL 'MG5000'               26
     C                     PARM MGMODI    @MODI   2
     C                     PARM MGTNUM    @TRAN  15
     C                     PARM 'CF'      @PROG   2
     C                     PARM 'U'       @MODE   1
     C                     PARM *ZEROS    MGLSWC  30
     C                     PARM *ZEROS    MGLSWS  30
     C                     PARM *BLANKS   @ERCD   1
     C                     ENDIF                                                              CSW213
      *
      **  Error on access for sequence number
      *
     C           @ERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     MOVE '018'     DBASE            * * * * * * * *
     C                     MOVELMODI      DBKEY            *  DBERR 018  *
     C                     MOVE MTRN      DBKEY            * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Program missing on call
      *
     C           *IN26     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '019'     DBASE            * * * * * * * *
     C                     MOVE 'MG5000'  DBKEY            *  DBERR 019  *
     C                     OUT  LDA                        * * * * * * * *
     C                     EXSR *PSSR
     C                     END
      *
     C                     END
     C           *LOCK     IN   LDA
     C                     MOVEL'MG0341  'DBPGM
     C                     OUT  LDA
      *
      **  COMIT all changes since no error on writing the message
      *
     C                     COMIT
      *                                                                   221145
      **  Call Compliance Watch:Watch List Checking                       221145
      *                                                                   221145
     C           CSD015    IFEQ 'Y'                                       221145
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDEQ'N'                                       221145
     C                     EXSR WLCDQ                                     221145
     C                     ENDIF                                          221145
      *
      ** Read next available record in MGF341PD.
      *
     C                     READ MGF341PD                 01
      *
     C                     ENDDO
      *
      **  Write end of report, only if the printer file is open
      *
     C           *IN50     IFEQ '1'
     C                     WRITEEOREPT
     C                     END
     C/COPY WNCPYSRC,MG0341C001
      *
     C                     MOVE *ON       *INLR
      *
      /EJECT
      *****************************************************************
      *   INIT - initial process                                      *
      *   Called by - main process                                    *
      *****************************************************************
      *
     C           INIT      BEGSR
      *
     C                     MOVEACPY@      CPY2@  80
      *
      **  Set up LDA
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVEL'MG0341'  DBPGM
     C                     MOVE *BLANKS   DBASE
     C                     OUT  LDA
      *
      **  Access SDBANKPD for report title.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** If no record is found on sdbankpd.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '001'     DBASE              * * * * * * *
     C                     MOVEL'FIRST'   DBKEY              * DBERR 001 *
     C                     MOVEL'SDBANKPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Correctly work out Date Format.
      *
     C           BJDFIN    COMP 'M'                      98
      *
      **  Access SDTRADPD for trading information.
      *
     C                     CALL 'AOTRADR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDTRAD    PARM SDTRAD    DSFDY
      *
      ** If no record is found on sdtradpd.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '002'     DBASE              * * * * * * *
     C                     MOVEL'FIRST'   DBKEY              * DBERR 002 *
     C                     MOVEL'SDTRADPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Access SDMMODPD for modules available.
      *
     C                     CALL 'AOMMODR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
      ** If no record is found on sdmmodpd.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '003'     DBASE              * * * * * * *
     C                     MOVEL'FIRST'   DBKEY              * DBERR 003 *
     C                     MOVEL'SDMMODPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Access SDMGMEPD for message management data.
      *
     C                     CALL 'AOMGMER0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDMGME    PARM SDMGME    DSFDY
      *
      ** If no record is found on sdmgmepd.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '004'     DBASE            * * * * * * * *
     C                     MOVEL'FIRST'   DBKEY            *  DBERR 004  *
     C                     MOVEL'SDMGMEPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Initialise constant fields.
      *
     C                     MOVE *LOVAL    CR      1
     C                     BITON'457'     CR
     C                     MOVE *LOVAL    LF      1
     C                     BITON'257'     LF
     C                     MOVELCR        CRLF    2
     C                     MOVE LF        CRLF
     C                     MOVE ':'       COLON1
     C                     MOVE ':'       COLON2
      *
      ** CRLF Control Character for message data records.
      *
     C                     MOVE CRLF      CTRC
      *
      ** Convert run date to YYMMDD, for Message Generation Date.
      *
     C                     CALL 'ZM0060'               15
     C                     PARM BJRDNB    ZMDAY   50
     C                     PARM           ZSDATE  6
      *
      ** Program ended in error.
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '005'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 005 *
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     MOVE ZSDATE    MGDE
      *
      ** Set-up Message Generation Century flag                           184718
      *                                                                   184718
     C                     MOVELMGDE      YY      20                      184718
     C           YY        IFLT 72                                        184718
     C                     MOVE '2'       CIND                            184718
     C                     ELSE                                           184718
     C                     MOVE '1'       CIND                            184718
     C                     ENDIF                                          184718
      *                                                                   184718
      ** Convert history retention date to YYMMDD.
      *
     C           BJRDNB    ADD  ENDSMN    ZMDAY
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY
     C                     PARM           ZSDATE
      *
      ** If the program ends in error.
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '006'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 006 *
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     MOVE ZSDATE    @HRDT   6
      *
      ** Access Switchable features file to see if ConCord is switched
      ** ON.
      *
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' RTCDA   7
     C                     PARM '*VERIFY' RTCDB   7
     C                     PARM 'CCF001'  RTCDC   6
      *
     C           RTCDA     IFEQ *BLANK
     C                     MOVE *ON       *IN27
     C                     END
      *                                                                   137909
      **  Access Switchable Features file for CEU003                      137909
      *                                                                   137909
     C                     CALL 'AOSARDR0'                                137909
     C                     PARM *BLANKS   @RTCD                           137909
     C                     PARM '*VERIFY' @OPTN                           137909
     C                     PARM 'CEU003'  @SARD   6                       137909
     C           @RTCD     IFEQ *BLANKS                                   137909
     C                     MOVEL'Y'       CEU003  1                       137909
     C                     ELSE                                           137909
     C                     MOVEL'N'       CEU003                          137909
     C                     ENDIF                                          137909
      *                                                                   CSW200
      ** Check if Swift 2000 Changes is switched on.                      CSW200
      *                                                                   CSW200
     C                     CALL 'SWIF2000'                                CSW200
     C                     PARM *BLANKS   @RTCD                           CSW200
     C*                                                                   CSW200
     C           @RTCD     IFEQ 'CSW200'                                  CSW200
     C                     MOVE 'Y'       CSW200  1                       CSW200
     C                     ELSE                                           CSW200
     C                     MOVE 'N'       CSW200                          CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      **  Access Switchable Features file for CSW201                                          CSW201
      *                                                                                       CSW201
     C                     CALL 'SWIF2001'                                                    CSW201
     C                     PARM *BLANKS   @RTCD                                               CSW201
      *                                                                                       CSW201
     C           @RTCD     IFEQ 'CSW2001'                                                     CSW201
     C                     MOVE 'Y'       CSW201  1                                           CSW201
     C                     ELSE                                                               CSW201
     C                     MOVE 'N'       CSW201                                              CSW201
     C                     ENDIF                                                              CSW201
      *                                                                                       CSW201
      ** Check if CSD015 is enabled.                                                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD   7                                           CSD015
     C                     PARM '*VERIFY' POPTN   7                                           CSD015
     C                     PARM 'CSD015'  PSARN   6                                           CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSD015  1                                           CSD015
     C                     MOVEL'N'       W1EWLC                                              222385
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSD015                                              CSD015
      *                                                                                       222385
      ** Access AOWLCCR0 to check if function code MESSGENT is available                      222385
      *                                                                                       222385
     C                     CALL 'AOWLCCR0'                                                    222385
     C                     PARM *BLANKS   PRTCD                                               222385
     C                     PARM '*KEY'    POPTN                                               222385
     C                     PARM 'MESSGENT'PFUNC   8                                           222385
     C           SDWLCC    PARM SDWLCC    DSFDY                                               222385
      *                                                                                       222385
     C           PRTCD     IFNE *BLANKS                                                       222385
     C           PRTCD     ANDNE'*NRF'                                                        222385
     C                     MOVEL'SDWLCCPD'DBFILE                                              222385
     C                     MOVELPFUNC     DBKEY                                               222385
     C                     Z-ADD32        DBASE                                               222385
     C                     EXSR *PSSR                                                         222385
     C                     ENDIF                                                              222385
      *                                                                                       222385
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE '*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVELPSARN     DBKEY                                               CSD015
     C                     Z-ADD31        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if CSW025 is enabled.                                                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*VERIFY' POPTN                                               CSD015
     C                     PARM 'CSW025'  PSARN                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSW025  1                                           CSD015
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSW025                                              CSD015
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE '*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVELPSARN     DBKEY                                               CSD015
     C                     Z-ADD32        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if switchable feature CSW213 is switched on                                    CSW213
      *                                                                                       CSW213
     C                     CALL 'SWIF2013'                                                    CSW213
     C                     PARM *BLANKS   @RTCD                                               CSW213
      *                                                                                       CSW213
     C           @RTCD     IFEQ 'CSW2013'                                                     CSW213
     C                     MOVE 'Y'       CSW213  1                                           CSW213
     C                     OPEN DLRPIFL1                                                    MD022981
     C                     ELSE                                                               CSW213
     C                     MOVE 'N'       CSW213                                              CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                     MD022981
      ** Setup Key Field for DLRPIFPD                                                       MD022981
      *                                                                                     MD022981
     C           RPIFKY    KLIST                                                            MD022981
     C                     KFLD           KDTYP                                             MD022981
     C                     KFLD           KDLNO                                             MD022981
      *                                                                                       CSW214
      ** Check if SWIFT 2014  is on                                                           CSW214
      *                                                                                       CSW214
     C                     CALL 'SWIF2014'                                                    CSW214
     C                     PARM *BLANKS   PRTCD                                               CSW214
      *                                                                                       CSW214
     C           PRTCD     IFEQ 'CSW2014'                                                     CSW214
     C                     MOVEL'Y'       CSW214  1                                           CSW214
     C                     ELSE                                                               CSW214
     C                     MOVEL'N'       CSW214                                              CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW213
     C/COPY WNCPYSRC,MG0341C002
      *
     C                     ENDSR
     C/EJECT                                                                               MD022633A
      *****************************************************************                    MD022633A
      *                                                               *                    MD022633A
      *  GETRCL- Get record length                                    *                    MD022633A
      *                                                               *                    MD022633A
      *****************************************************************                    MD022633A
      *                                                                                    MD022633A
     C           GETRCL    BEGSR                                                           MD022633A
      *                                                                                    MD022633A
     C           'UTGETRCD'CAT  'LN'      P#PGM  10                                        MD022633A
      *                                                                                    MD022633A
     C                     CALL P#PGM                                                      MD022633A
     C                     PARM           P#RTCD 10                                        MD022633A
     C                     PARM           P#RCDL  50                                       MD022633A
     C                     PARM           P#FILN 10                                        MD022633A
     C                     PARM '*LIBL'   P#LIBN 10                                        MD022633A
      *                                                                                    MD022633A
     C           P#RTCD    IFNE *BLANK                                                     MD022633A
     C                     EXSR *PSSR                                                      MD022633A
     C                     ENDIF                                                           MD022633A
      *                                                                                    MD022633A
     C                     ENDSR                                                           MD022633A
      /EJECT
      *****************************************************************
      *   INTF - Initalise non-constant fields                        *
      *   Called by - main process                                    *
      *****************************************************************
      *
     C           INTF      BEGSR
      *
     C                     MOVE *BLANKS   AWBA6   6
     C                     MOVELMGAWBA    AWBA6   6
     C                     MOVE *BLANKS   TRNO
     C                     MOVE *BLANKS   @TRNA
     C                     MOVE '      '  NWRK
     C**********           Z-ADD0         SECN                                                CSD027
     C                     MOVE *BLANKS   SECN                                                CSD027
     C                     MOVE *BLANKS   NWSN
     C**********           Z-ADD0         DECN                                                CSD027
     C                     MOVE *BLANKS   DECN                                                CSD027
     C                     MOVE *BLANKS   NWDS
     C                     MOVE *BLANKS   MGSG
     C                     MOVE *BLANKS   MGST
     C                     MOVE *BLANKS   LSCC
     C                     MOVE *BLANK    F57U
     C                     MOVE *BLANKS   CWRD
     C                     Z-ADD0         MGTM
     C                     Z-ADD0         LATM
     C                     MOVE *BLANKS   RELD
     C                     Z-ADD0         RELT
     C                     MOVE *BLANKS   AMTS
     C                     MOVE *BLANKS   SVDT
     C                     MOVE *BLANKS   CINDV                           184718
      *
     C                     MOVE *BLANKS   @ERR    1
     C                     MOVE *BLANKS   SCSID  12
     C                     MOVE *BLANKS   STELX  10
     C                     MOVE *BLANKS   SSTTX  12
     C                     MOVE *BLANKS   SCRNM  20
     C                     MOVE *BLANKS   SPCNB   6
     C                     MOVE *BLANKS   SPAIN   1
      *                                                                                     MD022633
     C                     MOVE *BLANKS   WRKMRJ                                            MD022633
     C                     MOVE *BLANKS   WRKMRP                                            MD022633
     C                     MOVE *BLANKS   WRKMRN                                           MD022633A
     C                     MOVE *BLANKS   WRKMRC                                           MD022633A
     C                     MOVE *BLANKS   WRKMRS                                           MD022633A
     C                     MOVE *BLANKS   WRKMRL                                           MD022633A
     C                     MOVE *BLANKS   WRKMRA                                           MD022633A
      *
      **  Currently positioned at line 1 of Field :72:
      *
     C                     MOVE 'N'       LINE2   1
      *
      **  Clear multiple occurrence data structure
      *
     C**********           Z-ADD1         X       20                                          CSW213
     C                     Z-ADD1         X                                                   CSW213
     C           X         OCUR MULT
      *
     C***********X         DOWLE40                                        CSW200
     C********** X         DOWLE46                                                     CSW200 CSW213
     C           X         DOWLE160                                                           CSW213
     C           MULT      ANDNE*BLANKS
     C                     MOVE *BLANKS   MULT
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END
      *
      **  Obtain sequence numbers from transaction record
      *
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     CALL 'MG5000'               24                                     CSW213
     C                     PARM MGTTYP    @MODI   2                                           CSW213
     C                     PARM MGTNUM    @TRAN  15                                           CSW213
     C                     PARM 'CE'      @PROG   2                                           CSW213
     C                     PARM 'U'       @MODE   1                                           CSW213
     C                     PARM *ZEROS    MGLSWC  30                                          CSW213
     C                     PARM *ZEROS    MGLSWS  30                                          CSW213
     C                     PARM *BLANKS   @ERCD   1                                           CSW213
     C                     ELSE                                                               CSW213
     C                     CALL 'MG5000'               26
     C                     PARM MGMODI    @MODI   2
     C                     PARM MGTNUM    @TRAN  15
     C                     PARM 'CF'      @PROG   2
     C                     PARM *BLANKS   @MODE   1
     C                     PARM *ZEROS    MGLSWC  30
     C                     PARM *ZEROS    MGLSWS  30
     C                     PARM *BLANKS   @ERCD   1
     C                     ENDIF                                                              CSW213
      *
      **  Error on access for sequence number
      *
     C           @ERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     MOVE '007'     DBASE            * * * * * * * *
     C                     MOVELMODI      DBKEY            *  DBERR 007  *
     C                     MOVE MTRN      DBKEY            * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Program missing on call.
      *
     C           *IN26     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '008'     DBASE            * * * * * * * *
     C                     MOVE 'MG5000'  DBKEY            *  DBERR 008  *
     C                     OUT  LDA                        * * * * * * * *
     C                     EXSR *PSSR
     C                     END
     C           *LOCK     IN   LDA
     C                     MOVEL'MG0341  'DBPGM
     C                     OUT  LDA
      *
      * If the branch code on the file MGF341PD is blank,
      * then defualt it to the branch code on the SDBRCHPD.
      *
     C           MGBRCA    IFEQ *BLANK
     C                     MOVELA8BRCD    MGBRCA
     C                     END
      *
      ** If our receive branch is blank then default it to the
      ** branch code.
      *
     C           MGROBR    IFEQ *BLANK
     C                     MOVELMGBRCA    MGROBR
     C                     END
      *
     C                     ENDSR
     C/EJECT                                                                                MD023007
      *****************************************************************                     MD023007
      *   SRRPPT - Match RPPT details for Reporting Jurisdiction and  *                     MD023007
      *            Reporting Party fields                             *                     MD023007
      *   Called by SRFMTD                                            *                     MD023007
      *   Calls -                                                     *                     MD023007
      *****************************************************************                     MD023007
      *                                                                                     MD023007
     C           SRRPPT    BEGSR                                                            MD023007
      *                                                                                     MD023007
      ** Initialize work fields                                                             MD023007
     C                     Z-ADD1         IX1     10                                        MD023007
     C                     Z-ADD1         IX2     10                                        MD023007
     C                     Z-ADD0         IX                                                MD023007
      *                                                                                     MD023007
      ** Main loop for RPPT                                                                 MD023007
      *                                                                                     MD023007
     C           IX1       DOWLE4                                                           MD023007
      *                                                                                     MD023007
     C           IX1       LOKUPIX                       98                                 MD023007
      *                                                                                     MD023007
     C           *IN98     IFEQ '0'                                                         MD023007
     C                     MOVE IX1       IX,IX2                                            MD023007
     C           IX1       OCUR RPPT                                                        MD023007
     C                     MOVELRPPT      WRPPT1136                                         MD023007
     C                     ADD  1         IX2                                               MD023007
      *                                                                                     MD023007
     C                     Z-ADD1         IX3     10                                        MD023007
      *                                                                                     MD023007
      ** Search a match for each Reporting Party details,                                   MD023007
      ** then resequence the occurence for all combined RPPT details                        MD023007
      *                                                                                     MD023007
     C           IX3       DOWLE4                                                           MD023007
      *                                                                                     MD023007
     C           IX3       IFNE IX1                                                         MD023007
     C           IX3       OCUR RPPT                                                        MD023007
     C                     MOVELRPPT      WRPPT2136                                         MD023007
      *                                                                                     MD023007
     C           WRPPT1    IFEQ WRPPT2                                                      MD023007
     C                     MOVE IX3       IX,IX2                                            MD023007
     C                     ADD  1         IX2                                               MD023007
     C                     ENDIF                                                            MD023007
     C                     ENDIF                                                            MD023007
      *                                                                                     MD023007
     C                     ADD  1         IX3                                               MD023007
      *                                                                                     MD023007
     C                     ENDDO                                                            MD023007
     C                     ENDIF                                                            MD023007
      *                                                                                     MD023007
     C                     ADD  1         IX1                                               MD023007
      *                                                                                     MD023007
     C                     ENDDO                                                            MD023007
      *                                                                                     MD023007
     C                     ENDSR                                                            MD023007
      /EJECT
      *****************************************************************
      *   SRROUT - determine message routing                          *
      *   Called by - main process                                    *
      *   Calls - MG9900 (Midas MG Standard routing API)              *
      *****************************************************************
      *
     C           SRROUT    BEGSR
      *
     C                     MOVE MGBRCA    I@SNBR
     C                     MOVE *BLANKS   I@DSCN
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     MOVELMGPTYA    I@DSCN                                              CSW213
     C                     ELSE                                                               CSW213
     C                     MOVE MGCNUM    I@DSCN
     C                     ENDIF                                                              CSW213
     C                     MOVE '341'     I@MTPY
     C                     MOVE 'Y'       I@CONC
     C                     Z-ADD0         I@SETT
     C                     MOVE *BLANK    I@FTCS
     C                     MOVE MGMODI    I@MMOD
      *
      * Add copy sources for enhancement methodology
      * one copy source for all MG generation programs and one
      * specific
      *
      * General
     C/COPY WNCPYSRC,MG9900CALL
      *
     C*********************CALL 'MG9900'                                                      CSW036
     C                     CALL 'MG9901'                                                      CSW036
     C                     PARM *BLANKS   @RTCD
     C                     PARM           P@IN
     C                     PARM *BLANKS   P@OUT
     C                     PARM           P@ZZ  256
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '019'     DBASE              * * * * * * *
     C                     MOVEL'*CALL  ' DBKEY              * DBERR 019 *
     C*********************MOVEL'MG9900'  DBFILE             * * * * * * *                    CSW036
     C                     MOVEL'MG9901'  DBFILE             * * * * * * *                    CSW036
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C                     MOVE O@NWRK    NWRK
     C**********           Z-ADDO@CNSN    SECN                                                CSD027
     C                     MOVE O@CNSN    SECN                                                CSD027
     C                     MOVE O@NWSN    NWSN
     C**********           Z-ADDMGCNUM    DECN                                                CSD027
     C                     MOVE MGCNUM    DECN                                                CSD027
     C                     MOVE O@NWDS    NWDS
     C                     MOVE O@MGSG    MGSG
     C                     MOVE O@MGST    MGST
     C                     MOVE O@PCNB    SPCNB
     C                     MOVE O@PAIN    SPAIN
     C                     END
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *   FMTFLD - Format MT341 fields for output                     *
      *   Called by - main process                                    *
      *   Calls - DATES format fields 30, 31C, 32a, 34a, 37M, 37R and *
      *           38D.                                                *
      *         - PAY   format fields 53a, 56a, and 57a for PAY       *
      *         - RECV  format fields 53a, 56a, and 57a for RECEIVE   *
      *         - FLD72 format field 72                               *
      *****************************************************************
      *
     C           FMTFLD    BEGSR
      *
      ** Field :20: -  Transaction Reference Number.
      *
     C**********           Z-ADD1         X       20                                          CSW213
     C                     Z-ADD1         X                                                   CSW213
     C           X         OCUR MULT
     C                     MOVEA*BLANKS   @WRK
      *
     C                     Z-ADD1         Z       20
     C                     MOVEAMGMODI    @WRK
     C                     MOVEAMGTNUM    @WRK,3
     C           MGLSWS    ADD  1         HLSWS   30
     C                     MOVE HLSWS     HSWS    3
      *
     C           ' '       LOKUP@WRK,Z                   31
     C                     MOVEAHSWS      @WRK,Z
      *
      **  Check on MGREFPD for a uniqne TRN,else output as an error.
      **  and store the TRN of the new confirmation message.
      *
     C                     MOVEA@WRK      @TRNA  16
      *
     C           @TRNA     CHAINMGREFL0              11
      *
      ** If record is found flag field is in error.
      *
     C           *IN11     IFEQ '0'
     C                     MOVE 'Y'       @ERR
     C                     MOVEAMSGA,8    MERR
     C                     END
      *
     C                     MOVEL':20:'    MTAG
     C                     MOVEA@WRK      MFLD
      *
      ** Field :21: - Related Reference.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVEA*BLANKS   @WRK
      *
      ** If related ref. is not blank, then use it as field of tag.
      ** Else, use transaction number.
      *
     C           MGRREF    IFEQ *BLANKS
      *
     C                     Z-ADD1         Z
     C                     MOVEAMGMODI    @WRK
     C                     MOVEAMGTNUM    @WRK,3
     C                     MOVELMGLSWC    WLSWC   3
      *
     C           ' '       LOKUP@WRK,Z                   31
     C                     MOVEAWLSWC     @WRK,Z
     C                     MOVEA@WRK      MFLD
      *
     C                     ELSE
      *
     C                     MOVELMGRREF    MFLD
      *
     C                     ENDIF
      *
      **  Obtain transaction reference of previous MT341                                      190127
     C                     MOVELMGTNUM    HSTRAN                                              190127
     C                     MOVE '341'     HSMTPY                                              190127
      *                                                                                       190127
     C                     MOVE HSTRAN    @HTRN   6                                           190127
      *                                                                                       190127
     C********** HSKEY     SETGTMGHISTL0                                               190127 CSW213
     C**********           READPMGHISTL0                 56                            190127 CSW213
     C           HSKEY     SETGTMGHISTL7                                                      CSW213
     C                     READPMGHISTL7                 56                                   CSW213
      *                                                                                       190127
     C           *IN56     IFEQ '0'                                                           190127
     C           HSMODI    ANDEQMGMODI                                                        190127
     C           HSTRAN    ANDEQ@HTRN                                                         190127
     C           HSMTPY    ANDEQ'341'                                                         190127
     C                     MOVEL@HREF     MFLD                                                190127
     C                     END                                                                190127
      *
     C                     MOVEL':21:'    MTAG
      *
      ** Field :22: - Code/Common Reference.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZCREF
      *
      ** If SWIFT network, use sender & destination customer swift ad.
      ** and the exchange rate to produce the common reference. Else
      ** use the message TRN.
      *
     C           NWRK      IFEQ 'SWIFT'
     C           NWRK      OREQ 'STTX'
      *
     C           NWRK      IFEQ 'SWIFT'
     C                     MOVELNWSN      ZSSWI
     C                     MOVELNWDS      ZDSWI
     C                     ELSE
     C                     MOVELSCSID     ZSSWI
     C                     MOVELCSID      ZDSWI
     C                     END
      *
     C                     MOVE MGCRAT    ZRATE
      *
      ** Format SWIFT common reference.
      *
     C                     CALL 'ZM0020'               15
     C                     PARM           ZSSWI  12
     C                     PARM           ZDSWI  12
     C                     PARM           ZRATE  138
     C                     PARM           ZCREF  16
      *
      ** If the program ends in error.
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '011'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 011 *
     C                     MOVEL'ZM0020'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     END
      *
     C           ZCREF     IFEQ *BLANKS
     C                     MOVEL@TRNA     ZCREF
     C                     END
      *
     C                     MOVEL':22:'    MTAG
      *
      ** Construct Field 22 - 'codeword/common reference'.
      *
      ** If last change type is equal to 'C', codeword is set to
      ** 'CANCEL', if equal to 'A', then set it to 'AMEND',
      ** otherwise set it to 'SETTLE'.
      *
     C           MGCHTP    IFEQ 'C'
     C                     MOVEL'CANCEL  'CWRD
     C                     ELSE
      *
     C           MGCHTP    IFEQ 'A'
     C                     MOVEL'AMEND   'CWRD
     C                     ELSE
      *
     C                     MOVEL'SETTLE  'CWRD
      *
     C                     ENDIF
     C                     ENDIF
      *
     C**********           Z-ADD1         I       20                                          CSW213
     C                     Z-ADD1         I                                                   CSW213
     C                     MOVEA*BLANKS   @WRK
     C                     MOVEACWRD      @WRK,I
     C           ' '       LOKUP@WRK,I                   31
      *
     C                     MOVEA'/'       @WRK,I
     C                     ADD  1         I
     C                     MOVEAZCREF     @WRK,I
     C                     MOVEA@WRK      MFLD
      *
      ** Codeword blank.
      *
     C           CWRD      IFEQ *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     MOVEAMSGA,7    MERR
     C                     END
      *
      ** Format fields 30, 31C, 32a, and 34a. via SR/DATES.
      *
     C                     EXSR DATES
      *
      ** Field :37M: - Contract rate.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     Z-ADDMGCRAT    ZPRIC  158
     C                     MOVE *BLANKS   ZSPRIC 16
     C                     MOVE *BLANKS   ZOPRIC 21
      *
      ** Format :37M:
      *
     C                     CALL 'ZM1190'               28
     C                     PARM           ZPRIC
     C                     PARM           ZSPRIC
     C                     PARM           ZOPRIC
      *
      ** If program is not found, then dbase error.
      *
     C           *IN28     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '012'     DBASE            * * * * * * * *
     C                     MOVE *BLANKS   DBKEY            *  DBERR 012  *
     C                     MOVEL'ZM1190'  DBPGM            * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     MOVE ':37M:'   MTAG
      *
      ** Move formatted data into output field.
      *
     C                     MOVELZSPRIC    MFLD
      *
      ** Field :37R: - Settlement rate.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     Z-ADDMGSRAT    ZPRIC
     C                     MOVE *BLANKS   ZSPRIC
     C                     MOVE *BLANKS   ZOPRIC
      *
      ** Format :37R:
      *
     C                     CALL 'ZM1190'               15
     C                     PARM           ZPRIC
     C                     PARM           ZSPRIC
     C                     PARM           ZOPRIC
      *
     C                     MOVE ':37R:'   MTAG
      *
      ** Move formatted data into output field.
      *
     C                     MOVELZSPRIC    MFLD
      *                                                                                       226723
     C           MGSRAT    IFLT 0                                                             226723
     C           'N'       CAT  MFLD      MFLD                                                226723
     C                     ENDIF                                                              226723
      *
      ** Format :38D: - Contract Period.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE ':38D:'   MTAG
     C                     MOVELMGCPER    MFLD
      *
      ** If pay/receive indicator is equal to 'P' then
      ** validate fields 53a, 56a and 57a using SR/PAY.
      *
     C           MGPORR    IFEQ 'P'
     C                     EXSR PAY
      *
      ** else, use SR/RECV ('R').
      *
     C                     ELSE
     C                     EXSR RECV
     C                     END
      *
      ** Format field :77D: - Conditions.
      *
     C           MGCON1    IFNE *BLANKS
      *
      ** Store the CONDITIONS information for easier use.
      *
     C                     MOVE MGCON1    S2RF,1
     C                     MOVE MGCON2    S2RF,2
     C                     MOVE MGCON3    S2RF,3
     C                     MOVE MGCON4    S2RF,4
     C                     MOVE MGCON5    S2RF,5
     C                     MOVE MGCON6    S2RF,6
      *
     C                     Z-ADD0         I
     C                     MOVE 'N'       FLD77O  1
      *
      ** Search through all six fields & output if not blank.
      *
     C           I         DOWLT6
      *
     C                     ADD  1         I
     C           S2RF,I    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C           FLD77O    IFEQ 'N'
     C                     MOVE ':77D:'   MTAG
     C                     MOVE 'Y'       FLD77O
     C                     ENDIF
     C                     MOVELS2RF,I    MFLD
     C                     ENDIF
      *
     C                     ENDDO
      *
     C                     ENDIF
      *
      ** Format field :72:
      *
     C                     EXSR FLD72
      *
     C                     ENDSR
      /EJECT
      *****************************************************************   CSW200
      *   FFLD2K - Format MT341 fields, with Swift 2000 changes       *   CSW200
      *   Called by - main process                                    *   CSW200
      *   Calls - DAT200 format fields 15B, 30T, 32B, 30F and 30P     *   CSW200
      *         - PAY200 format fields 53, 56, and 57 for PAY         *   CSW200
      *         - RECV   format fields 53a, 56a, and 57a for RECEIVE  *   CSW200
      *         - FLD72  format field 72                              *   CSW200
      *         - FSWAD  format Swift address fields                  *   CSW200
      *****************************************************************   CSW200
      *                                                                   CSW200
     C           FFLD2K    BEGSR                                          CSW200
      *                                                                   CSW200
      ** FIELD :15A: - New Sequence                                       CSW200
      *                                                                   CSW200
     C                     Z-ADD1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVEL':15A:'   MTAG                            CSW200
     C                     MOVE *BLANKS   MFLD                            CSW200
      *                                                                   CSW200
      ** Field :20: -  Transaction Reference Number.                      CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVEA*BLANKS   @WRK                            CSW200
      *                                                                   CSW200
     C                     Z-ADD1         Z       20                      CSW200
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     MOVE MGMODI    @TRN11                                              CSW213
     C                     MOVELMGTNUM    @TRN21                                              CSW213
     C                     MOVELMGCNUM    @TRN31                                              CSW213
     C           MGLSWS    ADD  1         @TRN41                                              CSW213
     C                     MOVE ':20: '   MTAG                                                CSW213
     C**********           MOVEL@TRN1     MFLD                                       CSW213 MD022733
     C**********           MOVEL@TRN1     @WRK                                     MD022733 MD023278
     C                     MOVEA@TRN1     @WRK                                              MD023278
      *                                                                                       CSW213
      **  Store the TRN of the new confirmation message                                       CSW213
     C                     MOVEL@TRN1     @TRNA  16                                           CSW213
      *                                                                                       CSW213
     C                     ELSE                                                               CSW213
     C                     MOVEAMGMODI    @WRK                            CSW200
     C                     MOVEAMGTNUM    @WRK,3                          CSW200
     C           MGLSWS    ADD  1         HLSWS   30                      CSW200
     C                     MOVE HLSWS     HSWS    3                       CSW200
      *                                                                   CSW200
     C           ' '       LOKUP@WRK,Z                   31               CSW200
     C                     MOVEAHSWS      @WRK,Z                          CSW200
      *                                                                   CSW200
      **  Check on MGREFPD for a uniqne TRN,else output as an error.      CSW200
      **  and store the TRN of the new confirmation message.              CSW200
      *                                                                   CSW200
     C                     MOVEA@WRK      @TRNA  16                       CSW200
      *                                                                                       CSW213
     C                     ENDIF                                                              CSW213
      *                                                                   CSW200
     C           @TRNA     CHAINMGREFL0              11                   CSW200
      *                                                                   CSW200
      ** If record is found flag field is in error.                       CSW200
      *                                                                   CSW200
     C           *IN11     IFEQ '0'                                       CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVEAMSGA,8    MERR                            CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     MOVEL':20:'    MTAG                            CSW200
     C                     MOVEA@WRK      MFLD                            CSW200
      *                                                                   CSW200
      ** Field :21: - Related Reference.                                  CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVEA*BLANKS   @WRK                            CSW200
      *                                                                                       CSW213
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     MOVELMGCNUM    WDEST   6                                           CSW213
     C                     ELSE                                                               CSW213
     C                     MOVEL*BLANKS   WDEST                                               CSW213
     C                     ENDIF                                                              CSW213
      *                                                                   CSW200
      ** If related ref. is not blank, then use it as field of tag.       CSW200
      ** Else, use transaction number.                                    CSW200
      *                                                                   CSW200
     C           MGRREF    IFEQ *BLANKS                                   CSW200
      *                                                                   CSW200
     C                     Z-ADD1         Z                               CSW200
     C                     MOVEAMGMODI    @WRK                            CSW200
     C                     MOVEAMGTNUM    @WRK,3                          CSW200
     C           MGACMI    IFEQ 'Y'                                                         MD022733
     C                     MOVELMGCNUM    HSDEST                                            MD023278
     C                     MOVEAMGCNUM    @WRK,9                                            MD022733
     C                     ENDIF                                                            MD022733
     C                     MOVELMGLSWC    WLSWC   3                       CSW200
      *                                                                   CSW200
     C           ' '       LOKUP@WRK,Z                   31               CSW200
     C                     MOVEAWLSWC     @WRK,Z                          CSW200
     C                     MOVEA@WRK      MFLD                            CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
     C                     MOVELMGRREF    MFLD                            CSW200
      *                                                                   CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      **  Obtain transaction reference of previous MT341                                      190127
     C                     MOVELMGTNUM    HSTRAN                                              190127
     C                     MOVE '341'     HSMTPY                                              190127
      *                                                                                       190127
     C                     MOVE HSTRAN    @HTRN   6                                           190127
      *                                                                                       190127
     C********** HSKEY     SETGTMGHISTL0                                               190127 CSW213
     C**********           READPMGHISTL0                 56                            190127 CSW213
     C           HSKEY     SETGTMGHISTL7                                                      CSW213
     C                     READPMGHISTL7                 56                                   CSW213
      *                                                                                       190127
     C           *IN56     IFEQ '0'                                                           190127
     C           HSMODI    ANDEQMGMODI                                                        190127
     C           HSTRAN    ANDEQ@HTRN                                                         190127
     C           HSDEST    ANDEQWDEST                                                         CSW213
     C           HSMTPY    ANDEQ'341'                                                         190127
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     MOVE *BLANKS   MFLD                                              MD023278
     C                     MOVE HSMODI    H1MODI                                            MD023278
     C                     MOVE HSTRAN    H1TRAN                                            MD023278
     C                     MOVE HSSEQ     @SSEQ                                               CSW213
     C                     MOVEL@HREF1    MFLD                                                CSW213
     C                     ELSE                                                               CSW213
     C                     MOVEL@HREF     MFLD                                                190127
     C                     END                                                                190127
     C                     ENDIF                                                              CSW213
      *
     C                     MOVEL':21:'    MTAG                            CSW200
      *                                                                   CSW200
      ** Field :22A: Type of Operation                                    CSW200
      *                                                                   CSW200
     C**********           ADD  1         X       20                                   CSW200 CSW213
     C                     ADD  1         X       30                                          CSW213
     C           X         OCUR MULT                                      CSW200
     C                     MOVEL':22A:'   MTAG                            CSW200
      *                                                                   CSW200
     C                     SELEC                                          CSW200
      *                                                                   CSW200
     C           MGCHTP    WHEQ 'C'                                       CSW200
     C                     MOVEL'CANC'    MFLD                            CSW200
      *                                                                   CSW200
     C           MGCHTP    WHEQ 'A'                                       CSW200
     C                     MOVEL'AMND'    MFLD                            CSW200
      *                                                                   CSW200
     C                     OTHER                                          CSW200
     C                     MOVEL'SETT'    MFLD                            CSW200
      *                                                                   CSW200
     C                     ENDSL                                          CSW200
      *                                                                   CSW200
      ** Field 22C 'Common Reference'                                     CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVEL':22C:'   MTAG                            CSW200
     C                     MOVE *BLANKS   ZCREF                           CSW200
      *                                                                   CSW200
      ** If SWIFT network, use sender & destination customer swift ad.    CSW200
      ** and the exchange rate to produce the common reference. Else      CSW200
      ** use the message TRN.                                             CSW200
      *                                                                   CSW200
     C           NWRK      IFEQ 'SWIFT'                                   CSW200
     C           NWRK      OREQ 'STTX'                                    CSW200
      *                                                                   CSW200
     C           NWRK      IFEQ 'SWIFT'                                   CSW200
     C                     MOVELNWSN      ZSSWI                           CSW200
     C                     MOVELNWDS      ZDSWI                           CSW200
     C                     ELSE                                           CSW200
     C                     MOVELSCSID     ZSSWI                           CSW200
     C                     MOVELCSID      ZDSWI                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     MOVE MGCRAT    ZRATE                           CSW200
      *                                                                   CSW200
      ** Format SWIFT common reference.                                   CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0020'               15                 CSW200
     C                     PARM           ZSSWI  12                       CSW200
     C                     PARM           ZDSWI  12                       CSW200
     C                     PARM           ZRATE  138                      CSW200
     C                     PARM           ZCREF  16                       CSW200
      *                                                                   CSW200
      ** If the program ends in error.                                    CSW200
      *                                                                   CSW200
     C           *IN15     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '023'     DBASE              * * * * * * *CSW200
     C                     MOVEL'       ' DBKEY              * DBERR 023 *CSW200
     C                     MOVEL'ZM0020'  DBFILE             * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C           ZCREF     IFEQ *BLANKS                                   CSW200
     C                     MOVEL@TRNA     ZCREF                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     MOVELZCREF     MFLD                            CSW200
      *                                                                   CSW200
      ** Field 23D - Type of FRA                                          CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE ':23D:'   MTAG                            CSW200
      *                                                                   CSW200
     C           MGBORS    IFEQ 'S'                                       CSW200
     C           'FLOAT'   CAT  'FIXED'   MFLD                            CSW200
     C                     ELSE                                           CSW200
     C           'FIXED'   CAT  'FLOAT'   MFLD                            CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      ** Field 82  - Party A Identifier                                   CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C**********           CALL 'AOBRCHR0'                                             CSW200 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD                           CSW200
     C                     PARM '*KEY   ' @OPTN                           CSW200
     C                     PARM MGBRCA    @BRCD   3                       CSW200
     C           SDBRCH    PARM SDBRCH    DSSDY                           CSW200
      *                                                                   CSW200
      ** Branch record not found - Error                                  CSW200
      *                                                                   CSW200
     C           @RTCD     IFNE *BLANKS                                   CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '024'     DBASE              * * * * * * *CSW200
     C                     MOVELMGBRCA    DBKEY              * DBERR 024 *CSW200
     C                     MOVEL'SDBRCHPD'DBFILE             * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELA8BICN    ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE 35                       CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '82'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
      *                                                                   CSW200
      ** Field 87  - Party B Identifier                                   CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELMGCNUM    ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE 35                       CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '87'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
      *                                                                   CSW200
      ** Format field :72: Sender to Receiver Information                 CSW200
      *                                                                   CSW200
     C                     EXSR FLD72                                     CSW200
      *                                                                   CSW200
      ** Format fields 15B, 30T, 32B, 30F and 30P via SR/DAT200.          CSW200
      *                                                                   CSW200
     C                     EXSR DAT200                                    CSW200
      *                                                                   CSW200
      ** Field :37M: - Contract rate.                                     CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     Z-ADDMGCRAT    ZPRIC  158                      CSW200
     C                     MOVE *BLANKS   ZSPRIC 16                       CSW200
     C                     MOVE *BLANKS   ZOPRIC 21                       CSW200
      *                                                                   CSW200
      ** Format :37M:                                                     CSW200
      *                                                                   CSW200
     C                     CALL 'ZM1190'               28                 CSW200
     C                     PARM           ZPRIC                           CSW200
     C                     PARM           ZSPRIC                          CSW200
     C                     PARM           ZOPRIC                          CSW200
      *                                                                   CSW200
      ** If program is not found, then dbase error.                       CSW200
      *                                                                   CSW200
     C           *IN28     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '020'     DBASE            * * * * * * * *CSW200
     C                     MOVE *BLANKS   DBKEY            *  DBERR 020  *CSW200
     C                     MOVEL'ZM1190'  DBPGM            * * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     MOVE ':37M:'   MTAG                            CSW200
      *                                                                   CSW200
      ** Move formatted data into output field.                           CSW200
      *                                                                   CSW200
     C                     MOVELZSPRIC    MFLD                            CSW200
      *                                                                   CSW200
      *                                                                   CSW200
      ** Field :30V: - Fixing Date                                        CSW200
      *                                                                   CSW200
     C           MGAGTY    IFEQ 'AFB'                                     CSW200
     C           MGAGTY    OREQ 'FRABBA'                                  CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE ':30V:'   MTAG                            CSW200
     C                     Z-ADDMGFDAT    ZMDAY                           CSW200
      *                                                                   CSW200
      **  Convert Midas date to SWIFT date format                         CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0065'               15                 CSW200
     C                     PARM           ZMDAY   50                      CSW200
     C                     PARM           ZSDATE  6                       CSW200
     C                     PARM           ZSDATC  8                       CSW200
      *                                                                   CSW200
      **  Call ended in error. (Program not found.)                       CSW200
      *                                                                   CSW200
     C           *IN15     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '021'     DBASE              * * * * * * *CSW200
     C                     MOVELZMDAY     DBKEY              * DBERR 021 *CSW200
     C                     MOVEL'ZM0065'  DBFILE             * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     MOVELZSDATC    MFLD                            CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      ** Format :38D: - Contract Period.                                  CSW200
      *                                                                   CSW200
     C           MGAGTY    IFEQ 'AFB'                                     CSW200
     C           MGAGTY    OREQ 'FRABBA'                                  CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE ':38D:'   MTAG                            CSW200
     C                     MOVELMGCPER    MFLD                            CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      ** FIELD :15C: - New Sequence                                       CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVEL':15C:'   MTAG                            CSW200
     C                     MOVE *BLANKS   MFLD                            CSW200
      *                                                                   CSW200
      ** Field :37R: - Settlement rate.                                   CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     Z-ADDMGSRAT    ZPRIC                           CSW200
     C                     MOVE *BLANKS   ZSPRIC                          CSW200
     C                     MOVE *BLANKS   ZOPRIC                          CSW200
      *                                                                   CSW200
      ** Format :37R:                                                     CSW200
      *                                                                   CSW200
     C                     CALL 'ZM1190'               15                 CSW200
     C                     PARM           ZPRIC                           CSW200
     C                     PARM           ZSPRIC                          CSW200
     C                     PARM           ZOPRIC                          CSW200
      *                                                                   CSW200
     C                     MOVE ':37R:'   MTAG                            CSW200
      *                                                                   CSW200
      ** Move formatted data into output field.                           CSW200
      *                                                                   CSW200
     C                     MOVELZSPRIC    MFLD                            CSW200
      *                                                                                       226723
     C           MGSRAT    IFLT 0                                                             226723
     C           'N'       CAT  MFLD      MFLD                                                226723
     C                     ENDIF                                                              226723
      *                                                                   CSW200
      *                                                                   CSW200
      ** Field :34E: - Interest Amount                                    CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVE MGCCY     WKCCY   3                                           244488
     C           WKCCY     CHAINSDCURRD0             89                                       244488
     C                     MOVE A6CYCD    MGCCY                                               244488
      *                                                                                       244488
     C                     MOVE MGCCY     ZCCY                            CSW200
     C                     MOVE MGSAMT    ZAMNT                           CSW200
     C                     CALL 'ZM0040'                                  CSW200
     C                     PARM           ZAMNT                           CSW200
     C                     PARM           ZCCY                            CSW200
     C                     PARM *BLANKS   ZSAMNT                          CSW200
     C                     PARM *BLANKS   ZSCCY                           CSW200
     C                     PARM *BLANKS   ZERR                            CSW200
     C                     PARM           ZSWDPC  1                                           222373
      *                                                                   CSW200
     C                     MOVE ':34E:'   MTAG                            CSW200
     C           ZSCCY     CAT  ZSAMNT    MFLD                            CSW200
     C           MGPORR    IFNE 'P'                                       CSW200
     C***********MGSAMT    ANDLT*ZERO                               CSW200186533
     C           'N'       CAT  MFLD      MFLD                            CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C           MGPORR    IFEQ 'P'                                       CSW200
     C                     EXSR PAY200                                    CSW200
     C                     ELSE                                           CSW200
     C                     EXSR RECV                                      CSW200
     C                     ENDIF                                          CSW200
      *                                                                                       CSW213
      ** Format message detail - CSW213                                                       CSW213
      *                                                                                       CSW213
     C           CSW213    IFEQ 'Y'                                                           CSW213
      *                                                                                     MD022981
     C                     MOVELMGTTYP    KDTYP   2                                         MD022981
     C                     MOVELMGTNUM    KDLNO  16                                         MD022981
      *                                                                                     MD022981
     C           RPIFKY    CHAINDLRPIFL1             20                                     MD022981
      *                                                                                     MD022981
     C           *IN20     IFEQ '0'                                                         MD022981
     C                     EXSR SRFMTD                                                        CSW213
     C                     ENDIF                                                            MD022981
     C                     ENDIF                                                              CSW213
      *                                                                   CSW200
     C                     ENDSR                                          CSW200
      /EJECT                                                              CSW200
      *****************************************************************
      *   REPT - print incorrectly generated messages                 *
      *   Called by - main process                                    *
      *****************************************************************
      *
     C           REPT      BEGSR
      *
      ** If MG0341P1 has not previously opened.
      *
     C           *IN50     IFEQ '0'
     C                     OPEN MG0341P1
     C                     MOVE *ON       *IN50
     C                     END
      *
     C                     WRITEHEADER
     C                     WRITETEXT
      *
      **  Process multiple occurrence data structure
      *
     C**********           Z-ADD0         I       20                                          CSW213
     C                     Z-ADD0         I       30                                          CSW213
     C           I         DOWLEX
     C                     ADD  1         I
     C           I         OCUR MULT
     C           *IN99     IFEQ '1'                                                           CSW213
     C                     WRITEHEADER                                                        CSW213
     C                     WRITETEXT                                                          CSW213
     C                     WRITELINE                                                          CSW213
     C                     ELSE                                                               CSW213
     C                     WRITELINE
     C                     ENDIF                                                              CSW213
     C                     END
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *   OMSG - output correctly generated messages                  *
      *   Called by - main process                                    *
      *   Calls - WREF Write o/p reference to PF/MGOREFPD.            *
      *****************************************************************
      *
     C           OMSG      BEGSR
      *
      **  Write reference record to PF/MGOREFPD.
      *
     C                     EXSR WREF
      *
      **  Write multiple occurrence data structure to MGOMSGPD
      *
     C**********           Z-ADD1         X       20                                          CSW213
     C                     Z-ADD1         X                                                   CSW213
     C           X         OCUR MULT
      *
     C***********X         DOWLE40                                        CSW200
     C********** X         DOWLE46                                                     CSW200 CSW213
     C           X         DOWLE157                                                           CSW213
     C           MFLD      ANDNE*BLANKS
     C********** X         ORLE 46                                                     CSW200 CSW213
     C           X         ORLE 157                                                           CSW213
     C           MTAG      ANDNE*BLANKS                                   CSW200
     C                     WRITEMGOMSGD0               06
      *
      **  Error on write to PF/MGOMSGPD (message data file)
      *
     C           *IN06     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '013'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 013  *
     C                     MOVEL'MGOMSGPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *   WREF - Write reference record to PF/MGOREFPD                *
      *   Called by - OMSG  output message PF/MGOMSGPD                *
      *****************************************************************
      *
     C           WREF      BEGSR
      *
     C                     MOVE *BLANKS   SYTM
     C                     MOVE MGMODI    MODI
     C                     MOVE @TRNA     TRNO
     C                     MOVE *BLANKS   TRNF
     C                     MOVE *BLANKS   TRNM
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     MOVEL@TRNID    MTRN                                                CSW213
     C                     ELSE                                                               CSW213
     C                     MOVELMGTNUM    MTRN
     C                     ENDIF                                                              CSW213
     C                     MOVE MGTTYP    TNTP
     C                     MOVE MGTSTP    SBTP
     C                     MOVE MGEVTP    EVTP
     C                     MOVEL*BLANKS   NWBN
     C                     MOVE '341'     MTPY
     C                     MOVE 'N'       MPRY
     C                     MOVELCWRD      LSCC
     C                     MOVEL*BLANKS   PTST
     C                     MOVEL*BLANKS   CARQ
     C                     MOVEL*BLANKS   MPDE
     C                     MOVEL@HRDT     HRDT
     C                     TIME           MGTM
     C                     MOVE BJMRDT    LADT
     C                     MOVE MGTM      LATM
      *                                                                                       CSD015
      ** Initiate the Midas Watch List Checking Engine if CSD015 is                           CSD015
      ** enabled and CSW025 is disabled.                                                      CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDEQ'N'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *
     C           MGST      IFEQ 'RSND'
     C                     MOVE BJMRDT    RELD
     C                     MOVE MGTM      RELT
     C                     MOVE '2'       MGSG
     C                     END
     C           MGST      IFEQ 'CRTD'
     C                     MOVE '1'       MGSG
     C                     END
     C           MGST      IFEQ 'PRTD'
     C                     MOVE '3'       MGSG
     C                     END
      *
     C                     MOVEL*BLANKS   RUSR
     C                     MOVEL*BLANKS   RWSN
     C                     MOVEL*BLANKS   AMTS
     C                     MOVEL*BLANKS   AMTX
     C                     MOVEL*BLANKS   SVDT
     C                     MOVEL*BLANKS   CINDV                           184718
     C                     MOVEL*BLANKS   CCY
     C                     MOVEL*BLANKS   NSNO
     C                     MOVEL*BLANKS   SACN
     C                     MOVEL*BLANKS   AORR
     C                     MOVEL*BLANKS   DESI
      *
      **  Branch details
      *
     C                     MOVE MGBRCA    BRCA
     C                     MOVE MGPOBR    OTHB
     C           OTHB      IFNE *BLANKS
     C                     MOVELMSGA,1    OTHT
     C                     END
     C                     MOVE MGROBR    RCBR
      *
     C                     MOVE *BLANKS   NETI
     C                     MOVE *BLANKS   DELC
     C                     MOVE *BLANKS   DYST
     C                     MOVE *BLANKS   RSID
     C                     MOVE *BLANKS   MSE1
     C                     MOVE *BLANKS   ELIN
     C                     MOVE *BLANKS   SSAC
     C                     MOVE *BLANKS   MIR
     C                     MOVE *BLANKS   TSKS
     C                     MOVE *BLANKS   TSKY
     C                     MOVE MGCHTP    AORR                                                CSW025
     C/COPY WNCPYSRC,MG0341C003
      *
     C                     WRITEMGOREFD0               05
      *
      **  Error on write to PF/MGOREFPD (message reference file)
      *
     C           *IN05     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '014'     DBASE            * * * * * * * *
     C                     MOVEL'       ' DBKEY            *  DBERR 014  *
     C                     MOVEL'MGOREFPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Write transaction history record                                                     190127
     C           MGACMI    IFEQ 'Y'                                                           CSW213
     C                     MOVELTRNO      @HREF1                                              CSW213
     C                     MOVE '000'     HSSEQ                                               CSW213
     C                     MOVE @SSEQ     HSSEQ                                               CSW213
     C                     ELSE                                                               CSW213
     C                     MOVELTRNO      @HREF                                               190127
     C                     ENDIF                                                              CSW213
     C                     MOVE '341'     HSMTPY                                              190127
      *                                                                                       190127
     C**********           WRITEMGHISTD0               56                              190127 CSW213
     C                     WRITEMGHIST                 56                                     CSW213
      *                                                                                       190127
      **  Error on write to PF/MGHISTPD                                                       190127
     C           *IN56     IFEQ '1'                                                           190127
     C           *LOCK     IN   LDA                                                           190127
     C                     MOVE '027'     DBASE            * * * * * * * *                    190127
     C                     MOVEL'       ' DBKEY            *  DBERR 027  *                    190127
     C                     MOVEL'MGHISTPD'DBFILE           * * * * * * * *                    190127
     C                     OUT  LDA                                                           190127
     C                     EXSR *PSSR                                                         190127
     C                     END                                                                190127
      *
     C                     ENDSR
     C/COPY WNCPYSRC,MG0341C004
      /EJECT
      *****************************************************************
      *   DATES - Format Date fields.                                 *
      *   Called by - FMTFLD  Format MT341 fields for output          *
      *****************************************************************
      *
     C           DATES     BEGSR
      *
      **  Field :30: - Date contract/agreed/amended.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE MGTDAT    ZMDAY
      *
      ** Convert Midas date to SWIFT date format.
      *
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
      ** Call ended in error. (Program not found.)
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '015'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 015 *
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     MOVE ':30: '   MTAG
     C                     MOVELZSDATE    MFLD
      *
      ** Field :31C: - Fixing Date.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE MGFDAT    ZMDAY
      *
      ** Convert Midas date to SWIFT date format.
      *
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
     C                     MOVE ':31C:'   MTAG
     C                     MOVELZSDATE    MFLD
      *
      ** Field :32: Maturity Date, Currency and Notional Amount.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE MGMDAT    ZMDAY
      *
      ** Convert Midas date to SWIFT date format.
      *
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
      ** Format currency code and notional amount.
      *
     C                     MOVE MGCCY     WKCCY   3                                           244488
     C           WKCCY     CHAINSDCURRD0             50                                       244488
     C                     MOVE A6CYCD    MGCCY                                               244488
      *                                                                                       244488
     C                     MOVE MGCCY     ZCCY
     C                     MOVE MGNOAM    ZAMNT
     C                     CALL 'ZM0040'
     C                     PARM           ZAMNT  130
     C                     PARM           ZCCY    3
     C                     PARM           ZSAMNT 15
     C                     PARM           ZSCCY   3
     C                     PARM           ZERR    1
     C                     PARM           ZSWDPC                                              222373
      *
      ** If buy/sell indicator is 'S' (SELL) then format field
      ** :32P:, otherwise field :32R:.
      *
     C           MGBORS    IFEQ 'S'
     C                     MOVE ':32P:'   MTAG
     C                     ELSE
     C                     MOVE ':32R:'   MTAG
     C                     END
      *
      ** Error - indicate erroneous fields;
      *
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVELERR3N     MFLD
     C                     MOVELMSGA,5    MERR
      *
     C                     ELSE
     C                     MOVELFLD3N     MFLD
     C                     END
      *
      ** Field 34 - Settlement Date, Currency, Settlement Amount.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
      ** Format currency and settlement amount.
      *
     C                     MOVE MGCCY     WKCCY   3                                           244488
     C           WKCCY     CHAINSDCURRD0             50                                       244488
     C                     MOVE A6CYCD    MGCCY                                               244488
      *                                                                                       244488
     C                     MOVE MGCCY     ZCCY
     C                     MOVE MGSAMT    ZAMNT
     C                     CALL 'ZM0040'
     C                     PARM           ZAMNT  130
     C                     PARM           ZCCY    3
     C                     PARM           ZSAMNT 15
     C                     PARM           ZSCCY   3
     C                     PARM           ZERR    1
     C                     PARM           ZSWDPC                                              222373
      *
      ** Format Settlement date.
      *
     C                     MOVE MGSDAT    ZMDAY
     C                     CALL 'ZM0060'
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
      ** If pay/receive indicator is 'P' (PAY) then format field
      ** :34P:, otherwise field :34R:.
      *
     C           MGPORR    IFEQ 'P'
     C                     MOVE ':34P:'   MTAG
     C                     ELSE
     C                     MOVE ':34R:'   MTAG
     C                     END
      *
      ** Error - indicate erroneous fields;
      *
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVELERR3N     MFLD
     C                     MOVELMSGA,5    MERR
      *
     C                     ELSE
     C                     MOVELFLD3N     MFLD
     C                     END
      *
     C                     ENDSR
      /EJECT
      *****************************************************************   CSW200
      *   DAT200- Format Date fields, with Swift 2000 changes         *   CSW200
      *   Called by - FFLD2K  Format MT341 fields for output          *   CSW200
      *****************************************************************   CSW200
      *                                                                   CSW200
     C           DAT200    BEGSR                                          CSW200
      *                                                                   CSW200
      ** FIELD :15B: - New Sequence                                       CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVEL':15B:'   MTAG                            CSW200
     C                     MOVE *BLANKS   MFLD                            CSW200
      *                                                                   CSW200
      **  Field :30: - Date contract/agreed/amended.                      CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE MGTDAT    ZMDAY                           CSW200
      *                                                                   CSW200
      ** Convert Midas date to SWIFT date format.                         CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0065'               15                 CSW200
     C                     PARM           ZMDAY                           CSW200
     C                     PARM           ZSDATE                          CSW200
     C                     PARM           ZSDATC                          CSW200
      *                                                                   CSW200
      ** Call ended in error. (Program not found.)                        CSW200
      *                                                                   CSW200
     C           *IN15     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '022'     DBASE              * * * * * * *CSW200
     C                     MOVEL'       ' DBKEY              * DBERR 022 *CSW200
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     MOVE ':30T:'   MTAG                            CSW200
     C                     MOVELZSDATC    MFLD                            CSW200
      *                                                                   CSW200
      ** Field :32B:  Notional amount                                     CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE MGCCY     WKCCY                                               244488
     C           WKCCY     CHAINSDCURRD0             50                                       244488
     C                     MOVE A6CYCD    MGCCY                                               244488
     C                     MOVE MGCCY     ZCCY                            CSW200
     C                     MOVE MGNOAM    ZAMNT                           CSW200
     C                     CALL 'ZM0040'                                  CSW200
     C                     PARM           ZAMNT                           CSW200
     C                     PARM           ZCCY                            CSW200
     C                     PARM *BLANKS   ZSAMNT                          CSW200
     C                     PARM *BLANKS   ZSCCY                           CSW200
     C                     PARM *BLANKS   ZERR                            CSW200
     C                     PARM           ZSWDPC                                              222373
      *                                                                   CSW200
     C                     MOVE ':32B:'   MTAG                            CSW200
     C           ZSCCY     CAT  ZSAMNT    MFLD                            CSW200
      *                                                                   CSW200
      *  Field :30F: Effective date                                       CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE MGSDAT    ZMDAY                           CSW200
      *                                                                   CSW200
      ** Convert Midas date to SWIFT date format.                         CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0065'               15                 CSW200
     C                     PARM           ZMDAY                           CSW200
     C                     PARM           ZSDATE                          CSW200
     C                     PARM           ZSDATC                          CSW200
      *                                                                   CSW200
     C                     MOVE ':30F:'   MTAG                            CSW200
     C                     MOVELZSDATC    MFLD                            CSW200
      *                                                                   CSW200
      ** Field :30P: Termination date                                     CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE MGMDAT    ZMDAY                           CSW200
      *                                                                   CSW200
      ** Convert Midas date to SWIFT date format.                         CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0065'               15                 CSW200
     C                     PARM           ZMDAY                           CSW200
     C                     PARM           ZSDATE                          CSW200
     C                     PARM           ZSDATC                          CSW200
      *                                                                   CSW200
     C                     MOVE ':30P:'   MTAG                            CSW200
     C                     MOVELZSDATC    MFLD                            CSW200
      *                                                                   CSW200
     C                     ENDSR                                          CSW200
      /EJECT                                                              CSW200
      *****************************************************************
      *   PAY  - Format fields 53, 56 and 57 for a payment            *
      *   Called by - FMTFLD Format MT341 fields for output           *
      *   Calls       FSWAD  Format Swift Address.                    *
      *****************************************************************
      *
     C           PAY       BEGSR
      *
     C                     MOVE *BLANKS   @WRK
      *
      ** Field 53 - Senders correspondant.
      **  Test if settlement via nostro
      *
     C                     MOVE MGPSTM    @STM    2
     C           @STM      LOKUPTABNST                   23
      *
      ** If our pay nostro is not blank and the settlement is via a nostro
      *
     C           MGPONS    IFNE *BLANKS
     C           *IN23     ANDEQ'1'
      *
      **  either A/C with Bank or Receipient entered
      **  or DIRECT entered
      *
     C           MGAWBN    IFNE *BLANKS
     C           AWBA6     OREQ 'DIRECT'
      *
     C                     MOVELMGPONS    @NONB
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *                                                                   137909
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6
     C***********          PARM MGCCY     @CYCD   3                       137909
     C                     PARM           @CYCD   3                       137909
     C**********           PARM *BLANKS   @ACCD   4                                           CGL029
     C                     PARM *BLANKS   @ACCD  10                                           CGL029
     C                     PARM *BLANKS   @ACSN   2
     C                     PARM           @NONB   2
     C                     PARM *BLANKS   @BRCD   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **  Nostro customer not found
      *
     C           @RTCD     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELMGPONS    HLD2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,3    MERR
     C                     ELSE
      *
      ** Branch Internal Customer cf. Customer number of Our Pay Nostro
      *
     C                     MOVELSECN      @SECN   6
     C           @SECN     IFNE A7CUST
     C           MGAWBN    ANDNEA7CUST
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C*********************CALL 'ZM0050'                                                      CSW036
     C                     CALL 'ZM0051'                                                      CSW036
     C                     PARM           ZDEST  12
     C                     PARM           ZSADD1 35
     C                     PARM           ZSADD2 35
     C                     PARM           ZSADD3 35
     C                     PARM           ZSADD4 35
     C                     PARM           ZSTAG   1
     C                     PARM           ZSTYPE  1
     C                     PARM           ZERR    1
     C                     PARM           ZDBEI   1                                           CSW201
      *
      **  Error when formating address
      *
     C           ZERR      IFEQ '1'
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELZDEST     MFLD
     C                     MOVELMSGA,6    MERR
     C                     ELSE
      *
      **  A Type address
      *
     C           ZSTAG     IFEQ 'A'
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'A'       TAG
     C                     MOVE '53'      FLDNO
     C                     MOVE @MTAG     MTAG
     C                     MOVELZSADD1    MFLD
      *
     C                     ELSE
      *
      **  Access SDCUSTPD using our pay nostro customer number
      *
     C                     MOVE *BLANKS   @KEY1
     C                     MOVELA7CUST    @KEY1
     C                     CALL 'AOCUSTR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @KEY1  10
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      ** Customer record not found - Error
      *
     C           @RTCD     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELA7CUST    MFLD
     C                     MOVE MSGA,2    MERR
      *
     C                     ELSE
      *
      **  B Type address
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C**********           MOVE BBPCNB    @PCNB   60                                          CSD027
     C                     MOVE BBPCNB    @PCNB   6                                           CSD027
     C           SPAIN     IFEQ 'P'
     C           @PCNB     ANDEQSECN
     C           BBPAIN    OREQ 'P'
     C           A7CUST    ANDEQSPCNB
     C           BBPCNB    OREQ SPCNB
     C           BBPCNB    ANDNE*BLANKS
      *
     C                     MOVE ':53B:'   MTAG
     C                     MOVE *BLANKS   @WRK
     C                     MOVEABBCRNM    @WRK,1
     C                     Z-ADD22        J       20
     C                     MOVEABBCRTN    @WRK,J
     C                     MOVEA@WRK      MFLD
      *
      **  D Type address
     C                     ELSE
     C                     MOVE ':53D:'   MTAG
     C                     MOVELZSADD1    MFLD
      **  Address 2
     C           ZSADD2    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD2    MFLD
      **  Address 3
     C           ZSADD3    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD3    MFLD
      **  Address 4
     C           ZSADD4    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD4    MFLD
     C                     END                             D address 4
     C                     END                             D address 3
     C                     END                             D address 2
     C                     END                             B/D address 1
      *
     C                     END                             Cust. error?
      *
     C                     END                             A/B/D address?
     C                     END                             Fmt ad. error    .
     C                     END                             Brch Int Cust.
     C                     END                             Nostro not fnd.
     C                     END
     C                     END                             Pay nostro?
      *
     C                     MOVE 'N'       FLD57O  1
      *
      ** Field :57:  A/C with institution non-blank.
      *
     C           CSW201    IFEQ 'Y'                                                         BUG11283
     C           MGSAMT    ANDEQ*ZERO                                                       BUG11283
     C                     ADD  1         X                                                 BUG11283
     C           X         OCUR MULT                                                        BUG11283
     C                     MOVE ':57D:'   MTAG                                              BUG11283
     C                     MOVEL'NONE'    MFLD                                              BUG11283
     C                     ELSE                                                             BUG11283
      *                                                                                     BUG11283
     C           MGAWBN    IFNE *BLANKS
      *
      ** Field :56:  Pay Intermediary bank
      ** This field is only produced when the account with institution
      ** is non-blank.
      *
      ** If the pay intermediary is entered.
      *
     C           MGPIBN    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGPIBN    ZDEST
     C                     MOVELMGPIBA    ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '56'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
      **  Format Account with institution. (Field 57.)
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGAWBN    ZDEST
     C                     MOVELMGAWBA    ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     MOVE 'Y'       FLD57O  1
      *
      **  A/C with Inst. blank
      *
     C                     ELSE
      *
     C           AWBA6     IFEQ 'DIRECT'
      *
      **  A/C with Inst. set up as DIRECT, use beneficiary details
      **  Format Account with institution. (Field 57.)
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGBENN    ZDEST
     C                     MOVELMGBENA    ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     MOVE 'Y'       FLD57O  1
      *
      **  A/C with Inst. blank and NOT "DIRECT" entered,
      *
     C                     ELSE
      *
      **  Field 57 = pay nostro customer if settlement via '02' or '12'
      *
     C           MGPSTM    IFEQ 02
     C           MGPSTM    OREQ 12
     C                     MOVELMGPONS    @NONB
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *                                                                   137909
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6
     C***********          PARM MGCCY     @CYCD   3                       137909
     C                     PARM           @CYCD   3                       137909
     C**********           PARM *BLANKS   @ACCD   4                                           CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2
     C                     PARM           @NONB   2
     C                     PARM *BLANKS   @BRCD   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **  Nostro customer not found
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELMGPONS    HLD2    2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5    5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,3    MERR
     C                     MOVE ':57 :'   MTAG
     C                     ELSE
      *
      **  Format our Pay Nostro Customer Address
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVEL*BLANKS   ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     MOVE 'Y'       FLD57O
     C                     END
      *
     C                     ELSE
      *
     C           MGPSTM    IFNE 00
     C                     MOVE MGPSTM    @STM
     C           @STM      LOKUPTABINT                   23
      *
     C           *IN23     IFEQ '1'
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELSECN      ZDEST
     C                     MOVEL*BLANKS   ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     MOVE 'Y'       FLD57O
      *
     C                     ELSE
      *
      **  Field 53 is equal to Our Pay Nostro
      *
     C                     MOVELMGPONS    @NSKYE
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @NSKYB                          137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @NSKYB                          137909
     C                     ENDIF                                          137909
      *                                                                   137909
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @NSKYA  6
     C***********          PARM MGCCY     @NSKYB  3                       137909
     C                     PARM           @NSKYB  3                       137909
     C**********           PARM *BLANKS   @NSKYC  4                                           CGL029
     C                     PARM *BLANKS   @NSKYC 10                                           CGL029
     C                     PARM *BLANKS   @NSKYD  2
     C                     PARM           @NSKYE  2
     C                     PARM *BLANKS   @KEYF   3
     C                     PARM *BLANKS   @KEYG  10
     C                     PARM *BLANKS   @KEYH   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **  Nostro customer not found
      *
     C           @RTCD     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELMGPONS    MFLD
     C                     MOVELMSGA,3    MERR
     C                     ELSE
      *
      **  Format our Pay Nostro Customer Address
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVEL*BLANKS   ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '53'      FLDNO
     C                     EXSR FSWAD
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
      *
      **  Settlement 01,07 or 08 with MGAWBN blank or settlement 00
      *
     C           FLD57O    IFEQ 'N'
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE ':57D:'   MTAG
     C                     MOVEL'UNKNOWN' MFLD
      *
      *
     C                     END
     C                     ENDIF                                                            BUG11283
      *
     C                     ENDSR
      /EJECT
      *****************************************************************   CSW200
      *   PAY200 Format fields 53, 56 and 57 for a payment            *   CSW200
      *          with Swift 2000 changes.                             *   CSW200
      *   Called by - FFLD2K Format MT341 fields for output           *   CSW200
      *   Calls       FSWAD  Format Swift Address.                    *   CSW200
      *****************************************************************   CSW200
      *                                                                   CSW200
     C           PAY200    BEGSR                                          CSW200
      *                                                                                       CSW201
     C           CSW201    IFEQ 'Y'                                                           CSW201
     C                     MOVE 'Y'       ZDBEI                                               CSW201
     C                     ENDIF                                                              CSW201
      *                                                                   CSW200
     C                     MOVE *BLANKS   @WRK                            CSW200
      *                                                                   CSW200
      ** Field 53 - Senders correspondant.                                CSW200
      **  Test if settlement via nostro                                   CSW200
      *                                                                   CSW200
     C                     MOVE MGPSTM    @STM    2                       CSW200
     C           @STM      LOKUPTABNST                   23               CSW200
      *                                                                   CSW200
      ** If our pay nostro is not blank and the settlement is via a nostroCSW200
      *                                                                   CSW200
     C           MGPONS    IFNE *BLANKS                                   CSW200
     C           *IN23     ANDEQ'1'                                       CSW200
      *                                                                   CSW200
      **  either A/C with Bank or Receipient entered                      CSW200
      **  or DIRECT entered                                               CSW200
      *                                                                   CSW200
     C           MGAWBN    IFNE *BLANKS                                   CSW200
     C           MGAWBA    OREQ 'DIRECT'                                  CSW200
      *                                                                   CSW200
     C                     MOVELMGPONS    @NONB                           CSW200
      *                                                                   CSW200
      ** Use settlement currency to access nostro if not blank.           CSW200
      ** Otherwise use deal currency.                                     CSW200
     C           CEU003    IFEQ 'Y'                                       CSW200
     C           MGSTCY    ANDNE*BLANKS                                   CSW200
     C                     MOVE MGSTCY    @CYCD                           CSW200
     C                     ELSE                                           CSW200
     C                     MOVE MGCCY     @CYCD                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     CALL 'AONOSTR0'                                CSW200
     C                     PARM '*MSG   ' @RTCD   7                       CSW200
     C                     PARM '*KEY   ' @OPTN   7                       CSW200
     C                     PARM *BLANKS   @CUST   6                       CSW200
     C                     PARM           @CYCD   3                       CSW200
     C**********           PARM *BLANKS   @ACCD   4                                    CSW200 CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2                       CSW200
     C                     PARM           @NONB   2                       CSW200
     C                     PARM *BLANKS   @BRCD   3                       CSW200
     C                     PARM *BLANKS   @CSSN  10                       CSW200
     C                     PARM *BLANKS   @PNOI   1                       CSW200
     C           SDNOST    PARM SDNOST    DSFDY                           CSW200
      *                                                                   CSW200
      **  Nostro customer not found                                       CSW200
      *                                                                   CSW200
     C           @RTCD     IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVE ':53 :'   MTAG                            CSW200
     C                     MOVELMGPONS    HLD2                            CSW200
     C                     MOVELMGCCY     HLD5                            CSW200
     C                     MOVE HLD2      HLD5                            CSW200
     C                     MOVELHLD5      MFLD                            CSW200
     C                     MOVELMSGA,3    MERR                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      ** Branch Internal Customer cf. Customer number of Our Pay Nostro   CSW200
      *                                                                   CSW200
     C                     MOVELSECN      @SECN   6                       CSW200
     C           @SECN     IFNE A7CUST                                    CSW200
     C           MGAWBN    ANDNEA7CUST                                    CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELA7CUST    ZDEST                           CSW200
     C*********************CALL 'ZM0050'                                               CSW200 CSW036
     C                     CALL 'ZM0051'                                                      CSW036
     C                     PARM           ZDEST  12                       CSW200
     C                     PARM           ZSADD1 35                       CSW200
     C                     PARM           ZSADD2 35                       CSW200
     C                     PARM           ZSADD3 35                       CSW200
     C                     PARM           ZSADD4 35                       CSW200
     C                     PARM           ZSTAG   1                       CSW200
     C                     PARM           ZSTYPE  1                       CSW200
     C                     PARM           ZERR    1                       CSW200
     C                     PARM           ZDBEI                                               CSW201
      *                                                                   CSW200
      **  Error when formating address                                    CSW200
      *                                                                   CSW200
     C           ZERR      IFEQ '1'                                       CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVE ':53 :'   MTAG                            CSW200
     C                     MOVELZDEST     MFLD                            CSW200
     C                     MOVELMSGA,6    MERR                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  A Type address                                                  CSW200
      *                                                                   CSW200
     C           ZSTAG     IFEQ 'A'                                       CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'A'       TAG                             CSW200
     C                     MOVE '53'      FLDNO                           CSW200
     C                     MOVE @MTAG     MTAG                            CSW200
     C                     MOVELZSADD1    MFLD                            CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  D Type address                                                  CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVE ':53D:'   MTAG                            CSW200
     C                     MOVELZSADD1    MFLD                            CSW200
      **  Address 2                                                       CSW200
     C           ZSADD2    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELZSADD2    MFLD                            CSW200
      **  Address 3                                                       CSW200
     C           ZSADD3    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELZSADD3    MFLD                            CSW200
      **  Address 4                                                       CSW200
     C           ZSADD4    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELZSADD4    MFLD                            CSW200
     C                     ENDIF                           D address 4    CSW200
     C                     ENDIF                           D address 3    CSW200
     C                     ENDIF                           D address 2    CSW200
      *                                                                   CSW200
     C                     ENDIF                           A/D address?   CSW200
     C                     ENDIF                           Fmt ad. error  CSW200
     C                     ENDIF                           Brch Int Cust. CSW200
     C                     ENDIF                           Nostro not fnd.CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                           Pay nostro?    CSW200
      *                                                                   CSW200
     C                     MOVE 'N'       FLD57O  1                       CSW200
      *                                                                   CSW200
      ** Field :57:  A/C with institution non-blank.                      CSW200
      *                                                                   CSW200
     C           CSW201    IFEQ 'Y'                                                         BUG11283
     C           MGSAMT    ANDEQ*ZERO                                                       BUG11283
     C                     ADD  1         X                                                 BUG11283
     C           X         OCUR MULT                                                        BUG11283
     C                     MOVE ':57D:'   MTAG                                              BUG11283
     C                     MOVEL'NONE'    MFLD                                              BUG11283
     C                     ELSE                                                             BUG11283
      *                                                                                     BUG11283
     C           MGAWBN    IFNE *BLANKS                                   CSW200
      *                                                                   CSW200
      ** Field :56:  Pay Intermediary bank                                CSW200
      ** This field is only produced when the account with institution    CSW200
      ** is non-blank.                                                    CSW200
      *                                                                   CSW200
      ** If the pay intermediary is entered.                              CSW200
      *                                                                   CSW200
     C           MGPIBN    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELMGPIBN    ZDEST                           CSW200
     C                     MOVELMGPIBA    ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '56'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      **  Format Account with institution. (Field 57.)                    CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELMGAWBN    ZDEST                           CSW200
     C                     MOVELMGAWBA    ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     MOVE 'Y'       FLD57O  1                       CSW200
      *                                                                   CSW200
      **  A/C with Inst. blank                                            CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
     C           MGAWBA    IFEQ 'DIRECT'                                  CSW200
      *                                                                   CSW200
      **  A/C with Inst. set up as DIRECT, use beneficiary details        CSW200
      **  Format Account with institution. (Field 57.)                    CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELMGBENN    ZDEST                           CSW200
     C                     MOVELMGBENA    ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     MOVE 'Y'       FLD57O  1                       CSW200
      *                                                                   CSW200
      **  A/C with Inst. blank and NOT "DIRECT" entered,                  CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Field 57 = pay nostro customer if settlement via '02' or '12'   CSW200
      *                                                                   CSW200
     C           MGPSTM    IFEQ 02                                        CSW200
     C           MGPSTM    OREQ 12                                        CSW200
     C                     MOVELMGPONS    @NONB                           CSW200
      *                                                                   CSW200
      ** Use settlement currency to access nostro if not blank.           CSW200
      ** Otherwise use deal currency.                                     CSW200
      *                                                                   CSW200
     C           CEU003    IFEQ 'Y'                                       CSW200
     C           MGSTCY    ANDNE*BLANKS                                   CSW200
     C                     MOVE MGSTCY    @CYCD                           CSW200
     C                     ELSE                                           CSW200
     C                     MOVE MGCCY     @CYCD                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     CALL 'AONOSTR0'                                CSW200
     C                     PARM '*MSG   ' @RTCD   7                       CSW200
     C                     PARM '*KEY   ' @OPTN   7                       CSW200
     C                     PARM *BLANKS   @CUST   6                       CSW200
     C                     PARM           @CYCD   3                       CSW200
     C**********           PARM *BLANKS   @ACCD   4                                    CSW200 CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2                       CSW200
     C                     PARM           @NONB   2                       CSW200
     C                     PARM *BLANKS   @BRCD   3                       CSW200
     C                     PARM *BLANKS   @CSSN  10                       CSW200
     C                     PARM *BLANKS   @PNOI   1                       CSW200
     C           SDNOST    PARM SDNOST    DSFDY                           CSW200
      *                                                                   CSW200
      **  Nostro customer not found                                       CSW200
      *                                                                   CSW200
     C           @RTCD     IFNE *BLANKS                                   CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELMGPONS    HLD2    2                       CSW200
     C                     MOVELMGCCY     HLD5                            CSW200
     C                     MOVE HLD2      HLD5    5                       CSW200
     C                     MOVELHLD5      MFLD                            CSW200
     C                     MOVELMSGA,3    MERR                            CSW200
     C                     MOVE ':57 :'   MTAG                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Format our Pay Nostro Customer Address                          CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELA7CUST    ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     MOVE 'Y'       FLD57O                          CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
     C           MGPSTM    IFNE 00                                        CSW200
     C                     MOVE MGPSTM    @STM                            CSW200
     C           @STM      LOKUPTABINT                   23               CSW200
      *                                                                   CSW200
     C           *IN23     IFEQ '1'                                       CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELSECN      ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     MOVE 'Y'       FLD57O                          CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Field 53 is equal to Our Pay Nostro                             CSW200
      *                                                                   CSW200
     C                     MOVELMGPONS    @NSKYE                          CSW200
      *                                                                   CSW200
      ** Use settlement currency to access nostro if not blank.           CSW200
      ** Otherwise use deal currency.                                     CSW200
     C           CEU003    IFEQ 'Y'                                       CSW200
     C           MGSTCY    ANDNE*BLANKS                                   CSW200
     C                     MOVE MGSTCY    @NSKYB                          CSW200
     C                     ELSE                                           CSW200
     C                     MOVE MGCCY     @NSKYB                          CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     CALL 'AONOSTR0'                                CSW200
     C                     PARM '*MSG   ' @RTCD   7                       CSW200
     C                     PARM '*KEY   ' @OPTN   7                       CSW200
     C                     PARM *BLANKS   @NSKYA  6                       CSW200
     C                     PARM           @NSKYB  3                       CSW200
     C**********           PARM *BLANKS   @NSKYC  4                                    CSW200 CGL029
     C                     PARM *BLANKS   @NSKYC                                              CGL029
     C                     PARM *BLANKS   @NSKYD  2                       CSW200
     C                     PARM           @NSKYE  2                       CSW200
     C                     PARM *BLANKS   @KEYF   3                       CSW200
     C                     PARM *BLANKS   @KEYG  10                       CSW200
     C                     PARM *BLANKS   @KEYH   1                       CSW200
     C           SDNOST    PARM SDNOST    DSFDY                           CSW200
      *                                                                   CSW200
      **  Nostro customer not found                                       CSW200
      *                                                                   CSW200
     C           @RTCD     IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVE ':53 :'   MTAG                            CSW200
     C                     MOVELMGPONS    MFLD                            CSW200
     C                     MOVELMSGA,3    MERR                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Format our Pay Nostro Customer Address                          CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELA7CUST    ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '53'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      **  Settlement 01,07 or 08 with MGAWBN blank or settlement 00       CSW200
      *                                                                   CSW200
     C           FLD57O    IFEQ 'N'                                       CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE ':57D:'   MTAG                            CSW200
     C                     MOVEL'UNKNOWN' MFLD                            CSW200
      *                                                                   CSW200
      *                                                                   CSW200
     C                     ENDIF                                          CSW200
     C                     ENDIF                                                            BUG11283
      *                                                                                       CSW201
     C                     MOVE *BLANKS   ZDBEI                                               CSW201
      *                                                                   CSW200
     C                     ENDSR                                          CSW200
      /EJECT                                                              CSW200
      *****************************************************************
      *   RECV  - Format fields 53, 56 and 57 for receive sequence    *
      *   Called by - FMTFLD Format MT341 fields for output           *
      *   Calls     - FSWAD  Format swift address.                    *
      *****************************************************************
      *
     C           RECV      BEGSR
      *                                                                                       CSW201
     C           CSW201    IFEQ 'Y'                                                           CSW201
     C                     MOVE 'Y'       ZDBEI                                               CSW201
     C                     ENDIF                                                              CSW201
      *
     C                     MOVE *BLANKS   @WRK
      *
      ** Format fields 56 and 57.
      *
      ** Branch code of sender not equal to Receive settlement branch.
      *
      ** Test if settlement via nostro.
      *
     C           CSW201    IFEQ 'Y'                                                         BUG11283
     C           MGSAMT    ANDEQ*ZERO                                                       BUG11283
     C                     ADD  1         X                                                 BUG11283
     C           X         OCUR MULT                                                        BUG11283
     C                     MOVE ':57D:'   MTAG                                              BUG11283
     C                     MOVEL'NONE'    MFLD                                              BUG11283
     C                     ELSE                                                             BUG11283
      *                                                                                     BUG11283
     C                     MOVE MGRSTM    @STM
     C           @STM      LOKUPTABNST                   23
     C           MGBRCA    IFNE MGROBR
     C           *IN23     ANDEQ'1'
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C           MGRIBN    IFNE *BLANKS
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGRIBN    ZDEST
     C                     MOVELMGRIBA    ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '56'      FLDNO
     C                     EXSR FSWAD
      *
     C                     ELSE
      *
      ** Access Branch file for the Internal customer number of the
      ** Receive branch (this will be used for the Intermediary
      ** Bank, because settlement is via an account owned
      ** by a branch different to the receive branch).
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM MGROBR    @BRCD   3
     C           SDBRCH    PARM SDBRCH    DSSDY
      *
      ** Branch record not found - Error.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '016'     DBASE              * * * * * * *
     C                     MOVELMGROBR    DBKEY              * DBERR 016 *
     C                     MOVEL'SDBRCHPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Format Intermediary using customer number of receive branch.
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA8BICN    ZDEST
     C                     MOVE *BLANKS   ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '56'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
      ** Field :57:  A/C With Institution.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *                                                                   137909
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6        I:Customer No
     C***********          PARM MGCCY     @CYCD   3        I:Currency     137909
     C                     PARM           @CYCD   3        I:Currency     137909
     C**********           PARM *BLANKS   @ACCD   4        I:A/c Code                         CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2        I:A/c Seq
     C                     PARM MGRONS    @NONB   2        I:Nostro No
     C                     PARM *BLANKS   @BRCD   3        I:Branch Code
     C                     PARM *BLANKS   @CSSN  10        I:Cust ShortN
     C                     PARM *BLANK    @PNOI   1        I:Prime Nost In
     C           SDNOST    PARM SDNOST    DSFDY
      *
      ** If our receive nostro is not found.
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     MOVELMGRONS    HLD2    2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5    5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,3    MERR
     C                     MOVE ':57 :'   MTAG
     C                     ELSE
      *
      ** Format our Receive Nostro Customer Address.
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVEL*BLANKS   ACLINE 35
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
      *
      ** Else the branch code of sender = receive settlement branch
      ** and the settlement is via a nostro.
      *
     C                     ELSE
      *
     C           MGRIBN    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGRIBN    ZDEST
     C                     MOVELMGRIBA    ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '56'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
     C           @STM      LOKUPTABNST                   23
      *
     C           *IN23     IFEQ '1'
     C                     ADD  1         X
     C           X         OCUR MULT
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *                                                                   137909
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6        I:Customer No
     C***********          PARM MGCCY     @CYCD   3        I:Currency     137909
     C                     PARM           @CYCD   3        I:Currency     137909
     C**********           PARM *BLANKS   @ACCD   4        I:A/c Code                         CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2        I:A/c Seq
     C                     PARM MGRONS    @NONB   2        I:Nostro No
     C                     PARM *BLANKS   @BRCD   3        I:Branch Code
     C                     PARM *BLANKS   @CSSN  10        I:Cust ShortN
     C                     PARM *BLANK    @PNOI   1        I:Prime Nost In
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **  If our receive nostro is not found.
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     MOVELMGRONS    HLD2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,3    MERR
     C                     MOVE ':57 :'   MTAG
     C                     ELSE
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
      *
     C                     MOVEL*BLANKS   ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
     C                     ELSE
      *
      ** Settlement method internal.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C           MGRSTM    IFNE 00
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELSECN      ZDEST
     C                     MOVEL*BLANKS   ACLINE
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
      *
      ** No settlement type entered.
      *
     C                     ELSE
     C                     MOVE ':57D:'   MTAG
     C                     MOVEL'UNKNOWN' MFLD
     C                     END
     C                     END
      *
     C                     END
     C                     ENDIF                                                            BUG11283
      *                                                                                       CSW201
     C                     MOVE *BLANKS   ZDBEI                                               CSW201
      *
     C                     ENDSR
     C/EJECT                                                                                  CSW213
      *****************************************************************                       CSW213
      *   SRFMTD - Format message detail - Sequence D                 *                       CSW213
      *   Called by   Main process                                    *                       CSW213
      *   Calls                                                       *                       CSW213
      *****************************************************************                       CSW213
      *                                                                                       CSW213
     C           SRFMTD    BEGSR                                                              CSW213
      *                                                                                       CSW213
      **  Field :15D: New Sequence                                                            CSW213
      *                                                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVE ':15D:'   MTAG                                                CSW213
     C                     MOVEL*BLANK    MFLD                                                CSW213
     C                     Z-ADDX         X15E    20                                        MD022981
      *                                                                                       CSW213
      **  Clear multiple occurrence DS for the RPPT                                           CSW213
      *                                                                                       CSW213
     C                     Z-ADD1         Y1      10                                          CSW213
     C           Y1        OCUR RPPT                                                          CSW213
     C           Y1        DOWLE4                                                             CSW213
      *                                                                                       CSW213
     C                     CLEARRPPT                                                          CSW213
     C                     ADD  1         Y1                                                  CSW213
     C           Y1        OCUR RPPT                                                          CSW213
     C                     ENDDO                                                              CSW213
     C                     Z-ADD0         Y1                                                  CSW213
      *                                                                                       CSW213
      **  Initialize multioccurence DS RPPT with the 4 set of fields                          CSW213
      *                                                                                       CSW213
     C                     Z-ADD1         Y1      10                                          CSW213
     C           Y1        OCUR RPPT                                                          CSW213
     C           Y1        DOWLE4                                                             CSW213
     C           Y1        IFEQ 1                                                             CSW213
     C                     MOVE MGRJ01    MGRJXX                                              CSW213
     C                     MOVE MGRP01    MGRPXX                                              CSW213
     C                     MOVE MGRN01    MGRNXX                                              CSW213
     C                     MOVE MGRC01    MGRCXX                                              CSW213
     C                     MOVE MGRS01    MGRSXX                                              CSW213
     C                     MOVE MGRL01    MGRLXX                                              CSW213
     C                     MOVE MGRA01    MGRAXX                                              CSW213
     C                     MOVE MGUT01    MGUTXX                                              CSW213
     C                     MOVE MGTN01    MGTNXX                                              CSW213
     C                     MOVE MGTI01    MGTIXX                                              CSW213
     C                     MOVE MGET01    MGETXX                                              CSW213
     C                     ENDIF                                                              CSW213
     C           Y1        IFEQ 2                                                             CSW213
     C                     MOVE MGRJ02    MGRJXX                                              CSW213
     C                     MOVE MGRP02    MGRPXX                                              CSW213
     C                     MOVE MGRN02    MGRNXX                                              CSW213
     C                     MOVE MGRC02    MGRCXX                                              CSW213
     C                     MOVE MGRS02    MGRSXX                                              CSW213
     C                     MOVE MGRL02    MGRLXX                                              CSW213
     C                     MOVE MGRA02    MGRAXX                                              CSW213
     C                     MOVE MGUT02    MGUTXX                                              CSW213
     C                     MOVE MGTN02    MGTNXX                                              CSW213
     C                     MOVE MGTI02    MGTIXX                                              CSW213
     C                     MOVE MGET02    MGETXX                                              CSW213
     C                     ENDIF                                                              CSW213
     C           Y1        IFEQ 3                                                             CSW213
     C                     MOVE MGRJ03    MGRJXX                                              CSW213
     C                     MOVE MGRP03    MGRPXX                                              CSW213
     C                     MOVE MGRN03    MGRNXX                                              CSW213
     C                     MOVE MGRC03    MGRCXX                                              CSW213
     C                     MOVE MGRS03    MGRSXX                                              CSW213
     C                     MOVE MGRL03    MGRLXX                                              CSW213
     C                     MOVE MGRA03    MGRAXX                                              CSW213
     C                     MOVE MGUT03    MGUTXX                                              CSW213
     C                     MOVE MGTN03    MGTNXX                                              CSW213
     C                     MOVE MGTI03    MGTIXX                                              CSW213
     C                     MOVE MGET03    MGETXX                                              CSW213
     C                     ENDIF                                                              CSW213
     C           Y1        IFEQ 4                                                             CSW213
     C                     MOVE MGRJ04    MGRJXX                                              CSW213
     C                     MOVE MGRP04    MGRPXX                                              CSW213
     C                     MOVE MGRN04    MGRNXX                                              CSW213
     C                     MOVE MGRC04    MGRCXX                                              CSW213
     C                     MOVE MGRS04    MGRSXX                                              CSW213
     C                     MOVE MGRL04    MGRLXX                                              CSW213
     C                     MOVE MGRA04    MGRAXX                                              CSW213
     C                     MOVE MGUT04    MGUTXX                                              CSW213
     C                     MOVE MGTN04    MGTNXX                                              CSW213
     C                     MOVE MGTI04    MGTIXX                                              CSW213
     C                     MOVE MGET04    MGETXX                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ADD  1         Y1                                                  CSW213
     C           Y1        OCUR RPPT                                                          CSW213
     C                     ENDDO                                                              CSW213
     C                     Z-ADD0         Y1                                                  CSW213
      *                                                                                       CSW213
     C                     EXSR SRRPPT                                                      MD023007
      *                                                                                     MD023007
     C                     Z-ADD0         WRKIX   10                                          CSW213
     C                     MOVEL'N'       WRKFLG  1                                           CSW213
      *                                                                                       CSW213
      **  Do Loop for 4 times                                                                 CSW213
      *                                                                                       CSW213
     C           WRKIX     DOWLT4                                                             CSW213
     C                     ADD  1         WRKIX                                               CSW213
     C********** WRKIX     OCUR RPPT                                                 CSW213 MD023007
     C           IX,WRKIX  OCUR RPPT                                                        MD023007
      *                                                                                       CSW213
      **  Reporting Jurisdiction                                                              CSW213
      *                                                                                       CSW213
     C           MGRJXX    IFEQ *BLANKS                                                       CSW213
     C                     ADD  5         WRKIX                                               CSW213
     C                     ELSE                                                               CSW213
     C********** MGRJXX    IFNE *BLANKS                                             CSW213 MD022633A
     C********** MGRPXX    ANDNE*BLANKS                                             CSW213 MD022633A
     C********** MGRNXX    ANDNE*BLANKS                                             CSW213 MD022633A
     C********** MGRCXX    ANDNE*BLANKS                                             CSW213 MD022633A
     C********** MGRSXX    ANDNE*BLANKS                                             CSW213 MD022633A
     C********** MGRLXX    ANDNE*BLANKS                                             CSW213 MD022633A
     C********** MGRAXX    ANDNE*BLANKS                                             CSW213 MD022633A
     C           MGRJXX    IFNE WRKMRJ                                                      MD022633
     C           MGRPXX    ORNE WRKMRP                                                      MD022633
     C           MGRNXX    ORNE WRKMRN                                                     MD022633A
     C           MGRCXX    ORNE WRKMRC                                                     MD022633A
     C           MGRSXX    ORNE WRKMRS                                                     MD022633A
     C           MGRLXX    ORNE WRKMRL                                                     MD022633A
     C           MGRAXX    ORNE WRKMRA                                                     MD022633A
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22L:'   MTAG                                                CSW213
     C                     MOVELMGRJXX    MFLD                                                CSW213
     C                     MOVEL'N'       WRKFLG                                              CSW213
     C**********           ENDIF                                                     CSW213 MD022633
      *                                                                                       CSW213
      **  Reporting Party                                                                     CSW213
      *                                                                                       CSW213
     C           MGRPXX    IFNE *BLANKS                                                       CSW213
     C                     MOVELMGRPXX    WRKMRP  6                                         MD022633
     C                     MOVELMGRJXX    WRKMRJ 35                                         MD022633
     C                     MOVELMGRNXX    WRKMRN 20                                        MD022633A
     C                     MOVELMGRCXX    WRKMRC 10                                        MD022633A
     C                     MOVELMGRSXX    WRKMRS 11                                        MD022633A
     C                     MOVELMGRLXX    WRKMRL 20                                        MD022633A
     C                     MOVELMGRAXX    WRKMRA 34                                        MD022633A
     C                     MOVE *BLANKS   ZDEST                                               CSW213
     C                     MOVELMGRPXX    ZDEST                                               CSW213
     C                     MOVELMGRAXX    ACLINE                                              CSW213
     C                     MOVEL'91'      FLDNO                                               CSW213
     C                     MOVE *BLANKS   TAG                                                 CSW213
     C                     EXSR SRFMPY                                                        CSW213
     C                     ELSE                                                               CSW213
     C                     MOVELMGRPXX    WRKMRP                                           MD022633A
     C                     MOVELMGRJXX    WRKMRJ                                           MD022633A
     C                     MOVELMGRNXX    WRKMRN                                           MD022633A
     C                     MOVELMGRCXX    WRKMRC                                           MD022633A
     C                     MOVELMGRSXX    WRKMRS                                           MD022633A
     C                     MOVELMGRLXX    WRKMRL                                           MD022633A
     C                     MOVELMGRAXX    WRKMRA                                           MD022633A
     C           MGRLXX    IFEQ *BLANKS                                                       CSW213
     C           MGRNXX    ANDEQ*BLANKS                                                       CSW213
     C           MGRSXX    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':91A:'   MTAG                                                CSW213
     C                     MOVEL*BLANKS   MFLD                                                CSW213
     C                     MOVELMGRSXX    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ELSE                                                               CSW213
     C           MGRNXX    IFNE *BLANKS                                                       CSW213
     C           MGRSXX    ANDNE*BLANKS                                                       CSW213
     C           MGRNXX    ORNE *BLANKS                                                       CSW213
     C           MGRLXX    ANDNE*BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':91J:'   MTAG                                                CSW213
     C           MGRSXX    IFNE *BLANKS                                                       CSW213
     C           '/ABIC/'  CAT  MGRSXX    MFLD                                                CSW213
     C                     ELSE                                                               CSW213
     C           '/ABIC'   CAT  '/UKWN'   MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           MGRLXX    IFNE *BLANKS                                                       CSW213
     C           '/LEIC/'  CAT  MGRLXX    MFLD                                                CSW213
     C                     ELSE                                                               CSW213
     C           '/NAME/'  CAT  MGRNXX    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGRCXX    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/NAME/'  CAT  MGRCXX    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ELSE                                                               CSW213
     C           MGRNXX    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':91D:'   MTAG                                                CSW213
     C                     MOVELMGRNXX    MFLD                                                CSW213
     C           MGRCXX    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVELMGRCXX    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                            MD022633
     C**********           ENDIF                                                  MD022633 MD022633A
      *                                                                                       CSW213
      **  Unique Transaction Identifier/Prior Unique Transaction Identifier                   CSW213
      *                                                                                       CSW213
     C           MGUTXX    IFNE *BLANKS                                                       CSW213
     C           MGTNXX    ANDNE*BLANKS                                                       CSW213
     C           MGTIXX    IFEQ '0'                                                           CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22M:'   MTAG                                                CSW213
     C                     MOVELMGUTXX    MFLD                                                CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22N:'   MTAG                                                CSW213
     C                     MOVELMGTNXX    MFLD                                                CSW213
     C                     MOVEL'Y'       WRKFLG                                              CSW213
     C                     ELSE                                                               CSW213
     C           WRKFLG    IFEQ 'Y'                                                           CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22P:'   MTAG                                                CSW213
     C                     MOVELMGUTXX    MFLD                                                CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22R:'   MTAG                                                CSW213
     C                     MOVELMGTNXX    MFLD                                                CSW213
     C                     ELSE                                                               CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22M:'   MTAG                                                CSW213
     C                     MOVELMGUTXX    MFLD                                                CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22N:'   MTAG                                                CSW213
     C                     MOVELMGTNXX    MFLD                                                CSW213
     C                     MOVEL'Y'       WRKFLG                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
     C                     ENDDO                                                              CSW213
      *                                                                                       CSW213
      **  Clearing Exception Party                                                            CSW213
      *                                                                                       CSW213
     C           MGCEPI    IFNE *BLANKS                                                       CSW213
     C                     MOVE *BLANKS   ZDEST                                               CSW213
     C                     MOVELMGCEPI    ZDEST                                               CSW213
     C                     MOVELMGCEPA    ACLINE                                              CSW213
     C                     MOVEL'96'      FLDNO                                               CSW213
     C                     MOVE *BLANKS   TAG                                                 CSW213
     C                     EXSR SRFMPY                                                        CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Clearing Broker Identification                                                      CSW213
      *                                                                                       CSW213
     C           MGCBCI    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22S:'   MTAG                                                CSW213
     C           'C/'      CAT  MGCBCI    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGCBPI    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22S:'   MTAG                                                CSW213
     C           'P/'      CAT  MGCBPI    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Cleared Product Identification                                                      CSW213
      *                                                                                       CSW213
     C           MGPRID    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22T:'   MTAG                                                CSW213
     C                     MOVELMGPRID    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Clearing Threshold Indicator                                                        CSW213
      *                                                                                       CSW213
     C           MGCGTI    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':17E:'   MTAG                                                CSW213
     C                     MOVELMGCGTI    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Underlying Product Identifier                                                       CSW213
      *                                                                                       CSW213
     C           MGUPID    IFEQ 'IRFRAG'                                                      CSW213
     C           MGUPID    OREQ 'IRFRAF'                                                    MD022526
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22U:'   MTAG                                                CSW213
     C                     MOVEL'IRFRAF'  MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Allocation Indicator                                                                CSW213
      *                                                                                       CSW213
     C           MGALLI    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':17H:'   MTAG                                                CSW213
     C                     MOVELMGALLI    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Collateralisation Indicator                                                         CSW213
      *                                                                                       CSW213
     C           MGCLLI    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':17P:'   MTAG                                                CSW213
     C                     MOVELMGCLLI    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Execution Venue                                                                     CSW213
      *                                                                                       CSW213
     C           MGEXVE    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':22V:'   MTAG                                                CSW213
     C                     MOVELMGEXVE    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Execution Timestamp                                                                 CSW213
      *                                                                                       CSW213
     C********** MGUTCT    IFNE *ZEROS                                               CSW213 MD023798
     C********** MGGEDT    ORNE *ZEROS                                             MD022981 MD023798
     C********** MGGETM    ORNE *ZEROS                                             MD022981 MD023798
     C           MGGEDT    IFNE *ZEROS                                                      MD023798
     C           MGGETM    ANDNE*ZEROS                                                      MD023798
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':98D:'   MTAG                                                CSW213
     C                     MOVE MGGEDT    DNGEDT  8                                           CSW213
     C                     MOVE MGGETM    DNGETM  6                                           CSW213
     C                     MOVE MGUTCT    DNUTCT  4                                           CSW213
     C           MGUSGN    IFEQ 'N'                                                           CSW213
     C           DNGEDT    CAT  DNGETM    ETIME1 14                                           CSW213
     C           '/N'      CAT  DNUTCT    ETIME2  6                                           CSW213
     C           ETIME1    CAT  ETIME2    MFLD                                                CSW213
     C                     ELSE                                                               CSW213
     C           DNGEDT    CAT  DNGETM    ETIME1 14                                           CSW213
     C********** ETIME1    CAT  DNUTCT    MFLD                                       CSW213 MD023798
      *                                                                                     MD023798
     C           DNUTCT    IFNE *ZEROS                                                      MD023798
     C           '/'       CAT  DNUTCT    ETIME3  5                                         MD023798
     C           ETIME1    CAT  ETIME3    MFLD                                              MD023798
     C                     ELSE                                                             MD023798
     C                     MOVELETIME1    MFLD                                              MD023798
     C                     ENDIF                                                            MD023798
      *                                                                                     MD023798
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Non Standard Flag                                                                   CSW213
      *                                                                                       CSW213
     C           MGNORS    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL':17W:'   MTAG                                                CSW213
     C                     MOVELMGNORS    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW214
     C           CSW214    IFEQ 'Y'                                                           CSW214
      *                                                                                       CSW214
      ** Financial Nature of the Counterparty Indicator                                       CSW214
      *                                                                                       CSW214
     C           MGFNCI    IFNE *BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':17Y:'   MTAG                                                CSW214
     C                     MOVELMGFNCI    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
      ** Collateral Portfolio Indicator                                                       CSW214
      *                                                                                       CSW214
     C           MGCOPI    IFNE *BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':17Z:'   MTAG                                                CSW214
     C                     MOVELMGCOPI    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
      ** Collateral Portfolio Code                                                            CSW214
      *                                                                                       CSW214
     C           MGCOPI    IFEQ 'Y'                                                           CSW214
     C           MGCOPC    ANDNE*BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':22Q:'   MTAG                                                CSW214
     C                     MOVELMGCOPC    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
      ** Portfolio Compression Indicator                                                      CSW214
      *                                                                                       CSW214
     C           MGPOCI    IFNE *BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':17L:'   MTAG                                                CSW214
     C                     MOVELMGPOCI    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
      ** Corporate Sector Indicator                                                           CSW214
      *                                                                                       CSW214
     C           MGCOSI    IFNE *BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':17M:'   MTAG                                                CSW214
     C                     MOVELMGCOSI    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
      ** Trade with Non-EEA Counterparty Indicator                                            CSW214
      *                                                                                       CSW214
     C           MGTNEI    IFNE *BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':17Q:'   MTAG                                                CSW214
     C                     MOVELMGTNEI    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
      ** Intragroup Trade Indicator                                                           CSW214
      *                                                                                       CSW214
     C           MGIGTI    IFNE *BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':17S:'   MTAG                                                CSW214
     C                     MOVELMGIGTI    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
      ** Commercial or Treasury Financial Indicator                                           CSW214
      *                                                                                       CSW214
     C           MGCTFI    IFNE *BLANKS                                                       CSW214
     C                     ADD  1         X                                                   CSW214
     C           X         OCUR MULT                                                          CSW214
     C                     MOVEL':17X:'   MTAG                                                CSW214
     C                     MOVELMGCTFI    MFLD                                                CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW214
     C                     ENDIF                                                              CSW214
      *                                                                                       CSW213
      **  Additional Reporting Information                                                    CSW213
      *                                                                                       CSW213
     C           MGAR01    IFNE *BLANKS                                                       CSW213
     C           MGAR02    ORNE *BLANK                                                        CSW213
     C           MGAR03    ORNE *BLANK                                                        CSW213
     C           MGAR04    ORNE *BLANK                                                        CSW213
     C           MGAR05    ORNE *BLANK                                                        CSW213
     C           MGAR06    ORNE *BLANK                                                        CSW213
     C           MGAR07    ORNE *BLANK                                                        CSW213
     C           MGAR08    ORNE *BLANK                                                        CSW213
     C           MGAR09    ORNE *BLANK                                                        CSW213
     C           MGAR10    ORNE *BLANK                                                        CSW213
     C           MGAR11    ORNE *BLANK                                                        CSW213
     C           MGAR12    ORNE *BLANK                                                        CSW213
     C           MGAR13    ORNE *BLANK                                                        CSW213
     C           MGAR14    ORNE *BLANK                                                        CSW213
     C           MGAR15    ORNE *BLANK                                                        CSW213
     C           MGAR16    ORNE *BLANK                                                        CSW213
     C           MGAR17    ORNE *BLANK                                                        CSW213
     C           MGAR18    ORNE *BLANK                                                        CSW213
     C           MGAR19    ORNE *BLANK                                                        CSW213
     C           MGAR20    ORNE *BLANK                                                        CSW213
      *                                                                                       CSW213
     C                     MOVE *BLANK    DN77    1                                           CSW213
     C           MGAR01    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR01    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR02    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR02    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR03    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR03    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR04    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR04    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR05    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR05    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR06    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR06    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR07    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR07    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR08    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR08    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR09    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR09    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR10    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR10    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR11    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR11    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR12    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR12    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR13    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR13    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR14    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR14    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR15    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR15    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR16    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR16    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR17    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR17    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR18    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR18    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR19    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR19    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           MGAR20    IFNE *BLANK                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           DN77      IFNE 'Y'                                                           CSW213
     C                     MOVE ':77A:'   MTAG                                                CSW213
     C                     MOVE 'Y'       DN77                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     MOVE *BLANK    MFLD                                                CSW213
     C                     MOVELMGAR20    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
     C           X         IFEQ X15E                                                        MD022981
     C                     MOVE *BLANKS   MTAG                                              MD022981
     C                     SUB  1         X                                                 MD022981
     C                     ENDIF                                                            MD022981
      *                                                                                     MD022981
     C                     ENDSR                                                              CSW213
     C/EJECT                                                                                  CSW213
      *****************************************************************                       CSW213
      *   SRFMPY - Format message - Cust. Extension SWIFT Details     *                       CSW213
      *   Called by   Main process                                    *                       CSW213
      *   Calls - None                                                *                       CSW213
      *****************************************************************                       CSW213
      *                                                                                       CSW213
     C           SRFMPY    BEGSR                                                              CSW213
      *                                                                                       CSW213
     C           ACLINE    IFNE *BLANKS                                                       CSW213
     C           1         SUBSTACLINE:1  ACTEMP  1                                           CSW213
     C           ACTEMP    IFNE '/'                                                           CSW213
     C           '/'       CAT  ACLINE    ACLINE                                              CSW213
     C                     ENDIF                                                              CSW213
      *                                                                                       CSW213
      **  Access Customer for with ZDEST (10 first characters) field using                    CSW213
      **  AOCSSWR0 - Customer Extension SWIFT Details                                         CSW213
      *                                                                                       CSW213
     C                     CALL 'AOCSSWR0'                                                    CSW213
     C                     PARM '*MSG   ' @RTCD   7                                           CSW213
     C                     PARM '*KEY   ' @OPTN   7                                           CSW213
     C                     PARM ZDEST     @KEY1  10                                           CSW213
     C                     PARM *BLANKS   @KYST   7                                           CSW213
     C                     PARM           DSLDY                                               CSW213
      *                                                                                       CSW213
      ** Extract SDCUSTPD and SDCSSWPD                                                     MD022633A
      *                                                                                    MD022633A
     C                     MOVEL'SDCUSTPD'P#FILN                                           MD022633A
     C                     EXSR GETRCL                                                     MD022633A
     C           P#RCDL    SUBSTDSLDY     SDCUST                                           MD022633A
     C           P#RCDL    ADD  1         WLEN    50                                       MD022633A
      *                                                                                    MD022633A
     C                     MOVEL'SDCSSWPD'P#FILN                                           MD022633A
     C                     EXSR GETRCL                                                     MD022633A
     C           P#RCDL    SUBSTDSLDY:WLENSDCSSW                                           MD022633A
      *                                                                                    MD022633A
     C           BBCSID    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL'A'       TAG                                                 CSW213
     C                     MOVEL@MTAG     MTAG                                                CSW213
     C           ACLINE    IFNE *BLANKS                                                       CSW213
     C                     MOVELACLINE    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVELBBCSID    MFLD                                                CSW213
     C                     ELSE                                                               CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C                     MOVEL'J'       TAG                                                 CSW213
     C                     MOVEL@MTAG     MTAG                                                CSW213
     C           '/ABIC'   CAT  '/UKWN'   ABIUKW 10                                           CSW213
     C                     MOVELABIUKW    MFLD                                                CSW213
     C           CSCLID    IFNE *BLANKS                                                       CSW213
     C           CSCLSY    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC/'  CAT  CSCLSY    CLRTMP 10                                           CSW213
     C           CLRTMP    CAT  CSCLID    MFLD                                                CSW213
     C                     ELSE                                                               CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC/'  CAT  CSCLID    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ELSE                                                               CSW213
     C           BBCHID    IFNE *ZEROS                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC'   CAT  '/CH'     CLRCH   8                                           CSW213
     C                     MOVE BBCHID    DNCHID  6                                           CSW213
     C           CLRCH     CAT  DNCHID    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           BBCHSC    IFNE *ZEROS                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC'   CAT  '/SC'     CLRSC   8                                           CSW213
     C                     MOVE BBCHSC    DNCHSC  6                                           CSW213
     C           CLRSC     CAT  DNCHSC    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           BBCABA    IFNE *ZEROS                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC'   CAT  '/CP'     CLRCP   8                                           CSW213
     C                     MOVE BBCABA    DNCABA  3                                           CSW213
     C           CLRCP     CAT  DNCABA    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           BBBFIC    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC'   CAT  '/BJ'     CLRBJ   8                                           CSW213
     C           CLRBJ     CAT  BBBFIC    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           BBBLCD    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC'   CAT  '/BL'     CLRBL   8                                           CSW213
     C           CLRBL     CAT  BBBLCD    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C           BBFWCD    IFNE *ZEROS                                                        CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/CLRC'   CAT  '/FW'     CLRFW   8                                           CSW213
     C                     MOVE BBFWCD    DNFWCD  9                                           CSW213
     C           CLRFW     CAT  DNFWCD    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDIF                                                              CSW213
     C           CSLEIC    IFNE *BLANKS                                                       CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/LEIC/'  CAT  CSLEIC    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ADD  1         X                                                   CSW213
     C           X         OCUR MULT                                                          CSW213
     C           '/NAME/'  CAT  BBCNA1    MFLD                                                CSW213
     C                     ENDIF                                                              CSW213
     C                     ELSE                                                               CSW213
     C                     ADD  1         X                                                 MD023009
     C           X         OCUR MULT                                                        MD023009
     C                     EXSR FSWAD                                                         CSW213
     C                     ENDIF                                                              CSW213
     C                     ENDSR                                                              CSW213
      /EJECT
      *****************************************************************
      *   FSWAD - Format SWIFT address                                *
      *   Called by - RECV  - Format fields 53,56, and 57.            *
      *               PAY   - Format fields 53,56, and 57.            *
      *****************************************************************
      *
     C           FSWAD     BEGSR
      *
     C*********************CALL 'ZM0050'                                                      CSW036
     C                     CALL 'ZM0051'                                                      CSW036
     C                     PARM           ZDEST  12
     C                     PARM           ZSADD1 35
     C                     PARM           ZSADD2 35
     C                     PARM           ZSADD3 35
     C                     PARM           ZSADD4 35
     C                     PARM           ZSTAG   1
     C                     PARM           ZSTYPE  1
     C                     PARM           ZERR    1
     C                     PARM           ZDBEI                                               CSW201
      *
      ** Error ?
      *
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVE @MTAG     MTAG
     C                     MOVELZDEST     MFLD
     C                     MOVELMSGA,6    MERR
     C                     ELSE
      *
      ** Address 1
      *
     C           ACLINE    IFNE *BLANKS
     C                     MOVELACLINE    MFLD
     C                     ELSE
     C                     MOVELZSADD1    MFLD
     C                     END
      *
      ** SWIFT address;  Else full address.
      *
     C           ZSTAG     IFEQ 'A'
     C                     MOVE 'A'       TAG
     C                     MOVE @MTAG     MTAG
     C           ACLINE    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD1    MFLD
     C                     END
      *
     C                     ELSE
     C                     MOVE 'D'       TAG
     C                     MOVE @MTAG     MTAG
     C           ACLINE    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD1    MFLD
     C                     END
      *
      **  Address 2
      *
     C           ZSADD2    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD2    MFLD
     C                     END                             Address 2
      *
      **  Address 3
      *
     C           ZSADD3    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD3    MFLD
     C                     END                             Address 3
      *
      **  Address 4
      *
     C           ZSADD4    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD4    MFLD
     C                     END                             Address 4
     C                     END                             Address 1
      *
     C                     END                             Error ?
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *   FLD72 - Format Field 72 (Sender to Receiver Information)    *
      *   Called by - Main process                                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           FLD72     BEGSR
      *
      ** Store the Sender to Receiver information for easier use.
      *
     C                     MOVE MGS2R1    S2RF,1
     C                     MOVE MGS2R2    S2RF,2
     C                     MOVE MGS2R3    S2RF,3
     C                     MOVE MGS2R4    S2RF,4
     C                     MOVE MGS2R5    S2RF,5
     C                     MOVE MGS2R6    S2RF,6
      *
     C                     Z-ADD0         I
     C                     MOVE 'N'       FLD72O  1
      *
      ** Search through all six fields & output if not blank.
      *
     C           I         DOWLT6
      *
     C                     ADD  1         I
     C           S2RF,I    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C           FLD72O    IFEQ 'N'
     C                     MOVE ':72: '   MTAG
     C                     MOVE 'Y'       FLD72O
     C                     ENDIF
     C                     MOVELS2RF,I    MFLD
     C                     ENDIF
      *
     C                     ENDDO
      *
     C                     ENDSR
      /EJECT
      *****************************************************************
      *   CFMAT - produce confirmation matching feedback record       *
      *   Called by - Main process                                    *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           CFMAT     BEGSR
      *
     C                     CALL 'MG5001'
     C                     PARM TRNO      @TRNM  16
     C                     PARM MGBRCA    @BRCA   3
     C                     PARM *BLANK    @FEED   1
      *
     C           @FEED     IFEQ 'Y'
      *
     C           *IN50     IFEQ '0'
     C                     OPEN MG0341P1
     C                     SETON                     50U7
     C                     END
      *
      ** Set up headings and sender/customer information
      ** for the error report.
      *
     C                     MOVE '1'       *IN30
     C                     MOVELMGTNUM    TNUM    60
     C                     WRITEHEADER
     C                     WRITETEXT
     C                     WRITEFEED
     C                     MOVE '0'       *IN30
     C                     END
      *
     C                     ENDSR
      *****************************************************************                       CSD015
      /EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
      *                                                               *                       CSD015
      *  SRWTCH - Initiates the Midas Watch List Checking Engine.     *                       CSD015
      *                                                               *                       CSD015
      *****************************************************************                       CSD015
     C           SRWTCH    BEGSR                                                              CSD015
      *                                                                                       CSD015
      ** Check if the message is for automatic release.                                       CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       PARLS                                               CSD015
      *                                                                                       CSD015
     C           MGST      IFEQ 'RSND'                                                        CSD015
     C           NWRK      IFEQ 'SWIFT '                                                      CSD015
     C           NWRK      OREQ 'TELEX '                                                      CSD015
     C           NWRK      OREQ 'STTX  '                                                      CSD015
     C                     MOVE 'CRTD'    MGST                                                CSD015
     C                     MOVE 'Y'       PARLS   1                                           CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Initialise the Transaction Details parameter.                                        CSD015
      *                                                                                       CSD015
     C                     CLEARWLTDS                                                         CSD015
     C                     Z-ADD*ZERO     W4VDAT                                              CSD015
     C                     Z-ADD*ZERO     W4MDAT                                              CSD015
     C                     Z-ADD*ZERO     W4AMT1                                              CSD015
     C                     Z-ADD*ZERO     W4AMT2                                              CSD015
      *                                                                                       CSD015
     C                     MOVELTRNO      W4IDEN                                              CSD015
     C                     MOVELMTPY      W4ITEM                                              CSD015
     C                     MOVEL'MGOREF  'W4FUNT                                              CSD015
     C                     MOVELMGBRCA    W4BRCH                                              CSD015
     C                     MOVELDECN      W4CNUM                                              CSD015
     C                     Z-ADDBJRDNB    W4DDAT                                              CSD015
     C                     MOVELPARLS     W4ARLS                                              CSD015
      *                                                                                       CSD015
      ***Send*the*Transaction Details to the Compliance Engine.                        CSD015 221145
      *********************                                                            CSD015 221145
     C*********************CALL 'SDWLCLOP'                                             CSD015 221145
     C*********************PARM           WLTDS                                        CSD015 221145
     C*********************PARM *BLANKS   PSTRNG                                       CSD015 221145
      *                                                                                       CSD015
     C                     ENDSR                                                              CSD015
      *****************************************************************                       CSD015
     C/EJECT                                                                                  221145
      *****************************************************************                       221145
      *                                                               *                       221145
      *  WLCDQ - Submit information to Watch List Check Dtaq          *                       221145
      *                                                               *                       221145
      *****************************************************************                       221145
      *                                                                                       221145
     C           WLCDQ     BEGSR                                                              221145
      *                                                                                       221145
      *  Send transaction to compliance engine program                                        221145
      *                                                                                       221145
     C                     CALL 'SDWLCLOP'                                                    221145
     C                     PARM           WLTDS                                               221145
     C                     PARM *BLANKS   PSTRNG                                              221145
      *                                                                                       221145
      *                                                                                       221145
     C                     ENDSR                                                              221145
      *                                                                                       221145
      *
      /EJECT
      *****************************************************************
      *   *PSSR - error handling                                      *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
      **  Write database error to report
      *
     C                     OPEN MG0341AU
     C                     WRITEHEAD
     C                     WRITEDBERROR
      *
     C                     MOVE *ON       *INU7
     C                     MOVE *ON       *INU8
     C                     MOVE *ON       *INLR
     C                     DUMP
     C                     RETRN
      *
     C                     ENDSR
      /EJECT
      /COPY MGCPYSRC,SWIFTTRANS
** CPY@   Object Copyright
(c) Finastra International Limited 2001
** MSGA   Messages
Settlement - pay
Customer details not found on SDCUSTPD
Nostro customer not found on SDNOSTPD
Broker code not found on SDBROKPD
ZM0040 (format ccy and amount) call ended in error
ZM0050 (format SWIFT address) call ended in error
Codeword was not found for this message
Duplicate TRN key built for this message
** TABNST - Codes indicating settlement via nostro
01
02
07
08
12
** TABINT - Codes indicating settlement via internal
03
04
05
06
14
