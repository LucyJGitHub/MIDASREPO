     H        1                           F
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MG Fmt loan/dep. int. pay. advices')             *
     F*****************************************************************
     F*                                                               *
     F*  Midas - MESSAGE GENERATION                                   *
     F*                                                               *
     F*  MG0350 - FORMAT LOAN/DEPOSIT INTEREST PAYMENT ADVICES.       *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. MD038672           Date 10May16               *
      *  Prev Amend No. CSW216             Date 14Mar16               *
      *                 CDL096I02          Date 04Nov14               *
      *                 CDL096I01          Date 03Nov14               *
      *                 CSW213             Date 03Jun13               *
      *                 AR996895           Date 25Nov12               *
      *                 CLE148             Date 23Jul12               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246141             Date 26Mar07               *
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CIR013             Date 25Apr05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 27Oct03               *
      *                 222385             Date 23Oct03               *
      *                 221145             Date 08Sep03               *
      *                 219242             Date 01Jul03               *
      *                 219241             Date 01Jul03               *
      *                 CSD015             Date 14Oct02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSW025             Date 26Mar02               *
      *                 CSW024             Date 31Aug01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CSW201             Date 02May01               *
      *                 183583             Date 11Jun01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 190127             Date 28Feb01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CSW200             Date 21Aug00               *
      *                 CIR004             Date 20Jan00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 141572             DATE 21SEP98               *
      *                 137909             Date 22Jul98               *
     F*                 113352            DATE 13FEB97                *
     F*                 121768             DATE 19FEB98               *
     F*                 126017             DATE 18NOV97               *
     F*                 097885             DATE 31JAN97               *
     F*                 CSW096             DATE 03JUN96               *
     F*                 103387             DATE 21MAY96               *
     F*                 068795             DATE 27FEB96               *
     F*                 067680             DATE 27FEB96               *
     F*                 095244             DATE 01NOV95               *
     F*                 095238             DATE 31OCT95               *
     F*                 088043             DATE 14JUN95               *
     F*                 084320             DATE 07MAR95               *
     F*                 080096             DATE 12JAN95               *
     F*                 066600             DATE 04FEB94               *
     F*                 066550             DATE 04FEB94               *
     F*                 055058             DATE 19NOV93               *
     F*                 056739             DATE 16NOV93               *
     F*                 S01421             DATE 18AUG93               *
     F*                 E42086             DATE 10JUL92               *
     F*                 E40242             DATE 25JUN92               *
     F*                 E38183             DATE 07APR91               *
     F*                 E29588             DATE 14NOV91               *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  MD038672 - MMM did not process MT350 due to duplicate message*
      *             field tag :53:                                    *
      *  CSW216 - SWIFT Changes 2016                                  *
      *  CDL096I02 - Fix on Next Interest Payment Date                *
      *  CDL096I01 - Fix to use IBDT(DEALSDC) when Amount Convention  *
      *              is 'A'(Actual)                                   *
      *  CSW213 - SWIFT Changes 2013 (Recompile)                      *
      *  AR996895 - Incorrect accrual interest calculation.           *
      *             (Child:AR996897) (Recompile)                      *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *            to Midas Plus (Recompile)                          *
      *  246141 - Recompiled due to changes in ZINTDYZ2               *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over GLINTC and ZINTDY.                   *
      *           Rename SR/INTF as pgm won't compile over GLINTCZ1   *
      *           changes for LSC236.                                 *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Parameter Mismatch.                                 *
      *  222385 - SWIFT msgs are Watch List checked regardless of     *
      *           configuration file setting                          *
      *  221145 - Compliance Watch WLC: Move compliance check to      *
      *           after COMIT to MGOMSGPD                             *
      *  219242 - Not possible to create MT103+ payment msg from      *
      *           non-FT transaction (Recompile)                      *
      *  219241 - Defaulting of "Details of Charges" assign a         *
      *           system value (Recompile)                            *
      *  CSD015 - Midas Compliance Watch - Watch List Checking        *
      *  CSW025 - Midas Message Manager                               *
      *           - Pass original change type                         *
      *  CSW024 - MT3xx field 82/83/87 changes                        *
      *  CSW201 - SWIFT 2001 Standards Update                         *
      *  183583 - Add extension file MGOEXTPD to store customer no.   *
      *           of field with SWIFT address.                        *
      *  190127 - Related reference should contain tansaction         *
      *           reference of previous message of same type          *
      *  CDL008 - Continuous Linked Settlement (Recompiled)           *
     F*  CSW200 - Swift 2000 Changes                                  *
      *  CIR004 - Dealing Calculation Method Change.                  *
      *         - Recompiled due to GLINTC and ZINTDY changes         *
     F*  141572 - Setup CINDV (century flag) SVDT ( value date).      *
     F*  137909 - Use the settlement currency if not blank for        *
     F*           accessing nostro details. This is needed for tag    *
     F*           57A.                                                *
     F*  113352 - Set-up CIND (Century flag)  to correct year2000     *
     F*           display problem.                                    *
     F*  121768 - Recompile over changed GLINTCZ1                     *
     F*  126017 - Correction to interest calculation for calculation  *
     F*           basis 6 in SR/GLINTC. Add SR/ZDAT10                 *
     F*  097885 - Recompiled for wrong calculation of number of day   *
     F*           interest (ZINTDYZ2).                                *
     F*  CSW096 - SWIFT Changes 1996                                  *
     F*           Add validation of field 22.                         *
     F*  103387 - If MGAWBA contains DIRECT, reformat it in /DIRECT   *
     F*           See also MG03xx.                                    *
     F*  068795 - Interest was still being calculated incorrectly     *
     F*           if DEAMS existed that were input today ie deals     *
     F*           update is not run before this is run. This fix      *
     F*           adds a new interest amount field to the file        *
     F*           MGF350PD which was calculated in DL0195 for the     *
     F*           confirmations.                                      *
     F*  067680 - Interest amount field 34P was being calculated      *
     F*           incorrectly. Processing added to calculate the      *
     F*           interest accrued this month correctly.              *
     F*  095244 - Recompiled for Calculation method 3                 *
     F*  095238 - Recompiled for Calculation method 3                 *
     F*  088043 - If DIRECT entered, use Beneficiary for :57: on Pay  *
     F*           Sequence                                            *
     F*  084320 - Do not set on U7 for a non-fatal error, as this     *
     F*           will cause the controlling component to end         *
     F*           abnormally.                                         *
     F*  080096 - RECOMPILE BECAUSE COPY MEMBER MGCPYSRC,SWIFTTRANS   *
     F*           CHANGED                                             *
     F*  066600 - Was not working out Date Format correctly.          *
     F*  066550 - GLINTC has had historical problems and inaccuracies *
     F*           and is now externaly descibed and changed to use    *
     F*           ZINTDYZ1. See document atached to error no on GEMS  *
     F*  055058 - Move blank to CFPF before MGOREFPD record output.   *
     F*  056739 - Add account line for fields :56: and :57:           *
     F*  S01421 - REPLACE THE SWIFT TRANSLATION TABLE WITH A          *
     F*           /COPY STATEMENT (SWIFTTRANS).                       *
     F*  E42086 - CATER FOR BLANK ADDRESS LINES                       *
     F*  E40242 - RE-COMPILED FOR CHANGE TO ASEQ                      *
     F*  E38183 - Database error if pay settlement method is '00'     *
     F*           because MGPONS is blank, so cannot format :53:      *
     F*  E29588 - POST COLLECTION SWIFT RATIONALISATION FIXES         *
     F*           o Interest amount incorrectly rounded (E31885)      *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*****************************************************************
     FMGF350PDUF  E                    DISK
     F                                              KCOMIT
     FMGOREFL0IF  E           K        DISK
     F            MGOREFD0                          KRENAMEMGREFL0
      *                                                                                    CDL096I01
     FDEALS   IF  E           K        DISK                                                CDL096I01
     F            DEALSDAF                          KIGNORE                                CDL096I01
     F            DEALSDBF                          KIGNORE                                CDL096I01
     F            DEALSDDF                          KIGNORE                                CDL096I01
     F            DEALSDEF                          KIGNORE                                CDL096I01
     F            DEALSDGF                          KIGNORE                                CDL096I01
     F            DEALSDFF                          KIGNORE                                CDL096I01
      *                                                                                    CDL096I01
     FMGOREFPDO   E                    DISK
     F                                              KCOMIT
     FMGOMSGPDO   E                    DISK
     F                                              KCOMIT
     F/COPY WNCPYSRC,MG0350F001
      *                                                                                       190127
      ** MG Transaction history file                                                          190127
     FMGHISTL0UF  E           K        DISK                      A                            190127
     F                                              KCOMIT                                    190127
     FMGOEXTPDO   E                    DISK                               183583
     F                                              KCOMIT                183583
     FMG0350P1O   E                    PRINTER                        UC
     FMG0350AUO   E                    PRINTER                        UC
     F/COPY WNCPYSRC,MGH00103
      ********************************************************************
      *
      * ID C  F  H  L    FUNCTION OF INDICATORS
      *
      *    05            Error on write to MGOREFPD.
      *    06            Error on write to MGOMSGPD
      *    10            EOF MGF350PD
      *    11            Chain to MGREFL0.
      *    15            Error in call to standard program (ZMxxxx)
      *    16            Error on delete of GDF record.
      *    20            LOKUP operation searching array (GNR, @WRK)
      *    21            LOKUP operation searching array (GNR)
      *    22            LOKUP operation searching array (GNR).
      *    23            Settlement method on TABNST/TABINT
      *    24            Error on call to MG5000
      *    30            Feedback record not generated
      *    31            @wrk array indicator.
      *    50            MG0350P1 open
      *    90            Calculation basis 2
      *    91            Calculation basis 3
      *    92            Calculation basis 1
      *    95            Calculation basis 6
      *    96            Calculation basis 5
      *    97            Calculation basis 4
      *    U7U8          Database error
      *
     F********************************************************************
     E                    CPY@    1   1 80               copyright
     E/COPY WNCPYSRC,MG0350E001
     E                    MSGA    1   6 60               message text
     E                    TABNST  1   5  2               settlement nostro
     E                    TABINT  1   5  2               settle. internal
     E                    GNR        15  3               msg gen. released
     E                    @WRK       50  1               work field
     E                    ZYDY    4   4  4 0             ZDATE1/2 SR.ARRAY
     E                    ZMDY   13  13  3 0             ZDATE1/2 SR.ARRAY
     E                    ZMNM   12  12  3               ZDATE2 SR. ARRAY
      *
     E/COPY ZSRSRC,ZDATE9Z1                                               066550
     E********************************************************************
      *
     E/COPY WNCPYSRC,MG0350E002
     I/COPY WNCPYSRC,MG0350I001
     I            DS
     I                                        1  12 CSID
     I                                        9  11 @BIC
      **  Data structure to test for BIC code
      *
     IMULT        DS                         95
     I                                        1   5 MTAG
     I                                        6  55 MFLD
     I                                       56 105 MERR
      **  Multiple occurrence data structure for message
      *
     IEXTN        DS                         20                           183583
     I                                        1   20MPSN                  183583
     I                                        3   7 MTG                   183583
     I                                        8  15 MCSI                  183583
      *                                                                   183583
      ** Multiple occurrence data structure for extension file            183583
      *                                                                   183583
     I            DS                                                      183583
     I                                        1   5 @MTG                  183583
     I                                        2   2 FLDTYP                183583
     I                                        4   4 FLDTAG                183583
      *                                                                   183583
      ** Field tag data structure                                         183583
      *                                                                   183583
     IFLD3N       DS                         24
     I                                        1   6 ZSDATE
     I                                        7   9 ZSCCY
     I                                       10  24 ZSAMNT
      **  Data structure containing codeword for fields 32.
      *
     IERR3N       DS                         24
     I                                        1   3 ZCCY
     I                                        5  170ZAMT
      **  Erroneous currency & amounts for Fields 32.
      *
     I@MTAG       DS                          5
     I                                        1   1 COLON1
     I                                        2   3 FLDNO
     I                                        4   4 TAG
     I                                        5   5 COLON2
      **  Data structure constructing message field tag
      *
     IP@IN        DS                            256                       CSW096
     I                                        1   3 I@SNBR                CSW096
     I                                        4   9 I@DSCN                CSW096
     I                                       10  12 I@MTPY                CSW096
     I                                       13  140I@SETT                CSW096
     I                                       15  15 I@CONC                CSW096
     I                                       16  16 I@FTCS                CSW096
     I                                       17  18 I@MMOD                CSW096
      ** Data structure for input parameter                               CSW096
      *                                                                   CSW096
     IP@OUT       DS                            256                       CSW096
     I**********                              1   60O@CNSN                             CSW096 CSD027
     I                                        1   6 O@CNSN                                    CSD027
     I                                        7  18 O@SWSN                CSW096
     I                                       19  38 O@NWSN                CSW096
     I                                       39  49 O@SWDS                CSW096
     I                                       46  46 W@96CN                CSW096
     I                                       47  49 W@BIC                 CSW096
     I                                       50  69 O@NWDS                CSW096
     I                                       70  75 O@NWRK                CSW096
     I                                       76  76 O@MGSG                CSW096
     I                                       77  80 O@MGST                CSW096
     I                                       81  81 O@PAIN                CSW096
     I                                       82  87 O@PCNB                CSW096
     I                                       88  90 O@SPRS                CSW096
      ** Data structure for ouput parameter                               CSW096
      *                                                                   CSW096
     I@HREF       DS                         16                                               190127
     I                                        1   2 HSMODI                                    190127
     I                                        3   8 HSTRAN                                    190127
     I                                        9  11 HSSEQ                                     190127
      **  Data structure for related reference                                                190127
      *                                                                                       190127
     ISDBANK    E DSSDBANKPD
      **  External Data structure for bank details.
      *
     ISDTRAD    E DSSDTRADPD
      **  External Data structure for trading file.
      *
     ISDCUST    E DSSDCUSTPD
      **  External Data structure for customer details.
      *
     ISDBRCH    E DSSDBRCHPD
     I              QQDFAC                          DFACQQ                                    CGL029
      **  External Data structure for branch details.
      *
     ISDMMOD    E DSSDMMODPD
      **  External Data structure for module ICD file.
      *
     ISDNOST    E DSSDNOSTPD
     I              QQACCD                          ACCDQQ                                    CGL029
      **  External Data structure for nostro details.
      *
     ISDMGME    E DSSDMGMEPD
      **  Data structure for message management data.
      *
     ISCSARD    E DSSCSARDPD                                                                  CSW024
      **  Data structure for Switchable Features file                                         CSW024
      *                                                                                       CSW024
     IDSFDY     E DSDSFDY
      **  Short data structure for access programs
      *
     IDSSDY     E DSDSSDY
      **  Long data structure for access programs
      *
     IDSLDY     E DSDSLDY                                                                     CSW024
      ** Third data structure for access programs                                             CSW024
      *                                                                                       CSW024
     IWLTDS     E DSSDWLTOPD                                                                  CSD015
      ** Watch List Transaction Details Data Structure                                        CSD015
      *                                                                                       CSD015
     IPSTRNG      DS                           9999                                           CSD015
      ** SDWLCLOP Search String Parameter                                                     CSD015
      *                                                                                       CSD015
     ISDWLCC    E DSSDWLCCPD                                                                  222385
      ** Watch list checking details                                                          222385
      *                                                                                       222385
     ILDA         DS                            256
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
      **  Local data area
      *
     I/COPY ZSRSRC,ZINTDYZ1                                               066550
     I/COPY ZSRSRC,ZDATE9Z2                                               066550
     I/COPY ZSRSRC,ZDAT10Z1                                               126017
     I/COPY WNCPYSRC,MG0350I002
     IMGAWBA      DS                                                      103387
     I                                        1   6 WWAWBA                103387
     I                                        7  35 WWAWBB                103387
     C/EJECT
      *****************************************************************
      *                   Index to subroutines                        *
      *   main process                                                *
      *   FSWAD- Format Swift Address.                                *
      ****INTF - Initialise non-constant fields.***********************                       CIR013
      *   SRINTF - Initialise non-constant fields.                    *                       CIR013
      ****ROUT*-*Determine*Message*Routing.****************************   CSW096
      * SRROUT - Determine Message Routing.                           *   CSW096
      *   FMTA - Format Message Detail.                               *
      *   RCV  - Format Fields 53 ,56 and 57.                         *
      *   PAY  - Format Fields 53  56 and 57.                         *
      *   FMA200 - Format Message Details - Sequence A                *   CSW200
      *   PAY200  - Format Fields 53  56 and 57.                      *   CSW200
      ****NWAD*-*Determine*Default*Network*Address.********************   CSW096
      ****PRAD*-*Determine*Priority*Network*Address.*******************   CSW096
      **TXROUT*-*Attempt*priority*route*to*STTX/Telex******************   CSW096
      **SWROUT*-*Attempt*priority*route*to*SWIFT***********************   CSW096
      ****FILL*-*Fill*arrays*for*generation*state**********************   CSW096
      *   REPT - Print Incorrectly Generated Messages.                *
      *   OMSG - Output Correctly Generated Messages.                 *
      *   WREF - Write o/p reference to PF/MGOREFPD.                  *
      *   INIT - Initial Process.                                     *
      *   *PSSR- Error Handling.                                      *
      *                                                               *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *   NOTE:   A multiple occurrence data structure is used to     *
      *           store up the records that make up the SWIFT message *
      *           before writing the whole message to file.           *
      *           To store the records of the message, you must       *
      *           first access an OCUR record, obtain the Message Tag *
      *           & Message field data values for this OCUR record,   *
      *           then go on to the next OCUR record and continue     *
      *           this process until the SWIFT message is complete.   *
      *                                                               *
      *   NOTE2:  PAY and RCV subroutines.                            *
      *           Both subroutines PAY and RCV format the same        *
      *           fields.However the order in which these are         *
      *           performed depends upon whether the deal is a        *
      *           placing (loan) or a taking(deposit).                *
      *           MGLORD:           ¦ L(placing) ¦D(taking)   ¦       *
      *           ~~~~~~~~~~~~~~~~~~¦~~~~~~~~~~~~¦~~~~~~~~~~~~¦       *
      *                             ¦     RCV    ¦    PAY     ¦       *   088043
      ******************************¦*****PAY****¦****RCV*****¦********   088043
      *           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~        *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *   MAIN - main process                                         *
      *   Called by - none                                            *
      *   Calls - INIT Initial Process.                               *
      ************INTF Initialise non-constant fields.*****************                       CIR013
      *           SRINTF Initialise non-constant fields.              *                       CIR013
      ************ROUT*Determine*Message*Routing.**********************   CSW096
      *           SRROUT Determine Message Routing.                   *   CSW096
      *           FMTA Format Message Detail.                         *
      *           REPT Print Incorrectly Generated Messages.          *
      *           OMSG Output Correctly Generated Messages.           *
      *****************************************************************
      *
      **  Transaction history key                                                             190127
     C           HSKEY     KLIST                                                              190127
     C                     KFLD           MGMODI                                              190127
     C                     KFLD           HSTRAN                                              190127
     C                     KFLD           HSMTPY                                              190127
      *
      ** Initial process
      *
     C/COPY WNCPYSRC,MG0350C024
     C                     EXSR INIT
      *
      ** Read the first record from the MT350 extract file
      *
     C                     READ MGF350PD                 10
      *
      ** Format Message Control.
      *
      ** Do While records found on the MT350 extract file
      *
     C           *IN10     DOWEQ'0'
      *
      ** Initialise non-constant fields
      *
     C******               EXSR INTF                                                          CIR013
     C                     EXSR SRINTF                                                        CIR013
      *
      ** Determine Message Routing.
      *
     C***********          EXSR ROUT                                      CSW096
     C                     EXSR SRROUT                                    CSW096
      *                                                                   CSW200
     C           CSW200    IFEQ 'N'                                       CSW200
      *
      ** Format Message Detail.
      *
     C                     EXSR FMTA
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      ** Use the Swift 2000 changes                                       CSW200
      *                                                                   CSW200
      ** Format Message Detail - Seq A.                                   CSW200
      *                                                                   CSW200
     C                     EXSR FMA200                                    CSW200
     C                     ENDIF                                          CSW200
      *
      ** Print incorrectly generated message
      *
     C           @ERR      IFEQ 'Y'
     C                     EXSR REPT
     C                     ELSE
      *
      ** Output correctly generated message
      *
     C                     EXSR OMSG
      *
      ** If confirmation matching switched on, generate feedback record
      **  (at present only produced for dealing)
      *
     C           BGCFMT    IFEQ 'Y'
     C           MGMODI    ANDEQ'DL'
     C                     EXSR CFMAT
     C                     END
      *
     C                     END
      *
      ** Delete the processed GDF record.
      *
     C                     DELETMGF350PD               16
      *
      **  Error on delete of record.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '013'     DBASE              * * * * * * *
     C                     MOVELMGTNUM    DBKEY              * DBERR 013 *
     C                     MOVEL'MGF350PD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Update sequence numbers on transaction record
      **  if no errors have occurred
      *
     C           @ERR      IFNE 'Y'
     C                     CALL 'MG5000'               24
     C                     PARM MGMODI    @MODI   2
     C                     PARM MGTNUM    @TRAN  15
     C                     PARM 'CE'      @PROG   2
     C                     PARM 'U'       @MODE   1
     C                     PARM *ZEROS    MGLSWC  30
     C                     PARM *ZEROS    MGLSWS  30
     C                     PARM *BLANKS   @ERCD   1
      *
      **  Error on access for sequence number
     C           @ERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Program missing on call
     C           *IN24     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '025'     DBASE            * * * * * * * *
     C                     MOVE 'MG5000'  DBKEY            *  DBERR 025  *
     C                     OUT  LDA                        * * * * * * * *
     C                     EXSR *PSSR
     C                     END
      *
     C                     END
     C           *LOCK     IN   LDA
     C                     MOVEL'MG0350  'DBPGM
     C                     OUT  LDA
      *
      **  COMIT all changes since no error on writing the message
      *
     C                     COMIT
      *                                                                   221145
      **  Call Compliance Watch:Watch List Checking                       221145
      *                                                                   221145
     C           CSD015    IFEQ 'Y'                                       221145
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDEQ'N'                                       221145
     C                     EXSR WLCDQ                                     221145
     C                     ENDIF                                          221145
      *
      **  Read the next record.
      *
     C                     READ MGF350PD                 10
     C                     END
      *
      **  Write end of report, only if the printer file is open
      *
     C           *IN50     IFEQ '1'
     C                     WRITEEOREPT
     C                     END
     C/COPY WNCPYSRC,MG0350C009
      *
     C                     SETON                     LR
      *
     C/EJECT
      *****************************************************************
      *   FSWAD - Format SWIFT address                                *
      *   Called by - PAY   - Format fields 53,56, and 57.            *
      *               RCV   - Format fields 53,56, and 57.            *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           FSWAD     BEGSR
      *
     C*********************CALL 'ZM0050'                                                      CSW036
     C                     CALL 'ZM0051'                                                      CSW036
     C                     PARM           ZDEST  12
     C                     PARM           ZSADD1 35
     C                     PARM           ZSADD2 35
     C                     PARM           ZSADD3 35
     C                     PARM           ZSADD4 35
     C                     PARM           ZSTAG   1
     C                     PARM           ZSTYPE  1
     C                     PARM           ZERR    1
     C                     PARM           ZDBEI   1                                           CSW201
      *
      **  Error ?
      *
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVE @MTAG     MTAG
     C                     MOVELZDEST     MFLD
     C                     MOVELMSGA,5    MERR
     C                     ELSE
      **  Address 1
     C           ACLINE    IFNE *BLANKS                                   088043
     C                     MOVELACLINE    MFLD                            088043
     C                     ELSE                                           088043
     C                     MOVELZSADD1    MFLD
     C                     END                                            088043
      *
      **  SWIFT address;  Else full address
     C           ZSTAG     IFEQ 'A'
     C                     MOVE 'A'       TAG
     C                     MOVE @MTAG     MTAG
     C                     MOVE *BLANKS   SAVMTG  5                       183583
     C           ACLINE    IFNE *BLANKS                                   088043
     C                     MOVE MTAG      SAVMTG                          183583
     C                     ADD  1         X                               088043
     C           X         OCUR MULT                                      088043
     C                     MOVELZSADD1    MFLD                            088043
     C                     END                                            088043
     C                     EXSR SEXTN                                     183583
      *
     C                     ELSE
     C                     MOVE 'D'       TAG
     C                     MOVE @MTAG     MTAG
     C           ACLINE    IFNE *BLANKS                                   088043
     C                     ADD  1         X                               088043
     C           X         OCUR MULT                                      088043
     C                     MOVELZSADD1    MFLD                            088043
     C                     END                                            088043
      **  Address 2
     C           ZSADD2    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD2    MFLD
     C                     END                             Address 2      E42086
      **  Address 3
     C           ZSADD3    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD3    MFLD
     C                     END                             Address 3      E42086
      **  Address 4
     C           ZSADD4    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD4    MFLD
     C                     END                             Address 4
     C**********           END                             Address 3      E42086
     C**********           END                             Address 2      E42086
     C                     END                             Address 1
      *
     C                     END                             Error ?
      *
     C                     ENDSR
      /EJECT                                                              183583
      *****************************************************************   183583
      *                                                               *   183583
      *   SEXTN - Store customer with SWIFT address to data structure *   183583
      *                                                               *   183583
      *   Called by: FSWAD, PAY                                       *   183583
      *   Calls    : None                                             *   183583
      *                                                               *   183583
      *****************************************************************   183583
      *                                                                   183583
     C           SEXTN     BEGSR                                          183583
      *                                                                   183583
     C           SAVMTG    IFNE *BLANKS                                   183583
     C                     MOVE SAVMTG    @MTG                            183583
     C                     ELSE                                           183583
     C                     MOVELMTAG      @MTG                            183583
     C                     ENDIF                                          183583
     C           FLDTYP    IFEQ '5'                                       183583
     C           FLDTAG    ANDEQ'A'                                       183583
     C                     ADD  1         V                               183583
     C           V         OCUR EXTN                                      183583
     C                     Z-ADDX         MPSN                            183583
     C                     MOVEL@MTG      MTG                             183583
     C                     MOVELZDEST     MCSI                            183583
     C                     ENDIF                                          183583
      *                                                                   183583
     C           SEXT9     ENDSR                                          183583
     C/EJECT
      *****************************************************************
      ****INTF - Initalise non-constant fields.************************                       CIR013
      *   SRINTF - Initalise non-constant fields.                     *                       CIR013
      *   Called by - main process.                                   *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C******     INTF      BEGSR                                                              CIR013
     C           SRINTF    BEGSR                                                              CIR013
      *
     C                     MOVE *BLANKS   AWBA6   6                       088043
     C                     MOVELMGAWBA    AWBA6   6                       088043
      *                                                                   103387
      * Reformat MGAWBA if it contains "DIRECT"                           103387
      *                                                                   103387
     C                     MOVE MGAWBA    MGTEST 29                       103387
     C           WWAWBA    IFEQ 'DIRECT'                                  103387
     C           WWAWBB    ANDEQ*BLANKS                                   103387
     C                     MOVEL'/DIRECT' MGAWBA    P                     103387
     C                     END                                            103387
     C                     MOVE *BLANKS   TRNO
     C                     MOVE *BLANKS   @TRNA
     C                     MOVE *BLANKS   @TRNB
     C                     MOVE '      '  NWRK
     C**********           Z-ADD0         SECN                                                CSD027
     C                     MOVE *BLANKS   SECN                                                CSD027
     C                     MOVE *BLANKS   NWSN
     C**********           Z-ADD0         DECN                                                CSD027
     C                     MOVE *BLANKS   DECN                                                CSD027
     C                     MOVE *BLANKS   NWDS
     C                     MOVE *BLANKS   MGSG
     C                     MOVE *BLANKS   MGST
     C                     MOVE *BLANKS   LSCC
     C                     MOVE *BLANKS   F57U
     C                     Z-ADD0         MGTM
     C                     Z-ADD0         LATM
     C                     MOVE *BLANKS   RELD
     C                     Z-ADD0         RELT
     C                     MOVE *BLANKS   AMTS
     C                     MOVE *BLANKS   SVDT
     C                     MOVE *BLANKS   CINDV                           141572
      *
     C                     MOVE *BLANKS   @ERR    1
     C                     MOVE *BLANKS   SCSID  12
     C                     MOVE *BLANKS   STELX  10
     C                     MOVE *BLANKS   SSTTX  12
     C                     MOVE *BLANKS   SCRNM  20
     C                     MOVE *BLANKS   SPCNB   6
     C                     MOVE *BLANKS   SPAIN   1
      *
      **  Clear multiple occurrence data structure
      *
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
      *
     C***********X         DOWLE40                                        CSW200
     C           X         DOWLE35                                        CSW200
     C           MULT      ANDNE*BLANKS
     C                     MOVE *BLANKS   MULT
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END
      *                                                                   183583
      ** Clear multiple occurrence DS for the extension file.             183583
      *                                                                   183583
     C                     Z-ADD1         V       20                      183583
     C           V         OCUR EXTN                                      183583
     C           V         DOWLE10                                        183583
     C           MCSI      ANDNE*BLANKS                                   183583
     C                     Z-ADD*ZEROS    MPSN                            183583
     C                     MOVE *BLANKS   MTG                             183583
     C                     MOVE *BLANKS   MCSI                            183583
     C                     ADD  1         V                               183583
     C           V         OCUR EXTN                                      183583
     C                     ENDDO                                          183583
     C                     Z-ADD0         V                               183583
      *
      **  Obtain sequence numbers from transaction record
     C                     CALL 'MG5000'               24
     C                     PARM MGMODI    @MODI   2
     C                     PARM MGTNUM    @TRAN  15
     C                     PARM 'CE'      @PROG   2
     C                     PARM *BLANKS   @MODE   1
     C                     PARM *ZEROS    MGLSWC  30
     C                     PARM *ZEROS    MGLSWS  30
     C                     PARM *BLANKS   @ERCD   1
      *
      **  Error on access for sequence number
     C           @ERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Program missing on call
     C           *IN24     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '023'     DBASE            * * * * * * * *
     C                     MOVE 'MG5000'  DBKEY            *  DBERR 023  *
     C                     OUT  LDA                        * * * * * * * *
     C                     EXSR *PSSR
     C                     END
     C           *LOCK     IN   LDA
     C                     MOVEL'MG0350  'DBPGM
     C                     OUT  LDA
      *
     C                     MOVE *BLANKS   @KEY1                                               CSW024
     C                     MOVELMGCNUM    @KEY1                                               CSW024
     C                     CALL 'AOCUSTR1'                                                    CSW024
     C                     PARM '*MSG   ' @RTCD                                               CSW024
     C                     PARM '*KEY   ' @OPTN                                               CSW024
     C                     PARM           @KEY1                                               CSW024
     C                     PARM *BLANKS   @KYST                                               CSW024
     C           SDCUST    PARM SDCUST    DSLDY                                               CSW024
      *                                                                                       CSW024
     C           @RTCD     IFNE *BLANKS                                                       CSW024
     C           *LOCK     IN   LDA                                                           CSW024
     C                     MOVEL'AOCUSTR0'DBFILE                                              CSW024
     C                     MOVE '037'     DBASE              * * * * * * *                    CSW024
     C                     MOVELMGCNUM    DBKEY              * DBERR 37  *                    CSW024
     C                     OUT  LDA                          * * * * * * *                    CSW024
     C                     EXSR *PSSR                                                         CSW024
     C                     ELSE                                                               CSW024
     C                     MOVE BBCNA1    DSCNA1 35                                           CSW024
     C                     MOVE BBCNA2    DSCNA2 35                                           CSW024
     C                     MOVE BBCNA3    DSCNA3 35                                           CSW024
     C                     MOVE BBCNA4    DSCNA4 35                                           CSW024
     C                     MOVE BBCORP    DSCORP  1                                           CSW024
     C                     MOVE BBCBEI    DSCBEI 11                                           CSW024
     C                     MOVE BBRI01    DSRI01 40                                           CSW024
     C                     MOVE BBRI02    DSRI02 40                                           CSW024
     C                     MOVE BBRI03    DSRI03 40                                           CSW024
     C                     MOVE BBRI04    DSRI04 40                                           CSW024
     C                     MOVE BBRI05    DSRI05 40                                           CSW024
     C                     MOVE BBFUND    DSFUND 34                                           CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW024
     C                     ENDSR
     C/EJECT
      *****************************************************************
      ****ROUT*-*determine*message*routing*****************************   CSW096
      ****Called*by*-*main*process*************************************   CSW096
      ****Calls*-*NWAD*determine*default*network*addresses.************   CSW096
      ************PRAD*determine*priority*network*addresses.***********   CSW096
      ************FILL*fill*up*GNR*array.******************************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********ROUT      BEGSR                                          CSW096
      ***********                                                         CSW096
      ***Access*branch*details*with*Branch*code*of*sender.****************CSW096
      ***********                                                         CSW096
     C***********          CALL 'AOBRCHR0'                                CSW096
     C***********          PARM '*MSG   ' @RTCD                           CSW096
     C***********          PARM '*KEY   ' @OPTN                           CSW096
     C***********          PARM MGBRCA    @BRCD   3                       CSW096
     C***********SDBRCH    PARM SDBRCH    DSSDY                           CSW096
      ***********                                                         CSW096
      ***Branch*record*not*found*-*Error.*********************************CSW096
      ***********                                                         CSW096
     C***********@RTCD     IFNE *BLANKS                                   CSW096
     C************LOCK     IN   LDA                                       CSW096
     C***********          MOVE '007'     DBASE              * * * * * * *CSW096
     C***********          MOVELMGBRCA    DBKEY              * DBERR 007 *CSW096
     C***********          MOVEL'SDBRCHPD'DBFILE             * * * * * * *CSW096
     C***********          OUT  LDA                                       CSW096
     C***********          EXSR *PSSR                                     CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      *****save*branch*internal*customer*number*&*SWIFT*TID*address*******CSW096
      ***********                                                         CSW096
     C***********          MOVELA8BICN    SECN                            CSW096
     C***********          MOVE A8BTID    SCSID                           CSW096
      ***********                                                         CSW096
      ****Access*SDCUSTPD*using*branch*internal*customer*number***********CSW096
      ***********                                                         CSW096
     C***********          MOVE *BLANKS   @KEY1                           CSW096
     C***********          MOVELSECN      @KEY1                           CSW096
      ***********                                                         CSW096
     C***********          CALL 'AOCUSTR0'                                CSW096
     C***********          PARM '*MSG   ' @RTCD                           CSW096
     C***********          PARM '*KEY   ' @OPTN                           CSW096
     C***********          PARM           @KEY1  10                       CSW096
     C***********          PARM *BLANKS   @KYST   7                       CSW096
     C***********SDCUST    PARM SDCUST    DSSDY                           CSW096
      ***********                                                         CSW096
      ***Customer*record*not*found*-*Error********************************CSW096
      ***********                                                         CSW096
     C***********@RTCD     IFNE *BLANKS                                   CSW096
     C************LOCK     IN   LDA                                       CSW096
     C***********          MOVE '008'     DBASE              * * * * * * *CSW096
     C***********          MOVEL@KEY1     DBKEY              * DBERR 008 *CSW096
     C***********          MOVEL'SDCUSTPD'DBFILE             * * * * * * *CSW096
     C***********          OUT  LDA                                       CSW096
     C***********          EXSR *PSSR                                     CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Save*sender's*addresses*&*parent*customer*number****************CSW096
      ***********                                                         CSW096
     C***********          MOVE BBTXA1    STELX                           CSW096
     C***********          MOVE BBSTAD    SSTTX                           CSW096
     C***********          MOVE BBCRNM    SCRNM                           CSW096
     C***********          MOVE BBPCNB    SPCNB                           CSW096
     C***********          MOVE BBPAIN    SPAIN                           CSW096
      ***********                                                         CSW096
      ****Access*SDCUSTPD*using*destination*customer*number***************CSW096
      ***********                                                         CSW096
     C***********          MOVE *BLANKS   @KEY1                           CSW096
     C***********          MOVELMGCNUM    @KEY1                           CSW096
      ***********                                                         CSW096
     C***********          CALL 'AOCUSTR0'                                CSW096
     C***********          PARM '*MSG   ' @RTCD                           CSW096
     C***********          PARM '*KEY   ' @OPTN                           CSW096
     C***********          PARM           @KEY1  10                       CSW096
     C***********          PARM *BLANKS   @KYST   7                       CSW096
     C***********SDCUST    PARM SDCUST    DSSDY                           CSW096
      ***********                                                         CSW096
     C***********          MOVE *BLANKS   DSERR                           CSW096
     C***********          MOVE MGCNUM    DECN                            CSW096
      ***********                                                         CSW096
      ***If*the*destination*customer*is*not*found*on*sdcustpd.************CSW096
      ***********                                                         CSW096
     C***********@RTCD     IFNE *BLANKS                                   CSW096
     C***********          MOVE 'Y'       @ERR    1                       CSW096
     C***********          MOVELMSGA,2    DSERR  50                       CSW096
      ***********                                                         CSW096
      ***Record*found*on*sdcustpd.****************************************CSW096
      ***********                                                         CSW096
     C***********          ELSE                                           CSW096
     C***********          MOVE BBCSID    CSID                            CSW096
      ***********                                                         CSW096
      ***If*the*default*network*for*the*destination*customer*is***********CSW096
      ***not*blank*execute*subroutine*NWAD*(Default*Network*Address.)*****CSW096
      ***If*the*default*is*blank*execute*subroutine*PRAD*(Priority********CSW096
      ***Network*Address).************************************************CSW096
      ***********                                                         CSW096
     C***********BBDNW3    IFNE *BLANKS                                   CSW096
     C***********          EXSR NWAD                                      CSW096
     C***********          ELSE                                           CSW096
     C***********          EXSR PRAD                                      CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Fill*up*the*message*status*released*info.*from*PF/SDCUSTPD******CSW096
      ****if*the*message*status*is*blank.*********************************CSW096
      ***********                                                         CSW096
     C***********MGST      IFEQ *BLANKS                                   CSW096
     C***********          EXSR FILL                                      CSW096
      ***********                                                         CSW096
      ***The*following*message*types*can*be*entered*on*sdcustpd*as*to*****CSW096
      ***be*generated*as*released.****************************************CSW096
      ***(NB.**3** -*any*of*the*300*series*messages.**********************CSW096
      *********35* -*any*of*the*350*series*messages.)*********************CSW096
      ***********                                                         CSW096
     C***********'350'     LOKUPGNR                      20               CSW096
     C***********'35*'     LOKUPGNR                      21               CSW096
     C***********'3**'     LOKUPGNR                      22               CSW096
      ***********                                                         CSW096
     C************IN20     IFEQ '1'                                       CSW096
     C************IN21     OREQ '1'                                       CSW096
     C************IN22     OREQ '1'                                       CSW096
     C***********          MOVE 'RSND'    MGST                            CSW096
     C***********          ELSE                                           CSW096
     C***********          MOVE 'CRTD'    MGST                            CSW096
     C***********          END                                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          ENDSR                                          CSW096
     C/EJECT                                                              CSW096
      *****************************************************************   CSW096
      *   SRROUT - determine message routing                          *   CSW096
      *   Called by - main process                                    *   CSW096
      *   Calls -                                                     *   CSW096
      *****************************************************************   CSW096
      *                                                                   CSW096
     C           SRROUT    BEGSR                                          CSW096
      *                                                                   CSW096
     C                     MOVE MGBRCA    I@SNBR                          CSW096
     C                     MOVE *BLANKS   I@DSCN                          CSW096
     C                     MOVE MGCNUM    I@DSCN                          CSW096
     C                     MOVE '350'     I@MTPY                          CSW096
     C                     MOVE 'N'       I@CONC                          CSW096
     C                     Z-ADD0         I@SETT                          CSW096
     C                     MOVE *BLANK    I@FTCS                          CSW096
     C                     MOVE MGMODI    I@MMOD                          CSW096
      *                                                                   CSW096
      *###################################################################CSW096
      *                                                                  #CSW096
      * Below are two copy sources intended for setting up the custom    #CSW096
      * parameter (P@ZZ) in the call to MG9900.                          #CSW096
      * One (MG9900CALL) is in ALL MG generation programs and is for use #CSW096
      * when a change is required to all of them.                        #CSW096
      * The other is only in this program.                               #CSW096
     C/COPY WNCPYSRC,MG9900CALL                                          #CSW096
     C/COPY WNCPYSRC,FT0640ROUT                                          #CSW096
      *                                                                  #CSW096
      *###################################################################CSW096
      *                                                                   CSW096
     C*********************CALL 'MG9900'                                               CSW096 CSW036
     C                     CALL 'MG9901'                                                      CSW036
     C                     PARM *BLANKS   @RTCD                           CSW096
     C                     PARM           P@IN                            CSW096
     C                     PARM *BLANKS   P@OUT                           CSW096
     C                     PARM           P@ZZ  256                       CSW096
      *                                                                   CSW096
     C           @RTCD     IFNE *BLANKS                                   CSW096
     C           *LOCK     IN   LDA                                       CSW096
     C                     MOVE '092'     DBASE              * * * * * * *CSW096
     C                     MOVEL'*CALL  ' DBKEY              * DBERR 092 *CSW096
     C*********************MOVEL'MG9900'  DBFILE             * * * * * * *             CSW096 CSW036
     C                     MOVEL'MG9901'  DBFILE             * * * * * * *                    CSW036
     C                     OUT  LDA                                       CSW096
     C                     EXSR *PSSR                                     CSW096
     C                     ELSE                                           CSW096
     C                     MOVE O@NWRK    NWRK                            CSW096
     C**********           Z-ADDO@CNSN    SECN                                         CSW096 CSD027
     C                     MOVE O@CNSN    SECN                                                CSD027
     C                     MOVE O@NWSN    NWSN                            CSW096
     C**********           Z-ADDMGCNUM    DECN                                         CSW096 CSD027
     C                     MOVE MGCNUM    DECN                                                CSD027
     C                     MOVE O@NWDS    NWDS                            CSW096
     C                     MOVE O@MGSG    MGSG                            CSW096
     C                     MOVE O@MGST    MGST                            CSW096
     C                     MOVE O@PCNB    SPCNB                           CSW096
     C                     MOVE O@PAIN    SPAIN                           CSW096
     C                     END                                            CSW096
      *                                                                   CSW096
     C                     ENDSR                                          CSW096
     C/EJECT                                                              CSW096
      *****************************************************************
      *   FMTA - Format Message Detail.                               *
      *   Called by - main process                                    *
      *   Calls     - PAY    format fields 53,56 and 57.              *
      *             - RCV   format fields 53,56 and 57.               *
      *****************************************************************
      *
     C           FMTA      BEGSR
      *
      ** Field :20: -  Transaction Reference Number.
      *
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
     C                     MOVEA*BLANKS   @WRK
      *
      ** Build up the trn with the module id, the transaction number
      ** and the last swift sequence add 1.
      *
     C                     Z-ADD1         Z       20
     C                     MOVEAMGMODI    @WRK
     C                     MOVEAMGTNUM    @WRK,3
     C           MGLSWS    ADD  1         HLSWS   30
     C                     MOVE HLSWS     HSWS    3
      *
     C           ' '       LOKUP@WRK,Z                   31
     C                     MOVEAHSWS      @WRK,Z
      *
      **  Check on MGREFPD for a uniqne TRN,else output as an error.
      **  and store the TRN of the new confirmation message.
      *
     C                     MOVEA@WRK      @TRNA  16
      *
     C           @TRNA     CHAINMGREFL0              11
      *
      ** If no record is found flag field as in error.
      *
     C           *IN11     IFEQ '0'
     C                     MOVE 'Y'       @ERR
     C                     MOVEAMSGA,4    MERR
     C                     END
      *
     C                     MOVEL':20:'    MTAG
     C                     MOVEA@WRK      MFLD
      *
      ** Field :21: - Related Reference.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
      **  Build up the trn with the module id, the transaction number
      **  and the last swift confirmation number.
      *
     C                     MOVEA*BLANKS   @WRK
     C                     MOVEAMGMODI    @WRK
     C                     MOVEAMGTNUM    @WRK,3
     C                     MOVE MGLSWC    MLSWC   3
      *
     C           ' '       LOKUP@WRK,Z                   31
     C                     MOVEAMLSWC     @WRK,Z
      *
     C                     MOVEA@WRK      MFLD
      *
      **  Obtain transaction reference of previous MT350                                      190127
     C                     MOVELMGTNUM    HSTRAN                                              190127
     C                     MOVE '350'     HSMTPY                                              190127
      *                                                                                       190127
     C                     MOVE HSTRAN    @HTRN   6                                           190127
      *                                                                                       190127
     C           HSKEY     SETGTMGHISTL0                                                      190127
     C                     READPMGHISTL0                 56                                   190127
      *                                                                                       190127
     C           *IN56     IFEQ '0'                                                           190127
     C           HSMODI    ANDEQMGMODI                                                        190127
     C           HSTRAN    ANDEQ@HTRN                                                         190127
     C           HSMTPY    ANDEQ'350'                                                         190127
     C                     MOVEL@HREF     MFLD                                                190127
     C                     END                                                                190127
      *                                                                                       190127
     C                     MOVEL':21:'    MTAG
     C                     MOVEA@WRK      @TRNB  16
      *
      ** Field :22: - Code/Common Reference.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZCREF
      *
      **  If SWIFT network, use sender & destination customer
      *
     C           NWRK      IFEQ 'SWIFT'
     C           NWRK      OREQ 'STTX'
      *
     C           NWRK      IFEQ 'SWIFT'
     C                     MOVELNWSN      ZSSWI
     C                     MOVELNWDS      ZDSWI
     C                     ELSE
     C                     MOVELSCSID     ZSSWI
     C                     MOVELCSID      ZDSWI
     C                     END
      *
     C                     MOVE MGINTR    ZRATE
      *
      **  Format SWIFT common reference
      *
     C                     CALL 'ZM0020'               15
     C                     PARM           ZSSWI  12
     C                     PARM           ZDSWI  12
     C                     PARM           ZRATE  138
     C                     PARM           ZCREF  16
      *
      ** If the program ends in error.(Program not found.)
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '009'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 009 *
     C                     MOVEL'ZM0020'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     END
      *
     C           O@SWSN    IFNE *BLANKS                                   CSW096
     C           O@SWDS    ANDNE*BLANKS                                   CSW096
      *                                                                   CSW096
     C                     MOVE MGINTR    ZRATE                           CSW096
     C                     MOVELO@SWSN    ZSSWI                           CSW096
     C                     MOVELO@SWDS    ZDSWI                           CSW096
      *                                                                   CSW096
      **  Format SWIFT common reference                                   CSW096
      *                                                                   CSW096
     C                     CALL 'ZM0020'               15                 CSW096
     C                     PARM           ZSSWI  12                       CSW096
     C                     PARM           ZDSWI  12                       CSW096
     C                     PARM           ZRATE  138                      CSW096
     C                     PARM           ZCREF  16                       CSW096
      *                                                                   CSW096
     C           *IN15     IFEQ '1'                                       CSW096
     C           *LOCK     IN   LDA                                       CSW096
     C                     MOVE '005'     DBASE                           CSW096
     C                     MOVEL'       ' DBKEY                           CSW096
     C                     MOVEL'ZM0020'  DBFILE                          CSW096
     C                     OUT  LDA                                       CSW096
     C                     EXSR *PSSR                                     CSW096
     C                     ENDIF                                          CSW096
      *                                                                   CSW096
     C                     ENDIF                                          CSW096
      *                                                                   CSW096
     C           ZCREF     IFEQ *BLANKS
     C                     MOVEL@TRNA     ZCREF
     C                     END
      *
     C                     MOVEL':22:'    MTAG
      *
      ** Construct Field 22  'codeword/common reference'
      *
     C                     MOVEL'ADVICE'  CWRD    6
     C                     MOVEA*BLANKS   @WRK
      *
     C                     MOVEACWRD      @WRK
      *
     C                     MOVEA'/'       @WRK,7
     C                     MOVEAZCREF     @WRK,8
     C                     MOVEA@WRK      MFLD
      *
      **  Field :25:  Account Identification.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVELMGTNUM    MFLD
     C                     MOVEL':25:'    MTAG
      *
      **  Field :67:  Interest Period.
      *
      ** This field is made up of the last interest date and the
      ** next interest date.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVEA*BLANKS   @WRK
     C                     Z-ADD1         Z
      *
      ** Last Interest Date.
      *
     C                     MOVE MGSLID    ZMDAY
      *
      **  Convert Midas date to SWIFT date format.
      *
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
     C/COPY WNCPYSRC,MG0350C004
     C                     MOVEAZSDATE    @WRK
      *
      ** Next Interest Date.
      *
     C                     MOVE MGNIDT    ZMDAY
      *
      **  Convert Midas date to SWIFT date format
      *
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
     C           ' '       LOKUP@WRK,Z                   31
     C                     MOVEA'/'       @WRK,Z
     C                     ADD  1         Z
     C                     MOVEAZSDATE    @WRK,Z
      *
      ** If the program ended in error.(Program not found.)
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '010'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 010 *
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     MOVEA@WRK      MFLD
     C                     MOVEL':67A:'   MTAG
      *
      **  Field :32:  Currency Code , Principal Amount.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
      **  Format currency code and contract amount.
      *
     C                     MOVE MGCCY     ZCCY
     C                     MOVE MGPCPL    ZAMNT
     C                     CALL 'ZM0040'
     C                     PARM           ZAMNT  130
     C                     PARM           ZCCY    3
     C                     PARM           ZSAMNT 15
     C                     PARM           ZSCCY   3
     C                     PARM           ZERR    1
     C                     PARM           ZSWDPC  1                                           222373
      *
      ** Error - indicate erroneous fields;
      *
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVELERR3N     MFLD
     C                     MOVELMSGA,3    MERR
      *
      ** Format field 32 using the currency and amount.
      *
     C                     ELSE
      *
     C                     MOVEA*BLANKS   @WRK
     C                     MOVEAZSCCY     @WRK
     C                     MOVEAZSAMNT    @WRK,4
     C                     MOVEA@WRK      MFLD
      *
     C                     END
      *
     C                     MOVE ':32B:'   MTAG
      *
      ** Field 34 - Value Date, Currency, Principal Amount.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     Z-ADDMGNIDT    ZMDAY
      *
     C                     CALL 'ZM0060'
     C                     PARM           ZMDAY   50
     C                     PARM           ZSDATE  6
      *
      **  Format currency and total interest.
      **  If interest amount on MGF350PD is not 0 use it as it was        068795
      **  correctly calculated in DL0195 for the confirmations else       068795
      **  calculate the interest taking into account and deal amends      068795
      **  during the life of the deal.                                    068795
      *
     C           MGINTA    IFNE 0                                         068795
     C                     Z-ADDMGINTA    ZAMNT                           068795
     C                     ELSE                                           068795
     C**********           Z-ADDMGSLID    ZIBEG                     S01237067680
     C                     Z-ADDMGIACD    ZIBEG                           067680
     C                     Z-ADDMGNIDT    ZIEND                           S01237
     C                     MOVE MGICBS    ZICALC                          S01237
     C                     Z-ADDMGINTR    ZIRATE                          S01237
     C                     Z-ADDMGPCPL    ZIAMT                           S01237
     C/COPY WNCPYSRC,MG0350C001
     C                     EXSR GLINTC                                    S01237
     C/COPY WNCPYSRC,MG0350C005
     C**********           Z-ADDZINTR     ZAMNT                           E29588
     C                     Z-ADDZINTR     ZAMNT     H                     E29588
     C           ZINTR     IFLT 0
     C**********           Z-SUBZINTR     ZAMNT                           E29588
     C                     Z-SUBZINTR     ZAMNT     H                     E29588
     C                     END
     C/COPY WNCPYSRC,MG0350C017
      *
      ** ZAMNT at this point = the interest from the interest accrual     067680
      ** date to the next interest date. The total interest for this      067680
      ** month = ZAMNT + AITC + AIAN + AIAP - IPRD - ICTD. These fields   067680
      ** have now been added to MG350PD and the following calculation     067680
      ** calculates the correct interest figure.                          067680
      *                                                                   067680
     C           ZAMNT     ADD  MGAITC    ZAMNT                           067680
     C           ZAMNT     ADD  MGAIAN    ZAMNT                           067680
     C           ZAMNT     ADD  MGAIAP    ZAMNT                           067680
     C           ZAMNT     SUB  MGIPRD    ZAMNT                           067680
     C           ZAMNT     SUB  MGICTD    ZAMNT                           067680
     C                     ENDIF                                          068795
     C/COPY WNCPYSRC,MGH00104
      *                                                                   067680
     C                     MOVE MGCCY     ZCCY
     C                     CALL 'ZM0040'
     C                     PARM           ZAMNT  130
     C                     PARM           ZCCY    3
     C                     PARM           ZSAMNT 15
     C                     PARM           ZSCCY   3
     C                     PARM           ZERR    1
     C                     PARM           ZSWDPC                                              222373
      *
      ** Error - indicate erroneous fields;
      *
     C           ZERR      IFEQ '1'
     C                     MOVE 'Y'       @ERR
     C                     MOVELERR3N     MFLD
     C                     MOVELMSGA,3    MERR
      *
     C                     ELSE
     C                     MOVELFLD3N     MFLD
      *
     C                     END
      *
     C                     MOVEL':34P:'   MTAG
      *
      ** Field 37 - Interest field.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVE MGINTR    ZINRT
     C                     MOVE MGNIDT    ZINPD
     C                     MOVE MGMDAT    ZMDAT
     C                     MOVE MGIPFR    ZINFC
     C                     MOVE MGICBS    ZCALC
      *
     C                     CALL 'ZM0070'               15
     C                     PARM           ZINRT  117
     C                     PARM           ZINPD   50
     C                     PARM           ZMDAT   50
     C                     PARM           ZINFC   1
     C                     PARM           ZCALC   10
     C                     PARM           ZSTAG   1
     C                     PARM           @VAR   35
     C                     PARM           ZSF72  35
      *
      ** If the program ended in error. (Program not found.)
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '011'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 011 *
     C                     MOVEL'ZM0070'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C/COPY WNCPYSRC,MG0350C006
     C                     MOVE '37'      FLDNO
     C                     MOVE ZSTAG     TAG
     C                     MOVEL@MTAG     MTAG
     C                     MOVEL@VAR      MFLD
      *
      ** Fields 53,56 and 57 are dependant on the deal type.
      ***If*the*loans/deposits*indicator*(MGLORD)*is*L*execute*********   088043
      ***subroutine*PAY*else*execute*subroutine*RCV.*******************   088043
      ** If the loans/deposits indicator (MGLORD) is L execute            088043
      ** subroutine RCV else execute subroutine PAY.                      088043
      *
     C***********MGLORD    IFEQ 'L'                                       088043
     C           MGLORD    IFEQ 'D'                                       088043
     C                     EXSR PAY
     C                     ELSE
     C                     EXSR RCV
     C                     END
      *
      ** Format field 72.
     C/COPY WNCPYSRC,MG0350C019
      *
      ** If there is field 72 info. from field 37 output field 72.
      *
     C           ZSF72     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVE ':72: '   MTAG
     C                     MOVELZSF72     MFLD
      *
     C                     END
      *
     C/COPY WNCPYSRC,MG0350C007
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   RCV  -  Format fields 53, 56 and 57 for a Taking            *
      *   Called by - FMTA - Format message detail.                   *
      *   Calls     - FSWAD Format swift address.                     *
      *****************************************************************
      *
     C           RCV       BEGSR
      *                                                                                       CSW201
     C           CSW201    IFEQ 'Y'                                                           CSW201
     C                     MOVE 'Y'       ZDBEI                                               CSW201
     C                     ENDIF                                                              CSW201
      *
     C                     MOVE *BLANKS   @WRK
     C*
      ** Field 53 - Senders correspondant.
      *
      ** If the module is lending attempt to process field 53.
      *
     C           MGMODI    IFEQ 'LE'
      *
      ** If the receive intermediary is not blank use this to format
      ** field 53. If this field is blank no field 53 is produced.
      *
     C           MGRIBN    IFNE *BLANKS
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGRIBN    ZDEST
     C                     MOVELMGRIBA    ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '53'      FLDNO
      *
      ** Execute subroutine FSWAD to format the swift address.
      *
     C                     EXSR FSWAD
     C                     END
     C                     END
      *
      ** Format fields 56 and 57.
      *
      ** Branch code of sender not equal to Receive settlement branch.
      *
      **  Test if settlement via nostro
      *
     C                     MOVE MGRSTM    @STM
     C           @STM      LOKUPTABNST                   23
     C           MGBRCA    IFNE MGROBR
     C           *IN23     ANDEQ'1'
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *
      ** Access the nostros file using our receive nostro.
      *
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6        I:Customer No
     C***********          PARM MGCCY     @CYCD   3        I:Currency     137909
     C                     PARM           @CYCD   3        I:Currency     137909
     C**********           PARM *BLANKS   @ACCD   4        I:A/c Code                         CGL029
     C                     PARM *BLANKS   @ACCD  10                                           CGL029
     C                     PARM *BLANKS   @ACSN   2        I:A/c Seq
     C                     PARM MGRONS    @NONB   2        I:Nostro No
     C                     PARM *BLANKS   @BRCD   3        I:Branch Code
     C                     PARM *BLANKS   @CSSN  10        I:Cust ShortN
     C                     PARM *BLANK    @PNOI   1        I:Prime Nost In
     C           SDNOST    PARM SDNOST    DSFDY
      *
      ** If our receive nostro is not found on sdnostpd.
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     MOVELMGRONS    HLD2    2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5    5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,6    MERR
     C                     MOVE ':56 :'   MTAG
     C                     ELSE
      *
      ** Format our receive nostro address.(Field 56).
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVEL*BLANKS   ACLINE 35                       056739
     C                     MOVE ' '       TAG
     C                     MOVE '56'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
      ** Format field 57.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
      **  Format Branch Internal Customer Number of Senders Brch Ad.
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELSECN      ZDEST
     C                     MOVEL*BLANKS   ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
      *
      ** Execute subroutine FSWAD to format the swift address.
      *
     C                     EXSR FSWAD
      *
     C                     ELSE
      *
      ** Else the branch code of sender = receive settlement branch
      ** and the settlement is via a nostro.
      *
     C           @STM      LOKUPTABNST                   23
      *
     C           *IN23     IFEQ '1'
     C                     ADD  1         X
     C           X         OCUR MULT
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *
      ** Access the nostros file with our receive nostro.
      *
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6        I:Customer No
     C***********          PARM MGCCY     @CYCD   3        I:Currency     137909
     C                     PARM           @CYCD   3        I:Currency     137909
     C**********           PARM *BLANKS   @ACCD   4        I:A/c Code                         CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2        I:A/c Seq
     C                     PARM MGRONS    @NONB   2        I:Nostro No
     C                     PARM *BLANKS   @BRCD   3        I:Branch Code
     C                     PARM *BLANKS   @CSSN  10        I:Cust ShortN
     C                     PARM *BLANK    @PNOI   1        I:Prime Nost In
     C           SDNOST    PARM SDNOST    DSFDY
      *
      ** If no record is found on the file.
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     MOVELMGRONS    HLD2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,6    MERR
     C                     MOVE ':57 :'   MTAG
     C                     ELSE
      *
      ** Format field 57 using subroutine FSWAD.
      *
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVEL*BLANKS   ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
     C                     ELSE
      *
      ** Settlement method internal.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C           MGRSTM    IFNE 00
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELSECN      ZDEST
     C                     MOVEL*BLANKS   ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
      *
      ** If settlement type is not found.
      *
     C                     ELSE
     C                     MOVE ':57D:'   MTAG
     C                     MOVEL'UNKNOWN' MFLD
     C                     END
     C                     END
      *
     C                     END
      *                                                                                       CSW201
     C                     MOVE *BLANKS   ZDBEI                                               CSW201
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   PAY  - Format fields 53, 56 and 57 for a Placing.           *
      *   Called by - FMTA - Format message detail.                   *
      *   Calls     - FSWAD Format swift address.                     *
      *****************************************************************
      *
     C           PAY       BEGSR
      *
     C                     MOVE *BLANKS   @WRK
      *
      ** Field 53 - Senders correspondant.
      **  Test if settlement via nostro
      *
     C                     MOVE MGPSTM    @STM    2
     C           @STM      LOKUPTABNST                   23
      *
      ** If our pay nostro is not blank and the settlement is via a nostro
      *
     C           MGPONS    IFNE *BLANKS
     C           *IN23     ANDEQ'1'
      *
      **  either A/C with Bank or Receipient entered
      **  or DIRECT entered                                               088043
      *
     C           MGAWBN    IFNE *BLANKS
     C           MGRVNO    ORNE *BLANKS
     C           AWBA6     OREQ 'DIRECT'                                  088043
      *
      *
     C                     MOVELMGPONS    @NONB
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *
      ** Access the nostros file using our pay nostro.
      *
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6
     C***********          PARM MGCCY     @CYCD   3                       137909
     C                     PARM           @CYCD   3                       137909
     C**********           PARM *BLANKS   @ACCD   4                                           CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2
     C                     PARM           @NONB   2
     C                     PARM *BLANKS   @BRCD   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **  Nostro customer not found
      *
     C           @RTCD     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELMGPONS    HLD2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,6    MERR
     C                     ELSE
      *
      ** Branch Internal Customer cf. Customer number of Our Pay Nostro
      *
     C                     MOVELSECN      @SECN   6
     C           @SECN     IFNE A7CUST
     C           MGAWBN    ANDNEA7CUST
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C*********************CALL 'ZM0050'                                                      CSW036
     C                     CALL 'ZM0051'                                                      CSW036
     C                     PARM           ZDEST  12
     C                     PARM           ZSADD1 35
     C                     PARM           ZSADD2 35
     C                     PARM           ZSADD3 35
     C                     PARM           ZSADD4 35
     C                     PARM           ZSTAG   1
     C                     PARM           ZSTYPE  1
     C                     PARM           ZERR    1
     C                     PARM           ZDBEI                                               CSW201
      *
      **  Error when formating address
      *
     C           ZERR      IFEQ '1'
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELZDEST     MFLD
     C                     MOVELMSGA,5    MERR
     C                     ELSE
      *
      **  A Type address
      *
     C           ZSTAG     IFEQ 'A'
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'A'       TAG
     C                     MOVE '53'      FLDNO
     C                     MOVE @MTAG     MTAG
     C                     MOVELZSADD1    MFLD
     C                     EXSR SEXTN                                     183583
      *
     C                     ELSE
      *
      **  Access SDCUSTPD using our pay nostro customer number
      *
     C                     MOVE *BLANKS   @KEY1
     C                     MOVELA7CUST    @KEY1
     C                     CALL 'AOCUSTR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @KEY1  10
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      ** Customer record not found - Error
      *
     C           @RTCD     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELA7CUST    MFLD
     C                     MOVE MSGA,2    MERR
      *
     C                     ELSE
      *
      **  B Type address
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C**********           MOVE BBPCNB    @PCNB   60                                          CSD027
     C                     MOVE BBPCNB    @PCNB   6                                           CSD027
     C           SPAIN     IFEQ 'P'
     C           @PCNB     ANDEQSECN
     C           BBPAIN    OREQ 'P'
     C           A7CUST    ANDEQSPCNB
     C           BBPCNB    OREQ SPCNB
     C           BBPCNB    ANDNE*BLANKS
      *
     C                     MOVE ':53B:'   MTAG
     C                     MOVE *BLANKS   @WRK
     C                     MOVELBBCRNM    @WRK,1
     C                     Z-ADD22        J       20
     C                     MOVEABBCRTN    @WRK,J
     C                     MOVEA@WRK      MFLD
      *
      **  D Type address
      *
     C                     ELSE
     C                     MOVE ':53D:'   MTAG
     C                     MOVELZSADD1    MFLD
      **  Address 2
     C           ZSADD2    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD2    MFLD
      **  Address 3
     C           ZSADD3    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD3    MFLD
      **  Address 4
     C           ZSADD4    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELZSADD4    MFLD
     C                     END                             D address 4
     C                     END                             D address 3
     C                     END                             D address 2
     C                     END                             B/D address 1
      *
     C                     END                             Cust. error?
      *
     C                     END                             A/B/D address?
     C                     END                             Fmt ad. error.
     C                     END                             Brch Int Cust.
     C                     END                             Nostro not fnd.
     C                     END
     C                     END                             Pay nostro?
      *
      **  Field :57:  A/C with institution non-blank
      *
     C           MGAWBN    IFNE *BLANKS
      *
      **  Field :56:  Pay Intermediary bank
      **  This field is only produced when the account with institution
      **  is non-blank.
      *
     C           MGPIBN    IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGPIBN    ZDEST
     C                     MOVELMGPIBA    ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '56'      FLDNO
      *
      ** Format field 56 via subroutine FSWAD.
      *
     C                     EXSR FSWAD
     C                     END
      *
      **  Format Account with institution. (Field 57.)
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELMGAWBN    ZDEST
     C                     MOVELMGAWBA    ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     MOVE 'Y'       FLD57O  1
      *
      **    A/C with Inst. blank
      *
     C                     ELSE
      *                                                                   088043
     C           AWBA6     IFEQ 'DIRECT'                                  088043
      *                                                                   088043
      **  A/C with Inst. set up as DIRECT, use beneficiary details        088043
      **  Format Account with institution. (Field 57.)                    088043
      *                                                                   088043
     C                     ADD  1         X                               088043
     C           X         OCUR MULT                                      088043
     C                     MOVE *BLANKS   ZDEST                           088043
     C                     MOVELMGBENN    ZDEST                           088043
     C                     MOVELMGBENA    ACLINE                          088043
     C                     MOVE ' '       TAG                             088043
     C                     MOVE '57'      FLDNO                           088043
     C/COPY WNCPYSRC,MG0350C002
     C                     EXSR FSWAD                                     088043
     C                     MOVE 'Y'       FLD57O  1                       088043
      *                                                                   088043
      **  A/C with Inst. blank and NOT "DIRECT" entered,                  088043
      *                                                                   088043
     C                     ELSE                                           088043
      *
      **  Field 57 = pay nostro customer if settlement via '02' or '12'
     C           MGPSTM    IFEQ 02
     C           MGPSTM    OREQ 12
     C                     MOVELMGPONS    @NONB
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @CYCD                           137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @CYCD                           137909
     C                     ENDIF                                          137909
      *                                                                   137909
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @CUST   6
     C***********          PARM MGCCY     @CYCD   3                       137909
     C                     PARM           @CYCD   3                       137909
     C**********           PARM *BLANKS   @ACCD   4                                           CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2
     C                     PARM           @NONB   2
     C                     PARM *BLANKS   @BRCD   3
     C                     PARM *BLANKS   @CSSN  10
     C                     PARM *BLANKS   @PNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      **  Nostro customer not found
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'Y'       @ERR
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVELMGPONS    HLD2    2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5    5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,6    MERR
     C                     MOVE ':57 :'   MTAG
     C                     ELSE
      *
      **  Format our Pay Nostro Customer Address
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVEL*BLANKS   ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *
     C                     ELSE
     C                     MOVE MGPSTM    @STM
     C           @STM      LOKUPTABINT                   23
      *
     C           *IN23     IFEQ '1'
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELSECN      ZDEST
     C                     MOVEL*BLANKS   ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '57'      FLDNO
     C                     EXSR FSWAD
      *
     C                     ELSE
      *
      **  Field 53 is equal to Our Pay Nostro
      **  (only if settlement type is NOSTRO, ie. not if s/typ is '00')   E38183
     C           MGPSTM    IFNE *ZEROS                                    E38183
     C                     MOVEL*BLANKS   WRKTAG  3                     MD038672
     C                     MOVELMTAG      WRKTAG                        MD038672
     C           WRKTAG    IFNE ':53'                                   MD038672
      *                                                                   E38183
     C                     MOVELMGPONS    @NSKYE
      *                                                                   137909
      ** Use settlement currency to access nostro if not blank.           137909
      ** Otherwise use deal currency.                                     137909
     C           CEU003    IFEQ 'Y'                                       137909
     C           MGSTCY    ANDNE*BLANKS                                   137909
     C                     MOVE MGSTCY    @NSKYB                          137909
     C                     ELSE                                           137909
     C                     MOVE MGCCY     @NSKYB                          137909
     C                     ENDIF                                          137909
      *                                                                   137909
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM *BLANKS   @NSKYA  6
     C***********          PARM MGCCY     @NSKYB  3                       137909
     C                     PARM           @NSKYB  3                       137909
     C**********           PARM *BLANKS   @NSKYC  4                                           CGL029
     C                     PARM *BLANKS   @NSKYC 10                                           CGL029
     C                     PARM *BLANKS   @NSKYD  2
     C                     PARM           @NSKYE  2
     C                     PARM *BLANKS   @KEYF   3
     C                     PARM *BLANKS   @KEYG  10
     C                     PARM *BLANKS   @KEYH   1
     C           SDNOST    PARM SDNOST    DSFDY
     C*
     C**  Nostro customer not found
     C           @RTCD     IFNE *BLANKS
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE 'Y'       @ERR
     C                     MOVE ':53 :'   MTAG
     C                     MOVELMGPONS    HLD2
     C                     MOVELMGCCY     HLD5
     C                     MOVE HLD2      HLD5
     C                     MOVELHLD5      MFLD
     C                     MOVELMSGA,6    MERR
     C                     ELSE
      *
      **  Format our Pay Nostro Customer Address
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE *BLANKS   ZDEST
     C                     MOVELA7CUST    ZDEST
     C                     MOVEL*BLANKS   ACLINE                          056739
     C                     MOVE ' '       TAG
     C                     MOVE '53'      FLDNO
     C                     EXSR FSWAD
     C                     END
      *                                                                   E38183
     C                     ENDIF                                        MD038672
     C                     END                                            E38183
      *
      **  Settlement 01,07 or 08 with MGAWBN blank or settlement 00
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVE ':57D:'   MTAG
     C                     MOVEL'UNKNOWN' MFLD
     C                     END
     C                     END
     C                     END                                            088043
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************   CSW200
      *   FMA200  - Format Message Detail - Sequence A.               *   CSW200
      *            This subroutine is similar to FMTA with the        *   CSW200
      *            following changes:                                 *   CSW200
      *             - New field :15A: Beginning of sequence A         *   CSW200
      *             - :22A: now just contains the type of operation   *   CSW200
      *             - New field :22C: common reference                *   CSW200
      *             - New field :15B: Beginning of sequence B(party A)*   CSW200
      *             - New field :30G: Similar to the old 67A          *   CSW200
      *             - New field :30V: Date part of old 34P            *   CSW200
      *             - New field :34B: Amount part of old 34P          *   CSW200
      *             - New field :37J: Rate part of old 37             *   CSW200
      *             - :14D: contains Day Count Faction(opt. letter 37)*   CSW200
      *   Called by - main process                                    *   CSW200
      *   Calls     - PAY200 format fields 53,56 and 57.              *   CSW200
      *             - RCV   format fields 53,56 and 57.               *   CSW200
      *****************************************************************   CSW200
      *                                                                   CSW200
     C           FMA200    BEGSR                                          CSW200
      *                                                                   CSW200
      ** FIELD :15A: - New Sequence                                       CSW200
      *                                                                   CSW200
     C                     Z-ADD1         X       20                      CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVEL':15A:'   MTAG                            CSW200
     C                     MOVE *BLANKS   MFLD                            CSW200
      *                                                                   CSW200
      ** Field :20: -  Transaction Reference Number.                      CSW200
      *                                                                   CSW200
     C                     ADD  1         X       20                      CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVEA*BLANKS   @WRK                            CSW200
      *                                                                   CSW200
      ** Build up the trn with the module id, the transaction number      CSW200
      ** and the last swift sequence add 1.                               CSW200
      *                                                                   CSW200
     C                     Z-ADD1         Z       20                      CSW200
     C                     MOVEAMGMODI    @WRK                            CSW200
     C                     MOVEAMGTNUM    @WRK,3                          CSW200
     C           MGLSWS    ADD  1         HLSWS   30                      CSW200
     C                     MOVE HLSWS     HSWS    3                       CSW200
      *                                                                   CSW200
     C           ' '       LOKUP@WRK,Z                   31               CSW200
     C                     MOVEAHSWS      @WRK,Z                          CSW200
      *                                                                   CSW200
      **  Check on MGREFPD for a uniqne TRN,else output as an error.      CSW200
      **  and store the TRN of the new confirmation message.              CSW200
      *                                                                   CSW200
     C                     MOVEA@WRK      @TRNA  16                       CSW200
      *                                                                   CSW200
     C           @TRNA     CHAINMGREFL0              11                   CSW200
      *                                                                   CSW200
      ** If no record is found flag field as in error.                    CSW200
      *                                                                   CSW200
     C           *IN11     IFEQ '0'                                       CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVEAMSGA,4    MERR                            CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     MOVEL':20:'    MTAG                            CSW200
     C                     MOVEA@WRK      MFLD                            CSW200
      *                                                                   CSW200
      ** Field :21: - Related Reference.                                  CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
      **  Build up the trn with the module id, the transaction number     CSW200
      **  and the last swift confirmation number.                         CSW200
      *                                                                   CSW200
     C                     MOVEA*BLANKS   @WRK                            CSW200
     C                     MOVEAMGMODI    @WRK                            CSW200
     C                     MOVEAMGTNUM    @WRK,3                          CSW200
     C                     MOVE MGLSWC    MLSWC   3                       CSW200
      *                                                                   CSW200
     C           ' '       LOKUP@WRK,Z                   31               CSW200
     C                     MOVEAMLSWC     @WRK,Z                          CSW200
      *                                                                   CSW200
     C                     MOVEA@WRK      MFLD                            CSW200
      *                                                                   CSW200
      **  Obtain transaction reference of previous MT350                                      190127
     C                     MOVELMGTNUM    HSTRAN                                              190127
     C                     MOVE '350'     HSMTPY                                              190127
      *                                                                                       190127
     C                     MOVE HSTRAN    @HTRN   6                                           190127
      *                                                                                       190127
     C           HSKEY     SETGTMGHISTL0                                                      190127
     C                     READPMGHISTL0                 56                                   190127
      *                                                                                       190127
     C           *IN56     IFEQ '0'                                                           190127
     C           HSMODI    ANDEQMGMODI                                                        190127
     C           HSTRAN    ANDEQ@HTRN                                                         190127
     C           HSMTPY    ANDEQ'350'                                                         190127
     C                     MOVEL@HREF     MFLD                                                190127
     C                     END                                                                190127
      *                                                                                       190127
     C                     MOVEL':21:'    MTAG                            CSW200
     C                     MOVEA@WRK      @TRNB  16                       CSW200
      *                                                                   CSW200
     C/COPY WNCPYSRC,MG0350C018
      *                                                                   CSW200
      ** Field :22: - Code/Common Reference.                              CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZCREF                           CSW200
      *                                                                   CSW200
      **  If SWIFT network, use sender & destination customer             CSW200
      *                                                                   CSW200
     C           NWRK      IFEQ 'SWIFT'                                   CSW200
     C           NWRK      OREQ 'STTX'                                    CSW200
      *                                                                   CSW200
     C           NWRK      IFEQ 'SWIFT'                                   CSW200
     C                     MOVELNWSN      ZSSWI                           CSW200
     C                     MOVELNWDS      ZDSWI                           CSW200
     C                     ELSE                                           CSW200
     C                     MOVELSCSID     ZSSWI                           CSW200
     C                     MOVELCSID      ZDSWI                           CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     MOVE MGINTR    ZRATE                           CSW200
      *                                                                   CSW200
      **  Format SWIFT common reference                                   CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0020'               15                 CSW200
     C                     PARM           ZSSWI  12                       CSW200
     C                     PARM           ZDSWI  12                       CSW200
     C                     PARM           ZRATE  138                      CSW200
     C                     PARM           ZCREF  16                       CSW200
      *                                                                   CSW200
      ** If the program ends in error.(Program not found.)                CSW200
      *                                                                   CSW200
     C           *IN15     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '027'     DBASE              * * * * * * *CSW200
     C                     MOVEL'       ' DBKEY              * DBERR 027 *CSW200
     C                     MOVEL'ZM0020'  DBFILE             * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     END                                            CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C           O@SWSN    IFNE *BLANKS                                   CSW200
     C           O@SWDS    ANDNE*BLANKS                                   CSW200
      *                                                                   CSW200
     C                     MOVE MGINTR    ZRATE                           CSW200
     C                     MOVELO@SWSN    ZSSWI                           CSW200
     C                     MOVELO@SWDS    ZDSWI                           CSW200
      *                                                                   CSW200
      **  Format SWIFT common reference                                   CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0020'               15                 CSW200
     C                     PARM           ZSSWI  12                       CSW200
     C                     PARM           ZDSWI  12                       CSW200
     C                     PARM           ZRATE  138                      CSW200
     C                     PARM           ZCREF  16                       CSW200
      *                                                                   CSW200
     C           *IN15     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '005'     DBASE                           CSW200
     C                     MOVEL'       ' DBKEY                           CSW200
     C                     MOVEL'ZM0020'  DBFILE                          CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C           ZCREF     IFEQ *BLANKS                                   CSW200
     C                     MOVEL@TRNA     ZCREF                           CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
      ** Field :22A: - Type of operation                                  CSW200
     C                     MOVEL':22A:'   MTAG                            CSW200
      *                                                                   CSW200
     C                     SELEC                                          CSW200
      *                                                                   CSW200
     C           MGCHTP    WHEQ 'C'                                       CSW200
     C                     MOVEL'CANC'    MFLD                            CSW200
      *                                                                   CSW200
     C                     OTHER                                          CSW200
     C                     MOVEL'ADVC'    MFLD                            CSW200
      *                                                                   CSW200
     C                     ENDSL                                          CSW200
      *                                                                   CSW200
      **  If corporate customer output :94A:                                                  CSW024
     C           CSW024    IFEQ 'Y'                                                           CSW024
     C           DSCORP    ANDEQ'Y'                                                           CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVEL'AGNT'    MFLD                                                CSW024
     C                     MOVE ':94A:'   MTAG                                                CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW024
      **  Field :22C: Common referenc'                                    CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVELZCREF     MFLD                            CSW200
      *                                                                   CSW200
     C                     MOVEL':22C:'   MTAG                            CSW200
      *                                                                                       CSW024
      ** If corporate customer output :21N:                                                   CSW024
     C           CSW024    IFEQ 'Y'                                                           CSW024
     C           DSCORP    ANDEQ'Y'                                                           CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVEL@TRNA     WK8     8                                           CSW024
     C                     MOVELWK8       MFLD                                                CSW024
     C                     MOVE ':21N:'   MTAG                                                CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW201
     C           CSW201    IFEQ 'Y'                                                           CSW201
      *                                                                                       CSW201
      ** Field :82a: Party A                                                                  CSW201
      *                                                                                       CSW201
     C                     ADD  1         X                                                   CSW201
     C           X         OCUR MULT                                                          CSW201
      *                                                                                       CSW201
     C**********           CALL 'AOBRCHR0'                                             CSW201 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD                                               CSW201
     C                     PARM '*KEY   ' @OPTN                                               CSW201
     C                     PARM MGBRCA    @BRCD   3                                           CSW201
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CSW201
      *                                                                                       CSW201
      ** Branch record not found - DB Error                                                   CSW201
      *                                                                                       CSW201
     C           @RTCD     IFNE *BLANKS                                                       CSW201
     C           *LOCK     IN   LDA                                                           CSW201
     C                     MOVE '031'     DBASE            ************                       CSW201
     C                     MOVELMGBRCA    DBKEY            * DBERR 31 *                       CSW201
     C                     MOVEL'SDBRCHPD'DBFILE           ************                       CSW201
     C                     OUT  LDA                                                           CSW201
     C                     EXSR *PSSR                                                         CSW201
     C                     ENDIF                                                              CSW201
      *                                                                                       CSW201
     C                     MOVE *BLANKS   ZDEST                                               CSW201
     C                     MOVE *BLANKS   ACLINE                                              CSW201
     C                     MOVE *BLANKS   TAG                                                 CSW201
     C                     MOVELA8BICN    ZDEST                                               CSW201
     C                     MOVE '82'      FLDNO                                               CSW201
     C                     EXSR FSWAD                                                         CSW201
      *                                                                                       CSW201
     C                     END                                                                CSW024
      *                                                                                       CSW024
      **  If corporate customer...                                                            CSW024
     C           CSW024    IFEQ 'Y'                                                           CSW024
     C           DSCORP    ANDEQ'Y'                                                           CSW024
      *                                                                                       CSW024
      **  If BEI output :87A:                                                                 CSW024
     C           DSCBEI    IFNE *BLANK                                                        CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVELDSCBEI    MFLD                                                CSW024
     C                     MOVE ':87A:'   MTAG                                                CSW024
      *                                                                                       CSW024
      **  If receiver party info output :87J:                                                 CSW024
     C                     ELSE                                                               CSW024
     C           DSRI01    IFNE *BLANK                                                        CSW024
     C           DSRI02    ORNE *BLANK                                                        CSW024
     C           DSRI03    ORNE *BLANK                                                        CSW024
     C           DSRI04    ORNE *BLANK                                                        CSW024
     C           DSRI05    ORNE *BLANK                                                        CSW024
      *                                                                                       CSW024
     C                     MOVE *BLANK    DN87    1                                           CSW024
     C           DSRI01    IFNE *BLANK                                                        CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C           DN87      IFNE 'Y'                                                           CSW024
     C                     MOVE ':87J:'   MTAG                                                CSW024
     C                     MOVE 'Y'       DN87                                                CSW024
     C                     ENDIF                                                              CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVELDSRI01    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
     C           DSRI02    IFNE *BLANK                                                        CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C           DN87      IFNE 'Y'                                                           CSW024
     C                     MOVE ':87J:'   MTAG                                                CSW024
     C                     MOVE 'Y'       DN87                                                CSW024
     C                     ENDIF                                                              CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVELDSRI02    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
     C           DSRI03    IFNE *BLANK                                                        CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C           DN87      IFNE 'Y'                                                           CSW024
     C                     MOVE ':87J:'   MTAG                                                CSW024
     C                     MOVE 'Y'       DN87                                                CSW024
     C                     ENDIF                                                              CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVELDSRI03    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
     C           DSRI04    IFNE *BLANK                                                        CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C           DN87      IFNE 'Y'                                                           CSW024
     C                     MOVE ':87J:'   MTAG                                                CSW024
     C                     MOVE 'Y'       DN87                                                CSW024
     C                     ENDIF                                                              CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVELDSRI04    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
     C           DSRI05    IFNE *BLANK                                                        CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C           DN87      IFNE 'Y'                                                           CSW024
     C                     MOVE ':87J:'   MTAG                                                CSW024
     C                     MOVE 'Y'       DN87                                                CSW024
     C                     ENDIF                                                              CSW024
     C                     MOVE *BLANK    MFLD                                                CSW024
     C                     MOVELDSRI05    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW024
      ** Else output :87D:                                                                    CSW024
     C                     ELSE                                                               CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C                     MOVE ':87D:'   MTAG                                                CSW024
     C                     MOVELDSCNA1    MFLD                                                CSW024
      **  Address 2                                                                           CSW024
     C           DSCNA2    IFNE *BLANKS                                                       CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C                     MOVELDSCNA2    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
      **  Address 3                                                                           CSW024
     C           DSCNA3    IFNE *BLANKS                                                       CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C                     MOVELDSCNA3    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
      **  Address 4                                                                           CSW024
     C           DSCNA4    IFNE *BLANKS                                                       CSW024
     C                     ADD  1         X                                                   CSW024
     C           X         OCUR MULT                                                          CSW024
     C                     MOVELDSCNA4    MFLD                                                CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW024
     C                     ENDIF                                                              CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW024
     C                     ELSE                                                               CSW024
      *                                                                                       CSW024
     C           CSW201    IFEQ 'Y'                                                           CSW024
      **  Field :87a: Party B                                                                 CSW201
      *                                                                                       CSW201
     C                     ADD  1         X                                                   CSW201
     C           X         OCUR MULT                                                          CSW201
      *                                                                                       CSW201
     C                     MOVE *BLANKS   ZDEST                                               CSW201
     C                     MOVE *BLANKS   ACLINE                                              CSW201
     C                     MOVE *BLANKS   TAG                                                 CSW201
     C                     MOVELMGCNUM    ZDEST                                               CSW201
     C                     MOVE '87'      FLDNO                                               CSW201
     C                     EXSR FSWAD                                                         CSW201
      *                                                                                       CSW201
     C                     ENDIF                                                              CSW024
     C                     ENDIF                                                              CSW201
     C/COPY WNCPYSRC,MG0350C020
      *                                                                   CSW200
      ** FIELD :15B: - New Sequence                                       CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVEL':15B:'   MTAG                            CSW200
     C                     MOVE *BLANKS   MFLD                            CSW200
      *                                                                   CSW200
      **  Field :67:  Interest Period.                                    CSW200
      *                                                                   CSW200
      ** This field is made up of the last interest date and the          CSW200
      ** next interest date.                                              CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVEA*BLANKS   @WRK                            CSW200
     C                     Z-ADD1         Z                               CSW200
      *                                                                   CSW200
      ** Last Interest Date.                                              CSW200
      *                                                                   CSW200
     C                     MOVE MGSLID    ZMDAY                           CSW200
      *                                                                   CSW200
      **  Convert Midas date to SWIFT date format.                        CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0065'               15                 CSW200
     C                     PARM           ZMDAY   50                      CSW200
     C                     PARM           ZSDATE  6                       CSW200
     C                     PARM           ZSDATC  8                       CSW200
      *                                                                   CSW200
      **  Call ended in error. (Program not found.)                       CSW200
      *                                                                   CSW200
     C           *IN15     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '028'     DBASE              * * * * * * *CSW200
     C                     MOVELZMDAY     DBKEY              * DBERR 028 *CSW200
     C                     MOVEL'ZM0065'  DBFILE             * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     MOVEAZSDATC    @WRK                            CSW200
      *                                                                   CSW200
      ** Next Interest Date.                                              CSW200
      *                                                                   CSW200
     C                     MOVE MGNIDT    ZMDAY                           CSW200
      *** Access DEALSDC to consider Amount Convention when CDL096                         CDL096I02
      *** is enabled                                                                       CDL096I02
     C           CDL096    IFEQ 'Y'                                                        CDL096I02
     C                     MOVE *BLANKS   @AMTC   1                                        CDL096I02
     C                     Z-ADD*ZEROS    @IBDT   50                                       CDL096I02
     C                     MOVELMGTNUM    @DLNO   60                                       CDL096I02
     C           @DLNO     CHAINDEALS                96                                    CDL096I02
     C           *IN96     IFEQ *OFF                                                       CDL096I02
     C           AMTC      ANDEQ'A'                                                        CDL096I02
     C                     MOVE IBDT      ZMDAY                                            CDL096I02
     C                     MOVELAMTC      @AMTC                                            CDL096I02
     C                     MOVE IBDT      @IBDT                                            CDL096I02
     C                     ENDIF                                                           CDL096I02
     C                     ENDIF                                                           CDL096I02
      *                                                                   CSW200
      **  Convert Midas date to SWIFT date format                         CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0065'               15                 CSW200
     C                     PARM           ZMDAY   50                      CSW200
     C                     PARM           ZSDATE  6                       CSW200
     C                     PARM           ZSDATC  8                       CSW200
      *                                                                   CSW200
     C           ' '       LOKUP@WRK,Z                   31               CSW200
     C                     MOVEA'/'       @WRK,Z                          CSW200
     C                     ADD  1         Z                               CSW200
     C                     MOVEAZSDATC    @WRK,Z                          CSW200
      *                                                                   CSW200
     C                     MOVEA@WRK      MFLD                            CSW200
     C                     MOVEL':30G:'   MTAG                            CSW200
      *                                                                   CSW200
      **  Field :32:  Currency Code , Principal Amount.                   CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
      **  Format currency code and contract amount.                       CSW200
      *                                                                   CSW200
     C/COPY WNCPYSRC,MG0350C021
     C                     MOVE MGCCY     ZCCY                            CSW200
     C                     MOVE MGPCPL    ZAMNT                           CSW200
     C                     CALL 'ZM0040'                                  CSW200
     C                     PARM           ZAMNT  130                      CSW200
     C                     PARM           ZCCY    3                       CSW200
     C                     PARM           ZSAMNT 15                       CSW200
     C                     PARM           ZSCCY   3                       CSW200
     C                     PARM           ZERR    1                       CSW200
     C                     PARM           ZSWDPC                                              222373
     C/COPY WNCPYSRC,MG0350C023
      *                                                                   CSW200
      ** Error - indicate erroneous fields;                               CSW200
      *                                                                   CSW200
     C           ZERR      IFEQ '1'                                       CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVELERR3N     MFLD                            CSW200
     C                     MOVELMSGA,3    MERR                            CSW200
      *                                                                   CSW200
      ** Format field 32 using the currency and amount.                   CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
     C                     MOVEA*BLANKS   @WRK                            CSW200
     C                     MOVEAZSCCY     @WRK                            CSW200
     C                     MOVEAZSAMNT    @WRK,4                          CSW200
     C                     MOVEA@WRK      MFLD                            CSW200
      *                                                                   CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     MOVE ':32B:'   MTAG                            CSW200
      *                                                                   CSW200
      ** Field 34 - Value Date, Currency, Principal Amount.               CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     Z-ADDMGNIDT    ZMDAY                           CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0065'               15                 CSW200
     C                     PARM           ZMDAY   50                      CSW200
     C                     PARM           ZSDATE  6                       CSW200
     C                     PARM           ZSDATC  8                       CSW200
      *                                                                   CSW200
     C                     MOVELZSDATC    MFLD                            CSW200
     C                     MOVEL':30V:'   MTAG                            CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
      **  Format currency and total interest.                             CSW200
      **  If interest amount on MGF350PD is not 0 use it as it was        CSW200
      **  correctly calculated in DL0195 for the confirmations else       CSW200
      **  calculate the interest taking into account and deal amends      CSW200
      **  during the life of the deal.                                    CSW200
      *                                                                   CSW200
     C           MGINTA    IFNE 0                                         CSW200
     C                     Z-ADDMGINTA    ZAMNT                           CSW200
     C                     ELSE                                           CSW200
     C                     Z-ADDMGIACD    ZIBEG                           CSW200
      ****Access*DEALSDC*to*consider*Amount*Convention*when*CDL096*****          CDL096I01 CDL096I02
      ****is*enabled*********                                                    CDL096I01 CDL096I02
     C********** CDL096    IFEQ 'Y'                                              CDL096I01 CDL096I02
     C**********           MOVELMGTNUM    @DLNO   60                             CDL096I01 CDL096I02
     C********** @DLNO     CHAINDEALS                96                          CDL096I01 CDL096I02
     C********** *IN96     IFEQ *OFF                                             CDL096I01 CDL096I02
     C********** AMTC      ANDEQ'A'                                              CDL096I01 CDL096I02
     C********** MGNIDT    ANDNEIBDT                                             CDL096I01 CDL096I02
     C**********           Z-ADDIBDT      ZIEND                                  CDL096I01 CDL096I02
     C**********           ELSE                                                  CDL096I01 CDL096I02
     C                     Z-ADDMGNIDT    ZIEND                           CSW200
      *                                                                                    CDL096I02
      *** Access DEALSDC to consider Amount Convention of 'A'                              CDL096I02
      *** when CDL096 is enabled                                                           CDL096I02
     C           CDL096    IFEQ 'Y'                                                        CDL096I02
     C           @AMTC     ANDEQ'A'                                                        CDL096I02
     C           MGNIDT    ANDNE@IBDT                                                      CDL096I02
     C                     Z-ADD@IBDT     ZIEND                                            CDL096I02
     C                     ENDIF                                                           CDL096I01
     C**********           ENDIF                                                 CDL096I01 CDL096I02
     C                     MOVE MGICBS    ZICALC                          CSW200
     C                     Z-ADDMGINTR    ZIRATE                          CSW200
     C                     Z-ADDMGPCPL    ZIAMT                           CSW200
     C                     EXSR GLINTC                                    CSW200
     C                     Z-ADDZINTR     ZAMNT     H                     CSW200
     C           ZINTR     IFLT 0                                         CSW200
     C                     Z-SUBZINTR     ZAMNT     H                     CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
      ** ZAMNT at this point = the interest from the interest accrual     CSW200
      ** date to the next interest date. The total interest for this      CSW200
      ** month = ZAMNT + AITC + AIAN + AIAP - IPRD - ICTD. These fields   CSW200
      ** have now been added to MG350PD and the following calculation     CSW200
      ** calculates the correct interest figure.                          CSW200
      *                                                                   CSW200
     C           ZAMNT     ADD  MGAITC    ZAMNT                           CSW200
     C           ZAMNT     ADD  MGAIAN    ZAMNT                           CSW200
     C           ZAMNT     ADD  MGAIAP    ZAMNT                           CSW200
     C           ZAMNT     SUB  MGIPRD    ZAMNT                           CSW200
     C           ZAMNT     SUB  MGICTD    ZAMNT                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C/COPY WNCPYSRC,MG0350C022
     C                     MOVE MGCCY     ZCCY                            CSW200
     C                     CALL 'ZM0040'                                  CSW200
     C                     PARM           ZAMNT  130                      CSW200
     C                     PARM           ZCCY    3                       CSW200
     C                     PARM           ZSAMNT 15                       CSW200
     C                     PARM           ZSCCY   3                       CSW200
     C                     PARM           ZERR    1                       CSW200
     C                     PARM           ZSWDPC                                              222373
      *                                                                   CSW200
      ** Error - indicate erroneous fields;                               CSW200
      *                                                                   CSW200
     C           ZERR      IFEQ '1'                                       CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVELERR3N     MFLD                            CSW200
     C                     MOVELMSGA,3    MERR                            CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
     C           ZSCCY     CAT  ZSAMNT    MFLD                            CSW200
      *                                                                   CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     MOVEL':34B:'   MTAG                            CSW200
      *                                                                   CSW200
      ** Field 37 - Interest field.                                       CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
      *                                                                   CSW200
     C           MGINTR    IFLT *ZERO                                     CSW200
     C                     Z-SUBMGINTR    ZINRT                           CSW200
     C                     ELSE                                           CSW200
     C                     Z-ADDMGINTR    ZINRT                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     CALL 'ZM0010'               15                 CSW200
     C                     PARM           ZINRT  117                      CSW200
     C                     PARM           ZSINRT 12                       CSW200
      *                                                                   CSW200
      ** If the program ended in error. (Program not found.)              CSW200
      *                                                                   CSW200
     C           *IN15     IFEQ '1'                                       CSW200
     C           *LOCK     IN   LDA                                       CSW200
     C                     MOVE '029'     DBASE              * * * * * * *CSW200
     C                     MOVEL'       ' DBKEY              * DBERR 029 *CSW200
     C                     MOVEL'ZM0010'  DBFILE             * * * * * * *CSW200
     C                     OUT  LDA                                       CSW200
     C                     EXSR *PSSR                                     CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
      ** If SWIFT 2016 is enabled, use 37M tag                                                CSW216
      *                                                                                       CSW216
     C           CSW216    IFEQ 'Y'                                                           CSW216
     C                     MOVEL':37M:'   MTAG                                                CSW216
     C                     MOVELZSINRT    MFLD                                                CSW216
      *                                                                                       CSW216
     C           MGINTR    IFLT *ZERO                                                         CSW216
     C           'N'       CAT  MFLD      MFLD                                                CSW216
     C                     ENDIF                                                              CSW216
      *                                                                                       CSW216
     C                     ELSE                                                               CSW216
     C                     MOVEL':37J:'   MTAG                            CSW200
     C                     MOVELZSINRT    MFLD                            CSW200
     C                     ENDIF                                                              CSW216
      *                                                                   CSW200
      ** FIELD :14D: - Day Count Fraction                                 CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVEL':14D:'   MTAG                            CSW200
      *                                                                   CSW200
     C                     SELEC                                          CSW200
      *                                                                   CSW200
     C           MGICBS    WHEQ 1                                         CSW200
     C                     MOVEL'AFI/365' MFLD                            CSW200
      *                                                                   CSW200
     C           MGICBS    WHEQ 2                                         CSW200
     C           MGICBS    OREQ 5                                         CSW200
     C                     MOVEL'ACT/360' MFLD                            CSW200
      *                                                                   CSW200
     C           MGICBS    WHEQ 3                                         CSW200
     C                     MOVEL'360/360' MFLD                            CSW200
      *                                                                   CSW200
     C           MGICBS    WHEQ 4                                         CSW200
     C           MGICBS    OREQ 6                                         CSW200
     C                     MOVEL'ACT/365' MFLD                            CSW200
      *                                                                   CSW200
     C                     ENDSL                                          CSW200
      *                                                                   CSW200
      *                                                                   CSW200
      ** FIELD :15C: - New Sequence                                       CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
      *                                                                   CSW200
     C                     MOVEL':15C:'   MTAG                            CSW200
     C                     MOVE *BLANKS   MFLD                            CSW200
      *                                                                   CSW200
      *                                                                   CSW200
      ** Fields 53,56 and 57 are dependant on the deal type.              CSW200
      ** If the loans/deposits indicator (MGLORD) is L execute            CSW200
      ** subroutine RCV else execute subroutine PAY.                      CSW200
      *                                                                   CSW200
     C           MGLORD    IFEQ 'D'                                       CSW200
     C                     EXSR PAY200                                    CSW200
     C                     ELSE                                           CSW200
     C                     EXSR RCV                                       CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     ENDSR                                          CSW200
     C/EJECT                                                              CSW200
      *****************************************************************   CSW200
      *   PAY200 - Format fields 53, 56 and 57 for a Placing.         *   CSW200
      *   Called by - FMA200 - Format message detail.                 *   CSW200
      *   Calls     - FSWAD Format swift address.                     *   CSW200
      *****************************************************************   CSW200
      *                                                                   CSW200
     C           PAY200    BEGSR                                          CSW200
      *                                                                                       CSW201
     C           CSW201    IFEQ 'Y'                                                           CSW201
     C                     MOVE 'Y'       ZDBEI                                               CSW201
     C                     ENDIF                                                              CSW201
      *                                                                   CSW200
     C                     MOVE *BLANKS   @WRK                            CSW200
      *                                                                   CSW200
      ** Field 53 - Senders correspondant.                                CSW200
      **  Test if settlement via nostro                                   CSW200
      *                                                                   CSW200
     C                     MOVE MGPSTM    @STM    2                       CSW200
     C           @STM      LOKUPTABNST                   23               CSW200
      *                                                                   CSW200
      ** If our pay nostro is not blank and the settlement is via a nostroCSW200
      *                                                                   CSW200
     C           MGPONS    IFNE *BLANKS                                   CSW200
     C           *IN23     ANDEQ'1'                                       CSW200
      *                                                                   CSW200
      **  either A/C with Bank or Receipient entered                      CSW200
      **  or DIRECT entered                                               CSW200
      *                                                                   CSW200
     C           MGAWBN    IFNE *BLANKS                                   CSW200
     C           MGRVNO    ORNE *BLANKS                                   CSW200
     C           AWBA6     OREQ 'DIRECT'                                  CSW200
      *                                                                   CSW200
      *                                                                   CSW200
     C                     MOVELMGPONS    @NONB                           CSW200
      *                                                                   CSW200
      ** Use settlement currency to access nostro if not blank.           CSW200
      ** Otherwise use deal currency.                                     CSW200
     C           CEU003    IFEQ 'Y'                                       CSW200
     C           MGSTCY    ANDNE*BLANKS                                   CSW200
     C                     MOVE MGSTCY    @CYCD                           CSW200
     C                     ELSE                                           CSW200
     C                     MOVE MGCCY     @CYCD                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
      ** Access the nostros file using our pay nostro.                    CSW200
      *                                                                   CSW200
     C                     CALL 'AONOSTR0'                                CSW200
     C                     PARM '*MSG   ' @RTCD   7                       CSW200
     C                     PARM '*KEY   ' @OPTN   7                       CSW200
     C                     PARM *BLANKS   @CUST   6                       CSW200
     C                     PARM           @CYCD   3                       CSW200
     C**********           PARM *BLANKS   @ACCD   4                       CSW200       CSW200 CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2                       CSW200
     C                     PARM           @NONB   2                       CSW200
     C                     PARM *BLANKS   @BRCD   3                       CSW200
     C                     PARM *BLANKS   @CSSN  10                       CSW200
     C                     PARM *BLANKS   @PNOI   1                       CSW200
     C           SDNOST    PARM SDNOST    DSFDY                           CSW200
      *                                                                   CSW200
      **  Nostro customer not found                                       CSW200
      *                                                                   CSW200
     C           @RTCD     IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVE ':53 :'   MTAG                            CSW200
     C                     MOVELMGPONS    HLD2                            CSW200
     C                     MOVELMGCCY     HLD5                            CSW200
     C                     MOVE HLD2      HLD5                            CSW200
     C                     MOVELHLD5      MFLD                            CSW200
     C                     MOVELMSGA,6    MERR                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      ** Branch Internal Customer cf. Customer number of Our Pay Nostro   CSW200
      *                                                                   CSW200
     C                     MOVELSECN      @SECN   6                       CSW200
     C           @SECN     IFNE A7CUST                                    CSW200
     C           MGAWBN    ANDNEA7CUST                                    CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELA7CUST    ZDEST                           CSW200
     C*********************CALL 'ZM0050'                                               CSW200 CSW036
     C                     CALL 'ZM0051'                                                      CSW036
     C                     PARM           ZDEST  12                       CSW200
     C                     PARM           ZSADD1 35                       CSW200
     C                     PARM           ZSADD2 35                       CSW200
     C                     PARM           ZSADD3 35                       CSW200
     C                     PARM           ZSADD4 35                       CSW200
     C                     PARM           ZSTAG   1                       CSW200
     C                     PARM           ZSTYPE  1                       CSW200
     C                     PARM           ZERR    1                       CSW200
     C                     PARM           ZDBEI                                               CSW201
      *                                                                   CSW200
      **  Error when formating address                                    CSW200
      *                                                                   CSW200
     C           ZERR      IFEQ '1'                                       CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVE ':53 :'   MTAG                            CSW200
     C                     MOVELZDEST     MFLD                            CSW200
     C                     MOVELMSGA,5    MERR                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  A Type address                                                  CSW200
      *                                                                   CSW200
     C           ZSTAG     IFEQ 'A'                                       CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'A'       TAG                             CSW200
     C                     MOVE '53'      FLDNO                           CSW200
     C                     MOVE @MTAG     MTAG                            CSW200
     C                     MOVELZSADD1    MFLD                            CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  D Type address                                                  CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C**********           MOVE BBPCNB    @PCNB   60                                   CSW200 CSD027
     C                     MOVE BBPCNB    @PCNB   6                                           CSD027
      *                                                                   CSW200
     C                     MOVE ':53D:'   MTAG                            CSW200
     C                     MOVELZSADD1    MFLD                            CSW200
      **  Address 2                                                       CSW200
     C           ZSADD2    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELZSADD2    MFLD                            CSW200
      **  Address 3                                                       CSW200
     C           ZSADD3    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELZSADD3    MFLD                            CSW200
      **  Address 4                                                       CSW200
     C           ZSADD4    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELZSADD4    MFLD                            CSW200
     C                     END                             D address 4    CSW200
     C                     END                             D address 3    CSW200
     C                     END                             D address 2    CSW200
      *                                                                   CSW200
     C                     END                             A/D address?   CSW200
     C                     END                             Fmt ad. error. CSW200
     C                     END                             Brch Int Cust. CSW200
     C                     END                             Nostro not fnd.CSW200
     C                     END                                            CSW200
     C                     END                             Pay nostro?    CSW200
      *                                                                   CSW200
      **  Field :57:  A/C with institution non-blank                      CSW200
      *                                                                   CSW200
     C           MGAWBN    IFNE *BLANKS                                   CSW200
      *                                                                   CSW200
      **  Field :56:  Pay Intermediary bank                               CSW200
      **  This field is only produced when the account with institution   CSW200
      **  is non-blank.                                                   CSW200
      *                                                                   CSW200
     C           MGPIBN    IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELMGPIBN    ZDEST                           CSW200
     C                     MOVELMGPIBA    ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '56'      FLDNO                           CSW200
      *                                                                   CSW200
      ** Format field 56 via subroutine FSWAD.                            CSW200
      *                                                                   CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
      **  Format Account with institution. (Field 57.)                    CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELMGAWBN    ZDEST                           CSW200
     C                     MOVELMGAWBA    ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     MOVE 'Y'       FLD57O  1                       CSW200
      *                                                                   CSW200
      **    A/C with Inst. blank                                          CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
     C           AWBA6     IFEQ 'DIRECT'                                  CSW200
      *                                                                   CSW200
      **  A/C with Inst. set up as DIRECT, use beneficiary details        CSW200
      **  Format Account with institution. (Field 57.)                    CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELMGBENN    ZDEST                           CSW200
     C                     MOVELMGBENA    ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     MOVE 'Y'       FLD57O  1                       CSW200
      *                                                                   CSW200
      **  A/C with Inst. blank and NOT "DIRECT" entered,                  CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Field 57 = pay nostro customer if settlement via '02' or '12'   CSW200
     C           MGPSTM    IFEQ 02                                        CSW200
     C           MGPSTM    OREQ 12                                        CSW200
     C                     MOVELMGPONS    @NONB                           CSW200
      *                                                                   CSW200
      ** Use settlement currency to access nostro if not blank.           CSW200
      ** Otherwise use deal currency.                                     CSW200
     C           CEU003    IFEQ 'Y'                                       CSW200
     C           MGSTCY    ANDNE*BLANKS                                   CSW200
     C                     MOVE MGSTCY    @CYCD                           CSW200
     C                     ELSE                                           CSW200
     C                     MOVE MGCCY     @CYCD                           CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     CALL 'AONOSTR0'                                CSW200
     C                     PARM '*MSG   ' @RTCD   7                       CSW200
     C                     PARM '*KEY   ' @OPTN   7                       CSW200
     C                     PARM *BLANKS   @CUST   6                       CSW200
     C                     PARM           @CYCD   3                       CSW200
     C**********           PARM *BLANKS   @ACCD   4                                    CSW200 CGL029
     C                     PARM *BLANKS   @ACCD                                               CGL029
     C                     PARM *BLANKS   @ACSN   2                       CSW200
     C                     PARM           @NONB   2                       CSW200
     C                     PARM *BLANKS   @BRCD   3                       CSW200
     C                     PARM *BLANKS   @CSSN  10                       CSW200
     C                     PARM *BLANKS   @PNOI   1                       CSW200
     C           SDNOST    PARM SDNOST    DSFDY                           CSW200
      *                                                                   CSW200
      **  Nostro customer not found                                       CSW200
      *                                                                   CSW200
     C           @RTCD     IFNE *BLANKS                                   CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVELMGPONS    HLD2    2                       CSW200
     C                     MOVELMGCCY     HLD5                            CSW200
     C                     MOVE HLD2      HLD5    5                       CSW200
     C                     MOVELHLD5      MFLD                            CSW200
     C                     MOVELMSGA,6    MERR                            CSW200
     C                     MOVE ':57 :'   MTAG                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Format our Pay Nostro Customer Address                          CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELA7CUST    ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
     C                     MOVE MGPSTM    @STM                            CSW200
     C           @STM      LOKUPTABINT                   23               CSW200
      *                                                                   CSW200
     C           *IN23     IFEQ '1'                                       CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELSECN      ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '57'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
      *                                                                   CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Field 53 is equal to Our Pay Nostro                             CSW200
      **  (only if settlement type is NOSTRO, ie. not if s/typ is '00')   CSW200
     C           MGPSTM    IFNE *ZEROS                                    CSW200
     C                     MOVEL*BLANKS   WRKTAG                        MD038672
     C                     MOVELMTAG      WRKTAG                        MD038672
     C           WRKTAG    IFNE ':53'                                   MD038672
      *                                                                   CSW200
     C                     MOVELMGPONS    @NSKYE                          CSW200
      *                                                                   CSW200
      ** Use settlement currency to access nostro if not blank.           CSW200
      ** Otherwise use deal currency.                                     CSW200
     C           CEU003    IFEQ 'Y'                                       CSW200
     C           MGSTCY    ANDNE*BLANKS                                   CSW200
     C                     MOVE MGSTCY    @NSKYB                          CSW200
     C                     ELSE                                           CSW200
     C                     MOVE MGCCY     @NSKYB                          CSW200
     C                     ENDIF                                          CSW200
      *                                                                   CSW200
     C                     CALL 'AONOSTR0'                                CSW200
     C                     PARM '*MSG   ' @RTCD   7                       CSW200
     C                     PARM '*KEY   ' @OPTN   7                       CSW200
     C                     PARM *BLANKS   @NSKYA  6                       CSW200
     C                     PARM           @NSKYB  3                       CSW200
     C**********           PARM *BLANKS   @NSKYC  4                                    CSW200 CGL029
     C                     PARM *BLANKS   @NSKYC                                              CGL029
     C                     PARM *BLANKS   @NSKYD  2                       CSW200
     C                     PARM           @NSKYE  2                       CSW200
     C                     PARM *BLANKS   @KEYF   3                       CSW200
     C                     PARM *BLANKS   @KEYG  10                       CSW200
     C                     PARM *BLANKS   @KEYH   1                       CSW200
     C           SDNOST    PARM SDNOST    DSFDY                           CSW200
     C*                                                                   CSW200
     C**  Nostro customer not found                                       CSW200
     C           @RTCD     IFNE *BLANKS                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE 'Y'       @ERR                            CSW200
     C                     MOVE ':53 :'   MTAG                            CSW200
     C                     MOVELMGPONS    HLD2                            CSW200
     C                     MOVELMGCCY     HLD5                            CSW200
     C                     MOVE HLD2      HLD5                            CSW200
     C                     MOVELHLD5      MFLD                            CSW200
     C                     MOVELMSGA,6    MERR                            CSW200
     C                     ELSE                                           CSW200
      *                                                                   CSW200
      **  Format our Pay Nostro Customer Address                          CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE *BLANKS   ZDEST                           CSW200
     C                     MOVELA7CUST    ZDEST                           CSW200
     C                     MOVEL*BLANKS   ACLINE                          CSW200
     C                     MOVE ' '       TAG                             CSW200
     C                     MOVE '53'      FLDNO                           CSW200
     C                     EXSR FSWAD                                     CSW200
     C                     END                                            CSW200
      *                                                                   CSW200
     C                     ENDIF                                        MD038672
     C                     END                                            CSW200
      *                                                                   CSW200
      **  Settlement 01,07 or 08 with MGAWBN blank or settlement 00       CSW200
      *                                                                   CSW200
     C                     ADD  1         X                               CSW200
     C           X         OCUR MULT                                      CSW200
     C                     MOVE ':57D:'   MTAG                            CSW200
     C                     MOVEL'UNKNOWN' MFLD                            CSW200
     C                     END                                            CSW200
     C                     END                                            CSW200
     C                     END                                            CSW200
     C                     END                                            CSW200
      *                                                                                       CSW201
     C                     MOVE *BLANKS   ZDBEI                                               CSW201
      *                                                                   CSW200
     C                     ENDSR                                          CSW200
     C/EJECT                                                              CSW200
      *****************************************************************
      ****NWAD*-*determine*default*network*addresses*******************   CSW096
      ****Called*by*-*ROUT*determine*message*routing*******************   CSW096
      ****Calls*****-**************************************************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********NWAD      BEGSR                                          CSW096
      ***********                                                         CSW096
      ****Default*is*SWIFT************************************************CSW096
      ***********                                                         CSW096
     C***********BBDNW3    IFEQ 'SWIFT'                                   CSW096
     C***********BBCSID    ANDNE*BLANKS                                   CSW096
     C***********@BIC      ANDNE'BIC'                                     CSW096
     C***********BGMSDL    ANDEQ'Y'                                       CSW096
     C***********          MOVELSCSID     NWSN                            CSW096
     C***********          MOVELBBCSID    NWDS                            CSW096
     C***********          MOVE BBDNW3    NWRK                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Default*is*TELEX************************************************CSW096
      ***********                                                         CSW096
     C***********BBDNW3    IFEQ 'TELEX'                                   CSW096
     C***********BBTXA1    ANDNE*BLANKS                                   CSW096
     C***********BGMTMI    ANDEQ'Y'                                       CSW096
     C***********          MOVELSTELX     NWSN                            CSW096
     C***********          MOVELBBTXA1    NWDS                            CSW096
     C***********          MOVE BBDNW3    NWRK                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Default*is*STTX*************************************************CSW096
      ***********                                                         CSW096
     C***********BBDNW3    IFEQ 'STTX'                                    CSW096
     C***********BBSTAD    ANDNE*BLANKS                                   CSW096
     C***********BGMSDL    ANDEQ'Y'                                       CSW096
     C***********          MOVELSSTTX     NWSN                            CSW096
     C***********          MOVELBBSTAD    NWDS                            CSW096
     C***********          MOVE BBDNW3    NWRK                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Default*is*PAPER************************************************CSW096
      ***********                                                         CSW096
     C***********BBDNW3    IFEQ 'PAPER'                                   CSW096
     C***********          MOVELSCRNM     NWSN                            CSW096
     C***********          MOVELBBCRNM    NWDS                            CSW096
     C***********          MOVE BBDNW3    NWRK                            CSW096
      ***********                                                         CSW096
      ****If*the*ICD*option*for*free*format*confirmations*is*'Y',*********CSW096
      ****the*message*has*already*been*printed*,*hence*no*further*********CSW096
      ****print*out*is*needed.********************************************CSW096
     C***********ENFFCR    IFEQ 'Y'                                       CSW096
     C***********          MOVEL'PRTD'    MGST                            CSW096
     C***********          MOVE '3'       MGSG                            CSW096
     C***********          ELSE                                           CSW096
     C***********          MOVEL'RSND'    MGST                            CSW096
     C***********          MOVE '2'       MGSG                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****Found*to*be*unroutable******************************************CSW096
      ***********                                                         CSW096
     C***********NWRK      IFEQ *BLANKS                                   CSW096
     C***********NWDS      OREQ *BLANKS                                   CSW096
     C***********NWSN      OREQ *BLANKS                                   CSW096
     C***********          MOVELSCRNM     NWSN                            CSW096
     C***********          MOVELBBCRNM    NWDS                            CSW096
     C***********          MOVEL'UNROUT'  NWRK                            CSW096
     C***********          MOVE 'CRTD'    MGST                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          ENDSR                                          CSW096
     C*/EJECT****                                                         CSW096
      *****************************************************************   CSW096
      ****PRAD*-*determine*priority*network*addresses******************   CSW096
      ****Called*by**ROUT****determine*message*routing*****************   CSW096
      ****Calls******TXROUT**priority*routing*to*STTX/Telex************   CSW096
      ***************SWROUT**priority*routing*to*SWIFT*****************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********PRAD      BEGSR                                          CSW096
      ***********                                                         CSW096
      ****If*STTX/Telex*has*higher*priority*than*SWIFT*attempt************CSW096
      ****STTX/Telex*routing*first,*followed*by*SWIFT.*(nb.*'Higher'******CSW096
      ****priority*is*numerically*lower*ie.*'1'*is*higher*than*'2')*******CSW096
     C***********BLTXPY    IFLT BLSWPY                                    CSW096
     C***********          EXSR TXROUT                                    CSW096
     C***********          EXSR SWROUT                                    CSW096
      ***********                                                         CSW096
      ****otherwise*attempt*SWIFT*routing*first***************************CSW096
     C***********          ELSE                                           CSW096
     C***********          EXSR SWROUT                                    CSW096
     C***********          EXSR TXROUT                                    CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
      ****If*failed*to*route*to*electronic*network,*produce*paper*********CSW096
     C***********NWRK      IFEQ *BLANKS                                   CSW096
     C***********          MOVEL'PAPER'   NWRK                            CSW096
     C***********          MOVELSCRNM     NWSN                            CSW096
     C***********          MOVELBBCRNM    NWDS                            CSW096
      ***********                                                         CSW096
      ****If*the*ICD*option*for*free*format*advices*is*'Y'*the************CSW096
      ****message*has*already*been*printed*,*hence*no*further*************CSW096
      ****print*out*is*needed.********************************************CSW096
     C***********ENFFCR    IFEQ 'Y'                                       CSW096
     C***********          MOVEL'PRTD'    MGST                            CSW096
     C***********          MOVE '3'       MGSG                            CSW096
     C***********          ELSE                                           CSW096
     C***********          MOVEL'RSND'    MGST                            CSW096
     C***********          MOVE '2'       MGSG                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          ENDSR                                          CSW096
     C*/EJECT****                                                         CSW096
      *****************************************************************   CSW096
      ****TXROUT*-*Attempt*priority*routing*to*STTX/Telex,*if*not******   CSW096
      *************already*routed**************************************   CSW096
      ****Called*by***PRAD*********************************************   CSW096
      ****Calls*******-************************************************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********TXROUT    BEGSR                                          CSW096
      ***********                                                         CSW096
      ****If*not*already*routed,*attempt*STTX/Telex*routing***************CSW096
     C***********NWRK      IFEQ *BLANKS                                   CSW096
      ***********                                                         CSW096
      ****Note*that*STTX*and*Telex*are*mutually*exclusive*-*try*both******CSW096
     C***********BGMSDL    IFEQ 'Y'                                       CSW096
     C***********BBSTAD    ANDNE*BLANKS                                   CSW096
     C***********SSTTX     ANDNE*BLANKS                                   CSW096
     C***********          MOVELSSTTX     NWSN                            CSW096
     C***********          MOVELBBSTAD    NWDS                            CSW096
     C***********          MOVEL'STTX'    NWRK                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********BGMTMI    IFEQ 'Y'                                       CSW096
     C***********BBTXA1    ANDNE*BLANKS                                   CSW096
     C***********STELX     ANDNE*BLANKS                                   CSW096
     C***********          MOVELSTELX     NWSN                            CSW096
     C***********          MOVELBBTXA1    NWDS                            CSW096
     C***********          MOVEL'TELEX'   NWRK                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          ENDSR                           TXROUT         CSW096
      ***********                                                         CSW096
     C*/EJECT****                                                         CSW096
      *****************************************************************   CSW096
      ****SWROUT*-*Attempt*priority*routing*to*SWIFT*if*not*already****   CSW096
      *************routed**********************************************   CSW096
      ****Called*by***PRAD*********************************************   CSW096
      ****Calls*******-************************************************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********SWROUT    BEGSR                                          CSW096
      ***********                                                         CSW096
      ****If*not*already*routed,*attempt*SWIFT*routing********************CSW096
     C***********NWRK      IFEQ *BLANKS                                   CSW096
     C***********BGMSDL    ANDEQ'Y'                                       CSW096
     C***********BBCSID    ANDNE*BLANKS                                   CSW096
     C***********SCSID     ANDNE*BLANKS                                   CSW096
     C***********@BIC      ANDNE'BIC'                                     CSW096
     C***********          MOVELSCSID     NWSN                            CSW096
     C***********          MOVELBBCSID    NWDS                            CSW096
     C***********          MOVEL'SWIFT'   NWRK                            CSW096
     C***********          END                                            CSW096
      ***********                                                         CSW096
     C***********          ENDSR                           SWROUT         CSW096
      ***********                                                         CSW096
     C*/EJECT****                                                         CSW096
      *****************************************************************   CSW096
      ****FILL*-*Fill*up*GNR*array.************************************   CSW096
      ****Called*by*-*ROUT**determine*message*routing.*****************   CSW096
      ****Calls*****-**************************************************   CSW096
      *****************************************************************   CSW096
      ***********                                                         CSW096
     C***********FILL      BEGSR                                          CSW096
      ***********                                                         CSW096
      ****Is*message*to*be*generated*as*released*?************************CSW096
      ***********                                                         CSW096
     C***********          MOVE BBDS01    GNR,1                           CSW096
     C***********          MOVE BBDS02    GNR,2                           CSW096
     C***********          MOVE BBDS03    GNR,3                           CSW096
     C***********          MOVE BBDS04    GNR,4                           CSW096
     C***********          MOVE BBDS05    GNR,5                           CSW096
     C***********          MOVE BBDS06    GNR,6                           CSW096
     C***********          MOVE BBDS07    GNR,7                           CSW096
     C***********          MOVE BBDS08    GNR,8                           CSW096
     C***********          MOVE BBDS09    GNR,9                           CSW096
     C***********          MOVE BBDS10    GNR,10                          CSW096
     C***********          MOVE BBDS11    GNR,11                          CSW096
     C***********          MOVE BBDS12    GNR,12                          CSW096
     C***********          MOVE BBDS13    GNR,13                          CSW096
     C***********          MOVE BBDS14    GNR,14                          CSW096
     C***********          MOVE BBDS15    GNR,15                          CSW096
      ***********                                                         CSW096
     C***********          ENDSR                                          CSW096
     C/EJECT
      *****************************************************************
      *   REPT - print incorrectly generated messages.                *
      *   Called by - main process.                                   *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           REPT      BEGSR
      *
      ** Open the printer file if it is not already open.
      *
     C           *IN50     IFEQ '0'
     C                     OPEN MG0350P1
     C                     SETON                     50                   084320
     C************         SETON                     50U7                 084320
     C                     END
      *
     C                     WRITEHEADER
     C                     WRITETEXT
      *
      **  Process multiple occurrence data structure
      *
     C                     Z-ADD0         I       20
     C           I         DOWLEX
     C                     ADD  1         I
     C           I         OCUR MULT
     C                     WRITELINE
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   OMSG - output correctly generated messages                  *
      *   Called by - main process                                    *
      *   Calls - WREF -Write reference record to MGOREFPD.           *
      *****************************************************************
      *
     C           OMSG      BEGSR
      *
      ** Write reference record to MGOREFPD.
      *
     C                     EXSR WREF
      *
      **  Write multiple occurrence data structure to MGOMSGPD
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
      *
     C***********X         DOWLE40                                        CSW200
     C***********MFLD      ANDNE*BLANKS                                   CSW200
     C           X         DOWLE35                                        CSW200
     C           MFLD      ANDNE*BLANKS                                   CSW200
     C           X         ORLE 35                                        CSW200
     C           MTAG      ANDNE*BLANKS                                   CSW200
     C                     WRITEMGOMSGD0               06
      *
      **  Error on write to PF/MGOMSGPD (message data file)
      *
     C           *IN06     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '012'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 012 *
     C                     MOVEL'MGOMSGPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END
      *                                                                   183583
      ** Write multiple occurrence data structure to MGOEXTPD             183583
      *                                                                   183583
     C                     Z-ADD1         V       20                      183583
     C           V         OCUR EXTN                                      183583
     C           V         DOWLE10                                        183583
     C           MCSI      ANDNE*BLANKS                                   183583
     C                     WRITEMGOEXTD0               06                 183583
      *                                                                   183583
      ** Error on write to PF/MGOEXTPD (message data extension file)      183583
      *                                                                   183583
     C           *IN06     IFEQ '1'                                       183583
     C           *LOCK     IN   LDA                                       183583
     C                     MOVE '027'     DBASE            ************** 183583
     C                     MOVEL'        'DBKEY            * DBERROR 27 * 183583
     C                     MOVEL'MGOEXTPD'DBFILE           ************** 183583
     C                     OUT  LDA                                       183583
     C                     EXSR *PSSR                                     183583
     C                     ENDIF                                          183583
     C                     ADD  1         V                               183583
     C           V         OCUR EXTN                                      183583
     C                     ENDDO                                          183583
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   CFMAT - produce confirmation matching feedback record       *
      *   Called by   Main process                                    *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           CFMAT     BEGSR
      *
     C                     CALL 'MG5001'
     C                     PARM TRNO      @TRNM  16
     C                     PARM MGBRCA    @BRCA   3
     C                     PARM *BLANK    @FEED   1
      *
     C           @FEED     IFEQ 'Y'
      *
     C           *IN50     IFEQ '0'
     C                     OPEN MG0350P1
     C                     SETON                     50U7
     C                     END
      *
      **   Set up headings and sender/customer information
      **       for the error report
     C                     MOVE '1'       *IN30
     C                     MOVELMGTNUM    TNUM    60
     C                     WRITEHEADER
     C                     WRITETEXT
     C                     WRITEFEED
     C                     MOVE '0'       *IN30
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   WREF - Write reference record to PF/MGOREFPD                *
      *   Called by - OMSG  output message PF/MGOMSGPD                *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           WREF      BEGSR
      *
     C                     MOVE *BLANKS   SYTM
     C                     MOVE MGMODI    MODI
     C                     MOVE @TRNA     TRNO
     C                     MOVE *BLANKS   TRNF
     C                     MOVE *BLANKS   TRNM
     C                     MOVELMGTNUM    MTRN
     C                     MOVE MGTTYP    TNTP
     C                     MOVE MGTSTP    SBTP
     C                     MOVE *BLANKS   EVTP
     C                     MOVEL*BLANKS   NWBN
     C                     MOVE '350'     MTPY
     C                     MOVE 'N'       MPRY
     C                     MOVEL*BLANKS   PTST
     C                     MOVEL*BLANKS   CARQ
     C                     MOVEL*BLANKS   MPDE
     C                     MOVEL@HRDT     HRDT
     C                     TIME           MGTM
     C                     MOVE BJMRDT    LADT
     C                     MOVE MGTM      LATM
      *                                                                                       CSD015
      ** Initiate the Midas Watch List Checking Engine if CSD015 is                           CSD015
      ** enabled and CSW025 is disabled.                                                      CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDEQ'N'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *
     C           MGST      IFEQ 'CRTD'
     C                     MOVE '1'       MGSG
     C                     END
     C           MGST      IFEQ 'RSND'
     C                     MOVE BJMRDT    RELD
     C                     MOVE MGTM      RELT
     C                     MOVE '2'       MGSG
     C                     END
     C           MGST      IFEQ 'PRTD'
     C                     MOVE '3'       MGSG
     C                     END
      *
     C                     MOVEL*BLANKS   RUSR
     C                     MOVEL*BLANKS   RWSN
     C                     MOVEL*BLANKS   AMTS
     C                     MOVEL*BLANKS   AMTX
     C                     MOVEL*BLANKS   SVDT
     C                     MOVEL*BLANKS   CINDV                           141572
     C                     MOVEL*BLANKS   CCY
     C                     MOVEL*BLANKS   NSNO
     C                     MOVEL*BLANKS   SACN
     C                     MOVEL*BLANKS   AORR
     C                     MOVEL*BLANKS   DESI
      *
      **  Branch details
      *
     C                     MOVE MGBRCA    BRCA
     C                     MOVE MGPOBR    OTHB
     C           OTHB      IFNE *BLANKS
     C                     MOVELMSGA,1    OTHT
     C                     END
     C                     MOVE MGROBR    RCBR
      *
     C                     MOVE *BLANKS   NETI
     C                     MOVE *BLANKS   DELC
     C                     MOVE *BLANKS   DYST
     C                     MOVE *BLANKS   RSID
     C                     MOVE *BLANKS   MSE1
     C                     MOVE *BLANKS   ELIN
     C                     MOVE *BLANKS   SSAC
     C                     MOVE *BLANKS   MIR
     C                     MOVE *BLANKS   TSKS
     C                     MOVE *BLANKS   CFPF                            055058
     C                     MOVE *BLANKS   TSKY
     C                     MOVE MGCHTP    AORR                                                CSW025
     C/COPY WNCPYSRC,MG0350C010
     C*
     C                     WRITEMGOREFD0               05
      *
      **  Error on write to PF/MGOREFPD (message reference file)
      *
     C           *IN05     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '014'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 014 *
     C                     MOVEL'MGOREFPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Write transaction history record                                                     190127
     C                     MOVELTRNO      @HREF                                               190127
     C                     MOVE '350'     HSMTPY                                              190127
      *                                                                                       190127
     C                     WRITEMGHISTD0               56                                     190127
      *                                                                                       190127
      **  Error on write to PF/MGHISTPD                                                       190127
     C           *IN56     IFEQ '1'                                                           190127
     C           *LOCK     IN   LDA                                                           190127
     C                     MOVE '027'     DBASE            * * * * * * * *                    190127
     C                     MOVEL'       ' DBKEY            *  DBERR 027  *                    190127
     C                     MOVEL'MGHISTPD'DBFILE           * * * * * * * *                    190127
     C                     OUT  LDA                                                           190127
     C                     EXSR *PSSR                                                         190127
     C                     END                                                                190127
      *
     C                     ENDSR
     C/COPY WNCPYSRC,MG0350C011
     C/EJECT
     C********************************************************************066550
     C***GLINTC**To calculate interest between any two day numbers     .  066550
     C*****Calculation methods are -                                      066550
     C*****1**ACTUAL/365                                                  066550
     C*****2**ACTUAL/360                                                  066550
     C*****3**360/360 (SOMETIMES CALLED 30/360)                           066550
     C*****4**365/365 (EXCLUDING 29/02)                                   066550
     C*****5**365/360 (EXCLUDING 29/02)                                   066550
     C*****6**ACTUAL/366                                                  066550
     C***********                                                         066550
     C*****Calls*         ZSAVE                                           066550
     C***********         ZDATE2                                          066550
     C***********         ZRSTOR                                          066550
     C********************************************************************066550
     C***********                                                         066550
     C***********GLINTC    BEGSR                           ** GLINTC  **  066550
     C***********                                                         066550
     C****Calculations to define input fields.                            066550
     C***********          Z-ADDZIBEG     ZIBEG   50       starting date  066550
     C***********          Z-ADDZIEND     ZIEND   50       finishing date 066550
     C***********          Z-ADDZICALC    ZICALC  10       calc. basis    066550
     C***********          Z-ADDZIAMT     ZIAMT  150       principal      066550
     C***********          Z-ADDZIRATE    ZIRATE 117       rate of intrst 066550
     C***********                                                         066550
     C***To*determine number of days interest to be calculated            066550
     C***********ZIEND     SUB  ZIBEG     ZDAYN1  50                      066550
     C***********                                                         066550
     C****Check*for interest calculation basis                            066550
     C****Use*of*indicators                                               066550
     C*****1-92**2-90  3-91  4-97  5-96  6-95                             066550
     C***********          SETOF                     959697               066550
     C***********ZICALC    COMP 2                    919290               066550
     C**N91******          GOTO ZICAL                                     066550
     C***********ZICALC    COMP 5                    959796               066550
     C***97******ZICALC    COMP 3                    97  91               066550
     C***95******                                                         066550
     C*R*96******          SETOF                     91                   066550
     C**N91******          GOTO ZILPCK                                    066550
     C***********                                                         066550
     C****This*coding will calculate the number of days to use when       066550
     C****using*the 30/360 basis - METHOD 3.                              066550
     C***********          EXSR ZSAVE                                     066550
     C***********          Z-ADDZIBEG     ZDAYNO                          066550
     C***********          EXSR ZDATE2                                    066550
     C***********          MOVE ZDAY      ZISD    20                      066550
     C***********          MOVE ZMTH      ZISM    20                      066550
     C***********          MOVE ZYEAR     ZISY    20                      066550
     C***********          Z-ADDZIEND     ZDAYNO                          066550
     C***********          EXSR ZDATE2                                    066550
     C***********          MOVE ZDAY      ZIFD    20                      066550
     C***********          MOVE ZMTH      ZIFM    20                      066550
     C***********          MOVE ZYEAR     ZIFY    20                      066550
     C***********          EXSR ZRSTOR                                    066550
     C***********          SETOF                     93                   066550
     C****In*order for the finish year to be less than the start year if  066550
     C****ZIEND*is greater than ZIBEG, then the date ZIEND must be in a   066550
     C****different century to ZIBEG. If so add 100 years to it.          066550
     C***********ZIEND     COMP ZIBEG                93                   066550
     C***93******ZIFY      COMP ZISY                   93                 066550
     C***********          Z-ADDZISY      ZISY2   30                      066550
     C**N93******          Z-ADDZIFY      ZIFY2   30                      066550
     C***93******ZIFY      ADD  100       ZIFY2                           066550
     C***********                                                         066550
     C*****Determine whether start year is a leap year and if start       066550
     C*****month*is February.                                             066550
     C***********                                                         066550
     C**N98******          BITOF'0'       ZGLBIT  1                       066550
     C***98******          BITON'0'       ZGLBIT                          066550
     C***********ZISY2     ADD  1900      ZLYCHK  40                      066550
     C***********ZLYCHK    DIV  4         ZLYCHK                          066550
     C***********          MVR            ZLYREM  20                      066550
     C***********ZLYREM    COMP *ZERO                    98*LEAP YEAR     066550
     C***********ZISM      COMP 2                        99*FEBRUARY      066550
     C**N99******30        SUB  ZISD      ZID1    50   93                 066550
     C**N99*93***          Z-ADD0         ZID1                            066550
     C***99N98***28        SUB  ZISD      ZID1                            066550
     C***99*98***29        SUB  ZISD      ZID1                            066550
     C***********ZISM      COMP 12                       93               066550
     C***93******          Z-ADD0         ZISM                            066550
     C***93******ZISY      ADD  1         ZISY                            066550
     C***93******ZISY2     ADD  1         ZISY2                           066550
     C***********                                                         066550
     C*****Determine whether end year is a leap year and is end month     066550
     C*****is*February.                                                   066550
     C***********                                                         066550
     C***********ZIFY2     ADD  1900      ZLYCHK  40                      066550
     C***********ZLYCHK    DIV  4         ZLYCHK                          066550
     C***********          MVR            ZLYREM  20                      066550
     C***********ZLYREM    COMP *ZERO                    98*LEAP YEAR     066550
     C***********ZIFM      COMP 2                        99*FEBRUARY      066550
     C**N99******ZIFD      COMP 31                       93               066550
     C***99N98***ZIFD      COMP 28                       93               066550
     C***99*98***ZIFD      COMP 29                       93               066550
     C***********          SETOF                     98                   066550
     C***********          TESTB'0'       ZGLBIT         98               066550
     C***93******ZID1      ADD  30        ZID1                            066550
     C**N93******ZID1      ADD  ZIFD      ZID1                            066550
     C***********ZIFM      SUB  1         ZIFM                            066550
     C***********ZISY      COMP ZIFY                     93               066550
     C***93******ZIFM      SUB  ZISM      ZINOM   30                      066550
     C***93******          GOTO ZIOUT                                     066550
     C***********12        SUB  ZISM      ZIM1    20                      066550
     C***********          Z-ADD1         ZISM                            066550
     C****Use*enlarged fields that can handle 1999 onwards.               066550
     C***********ZISY2     ADD  1         ZISY2                           066550
     C***********ZIFY2     SUB  ZISY2     ZIY1    20                      066550
     C***********ZIY1      MULT 12        ZIM2    30                      066550
     C***********ZIM2      ADD  ZIFM      ZIM2                            066550
     C***********ZIM1      ADD  ZIM2      ZINOM                           066550
     C***********ZIOUT     TAG                             * ZIOUT TAG *  066550
     C***********ZINOM     MULT 30        ZID2    50                      066550
     C***********ZID2      ADD  ZID1      ZDAYN1                          066550
     C***********          SETOF                     93                   066550
     C***********ZILPCK    TAG                             * ZILPCK TAG * 066550
     C**N96N97***          GOTO ZICAL                                     066550
     C****The*following code applies for methods  4 and 5 only.           066550
     C****1*day*is subtracted from ZDAYN1 for each occurance of 29 FEB    066550
     C****in*the*interest calculation period inclusive of ZIBEG, & ZIEND. 066550
     C***********                                                         066550
     C****Find*no. of 4 year periods between dates                        066550
     C***********ZDAYN1    DIV  1461      ZIMAN   20                      066550
     C***********          MVR            ZIREM   50                      066550
     C****Find*next 29 Feb day no. on or after ZIBEG.                     066550
     C***********ZIBEG     SUB  60        ZIBW1   50                      066550
     C***********ZIBW1     DIV  1461      ZIDW1   20                      066550
     C***********          MVR            ZIDREM  50                      066550
     C***********ZIDREM    COMP 0                        94               066550
     C***94******          Z-ADDZIBEG     ZIDW2   50                      066550
     C***94******          GOTO ZILP1                                     066550
     C****Round*up result.                                                066550
     C***********ZIDW1     ADD  1         ZIDW2                           066550
     C****Calculate next 29 Feb.                                          066550
     C***********ZIDW2     MULT 1461      ZIDW2                           066550
     C***********ZIDW2     ADD  60        ZIDW2                           066550
     C***********ZILP1     TAG                             * ZILP1 TAG *  066550
     C****If*this next 29 Feb. DAYNO - ZIBEG is Gr. Th. or EQ. To         066550
     C*****ZIREM*then add 1 to ZIMAN.                                     066550
     C***********ZIDW2     SUB  ZIBEG     ZILPCP  50                      066550
     C***********ZIREM     COMP ZILPCP               94  94               066550
     C***94******ZIMAN     ADD  1         ZIMAN                           066550
     C****Subtract ZIMAN from ZDAYN1 to give value of ZDAYN1              066550
     C****required for this interest calculation.                         066550
     C***********ZDAYN1    SUB  ZIMAN     ZDAYN1                          066550
     C***********          SETOF                     94                   066550
     C***********ZICAL     TAG                             * ZICAL TAG *  066550
     C***********                                                         066550
     C****Calculate interest                                              066550
     C***90******                                                         066550
     C*R*91******                                                         066550
     C*R*96******ZIAMT     DIV  36000     ZIWRK1 155H                     066550
     C***92******                                                         066550
     C*R*97******ZIAMT     DIV  36500     ZIWRK1    H                     066550
     C***95******ZIAMT     DIV  36600     ZIWRK1    H                     066550
     C***********ZIWRK1    MULT ZIRATE    ZIWRK2 155H                     066550
     C***********ZIWRK2    MULT ZDAYN1    ZINTR  152H      amt. of intrst 066550
     C***********                                                         066550
     C***********          SETOF                     909192               066550
     C***********          SETOF                     959697               066550
     C***********                                                         066550
     C***********          ENDSR                                          066550
     C********************************************************************066550
     C/EJECT
     C********************************************************************
     C**
     C**   ZSAVE SR. TO MEMORISE THE SETTINGS AND TO SET OFF INDICATORS
     C**              90 - 97 BEFORE EXECUTION OF A Z-SUBROUTINE.
     C**
     C**   THIS SR. IS REQUIRED ONLY IF INDICATORS
     C**   90 - 97 ARE USED ELSEWHERE IN A PROGRAM.
     C**
     C           ZSAVE     BEGSR                           *** ZSAVE ***
     C**
     C                     BITOF'01234567'ZBITS   1
     C   90                BITON'0'       ZBITS
     C   91                BITON'1'       ZBITS
     C   92                BITON'2'       ZBITS
     C   93                BITON'3'       ZBITS
     C   94                BITON'4'       ZBITS
     C   95                BITON'5'       ZBITS
     C   96                BITON'6'       ZBITS
     C   97                BITON'7'       ZBITS
     C**
     C                     SETOF                     909192
     C                     SETOF                     939495
     C                     SETOF                     9697
     C**
     C                     ENDSR
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**
     C**   ZDATE2 SR. TO CONVERT A DAY NUMBER TO DATE FORMATS.
     C**
     C**   THE YEAR 2000, BEING DIVISIBLE BY 400, IS A LEAP YEAR.
     C**
     C           ZDATE2    BEGSR                           *** ZDATE2 ***
     C**
     C**   CLEAR LEAP YEAR WORK FIELD.
     C                     MOVE 'N'       ZLEAP   1
     C**
     C**   CLEAR DATE FIELDS.
     C                     Z-ADD0         ZDATE   60
     C                     MOVEL'       ' ZADATE  7
     C**
     C**   CALCULATION TO DEFINE INPUT DAY NUMBER.
     C                     Z-ADDZDAYNO    ZDAYNO  50
     C**
     C**   DETERMINE YEAR NUMBER.
     C**
     C**   ADJUST DAY NUMBER IN CASE LAST DAY OF YEAR.
     C           ZDAYNO    SUB  1         ZDAYN1  50
     C           ZDAYN1    IFLT 0
     C                     GOTO Z2END2
     C                     END
     C**
     C**   CALCULATE NUMBER OF 4 YEAR SPANS SINCE 31/12/1971.
     C           ZDAYN1    DIV  1461      ZLYR    20
     C                     MVR            ZDAYN1           SAVE REMAINING
     C**                                                   DAYS
     C**   CALCULATE NUMBER OF REMAINING YEARS.
     C                     Z-ADD1         ZWRK2   20
     C           Z2TAG1    TAG                             ** Z2TAG1 TAG **
     C           ZDAYN1    IFGE ZYDY,ZWRK2
     C           ZWRK2     ADD  1         ZWRK2
     C                     GOTO Z2TAG1
     C                     END
     C*
     C           ZWRK2     SUB  1         ZWRK2
     C**
     C**   DECREMENT DAY NO. BY DAYS IN REMAINING YEARS.
     C           ZWRK2     IFNE 0
     C           ZDAYN1    SUB  ZYDY,ZWRK2ZDAYN1
     C                     END
     C**
     C**   CALCULATE ACTUAL YEAR NUMBER.
     C           ZLYR      MULT 4         ZWRK3   30
     C           ZWRK3     ADD  72        ZWRK3            BASE IS 1972
     C                     Z-ADDZWRK3     ZYEAR   20
     C           ZYEAR     ADD  ZWRK2     ZYEAR            YEAR
     C**
     C**   DETERMINE MONTH NUMBER.
     C**
     C**   ADJUST DAY NO. IN CASE LAST DAY OF LEAP YEAR FEBRUARY.
     C           ZWRK2     IFEQ 0
     C           ZDAYN1    IFEQ 59
     C                     MOVE 'Y'       ZLEAP
     C                     END
     C           ZDAYN1    IFGE 59
     C           ZDAYN1    SUB  1         ZDAYN1
     C                     END
     C                     END
     C**
     C**   CALCULATE MONTH NUMBER.
     C                     Z-ADD2         ZWRK2
     C           Z2TAG2    TAG                             ** ZDTAG2 TAG *
     C           ZDAYN1    IFGE ZMDY,ZWRK2
     C           ZWRK2     ADD  1         ZWRK2
     C                     GOTO Z2TAG2
     C                     END
     C*
     C           ZWRK2     SUB  1         ZWRK2
     C**
     C                     Z-ADDZWRK2     ZMTH    20       MONTH
     C**
     C**   DETERMINE DAY OF MONTH.
     C**
     C**   ADD BACK LAST DAY OF YEAR ADJUSTMENT.
     C           ZDAYN1    ADD  1         ZDAYN1
     C**
     C**   CALCULATE DAY OF MONTH.
     C           ZDAYN1    SUB  ZMDY,ZWRK2ZDAY    20       DAY
     C**
     C**   ADD BACK LEAP YEAR 29TH FEBUARY ADJUSTMENT, IF REQUIRED.
     C           ZLEAP     IFEQ 'Y'
     C           ZDAY      ADD  1         ZDAY
     C                     END
     C**
     C**   FORMAT DATE, DDMMYY OR MMDDYY.
     C  N98                MOVELZDAY      ZWRK4   40
     C   98                MOVE ZDAY      ZWRK4
     C  N98                MOVE ZMTH      ZWRK4
     C   98                MOVELZMTH      ZWRK4
     C                     MOVELZWRK4     ZDATE
     C                     MOVE ZYEAR     ZDATE
     C**
     C**   FORMAT ALPHA DATE, DDMMMYY.
     C                     MOVELZDAY      ZWRK5   5
     C           ZDAY      IFLT 10
     C                     MOVEL' '       ZWRK5
     C                     END
     C                     MOVE ZMNM,ZMTH ZWRK5
     C                     MOVELZWRK5     ZADATE
     C                     MOVE ZYEAR     ZADATE
     C**
     C           Z2END2    ENDSR                           * ZDEND2 ENDSR*
     C**
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C*
     C*    ZRSTOR SR. To restore indicators 90 - 97 to the settings
     C*               they had before the execution of SR. ZSAVE.
      *****************************************************************
     C*
     C           ZRSTOR    BEGSR                           *** ZRSTOR ***
     C*
     C                     TESTB'0'       ZBITS          90
     C                     TESTB'1'       ZBITS          91
     C                     TESTB'2'       ZBITS          92
     C                     TESTB'3'       ZBITS          93
     C                     TESTB'4'       ZBITS          94
     C                     TESTB'5'       ZBITS          95
     C                     TESTB'6'       ZBITS          96
     C                     TESTB'7'       ZBITS          97
     C*
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *   INIT - inital process                                       *
      *   Called by - main process                                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           INIT      BEGSR
      *
     C                     MOVEACPY@      BIS@   80
      *
      **  Set up LDA
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVEL'MG0350'  DBPGM
     C                     MOVE *BLANKS   DBASE
     C                     OUT  LDA
      *
      **  Access SDBANKPD for report title
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** If program ended in error.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '001'     DBASE              * * * * * * *
     C                     MOVEL'FIRST'   DBKEY              * DBERR 001 *
     C                     MOVEL'SDBANKPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C* Correctly work out Date Format                                    066600
     C*                                                                   066600
     C           BJDFIN    COMP 'M'                      98MMDDYY,*98*ON  066600
      *
      **  Access SDTRADPD for trading information
      *
     C                     CALL 'AOTRADR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDTRAD    PARM SDTRAD    DSFDY
      *
      ** If program ended in error.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '002'     DBASE              * * * * * * *
     C                     MOVEL'FIRST'   DBKEY              * DBERR 002 *
     C                     MOVEL'SDTRADPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Access SDMMODPD for modules available
      *
     C                     CALL 'AOMMODR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
      ** If program ended in error.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '003'     DBASE              * * * * * * *
     C                     MOVEL'FIRST'   DBKEY              * DBERR 003 *
     C                     MOVEL'SDMMODPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Access SDMGMEPD for message management data.
      *
     C                     CALL 'AOMGMER0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C           SDMGME    PARM SDMGME    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '026'     DBASE            * * * * * * * *
     C                     MOVEL'FIRST'   DBKEY            *  DBERR 026  *
     C                     MOVEL'SDMGMEPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Initialise constant fields
      *
     C                     MOVE *LOVAL    CR      1
     C                     BITON'457'     CR
     C                     MOVE *LOVAL    LF      1
     C                     BITON'257'     LF
     C                     MOVELCR        CRLF    2
     C                     MOVE LF        CRLF
     C                     MOVE ':'       COLON1
     C                     MOVE ':'       COLON2
      *
      **  CRLF Control Character for message data records
      *
     C                     MOVE CRLF      CTRC
      *
      **  Convert run date to YYMMDD, for Message Generation Date
      *
     C                     CALL 'ZM0060'               15
     C                     PARM BJRDNB    ZMDAY   50
     C                     PARM           ZSDATE  6
      *
      ** If program ended in error.(Program not found.)
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '004'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 004 *
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Format message generation date.
      *
     C                     MOVE ZSDATE    MGDE
      *                                                                   113352
      ** Set-up Message Generation  Century flag                          113352
      *                                                                   113352
     C                     MOVELMGDE      YY      20                      113352
     C           YY        IFLT 72                                        113352
     C                     MOVE '2'       CIND                            113352
     C                     ELSE                                           113352
     C                     MOVE '1'       CIND                            113352
     C                     ENDIF                                          113352
      *
      **  Convert history retention date to YYMMDD
      *
     C           BJRDNB    ADD  ENDSMN    ZMDAY
     C                     CALL 'ZM0060'               15
     C                     PARM           ZMDAY
     C                     PARM           ZSDATE
      *
      ** If program ended in error.(Program not found.)
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '006'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 006 *
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     MOVE ZSDATE    @HRDT   6
      *                                                                   137909
      **  Access Switchable Features file for CEU003                      137909
      *                                                                   137909
     C                     CALL 'AOSARDR0'                                137909
     C                     PARM *BLANKS   @RTCD                           137909
     C                     PARM '*VERIFY' @OPTN                           137909
     C                     PARM 'CEU003'  @SARD   6                       137909
     C           @RTCD     IFEQ *BLANKS                                   137909
     C                     MOVEL'Y'       CEU003  1                       137909
     C                     ELSE                                           137909
     C                     MOVEL'N'       CEU003                          137909
     C                     ENDIF                                          137909
      *                                                                   CSW200
      **  Check if SWIFT Changes 2000 (CSW200) is installed               CSW200
      *                                                                   CSW200
     C                     CALL 'SWIF2000'                                CSW200
     C                     PARM *BLANKS   @RTCD   7                       CSW200
      *                                                                   CSW200
     C           @RTCD     IFEQ 'CSW200'                                  CSW200
     C                     MOVE 'Y'       CSW200  1                       CSW200
     C                     ELSE                                           CSW200
     C                     MOVE 'N'       CSW200                          CSW200
     C                     ENDIF                                          CSW200
      *                                                                                       CSW201
      ** Check if switchable feature CSW024 is switched on                                    CSW024
     C                     CALL 'AOSARDR0'                                                    CSW024
     C                     PARM *BLANKS   @RTCD                                               CSW024
     C                     PARM '*VERIFY' @OPTN                                               CSW024
     C                     PARM 'CSW024'  @SARD                                               CSW024
     C           SCSARD    PARM SCSARD    DSFDY                                               CSW024
      *                                                                                       CSW024
     C           @RTCD     IFNE *BLANK                                                        CSW024
     C           @RTCD     ANDNE'*NRF   '                                                     CSW024
     C           *LOCK     IN   LDA                                                           CSW024
     C                     MOVEL'SCSARDPD'DBFILE           ************                       CSW024
     C                     MOVEL'CSW024'  DBKEY            * DBERR 38 *                       CSW024
     C                     MOVEL'038'     DBASE            ************                       CSW024
     C                     OUT  LDA                                                           CSW024
     C                     EXSR *PSSR                                                         CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW024
     C           @RTCD     IFEQ *BLANK                                                        CSW024
     C                     MOVE 'Y'       CSW024  1                                           CSW024
     C                     ELSE                                                               CSW024
     C                     MOVE 'N'       CSW024                                              CSW024
     C                     ENDIF                                                              CSW024
      *                                                                                       CSW024
      **  Access Switchable Features file for CSW201                                          CSW201
      *                                                                                       CSW201
     C                     CALL 'SWIF2001'                                                    CSW201
     C                     PARM *BLANKS   @RTCD                                               CSW201
      *                                                                                       CSW201
     C           @RTCD     IFEQ 'CSW2001'                                                     CSW201
     C                     MOVE 'Y'       CSW201  1                                           CSW201
     C                     ELSE                                                               CSW201
     C                     MOVE 'N'       CSW201                                              CSW201
     C                     ENDIF                                                              CSW201
      *                                                                                       CSW216
      ** Access Switchable Features file for CSW216                                           CSW216
      *                                                                                       CSW216
     C                     CALL 'SWIF2016'                                                    CSW216
     C                     PARM *BLANKS   @RTCD                                               CSW216
      *                                                                                       CSW216
     C           @RTCD     IFEQ 'CSW2016'                                                     CSW216
     C                     MOVE 'Y'       CSW216  1                                           CSW216
     C                     ELSE                                                               CSW216
     C                     MOVE 'N'       CSW216                                              CSW216
     C                     ENDIF                                                              CSW216
      *                                                                                       CSD015
      ** Check if CSD015 is enabled.                                                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD   7                                           CSD015
     C                     PARM '*VERIFY' POPTN   7                                           CSD015
     C                     PARM 'CSD015'  PSARN   6                                           CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSD015  1                                           CSD015
     C                     MOVEL'N'       W1EWLC                                              222385
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSD015                                              CSD015
      *                                                                                       222385
      ** Access AOWLCCR0 to check if function code MESSGENT is available                      222385
      *                                                                                       222385
     C                     CALL 'AOWLCCR0'                                                    222385
     C                     PARM *BLANKS   PRTCD                                               222385
     C                     PARM '*KEY'    POPTN                                               222385
     C                     PARM 'MESSGENT'PFUNC   8                                           222385
     C           SDWLCC    PARM SDWLCC    DSFDY                                               222385
      *                                                                                       222385
     C           PRTCD     IFNE *BLANKS                                                       222385
     C           PRTCD     ANDNE'*NRF'                                                        222385
     C                     MOVEL'SDWLCCPD'DBFILE                                              222385
     C                     MOVELPFUNC     DBKEY                                               222385
     C                     Z-ADD32        DBASE                                               222385
     C                     EXSR *PSSR                                                         222385
     C                     ENDIF                                                              222385
      *                                                                                       222385
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE '*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVELPSARN     DBKEY                                               CSD015
     C                     Z-ADD42        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if CSW025 is enabled.                                                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD                                               CSD015
     C                     PARM '*VERIFY' POPTN                                               CSD015
     C                     PARM 'CSW025'  PSARN                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       CSW025  1                                           CSD015
     C           PRTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSW025                                              CSD015
     C                     ELSE                                                               CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE '*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     MOVELPSARN     DBKEY                                               CSD015
     C                     Z-ADD43        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      *                                                                                    CDL096I01
      ** Check if CDL096 is enabled.                                                       CDL096I01
      *                                                                                    CDL096I01
     C                     CALL 'AOSARDR0'                                                 CDL096I01
     C                     PARM *BLANKS   PRTCD                                            CDL096I01
     C                     PARM '*VERIFY' POPTN                                            CDL096I01
     C                     PARM 'CDL096'  PSARN                                            CDL096I01
     C           SCSARD    PARM SCSARD    DSFDY                                            CDL096I01
      *                                                                                    CDL096I01
     C                     MOVE 'N'       CDL096  1                                        CDL096I01
     C           PRTCD     IFEQ *BLANKS                                                    CDL096I01
     C                     MOVE 'Y'       CDL096                                           CDL096I01
     C                     ELSE                                                            CDL096I01
      *                                                                                    CDL096I01
     C           PRTCD     IFNE '*NRF   '                                                  CDL096I01
     C           *LOCK     IN   LDA                                                        CDL096I01
     C                     MOVEL'SCSARDPD'DBFILE                                           CDL096I01
     C                     MOVELPSARN     DBKEY                                            CDL096I01
     C                     Z-ADD96        DBASE                                            CDL096I01
     C                     OUT  LDA                                                        CDL096I01
     C                     EXSR *PSSR                                                      CDL096I01
     C                     ENDIF                                                           CDL096I01
      *                                                                                    CDL096I01
     C                     ENDIF                                                           CDL096I01
      *                                                                                    CDL096I01
     C/COPY WNCPYSRC,MG0350C003
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   *PSSR - error handling                                      *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
      **  Write database error to report
      *
     C                     OPEN MG0350AU
     C                     WRITEHEAD
     C                     WRITEDBERROR
      *
     C                     SETON                     U7U8LR
     C                     DUMP
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************                       CSD015
     C/EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
      *                                                               *                       CSD015
      *  SRWTCH - Initiates the Midas Watch List Checking Engine.     *                       CSD015
      *                                                               *                       CSD015
      *****************************************************************                       CSD015
     C           SRWTCH    BEGSR                                                              CSD015
      *                                                                                       CSD015
      ** Check if the message is for automatic release.                                       CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       PARLS                                               CSD015
      *                                                                                       CSD015
     C           MGST      IFEQ 'RSND'                                                        CSD015
     C           NWRK      IFEQ 'SWIFT '                                                      CSD015
     C           NWRK      OREQ 'TELEX '                                                      CSD015
     C           NWRK      OREQ 'STTX  '                                                      CSD015
     C                     MOVE 'CRTD'    MGST                                                CSD015
     C                     MOVE 'Y'       PARLS   1                                           CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Initialise the Transaction Details parameter.                                        CSD015
      *                                                                                       CSD015
     C                     CLEARWLTDS                                                         CSD015
     C                     Z-ADD*ZERO     W4VDAT                                              CSD015
     C                     Z-ADD*ZERO     W4MDAT                                              CSD015
     C                     Z-ADD*ZERO     W4AMT1                                              CSD015
     C                     Z-ADD*ZERO     W4AMT2                                              CSD015
      *                                                                                       CSD015
     C                     MOVELTRNO      W4IDEN                                              CSD015
     C                     MOVELMTPY      W4ITEM                                              CSD015
     C                     MOVEL'MGOREF  'W4FUNT                                              CSD015
     C                     MOVELMGBRCA    W4BRCH                                              CSD015
     C                     MOVELDECN      W4CNUM                                              CSD015
     C                     Z-ADDBJRDNB    W4DDAT                                              CSD015
     C                     MOVELPARLS     W4ARLS                                              CSD015
      *                                                                                       CSD015
      ***Send*the*Transaction Details to the Compliance Engine.                        CSD015 221145
      *********************                                                            CSD015 221145
     C*********************CALL 'SDWLCLOP'                                             CSD015 221145
     C*********************PARM           WLTDS                                        CSD015 221145
     C*********************PARM *BLANKS   PSTRNG                                       CSD015 221145
      *                                                                                       CSD015
     C                     ENDSR                                                              CSD015
      *****************************************************************                       CSD015
     C/EJECT
      *****************************************************************                       221145
      *                                                               *                       221145
      *  WLCDQ - Submit information to Watch List Check Dtaq          *                       221145
      *                                                               *                       221145
      *****************************************************************                       221145
      *                                                                                       221145
     C           WLCDQ     BEGSR                                                              221145
      *                                                                                       221145
      *  Send transaction to compliance engine program                                        221145
      *                                                                                       221145
     C                     CALL 'SDWLCLOP'                                                    221145
     C                     PARM           WLTDS                                               221145
     C                     PARM *BLANKS   PSTRNG                                              221145
      *                                                                                       221145
      *                                                                                       221145
     C                     ENDSR                                                              221145
      *                                                                                       221145
      *****************************************************************                       221145
      *
      /EJECT                                                              066550
     C/COPY ZSRSRC,ZINTDYZ2                                               066550
      /EJECT                                                              066550
     C/COPY ZSRSRC,ZDATE9Z3                                               066550
      /EJECT                                                              066550
     C/COPY ZSRSRC,ZDAT10Z2                                               126017
     C/EJECT                                                              126017
     C/COPY ZSRSRC,GLINTCZ1                                               066550
      /EJECT                                                              066550
     C/COPY WNCPYSRC,MG0350C008
      /COPY MGCPYSRC,SWIFTTRANS                                           BLI605
** CPY@   Object Copyright
(c) Misys International Banking Systems Ltd. 2001
     X/COPY WNCPYSRC,MG0350X001
** MSGA   Messages
Settlement - pay
Customer details not found on SDCUSTPD
ZM0040 (format ccy and amount) call ended in error
Duplicate TRN key built for this message
ZM0050 (format SWIFT address) call ended in error
Nostro customer not found on SDNOSTPD
** TABNST - Codes indicating settlement via nostro
01
02
07
08
12
** TABINT - Codes indicating settlement via internal
03
04
05
06
14
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES                                            S01237
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC                                      S01237
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
