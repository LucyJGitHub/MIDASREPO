     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MG Message cancellation processing')             *
     F*****************************************************************
     F*                                                               *
     F*  Midas - MESSAGE GENERATION                                   *
     F*                                                               *
     F*  MG9210 - MESSAGE CANCELLATION PROCESSING.                    *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. MD052168           Date 22Nov18               *      
      *  Prev Amend No. CLE141             Date 08Feb16               *
      *                 CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CSW212             Date 03May12               *
      *                 CRE073             Date 06Dec10               *
      *                 CLE143             Date 06Dec10               *
      *                 CLE139             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER054             Date 07Apr09               *
      *                 CER048             Date 19May08               *
      *                 CER020             Date 19May08               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 CAS016             Date 28Feb06               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CDL049             Date 07Jul06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE042             Date 06Sep05               *
      *                 CDL038             Date 10May05               *
      *                 CAS009             Date 16May05               *
      *                 CSW037A            Date 02May05               *
      *                 CAS008             Date 16Jun04               *
      *                 BUG5646            Date 17Feb05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CAP074             Date 08Aug02               *
      *                 222385             Date 23Oct03               *
      *                 221145             Date 08Sep03               *
      *                 217684             Date 12May03               *
      *                 CAS006             Date 21Jan03               *
      *                 CAS005             Date 16Dec02               *
      *                 CSD015             Date 14Oct02               *
      *                 CLE028             Date 27Jun02               *
      *                 CAS004             Date 26Jun02               *
      * Midas Release 4.01.03 ----------------------------------------*
      *                 210851             Date 07Jan03               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 209250             Date 25Oct02               *
      *                 209555             Date 07Oct02               *
      *                 208030             Date 01Aug02               *
      *                 204452             Date 03May02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CAP056             Date 13Mar02               *
      *                 CIR008             Date 13Mar02               *
      *                 186066             Date 27Nov01               *
      *                 195527             Date 15Aug01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CLE011             Date 07Nov00               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSE023             Date 12Jul00               *
      *                 CFT013             Date 16Apr99               *
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.03 -----------------------------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSW097             Date 02Dec99               *
      *                 117956             Date 06Oct99               *
      *                 CLE009             Date 26Apr99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 155932             Date 25Feb99               *
      *                 141572             DATE 21SEP98               *
     F*                 140165             DATE 07AUG98               *
     F*                 113352             DATE 13FEB97               *
     F*                 111009             DATE 28NOV96               *
     F*                 115266             DATE 30OCT97               *   E32333
      *                 CLE007             Date 22May97               *
     F*                 CDL002             DATE 17SEP97               *
     F*                 S01408             DATE 14NOV96               *
     F*                 093047             DATE 13SEP95               *
     F*                 CSW095             DATE 10APR95               *
     F*                 077553             DATE 20DEC94               *
     F*                 059061             DATE 02JUN94               *
     F*                 052254             DATE 10JAN94               *
     F*                 058491             DATE 07JAN94               *
     F*                 043907             DATE 07JAN94               *
     F*                 S01453             DATE 14DEC93               *
     F*                 S01412             DATE 07MAY93               *
     F*                 E40242             DATE 25JUN92               *
     F*                 S01386             DATE 18MAY92               *
     F*                 E34539             DATE 21JAN92               *
     F*                 E33587             DATE 18DEC91               *
     F*                 E32333             DATE 27NOV91               *
     F*                 E31532             DATE 08NOV91               *
     F*                 E29592             DATE 25OCT91               *
     F*                 E30475             DATE 24OCT91               *
     F*                                                               *
     F*****************************************************************
      *                                                               *
      *  MD052168 - Use of UETR in MT292/MT192 messages.              *
      *             Applied for MD-52369.                             *
      *  CLE141 - Currency and Location Business Day Convention       *
      *           (Recompile)                                         *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CLE134 - Past Due Call Loan Processing (Recompile)           *
      *  CLE148 - Alpha Loan Reference                                *
      *  CSW212 - SWIFT 2012 Changes (Recompile)                      *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CLE143 - Original Loan Contract Date & Effective Interest    *
      *           Rate (Recompile)                                    *
      *  CLE139 - Lending Fee Capitalisation (Recompile)              *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER054 - German Features - Church Tax (Recompile)            *
      *  CER048 - German Features - Taxes (Recompile)                 *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus (Recompile)                              *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  CAS016 - IAS18 EIR Recalculation (Fee Amortisation Over      *
      *           Whole Period) -Recompile.                           *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE042 - Extended Loan Sub Type (Recompile)                  *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CAS009 - EIR/AC Accounting (Recompile)                       *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CAS008 - IAS 39 Enhancements (Recompile)                     *
      *  BUG5646- Cancellation not done in MMM when deal is amended   *
      *           to non Swift settlement.                            *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CAP074 - Lending API enhancements - Loans input.             *
      *  222385 - SWIFT msgs are Watch List checked regardless of     *
      *           configuration file setting                          *
      *  221145 - Compliance Watch WLC: Move compliance check to      *
      *           after COMIT to MGOMSGPD                             *
      *  217684 - Authorisation User Malfunction (Recompile)          *
      *  CAS006 - Hedge Accounting Phase B                            *
      *  CAS005 - Enhancements to CAS001, CAS002 and CAS004           *
      *           (Recompile)                                         *
      *  CSD015 - Midas Compliance Watch - Watch List Checking        *
      *  CLE028 - Flat Rate Personal Loans (Rule of 78s)              *
      *           (Recompile)                                         *
      *  CAS004 - Hedge Accounting Phase A (Recompile)                *
      *  210851 - Duplicate MT292 messages created. Partially applied *
      *           fix 211307.                                         *
      *  209250 - Deletions not sending cancellation to MMM           *
      *  209555 - MTRN not written on cancellation message            *
      *  208030 - Amend 195527 to cater for multiple messages.        *
      *  204452 - Recompiled due to changed PF/LEFEED.                *
      *  CAP056 - Automatic Authorisation of Interface deals          *
      *           (Recompile)                                         *
      *  CIR008 - FRA/IRS Deals Authorisation (Recompile)             *
      *  186066 - Allow cancellation or deletion processing for fees  *
      *           which have been reversed or whose settlement method *
      *           has been amended from 08 to 01. Amend program to    *
      *           correcly generate TRNO of new MT202 used to convert *
      *           existing MT203. Also, amend program to use DLNRF as *
      *           key to access CLOAN record of fees based on loans.  *
      *  195527 - :103: should appear in block 3                      *
      *  CLE011 - Rate Fixing Days for Lending Rollover Processing    *
      *           Recompile                                           *
      *  CSE023 - Treaty Withholding Tax (Recompiled)                 *
      *  CFT013 - Allow deletion of MT103s                            *
      *  CDL008 - Continuous Linked Settlement                        *
      *  CSW097 - SWIFT 97 changes to MT340s and MT360s               *
      *           generation                                          *
      *  117956 - Check default status released details for customer  *
      *           for cancellation messages                           *
     F*  CLE009 - LE I/C Swift Message Generation for Fees            *
     F*           Modify Transaction Number Specification             *
      *  155932 - Previous fix E30475 inserts f-spec in wrong place   *
      *           causing loss of commitment control on mgorefl0.     *
     F*  141572 - Recompile over MGOREFPD                             *
     F*  140165 - Convert SVDT to DDMMYY before calling subroutine    *
     F*           ZDATE1 to convert it to midas day number.           *
     F*  113352 - Set-up CIND (Century flag)  to correct year2000     *
     F*           display problem.                                    *
     F*  111009 - Replace YYMMDD date comparison with MIDAS date      *
     F*           comparison for year 2000 processing                 *
     F*  115266 - Produce MT392 messages for network 'PAPER' (in      *
     F*           addition to network 'SWIFT') to avoid duplicates    *
     F*           on TRAM when a deal is amended.                     *
     F*  CLE007 - Customer Lending Enhancements - Others (T3)         *
     F*  CDL002 - FX Netting                                          *
     F*  S01408 - Addition of core hook MG9210EEP1                    *
     F*         - Addition of core hook MG9210CCP3                    *
     F*         - Addition of core hook MG9210CCP2                    *
     F*         - Addition of core hook MG9210CCP1                    *
     F*         - Addition of core hook MG9210X001                    *
     F*  093047 - OVRDBF DEALS BEFORE OPENING FOR UPDATE - IT IS      *
     F*           OPENED FOR INPUT IN DL6310.                         *
     F*  CSW095 - S.W.I.F.T 1995 Message Changes.                     *
     F*           Ensure that the MTn92 generate does not exceed      *
     F*           2,000 characters.                                   *
     F*  077553 - Should MOVEL not MOVE into NWRK                     *
     F*  059061 - Amendments not Cancelling for Confirmations         *
     F*  052254 - RECOMPILED as CURRENT FACTOR amended from 9,8       *
     F*           to 10,9                                             *
     F*  058491 - Open TRADS only if required.                        *
     F*  043907 - Ensure that part deleted flag is blank.             *
     F*  S01453 - MARGIN AND FX POSITIONS/POINTS AND BASE CURRENCY    *
     F*           POSITIONS/POINTS ADDED TO FX INPUT (RECOMPILED)     *
     F*  S01412 - FIELD :11: CHANGED TO :11S: IN SR CANCEL            *
     F*  E40242 - RE-COMPILED FOR CHANGE TO ASEQ                      *
     F*  S01386 - MG/SE AMENDMENTS                                    *
     F*           o Add trades file (LF/TRADS)                        *
     F*  E34539 - MTn92's N'ACK due to blanks being inserted          *
     F*           before the message field data (MFLD). This was      *
     F*           caused by message field tag (MTAG), being blank     *
     F*  E33587 - SWIFT RULES HAVE CHANGED                            *
     F*           o Field 79 content rules have been tightened.       *
     F*  E32333 - NO MT292 MESSAGES SHOULD BE CREATED FOR MESSAGES    *
     F*           PRIOR TO VALUE DATE.                                *
     F*  E31532 - SPACE BETWEEN FIELD TAG (:21:) AND FIELD DATA FOR   *
     F*           MT292 WHEN TAKING COPY OF ORIGINAL MESSAGE          *
     F*           CAUSED MT292 TO BE NAK'D.                           *
     F*  E29592 - MTN92 MESSAGES WERE BEING PRODUCED FOR PART         *
     F*           DELETED MESSAGES OF A SENT MULTIPLE MESSAGE.        *
     F*  E30475 - FIELD :11: (MESSAGE TYPE AND DATE) SHOULD BE ON     *
     F*           TWO LINES, NOT ONE.                                 *
     F*                                                               *
     F*****************************************************************
     F/COPY WNCPYSRC,MG9210F001
     FMGOREFL0UF  E           K        DISK
     F            MGOREFD0                          KRENAMEMGREFL0
     F***MGOREFL1IF  F     406 16AI     9 DISK                      E30475155932
     F                                              KCOMIT
     FMGOREFL1IF  F     406 16AI     9 DISK                               155932
     FMGOMSGPDUF  E           K        DISK                      A
     F                                              KCOMIT
     FDEALS   UF  E           K        DISK                           UC
     F                                              KCOMIT
     FCLOAN   UF  E           K        DISK                           UC
     F                                              KCOMIT
     F*****TRADS   UF  E           K        DISK
     F*****                                         KCOMIT
     F***TRADS***UF**E           K        DISK                     S01386 058491
     FTRADS   UF  E           K        DISK                           UC  058491
     F                                              KCOMIT                S01386
     FLEFEEDL1UF  E           K        DISK                           UC  CLE007
     F                                              KCOMIT                CLE007
     FMGOREFPDO   E                    DISK
     F                                              KCOMIT
     FFXNETML4UF  E           K        DISK                           UC  CDL002
     F                                              KCOMIT                CDL002
      ********************************************************************
      *
      * ID C  F  H  L    FUNCTION OF INDICATORS
      *
      *    05            Error on write to PF/MGOREFPD.
      *    06            Error on write to PF/MGOMSGPD.
      *    07            Error on chain to LF/DEALS.
      *    08            Error on chain to LF/CLOAN.
      *****09*****       Error on chain to LF/TRADS.
      *    09            Error on chain to LF/TRADS.                      S01386
      *    10            Error on chain to PF/MGOMSGPD.
      *    11            Error on chain to PF/MGOREFL0.
      *    12            End of file on PF/MGOMSGPD.
      *    14            Msg. required is an MTn92.
      *    15            Error in standard program.
      *    16            Field 22 found in message.
      *    20            MTn92 messages not produced.
      *    21            MTn9* messages not produced.
      *    22            MTn** messages not produced.
      *    23            MT*92 messages not produced.
      *    24            SWIFT VALUE DATE < MIDAS RUN DATE                E32333
      *   25  - Chain to LEFEEDL1                                     *   CLE007
      *    50            Work flag for default status release             117956
      *    U7U8          Database error.
      *
     F********************************************************************
      *                                                                   S01408
     E/COPY WNCPYSRC,MG9210EEP1                                           S01408
      *                                                                   S01408
     E                    CPY@    1   1 80               copyright
     E                    GNR        15  3               msg type not gen.
     E                    DSR        15  3               msg dflt sts rls.117956
     E                    @WRK       50  1               work array
     E/COPY WNCPYSRC,MG9210E001
     E***********         CAN     1   4  3               cancelatn. msgs. CDL008
     E***********         CAN     1   5  3               cancelatn.CDL008 CFT013
     E                    CAN     1   6  3                                CFT013
     E/COPY WNCPYSRC,MG9210E002
     E                    CMD     1   1 80               COMMANDS         093047
     E/COPY ZSRSRC,ZDATE1Z1                                               111009
      *
     E********************************************************************
      *                                                                                       CAS006
      ** Rename Credit Risk Spread Field                                                      CAS006
      *                                                                                       CAS006
     ITRADSDF                                                                                 CAS006
     I              CRSK                            ASCRSK                                    CAS006
      *
     IMGOREFL1NS                                                          E30475
     I                                        9  24 TRNHDR                E30475
     I                                      208 214 RELD                  E30475
      *                                                                   CLE007
      *                                                                   E30475
      ** Rename fields to avoid override.                                 CLE007
      *                                                                   CLE007
     ILEFEEDF                                                             CLE007
     I              LSWS                            FLSWS                 CLE007
     ICLOANCKF                                                            CLE007
     I              NLRA                            KNLRA                 CLE007
      *                                                                   CDL002
     IFXNETMD0                                                            CDL002
     I              AMLSWC                          LSWC                  CDL002
     I              AMLSWS                          LSWS                  CDL002
      *                                                                   CLE007
      *                                                                   CDL002
      ** Parse the transaction number                                     CLE007
      *                                                                   CLE007
     I            DS                                                      CLE007
     I                                        1  16 WTNUM                 CLE007
     I*********************                   1   60DCNUM           CLE007CLE009
     I*********************                   7   7 DFIND           CLE007CLE009
     I                                        1   1 DFIND                 CLE009
     I**********                              2   70DCNUM                              CLE009 CSD027
     I                                        2   7 DCNUM                                     CSD027
     I                                        8  12 DFACL                 CLE007
     I                                       13  140DFFSQ                 CLE009
     I*********************                   7  12 DLNRF           CLE007CLE009
     I*********************                  13  140DFSEQ           CLE007CLE009
     I                                        2   7 DLNRF                 CLE009
     I                                        8   90DLFSQ                 CLE009
     I**********                             10  14 DBLNK                              CLE009 186066
     I                                       12  16 DBLNK                                     186066
      *                                                                   CLE007
      ** LEFEEDL1 Key                                                     CLE007
      *                                                                   CLE007
     I            DS                                                      CLE007
     I**********                              1   60WCNUM                              CLE007 CSD027
     I                                        1   6 WCNUM                                     CSD027
     I                                        7  110WFACL                 CLE007
     I**********                             12  170WLNRF                              CLE007 CLE148
     I                                       12  17 WLNRF                                     CLE148
     I                                       18  190WFSEQ                 CLE007
     I                                        1  19 DSFEE                 CLE007
      *                                                                   E30475
     IMULT        DS                         95
     I                                        1   5 @MTAG
     I                                        6  55 @MFLD
      **  Multiple occurrence data structure for message
      *
     IMSG         DS                         50
     I                                        1   5 MTAG
     I                                        5  55 MFLD1                 E31532
     I                                        6  55 MFLD2                 E31532
     I                                        5   5 CHTAG                 E31532
     I                                        1  50 MFLD3                 E34539
     I*********************                   6  55 MFLD                  E31532
      **  Data structure to hold the original message fields.
      **  If MTAG only 4 characters then CHTAG will be blank; hence
      **  transpose MFLD into MFLD1 to remove the blank character.
      *
     ISDBANK    E DSSDBANKPD
      **  External Data structure for bank details.
      *
     ISDCUST    E DSSDCUSTPD
      **  External Data structure for customer details.
      *
     ISCSARD    E DSSCSARDPD                                              CLE007
      ** Switchable Features File                                         CLE007
      *                                                                   CLE007
     IDSFDY     E DSDSFDY
      **  Short data structure for access programs
      *
     IDSSDY     E DSDSSDY
      **  Long data structure for access programs
      *
     IWLTDS     E DSSDWLTOPD                                                                  CSD015
      ** DS For Watch List Transaction Details File                                           CSD015
      *                                                                                       CSD015
     IPSTRNG      DS                           9999                                           CSD015
      *                                                                                       CSD015
     ISDWLCC    E DSSDWLCCPD                                                                  222385
      ** Watch list checking details                                                          222385
      *                                                                                       222385
     ILDA         DS                            256
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
      **  Local data area
      *
     C/EJECT
      *****************************************************************
      *                   Index to subroutines                        *
      *   main process                                                *
      *   VALID  - Check if Cancellation Messages are valid for       *
      *            destination customer.                              *
      *   CANCEL - Cancellation Messages (MTn92).                     *
      *   MSGCAN - Cancel part of a multiple message.                 *
      *   SINGLE - Cancel a single Message.                           *
      *   TRAN   - Retreive msg. sequence from transaction file.      *
      *   TYPE   - Determine the type of message being cancelled.     *
      *   FILL   - Write the original message to a D.S as new field 79*
      *   WREF   - Write o/p reference to PF/MGOREFPD.                *
      *   OMSG   - Output a message to PF/MGOMSGPD.                   *
      *   INIT   - Initial Process.                                   *
      *   *PSSR  - Error Handling.                                    *
      *                                                               *
      *   NOTE:   A multiple occurrence data structure is used to     *
      *           store up the records that make up the SWIFT message *
      *           before writing the whole message to file.           *
      *           To store the records of the message, you must       *
      *           first access an OCUR record, obtain the Message Tag *
      *           & Message field data values for this OCUR record,   *
      *           then go on to the next OCUR record and continue     *
      *           this process until the SWIFT message is complete.   *
      *                                                               *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *   MAIN - main process                                         *
      *   Called by - none                                            *
      *   Calls - INIT Initial Process.                               *
      *           VALID Are cancellation msgs are valid for dest. cust*
      *           CANCEL Cancellation messages processing.            *
      *****************************************************************
      *
      ** Parameters passed to the program by the calling program.
      ** @TNUM is the transaction reference number of the message
      ** being cancelled.
      ** @MODI is the calling module id.
      ** @RTNC is used to inform the calling program of an error.
      *
     C           *ENTRY    PLIST
     C                     PARM           @TNUM  16
     C                     PARM           @MODI   2
     C                     PARM           @RTNC   1
      *
      ** Initial process
      *
     C                     EXSR INIT
      *
      ** Access LF/MGOREFL0 with the TRN parameter to access the
      ** cancelled message.
      *
     C           @TNUM     CHAINMGOREFL0             11
      *
      ** If no record of the message is not found.
      *
     C           *IN11     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '001'     DBASE              * * * * * * *
     C                     MOVEL@TNUM     DBKEY              * DBERR 001 *
     C                     MOVEL'MGOREFL0'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *                                                                   CDL008
      ** If CDL008 is installed, save message type and status.            CDL008
      *                                                                   CDL008
     C           CDL008    IFEQ 'Y'                                       CDL008
     C                     MOVE MTPY      WMTPY   3                       CDL008
     C                     MOVE MGST      WMGST   4                       CDL008
     C                     ENDIF                                          CDL008
      *
      ** Only proceed with the processing if cancellation requested
      ** flag for the message is not 'Y'.
      *
     C           CARQ      IFNE 'Y'
     C/COPY WNCPYSRC,MG9210C009
      *
      ** Valid message types that produce cancellation messages
      ** (MTn92) are '100','202','203' and '210'.
      ** and '103'.                                                       CFT013
      *
     C           MTPY      LOKUPCAN                      14
      *                                                                   S01408
     C********** CSW025    IFEQ 'Y'                                                   209250 BUG5646
     C**********           SETOF                     14                               209250 BUG5646
     C**********           END                                                        209250 BUG5646
      *                                                                                       209250
     C/COPY WNCPYSRC,MG9210CCP1                                           S01408
      *                                                                   S01408
     C*                                                                   059061
     C** Also include cancellations for confirmations, and change         059061
     C** to network of paper (non swift).                                 059061
     C*                                                                   059061
     C                     MOVELMTPY      #MTPY1  1                       059061
     C           *IN14     IFEQ *OFF                                      059061
     C           NWRK      ANDEQ'SWIFT '                                  059061
     C           #MTPY1    ANDEQ'3'                                       059061
     C           *IN14     OREQ *OFF                                      115266
     C           NWRK      ANDEQ'PAPER '                                  115266
     C           #MTPY1    ANDEQ'3'                                       115266
     C                     MOVE *ON       *IN14                           059061
     C                     END                                            059061
      *
      ** Determine if a cancellation message is valid for the
      ** destination customer type.
      *
     C           *IN14     IFEQ '1'
     C/COPY WNCPYSRC,MG9210C001
     C                     EXSR VALID
     C                     EXSR CANCEL
     C/COPY WNCPYSRC,MG9210C002
     C                     END
      *
      **  COMIT all file changes
      *
     C                     COMIT
      *                                                                   221145
      **  Call Compliance Watch:Watch List Checking                       221145
      *                                                                   221145
     C           CSD015    IFEQ 'Y'                                       221145
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDEQ'N'                                       221145
     C                     EXSR WLCDQ                                     221145
     C                     ENDIF                                          221145
      *                                                                   221145
     C                     END
     C/COPY WNCPYSRC,MG9210C016
      *
     C                     SETON                     LR
     C                     RETRN
     C/EJECT
      *****************************************************************
      *   VALID - Determine if cancellation messages are generated    *
      *           for destination customer.                           *
      *   Called by - main processing.                                *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           VALID     BEGSR
      *
      ** Access SDCUSTPD for the destination customer details.
      *
     C                     MOVE *BLANKS   @KEY1
     C                     MOVELDECN      @KEY1
     C                     CALL 'AOCUSTR0'
     C                     PARM '*MSG   ' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @KEY1  10
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      ** Customer record not found - Error
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '002'     DBASE              * * * * * * *
     C                     MOVEL@KEY1     DBKEY              * DBERR 002 *
     C                     MOVEL'SDCUSTPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Is message type to be generated ?
      *
     C                     MOVE BBNG01    GNR,1
     C                     MOVE BBNG02    GNR,2
     C                     MOVE BBNG03    GNR,3
     C                     MOVE BBNG04    GNR,4
     C                     MOVE BBNG05    GNR,5
     C                     MOVE BBNG06    GNR,6
     C                     MOVE BBNG07    GNR,7
     C                     MOVE BBNG08    GNR,8
     C                     MOVE BBNG09    GNR,9
     C                     MOVE BBNG10    GNR,10
     C                     MOVE BBNG11    GNR,11
     C                     MOVE BBNG12    GNR,12
     C                     MOVE BBNG13    GNR,13
     C                     MOVE BBNG14    GNR,14
     C                     MOVE BBNG15    GNR,15
      *
      ** Any of the following names can be entered on BBNGxx on
      ** Sdcustpd to show the messages are not to be generated.
      **  -'n92' where n is the 1st digit of the cancelled message type.
      **  -'n9*' any of the n90 series of messages.
      **  -'n**' any of the 'n00' series of messages.
      **  -'*92' no cancellation messages are produced.
      *
      ** Initially fill up the test field with 'n92' where n is the 1st
      ** digit of the message type.
      *
     C                     MOVE MTPY      TEST    3
     C                     MOVE '92'      TEST
      *
      ** Store the new msg type for later output.
      *
     C                     MOVE TEST      NTPY    3
      ** 'n92' valid
     C           TEST      LOKUPGNR                      20
      ** 'n9*' valid
     C                     MOVE '*'       TEST
     C           TEST      LOKUPGNR                      21
      ** 'n**' valid
     C                     MOVE '**'      TEST
     C           TEST      LOKUPGNR                      22
      ** '*92' VALID
     C           '*92'     LOKUPGNR                      23
      *                                                                   E32333
      ****Convert*run*date*to*YYMMDD,*for*SWIFT*VALUE*DATE*VALIDATION.2333111009
     C***********          CALL 'ZM0060'               15           E32333111009
     C***********          PARM BJRDNB    ZMDAY   50                E32333111009
     C***********          PARM           ZSDATE  6                 E32333111009
      ***********                                                   E32333111009
      ***Program*ended*in*error.                                    E32333111009
      ***********                                                   E32333111009
     C************IN15     IFEQ '1'                                 E32333111009
     C************LOCK     IN   LDA                                 E32333111009
     C***********          MOVE '009'     DBASE              * * * *E*2*3*111009
     C***********          MOVEL'       ' DBKEY              * DBERRE0093*111009
     C***********          MOVEL'ZM0060'  DBFILE             * * * *E*2*3*111009
     C***********          OUT  LDA                                 E32333111009
     C***********          EXSR *PSSR                               E32333111009
     C***********          END                                      E32333111009
     C***********          MOVE ZSDATE    MRDT    6                 E32333111009
     C/COPY WNCPYSRC,MG9210C008
      *                                                                   E32333
      *                                                                   111009
      ** Get MIDAS day no. equiv. of SWIFT value date                     111009
      *                                                                   111009
     C                     MOVE '0'       *IN98                           111009
     C                     Z-ADD0         ZDATE                           111009
      *                                                                   140165
      ** SVDT is YYMMDD so change to DDMMYY                               140165
      *                                                                   140165
     C                     MOVE SVDT      WDD     2                       140165
     C                     MOVELSVDT      WYY     2                       140165
     C                     MOVE SVDT      ZDATE                           111009
     C                     MOVELWDD       ZDATE                           140165
     C                     MOVE WYY       ZDATE                           140165
     C                     EXSR ZDATE1                                    111009
     C                     Z-ADDZDAYNO    MSVDT   50                      111009
     C/COPY WNCPYSRC,MG9210C019
      *                                                                   140165
      ** Suppress cancellation message (MTn92), when the SWIFT value      E32333
      ** date of the message is past.                                     E32333
      *                                                                   E32333
     C***********SVDT      IFLT MRDT                                E32333111009
     C           MSVDT     IFLT BJRDNB                                    111009
      *                                                                   111009
     C           #MTPY1    ANDNE'3'                                       059061
      *                                                                   S01408
     C/COPY WNCPYSRC,MG9210CCP3                                           S01408
      *                                                                   S01408
     C                     SETON                     24                   E32333
     C                     END                                            E32333
      *
      ** If the message is not to be generated seton LR.
      *
     C           *IN20     IFEQ '1'
     C           *IN21     OREQ '1'
     C           *IN22     OREQ '1'
     C           *IN23     OREQ '1'
     C           *IN24     OREQ '1'                                       E32333
     C                     SETON                     LR
     C                     RETRN
     C                     END
      *
     C                     ENDSR
     C/EJECT
     C/COPY WNCPYSRC,MG9210C003
      *****************************************************************
      *   CANCEL - Create cancellation message. (MTn92 processing).   *
      *   Called by - main processing.                                *
      *   Calls     - TRAN Create TRN for the new message.            *
      *             - TYPE Determine the type of cancelled message.   *
      *             - MSGCAN Cancel part of a multiple message.       *
      *             - SINGLE Cancel a single message.                 *
      *             - OMSG   Output the message to PF/MGOMSGPD.       *
      *****************************************************************
      *
     C           CANCEL    BEGSR
      *
     C           TRNF      IFNE *BLANKS                                                       208030
     C                     MOVEL@TNUM     WWTNUM                                              210851
     C                     MOVELTRNF      @TNUM                                               208030
     C                     ELSE                                                               210851
     C                     MOVEL@TNUM     WWTNUM                                              210851
     C                     END                                                                208030
      *                                                                                       208030
     C           @TNUM     CHAINMGOMSGPD             10                                       195527
     C           *IN10     IFEQ '1'                                                           195527
     C           *LOCK     IN   LDA                                                           195527
     C                     MOVE '010'     DBASE              * * * * * * *                    195527
     C                     MOVEL@TNUM     DBKEY              * DBERR 010 *                    195527
     C                     MOVEL'MGOMSGPD'DBFILE             * * * * * * *                    195527
     C                     OUT  LDA                                                           195527
     C                     EXSR *PSSR                                                         195527
     C                     END                                                                195527
      *                                                                                       195527
     C           MTAG      IFEQ ':103:'                                                       195527
     C                     ADD  1         X                                                   195527
     C           X         OCUR MULT                                                          195527
     C                     MOVELMTAG      @MTAG                                               195527
     C                     MOVELMFLD      @MFLD                                               195527
     C                     END                                                                195527
      *                                                                                       195527
      ** Create the TRN for the new message.
      *
     C                     EXSR TRAN
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVEL':20:'    @MTAG
     C                     MOVE *BLANKS   @WRK
      *
      ** If CLE007 is switched on and module id is 'LF' change the        CLE007
      ** transaction number format to the Midas Transaction Reference     CLE007
      ** Number and the newly computed Last Swift Sequence Number.        CLE007
      *                                                                   CLE007
     C           CLE007    IFEQ 'Y'                                       CLE007
     C           @MODI     ANDEQ'LF'                                      CLE007
     C           CLE007    OREQ 'Y'                                       CLE009
     C           @MODI     ANDEQ'LS'                                      CLE009
      *                                                                                       186066
     C           DBLNK     IFEQ *BLANKS                                                       186066
     C           @MODI     ANDEQ'LF'                                                          186066
     C                     MOVEL@TNUM     WTM9    9                                           186066
     C                     MOVE FLSWS     WTM11  11                                           186066
     C                     MOVELWTM9      WTM11  11                                           186066
     C                     MOVELWTM11     @MFLD     P                                         186066
     C                     ELSE                                                               186066
     C                     MOVE *BLANKS   WTMFL  14                       CLE007
     C                     MOVELMTRN      WTM13  13                       CLE009
     C                     MOVE *BLANKS   WMFLD  16                       CLE007
     C                     MOVE FLSWS     WMFLD                           CLE007
     C***********          MOVELMTRN      WTMFL                     CLE007CLE009
     C                     MOVELMTRN      WTM13                           CLE009
     C                     MOVE WTM13     WTMFL                           CLE009
     C                     MOVEL'F'       WTMFL                           CLE009
     C                     MOVELWTMFL     WMFLD                           CLE007
     C                     MOVELWMFLD     @MFLD                           CLE007
     C                     ENDIF                                                              186066
      *                                                                   CLE007
     C                     ELSE                                           CLE007
      *                                                                   CLE007
     C                     MOVEA@MODI     @WRK
     C                     MOVEAMTRN      @WRK,3
     C                     Z-ADD1         Z       20
     C           ' '       LOKUP@WRK,Z                   99
     C                     MOVELLSWS      HLSWS   3
     C                     MOVEAHLSWS     @WRK,Z
      *
     C                     MOVEA@WRK      @MFLD
     C                     ENDIF                                          CLE007
      *                                                                   CLE007
     C                     MOVEL@MFLD     @TRNO  16
      *
      ** Field 21: The related reference.
      ** Related Reference of new message = TRN of cancelled message.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     MOVEL':21:'    @MTAG
     C**********           MOVEL@TNUM     @MFLD                                               210851
     C                     MOVELWWTNUM    @MFLD                                               210851
      *
      ** Field 11.  - MT and Date of Original Message Record
      **              to LF/MGOMSGL0.
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C******************** MOVEL':11:'    @MTAG                           S01412
     C                     MOVEL':11S:'   @MTAG                           S01412
     C******************** MOVELMTPY      TEN    10                       E30475
     C                     MOVELMTPY      @MFLD                           E30475
      *                                                                   E30475
     C                     ADD  1         X                               E30475
     C           X         OCUR MULT                                      E30475
      *
      ** Format the release date via standard program ZM0085.
      *
     C                     MOVE *BLANKS   RDATE   6
      *                                                                   E30475
      ** For part of multiple message access header for release date      E30475
     C           TRNF      IFNE *BLANKS                                   E30475
     C           TRNF      CHAINMGOREFL1             11                   E30475
     C                     END
      *
     C                     CALL 'ZM0085'               15
     C                     PARM RELD      @RELD   7
     C           RDATE     PARM *BLANKS   @RDATE  6
      *
      **  Call ended in error. (Program not found.)
      *
     C           *IN15     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '003'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 003 *
     C                     MOVEL'ZM0085'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C******************** MOVE RDATE     TEN                            E30475
     C******************** MOVELTEN       @MFLD                          E30475
     C                     MOVELRDATE     @MFLD                          E30475
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
      **  Determine if message to be cancelled is single or multiple   ed.
      *
     C                     EXSR TYPE
      *
      **  Do cancellation process for multiple message
      *
     C           MMEG      IFEQ 'Y'
      *
      **  Perform multiple MT210 AND 203 message cancellation.
      *
     C                     EXSR MSGCAN
      *
      **  Perform single message cancellation.
      *
     C                     ELSE
     C                     EXSR SINGLE
      *
     C                     END
      *
      ** Write the message to PF/MGOMSGPD.
      *
     C                     EXSR OMSG
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   MSGCAN - Part cancel. message from message on PF/MGOMSGPD   *
      *   Called by   CANCEL - Cancellation Messages MTn92.           *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           MSGCAN    BEGSR
      *
      **  Access multiple message on the message data file
      *
     C           @HEAD     CHAINMGOMSGPD             10
     C           *IN10     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '004'     DBASE              * * * * * * *
     C                     MOVEL@HEAD     DBKEY              * DBERR 004 *
     C                     MOVEL'MGOMSGPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  For MT203's the first record is field 19 and is not required.
      *
     C           MTPY      IFEQ '203'
     C                     READ MGOMSGPD                 12
     C                     END
      *
      ** Move the message into field :79: of the new message.
      *
     C*********            MOVEL':79:'    @MTAG                           E33587
     C*********            MOVELMFLD      MFLD2                           E33587
      *                                                                   E33587
     C                     MOVEL'    '    @MTAG                           E33587
      ** Remove possible space between MTAG & MFLD, (e.g. change          E31532
      ** ':21: ABCDEF0123FEDCBA' to ':21:ABCDEF0123FEDCBA')               E31532
     C           CHTAG     IFEQ ' '                                       E31532
     C                     MOVELMFLD      MFLD1                           E31532
     C                     ELSE                                           E31532
     C                     MOVELMFLD      MFLD2                           E31532
     C                     END                                            E31532
      *                                                                   E31532
     C                     MOVELMSG       @MFLD
     C                     READ MGOMSGPD                 12
      *
     C           MTAG      DOWNE':20:'
     C           *IN12     ANDEQ'0'
     C           @HEAD     ANDEQTRNO
     C           MTAG      ANDNE':21:'
      *
     C           @MTAG     IFNE ':103:'                                                       195527
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END                                                                195527
      *                                                                   E31532
      ** Remove possible space between MTAG & MFLD, (e.g. change          E31532
      ** ':21: ABCDEF0123FEDCBA' to ':21:ABCDEF0123FEDCBA')               E31532
     C           CHTAG     IFEQ ' '                                       E31532
      *                                                                   E34539
      **  If tag blank (next subfield/narrative line) left justify data   E34539
     C           MTAG      IFEQ ' '                                       E34539
     C                     MOVELMFLD      MFLD3                           E34539
     C                     ELSE                                           E34539
     C                     MOVELMFLD      MFLD1                           E31532
     C                     END                                            E34539
      *                                                                   E34539
     C                     ELSE                                           E31532
     C                     MOVELMFLD      MFLD2                           E31532
     C                     END                                            E31532
      *                                                                   E31532
     C                     MOVELMSG       @MFLD
     C                     READ MGOMSGPD                 12
     C                     END
      *
     C                     MOVE 'N'       FOUND
     C                     Z-ADD0         P210    20
      *
      **  Read through the multiple to find the cancelled message.
      *
     C           @HEAD     DOWEQTRNO
     C           *IN12     ANDEQ'0'
     C           FOUND     ANDEQ'N'
      *
      **  For MT203, part found when Field :20: contains the
      **  TRN of the message we are cancelling.
      *
     C           @MTPY     IFEQ '203'
     C           MTAG      ANDEQ':20: '
     C                     MOVELMFLD      @FLD   16
     C********** @FLD      IFEQ @TNUM                                                         210851
     C           @FLD      IFEQ WWTNUM                                                        210851
      *
      **  For this part of the multiple message, flag as part cancelled.
      *
     C           MTAG      DOUEQ':20: '
     C           *IN12     OREQ '1'
     C           @HEAD     ORNE TRNO
     C           @MTAG     IFNE ':103:'                                                       195527
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END                                                                195527
      *                                                                   E31532
      ** Remove possible space between MTAG & MFLD, (e.g. change          E31532
      ** ':21: ABCDEF0123FEDCBA' to ':21:ABCDEF0123FEDCBA')               E31532
     C           CHTAG     IFEQ ' '                                       E31532
      *                                                                   E34539
      **  If tag blank (next subfield/narrative line) left justify data   E34539
     C           MTAG      IFEQ ' '                                       E34539
     C                     MOVELMFLD      MFLD3                           E34539
     C                     ELSE                                           E34539
     C                     MOVELMFLD      MFLD1                           E31532
     C                     END                                            E34539
      *                                                                   E34539
     C                     ELSE                                           E31532
     C                     MOVELMFLD      MFLD2                           E31532
     C                     END                                            E31532
      *                                                                   E31532
     C                     MOVELMSG       @MFLD
     C                     READ MGOMSGPD                 12
     C                     END
      *
      **  Flag message part has been part cancelled.
      *
     C                     MOVE 'Y'       FOUND   1
     C                     END
     C                     END
      *
      **  For MT210, part found when part position within multiple on
      **  the reference file is equal to the number of field :21:'s
      **  we have read within the message on the data file
      *
     C           @MTPY     IFEQ '210'
     C           MTAG      ANDEQ':21: '
     C                     ADD  1         P210
     C           P210      IFEQ @PT210
      *
      **  For this part of the multiple message.
      *
     C           MTAG      DOUEQ':21: '
     C           *IN12     OREQ '1'
     C           @HEAD     ORNE TRNO
     C           @MTAG     IFNE ':103:'                                                       195527
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END                                                                195527
      *                                                                   E31532
      ** Remove possible space between MTAG & MFLD, (e.g. change          E31532
      ** ':21: ABCDEF0123FEDCBA' to ':21:ABCDEF0123FEDCBA')               E31532
     C           CHTAG     IFEQ ' '                                       E31532
      *                                                                   E34539
      **  If tag blank (next subfield/narrative line) left justify data   E34539
     C           MTAG      IFEQ ' '                                       E34539
     C                     MOVELMFLD      MFLD3                           E34539
     C                     ELSE                                           E34539
     C                     MOVELMFLD      MFLD1                           E31532
     C                     END                                            E34539
      *                                                                   E34539
     C                     ELSE                                           E31532
     C                     MOVELMFLD      MFLD2                           E31532
     C                     END                                            E31532
      *                                                                   E31532
     C                     MOVELMSG       @MFLD
     C                     READ MGOMSGPD                 12
     C                     END
      *
      **  Flag message part has been part cancelled.
      *
     C                     MOVE 'Y'       FOUND   1
     C                     END
     C                     END
      *
     C                     READ MGOMSGPD                 12
     C                     END
      *
      ** If the part of message is not found.
      *
     C           FOUND     IFEQ 'N'
     C           *LOCK     IN   LDA
     C                     MOVE '005'     DBASE              * * * * * * *
     C                     MOVEL@HEAD     DBKEY              * DBERR 005 *
     C                     MOVEL'MGOMSGPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   SINGLE - Process MTn92 for a single message.                *
      *   Called by - CANCEL - Cancellation messages. (MTn92).        *
      *   Calls     - FILL - Original msg to D.S as field 79.         *
      *****************************************************************
      *
     C           SINGLE    BEGSR
      *
      ** Access PF/MGOMSGPD with the TRN of the cancelled message.
      *
     C           @TNUM     CHAINMGOMSGPD             10
      *
      ** If no record is found.
      *
     C           *IN10     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '006'     DBASE              * * * * * * *
     C                     MOVEL@TNUM     DBKEY              * DBERR 006 *
     C                     MOVEL'MGOMSGPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C           MTAG      IFEQ ':103:'                                                       195527
     C                     READ MGOMSGPD                 10                                   195527
     C                     END                                                                195527
      *                                                                                       195527
      ** Move the TRN to the field to chain on in FILL subroutine.
      *
     C                     MOVEL@TNUM     @HEAD
      *
     C                     EXSR FILL
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   TRAN - Retreive msg. seq. from transaction file.            *
      *   Called by - CANCEL Cancellation message. (MTn92.)           *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           TRAN      BEGSR
      *
      **  Put Midas Transaction Number into key valid for chain
      *
     C                     MOVELMTRN      MTRAN   60
     C                     MOVELMTRN      MTRANA  6                                           CLE148
      *
      **  DEALING transaction
      *
     C           @MODI     IFEQ 'DL'
     C                     CALL 'QCAEXEC'                                 093047
     C                     PARM CMD,1     QCCMD  80                       093047
     C                     PARM 80        QCLEN  155                      093047
     C                     OPEN DEALS
     C           MTRAN     CHAINDEALS                07
      *
      **  Dealing transaction not found
      *
     C           *IN07     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '007'     DBASE              * * * * * * *
     C                     MOVELMTRAN     DBKEY              * DBERR 007 *
     C                     MOVEL'LF/DEALS'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Increment S.W.I.F.T. seq. number & update appropriate file
      *
     C                     ADD  1         LSWS
      *
      **  Foreign Exchange deal (swaps/outrights)
      *
     C           RCDT      IFEQ 'B'
     C                     UPDATDEALSDBF
     C                     END
      *
      **  Takings/Placings/Time Deposits/Loans
      *
     C           RCDT      IFEQ 'C'
     C                     UPDATDEALSDCF
     C                     END
      *
      **  Negotiable Assets Purchased
      *
     C           RCDT      IFEQ 'D'
     C                     UPDATDEALSDDF
     C                     END
      *
      **  Negotiable Assets Sold
      *
     C           RCDT      IFEQ 'E'
     C                     UPDATDEALSDEF
     C                     END
      *
     C                     END
      *
      **  FRA/IRS transaction
      *
     C           @MODI     IFEQ 'FI'
     C                     CALL 'QCAEXEC'                                 093047
     C                     PARM CMD,1     QCCMD  80                       093047
     C                     PARM 80        QCLEN  155                      093047
     C                     OPEN DEALS
     C           MTRAN     CHAINDEALS                07
      *
      **  Dealing transaction not found
      *
     C           *IN07     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '007'     DBASE              * * * * * * *
     C                     MOVELMTRAN     DBKEY              * DBERR 008 *
     C                     MOVEL'LF/DEALS'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Increment S.W.I.F.T. seq. number & update appropriate file
      *
     C                     ADD  1         LSWS
      *
      **  FRA/IRS
      *
     C           RCDT      IFEQ 'G'
     C                     UPDATDEALSDGF
     C                     END
      *
     C                     END
      *
      ** If the parameter module id is Lending (LE).Access CLOAN.
      *
     C           @MODI     IFEQ 'LE'
     C                     OPEN CLOAN
     C********** MTRAN     CHAINCLOAN                08                                       CLE148
     C           MTRANA    CHAINCLOAN                08                                       CLE148
      *
      **  Lending transaction not found
      *
     C           *IN08     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '008'     DBASE              * * * * * * *
     C                     MOVELMTRAN     DBKEY              * DBERR 009 *
     C                     MOVEL'LF/CLOAN'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      **  Increment S.W.I.F.T. seq. number & update lending file
      *
     C                     ADD  1         LSWS
     C                     UPDATCLOANCLF
     C                     END
      *
      ** If the parameter module id is Securities Trading (SE)
      ** access trading file TRADS.
      *
     C***********@MODI     IFEQ 'SE'
     C***********          MOVE MTRAN     MTRAD   6
     C***********MTRAD     CHAINTRADS                09
      *
      ****Securities transaction not found
      *
     C************IN09     IFEQ '1'
     C************LOCK     IN   LDA
     C************         MOVE '009'     DBASE              * * * * * * *
     C***********          MOVELMTRAN     DBKEY              * DBERR 010 *
     C***********          MOVEL'TRADS   'DBFILE             * * * * * * *
     C***********          OUT  LDA
     C***********          EXSR *PSSR
     C***********          END
      *
      ****Increment S.W.I.F.T. seq. number & update trading file
      *
     C***********          ADD  1         TSSQ
     C***********          Z-ADDTSSQ      LSWS
     C***********          UPDATTRADSDF
     C***********          END
      *
      *                                                                   CDL002
      ** If the parameter module id is Netting (NT).Access FXNETPD        CDL002
      *                                                                   CDL002
     C           @MODI     IFEQ 'NT'                                      CDL002
     C                     OPEN FXNETML4                                  CDL002
     C           MTRAN     CHAINFXNETML4             99                   CDL002
      *                                                                   CDL002
      **  Netting transaction not found                                   CDL002
      *                                                                   CDL002
     C           *IN99     IFEQ '1'                                       CDL002
     C           *LOCK     IN   LDA                                       CDL002
     C                     MOVE '015'     DBASE              * * * * * * *CDL002
     C                     MOVELMTRAN     DBKEY              * DBERR 015 *CDL002
     C                     MOVEL'FXNETML4'DBFILE             * * * * * * *CDL002
     C                     OUT  LDA                                       CDL002
     C                     EXSR *PSSR                                     CDL002
     C                     END                                            CDL002
      *                                                                   CDL002
      **  Increment S.W.I.F.T. seq. number & update netting file          CDL002
      *                                                                   CDL002
     C                     ADD  1         LSWS                            CDL002
     C                     UPDATFXNETMD0                                  CDL002
     C                     END                                            CDL002
      *                                                                   CDL002
     C           @MODI     IFEQ 'SE'                                      S01386
     C                     MOVE MTRAN     MTRAD   6                       S01386
     C                     OPEN TRADS                                     058491
     C           MTRAD     CHAINTRADS                09                   S01386
      *                                                                   S01386
      **  Securities transaction not found                                S01386
     C           *IN09     IFEQ '1'                                       S01386
     C           *LOCK     IN   LDA                                       S01386
     C                     MOVE '009'     DBASE              * * * * * * *S01386
     C                     MOVELMTRAN     DBKEY              * DBERR 009 *S01386
     C                     MOVEL'TRADS   'DBFILE             * * * * * * *S01386
     C                     OUT  LDA                                       S01386
     C                     EXSR *PSSR                                     S01386
     C                     END                                            S01386
      *                                                                   S01386
      **  Increment S.W.I.F.T. seq. number & update trading file          S01386
     C                     ADD  1         LSWS                            S01386
     C                     UPDATTRADSDF                                   S01386
     C                     END                                            S01386
      *
      ** If CLE007 is switched on, increment the Last Swift Sequence      CLE007
      ** by 1 then update the Fees file.                                  CLE007
      *                                                                   CLE007
     C           CLE007    IFEQ 'Y'                                       CLE007
     C           @MODI     ANDEQ'LF'                                      CLE007
      *                                                                   CLE007
     C                     OPEN LEFEEDL1                                  CLE007
      *                                                                   CLE007
     C                     MOVE *BLANKS   WTNUM                           CLE007
     C                     MOVE *BLANKS   DSFEE                           CLE007
      *                                                                   CLE007
     C                     MOVE @TNUM     WTNUM  16                       CLE007
     C***********          Z-ADDDCNUM     WCNUM   60                CLE007CLE009
     C***********DFIND     IFEQ 'F'                                 CLE007CLE009
     C           DBLNK     IFNE *BLANKS                                   CLE009
     C**********           Z-ADDDCNUM     WCNUM   60                                   CLE009 CSD027
     C                     MOVE DCNUM     WCNUM   6                                           CSD027
     C                     MOVE DFACL     WFACL   50                      CLE007
     C**********           Z-ADD0         WLNRF                                        CLE007 CLE148
     C                     MOVEL*BLANKS   WLNRF                                               CLE148
     C                     Z-ADDDFFSQ     WFSEQ   20                      CLE009
     C                     ELSE                                           CLE007
      *                                                                   CLE009
     C                     OPEN CLOAN                                     CLE009
     C********** MTRAN     CHAINCLOAN                08                                CLE009 186066
     C**********           MOVE DLNRF     WLOAN   60                                   186066 CLE148
     C                     MOVE DLNRF     WLOAN   6                                           CLE148
     C           WLOAN     CHAINCLOAN                08                                       186066
      **  Lending transaction not found                                   CLE009
     C           *IN08     IFEQ '1'                                       CLE009
     C           *LOCK     IN   LDA                                       CLE009
     C                     MOVE '020'     DBASE            * * * * * * * *CLE009
     C                     MOVELMTRAN     DBKEY            *  DBERR 020  *CLE009
     C                     MOVEL'LF/CLOAN'DBFILE           * * * * * * * *CLE009
     C                     OUT  LDA                                       CLE009
     C                     EXSR *PSSR                                     CLE009
     C                     END                                            CLE009
      *                                                                   CLE009
     C**********           Z-ADDCNUM      WCNUM   60                                   CLE009 CSD027
     C                     MOVE CNUM      WCNUM   6                                           CSD027
     C**********           MOVE DLNRF     WLNRF   60                                   CLE007 CLE148
     C                     MOVE DLNRF     WLNRF   6                                           CLE148
     C                     Z-ADD0         WFACL                           CLE007
     C                     Z-ADDDLFSQ     WFSEQ                           CLE009
     C                     ENDIF                                          CLE007
     C***********          Z-ADDDFSEQ     WFSEQ   20                CLE007CLE009
      *                                                                   CLE007
     C           KEYFEE    CHAINLEFEEDL1             25                   CLE007
      *                                                                   CLE007
     C           *IN25     IFEQ '1'                                       CLE007
     C           *LOCK     IN   LDA                                       CLE007
     C                     Z-ADD018       DBASE            ***************CLE007
     C                     MOVEL'LEFEED  'DBFILE           * DB ERROR 18 *CLE007
     C                     MOVELDSFEE     DBKEY            ***************CLE007
     C                     OUT  LDA                                       CLE007
     C                     EXSR *PSSR                                     CLE007
      *                                                                   CLE007
     C                     ELSE                                           CLE007
      *                                                                   CLE007
     C                     ADD  1         FLSWS                           CLE007
     C                     UPDATLEFEEDF                                   CLE007
      *                                                                   CLE007
     C                     ENDIF                                          CLE007
     C                     ENDIF                                          CLE007
      *                                                                   S01386
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   TYPE - determine the type of message being cancelled.       *
      *   Called by   CANCEL                                          *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           TYPE      BEGSR
      *
      **  Initialise multiple message flag
      *
     C                     MOVE 'N'       MMEG    1
     C                     MOVE PT210     @PT210  20
     C                     MOVE MTPY      @MTPY   3
      *
      **  The message being cancelled is part of a multiple and
      **  is part cancelled from the multiple message (PF/MGOREFPD)
      *
     C           TRNF      IFNE *BLANKS
     C           TRNM      ORNE *BLANKS
     C                     MOVE 'Y'       MMEG
      *
      **  The header TRN is the TRN of the message being cancelled.
      *
     C           TRNF      IFEQ *BLANKS
     C                     MOVEL@TNUM     @HEAD  16
      *
      **  The header TRN is the 'TRN of the first part' (TRNF)
      *
     C                     ELSE
     C                     MOVELTRNF      @HEAD
     C                     END
      *
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   FILL - Write the original message to the data structure.    *
      *   Called by   SINGLE  Single Message Cancellation             *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           FILL      BEGSR
      *
      ** Field :79: contains the message to be cancelled.The message
      ** consists of both the field tags and the narrative.
      *
     C*********            MOVEL':79:'    @MTAG                           E33587
     C*********            MOVELMFLD      MFLD2                           E33587
      *                                                                   E31532
     C                     MOVEL'    '    @MTAG                           E33587
      ** Remove possible space between MTAG & MFLD, (e.g. change          E31532
      ** ':21: ABCDEF0123FEDCBA' to ':21:ABCDEF0123FEDCBA')               E31532
     C           CHTAG     IFEQ ' '                                       E31532
     C                     MOVELMFLD      MFLD1                           E31532
     C                     ELSE                                           E31532
     C                     MOVELMFLD      MFLD2                           E31532
     C                     END                                            E31532
      *                                                                   E31532
     C                     Z-ADD1         COUNT   20                      CSW095
     C                     MOVELMSG       @MFLD
     C                     READ MGOMSGPD                 12
      *
      ** Write the next record of the message being cancelled to the
      ** data structure.
      ** Ensure that the MTn92 does not exceed 2,000 characters.          CSW095
      *
     C           @HEAD     DOWEQTRNO
     C           *IN12     ANDEQ'0'
     C           COUNT     ANDLT30                                        CSW095
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *                                                                   E31532
      ** Remove possible space between MTAG & MFLD, (e.g. change          E31532
      ** ':21: ABCDEF0123FEDCBA' to ':21:ABCDEF0123FEDCBA')               E31532
     C           CHTAG     IFEQ ' '                                       E31532
      *                                                                   E34539
      **  If tag blank (next subfield/narrative line) left justify data   E34539
     C           MTAG      IFEQ ' '                                       E34539
     C                     MOVELMFLD      MFLD3                           E34539
     C                     ELSE                                           E34539
     C                     MOVELMFLD      MFLD1                           E31532
     C                     END                                            E34539
      *                                                                   E34539
     C                     ELSE                                           E31532
     C                     MOVELMFLD      MFLD2                           E31532
     C                     END                                            E31532
      *                                                                   E31532
     C                     MOVELMSG       @MFLD
     C                     READ MGOMSGPD                 12
     C                     ADD  1         COUNT                           CSW095
     C                     END
      *
     C                     ENDSR
      *****************************************************************                       CSD015
     C/EJECT                                                                                  CSD015
      *****************************************************************                       CSD015
      *                                                               *                       CSD015
      *  SRWTCH - Watch Processing                                    *                       CSD015
      *                                                               *                       CSD015
      *****************************************************************                       CSD015
      *                                                                                       CSD015
     C           SRWTCH    BEGSR                                                              CSD015
      *                                                                                       CSD015
      ** Re-determine Message Status                                                          CSD015
      *                                                                                       CSD015
     C                     MOVE 'N'       PARLS   1                                           CSD015
      *                                                                                       CSD015
     C           MGST      IFEQ 'RSND'                                                        CSD015
     C           NWRK      IFEQ 'SWIFT '                                                      CSD015
     C           NWRK      OREQ 'TELEX '                                                      CSD015
     C           NWRK      OREQ 'STTX  '                                                      CSD015
     C                     MOVE 'CRTD'    MGST                                                CSD015
     C                     MOVE '1'       MGSG                                                CSD015
     C                     MOVE 'Y'       PARLS                                               CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Initialise parameter for Compliance Engine program.                                  CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANK    WLTDS                                               CSD015
      *                                                                                       CSD015
     C                     Z-ADD0         W4VDAT                                              CSD015
     C                     Z-ADD0         W4MDAT                                              CSD015
     C                     Z-ADD0         W4AMT1                                              CSD015
     C                     Z-ADD0         W4AMT2                                              CSD015
      *                                                                                       CSD015
      ** Set up parameter for compliance engine program                                       CSD015
      *                                                                                       CSD015
     C                     MOVELTRNO      W4IDEN                                              CSD015
     C                     MOVELMTPY      W4ITEM                                              CSD015
     C                     MOVELBRCA      W4BRCH                                              CSD015
     C                     MOVEL'MGOREF  'W4FUNT                                              CSD015
     C                     MOVELDECN      W4CNUM                                              CSD015
     C                     Z-ADDBJRDNB    W4DDAT                                              CSD015
     C                     MOVELPARLS     W4ARLS                                              CSD015
      *                                                                                       CSD015
      ***Send*transaction*to compliance engine program                                 CSD015 221145
      *********************                                                            CSD015 221145
     C*********************CALL 'SDWLCLOP'                                             CSD015 221145
     C*********************PARM           WLTDS                                        CSD015 221145
     C*********************PARM *BLANKS   PSTRNG                                       CSD015 221145
      *                                                                                       CSD015
     C           EWATCH    ENDSR                                                              CSD015
      *                                                                                       CSD015
      *****************************************************************                       CSD015
     C/EJECT
      *****************************************************************                       221145
      *                                                               *                       221145
      *  WLCDQ - Submit information to Watch List Check Dtaq          *                       221145
      *                                                               *                       221145
      *****************************************************************                       221145
      *                                                                                       221145
     C           WLCDQ     BEGSR                                                              221145
      *                                                                                       221145
      *  Send transaction to compliance engine program                                        221145
      *                                                                                       221145
     C                     CALL 'SDWLCLOP'                                                    221145
     C                     PARM           WLTDS                                               221145
     C                     PARM *BLANKS   PSTRNG                                              221145
      *                                                                                       221145
      *                                                                                       221145
     C                     ENDSR                                                              221145
      *                                                                                       221145
     C/EJECT                                                                                  221145
      *****************************************************************
      *   WREF - Write a reference record to PF/MGOREFPD.             *
      *   Called by   - OMSG Output a reference to PF/MGOMSGPD.       *
      *   Calls       -                                               *
      *****************************************************************
      *
     C           WREF      BEGSR
      *
      *
      ** Access LF/MGOREFL0 with the TRN parameter to access the
      ** cancelled message.
      *
     C********** @TNUM     CHAINMGOREFL0             11                                       210851
     C           WWTNUM    CHAINMGOREFL0             11                                       210851
      *
      ** If no record of the message is not found.
      *
     C           *IN11     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '011'     DBASE              * * * * * * *
     C**********           MOVEL@TNUM     DBKEY              **DBERR*012**                    210851
     C                     MOVELWWTNUM    DBKEY              * DBERR 011 *                    210851
     C                     MOVEL'MGOREFL0'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      ** Update old record.
      *
     C                     MOVE 'Y'       CARQ
     C                     MOVELBJMRDT    LADT
     C                     TIME           LATM
      *                                                                   S01408
     C/COPY WNCPYSRC,MG9210CCP2                                           S01408
      *                                                                   S01408
     C                     UPDATMGREFL0
     C/COPY WNCPYSRC,MG9210C010
      *
      ** Write new record.
      *
     C                     MOVEL@TRNO     TRNO
     C                     MOVE *BLANKS   TRNF
     C                     MOVE *BLANKS   TRNM
     C********** MTRN      IFEQ *BLANK                                                 209555 210851
     C                     MOVELMTRAN     MTRN                                                209555
     C**********           END                                                         209555 210851
      *
      ** Set up the msg. type dependant on the cancellation type
     C/COPY WNCPYSRC,MG9210C004
      *
     C           *IN14     IFEQ '1'
     C                     MOVE NTPY      MTPY
     C                     ELSE
     C                     MOVE MTPY      MTPY
     C                     END
      *
      **  Convert run date to YYMMDD, for Message Generation Date         E29592
     C                     CALL 'ZM0060'               15                 E29592
     C                     PARM BJRDNB    ZMDAY   50                      E29592
     C                     PARM           ZSDATE  6                       E29592
      *                                                                   E29592
      ** Program ended in error.                                          E29592
      *                                                                   E29592
     C           *IN15     IFEQ '1'                                       E29592
     C           *LOCK     IN   LDA                                       E29592
     C                     MOVE '009'     DBASE              * * * * * * *E29592
     C                     MOVEL'       ' DBKEY              * DBERR 009 *E29592
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *E29592
     C                     OUT  LDA                                       E29592
     C                     EXSR *PSSR                                     E29592
     C                     END                                            E29592
     C                     MOVE ZSDATE    MGDE                            E29592
      *                                                                   113352
      ** Set-up Message Generation  Century flag                          113352
      *                                                                   113352
     C                     MOVELMGDE      YY      20                      113352
     C           YY        IFLT 72                                        113352
     C                     MOVE '2'       CIND                            113352
     C                     ELSE                                           113352
     C                     MOVE '1'       CIND                            113352
     C                     ENDIF                                          113352
      *                                                                   E29592
     C/COPY WNCPYSRC,MG9210C005
     C                     TIME           MGTM
     C                     MOVELBJMRDT    LADT
     C                     MOVE MGTM      LATM
     C*                                                                   059061
     C** If producing a confirmation cancellation - change network        059061
     C** to non swift (for tram)                                          059061
     C*                                                                   059061
     C           #MTPY1    IFEQ '3'                                       059061
     C           CDL008    ANDEQ'N'                                       CDL008
     C           #MTPY1    OREQ '3'                                       CDL008
     C           CDL008    ANDEQ'Y'                                       CDL008
     C           WMTPY     ANDNE'300'                                     CDL008
     C           #MTPY1    OREQ '3'                                       CDL008
     C           CDL008    ANDEQ'Y'                                       CDL008
     C           WMTPY     ANDEQ'300'                                     CDL008
     C           WMGST     ANDEQ'DLTD'                                    CDL008
     C***********          MOVE 'PAPER'   NWRK                      059061077553
     C                     MOVEL'PAPER'   NWRK                            077553
     C                     MOVE 'PRTD'    MGST                            059061
     C                     MOVE '3'       MGSG                            059061
     C                     ELSE                                           059061
      *                                                                   117956
      ** Check default status on customer record                          117956
      *                                                                   117956
     C                     MOVE BBDS01    DSR,1                           117956
     C                     MOVE BBDS02    DSR,2                           117956
     C                     MOVE BBDS03    DSR,3                           117956
     C                     MOVE BBDS04    DSR,4                           117956
     C                     MOVE BBDS05    DSR,5                           117956
     C                     MOVE BBDS06    DSR,6                           117956
     C                     MOVE BBDS07    DSR,7                           117956
     C                     MOVE BBDS08    DSR,8                           117956
     C                     MOVE BBDS09    DSR,9                           117956
     C                     MOVE BBDS10    DSR,10                          117956
     C                     MOVE BBDS11    DSR,11                          117956
     C                     MOVE BBDS12    DSR,12                          117956
     C                     MOVE BBDS13    DSR,13                          117956
     C                     MOVE BBDS14    DSR,14                          117956
     C                     MOVE BBDS15    DSR,15                          117956
      *                                                                   117956
     C                     MOVELMTPY      W@MTPY  3                       117956
     C           W@MTPY    LOKUPDSR                      50               117956
     C           *IN50     IFEQ '0'                                       117956
     C                     MOVE '*'       W@MTPY                          117956
     C           W@MTPY    LOKUPDSR                      50               117956
     C                     ENDIF                                          117956
     C           *IN50     IFEQ '0'                                       117956
     C                     MOVE '**'      W@MTPY                          117956
     C           W@MTPY    LOKUPDSR                      50               117956
     C                     ENDIF                                          117956
     C           *IN50     IFEQ '0'                                       117956
     C                     MOVE '***'     W@MTPY                          117956
     C           W@MTPY    LOKUPDSR                      50               117956
     C                     ENDIF                                          117956
      *                                                                   117956
     C           *IN50     IFEQ '1'                                       117956
     C                     MOVEL'2'       MGSG                            117956
     C                     MOVEL'RSND'    MGST                            117956
     C                     ELSE                                           117956
     C                     MOVE 'CRTD'    MGST
     C                     MOVE '1'       MGSG
     C                     END                                            059061
     C                     END                                            117956
      *                                                                                       CSD015
      ** If Watch List Checking is Applied and CSW025 is not installed,                       CSD015
      ** do watch list processing.                                                            CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           222385
     C           CSW025    ANDNE'Y'                                                           CSD015
     C                     EXSR SRWTCH                                                        CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C                     MOVE *BLANK    CARQ
      *
     C                     MOVEL*BLANKS   PTST                            E29592
     C                     MOVEL*BLANKS   MPDE                            E29592
     C                     MOVE *BLANKS   RELD                            E29592
     C                     MOVE *BLANKS   RELT                            E29592
     C                     MOVEL*BLANKS   RUSR                            E29592
     C                     MOVEL*BLANKS   RWSN                            E29592
      *                                                                   E29592
     C                     MOVE *BLANKS   CFPF                            E29592
     C                     MOVE *BLANKS   TSKS                            E29592
     C                     MOVE *BLANKS   TSKY                            E29592
     C                     Z-ADD0         PT210                           E29592
     C                     Z-ADD0         AVDT                            E29592
     C                     Z-ADD0         ASEQ                            E29592
     C                     MOVE *BLANKS   TODY                            E29592
     C           CSW025    IFEQ 'Y'                                                          BUG5646
     C                     MOVE 'Z'       AORR                                               BUG5646
     C                     ENDIF                                                             BUG5646
      *                                                                   CSW097
      ** Blank out Event Type                                             CSW097
     C                     MOVE *BLANKS   EVTP                            CSW097
      *                                                                   CSW097
     C/COPY WNCPYSRC,MG9210C012
      *
     C                     WRITEMGOREFD0               05
     C/COPY WNCPYSRC,MG9210C011
      *
      **  Error on write to PF/MGOREFPD (message reference file)
      *
     C           *IN05     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '012'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 013 *
     C                     MOVEL'MGOREFPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   OMSG - output correctly generated messages                  *
      *   Called by - CANCEL - Cancellation messages. (MTn92).        *
      *   Calls     - WREF - Write o/p reference to PF/MGOREFPD.      *
      *****************************************************************
      *
     C           OMSG      BEGSR
      *
      **  Write reference record to PF/MGOREFPD.
      *
     C                     EXSR WREF
      *
      **  Write multiple occurrence data structure to MGOMSGPD
      *
     C/COPY WNCPYSRC,MG9210C013
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
      *
     C           X         DOWLE40
     C           @MFLD     ANDNE*BLANKS
      *                                                                                     MD052168
      ** Do not write tag :121: and :119: in 'Copy of fields' on MTn92 message              MD052168
      *                                                                                     MD052168
     C                     MOVEL@MFLD     MFLD4   5                                         MD052168
     C           MFLD4     IFNE ':121:'                                                     MD052168
     C           MFLD4     ANDNE':119:'                                                     MD052168
      *
      **  Move the fields to be output to the field names on
      **  the file.
      *
     C                     MOVEL@MFLD     MFLD
     C                     MOVEL@MTAG     MTAG
     C                     MOVE *BLANKS   PTDL                            043907
     C/COPY WNCPYSRC,MG9210C014
      *
     C                     WRITEMGOMSGD0               06
      *
      **  Error on write to PF/MGOMSGPD (message data file)
      *
     C           *IN06     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVE '013'     DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 014 *
     C                     MOVEL'MGOMSGPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C                     ENDIF                                                            MD052168
      *
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     END
     C/COPY WNCPYSRC,MG9210C015
      *
     C                     ENDSR
     C/EJECT
      *****************************************************************
      *   INIT - initial process                                      *
      *   Called by - main process                                    *
      *   Calls     -                                                 *
      *****************************************************************
      *
     C           INIT      BEGSR
      *
     C                     MOVEACPY@      BIS@   80
      *
      **  Set up LDA
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVEL'MG9210'  DBPGM
     C                     MOVE *BLANKS   DBASE
     C                     OUT  LDA
      *
      **  Initialise constant fields
      *
     C                     MOVE *LOVAL    CR      1
     C                     BITON'457'     CR
     C                     MOVE *LOVAL    LF      1
     C                     BITON'257'     LF
     C                     MOVELCR        CRLF    2
     C                     MOVE LF        CRLF
     C                     MOVEL@TNUM     TRNO
     C                     MOVE *BLANKS   PTDL
      *
      **  CRLF Control Character for message data records
      *
     C                     MOVE CRLF      CTRC
      *
      **  Access SDBANKPD for run date and date format.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C/COPY WNCPYSRC,MG9210C006
     C           SDBANK    PARM SDBANK    DSFDY
      *
      **  If no record is found on sdbankpd.
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE '015'     DBASE              * * * * * * *
     C                     MOVEL'FIRST'   DBKEY              * DBERR 015 *
     C                     MOVEL'SDBANKPD'DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
     C/COPY WNCPYSRC,MG9210C007
      *                                                                   CLE007
      ** Check if CLE007 is switched *ON.                                 CLE007
      *                                                                   CLE007
     C                     MOVE 'N'       CLE007  1                       CLE007
     C                     CALL 'AOSARDR0'                                CLE007
     C                     PARM *BLANKS   WRTCD   7                       CLE007
     C                     PARM '*VERIFY' WOPTN   7                       CLE007
     C                     PARM 'CLE007'  WSARD   6                       CLE007
     C           SCSARD    PARM SCSARD    DSFDY                           CLE007
      *                                                                   CLE007
     C           WRTCD     IFEQ *BLANKS                                   CLE007
     C                     MOVE 'Y'       CLE007                          CLE007
      *                                                                   CLE007
     C                     ELSE                                           CLE007
     C                     MOVE 'N'       CLE007                          CLE007
      *                                                                   CLE007
      ** Call to program ended in error                                   CLE007
      *                                                                   CLE007
     C           WRTCD     IFNE '*NRF   '                                 CLE007
     C           *LOCK     IN   LDA                                       CLE007
     C                     Z-ADD019       DBASE            ***************CLE007
     C                     MOVE 'SCSARDPD'DBFILE           * DB ERROR 19 *CLE007
     C                     MOVEL'CLE007'  DBKEY            ***************CLE007
     C                     OUT  LDA                                       CLE007
     C                     EXSR *PSSR                                     CLE007
     C                     ENDIF                                          CLE007
     C                     ENDIF                                          CLE007
      *                                                                   CDL008
      ** Check if CDL008 (Continuous Linked Settlement) is installed      CDL008
      *                                                                   CDL008
     C                     MOVE 'N'       CDL008  1                       CDL008
     C                     CALL 'AOSARDR0'                                CDL008
     C                     PARM *BLANKS   WRTCD                           CDL008
     C                     PARM '*VERIFY' WOPTN                           CDL008
     C                     PARM 'CDL008'  WSARD                           CDL008
     C           SCSARD    PARM SCSARD    DSFDY                           CDL008
      *                                                                   CDL008
     C           WRTCD     IFNE *BLANKS                                   CDL008
     C           WRTCD     ANDNE'*NRF   '                                 CDL008
     C           *LOCK     IN   LDA                                       CDL008
     C                     Z-ADD021       DBASE             ************* CDL008
     C                     MOVEL'SCSARDPD'DBFILE            * DBERR 021 * CDL008
     C                     MOVELWSARD     DBKEY             ************* CDL008
     C                     OUT  LDA                                       CDL008
     C                     EXSR *PSSR                                     CDL008
     C                     ENDIF                                          CDL008
     C           WRTCD     IFEQ *BLANK                                    CDL008
     C                     MOVEL'Y'       CDL008                          CDL008
     C                     ENDIF                                          CDL008
      *                                                                   CLE007
      ** Is CSW025 installed?                                                                 209250
     C                     MOVE 'N'       CSW025                                             BUG5646
     C                     CALL 'AOSARDR0'                                                    209250
     C                     PARM '       ' WRTCD                                               209250
     C                     PARM '*VERIFY' WOPTN                                               209250
     C                     PARM 'CSW025'  WSARD                                               209250
     C********** @RTCD     IFNE *BLANK                                                209250 BUG5646
     C********** @RTCD     ANDNE'*NRF   '                                             209250 BUG5646
     C           WRTCD     IFNE *BLANK                                                       BUG5646
     C           WRTCD     ANDNE'*NRF   '                                                    BUG5646
     C                     MOVEL'SCSARDPD'DBFILE                                              209250
     C                     MOVEL'022'     DBASE                                               209250
     C                     MOVEL@RTCD     DBKEY                                               209250
     C                     MOVE *ON       *INU7                                               209250
     C                     MOVE *ON       *INU8                                               209250
     C                     EXSR *PSSR                                                         209250
     C                     ENDIF                                                              209250
     C********** @RTCD     IFEQ *BLANK                                                209250 BUG5646
     C           WRTCD     IFEQ *BLANK                                                       BUG5646
     C                     MOVE 'Y'       CSW025  1                                           209250
     C                     ENDIF                                                              209250
      *                                                                                       CSD015
      ** Access SAR file to determine if Midas Compliance Watch                               CSD015
      ** - Watch List Checking (CSD015) is installed                                          CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   PRTCD   7                                           CSD015
     C                     PARM '*VERIFY' POPTN   7                                           CSD015
     C                     PARM 'CSD015'  PSARD   6                                           CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
      ** An NRF (No Record Found) return code is valid.                                       CSD015
      ** Issue database error only for error return codes.                                    CSD015
      *                                                                                       CSD015
     C           PRTCD     IFNE *BLANKS                                                       CSD015
     C           PRTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVEL'CSD015'  DBKEY                                               CSD015
     C                     MOVEL'SCSARDPD'DBFILE                                              CSD015
     C                     Z-ADD22        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           PRTCD     IFEQ *BLANK                                                        CSD015
     C                     MOVEL'Y'       CSD015  1                                           CSD015
      *                                                                                       222385
      ** Access AOWLCCR0 to check if function code MESSGENT is available                      222385
      *                                                                                       222385
     C                     CALL 'AOWLCCR0'                                                    222385
     C                     PARM *BLANKS   @RTCD                                               222385
     C                     PARM '*KEY'    @OPTN                                               222385
     C                     PARM 'MESSGENT'PFUNC   8                                           222385
     C           SDWLCC    PARM SDWLCC    DSFDY                                               222385
      *                                                                                       222385
     C           @RTCD     IFNE *BLANKS                                                       222385
     C           @RTCD     ANDNE'*NRF'                                                        222385
     C                     MOVEL'SDWLCCPD'DBFILE                                              222385
     C                     MOVELPFUNC     DBKEY                                               222385
     C                     Z-ADD32        DBASE                                               222385
     C                     EXSR *PSSR                                                         222385
     C                     ENDIF                                                              222385
      *                                                                                       222385
     C                     ELSE                                                               CSD015
     C                     MOVEL'N'       CSD015                                              CSD015
     C                     MOVEL'N'       W1EWLC                                              222385
     C                     ENDIF                                                              CSD015
      ** Fees Key.                                                        CLE007
      *                                                                   CLE007
     C           KEYFEE    KLIST                                          CLE007
     C                     KFLD           WCNUM                           CLE007
     C                     KFLD           WFACL                           CLE007
     C                     KFLD           WLNRF                           CLE007
     C                     KFLD           WFSEQ                           CLE007
     C/COPY WNCPYSRC,MG9210C017
      *
     C           *LIKE     DEFN @TNUM     WWTNUM                                              210851
      *                                                                                       210851
     C                     ENDSR
     C/COPY WNCPYSRC,MG9210C018
     C/EJECT
     C/COPY ZSRSRC,ZDATE1Z2                                               111009
      *****************************************************************
      *   *PSSR - error handling                                      *
      *****************************************************************
      *
     C           *PSSR     BEGSR
     C                     MOVE 'E'       @RTNC
     C                     SETON                     U7U8LR
     C                     DUMP
     C                     RETRN
     C                     ENDSR
     C/EJECT
     C** ZYDY & ZMDY INSERTED BY FIX 111009
     X/COPY WNCPYSRC,MG9210X001                                           S01408
** CPY@   Object Copyright
(c) Misys International Banking Systems Ltd. 2001
** CAN - Message types requiring an MTn92.
100
103                                                                       CFT013
202
203
210
300
     X/COPY WNCPYSRC,MG9210X002
** CMD                                                                    093047
OVRDBF DEALS SHARE(*NO)
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
