     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MM Deal amendments maintenance')                 *
     F*****************************************************************
     F*                                                               *
     F*  Midas - MM Dealer Module                                     *
     F*                                                               *
     F*     This program will be made redundant at DBA R4.00          *
     F*     In the interim please check the new ILE RPG versions      *
     F*     and apply any new fixes if they are appropriate.          *
     F*                                                               *
     F*  MM0028   - BACK OFFICE DEAL INPUT - DEAL AMENDMENTS -        *
     F*             INPUT AND AUTHORIZATION                           *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD061957           Date 26Oct23               *
      *  Prev Amend No. CDL102             Date 01Jun21               *
      *                 CSD103             Date 10Aug20               *
      *                 MD046248           Date 27Oct17               *
      *                 CDL099             Date 06Oct17               *
      *                 CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CRE073             Date 06Dec10               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 11Jul06               *
      *                 CSD027             Date 09Dec05               *
      *                 237063             Date 20Nov05               *
      *                 CDL038             Date 10May05               *
      *                 BUG7411            Date 01Jun05               *
      *                 CSW037A            Date 02May05               *
      *                 CDL028             Date 07Feb05               *
      *                 229544             Date 15Sep04               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CDL022             Date 03Feb04               *
      *                 CDL020             Date 03Feb04               *
      *                 CDL019             Date 03Feb04               *
      *                 CDL018             Date 03Feb04               *
      *                 CDL017             Date 03Feb04               *
      *                 CDL016             Date 03Feb04               *
      *                 CGL029             Date 01Sep03               *
      *                 222727             Date 05Nov03               *
      *                 CDL010             Date 02Aug02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 04Oct01               *
      * Midas DBA 3.05 -----------------------------------------------*
     F*                 CSD006             Date 15May01               *
      * Midas DBA 3.04 -----------------------------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
     F*                 109499             Date 31Mar00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 136653             Date 28Apr99               *
     F*                 138107             Date 02Jul98               *
     F*                 114485             DATE 16Jun98               *
     F*                 115603             DATE 26Jun98               *
      *                 CAP002             Date 01May98               *
     F*                 CEU003             Date 25Nov97               *
     F*                 118181             DATE 19Feb98               *
     F*                 105883             DATE 19FEB98               *
     F*                 104599             DATE 19feb98               *
     F*                 110471             DATE 20Jan98               *
     F*                 S01408             DATE 24Nov97               *
     F*                 126017             DATE 18NOV97               *
     F*                 S01408             Date 16Oct97               *
     F*                 S01408             Date 05Nov96               *
     F*                 S01408             DATE 03OCT96               *
     F*                 S01408             DATE 13SEP96               *
     F*                 S01408             DATE 29AUG96               *
     F*                 S01408             DATE 08AUG96               *
     F*                 CAC001             DATE 01FEB96               *
     F*                 S01408             DATE 11JUN96               *
     F*                 S01408             DATE 29MAY96               *
     F*                 101523             DATE 12APR96               *
     F*                 S01408             DATE 29APR96               *
     F*                 S01408             DATE 18JAN96               *
     F*                 092455             DATE 22NOV95               *
     F*                 095244             DATE 01NOV95               *
     F*                 095238             DATE 31OCT95               *
     F*                 073682             DATE 24OCT95               *
     F*                 S01408             DATE 14SEP95               *
     F*                 087924             DATE 05MAY95               *
     F*                 S01408             DATE 21AUG95               *
     F*                 S01408             DATE 04AUG95               *
     F*                 S01408             DATE 20JUL95               *
     F*                 S01408             DATE 14JUN95               *
     F*                 085052             DATE 06JUN95               *
     F*                 082738             DATE 17MAR95               *
     F*                 S01408             DATE 21APR95               *
     F*                 083409             DATE 15MAR95               *
     F*                 S01408             DATE 22FEB95               *
     F*                 S01408             DATE 13DEC94               *
     F*                 S01486             DATE 28OCT94               *
     F*                 076419             DATE 19SEP94               *
     F*                 076272             DATE 15SEP94               *
     F*                 073516             DATE 12AUG94               *
     F*                 044740             DATE 05JUL94               *
     F*                 062436             DATE 28FEB94               *
     F*                 059667             DATE 03FEB94               *
     F*                 S01408             DATE 20JAN94               *
     F*                 060779             DATE 13JAN94               *
     F*                 S01453             DATE 14DEC93               *
     F*                 061426             DATE 30SEP93               *
     F*                 056095             DATE 08JUN93               *
     F*                 054017             DATE 16MAY93               *
     F*                 051307             DATE 19APR93               *
     F*                 050588             DATE 19MAR93               *
     F*                 050174             DATE 19MAR93               *
     F*                 049518             DATE 19MAR93               *
     F*                 047741             DATE 19MAR93               *
     F*                 E49965             DATE 01FEB93               *
     F*                 E47225             DATE 01FEB93               *
     F*                 E42414             DATE 17NOV92               *
     F*                 AUS007             DATE 13JUL92               *
     F*                 E28503             DATE 16MAR92               *
     F*                 E36559             DATE 03MAR92               *
     F*                 E36546             DATE 29FEB92               *
     F*                 E29460             DATE 29JAN91               *
     F*                 E32101             DATE 10JAN92               *
     F*                 E29463             DATE 06JAN92               *
     F*                 E33979             DATE 06JAN92               *
     F*                 S01354             DATE 06JAN92               *
     F*                 E27750             DATE 15JAN92               *
     F*                 E25518             DATE 02SEP91               *
     F*                 S01319             DATE 07AUG91               *
     F*                 E24193             DATE 18JUL91               *
     F*                 E24191             DATE 18JUL91               *
     F*                 E24031             DATE 04JUL91               *
     F*                 RT0150             DATE 12JUN91               *
     F*                 BHF972             DATE 11MAR91               *
     F*                 BHF947             DATE 26NOV90               *
     F*                 BHF946             DATE 21NOV90               *
     F*                 BHF944             DATE 20NOV90               *
     F*                 BHF914             DATE 14NOV90               *
     F*                 BHF907             DATE 14NOV90               *
     F*                 BHF906             DATE 01NOV90               *
     F*                 DT0091             DATE 22APR91               *
     F*                 DT0058             DATE 04APR91               *
     F*                 DT0015             DATE 20MAR91               *
     F*                 DT0010             DATE 19MAR91               *
     F*                 S01314             DATE 01MAR91               *
     F*                 S01304             DATE 13SEP90               *
     F*                 S01184             DATE 21FEB90               *
     F*                 E23406             DATE 18SEP90               *
     F*                 E20204             DATE 16AUG90               *
     F*                 E23326             DATE 15AUG90               *
     F*                 E22271             DATE 13AUG90               *
     F*                 E23041             DATE 13AUG90               *
     F*                 E23032             DATE 30JUL90               *
     F*                 E22744             DATE 21JUL90               *
     F*                 E22315             DATE 20JUL90               *
     F*                 E22668             DATE 20JUL90               *
     F*                 E20031             DATE 06JUN90               *
     F*                 E22161             DATE 23MAY90               *
     F*                 S01253             DATE 06APR90               *
     F*                 E20774             DATE 06APR60               *
     F*                 E20344             DATE 01FEB90               *
     F*                 E16441             DATE 31JAN90               *
     F*                 BHF635             DATE 15SEP90               *
     F*                 LN0822 (BHF0862)   DATE 28SEP90               *
     F*                 BHF632             DATE 14SEP90               *
     F*                 BHF488             DATE 12SEP90               *
     F*                 BHF430             DATE 14AUG90               *
     F*                 LN0663             DATE 22AUG90               *
     F*                 LN0637             DATE 16AUG90               *
     F*                 BHF439             DATE 16AUG90               *
     F*                 E22405             DATE 16AUG90               *
     F*                 BHF298             DATE 24JUL90               *
      *                 E17279             DATE 01AUG90               *
     F*                 BHF183             DATE 06JUL90               *
     F*                 LN0488             DATE 06JUL90               *
     F*                 LN0367             DATE 13JUN90               *
     F*                 LN0356             DATE 12JUN90               *
     F*                 LN0234             DATE 07JUN90               *
     F*                 E20897             DATE 24APR90               *
     F*                 E20829             DATE 24APR90               *
     F*                 E15515             DATE 24APR90               *
     F*                 S01227             DATE 24APR90               *
     F*                 E286               DATE 4APR90                *
     F*                 E284               DATE 20MAR90               *
     F*                 E279               DATE 19MAR90               *
     F*                 E276               DATE 16MAR90               *
     F*                 S01199             DATE 08MAR90               *
      *                 E214               DATE 18JAN90               *
     F*                 E70                DATE 16NOV89               *
     F*                 E18811             DATE 31OCT89               *
     F*                 E18663             DATE 31OCT89               *
     F*                 S01218             DATE 31OCT89               *
     F*                 E18380             DATE 31OCT89               *
     F*                 E18139             DATE 30OCT89               *
     F*                 E17654             DATE 30OCT89               *
     F*                 E17050             DATE 30OCT89               *
     F*                 E17021             DATE 30OCT89               *
     F*                 E16027             DATE 27OCT89               *
     F*                 S01117             DATE 14/09/89              *
     F*                 S01194             DATE 07/06/89              *
     F*                 S01177             DATE 27/10/88              *
     F*                 E16041             DATE 25/11/88              *
     F*                 E13747             DATE 02/09/88              *
     F*                 E14354             DATE 31/08/88              *
     F*                 E14379             DATE 11/08/88              *
     F*                 E14363             DATE 26/07/88              *
     F*                 E13873             DATE 25/06/88              *
     F*                 E12314             DATE 03/03/88              *
     F*                 E12145             DATE 02/02/88              *
     F*                 E12141             DATE 28/01/88              *
     F*                 S01136             DATE 14/01/88              *
     F*                                                               *
     F*---------------------------------------------------------------*
      *                                                               *
      *  MD061957 - DLBHISPD contains 188 fields, whereas DEALSDB     *
      *             contains 194 fields.                              *
      *           - Recompile due to DLBHISPD changes.                *
      *  CDL102 - LIBOR Deregulation - Dealing (Recompile)            *
      *  CSD103 - LIBOR Deregulation - Common Layer/Standing Data     *
      *           (Recompile)                                         *
      *  MD046248 - Finastra Rebranding                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  237063 - EU Tax fixes upgrade to MP build 103 (Recompile).   *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  BUG7411- CDL028 fields missing from DLGHISPD (Recompile)     *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CDL028 - Automatic Rate Interpolations (Recompile)           *
      *  229544 - Recompiled due to inserted fields in DLCHISPD.      *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CDL022 - Deal Amendment Changes (Recompile)                  *
      *  CDL020 - Apply Base Rate at Value Date (Recompile)           *
      *  CDL019 - Allow Base Rate Changes on Fixed Deposits/Loans     *
      *           (Recompile)                                         *
      *  CDL018 - Multiple Settlement Accounts on Loans/Deposits      *
      *           (Recompile)                                         *
      *  CDL017 - Penalty Fee & Early Maturity of Fixed Term Loan/Dep *
      *           (Recompile)                                         *
      *  CDL016 - Automatic rollover of Fixed Term Loans/Deposits     *
      *           (Recompile)                                         *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222727 - Release 5.0 errors  (Recompile)                     *
     F*  CDL010 - Prevent last user that actioned the trade from      *
     F*           authorising it.Recompile due to changes in MMDEAMPP *
     F*           , MMDELDPP, MMDENBPP AND MMDENSPP.                  *
      *  CPK014 - Release 4 packaging. A default timestamp string is  *
      *           required for file MMDEAMPP write.                   *
     F*  CSD006 - Use long DS with SDBSRTPD.                          *
     F*  109499 - Interest Capitalisation  should not be allowed if   *
     F*           interest capitalisation indicator on the deal is    *
     F*           not equal to  'Y' .                                 *
     F*  136653 - Action code field is blanked after authorization    *
     F*  138107 - Fix 105883 has line missing after DBA2.05           *
     F*  114485 - Disable F14 until Deal details validated.           *
     F*  115603 - Recompiled for changes in ZACCH                     *
     F*  CAP002 - Recompiled as part of conversion of Midas inputs to *
     F*           modular API structure.                              *
     F*  CEU003 - EMU Dealing Settlement Ccy conversion.              *
     F*  118181 - Apply fix 089621                                    *
     F*  089621 - Disallow change to settlement instructions for CI   *
     F*           records not set to 'Y'                              *
     F*  105883 - WRONG TEST ON DATE (FORMAT DDMMYY CANNOT BE COMPARE)*
     F*           DURING VALIDATION OF 'PD' AND NEGATIVE AMOUNT       *
     F*  104599 - RESERT OF *IN65 NOT DONE SO ACCESS TO AOCNSTR0 FAILED*
     F*  110471 - Do not change action to 'E' when hit F12 for deal   *
     F*           authorisation.                                      *
     F*  S01408 - Move core hooks to match equivalent position in     *
     F*           R10.6 source.                                       *
     F*         - Move core hook MM0028CP62 (DBAR2 only)              *
     F*         - Move core hook MM0028C015 (DBAR2 only)              *
     F*         - Addition of core hook MM0028CP73 (DBAR2 and R10.6)  *
     F*           in the old position of MM0028C015                   *
     F*  126017 - Correction to interest calculation for calculation  *
     F*           basis 6 in SR/GLINTC - recompile program.           *
     F*  S01408 - Addition of core hook MM0028CP72 (DBAR2 ONLY)       *
     F*         - Addition of core hook MM0028CP71 (DBAR2 ONLY)       *
     F*  S01408 - Addition of core hook MM0028CP70                    *
     F*         - Addition of core hook MM0028CP69                    *
     F*         - Addition of core hook MM0028CP68                    *
     F*         - Addition of core hook MM0028CP67                    *
     F*  S01408 - Addition of core hooks MM0028CP66                   *
     F*         - Addition of core hooks MM0028CP65                   *
     F*         - Addition of core hooks MM0028CP64                   *
     F*         - Addition of core hooks MM0028CP63                   *
     F*  S01408 - Addition of core hooks MM0028CP62                   *
     F*         - Addition of core hooks MM0028CP61                   *
     F*  S01408 - Addition of core hooks MM0028CP36                   *
     F*         - Addition of core hooks MM0028CP37                   *
     F*         - Addition of core hooks MM0028CP38                   *
     F*         - Addition of core hooks MM0028CP39                   *
     F*         - Addition of core hooks MM0028CP40                   *
     F*         - Addition of core hooks MM0028CP41                   *
     F*         - Addition of core hooks MM0028CP42                   *
     F*         - Addition of core hooks MM0028CP43                   *
     F*         - Addition of core hooks MM0028CP44                   *
     F*         - Addition of core hooks MM0028CP45                   *
     F*         - Addition of core hooks MM0028CP46                   *
     F*         - Addition of core hooks MM0028CP47                   *
     F*         - Addition of core hooks MM0028CP48                   *
     F*         - Addition of core hooks MM0028CP49                   *
     F*         - Addition of core hooks MM0028CP50                   *
     F*         - Addition of core hooks MM0028CP51                   *
     F*         - Addition of core hooks MM0028CP52                   *
     F*         - Addition of core hooks MM0028CP53                   *
     F*         - Addition of core hooks MM0028CP54                   *
     F*         - Addition of core hooks MM0028CP55                   *
     F*         - Addition of core hooks MM0028CP56                   *
     F*         - Addition of core hooks MM0028CP57                   *
     F*         - Addition of core hooks MM0028CP58                   *
     F*         - Addition of core hooks MM0028CP59                   *
     F*         - Addition of core hooks MM0028CP60                   *
     F*         - Addition of core hooks MM0028IIP5                   *
     F*         - Addition of core hooks MM0028FFP1                   *
     F*  S01408 - Addition of core hooks MM0028CP35                   *
     F*         - Addition of core hooks MM0028CP34                   *
     F*         - Addition of core hooks MM0028CP33                   *
     F*         - Addition of core hooks MM0028CP32                   *
     F*  CAC001 - Profit Centre Accounting Development:               *
     F*           If Analytical Accounting is installed, 'Funding     *
     F*           Spread/Rate' field will be available for 'SC' deal  *
     F*           amendments.                                         *
     F*  S01408 - Addition of core hooks MM0028CP30                   *
     F*           Addition of core hooks MM0028CP31                   *
     F*  S01408 - Addition of core hooks MM0028CP29                   *
     F*  101523 - Check Negative interest field (HKNGVI) being 'N'    *
     F*           - currently only checks for ' '.                    *
     F*  S01408 - Addition of core hooks MM0028CP24                   *
     F*           Addition of core hooks MM0028CP25                   *
     F*           Addition of core hooks MM0028CP26                   *
     F*           Addition of core hooks MM0028CP27                   *
     F*           Addition of core hooks MM0028CP28                   *
     F*  S01408 - Addition of core hooks MM0028IIP4                   *
     F*           Addition of core hooks MM0028CP23                   *
     F*  092455 - When checking whether loan amendment value date is  *
     F*           within rundate + notice days, calculation should    *
     F*           include only working days for both deal and local   *
     F*           currencies.                                         *
     F*  095244 - Recompiled for Calculation method 3                 *
     F*  095238 - Recompiled for Calculation method 3                 *
     F*  073682 - PROBLEM IF AUTHORISATION NOT DONE IN CORRECT        *
     F*           SEQUENCE FOR SEVERAL DEAL AMENDMENTS                *
     F*  S01408 - Addition of core hooks MM0028CP22                   *
     F*  087924 - Reset *IN65 when calling AOCNSTR0                   *
     F*  S01408 - Addition of core hooks MM0028CP20                   *
     F*           Addition of core hooks MM0028CP21                   *
     F*  S01408 - Addition of core hooks MM0028CP18                   *
     F*           Addition of core hooks MM0028CP19                   *
     F*  S01408 - Addition of core hooks MM0028IIP2                   *
     F*           Addition of core hooks MM0028IIP3                   *
     F*           Addition of core hooks MM0028CSFI                   *
     F*           Addition of core hooks MM0028CSF1                   *
     F*  S01408 - Addition of core hooks MM0028IIPG                   *
     F*           Addition of core hooks MM0028IIP1                   *
     F*           Addition of core hooks MM0028CEND                   *
     F*           Addition of core hooks MM0028CP17                   *
     F*           Addition of core hooks MM0028FFPG                   *
     F*           Addition of core hooks MM0028CVS7                   *
     F*  085052 - It is possible to do an input for Customer with a   *
     F*           branch that the user is not allowed to.             *
     F*  082738 - Rewrite of projected account movements.             *
     F*  S01408 - Addition of core hooks MM0028CCP1                   *
     F*           Addition of core hooks MM0028CCP2                   *
     F*           Addition of core hooks MM0028CCP3                   *
     F*           Addition of core hooks MM0028CCP4                   *
     F*           Addition of core hooks MM0028CCP5                   *
     F*           Addition of core hooks MM0028CCP6                   *
     F*           Addition of core hooks MM0028CCP7                   *
     F*           Addition of core hooks MM0028CCP8                   *
     F*           Addition of core hooks MM0028CP10                   *
     F*           Addition of core hooks MM0028CP11                   *
     F*           Addition of core hooks MM0028CP12                   *
     F*           Addition of core hooks MM0028CP13                   *
     F*           Addition of core hooks MM0028CP14                   *
     F*           Addition of core hooks MM0028CP15                   *
     F*           Addition of core hooks MM0028CP16                   *
     F*           Addition of core hooks MM0028CVS2                   *
     F*           Addition of core hooks MM0028CVS3                   *
     F*           Addition of core hooks MM0028CVS4                   *
     F*           Addition of core hooks MM0028CVS5                   *
     F*           Addition of core hooks MM0028CVS6                   *
     F*           Addition of core hooks MM0028CDB2                   *
     F*           Addition of core hooks MM0028CDB3                   *
     F*           Addition of core hooks MM0028CDB4                   *
     F*           Addition of core hooks MM0028CLD3                   *
     F*           Addition of core hooks MM0028CLD4                   *
     F*           Addition of core hooks MM0028EEPG                   *
     F*  083409 - SI amendment is allowed on same day as existing CI. *
     F*           This is caused by 076419 below which tries to       *
     F*           prevent a second SI on the same day but at the same *
     F*           time allows any other amendment type including CI.  *
     F*           076419 removed as original code seems to prevent a  *
     F*           second SI satisfactorily.                           *
     F*                                                               *
     F*  S01408 - Addition of core hooks MM0028CDB1                   *
     F*           Addition of core hooks MM0028CLD1                   *
     F*           Addition of core hooks MM0028CLD2                   *
     F*           Addition of core hooks MM0028CDBU                   *
     F*           Addition of core hooks MM0028CPCA                   *
     F*           Addition of core hooks MM0028CCB2                   *
     F*           Addition of core hooks MM0028CLDS                   *
     F*           Addition of core hooks MM0028CPCK                   *
     F*           Addition of core hooks MM0028CVS1                   *
     F*           Addition of core hooks MM0028CCB1                   *
     F*  S01408 - Addition of core hooks MM0028GDTA                   *
     F*                                  MM0028CVSF                   *
     F*                                  MM0028CCPG                   *
     F*  S01486 - Portfolio Management Upgrade to Release 10.         *
     F*           Recompile Only.                                     *
     F*  076419 - Only one SI amendment per value date allowed.       *
     F*                                                               *
     F*  076272 - 073516 incomplete                                   *
     F*                                                               *
     F*  073516 - Use decimal point and thousand separator as set up  *
     F*           in ICD                                              *
     F*  044740 - File was not updated even when customer shortname   *
     F*           was changed.                                        *
     F*  062436 - Database error in MM0078, file SDCNSTPD, at 036.    *
     F*           Counterparty nostros being written to file in       *
     F*           DRS (i.e. 2 part shortname) format.  AOCNSTR0       *
     F*           cannot find.  Same as E25683 on MM0089.             *
     F*  059667 - Quicken the authorisation function (follow the      *
     F*           procedures of FX deal authorisation).               *
     F*  S01408 - Core hook MM0028CBUW added                          *
     F*           Core hook MM0028CCBU added                          *
     F*           Core hook MM0028CBDU added                          *
     F*           Core hook MM0028CCBW added                          *
     F*  060779 - The confirmation matching feedback records are      *
     F*           not displaying the correct information. Set up      *
     F*           key correctly before chaining to LF/CFFEEDL0.       *
     F*  S01453 - MARGIN AND FX POSITIONS/POINTS AND BASE CURRENCY    *
     F*           POSITIONS/POINTS ADDED TO FX INPUT (RECOMPILED)     *
     F*  061426 - Recompile after ZDATE9 correction                   *
     F*  056095 - Interest not calculated consistently in MM.         *
     F*           SR. MM1009 was externally defined as ZINTDY,        *
     F*           while SR. ZA0710 and ZA0680 were replaced by        *
     F*           the externally defined standard SR. ZDATE9 and      *
     F*           ZDAT10, respectively.  Seventeen MM programs        *
     F*           were amended.  (MM0028 does not use MM1009.)        *
     F*  054017 - WHEN AMOUNT IS ENTERED IN AMOUNT FIELD AND F15      *
     F*           IS TAKEN, AMOUNT IS DISPLAYED IN TRANSACTIONS       *
     F*  051307 - HAD A PROBLEM WHERE THE LAST SEQUENCE NUMBER        *
     F*           WAS NOT BEING SHOWN.IT WAS FOUND THAT THE           *
     F*           INDICATOR WAS NOT TURNED ON IN THE RIGHT PLACE.     *
     F*           THEREFORE THE INDICATOR WAS TURNED ON BEFORE        *
     F*           THE SCREEN IS BLANKED OUT TO ACCEPT A NEW           *
     F*           CHANGED DEAL.                                       *
     F*  050588 - Value date warning check now done in SR #ZI.        *
     F*  050174 - Amendment type 'CI' should be validated in a        *
     F*           similar manner to a type 'SI' in that               *
     F*           a) Do not allow more than one 'CI' for the same     *
     F*              value date                                       *
     F*           b) If entered it must be the first amendment for    *
     F*              that value date                                  *
     F*           c) This also prevents both a 'CI' and an 'SI'       *
     F*              from being entered for the same value date.      *
     F*           Also remove part of E28503 relating to this as      *
     F*           it doesnt work.                                     *
     F*  049518 - a) E36546 was not applied to value date holidays    *
     F*              on payment side - these should be warning        *
     F*              errors.                                          *
     F*           b) If in insert mode  the amendment type is         *
     F*              changed from PI to PD without entering the       *
     F*              deal the settlement instructions are not         *
     F*              cleared. If the 'protected indicator' is on      *
     F*              then the protected fields should be blanked.     *
     F*           c) *IN31 (conf matching present) should not be      *
     F*              set on if value date in error.                   *
     F*           d) Clear screen error message queue before          *
     F*              revalidating screen 1 details after return       *
     F*              from settlement screen to prevent duplicate      *
     F*              warning messages.                                *
     F*  047741 - Do not blank out screen details if a validation     *
     F*           error occurs during authorisation.                  *
     F*  E49965 - BOOKING BRANCH ADDED TO DEAMSDI/MMDEAMPP            *
     F*  E47225 - CONDITION CALL TO AORETLR0 ON RETAIL BEING          *
     F*           PRESENT. ALSO ONLY CALL ACCESS PROGRAMS WITH        *
     F*           '*DBERR' IF THEY ARE ACCESSING ICDR                 *
     F*  E42414 - The deal number of matured deals can be             *
     F*           inserted. Chain deal number to DEALSH file          *
     F*           to trap matured deal numbers.  (Originally          *
     F*           23JUL92; fix then lost, and re-instated 17NOV92.    *
     F*  AUS007 - AUSTRALIAN BROKERAGE.                               *
     F*  E28503 - When checking for a deal amend only read for        *
     F*           the same deal number and value date.                *
     F*           Fix E27750 removed.                                 *
     F*  E36559 - Deal amendment cust. not equal cust from            *
     F*           related deal, reported in error.                    *
     F*  E36546 - Value Date holidays should only be warnings         *
     F*           E24193 was incomplete                               *
     F*  E29460 - Check principal amount to ensure deposit does       *
     F*           not become negative                                 *
     F*  E32101 - Prevent Deal Amendments for Deleted Deals           *
     F*  E29463 - Reset work indicator to avoid Counterparty          *
     F*           Nostro access program being called in error         *
     F*  E33979 - Allow deletion of any deal amendment.               *
     F*  S01354 - Add Internal Funding Deal Processing                *
     F*  E27750 - A user was able to enter a Deal Amendment           *
     F*           relating to a deal for a branch to which            *
     F*           he did not have any authority.                      *
     F*  E25518 - CANNOT AUTHORIZE A 'CI' DEAL AMENDMENT DUE TO       *
     F*           AMOUNT APPEARING IN 'RATE/SPREAD' FIELD.            *
     F*  S01319 - Remove redundant processing                         *
     F*  E24193 - Value Date holidays should only be warning          *
     F*           errors.                                             *
     F*  E24191 - Field IPSODA is to allow a Settlement Officer       *
     F*           to delete an ordinary deal not a DEAM. Correct      *
     F*           field for DEAMS should be IPDSDA.                   *
     F*  E24031 - Correction of move from display to file field       *
     F*           in order to correct a CoB confirmation printing     *
     F*           error in DL0195 (MOVE changed to MOVEL).            *
     F*  RT0150 - RECOMPILE PROGRAM FOR CHANGE IN MMSTDSPP            *
     F*  BHF972 - DEFAULT VALUES FROM SETTLE INSTRUCTIONS ON ONE      *
     F*           DEAL AMENDMENT ARE CARRIED OVER TO THE NEXT         *
     F*           AMENDMENT IF THE DEAL NUMBER AND VALUE DATE         *
     F*           REMAIN THE SAME                                     *
     F*  BHF947 - DOES NOT CHECK DATE FORMAT PROPERLY FOR VALIDATN    *
     F*           IF BACKVALUED AMENDMENT DOES NOT CHECK PRINCIPAL    *
     F*           CORRECTLY. (SKIP FIRST AMENDMENT)                   *
     F*  BHF946 - RESET INDICATOR OF DATABASE ERROR OCCURS            *
     F*  BHF944 - PUT THE PAY OR REC BRANCH INTO OUR SETTLEMENT       *
     F*           BRANCH OR ELSE MAY SETTLE TO WRONG BRANCH           *
     F*  BHF914 - UNABLE TO ENTER SETTLEMENT DETAILS FOR SI           *
     F*           AMENDMENTS TO CALL NOTICE DEALS                     *
     F*  BHF907 - UNABLE TO DELETE AN AMENDMENT IMMEDIATELY AFTER     *
     F*           INSERTING OR AMENDING                               *
     F*  BHF906 - EXTEND FIX E20204 TO COVER DL DEAL TYPE             *
     F*  DT0091 - Incorrect side of settlement instructions           *
     F*           displayed when negative interest ind = Y            *
     F*  DT0058 - UNABLE TO SETTLE INTEREST ON A CALL LOAN OR A       *
     F*           CALL DEPOSIT                                        *
     F*  DT0015 - RECOMPILED                                          *
     F*  DT0010 - Call to MM0031 removed.  MM0031 is now              *
     F*           called in MIPGM.                                    *
     F*  S01314 - Incorporation changes                               *
     F*  S01304 - CHANGES MADE DURING CONFIRMATION MATCHING           *
     F*           INCORPORATION.                                      *
     F*  S01184 - CONFIRMATION MATCHING                               *
     F*           Display counterparty/broker match status            *
     F*  E23406 - Check for modules RE(RETAIL 2) or IA(INTEREST       *
     F*           ON ACCOUNTS).                                       *
     F*  E20204 - Amendment type 'SI' should also be allowed for      *
     F*           deal types CL and CD.                               *
     F*  E23326 - E21202 causes wrong deams to be displayed from      *
     F*           select processing.                                  *
     F*           (SEE BHF183)                                        *
     F*  E22271 - Allow 'PI', 'PD' and 'SC' deal amendments with      *
     F*           value date equal to the later of interest date      *
     F*           and last rate change date.                          *
     F*           Error if 'CI' or 'SI' deal amendments have          *
     F*           value date less than or equal to last interest      *
     F*           date or interest accrual date.                      *
     F*  E23041 - If a zero rate was inserted for an SC deam,         *
     F*           it would subsequently be displayed as blank and     *
     F*           would therefore fail authorisation validation.      *
     F*  E21202 - PROGRAM REFORMATS DATE FROM 'MMDDYY' TO             *
     F*           'DDMMYY'                                            *
     F*           (SEE BHF183)                                        *
     F*  E23032 - Number of integers calculated in ZA0840 is one      *
     F*           too many if leading zeros are entered.              *
     F*  E22744 - Enquire on deleted deal,then insert another         *
     F*           deal the deleted flag stays on.(Caption 'DELETED'   *
     F*           remains at bottom of screen.)                       *
     F*           (SEE BHF632)                                        *
     F*  E22315 - Deal No of the amendment record is compared with    *
     F*           deal numbers in the deal amendment file rather      *
     F*           than the deals file.                                *
     F*  E22668 - When the customer has leading zeros one can         *
     F*           enter either just the customer number without       *
     F*           the leading zeros or as many zeros as one can       *
     F*           enter & then the customer number.The customer       *
     F*           number should be 6 numeric.                         *
     F*           (REDUNDANT - ACCESS OBJECTS NOW USED)               *
     F*  E20031 - With F15 processing where multiple deals are        *
     F*           selected,with any other action than Enquire         *
     F*           only the first deal selected is displayed.          *
     F*           Ensure that with Range Authorisation that the       *
     F*           deals in the range selected are displayed,          *
     F*           with the option not to authorise if desired.        *
     F*           (PARTLY SUPERSEDED BY LN0367)                       *
     F*  E22161 - Introduction of M = Million,T = Thousand            *
     F*           processing. (SEE E17279)                            *
     F*           On options available 'X' is displayed even if       *
     F*           back office authorisation is not required.This      *
     F*           was because the field H1BOAR was tested before      *
     F*           its file MMSSTSLL was opened and read.              *
     F*  S01253 - CHANGED FOR MULTILANGUAGE SCREENS                   *
     F*  E20774 - Replace QCAEXEC with QCMDEXC                        *
     F*  E20344 - AMENDED DELETION OF DEAL AMENDMENTS SO THAT THEY    *
     F*           CANNOT BE DELETED IF THE AMENDMENT VALUE DATE IS    *
     F*           PRIOR TO THE RUN DATE.ALSO ANNOTATED OUT            *
     F*           UNWANTED AMOUNT VALIDATION WHEN DELETION            *
     F*           REQUESTED.                                          *
     F*  E16441 - FOR LOAN/DEPOSIT/CD ISSUED(I.E NOTICE DAYS) THE     *
     F*           VALUE DATE OF AN AMENDMENT MUST BE EARLIER THAN     *
     F*           THR RUNDATE PLUS NOTICE DAYS.                       *
     F*  BHF635 - IF A CUST. NO. IS INPUT ON FIELD 56 OF RECEIVE      *
     F*           SETT. INST., PROGRAM SHOULD NOT CALL 'AOCNSTR0'     *
     F*           TO VALIDATE COUNTERPARTY NOSTROS DETAIL.            *
     F*  LN0822 - SETTLEMENT METHOD NOT WRITTEN TO DEAMSDI.           *
     F*           ALSO SETTLEMENT BRANCH.                             *
     F*  BHF632 - DELETE INDICATOR NOT RESET BEFORE ACTION CODE       *
     F*           AND DEAL NUMBER VALIDATION (ALSO E22744/160074)     *
     F*  BHF488 - DISPLAY DEAL NUMBER ON SETTLEMENTS SCREEN           *
     F*           IF KNOWN                                            *
     F*  BHF430 - SHOULD ONLY CHECK NOSTRO IF ENTERED, CAN ONLY       *
     F*           ENTER ONE NOSTRO SO CHECK WHICH ONE IS ENTERED      *
     F*  LN0663 - Code missed out during S01177 incorporation         *
     F*  LN0637 - AOMMODR0 not being called                           *
     F*  BHF439 - To reverse BHF298 which is incorrect                *
     F*  E22405 - Add new field to Extended Settlements.(Cover        *
     F*           MT202 required).                                    *
     F*  BHF298 - To prevent record locking of MMDAMULL on an         *
     F*           amend                                               *
     F*  E17279 - Introduction of M = Million,T = Thousand            *
     F*           processing.                                         *
     F*  BHF183 - VALUE DATE UPDATED INCORRECTLY WHEN AMERICAN        *
     F*           DATE FORMAT REQUIRED                                *
     F*  LN0488 - RECEIVE NOSTRO SHOULD ONLY BE VALIDATED IF          *
     F*           ENTERED.(TO CORRECT LN0234)                         *
     F*  LN0367 - WHEN MM0028 IS CALLED VIA RANGE AUTHORIZATION       *
     F*           PROGRAM DEAL DETAILS ARE NOT BEING DISPLAYED.       *
     F*  LN0356 - F15 SELECT SCREEN OR 'E' ENQUIRE NOT DISPLAYING     *
     F*           DEALS BECAUSE DEAL BRANCH CODE IS NOT BEING         *
     F*           PASSED FOR USER AUTHORISATION.                      *
     F*  LN0234 - VALUE DATE HOLIDAY VALIDATION NOT BEING CARRIED     *
     F*           OUT USING SYSTEM OR NOSTRO LOCATION. VALUE DATE     *
     F*           VALIDATION NOT BEING CARRIED OUT AGAIN AFTER        *
     F*           EXTENDED SETTLEMENT DETAILS ENTERED. VALUE DATE     *
     F*           VALIDATION ONLY TO BE CARRIED OUT AFTER             *
     F*           SETTLEMENT INSTRUCTIONS ENTERED.                    *
     F*  E20897 - CORRECTING REPEAT USE OF IN15 DONE IN S01227        *
     F*           INCORPORATION.IN17 USED AS SUBSTITUTE.              *
     F*  E20829 - ON USING F15 PROCESSING A LOOP OCCURS WHEN          *
     F*           AN ERROR MSG IS IGNORED ON ATTEMPTING               *
     F*           AUTHORISATION WHEN ENDORSING SETTLEMENT             *
     F*           DETAILS AMENDMENT. ENTER IS PRESSED WHEN            *
     F*           ACTION CODE IS BLANK.                               *
     F*  E15515 - To remove any embeded BLANKS in the construction    *
     F*           of Standard Deals Member for User ID with only      *
     F*           one or two characters.                              *
     F*  S01227 - EXTENDED SETTLEMENTS INCORPORATION - CHANGE         *
     F*           OF PROGRAM NAMES SDKTPVR TO SD2400 AND              *
     F*           SDKUUPR TO SD2410.                                  *
     F*  E286   - ONLY SEND ROBR, POBR FOR METHOD '05'                *
     F*  E284   - INCORRECT PARAMETER USED                            *
     F*  S01199 - ABS HELP                                            *
     F*  E214   - SDKTPVR & SDKUUPR renamed SD2400 & SD2410           *
     F*  E70    - USE OF '?' WITH ACCESS PROGRAMS                     *
     F*  E18811 - Amended program so that when a PD is input          *
     F*           the program takes into account any PI's on the      *
     F*           file when calculating whether the affect of the     *
     F*           PD is to reduce the Principal below zero.           *
     F*  E18663 - Amended Deals File processing to ensure that the    *
     F*           program only subtracts deal amendments with         *
     F*           the same deal number as the current deal            *
     F*           number.                                             *
     F*  S01218 - Recompiled to include new file layouts for          *
     F*           capital markets dealing interface                   *
     F*  E18380 - Program was recompiled with new formats for the     *
     F*           standard deal files. This stops the book code       *
     F*           and linked reference number fields from being       *
     F*           overwritten.                                        *
     F*  E18139 - Speed up response time on deal update by            *
     F*           writing deal input screen while update taking       *
     F*           place. Involves splitting SR #ZE into #ZE & #ZEA    *
     F*  E17654 - REMOVE LOCATION CODE VALIDATION                     *
     F*           (NOTE: THIS HAS BEEN SUPERCEDED BY S01177)          *
     F*  E17050 - Don't default For Accnt Of and Special              *
     F*           instruction fields if values have already been      *
     F*           entered there.                                      *
     F*           (NOTE: THIS HAS BEEN SUPERCEDED BY S01177)          *
     F*  E17021 - Remove COMIT from between MM0078 and MM0082         *
     F*           so that DRS & MIDAS update in the same comit        *
     F*           cycle. E14354 not applied completely.               *
     F*  E16027 - Fixes for accepting Counterparty Nostro             *
     F*           Shortname in FACO field and make sure DRS           *
     F*           Shortname will go into the DRS for A/C of           *
     F*           field.                                              *
     F*  S01117 - MULTI-BRANCHING MODIFICATIONS                       *
     F*  S01177 - EXTENDED SETTLEMENT DETAILS                         *
     F*  S01194 - REL 10 COPYRIGHT STATEMENTS                         *
     F*           REL 10 HOLIDAYS PROCESSING                          *
     F*  E16041 - Fix Database Error 009 caused by Customer           *
     F*           Shortname/Number in Counterparty Pay/Receive        *
     F*           Instructions. Also, when an error occurred,         *
     F*           program dumped twice and then continued.            *
     F*  E13747 - The program now uses MIDAS default standard         *
     F*           settlement instructions.                            *
     F*  E14354 - Remove COMIT from between MM0078 and MM0082         *
     F*           so that DRS & Midas update is in same comit         *
     F*           cycle.                                              *
     F*  E14379 - Program should issue a WARNING message for          *
     F*           Deal Amendments to call/notice deals if the         *
     F*           deam value date is less than the associated         *
     F*           deal value date + notice days.                      *
     F*  E14363 - C'Party Bank's local currency should be the         *
     F*           same as the Deal Currency.                          *
     F*  E13873 - Correct error message now issued for invalid        *
     F*           C'Party Paying/Recieving Bank Details.              *
     F*  E12314 - message for successful insertion of deam            *
     F*           altered to include sequence number.                 *
     F*  E12145 - when entering an SI Deam, check that the            *
     F*           associated NAb has not already been sold.           *
     F*  E12141 - check that customer name/number input for the       *
     F*           deam is equal to that for the deal upon which       *
     F*           the deam is based.                                  *
     F*  S01136 - message for successful insertion of deam            *
     F*              altered to include sequence number.              *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F****************************************************************
     F*                                                              *
     F* ID F  C  H  L    FUNCTION OF INDICATORS                      *
     F*                                                              *
     F*       KC         Exit program.                               *
     F*       KL         Return to blank screen or, if screen blank, *
     F*                  exit program.                               *
     F*       KH         Advance to next record.                     *
     F*       KG         Go to previous record.                      *
     F*       KN         Settlement screen.                          *    S01177
     F*       KP         Select processing required.                 *
     F********KY*********Confirm delete.                             *
      *       KJ         Confirm delete.                             *
     F*                                                              *
     F*       01         Error on field DDACTN                       *
     F*       02         Error on field DDDLNO                       *
     F*       03         Error on field DDMTYP                       *
     F*       05         LOKUP Counterparty/Broker STATUS TABLE      *    S01184
     F*       10         Error on field DDCSNM                       *
     F*       11         Error on field DDVDAT                       *
     F*       14         Error on field DDLSQN                       *
     F*       15         Error on field DDDS38                       *
     F*       16         Error on field DDCCY                        *
     F*       17         F12 ESCAPE FROM AUTHORISATION CONFIRMATION  *    E20897
     F*       18         Error on field DDAMNP                       *
     F*       19         #ZD called from within F15 processing       *    S01184
     F*       20         Error on field DDINTR                       *
     F/COPY WNCPYSRC,MM0028FFP1                                           S01408
     F*       21         Analytical Accounting is installed          *    CAC001
     F*       22         Settlement screen called                    *    LN0234
     F*       23         Error on field DDFSRP                       *    CAC001
     F*       24         Perform tolerance check                     *    CAC001
     F******  31         Error on field DDORCM                       *    S01177
     F******  33         Error on field DDMORI                       *    S01177
     F******  35         Error on field DDMCPI                       *    S01177
     F******  37         Error on field DDMFAD                       *    S01177
     F*                                                              *
     F*       31         CONFIRMATION MATCHING present               *    S01184
     F*       35         "INSERT" so do not display FEEDBACK         *    S01184
     F*       36         On => no broker involved                    *    S01184
     F*       37         Chain fail CFFEEDL0                         *    S01184
     F*       38         Display deal status DDSTS                   *
     F*       39         Display and reverse image Deleted Message.  *
     F*                                                              *
     F*       41         Error has occurred in screen validation.    *
     F*                                                              *
     F*       42         F10 is enabled.                             *
     F*                                                              *
     F*       43         Position cursor under key.                  *
     F*       44         Position cursor under first non-key field.  *
     F*                                                              *
     F*       45         Select processing in progress.              *
     F*       46         Controls SFLCLR on select screen.           *
     F*       47         Allows write to msg control fmt without the *
     F*                  screen being displayed.                     *
     F*       48         Inhibit input for non-amendable amount field*
     F*       49         Inhibit input for non-amendable fields      *
     F*       50         ROLLUP key pressed.                         *
     F*       55         Warning error indicator.                    *    E14379
     F*       57         Input screen displayed already              *    E18139
     F*       58         No more selected records on subfile.        *
     F*       59         Controls SFLEND on Display File.            *
     F*                                                              *
     F*                                                              *
     F*       60         Failure on read of display file.            *
     F*       61         Data base errors in first cycle processing  *
     F*       62         Deal number is numeric.                     *
     F*       63         Deal number is numeric with leading blanks  *
     F*       64         Action code changed.                        *
     F*       65         General indicator used in validation        *
     F*       66         indicates error in settlement instructions  *
     F*       67         customer number has changed                 *
     F*       68         S.I. defaults performed                     *
     F*       69         error in SI validation.                     *
     F*       70         end of file of deals file                   *
     F*       71         beginning of deals file                     *
     F*       72         record locked on deals file                 *
     F*       73         TESTZ                                       *
     F*       76         Enable CMD/14                               *    S01177
     F*       78         external transaction taken place            *
     F*       79         update record locked                        *
     F*                                                              *
     F*       80-99      Standard subroutine indicators.             *
     F*                                                              *
     F*       U7         Set on with U8 if a database error occurs.  *
     F*       U8         File out of balance if on on its own.       *
     F*                                                              *
     F****************************************************************
     F/EJECT
     F*FDINSTLLIF**E*******************DISK*********KINFSR**PSSR******UC**S01319
     F*DICDRLLIF  E           K        DISK         KINFSR *PSSR *****UC  S01194
     F*XTB40LLIF  E           K        DISK         KINFSR *PSSR *****UC  S01194
     FMMMCOMLLIF  E                    DISK         KINFSR *PSSR      UC
     F*MMSSTSLLIF**E*******************DISK*********KINFSR**PSSR******UC**S01319
     F*MMUAUTLLIF**E*******************DISK*********KINFSR**PSSR******UC**S01319
     F*MMUSERLLIF**E**********K********DISK*********KINFSR**PSSR******UC**S01319
     FMMCMPLLLIF  E           K        DISK         KINFSR *PSSR      UC
     F            MMDELDP0                          KIGNORE
     F            MMDENBP0                          KIGNORE
     F            MMDENSP0                          KIGNORE
     FMMCARMLLIF  E           K        DISK         KINFSR *PSSR      UC
     F            MMDEAMP0                          KRENAMEMMDEAMP1
     FMMLVDMLLIF  E           K        DISK         KINFSR *PSSR      UC
     F            MMDEAMP0                          KRENAMEMMDEAMP4
     F*DTABJLLIF  E           K        DISK         KINFSR *PSSR      UC  S01195
     F*FDRETALLIF**E***        K        DISK         KINFSR *PSSR      UC S01177
     F*********** ACCNTABF                          KRENAMEFDRETAL0       S01177
     F*ACCNT***IF**E           K        DISK         KINFSR *PSSR      UC S01177
     F*********** ACCNTAAF                          KIGNORE               S01177
     F************ACCNTACF                          KIGNORE               S01177
     F*LINT   IF  E           K        DISK         KINFSR *PSSR *****UC  S01194
     F*           CLINTCAF                          KIGNORE      *****    S01194
     F*           CLINTCCF                          KIGNORE      *****    S01194
     F*NAME   IF  E           K        DISK         KINFSR *PSSR *****UC  S01194
     F*           CLINTCBF                          KRENAMESNAMEF*****    S01194
     F*DCCYTLLIF  E           K        DISK         KINFSR *PSSR *****UC  S01194
     F*           TABTG10F                          KRENAMETABTG1*****    S01194
     F*DTBLILLIF  E           K        DISK         KINFSR *PSSR *****UC  S01194
     F********** FDCCCYLLIF  EK        DISK         KINFSR *PSSR      UC  E13747
     F********** FDNOSTLLIF  EK        DISK         KINFSR *PSSR      UC  E13747
     F**********  TABLETLF                          KRENAMETABLETL        E13747
     F*DCPTILLIF  E           K        DISK         KINFSR *PSSR***** UC  S01194
     F*FDLCY1LLIF**E********  K        DISK         KINFSR *PSSRUC E14363 S01177
     F********** FDSNAMLLIF  EK        DISK         KINFSR *PSSR      UC  E13747
     F**********  TABLET2F                          KRENAMEFDSNAML0       E13747
     FMMDEALLLIF  E           K        DISK         KINFSR *PSSR      UC
     F                                              KINFDS @MDEAL
     F            MMDELDP0                          KRENAMEMMDELDP2
     F            MMDENBP0                          KRENAMEMMDENBP2
     F            MMDENSP0                          KRENAMEMMDENSP2
     FMMDEAMLLIF  E           K        DISK         KINFSR *PSSR      UC
     F            MMDEAMP0                          KRENAMEMMDEAMP2
     FDEALSH  IF  E           K        DISK         KINFSR *PSSR      UC  E42414
     F            DEALSDBF                          KRENAMEDEALSHBF       E42414
     F            DEALSDCF                          KRENAMEDEALSHCF       E42414
     F            DEALSDDF                          KRENAMEDEALSHDF       E42414
     F            DEALSDEF                          KRENAMEDEALSHEF       E42414
     F            DEALSDGF                          KRENAMEDEALSHGF       E42414
     FMM0028DDCF  E                    WORKSTN      KINFSR *PSSR      UC
     F                                        @RRN  KSFILE MM0028S3
     F/COPY WNCPYSRC,MM0028F001
     FMMDAMULLUF  E           K        DISK         KINFSR INFSR A    UC
     F                                              KINFDS INFDS
     F            MMDEAMP0                          KRENAMEMMDEAMP3
     F                                              KCOMIT
     F*STDSI***IF**E****       K        DISK        KINFSR *PSSRUC E13747 S01177
     F**********  STDSIAAF                          KIGNORE        E13747 S01177
     FCFFEEDL0IF  E           K        DISK                               S01184
     F*                                                                   S01408
     F/COPY WNCPYSRC,MM0028FFPG                                           S01408
     F*                                                                   S01408
     E/COPY ZSRSRC,ZHOLE                                                  S01195
     E/COPY ZSRSRC,ZF2CE                                                  092455
     E*                                                                   092455
     E                    CPY@    1   1 80                                S01194
     E* ARRAY FOR COPYRIGHT STATEMENT                                     S01194
     E********************@TYP   13  13  2                                S01354
     E                    @TYP   15  15  2                                S01354
     E**  ARRAY TO LOOK UP DEAL TYPE.
     E*
     E********************@DT2   13  13  2                                S01354
     E                    @DT2   15  15  2                                S01354
     E**  ARRAY TO LOOK UP MIDAS DEAL TYPE FOR VALIDATION.
     E*
     E                    @TXT    1   2 25
     E**  Array to hold key field descriptive text for screen messages.
     E*
     E********************@STSA***1***5*24********************************S01319
     E                    @STSA   1   4 24                                S01319
     E*                                                                   S01408
     E/COPY WNCPYSRC,MM0028EEPG                                           S01408
     E*                                                                   S01408
     E**  Array of text for the status.
     E*
     E*****               @CY        50  3                        *****   S01195
     E****Used by SR. ZA0830 - ccy records.                       *****   S01195
     E*
     E                    @F         16  1
     E**  Input array for ZA0840
     E*
     E                    @G         16  1
     E**  Output array for ZA0840
     E*
     E                    @H      1  15 15 0
     E**  Array of powers of ten
     E*
     E***********         @YD     4   4  5 0A                             056095
     E****Array*for*SR.*ZA0710*-*Cumulative*days*in*year*for*4*year*period056095
     E*
     E***********         @MD    13  13  5 0A                             056095
     E****Array*for*SR.*ZA0710*-*Cumulative*days*in*year*per*month.****   056095
     E*                                                                   056095
     E/COPY ZSRSRC,ZDATE9Z1                                               056095
     E**  Array for SR. ZDATE9                                            056095
     E*
     E                    @Z         14  1
     E**  Array @Z stores amount with decimal.(Execution time array)
     E*
     E                    @Q         13  1 0
     E**  Array @Q stores amount as it is.(Execution time array)
     E*
     E********************@CMD****1***1*30********************************S01319
     E***Command*used*on*call*to*QCAEXEC**********                        E20774
     E***Command*used*on*call*to*QCMDEXC****************************E20774S01319
     E*
     E********************@V      1   4 20                                S01177
     E****Array to hold event date names.                                 S01177
     E*****                                                               S01177
     E****E15515*-*Initial*array*with*embeded*BLANKS****************E15515S01319
     E********************@IA********10**1**************************E15515S01319
     E****E15515*-*Ending*array*without*any*embeded*BLANKS**********E15515S01319
     E********************@EA********10**1**************************E15515S01319
     E                    TABA    1  10  2   TABB   15                    S01184
     E*   Counterparty and Broker STATUS Codes and associated text        S01184
     E*****************************************************************   S01184
     E*                                                                   E15515
     E                    STAMP   1   1 26                                                    CPK014
      ** Array containing dummy timestamp                                                     CPK014
     I*
     I** Rename fields on deals file with common names to simplify processing
     IMMDELDP2
     I              HKRCID                          H@RCID
     I              HKDLTF                          H@DLTF
     I              HKDDLT                          H@DDLT                E32101
     I              HKMTYP                          H@MTYP
     I              HKRBSI                          H@RBSI
     I              HKVDYY                          H@VDYY
     I              HKVDMM                          H@VDMM
     I              HKVDDD                          H@VDDD
     I              HKCDRP                          H@CDRP
     I              HKDUSC                          H@DUSC
     I              HKAOFR                          H@AOFR
     I              HKSLYY                          H@SLYY
     I              HKSLMM                          H@SLMM
     I              HKSLDD                          H@SLDD
     I              HKIAYY                          H@IAYY
     I              HKIAMM                          H@IAMM
     I              HKIADD                          H@IADD
     I              HKIPFQ                          H@IPFQ
     I              HKNIDD                          H@NIDD
     I              HKNIMM                          H@NIMM
     I              HKNIYY                          H@NIYY
     I              HKTYPE                          H@TYPE
     I/COPY WNCPYSRC,MM0028I004
     I              HKCNUM                          H@CNUM
     I              HKCCY                           H@CCY
     I              HKDN38                          H@DN38
     I              HKAMNP                          H@AMNP
     I              HKDSTS                          H@DSTS
     I              HKMDYY                          H@MDYY
     I              HKMDMM                          H@MDMM
     I              HKMDDD                          H@MDDD
     I*****         HKBRCD                          H@BRCD        S01177  S01117
     I              HKBRCA                          H@BRCA                S01117
     I              HKORBR                          H@ORBR                E
     I              HKBKCD                          H@BKCD                S01184
     I              HKCSNM                          H@CSNM                S01354
     I              HKDADN                          H@DADN                S01354
     I              HKROBR                          H@ROBR                S01354
     I              HKPOBR                          H@POBR                S01354
     I*                                                                   S01408
     I/COPY WNCPYSRC,MM0028IIPG                                           S01408
     I*
     IMMDENBP2
     I              HLRCID                          H@RCID
     I              HLDLTF                          H@DLTF
     I              HLDDLT                          H@DDLT                E32101
     I              HLMTYP                          H@MTYP
     I              HLVDYY                          H@VDYY
     I              HLVDMM                          H@VDMM
     I              HLVDDD                          H@VDDD
     I              HLRBSI                          H@RBSI
     I              HLLIYY                          H@SLYY
     I              HLLIMM                          H@SLMM
     I              HLLIDD                          H@SLDD
     I              HLIPFQ                          H@IPFQ
     I              HLNIDD                          H@NIDD
     I              HLNIMM                          H@NIMM
     I              HLNIYY                          H@NIYY
     I              HLTYPE                          H@TYPE
     I/COPY WNCPYSRC,MM0028I005
     I              HLCNUM                          H@CNUM
     I              HLCCY                           H@CCY
     I              HLDN38                          H@DN38
     I              HLAMNP                          H@AMNP
     I              HLCDRP                          H@CDRP
     I              HLDUSC                          H@DUSC
     I              HLAOFR                          H@AOFR
     I              HLIAYY                          H@IAYY
     I              HLIAMM                          H@IAMM
     I              HLIADD                          H@IADD
     I              HLDSTS                          H@DSTS
     I              HLMDYY                          H@MDYY
     I              HLMDMM                          H@MDMM
     I              HLMDDD                          H@MDDD
     I*****         HLBRCD                          H@BRCD        S01177  S01117
     I              HLBRCA                          H@BRCA                S01117
     I              HLBKCD                          H@BKCD                S01184
     I              HLORBR                          H@ORBR
     I*                                                                   S01408
     I/COPY WNCPYSRC,MM0028IIP3                                           S01408
     I*                                                                   S01408
     IMMDENSP2
     I              HMRCID                          H@RCID
     I              HMDLTF                          H@DLTF
     I              HMDDLT                          H@DDLT                E32101
     I              HMMTYP                          H@MTYP
     I              HMVDYY                          H@VDYY
     I              HMVDMM                          H@VDMM
     I              HMVDDD                          H@VDDD
     I              HMRBSI                          H@RBSI
     I              HMLIYY                          H@SLYY
     I              HMLIMM                          H@SLMM
     I              HMLIDD                          H@SLDD
     I              HMCDRP                          H@CDRP
     I              HMDUSC                          H@DUSC
     I              HMAOFR                          H@AOFR
     I              HMIPFQ                          H@IPFQ
     I              HMNIDD                          H@NIDD
     I              HMNIMM                          H@NIMM
     I              HMNIYY                          H@NIYY
     I              HMTYPE                          H@TYPE
     I/COPY WNCPYSRC,MM0028I006
     I              HMCNUM                          H@CNUM
     I              HMCCY                           H@CCY
     I              HMDN38                          H@DN38
     I              HMAMNP                          H@AMNP
     I              HMDSTS                          H@DSTS
     I              HMMDYY                          H@MDYY
     I              HMMDMM                          H@MDMM
     I              HMMDDD                          H@MDDD
     I*****         HMBRCD                          H@BRCD        S01177  S01117
     I              HMBRCA                          H@BRCA                S01117
     I              HMBKCD                          H@BKCD                S01184
     I              HMORBR                          H@ORBR
     I*                                                                   S01408
     I/COPY WNCPYSRC,MM0028IIP2                                           S01408
     I*                                                                   S01408
     IZ#BSTS    E DSZ#BST                                                 082738
     IZ#ASTS    E DSZ#AST                                                 082738
     IZ#WSTS    E DSZ#WST                                                 082738
     I*
     I@STDDL    E DSMMSTDLPP
     I**  Data structure of the standard deal, Loan Deposit format.
     I*
     I@STDDB    E DSMMSTDBPP
     I**  Data structure of the standard deal, N.A. Bought format.
     I              QQDORI                          QQDOR1                                    CGL029
     I              QQMORI                          QQMOR1                                    CGL029
     I              QQDOPI                          QQDOP1                                    CGL029
     I              QQMOPI                          QQMOP1                                    CGL029
     I              QQBORI                          QQBOR1                                    CGL029
     I              QQBOPI                          QQBOP1                                    CGL029
     I              QQRONS                          QQRON1                                    CGL029
     I              QQPONS                          QQPON1                                    CGL029
     I*
     I@STDDS    E DSMMSTDSPP
     I**  Data structure of the standard deal, N.A. Sold format.
     I              QQDORI                          QQDOR2                                    CGL029
     I              QQMORI                          QQMOR2                                    CGL029
     I              QQBORI                          QQBOR2                                    CGL029
     I              QQBOPI                          QQBOP2                                    CGL029
     I              QQRORI                          QQROR2                                    CGL029
     I              QQROPI                          QQROP2                                    CGL029
     I              QQRONS                          QQRON2                                    CGL029
     I              QQPONS                          QQPON2                                    CGL029
     I*
     I@STDDA    E DSMMSTDAPP
     I**  Data structure of the standard deal, Deams format.
     I              QQDORI                          QQDOR3                                    CGL029
     I              QQMORI                          QQMOR3                                    CGL029
     I              QQDOPI                          QQDOP3                                    CGL029
     I              QQMOPI                          QQMOP3                                    CGL029
     I              QQBORI                          QQBOR3                                    CGL029
     I              QQBOPI                          QQBOP3                                    CGL029
     I              QQRORI                          QQROR3                                    CGL029
     I              QQROPI                          QQROP3                                    CGL029
     I              QQPONS                          QQPON3                                    CGL029
     I              QQRONS                          QQRON3                                    CGL029
     I*
     I@DEAM     E DSMMDEAMPP
     I              QQDORI                          QQDOR4                                    CGL029
     I              QQMORI                          QQMOR4                                    CGL029
     I              QQDOPI                          QQDOP4                                    CGL029
     I              QQMOPI                          QQMOP4                                    CGL029
     I              QQPONS                          QQPON4                                    CGL029
     I              QQRONS                          QQRON4                                    CGL029
     I                                       51  52 @DMVYR
     I                                       53  54 @DMVMT
     I                                       55  56 @DMVDY
     I/COPY WNCPYSRC,MM0028I003
     ISDBANK    E DSSDBANKPD                                              S01194
     I* BANK DETAILS ACCESSED VIA ACCESS PROGRAM                          S01194
     I*                                                                   S01194
     ISDMMOD    E DSSDMMODPD                                              S01194
     I* MODULE DETAILS ACCESSED VIA ACCESS PROGRAM                        S01194
     I*                                                                   S01194
     ISDGELR    E DSSDGELRPD                                              S01194
     I* GENERAL LEDGER DETAILS ACCESSED VIA ACCESS PROGRAM                S01194
     I*                                                                   S01194
     ISDRETL    E DSSDRETLPD                                              S01194
     I* RETAIL DETAILS ACCESSED VIA ACCESS PROGRAM                        S01194
     I              QQACCD                          QQACD5                                    CGL029
     I*                                                                   S01194
     ISDNOST    E DSSDNOSTPD                                              S01194
     I* NOSTRO DETAILS ACCESSED VIA ACCESS PROGRAM                        S01194
     I              QQACCD                          QQACD6                                    CGL029
     I*                                                                   S01194
     ISDCUST    E DSSDCUSTPD                                              S01194
     I* CUSTOMER DETAILS ACCESSED VIA ACCESS PROGRAM                      S01194
     I*                                                                   S01194
     ISDCURR    E DSSDCURRPD                                              S01194
     I* CURRENCY DETAILS ACCESSED VIA ACCESS PROGRAM                      S01194
     I*                                                                   S01194
     ISDCNST    E DSSDCNSTPD                                              S01194
     I* COUNTERPARTY NOSTROS DETAILS ACCESSED VIA ACCESS PROGRAM          S01194
     I*                                                                   S01194
     ISDDEAL    E DSSDDEALPD                                              S01319
     I** EXTERNAL DS FOR DEALING DETAILS                                  S01319
     I              QQACCD                          QQACD7                                    CGL029
     I*                                                                   S01319
     ISCSARD    E DSSCSARDPD                                              CEU003
      ** Switchable Features File                                         CEU003
      *                                                                   CEU003
     ISDPCAC    E DSSDPCACPD                                              CAC001
      **  External DS for PCA ICD Details                                 CAC001
      *                                                                   CAC001
     ISDBSRT    E DSSDBSRTPD                                              CAC001
      **  External DS for Base Rate Codes                                 CAC001
      *                                                                   CAC001
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   S01117
     IDSSDY     E DSDSSDY                                                 S01194
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE                S01194
     I*                                                                   S01194
     I**  Data structure of the MM DEAM
     I*
      *                                                                   S01177
     I@PARM2    E DSSETLIAB                                               S01177
     I              QQRONS                          QQRON8                                    CGL029
     I              QQPONS                          QQPON8                                    CGL029
      *                                                                   S01177
      ** data structure for passing a parameter to synon screen           S01177
      *  handling program.                                                S01177
      *                                                                   S01177
     I@PARM3    E DSSETLIAZ                                               S01177
     I/COPY WNCPYSRC,MM0028IIP5                                           S01408
      *                                                                   S01177
      ** data structure for passing a parameter to synon screen           S01177
      *  handling program.                                                S01177
     IWDUMMY      DS                            648                       CEU003
     I** data structure for passing parameter to PGM SD2400               CEU003
     I** (Note: length of DS must equal length of PF/SETLDPD)             CEU003
     I*                                                                   CEU003
     I            DS
     I*
     I**  Data Structure for screen value date
     I                                        1   6 DDVDAT
     I                                        1   2 @DSPD
     I                                        3   4 @DSPM
     I                                        5   6 @DSPY
     I            DS
     I*
     I**  Data Structure for input start/last interest date
     I                                        1   80H@SLDT
     I                                        1   40H@SLYY
     I                                        5   60H@SLMM
     I                                        7   80H@SLDD
     I*
     I            DS
     I*
     I**  Data Structure for input next interest date
     I                                        1   80H@NIDT
     I                                        1   40H@NIYY
     I                                        5   60H@NIMM
     I                                        7   80H@NIDD
     I*
     I            DS
     I*
     I**  Data Structure for input value date
     I                                        1   80H@VDAT
     I                                        1   40H@VDYY
     I                                        5   60H@VDMM
     I                                        7   80H@VDDD
     I*
     I            DS
     I**  Data Structure for input interest accrual control date
     I                                        1   80H@IADT
     I                                        1   40H@IAYY
     I                                        5   60H@IAMM
     I                                        7   80H@IADD
     I*
     I            DS
     I**  Data Structure for input maturity date
     I                                        1   80H@MATD
     I                                        1   40H@MDYY
     I                                        5   60H@MDMM
     I                                        7   80H@MDDD
     I*
     I            DS
     I**  Data Structure to split value date used in key to deams file
     I                                        1   80@KVALD
     I                                        1   40@VDYY
     I                                        3   40@VYEAR
     I                                        5   60@VDMM
     I                                        7   80@VDDD
     I*
     I            DS
     I**  Data Structure to parameter date passed to mm0085
     I                                        1   80@PDAT
     I                                        1   40@PDYY
     I                                        3   40@PYEAR
     I                                        5   60@PDMM
     I                                        7   80@PDDD
     I*
     I*                                                                   S01408
     I/COPY WNCPYSRC,MM0028IIP1                                           S01408
     I*                                                                   S01408
     IINFDS       DS
     I**  Data structure for file status of MMDAMULL.
     I                                     *STATUS  STATUS
     I*
     IDNATN       DS                              5
     I**  Data structure to update last transaction number.
     I                                        1   50FNATN
     I*
     IPSDS       SDS
     I**  Program status data structure.
     I/COPY WNCPYSRC,MM0028I001
     I                                       37  390@NOPMS
     I                                      244 253 @JOB
     I                                      254 263 @USER
     I**************************************264*2690@JOBNO****************S01319
     I*
     I           UDS
     I**  Local data area for data base errors.
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 183 DBASE
     ICMTTXT      DS                             67
     I**  COMIT text.
     I                                        1   50NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  25 ACTCDX
     I*
     I@MDEAL      DS
     I                                     *STATUS  @DEST
     I                                        9   9 @DEOPN
     I                                      261 270 @DERCD
     I                                      265 266 @DERCT
     I*
     I@DMDTA      DS                             45
     I**  Data structure to hold the data for screen messages.
     I                                        1  25 @DATA1
     I                                       26  45 @DATA2
     I*********************                  26  31 DDDLNO                S01354
     I                                       32  32 @DASH1
     I                                       33  38 @ERVDT
     I                                       39  39 @DASH2
     I                                       40  42 DDDS38
     I*
     I*@KEY********DS                             12
     I****Data structure for keying to the MIDAS table files              E276
     I*********************                   1   2 @KEY1                 E276
     I*********************                   9  11 @KEY2                 E276
     I*********************                  12  12 @KEY3                 E276
     I*
     I            DS
     I**  Data structure to format separate dates into a 8N number
     I                                        1   40@YEAR
     I                                        5   60@MNTH
     I                                        7   80@DAY
     I                                        1   80@DATE
     I*
     I*********** DS                                                      056095
     I****Data*structure*for*SR.*ZA0710*-*field*is*@@Z71Y**************   056095
     I***********                             1   40@@Z71Y                056095
     I***********                             1   10@@SSY1                056095
     I***********                             2   20@@SSY2                056095
     I***********                             3   30@@SSY3                056095
     I***********                             4   40@@SSY4                056095
     I*
     I*********** DS                                                      056095
     I****Data*structure*for*SR.*ZA0710*-*field*is*@@VDT***************   056095
     I***********                             1   80@@VDT                 056095
     I***********                             1   40@@YR                  056095
     I***********                             5   60@@Z71M                056095
     I***********                             7   80@@Z71D                056095
     I*
     I/COPY ZSRSRC,ZDATE9Z2                                               056095
     I**  Data structure for SR. ZDATE9                                   056095
     I            DS
     I**  Data structure for date in, to change format.
     I                                        1   80@@DTIN
     I                                        3   40@@YY
     I                                        5   60@@MM
     I                                        7   80@@DD
     I***********                             1   40@@YYYY                056095
     I***********                             1   20@@CC                  056095
     I***********                             5   60@@MTH                 056095
     I***********                             7   80@@DAY                 056095
     I*                                                                   056095
     I/COPY ZSRSRC,ZDAT10Z1                                               056095
     I**  Data structure for SR. ZDAT10                                   056095
     I*
     I            DS                              6
     I**  Data structure to change format to MMDDYY/DDMMYY
     I                                        1   60@@DTOU
     I                                        1   20@@DAT1
     I                                        3   40@@DAT2
     I                                        5   60@@YYY
     I*
     I            DS
     I**  Data structure to redefine array @Z as returned field @@AMTD
     I                                        1  14 @@AMTD
     I                                        1  14 @Z
     I*
     I            DS
     I**  Data structure to redefine array @Q as input field @@AMTW
     I                                        1  130@@AMTW
     I                                        1  130@Q
     I*
     I/COPY ZSRSRC,ZF2CI                                                  092455
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     I            DS
     I****Used by SR. ZA0830 - array data structure.              *****   S01195
     I*****                                   1 150 @CY           *****   S01195
     I*****                                   1  75 @@CY1         *****   S01195
     I*****                                  76 150 @@CY2         *****   S01195
     I*
     I************DS******************************************************S01319
     I****Data*Structure*for*SR.*MM1009*-*date*field*YYYYMMDD.************S01319
     I****************************************1***80@@DATA****************S01319
     I****************************************1***40@@YY1*****************S01319
     I****************************************5***60@@MM1*****************S01319
     I****************************************7***80@@DD1*****************S01319
     I********************************************************************S01319
     I************DS******************************************************S01319
     I****Data*Structure*for*SR.*MM1009*-*date*field*YYYYMMDD.************S01319
     I****************************************1***80@@DATB****************S01319
     I****************************************1***40@@YY2*****************S01319
     I****************************************5***60@@MM2*****************S01319
     I****************************************7***80@@DD2*****************S01319
     I*
     I*@CLTDS******DS*****************************************************S01319
     I****Data*structure*for*output*of*the*CLINT*key.*********************S01319
     I****************************************1***60@CNUM*****************S01319
     I****************************************7***7*@RCDT*****************S01319
     I********************************************************************S01319
     I************DS******************************************************S01319
     I****Data*structure*to*split*up*our*settlement*instructions.*********S01319
     I****************************************1***60@CUN******************S01319
     I****************************************7**100@ACD******************S01319
     I***************************************11**120@SEQ******************S01319
     I****************************************1**12*@OUR******************S01319
     I*
     I*@CMDV*******DS*****************************10**********************S01319
     I****Command*variables***********************************************S01319
     I****************************************1***3*@CUID*****************S01319
     I****************************************4***9*@CJON*****************S01319
     I***************************************10**10*@CEND*****************S01319
     I*
     I            DS
     I*
     I** Data structure to split machine date & time
     I                                        1  120@MCHDT
     I                                        7  120@MCHD
     I*
     I            DS
     I**  Data structure for convertion of YYMMDD to DDMMYY
     I                                        1   6 @DMVDT
     I                                        1   2 @DMVD
     I                                        3   4 @DMVM
     I                                        5   6 @DMVY
     I****************************************1***40@BMAFN**********S01194S01319
      *                                                                   S01408
     I/COPY WNCPYSRC,MM0028IIP4                                           S01408
      *                                                                   S01408
     I@PORC       DS                             41                       S01117
      *  Profit Centre Dft. Matrix Retrieval index (AOPRFMR0)             S01117
      *  Book Code                                                        S01117
     I                                        1   2 DDBOKC                S01117
      *  Relevant Transaction Type                                        S01117
     I                                        3   7 @DLTP1                S01117
      *  Sub Type                                                         S01117
     I                                        8   9 DDDLST                S01117
      *  Branch code                                                      S01117
     I                                       10  12 DDBRSN                S01117
      *  Dept Code                                                        S01117
     I                                       13  15 @DEPT1                S01117
      *  User                                                             S01117
     I                                       16  25 @USER1                S01117
      *  Account Officer Code                                             S01117
     I                                       26  27 ACOC                  S01117
      *  Customer number                                                  S01117
     I                                       28  33 @CNUM1                S01117
      * Profit Centre Code                                                S01117
     I                                       34  37 @PRFC1                S01117
     I*                                                                   S01117
     IZMUSER      DS                             17                       S01117
     I* DATA STRUCTURE WITH DEFAULT BRANCH                                S01117
     I                                       11  13 BRC                   S01117
     I                                       14  16 DEPT                  S01117
     I*                                                                   S01117
     IRUNDAT      DS                                                      S01117
     I/COPY WNCPYSRC,MM0028I007
     I                                       13  13 @MBIN                 S01117
     I*                                                                   S01408
     I/COPY QWINDSRC,MM0028GDTA                                           S01408
     I*                                                                   S01408
     I***MODULE*IDS*************************                        S01184S01314
     I*MMOD********DS***********************     256                S01184S01314
     I***************************************60  60 @CNF            S01184S01314
     I/COPY WNCPYSRC,MM0028I002
     I*                                                                   S01117
      *EJECT                                                      *****   S01117
     C**************************************************************S01253S01304
      **********************************************                S01253S01304
      **Call*SDRTVTXT*pgm*to*access*appropriate*text                S01253S01304
      ***for*a*field*used*in*a*SFL******************                S01253S01304
      **********************************************                S01253S01304
     C*********************MOVEL'ZZGBMSGF'MSGNM                     S01253S01304
     C*********************MOVEL'ZZM1607' MSGDNB                    S01253S01304
     C*********************CALL 'SDRTVTXT'                          S01253S01304
     C*********************PARM           MSGDNB  7                 S01253S01304
     C*********************PARM           MSGNM  10                 S01253S01304
     C*********************PARM           MSGTXT 80                 S01253S01304
     C*********************MOVELMSGTXT    ZZM022                    S01253S01304
      *********************************************                 S01253S01304
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* MAIN     -  Controls main processing                          *
     C*                                                               *
     C* CALLS    #A       -  Initial processing                       *
     C*          #B       -  Main processing                          *
     C*          #C       -  Final processing                         *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @TERM  -  Termination parameter                    *
     C*                                                               *
     C*****************************************************************
     C/COPY WNCPYSRC,MM0028C147
     C*
     C**  Initial processing.
     C           @TERM     IFNE 'T'                        B1
     C                     EXSR #A                         *1
     C*
     C**  Main processing
     C           *INU7     IFNE '1'                        B*2
     C           @TERM     ANDNE'E'                        **2
     C                     EXSR #B                         **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C/COPY WNCPYSRC,MM0028C001
     C**  Termination processing
     C                     EXSR #C
     C*
     C           ENDPGM    TAG                             ENDPGM TAG
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C* SUBROUTINES USED                                              *
     C*                                                               *
     C*  01  #B       - main processing handles screen processing     *
     C*  02  #ZL      - displays, reads and resets screen             *
     C*  03  #ZA      - resets screen error indicators and msgq       *
     C*  04  #ZR      - Check that key fields are valid numeric
     C*  05  #BE      - Range authorisation processing.               *
     C*  06  #BB      - F8  processing                                *
     C*  07  #BC      - F7  processing                                *
     C*  08  #BA      - F12 processing                                *
     C*      #BG      - F14 processing - settlement screen details    *   S01177
     C*      #BGA     - Screen 2 insert processing                    *   S01177
     C*      #BGB     - Screen 2 amend  processing                    *   S01177
     C*      #BGC     - Screen 2 enquireprocessing                    *   S01177
     C*      #BGD     - Screen 2 authorise processing                 *   S01177
     C*      #BGF     - Screen 2 initial validation                   *   S01177
     C*  09  #ZE      - clear screen                                  *
     C*  07  #ZEA     - clear standard deal fields                    *   E18139
     C*  10  #ZD      - move file to screen                           *
     C*  11  #ZF      - move store to screen                          *
     C*  12  #BD      - enter processing                              *
     C*  13  #BDA     - enter processing for action code I            *
     C*  14  #ZC      - enter processing for action code A            *
     C*  15  #ZK      - retrieves a record and displays it            *
     C*  16  #ZI      - validates the display for I and A             *
     C****** #ZIA     - validates the settlement instructions         *   S01177
     C****** #ZIAA    - account checks                                *   S01177
     C*  19  #ZO      - validate deal number and action code          *
     C*  20  #ZOA     - Check valid deal for key fields
     C*  21  #ZOB - Check that non-amendable fields have not changed  *
     C*  22  #ZQ      - Check deal amendment principle
     C***23**ZA0680***-*Convert*date*YYYYMMDD*to*a*midas*day*number****   056095
     C*  23  ZDAT10   - Convert date YYYYMMDD to a midas day number   *   056095
     C*  24  #ZP      - authorize processing                          *
     C***25**ZA0710***-*MIDAS*day*number*to*YYYYMMDD*******************   056095
     C*  25  ZDATE9   - MIDAS day number to YYYYMMDD                  *   056095
     C*  26  ZA0770   - Convert date YYYYMMDD to DDMMYY format        *
     C***27  ZA0830   - Is day a holiday in currency              *****   S01195
     C*  28  ZA0840   - Validate/reformat input amount                *
     C*  29  ZA0920   - Convert amount to display format              *
     C*  30  #ZJ      - Set up Standard deal                          *
     C*      #ZT      - Set up Standard deal for Internal Deals       *   S01354
     C*  31  #ZG      - calls update routines                         *
     C*  32  #BDAA    - calls new record update routines              *
     C*  33  ZTNLU1   - locks and updates trans no data area          *
     C*  34  #ZB      - enter processing for action code D            *
     C*  35  #ZM      - F10  processing                               *
     C*  36  #BF      - F15 processing select screen                  *
     C*  37  #BFA     - F15 processing amend                          *
     C*  38  #BFB     - F15 delete                                    *
     C*  39  #BFC     - F15 authorize                                 *
     C*  40  #A       - initial processing                            *
     C*  41  #C       - termination processing                        *
     C*  42  INFSR    - error checking sr for update files            *
     C*  43  ZA0150   - access tabtb10                                *
     C*  44  *PSSR    - error handling SR                             *
     C*  45  #AB      - KLIST/PLIST , field definitions               *
     C*  55  #FEED    - Extract feedback information when             *   S01184
     C*                 CONFIRMATION MATCHING module present          *   S01184
     C*                                                               *
     C* EXTERNAL ROUTINES                                             *
     C*  46  ZA0250   - Clears message queue.                         *
     C*  47  ZA0240   - Sends message to screen.                      *
     C*  48  ZA0270   - Convert and validate deal number to date.     *
     C*  49  MM0085   - Generate new sequence number for deam         *
     C*  50  ZA0440   - Send message with data.                       *
     C*  51  MM0078   - Update MM database                            *
     C***52**MM0082***-*Update*midas*data*base                        *   082738
     C*  52  MM0083   - Update midas data base                        *   082738
     C***53**MM0031***-*Add*member*to*Standard*deal*format.***************S01319
     C***54**QCAEXEC**-*Execute*CL*command*from*within*program.********   E20774
     C***54**QCMDEXC**-*Execute*CL*command*from*within*program.*****E20774S01319
     C*                                                               *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #B       - Main processing; handles screen processing.        *
     C*                                                               *
     C* CALLS    #ZL      - displays, reads and resets screen         *
     C*          #BA      - F12 processing                            *
     C*          #BB      - F8  processing                            *
     C*          #BC      - F7  processing                            *
     C*          #BG      - F14  processing settlements screen        *   S01177
     C*          #BF      - F15  processing select screen             *
     C*          #ZM      - F10  processing                           *
     C*                                                               *
     C* CALLED BY:          Main Processing                           *
     C*                                                               *
     C* FLDS USED:                                                    *
     C*                                                               *
     C*****************************************************************
     C*
     C/EJECT
     C           #B        BEGSR
     C*
     C**  If the number of parameters passed to the program is five , then
     C**  the program has been called from the range authorizations.
     C**  Set up range error.
     C           @NOPMS    IFEQ 5                          B1
     C                     EXSR #BE
     C                     GOTO #B9                        *1
     C                     END                             E1
     C*
     C**  Continue processing until program exit is required.
     C           *INKC     DOWEQ'0'                        B1
     C**  If INSERT do not display FEEDBACK information (or DELETED)      S01184
     C           DDACTN    IFEQ 'I'                                       S01184
     C                     MOVE '1'       *IN35                           S01184
     C                     MOVE '0'       *IN39                           S01184
     C                     ELSE                                           S01184
     C                     MOVE '0'       *IN35                           S01184
     C                     END                                            S01184
     C*
     C**  Process screen.
     C/COPY WNCPYSRC,MM0028C074
     C                     EXSR #ZL                        *1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS1                                           S01408
     C*
     C*
     C**  Process screen input - depending upon input type.
     C*
     C**  If F3 is input exit main processing immediately.
     C           *INKC     CABEQ'1'       #B9              *1
     C*
     C**  F12 input.
     C           *INKL     CASEQ'1'       #BA              *1
     C*
     C**  F8 input.
     C           *INKH     CASEQ'1'       #BB              *1
     C*
     C**  F7 input.
     C           *INKG     CASEQ'1'       #BC              *1
     C*
     C**  F14  input.                                                     S01177
     C           *INKN     CASEQ'1'       #BG              *1             S01177
     C*
     C**  F15 input.
     C           *INKP     CASEQ'1'       #BF              *1
     C*
     C**  F10 input - only possible after valid 'ENTER' processing
     C**               in delete mode.
     C           *INKJ     CASEQ'1'       #ZM              *1
     C*
     C**  'ENTER' input.
     C                     CAS            #BD              *1
     C*
     C                     END                             *1
     C*
     C/COPY WNCPYSRC,MM0028C017
     C                     END                             E1
     C*
     C           #B9       ENDSR                           **#B9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZL      - Displays, reads and resets screen                  *
     C*                                                               *
     C* CALLS    #ZA      - Resets screen error indicators and msgq   *
     C*                                                               *
     C* CALLED BY  #B     - Main processing handles screen processing.*
     C*            #BF    - F15 processing.                           *
     C*            #BFA   - F15 processing amend.                     *
     C*            #BFB   - F15 processing delete.                    *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           #ZL       BEGSR
     C*
     C**  Retrieve time and place in screen field.
     C                     TIME           DDTIME
     C*
     C**  Enable CMD14 so settlement screen can be displayed              S01177
     C           @PRI      COMP ' '                  7676                 S01177
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CLD4                                           S01408
     C*                                                                   S01408
     C**  Display screen.
      **  Do not display screen if already diplayed pending file update   E18139
      **  Except when program is called via Range Authorisation option    LN0367
     C           *IN57     IFEQ '0'                        B1             E18139
     C           @NOPMS    OREQ 5                          B1             LN0367
     C                     WRITEMM0028S0
     C                     WRITEMM0028D2                                  S01199
     C                     WRITEMM0028D0
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CLDS                                           S01408
     C*
     C                     END                             E1             E18139
     C*
     C**  Read screen.
     C*********************READ MM0028S0                 60               S01199
     C                     READ MM0028D2                 60               S01199
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVSF                                           S01408
     C*                                                                   S01408
     C*
     C**  Reset error indicators and clear screen message queue.
     C                     EXSR #ZA
     C*
      **  Set off screen indicator                                        E18139
     C                     SETOF                     57                   E18139
      *                                                                   E18139
     C           #ZL9      ENDSR                           **#ZL9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*      #ZA      - resets screen error indicators and msgq       *
     C*                                                               *
     C* CALLED BY  #ZL    - Displays, reads and resets screen.        *
     C*                                                               *
     C* CALLS      ZA0250 - Clears message queue.                     *
     C*            #ZL    - Displays, reads and resets screen.        *
     C*************ZA0710*-*MIDAS*day*number*to*YYYYMMDD***************   056095
     C*            ZDATE9 - MIDAS day number to YYYYMMDD              *   056095
     C*            ZA0770 - Convert date YYYYMMDD to DDMMYY format    *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           #ZA       BEGSR
     C*
     C**  Reset all field error indicators.
     C                     MOVE '0'       *IN01
     C                     MOVE '0'       *IN02
     C                     MOVE '0'       *IN03
     C                     MOVE '0'       *IN10
     C                     MOVE '0'       *IN11
     C                     MOVE '0'       *IN14
     C                     MOVE '0'       *IN15
     C                     MOVE '0'       *IN16
     C                     MOVE '0'       *IN18
     C                     MOVE '0'       *IN20
     C/COPY WNCPYSRC,MM0028CP36                                           S01408
     C                     MOVE '0'       *IN23                           CAC001
     C                     MOVE '0'       *IN31                           S01117
     C                     MOVE '0'       *IN36                           S01117
     C*****                MOVE '0'       *IN31                           S01177
     C*****                MOVE '0'       *IN33                           S01177
     C*****                MOVE '0'       *IN35                           S01177
     C*****                MOVE '0'       *IN37                           S01177
     C*
     C**  Reset cursor positioning indicators.
     C                     MOVE '0'       *IN43
     C*
     C**  Reset validation error indicator.
     C                     MOVE '0'       *IN41
     C*
     C**  Reset warning error indicator.                                  E14379
     C                     MOVE '0'       *IN55                           E14379
     C*
     C**  Reset indicator enabling F10.
     C           DDACTN    IFNE 'D'                                       S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP13                                           S01408
     C*                                                                   S01408
     C                     MOVE '0'       *IN42
     C                     END                                            S01177
     C*
     C**  Set off last sequence no. present indicator.
     C                     MOVE '0'       *IN40
     C*
     C**  Set off inhibited fields indicator for amendment
     C                     MOVE '0'       *IN48
     C                     MOVE '0'       *IN49
     C*
     C**  Reset indicator showing external update.
     C                     MOVE '0'       *IN78
     C*
     C**  Clear screen message queue.
     C/COPY WNCPYSRC,MM0028C081
     C                     CALL 'ZA0250'
     C/COPY WNCPYSRC,MM0028C082
     C***define*MODULE*ID*data*area***                              S01184S01314
     C************NAMVAR***DEFN           MMOD                      S01184S01314
     C*********************IN   MMOD                                S01184S01314
     C*
     C           #ZA9      ENDSR                           **#ZA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZR      - Check that key fields are valid numeric            *
     C*                                                               *
     C* CALLS    ZA0240   - Sends message to screen.                  *
     C*          ZA0270   - Convert and validate deal number to date. *
     C*                                                               *
     C* CALLED BY  #BB    - F8 processing.                            *
     C*            #BC    - F7 processing.                            *
     C*                                                               *
     C* FLDS USED  @TEST  - Workfield to test numeric                 *
     C*            @DLKEY - Deal file key.                            *
     C*            @MSGID - Message id.                               *
     C*            @DAT   - 6N date for ZA0270                        *
     C*            @RTCDE - 1A return code for ZA0270                 *
     C*            @VDYNO - value date                                *
     C*            @VDYY  - Value date : year                         *
     C*            @VDMM  - Value date : month                        *
     C*            @VDDD  - Value date : day                          *
     C*            @KVALD - Key field  : value date                   *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @DSPM  - Month frm screen field : value date       *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @VYEAR - Year numeric field                        *
     C*            @KSEQN - Sequence number key field                 *
     C*                                                               *
     C*****************************************************************
     C           #ZR       BEGSR
     C*
     C**  Validate that deal number is numeric or blank.
     C                     TESTN          DDDLNO     6263
     C                     MOVE DDDLNO    @TEST   1
     C                     TESTZ          @TEST          73
     C*
     C**  If it is set up the file key, otherwise output an error message.
     C           DDDLNO    IFEQ *BLANKS                    B1
     C           *IN62     OREQ '1'                        X1
     C           *IN73     ANDEQ'1'                        X1
     C           *IN63     OREQ '1'                        X1
     C           *IN73     ANDEQ'1'                        X1
     C           DDDLNO    IFEQ *BLANKS                    B*2
     C                     Z-ADD*LOVAL    @DLKEY  60       **2
     C                     ELSE                            X*2
     C                     MOVE DDDLNO    @DLKEY           **2
     C                     END                             E*2
     C                     ELSE                            X1
     C                     MOVEL'MMM0162' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     MOVE '1'       *IN02            *1
     C                     MOVE '1'       *IN41            *1
     C                     END                             E1
     C*
     C**  Validate that the value date is a valid date or blank.
     C           DDVDAT    IFNE *BLANKS                    B1
     C                     TESTN          DDVDAT     6263  *1
     C                     MOVE DDVDAT    @TEST            *1
     C                     TESTZ          @TEST          73*1
     C           *IN62     IFEQ '1'                        B*2
     C           *IN73     ANDEQ'1'                        **2
     C           *IN63     OREQ '1'                        **2
     C           *IN73     ANDEQ'1'                        **2
     C                     MOVELDDVDAT    @DAT             **2
     C                     CALL 'ZA0270'                   **2
     C                     PARM           @DAT    60       **2
     C*****                PARM           DATF             **2    *****   S01194
     C                     PARM           BJDFIN           **2            S01194
     C                     PARM           @RTCDE  1        **2
     C                     PARM           @VDYNO  50       **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If the return code is 1 then the input date is invalid or
     C**  non-numeric.
     C           @RTCDE    IFEQ '1'                        B1
     C           DDVDAT    ANDNE*BLANKS                    B1
     C*
     C           *IN73     OREQ '0'                        B1
     C           DDVDAT    ANDNE*BLANKS                    B1
     C*
     C           *IN62     OREQ '0'                        B1
     C           *IN63     ANDEQ'0'                        B1
     C           DDVDAT    ANDNE*BLANKS                    B1
     C*
     C                     MOVE '1'       *IN11            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0125' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     ELSE                            X1
     C           DDVDAT    IFEQ *BLANKS                    B*2
     C                     Z-ADD*LOVAL    @VDYY            **2
     C                     Z-ADD*LOVAL    @VDMM            **2
     C                     Z-ADD*LOVAL    @VDDD            **2
     C                     ELSE                            X*2
     C*
     C** Load value date to numeric keyfield,in YYYYMMDD format
     C                     Z-ADD0         @KVALD           **2
     C                     MOVE @DSPY     @VYEAR           **2
     C/COPY WNCPYSRC,MM0028C127
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPD     @VDDD            **2
     C                     ELSE                                           BHF183
     C                     MOVE @DSPD     @VDMM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPM     @VDMM            **2
     C                     ELSE                                           BHF183
     C                     MOVE @DSPM     @VDDD                           BHF183
     C                     END                                            BHF183
     C*
     C** Century
     C           @VYEAR    IFGE 72                         B**3
     C           @VDYY     ADD  1900      @VDYY            ***3
     C                     ELSE                            ***3
     C           @VDYY     ADD  2000      @VDYY            ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C** Sequence no. must be numeric if entered
     C           DDDS38    IFNE *BLANKS                    B1
     C*
     C                     TESTN          DDDS38     6263  *1
     C                     MOVE DDDS38    @TEST            *1
     C                     TESTZ          @TEST          73*1
     C                     END                             E1
     C*
     C           DDDS38    IFEQ *BLANKS                    B1
     C*
     C           *IN62     OREQ '1'                        B1
     C           *IN73     ANDEQ'1'                        B1
     C*
     C           *IN73     OREQ '1'                        B1
     C           *IN63     ANDEQ'1'                        B1
     C*
     C           DDDS38    IFEQ *BLANKS                    B*2
     C                     Z-ADD*LOVAL    @KSEQN           **2
     C                     ELSE                            X*2
     C                     MOVE DDDS38    @KSEQN           **2
     C                     END                             E*2
     C*
     C                     ELSE                            X1
     C*
     C                     MOVE '1'       *IN15            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0196' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C           #ZR9      ENDSR                           **#ZR9**
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C* #BE      - Range authorisation processing.                    *
     C*                                                               *
     C* CALLS    #ZA      - Resets screen error indicators and MSGQ.  *
     C*          #ZD      - Sets up screen with file values.          *
     C*          #ZG      - Update processing.                        *
     C*          #ZI      - Validates the screen input for I,A and X. *
     C*          #ZL      - Displays, reads and resets screen.        *
     C*                                                               *
     C* CALLED BY  #B     - Main processing.                          *
     C*                                                               *
     C* FLDS USED  @RDLN  - No. of deal requiring authorisation.      *
     C*            @RVDT  -  deal value date parameter                *
     C*            @RSQN  -  Sequence no. parameter                   *
     C*            @RADMK - Range authorisation key to deams file.    *
     C*            @TERM1 - Termination paramater.                    *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @DSPM  - Month frm screen field : value date       *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @VYEAR - Year numeric field                        *
     C*            @KSEQN - Sequence number key field                 *
     C*                                                               *
     C*****************************************************************
     C           #BE       BEGSR
     C*
     C**  Key fields are passed as parameters. Assign to screen field
     C**   and protect
     C                     MOVE 'X'       DDACTN
     C                     MOVE '1'       *IN45
     C*
     C**  Split value date in data structure & load key fields.
     C                     Z-ADD@RVDT     @KVALD
     C                     Z-ADD@RDLN     @DLKEY
     C                     Z-ADD@RSQN     @KSEQN
     C*
     C           @DMKEY    CHAINMMDEAMLL             72
     C*
     C**  Skip load of file fields if record not found
     C           *IN72     IFNE '1'                        B1
     C*
     C**  Move fields into pgm fields.
     C                     EXSR #ZD                        *1
     C/COPY WNCPYSRC,MM0028C009
     C                     ELSE                            X1
     C*
     C**  Load recieved parameters into display fields.
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @VDDD     @DSPD            *1
     C                     ELSE                                           BHF183
     C                     MOVE @VDDD     @DSPM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @VDMM     @DSPM            *1
     C                     ELSE                                           BHF183
     C                     MOVE @VDMM     @DSPD                           BHF183
     C                     END                                            BHF183
     C                     MOVE @VYEAR    @DSPY            *1
     C                     MOVE @KSEQN    DDDS38           *1
     C                     MOVE @DLKEY    DDDLNO           *1
     C                     END                             E1
     C*
     C**  Reset error indicators and clear screen message queue.
     C                     EXSR #ZA
     C*
     C**  Process until record updated
     C**          or    CMD3 entered   (for invalid deam)
     C           DDDLNO    DOUEQ*BLANKS                    B1
     C           *INKC     OREQ '1'                        B1
     C*
     C**  Validation
     C                     EXSR #ZO                        *1
     C*
     C           *IN41     IFNE '1'                        B*2
     C                     MOVE '0'       *IN77                           S01177
     C                     EXSR #ZI                        **2
     C                     ELSE                            X*2
     C                     MOVE '0'       *IN50            **2
     C                     END                             E*2
     C*
     C**  If valid, update
     C           *IN41     IFEQ '0'                        B*2
     C                     MOVE 'Y'       @@@BPS                          E20031
     C                     EXSR #ZG                        **2
     C                     MOVE *BLANKS   @@@BPS                          E20031
     C                     END                             E*2
     C/COPY WNCPYSRC,MM0028C083
     C*
     C**  If not updated, display for amendment
     C           DDDLNO    IFNE *BLANKS                    B*2
     C                     MOVE 'A'       DDACTN           **2
     C                     MOVE 'E'       @ERR             **2
     C                     EXSR #ZL                        **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C           #BE9      ENDSR                           **#BE9**
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BB      - F8  processing                                     *
     C*                                                               *
     C* CALLS    ZA0240   - Sends message to screen                   *
     C*          #ZD      - Move file to screen                       *
     C*          #ZR      - Check that key fields are valid numeric   *
     C*                                                               *
     C* CALLED BY  #B     - Main processing;handles screen processing *
     C*                                                               *
     C* FLDS USED  @DLNO  - stored deal number                        *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Stored deam sequence number               *
     C*            @DMKEY - Key to deams file                         *
     C*            @ACTN  - stored action code                        *
     C*            @MSGID - Message id.                               *
     C*                                                               *
     C*****************************************************************
     C           #BB       BEGSR
      *                                                                   S01117
      ** Must first check user is authorised to action code 'E' if        S01117
      ** @MBIN 'N'. Note @MBIN 'Y' checking done later in subroutine      S01117
     C           @MBIN     IFEQ 'N'                        B1             S01117
      *                                                                   S01117
     C                     CALL 'ZVACTU'                   *1             S01117
     C                     PARM 'E'       ZACTN            *1             S01117
     C                     PARM           ERR              *1             S01117
      *                                                                   S01117
     C           ERR       IFEQ 1                          B*2            S01117
     C                     MOVE '1'       *IN01            **2            S01117
     C                     MOVE '1'       *IN41            **2            S01117
     C                     MOVEL'FXM0292' @MSGID           **2            S01117
     C                     CALL 'ZA0240'                   **2            S01117
     C                     PARM           @MSGID           **2            S01117
     C                     GOTO #BB9                       **2            S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
     C                     END                             E1             S01117
     C*
     C**  Clear "F10-CONFIRM" prompt if displayed before F8 pressed       S01177
     C                     MOVE '0'       *IN42                           S01177
     C*
     C**  Validate that key fields are numeric or blank.
     C                     EXSR #ZR
     C*
     C** If an error has been found exit routine
     C           *IN41     CABEQ'1'       #BB9
     C*
     C**  Set action code to E, only if action code is not X
     C           DDACTN    IFNE 'X'                        B1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP7                                           S01408
     C*                                                                   S01408
     C                     MOVE 'E'       DDACTN           *1
     C                     END                             E1
     C*
     C**  If the key field has changed or is blank, set file pointer
     C**  using key.  Which file depends on whether an authorization
     C**  is to be performed or not.
     C           DDDLNO    IFNE @DLNO                      B1
     C           DDDLNO    OREQ *BLANKS                    *1
     C*
     C           DDVDAT    ORNE @VDAT                      B1
     C           DDVDAT    OREQ *BLANKS                    *1
     C*
     C           DDDS38    ORNE @DS38                      B1
     C           DDDS38    OREQ *BLANKS                    *1
     C*
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETLLMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETLLMMCARMLL                   **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If the action code has changed from the last F7 or F8
     C**  then setgt on the new file
     C           DDACTN    IFNE @ACTN                      B1
     C           DDDLNO    ANDNE*BLANKS                    *1
     C           DDDLNO    ANDEQ@DLNO                      *1
     C*
     C           DDVDAT    ANDNE*BLANKS                    *1
     C           DDVDAT    ANDEQ@VDAT                      *1
     C*
     C           DDDS38    ANDNE*BLANKS                    *1
     C           DDDS38    ANDEQ@DS38                      *1
     C*
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETGTMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETGTMMCARMLL                   **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If the key field is the same, and *IN71 is on, the beginning
     C**  of the file was passed whilst the first record was displayed.
     C**  Set the file pointer to read the second record.
     C           @DLNO     IFEQ DDDLNO                     B1
     C           @VDAT     ANDEQDDVDAT                     B1
     C           @DS38     ANDEQDDDS38                     B1
     C           *IN71     ANDEQ'1'                        *1
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETGTMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETGTMMCARMLL                   **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  Read the next record on file
     C*
     C**  Read records until valid record found.
     C           *IN70     DOUEQ'1'                        B1
     C           HNDLTF    OREQ ' '                        *1
     C           ERR       ANDEQ*ZERO                      B1             S01117
     C           DDACTN    IFEQ 'X'                        B*2
     C                     READ MMCMPLLL                 70**2
     C                     ELSE                            X*2
     C                     READ MMCARMLL                 70**2
     C                     END                             E*2
     C                     END                             E1
      *                                                                   S01117
      ** Must also check for user authority to branch in mb system        S01117
     C           @MBIN     IFEQ 'Y'                        B*2            S01117
      *                                                                   S01117
      ** check booking branch, always use action code of 'E'              S01117
     C                     CALL 'ZVACTBU'                  **2            S01117
     C                     PARM 'E'       ZACTN            **2            S01117
     C                     PARM           H@BRCA           **2            S01117
     C                     PARM           ERR              **2            S01117
      *                                                                   S01117
      ** Must also check for user authority to action code for @MBIN 'N'  S01117
     C                     ELSE                            X*2            S01117
      *                                                                   S01117
      ** check booking branch, always use action code of 'E'              S01117
     C                     CALL 'ZVACTU'                   **2            S01117
     C                     PARM 'E'       ZACTN            **2            S01117
     C                     PARM           ERR              **2            S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
     C*
     C**  If *IN70 is on then the end of the file has been reached.
     C           *IN70     IFEQ '1'                        B1
     C*
     C**  Reset the file pointer for the next read operation.
     C**  - If the key is that of the last record on file, a subsequent
     C**    F7 will read the record prior to the last record.
     C**  - If the key is beyond the last record on file, a subsequent
     C**    F7 will read the last record.
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETGTMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETGTMMCARMLL                   **2
     C                     END                             E*2
     C*
     C**  If the key field is blank then no valid records exist.
     C           DDDLNO    IFEQ *BLANKS                    B*2
     C           DDVDAT    ANDEQ*BLANKS                    B*2
     C           DDDS38    ANDEQ*BLANKS                    B*2
     C*
     C**  Set up error output for screen.
     C                     MOVEL'MMM1006' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*
     C**  By-pass further F8 processing.
     C                     GOTO #BB9                       **2
     C*
     C                     END                             E*2
     C*
     C**  Set up error output for screen.
     C                     MOVEL'MMM1002' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C*
     C**  By-pass further F8 processing.
     C                     GOTO #BB9                       *1
     C*
     C                     END                             E1
     C*                                                                   S01177
     C**  Enable CMD14 so settlement screen can be displayed              S01177
     C                     MOVE '1'       @PRI             *1             S01177
     C*
     C**  A valid record has been read - move file fields into program
     C**  work fields and screen fields.
     C                     EXSR #ZD
     C/COPY WNCPYSRC,MM0028C010
     C*
     C**  Enter has now been pressed for this deal number/date/seq. no    S01177
     C                     MOVE DDDLNO    DLENT                           S01177
     C                     MOVE DDVDAT    VDENT                           S01177
     C                     MOVE DDDS38    DSENT                           S01177
     C*                                                                   S01177
     C*   return control to beginning of main loop in #B where screen     S01177
     C*   will be displayed                                               S01177
     C*
     C           #BB9      ENDSR                           **#BB9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BC      - F7  processing                                     *
     C*                                                               *
     C* CALLS    ZA0240   - Sends message to screen                   *
     C*          #ZD      - Move file to screen                       *
     C*          #ZR      - Check that key fields are valid numeric   *
     C*                                                               *
     C* CALLED BY  #B     - Main processing;handles screen processing *
     C*                                                               *
     C* FLDS USED  @DLKEY - Deal file key                             *
     C*            @MSGID - Message id                                *
     C*            @DLNO  - Stored deal number                        *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Stored deam sequence number               *
     C*            @DMKEY - Key to deams file                         *
     C*            @ACTN  - stored action code                        *
     C*            @MSGID - Message id.                               *
     C*                                                               *
     C*****************************************************************
     C           #BC       BEGSR
      *                                                                   S01117
      ** Must first check user is authorised to action code 'E' if        S01117
      ** @MBIN 'N'. Note @MBIN 'Y' checking done later in subroutine      S01117
     C           @MBIN     IFEQ 'N'                        B1             S01117
      *                                                                   S01117
     C                     CALL 'ZVACTU'                   *1             S01117
     C                     PARM 'E'       ZACTN            *1             S01117
     C                     PARM           ERR              *1             S01117
      *                                                                   S01117
     C           ERR       IFEQ 1                          B*2            S01117
     C                     MOVE '1'       *IN01            **2            S01117
     C                     MOVE '1'       *IN41            **2            S01117
     C                     MOVEL'FXM0292' @MSGID           **2            S01117
     C                     CALL 'ZA0240'                   **2            S01117
     C                     PARM           @MSGID           **2            S01117
     C                     GOTO #BC9                       **2            S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
     C                     END                             E1             S01117
     C*
     C**  Clear "F10-CONFIRM" prompt if displayed before F7 pressed       S01177
     C                     MOVE '0'       *IN42                           S01177
     C*
     C**  Validate that key fields are numeric or blank.
     C                     EXSR #ZR
     C*
     C** If an error has been found exit routine
     C           *IN41     CABEQ'1'       #BC9
     C*
     C**  Set action code to E, only if not X
     C           DDACTN    IFNE 'X'                        B1
     C                     MOVE 'E'       DDACTN           *1
     C                     END                             E1
     C*
     C**  If the key field has changed or is blank, set file pointer
     C**  using key.  Which file depends on whether an authorization
     C**  is to be performed or not.
     C           DDDLNO    IFNE @DLNO                      B1
     C           DDDLNO    OREQ *BLANKS                    *1
     C*
     C           DDVDAT    ORNE @VDAT                      B1
     C           DDVDAT    OREQ *BLANKS                    *1
     C*
     C           DDDS38    ORNE @DS38                      B1
     C           DDDS38    OREQ *BLANKS                    *1
     C*
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETLLMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETLLMMCARMLL                   **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C**  If the action code has changed from the last F7 or F8
     C**  then setll on the new file.
     C           DDACTN    IFNE @ACTN                      B1
     C           DDDLNO    ANDNE*BLANKS                    *1
     C           DDDLNO    ANDEQ@DLNO                      *1
     C*
     C           DDVDAT    ANDNE*BLANKS                    *1
     C           DDVDAT    ANDEQ@VDAT                      *1
     C*
     C           DDDS38    ANDNE*BLANKS                    *1
     C           DDDS38    ANDEQ@DS38                      *1
     C*
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETLLMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETLLMMCARMLL                   **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If the key field is the same, and *IN70 is on, the end of the
     C**  file was passed whilst the last record was displayed.
     C**  Set the file pointer to read the penultimate record.
     C           DDDLNO    IFEQ @DLNO                      B1
     C           @VDAT     ANDEQDDVDAT                     B1
     C           @DS38     ANDEQDDDS38                     B1
     C           *IN70     ANDEQ'1'                        *1
     C*
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETLLMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETLLMMCARMLL                   **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C**  Read the previous record on file
     C*
     C**  Read record previous to file pointer, until valid record found.
     C           *IN71     DOUEQ'1'                        B1
     C           HNDLTF    OREQ ' '                        *1
     C           ERR       ANDEQ*ZERO                      *1             S01117
     C*
     C           DDACTN    IFEQ 'X'                        B*2
     C                     READPMMCMPLLL                 71**2
     C                     ELSE                            X*2
     C                     READPMMCARMLL                 71**2
     C                     END                             E*2
      *                                                                   S01117
      ** Must also check for user authority to branch in mb system        S01117
     C           @MBIN     IFEQ 'Y'                        B*2            S01117
      *                                                                   S01117
      ** check booking branch, always use action code of 'E'              S01117
     C                     CALL 'ZVACTBU'                  **2            S01117
     C                     PARM 'E'       ZACTN            **2            S01117
     C                     PARM           H@BRCA           **2            S01117
     C                     PARM           ERR              **2            S01117
      *                                                                   S01117
      ** Must also check for user authority to action code for @MBIN 'N'  S01117
     C                     ELSE                            X*2            S01117
      *                                                                   S01117
      ** check booking branch, always use action code of 'E'              S01117
     C                     CALL 'ZVACTU'                   **2            S01117
     C                     PARM 'E'       ZACTN            **2            S01117
     C                     PARM           ERR              **2            S01117
     C                     END                             E*2            S01117
     C*
     C                     END                             E1
     C*
     C**  If *IN71 is on then the start of the file has been reached.
     C           *IN71     IFEQ '1'                        B1
     C*
     C**  Reset the file pointer for the next read operation.
     C           DDACTN    IFEQ 'X'                        B*2
     C           @DMKEY    SETLLMMDEAMP0                   **2
     C                     ELSE                            X*2
     C           @DMKEY    SETLLMMCARMLL                   **2
     C                     END                             E*2
     C*
     C**  Set up error output for screen.
     C                     MOVEL'MMM1003' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C*
     C**  By-pass further F7 processing.
     C                     GOTO #BC9                       *1
     C*
     C                     END                             E1
     C*                                                                   S01177
     C**  Enable CMD14 so settlement screen can be displayed              S01177
     C                     MOVE '1'       @PRI             *1             S01177
     C*
     C**  A valid record has been read - move file fields into program
     C**  work fields and screen fields.
     C                     EXSR #ZD
     C/COPY WNCPYSRC,MM0028C011
     C*
     C**  Enter has now been pressed for this deal number/date/seq. no    S01177
     C                     MOVE DDDLNO    DLENT                           S01177
     C                     MOVE DDVDAT    VDENT                           S01177
     C                     MOVE DDDS38    DSENT                           S01177
     C*
     C           #BC9      ENDSR                           **#BC9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BA      - F12 processing                                     *
     C*                                                               *
     C* CALLS    #ZE      - Clear screen.                             *
     C*          #ZEA     - Clear standard deal                       *   E18139
     C*                                                               *
     C* CALLED BY  #B     - Main processing;handles screen processing *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           #BA       BEGSR
     C*
     C**  Check whether all Screen fields blank.
     C           DDACTN    IFEQ *BLANKS                    B1
     C           DDDLNO    ANDEQ*BLANKS                    X1
     C           DDMTYP    ANDEQ*BLANKS                    X1
     C           DDCSNM    ANDEQ*BLANKS                    X1
     C           DDVDAT    ANDEQ*BLANKS                    X1
     C           DDDS38    ANDEQ*BLANKS                    X1
     C           DDCCY     ANDEQ*BLANKS                    X1
     C           DDAMNP    ANDEQ*BLANKS                    X1
     C           DDLSQN    ANDEQ*BLANKS                    X1
     C           DDINTR    ANDEQ*BLANKS                    X1
     C/COPY WNCPYSRC,MM0028CP37                                           S01408
     C           DDFSRP    ANDEQ*BLANKS                                   CAC001
     C*****      DDORCM    ANDEQ*BLANKS                    X1             S01177
     C*****      DDMORI    ANDEQ*BLANKS                    X1             S01177
     C*****      DDMCPI    ANDEQ*BLANKS                    X1             S01177
     C*****      DDMFAO    ANDEQ*BLANKS                    X1             S01177
     C*****      DDSPEC    ANDEQ*BLANKS                    X1             S01177
     C*
     C**  If they are, cease main processing by setting *INKC on.
     C                     MOVE '1'       *INKC            *1
     C*
     C**  Otherwise, blank out all input capable screen fields.
     C                     ELSE                            X1
     C*
     C                     EXSR #ZE                        *1
      *                                                                   E18139
      **  And standard deal fields                                        E18139
     C                     EXSR #ZEA                       *1             E18139
     C*
     C/COPY WNCPYSRC,MM0028C018
     C                     END                             E1
     C*
     C           #BA9      ENDSR                           **#BA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************   S01177
     C*                                                               *   S01177
     C* #BG      - F14 processing                                     *   S01177
     C*                                                               *   S01177
     C* CALLS      #BGA   - Screen 2 insert processing                *   S01177
     C*            #BGB   - Screen 2 amend  processing                *   S01177
     C*            #BGC   - Screen 2 enquireprocessing                *   S01177
     C*            #BGD   - Screen 2 authorise processing             *   S01177
     C*            #BGF   - Screen 2 initial validation               *   S01177
     C*                                                               *   S01177
     C* CALLED BY  #B     - Main processing;handles screen processing *   S01177
     C*            #BDA   - Enter processing for action code I        *   S01177
     C*                                                               *   S01177
     C* FLDS USED         -                                           *   S01177
     C*                                                               *   S01177
     C*****************************************************************   S01177
     C           #BG       BEGSR                                          S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CPCK                                           S01408
     C*
     C*                                                                   S01177
     C** If Deal number has been changed on first screen but enter has    S01177
     C*    not been pressed to update screen fields do not allow          S01177
     C*    CMD/14 processing unless inselect screen processing.           S01177
     C           DDDLNO    IFNE DLENT                                     S01177
     C           *IN45     ANDEQ'0'                                       S01177
     C*********************MOVEL'MMM1041' @MSGID                S01177    S01227
     C                     MOVEL'MMM1043' @MSGID                          S01227
     C                     CALL 'ZA0240'                                  S01177
     C                     PARM           @MSGID                          S01177
     C                     GOTO #BG9                                      S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C** Similarly for Value date and Deam sequence number                S01177
     C           DDVDAT    IFNE VDENT                                     S01177
     C           *IN45     ANDEQ'0'                                       S01177
     C                     MOVEL'MMM1041' @MSGID                          S01177
     C                     CALL 'ZA0240'                                  S01177
     C                     PARM           @MSGID                          S01177
     C                     GOTO #BG9                                      S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C           DDDS38    IFNE DSENT                                     S01177
     C           *IN45     ANDEQ'0'                                       S01177
     C                     MOVEL'MMM1041' @MSGID                          S01177
     C                     CALL 'ZA0240'                                  S01177
     C                     PARM           @MSGID                          S01177
     C                     GOTO #BG9                                      S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C**  ensure that related deal has been read, otherwise the compare   S01177
     C****of*CNUM*with*H@CNUM*(from*deal)*will*fail*in*#BGF*and*H@BRCD****S01117
     C**  of CNUM with H@CNUM (from deal) will fail in #BGF and H@BRCA    S01117
     C**  will not be set up                                              S01177
     C**                                                                  S01177
     C                     MOVE DDDLNO    @DLKEY                          S01177
     C           @DLKEY    CHAINMMDEALLL             65                   S01177
     C*                                                                   S01177
     C           *IN65     IFEQ '1'                                       S01177
     C                     MOVE '1'       *INLR                           S01177
     C                     MOVE '1'       *INU7                           S01177
     C                     MOVE '1'       *INU8                           S01177
     C                     MOVE '1'       *INKC            ***************S01177
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 009 *S01177
     C                     MOVELDDDLNO    DBKEY            ***************S01177
     C                     MOVE '009'     DBASE                           S01177
     C                     EXSR #C                                        S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C** If action code is insert, amend or authorise do primary          S01177
     C**   validation on first screen fields to be passed to              S01177
     C**      parameters                                                  S01177
     C           DDACTN    IFEQ 'I'                                       S01177
     C           DDACTN    OREQ 'A'                                       S01177
     C           DDACTN    OREQ 'X'                                       S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP6                                           S01408
     C*                                                                   S01408
     C           DDACTN    OREQ ' '                                       S01177
     C                     EXSR #BGF                                      S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C** If deal number entered does not match that currently in parms    S01177
     C**   then this is first time in for this deal                       S01177
     C           DDDLNO    IFNE @SAVD                                     S01177
     C           DDVDAT    ORNE @SAVV                                     S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP24                                           S01408
     C*                                                                   S01408
     C           DDDS38    ORNE @SAVS                                     S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP25                                           S01408
     C*                                                                   S01408
     C*  Check if the settlement screen has been accessed                 BHF972
     C           *IN22     ORNE '1'                                       BHF972
     C                     MOVE 'Y'       PMFRST                          S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP26                                           S01408
     C*                                                                   S01408
     C                     MOVE DDDLNO    @SAVD   6                       S01177
     C                     MOVE DDVDAT    @SAVV   6                       S01177
     C                     MOVE DDDS38    @SAVS   3                       S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP27                                           S01408
     C*                                                                   S01408
     C                     ELSE                                           S01177
     C*                                                                   S01177
     C** Parmameters will already be set up                               S01177
     C*                                                                   S01177
     C                     MOVE 'N'       PMFRST                          S01177
     C                     END                                            S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP28                                           S01408
     C*                                                                   S01408
     C*                                                                   S01177
     C** Set up parameters for call to SETLIAB                            S01177
     C*                                                                   S01177
     C                     MOVE DDACTN    PMACTC                          S01177
     C                     MOVE 'MMDA'    PMCPGM                          S01177
     C                     MOVE DDMTYP    PMTTYP                          S01177
     C                     MOVE DDCSNM    PMCSNM                          S01177
     C                     MOVE @VDYNO    PMDTRC                          S01177
     C                     MOVE @VDYNO    PMDTPY                          S01177
     C                     MOVE DDCCY     PMRCCY                          S01177
     C                     MOVE DDCCY     PMPCCY                          S01177
     C                     MOVE *BLANK    PMFFND                          S01177
     C*****                MOVE H@BRCD    PMBRCD                  S01177  S01117
     C                     MOVE H@BRCA    PMBRCA                          S01117
     C                     MOVE *BLANKS   PMCMDP                          S01177
     C*                                                                   S01177
     C*  If any invalid fields found bypass screen 2 processing and       S01177
     C*    return to first screen                                         S01177
     C*                                                                   S01177
     C           *IN10     IFEQ '1'                                       S01177
     C*                                                                   S01177
     C*  ONLY SKIP SCREEN 2 PROCESSING FOR VALUE DATE ERROR IF THE        S01177
     C*  ERROR IS  NOT  A WARNING ERROR (N.B. VALUE DATE IS THE ONLY      S01177
     C*  FIELD THAT USES *IN55)                                           S01177
     C*                                                                   S01177
     C           *IN11     OREQ '1'                                       S01177
     C           *IN55     ANDNE'1'                                       S01177
     C*                                                                   S01177
     C           *IN03     OREQ '1'                                       S01177
     C           *IN16     OREQ '1'                                       S01177
     C                     GOTO #BG9                                      S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C*                                                                   S01177
     C** Process according to action code                                 S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP5                                           S01408
     C*                                                                   S01408
     C*                                                                   S01177
     C**  - If the action code is I, process SR #BGA.                     S01177
     C           DDACTN    CASEQ'I'       #BGA                            S01177
     C*                                                                   S01177
     C**  - If the action code is A, process SR #BGB.                     S01177
     C           DDACTN    CASEQ'A'       #BGB                            S01177
     C*                                                                   S01177
     C**  - If the action code is E or D, process SR #BGC.                S01177
     C           DDACTN    CASEQ'D'       #BGC                            S01177
     C           DDACTN    CASEQ'E'       #BGC                            S01177
     C*                                                                   S01177
     C**  - If the action code is X, process SR #BGD.                     S01177
     C           DDACTN    CASEQ'X'       #BGD                            S01177
     C*                                                                   S01177
     C                     END                                            S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP4                                           S01408
     C*                                                                   S01408
     C*                                                                   S01177
     C** Call settlement screen validation program                        S01177
     C*****                CALL 'SDKTPVR'                          S01177 E214
     C                     CALL 'SD2400'                                  E214
     C                     PARM           @PARM1  7                       S01177
     C                     PARM           @PARM2                          S01177
     C                     PARM           @PARM3                          S01177
     C                     PARM           DDDLNO                          BHF488
     C                     PARM           WDUMMY                          CEU003
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CSFI                                           S01408
     C*                                                                   S01408
     C*                                                                   S01177
     C** Terminate program if database error returned                     S01177
     C*                                                                   S01177
     C           PMDBSE    IFNE *ZERO                                     S01177
     C                     MOVE '1'       *INLR            *1             S01177
     C                     MOVE '1'       *INU7            *1             S01177
     C                     MOVE '1'       *INU8            *1             S01177
     C                     MOVE '1'       *INKC            ***************S01177
     C                     MOVELPMDBFL    DBFILE           * DBERROR 028 *S01177
     C                     MOVE PMDBSE    DBASE            ***************S01177
     C                     MOVELPMDBKY    DBKEY            *1             S01177
     C                     MOVELPMDPGM    DBPGM            *1             S01177
     C                     GOTO #BG9                       *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*                                                                   S01177
     C** Check if command key entered from screen 2                       S01177
     C*                                                                   S01177
     C/COPY WNCPYSRC,MM0028C019
     C           PMCMDP    IFEQ '12'                                      S01177
     C/COPY WNCPYSRC,MM0028C020
     C                     MOVE '1'       *INKL                           S01177
     C                     MOVE 'N'       PMSDTV                          S01177
     C                     MOVE '1'       *IN22                           LN0234
     C                     END                                            S01177
     C*                                                                   S01177
     C           PMCMDP    IFEQ '03'                                      S01177
     C                     MOVE '1'       *INKC                           S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C           #BG9      ENDSR                           **#BG9**       S01177
     C*                                                                   S01177
      /EJECT                                                              S01177
     C*****************************************************************   S01177
     C*                                                               *   S01177
     C* #BGA     - Screen 2 insert processing                         *   S01177
     C*                                                               *   S01177
     C* CALLS                                                         *   S01177
     C*                                                               *   S01177
     C* CALLED BY  #BG    - F14 processing                            *   S01177
     C*                                                               *   S01177
     C* FLDS USED         -                                           *   S01177
     C*                                                               *   S01177
     C*****************************************************************   S01177
     C           #BGA      BEGSR                                          S01177
     C*                                                                   S01177
     C** Set parameters to allow update and validation of settlement      S01177
     C**   fields                                                         S01177
     C                     MOVE 'N'       PMSDTV                          S01177
     C*                                                                   S01177
     C** Check whether pay or receive instructions to be protected        S01177
     C*                                                                   S01177
     C** If deal is a deposit                                             S01177
     C           H@MTYP    IFEQ 'IT'                       B1             S01177
     C           H@MTYP    OREQ 'TD'                       *1             S01177
     C           H@MTYP    OREQ 'CI'                       *1             S01177
     C           H@MTYP    OREQ 'CD'                       *1             S01177
     C*                                                                   S01177
     C**     and Deam type is SI or PD protect receipt details            S01177
     C*      unless negative interest indicator = Y                       DT0091
     C           DDMTYP    IFEQ 'SI'                       B*2            S01177
     C           HKNGVI    ANDEQ' '                                       DT0091
     C           DDMTYP    OREQ 'SI'                                      101523
     C           HKNGVI    ANDEQ'N'                                       101523
     C           DDMTYP    OREQ 'PD'                        *2            S01177
     C*                                                                   S01177
     C                     MOVE 'Y'       PMPRCV            *2            S01177
     C                     MOVE 'N'       PMPPAY            *2            S01177
     C*                                                                   S01177
     C** Blank out the protected receipt details fields in case           049518
     C** the deal amendment type has been changed from PI                 049518
     C*                                                                   049518
     C                     MOVE *ZEROS    PMRSTM            *2            049518
     C                     MOVE *BLANKS   PMRONS            *2            049518
     C                     MOVE *BLANKS   PARIBN            *2            049518
     C                     MOVE *BLANKS   PMRIBN            *2            049518
     C                     MOVE *BLANKS   PMRIBA            *2            049518
     C                     MOVE *BLANKS   PAROBN            *2            049518
     C                     MOVE *BLANKS   PMROBN            *2            049518
     C                     MOVE *BLANKS   PAROCN            *2            049518
     C                     MOVE *BLANKS   PMROCN            *2            049518
     C                     MOVE *BLANKS   PMROBR            *2            049518
     C                     MOVE *BLANKS   PMRSCY                          CEU003
     C*                                                                   049518
     C**     else protect payment details                                 S01177
     C                     ELSE                             X2            S01177
     C                     MOVE 'N'       PMPRCV            *2            S01177
     C                     MOVE 'Y'       PMPPAY            *2            S01177
     C*                                                                   049518
     C** Blank out the protected pay details fields in case               049518
     C** the deal amendment type has been changed from PD                 049518
     C*                                                                   049518
     C                     MOVE *ZEROS    PMPSTM            *2            049518
     C                     MOVE *BLANKS   PMPONS            *2            049518
     C                     MOVE *BLANKS   PAPIBN            *2            049518
     C                     MOVE *BLANKS   PMPIBN            *2            049518
     C                     MOVE *BLANKS   PMPIBA            *2            049518
     C                     MOVE *BLANKS   PAPOBN            *2            049518
     C                     MOVE *BLANKS   PMPOBN            *2            049518
     C                     MOVE *BLANKS   PAPOCN            *2            049518
     C                     MOVE *BLANKS   PMPOCN            *2            049518
     C                     MOVE *BLANKS   PARCRN            *2            049518
     C                     MOVE *BLANKS   PMRCRN            *2            049518
     C                     MOVE *BLANKS   PMRCRA            *2            049518
     C                     MOVE *BLANKS   PARVNO            *2            049518
     C                     MOVE *BLANKS   PMRVNO            *2            049518
     C                     MOVE *BLANKS   PAAWBN            *2            049518
     C                     MOVE *BLANKS   PMAWBN            *2            049518
     C                     MOVE *BLANKS   PMAWBA            *2            049518
     C                     MOVE *BLANKS   PABENN            *2            049518
     C                     MOVE *BLANKS   PMBENN            *2            049518
     C                     MOVE *BLANKS   PMBENA            *2            049518
     C                     MOVE *BLANKS   PMDTP1            *2            049518
     C                     MOVE *BLANKS   PMDTP2            *2            049518
     C                     MOVE *BLANKS   PMDTP3            *2            049518
     C                     MOVE *BLANKS   PMDTP4            *2            049518
     C                     MOVE *BLANKS   PMDCHG            *2            049518
     C                     MOVE *BLANKS   PMBTB1            *2            049518
     C                     MOVE *BLANKS   PMBTB2            *2            049518
     C                     MOVE *BLANKS   PMBTB3            *2            049518
     C                     MOVE *BLANKS   PMBTB4            *2            049518
     C                     MOVE *BLANKS   PMBTB5            *2            049518
     C                     MOVE *BLANKS   PMBTB6            *2            049518
     C                     MOVE *BLANKS   PMCVMR            *2            049518
     C                     MOVE *BLANKS   PMPOBR            *2            049518
     C                     MOVE *BLANKS   PMPSCY                          CEU003
     C                     MOVE *BLANKS   PMIERI                          CEU003
     C                     MOVE *BLANKS   PMIC72                          CEU003
     C*                                                                   049518
     C                     END                              E2            S01177
     C*                                                                   S01177
     C** Else deal is a loan                                              S01177
     C                     ELSE                             X1            S01177
     C**     and Deam type is SI or PD protect pay details                S01177
     C*      unless negative interest indicator = Y                       DT0091
     C           DDMTYP    IFEQ 'SI'                       B*2            S01177
     C           HKNGVI    ANDEQ' '                                       DT0091
     C           DDMTYP    OREQ 'SI'                                      101523
     C           HKNGVI    ANDEQ'N'                                       101523
     C           DDMTYP    OREQ 'PD'                        *2            S01177
     C*                                                                   S01177
     C                     MOVE 'N'       PMPRCV            *2            S01177
     C                     MOVE 'Y'       PMPPAY            *2            S01177
     C*                                                                   049518
     C** Blank out the protected pay details fields in case               049518
     C** the deal amendment type has been changed from PI                 049518
     C*                                                                   049518
     C                     MOVE *ZEROS    PMPSTM            *2            049518
     C                     MOVE *BLANKS   PMPONS            *2            049518
     C                     MOVE *BLANKS   PAPIBN            *2            049518
     C                     MOVE *BLANKS   PMPIBN            *2            049518
     C                     MOVE *BLANKS   PMPIBA            *2            049518
     C                     MOVE *BLANKS   PAPOBN            *2            049518
     C                     MOVE *BLANKS   PMPOBN            *2            049518
     C                     MOVE *BLANKS   PAPOCN            *2            049518
     C                     MOVE *BLANKS   PMPOCN            *2            049518
     C                     MOVE *BLANKS   PARCRN            *2            049518
     C                     MOVE *BLANKS   PMRCRN            *2            049518
     C                     MOVE *BLANKS   PMRCRA            *2            049518
     C                     MOVE *BLANKS   PARVNO            *2            049518
     C                     MOVE *BLANKS   PMRVNO            *2            049518
     C                     MOVE *BLANKS   PAAWBN            *2            049518
     C                     MOVE *BLANKS   PMAWBN            *2            049518
     C                     MOVE *BLANKS   PMAWBA            *2            049518
     C                     MOVE *BLANKS   PABENN            *2            049518
     C                     MOVE *BLANKS   PMBENN            *2            049518
     C                     MOVE *BLANKS   PMBENA            *2            049518
     C                     MOVE *BLANKS   PMDTP1            *2            049518
     C                     MOVE *BLANKS   PMDTP2            *2            049518
     C                     MOVE *BLANKS   PMDTP3            *2            049518
     C                     MOVE *BLANKS   PMDTP4            *2            049518
     C                     MOVE *BLANKS   PMDCHG            *2            049518
     C                     MOVE *BLANKS   PMBTB1            *2            049518
     C                     MOVE *BLANKS   PMBTB2            *2            049518
     C                     MOVE *BLANKS   PMBTB3            *2            049518
     C                     MOVE *BLANKS   PMBTB4            *2            049518
     C                     MOVE *BLANKS   PMBTB5            *2            049518
     C                     MOVE *BLANKS   PMBTB6            *2            049518
     C                     MOVE *BLANKS   PMCVMR            *2            049518
     C                     MOVE *BLANKS   PMPOBR            *2            049518
     C                     MOVE *BLANKS   PMPSCY                          CEU003
     C                     MOVE *BLANKS   PMIERI                          CEU003
     C                     MOVE *BLANKS   PMIC72                          CEU003
     C*                                                                   S01177
     C**     else protect receipt details                                 S01177
     C                     ELSE                             X2            S01177
     C                     MOVE 'Y'       PMPRCV            *2            S01177
     C                     MOVE 'N'       PMPPAY            *2            S01177
     C*                                                                   049518
     C** Blank out the protected receipt details fields in case           049518
     C** the deal amendment type has been changed from PD                 049518
     C*                                                                   049518
     C                     MOVE *ZEROS    PMRSTM            *2            049518
     C                     MOVE *BLANKS   PMRONS            *2            049518
     C                     MOVE *BLANKS   PARIBN            *2            049518
     C                     MOVE *BLANKS   PMRIBN            *2            049518
     C                     MOVE *BLANKS   PMRIBA            *2            049518
     C                     MOVE *BLANKS   PAROBN            *2            049518
     C                     MOVE *BLANKS   PMROBN            *2            049518
     C                     MOVE *BLANKS   PAROCN            *2            049518
     C                     MOVE *BLANKS   PMROCN            *2            049518
     C                     MOVE *BLANKS   PMROBR            *2            049518
     C                     MOVE *BLANKS   PMRSCY                          CEU003
     C*                                                                   049518
     C                     END                              E2            S01177
     C                     END                              E1            S01177
     C*                                                                   S01177
     C** for Internal funding Deals protect Pay & Receive Instructions    S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                                      S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C                     MOVE 'Y'       PMPRCV                          S01354
     C                     MOVE 'Y'       PMPPAY                          S01354
     C                     END                                            S01354
     C*                                                                   S01354
     C*                                                                   S01177
     C** If this is not the first time in for this deal show already      S01177
     C**   invalidated fields highlighted                                 S01177
     C/COPY WNCPYSRC,MM0028C031
     C           PMFRST    IFEQ 'N'                                       S01177
     C                     MOVE 'Y'       PMVALO                          S01177
     C*                                                                   S01177
     C                     ELSE                                           S01177
     C                     MOVE 'N'       PMVALO                          S01177
     C*                                                                   S01177
     C** New deal insert so blank out parameters                          S01177
     C                     MOVE *ZEROS    PMRSTM                          S01177
     C                     MOVE *BLANKS   PMRONS                          S01177
     C                     MOVE *BLANKS   PARIBN                          S01177
     C                     MOVE *BLANKS   PMRIBN                          S01177
     C                     MOVE *BLANKS   PMRIBA                          S01177
     C                     MOVE *BLANKS   PAROBN                          S01177
     C                     MOVE *BLANKS   PMROBN                          S01177
     C                     MOVE *BLANKS   PAROCN                          S01177
     C                     MOVE *BLANKS   PMROCN                          S01177
     C                     MOVE *ZEROS    PMPSTM                          S01177
     C                     MOVE *BLANKS   PMPONS                          S01177
     C                     MOVE *BLANKS   PAPIBN                          S01177
     C                     MOVE *BLANKS   PMPIBN                          S01177
     C                     MOVE *BLANKS   PMPIBA                          S01177
     C                     MOVE *BLANKS   PAPOBN                          S01177
     C                     MOVE *BLANKS   PMPOBN                          S01177
     C                     MOVE *BLANKS   PAPOCN                          S01177
     C                     MOVE *BLANKS   PMPOCN                          S01177
     C                     MOVE *BLANKS   PARCRN                          S01177
     C                     MOVE *BLANKS   PMRCRN                          S01177
     C                     MOVE *BLANKS   PMRCRA                          S01177
     C                     MOVE *BLANKS   PARVNO                          S01177
     C                     MOVE *BLANKS   PMRVNO                          S01177
     C                     MOVE *BLANKS   PAAWBN                          S01177
     C                     MOVE *BLANKS   PMAWBN                          S01177
     C                     MOVE *BLANKS   PMAWBA                          S01177
     C                     MOVE *BLANKS   PABENN                          S01177
     C                     MOVE *BLANKS   PMBENN                          S01177
     C                     MOVE *BLANKS   PMBENA                          S01177
     C                     MOVE *BLANKS   PMDTP1                          S01177
     C                     MOVE *BLANKS   PMDTP2                          S01177
     C                     MOVE *BLANKS   PMDTP3                          S01177
     C                     MOVE *BLANKS   PMDTP4                          S01177
     C                     MOVE *BLANKS   PMDCHG                          S01177
     C                     MOVE *BLANKS   PMBTB1                          S01177
     C                     MOVE *BLANKS   PMBTB2                          S01177
     C                     MOVE *BLANKS   PMBTB3                          S01177
     C                     MOVE *BLANKS   PMBTB4                          S01177
     C                     MOVE *BLANKS   PMBTB5                          S01177
     C                     MOVE *BLANKS   PMBTB6                          S01177
     C                     MOVE *BLANKS   PMCVMR                          E22405
     C                     MOVE *BLANKS   PMROBR                          LN0822
     C                     MOVE *BLANKS   PMPOBR                          LN0822
     C                     MOVE *BLANKS   PMRSCY                          CEU003
     C                     MOVE *BLANKS   PMPSCY                          CEU003
     C                     MOVE *BLANKS   PMIERI                          CEU003
     C                     MOVE *BLANKS   PMIC72                          CEU003
     C*                                                                   S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C           #BGA9     ENDSR                           **#BGA9**      S01177
      /EJECT                                                              S01177
     C*****************************************************************   S01177
     C*                                                               *   S01177
     C* #BGB     - Screen 2 amend  processing                         *   S01177
     C*                                                               *   S01177
     C* CALLS                                                         *   S01177
     C*                                                               *   S01177
     C* CALLED BY  #BG    - F14 processing                            *   S01177
     C*                                                               *   S01177
     C* FLDS USED         -                                           *   S01177
     C*                                                               *   S01177
     C*****************************************************************   S01177
     C           #BGB      BEGSR                                          S01177
     C*                                                                   S01177
     C** Set parameters to allow update and validation of settlement      S01177
     C**   fields                                                         S01177
     C                     MOVE 'N'       PMSDTV                          S01177
     C*                                                                   S01177
     C** Check whether pay or receive instructions to be protected        S01177
     C*                                                                   S01177
     C** If deal is a deposit                                             S01177
     C           H@MTYP    IFEQ 'IT'                       B1             S01177
     C           H@MTYP    OREQ 'TD'                       *1             S01177
     C           H@MTYP    OREQ 'CI'                       *1             S01177
     C           H@MTYP    OREQ 'CD'                       *1             S01177
     C*                                                                   S01177
     C**     and Deam type is SI or PD protect receipt details            S01177
     C*      unless negative interest indicator = Y                       DT0091
     C           DDMTYP    IFEQ 'SI'                       B*2            S01177
     C           HKNGVI    ANDEQ' '                                       DT0091
     C           DDMTYP    OREQ 'SI'                                      101523
     C           HKNGVI    ANDEQ'N'                                       101523
     C           DDMTYP    OREQ 'PD'                        *2            S01177
     C*                                                                   S01177
     C                     MOVE 'Y'       PMPRCV            *2            S01177
     C                     MOVE 'N'       PMPPAY            *2            S01177
     C*                                                                   S01177
     C**     else protect payment details                                 S01177
     C                     ELSE                             X2            S01177
     C                     MOVE 'N'       PMPRCV            *2            S01177
     C                     MOVE 'Y'       PMPPAY            *2            S01177
     C                     END                              E2            S01177
     C*                                                                   S01177
     C** Else deal is a loan                                              S01177
     C                     ELSE                             X1            S01177
     C**     and Deam type is SI or PD protect pay details                S01177
     C*      unless negative interest indicator = Y                       DT0091
     C           DDMTYP    IFEQ 'SI'                       B*2            S01177
     C           HKNGVI    ANDEQ' '                                       DT0091
     C           DDMTYP    OREQ 'SI'                                      101523
     C           HKNGVI    ANDEQ'N'                                       101523
     C           DDMTYP    OREQ 'PD'                        *2            S01177
     C*                                                                   S01177
     C                     MOVE 'N'       PMPRCV            *2            S01177
     C                     MOVE 'Y'       PMPPAY            *2            S01177
     C*                                                                   S01177
     C**     else protect receipt details                                 S01177
     C                     ELSE                             X2            S01177
     C                     MOVE 'Y'       PMPRCV            *2            S01177
     C                     MOVE 'N'       PMPPAY            *2            S01177
     C                     END                              E2            S01177
     C                     END                              E1            S01177
     C*                                                                   S01177
     C** for Internal funding Deals protect Pay & Receive Instructions    S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                                      S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C                     MOVE 'Y'       PMPRCV                          S01354
     C                     MOVE 'Y'       PMPPAY                          S01354
     C                     END                                            S01354
     C*                                                                   S01354
     C*                                                                   S01177
     C** If this is not the first time in for this deal show already      S01177
     C**   invalidated fields highlighted                                 S01177
     C           PMFRST    IFEQ 'N'                                       S01177
     C                     MOVE 'Y'       PMVALO                          S01177
     C*                                                                   S01177
     C                     ELSE                                           S01177
     C                     MOVE 'N'       PMVALO                          S01177
     C*                                                                   S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C           #BGB9     ENDSR                           **#BGB9**      S01177
      /EJECT                                                              S01177
     C*****************************************************************   S01177
     C*                                                               *   S01177
     C* #BGC     - Screen 2 enquiry processing                        *   S01177
     C*                                                               *   S01177
     C* CALLS                                                         *   S01177
     C*                                                               *   S01177
     C* CALLED BY  #BG    - F14 processing                            *   S01177
     C*                                                               *   S01177
     C* FLDS USED         -                                           *   S01177
     C*                                                               *   S01177
     C*****************************************************************   S01177
     C           #BGC      BEGSR                                          S01177
     C*                                                                   S01177
     C** Set parameters to protect settlement fields , no validation      S01177
     C                     MOVE 'Y'       PMSDTV                          S01177
     C                     MOVE 'N'       PMVALO                          S01177
     C                     MOVE 'Y'       PMPRCV                          S01177
     C                     MOVE 'Y'       PMPPAY                          S01177
     C*                                                                   S01177
     C*                                                                   S01177
     C           #BGC9     ENDSR                           **#BGC9**      S01177
      /EJECT                                                              S01177
     C*****************************************************************   S01177
     C*                                                               *   S01177
     C* #BGD     - Screen 2 authorisation processing                  *   S01177
     C*                                                               *   S01177
     C* CALLS                                                         *   S01177
     C*                                                               *   S01177
     C* CALLED BY  #BG    - F14 processing                            *   S01177
     C*                                                               *   S01177
     C* FLDS USED         -                                           *   S01177
     C*                                                               *   S01177
     C*****************************************************************   S01177
     C           #BGD      BEGSR                                          S01177
     C*                                                                   S01177
     C** Set parameters to protect settlement fields , but allow          S01177
     C**   validation                                                     S01177
     C                     MOVE 'N'       PMSDTV                          S01177
     C                     MOVE 'Y'       PMVALO                          S01177
     C                     MOVE 'Y'       PMPRCV                          S01177
     C                     MOVE 'Y'       PMPPAY                          S01177
     C*                                                                   S01177
     C           #BGD9     ENDSR                           **#BGD9*       S01177
      /EJECT                                                              S01177
     C*****************************************************************   S01177
     C*                                                               *   S01177
     C* #BGF              - Screen 2 initial validation               *   S01177
     C*                                                               *   S01177
     C* CALLS                                                         *   S01177
     C*                                                               *   S01177
     C* CALLED BY  #BG    - F14  processing                           *   S01177
     C*                                                               *   S01177
     C* FLDS USED         -                                           *   S01177
     C*                                                               *   S01177
     C*****************************************************************   S01177
     C           #BGF      BEGSR                                          S01177
     C*                                                                   S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP2                                           S01408
     C*                                                                   S01408
     C*  *----------------------------------*                             S01177
     C*  * Validate Customer                *                             S01177
     C*  *----------------------------------*                             S01177
     C*                                                                   S01177
     C**  Customer may only be blank for complete deals on which it       S01177
     C**  is not mandatory                                                S01177
     C           @STS      IFEQ 'C'                        B1             S01177
     C           ICCNMM    ANDNE'N'                        B1             S01177
     C           DDCSNM    ANDEQ*BLANKS                    B1             S01177
     C           @STS      ORNE 'C'                        B1             S01177
     C           DDCSNM    ANDEQ*BLANKS                    B1             S01177
     C                     MOVE '1'       *IN10            *1             S01177
     C                     MOVE '1'       *IN41            *1             S01177
     C                     MOVEL'MMM0204' @MSGID           *1             S01177
     C                     CALL 'ZA0240'                   *1             S01177
     C                     PARM           @MSGID           *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C**  For authorization customer must not be blank                    S01177
     C           DDACTN    IFEQ 'X'                        B1             S01177
     C           DDCSNM    ANDEQ*BLANKS                    B1             S01177
     C                     MOVE '1'       *IN10            *1             S01177
     C                     MOVE '1'       *IN41            *1             S01177
     C                     MOVEL'MMM0506' @MSGID           *1             S01177
     C                     CALL 'ZA0240'                   *1             S01177
     C                     PARM           @MSGID           *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C**  If the input is not blank, validate it.                         S01177
     C           DDCSNM    IFNE *BLANKS                    B1             S01177
     C*                                                                   S01177
     C*****heck if the input is numeric.                          S01177  S01194
     C*****                MOVE *BLANKS   @@ALPH           *1     S01177  S01194
     C*****                Z-ADD0         @@IDP            *1     S01177  S01194
     C*****                Z-ADD6         @@IINT           *1     S01177  S01194
     C*****                MOVE DDCSNM    @@ALPH           *1     S01177  S01194
     C*****                EXSR ZA0840                     *1     S01177  S01194
     C*****                                                       S01177  S01194
     C*****f ZA0840 returns no errors, the result will be treated S01177  S01194
     C*****s a customer number, else it will be a shortname.      S01177  S01194
     C*****      @@ERCD    IFEQ 0                          B*2    S01177  S01194
     C*****                Z-ADD@@AMT     @CNUM            **2    S01177  S01194
     C*****      @CLTKY    CHAINCLINT                65    **2    S01177  S01194
     C*****      *IN65     IFEQ '1'                        B**3   S01177  S01194
      *                                                                   S01194
032  C* CALL ACCESS PROG. FOR CUSTOMER DETAILS.                           S01194
     C                     CALL 'AOCUSTR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM DDCSNM    @CLKEY 10                       S01194
     C                     PARM *BLANKS   @KYST   7                       E70
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *IN10            ***3           S01177
     C                     MOVE '1'       *IN41            ***3           S01177
     C                     MOVEL'MMM0205' @MSGID           ***3           S01177
     C                     CALL 'ZA0240'                   ***3           S01177
     C                     PARM           @MSGID           ***3           S01177
     C                     ELSE                                           E70
     C/COPY WNCPYSRC,MM0028C140
     C           DDCSNM    IFEQ '?'                                       E70
     C                     MOVELBBCUST    DDCSNM                          E70
     C/COPY WNCPYSRC,MM0028C064
     C                     END                                            E70
     C                     END                             E**3           S01177
     C*****                END                             E*2    S01177  S01194
     C*****                ELSE                            X*2    S01177  S01194
     C*****      DDCSNM    CHAINSNAME                65    **2    S01177  S01194
     C*****      *IN65     IFEQ '1'                        B**3   S01177  S01194
     C*****      RECI      ORNE 'D'                        B**3   S01177  S01194
     C*****                MOVE '1'       *IN10            ***3   S01177  S01194
     C*****                MOVE '1'       *IN41            ***3   S01177  S01194
     C*****                MOVEL'MMM0205' @MSGID           ***3   S01177  S01194
     C*****                CALL 'ZA0240'                   ***3   S01177  S01194
     C*****                PARM           @MSGID           ***3   S01177  S01194
     C*****                END                             E**3   S01177  S01194
     C*****                END                             E*2    S01177  S01194
     C*                                                                   S01177
     C**  If a record was found, check that the customer is not a         S01177
     C**  parent.                                                         S01177
     C           *IN10     IFEQ '0'                        B*2            S01177
     C*****                TESTB'2'       CMIN           65**2    S01177  S01194
     C*****      *IN65     IFEQ '1'                        B**3   S01177  S01194
     C           BBPAIN    IFEQ 'P'                        B**3           S01194
     C                     MOVE '1'       *IN10            ***3           S01177
     C                     MOVE '1'       *IN41            ***3           S01177
     C                     MOVEL'MMM0206' @MSGID           ***3           S01177
     C                     CALL 'ZA0240'                   ***3           S01177
     C                     PARM           @MSGID           ***3           S01177
     C                     END                             E**3           S01177
     C                     END                             E*2            S01177
     C*                                                                   S01177
     C** Compare deam customer number with customer number from related   S01177
     C** deal                                                             S01177
     C*****      CNUM      IFNE H@CNUM                     B*2    S01177  S01194
     C**   Converting an alpha field to a numeric field                   S01194
     C**********           MOVE BBCUST    @A7AEN  60                                   S01194 CSD027
     C                     MOVE BBCUST    @A7AEN  6                                           CSD027
     C           @A7AEN    IFNE H@CNUM                     B*2            S01194
     C                     MOVE '1'       *IN10            **2            S01177
     C                     MOVE '1'       *IN41            **2            S01177
     C                     MOVEL'MMM0474' @MSGID           **2            S01177
     C                     CALL 'ZA0240'                   **2            S01177
     C                     PARM           @MSGID           **2            S01177
     C                     END                             E*2            S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*  *-------------------------------------------*                    S01177
     C*  * Validate Value Date / Deal amendment type *                    S01177
     C*  *-------------------------------------------*                    S01177
     C*                                                                   S01177
     C**  Amendment type must not be blank                                S01177
     C           DDMTYP    IFEQ *BLANKS                    B1             S01177
     C                     MOVEL'MMM0297' @MSGID           *1             S01177
     C                     CALL 'ZA0240'                   *1             S01177
     C                     PARM           @MSGID           *1             S01177
     C                     MOVE '1'       *IN03            *1             S01177
     C                     MOVE '1'       *IN41            *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C**  Type must have a value of SC,PI,PD,CI or SI                     S01177
     C           DDMTYP    IFNE 'SC'                       B1             S01177
     C           DDMTYP    ANDNE'PI'                       B1             S01177
     C           DDMTYP    ANDNE'PD'                       B1             S01177
     C           DDMTYP    ANDNE'CI'                       B1             S01177
     C           DDMTYP    ANDNE'SI'                       B1             S01177
     C                     MOVE '1'       *IN03            *1             S01177
     C                     MOVE '1'       *IN41            *1             S01177
     C                     MOVEL'MMM0298' @MSGID           *1             S01177
     C                     CALL 'ZA0240'                   *1             S01177
     C                     PARM           @MSGID           *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*  For types CI or SI                                               S01177
     C** Value date must not be greater than both interest accrual        S01177
     C** control date & start/last interest date.                         S01177
     C           DDMTYP    IFEQ 'CI'                       B1             S01177
     C           DDMTYP    OREQ 'SI'                       B1             S01177
     C*                                                                   S01177
     C           @VDYNO    IFLE @SLDYN                     B*2            S01177
     C***********@VDYNO    ANDLE@IADYN                     B*2      S01177E22271
     C           @VDYNO    ORLE @IADYN                     B*2      S01177E22271
     C*                                                                   S01177
     C                     MOVE '1'       *IN11            **2            S01177
     C                     MOVE '1'       *IN03            **2            S01177
     C                     MOVE '1'       *IN41            **2            S01177
     C                     MOVEL'MMM0299' @MSGID           **2            S01177
     C                     CALL 'ZA0240'                   **2            S01177
     C                     PARM           @MSGID           **2            S01177
     C                     END                             E*2            S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*  For CI deal types disallow change to interest settlement         089621
     C*  instructions if settlement instructions not equal to 'Y'         089621
     C*                                                                   089621
     C           DDMTYP    IFEQ 'CI'                                      089621
     C           HKCPTI    IFNE 'Y'                                       089621
     C*                                                                   089621
     C                     MOVE '1'       *IN41                           089621
     C           *IN66     IFEQ '0'                                       089621
     C                     MOVE '1'       *IN66                           089621
     C                     MOVEL'MMM0317' @MSGID                          089621
     C                     CALL 'ZA0240'                                  089621
     C                     PARM           @MSGID                          089621
     C                     END                                            089621
     C*                                                                   089621
     C                     END                                            089621
     C                     END                                            089621
     C*                                                                   089621
     C** For type SI                                                      S01177
     C** Retrieve NAS details for the associated deal, if they            S01177
     C** exist, and check the Deam value date is not after the            S01177
     C** date of the NA sale.                                             S01177
     C           DDMTYP    IFEQ 'SI'                       B1             S01177
     C*                                                                   S01177
     C** clear NAB associated deal no in case previous deal was NAB       S01177
     C                     MOVE *BLANKS   HLDADN           *1             S01177
     C*                                                                   S01177
     C** Retrieve NAB details for the associated deal.                    S01177
     C                     MOVE DDDLNO    @DLKEY           *1             S01177
     C           @DLKEY    CHAINMMDEALLL             65    *1             S01177
     C*                                                                   S01177
     C           *IN65     IFEQ '1'                        B*2            S01177
     C                     MOVE '1'       *INLR            **2            S01177
     C                     MOVE '1'       *INU7            **2            S01177
     C                     MOVE '1'       *INU8            **2            S01177
     C                     MOVE '1'       *INKC            ********E12145 S01177
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 005 *S01177
     C                     MOVELDDDLNO    DBKEY            ***************S01177
     C                     MOVE '005'     DBASE            **2            S01177
     C                     EXSR #C                         **2            S01177
     C*                                                                   S01177
     C                     ELSE                            X*2            S01177
     C*                                                                   S01177
     C** If there is a NAS deal number in the deal associated             S01177
     C** deal number field, retrieve NAS details.                         S01177
     C           HLDADN    IFNE *BLANK                     B**3           S01177
     C                     MOVE HLDADN    @DLKEY           ***3           S01177
     C           @DLKEY    CHAINMMDEALLL             65    ***3           S01177
     C*                                                                   S01177
     C           *IN65     IFEQ '1'                        B***4          S01177
     C                     MOVE '1'       *INLR            ****4          S01177
     C                     MOVE '1'       *INU7            ****4          S01177
     C                     MOVE '1'       *INU8            ****4          S01177
     C                     MOVE '1'       *INKC            ********E12145 S01177
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 006 *S01177
     C                     MOVELHLDADN    DBKEY            ***************S01177
     C                     MOVE '006'     DBASE            ****4          S01177
     C                     EXSR #C                         ****4          S01177
     C*                                                                   S01177
     C                     ELSE                            X***4          S01177
     C*                                                                   S01177
     C** Convert NA sale date to MIDAS day number.                        S01177
     C***********          Z-ADDH@VDAT    @@DTIN           ****4    S01177056095
     C***********          EXSR ZA0680                     ****4    S01177056095
     C                     Z-ADDH@VDAT    ZZDTIN           ****4          056095
     C                     EXSR ZDAT10                     ****4          056095
     C*                                                                   S01177
     C** Check that the Deam value date is not after the NA sale date.    S01177
     C***********@VDYNO    IFGT @@MDNO                     B****5   S01177056095
     C           @VDYNO    IFGT ZZMDNO                     B****5         056095
     C                     MOVE '1'       *IN02            *****5         S01177
     C                     MOVE '1'       *IN41            *****5         S01177
     C                     MOVEL'MMM0580' @MSGID           *****5         S01177
     C                     CALL 'ZA0240'                   *****5         S01177
     C                     PARM           @MSGID           *****5         S01177
     C                     END                             E****5         S01177
     C*                                                                   S01177
     C** Return NAB details to common fields.                             S01177
     C                     MOVE DDDLNO    @DLKEY           ****4          S01177
     C           @DLKEY    CHAINMMDEALLL             65    ****4          S01177
     C*                                                                   S01177
     C                     END                             E***4          S01177
     C                     END                             E**3           S01177
     C                     END                             E*2            S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*  For types PI,PD or SC                                            S01177
     C** If Value date of DEAL is = to both interest accrual              S01177
     C** control date & start/last interest date.                         S01177
     C***Value*date*must*not*be*greater*than*both*interest*accrual  S01177E22271
     C** Value date must not be LESS than both interest accrual     S01177E22271
     C** control date & start/last interest date.                         S01177
     C           DDMTYP    IFEQ 'PI'                       B1             S01177
     C           DDMTYP    OREQ 'PD'                       B1             S01177
     C           DDMTYP    OREQ 'SC'                       B1             S01177
     C*                                                                   S01177
     C           H@VDAT    IFEQ H@SLDT                     B*2            S01177
     C           H@VDAT    ANDEQH@IADT                     **2            S01177
     C*                                                                   S01177
     C           @VDYNO    IFLT @SLDYN                     B**3           S01177
     C           @VDYNO    ANDLT@IADYN                     ***3           S01177
     C                     MOVE '1'       *IN11            ***3           S01177
     C                     MOVE '1'       *IN03            ***3           S01177
     C                     MOVE '1'       *IN41            ***3           S01177
     C                     MOVEL'MMM0300' @MSGID           ***3           S01177
     C                     CALL 'ZA0240'                   ***3           S01177
     C                     PARM           @MSGID           ***3           S01177
     C                     END                             E**3           S01177
     C*                                                                   S01177
     C                     ELSE                            X*2            S01177
     C*                                                                   S01177
     C** If Value date of DEAL is NOT = to both interest accrual          S01177
     C** control date & start/last interest date.                         S01177
     C***Value*date*must*not*be*greater*than*both*interest*accrual  S01177E22271
     C** Value date must be greater than both interest accrual      S01177E22271
     C** control date & start/last interest date.                         S01177
     C*                                                                   S01177
     C***********@VDYNO    IFLE @SLDYN                     B**3     S01177E22271
     C***********@VDYNO    ANDLE@IADYN                     B**3     S01177E22271
     C           @VDYNO    IFLT @SLDYN                     B**3     S01177E22271
     C           @VDYNO    ORLT @IADYN                     B**3     S01177E22271
     C*                                                                   S01177
     C                     MOVE '1'       *IN11            ***3           S01177
     C                     MOVE '1'       *IN03            ***3           S01177
     C                     MOVE '1'       *IN41            ***3           S01177
     C                     MOVEL'MMM0300' @MSGID           ***3           S01177
     C                     CALL 'ZA0240'                   ***3           S01177
     C                     PARM           @MSGID           ***3           S01177
     C                     END                             E**3           S01177
     C                     END                             E*2            S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C** For type SI interest capitilisation indicator must not be 'Y'    S01177
     C** Not present for N/A's bought or sold                             S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP67                                           S01408
     C*                                                                   S01408
     C           DDMTYP    IFEQ 'SI'                       B1             S01177
     C           H@RCID    ANDEQ'HK'                       *1             S01177
     C           HKCPTI    ANDEQ'Y'                        *1             S01177
     C                     MOVE '1'       *IN03            *1             S01177
     C                     MOVE '1'       *IN41            *1             S01177
     C                     MOVEL'MMM0301' @MSGID           *1             S01177
     C                     CALL 'ZA0240'                   *1             S01177
     C                     PARM           @MSGID           *1             S01177
     C                     END                             E1             S01177
     C*                                                                   109499
     C** For type CI interest capitilisation indicator must be 'Y'        109499
     C           DDMTYP    IFEQ 'CI'                       B1             109499
     C           H@RCID    ANDEQ'HK'                       *1             109499
     C           HKCPTI    ANDNE'Y'                        *1             109499
     C                     MOVE '1'       *IN03            *1             109499
     C                     MOVE '1'       *IN41            *1             109499
     C                     MOVEL'MMM0321' @MSGID           *1             109499
     C                     CALL 'ZA0240'                   *1             109499
     C                     PARM           @MSGID           *1             109499
     C                     END                             E1             109499
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP68                                           S01408
     C*                                                                   S01408
     C*                                                                   S01177
     C***For*deam*type*PI,PD,SC*or*CI*related*deal*type*must*be*****S01177S01354
     C***CD,CL,DL***************************************************S01177S01354
     C** For deam type PI,PD,SC or CI deal types must be CD,CL,DL,IL,ID.  S01354
     C           DDMTYP    IFEQ 'PI'                       B1             S01177
     C           DDMTYP    OREQ 'PD'                       *1             S01177
     C           DDMTYP    OREQ 'SC'                       *1             S01177
     C           DDMTYP    OREQ 'CI'                       *1             S01177
     C           H@MTYP    IFNE 'CD'                       B*2            S01177
     C           H@MTYP    ANDNE'CL'                       **2            S01177
     C           H@MTYP    ANDNE'DL'                       **2            S01177
     C           H@MTYP    ANDNE'IL'                       **2            S01354
     C           H@MTYP    ANDNE'ID'                       **2            S01354
     C                     MOVE '1'       *IN03            **2            S01177
     C                     MOVE '1'       *IN41            **2            S01177
     C                     MOVEL'MMM0302' @MSGID           **2            S01177
     C                     CALL 'ZA0240'                   **2            S01177
     C                     PARM           @MSGID           **2            S01177
     C                     END                             E*2            S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C** For deam type CI or SI next interest date must not be zero       S01177
     C**  if interest frequency is not blank                              S01177
     C           DDMTYP    IFEQ 'SI'                       B1             S01177
     C           H@IPFQ    ANDNE*BLANK                     *1             S01177
     C           H@NIDT    ANDNE*ZEROS                     *1             S01177
     C           DDMTYP    OREQ 'CI'                       *1             S01177
     C           H@IPFQ    ANDNE*BLANK                     *1             S01177
     C           H@NIDT    ANDNE*ZEROS                     *1             S01177
     C                     MOVE '1'       *IN03            *1             S01177
     C                     MOVE '1'       *IN41            *1             S01177
     C                     MOVEL'MMM0303' @MSGID           *1             S01177
     C                     CALL 'ZA0240'                   *1             S01177
     C                     PARM           @MSGID           *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C** For deam type SI related deal must be IT,IP,TD,TI,CI,LN,         S01177
     C** C1,C2,BP,BD.                                                     S01177
     C** or CL or CD.                                                     E20204
     C** or IL or ID.                                                     S01354
     C           DDMTYP    IFEQ 'SI'                       B1             S01177
     C           H@MTYP    IFNE 'IT'                       B*2            S01177
     C           H@MTYP    ANDNE'IP'                       **2            S01177
     C           H@MTYP    ANDNE'TD'                       **2            S01177
     C           H@MTYP    ANDNE'TI'                       **2            S01177
     C           H@MTYP    ANDNE'CI'                       **2            S01177
     C           H@MTYP    ANDNE'LN'                       **2            S01177
     C           H@MTYP    ANDNE'C1'                       **2            S01177
     C           H@MTYP    ANDNE'C2'                       **2            S01177
     C           H@MTYP    ANDNE'BP'                       **2            S01177
     C           H@MTYP    ANDNE'BD'                       **2            S01177
     C           H@MTYP    ANDNE'CL'                       **2            E20204
     C           H@MTYP    ANDNE'CD'                       **2            E20204
     C           H@MTYP    ANDNE'DL'                       **2            BHF906
     C           H@MTYP    ANDNE'IL'                       **2            S01354
     C           H@MTYP    ANDNE'ID'                       **2            S01354
     C                     MOVE '1'       *IN03            **2            S01177
     C                     MOVE '1'       *IN41            **2            S01177
     C                     MOVEL'MMM0304' @MSGID           **2            S01177
     C                     CALL 'ZA0240'                   **2            S01177
     C                     PARM           @MSGID           **2            S01177
     C                     END                             E*2            S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*  *-------------------*                                            S01177
     C*  * Validate Currency *                                            S01177
     C*  *-------------------*                                            S01177
     C*                                                                   S01177
     C** Skip file access & validation which will have been performed     S01177
     C** this is an amendment.                                            S01177
     C           DDACTN    IFNE 'A'                        B1             S01177
     C           DDAMNP    OREQ *BLANKS                    B1             S01177
     C*                                                                   S01177
     C**  The currency must be entered.                                   S01177
     C           DDCCY     IFEQ *BLANKS                    B*2            S01177
     C                     MOVE '1'       *IN16            **2            S01177
     C                     MOVE '1'       *IN41            **2            S01177
     C                     MOVEL'MMM0142' @MSGID           **2            S01177
     C                     CALL 'ZA0240'                   **2            S01177
     C                     PARM           @MSGID           **2            S01177
     C*                                                                   S01177
     C**  If the currency is still valid, check that it is a live         S01177
     C**  dealing currency.                                               S01177
     C                     ELSE                            X*2            S01177
     C*****                MOVE *BLANKS   @KEY             **2    S01177  S01194
     C*****                MOVE '20'      @KEY1            **2    S01177  S01194
     C*****                MOVE DDCCY     @KEY2            **2    S01177  S01194
     C***5*                MOVE '1'       @KEY3            **2    S01177  S01194
     C*****      @KEY      CHAINFDCCYTLL             65    **2    S01177  S01194
     C*****                                                       S01177  S01194
     C**  If no valid record is found, it is an error.                    S01177
     C*****      *IN65     IFEQ '1'                        B**3   S01177  S01194
     C*****      RECI      ORNE 'D'                        B**3   S01177  S01194
032  C* CALL ACCESS PROG. FOR CURRENCY DETAILS.                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM DDCCY     @CRKEY  3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *IN16            ***3           S01177
     C                     MOVE '1'       *IN41            ***3           S01177
     C                     MOVEL'MMM0202' @MSGID           ***3           S01177
     C                     CALL 'ZA0240'                   ***3           S01177
     C                     PARM           @MSGID           ***3           S01177
     C                     ELSE                                           E70
     C                     MOVE A6CYCD    DDCCY                           E70
     C                     END                             E**3           S01177
     C                     END                             E*2            S01177
     C*                                                                   S01177
     C** If error found exit validation                                   S01177
     C           *IN16     IFEQ '1'                        B*2            S01177
     C                     GOTO #BGF9                      **2            S01177
     C                     END                             E*2            S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C** Compare deam currency with that of related deal                  S01177
     C           DDCCY     IFNE H@CCY                      B1             S01177
     C                     MOVE '1'       *IN16            *1             S01177
     C                     MOVE '1'       *IN41            *1             S01177
     C                     MOVEL'MMM0476' @MSGID           *1             S01177
     C                     CALL 'ZA0240'                   *1             S01177
     C                     PARM           @MSGID           *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*                                                                   S01177
     C           #BGF9     ENDSR                           **#BGF9**      S01177
      /EJECT                                                              S01177
     C*****************************************************************
     C*                                                               *
     C* #ZE      - Clear screen                                       *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  #BA    - F12 processing                            *
     C*            #ZO    - Validate deal number and action code      *
     C*                                                               *
     C* FLDS USED  @STDDA - Standard deal format parameter : DEAMS    *
     C*            @ACTN  - stored action code                        *
     C*            @DLNO  - stored deal number                        *
     C*            @CSNM  - stored customer                           *
     C*            @MTYP  - Stored deal type                          *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @INTR  - stored spread rate                        *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C*            @ORCM  - stored rec. settlement method             *
     C*            @MORI  - stored our rec. bank a/c debit            *
     C*            @MCPI  - stored c'party paying bank                *
     C*            @MFAO  - stored for a/c of                         *
     C*            @SPEC  - stored special instructions               *
     C*            @CVMR  - cover MT202 required                      *   E22405
     C*            @AUTO  - auto deal number flag                     *
     C*            @PRFC  - stored profit centre                      *   S01117
     C*            @ORBR  - stored originating branch code            *   S01117
     C*                                                               *
     C*****************************************************************
     C           #ZE       BEGSR
     C*
     C****Clear the standard deal format.                                 E18139
     C****First fill standard deal format data structure with blanks,     E18139
     C****then zeroise numeric fields.                                    E18139
     C******                                                              E18139
     C******               MOVE *BLANKS   @STDDA                          E18139
     C******               Z-ADD0         IGDLUP                          E18139
     C******               Z-ADD0         IGYLUP                          E18139
     C******               Z-ADD0         IGTLUP                          E18139
     C******               Z-ADD0         IGLCD                           E18139
     C******               Z-ADD0         IGDA38                          E18139
     C******               Z-ADD0         IGDS38                          E18139
     C******               Z-ADD0         IGCYDP                          E18139
     C******               Z-ADD0         IGVDYY                          E18139
     C******               Z-ADD0         IGVDMM                          E18139
     C******               Z-ADD0         IGVDDD                          E18139
     C******               Z-ADD0         IGDTYY                          E18139
     C******               Z-ADD0         IGDTMM                          E18139
     C******               Z-ADD0         IGDTDD                          E18139
     C******               Z-ADD0         IGDMDY                          E18139
     C******               Z-ADD0         IGDMDM                          E18139
     C******               Z-ADD0         IGDMDD                          E18139
     C******               Z-ADD0         IGAMNP                          E18139
     C******               Z-ADD0         IGINTR                          E18139
     C******               Z-ADD0         IGORCM                          E18139
     C******               Z-ADD0         IGMOPM                          E18139
     C******               Z-ADD0         IGCNUM                          E18139
     C******               Z-ADD0         IGPCTN                          E18139
     C******               Z-ADD0         IGTIME                          E18139
     C******               Z-ADD0         IGLDAT                          E18139
     C******               Z-ADD0         IGBORM                          E18139
     C******               Z-ADD0         IGBOPM                          E18139
     C******               Z-ADD0         IGBAMT                          E18139
     C******               Z-ADD0         IGBCNM                          E18139
     C******               Z-ADD0         IGBVDT                          E18139
     C******               Z-ADD0         IGBIRT                          E18139
     C******               Z-ADD0         IGRORM                          E18139
     C******               Z-ADD0         IGROPM                          E18139
     C******               Z-ADD0         IGRBAT                          E18139
     C******               Z-ADD0         IGRCNM                          E18139
     C******               Z-ADD0         IGRVDT                          E18139
     C******               Z-ADD0         IGRIRT                          E18139
     C******               Z-ADD0         IGMCHD                          E18139
     C******               Z-ADD0         IGOGDA                          E18139
     C******               Z-ADD0         IGORAT                          E18139
     C******               Z-ADD0         IGOSYY                          E18139
     C******               Z-ADD0         IGOSMM                          E18139
     C******               Z-ADD0         IGOSDD                          E18139
     C******               Z-ADD0         IGOMYY                          E18139
     C******               Z-ADD0         IGOMMM                          E18139
     C******               Z-ADD0         IGOMDD                          E18139
     C******               Z-ADD0         IGONTC                          E18139
     C******               Z-ADD0         IGDVSD                          E18139
     C******               Z-ADD0         IGDDLD                          E18139
     C******               Z-ADD0         IGDLAD                          E18139
     C*
     C/COPY WNCPYSRC,MM0028C032
     C**  Blank all screen input fields.
      *                                                                   136653
      ** Allow blanking of DDACTN after every processing of any           136653
      ** action code. Also, reset to blank @@ACTN if INKL = '1'           136653
      *                                                                   136653
     C           *INKL     IFEQ '1'                                       136653
     C                     MOVE *BLANKS   @@ACTN                          136653
     C                     END                                            136653
     C***********DDACTN    IFNE 'X'                                110471 136653
     C                     MOVE *BLANKS   DDACTN
     C***********          END                                     110471 136653
     C                     MOVE *BLANKS   DDDLNO
     C/COPY WNCPYSRC,MM0028C033
     C                     MOVE *BLANKS   DDMTYP
     C                     MOVE *BLANKS   DDCSNM
     C/COPY WNCPYSRC,MM0028C034
     C                     MOVE *BLANKS   DDVDAT
     C                     MOVE *BLANKS   DDDS38
     C/COPY WNCPYSRC,MM0028C035
     C                     MOVE *BLANKS   DDCCY
     C                     MOVE *BLANKS   DDAMNP
     C                     MOVE *BLANKS   DDINTR
     C                     MOVE *BLANKS   DDCPTY                          S01184
     C                     MOVE *BLANKS   DDBROK                          S01184
     C                     MOVE *BLANKS   DDTEXT                          S01184
     C                     MOVE *BLANKS   DDFSRP                          CAC001
     C*****                MOVE *BLANKS   DDORCM                          S01177
     C*****                MOVE *BLANKS   DDMORI                          S01177
     C*****                MOVE *BLANKS   DDMCPI                          S01177
     C*****                MOVE *BLANKS   DDMFAO                          S01177
     C*****                MOVE *BLANKS   DDSPEC                          S01177
     C                     MOVE *BLANKS   DDLSQN                          LN0663
     C/COPY WNCPYSRC,MM0028CP38                                           S01408
     C                     MOVE '0'       *IN38
     C                     MOVE '0'       *IN39
     C                     MOVE '0'       *IN67
     C                     MOVE '0'       *IN72
     C*
     C**  Clear "F10-CONFIRM" prompt                                      S01177
     C                     MOVE '0'       *IN42                           S01177
     C**  Clear F14 OPTION                                                S01177
     C                     MOVE '0'       *IN76                           S01177
     C                     MOVE *BLANKS   @PRI                            114485
     C*
     C**  Clear CONFIRMATION MATCHING indicator                           S01184
     C                     MOVE '0'       *IN31                           S01184
     C**  Blank settlement screen fields                                  S01177
     C*                                                                   S01177
     C                     MOVE *BLANKS   PMACTC                          S01177
     C                     MOVE *BLANKS   PMCPGM                          S01177
     C                     MOVE *BLANKS   PMTTYP                          S01177
     C                     MOVE *BLANKS   PMCSNM                          S01177
     C                     MOVE *BLANKS   PMRCCY                          S01177
     C                     MOVE *BLANKS   PMPCCY                          S01177
     C                     MOVE *BLANKS   PMFFND                          S01177
     C                     MOVE *BLANKS   PMPRCV                          S01177
     C                     MOVE *BLANKS   PMPPAY                          S01177
     C                     MOVE *BLANKS   PMCMDP                          S01177
     C                     MOVE *BLANKS   PMVALO                          S01177
     C                     MOVE *BLANKS   PMSDTV                          S01177
     C                     MOVE *BLANKS   PMTERM                          S01177
     C                     MOVE *BLANKS   PMRONS                          S01177
     C                     MOVE *BLANKS   PARIBN                          S01177
     C                     MOVE *BLANKS   PMRIBN                          S01177
     C                     MOVE *BLANKS   PMRIBA                          S01177
     C                     MOVE *BLANKS   PAROBN                          S01177
     C                     MOVE *BLANKS   PMROBN                          S01177
     C                     MOVE *BLANKS   PAROCN                          S01177
     C                     MOVE *BLANKS   PMROCN                          S01177
     C                     MOVE *BLANKS   PMPONS                          S01177
     C                     MOVE *BLANKS   PAPIBN                          S01177
     C                     MOVE *BLANKS   PMPIBN                          S01177
     C                     MOVE *BLANKS   PMPIBA                          S01177
     C                     MOVE *BLANKS   PAPOBN                          S01177
     C                     MOVE *BLANKS   PMPOBN                          S01177
     C                     MOVE *BLANKS   PAPOCN                          S01177
     C                     MOVE *BLANKS   PMPOCN                          S01177
     C                     MOVE *BLANKS   PARCRN                          S01177
     C                     MOVE *BLANKS   PMRCRN                          S01177
     C                     MOVE *BLANKS   PMRCRA                          S01177
     C                     MOVE *BLANKS   PARVNO                          S01177
     C                     MOVE *BLANKS   PMRVNO                          S01177
     C                     MOVE *BLANKS   PAAWBN                          S01177
     C                     MOVE *BLANKS   PMAWBN                          S01177
     C                     MOVE *BLANKS   PMAWBA                          S01177
     C                     MOVE *BLANKS   PABENN                          S01177
     C                     MOVE *BLANKS   PMBENN                          S01177
     C                     MOVE *BLANKS   PMBENA                          S01177
     C                     MOVE *BLANKS   PMDTP1                          S01177
     C                     MOVE *BLANKS   PMDTP2                          S01177
     C                     MOVE *BLANKS   PMDTP3                          S01177
     C                     MOVE *BLANKS   PMDTP4                          S01177
     C                     MOVE *BLANKS   PMDCHG                          S01177
     C                     MOVE *BLANKS   PMBTB1                          S01177
     C                     MOVE *BLANKS   PMBTB2                          S01177
     C                     MOVE *BLANKS   PMBTB3                          S01177
     C                     MOVE *BLANKS   PMBTB4                          S01177
     C                     MOVE *BLANKS   PMBTB5                          S01177
     C                     MOVE *BLANKS   PMBTB6                          S01177
     C                     MOVE *BLANKS   PMCVMR                          E22405
     C                     MOVE *BLANKS   PMROBR                          LN0822
     C                     MOVE *BLANKS   PMPOBR                          LN0822
     C                     MOVE *BLANKS   PMDBFL                          S01177
     C                     MOVE *BLANKS   PMDBKY                          S01177
     C                     MOVE *BLANKS   PMDPGM                          S01177
     C                     MOVE *BLANKS   PMERCD                          S01177
      *                                                                   CEU003
     C                     MOVE *BLANKS   PMRSCY                          CEU003
     C                     MOVE *BLANKS   PMPSCY                          CEU003
     C                     MOVE *BLANKS   PMIC72                          CEU003
     C                     MOVE *BLANKS   PMIERI                          CEU003
     C*                                                                   S01177
     C**  Zeroise numeric settlement screen fields                        S01177
     C*                                                                   S01177
     C                     Z-ADD0         PMDTRC                          S01177
     C                     Z-ADD0         PMDTPY                          S01177
     C                     Z-ADD0         PMRSTM                          S01177
     C                     Z-ADD0         PMPSTM                          S01177
     C                     Z-ADD0         PMDBSE                          S01177
     C*
     C**  Blank all program work fields.
     C                     MOVE *BLANKS   @ACTN
     C/COPY WNCPYSRC,MM0028C036
     C                     MOVE *BLANKS   @DLNO
     C/COPY WNCPYSRC,MM0028C037
     C                     MOVE *BLANKS   @MTYP
     C                     MOVE *BLANKS   @CSNM
     C/COPY WNCPYSRC,MM0028C038
     C                     MOVE *BLANKS   @VDAT
     C                     MOVE *BLANKS   @DS38
     C/COPY WNCPYSRC,MM0028C039
     C                     MOVE *BLANKS   @CCY
     C                     MOVE *BLANKS   @AMNP
     C                     MOVE *BLANKS   @INTR
     C                     MOVE *BLANKS   @FSRP                           CAC001
     C                     MOVE *BLANKS   @LSQN                           BHF907
     C*****                MOVE *BLANKS   @ORCM                           S01177
     C*****                MOVE *BLANKS   @MORI                           S01177
     C*****                MOVE *BLANKS   @MCPI                           S01177
     C*****                MOVE *BLANKS   @MFAO                           S01177
     C*****                MOVE *BLANKS   @SPEC                           S01177
     C                     MOVE *BLANKS   @RONS                           LN0663
     C                     MOVE *BLANKS   @RIBN                           LN0663
     C                     MOVE *BLANKS   @RIBA                           LN0663
     C                     MOVE *BLANKS   @PONS                           LN0663
     C                     MOVE *BLANKS   @PIBN                           LN0663
     C                     MOVE *BLANKS   @PIBA                           LN0663
     C                     MOVE *BLANKS   @RCRN                           LN0663
     C                     MOVE *BLANKS   @RCRA                           LN0663
     C                     MOVE *BLANKS   @RVNO                           LN0663
     C                     MOVE *BLANKS   @AWBN                           LN0663
     C                     MOVE *BLANKS   @AWBA                           LN0663
     C                     MOVE *BLANKS   @BENN                           LN0663
     C                     MOVE *BLANKS   @BENA                           LN0663
     C                     MOVE *BLANKS   @DTP1                           LN0663
     C                     MOVE *BLANKS   @DTP2                           LN0663
     C                     MOVE *BLANKS   @DTP3                           LN0663
     C                     MOVE *BLANKS   @DTP4                           LN0663
     C                     MOVE *BLANKS   @DCHG                           LN0663
     C                     MOVE *BLANKS   @BTB1                           LN0663
     C                     MOVE *BLANKS   @BTB2                           LN0663
     C                     MOVE *BLANKS   @BTB3                           LN0663
     C                     MOVE *BLANKS   @BTB4                           LN0663
     C                     MOVE *BLANKS   @BTB5                           LN0663
     C                     MOVE *BLANKS   @BTB6                           LN0663
     C                     MOVE *BLANKS   @CVMR                           E22405
     C                     MOVE *BLANKS   @ROBR                           LN0822
     C                     MOVE *BLANKS   @POBR                           LN0822
     C                     MOVE 'N'       @AUTO
     C                     MOVE *BLANKS   @CPTY                           S01184
     C                     MOVE *BLANKS   @BROK                           S01184
     C                     MOVE *BLANKS   @TEXT                           S01184
      *                                                                   CEU003
     C                     MOVE *BLANKS   @PSCY                           CEU003
     C                     MOVE *BLANKS   @RSCY                           CEU003
     C                     MOVE *BLANKS   @IC72                           CEU003
      *                                                                   CEU003
     C/COPY WNCPYSRC,MM0028CP39                                           S01408
     C*
     C**  Zeroise numeric settlement work   fields                        S01177
     C                     MOVE *ZEROS    @RSTM                           S01177
     C**********           MOVE *ZEROS    @ROBN                                        S01177 CSD027
     C**********           MOVE *ZEROS    @ROCN                                        S01177 CSD027
     C                     MOVE *BLANKS   @ROBN                                               CSD027
     C                     MOVE *BLANKS   @ROCN                                               CSD027
     C                     MOVE *ZEROS    @PSTM                           S01177
     C**********           MOVE *ZEROS    @POBN                                        S01177 CSD027
     C**********           MOVE *ZEROS    @POCN                                        S01177 CSD027
     C                     MOVE *BLANKS   @POBN                                               CSD027
     C                     MOVE *BLANKS   @POCN                                               CSD027
     C/COPY WNCPYSRC,MM0028C040
     C*
     C           #ZE9      ENDSR                           **#ZE9**
     C*****************************************************************
      /EJECT                                                              E18139
      *****************************************************************   E18139
      *                                                               *   E18139
      * #ZEA     - clear standard deal                                *   E18139
      *                                                               *   E18139
      * CALLS             -                                           *   E18139
      *                                                               *   E18139
      * CALLED BY  #BA    - CF12 processing                           *   E18139
      *            #ZO    - validate deal number and action code      *   E18139
      *            #ZK    - retrieves and displays record             *   E18139
      *            #ZG    - updates file                              *   E18139
      *            #BDAA  - inserts record                            *   E18139
      *                                                               *   E18139
      *                                                               *   E18139
      *****************************************************************   E18139
     C           #ZEA      BEGSR                                          E18139
     C*                                                                   E18139
     C** clear the standard deal                                          E18139
     C**  First fill standard deal format data structure with blanks,     E18139
     C**  then zeroise numeric fields.                                    E18139
     C*                                                                   E18139
     C                     MOVE *BLANKS   @STDDA                          E18139
     C                     Z-ADD0         IGDLUP                          E18139
     C                     Z-ADD0         IGYLUP                          E18139
     C                     Z-ADD0         IGTLUP                          E18139
     C                     Z-ADD0         IGLCD                           E18139
     C                     Z-ADD0         IGDA38                          E18139
     C                     Z-ADD0         IGDS38                          E18139
     C                     Z-ADD0         IGCYDP                          E18139
     C                     Z-ADD0         IGVDYY                          E18139
     C                     Z-ADD0         IGVDMM                          E18139
     C                     Z-ADD0         IGVDDD                          E18139
     C                     Z-ADD0         IGDTYY                          E18139
     C                     Z-ADD0         IGDTMM                          E18139
     C                     Z-ADD0         IGDTDD                          E18139
     C                     Z-ADD0         IGDMDY                          E18139
     C                     Z-ADD0         IGDMDM                          E18139
     C                     Z-ADD0         IGDMDD                          E18139
     C                     Z-ADD0         IGAMNP                          E18139
     C                     Z-ADD0         IGINTR                          E18139
     C                     Z-ADD0         IGORCM                          E18139
     C                     Z-ADD0         IGMOPM                          E18139
     C**********           Z-ADD0         IGCNUM                                       E18139 CSD027
     C                     MOVE *BLANKS   IGCNUM                                              CSD027
     C                     Z-ADD0         IGPCTN                          E18139
     C                     Z-ADD0         IGTIME                          E18139
     C                     Z-ADD0         IGLDAT                          E18139
     C                     Z-ADD0         IGBORM                          E18139
     C                     Z-ADD0         IGBOPM                          E18139
     C                     Z-ADD0         IGBAMT                          E18139
     C**********           Z-ADD0         IGBCNM                                       E18139 CSD027
     C                     MOVE *BLANKS   IGBCNM                                              CSD027
     C                     Z-ADD0         IGBVDT                          E18139
     C                     Z-ADD0         IGBIRT                          E18139
     C                     Z-ADD0         IGRORM                          E18139
     C                     Z-ADD0         IGROPM                          E18139
     C                     Z-ADD0         IGRBAT                          E18139
     C**********           Z-ADD0         IGRCNM                                       E18139 CSD027
     C                     MOVE *BLANKS   IGRCNM                                              CSD027
     C                     Z-ADD0         IGRVDT                          E18139
     C                     Z-ADD0         IGRIRT                          E18139
     C                     Z-ADD0         IGMCHD                          E18139
     C                     Z-ADD0         IGOGDA                          E18139
     C                     Z-ADD0         IGORAT                          E18139
     C                     Z-ADD0         IGOSYY                          E18139
     C                     Z-ADD0         IGOSMM                          E18139
     C                     Z-ADD0         IGOSDD                          E18139
     C                     Z-ADD0         IGOMYY                          E18139
     C                     Z-ADD0         IGOMMM                          E18139
     C                     Z-ADD0         IGOMDD                          E18139
     C                     Z-ADD0         IGONTC                          E18139
     C                     Z-ADD0         IGDVSD                          E18139
     C                     Z-ADD0         IGDDLD                          E18139
     C                     Z-ADD0         IGDLAD                          E18139
     C                     Z-ADD0         IGRSTM                          S01177
     C**********           Z-ADD0         IGROBN                                       S01177 CSD027
     C**********           Z-ADD0         IGROCN                                       S01177 CSD027
     C                     MOVE *BLANKS   IGROBN                                              CSD027
     C                     MOVE *BLANKS   IGROCN                                              CSD027
     C                     Z-ADD0         IGPSTM                          S01177
     C**********           Z-ADD0         IGPOBN                                       S01177 CSD027
     C**********           Z-ADD0         IGPOCN                                       S01177 CSD027
     C                     MOVE *BLANKS   IGPOBN                                              CSD027
     C                     MOVE *BLANKS   IGPOCN                                              CSD027
     C                     MOVE *BLANKS   IGOSBR                          BHF944
     C                     MOVE *BLANKS   IGBRCA                          E49965
     C                     Z-ADD0         IGFSRP                          CAC001
     C*                                                                   E18139
      *                                                                   E18139
     C           #ZEA9     ENDSR                           #ZEA9 TAG      E18139
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZD      - Move file to screen                                *
     C*                                                               *
     C* CALLS    ZA0770 - Convert date YYYYMMDD to DDMMYY format    *
     C*          ZA0920   - Convert Amount to display format          *
      *          #FEED    - Extract feedback information when         *   S01184
      *                     CONFIRMATION MATCHING module present      *   S01184
     C*                                                               *
     C* CALLED BY  #BB    - F8  processing.                           *
     C*            #BC    - F7  processing.                           *
     C*            #ZK    - Retrieves a record and displays it.       *
     C*            #ZM    - F10  processing.                          *
     C*            #BE    - Range authorisation processing            *   S01177
     C*                                                               *
     C* FLDS USED  @DLNO  - stored deal number                        *
     C*            @MTYP  - Stored deal type                          *
     C*            @YEAR  - Format date to YYYYMMDD : year            *
     C*            @MNTH  - Format date to YYYYMMDD : month           *
     C*            @DAY   - dd days for conversion to YYYYMMDD        *
     C*            @DATE  - YYYYMMDD date for separation              *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @INTR  - stored spread rate                        *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C*            @@DTIN - Input date to ZA0770                      *
     C*            @@DTOU - Output date to ZA0770                     *
     C*            @CSNM  - stored customer                           *
     C*            @@AMTW - AMOUNT  input to ZA0920                   *
     C*            @@QECN - DECIMAL NO. (ZA0920)                      *
     C*            @@AMTD - AMOUNT WITH DECIMAL FORMAT output (ZA0920)*
     C*            @N     - Array index for lookup of deal type       *
     C*            @TYP   - Deal type                                 *
     C*            @PRI   - Pay or recieve indicator                  *
     C*            @PRFC  - stored profit centre                      *   S01117
     C*            @ORBR  - stored Originating Branch                 *   S01117
     C******       @ORCM  - stored rec. settlement method             *   S01177
     C******       @MORI  - stored our rec. bank a/c debit            *   S01177
     C******       @MCPI  - stored c'party paying bank                *   S01177
     C******       @MFAO  - stored for a/c of                         *   S01177
     C******       @MORI  - stored our rec. bank a/c debit            *   S01177
     C******       @SPEC  - stored special instructions               *   S01177
     C*            @RSTM  - stored rcpt settlement method             *   S01177
     C*            @RONS  - stored rcpt our nostro                    *   S01177
     C*            @RIBN  - stored rcpt intermed bank no.             *   S01177
     C*            @RIBA  - stored rcpt intermed bank a/c line        *   S01177
     C*            @ROBN  - stored rcpt ordering bank no.             *   S01177
     C*            @ROCN  - stored rcpt ordering customer no.         *   S01177
     C*            @PSTM  - stored pay settlement method              *   S01177
     C*            @PONS  - stored pay our nostro                     *   S01177
     C*            @PIBN  - stored pay intermed bank no.              *   S01177
     C*            @PIBA  - stored pay intermed bank a/c line         *   S01177
     C*            @POBN  - stored pay ordering bank no.              *   S01177
     C*            @POCN  - stored pay ordering customer no.          *   S01177
     C*            @RCRN  - stored receiver correspondant no.         *   S01177
     C*            @RCRA  - stored receiver corr a/c line             *   S01177
     C*            @RVNO  - stored receiver no.                       *   S01177
     C*            @AWBN  - stored a/c with bank no.                  *   S01177
     C*            @AWBA  - stored a/c with bank a/c line             *   S01177
     C*            @BENN  - stored beneficiary no.                    *   S01177
     C*            @BENA  - stored beneficiary a/c line               *   S01177
     C*            @DTP1  - stored details of payment 1               *   S01177
     C*            @DTP2  - stored details of payment 2               *   S01177
     C*            @DTP3  - stored details of payment 3               *   S01177
     C*            @DTP4  - stored details of payment 4               *   S01177
     C*            @DCHG  - stored details of charges                 *   S01177
     C*            @BTB1  - stored bank to bank info 1                *   S01177
     C*            @BTB2  - stored bank to bank info 2                *   S01177
     C*            @BTB3  - stored bank to bank info 3                *   S01177
     C*            @BTB4  - stored bank to bank info 4                *   S01177
     C*            @BTB5  - stored bank to bank info 5                *   S01177
     C*            @BTB6  - stored bank to bank info 6                *   S01177
     C*            @CVMR  - cover MT202 required                      *   E22405
     C*            @ROBR  - stored our receive branch                     LN0822
     C*            @POBR  - stored our pay branch                         LN0822
     C*            @STSA  - status of deal array for display          *
     C*            @DLUP  - day of last update                        *
     C*            @MLUP  - month of last update                      *
     C*            @YLUP  - year of last update                       *
     C*            @TLUP  - time of last update                       *
     C*                                                               *
     C*****************************************************************
     C           #ZD       BEGSR
     C/COPY WNCPYSRC,MM0028C041
     C*
     C**  Moves fields from file into program work fields and screen
     C**  fields.
     C*
     C**  Deal number.
     C                     MOVE HNDA38    @DLNO
     C                     MOVE @DLNO     DDDLNO
     C*
     C**  Deal type.
     C                     MOVE HNMTYP    @MTYP
     C                     MOVE @MTYP     DDMTYP
     C*
     C**  Format the value date.
     C                     Z-ADDHNVDYY    @YEAR
     C                     Z-ADDHNVDMM    @MNTH
     C                     Z-ADDHNVDDD    @DAY
     C           @DATE     IFEQ 0                          B1
     C                     MOVE *BLANKS   DDVDAT           *1
     C                     MOVE *BLANKS   @VDAT            *1
     C                     ELSE                            X1
     C                     Z-ADD@DATE     @@DTIN           *1
     C                     EXSR ZA0770                     *1
     C                     MOVE @@DTOU    DDVDAT           *1
     C                     MOVE @@DTOU    @VDAT            *1
     C                     END                             E1
     C*
     C**  Sequence Number AS400.
     C           HNDS38    IFEQ 0                          B1
     C                     MOVE *BLANKS   DDDS38           *1
     C                     MOVE *BLANKS   @DS38            *1
     C                     ELSE                            X1
     C                     MOVE HNDS38    DDDS38           *1
     C                     MOVE DDDS38    @DS38            *1
     C                     END                             E1
     C*
     C**  Customer number.
     C                     MOVE *BLANKS   @CSNM
     C                     MOVE *BLANKS   DDCSNM
     C********** HNCNUM    IFNE 0                          B1                                 CSD027
     C           HNCNUM    IFNE *BLANKS                    B1                                 CSD027
     C                     MOVELHNCNUM    @CSNM            *1
     C                     MOVE @CSNM     DDCSNM           *1
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028CP40                                           S01408
     C*
     C**  Interest Rate/spread.
     C*
     C**  Interest Rate.
     C**  - Execute ZA0920 to format the rate, using 8 decimal places
     C**    and adjusting the file figure to have only implied decimal
     C**    places.
     C***********HNINTR    IFEQ 0                          B1             E25518
     C***********HNMTYP    ANDNE'SC'                       B1       E23041E25518
     C           HNMTYP    IFNE 'SC'                       B1             E25518
     C                     MOVE *BLANKS   DDINTR           *1
     C                     ELSE                            X1
     C           HNINTR    MULT 10000000  @@AMTW           *1
     C                     Z-ADD7         @@QECN           *1
     C*
     C**  Reverse sign for display if amount -ve.
     C           @@AMTW    IFLT 0                          B*2
     C                     Z-SUB@@AMTW    @@AMTW           **2
     C                     END                             E*2
     C*
     C                     EXSR ZA0920                     *1
      *                                                                   CAC001
      **  If Anal Acctg is installed and Int Rate Chg Flag = 'N',         CAC001
      **  DDINTR = blanks                                                 CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
     C           HNIRCF    ANDEQ'N'                                       CAC001
     C                     MOVE *BLANKS   DDINTR                          CAC001
     C                     ELSE                                           CAC001
     C                     MOVE @@AMTD    DDINTR           *1
     C                     ENDIF                                          CAC001
     C                     END                             E1
     C                     MOVE DDINTR    @INTR
      *                                                                   CAC001
      **  Process Funding Spread/Rate if Anal Acctg is installed          CAC001
      **  - Execute ZA0920 to format the rate, using 8 decimal places     CAC001
      **    and adjusting the file figure to have only implied decimal    CAC001
      **    places.                                                       CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
      *                                                                   CAC001
     C           HNMTYP    IFNE 'SC'                                      CAC001
     C                     MOVE *BLANKS   DDFSRP                          CAC001
     C                     ELSE                                           CAC001
     C           HNFSRP    MULT 10000000  @@AMTW                          CAC001
     C                     Z-ADD7         @@QECN                          CAC001
      *                                                                   CAC001
      **  Reverse sign for display if amount -ve.                         CAC001
      *                                                                   CAC001
     C           @@AMTW    IFLT 0                                         CAC001
     C                     Z-SUB@@AMTW    @@AMTW                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C                     EXSR ZA0920                                    CAC001
      *                                                                   CAC001
      **  If Fund Rate Chg Flag = 'N', DDFSRP = blanks                    CAC001
      *                                                                   CAC001
     C           HNFRCF    IFEQ 'N'                                       CAC001
     C                     MOVE *BLANKS   DDFSRP                          CAC001
     C                     ELSE                                           CAC001
     C                     MOVE @@AMTD    DDFSRP                          CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
     C                     MOVE DDFSRP    @FSRP                           CAC001
     C                     ENDIF                                          CAC001
     C*
     C**  Currency Code.
     C                     MOVE HNCCY     DDCCY
     C                     MOVE DDCCY     @CCY
     C*
     C**  Deal Amount.
     C**  - Execute ZA0920 to format Deal Amount, using Deal Ccy
     C**    decimal places.
     C           HNAMNP    IFEQ 0                          B1
     C           HNMTYP    OREQ 'SI'                       B1             ME2198
     C           HNMTYP    OREQ 'CI'                       B1             ME2198
     C                     MOVE *BLANKS   DDAMNP           *1
     C                     ELSE                            X1
     C                     Z-ADDHNCYDP    @@QECN           *1
     C*
     C**  Reverse sign for display if amount -ve.
     C           HNAMNP    IFGT 0                          B*2
     C                     Z-ADDHNAMNP    @@AMTW           **2
     C                     ELSE                            X*2
     C                     Z-SUBHNAMNP    @@AMTW           **2
     C                     END                             E*2
     C*
     C                     EXSR ZA0920                     *1
     C                     MOVE @@AMTD    DDAMNP           *1
     C                     END                             E1
     C                     MOVE DDAMNP    @AMNP
     C*
     C** Decide whether instructions are pay or recieve by cross
     C** checking deal type against original deal type.(Table MMT0015)
     C*
     C** INITIALISE INDICATORS
     C                     Z-ADD1         @N      20
     C                     MOVE '0'       *IN75
     C*
     C           HNOGDT    LOKUP@TYP,@N                  75
     C*
     C** Initialise to  SET FIELDS TO BLANKS which will be the default
     C** if none of the conditions set out in table MMT0015 are satisfied
     C                     MOVE *BLANK    @PRI    1
     C*
     C** FROM PREVIOUS LOOKUP TYPE WILL BE 'IT','TD' OR 'CI' IF
     C** @N IS BETWEEN 1 & 3.
     C** PAY if deal type is 'SI'
     C           *IN75     IFNE '0'                        B1
     C           @N        ANDLE3                          *1
     C           HNTYPE    ANDEQ'SI'                       *1
     C****   ALSO APPLIES TO TYPE 'CT' @N EQUAL TO 11                     BHF914
     C           @N        OREQ 11                         *1             BHF914
     C           HNTYPE    ANDEQ'SI'                       *1             BHF914
     C                     MOVE 'P'       @PRI             *1
     C                     END                             E1
     C*
     C** FROM PREVIOUS LOOKUP HNOGDT WILL BE 'IP','TL' CP 'CL' 'C1'
     C** 'C2' 'BO' 'BI' IF @N IS BETWEEN 4 & 10.
     C           @N        IFLE 10                         B1
     C           @N        ANDGE4                          *1
     C*
     C** RECIEVE if deal type is 'SI'
     C           HNTYPE    ANDEQ'SI'                       *1
     C**   ALSO APPLIES TO TYPE 'CP'&'DL' @N EQUAL TO 12 OR 13            BHF914
     C           @N        ORGE 12                         *1             BHF914
     C           @N        ANDLE13                         *1             S01354
     C           HNTYPE    ANDEQ'SI'                       *1             BHF914
     C                     MOVE 'R'       @PRI             *1
     C*
     C** For types C1,C2,BO & BI rollover/bought/sold ind must also = B
     C** RESET to blank if it is not
     C           @N        IFGE 7                          B*2
     C           HNORBS    ANDNE'B'                        **2
     C                     MOVE *BLANK    @PRI             **2
     C                     END                             E*2
     C                     END                             E1
     C*  Remaining types decided as below
     C** ************************************************
     C*      ORIG.TYPE         TYPE         PAY/RECIEVE
     C*      |   CT       |     PI      |       R
     C*      |   CP       |     PD      |       R
     C*      |   DL       |     PD      |       R
     C*
     C*      |   CP       |     PI      |       P
     C*      |   CT       |     PD      |       P
     C*      |   DL       |     PI      |       P
     C** ************************************************
     C           HNOGDT    IFEQ 'CT'                       B1
     C           HNTYPE    ANDEQ'PI'                       *1
     C*
     C           HNOGDT    OREQ 'CP'                       *1
     C           HNTYPE    ANDEQ'PD'                       *1
     C*
     C           HNOGDT    OREQ 'DL'                       *1
     C           HNTYPE    ANDEQ'PD'                       *1
     C*
     C           HNOGDT    OREQ 'CP'                       *1             DT0058
     C           HNTYPE    ANDEQ'SI'                       *1             DT0058
     C*                                                                   DT0058
     C                     MOVE 'R'       @PRI             *1
     C                     END                             E1
     C*
     C           HNOGDT    IFEQ 'CT'                       B1
     C           HNTYPE    ANDEQ'PD'                       *1
     C*
     C           HNOGDT    OREQ 'DL'                       *1
     C           HNTYPE    ANDEQ'PI'                       *1
     C*
     C           HNOGDT    OREQ 'CP'                       *1
     C           HNTYPE    ANDEQ'PI'                       *1
     C*
     C           HNOGDT    OREQ 'CT'                       *1             DT0058
     C           HNTYPE    ANDEQ'SI'                       *1             DT0058
     C*                                                                   DT0058
     C                     MOVE 'P'       @PRI             *1
     C                     END                             E1
     C*
     C**  CLEAR SETTLEMENT DETAILS                                        S01177
     C**        RECEIVE                                                   S01177
     C                     MOVE *BLANKS   PMRSTM                          S01177
     C                     MOVE *BLANKS   PMRONS                          S01177
     C                     MOVE *BLANKS   PARIBN                          S01177
     C                     MOVE *BLANKS   PMRIBN                          S01177
     C                     MOVE *BLANKS   PAROBN                          S01177
     C                     MOVE *BLANKS   PMROBN                          S01177
     C                     MOVE *BLANKS   PMRIBA                          S01177
     C                     MOVE *BLANKS   PAROCN                          S01177
     C                     MOVE *BLANKS   PMROCN                          S01177
     C**        PAY                                                       S01177
     C                     MOVE *BLANKS   PMPSTM                          S01177
     C                     MOVE *BLANKS   PMPONS                          S01177
     C                     MOVE *BLANKS   PAPIBN                          S01177
     C                     MOVE *BLANKS   PMPIBN                          S01177
     C                     MOVE *BLANKS   PMPIBA                          S01177
     C                     MOVE *BLANKS   PAPOBN                          S01177
     C                     MOVE *BLANKS   PMPOBN                          S01177
     C                     MOVE *BLANKS   PAPOCN                          S01177
     C                     MOVE *BLANKS   PMPOCN                          S01177
     C                     MOVE *BLANKS   PARCRN                          S01177
     C                     MOVE *BLANKS   PMRCRN                          S01177
     C                     MOVE *BLANKS   PMRCRA                          S01177
     C                     MOVE *BLANKS   PARVNO                          S01177
     C                     MOVE *BLANKS   PMRVNO                          S01177
     C                     MOVE *BLANKS   PAAWBN                          S01177
     C                     MOVE *BLANKS   PMAWBN                          S01177
     C                     MOVE *BLANKS   PMAWBA                          S01177
     C                     MOVE *BLANKS   PABENN                          S01177
     C                     MOVE *BLANKS   PMBENN                          S01177
     C                     MOVE *BLANKS   PMBENA                          S01177
     C                     MOVE *BLANKS   PMDTP1                          S01177
     C                     MOVE *BLANKS   PMDTP2                          S01177
     C                     MOVE *BLANKS   PMDTP3                          S01177
     C                     MOVE *BLANKS   PMDTP4                          S01177
     C                     MOVE *BLANKS   PMBTB1                          S01177
     C                     MOVE *BLANKS   PMBTB2                          S01177
     C                     MOVE *BLANKS   PMBTB3                          S01177
     C                     MOVE *BLANKS   PMBTB4                          S01177
     C                     MOVE *BLANKS   PMBTB5                          S01177
     C                     MOVE *BLANKS   PMBTB6                          S01177
     C                     MOVE *BLANKS   PMCVMR                          E22405
     C                     MOVE *BLANKS   PMROBR                          LN0822
     C                     MOVE *BLANKS   PMPOBR                          LN0822
     C                     MOVE *BLANKS   PMDCHG                          S01177
      *                                                                   CEU003
     C                     MOVE *BLANKS   PMRSCY                          CEU003
     C                     MOVE *BLANKS   PMPSCY                          CEU003
     C                     MOVE *BLANKS   PMIC72                          CEU003
     C                     MOVE *BLANKS   PMIERI                          CEU003
      *                                                                   CEU003
     C*
     C** Settlement method & 'our bank',customers pay/rec instructions
     C** For a/c of only for pay.
     C           @PRI      IFEQ 'R'                        B1
     C**  RECEIVE
     C*****                MOVE HNORCM    DDORCM           *1             S01177
     C*****                MOVE HNMORI    DDMORI           *1             S01177
     C*****                MOVE HNMCPI    DDMCPI           *1             S01177
     C*****                MOVE *BLANKS   DDMFAO           *1             S01177
     C*                                                                   S01177
     C                     MOVE HNRSTM    PMRSTM                          S01177
     C                     MOVE HNRONS    PMRONS                          S01177
     C                     MOVELHNRIBN    PARIBN                          S01177
     C                     MOVELPARIBN    PMRIBN                          S01177
     C                     MOVE HNOSBR    PMROBR                          LN0822
     C                     MOVELHNSTCY    PMRSCY                          CEU003
     C                     MOVELHNSTCY    @RSCY                           CEU003
     C*                                                                   S01177
     C**  Rcpt - Intermediary bank A/C line                               S01177
     C                     MOVE HNRIBA    PMRIBA                          S01177
     C*                                                                   S01177
     C**  Rcpt - Ordering bank no.                                        S01177
     C********** HNROBN    IFNE *ZEROS                                                 S01177 CSD027
     C           HNROBN    IFNE *BLANKS                                                       CSD027
     C                     MOVELHNROBN    PAROBN                          S01177
     C                     END                                            S01177
     C                     MOVELPAROBN    PMROBN                          S01177
     C*                                                                   S01177
     C**  Rcpt - Ordering customer no.                                    S01177
     C********** HNROCN    IFNE *ZEROS                                                 S01177 CSD027
     C           HNROCN    IFNE *BLANKS                                                       CSD027
     C                     MOVELHNROCN    PAROCN                          S01177
     C                     END                                            S01177
     C                     MOVELPAROCN    PMROCN                          S01177
     C                     END                             E1
     C*
     C**  PAY                                                             S01177
     C           @PRI      IFEQ 'P'                        B1
     C*****                MOVE HNMOPM    DDORCM           *1             S01177
     C*****                MOVE HNMOPI    DDMORI           *1             S01177
     C*****                MOVE HNMCRI    DDMCPI           *1             S01177
     C*****                MOVE HNMFAO    DDMFAO           *1             S01177
     C*                                                                   S01177
     C                     MOVE HNPSTM    PMPSTM                          S01177
     C                     MOVE HNPONS    PMPONS                          S01177
     C                     MOVELHNAWBN    PMAWBN                          S01177
     C                     MOVELPMAWBN    PAAWBN                          S01177
     C                     MOVELHNBENN    PMBENN                          S01177
     C                     MOVELPMBENN    PABENN                          S01177
     C                     MOVE HNOSBR    PMPOBR                          LN0822
     C*                                                                   S01177
     C**  Pay  - Intermediary bank no.                                    S01177
     C                     MOVE HNPIBN    PAPIBN                          S01177
     C                     MOVELPAPIBN    PMPIBN                          S01177
     C*                                                                   S01177
     C**  Pay  - Intermediary bank A/C line                               S01177
     C                     MOVE HNPIBA    PMPIBA                          S01177
     C*                                                                   S01177
     C**  Pay  - Ordering bank no.                                        S01177
     C********** HNPOBN    IFNE *ZEROS                                                 S01177 CSD027
     C           HNPOBN    IFNE *BLANKS                                                       CSD027
     C                     MOVELHNPOBN    PAPOBN                          S01177
     C                     END                                            S01177
     C                     MOVELPAPOBN    PMPOBN                          S01177
     C*                                                                   S01177
     C**  Pay  - Ordering customer no.                                    S01177
     C********** HNPOCN    IFNE *ZEROS                                                 S01177 CSD027
     C           HNPOCN    IFNE *BLANKS                                                       CSD027
     C                     MOVELHNPOCN    PAPOCN                          S01177
     C                     END                                            S01177
     C                     MOVELPAPOCN    PMPOCN                          S01177
     C*                                                                   S01177
     C**  Beneficiary A/C line                                            S01177
     C                     MOVE HNBENA    PMBENA                          S01177
     C*                                                                   S01177
     C**  Details of payment 1                                            S01177
     C                     MOVE HNDTP1    PMDTP1                          S01177
     C*                                                                   S01177
     C**  Details of payment 2                                            S01177
     C                     MOVE HNDTP2    PMDTP2                          S01177
     C*                                                                   S01177
     C**  Details of payment 3                                            S01177
     C                     MOVE HNDTP3    PMDTP3                          S01177
     C*                                                                   S01177
     C**  Details of payment 4                                            S01177
     C                     MOVE HNDTP4    PMDTP4                          S01177
     C*
     C**  Special Instructions.
     C                     MOVE HNBTB1    PMBTB1                          S01177
     C*
     C**  Receiver correspondent no.                                      S01177
     C                     MOVE HNRCRN    PARCRN                          S01177
     C                     MOVELPARCRN    PMRCRN                          S01177
     C*                                                                   S01177
     C**  Receiver correspondent A/C line                                 S01177
     C                     MOVE HNRCRA    PMRCRA                          S01177
     C*                                                                   S01177
     C**  Receiver number                                                 S01177
     C                     MOVE HNRVNO    PARVNO                          S01177
     C                     MOVELPARVNO    PMRVNO                          S01177
     C*                                                                   S01177
     C**  A/C with bank A/C line                                          S01177
     C                     MOVE HNAWBA    PMAWBA                          S01177
     C*                                                                   S01177
     C**  Details of charges                                              S01177
     C                     MOVE HNDCHG    PMDCHG                          S01177
     C*                                                                   S01177
     C**  Bank to bank information 2                                      S01177
     C                     MOVE HNBTB2    PMBTB2                          S01177
     C*                                                                   S01177
     C**  Bank to bank information 3                                      S01177
     C                     MOVE HNBTB3    PMBTB3                          S01177
     C*                                                                   S01177
     C**  Bank to bank information 4                                      S01177
     C                     MOVE HNBTB4    PMBTB4                          S01177
     C*                                                                   S01177
     C**  Bank to bank information 5                                      S01177
     C                     MOVE HNBTB5    PMBTB5                          S01177
     C*                                                                   S01177
     C**  Bank to bank information 6                                      S01177
     C                     MOVE HNBTB6    PMBTB6                          S01177
     C*                                                                   E22405
     C**  Cover MT202 required                                            E22405
     C                     MOVE HNCVMR    PMCVMR                          E22405
     C*                                                                   S01177
     C                     MOVELHNSTCY    PMPSCY                          CEU003
     C                     MOVELHNIC72    PMIC72                          CEU003
     C                     MOVELHNSTCY    @PSCY                           CEU003
     C                     MOVELHNIC72    @IC72                           CEU003
     C                     END                             E1
     C*
     C***        @PRI      IFEQ *BLANK                     B1             S01177
     C*****                MOVE *BLANKS   DDORCM           *1             S01177
     C*****                MOVE *BLANKS   DDMORI           *1             S01177
     C*****                MOVE *BLANKS   DDMCPI           *1             S01177
     C*****                MOVE *BLANKS   DDMFAO           *1             S01177
     C***                  END                             E1             S01177
     C*
     C*****                MOVE DDORCM    @ORCM                           S01177
     C*****                MOVE DDMORI    @MORI                           S01177
     C*****                MOVE DDMCPI    @MCPI                           S01177
     C*****                MOVE DDMFAO    @MFAO                           S01177
     C*                                                                   S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP29                                           S01408
     C*                                                                   S01408
     C                     MOVE PMRSTM    @RSTM                           S01177
     C                     MOVE PMPSTM    @PSTM                           S01177
     C                     MOVE PMRONS    @RONS                           S01177
     C                     MOVE PMPONS    @PONS                           S01177
     C                     MOVELPMRIBN    @RIBN                           S01177
     C                     MOVE PMRIBA    @RIBA                           S01177
     C                     MOVELPMAWBN    @AWBN                           S01177
     C                     MOVE PMAWBA    @AWBA                           S01177
     C                     MOVELPMBENN    @BENN                           S01177
     C                     MOVE PMBENA    @BENA                           S01177
     C                     MOVE PAROBN    @ROBN                           S01177
     C                     MOVE PAROCN    @ROCN                           S01177
     C                     MOVE PAPIBN    @PIBN                           S01177
     C                     MOVE PMPIBA    @PIBA                           S01177
     C                     MOVE PAPOBN    @POBN                           S01177
     C                     MOVE PAPOCN    @POCN                           S01177
     C                     MOVE PMDTP1    @DTP1                           S01177
     C                     MOVE PMDTP2    @DTP2                           S01177
     C                     MOVE PMDTP3    @DTP3                           S01177
     C                     MOVE PMDTP4    @DTP4                           S01177
     C                     MOVE PARCRN    @RCRN                           S01177
     C                     MOVE PMRCRA    @RCRA                           S01177
     C                     MOVE PARVNO    @RVNO                           S01177
     C                     MOVE PMDCHG    @DCHG                           S01177
     C                     MOVE PMBTB1    @BTB1                           S01177
     C                     MOVE PMBTB2    @BTB2                           S01177
     C                     MOVE PMBTB3    @BTB3                           S01177
     C                     MOVE PMBTB4    @BTB4                           S01177
     C                     MOVE PMBTB5    @BTB5                           S01177
     C                     MOVE PMBTB6    @BTB6                           S01177
     C                     MOVE PMCVMR    @CVMR                           E22405
     C                     MOVE PMROBR    @ROBR                           LN0822
     C                     MOVE PMPOBR    @POBR                           LN0822
     C*
     C** If the settlement method is '04',our instructions should be
     C** blank.
     C*****      DDORCM    IFEQ '04'                       B1             S01177
     C*****                MOVE *BLANKS   DDMORI           *1             S01177
     C*****                MOVE *BLANKS   @MORI            *1             S01177
     C           PMRSTM    IFEQ 04                         B1             S01177
     C           PMPSTM    OREQ 04                         B1             S01177
     C                     MOVE *BLANKS   PMRONS                          S01177
     C                     MOVE *BLANKS   PMPONS                          S01177
     C                     MOVE *BLANKS   PMIC72                          CEU003
     C                     MOVE *BLANKS   @RONS                           S01177
     C                     MOVE *BLANKS   @PONS                           S01177
     C                     MOVE *BLANKS   @IC72                           CEU003
     C                     END                             E1
     C*
     C**  Special Instructions.
     C*****                MOVE HNSPEC    DDSPEC                          S01177
     C*****                MOVE DDSPEC    @SPEC                           S01177
     C*                                                                   S01177
     C*  branch code                                                      S01177
     C*                                                                   S01177
     C*****                MOVE H@BRCD    PMBRCD                  S01177  S01117
     C                     MOVE H@BRCA    PMBRCA                          S01117
     C*
     C**  Set up text for deal status.
     C                     MOVE *BLANKS   DDSTS
     C***********HNDSTS****IFEQ*'I'************************B1*************S01319
     C*********************MOVE*@STSA,1***DDSTS*************1*************S01319
     C*********************MOVE*'1'********IN38***************************S01319
     C*********************END*****************************E1*************S01319
     C*
     C           HNDSTS    IFEQ 'C'                        B1
     C*********************MOVE*@STSA,2***DDSTS*************1*************S01319
     C                     MOVE @STSA,1   DDSTS            *1             S01319
     C                     MOVE '1'       *IN38
     C                     END                             E1
     C*
     C           HNDSTS    IFEQ 'A'                        B1
     C*********************MOVE*@STSA,3***DDSTS*************1*************S01319
     C                     MOVE @STSA,2   DDSTS            *1             S01319
     C                     MOVE '1'       *IN38
     C                     END                             E1
     C*
     C           HNDSTS    IFEQ 'R'                        B1
     C*********************MOVE*@STSA,4***DDSTS*************1*************S01319
     C                     MOVE @STSA,3   DDSTS            *1             S01319
     C                     MOVE '1'       *IN38
     C                     END                             E1
     C*
     C           HNDSTS    IFEQ 'M'                        B1
     C*********************MOVE*@STSA,5***DDSTS*************1*************S01319
     C                     MOVE @STSA,4   DDSTS            *1             S01319
     C                     MOVE '1'       *IN38
     C                     END                             E1
     C*
     C**  If the deleted indicator is on then the 'DELETED' text is
     C**  displayed.
     C           HNDDLT    IFEQ 'D'                        B1
     C                     MOVE '1'       *IN39            *1
     C                     ELSE                            X1
     C                     MOVE '0'       *IN39            *1
     C                     END                             E1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CLD3                                           S01408
     C*                                                                   S01408
     C*
     C**  Save time and date fields from file.
     C                     Z-ADDHNDLUP    @DLUP   20
     C                     MOVE HNMLUP    @MLUP   3
     C                     Z-ADDHNYLUP    @YLUP   20
     C                     Z-ADDHNTLUP    @TLUP   60
     C** if CONFIRMATION MATCHING present get match status feedback       S01184
     C           BGCFMT    IFEQ 'Y'                                       S01184
     C                     EXSR #FEED                                     S01184
     C                     END                                            S01184
     C*
     C           #ZD9      ENDSR                           **#ZD9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZF      - Move store to screen.                              *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  #ZP    - Authorize processing.                     *
     C*            #ZM    - F10 processing.                           *
     C*            #ZB    - Delete processing.                        *
     C*                                                               *
     C* FLDS USED  @ACTN  - stored action code                        *
     C*            @DLNO  - stored deal number                        *
     C*            @MTYP  - stored deal type                          *
     C*            @CSNM  - stored customer                           *
     C*            @VDAT  - stored value date                         *
     C*            @LSQN  - 38 sequence number                        *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @INTR  - stored interest rate                      *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C******       @ORCM  - stored rec. settlement method             *   S01177
     C******       @MORI  - stored our rec. bank a/c debit            *   S01177
     C******       @MCPI  - stored c'party paying bank                *   S01177
     C******       @MFAo  - stored for a/c of                         *   S01177
     C******       @SPEC  - stored special instructions               *   S01177
     C*            @RSTM  - stored rcpt settlement method             *   S01177
     C*            @RONS  - stored rcpt our nostro                    *   S01177
     C*            @RIBN  - stored rcpt intermed bank no.             *   S01177
     C*            @RIBA  - stored rcpt intermed bank a/c line        *   S01177
     C*            @ROBN  - stored rcpt ordering bank no.             *   S01177
     C*            @ROCN  - stored rcpt ordering customer no.         *   S01177
     C*            @PSTM  - stored pay settlement method              *   S01177
     C*            @PONS  - stored pay our nostro                     *   S01177
     C*            @PIBN  - stored pay intermed bank no.              *   S01177
     C*            @PIBA  - stored pay intermed bank a/c line         *   S01177
     C*            @POBN  - stored pay ordering bank no.              *   S01177
     C*            @POCN  - stored pay ordering customer no.          *   S01177
     C*            @RCRN  - stored receiver correspondant no.         *   S01177
     C*            @RCRA  - stored receiver corr a/c line             *   S01177
     C*            @RVNO  - stored receiver no.                       *   S01177
     C*            @AWBN  - stored a/c with bank no.                  *   S01177
     C*            @AWBA  - stored a/c with bank a/c line             *   S01177
     C*            @BENN  - stored beneficiary no.                    *   S01177
     C*            @BENA  - stored beneficiary a/c line               *   S01177
     C*            @DTP1  - stored details of payment 1               *   S01177
     C*            @DTP2  - stored details of payment 2               *   S01177
     C*            @DTP3  - stored details of payment 3               *   S01177
     C*            @DTP4  - stored details of payment 4               *   S01177
     C*            @DCHG  - stored details of charges                 *   S01177
     C*            @BTB1  - stored bank to bank info 1                *   S01177
     C*            @BTB2  - stored bank to bank info 2                *   S01177
     C*            @BTB3  - stored bank to bank info 3                *   S01177
     C*            @BTB4  - stored bank to bank info 4                *   S01177
     C*            @BTB5  - stored bank to bank info 5                *   S01177
     C*            @BTB6  - stored bank to bank info 6                *   S01177
     C*            @CVMR  - cover MT202 required                      *   E22405
     C*            @LSQN  - stored last sequence number               *
     C*                                                               *
     C*****************************************************************
     C           #ZF       BEGSR
     C*
     C**  Moves fields from program work fields into screen fields.
     C                     MOVE @ACTN     DDACTN
     C                     MOVE @DLNO     DDDLNO
     C                     MOVE @MTYP     DDMTYP
     C                     MOVE @CSNM     DDCSNM
     C                     MOVE @VDAT     DDVDAT
     C                     MOVE @DS38     DDDS38
     C                     MOVE @CCY      DDCCY
     C                     MOVE @AMNP     DDAMNP
     C                     MOVE @LSQN     DDLSQN
     C                     MOVE @INTR     DDINTR
     C                     MOVE @FSRP     DDFSRP                          CAC001
     C                     MOVE @CPTY     DDCPTY                          S01184
     C                     MOVE @BROK     DDBROK                          S01184
     C                     MOVE @TEXT     DDTEXT                          S01184
     C/COPY WNCPYSRC,MM0028CP41                                           S01408
     C*****                MOVE @ORCM     DDORCM                          S01177
     C*****                MOVE @MORI     DDMORI                          S01177
     C*****                MOVE @MCPI     DDMCPI                          S01177
     C*****                MOVE @MFAO     DDMFAO                          S01177
     C*****                MOVE @SPEC     DDSPEC                          S01177
     C*
     C**  Moves fields from program work fields into screen 2 parms       S01177
     C*                                                                   S01177
     C                     MOVE @RSTM     PMRSTM                          S01177
     C                     MOVE @RONS     PMRONS                          S01177
     C                     MOVE @RIBN     PARIBN                          S01177
     C                     MOVE @RIBA     PMRIBA                          S01177
     C                     MOVE @ROBN     PAROBN                          S01177
     C                     MOVE @ROCN     PAROCN                          S01177
     C                     MOVE @PSTM     PMPSTM                          S01177
     C                     MOVE @PONS     PMPONS                          S01177
     C                     MOVE @PIBN     PAPIBN                          S01177
     C                     MOVE @PIBA     PMPIBA                          S01177
     C                     MOVE @POBN     PAPOBN                          S01177
     C                     MOVE @POCN     PAPOCN                          S01177
     C                     MOVE @RCRN     PARCRN                          S01177
     C                     MOVE @RCRA     PMRCRA                          S01177
     C                     MOVE @RVNO     PARVNO                          S01177
     C                     MOVE @AWBN     PAAWBN                          S01177
     C                     MOVE @AWBA     PMAWBA                          S01177
     C                     MOVE @BENN     PABENN                          S01177
     C                     MOVE @BENA     PMBENA                          S01177
     C                     MOVE @DTP1     PMDTP1                          S01177
     C                     MOVE @DTP2     PMDTP2                          S01177
     C                     MOVE @DTP3     PMDTP3                          S01177
     C                     MOVE @DTP4     PMDTP4                          S01177
     C                     MOVE @DCHG     PMDCHG                          S01177
     C                     MOVE @BTB1     PMBTB1                          S01177
     C                     MOVE @BTB2     PMBTB2                          S01177
     C                     MOVE @BTB3     PMBTB3                          S01177
     C                     MOVE @BTB4     PMBTB4                          S01177
     C                     MOVE @BTB5     PMBTB5                          S01177
     C                     MOVE @BTB6     PMBTB6                          S01177
     C                     MOVE @CVMR     PMCVMR                          E22405
     C                     MOVE @ROBR     PMROBR                          LN0822
     C                     MOVE @POBR     PMPOBR                          LN0822
      *                                                                   CEU003
     C                     MOVEL@RSCY     PMRSCY                          CEU003
     C                     MOVEL@PSCY     PMPSCY                          CEU003
     C                     MOVEL@IC72     PMIC72                          CEU003
     C*
     C           #ZF9      ENDSR                           **#ZF9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BD      - Enter processing.                                  *
     C*                                                               *
     C* CALLS    #ZO      - Validate deal number and action code.     *
     C*          #BDA     - Enter processing for action code I.       *
     C*          #ZC      - Enter processing for action code A.       *
     C*          #ZB      - Enter processing for action code D.       *
     C*          #ZK      - Retrieves a record and displays it.       *
     C*          #ZP      - Authorize processing.                     *
     C*                                                               *
     C* CALLED BY  #B     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @ACTN  - stored action code                        *
     C*            @DLNO  - stored deal number                        *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*                                                               *
     C*****************************************************************
     C           #BD       BEGSR
     C*
     C**  Validate deal number,action code,value date & sequence
     C**  number if any have changed.
     C           @DLNO     IFNE DDDLNO                     B1
     C           @DLNO     OREQ *BLANKS                    *1
     C*
     C           @ACTN     ORNE DDACTN                     *1
     C           @ACTN     OREQ *BLANKS                    *1
     C*
     C           @VDAT     ORNE DDVDAT                     *1
     C           @VDAT     OREQ *BLANKS                    *1
     C*
     C           DDDS38    ORNE @DS38                      *1
     C           @DS38     OREQ *BLANKS                    *1
     C*
     C/COPY WNCPYSRC,MM0028C042
     C                     EXSR #ZO                        *1
     C/COPY WNCPYSRC,MM0028C043
     C*
     C**  Enter has now been pressed for this deal number/date/seq. no    S01177
     C                     MOVE DDDLNO    DLENT   6                       S01177
     C                     MOVE DDVDAT    VDENT   6                       S01177
     C                     MOVE DDDS38    DSENT   3                       S01177
     C**  By-pass further ENTER processing if a validation error has
     C**  occurred.
     C/COPY WNCPYSRC,MM0028C084
     C           *IN41     CABEQ'1'       #BD9             *1
     C/COPY WNCPYSRC,MM0028C085
     C                     END                             E1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP3                                           S01408
     C*                                                                   S01408
     C*
     C**  Further processing depends on the action code.
     C**  - If the action code is I, process SR #BDA.
     C           DDACTN    CASEQ'I'       #BDA
     C*
     C**  - If the action code is A, process SR #ZC .
     C           DDACTN    CASEQ'A'       #ZC
     C*
     C**  - If the action code is D, process SR #ZB .
     C           DDACTN    CASEQ'D'       #ZB
     C*
     C**  - If the action code is E, process SR #ZK .
     C           DDACTN    CASEQ'E'       #ZK
     C*
     C**  - If the action code is X, process SR #ZP .
     C           DDACTN    CASEQ'X'       #ZP
     C*
     C                     END
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP8                                           S01408
     C*                                                                   S01408
     C           #BD9      ENDSR                           **#BD9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BDA     - Enter processing for action code I.                *
     C*                                                               *
     C* CALLS    #ZI      - Validates the display for I and A.        *
     C*          #BDAA    - Calls new record update routines.         *
     C*                                                               *
     C* CALLED BY  #BD    - Enter processing                          *
     C*                                                               *
     C* CALLS    #ZI      - Validates the display for I and A.        *
     C*          #BDAA    - Calls new record update routines.         *
     C*          MM0085   - Generate new sequence number for deam     *
     C*                                                               *
     C* CALLED BY  #BD    - Enter processing                          *
     C*                                                               *
     C* FLDS USED  @TERM  -  Termination parameter                    *
     C*            @PDLNO -  Deal number parameter passed to MM0085  *
     C*            @PDAT  -  Value date  parameter passed to MM0085  *
     C*            @PDDD  -  Value date  parameter passed to MM0085  *
     C*            @PDMM  -  Value date  parameter passed to MM0085  *
     C*            @PYEAR -  Value date  parameter passed to MM0085  *
     C*            @DSPD  -  Displayed value date : days              *
     C*            @DSPM  -  Displayed value date : month             *
     C*            @DSPY  -  Displayed value date : year              *
     C*            @PYEAR -  Value date  parameter YYYYMMDD          *
     C*            @PDS38 -  Sequence no.parameter passed to MM0085  *
     C*            @LSQN  - stored last sequence number               *
     C*                                                               *
     C*****************************************************************
     C           #BDA      BEGSR
     C**  Dont allow call to SD2410  before settlement screen called      S01177
     C                     MOVE '1'       *IN77                           S01177
     C*
     C**  Validate the screen input.  If an error has occurred in a
     C**  called program, by-pass further processing.
     C                     EXSR #ZI
     C           @TERM     CABEQ'E'       #BDA9
     C*
     C**  If the input is invalid, cease ENTER processing.
     C/COPY WNCPYSRC,MM0028C086
     C           *IN41     CABEQ'1'       #BDA9
     C*
     C/COPY WNCPYSRC,MM0028C021
     C**  Call screen 2 to set up settlement details (IF @PRI IS P,R)     S01177
     C           @PRI      IFNE ' '                                       S01177
     C                     EXSR #BG                                       S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C*   If CMD/3 taken from settlement screen bypass update processing  S01177
     C           *INKC     CABEQ'1'       #BDA9                           S01177
     C*                                                                   S01177
     C*                                                                   S01177
     C**  Allow  call to SD2410  to validate settlement details           S01177
     C                     MOVE '0'       *IN77                           S01177
     C*                                                                   049518
     C**  Clear screen message queue to prevent duplicate messages.       049518
     C/COPY WNCPYSRC,MM0028C087
     C                     CALL 'ZA0250'                                  049518
     C/COPY WNCPYSRC,MM0028C088
     C*                                                                   S01177
     C                     EXSR #ZI                                       S01177
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP20                                           S01408
      *                                                                   S01408
     C           *IN41     CABEQ'1'       #BDA9                           S01177
     C/COPY WNCPYSRC,MM0028C089
     C**  Load deal number into numeric field passed to MM0085
     C                     MOVE DDDLNO    @PDLNO  60
     C*
     C**  Load valid value date
     C           DDVDAT    IFNE *BLANKS                    B1
     C*
     C** Load value date to numeric keyfield,in YYYYMMDD format
     C                     Z-ADD0         @PDAT            **2
     C                     MOVE @DSPY     @PYEAR           **2
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPD     @PDDD            **2
     C                     ELSE                                           BHF183
     C                     MOVE @DSPD     @PDMM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPM     @PDMM            **2
     C                     ELSE                                           BHF183
     C                     MOVE @DSPM     @PDDD                           BHF183
     C                     END                                            BHF183
     C*
     C** Century
     C           @PYEAR    IFGE 72                         B**3
     C           @PDYY     ADD  1900      @PDYY            ***3
     C                     ELSE                            ***3
     C           @PDYY     ADD  2000      @PDYY            ***3
     C                     END                             E**3
     C                     ELSE                            X1
     C                     Z-ADD0         @PDAT            *1
     C                     END                             E1
     C                     Z-ADD@PDAT     @PMDT   80
     C*
     C           *LIKE     DEFN HNDS38    @PDS38                          CAP002
     C**  Generate new sequence number for insert of deam
     C                     CALL 'MM0085'
     C                     PARM           @TERM
     C                     PARM           @PDLNO
     C                     PARM           @PMDT
     C*********************PARM           @PDS38  30                      CAP002
     C                     PARM           @PDS38                          CAP002
     C*
     C           @TERM     CABEQ'E'       #BDA9
     C*
     C**  Store last sequence number
     C                     MOVE @PDS38    DDLSQN
     C                     MOVE DDLSQN    @LSQN   3
     C*
     C**  Write a new record.
     C                     EXSR #BDAA
     C/COPY WNCPYSRC,MM0028C090
     C*
     C**  If the Action code is E, then the record has been inserted by
     C**  another workstation.  Therefore the intelligent insert is not
     C**  set up.
     C           DDACTN    CABEQ'E'       #BDA9
     C*
     C*
     C**  Set up I in the action code field.
     C                     MOVE 'I'       DDACTN
     C*
     C**  Position cursor on key field
     C                     MOVE '1'       *IN43
     C*
     C           #BDA9     ENDSR                           **#BDA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZC      - Enter processing for action code A.                *
     C*                                                               *
     C* CALLS    #ZK      - Retrieves a record and displays it.       *
     C*          #ZI      - Validates the display for I and A.        *
     C*          #ZG      - Calls update routines.                    *
     C*                                                               *
     C* CALLED BY  #BD    - Enter processing.                         *
     C*            #ZJ    - Set up Standard deal                      *
     C*                                                               *
     C* FLDS USED  @DLNO  - stored deal number                        *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @TERM  -  Termination parameter                    *
     C*                                                               *
     C*****************************************************************
     C           #ZC       BEGSR
     C*
     C**  If key work field not the same as screen field, then the
     C**  record is not being displayed.
     C           DDDLNO    IFNE @DLNO                      B1
     C           DDDLNO    OREQ *BLANKS                    X1
     C*
     C           DDVDAT    ORNE @VDAT                      B1
     C           DDVDAT    OREQ *BLANKS                    *1
     C*
     C           DDDS38    ORNE @DS38                      B1
     C           DDDS38    OREQ *BLANKS                    *1
     C*
     C**  Chain to file and display on screen.
     C                     EXSR #ZK                        *1
     C*
     C**  By-pass further ENTER processing.
     C                     GOTO #ZC9                       *1
     C*
     C                     END                             E1
     C**  Dont allow call to SD2410  before settlement screen called      S01177
     C                     MOVE '1'       *IN77                           S01177
     C*
     C**  The record was displayed last cycle; validate the screen
     C**  input.  If an error has occurred in a called program, by-pass
     C**  further processing.
     C*
     C**  Check that non-amendable fields have not changed since last
     C**  displayed
     C                     EXSR #ZOB
     C*
     C**  If the input is invalid, cease ENTER processing.
     C           *IN41     CABEQ'1'       #ZC9
     C*
     C**  Main validation
     C                     EXSR #ZI
     C           @TERM     CABEQ'E'       #ZC9
     C*
     C**  If the input is invalid, cease ENTER processing.
     C           *IN41     CABEQ'1'       #ZC9
     C**  Call screen 2 to set up settlement details                      S01177
     C           @PRI      IFNE ' '                                       S01177
     C                     EXSR #BG                                       S01177
     C/COPY WNCPYSRC,MM0028C130
     C                     END                                            S01177
     C/COPY WNCPYSRC,MM0028C131
     C*                                                                   S01177
     C*   If CMD/3 taken from settlement screen bypass update processing  S01177
     C           *INKC     CABEQ'1'       #ZC9                            S01177
     C*                                                                   S01177
     C*   F12 PRESSED ON SETTLEMENTS SCREEN                               S01177
     C*                                                                   S01177
     C**  Allow  call to SD2410  to validate settlement details           S01177
     C                     MOVE '0'       *IN77                           S01177
     C*                                                                   049518
     C**  Clear screen message queue to prevent duplicate messages.       049518
     C                     CALL 'ZA0250'                                  049518
     C*                                                                   S01177
     C                     EXSR #ZI                                       S01177
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP21                                           S01408
      *                                                                   S01408
     C           *IN41     CABEQ'1'       #ZC9                            S01177
     C/COPY WNCPYSRC,MM0028C091
     C*
     C**  The input is valid, update file.
     C                     EXSR #ZG
     C*
     C           #ZC9      ENDSR                           **#ZC9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZK      - Retrieves a record and displays it.                *
     C*                                                               *
     C* CALLS    #ZD      - Move file to screen.                      *
     C*                                                               *
     C* CALLED BY  #BD    - Enter processing.                         *
     C*            #ZC    - Enter processing for action code A.       *
     C*                                                               *
     C* FLDS USED  @DLKEY - deal file key                             *
     C*            @VYEAR - Year numeric field                        *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @DSPM  - Month frm screen field : value date       *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @VDYY  - Value date : year                         *
     C*            @VDMM  - Value date : month                        *
     C*            @VDDD  - Value date : day                          *
     C*            @KVALD - Key field  : value date                   *
     C*            @KSEQN - Sequence number key field                 *
     C*            @DMKEY - Deam key                                  *
     C*                                                               *
     C*****************************************************************
     C           #ZK       BEGSR
     C*
     C**  Chain to the file using the key.
     C**  - *IN72 set on if the record is not found.
     C                     MOVE DDDLNO    @DLKEY
     C*
     C** Load value date to numeric keyfield,in YYYYMMDD format
     C                     Z-ADD0         @KVALD
     C                     MOVE @DSPY     @VYEAR
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPD     @VDDD
     C                     ELSE                                           BHF183
     C                     MOVE @DSPD     @VDMM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPM     @VDMM
     C                     ELSE                                           BHF183
     C                     MOVE @DSPM     @VDDD                           BHF183
     C                     END                                            BHF183
     C*
     C** Century
     C           @VYEAR    IFGE 72                         B1
     C           @VDYY     ADD  1900      @VDYY            *1
     C                     ELSE                            X1
     C           @VDYY     ADD  2000      @VDYY            *1
     C                     END                             E1
     C                     MOVE DDDS38    @KSEQN  30
     C*
     C/COPY WNCPYSRC,MM0028C022
     C           @DMKEY    CHAINMMDEAMLL             72
     C/COPY WNCPYSRC,MM0028C023
     C*
     C**  A valid record has been read, move fields into pgm fields.
     C                     EXSR #ZD
     C/COPY WNCPYSRC,MM0028C012
     C*
     C           #ZK9      ENDSR                           **#ZK9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZI      - Validates the screen input for I,A and X.          *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          ZA0840   - Validate/reformat input amount            *
     C*          #ZQ      - Check deal amendment principle            *
     C******     #ZIA     - validates the settlement instructions     *   S01177
     C*                                                               *
     C* CALLED BY  #BDA   - Enter processing for action code I.       *
     C*            #ZC    - Enter processing for action code A.       *
     C*            #BE    - Range authorisation processing            *   S01177
     C*            #ZP    - Authorisation processing                  *   S01177
     C*                                                               *
     C* FLDS USED  @MSGID - message id                                *
     C*            @DLNO  - stored deal number                        *
     C*            @STS   - next status of deal                       *
     C*            @DSTS  - present status of deal                    *
     C*            @SMT   - settlement method                         *
     C*            @THEIR - their instructions                        *
     C*************@OUR***-*our*instructions***************************   S01319
     C*            @FORAC - for account of                            *
     C*            @VALD  - value date                                *
     C*            @@ALPH - 16A field containing field to validate    *
     C*            @@IDP  - number of decimal places                  *
     C*            @@IINT - number of integers                        *
     C*            @@ALPH - 16A field for display                     *
     C*            @@AMT  - 15N field for calculation                 *
     C*            @@ERCD - 1N error code                             *
     C*************@CNUM**-*customer*number****************************   S01319
     C*************@CLTKY*-*Key*to*CLINT*******************************   S01319
     C*            @SLDYN - Start/last interest date day no.          *
     C*            @IADYN - Interest accrual day no.                  *
     C*            @VDYNO - value date                                *
     C*            @N     - Array index for lookup of deal type       *
     C*            @TYP   - Deal type                                 *
     C*            @PRI   - Pay or recieve indicator                  *
     C*            @KEY   - key for table files                       *
     C*            @KEY1  -     "      "                              *
     C*            @KEY2  -     "      "                              *
     C*            @KEY3  -     "      "                              *
     C*            @TDLA  - This  deam amount                         *
     C*            @AMNP  - Numeric amount                            *
     C*            @EDAT  - Event date                                *
     C*            @EFLG  - Event flag                                *
     C*            @PRIND - pay receive indicator                     *
     C*            @FORAC - for account of                            *
     C*            @CUST# - Deam customer no.                         *
     C*            @CUSTN - customer number                           *
     C*            @XCUST - customer number from display              *
     C*                                                               *
     C*****************************************************************
     C           #ZI       BEGSR
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP2                                           S01408
     C*                                                                   S01408
     C*
     C** Deam will have been accessed in initial validation #ZO
     C** if this is not an insert.
     C*
     C*  *------------------------*
     C*  * Determine Deal Status  *
     C*  *------------------------*
     C*
     C**  Determine the status the deal is to achieve.
     C           DDACTN    IFEQ 'I'                        B1
     C***********H1BOAR****ANDEQ'Y'************************B1*************S01319
     C           BNMMAU    ANDEQ'Y'                        B1             S01319
     C                     MOVE 'C'       @STS    1        *1
     C                     END                             E1
     C*
     C           DDACTN    IFEQ 'A'                        B1
     C           HNDSTS    ANDEQ'C'                        B1
     C                     MOVE 'C'       @STS             *1
     C                     END                             E1
     C*
     C           DDACTN    IFEQ 'I'                        B1
     C***********H1BOAR****ANDEQ'N'************************B1*************S01319
     C           BNMMAU    ANDEQ'N'                        B1             S01319
     C                     MOVE 'A'       @STS             *1
     C                     END                             E1
     C*
     C           DDACTN    IFEQ 'A'                        B1
     C           HNDSTS    ANDEQ'A'                        B1
     C***********H1RADL****ANDEQ'N'************************B1*************S01319
     C           BNMMRA    ANDEQ'N'                        B1             S01319
     C                     MOVE 'A'       @STS             *1
     C                     END                             E1
     C*
     C           DDACTN    IFEQ 'X'                        B1
     C                     MOVE 'A'       @STS             *1
     C                     END                             E1
     C*
     C           DDACTN    IFEQ 'A'                        B1
     C***********H1RADL****ANDEQ'Y'************************B1*************S01319
     C           BNMMRA    ANDEQ'Y'                        B1             S01319
     C           HNDSTS    IFEQ 'R'                        B*2
     C           HNDSTS    OREQ 'A'                        B*2
     C                     MOVE 'R'       @STS             **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C           DDACTN    IFEQ 'D'                        B1
     C                     MOVE HNDSTS    @STS             *1
     C                     END                             E1
     C*                                                                   S01354
     C** Internal Deals are Always AUTHORISED                             S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                                      S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C                     MOVE 'A'       @STS                            S01354
     C                     END                                            S01354
     C*                                                                   S01354
     C                     MOVE @STS      HNDSTS
     C                     MOVE HNDSTS    @DSTS   1
     C/COPY WNCPYSRC,MM0028C013
     C*
     C*  *----------------------*
     C*  * Validate Customer    *
     C*  *----------------------*
     C*
     C**  Customer may only be blank for complete deals on which it
     C**  is not mandatory
     C           @STS      IFEQ 'C'                        B1
     C           ICCNMM    ANDNE'N'                        B1
     C           DDCSNM    ANDEQ*BLANKS                    B1
     C           @STS      ORNE 'C'                        B1
     C           DDCSNM    ANDEQ*BLANKS                    B1
     C                     MOVE '1'       *IN10            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0204' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C**  For authorization customer must not be blank
     C           DDACTN    IFEQ 'X'                        B1
     C           DDCSNM    ANDEQ*BLANKS                    B1
     C                     MOVE '1'       *IN10            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0506' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C**  If the input is not blank, validate it.
     C           DDCSNM    IFNE *BLANKS                    B1
     C*****
     C*****heck if the input is numeric.                          *****   S01194
     C*****                MOVE *BLANKS   @@ALPH           *1     *****   S01194
     C*****                Z-ADD0         @@IDP            *1     *****   S01194
     C*****                Z-ADD6         @@IINT           *1     *****   S01194
     C*****                MOVE DDCSNM    @@ALPH           *1     *****   S01194
     C*****                EXSR ZA0840                     *1     *****   S01194
     C*****                                                       *****   S01194
     C*****f ZA0840 returns no errors, the result will be treated *****   S01194
     C*****s a customer number, else it will be a shortname.      *****   S01194
     C*****      @@ERCD    IFEQ 0                          B*2    *****   S01194
     C*****                Z-ADD@@AMT     @CNUM            **2    *****   S01194
     C*****      @CLTKY    CHAINCLINT                65    **2    *****   S01194
     C*****      *IN65     IFEQ '1'                        B**3   *****   S01194
     C*****      RECI      ORNE 'D'                        B**3   *****   S01194
032  C* CALL ACCESS PROG. FOR CUSTOMER DETAILS.                           S01194
     C                     CALL 'AOCUSTR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM DDCSNM    @CLKEY 10                       S01194
     C                     PARM *BLANKS   @KYST   7                       E70
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                     B**3           S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *IN10            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0205' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     ELSE                                           E70
     C           DDCSNM    IFEQ '?'                                       E70
     C                     MOVELBBCUST    DDCSNM                          E70
     C/COPY WNCPYSRC,MM0028C065
     C                     END                                            E70
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP61                                           S01408
      *                                                                   S01408
     C                     END                             E**3
     C*****                ELSE                            X*2    *****   S01194
     C*****      DDCSNM    CHAINSNAME                65    **2    *****   S01194
     C*****      *IN65     IFEQ '1'                        B**3   *****   S01194
     C*****      RECI      ORNE 'D'                        B**3   *****   S01194
     C*****                MOVE '1'       *IN10            ***3   *****   S01194
     C*****                MOVE '1'       *IN41            ***3   *****   S01194
     C*****                MOVEL'MMM0205' @MSGID           ***3   *****   S01194
     C*****                CALL 'ZA0240'                   ***3   *****   S01194
     C*****                PARM           @MSGID           ***3   *****   S01194
     C*****                END                             E**3   *****   S01194
     C*****                END                             E*2    *****   S01194
     C*                                                           *****   S01194
     C**  If a record was found, check that the customer is not a
     C**  parent.
     C           *IN10     IFEQ '0'                        B*2
     C*****                TESTB'2'       CMIN           65**2    *****   S01194
     C*****      *IN65     IFEQ '1'                        B**3   *****   S01194
     C           BBPAIN    IFEQ 'P'                        B**3           S01194
     C                     MOVE '1'       *IN10            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0206' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     END                             E**3
     C                     END                             E*2
     C*
     C**  If the customer is valid, store it on the Standard Deal format.
     C*******    *IN10     IFEQ '0'                        B*2            E12141
     C*******              Z-ADDCNUM      IGCNUM           **2            E12141
     C*******              MOVE CSNM      IGCSNM           **2            E12141
     C*******              ELSE                            X*2            E12141
     C*******              Z-ADD0         IGCNUM           **2            E12141
     C*******              MOVE *BLANKS   IGCSNM           **2            E12141
     C           *IN10     IFEQ '1'                        B*2            E12141
     C**********           Z-ADD0         IGCNUM           **2                         E12141 CSD027
     C                     MOVE *BLANKS   IGCNUM           **2                                CSD027
     C                     MOVE *BLANKS   IGCSNM           **2            E12141
     C                     ELSE                            X*2            E12141
     C*****                Z-ADDCNUM      IGCNUM           **2    E12141  S01194
     C                     MOVE BBCUST    IGCNUM           **2            S01194
     C*****                MOVE CSNM      IGCSNM           **2    E12141  S01194
     C                     MOVE BBCSSN    IGCSNM           **2            S01194
     C*
     C** Compare deam customer number with customer number from related
     C** deal
     C           IGCNUM    IFNE H@CNUM                     B**3
     C                     MOVE '1'       *IN10            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0474' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C*  *------------------------------*                                 050588
     C*  * Validate Value Date (warning)*                                 050588
     C*  *------------------------------*                                 050588
     C*                                                                   050588
     C** Send warning message if notice days are not 0 or -999            050588
     C** & value date is greater than the run date + associated deal      050588
     C** notice days                                                      050588
     C** Only loan/deposit/cd issued can have notice days                 050588
     C*                                                                   050588
     C           H@RCID    IFEQ 'HK'                       B1             050588
     C***********BJRDNB    ADD  HKNTCE    @CMDT   50       *1      050588 092455
     C*                                                                   092455
     C* Calculate no. of notice days forward in both deal and local ccy   092455
     C                     Z-ADDBJRDNB    ZDAYNO           *1             092455
     C***********          MOVE H@CCY     ZCCY1            *1      092455 CEU003
     C                     MOVELWEFCY     ZCCY1                           CEU003
     C                     MOVE @RLOC     ZLOC1            *1             092455
     C                     MOVE BJLCCY    ZCCY2            *1             092455
     C                     MOVE BJSLCD    ZLOC2            *1             092455
     C                     Z-ADDHKNTCE    ZNRDYS           *1             092455
     C                     EXSR ZF2C                       *1             092455
     C                     Z-ADDZDYNBR    @CMDT   50       *1             092455
     C*                                                    *1             092455
     C           HKNTCE    IFNE *ZEROS                     B*2            050588
     C           HKNTCE    ANDNE-999                       **2            050588
     C           @VDYNO    ANDGT@CMDT                      **2            050588
     C                     MOVE '1'       *IN11            **2            050588
     C                     MOVE '1'       *IN55            **2            050588
     C                     MOVEL'MMM0155' @MSGID           **2            050588
     C/COPY WNCPYSRC,MM0028C092
     C                     CALL 'ZA0240'                   **2            050588
     C                     PARM           @MSGID           **2            050588
     C/COPY WNCPYSRC,MM0028C093
     C                     END                             E*2            050588
     C                     END                             E1             050588
     C*                                                                   050588
     C*  *------------------------------*
     C*  * Validate Deal Amendment Type *                     (MMP0084)
     C*  *------------------------------*
     C*
     C**  Amendment type must not be blank
     C           DDMTYP    IFEQ *BLANKS                    B1
     C                     MOVEL'MMM0297' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     MOVE '1'       *IN03            *1
     C                     MOVE '1'       *IN41            *1
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028C066
     C*
     C**  Type must have a value of SC,PI,PD,CI or SI
     C           DDMTYP    IFNE 'SC'                       B1
     C           DDMTYP    ANDNE'PI'                       B1
     C           DDMTYP    ANDNE'PD'                       B1
     C           DDMTYP    ANDNE'CI'                       B1
     C           DDMTYP    ANDNE'SI'                       B1
     C                     MOVE '1'       *IN03            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0298' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C*  For types CI or SI
     C** Value date must not be greater than both interest accrual
     C** control date & start/last interest date.
     C           DDMTYP    IFEQ 'CI'                       B1
     C           DDMTYP    OREQ 'SI'                       B1
     C*
     C           @VDYNO    IFLE @SLDYN                     B*2
     C***********@VDYNO    ANDLE@IADYN                     B*2            E22271
     C           @VDYNO    ORLE @IADYN                     B*2            E22271
     C*
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN03            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0299' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C** For type SI                                                      E12145
     C** Retrieve NAS details for the associated deal, if they            E12145
     C** exist, and check the Deam value date is not after the            E12145
     C** date of the NA sale.                                             E12145
     C           DDMTYP    IFEQ 'SI'                       B1             E12145
     C** clear NAB associated deal no in case previous deal was NAB       S01177
     C                     MOVE *BLANKS   HLDADN           *1             S01177
     C*                                                                   E12145
     C** Retrieve NAB details for the associated deal.                    E12145
     C                     MOVE DDDLNO    @DLKEY           *1             E12145
     C           @DLKEY    CHAINMMDEALLL             65    *1             E12145
     C*                                                                   E12145
     C           *IN65     IFEQ '1'                        B*2            E12145
     C                     MOVE '1'       *INLR            **2            E12145
     C                     MOVE '1'       *INU7            **2            E12145
     C                     MOVE '1'       *INU8            **2            E12145
     C                     MOVE '1'       *INKC            ***************E12145
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 005 *E12145
     C                     MOVELDDDLNO    DBKEY            ***************E12145
     C                     MOVE '005'     DBASE            **2            E12145
     C                     EXSR #C                         **2            E12145
     C*                                                                   E12145
     C                     ELSE                            X*2            E12145
     C*                                                                   E12145
     C** If there is a NAS deal number in the deal associated             E12145
     C** deal number field, retrieve NAS details.                         E12145
     C           HLDADN    IFNE *BLANK                     B**3           E12145
     C                     MOVE HLDADN    @DLKEY           ***3           E12145
     C           @DLKEY    CHAINMMDEALLL             65    ***3           E12145
     C*                                                                   E12145
     C           *IN65     IFEQ '1'                        B***4          E12145
     C                     MOVE '1'       *INLR            ****4          E12145
     C                     MOVE '1'       *INU7            ****4          E12145
     C                     MOVE '1'       *INU8            ****4          E12145
     C                     MOVE '1'       *INKC            ***************E12145
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 006 *E12145
     C                     MOVELHLDADN    DBKEY            ***************E12145
     C                     MOVE '006'     DBASE            ****4          E12145
     C                     EXSR #C                         ****4          E12145
     C*                                                                   E12145
     C                     ELSE                            X***4          E12145
     C*                                                                   E12145
     C** Convert NA sale date to MIDAS day number.                        E12145
     C***********          Z-ADDH@VDAT    @@DTIN           ****4    E12145056095
     C***********          EXSR ZA0680                     ****4    E12145056095
     C                     Z-ADDH@VDAT    ZZDTIN           ****4          056095
     C                     EXSR ZDAT10                     ****4          056095
     C*                                                                   E12145
     C** Check that the Deam value date is not after the NA sale date.    E12145
     C***********@VDYNO    IFGT @@MDNO                     B****5   E12145056095
     C           @VDYNO    IFGT ZZMDNO                     B****5         056095
     C                     MOVE '1'       *IN02            *****5         E12145
     C                     MOVE '1'       *IN41            *****5         E12145
     C                     MOVEL'MMM0580' @MSGID           *****5         E12145
     C                     CALL 'ZA0240'                   *****5         E12145
     C                     PARM           @MSGID           *****5         E12145
     C                     END                             E****5         E12145
     C*                                                                   E12145
     C** Return NAB details to common fields.                             E12145
     C                     MOVE DDDLNO    @DLKEY           ****4          E12145
     C           @DLKEY    CHAINMMDEALLL             65    ****4          E12145
     C*                                                                   E12145
     C                     END                             E***4          E12145
     C                     END                             E**3           E12145
     C                     END                             E*2            E12145
     C                     END                             E1             E12145
     C*                                                                   E12145
     C*  For types PI,PD or SC
     C** If Value date of DEAL is = to both interest accrual
     C** control date & start/last interest date.
     C***Value*date*must*not*be*greater*than*both*interest*accrual        E22271
     C** Value date must not be greater than both interest accrual        E22271
     C** control date & start/last interest date.
     C           DDMTYP    IFEQ 'PI'                       B1
     C           DDMTYP    OREQ 'PD'                       B1
     C           DDMTYP    OREQ 'SC'                       B1
     C*
     C           H@VDAT    IFEQ H@SLDT                     B*2
     C           H@VDAT    ANDEQH@IADT                     **2
     C*
     C           @VDYNO    IFLT @SLDYN                     B**3
     C           @VDYNO    ANDLT@IADYN                     ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN03            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0300' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     END                             E**3
     C*
     C                     ELSE                            X*2
     C*
     C** If Value date of DEAL is NOT = to both interest accrual
     C** control date & start/last interest date.
     C***Value*date*must*not*be*greater*than*both*interest*accrual        E22271
     C** Value date must not be greater than both interest accrual        E22271
     C** control date & start/last interest date.
     C*
     C***********@VDYNO    IFLE @SLDYN                     B**3           E22271
     C***********@VDYNO    ANDLE@IADYN                     B**3           E22271
     C           @VDYNO    IFLT @SLDYN                     B**3           E22271
     C           @VDYNO    ORLT @IADYN                     B**3           E22271
     C*
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN03            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0300' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C** For type SI interest capitilisation indicator must not be 'Y'
     C** Not present for N/A's bought or sold
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP69                                           S01408
     C*                                                                   S01408
     C           DDMTYP    IFEQ 'SI'                       B1
     C           H@RCID    ANDEQ'HK'                       *1
     C           HKCPTI    ANDEQ'Y'                        *1
     C                     MOVE '1'       *IN03            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0301' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*                                                                   109499
     C** For type CI interest capitilisation indicator must be 'Y'        109499
     C           DDMTYP    IFEQ 'CI'                       B1             109499
     C           H@RCID    ANDEQ'HK'                       *1             109499
     C           HKCPTI    ANDNE'Y'                        *1             109499
     C                     MOVE '1'       *IN03            *1             109499
     C                     MOVE '1'       *IN41            *1             109499
     C                     MOVEL'MMM0321' @MSGID           *1             109499
     C                     CALL 'ZA0240'                   *1             109499
     C                     PARM           @MSGID           *1             109499
     C                     END                             E1             109499
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP70                                           S01408
     C*                                                                   S01408
     C*
     C*For*deam*type*PI,PD,SC*or*CI*related*deal*type*must*be*CD,CL*or*DL.S01354
     C** For deam type PI,PD,SC,CI deal types must be CD,CL,DL,IL or ID.  S01354
     C           DDMTYP    IFEQ 'PI'                       B1
     C           DDMTYP    OREQ 'PD'                       *1
     C           DDMTYP    OREQ 'SC'                       *1
     C           DDMTYP    OREQ 'CI'                       *1
     C           H@MTYP    IFNE 'CD'                       B*2
     C           H@MTYP    ANDNE'CL'                       **2
     C           H@MTYP    ANDNE'DL'                       **2
     C           H@MTYP    ANDNE'IL'                       **2            S01354
     C           H@MTYP    ANDNE'ID'                       **2            S01354
     C                     MOVE '1'       *IN03            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0302' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C** For deam type CI or SI next interest date must not be zero
     C**  if interest frequency is not blank
     C           DDMTYP    IFEQ 'SI'                       B1
     C           H@IPFQ    ANDNE*BLANK                     *1
     C           H@NIDT    ANDNE*ZEROS                     *1
     C           DDMTYP    OREQ 'CI'                       *1
     C           H@IPFQ    ANDNE*BLANK                     *1
     C           H@NIDT    ANDNE*ZEROS                     *1
     C                     MOVE '1'       *IN03            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0303' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C** For deam type SI related deal must be IT,IP,TD,TI,CI,LN,
     C** C1,C2,BP,BD.
     C** or CL or CD.                                                     E20204
     C** or IL or ID.                                                     S01354
     C           DDMTYP    IFEQ 'SI'                       B1
     C           H@MTYP    IFNE 'IT'                       B*2
     C           H@MTYP    ANDNE'IP'                       **2
     C           H@MTYP    ANDNE'TD'                       **2
     C           H@MTYP    ANDNE'TI'                       **2
     C           H@MTYP    ANDNE'CI'                       **2
     C           H@MTYP    ANDNE'LN'                       **2
     C           H@MTYP    ANDNE'C1'                       **2
     C           H@MTYP    ANDNE'C2'                       **2
     C           H@MTYP    ANDNE'BP'                       **2
     C           H@MTYP    ANDNE'BD'                       **2
     C           H@MTYP    ANDNE'CL'                       **2            E20204
     C           H@MTYP    ANDNE'CD'                       **2            E20204
     C           H@MTYP    ANDNE'DL'                       **2            BHF906
     C           H@MTYP    ANDNE'IL'                       **2            S01354
     C           H@MTYP    ANDNE'ID'                       **2            S01354
     C                     MOVE '1'       *IN03            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0304' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C** if the deal type is valid, store it on Standard Deal
     C           *IN03     IFEQ '0'                        B1
     C                     MOVE DDMTYP    IGMTYP           *1
     C/COPY WNCPYSRC,MM0028CP42                                           S01408
     C                     END                             E1
     c*
     C*-----------------------------------------*
     C* Find if instructions are pay or recieve *
     C*-----------------------------------------*
     C*
     C** Decide whether instructions are pay or recieve by cross
     C** checking deal type against original deal type.(Table MMT0015)
     C*
     C** INITIALISE INDICATORS
     C                     Z-ADD1         @N      20
     C                     MOVE '0'       *IN75
     C*
     C           H@TYPE    LOKUP@TYP,@N                  75
     C*
     C** Initialise to  SET FIELDS TO BLANKS which will be the default
     C** if none of the conditions set out in table MMT0015 are satisfied
     C                     MOVE *BLANK    @PRI
     C*
     C** FROM PREVIOUS LOOKUP TYPE WILL BE 'IT','TD' OR 'CI' IF
     C** @N IS BETWEEN 1 & 3.
     C** PAY if deal type is 'SI'
     C           *IN75     IFNE '0'                        B1
     C           @N        ANDLE3                          *1
     C           DDMTYP    ANDEQ'SI'                       *1
     C****   ALSO APPLIES TO TYPE 'CT' @N EQUAL TO 11                     BHF914
     C           @N        OREQ 11                         *1             BHF914
     C           DDMTYP    ANDEQ'SI'                       *1             BHF914
     C                     MOVE 'P'       @PRI             *1
     C                     END                             E1
     C*
     C** FROM PREVIOUS LOOKUP HNOGDT WILL BE 'IP','TL' CP 'CL' 'C1'
     C** 'C2' 'BO' 'BI' IF @N IS BETWEEN 4 & 10.
     C           @N        IFLE 10                         B1
     C           @N        ANDGE4                          *1
     C*
     C** RECIEVE if deal type is 'SI'
     C           DDMTYP    ANDEQ'SI'                       *1
     C**   ALSO APPLIES TO TYPE 'CP'&'DL' @N EQUAL TO 12 OR 13            BHF914
     C           @N        ORGE 12                         *1             BHF914
     C           @N        ANDLE13                         *1             S01354
     C           DDMTYP    ANDEQ'SI'                       *1             BHF914
     C                     MOVE 'R'       @PRI             *1
     C*
     C** For types C1,C2,BO & BI rollover/bought/sold ind must also = B
     C** RESET to blank if it is not
     C           @N        IFGE 7                          B*2
     C           H@RBSI    ANDNE'B'                        **2
     C                     MOVE *BLANK    @PRI             **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C*  Remaining types decided as below
     C** ************************************************
     C*      ORIG.TYPE         TYPE         PAY/RECIEVE
     C*      |   CT       |     PI      |       R
     C*      |   CP       |     PD      |       R
     C*      |   DL       |     PD      |       R
     C*
     C*      |   CP       |     PI      |       P
     C*      |   CT       |     PD      |       P
     C*      |   DL       |     PI      |       P
     C** ************************************************
     C           H@TYPE    IFEQ 'CT'                       B1
     C           DDMTYP    ANDEQ'PI'                       *1
     C*
     C           H@TYPE    OREQ 'CP'                       *1
     C           DDMTYP    ANDEQ'PD'                       *1
     C*
     C           H@TYPE    OREQ 'DL'                       *1
     C           DDMTYP    ANDEQ'PD'                       *1
     C*
     C           H@TYPE    OREQ 'CP'                       *1             DT0058
     C           DDMTYP    ANDEQ'SI'                       *1             DT0058
     C*                                                                   DT0058
     C                     MOVE 'R'       @PRI             *1
     C                     END                             E1
     C*
     C           H@TYPE    IFEQ 'CT'                       B1
     C           DDMTYP    ANDEQ'PD'                       *1
     C*
     C           H@TYPE    OREQ 'DL'                       *1
     C           DDMTYP    ANDEQ'PI'                       *1
     C*
     C           H@TYPE    OREQ 'CP'                       *1
     C           DDMTYP    ANDEQ'PI'                       *1
     C*
     C           H@TYPE    OREQ 'CT'                       *1             DT0058
     C           DDMTYP    ANDEQ'SI'                       *1             DT0058
     C*                                                                   DT0058
     C                     MOVE 'P'       @PRI             *1
     C                     END                             E1
     C*
     C*  *-------------------------------*
     C*  * Validate Interest Rate/Spread *
     C*  *-------------------------------*
     C*
     C*
     C****If*the*spread/rate*is*blank,*this*is*an*error*for*type*SC****   CAC001
      **  If spread/rate is blank, deal type is SC, & anal. acctg. is     CAC001
      **  not installed, this is an error                                 CAC001
      *                                                                   CAC001
     C           DDMTYP    IFEQ 'SC'                       B1
     C           DDINTR    ANDEQ*BLANKS                    B1
     C           BGN0ST    ANDEQ'N'                                       CAC001
     C/COPY WNCPYSRC,MM0028CP43                                           S01408
     C                     MOVE '1'       *IN20            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0468' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028CP44                                           S01408
     C*
     C**  If the spread/rate is not blank, this is an error for type
     C**  other than SC.
     C           DDMTYP    IFNE 'SC'                       B1
     C           DDINTR    ANDNE*BLANKS                    B1
     C                     MOVE '1'       *IN20            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0469' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C**  Check it is a valid figure with 7 decimal places max.
     C           *IN20     IFNE '1'                        B1
     C                     Z-ADD7         @@IDP            *1
     C                     Z-ADD4         @@IINT           *1
     C                     MOVE *BLANKS   @@ALPH           *1
     C                     MOVE DDINTR    @@ALPH           *1
     C                     MOVE 'N'       @@MTID  1                       E17279
     C                     EXSR ZA0840                     *1
     C           @@ERCD    IFNE 0                          B*2
     C                     MOVE '1'       *IN20            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0422' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If the spread/rate is valid, determine the effective rate and
     C**  place it in the Standard Deal format.
     C           *IN20     IFEQ '0'                        B1
     C           DDINTR    IFNE *BLANKS                    B*2
     C           @@AMT     DIV  10000000  IGINTR           **2
     C                     ELSE                            X*2
     C                     Z-ADD0         IGINTR           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C/COPY WNCPYSRC,MM0028CP45                                           S01408
     C*
     C*
     C*
     C*  *-------------------*
     C*  * Validate Currency *
     C*  *-------------------*
     C*
     C** Skip file access & validation which will have been performed
     C** this is an amendment.
     C           DDACTN    IFNE 'A'                        B1
     C           DDAMNP    OREQ *BLANKS                    B1
     C*
     C**  The currency must be entered.
     C           DDCCY     IFEQ *BLANKS                    B*2
     C                     MOVE '1'       *IN16            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0142' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*
     C**  If the currency is still valid, check that it is a live
     C**  dealing currency.
     C                     ELSE                            X*2
     C*****                MOVE *BLANKS   @KEY             **2    *****   S01194
     C*****                MOVE '20'      @KEY1            **2    *****   S01194
     C*****                MOVE DDCCY     @KEY2            **2    *****   S01194
     C*****                MOVE '1'       @KEY3            **2    *****   S01194
     C*****      @KEY      CHAINFDCCYTLL             65    **2    *****   S01194
     C*****                                                       *****   S01194
     C**  If no valid record is found, it is an error.
     C*****      *IN65     IFEQ '1'                        B**3   *****   S01194
     C*****      RECI      ORNE 'D'                        B**3   *****   S01194
032  C* CALL ACCESS PROG. FOR CURRENCY DETAILS.                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C*********************PARM @KEY2     @CRKEY  3                 S01194E276
     C                     PARM DDCCY     @CRKEY  3                       E276
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *IN16            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0202' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     END                             E**3
     C                     END                             E*2
     C*
     C** If error found exit validation
     C           *IN16     IFEQ '1'                        B*2
     C                     GOTO #ZI9                       **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C** Compare deam currency with that of related deal
     C           DDCCY     IFNE H@CCY                      B1
     C                     MOVE '1'       *IN16            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0476' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C**  If no error has occurred, set up the Standard Deal format field
     C           *IN16     IFEQ '0'                        B1
     C                     MOVE DDCCY     IGCCY            *1
     C*****                MOVE CDP       IGCYDP           *1     *****   S01194
     C/COPY WNCPYSRC,MM0028CP46                                           S01408
     C                     MOVE A6NBDP    IGCYDP           *1             S01194
     C                     END                             E1
     C*
     C*  *-----------------*
     C*  * Validate Amount *
     C*  *-----------------*
     C*
     C*
     C**  If deal type is PI or PD and amount has not been entered
     C**  then it is an error.
     C           DDMTYP    IFEQ 'PI'                       B1
     C           DDAMNP    ANDEQ*BLANK                     B1
     C           DDMTYP    OREQ 'PD'                       B1
     C           DDAMNP    ANDEQ*BLANK                     B1
     C                     MOVE '1'       *IN18            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0471' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C**  If deal type is not PI or PD and amount has been entered
     C**  then it is an error.
     C           DDMTYP    IFNE 'PI'                       B1
     C           DDMTYP    ANDNE'PD'                       B1
     C           DDMTYP    ANDNE*BLANKS                    B1
     C           DDAMNP    IFNE *BLANKS                    B*2
     C                     MOVE '1'       *IN18            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0472' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C           *IN16     IFEQ '0'                        B1
     C           *IN18     ANDEQ'0'                        B1
     C           DDAMNP    ANDNE*BLANK                     B1
     C*
     C**  Verify that the amount entered is valid numeric.
     C*****                Z-ADDCDP       @@IDP            *1     *****   S01194
     C                     Z-ADDA6NBDP    @@IDP            *1             S01194
     C*****      13        SUB  CDP       @@IINT           *1     *****   S01194
     C           13        SUB  A6NBDP    @@IINT           *1             S01194
     C                     MOVE *BLANKS   @@ALPH           *1
     C                     MOVE DDAMNP    @@ALPH           *1
     C                     MOVE 'Y'       @@MTID  1                       E17279
     C                     EXSR ZA0840                     *1
     C           @@ERCD    IFNE 0                          B*2
     C                     MOVE '1'       *IN18            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0144' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     END                             E*2
     C*
     C**If amendment type is 'PD' execute process 'Check deal amendment
     C** principle'   : MMP0082.
     C** Only necessary if -ve result is possible (INSERT OF PD)
     C           DDMTYP    IFEQ 'PD'                       B*2
     C           DDAMNP    ANDNE*BLANKS                    **2
     C           DDACTN    ANDEQ'I'                        **2
     C           *IN41     ANDEQ'0'                        **2
     C*
     C**  Store this deam amount
     C                     Z-ADD@@AMT     @TDLA  150       **2
     C                     EXSR #ZQ                        **2
     C                     END                             E*2
     C*
     C*
     C**  If the amount is valid, set up the numeric amount on the
     C**  Standard Deal format.
     C           *IN18     IFEQ '0'                        B*2
     C           DDAMNP    IFNE *BLANK                     B**3
     C                     Z-ADD@@AMT     IGAMNP           ***3
     C/COPY WNCPYSRC,MM0028C128
     C                     MOVE @@ALPH    DDAMNP           ***3
     C                     MOVE @@ALPH    @AMNP            ***3
     C                     ELSE                            X**3
     C                     Z-ADD*ZERO     IGAMNP           ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
      *                                                                   CAC001
      **  If Analytical Accounting is on, validate Funding Spread/Rate    CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
      *                                                                   CAC001
     C                     MOVE '0'       *IN23                           CAC001
      *                                                                   CAC001
      **  Funding spread/rate should not be entered if amendment type     CAC001
      **  is not 'SC'                                                     CAC001
      *                                                                   CAC001
     C           DDMTYP    IFNE 'SC'                                      CAC001
     C           DDFSRP    ANDNE*BLANKS                                   CAC001
     C                     MOVE '1'       *IN23                           CAC001
     C                     MOVE '1'       *IN41                           CAC001
     C                     MOVEL'MMM0469' @MSGID                          CAC001
     C                     CALL 'ZA0240'                                  CAC001
     C                     PARM           @MSGID                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Still an error if 'SC' but both interest rate/spread are        CAC001
      **  blank                                                           CAC001
      *                                                                   CAC001
     C           DDMTYP    IFEQ 'SC'                                      CAC001
     C           DDINTR    ANDEQ*BLANKS                                   CAC001
     C           DDFSRP    ANDEQ*BLANKS                                   CAC001
     C                     MOVE '1'       *IN20                           CAC001
     C                     MOVE '1'       *IN41                           CAC001
     C                     MOVEL'MMM0468' @MSGID                          CAC001
     C                     CALL 'ZA0240'                                  CAC001
     C                     PARM           @MSGID                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Not valid if deal is not directly funded                        CAC001
      *                                                                   CAC001
     C           DDMTYP    IFEQ 'SC'                                      CAC001
     C           DDFSRP    ANDNE*BLANKS                                   CAC001
     C           HKFPRC    ANDEQ*BLANKS                                   CAC001
     C                     MOVE '1'       *IN23                           CAC001
     C                     MOVE '1'       *IN41                           CAC001
     C                     MOVEL'MMM0470' @MSGID                          CAC001
     C                     CALL 'ZA0240'                                  CAC001
     C                     PARM           @MSGID                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Check if it is a valid figure with 7 decimal places max.        CAC001
      *                                                                   CAC001
     C           *IN23     IFEQ *OFF                                      CAC001
     C           *IN20     ANDEQ*OFF                                      CAC001
     C                     Z-ADD7         @@IDP                           CAC001
     C                     Z-ADD4         @@IINT                          CAC001
     C                     MOVE *BLANKS   @@ALPH                          CAC001
     C                     MOVE DDFSRP    @@ALPH                          CAC001
     C                     MOVE 'N'       @@MTID                          CAC001
     C                     EXSR ZA0840                                    CAC001
     C           @@ERCD    IFNE 0                                         CAC001
     C                     MOVE '1'       *IN23                           CAC001
     C                     MOVE '1'       *IN41                           CAC001
     C                     MOVEL'MMM0422' @MSGID                          CAC001
     C                     CALL 'ZA0240'                                  CAC001
     C                     PARM           @MSGID                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Determine Interest Rate Change Flag                             CAC001
      *                                                                   CAC001
     C           DDINTR    IFNE *BLANKS                                   CAC001
     C                     MOVE 'Y'       IGIRCF                          CAC001
     C                     ELSE                                           CAC001
     C                     MOVE 'N'       IGIRCF                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Determine Funding Rate Change Flag                              CAC001
      *                                                                   CAC001
     C           DDFSRP    IFNE *BLANKS                                   CAC001
     C                     MOVE 'Y'       IGFRCF                          CAC001
     C                     ELSE                                           CAC001
     C                     MOVE 'N'       IGFRCF                          CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  If the spread/rate is valid, determine the effective rate and   CAC001
      **  place it in the Standard Deal format.                           CAC001
      *                                                                   CAC001
     C           *IN23     IFEQ *OFF                                      CAC001
     C           *IN20     ANDEQ*OFF                                      CAC001
     C           DDFSRP    IFNE *BLANKS                                   CAC001
     C           @@AMT     DIV  10000000  IGFSRP                          CAC001
     C                     ELSE                                           CAC001
     C                     Z-ADD0         IGFSRP                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Calculate new effective rates and check if effective funding    CAC001
      **  rate is within tolerance level                                  CAC001
      *                                                                   CAC001
     C                     EXSR SRERAT                                    CAC001
      *                                                                   CAC001
      **  Retrieve Funding Tolerance from PCA ICD                         CAC001
      *                                                                   CAC001
     C                     CALL 'AOPCACR0'                                CAC001
     C                     PARM *BLANKS   @RTCD                           CAC001
     C                     PARM '*FIRST'  @OPTN                           CAC001
     C           SDPCAC    PARM SDPCAC    DSFDY                           CAC001
      *                                                                   CAC001
      **  Check for data base error                                       CAC001
      *                                                                   CAC001
     C           @RTCD     IFNE *BLANK                                    CAC001
     C                     MOVEL'SDPCACPD'DBFILE           ************   CAC001
     C                     MOVEL'019'     DBASE            * DBERR 019*   CAC001
     C                     MOVEL@OPTN     DBOPTN           ************   CAC001
     C                     MOVEL'*FIRST ' DBKEY                           CAC001
     C                     MOVE '1'       *INU7                           CAC001
     C                     MOVE '1'       *INU8                           CAC001
     C                     MOVE '1'       *INKC                           CAC001
     C                     EXSR #C                                        CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Calculate minimum & maximum allowable amount based on           CAC001
      **  Funding Tolerance                                               CAC001
      *                                                                   CAC001
     C           WEFFR     IFGT WEFIR                                     CAC001
     C           FTTFRT    DIV  100       WTOL1   32                      CAC001
     C           WTOL1     ADD  1         WTOL4   32                      CAC001
     C           WEFIR     MULT WTOL4     WMAX   117                      CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C           WEFFR     IFLT WEFIR                                     CAC001
     C           FTTFRT    DIV  100       WTOL2   32                      CAC001
     C           1         SUB  WTOL2     WTOL3   32                      CAC001
     C           WEFIR     MULT WTOL3     WMIN   117                      CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Check if Effective Funding Rate is within tolerance level       CAC001
      *                                                                   CAC001
     C           *IN24     IFEQ *ON                                       CAC001
     C           WEFFR     ANDNEWEFIR                                     CAC001
     C           WEFFR     IFGT WMAX                                      CAC001
     C           WEFFR     ANDGTWEFIR                                     CAC001
     C           WEFFR     ORLT WMIN                                      CAC001
     C           WEFFR     ANDLTWEFIR                                     CAC001
     C                     MOVE '1'       *IN23                           CAC001
     C                     MOVE '1'       *IN55                           CAC001
     C                     MOVEL'MMM2550' @MSGID                          CAC001
     C/COPY WNCPYSRC,MM0028CP71                                           S01408
     C                     CALL 'ZA0240'                                  CAC001
     C                     PARM           @MSGID                          CAC001
     C/COPY WNCPYSRC,MM0028CP72                                           S01408
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
     C/COPY WNCPYSRC,MM0028C145
     C*
     C*  *-----------------------------------------------*
     C*  * Validate Settlement Pay/Receive Instructions  *
     C*  *-----------------------------------------------*
     C*
     C*  branch code                                                      S01177
     C*
     C*****                MOVE H@BRCD    PMBRCD                  S01177  S01117
     C                     MOVE H@BRCA    PMBRCA                          S01117
     C*                                                                   S01177
     C           *IN77     IFEQ '1'                                       S01177
     C                     GOTO #ZI9                       *1             S01177
     C                     END                                            S01177
     C                     MOVE '0'       *IN66
     C** Set up parameters for call to SD2410  in case first screen       S01177
     C*     has been changed                                              S01177
     C*                                                                   S01177
     C                     MOVE DDACTN    PMACTC                          S01177
     C                     MOVE 'MMDA'    PMCPGM                          S01177
     C                     MOVE DDMTYP    PMTTYP                          S01177
     C                     MOVE DDCSNM    PMCSNM                          S01177
     C                     MOVE @VDYNO    PMDTRC                          S01177
     C                     MOVE @VDYNO    PMDTPY                          S01177
     C                     MOVE DDCCY     PMRCCY                          S01177
     C                     MOVE DDCCY     PMPCCY                          S01177
     C                     MOVE *BLANK    PMFFND                          S01177
     C                     MOVE *BLANKS   PMCMDP                          S01177
      *                                                                   E286
      ** Must blank out settlement branches, this is handled and          E286
      ** validated by SD2410,  unless settlement method is '05'           E286
     C           PMRSTM    IFNE 05                                        E286
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP65                                           S01408
      *                                                                   S01408
     C                     MOVE *BLANKS   PMROBR                          E286
     C                     ELSE                                           E286
      * SETUP DEFAULT BRANCH FOR '05' IF MBIN IS OFF                      E286
     C           @MBIN     IFEQ 'N'                                       E286
     C                     MOVE BJSBRC    PMROBR                          E286
     C                     END                                            E286
     C                     END                                            E286
      *                                                                   E286
     C           PMPSTM    IFNE 05                                        E286
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP66                                           S01408
      *                                                                   S01408
     C                     MOVE *BLANKS   PMPOBR                          E286
     C                     ELSE                                           E286
      * SETUP DEFAULT BRANCH FOR '05' IF MBIN IS OFF                      E286
     C           @MBIN     IFEQ 'N'                                       E286
     C                     MOVE BJSBRC    PMPOBR                          E286
     C                     END                                            E286
     C                     END                                            E286
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP17                                           S01408
     C*                                                                   S01408
     C*                                                                   S01177
     C** Call settlement screen validation program                        S01177
     C*****                CALL 'SDKUUPR'                          S01177 E214
     C                     CALL 'SD2410'                                  E214
     C                     PARM           @PARM2                          S01177
     C                     PARM           @PARM3                          S01177
     C                     PARM           WDUMMY                          CEU003
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CSF1                                           S01408
     C*                                                                   S01408
     C*                                                                   LN0234
     C* If settlement through a NOSTRO, access nostro location            LN0234
     C* to validate value date for holiday, using deal currency.          LN0234
      * Check receive side first                                          LN0488
     C*                                                                   LN0234
     C           *IN77     IFEQ '0'                                       LN0234
     C           PMRSTM    IFEQ 01                         B1             LN0234
     C           PMRSTM    OREQ 07                         *1             LN0234
     C           PMRSTM    OREQ 08                         *1             LN0234
     C***********PMPSTM****OREQ 01                         B1       LN0234LN0488
     C***********PMPSTM****OREQ 07                         *1       LN0234LN0488
     C***********PMPSTM****OREQ 08                         *1       LN0234KN0488
      *                                                                   CEU003
      ** Determine effective currency                                     CEU003
      *                                                                   CEU003
     C                     MOVE *BLANKS   WEFCY                           CEU003
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           PMRSCY    ANDNE*BLANKS                                   CEU003
      *                                                                   CEU003
     C                     MOVELPMRSCY    WEFCY                           CEU003
      *                                                                   CEU003
     C                     ELSE                                           CEU003
      *                                                                   CEU003
     C                     MOVELDDCCY     WEFCY                           CEU003
      *                                                                   CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
     C*                                                                   LN0234
032  C* CALL ACCESS PROG. FOR NOSTROS DETAILS.                            LN0234
     C                     CALL 'AONOSTR0'                 *1             LN0234
     C*********************PARM '*DBERR ' @RTCD   7        *1      LN0234 E47225
     C                     PARM '*MSG   ' @RTCD   7        *1             E47225
     C                     PARM '*KEY   ' @OPTN   7        *1             LN0234
     C                     PARM *BLANKS   @NSKYA  6        *1             LN0234
     C***********          PARM DDCCY     @NSKYB  3        *1      LN0234 CEU003
     C                     PARM WEFCY     @NSKYB  3                       CEU003
     C**********           PARM *BLANKS   @NSKYC  4        *1                          LN0234 CGL029
     C                     PARM *BLANKS   @NSKYC 10                                           CGL029
     C                     PARM *BLANKS   @NSKYD  2        *1             LN0234
     C                     PARM PMRONS    @NSKYE  2        *1             LN0234
     C                     PARM *BLANKS   @KEYF            *1             LN0234
     C                     PARM *BLANKS   @KEYG            *1             LN0234
     C                     PARM *BLANKS   @KEYH            *1             LN0234
     C           SDNOST    PARM SDNOST    DSFDY            *1             LN0234
     C*                                                                   LN0234
     C           @RTCD     IFNE *BLANK                     B2             LN0234
     C                     MOVE '1'       *IN65            *2             LN0234
     C                     MOVE '1'       *INLR            *2             LN0234
     C                     MOVE '1'       *INKC            *2             LN0234
     C                     MOVE '1'       *INU7            ***************LN0234
     C                     MOVE '1'       *INU8            *             *LN0234
     C                     MOVEL'SDNOSTPD'DBFILE           * DB ERROR 018*LN0234
     C                     MOVEL@NSKYB    DBKEY            *             *LN0234
     C                     MOVE @NSKYE    DBKEY            *             *LN0234
     C                     MOVE '018'     DBASE            ***************LN0234
     C                     GOTO #ZI9                       *2             LN0234
     C                     END                             E2             LN0234
     C*                                                                   LN0234
     C                     MOVE A7NOSN    @RLOC   3        *1             LN0234
     C*                                                                   LN0234
     C**  Find whether the date is a holiday in the deal currency.        LN0234
     C***********          MOVE H@CCY     ZCCY             *1      LN0234 CEU003
     C                     MOVELWEFCY     ZCCY                            CEU003
     C                     Z-ADD@VDYNO    ZDAYNO  50       *1             LN0234
     C                     MOVE @RLOC     ZLOC    3        *1             LN0234
     C                     EXSR ZCHKH                      *1             LN0234
     C*                                                                   LN0234
     C**  If ZIND = 'H' then the date is a holiday.               *****   LN0234
     C           ZIND      IFEQ 'H'                        B*2            LN0234
     C                     MOVE '1'       *IN11            **2            LN0234
     C*********************MOVE '1'       *IN41            **2     LN0234 E36546
     C                     MOVE '1'       *IN55            **2            E36546
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           PMRSCY    ANDNE*BLANKS                                   CEU003
     C                     MOVEL'MMM3000' @MSGID                          CEU003
     C                     ELSE                                           CEU003
     C                     MOVEL'MMM0129' @MSGID           **2            LN0234
     C                     ENDIF                                          CEU003
     C/COPY WNCPYSRC,MM0028C094
     C                     CALL 'ZA0240'                   **2            LN0234
     C                     PARM           @MSGID           **2            LN0234
     C/COPY WNCPYSRC,MM0028C095
     C                     GOTO #ZI9                       **2            LN0234
     C                     END                             E*2            LN0234
     C                     END                             E1             LN0234
      *                                                                   LN0488
      * Check payment side                                                LN0488
      *                                                                   LN0488
     C           PMPSTM    IFEQ 01                         B1             LN0488
     C           PMPSTM    OREQ 07                         *1             LN0488
     C           PMPSTM    OREQ 08                         *1             KN0488
      *                                                                   CEU003
      ** Determine effective currency                                     CEU003
      *                                                                   CEU003
     C                     MOVE *BLANKS   WEFCY                           CEU003
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           PMPSCY    ANDNE*BLANKS                                   CEU003
      *                                                                   CEU003
     C                     MOVELPMPSCY    WEFCY                           CEU003
      *                                                                   CEU003
     C                     ELSE                                           CEU003
      *                                                                   CEU003
     C                     MOVELDDCCY     WEFCY                           CEU003
      *                                                                   CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
     C*                                                                   LN0488
032  C* CALL ACCESS PROG. FOR NOSTROS DETAILS.                            LN0488
     C                     CALL 'AONOSTR0'                 *1             LN0488
     C*********************PARM '*DBERR ' @RTCD   7        *1      LN0488 E47225
     C                     PARM '*MSG   ' @RTCD   7        *1             E47225
     C                     PARM '*KEY   ' @OPTN   7        *1             LN0488
     C                     PARM *BLANKS   @NSKYA  6        *1             LN0488
     C***********          PARM DDCCY     @NSKYB  3        *1      LN0488 CEU003
     C                     PARM WEFCY     @NSKYB  3                       CEU003
     C**********           PARM *BLANKS   @NSKYC  4        *1                          LN0488 CGL029
     C                     PARM *BLANKS   @NSKYC                                              CGL029
     C                     PARM *BLANKS   @NSKYD  2        *1             LN0488
     C                     PARM PMPONS    @NSKYE  2        *1             LN0488
     C                     PARM *BLANKS   @KEYF            *1             LN0488
     C                     PARM *BLANKS   @KEYG            *1             LN0488
     C                     PARM *BLANKS   @KEYH            *1             LN0488
     C           SDNOST    PARM SDNOST    DSFDY            *1             LN0488
     C*                                                                   LN0488
     C           @RTCD     IFNE *BLANK                     B2             LN0488
     C                     MOVE '1'       *IN65            *2             LN0488
     C                     MOVE '1'       *INLR            *2             LN0488
     C                     MOVE '1'       *INKC            *2             LN0488
     C                     MOVE '1'       *INU7            ***************LN0488
     C                     MOVE '1'       *INU8            *             *LN0488
     C                     MOVEL'SDNOSTPD'DBFILE           * DB ERROR 018*LN0488
     C                     MOVEL@NSKYB    DBKEY            *             *LN0488
     C                     MOVE @NSKYE    DBKEY            *             *LN0488
     C                     MOVE '018'     DBASE            ***************LN0488
     C                     GOTO #ZI9                       *2             LN0488
     C                     END                             E2             LN0488
     C*                                                                   LN0488
     C                     MOVE A7NOSN    @RLOC   3        *1             LN0488
     C*                                                                   LN0488
     C**  Find whether the date is a holiday in the deal currency.        LN0488
     C***********          MOVE H@CCY     ZCCY             *1      LN0488 CEU003
     C                     MOVELWEFCY     ZCCY                            CEU003
     C                     Z-ADD@VDYNO    ZDAYNO  50       *1             LN0488
     C                     MOVE @RLOC     ZLOC    3        *1             LN0488
     C                     EXSR ZCHKH                      *1             LN0488
     C*                                                                   LN0488
     C**  If ZIND = 'H' then the date is a holiday.               *****   LN0488
     C           ZIND      IFEQ 'H'                        B*2            LN0488
     C                     MOVE '1'       *IN11            **2            LN0488
     C*******              MOVE '1'       *IN41            **2     LN0488 049518
     C                     MOVE '1'       *IN55            **2            049518
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           PMPSCY    ANDNE*BLANKS                                   CEU003
     C                     MOVEL'MMM3000' @MSGID                          CEU003
     C                     ELSE                                           CEU003
     C                     MOVEL'MMM0129' @MSGID           **2            LN0488
     C                     ENDIF                                          CEU003
     C/COPY WNCPYSRC,MM0028C096
     C                     CALL 'ZA0240'                   **2            LN0488
     C                     PARM           @MSGID           **2            LN0488
     C/COPY WNCPYSRC,MM0028C097
     C                     GOTO #ZI9                       **2            LN0488
     C                     END                             E*2            LN0488
     C                     END                             E1             LN0488
     C                     END                                            LN0234
     C*                                                                   LN0234
     C* For settlement NOT through a NOSTRO validate value date           LN0234
     C* for holiday at local location.                                    LN0234
     C* Ensure settlement instructions entered before Date holiday        LN0234
     C* validation is carried out.                                        LN0234
     C*                                                                   LN0234
     C           *IN77     IFEQ '0'                        B1             LN0234
     C           PMRSTM    IFNE 01                         B1             LN0234
     C           PMRSTM    ANDNE07                         *1             LN0234
     C           PMRSTM    ANDNE08                         *1             LN0234
     C           PMPSTM    ANDNE01                         B1             LN0234
     C           PMPSTM    ANDNE07                         *1             LN0234
     C           PMPSTM    ANDNE08                         *1             LN0234
     C**  Find whether the date is a holiday in the local currency.       LN0234
     C                     MOVE BJLCCY    ZCCY             *1             LN0234
     C                     Z-ADD@VDYNO    ZDAYNO           *1             LN0234
     C                     MOVE BJSLCD    ZLOC             *1             LN0234
     C                     EXSR ZCHKH                      *1             LN0234
     C*                                                                   LN0234
     C*   If ZIND   = 'H' then the date is a holiday.                     LN0234
     C           ZIND      IFEQ 'H'                        B*2            LN0234
     C*******              MOVE '1'       *IN31            **2     LN0234 049518
     C                     MOVE '1'       *IN11            **2            LN0234
     C*********************MOVE '1'       *IN41            **2     LN0234 E36546
     C                     MOVE '1'       *IN55            **2            E36546
     C                     MOVEL'MMM0131' @MSGID           **2            LN0234
     C/COPY WNCPYSRC,MM0028C098
     C                     CALL 'ZA0240'                   **2            LN0234
     C                     PARM           @MSGID           **2            LN0234
     C/COPY WNCPYSRC,MM0028C099
     C                     GOTO #ZI9                       **2            LN0234
     C                     END                             E*2            LN0234
     C                     END                             E1             LN0234
     C                     END                             E1             LN0234
     C*
     C*                                                                   S01177
     C** Terminate program if database error returned                     S01177
     C*                                                                   S01177
     C           PMDBSE    IFNE *ZEROS                                    S01177
     C                     MOVE '1'       *INLR            *1             S01177
     C                     MOVE '1'       *INU7            *1             S01177
     C                     MOVE '1'       *INU8            *1             S01177
     C                     MOVE '1'       *INKC            ***************S01177
     C                     MOVELPMDBFL    DBFILE           * DBERROR 029 *S01177
     C                     MOVE PMDBSE    DBASE            ***************S01177
     C                     MOVELPMDBKY    DBKEY            *1             S01177
     C                     MOVELPMDPGM    DBPGM            *1             S01177
     C                     GOTO #ZI9                       *1             S01177
     C                     END                             E1             S01177
     C*                                                                   S01177
     C*                                                                   S01177
     C** If validation errors have occured do not allow update            S01177
     C           PMERCD    IFNE *BLANKS                                   S01177
     C/COPY WNCPYSRC,MM0028C129
     C                     MOVE '1'       *IN41                           S01177
     C                     MOVE '1'       *IN66                           S01177
     C*********************MOVEL'MMM1040' @MSGID                S01177    S01227
     C                     MOVEL'MMM1042' @MSGID                          S01227
     C                     CALL 'ZA0240'                                  S01177
     C                     PARM           @MSGID                          S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C** Check validity of input                                          S01177
     C** For deal type CI instructions cannot be pay if method is 04      S01177
     C*****      H@MTYP    IFEQ 'CI'                       B1             S01177
     C*****      @PRI      ANDEQ'P'                        *1             S01177
     C*****      DDORCM    ANDEQ'04'                       *1             S01177
     C*****                MOVE '1'       *IN31            *1             S01177
     C*****                MOVE '1'       *IN41            *1             S01177
     C*****                MOVEL'MMM0215' @MSGID           *1             S01177
     C*****                CALL 'ZA0240'                   *1             S01177
     C*****                PARM           @MSGID           *1             S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C** For deal type SC or CI settlement fields must be blank           S01177
     C*****      DDMTYP    IFEQ 'CI'                       B1             S01177
     C*****      DDMTYP    OREQ 'SC'                       B1             S01177
     C*****      DDORCM    IFNE *BLANKS                    B*2            S01177
     C*****      DDMORI    ORNE *BLANKS                    B*2            S01177
     C*****      DDMCPI    ORNE *BLANKS                    B*2            S01177
     C*****      DDMFAO    ORNE *BLANKS                    B*2            S01177
     C*****      DDORCM    IFNE *BLANKS                    B*2            S01177
     C*****                MOVE '1'       *IN31            **2            S01177
     C*****                END                             E**3           S01177
     C*****      DDMORI    IFNE *BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN33            ***3           S01177
     C*****                END                             E**3           S01177
     C*****      DDMCPI    IFNE *BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN35            ***3           S01177
     C*****                END                             E**3           S01177
     C*****      DDMFAO    IFNE *BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN37            ***3           S01177
     C*****                END                             E**3           S01177
     C*****                MOVE '1'       *IN41            **2            S01177
     C*****                MOVEL'MMM0209' @MSGID           **2            S01177
     C*****                CALL 'ZA0240'                   **2            S01177
     C*****                PARM           @MSGID           **2            S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C*
     C**  If there are no validation errors so far validate &/or
     C**  determine defaults.
     C*
     C*****      *IN41     IFEQ '0'                        B1             S01177
     C*****                                                               S01177
     C** No validation required for rate change or cd issued since
     C** instructions must be blank
     C*****      DDMTYP    ANDNE'CI'                       *1             S01177
     C*****      DDMTYP    ANDNE'SC'                       *1             S01177
     C*****                                                               S01177
     C*
     C** Event date
     C** Set event date to value date
     C*****                MOVE @VDYNO    @EDAT   50       *1             S01177
     C*****                MOVE 'V'       @EFLG   1        *1             S01177
     C*****                                                               S01177
     C*
     C** Set up parameters for receive/PAY instructions
     C*****                MOVE DDORCM    @SMT    2        *1             S01177
     C*****                MOVE DDMORI    @OUR   12        *1             S01177
     C*****                MOVE DDMCPI    @THEIR 10        *1             S01177
     C*****                MOVE @PRI      @PRIND  1        *1             S01177
     C*****                MOVE DDMFAO    @FORAC 10        *1             S01177
     C*****                MOVE DDSPEC    @SPECI 35        *1             E13747
     C*****                Z-ADDIGCNUM    @CUST#  60       *1             S01177
     C*****                MOVE IGCSNM    @CUSTN 10        *1             S01177
     C*****                                                               S01177
     C*
     C** Call #ZIA to determine defaults and to validate instructions.
     C*****                EXSR #ZIA                       *1             S01177
     C*****                                                               S01177
     C*****                MOVE @SMT      DDORCM           *1             S01177
     C*****                MOVE @OUR      DDMORI           *1             S01177
     C*****                MOVE @THEIR    DDMCPI           *1             S01177
     C*****                MOVE @FORAC    DDMFAO           *1             S01177
     C*****                MOVE @SPECI    DDSPEC           *1             E13747
     C*****                                                               S01177
     C*****                MOVE DDCSNM    @XCUST 10        *1             S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS7                                           S01408
     C*                                                                   S01408
     C           #ZI9      ENDSR                           **#ZI9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C********                                                        *   S01177
     C**#ZIA**   - Validates the settlement instructions.             *   S01177
     C********                                                        *   S01177
     C**CALLS*   ZA0240   - Sends message to screen.                  *   S01177
     C********   ZA0830   - Is day a holiday in currency              *   S01177
     C********   ZA0840   - Validate/reformat input amount            *   S01177
     C********   ZA0440   - Send message with data.                   *   S01177
     C********   #ZIAA    - Account checks.                           *   S01177
     C********                                                        *   S01177
     C**CALL*D BY  #ZI    - Validates the display for I and A.        *   S01177
     C********                                                        *   S01177
     C**FLDS*USED  @CUSTN - customer number                           *   S01177
     C********     @SMT   - settlement method                         *   S01177
     C********     @THEIR - their instructions                        *   S01177
     C********     @OUR   - our instructions                          *   S01177
     C********     @FORAC - for account of                            *   S01177
     C********     @PRIND - pay receive indicator                     *   S01177
     C********     @CUST# - Deam customer no.                         *   S01177
     C********     @CUSTN - customer number                           *   S01177
     C********     @XCUST - customer number from display              *   S01177
     C********     @@ALPH - 16A field containing field to validate    *   S01177
     C********     @@IDP  - number of decimal places                  *   S01177
     C********     @@IINT - number of integers                        *   S01177
     C********     @@ALPH - 16A field for display                     *   S01177
     C********     @@AMT  - 15N field for calculation                 *   S01177
     C********     @@ERCD - 1N error code                             *   S01177
     C********     @STS   - next status of deal                       *   S01177
     C********     @ENAM  - Event title                               *   S01177
     C********     @EFLG  - Event flag                                *   S01177
     C********     @V     - Index to array @ENAM                      *   S01177
     C********     @CYCCY - Customer currency defaults key.           *   S01177
     C********     @CYCNM - Customer currency defaults key.           *   S01177
     C********     @CYKEY - Customer currency defaults key.           *   S01177
     C********     @CTTP  - Customer currency defaults key.        E13747 S01177
     C********     @DMTD  - Settlement method.                        *   S01177
     C*************@NSCNO*-*Nostro*key.**************************  E13747 S01177
     C*************@NSCCY*-*Nostro*key.**************************  E13747 S01177
     C*************@NSKEY*-*Nostro*key.**************************  E13747 S01177
     C********     @TEMP  - Work field.                               *   S01177
     C*************@SNNM2*-*Nostro*shortname*key.****************  E13747 S01177
     C*************@SNNM1*-*Nostro*shortname*key.****************  E13747 S01177
     C*************@SNKEY*-*Nostro*shortname*key.****************  E13747 S01177
     C********     @SNNM2 - Nostro shortname key.                     *   S01177
     C********     @SNNM1 - Nostro shortname key.                     *   S01177
     C********     @SNKEY - Nostro shortname key.                     *   S01177
     C********     @8     - Work field.                               *   S01177
     C********     @@CCY  - Currency                                  *   S01177
     C********     @VDYNO - Value date day no.                        *   S01177
     C********     @@MNO  MIDAS DAY NUMBER 5N                         *   S01177
     C********     @@CCY  CURRENCY CODE 3A                            *   S01177
     C********     @@HIND HOLIDAY/WORKING DAY INDICATOR 1A            *   S01177
     C********     @TEMP2 - work field                                *   S01177
     C********     @KEY   - key for table files                       *   S01177
     C********     @KEY1  -   "           "                           *   S01177
     C********     @TEMP3 - work field                                *   S01177
     C********     @TEMT4 - workfield                                 *   S01177
     C********     @ACCNM - ACCNT key                                 *   S01177
     C********     @ACCCY - ACCNT key                                 *   S01177
     C********     @ACCDE - ACCNT key                                 *   S01177
     C********     @ACSEQ - ACCNT key                                 *   S01177
     C********     @ERCD  - Error code                                *   S01177
     C********     @TEMP5 - work field                                *   S01177
     C********     @MORI  -                                           *   S01177
     C********     @WK25  -                                           *   S01177
     C********     @X1    -                                           *   S01177
     C********     @TEN   - work field                                *   S01177
     C********     @TEN   - work field                                *   S01177
     C********     @TEND  - work field                                *   S01177
     C********     @TWLV  - work field                                *   S01177
     C********     @CUN   - work field to split our instructions      *   S01177
     C********     @ACD   - work field                                *   S01177
     C********     @SEQ   - work field                                *   S01177
     C********     @T11   - work field                                *   S01177
     C********     @REKEY - retail account key                        *   S01177
     C*********    @RET   - retail account key                        *   S01177
     C********     @WK30  - workfield                                 *   S01177
     C********     @WK10  - workfield                                 *   S01177
     C********     @CNUM  - key to CLINT                              *   S01177
     C********     @CLTKY - key to CLINT                              *   S01177
     C********                                                        *   S01177
     C*****************************************************************   S01177
     C*****      #ZIA      BEGSR                                          S01177
     C*****                                                               S01177
     C**  Initialise event date literal.                                  S01177
     C*****                MOVEL*BLANK    @ENAM  18                       S01177
     C*****      @EFLG     IFEQ 'V'                        B1             S01177
     C*****                MOVEL@V,2      @ENAM            *1             S01177
     C*****                END                             E1             S01177
     C*****      @EFLG     IFEQ 'M'                        B1             S01177
     C*****                MOVEL@V,4      @ENAM            *1             S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C****--------------------------------------------*                   S01177
     C**** Preliminary Validation and Defaulting      *                   S01177
     C****--------------------------------------------*                   S01177
     C*****                                                               S01177
     C**  If the customer field is blank, then all settlement             S01177
     C**  instructions must also be blank.                                S01177
     C*****      @CUSTN    IFEQ *BLANKS                    B1             S01177
     C*****      @SMT      IFNE *BLANKS                    B*2            S01177
     C*****      @THEIR    ORNE *BLANKS                    B*2            S01177
     C*****      @OUR      ORNE *BLANKS                    B*2            S01177
     C*****      @FORAC    ORNE *BLANKS                    B*2            S01177
     C*****                MOVE '1'       *IN41            **2            S01177
     C*****      *IN66     IFEQ '0'                        B**3           S01177
     C*****                MOVE '1'       *IN66            ***3           S01177
     C*****                MOVEL'MMM0210' @MSGID           ***3           S01177
     C*****                CALL 'ZA0240'                   ***3           S01177
     C*****                PARM           @MSGID           ***3           S01177
     C*****                END                             E**3           S01177
     C*****      DDORCM    IFNE *BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN31            ***3           S01177
     C*****                END                             E**3           S01177
     C*****      DDMORI    IFNE *BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN33            ***3           S01177
     C*****                END                             E**3           S01177
     C*****      DDMCPI    IFNE *BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN35            ***3           S01177
     C*****                END                             E**3           S01177
     C*****      DDMFAO    IFNE *BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN37            ***3           S01177
     C*****                END                             E**3           S01177
     C*****                GOTO #ZIA9                      **2            S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C**  If the customer number is non blank and if customer number      S01177
     C**  was previously blank when last displayed on screen, or          S01177
     C**  action is insert and default processing has not already         S01177
     C**  been done, do default processing                                S01177
     C*****      @CUSTN    IFNE *BLANKS                    B1             S01177
     C*****      @CUSTN    ANDNE@XCUST                     B1             S01177
     C*****      @XCUST    ANDEQ*BLANKS                    B1             S01177
     C*****      DDACTN    OREQ 'I'                        B1             S01177
     C*****      @CUSTN    ANDNE*BLANKS                    B1             S01177
     C*****      *IN67     ANDEQ'0'                        B1             S01177
     C*****      @PRIND    IFEQ 'P'                        B*2            S01177
     C*****                MOVE '1'       *IN67            **2            S01177
     C*****                END                             E*2            S01177
     C*****                MOVE DDCCY     @CYCCY           *1             S01177
     C*****                MOVE @CUST#    @CYCNM           *1             S01177
     C*****                MOVE 'MM'      @CTTP            *1      E13747 S01177
     C********** @CYKEY    CHAINFDCCCYLL             68    *1      E13747 S01177
     C*****      @CYKEY    CHAINSTDSI                68    *1      E13747 S01177
     C*****                                                        E13747 S01177
     C** If the default record not found, set default settlement meE13747 S01177
     C** to '00', else move the default pay receive method         E13747 S01177
     C*****                                                        E13747 S01177
     C** NOTE :- DUE TO ERRORS ON STANDARD SETTLEMENT INPUT CAUSINGE13747 S01177
     C*****      STANDARD SETTLEMENT FILE TO BE UPDATED INCORRECTLYE13747 S01177
     C*****      I.E. RECEIPT INSTNS. UPDATED TO SELL CCY SETTLEMENE13747 S01177
     C*****           WHEREAS PAY INSTNS. TO PURCHASED CCY SETTLEMEE13747 S01177
     C*****      THE SETTING UP OF THE FOLLOWING DEFAULT METHODS ISE13747 S01177
     C*****      DELIBERATLY INCORRECT, SO THAT THE MASTER FILES ARE13747 S01177
     C*****      UPDATED CORRECTLY.                                E13747 S01177
     C*****                                                        E13747 S01177
     C*****      *IN68     IFEQ '1'                        B*2     E13747 S01177
     C*****      RECI      OREQ '*'                        B*2     E13747 S01177
     C*****                MOVE '00'      @DMTD   2        **2     E13747 S01177
     C*****                ELSE                            **2     E13747 S01177
     C*****      @PRIND    IFEQ 'P'                        B**3    E13747 S01177
     C*****                MOVE PCST      @DMTD            ***3    E13747 S01177
     C*****                END                             E**3    E13747 S01177
     C*****      @PRIND    IFEQ 'R'                        B**3    E13747 S01177
     C*****                MOVE SCST      @DMTD            ***3    E13747 S01177
     C*****                END                             E**3    E13747 S01177
     C*****                                                        E13747 S01177
     C*****--------------------------------------------------------E13747 S01177
     C****If*the pay/receive method is blank and the default methodE13747 S01177
     C****exists, then move the default method into the default payE13747 S01177
     C****receive method field.                                    E13747 S01177
     C********** *IN68     IFEQ '0'                        B*2     E13747 S01177
     C********** CCDLTF    ANDEQ*BLANKS                    B*2     E13747 S01177
     C********** CCDMTD    IFEQ 'NA    '                   B**3    E13747 S01177
     C********** CCDMTD    OREQ *BLANKS                    ***3    E13747 S01177
     C**********           MOVE '00'      @DMTD   2        ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'TELX  '                   B**3    E13747 S01177
     C**********           MOVE '01'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'CHIPS '                   B**3    E13747 S01177
     C**********           MOVE '07'      @DMTD            ***3   E13747  S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'SWIFT '                   B**3    E13747 S01177
     C**********           MOVE '08'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'CSENT '                   B**3    E13747 S01177
     C**********           MOVE '02'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'CCOLL '                   B**3    E13747 S01177
     C**********           MOVE '12'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'COMP  '                   B**3    E13747 S01177
     C**********           MOVE '03'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'PCURR '                   B**3    E13747 S01177
     C**********           MOVE '04'      @DMTD            ***3   E13747  S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'CURR  '                   B**3    E13747 S01177
     C**********           MOVE '14'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'MACC  '                   B**3    E13747 S01177
     C**********           MOVE '05'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C********** CCDMTD    IFEQ 'SUSP  '                   B**3    E13747 S01177
     C**********           MOVE '06'      @DMTD            ***3    E13747 S01177
     C**********           END                             E**3    E13747 S01177
     C*----------------------------------------------------------  E13747 S01177
     C*****                                                               S01177
     C*****      @SMT      IFEQ *BLANKS                    B**3           S01177
     C*****                MOVE @DMTD     @SMT             ***3           S01177
     C*****                END                             E**3           S01177
     C*****                                                               S01177
     C**  If the settlement method is the same as the default, carry      S01177
     C**  out any defaulting required.                                    S01177
     C*****      @SMT      IFEQ @DMTD                      B**3           S01177
     C*****                                                               S01177
     C**  If our instructions are blank, default instructions exist       S01177
     C**  and settlement method is not 00, set up our instructions        S01177
     C**  with the default.                                               S01177
     C*****      @OUR      IFEQ *BLANKS                    B***4          S01177
     C*****      @DMTD     ANDNE'00'                       B***4          S01177
     C*****                                                               S01177
     C*****      @PRIND    IFEQ 'P'                        B****5  E13747 S01177
     C*****                MOVELOPCA      @OUR             *****5  E13747 S01177
     C*****                END                             E****5  E13747 S01177
     C*****      @PRIND    IFEQ 'R'                        B****5  E13747 S01177
     C*****                MOVELOSCA      @OUR             *****5  E13747 S01177
     C*****                END                             E****5  E13747 S01177
     C*****                                                        E13747 S01177
     C*----------------------------------------------------------- E13747 S01177
     C****If*the settlement method is 01,07 or 08, move the bank's E13747 S01177
     C****default nostro number to the our instructions field.    E13747  S01177
     C********** @DMTD     IFEQ '01'                       B****5  E13747 S01177
     C********** @DMTD     OREQ '07'                       B****5  E13747 S01177
     C********** @DMTD     OREQ '08'                       B****5 E13747  S01177
     C**********                                                   E13747 S01177
     C****Access the nostro file using the nostro shortname and de E13747 S01177
     C****to*find the corresponding nostro number.                 E13747 S01177
     C**********           MOVE NSNM      @NSCNO           *****5  E13747 S01177
     C**********           MOVE DDCCY     @NSCCY           *****5  E13747 S01177
     C********** @NSKEY    CHAINFDNOSTLL             65    *****5  E13747 S01177
     C********** *IN65     IFEQ '1'                        B*****6 E13747 S01177
     C********** RECI      OREQ '*'                        B*****6 E13747 S01177
     C**********           MOVE *BLANKS   @OUR             ******6 E13747 S01177
     C**********           ELSE                            X*****6 E13747 S01177
     C**********           MOVE *BLANKS   @OUR             ******6E13747  S01177
     C**********           MOVELNOSN      @OUR             ******6 E13747 S01177
     C**********           END                             E*****6 E13747 S01177
     C**********           END                             E****5  E13747 S01177
     C**********                                                   E13747 S01177
     C****If*the settlement method is 05,04 or 14, move the defaul E13747 S01177
     C****settlement instructions to the our instructions field.   E13747 S01177
     C********** @DMTD     IFEQ '05'                       B****5  E13747 S01177
     C********** @DMTD     OREQ '04'                       B****5  E13747 S01177
     C********** @DMTD     OREQ '14'                       B****5  E13747 S01177
     C**********           MOVE *BLANKS   @OUR             *****5  E13747 S01177
     C**********                                                   E13747 S01177
     C********** @DMTD     IFEQ '04'                       B*****  E13747 S01177
     C**********           MOVEL*BLANKS   @OUR             ******  E13747 S01177
     C**********           END                             E*****  E13747 S01177
     C**********                                                   E13747 S01177
     C********** @DMTD     IFEQ '14'                       B*****  E13747 S01177
     C**********           MOVELCCACNO    @OUR             ******  E13747 S01177
     C**********           END                             E*****  E13747 S01177
     C**********                                                   E13747 S01177
     C********** @DMTD     IFEQ '05'                       B*****  E13747 S01177
     C**********           MOVEL@CUST#    @OUR             ******  E13747 S01177
     C**********           MOVELCCACOD    @TEMP   6        ******  E13747 S01177
     C**********           MOVE CCACSQ    @TEMP            ******  E13747 S01177
     C**********           MOVE @TEMP     @OUR             ******  E13747 S01177
     C**********           END                             E*****  E13747 S01177
     C**********           END                             E****5  E13747 S01177
     C*----------------------------------------------------------  E13747 S01177
     C*****                                                               S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C**  If their instructions are blank, default instructions exist     S01177
     C**  and settlement method is not 00, set up their instructions      S01177
     C**  with the default.                                               S01177
     C*****      @THEIR    IFEQ *BLANKS                    B***4          S01177
     C*****      @DMTD     ANDNE'00'                       B***4          S01177
     C*****                                                               S01177
     C*****      @PRIND    IFEQ 'P'                        B****5  E13747 S01177
     C*****                MOVELTPCN      @THEIR           *****5  E13747 S01177
     C*****                MOVELFACO      @FORAC           *****5  E13747 S01177
     C*****                MOVELSPI       @SPECI           *****5  E13747 S01177
     C*****                END                             E****5  E13747 S01177
     C*****      @PRIND    IFEQ 'R'                        B****5  E13747 S01177
     C*****                MOVELTSCN      @THEIR           *****5  E13747 S01177
     C*****                END                             E****5  E13747 S01177
     C*****                                                        E13747 S01177
     C*****------------------------------------------------------- E13747 S01177
     C****If*the settlement method is 01,07 or 08, set up the thei E13747 S01177
     C****instructions field to hold the customer shortname.       E13747 S01177
     C********** @DMTD     IFEQ '01'                       B****5 E13747  S01177
     C********** @DMTD     OREQ '07'                       *****5  E13747 S01177
     C********** @DMTD     OREQ '08'                       *****5 E13747  S01177
     C**********           MOVELCCCSN1    @THEIR           *****5 E13747  S01177
     C**********           MOVE CCCSN2    @THEIR           *****5  E13747 S01177
     C**********                                                   E13747 S01177
     C****Check*to see if the shortname is on the file SNAME.      E13747 S01177
     C********** @THEIR    CHAINSNAME                65    *****5  E13747 S01177
     C**********                                                   E13747 S01177
     C****If*it*is not it will need converting to back office      E13747 S01177
     C****counterparty nostro shortname.                          E13747  S01177
     C********** *IN65     IFEQ '1'                        B*****  E13747 S01177
     C********** RECI      OREQ '*'                        ******  E13747 S01177
     C**********           MOVE @THEIR    @SNNM2           ******  E13747 S01177
     C**********           MOVEL@THEIR    @SNNM1           ******  E13747 S01177
     C**********                                                   E13747 S01177
     C****Access the file FDSNAMLL, to obtain the 8 letter counte  E13747 S01177
     C****nostro shortname.  If it is not found, this is a databa  E13747 S01177
     C****error.                                                   E13747 S01177
     C********** @SNKEY    CHAINFDSNAMLL             65    ******6 E13747 S01177
     C********** *IN65     IFEQ '1'                        B******7E13747 S01177
     C********** RECI      OREQ '*'                        *******7E13747 S01177
     C**********           MOVE '1'       *INU7            *******7E13747 S01177
     C**********           MOVE '1'       *INU8            *******7E13747 S01177
     C**********           MOVE '1'       *INLR            *******7E13747 S01177
     C**********           MOVE '1'       *INKA            ********E13747 S01177
     C**********           MOVEL'FDSNAMLL'DBFILE           * DBERROE13747 S01177
     C**********           MOVEL@THEIR    DBKEY            ********E13747 S01177
     C**********           MOVE '001'     DBASE            *******7E13747 S01177
     C**********           EXSR #C                         *******7E13747 S01177
     C**********           ELSE                            X******7E13747 S01177
     C**********           MOVE KEY       @8      8        *******7E13747 S01177
     C**********           MOVE *BLANKS   @THEIR           *******7E13747 S01177
     C**********           MOVEL@8        @THEIR           *******7E13747 S01177
     C**********           END                             E******7E13747 S01177
     C**********           END                             E*****6 E13747 S01177
     C**********           END                             E****5  E13747 S01177
     C*------------------------------------------------------------E13747 S01177
     C*****                                                               S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C**  If either of the our or their instructions fields contains      S01177
     C**  'NODEF' fill the field with blanks.                             S01177
     C*****      @OUR      IFEQ 'NODEF'                    B1             S01177
     C*****                MOVE *BLANKS   @OUR             *1             S01177
     C*****                END                             E1             S01177
     C*****      @THEIR    IFEQ 'NODEF'                    B1             S01177
     C*****                MOVE *BLANKS   @THEIR           *1             S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C**  Value date validation which may have been invalidated by        S01177
     C**  by the default settlement method must be repeated.              S01177
     C*****                                                               S01177
     C** Settlement method must not be 01,07 or 08 if value date          S01177
     C** is not a working day in deal currency.                           S01177
     C*****                                                               S01177
     C**  If settlement method is not 01,07,08 and is not a working day inS01177
     C**  deal currency, it is an error.                                  S01177
     C*****      @SMT      IFNE '01'                       B1             S01177
     C*****      @SMT      ANDNE'07'                       *1             S01177
     C*****      @SMT      ANDNE'08'                       *1             S01177
     C*****                                                               S01177
     C**  Find whether the date is a holiday in the deal currency.        S01177
     C*****                MOVE H@CCY     @@CCY   3        *1             S01177
     C*****                Z-ADD@VDYNO    @@MNO   50       *1             S01177
     C*****                EXSR ZA0830                     *1             S01177
     C*****                                                               S01177
     C**  If @@HIND = 'H' then the date is a holiday.                     S01177
     C*****      @@HIND    IFEQ 'H'                        B*2            S01177
     C*****                MOVE '1'       *IN11            **2            S01177
     C*****                MOVE '1'       *IN31            **2            S01177
     C*****                MOVE '1'       *IN41            **2            S01177
     C*****                MOVEL'MMM0578' @MSGID           **2            S01177
     C*****                MOVE *BLANKS   @DATA            **2            S01177
     C*****                MOVEL@SMT      @DATA  45        **2            S01177
     C*****                CALL 'ZA0440'                   **2            S01177
     C*****                PARM           @MSGID           **2            S01177
     C*****                PARM           @DATA            **2            S01177
     C*****                GOTO #ZIA9                      **2            S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C**  If Settlement method is not blank, 0,01,05,07,08 OR NODEF and is not a
     C**  working day in the local currency, it is an error.              S01177
     C*****      @SMT      IFNE *BLANKS                    B1             S01177
     C*****      @SMT      ANDNE'00'                       *1             S01177
     C*****      @SMT      ANDNE'01'                       *1             S01177
     C*****      @SMT      ANDNE'05'                       *1             S01177
     C*****      @SMT      ANDNE'07'                       *1             S01177
     C*****      @SMT      ANDNE'08'                       *1             S01177
     C*****                                                               S01177
     C**  Find whether the date is a holiday in the local currency.       S01177
     C*****                MOVE LOCY      @@CCY            *1             S01177
     C*****                Z-ADD@VDYNO    @@MNO            *1             S01177
     C*****                EXSR ZA0830                     *1             S01177
     C*****                                                               S01177
     C**  If @@HIND = 'H' then the date is a holiday.                     S01177
     C*****      @@HIND    IFEQ 'H'                        B*2            S01177
     C*****                MOVE '1'       *IN31            **2            S01177
     C*****                MOVE '1'       *IN11            **2            S01177
     C*****                MOVE '1'       *IN41            **2            S01177
     C*****                MOVEL'MMM0579' @MSGID           **2            S01177
     C*****                MOVE *BLANKS   @DATA            **2            S01177
     C*****                MOVEL@SMT      @DATA            **2            S01177
     C*****                CALL 'ZA0440'                   **2            S01177
     C*****                PARM           @MSGID           **2            S01177
     C*****                PARM           @DATA            **2            S01177
     C*****                GOTO #ZIA9                      **2            S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C*  *----------------------------*                                   S01177
     C*  * Settlement Type Validation *                                   S01177
     C*  *----------------------------*                                   S01177
     C*****                                                               S01177
     C**  Check to see if the settlement method needs validating          S01177
     C*****                MOVE '0'       *IN69                           S01177
     C*****      @SMT      IFEQ *BLANKS                    B1             S01177
     C*****      ICOITM    ANDEQ'Y'                        B1             S01177
     C*****      @STS      ANDEQ'C'                        B1             S01177
     C*****      @SMT      ORNE *BLANKS                    B1             S01177
     C*****      @STS      ORNE 'C'                        B1             S01177
     C*****                                                               S01177
     C**  Validate the settlement method, it must be one of blank         S01177
     C**  00, 01, 02, 03, 04, 05, 06, 07, 08, 12, or 14                   S01177
     C*****      @SMT      IFNE *BLANKS                    B*2            S01177
     C*****      @SMT      ANDNE'00'                       B*2            S01177
     C*****      @SMT      ANDNE'01'                       B*2            S01177
     C*****      @SMT      ANDNE'02'                       B*2            S01177
     C*****      @SMT      ANDNE'03'                       B*2            S01177
     C*****      @SMT      ANDNE'04'                       B*2            S01177
     C*****      @SMT      ANDNE'05'                       B*2            S01177
     C*****      @SMT      ANDNE'06'                       B*2            S01177
     C*****      @SMT      ANDNE'07'                       B*2            S01177
     C*****      @SMT      ANDNE'08'                       B*2            S01177
     C*****      @SMT      ANDNE'12'                       B*2            S01177
     C*****      @SMT      ANDNE'14'                       B*2            S01177
     C*****                MOVE '1'       *IN69            **2            S01177
     C*****                MOVEL'MMM0211' @MSGID           **2            S01177
     C*****                CALL 'ZA0240'                   **2            S01177
     C*****                PARM           @MSGID           **2            S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  If settlement method is blanks change it to 00.                 S01177
     C*****      @SMT      IFEQ *BLANKS                    B*2            S01177
     C*****                MOVE '00'      @SMT             **2            S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  If settlement type is 04 or 14 and the retail indicator is      S01177
     C**  off on TABTB10, then it is an error.                            S01177
     C*****      @SMT      IFEQ '14'                       B*2            S01177
     C*****      @SMT      OREQ '04'                       B*2            S01177
     C*****                TESTB'2'       MODI1          65**2            S01177
     C*****      *IN65     IFEQ '0'                        B**3           S01177
     C*****                MOVE '1'       *IN69            ***3           S01177
     C*****                MOVEL'MMM0212' @MSGID           ***3           S01177
     C*****                CALL 'ZA0240'                   ***3           S01177
     C*****                PARM           @MSGID           ***3           S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  If the settlement type is 14 and retail account numbers are     S01177
     C**  not supported (Retail Acct. Nos. field on TABTB20 is 'N'),      S01177
     C**  the settlement method is invalid.                               S01177
     C*****      @SMT      IFEQ '14'                       B*2            S01177
     C*****      RACN      ANDEQ'N'                        B*2            S01177
     C*****                MOVE '1'       *IN69            **2            S01177
     C*****                MOVEL'MMM0213' @MSGID           **2            S01177
     C*****                CALL 'ZA0240'                   **2            S01177
     C*****                PARM           @MSGID           **2            S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  If the settlement type is 07, the currency code must be the     S01177
     C**  one for US dollars,as held on FXTB40LL.                         S01177
     C*****      @SMT      IFEQ '07'                       B*2            S01177
     C*****      USCY      ANDNEDDCCY                      B*2            S01177
     C*****                MOVE '1'       *IN69            **2            S01177
     C*****                MOVEL'MMM0214' @MSGID           **2            S01177
     C*****                CALL 'ZA0240'                   **2            S01177
     C*****                PARM           @MSGID           **2            S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C**  If an error occurred, set on reverse image indicators for       S01177
     C**  either the pay or receive method.                               S01177
     C*****      *IN69     IFEQ '1'                        B1             S01177
     C*****                MOVE '1'       *IN31            *1             S01177
     C*****                MOVE '1'       *IN41            *1             S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C****---------------------------*                                    S01177
     C**** Validate Our Instructions *                                    S01177
     C****---------------------------*                                    S01177
     C*****                                                               S01177
     C**  Check to see if any validation is necessary.                    S01177
     C*****                MOVE '0'       *IN69                           S01177
     C*****      @STS      IFEQ 'C'                        B1             S01177
     C*****      ICOITM    ANDEQ'Y'                        B1             S01177
     C*****      @OUR      ANDEQ*BLANKS                    B1             S01177
     C*****      @OUR      ORNE *BLANKS                    B1             S01177
     C*****      @SMT      OREQ '04'                       B1             S01177
     C*****      @STS      ORNE 'C'                        B1             S01177
     C*****                                                               S01177
     C**  If settlement type is 00 or 06, then ours instructions must     S01177
     C**  be blanks.                                                      S01177
     C*****      @SMT      IFEQ '00'                       B*2            S01177
     C*****      @OUR      ANDNE*BLANKS                    B*2            S01177
     C*****      @SMT      OREQ '06'                       B*2            S01177
     C*****      @OUR      ANDNE*BLANKS                    B*2            S01177
     C*****                MOVE '1'       *IN69            **2            S01177
     C*****                MOVEL'MMM0216' @MSGID           **2            S01177
     C*****                CALL 'ZA0240'                   **2            S01177
     C*****                PARM           @MSGID           **2            S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  If the settlement type is 01,02,12,07 or 08, and our            S01177
     C**  instructions are not blanks...                                  S01177
     C*****      @SMT      IFEQ '01'                       B*2            S01177
     C*****      @SMT      OREQ '02'                       B*2            S01177
     C*****      @SMT      OREQ '12'                       B*2            S01177
     C*****      @SMT      OREQ '07'                       B*2            S01177
     C*****      @SMT      OREQ '08'                       B*2            S01177
     C*****      @OUR      IFNE *BLANKS                    B**3           S01177
     C*****                                                               S01177
     C**  If our instructions is not a 2 digit number it is invalid.      S01177
     C*****                Z-ADD2         @@IINT           ***3           S01177
     C*****                Z-ADD0         @@IDP            ***3           S01177
     C*****                MOVE *BLANKS   @@ALPH           ***3           S01177
     C*****                MOVE @OUR      @@ALPH           ***3           S01177
     C*****                EXSR ZA0840                     ***3           S01177
     C*****      @@ERCD    IFNE 0                          B***4          S01177
     C*****                MOVE '1'       *IN69            ****4          S01177
     C*****                MOVEL'MMM0217' @MSGID           ****4          S01177
     C*****                MOVE *BLANKS   @DATA            ****4          S01177
     C*****                MOVEL@SMT      @DATA            ****4          S01177
     C*****                CALL 'ZA0440'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                PARM           @DATA            ****4          S01177
     C*****                ELSE                            X***4          S01177
     C*****                                                               S01177
     C**  If the instructions are valid so far combine them with the      S01177
     C**  deal currency to form a key to the nostro file.                 S01177
     C*****                Z-ADD@@AMT     @TEMP2           ****4          S01177
     C*****                MOVE *BLANKS   @KEY             ****4          S01177
     C*****                MOVE '70'      @KEY1            ****4          S01177
     C*****                MOVELDDCCY     @TEMP3  5        ****4          S01177
     C*****                MOVE @TEMP2    @TEMP3           ****4          S01177
     C*****                MOVE @TEMP3    @KEY             ****4          S01177
     C*****                                                               S01177
     C**  If our instructions are not 00, validate the nostro number.     S01177
     C**  (00 is always valid.)  If no live record is found, this is      S01177
     C**  an error.                                                       S01177
     C*****      @TEMP2    IFNE 00                         B****5         S01177
     C*****      @KEY      CHAINFDTBLILL             65    *****5         S01177
     C*****      *IN65     IFEQ '1'                        B*****6        S01177
     C*****      RECI      ORNE 'D'                        B*****6        S01177
     C*****                MOVE '1'       *IN69            ******6        S01177
     C*****                MOVEL'MMM0218' @MSGID           ******6        S01177
     C*****                MOVE *BLANKS   @DATA            ******6        S01177
     C*****                MOVE @OUR      @TEMT4 15        ******6        S01177
     C*****                MOVELDDCCY     @TEMT4           ******6        S01177
     C*****                MOVEL@TEMT4    @DATA            ******6        S01177
     C*****                CALL 'ZA0440'                   ******6        S01177
     C*****                PARM           @MSGID           ******6        S01177
     C*****                PARM           @DATA            ******6        S01177
     C*****                                                               S01177
     C**  If a live record exists, carry out account checks.  Access      S01177
     C**  the ACCNT file using fields retrieved from the nostro file.     S01177
     C*****                ELSE                            X*****6        S01177
     C*****                Z-ADDCNUM      @ACCNM           ******6        S01177
     C*****                MOVE CCY       @ACCCY           ******6        S01177
     C*****                Z-ADDACOD      @ACCDE           ******6        S01177
     C*****                Z-ADDACSQ      @ACSEQ           ******6        S01177
     C*****                EXSR #ZIAA                      ******6        S01177
     C*****                                                               S01177
     C**  Set up error messages according to the results of the account   S01177
     C**  checks.                                                         S01177
     C*****      @ERCD     IFEQ 1                          B******7       S01177
     C*****                MOVEL'MMM0232' @MSGID           *******7       S01177
     C*****                END                             E******7       S01177
     C*****      @ERCD     IFEQ 2                          B******7       S01177
     C*****                MOVEL'MMM0233' @MSGID           *******7       S01177
     C*****                END                             E******7       S01177
     C*****      @ERCD     IFEQ 3                          B******7       S01177
     C*****                MOVEL'MMM0235' @MSGID           *******7       S01177
     C*****                END                             E******7       S01177
     C*****      @ERCD     IFNE 0                          B******7       S01177
     C*****                MOVE *BLANKS   @DATA            *******7       S01177
     C*****                MOVEL@TEMP3    @DATA            *******7       S01177
     C*****                MOVE '1'       *IN69            *******7       S01177
     C*****                CALL 'ZA0440'                   *******7       S01177
     C*****                PARM           @MSGID           *******7       S01177
     C*****                PARM           @DATA            *******7       S01177
     C*****                ELSE                            X******7       S01177
     C*****                                                               S01177
     C****Set up valid our instructions field.                            S01177
     C*****                Z-ADD@@AMT     @TEMP2  20       *******7       S01177
     C*****                MOVE *BLANKS   @OUR             *******7       S01177
     C*****                MOVEL@TEMP2    @OUR             *******7       S01177
     C*****                END                             E******7       S01177
     C*****                END                             E*****6        S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  If the settlement type is 03, our  instructions must contain    S01177
     C**  either blanks or a 6 digit number.                              S01177
     C*****      @SMT      IFEQ '03'                       B*2            S01177
     C*****      @OUR      ANDNE*BLANKS                    B*2            S01177
     C*****                Z-ADD0         @@IDP            **2            S01177
     C*****                Z-ADD6         @@IINT           **2            S01177
     C*****                MOVE *BLANKS   @@ALPH           **2            S01177
     C*****                MOVE @OUR      @@ALPH           **2            S01177
     C*****                EXSR ZA0840                     **2            S01177
     C*****      @@ERCD    IFEQ 0                          B**3           S01177
     C*****                MOVE *BLANKS   @OUR             ***3           S01177
     C*****                Z-ADD@@AMT     @TEMP5  60       ***3           S01177
     C*****                MOVEL@TEMP5    @OUR             ***3           S01177
     C*****                ELSE                            X**3           S01177
     C*****                MOVE '1'       *IN69            ***3           S01177
     C*****                MOVEL'MMM0219' @MSGID           ***3           S01177
     C*****                CALL 'ZA0240'                   ***3           S01177
     C*****                PARM           @MSGID           ***3           S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  If our instructions for settlement type 04, are not blank and   S01177
     C**  a deal is being inserted, it is an error.                       S01177
     C*****      @SMT      IFEQ '04'                       B*2            S01177
     C*****      DDACTN    IFEQ 'I'                        B**3           S01177
     C*****      @OUR      ANDNE*BLANKS                    B**3           S01177
     C*****      DDACTN    ORNE 'I'                        B**3           S01177
     C*****      DDMORI    ANDNE@MORI                      B**3           S01177
     C*****      DDMORI    ANDNE*BLANKS                    B**3           S01177
     C*****                MOVE '1'       *IN69            ****4          S01177
     C*****                MOVE @MORI     DDMORI           ****4          S01177
     C*****                MOVEL'MMM0220' @MSGID           ****4          S01177
     C*****                CALL 'ZA0240'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                                                               S01177
     C**  Otherwise, perform account checks.                              S01177
     C*****                ELSE                            X***4          S01177
     C*****                Z-ADD@CUST#    @ACCNM           ****4          S01177
     C*****                MOVE DDCCY     @ACCCY           ****4          S01177
     C*****                Z-ADDCADC      @ACCDE           ****4          S01177
     C*****                Z-ADD1         @ACSEQ           ****4          S01177
     C*****                EXSR #ZIAA                      ****4          S01177
     C*****                                                               S01177
     C**  Set up error messages according to the results of the account   S01177
     C**  checks.                                                         S01177
     C*****      @ERCD     IFEQ 1                          B***4          S01177
     C*****                MOVEL'MMM0236' @MSGID           ****4          S01177
     C*****                CALL 'ZA0240'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                END                             E***4          S01177
     C*****                MOVE *BLANKS   @WK25            ***3           S01177
     C*****                MOVEL@ENAM     @WK25            ***3           S01177
     C*****      @ERCD     IFEQ 2                          B***4          S01177
     C*****                MOVEL'MMM0237' @MSGID           ****4          S01177
     C*****                CALL 'ZA0440'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                PARM           @WK25            ****4          S01177
     C*****                END                             E***4          S01177
     C*****      @ERCD     IFEQ 3                          B***4          S01177
     C*****                MOVEL'MMM0239' @MSGID           ****4          S01177
     C*****                CALL 'ZA0440'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                PARM           @WK25            ****4          S01177
     C*****                END                             E***4          S01177
     C*****      @ERCD     IFNE 0                          B***4          S01177
     C*****                MOVE '1'       *IN69            ****4          S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  Validate our instructions for settlement type 05.               S01177
     C*****      @SMT      IFEQ '05'                       B*2            S01177
     C*****                                                               S01177
     C**  Check whether our instructions are a 10 digit number.           S01177
     C*****                Z-ADD10        @@IINT           **2            S01177
     C*****                Z-ADD0         @@IDP            **2            S01177
     C*****                MOVE *BLANKS   @@ALPH           **2            S01177
     C*****                MOVE @OUR      @@ALPH           **2            S01177
     C*****                EXSR ZA0840                     **2            S01177
     C*****                                                               S01177
     C**  If the instructions are valid, reallign the number and set a    S01177
     C**  flag to indicate that they are ten long.                        S01177
     C*****                MOVE @OUR      @X1     2        **2            S01177
     C*****      @@ERCD    IFEQ 0                          B**3           S01177
     C*****      @OUR      ANDNE*BLANKS                    B**3           S01177
     C*****      @X1       ANDEQ*BLANKS                    B**3           S01177
     C*****                MOVE 'Y'       @TEN    1        ***3           S01177
     C*****                Z-ADD@@AMT     @TEND  100       ***3           S01177
     C*****                MOVE *BLANKS   @OUR             ***3           S01177
     C*****                MOVEL@TEND     @OUR             ***3           S01177
     C*****                ELSE                            X**3           S01177
     C*****                                                               S01177
     C**  If the number is not 10 digits long, check whether it is 12     S01177
     C**  long.                                                           S01177
     C*****                Z-ADD0         @@IDP            ***3           S01177
     C*****                MOVE *BLANKS   @@ALPH           ***3           S01177
     C*****                MOVE @OUR      @@ALPH           ***3           S01177
     C*****                Z-ADD12        @@IINT           ***3           S01177
     C*****                EXSR ZA0840                     ***3           S01177
     C*****                                                               S01177
     C**  If the number is twelve digits long, set the ten long flag to   S01177
     C**  'N', and set up the our instructions field.                     S01177
     C*****      @@ERCD    IFEQ 0                          B***4          S01177
     C*****      @OUR      ANDNE*BLANKS                    B***4          S01177
     C*****                MOVE 'N'       @TEN             ****4          S01177
     C*****                Z-ADD@@AMT     @TWLV  120       ****4          S01177
     C*****                MOVE *BLANKS   @OUR             ****4          S01177
     C*****                MOVEL@TWLV     @OUR             ****4          S01177
     C*****                ELSE                            *X**4          S01177
     C*****                                                               S01177
     C**  If the instructions are neither 10 nor 12 digits long, it is    S01177
     C**  an error.                                                       S01177
     C*****                MOVE '1'       *IN69            ****4          S01177
     C*****                MOVEL'MMM0221' @MSGID           ****4          S01177
     C*****                CALL 'ZA0240'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                                                               S01177
     C**  If no error in our instructions has so far been found, access   S01177
     C**  ACCNT file and perform account checks.                          S01177
     C*****      *IN69     IFEQ '0'                        B**3           S01177
     C*****                Z-ADD@CUN      @ACCNM           ***3           S01177
     C*****                MOVE DDCCY     @ACCCY           ***3           S01177
     C*****                Z-ADD@ACD      @ACCDE           ***3           S01177
     C*****      @TEN      IFEQ 'Y'                        B***4          S01177
     C*****      @SEQ      OREQ 0                          ****4          S01177
     C*****                Z-ADD1         @ACSEQ           ****4          S01177
     C*****                ELSE                            X***4          S01177
     C*****                Z-ADD@SEQ      @ACSEQ           ****4          S01177
     C*****                END                             E***4          S01177
     C*****                EXSR #ZIAA                      ***3           S01177
     C*****                                                               S01177
     C**  Set up error messages according to the results of the account   S01177
     C**  checks.                                                         S01177
     C*****      @ERCD     IFEQ 1                          B***4          S01177
     C*****                MOVEL'MMM0256' @MSGID           ****4          S01177
     C*****                END                             E***4          S01177
     C*****      @ERCD     IFEQ 2                          B***4          S01177
     C*****                MOVEL'MMM0257' @MSGID           ****4          S01177
     C*****                END                             E***4          S01177
     C*****      @ERCD     IFEQ 3                          B***4          S01177
     C*****                MOVEL'MMM0259' @MSGID           ****4          S01177
     C*****                END                             E***4          S01177
     C*****      @ERCD     IFNE 0                          B***4          S01177
     C*****                MOVE *BLANKS   @WK35            ****4          S01177
     C*****                MOVE *BLANKS   @T11             ****4          S01177
     C*****                MOVEL@OUR      @T11             ****4          S01177
     C*****                MOVE DDCCY     @T11             ****4          S01177
     C*****                MOVEL@T11      @WK35            ****4          S01177
     C*****                MOVE @ENAM     @WK35            ****4          S01177
     C*****                CALL 'ZA0440'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                PARM           @WK35            ****4          S01177
     C*****                MOVE '1'       *IN69            ****4          S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                                                               S01177
     C**  Validate our instructions for settlement type 14.               S01177
     C*****      @SMT      IFEQ '14'                       B*2            S01177
     C*****                                                               S01177
     C**  If our instructions are blank or the number is not a 10 digit   S01177
     C**  retail account code, then it is invalid.                        S01177
     C*****      @OUR      IFNE *BLANKS                    B**3           S01177
     C*****                Z-ADD10        @@IINT           ***3           S01177
     C*****                Z-ADD0         @@IDP            ***3           S01177
     C*****                MOVE *BLANKS   @@ALPH           ***3           S01177
     C*****                MOVE @OUR      @@ALPH           ***3           S01177
     C*****                EXSR ZA0840                     ***3           S01177
     C*****                END                             E**3           S01177
     C*****                                                               S01177
     C*****      @OUR      IFEQ *BLANKS                    B**3           S01177
     C*****      @@ERCD    ORNE 0                          B**3           S01177
     C*****                MOVE '1'       *IN69            ***3           S01177
     C*****                MOVEL'MMM0222' @MSGID           ***3           S01177
     C*****                CALL 'ZA0240'                   ***3           S01177
     C*****                PARM           @MSGID           ***3           S01177
     C*****                ELSE                            X**3           S01177
     C*****                                                               S01177
     C****Check to see whether the retail account exists.                 S01177
     C*****                Z-ADD@@AMT     @REKEY 100       ***3           S01177
     C*****      @REKEY    CHAINFDRETALL             65    ***3           S01177
     C*****                                                               S01177
     C**  If no live record exists, it is an error.                       S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****      RECI      OREQ '*'                        B***4          S01177
     C*****                MOVE '1'       *IN69            ****4          S01177
     C*****                MOVEL'MMM0223' @MSGID           ****4          S01177
     C*****                MOVE *BLANKS   @DATA            ****4          S01177
     C*****                MOVEL@REKEY    @DATA            ****4          S01177
     C*****                CALL 'ZA0440'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                PARM           @DATA            ****4          S01177
     C*****                ELSE                            X***4          S01177
     C*****                                                               S01177
     C**  Check the currency of the account equals the deal currency.     S01177
     C*****      CCY       IFNE DDCCY                      B****5         S01177
     C*****                MOVE '1'       *IN69            *****5         S01177
     C*****                MOVE *BLANKS   @DATA            ****4          S01177
     C*****                MOVEL@REKEY    @DATA            ****4          S01177
     C*****                MOVEL'MMM0224' @MSGID           *****5         S01177
     C*****                CALL 'ZA0440'                   *****5         S01177
     C*****                PARM           @MSGID           *****5         S01177
     C*****                PARM           @DATA            *****5         S01177
     C*****                ELSE                            X****5         S01177
     C*****                                                               S01177
     C**  If the instructions are valid so far, perform account checks.   S01177
     C**  The flag @RET is set to 'Y' to prevent ACCNT being reread.      S01177
     C** set on the retail account read indicator                         S01177
     C*****                MOVE 'Y'       @RET    1        *****5         S01177
     C*****                EXSR #ZIAA                      *****5         S01177
     C*****                MOVE 'N'       @RET             *****5         S01177
     C*****                                                               S01177
     C**  Set up error messages according to the results of the account   S01177
     C**  checks.                                                         S01177
     C*****                MOVE *BLANKS   @WK30            *****5         S01177
     C*****      @ERCD     IFEQ 1                          B*****6        S01177
     C*****                MOVEL'MMM0240' @MSGID           ******6        S01177
     C*****                MOVE @@AMT     @WK10            ******6        S01177
     C*****                MOVEL@WK10     @WK30            ******6        S01177
     C*****                END                             E*****6        S01177
     C*****      @ERCD     IFEQ 2                          B*****6        S01177
     C*****                MOVEL'MMM0241' @MSGID           ******6        S01177
     C*****                MOVE @@AMT     @WK10            ******6        S01177
     C*****                MOVEL@WK10     @WK30            ******6        S01177
     C*****                MOVE @ENAM     @WK30            ******6        S01177
     C*****                END                             E*****6        S01177
     C*****      @ERCD     IFEQ 3                          B*****6        S01177
     C*****                MOVEL'MMM0243' @MSGID           ******6        S01177
     C*****                MOVEL@ENAM     @WK30            ******6        S01177
     C*****                END                             E*****6        S01177
     C*****      @ERCD     IFNE 0                          B*****6        S01177
     C*****                MOVE '1'       *IN69            ******6        S01177
     C*****                CALL 'ZA0440'                   ******6        S01177
     C*****                PARM           @MSGID           ******6        S01177
     C*****                PARM           @WK30            ******6        S01177
     C*****                END                             E*****6        S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C**  If any errors have occurred in the validation of our instr-     S01177
     C**  uctions set up the relevant fields to be in reverse image.      S01177
     C*****      *IN69     IFEQ '1'                        B1             S01177
     C*****                MOVE '1'       *IN33            *1             S01177
     C*****                MOVE '1'       *IN41            *1             S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C****-----------------------------*                                  S01177
     C**** Validate Their Instructions *                                  S01177
     C****-----------------------------*                                  S01177
     C*****                                                               S01177
     C*****                MOVE '0'       *IN69                           S01177
     C*****                MOVE '0'       *IN65                           S01177
     C*****                                                               S01177
     C**  Check to see if any validation is necessary.                    S01177
     C*****      @THEIR    IFEQ *BLANKS                    B1             S01177
     C*****      @STS      ANDEQ'C'                        *1             S01177
     C*****      ICCITM    ANDEQ'Y'                        *1             S01177
     C*****      @THEIR    ORNE *BLANKS                    *1             S01177
     C*****      @STS      ORNE 'C'                        *1             S01177
     C*****                                                               S01177
     C**  If the settlement type is not 01,07,08 and their settlement     S01177
     C**  instructions are not blank, it is an error.                     S01177
     C*****      @THEIR    IFNE *BLANKS                    B*2            S01177
     C*****      @SMT      IFNE '01'                       B**3           S01177
     C*****      @SMT      ANDNE'07'                       B**3           S01177
     C*****      @SMT      ANDNE'08'                       B**3           S01177
     C*****                MOVE '1'       *IN35            ***3           S01177
     C*****                MOVEL'MMM0226' @MSGID           ***3           S01177
     C*****                CALL 'ZA0240'                   ***3           S01177
     C*****                PARM           @MSGID           ***3           S01177
     C*****                MOVE '1'       *IN41            ***3           S01177
     C*****                ELSE                            X**3           S01177
     C*****                                                               S01177
     C**  If the field contains 6 numeric characters, then use the        S01177
     C**  customer number to chain to CLINT.                              S01177
     C*****                Z-ADD0         @@IDP            ***3           S01177
     C*****                Z-ADD6         @@IINT           ***3           S01177
     C*****                MOVE *BLANKS   @@ALPH           ***3           S01177
     C*****                MOVE @THEIR    @@ALPH           ***3           S01177
     C*****                EXSR ZA0840                     ***3           S01177
     C*****      @@ERCD    IFEQ 0                          B***4          S01177
     C*****                Z-ADD@@AMT     @CNUM            ****4          S01177
     C*****      @CLTKY    CHAINCLINT                65    ****4          S01177
     C*****      RECI      IFNE 'D'                        B****5         S01177
     C*****                MOVE '1'       *IN65            *****5         S01177
     C*****                END                             E****5         S01177
     C*****      *IN65     IFEQ '0'                        B****5         S01177
     C*****                MOVE *BLANKS   @THEIR           *****5         S01177
     C*****                MOVEL@CNUM     @THEIR           *****5         S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C**  If the field is not 6 numeric characters, then try to access    S01177
     C**  SNAME using the field as a shortname.                           S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****      @@ERCD    ORNE 0                          B***4          S01177
     C*****      @THEIR    CHAINSNAME                65    ****4          S01177
     C*****      RECI      IFNE 'D'                        B****5         S01177
     C*****                MOVE '1'       *IN65            *****5         S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C**  If the field is not a valid key for either of the files         S01177
     C**  accessed so far, and the settlement type is 01, use the         S01177
     C**  first 8 chars. as a key to FDCPTILL.                            S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****      @SMT      ANDEQ'01'                       B***4          S01177
     C*****                MOVE *BLANKS   @KEY             ****4          S01177
     C*****                MOVE '71'      @KEY1            ****4          S01177
     C*****                MOVEL@THEIR    @8               ****4          S01177
     C*****                MOVE @8        @KEY             ****4          S01177
     C*****      @KEY      CHAINFDCPTILL             65    ****4          S01177
     C*****      RECI      IFNE 'D'                        B****5         S01177
     C*****                MOVE '1'       *IN65            *****5         S01177
     C*****                END                             E****5         S01177
     C*****      *IN65     IFEQ '0'                        B****5         S01177
     C*****                MOVELCSN1      CSNM             *****5         S01177
     C*****                MOVE CSN2      CSNM             *****5         S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C**  If the field is not a valid key for any of the three files      S01177
     C**  accessed so far, this is an error.                              S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****      @SMT      IFEQ '01'                       B****5         S01177
     C*****                MOVEL'MMM0227' @MSGID           *****5         S01177
     C*****                ELSE                            X****5         S01177
     C*****                MOVEL'MMM0228' @MSGID           *****5         S01177
     C*****                END                             E****5         S01177
     C*****                CALL 'ZA0240'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C**  If a customer settlement nostro has been found must check       S01177
     C**  that it has the correct location code for the deal currency.    S01177
     C*****      *IN65     IFEQ '0'                        B***4          S01177
     C**********           MOVE CSNM      @NSCNO           ****4  E14363  S01177
     C**********           MOVE DDCCY     @NSCCY           ****4   E14363 S01177
     C********** @NSPKY    CHAINFDNOSTLL             65    ****4   E14363 S01177
     C********** *IN65     IFEQ '1'                        B****5  E14363 S01177
     C********** RECI      ORNE 'D'                        B****5  E14363 S01177
     C**********           MOVE '1'       *IN69            *****5  E14363 S01177
     C**********           MOVEL'MMM0218' @MSGID           *****5  E13873 E14363
     C**********           MOVEL'MMM0284' @MSGID           *****5  E13873 E14363
     C**********           MOVE *BLANKS   @DATA            *****5  E14363 S01177
     C**********           MOVE @THEIR    @TEMT5 13        *****5  E14363 S01177
     C**********           MOVELDDCCY     @TEMT5           *****5  E14363 S01177
     C**********           MOVEL@TEMT5    @DATA            *****5  E14363 S01177
     C**********           CALL 'ZA0440'                   *****5  E14363 S01177
     C**********           PARM           @MSGID           *****5  E14363 S01177
     C**********           PARM           @DATA            *****5  E14363 S01177
     C**********           END                             E****5  E14363 S01177
     C*****                MOVE CSNM      @LCOD   3        ****4   E14363 S01177
     C*****      @LCOD     CHAINFDLCY1LL             60    ****4   E14363 S01177
     C*****                                                        E14363 S01177
     C**  If the chain fails or RECI is not 'D' then it is a data E14363  S01177
     C**  error.                                                   E14363 S01177
     C*****      *IN60     IFEQ '1'                        B****5  E14363 S01177
     C*****      RECI      ORNE 'D'                        *****5  E14363 S01177
     C*****                MOVE '1'       *INU7            *****5  E14363 S01177
     C*****                MOVE '1'       *INU8            ********E14363 S01177
     C*****                MOVEL'FDLCY1LL'DBFILE           * DBEROR 009 *E14363
     C*****                MOVEL@LCOD     DBKEY            ********E14363 S01177
     C*****                MOVE '009'     DBASE            *****5  E14363 S01177
     C*****                MOVE '1'       *INLR            *****5  E14363 S01177
     C*****                MOVE '1'       *INKA            *****5  E14363 S01177
     C*****                DUMP                            *****5  E14363 S01177
     C*****                GOTO #ZIA9                      *****5  E14363 S01177
     C*****                END                             E****5  E14363 S01177
     C*****                                                        E14363 S01177
     C**  Compare deal currency with location code currency.       E14363 S01177
     C*****      DDCCY     IFNE LCLCCY                     B****5  E14363 S01177
     C*****                MOVE '1'       *IN65            *****5  E14363 S01177
     C*****                END                             E****5  E14363 S01177
     C*****                                                        E14363 S01177
     C*****      *IN65     IFEQ '1'                        B****5  E14363 S01177
     C*****                MOVE '1'       *IN69            *****5  E14363 S01177
     C*****                MOVEL'MMM0284' @MSGID           *****5  E14363 S01177
     C*****                MOVE *BLANKS   @DATA            *****5  E14363 S01177
     C*****                MOVE @THEIR    @TEMT5 13        *****5  E14363 S01177
     C*****                MOVELDDCCY     @TEMT5           *****5  E14363 S01177
     C*****                MOVEL@TEMT5    @DATA            *****5  E14363 S01177
     C*****                CALL 'ZA0440'                   *****5  E14363 S01177
     C*****                PARM           @MSGID           *****5  E14363 S01177
     C*****                PARM           @DATA            *****5  E14363 S01177
     C*****                END                             E****5  E14363 S01177
     C*****                                                               S01177
     C*****                END                             E***4          S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****                MOVE '1'       *IN35            ****4          S01177
     C*****                MOVE '1'       *IN41            ****4          S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C****-------------------------*                                      S01177
     C**** Validate For Account Of *                                      S01177
     C****-------------------------*                                      S01177
     C******                                                              S01177
     C**  If the 'Pay' instructions are being validated, and the for      S01177
     C**  account of field is not blank, validate the field.              S01177
     C*****      @PRIND    IFEQ 'P'                        B1             S01177
     C*****      @FORAC    IFNE *BLANKS                    B*2            S01177
     C*****                                                               S01177
     C**  If the pay method is not 01,07 or 08, it is an error.           S01177
     C*****      @SMT      IFNE '01'                       B**3           S01177
     C*****      @SMT      ANDNE'07'                       B**3           S01177
     C*****      @SMT      ANDNE'08'                       B**3           S01177
     C*****                MOVE '1'       *IN37            ***3           S01177
     C*****                MOVE '1'       *IN41            ***3           S01177
     C*****                MOVEL'MMM0231' @MSGID           ***3           S01177
     C*****                CALL 'ZA0240'                   ***3           S01177
     C*****                PARM           @MSGID           ***3           S01177
     C*****                ELSE                            X**3           S01177
     C*****                                                               S01177
     C**  If the for account of field is 6 numeric characters, use it     S01177
     C**  to chain to CLINT.                                              S01177
     C*****                Z-ADD0         @@IDP            ***3           S01177
     C*****                Z-ADD6         @@IINT           ***3           S01177
     C*****                MOVE *BLANKS   @@ALPH           ***3           S01177
     C*****                MOVE @FORAC    @@ALPH           ***3           S01177
     C*****                EXSR ZA0840                     ***3           S01177
     C*****      @@ERCD    IFEQ 0                          B***4          S01177
     C*****                Z-ADD@@AMT     @CNUM            ****4          S01177
     C*****      @CLTKY    CHAINCLINT                65    ****4          S01177
     C*****      RECI      IFNE 'D'                        B****5         S01177
     C*****                MOVE '1'       *IN65            *****5         S01177
     C*****                END                             E****5         S01177
     C*****      *IN65     IFEQ '0'                        B****5         S01177
     C*****                MOVE *BLANKS   @FORAC           *****5         S01177
     C*****                MOVEL@CNUM     @FORAC           *****5         S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C****If the field is not 6 numeric characters, then try to access    S01177
     C**  SNAME using the field as a shortname.                           S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****      @@ERCD    ORNE 0                          B***4          S01177
     C*****      @FORAC    CHAINSNAME                65    ****4          S01177
     C*****      RECI      IFNE 'D'                        B****5         S01177
     C*****                MOVE '1'       *IN65            *****5         S01177
     C*****                END                             E****5         S01177
     C*****      *IN65     IFEQ '0'                        B****5         S01177
     C*****                MOVE *BLANKS   @FORAC           *****5         S01177
     C*****                MOVELCNUM      @FORAC           *****5         S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C**  If the field is not a valid key for either of the files         S01177
     C**  accessed so far, and the settlement type is 01, use the         S01177
     C**  first 8 chars. as a key to FDCPTILL.                            S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****      @SMT      ANDEQ'01'                       B***4          S01177
     C*****                MOVE *BLANKS   @KEY             ****4          S01177
     C*****                MOVE '71'      @KEY1            ****4          S01177
     C*****                MOVEL@FORAC    @8      8        ****4          S01177
     C*****                MOVE @8        @KEY             ****4          S01177
     C*****      @KEY      CHAINFDCPTILL             65    ****4          S01177
     C*****      RECI      IFNE 'D'                        B****5         S01177
     C*****                MOVE '1'       *IN65            *****5         S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                                                               S01177
     C**  If the field is not a valid key for any of the three files      S01177
     C**  accessed so far, this is an error.                              S01177
     C*****      *IN65     IFEQ '1'                        B***4          S01177
     C*****      @SMT      IFEQ '01'                       B****5         S01177
     C*****                MOVEL'MMM0229' @MSGID           *****5         S01177
     C*****                ELSE                            X****5         S01177
     C*****                MOVEL'MMM0230' @MSGID           *****5         S01177
     C*****                END                             E****5         S01177
     C*****                CALL 'ZA0240'                   ****4          S01177
     C*****                PARM           @MSGID           ****4          S01177
     C*****                MOVE '1'       *IN41            ****4          S01177
     C*****                MOVE '1'       *IN37            ****4          S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C*****      #ZIA9     ENDSR                           **#ZIA9**      S01177
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C********                                                        *
     C**#ZIAA*   -  Perform account checks                            *   S01177
     C********                                                        *   S01177
     C**CALLS*            -                                           *   S01177
     C********                                                        *   S01177
     C**CALL*D BY  #ZIA   - validates the settlement instructions     *   S01177
     C********                                                        *   S01177
     C**FLDS*USED  @ERCD  - error code for accounts                   *   S01177
     C********     @RET   - Flag to indicate whether to access ACCNT. *   S01177
     C********     @ACKEY - ACCNT key                                 *   S01177
     C********     @WK5   - work field                                *   S01177
     C********     @EDAT  - Event date                                *   S01177
     C********                                                        *   S01177
     C*****************************************************************   S01177
     C*****      #ZIAA     BEGSR                                          S01177
     C*****                                                               S01177
     C****Initialise the error code to 0.                                 S01177
     C*****                Z-ADD0         @ERCD   10                      S01177
     C*****                                                               S01177
     C****Access the ACCNT file, if it has not been accessed already.     S01177
     C*****      @RET      IFNE 'Y'                        B1             S01177
     C*****      @ACKEY    CHAINACCNT                65    *1             S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C****If the account is not live or not found, return error 1.        S01177
     C*****      *IN65     IFEQ '1'                        B1             S01177
     C*****      @RET      ANDNE'Y'                        B1             S01177
     C*****      RECI      ORNE 'D'                        B1             S01177
     C*****      @RET      ANDNE'Y'                        B1             S01177
     C*****                Z-ADD1         @ERCD            *1             S01177
     C*****                ELSE                            X1             S01177
     C*****                                                               S01177
     C****If the account is retail.                                       S01177
     C*****      ATYP      IFEQ 'R'                        B*2            S01177
     C*****                                                               S01177
     C****If the event date is earlier than the date the account was      S01177
     C****opened, then it is an error.                                    S01177
     C*****      @EDAT     IFLT DACO                       B**3           S01177
     C*****                Z-ADD2         @ERCD            ***3           S01177
     C*****                GOTO #ZIAA9                     ***3           S01177
     C*****                END                             E**3           S01177
     C*****                                                               S01177
     C****If the event date of the deal is less than the run date minus   S01177
     C****the back value limit period number of days then it is an        S01177
     C****it is an error.                                                 S01177
     C*****      RUND      SUB  BVLP      @WK5    50       **2            S01177
     C*****      @EDAT     IFLT @WK5                       B**3           S01177
     C*****                Z-ADD3         @ERCD            ***3           S01177
     C*****                END                             E**3           S01177
     C*****                END                             E*2            S01177
     C*****                END                             E1             S01177
     C*****                                                               S01177
     C*****      #ZIAA9    ENDSR                           **#ZIAA9**     S01177
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZO      - Validate deal number and action code.              *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          #ZE      - clear screen                              *
     C*          #ZEA     - Clear standard deal                       *   E18139
     C*          ZA0270   - Convert and validate deal number to date. *
     C*          #ZOA     - Check valid deal for key fields
     C*          #ZOB - Check non-amendable fields have not changed   *
     C*          ZA0840   - Validate/reformat input amount            *
     C*          #ZQ      - Check deal amendment principle            *
     C*                                                               *
     C* CALLED BY  #BD    - enter processing                          *
     C*                                                               *
     C* FLDS USED  @DLNO  - stored deal number                        *
     C*            @AUTO  - auto deal number flag                     *
     C*            @MSGID - message id                                *
     C*            @DLKEY - deal file key                             *
     C*            @TEST  - Workfield to test numeric                 *
     C*            @DAT   - 6N date for ZA0270                        *
     C*            @RTCDE - 1A return code for ZA0270                 *
     C*            @VDYNO - value date                                *
     C*            @KVALD - Key field  : value date                   *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @DSPM  - Month frm screen field : value date       *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @VDYY  - Value date : year                         *
     C*            @VDMM  - Value date : month                        *
     C*            @VDDD  - Value date : day                          *
     C*            @KSEQN - Sequence number key field                 *
     C*            @DMKEY - Key to deams file                         *
     C*            @KEY   - key for table files                       *
     C*            @N     - Index to deal types array                 *
     C*            @DT2   - Midas deal types array                    *
     C*            @@ALPH - 16A field containing field to validate    *
     C*            @@IDP  - number of decimal places                  *
     C*            @@IINT - number of integers                        *
     C*            @@ALPH - 16A field for display                     *
     C*            @@AMT  - 15N field for calculation                 *
     C*            @@ERCD - 1N error code                             *
     C*            @@ALPH - 16A field containing field to validate    *
     C*            @@IDP  - number of decimal places                  *
     C*            @@IINT - number of integers                        *
     C*            @@ALPH - 16A field for display                     *
     C*            @@AMT  - 15N field for calculation                 *
     C*            @@ERCD - 1N error code                             *
     C*            @TDLA  - This  deam amount                         *
     C*            @WK11  - Workfield                                 *
     C*            @WK22  -     "                                     *
     C*            @WK33  -     "                                     *
     C*            @WK44  -     "                                     *
     C*                                                               *
     C*****************************************************************
     C           #ZO       BEGSR
     C                     MOVE '0'       *IN38
     C                     MOVE '0'       *IN39                           BHF632
     C*
     C*  *------------------------*
     C*  * Preliminary Validation *
     C*  *------------------------*
     C*
     C**  If the action code is not 'I', or the deal number has
     C**  changed, set off the auto deal number indicator so that
     C**  validation is not by-passed.
     C           DDACTN    IFNE 'I'                        B1
     C           DDDLNO    ORNE @DLNO                      B1
     C                     MOVE 'N'       @AUTO   1        *1
     C                     END                             E1
     C*
     C/COPY WNCPYSRC,MM0028CP30                                           S01408
     C**  If the auto deal number indicator is 'Y', the action code is
     C**  valid and the deal no. has been generated; by-pass
     C**  preliminary validation.
     C           @AUTO     CABEQ'Y'       #ZO9
     C*
     C**  Check that the action code is valid; if authorizations are
     C**  not in the system, then action code X is not allowed.
     C***********H1BOAR****IFEQ*'N'************************B1*************S01319
     C           BNMMAU    IFEQ 'N'                        B1             S01319
     C           DDACTN    ANDNE*BLANK                     B1
     C           DDACTN    ANDNE'I'                        B1
     C           DDACTN    ANDNE'A'                        B1
     C           DDACTN    ANDNE'D'                        B1
     C           DDACTN    ANDNE'E'                        B1
     C           DDACTN    ANDNE*BLANK                     B1
     C                     MOVE '1'       *IN01            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0161' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C***********H1BOAR****IFNE*'N'************************B1*************S01319
     C           BNMMAU    IFNE 'N'                        B1             S01319
     C           DDACTN    ANDNE*BLANK                     B1
     C           DDACTN    ANDNE'I'                        B1
     C           DDACTN    ANDNE'A'                        B1
     C           DDACTN    ANDNE'D'                        B1
     C           DDACTN    ANDNE'E'                        B1
     C           DDACTN    ANDNE'X'                        B1
     C                     MOVE '1'       *IN01            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0160' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C**  The action code defaults to E if blank.
     C           DDACTN    IFEQ *BLANK                     B1
     C                     MOVE 'E'       DDACTN           *1
     C                     END                             E1
     C*
     C****If*the*user*is*not*an*authorizations*officer*and*action*code****S01319
     C****is*X*it*is*an*error.********************************************S01319
     C***********DDACTN****IFEQ*'X'************************B1*************S01319
     C***********IQMMAO****ANDEQ'N'************************B1*************S01319
     C*********************MOVE*'1'********IN01*************1*************S01319
     C*********************MOVE*'1'********IN41*************1*************S01319
     C*********************MOVEL'MMM0175'*@MSGID************1*************S01319
     C*********************CALL*'ZA0240'********************1*************S01319
     C*********************PARM***********@MSGID************1*************S01319
     C*********************END*****************************E1*************S01319
     C********************************************************************S01319
     C****If*the*user*is*not*a*settlements*officer*and*the*action*code****S01319
     C****is*I,A*or*D,*it*is*an*error.************************************S01319
     C***********DDACTN****IFEQ*'I'************************B1*************S01319
     C***********IQMMSO****ANDEQ'N'************************B1*************S01319
     C***********DDACTN****OREQ*'D'************************B1*************S01319
     C***********IQMMSO****ANDEQ'N'************************B1*************S01319
     C***********DDACTN****OREQ*'A'************************B1*************S01319
     C***********IQMMSO****ANDEQ'N'************************B1*************S01319
     C*********************MOVE*'1'********IN01*************1*************S01319
     C*********************MOVE*'1'********IN41*************1*************S01319
     C*********************MOVEL'MMM0176'*@MSGID************1*************S01319
     C*********************CALL*'ZA0240'********************1*************S01319
     C*********************PARM***********@MSGID************1*************S01319
     C*********************END*****************************E1*************S01319
     C*
     C**  Validate that key fields are numeric or blank.
     C*
     C**  Validate that deal number is numeric & not blank.
     C                     TESTN          DDDLNO     6263
     C                     MOVE DDDLNO    @TEST   1
     C                     TESTZ          @TEST          73
     C*
     C**  If it is set up the file key, otherwise output an error message.
     C           *IN62     IFEQ '1'                        B1
     C           *IN73     ANDEQ'1'                        X1
     C*
     C           *IN63     OREQ '1'                        X1
     C           *IN73     ANDEQ'1'                        X1
     C*
     C                     MOVE DDDLNO    @DLKEY           *1
     C                     ELSE                            X1
     C                     MOVEL'MMM0145' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     MOVE '1'       *IN02            *1
     C                     MOVE '1'       *IN41            *1
     C                     END                             E1
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS2                                           S01408
     C*                                                                   S01408
     C**  Validate that the value date is a valid date
     C           DDVDAT    IFNE *BLANKS                    B1
     C                     TESTN          DDVDAT     6263  *1
     C                     MOVE DDVDAT    @TEST            *1
     C                     TESTZ          @TEST          73*1
     C           *IN62     IFEQ '1'                        B*2
     C           *IN73     ANDEQ'1'                        **2
     C           *IN63     OREQ '1'                        **2
     C           *IN73     ANDEQ'1'                        **2
     C                     MOVELDDVDAT    @DAT             **2
     C                     CALL 'ZA0270'                   **2
     C                     PARM           @DAT    60       **2
     C*****                PARM           DATF             **2    *****   S01194
     C                     PARM           BJDFIN           **2            S01194
     C                     PARM           @RTCDE  1        **2
     C                     PARM           @VDYNO  50       **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If the return code is 1 then the input date is invalid or
     C**  non-numeric.
     C           @RTCDE    IFEQ '1'                        B1
     C*
     C           DDVDAT    OREQ *BLANKS                    B1
     C*
     C           *IN73     OREQ '0'                        B1
     C*
     C           *IN62     OREQ '0'                        B1
     C           *IN63     ANDEQ'0'                        B1
     C*
     C                     MOVE '1'       *IN11            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0125' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     ELSE                            X1
     C*
     C** Load value date to numeric keyfield,in YYYYMMDD format
     C                     Z-ADD0         @KVALD           *1
     C                     MOVE @DSPY     @VYEAR           *1
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPD     @VDDD            *1
     C                     ELSE                                           BHF183
     C                     MOVE @DSPD     @VDMM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPM     @VDMM            *1
     C                     ELSE                                           BHF183
     C                     MOVE @DSPM     @VDDD                           BHF183
     C                     END                                            BHF183
     C*
     C** Century
     C           @VYEAR    IFGE 72                         B*2
     C           @VDYY     ADD  1900      @VDYY            **2
     C                     ELSE                            **2
     C           @VDYY     ADD  2000      @VDYY            **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C** Sequence no. must be numeric if entered
     C           DDDS38    IFNE *BLANKS                    B1
     C*
     C                     TESTN          DDDS38     6263  *1
     C                     MOVE DDDS38    @TEST            *1
     C                     TESTZ          @TEST          73*1
     C                     END                             E1
     C*
     C           DDDS38    IFEQ *BLANKS                    B1
     C*
     C           *IN62     OREQ '1'                        B1
     C           *IN73     ANDEQ'1'                        B1
     C*
     C           *IN73     OREQ '1'                        B1
     C           *IN63     ANDEQ'1'                        B1
     C*
     C           DDDS38    IFEQ *BLANKS                    B*2
     C                     MOVE *LOVAL    @KSEQN           **2
     C                     ELSE                            X*2
     C                     MOVE DDDS38    @KSEQN           **2
     C                     END                             E*2
     C*
     C                     ELSE                            X1
     C*
     C                     MOVE '1'       *IN15            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0196' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C** If action code is 'I' sequence no. NOT needed otherwise sequence
     C** number must be entered
     C           DDACTN    IFNE 'I'                        B1
     C           DDDS38    ANDEQ*BLANKS                    *1
     C*
     C           DDACTN    OREQ 'I'                        *1
     C           DDDS38    ANDNE*BLANKS                    *1
     C                     MOVE '1'       *IN15            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0146' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     END                             E1
     C*
     C**  Carry out no further validation if errors occurred.
     C           *IN41     CABEQ'1'       #ZO8
     C*
     C**  Set up the deal number as a numeric field.
     C                     MOVE DDDLNO    @DLKEY
     C                     MOVE DDDS38    @KSEQN
     C*
     C** Load value date to numeric keyfield,in YYYYMMDD format
     C                     Z-ADD0         @KVALD
     C                     MOVE @DSPY     @VYEAR
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPD     @VDDD
     C                     ELSE                                           BHF183
     C                     MOVE @DSPD     @VDMM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPM     @VDMM
     C                     ELSE                                           BHF183
     C                     MOVE @DSPM     @VDDD                           BHF183
     C                     END                                            BHF183
     C*
     C** Century
     C           @VYEAR    IFGE 72                         B1
     C           @VDYY     ADD  1900      @VDYY            *1
     C                     ELSE                            X1
     C           @VDYY     ADD  2000      @VDYY            *1
     C                     END                             E1
     C*
     C*  *--------------------------------*
     C*  * Validation for Action Code 'E' *
     C*  *--------------------------------*
     C*
     C           DDACTN    IFEQ 'E'                        B1
     C*
     C**  If there is no valid record on MMDEAMLL, it is an error.
     C           @DMKEY    CHAINMMDEAMLL             65    *1
     C           *IN65     IFEQ '1'                        B*2
     C           HNDLTF    ORNE ' '                        B*2
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN15            **2
     C                     MOVE '1'       *IN41            **2
     C/COPY WNCPYSRC,MM0028C024
     C                     MOVEL'MMM0157' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     ELSE                            X*2
     C*
     C**  If the deal status is not C,A or R, it is an error.
     C           HNDSTS    IFNE 'C'                        B**3
     C           HNDSTS    ANDNE'A'                        ***3
     C           HNDSTS    ANDNE'R'                        ***3
     C                     MOVE '1'       *IN02            ***3
     C                     MOVE '1'       *IN15            ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN41            ***3
     C/COPY WNCPYSRC,MM0028C025
     C                     MOVEL'MMM0148' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     GOTO #ZO8                       ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C*  *--------------------------------*
     C*  * Validation for Action Code 'X' *
     C*  *--------------------------------*
     C*
     C           DDACTN    IFEQ 'X'                        B1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS3                                           S01408
     C*                                                                   S01408
     C* CHECK IF PREVIOUS DEAMS ARE AUTHORISED OR DELETED                 073682
     C*                                                                   073682
     C           @DMKEY    SETLLMMDEAMLL             65                   073682
     C           @DLKEY    REDPEMMDEAMLL                 65               073682
B2   C           *IN65     DOWEQ'0'                                       073682
B3   C           HNDSTS    IFNE 'A'                                       073682
     C           HNDDLT    ANDEQ' '                                       073682
     C                     MOVE '1'       *IN02                           073682
     C                     MOVE '1'       *IN15                           073682
     C                     MOVE '1'       *IN11                           073682
     C                     MOVE '1'       *IN41                           073682
     C                     MOVEL'MMM015A' @MSGID                          073682
     C                     CALL 'ZA0240'                                  073682
     C                     PARM           @MSGID                          073682
     C                     GOTO #ZO8                                      073682
X3   C                     ELSE                                           073682
     C           @DLKEY    REDPEMMDEAMLL                 65               073682
E3   C                     ENDIF                                          073682
E2   C                     ENDDO                                          073682
     C*
     C**  If there is no valid, undeleted record on MMDEAMLL, it is an
     C**  error.
     C           @DMKEY    CHAINMMDEAMLL             65    *1
     C           *IN65     IFEQ '1'                        B*2
     C/COPY WNCPYSRC,MM0028C044
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN15            ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0147' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*******              GOTO #ZO8                       **2            047741
     C                     GOTO #ZO9                       **2            047741
     C                     END                             E*2
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP18                                           S01408
     C*                                                                   S01408
     C*
     C** PROCESS MMP0081
     C** Check deal amendment is valid for authorization
     C           HNDDLT    IFNE *BLANK                     **2
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS4                                           S01408
     C*                                                                   S01408
     C           HNDLTF    ORNE *BLANK                     **2
     C/COPY WNCPYSRC,MM0028C045
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN15            ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0147' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*******              GOTO #ZO8                       **2            047741
     C                     GOTO #ZO9                       **2            047741
     C                     END                             E*2
     C*
     C** Deam status indicator  must be 'C' or 'R'
     C           HNDSTS    IFNE 'C'                        B*2
     C           HNDSTS    ANDNE'R'                        **2
     C/COPY WNCPYSRC,MM0028C046
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN15            ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0290' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*******              GOTO #ZO8                       **2            047741
     C                     GOTO #ZO9                       **2            047741
     C                     END                             E*2
     C*
     C** Related deal status indicator must not be 'A' or 'R'
     C           HNDA38    CHAINMMDEALLL             65
     C           *IN65     IFEQ '1'                        B*2
     C                     MOVE '1'       *INLR            **2
     C                     MOVE '1'       *INU7            **2
     C                     MOVE '1'       *INU8            **2
     C                     MOVE '1'       *INKC            ***************
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 002 *
     C*********************MOVEL@KEY      DBKEY            ***************E276
     C                     MOVELHNDA38    DBKEY            ***************E276
     C                     MOVE '002'     DBASE            **2
     C                     EXSR #C                         **2
     C                     END                             E*2
     C*
     C           H@DSTS    IFNE 'A'                        B*2
     C           H@DSTS    ANDNE'R'                        **2
     C/COPY WNCPYSRC,MM0028C047
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0173' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*******              GOTO #ZO8                       **2            047741
     C                     GOTO #ZO9                       **2            047741
     C                     END                             E*2
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP22                                           S01408
      *                                                                   S01408
     C                     END                             E1
     C*
     C****************************************************
     C*  Insert,amend,delete processing : Level 1 checks *
     C****************************************************
     C*
     C*  *--------------------------------*
     C*  * Validation for Action Code 'I' *
     C*  *--------------------------------*
     C**
     C*
     C**  Validate the action code and deal no. for action code 'I',
     C           DDACTN    IFEQ 'I'                        B1
     C*
     C**  Check that the deal does not exist on the
     C**  MMDEAMLL file; if it does it is an error.
     C           @DMKEY    CHAINMMDEAMLL             65    *1
     C           *IN65     IFEQ '0'                        B*2
     C*
     C** Record already exists
     C           HNDLTF    IFEQ *BLANKS                    B**3
     C/COPY WNCPYSRC,MM0028C048
     C                     MOVE '1'       *IN02            ***3
     C                     MOVE '1'       *IN15            ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0149' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     GOTO #ZO8                       ***3
     C                     END                             E**3
     C                     END                             E*2
     C*
     C*
     C** check that the record exists
     C           @DLKEY    CHAINMMDEALLL             65    *1
     C*
     C** Check deal type is valid
     C*
     C** INITIALISE INDICATORS
     C                     Z-ADD1         @N      20
     C                     MOVE '0'       *IN75
     C*
     C           H@MTYP    LOKUP@DT2,@N                  75
     C*
     C           *IN65     IFEQ '1'                        B*2
     C           *IN75     OREQ '0'                        B*2
     C           H@DLTF    ORNE ' '                        B*2
     C           H@DDLT    ORNE ' '                        B*2            E32101
     C/COPY WNCPYSRC,MM0028C049
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0150' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     END                             E*2
     C*                                                                   E42414
     C** Check that the deal does not exist on                            E42414
     C** DEALSH file else, it is an error                                 E42414
     C           *IN65     IFNE '1'                        B*2            E42414
     C/COPY WNCPYSRC,MM0028C143
     C           *IN75     ANDNE'0'                        B*2            E42414
     C           H@DLTF    ANDEQ' '                        B*2            E42414
     C           H@DDLT    ANDEQ' '                        B*2            E42414
     C           @DLKEY    CHAINDEALSH               65    **2            E42414
     C*                                                                   E42414
     C** Record already exists in DEALSH file                             E42414
     C           *IN65     IFEQ '0'                        B**3           E42414
     C/COPY WNCPYSRC,MM0028C050
     C                     MOVE '1'       *IN02            ***3           E42414
     C                     MOVE '1'       *IN41            ***3           E42414
     C                     MOVEL'MMM0150' @MSGID           ***3           E42414
     C                     CALL 'ZA0240'                   ***3           E42414
     C                     PARM           @MSGID           ***3           E42414
     C                     GOTO #ZO8                       ***3           E42414
     C                     END                             E**3           E42414
     C*                                                                   E42414
     C                     END                             E*2            E42414
     C*
     C** Check valid deal for key fields
     C                     EXSR #ZOA                       *1
     C           *IN41     CABEQ'1'       #ZO8             *1
     C*
     C                     END                             E1
     C*
     C*  *--------------------------------*
     C*  * Validation for Action Code 'A' *
     C*  *--------------------------------*
     C*
     C           DDACTN    IFEQ 'A'                        B1
     C*
     C** check that the record exists
     C           @DMKEY    CHAINMMDEAMLL             65    *1
     C           *IN65     IFEQ '1'                        B*2
     C           HNDLTF    ORNE *BLANK                     **2
     C/COPY WNCPYSRC,MM0028C051
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN15            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0157' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     END                             E*2
     C*
     C** Deam deleted indicator must be blank.
     C           HNDDLT    IFNE *BLANKS                    B*2
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS6                                           S01408
     C*                                                                   S01408
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN15            ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0151' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     END                             E*2
     C*
     C** Check that no non-amendable fields have been altered
     C                     EXSR #ZOB                       *1
     C*
     C           *IN41     CABEQ'1'       #ZO9             *1
     C*
     C** if the record exists the status must be C A or R
     C           HNDSTS    IFNE 'C'                        B*2
     C           HNDSTS    ANDNE'A'                        **2
     C           HNDSTS    ANDNE'R'                        **2
     C/COPY WNCPYSRC,MM0028C052
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN15            ***3
     C                     MOVE '1'       *IN11            ***3
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0152' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     END                             E*2
     C*
     C** Check valid deal for key fields
     C                     EXSR #ZOA                       *1
     C           *IN41     CABEQ'1'       #ZO8             *1
     C*
     C** If preliminary validation passed for amend inhibit input on
     C** non-amendable fields
     C                     MOVE '1'       *IN49            *1
     C           DDMTYP    IFNE 'SI'                       B*2
     C                     MOVE '1'       *IN48            **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C*  *--------------------------------*
     C*  * Validation for Action Code 'D' *
     C*  *--------------------------------*
     C*
     C           DDACTN    IFEQ 'D'                        B1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS5                                           S01408
     C*                                                                   S01408
     C*
     C** deal must exist
     C           @DMKEY    CHAINMMDEAMLL             65    *1
     C           *IN65     IFEQ '1'                        B*2
     C           HNDLTF    ORNE *BLANK                     **2
     C/COPY WNCPYSRC,MM0028C053
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN15            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0157' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     END                             E*2
     C*
     C** Deam deleted indicator must be blank.
     C           HNDDLT    IFNE *BLANKS                    B*2
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CVS6                                           S01408
     C*                                                                   S01408
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN15            **2
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0151' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     END                             E*2
     C*
     C** if the record exists the status must be C A or R
     C           HNDSTS    IFNE 'C'                        B*2
     C           HNDSTS    ANDNE'A'                        **2
     C           HNDSTS    ANDNE'R'                        **2
     C/COPY WNCPYSRC,MM0028C054
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN15            **2
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0156' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZO8                       **2
     C                     END                             E*2
     C*** Following Code remove because after a deal amendment            E33979
     C*** has been Actioned in COB it is removed. Any amendments          E33979
     C*** with a value date before today must have been input today,      E33979
     C*** and are therefore valid for deletion.                           E33979
     C*
     C***If*amendment*value*date*is*before*run*date*do*not*allow*delete44 E33979
     C***********                                                  E20344 E33979
     C***********@VDYNO    IFLT BJRDNB                             E20344 E33979
     C***********          MOVE '1'       *IN11                    E20344 E33979
     C***********          MOVE '1'       *IN41                    E20344 E33979
     C***********          MOVEL'MMM0201' @MSGID                   E20344 E33979
     C***********          CALL 'ZA0240'                           E20344 E33979
     C***********          PARM           @MSGID                   E20344 E33979
     C***********          GOTO #ZO8                               E20344 E33979
     C***********          END                                     E20344 E33979
     C**If amendment type is 'PI' execute process 'Check deal amendment
     C** principle'   : MMP0082,1st check numeric amount
     C           DDMTYP    IFEQ 'PI'                       B*2
     C*
     C****Verify*that*the*amount*entered*is*valid*numeric.                E20344
     C**  This verification is not needed with action code of D.          E20344
     C**  Suggest as coding used elsewhere copied in bulk and mistakenly  E20344
     C**  left.??                                                         E20344
     C*****                Z-ADDCDP       @@IDP            **2    *****   S01194
     C*********************Z-ADDA6NBDP    @@IDP            **2  S01194    E20344
     C*****      13        SUB  CDP       @@IINT           **2    *****   S01194
     C***********13********SUB  A6NBDP    @@IINT           **2  S01194    E20344
     C*********************MOVE *BLANKS   @@ALPH           **2            E20344
     C*********************MOVE DDAMNP    @@ALPH           **2            E20344
     C*********************MOVE 'Y'       @@MTID  1             E17279    E20344
     C*********************EXSR ZA0840                     **2            E20344
     C***********@@ERCD****IFNE 0                          B**3           E20344
     C*********************MOVE '1'       *IN18            ***3           E20344
     C*********************MOVE '1'       *IN41            ***3           E20344
     C*********************MOVEL'MMM0144' @MSGID           ***3           E20344
     C*********************CALL 'ZA0240'                   ***3           E20344
     C*********************PARM           @MSGID           ***3           E20344
     C*********************GOTO #ZO8                       ***3           E20344
     C*********************END                             E**3           E20344
     C*
     C**If amendment type is 'PI' execute process 'Check deal amendment
     C** principle'   : MMP0082.
     C           DDAMNP    IFNE *BLANKS                    B**3
     C*
     C**  Store this deam amount
     C                     Z-ADD@@AMT     @TDLA            ***3
     C                     EXSR #ZQ                        ***3
     C*
     C** If invalid exit routine
     C           *IN41     CABEQ'1'       #ZO9             ***3
     C*
     C**  Reset deams file if amount passed principle validation check
     C**  Access only if current deam is not deam last accessed.
     C           @DLKEY    IFNE HNDA38                     B***4
     C           @VDYY     ORNE HNVDYY                     ****4
     C           @VDMM     ORNE HNVDMM                     ****4
     C           @VDDD     ORNE HNVDDD                     ****4
     C           @KSEQN    ORNE HNDS38                     ****4
     C*
     C** deam must exist
     C           @DMKEY    CHAINMMDEAMLL             65    ****4
     C           *IN65     IFEQ '1'                        B****5
     C           HNDLTF    ORNE *BLANK                     *****5
     C/COPY WNCPYSRC,MM0028C055
     C                     MOVE '1'       *IN02            *****5
     C                     MOVE '1'       *IN11            *****5
     C                     MOVE '1'       *IN15            *****5
     C                     MOVE '1'       *IN41            *****5
     C                     MOVEL'MMM0157' @MSGID           *****5
     C                     CALL 'ZA0240'                   *****5
     C                     PARM           @MSGID           *****5
     C                     GOTO #ZO8                       *****5
     C                     END                             E****5
     C                     END                             E***4
     C                     END                             E**3
     C                     END                             E*2
     C*
     C                     END                             E1
      *                                                                   S01117
     C*  *-----------------------------------------------*
      ** * ACCESS SECURITY CHECKING                      *                S01117
     C*  *-----------------------------------------------*
      *                                                                   S01117
      *                                                                   S01117
     C           @MBIN     IFEQ 'Y'                        B1             S01117
     C***********DDACTN    ANDNE'I'                        *1             E27750
     C***********DDACTN    ANDNE'I'                        *1      E28503 085052
     C**                                                                  LN0356
     C*  Access file for deal associated  branch code                     LN0356
     C*  for validation.                                                  LN0356
     C***********HNDA38    CHAINMMDEALLL             65    *1      LN0356 E36559
     C           @DLKEY    CHAINMMDEALLL             65    *1             E36559
     C*                                                                   LN0356
     C*                                                                   LN0356
      *                                                                   S01117
     C                     CALL 'ZVACTBU'                  *1             S01117
     C                     PARM DDACTN    ZACTN   1        *1             S01117
     C                     PARM H@BRCA    ZBR     3        *1             S01117
     C                     PARM           ERR     10       *1             S01117
      *                                                                   S01117
     C           ERR       IFEQ 1                          B*2            S01117
      * no valid action codes for user/branch combination                 S01117
     C                     MOVE '1'       *IN01            **2            S01117
     C                     MOVE '1'       *IN02            **2            S01117
     C                     MOVE '1'       *IN41            **2            S01117
     C                     MOVEL'FXM0290' @MSGID           **2            S01117
     C                     CALL 'ZA0240'                   **2            S01117
     C                     PARM           @MSGID           **2            S01117
     C                     GOTO #ZO8                       **2            S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
     C           ERR       IFEQ 2                          B*2            S01117
      * this action code invalid for user/branch combination              S01117
     C                     MOVE '1'       *IN01            **2            S01117
     C                     MOVE '1'       *IN02            **2            S01117
     C                     MOVE '1'       *IN41            **2            S01117
     C                     MOVEL'FXM0291' @MSGID           **2            S01117
     C                     CALL 'ZA0240'                   **2            S01117
     C                     PARM           @MSGID           **2            S01117
     C                     GOTO #ZO8                       **2            S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
      ** If orig branch is user validated and this is not an enquiry
      **  validate originating branch                                     S01117
      *                                                                   S01117
     C           DDACTN    IFNE 'E'                        B*2            S01117
     C*****      OBUV      ANDEQ'Y'                        B*2    S01117  S01194
     C           BKOBUV    ANDEQ'Y'                        B*2            S01194
     C                     CALL 'ZVOBU'                    **2            S01117
     C*********************PARM HLORBR    ZOBRX   3        **2      S01117E284
     C                     PARM H@ORBR    ZOBRX   3        **2            E284
     C                     PARM           ERR     10       **2            S01117
     C           ERR       IFEQ 1                          B**3           S01117
      * no valid originating branches for this user                       S01117
     C                     MOVE '1'       *IN01            ***3           S01117
     C                     MOVE '1'       *IN02            ***3           S01117
     C                     MOVE '1'       *IN41            ***3           S01117
     C                     MOVEL'FXM0287' @MSGID           ***3           S01117
     C                     CALL 'ZA0240'                   ***3           S01117
     C                     PARM           @MSGID           ***3           S01117
     C                     GOTO #ZO8                       ***3           S01117
     C                     END                             E**3           S01117
     C           ERR       IFEQ 2                          B**3           S01117
      * this originating branch invalid for user                          S01117
     C                     MOVE '1'       *IN01            ***3           S01117
     C                     MOVE '1'       *IN02            ***3           S01117
     C                     MOVE '1'       *IN41            ***3           S01117
     C                     MOVEL'FXM0288' @MSGID           ***3           S01117
     C                     CALL 'ZA0240'                   ***3           S01117
     C                     PARM           @MSGID           ***3           S01117
     C                     GOTO #ZO8                       ***3           S01117
     C                     END                             E**3           S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
     C                     END                             E1             S01117
      *                                                                   S01117
     C           @MBIN     IFEQ 'N'                        B1             S01117
     C*
      ** validate action codes for user                                   S01117
     C                     CALL 'ZVACTU'                   *1             S01117
     C                     PARM DDACTN    ZACTN   1        *1             S01117
     C                     PARM           ERR     10       *1             S01117
      *                                                                   S01117
     C           ERR       IFEQ 1                          B*2            S01117
      * This action code invalid for user                                 S01117
     C                     MOVE '1'       *IN01            **2            S01117
     C                     MOVE '1'       *IN41            **2            S01117
     C                     MOVEL'FXM0292' @MSGID           **2            S01117
     C                     CALL 'ZA0240'                   **2            S01117
     C                     PARM           @MSGID           **2            S01117
     C                     GOTO #ZO8                       **2            S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
     C                     END                             E1             S01117
     C/COPY WNCPYSRC,MM0028C142
     C*
     C*****************************************
     C** second level validation for I,A or D *
     C*****************************************
     C*
     C** if user authority checks are being bypassed exit subroutine
     C***********IDIRO*****CABEQ'Y'*******#ZO9****************************S01319
     C           DDACTN    CABEQ'X'       #ZO9
     C           DDACTN    CABEQ'E'       #ZO9
     C*
     C***cross*validate*deal*status*and*action*for*settlement*officer*****S01319
     C********************************************************************S01319
     C***Settlement*officers*are*not*allowed*to*insert*deals*unless*******S01319
     C***authorized.******************************************************S01319
     C***********DDACTN****IFEQ*'I'************************B1*************S01319
     C***********IPSOIC****ANDEQ'N'*************************1*************S01319
     C*********************MOVE*'1'********IN01*************1*************S01319
     C*********************MOVE*'1'********IN41*************1*************S01319
     C*********************MOVEL'MMM0286'*@MSGID************1*************S01319
     C*********************CALL*'ZA0240'********************1*************S01319
     C*********************PARM***********@MSGID************1*************S01319
     C*********************GOTO*#ZO8************************1*************S01319
     C*********************END*****************************E1*************S01319
     C********************************************************************S01319
     C***Settlement*officers*are*not*allowed*to*amend*authorized*deals****S01319
     C***unless*authorized*to*do*so.**************************************S01319
     C***********DDACTN****IFEQ*'A'************************B1*************S01319
     C***********HNDSTS****ANDEQ'A'*************************1*************S01319
     C***********IPSOAA****ANDEQ'N'*************************1*************S01319
     C***********DDACTN****OREQ*'A'*************************1*************S01319
     C***********HNDSTS****ANDEQ'R'*************************1*************S01319
     C***********IPSOAA****ANDEQ'N'*************************1*************S01319
     C*********************MOVE*'1'********IN01*************1*************S01319
     C*********************MOVE*'1'********IN41*************1*************S01319
     C*********************MOVE*'0'********IN49*************1*************S01319
     C*********************MOVE*'0'********IN48*************1*************S01319
     C*********************MOVEL'MMM0287'*@MSGID************1*************S01319
     C*********************CALL*'ZA0240'********************1*************S01319
     C*********************PARM***********@MSGID************1*************S01319
     C*********************GOTO*#ZO8************************1*************S01319
     C*********************END*****************************E1*************S01319
     C********************************************************************S01319
     C***Settlement*officers*are*not*allowed*to*delete*completed*deals****S01319
     C***unless*authorized.***********************************************S01319
     C***********DDACTN****IFEQ*'D'************************B1*************S01319
     C***********HNDSTS****ANDEQ'C'************************B1*************S01319
     C***********IPSODC****ANDEQ'N'************************B1*************S01319
     C*********************MOVE*'1'********IN01*************1*************S01319
     C*********************MOVE*'1'********IN41*************1*************S01319
     C*********************MOVEL'MMM0288'*@MSGID************1*************S01319
     C*********************CALL*'ZA0240'********************1*************S01319
     C*********************PARM***********@MSGID************1*************S01319
     C*********************GOTO*#ZO8************************1*************S01319
     C*********************END*****************************E1*************S01319
     C********************************************************************S01319
     C***Settlement*officers*are*not*allowed*to*delete*authorized*deals***S01319
     C***unless*authorized.***********************************************S01319
     C***********DDACTN****IFEQ*'D'************************B1*************S01319
     C***********HNDSTS****ANDEQ'A'*************************1*************S01319
     C***********IPSODA    ANDEQ'N'                        *1             E24191
     C***********IPDSDA****ANDEQ'N'*************************1*******E24191S01319
     C***********IPSODA****ANDEQ'N'*************************1*************S01319
     C***********DDACTN****OREQ*'D'*************************1*************S01319
     C***********HNDSTS****ANDEQ'R'*************************1*************S01319
     C***********IPSODA    ANDEQ'N'                        *1             E24191
     C***********IPDSDA****ANDEQ'N'*************************1*******E24191S01319
     C*********************MOVE*'1'********IN11*************1*************S01319
     C*********************MOVE*'1'********IN12*************1*************S01177
     C*********************MOVE*'1'********IN41*************1*************S01319
     C*********************MOVEL'MMM0289'*@MSGID************1*************S01319
     C*********************CALL*'ZA0240'********************1*************S01319
     C*********************PARM***********@MSGID************1*************S01319
     C*********************GOTO*#ZO8************************1*************S01319
     C*********************END*****************************E1*************S01319
     C*
     C** if processing is not insert and an error has occurred then
     C** clear all the fields except the action and key fields.
     C           #ZO8      TAG                             #ZO8 TAG
     C*
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP63                                           S01408
      *                                                                   S01408
     C           DDACTN    IFNE 'I'                        B1
     C           *IN41     ANDEQ'1'                        *1
     C                     MOVE DDACTN    @WK11   1        *1
     C                     MOVE DDDLNO    @WK22   6        *1
     C                     MOVE DDVDAT    @WK33   6        *1
     C                     MOVE DDDS38    @WK44   6        *1
     C                     EXSR #ZE                        *1
     C                     EXSR #ZEA                       *1             E18139
     C                     MOVE @WK11     DDACTN           *1
     C                     MOVE @WK22     DDDLNO           *1
     C                     MOVE @WK33     DDVDAT           *1
     C                     MOVE @WK44     DDDS38           *1
     C                     END                             E1
     C*
     C           #ZO9      ENDSR                           **#ZO9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*      #ZOA     - Check valid deal for key fields
     C*                                                               *
     C**CALLS****ZA0680***-Convert*date*YYYYMMDD*to*a*midas*day*number*   056095
     C* CALLS    ZDAT10   -Convert date YYYYMMDD to a midas day number*   056095
     C*          ZA0240   - sends message to screen                   *
     C*****      ZA0830   - Is day a holiday in currency          *****   S01195
     C*                                                               *
     C* CALLED BY  #ZO    - Validate deal number and action code      *
     C*                                                               *
     C* FLDS USED  @DLKEY - deal file key                             *
     C*            @KEY   - key for table files                       *
     C*            @@DTIN - Input date to ZA0770                      *
     C*            @@MDNO - MIDAS DAY NUMBER  (SIZE : 5N)
     C*            @SLDYN - Start/last interest date day no.          *
     C*            @IADYN - Interest accrual day no.                  *
     C*            @MDAYN - Maturity date day no.                     *
     C*            @VDYNO - value date                                *
     C*            @MSGID - message id                                *
     C*            @CMDT  - calculated maturity date                  *
     C*****        @@MNO  MIDAS DAY NUMBER 5N                     *****   S01195
     C*            @@CCY  CURRENCY CODE 3A                            *
     C*****        @@HIND HOLIDAY/WORKING DAY INDICATOR 1A        *****   S01195
     C*            @KSEQN - Sequence number key field                 *
     C*            @DMKEY - Key to deams file                         *
     C*            @DMVY  - Convert date to DDMMYY                    *
     C*            @DMVM  - Convert date to DDMMYY                    *
     C*            @DMVD  - Convert date to DDMMYY                    *
     C*            @DMVDT - Deam value date from file                 *
     C*            @DMVYR - Deam value date from file                 *
     C*            @DMVMT - Deam value date from file                 *
     C*            @DMVDY - Deam value date from file                 *
     C*                                                               *
     C*****************************************************************
     C           #ZOA      BEGSR
     C*
     C** Access MMDEALLL if this has not been done for this deal number
     C           @DLKEY    IFNE H@DN38                     B1
     C           @DLKEY    CHAINMMDEALLL             65    *1
     C           *IN65     IFEQ '1'                        B*2
     C                     MOVE '1'       *INLR            **2
     C                     MOVE '1'       *INU7            **2
     C                     MOVE '1'       *INU8            **2
     C                     MOVE '1'       *INKC            ***************
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 003 *
     C*********************MOVEL@KEY******DBKEY            ***************E276
     C                     MOVEL@DLKEY    DBKEY            ***************E276
     C                     MOVE '003'     DBASE            **2
     C                     EXSR #C                         **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C** Convert dates used in compares to midas day numbers
     C***********          Z-ADDH@SLDT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********          Z-ADD@@MDNO    @SLDYN  50                      056095
     C***********          Z-ADDH@IADT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********          Z-ADD@@MDNO    @IADYN  50                      056095
     C                     Z-ADDH@SLDT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C                     Z-ADDZZMDNO    @SLDYN  50                      056095
     C                     Z-ADDH@IADT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C                     Z-ADDZZMDNO    @IADYN  50                      056095
     C           H@RCID    IFEQ 'HK'                       B1
     C***********          Z-ADDH@MATD    @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @MDAYN  50       *1             056095
     C                     Z-ADDH@MATD    ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @MDAYN  50       *1             056095
     C                     ELSE                            X1
     C                     Z-ADD0         @MDAYN           *1
     C                     END                             E1
     C*
     C***Value*date*must*be*greater*than*both*interest*accrual            E22271
     C** Value date must be greater than OR EQUAL TO both interest accrualE22271
     C** control date & start/last interest date.
     C** 'HM' IS NOT CHECKED SINCE DEAL AMENDMENT TYPE IS CHECKED WITH    E22271
     C** DEAL TYPE TO SEE THAT NO N/A SOLD IS VALID FOR AMENDMENT         E22271
     C***********@VDYNO    IFLE @SLDYN                     B1             E22271
     C***********H@RCID    IFEQ 'HM'                       B*2            E22271
     C***********@VDYNO    ORLE @IADYN                     **2            E22271
     C           @VDYNO    IFLT @SLDYN                     B1             E22271
     C           @VDYNO    ORLT @IADYN                     **2            E22271
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0153' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOA9                      **2
     C*********************END                             E*2            E22271
     C                     END                             E1
     C*
     C** Value date must be = or < than maturity date if maturity date
     C** is present
     C           @MDAYN    IFNE 0                          B1
     C           @VDYNO    ANDGE@MDAYN                     *1
     C                     MOVE '1'       *IN11            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0154' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     GOTO #ZOA9                      *1
     C                     END                             E1
     C*
     C** MOVE THIS CODE TO MAIN VALIDATION ROUTINE #ZI                    050588
     C***Send*warning message if notice days are not 0 or -999            050588
     C***&*value*date*is*less*than*the*run*date*+*associated*deal         E16441
     C***&*value date is greater than the run date + associated dealE16441050588
     C***notice*days                                                      050588
     C***Only*loan/deposit/cd issued can have notice days                 050588
     C*******    H@RCID    IFEQ 'HK'                       B1             050588
     C*****      RUND      ADD  HKNTCE    @CMDT   50       *1     *****   S01194
     C*******    BJRDNB    ADD  HKNTCE    @CMDT   50       *1      S01194 050588
     C*******    HKNTCE    IFNE *ZEROS                     B*2            050588
     C*******    HKNTCE    ANDNE-999                       **2            050588
     C***********@VDYNO    ANDLT@CMDT                      **2            E16441
     C*******    @VDYNO    ANDGT@CMDT                      **2     E16441 050588
     C*******              MOVE '1'       *IN11            **2            050588
     C**********           MOVE '1'       *IN41            **2            E14379
     C*******              MOVE '1'       *IN55            **2     E14379 050588
     C*******              MOVEL'MMM0155' @MSGID           **2            050588
     C*******              CALL 'ZA0240'                   **2            050588
     C*******              PARM           @MSGID           **2            050588
     C*******              GOTO #ZOA9                      **2            050588
     C*******              END                             E*2            050588
     C*******              END                             E1             050588
     C*
     C***Settlement*method*must*not*be*01,07*or*08*if*value*date***       LN0234
     C***is*not*a*working*day*in*deal*currency.***                        LN0234
     C***                                                                 LN0234
     C****If*settlement*method*is*not*01,07,08*and*is*not*a*working*day inLN0234
     C****deal*currency,*it*is*an*error.***                               LN0234
     C*****      DDORCM    IFNE '01'                       B1             S01177
     C*****      DDORCM    ANDNE'07'                       *1             S01177
     C*****      DDORCM    ANDNE'08'                       *1             S01177
     C***********PMRSTM    IFNE 01                         B1      S01177 LN0234
     C***********PMRSTM    ANDNE07                         *1      S01177 LN0234
     C***********PMRSTM    ANDNE08                         *1      S01177 LN0234
     C***********PMPSTM    ANDNE01                         B1      S01177 LN0234
     C***********PMPSTM    ANDNE07                         *1      S01177 LN0234
     C***********PMPSTM    ANDNE08                         *1      S01177 LN0234
     C*                                                                   LN0234
     C* If settlement through a NOSTRO, access nostro location            LN0234
     C* to validate value date for holiday, using deal currency.          LN0234
     C* Ensure settlement instructions entered before Date holiday        LN0234
     C* validation is carried out.                                        LN0234
     C*  Deams will have settlement details on one side only (pay/rec)    BHF430
     C* so must check appropriate side.                                   BHF430
     C*                                                                   LN0234
     C           *IN22     IFEQ '1'                        B1             LN0234
     C           PMRSTM    IFEQ 01                         B1             LN0234
     C           PMRSTM    OREQ 07                         *1             LN0234
     C           PMRSTM    OREQ 08                         *1             LN0234
     C           PMPSTM    OREQ 01                         B1             LN0234
     C           PMPSTM    OREQ 07                         *1             LN0234
     C           PMPSTM    OREQ 08                         *1             LN0234
     C*                                                                   LN0234
032  C* CALL ACCESS PROG. FOR NOSTROS DETAILS.                            LN0234
      *                                                                   CEU003
      *                                                                   CEU003
      ** Determine the effective currency to access nostro details        CEU003
      *                                                                   CEU003
     C                     MOVE *BLANKS   WEFCY   3                       CEU003
     C           PMPSTM    IFNE 0                          B**3           BHF430
     C                     MOVELPMPONS    @NSKYE           ***3           BHF430
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           PMPSCY    ANDNE*BLANKS                                   CEU003
     C                     MOVELPMPSCY    WEFCY                           CEU003
     C                     ELSE                                           CEU003
     C                     MOVELDDCCY     WEFCY                           CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
     C                     ELSE                            X**3           BHF430
     C                     MOVELPMRONS    @NSKYE           ***3           BHF430
      *                                                                   CEU003
     C           CEU003    IFEQ 'Y'                                       CEU003
     C           PMRSCY    ANDNE*BLANKS                                   CEU003
     C                     MOVELPMRSCY    WEFCY                           CEU003
     C                     ELSE                                           CEU003
     C                     MOVELDDCCY     WEFCY                           CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
     C                     END                             E**3           BHF430
     C                     CALL 'AONOSTR0'                 *1             LN0234
     C*********************PARM '*DBERR ' @RTCD   7        *1      LN0234 E47225
     C                     PARM '*MSG   ' @RTCD   7        *1             E47225
     C                     PARM '*KEY   ' @OPTN   7        *1             LN0234
     C                     PARM *BLANKS   @NSKYA  6        *1             LN0234
     C***********          PARM DDCCY     @NSKYB  3        *1      LN0234 CEU003
     C                     PARM WEFCY     @NSKYB  3                       CEU003
     C**********           PARM *BLANKS   @NSKYC  4        *1                          LN0234 CGL029
     C                     PARM *BLANKS   @NSKYC                                              CGL029
     C                     PARM *BLANKS   @NSKYD  2        *1             LN0234
     C*********************PARM PMRONS    @NSKYE  2        *1       LN0234BHF430
     C                     PARM           @NSKYE  2        *1             BHF430
     C                     PARM *BLANKS   @KEYF            *1             LN0234
     C                     PARM *BLANKS   @KEYG            *1             LN0234
     C                     PARM *BLANKS   @KEYH            *1             LN0234
     C           SDNOST    PARM SDNOST    DSFDY            *1             LN0234
     C*                                                                   LN0234
     C           @RTCD     IFNE *BLANK                     B2             LN0234
     C                     MOVE '1'       *IN65            *2             LN0234
     C                     MOVE '1'       *INLR            *2             LN0234
     C                     MOVE '1'       *INKC            *2             LN0234
     C                     MOVE '1'       *INU7            ***************LN0234
     C                     MOVE '1'       *INU8            *             *LN0234
     C                     MOVEL'SDNOSTPD'DBFILE           * DB ERROR 017*LN0234
     C                     MOVEL@NSKYB    DBKEY            *             *LN0234
     C                     MOVE @NSKYE    DBKEY            *             *LN0234
     C                     MOVE '017'     DBASE            ***************LN0234
     C                     GOTO #ZOA9                      *2             LN0234
     C                     END                             E2             LN0234
     C*                                                                   LN0234
     C                     MOVE A7NOSN    @RLOC   3        *1             LN0234
     C*                                                                   LN0234
     C**  Find whether the date is a holiday in the deal currency.
     C*****                MOVE H@CCY     @@CCY   3        *1     *****   S01195
     C***********          MOVE H@CCY     ZCCY             *1      S01195 CEU003
     C                     MOVELWEFCY     ZCCY                            CEU003
     C*****                Z-ADD@VDYNO    @@MNO   50       *1     *****   S01195
     C                     Z-ADD@VDYNO    ZDAYNO  50       *1             S01195
     C                     MOVE @RLOC     ZLOC    3        *1             LN0234
     C*****                EXSR ZA0830                     *1     *****   S01195
     C                     EXSR ZCHKH                      *1             S01195
     C*
     C*****f @@HIND = 'H' then the date is a holiday.             *****   S01195
     C*****      @@HIND    IFEQ 'H'                        B*2            S01195
     C**  If ZIND = 'H' then the date is a holiday.               *****   S01195
     C           ZIND      IFEQ 'H'                        B*2            S01195
     C                     MOVE '1'       *IN11            **2
     C*********************MOVE '1'       *IN41            **2            E24193
     C                     MOVE '1'       *IN55            **2            E24193
     C                     MOVEL'MMM0129' @MSGID           **2
     C/COPY WNCPYSRC,MM0028C100
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C/COPY WNCPYSRC,MM0028C101
     C                     GOTO #ZOA9                      **2
     C                     END                             E*2
     C                     END                             E1
     C                     END                             E1             LN0234
     C*
     C****If*Settlement*method*is*not*blank,*0,01,05,07,08*OR*NODEF*and is not a
     C****working*day*in*the*local*currency,*it*is*an*error.***           LN0234
     C*****      DDORCM    IFNE *BLANKS                    B1             S01177
     C*****      DDORCM    ANDNE'00'                       *1             S01177
     C*****      DDORCM    ANDNE'01'                       *1             S01177
     C*****      DDORCM    ANDNE'05'                       *1             S01177
     C*****      DDORCM    ANDNE'07'                       *1             S01177
     C*****      DDORCM    ANDNE'08'                       *1             S01177
     C***********PMRSTM    IFNE *ZERO                      B1      S01177 LN0234
     C***********PMRSTM    ANDNE00                         *1      S01177 LN0234
     C***********PMRSTM    ANDNE01                         *1      S01177 LN0234
     C***********PMRSTM    ANDNE05                         *1      S01177 LN0234
     C***********PMRSTM    ANDNE07                         *1      S01177 LN0234
     C***********PMRSTM    ANDNE08                         *1      S01177 LN0234
     C***********PMPSTM    ANDNE*ZERO                      B1      S01177 LN0234
     C***********PMPSTM    ANDNE00                         *1      S01177 LN0234
     C***********PMPSTM    ANDNE01                         *1      S01177 LN0234
     C***********PMPSTM    ANDNE05                         *1      S01177 LN0234
     C***********PMPSTM    ANDNE07                         *1      S01177 LN0234
     C***********PMPSTM    ANDNE08                         *1      S01177 LN0234
     C*                                                                   LN0234
     C* For settlement NOT through a NOSTRO validate value date           LN0234
     C* for holiday at local location.                                    LN0234
     C* Ensure settlement instructions entered before Date holiday        LN0234
     C* validation is carried out.                                        LN0234
     C*                                                                   LN0234
     C           *IN22     IFEQ '1'                        B1             LN0234
     C           PMRSTM    IFNE 01                         B1             LN0234
     C           PMRSTM    ANDNE07                         *1             LN0234
     C           PMRSTM    ANDNE08                         *1             LN0234
     C           PMPSTM    ANDNE01                         B1             LN0234
     C           PMPSTM    ANDNE07                         *1             LN0234
     C           PMPSTM    ANDNE08                         *1             LN0234
     C**  Find whether the date is a holiday in the local currency.
     C*****                MOVE LOCY      @@CCY            *1     *****   S01195
     C*****                MOVE LOCY      ZCCY             *1     S01195  S01194
     C                     MOVE BJLCCY    ZCCY             *1             S01194
     C*****                Z-ADD@VDYNO    @@MNO            *1     *****   S01195
     C                     Z-ADD@VDYNO    ZDAYNO           *1             S01195
     C                     MOVE BJSLCD    ZLOC             *1             LN0234
     C*****                EXSR ZA0830                     *1     *****   S01195
     C                     EXSR ZCHKH                      *1             S01195
     C*
     C*****f @@HIND = 'H' then the date is a holiday.             *****   S01195
     C*****      @@HIND    IFEQ 'H'                        B*2    *****   S01195
     C*   If ZIND   = 'H' then the date is a holiday.                     S01195
     C           ZIND      IFEQ 'H'                        B*2            S01195
     C****                 MOVE '1'       *IN31            **2            S01184
     C                     MOVE '1'       *IN11            **2
     C*********************MOVE '1'       *IN41            **2            E24193
     C                     MOVE '1'       *IN55            **2            E24193
     C                     MOVEL'MMM0131' @MSGID           **2
     C/COPY WNCPYSRC,MM0028C102
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C/COPY WNCPYSRC,MM0028C103
     C                     GOTO #ZOA9                      **2
     C                     END                             E*2
     C                     END                             E1
     C                     END                             E1             LN0234
     C*
     C** For deam type 'SI' the deam value date must not be the same
     C** as the value date of a deam already existing on the deal.
     C** Also applys to deam type 'CI'.                                   050174
     C           DDMTYP    IFEQ 'SI'                       B1
     C           DDACTN    ANDEQ'I'                        *1
     C           DDMTYP    OREQ 'CI'                       B1             050174
     C           DDACTN    ANDEQ'I'                        *1             050174
     C*
     C** Check for all possible deam sequence  values
     C                     MOVE *LOVAL    @KSEQN           *1
     C***********@DMKEY    SETLLMMLVDMLL                   *1             E28503
     C***********          READ MMLVDMLL                 65*1             E28503
     C**  Read for a deal with the same value date and deal no            E28503
     C*******    @DMKEY    SETLLMMLVDMLL                 65*1      E28503 050174
     C*******    *IN65     IFEQ '1'                                E28503 050174
     C*******    @DMKEY    READEMMLVDMLL                 65*1      E28503 050174
     C*******              END                                     E28503 050174
     C           @DMKEY    SETLLMMLVDMLL                   *1             050174
     C                     READ MMLVDMLL                 65*1             050174
     C*
     C**  Place value date from files into same sequence as display (DDMMYY)
     C                     MOVE @DMVYR    @DMVY            *1
     C           BJDFIN    IFEQ 'D'                        *1             BHF947
     C                     MOVE @DMVMT    @DMVM            *1
     C                     MOVE @DMVDY    @DMVD            *1
     C                     ELSE                            *1             BHF947
     C                     MOVE @DMVMT    @DMVD            *1             BHF947
     C                     MOVE @DMVDY    @DMVM            *1             BHF947
     C                     END                             *1             BHF947
     C*
     C**  If a live record is found then a deam already exists
     C**  for the value date & deal number
     C           *IN65     IFEQ '0'                        B*2
     C***********@DLKEY    ANDEQH@DN38                     **2            E22315
     C           @DLKEY    ANDEQHNDA38                     **2            E22315
     C           DDVDAT    ANDEQ@DMVDT                     **2
      *                                                                   076419
      ************************                                      076419083409
     C***********HNTYPE****IFEQ 'SI'                                076419083409
     C                     MOVE '1'       *IN02            **2
     C                     MOVE '1'       *IN11            **2
     C                     MOVE '1'       *IN41            **2
     C*********************MOVE '1'       *IN65                     076419083409
     C           DDMTYP    IFEQ 'SI'                       B**3           050174
     C                     MOVEL'MMM0577' @MSGID           **2
     C                     ELSE                            X**3           050174
     C                     MOVEL'MMM2548' @MSGID           ***3           050174
     C                     END                             E**3           050174
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
      ************************                                      076419083409
     C*********************ELSE                                     076419083409
     C*********************READ MMLVDMLL                 65         076419083409
      ************************                                      076419083409
      ****Place*value*date*from files into same sequence as display 076419083409
     C*********************MOVE @DMVYR    @DMVY                     076419083409
     C*********************MOVE @DMVMT    @DMVM                     076419083409
     C*********************MOVE @DMVDY    @DMVD                     076419083409
     C*********************END                                      076419083409
     C                     END                             E*2
     C                     END                             E1
     C*
     C           #ZOA9     ENDSR                           **#ZOA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #ZOB - Check non-amendable fields have not changed   *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          ZA0770 - Convert date YYYYMMDD to DDMMYY format      *
     C*          ZA0920   - Convert Amount to display format          *
     C*          ZA0840   - Validate/reformat input amount            *
     C*                                                               *
     C* CALLED BY  #ZC    - Enter processing for action code A.       *
     C*            #ZO    - Validate deal number and action code      *
     C*                                                               *
     C* FLDS USED  @YEAR  - Format date to YYYYMMDD : year            *
     C*            @MNTH  - Format date to YYYYMMDD : month           *
     C*            @DAY   - dd days for conversion to YYYYMMDD        *
     C*            @DATE  - YYYYMMDD date for separation              *
     C*            @VDAT  - stored value date                         *
     C*            @@DTIN - Input date to ZA0770                      *
     C*            @@DTOU - Output date to ZA0770                     *
     C*            @MSGID - Message id.                               *
     C*            @DS38  - Stored deam sequence number               *
     C*            @AMNP  - stored purchase price                     *
     C*            @@AMTW - AMOUNT  input to ZA0920                   *
     C*            @@QECN - DECIMAL NO. (ZA0920)                      *
     C*            @@AMTD - AMOUNT WITH DECIMAL FORMAT output (ZA0920)*
     C*            @KEY   - key for table files                       *
     C*            @KEY1  -     "     "                               *
     C*            @KEY2  -     "     "                               *
     C*            @KEY3  -     "     "                               *
     C*            @@ALPH - 16A field containing field to validate    *
     C*            @@IDP  - number of decimal places                  *
     C*            @@IINT - number of integers                        *
     C*            @@ALPH - 16A field for display                     *
     C*            @@AMT  - 15N field for calculation                 *
     C*            @@ERCD - 1N error code                             *
     C*            @INTR  - stored spread rate                        *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C*            @INTRD - interest days                             *
     C*            @CSNM  - customer shortname                        *
     C*                                                               *
     C*****************************************************************
     C           #ZOB      BEGSR
     C/COPY WNCPYSRC,MM0028C002
     C*
     C*
     C**  If this is an amendment & any non-amendable fields are
     C**  different from values on file : send error message to screen.
     C**  TABLE : MMT0024.
     C*
     C**  Format the value date.
     C                     Z-ADDHNVDYY    @YEAR
     C                     Z-ADDHNVDMM    @MNTH
     C                     Z-ADDHNVDDD    @DAY
     C           @DATE     IFEQ 0                          B1
     C                     MOVE *BLANKS   @VDAT            *1
     C                     ELSE                            X1
     C                     Z-ADD@DATE     @@DTIN           *1
     C                     EXSR ZA0770                     *1
     C                     MOVE @@DTOU    @VDAT            *1
     C                     END                             E1
     C*
     C           DDVDAT    IFNE @VDAT                      B1
     C                     MOVE @VDAT     DDVDAT           *1
     C                     MOVE '1'       *IN11            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0386' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     GOTO #ZOB9                      *1
     C                     END                             E1
     C*
     C**  Sequnce Number 38.
     C           HNDS38    IFEQ 0                          B1
     C                     MOVE *BLANKS   @DS38            *1
     C                     ELSE                            X1
     C                     MOVE HNDS38    @DS38            *1
     C                     END                             E1
     C*
     C           DDDS38    IFNE @DS38                      B1
     C                     MOVE @DS38     DDDS38           *1
     C                     MOVE '1'       *IN15            *1
     C                     MOVE '1'       *IN41            *1
     C                     MOVEL'MMM0501' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C                     GOTO #ZOB9                      *1
     C                     END                             E1
     C*
     C           DDMTYP    IFNE *BLANKS                    B1
     C           DDMTYP    IFNE HNMTYP                     B*2
     C                     MOVE HNMTYP    DDMTYP           **2
     C                     MOVE '1'       *IN03            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0502' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOB9                      **2
     C                     END                             E*2
     C                     ELSE                            X1
     C                     MOVE HNMTYP    DDMTYP           *1
     C                     END                             E1
     C*
     C           DDCCY     IFNE *BLANKS                    B1
     C           DDCCY     IFNE HNCCY                      B*2
     C                     MOVE HNCCY     DDCCY            **2
     C                     MOVE '1'       *IN16            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0370' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOB9                      **2
     C                     END                             E*2
     C                     ELSE                            X1
     C                     MOVE HNCCY     DDCCY            *1
     C                     END                             E1
     C*
     C/COPY WNCPYSRC,MM0028CP47                                           S01408
     C*
     C**  Deal Amount.
     C**  - Execute ZA0920 to format Deal Amount, using Deal Ccy
     C**    decimal places.
     C           HNAMNP    IFEQ 0                          B1
     C                     MOVE *BLANKS   @AMNP            *1
     C                     ELSE                            X1
     C                     Z-ADDHNCYDP    @@QECN           *1
     C*
     C**  Reverse sign for display if amount -ve.
     C           HNAMNP    IFGT 0                          B*2
     C                     Z-ADDHNAMNP    @@AMTW           **2
     C                     ELSE                            X*2
     C                     Z-SUBHNAMNP    @@AMTW           **2
     C                     END                             E*2
     C*
     C                     EXSR ZA0920                     *1
     C                     MOVE @@AMTD    @AMNP            *1
     C                     END                             E1
     C*
     C           DDAMNP    IFNE *BLANKS                    B1
     C*
     C**  The currency must be entered.
     C           DDCCY     IFEQ *BLANKS                    B*2
     C                     MOVE '1'       *IN16            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0142' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOB9                      **2
     C                     END                             E*2
     C*
     C**  If the currency is valid, find number of decimal places
     C*****                MOVE *BLANKS   @KEY             *1     *****   S01194
     C*****                MOVE '20'      @KEY1            *1     *****   S01194
     C*****                MOVE DDCCY     @KEY2            *1     *****   S01194
     C*****                MOVE '1'       @KEY3            *1     *****   S01194
     C*****      @KEY      CHAINFDCCYTLL             65    *1     *****   S01194
     C*****                                                       *****   S01194
     C**  If no valid record is found, it is an error.
     C*****      *IN65     IFEQ '1'                        B*2    *****   S01194
     C*****      RECI      ORNE 'D'                        B*2    *****   S01194
032  C* CALL ACCESS PROG. FOR CURRENCY DETAILS.                           S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C*********************PARM @KEY2     @CRKEY  3                 S01194E276
     C                     PARM DDCCY     @CRKEY  3                       E276
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *IN16            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0202' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOB9                      **2
     C                     END                             E*2
     C*
     C**  Verify that the amount entered is valid numeric.
     C*****                Z-ADDCDP       @@IDP            *1     *****   S01194
     C                     Z-ADDA6NBDP    @@IDP            *1             S01194
     C*****      13        SUB  CDP       @@IINT           *1     *****   S01194
     C           13        SUB  A6NBDP    @@IINT           *1             S01194
     C                     MOVE *BLANKS   @@ALPH           *1
     C                     MOVE DDAMNP    @@ALPH           *1
     C                     MOVE 'Y'       @@MTID  1                       E17279
     C                     EXSR ZA0840                     *1
     C           @@ERCD    IFEQ 0                          B*2
     C                     MOVE @@ALPH    DDAMNP           **2
     C                     END                             E*2
     C*
     C           DDAMNP    IFNE @AMNP                      B*2
     C           @@ERCD    ORNE 0                          B*2
     C                     MOVEL@AMNP     DDAMNP           **2
     C                     MOVE '1'       *IN18            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0372' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOB9                      **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C*
     C**  Interest Rate/spread.
     C*
     C**  Interest Rate.
     C**  - Execute ZA0920 to format the rate, using 7 decimal places
     C**    and adjusting the file figure to have only implied decimal
     C**    places.
     C           HNINTR    IFEQ 0                          B1
     C                     MOVE *BLANKS   @INTR            *1
     C                     ELSE                            X1
     C           HNINTR    MULT 10000000  @@AMTW           *1
     C                     Z-ADD7         @@QECN           *1
     C*
     C**  Reverse sign for display if amount -ve.
     C           @@AMTW    IFLT 0                          B*2
     C                     Z-SUB@@AMTW    @@AMTW           **2
     C                     END                             E*2
     C*
     C                     EXSR ZA0920                     *1
     C                     MOVE @@AMTD    @INTR            *1
     C                     END                             E1
     C           DDINTR    IFNE *BLANKS                    B1
     C*
     C**  Check it is a valid figure with 7 decimal places max.
     C                     Z-ADD7         @@IDP            *1
     C                     Z-ADD4         @@IINT           *1
     C                     MOVE *BLANKS   @@ALPH           *1
     C                     MOVE DDINTR    @@ALPH           *1
     C                     MOVE 'N'       @@MTID  1                       E17279
     C                     EXSR ZA0840                     *1
     C           @@ERCD    IFEQ 0                          B*2
     C           @@AMT     DIV  10000000  @INTRD 117       **2
     C                     END                             E*2
     C*
     C           @INTRD    IFNE HNINTR                     B*2
     C           @@ERCD    ORNE 0                          B*2
     C                     MOVE '1'       *IN20            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0374' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOB9                      **2
     C                     END                             E*2
     C                     ELSE                            X1
     C                     MOVE @INTR     DDINTR           *1
     C                     END                             E1
     C*
     C**  Customer number.
     C/COPY WNCPYSRC,MM0028C014
     C                     MOVE *BLANKS   @CSNM
     C********** HNCNUM    IFNE 0                          B1                                 CSD027
     C           HNCNUM    IFNE *BLANKS                    B1                                 CSD027
     C                     MOVELHNCNUM    @CSNM            *1
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP62                                           S01408
      *                                                                   S01408
     C                     END                             E1
      *                                                                   S01408
     C*CO*Y WN*PY*RC*MM0028CP62                                           S01408
     C/COPY WNCPYSRC,MM0028C015                                           S01408
      *                                                                   S01408
     C           DDCSNM    IFNE *BLANKS                    B1
     C           DDCSNM    IFNE @CSNM                      B*2
     C                     MOVE @CSNM     DDCSNM           **2
     C                     MOVE '1'       *IN10            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0387' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     GOTO #ZOB9                      **2
     C                     END                             E*2
     C                     ELSE                            X1
     C                     MOVE @CSNM     DDCSNM           *1
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028C015
     C/COPY WNCPYSRC,MM0028CP73                                           S01408
      *                                                                   CAC001
      **  Process Funding Spread/Rate if Anal Acctg is installed          CAC001
      *                                                                   CAC001
      **  Execute ZA0920 to format the rate, using 7 decimal places       CAC001
      **  and adjusting the file figure to have only implied decimal      CAC001
      **  places.                                                         CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
      *                                                                   CAC001
     C           HNFSRP    IFEQ 0                                         CAC001
     C                     MOVE *BLANKS   @FSRP                           CAC001
     C                     ELSE                                           CAC001
     C           HNFSRP    MULT 10000000  @@AMTW                          CAC001
     C                     Z-ADD7         @@QECN                          CAC001
      *                                                                   CAC001
      **  Reverse sign for display if amount -ve.                         CAC001
      *                                                                   CAC001
     C           @@AMTW    IFLT 0                                         CAC001
     C                     Z-SUB@@AMTW    @@AMTW                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C                     EXSR ZA0920                                    CAC001
     C                     MOVE @@AMTD    @FSRP                           CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C           DDFSRP    IFNE *BLANKS                                   CAC001
      *                                                                   CAC001
      **  Check it is a valid figure with 7 decimal places max.           CAC001
      *                                                                   CAC001
     C                     Z-ADD7         @@IDP                           CAC001
     C                     Z-ADD4         @@IINT                          CAC001
     C                     MOVE *BLANKS   @@ALPH                          CAC001
     C                     MOVE DDFSRP    @@ALPH                          CAC001
     C                     MOVE 'N'       @@MTID                          CAC001
     C                     EXSR ZA0840                                    CAC001
     C           @@ERCD    IFEQ 0                                         CAC001
     C           @@AMT     DIV  10000000  @FSRPD 117                      CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C           @FSRPD    IFNE HNFSRP                                    CAC001
     C           @@ERCD    ORNE 0                                         CAC001
     C                     MOVE '1'       *IN23                           CAC001
     C                     MOVE '1'       *IN41                           CAC001
     C                     MOVEL'MMM0374' @MSGID                          CAC001
     C                     CALL 'ZA0240'                                  CAC001
     C                     PARM           @MSGID                          CAC001
     C                     GOTO #ZOB9                                     CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C                     ELSE                                           CAC001
     C                     MOVE @FSRP     DDFSRP                          CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
     C*
     C           #ZOB9     ENDSR                           **#ZOB9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #ZQ      - Check deal amendment principle            *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*                                                               *
     C* CALLED BY  #ZI    - Validates the display for I and A.        *
     C*            #ZO    - Validate deal number and action code      *
     C*                                                               *
     C* FLDS USED  @DMKY2 - Deam's file key 2                         *
     C*            @DLKEY - Deal file  key                            *
     C*            @VLY   - Deam key 2 value date                     *
     C*            @VLM   - Deam key 2 value date                     *
     C*            @VLD   - Deam key 2 value date                     *
     C*            @SQ    - Deam sequence no. key field               *
     C*            @DMVYR - Deam value date from file                 *
     C*            @DMVMT - Deam value date from file                 *
     C*            @DMVDY - Deam value date from file                 *
     C*            @DMVY  - Convert date to DDMMYY                    *
     C*            @DMVM  - Convert date to DDMMYY                    *
     C*            @DMVD  - Convert date to DDMMYY                    *
     C*            @DMVDT - Deam value date from file                 *
     C*            @TDLA  - This  deam amount                         *
     C*            @MSGID - message id                                *
     C*            @HNSQ  - sequence no. from file                    *
     C*                                                               *
     C*****************************************************************
     C           #ZQ       BEGSR
     C*
     C** If deal amount is -ve make +ve for calculation
     C           H@AMNP    IFLT 0                          B1
     C                     Z-SUBH@AMNP    H@AMNP           *1
     C                     END                             E1
     C*
     C** Process all deams on file for this deal
     C*
     C                     MOVE *LOVAL    @VLD    20
     C                     MOVE *LOVAL    @VLM    20
     C                     MOVE *LOVAL    @VLY    40
     C                     MOVE *LOVAL    @SQ     30
     C                     MOVE '0'       *IN74
     C                     MOVE '0'       *IN18                           E18663
     C                     MOVE *ALL' '   @WKDLN  6                       E18663
     C           @DMKY2    SETLLMMLVDMLL
     C           *IN65     DOUEQ'1'                        B1
     C           *IN18     OREQ '1'                        *1
     C                     READ MMLVDMLL                 65*1
     C                     MOVE HNDA38    @WKDLN                          E18663
     C*
     C**  If a live record is found then a deam exists
     C**  for the deal number
     C           *IN65     IFEQ '0'                        B*2
     C           @WKDLN    ANDEQDDDLNO                                    E18663
     C*
     C**  Place value date from files into same sequence as display (DDMMYY)
     C                     MOVE @DMVYR    @DMVY            **2
     C           BJDFIN    IFEQ 'D'                        B**3           BHF947
     C                     MOVE @DMVMT    @DMVM            **2
     C                     MOVE @DMVDY    @DMVD            **2
     C                     ELSE                            X**3           BHF947
     C                     MOVE @DMVMT    @DMVD            ***3           BHF947
     C                     MOVE @DMVDY    @DMVM            ***3           BHF947
     C                     END                             E**3           BHF947
     C*
     C** If DEAM amount is -ve make +ve for calculation
     C           HNAMNP    IFLT 0                          B**3
     C                     Z-SUBHNAMNP    HNAMNP           ***3
     C                     END                             E**3
     C*
     C** If current transaction is an insert of a 'PD' & value date
     C** of current transaction is < value date of record read
     C** subtract amount from current transaction from deal amount
     C*
     C                     MOVEL@DMVDT    @DAT1            *1             105883
     C                     CALL 'ZA0270'                   *1             105883
     C                     PARM           @DAT1   60       *1             105883
     C                     PARM           BJDFIN           **2            105883
     C                     PARM           @RTCDE  1        *1             105883
     C                     PARM           VDYNO1  50       *1             105883
     C           DDACTN    IFEQ 'I'                        B**3
     C           DDMTYP    ANDEQ'PD'                       ***3
     C***********DDVDAT    ANDLT@DMVDT                     ***3           105883
     C           @VDYNO    ANDLTVDYNO1                     B*2            138107
     C           *IN74     ANDEQ'0'                        ***3           E29460
     C           H@AMNP    SUB  @TDLA     H@AMNP           ***3
     C*
     C** Set on ind. to show calc. performed for current transaction
     C                     MOVE '1'       *IN74            ***3
     C**                                                                  E29460
     C           H@AMNP    IFLT *ZERO                      B***4          E29460
     C                     MOVE '1'       *IN18            ****4          E29460
     C                     MOVE '1'       *IN41            ****4          E29460
     C                     MOVEL'MMM0295' @MSGID           ****4          E29460
     C                     CALL 'ZA0240'                   ****4          E29460
     C                     PARM           @MSGID           ****4          E29460
     C                     GOTO #ZQ9                       ****4          E29460
     C                     END                             E***4          E29460
     C                     END                             E**3           E29460
     C**                                                                  E18811
     C***Else*if*value*date*of*current*transaction*is*>*or*=*to*recoE18811E29460
     C***read,principal*amount*must*be*adjusted*accordingly.***     E18811E29460
     C** If an insert of a principal decrease then the                    E29460
     C** principal amount must be adjusted accordingly.                   E29460
     C*********            ELSE                                     E18811E29460
     C           DDACTN    IFEQ 'I'                                       E18811
     C           DDMTYP    ANDEQ'PD'                                      E18811
     C***********DDVDAT    ANDGE@DMVDT                              E18811E29460
     C*                                                                   E18811
     C           HNMTYP    IFEQ 'PD'                                      E18811
     C           H@AMNP    SUB  HNAMNP    H@AMNP                          E18811
     C                     ELSE                                           E18811
     C           HNMTYP    IFEQ 'PI'                                      E18811
     C           H@AMNP    ADD  HNAMNP    H@AMNP                          E18811
     C                     END                                            E18811
     C                     END                                            E18811
     C                     END                                            E18811
     C           H@AMNP    IFLT *ZERO                      B***4
     C                     MOVE '1'       *IN18            ****4
     C                     MOVE '1'       *IN41            ****4
     C                     MOVEL'MMM0295' @MSGID           ****4
     C                     CALL 'ZA0240'                   ****4
     C                     PARM           @MSGID           ****4
     C                     GOTO #ZQ9                       ****4
     C                     END                             E***4
     C*********            END                             E**3           E29460
     C*
     C** If current transaction is a delete of a 'PI' & record read
     C** is record to be deleted ignore it
     C*
     C           DDMTYP    IFEQ 'PI'                       B**3
     C*
     C** Place sequence number into alpha field for comparison
     C                     MOVE *BLANKS   @HNSQ            ***3
     C                     MOVE HNDS38    @HNSQ   3        ***3
     C           DDACTN    IFNE 'D'                        B***4
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP10                                           S01408
     C*                                                                   S01408
     C           DDVDAT    ORNE @DMVDT                     ****4
     C           @HNSQ     ORNE DDDS38                     ****4
     C*
     C** If record read is PI add deam amount to deal principle
     C           HNMTYP    IFEQ 'PI'                       B****5
     C           H@AMNP    ADD  HNAMNP    H@AMNP           *****5
     C                     END                             E****5
     C                     END                             E***4
     C** Move end to after check if PCPL >= 0.                            E18811
     C***********          END                             E**3           E18811
     C*
     C** If read transaction is a 'PD' subtract deam amount
     C** from deal principle
     C           HNMTYP    IFEQ 'PD'                       B**3
     C           H@AMNP    SUB  HNAMNP    H@AMNP           ***3
     C                     END                             E**3
     C*
     C** New principle must be = or > 0.
     C           H@AMNP    IFLT *ZERO                      B**3
     C                     MOVE '1'       *IN18            ***3
     C                     MOVE '1'       *IN41            ***3
     C                     MOVEL'MMM0295' @MSGID           ***3
     C                     CALL 'ZA0240'                   ***3
     C                     PARM           @MSGID           ***3
     C                     GOTO #ZQ9                       ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C                     END                                            E18811
     C*
     C**  If insert of a deam has not yet been subtracted from deal
     C**  principle calculate new principle.
     C           DDACTN    IFEQ 'I'                        B1
     C           DDMTYP    ANDEQ'PD'                       *1
     C           *IN18     ANDNE'1'                        *1
     C           *IN74     ANDNE'1'                        *1
     C*
     C           H@AMNP    SUB  @TDLA     H@AMNP           *1
     C*
     C           H@AMNP    IFLT *ZERO                      B*2
     C                     MOVE '1'       *IN18            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM0295' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C           #ZQ9      ENDSR                           **#ZQ9**
     C*
     C/EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDAT10Z2                                               056095
     C*******************************************************************
     C***********                                                         056095
     C**ZA0680*-*THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO         056095
     C***********MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)         056095
     C***********                                                         056095
     C**CALLED*BY :                                                       056095
     C***********                                                         056095
     C**CALLS*:**                                                         056095
     C***********                                                         056095
     C**INPUT**:*@@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)   056095
     C***********                                                         056095
     C**OUTPUT*:*@@MDNO MIDAS DAY NUMBER  (SIZE : 5N)                     056095
     C***********                                                         056095
     C**USES*:***@@CC   NUMBER OF CENTURIES IN DATE                       056095
     C***********@@DAY  DAY NUMBER                                        056095
     C***********@@REM  REMAINDER FROM DIVIDE                             056095
     C***********@@MTH  MONTH NUMBER                                      056095
     C***********@MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       MONTH                                             056095
     C***********@@WK2  WORK FIELD (2,0)                                  056095
     C***********@@WK5  WORK FIELD (5,0)                                  056095
     C***********@@YYYY YEAR (4 CHARACTER)                                056095
     C***********@@YY   YEAR (2 CHARACTER)                                056095
     C***********@YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       A FOUR YEAR PERIOD                                056095
     C***********                                                         056095
     C******LAST*AMEND NO. ME1257              DATE 02/04/87              05*095
     C******When*date input is zero set output date to zeroes             05*095
     C***********                                                         056095
     C******************************************************************* 056095
     C***********                                                         056095
     C***********ZA0680    BEGSR                                          056095
     C***********                                                         056095
     C****CLEAR*OUT ANY 'OLD' DATA IN FIELD                               056095
     C***********          Z-ADD0         @@MDNO  50                      056095
     C***********                                                         056095
     C***********@@DTIN    CABEQ0         ZA0689                    ME1257056095
     C***********                                                         056095
     C*****IF*DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING          056095
     C*****WORK*OUT THE NUMBER OF CENTURIES PASSED SINCE 1971,            056095
     C*****BY*SUBTRACTING 1972 FROM THE YEAR FIELD.                       056095
     C***********@@YYYY    IFGE 2072                       B1             056095
     C***********@@YYYY    SUB  1972      @@YYYY           *1             056095
     C***********                                                         056095
     C*****MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)             056095
     C*****THEN*RESTORE THE YEAR WHICH WAS INPUT BACK TO THE              056095
     C*****ORIGINAL VALUE BEFORE CONTINUING WITH NORMAL CALCULATIONS.     056095
     C***********                                                         056095
     C***********@@CC      MULT 36524     @@MDNO           *1             056095
     C***********@@YYYY    ADD  1972      @@YYYY           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C***********@@YYYY    ADD  28        @@WK2   20                      056095
     C***********                                                         056095
     C***********@@WK2     DIV  4         @@WK2                           056095
     C***********          MVR            @@REM   10                      056095
     C***********                                                         056095
     C******MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD                056095
     C***********@@WK2     MULT 1461      @@WK5   50                      056095
     C***********          ADD  @@WK5     @@MDNO                          056095
     C***********                                                         056095
     C****CHECK*REMAINDER AND MONTH NUMBER                                056095
     C***********@@REM     IFEQ 0                          B1             056095
     C***********@@MTH     ANDGT2                          B1             056095
     C***********          ADD  1         @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****YEAR*NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR               056095
     C***********@@REM     IFNE 0                          B1             056095
     C***********          ADD  @YD,@@REM @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****ADD*MONTHS THIS YEAR                                            056095
     C***********          ADD  @MD,@@MTH @@MDNO                          056095
     C***********                                                         056095
     C****ADD*DAYS THIS MONTH                                             056095
     C***********          ADD  @@DAY     @@MDNO                          056095
     C***********                                                         056095
     C***********ZA0689    ENDSR                           **ZA0689 TAG** 056095
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #ZP      - Authorize processing.                     *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          #ZK      - Retrieves a record and displays it.       *
     C*          #ZF      - Move store to screen.                     *
     C*          #ZI      - Validates the display for I and A.        *
     C*          #ZG      - Calls update routines.                    *
     C*                                                               *
     C* CALLED BY  #BD    - enter processing                          *
     C*            #BDAA    - Calls new record update routines.       *
     C*                                                               *
     C* FLDS USED  @MSGID - message id                                *
     C*            @CSNM  - stored customer                           *
     C*            @MTYP  - Stored deal type                          *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @DLNO  - stored deal number                        *
     C*            @MTYP  - Stored deal type                          *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @INTR  - stored spread rate                        *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C******       @ORCM  - stored rec. settlement method             *   S01177
     C******       @MORI  - stored our rec. bank a/c debit            *   S01177
     C******       @MCPI  - stored c'party paying bank                *   S01177
     C******       @MFAO  - stored for a/c of                         *   S01177
     C******       @SPEC  - stored special instructions               *   S01177
     C*            @RSTM  - stored rcpt settlement method             *   S01177
     C*            @RONS  - stored rcpt our nostro                    *   S01177
     C*            @RIBN  - stored rcpt intermed bank no.             *   S01177
     C*            @RIBA  - stored rcpt intermed bank a/c line        *   S01177
     C*            @ROBN  - stored rcpt ordering bank no.             *   S01177
     C*            @ROCN  - stored rcpt ordering customer no.         *   S01177
     C*            @PSTM  - stored pay settlement method              *   S01177
     C*            @PONS  - stored pay our nostro                     *   S01177
     C*            @PIBN  - stored pay intermed bank no.              *   S01177
     C*            @PIBA  - stored pay intermed bank a/c line         *   S01177
     C*            @POBN  - stored pay ordering bank no.              *   S01177
     C*            @POCN  - stored pay ordering customer no.          *   S01177
     C*            @RCRN  - stored receiver correspondant no.         *   S01177
     C*            @RCRA  - stored receiver corr a/c line             *   S01177
     C*            @RVNO  - stored receiver no.                       *   S01177
     C*            @AWBN  - stored a/c with bank no.                  *   S01177
     C*            @AWBA  - stored a/c with bank a/c line             *   S01177
     C*            @BENN  - stored beneficiary no.                    *   S01177
     C*            @BENA  - stored beneficiary a/c line               *   S01177
     C*            @DTP1  - stored details of payment 1               *   S01177
     C*            @DTP2  - stored details of payment 2               *   S01177
     C*            @DTP3  - stored details of payment 3               *   S01177
     C*            @DTP4  - stored details of payment 4               *   S01177
     C*            @DCHG  - stored details of charges                 *   S01177
     C*            @BTB1  - stored bank to bank info 1                *   S01177
     C*            @BTB2  - stored bank to bank info 2                *   S01177
     C*            @BTB3  - stored bank to bank info 3                *   S01177
     C*            @BTB4  - stored bank to bank info 4                *   S01177
     C*            @BTB5  - stored bank to bank info 5                *   S01177
     C*            @BTB6  - stored bank to bank info 6                *   S01177
     C*            @CVMR  - cover MT202 required                      *   E22405
     C*            @CSNM  - stored customer                           *
     C*            @TERM  -  Termination parameter                    *
     C*                                                               *
     C*****************************************************************
     C           #ZP       BEGSR
     C/COPY WNCPYSRC,MM0028C141
     C*
     C**  If key work fields are not the same as screen fields, then
     C**  the record is not already being displayed.
     C           DDDLNO    IFNE @DLNO                      B1
     C           DDDLNO    OREQ *BLANKS                    *1
     C*
     C**  Chain to file and display on screen.
     C                     EXSR #ZK                        *1
     C*
     C                     ELSE                            X1
     C*
     C**  If the action code is not X, it is invalid.
     C           DDACTN    IFNE 'X'                        B*2
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP7                                           S01408
     C*                                                                   S01408
     C*
     C**  Set up error output for screen.
     C                     MOVE '1'       *IN41            **2
     C***                  MOVE '1'       *IN10            **2            S01177
     C                     MOVE '1'       *IN01            **2            S01177
     C*
     C                     MOVEL'MMM1025' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*
     C**  Restore former field values.
     C                     EXSR #ZF                        **2
     C*
     C**  By-pass further amend processing.
     C                     GOTO #ZP9                       **2
     C*
     C                     END                             E*2
     C*
     C**  Record was displayed last cycle: check that no amendments to
     C**  fields have been made.
     C*
     C           DDDLNO    IFNE @DLNO                      B*2            S01177
     C           DDMTYP    ORNE @MTYP                      B*2            S01177
     C           DDCSNM    ORNE @CSNM                      B*2            S01177
     C           DDVDAT    ORNE @VDAT                      B*2            S01177
     C           DDDS38    ORNE @DS38                      B*2            S01177
     C           DDCCY     ORNE @CCY                       B*2            S01177
     C           DDAMNP    ORNE @AMNP                      B*2            S01177
     C           DDINTR    ORNE @INTR                      B*2            S01177
     C           DDFSRP    ORNE @FSRP                                     CAC001
     C           DDLSQN    ORNE @LSQN                      B*2            S01177
     C/COPY WNCPYSRC,MM0028CP48                                           S01408
     C*****      DDORCM    ORNE @ORCM                      B*2            S01177
     C*****      DDMORI    ORNE @MORI                      B*2            S01177
     C*****      DDMCPI    ORNE @MCPI                      B*2            S01177
     C*****      DDMFAO    ORNE @MFAO                      B*2            S01177
     C*****      DDSPEC    ORNE @SPEC                      B*2            S01177
     C** also check second screen parms                                   S01177
     C           PMRSTM    ORNE @RSTM                      **2            S01177
     C           PMRONS    ORNE @RONS                      **2            S01177
     C           PARIBN    ORNE @RIBN                      **2            S01177
     C           PMRIBA    ORNE @RIBA                      **2            S01177
     C           PAROBN    ORNE @ROBN                      **2            S01177
     C           PAROCN    ORNE @ROCN                      **2            S01177
     C           PMPSTM    ORNE @PSTM                      **2            S01177
     C           PMPONS    ORNE @PONS                      **2            S01177
     C           PAPIBN    ORNE @PIBN                      **2            S01177
     C           PMPIBA    ORNE @PIBA                      **2            S01177
     C           PAPOBN    ORNE @POBN                      **2            S01177
     C           PAPOCN    ORNE @POCN                      **2            S01177
     C           PARCRN    ORNE @RCRN                      **2            S01177
     C           PMRCRA    ORNE @RCRA                      **2            S01177
     C           PARVNO    ORNE @RVNO                      **2            S01177
     C           PAAWBN    ORNE @AWBN                      **2            S01177
     C           PMAWBA    ORNE @AWBA                      **2            S01177
     C           PABENN    ORNE @BENN                      **2            S01177
     C           PMBENA    ORNE @BENA                      **2            S01177
     C           PMDTP1    ORNE @DTP1                      **2            S01177
     C           PMDTP2    ORNE @DTP2                      **2            S01177
     C           PMDTP3    ORNE @DTP3                      **2            S01177
     C           PMDTP4    ORNE @DTP4                      **2            S01177
     C           PMDCHG    ORNE @DCHG                      **2            S01177
     C           PMBTB1    ORNE @BTB1                      **2            S01177
     C           PMBTB2    ORNE @BTB2                      **2            S01177
     C           PMBTB3    ORNE @BTB3                      **2            S01177
     C           PMBTB4    ORNE @BTB4                      **2            S01177
     C           PMBTB5    ORNE @BTB5                      **2            S01177
     C           PMBTB6    ORNE @BTB6                      **2            S01177
     C           PMCVMR    ORNE @CVMR                      **2            E22405
     C           PMROBR    ORNE @ROBR                      **2            LN0822
     C           PMPOBR    ORNE @POBR                      **2            LN0822
     C           PMRSCY    ORNE @RSCY                                     CEU003
     C           PMPSCY    ORNE @PSCY                                     CEU003
     C           PMIC72    ORNE @IC72                                     CEU003
     C** set up error output
     C***                  MOVE '1'       *IN10            **2            S01177
     C                     MOVE '1'       *IN01            **2            S01177
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM1026' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*
     C** restore field values
     C                     EXSR #ZF                        **2
     C*
     C                     GOTO #ZP9                       **2
     C*
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C**  Allow  call to SD2410  to validate settlement details
     C                     MOVE '0'       *IN77                           S01177
     C                     MOVE 'N'       PMSDTV                          S01177
     C*                                                                   S01177
     C**  Validate screen data before authorising
     C                     EXSR #ZI
     C**  Bypass update processing if database or validation error
     C           @TERM     CABEQ'E'       #ZP9
     C/COPY WNCPYSRC,MM0028C104
     C           *IN41     CABEQ'1'       #ZP9
     C/COPY WNCPYSRC,MM0028C105
     C*
     C**  The entry must now be valid, call update processing
     C                     EXSR #ZG
     C*
     C*
     C           #ZP9      ENDSR                           **#ZP9**
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDATE9Z3                                               056095
     C*****************************************************************
     C***********                                                     *   056095
     C********TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *   056095
     C***********                                                     *   056095
     C********SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *   056095
     C********PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *   056095
     C********THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *   056095
     C********SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *   056095
     C********IF*'@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *   056095
     C********'@@VDT'  IN 'YYYYMMDD' FORMAT.                          *   056095
     C***********                                                     *   056095
     C**NOTE:*FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS                  056095
     C***********                                                     *   056095
     C********1)*@@DAYN   LENGTH 5,0.                                 *   056095
     C***********                                                     *   056095
     C********FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *   056095
     C***********                                                     *   056095
     C********1)*@@VDT    LENGTH 8,0 DEFINED BY A DS.                 *   056095
     C********2)*@@RTN    LENGTH 1,0.                                 *   056095
     C********3)*@@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *   056095
     C********4)*@@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *   056095
     C********5)*@@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *   056095
     C********6)*@@RDAY   LENGTH 5,0.                                 *   056095
     C********7)*@@LEAP   LENGTH 1,0.                                     056095
     C***********                                                     *   056095
     C********INDICATORS USED ARE:                                    *   056095
     C***********                                                     *   056095
     C********1)*80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *   056095
     C********2)*81       CHECK FOR LOW ON ARRAY @MD.                 *   056095
     C***********                                                     *   056095
     C**INPUT*FIELD:       @@DAYN                                     *   056095
     C***********                                                     *   056095
     C**OUTPUT*FIELD:      @@VDT                                      *   056095
     C***********                                                     *   056095
     C**WORK*FIELDS:       @@RTN                                      *   056095
     C***********          @@Z71Y                                     *   056095
     C***********          @@RDAY                                     *   056095
     C***********          @@LEAP                                     *   056095
     C***********          @@I                                        *   056095
     C***********          @@J                                        *   056095
     C***********                                                     *   056095
     C**ARRAYS*USED:       @YD COMPILE TIME ARRAY.                        056095
     C***********          @MD COMPILE TIME ARRAY.                        056095
     C***********                                                         056095
     C******LAST*AMEND NO. ME1257              DATE 02/04/87          *   056095
     C******When*date input is zero set output date to zeroes         *   056095
     C***********                                                         056095
     C*****************************************************************   056095
     C***********                                                         056095
     C***********ZA0710    BEGSR                                          056095
     C***********                                                         056095
     C***********          SETOF                     8081                 056095
     C***********          Z-ADD0         @@RTN   10                      056095
     C***********          Z-ADD0         @@VDT                           056095
     C***********          Z-ADD1         @@I     20                      056095
     C***********          Z-ADD1         @@J     20                      056095
     C***********          Z-ADD1         @@LEAP  10                      056095
     C***********                                                         056095
     C***********@@DAYN    CABEQ0         ZA0719                    ME1257056095
     C***********                                                         056095
     C***********@@DAYN    IFLT 1                                         056095
     C***********          Z-ADD1         @@RTN                           056095
     C***********          GOTO ZA0719                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**DIVISION*TO DETERMINE WETHER LEAP YEAR.                           056095
     C***********                                                         056095
     C***********@@DAYN    DIV  1461      @@Z71Y                          056095
     C***********          MVR            @@RDAY  50                      056095
     C***********                                                         056095
     C**CALCULATING YEAR.                                                 056095
     C***********                                                         056095
     C***********@@Z71Y    MULT 4         @@Z71Y                          056095
     C***********          ADD  1972      @@Z71Y                          056095
     C***********                                                         056095
     C**CHECKING*IF YEAR IS GREATER THAN OR EQUAL TO 2100                 056095
     C***********                                                         056095
     C***********@@Z71Y    IFGE 2100                                      056095
     C***********          ADD  @@SSY2    @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOKUP*ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE        056095
     C**HAVE*PASSED.                                                      056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@YD,@@I                8080               056095
     C***********                                                         056095
     C**IF*YEAR*IS A LEAP YEAR SSLEAP IS SET TO ZERO.                     056095
     C***********                                                         056095
     C************IN80     IFEQ '0'                                       056095
     C***********          Z-ADD0         @@LEAP                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**ADD*INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 1                                         056095
     C***********@@RDAY    SUB  @YD,@@I   @@RDAY                          056095
     C***********          ADD  @@I       @@Z71Y                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**PROCESSING FOR A LEAP YEAR.                                       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 0                                         056095
     C***********                                                         056095
     C**IF*'@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.                   056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 60                                        056095
     C***********          Z-ADD29        @@Z71D                          056095
     C***********          Z-ADD2         @@Z71M                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*'@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN    056095
     C**PROCEED*AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP     056095
     C**YEAR.*NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.          056095
     C***********                                                         056095
     C***********@@RDAY    IFGT 60                                        056095
     C***********@@RDAY    SUB  1         @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*DAY*'@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS      056095
     C**IN*4*YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR      056095
     C**GROUP.***                                                         056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 0                                         056095
     C***********          Z-ADD31        @@Z71D                          056095
     C***********          Z-ADD12        @@Z71M                          056095
     C***********          SUB  1         @@Z71Y                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOOK*UP*ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'         056095
     C**OCCURS*IN                                                         056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@MD,@@J                81                 056095
     C***********          Z-ADD@@J       @@Z71M                          056095
     C***********@@RDAY    SUB  @MD,@@J   @@Z71D                          056095
     C***********                                                         056095
     C**DS*@@VDT* IS RETURNED IN YYYYMMDD FORMAT                          056095
     C***********                                                         056095
     C***********ZA0711    TAG                                            056095
     C***********                                                         056095
     C***********          MOVE @@Z71Y    @@YR                            056095
     C***********                                                         056095
     C***********ZA0719    ENDSR                                          056095
     C*****************************************************************
      /EJECT                                                              CAC001
      *****************************************************************   CAC001
      *                                                               *   CAC001
      *  SRERAT - Subroutine to calculate new effective rates         *   CAC001
      *                                                               *   CAC001
      *  Called by: #ZI - Deal amendment validation                   *   CAC001
      *  Calls:                                                       *   CAC001
      *                                                               *   CAC001
      *****************************************************************   CAC001
     C           SRERAT    BEGSR                                          CAC001
      *                                                                   CAC001
     C                     MOVE '1'       *IN24                           CAC001
     C                     MOVE '0'       *IN25                           CAC001
      *                                                                   CAC001
      **  Calculate New Effective Interest Rate                           CAC001
      *                                                                   CAC001
      **  New Interest Rate/Spread as entered for current deal amend      CAC001
      *                                                                   CAC001
     C           DDINTR    IFNE *BLANKS                                   CAC001
     C                     Z-ADDIGINTR    WIRTS  117                      CAC001
      *                                                                   CAC001
      **  Or, if no Interest Rate/Spread entered, from another 'SC'       CAC001
      **  with value date <= current deal amendment value date            CAC001
      *                                                                   CAC001
     C                     ELSE                                           CAC001
     C                     MOVE DDDLNO    @DLKEY                          CAC001
     C           DDDS38    IFEQ *BLANKS                                   CAC001
     C                     MOVE '999'     @KSEQN                          CAC001
     C                     ELSE                                           CAC001
     C                     MOVE DDDS38    @KSEQN                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Look for last 'SC' for the entered deal                         CAC001
      *                                                                   CAC001
     C           @DMKEY    SETGTMMLVDMLL                                  CAC001
     C           *IN25     DOUEQ*ON                                       CAC001
     C           HNMTYP    OREQ 'SC'                                      CAC001
     C           HNIRCF    ANDEQ'Y'                                       CAC001
     C           HNDA38    ORNE @DLKEY                                    CAC001
     C                     READPMMLVDMLL                 25               CAC001
     C                     ENDDO                                          CAC001
      *                                                                   CAC001
     C           HNMTYP    IFEQ 'SC'                                      CAC001
     C           HNIRCF    ANDEQ'Y'                                       CAC001
     C           HNDA38    ANDEQ@DLKEY                                    CAC001
     C                     Z-ADDHNINTR    WIRTS                           CAC001
      *                                                                   CAC001
      **  Or, if no Int Rate/Spread entered & no other 'SC' for deal,     CAC001
      **  use original deal rate/spread                                   CAC001
      *                                                                   CAC001
     C                     ELSE                                           CAC001
      *                                                                   CAC001
      **  If deal has base rate, use spread rate, else use current deal   CAC001
      **  interest rate                                                   CAC001
      *                                                                   CAC001
     C           HKBSRC    IFNE *BLANKS                                   CAC001
     C                     Z-ADDHKSPRD    WIRTS                           CAC001
     C                     ELSE                                           CAC001
     C                     Z-ADDHKINTR    WIRTS                           CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Obtain Base Rate Code                                           CAC001
      *                                                                   CAC001
     C                     MOVE HKBSRC    WBSRC   2                       CAC001
      *                                                                   CAC001
      **  If deal is linked to a Base Rate...                             CAC001
      *                                                                   CAC001
     C           WBSRC     IFNE *BLANKS                                   CAC001
      *                                                                   CAC001
      **  Retrieve Base Rate Code details                                 CAC001
      *                                                                   CAC001
     C                     CALL 'AOBSRTR0'                                CAC001
     C                     PARM *BLANKS   @RTCD                           CAC001
     C                     PARM '*KEY   ' @OPTN                           CAC001
     C                     PARM DDCCY     @BRCY   3                       CAC001
     C                     PARM WBSRC     @BRCD   2                       CAC001
     C********** SDBSRT    PARM SDBSRT    DSFDY                     CAC001CSD006
     C           SDBSRT    PARM SDBSRT    DSSDY                           CSD006
      *                                                                   CAC001
      **  Check for database error                                        CAC001
      *                                                                   CAC001
     C           @RTCD     IFNE *BLANK                                    CAC001
     C                     MOVEL'SDBSRTPD'DBFILE           ************   CAC001
     C                     MOVEL'020'     DBASE            * DBERR 020*   CAC001
     C                     MOVEL@OPTN     DBOPTN           ************   CAC001
     C                     MOVEL@BRCY     WBRKY   5                       CAC001
     C                     MOVE @BRCD     WBRKY                           CAC001
     C                     MOVELWBRKY     DBKEY                           CAC001
     C                     MOVE '1'       *INU7                           CAC001
     C                     MOVE '1'       *INU8                           CAC001
     C                     MOVE '1'       *INKC                           CAC001
     C                     EXSR #C                                        CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Determine actual base rate                                      CAC001
      *                                                                   CAC001
     C           @VDYNO    IFLT BAVDNR                                    CAC001
     C                     Z-ADDBACBSR    WBSRT  117                      CAC001
     C                     ELSE                                           CAC001
     C                     Z-ADDBANBRT    WBSRT                           CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C           WBSRT     ADD  WIRTS     WEFIR  117                      CAC001
      *                                                                   CAC001
      **  If deal is not linked to a Base Rate, eff. int. rate = WIRTS    CAC001
      *                                                                   CAC001
     C                     ELSE                                           CAC001
     C                     Z-ADDWIRTS     WEFIR                           CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Do not perform tolerance check if new eff. int. rate = 0        CAC001
      *                                                                   CAC001
     C           WEFIR     IFEQ 0                                         CAC001
     C                     MOVE '0'       *IN24                           CAC001
     C                     GOTO SRERA9                                    CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Calculate New Funding Rate/Spread                               CAC001
      *                                                                   CAC001
     C                     MOVE '0'       *IN25                           CAC001
      *                                                                   CAC001
      **  New Funding Rate/Spread as entered for current deal amend       CAC001
      *                                                                   CAC001
     C           DDFSRP    IFNE *BLANKS                                   CAC001
     C                     Z-ADDIGFSRP    WFRSP  117                      CAC001
      *                                                                   CAC001
      **  Or, if no Funding Rate/Spread entered, from another 'SC'        CAC001
      **  with value date <= current deal amendment value date            CAC001
      *                                                                   CAC001
     C                     ELSE                                           CAC001
     C                     MOVE DDDLNO    @DLKEY                          CAC001
     C           DDDS38    IFEQ *BLANKS                                   CAC001
     C                     MOVE '999'     @KSEQN                          CAC001
     C                     ELSE                                           CAC001
     C                     MOVE DDDS38    @KSEQN                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Look for last 'SC' for the entered deal                         CAC001
      *                                                                   CAC001
     C           @DMKEY    SETGTMMLVDMLL                                  CAC001
     C           *IN25     DOUEQ*ON                                       CAC001
     C           HNMTYP    OREQ 'SC'                                      CAC001
     C           HNFRCF    ANDEQ'Y'                                       CAC001
     C           HNDA38    ORNE @DLKEY                                    CAC001
     C                     READPMMLVDMLL                 25               CAC001
     C                     ENDDO                                          CAC001
      *                                                                   CAC001
     C           HNMTYP    IFEQ 'SC'                                      CAC001
     C           HNFRCF    ANDEQ'Y'                                       CAC001
     C           HNDA38    ANDEQ@DLKEY                                    CAC001
     C                     Z-ADDHNFSRP    WFRSP                           CAC001
      *                                                                   CAC001
      **  Or, if Interest Rate/Spread entered & no other 'SC' for deal,   CAC001
      **  use original deal rate/spread                                   CAC001
      *                                                                   CAC001
     C                     ELSE                                           CAC001
     C                     MOVE '1'       *IN25                           CAC001
     C                     Z-ADDHKFSRP    WFRSP                           CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Do not perform tolerance check if new eff. int. rate = 0        CAC001
      *                                                                   CAC001
     C           WFRSP     IFEQ 0                                         CAC001
     C                     MOVE '0'       *IN24                           CAC001
     C                     GOTO SRERA9                                    CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
      **  Calculate New Effective (Actual) Funding Rate                   CAC001
      *                                                                   CAC001
     C           HKFSGN    IFEQ *BLANKS                                   CAC001
     C                     Z-ADDWFRSP     WEFFR  117                      CAC001
     C                     ELSE                                           CAC001
     C           HKFSGN    IFEQ '+'                                       CAC001
     C           WEFIR     ADD  WFRSP     WEFFR                           CAC001
     C                     ELSE                                           CAC001
     C           WEFIR     SUB  WFRSP     WEFFR                           CAC001
     C                     ENDIF                                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C           SRERA9    ENDSR                                          CAC001
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE ZA0770 - THIS SUBROUTINE RECEIVES A 8/0 INPUT     *
     C*                      DATE - FORMAT YYYYMMDD AND OUTPUTS A     *
     C*                      6/0 DATE. IF FIELD DATF ON TABTB10 =     *
     C*                      'M' OUTPUT FORMAT MMDDYY. IF FIELD       *
     C*                      DATF = 'D' OUTPUT FORMAT DDMMYY.         *
     C*                                                               *
     C*  CALLED BY   :                                                *
     C*                                                               *
     C*  INPUT       : @@DTIN  - DATE INPUT (8,0)                     *
     C*  OUTPUT      : @@DTOU  - DATE OUTPUT (6,0)                    *
     C*                                                               *
     C*  WORK FIELDS : @@YYY   - YEAR IN (2,0)                        *
     C*              : @@MM    - MONTH IN (2,0)                       *
     C*              : @@DD    - DAY IN (2,0)                         *
     C*                                                               *
     C*              : @@DAT1  - IF DATE DD/MM/YY DAY ELSE MONTH (2,0)*
     C*              : @@DAT2  - IF DATE DD/MM/YY MONTH ELSE DAY (2,0)*
     C*                                                               *
     C*****************************************************************
     C/EJECT
     C           ZA0770    BEGSR
     C*
     C                     Z-ADD@@YY      @@YYY
     C*
     C****DATF = 'D' CONVERT TO MMDDYY FORMAT                     *****   S01194
     C**  BJFKST = 'D' CONVERT TO MMDDYY FORMAT                           S01194
     C*****      DATF      IFEQ 'D'                        B1     *****   S01194
     C           BJDFIN    IFEQ 'D'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT1           *1
     C                     Z-ADD@@MM      @@DAT2           *1
     C                     END                             E1
     C*
     C*
     C****DATF = 'M' CONVERT TO MMDDYY FORMAT                     *****   S01194
     C**  BJFKST = 'M' CONVERT TO MMDDYY FORMAT                           S01194
     C*****      DATF      IFEQ 'M'                        B1     *****   S01194
     C           BJDFIN    IFEQ 'M'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT2           *1
     C                     Z-ADD@@MM      @@DAT1           *1
     C                     END                             E1
     C*
     C           ZA0779    ENDSR                           ***ZA0779***
      /EJECT
     C/COPY ZSRSRC,ZACCH
     C/COPY ZSRSRC,ZF2C                                                   092455
     C/COPY ZSRSRC,ZCHKH
     C*****************************************************************   S01195
     C*****                                                       *****   S01195
     C**ZA0830 - THIS SUBROUTINE FINDS OUT WHETHER A PARTICULAR DA*****   S01195
     C*****      IS A HOLIDAY IN A PARTICULAR CURRENCY            *****   S01195
     C*****                                                       *****   S01195
     C**CALLED BY :                                               *****   S01195
     C*****                                                       *****   S01195
     C**CALLS :                                                   *****   S01195
     C*****                                                       *****   S01195
     C**INPUT  : @@MNO  MIDAS DAY NUMBER 5N                       *****   S01195
     C*****      @@CCY  CURRENCY CODE 3A                          *****   S01195
     C*****                                                       *****   S01195
     C**OUTPUT : @@HIND HOLIDAY/WORKING DAY INDICATOR 1A          *****   S01195
     C*****                                                       *****   S01195
     C**USES :   @@MNO  MIDAS DAY NUMBER                          *****   S01195
     C*****      @@CCY  CURRENCY CODE                             *****   S01195
     C*****      @@ONCE FIRST TIME THROUGH INDICATOR              *****   S01195
     C*****      @@CY1  FIRST HALF OF CURRENCY ARRAY              *****   S01195
     C*****      @@CY2  SECOND HALF OF CURRENCY ARRAY             *****   S01195
     C*****      @@MNO6 MIDAS NUMBER WITH TRAILING BLANK          *****   S01195
     C*****      @@HIND HOLIDAY/WORKING DAY INDICATOR             *****   S01195
     C*****      @@INEX INCLUDE/EXCLUDE INDICATOR                 *****   S01195
     C*****                                                       *****   S01195
     C*****      INDICATORS                                       *****   S01195
     C*****      80 RECORD NOT FOUND                              *****   S01195
     C*****      81 CURRENCY NOT FOUND ON RECORD                  *****   S01195
     C*****                                                       *****   S01195
     C*****************************************************************   S01195
     C*****      ZA0830    BEGSR                                  *****   S01195
     C*****                                                       *****   S01195
     C*****   CURRENCY/HOLIDAY FILE IF FIRST TIME THROUGH         *****   S01195
     C*****      @@ONCE    IFNE 'Y'                        B1     *****   S01195
     C*****                 *   FDTABJLL                   *1     *****   S01195
     C*****                MOVE 'Y'       @@ONCE  1        *1     *****   S01195
     C*****                END                             E1     *****   S01195
     C*****                                                       *****   S01195
     C***BLANK OUT ARRAY                                          *****   S01195
     C*****                MOVE *BLANKS   @@CY1                   *****   S01195
     C*****                MOVE *BLANKS   @@CY2                   *****   S01195
     C*****                                                       *****   S01195
     C***ACCESS TABLE ON FIRST KEY                                *****   S01195
     C*****                MOVEL@@MNO     @@MNO6  6               *****   S01195
     C*****                MOVE @@MNO6    SS0830 12               *****   S01195
     C*****                MOVEL'22    '  SS0830                  *****   S01195
     C*****                MOVE '1'       SS0830                  *****   S01195
     C*****      SS0830    CHAINTABLETJF             80           *****   S01195
     C*****                                                       *****   S01195
     C***** RECORD NOT FOUND OR DELETED                           *****   S01195
     C*****      *IN80     IFEQ '1'                        B1     *****   S01195
     C*****      RECI      OREQ '*'                        *1     *****   S01195
     C*****                MOVE 'W'       @@HIND           *1     *****   S01195
     C*****                GOTO ZA0839                     *1     *****   S01195
     C*****                END                             E1     *****   S01195
     C*****                                                       *****   S01195
     C***MOVE FIRST 25 CURRENCIES TO ARRAY                        *****   S01195
     C*****                MOVE HCCY      @@CY1                   *****   S01195
     C*****                                                       *****   S01195
     C***ACCESS TABLE ON SECOND KEY                               *****   S01195
     C*****                MOVE '2'       SS0830                  *****   S01195
     C*****      SS0830    CHAINTABLETJF             80           *****   S01195
     C*****                                                       *****   S01195
     C***IF SECOND RECORD FOUND AND NOT DELETED                   *****   S01195
     C*****      *IN80     IFEQ '0'                        B1     *****   S01195
     C*****      RECI      ANDNE'*'                        *1     *****   S01195
     C*****                MOVE HCCY      @@CY2            *1     *****   S01195
     C*****                END                             E1     *****   S01195
     C*****                                                       *****   S01195
     C***SEARCH ARRAY FOR INPUT CURRENCY                          *****   S01195
     C*****      @@CCY     LOKUP@CY                      81       *****   S01195
     C*****                                                       *****   S01195
     C***IF INPUT CURRENCY IS IN ARRAY                            *****   S01195
     C*****      *IN81     IFEQ '1'                        B1     *****   S01195
     C*****                                                       *****   S01195
     C***IF INCLUDE/EXCLUDE INDICATOR EQ 'E'                      *****   S01195
     C*****      INEX      IFEQ 'E'                        B*2    *****   S01195
     C*****                MOVE 'W'       @@HIND  1        **2    *****   S01195
     C*****                ELSE                            X*2    *****   S01195
     C*****                MOVE 'H'       @@HIND           **2    *****   S01195
     C*****                END                             E*2    *****   S01195
     C*****                END                             E1     *****   S01195
     C*****                                                       *****   S01195
     C***IF INPUT CURRENCY IS NOT IN ARRAY                        *****   S01195
     C*****      *IN81     IFEQ '0'                        B1     *****   S01195
     C*****                                                       *****   S01195
     C***IF INCLUDE/EXCLUDE INDICATOR EQ 'I'                      *****   S01195
     C*****      INEX      IFEQ 'I'                        B*2    *****   S01195
     C*****                MOVE 'W'       @@HIND           **2    *****   S01195
     C*****                ELSE                            X*2    *****   S01195
     C*****                MOVE 'H'       @@HIND           **2    *****   S01195
     C*****                END                             E*2    *****   S01195
     C*****                END                             E1     *****   S01195
     C*****      ZA0839    ENDSR                                  *****   S01195
     C*****************************************************************   S01195
      *EJECT                                                      *****   S01195
     C*****************************************************************
     C*                                                               *
     C*  ZA0840 - This subroutine will take as input a 16A field      *
     C*           a 1N number of integers and a 1N number of decimal  *
     C*           places. Ignoring the leading and trailing blanks    *
     C*           it will ensure that the field contains only numeric *
     C*           characters and a decimal point, and that it has no  *
     C*           embedded blanks, or more than one decimal point.    *
     C*           It will also check that the number of figures before*
     C*           and after the decimal point do not exceed the input *
     C*           parameters. The subroutine will output the number as*
     C*           a 16A field and a 15N field, along with an error    *
     C*           code. The alpha field will be right aligned with    *
     C*           the leading zeros blanked, and trailing blanks zero *
     C*           filled. The number returned will be 15 long with 0  *
     C*           decimal places. The error code will contain 0 if    *
     C*           there was no error, 1 if there was a non-numeric    *
     C*           character found, and 2 if the number of decimal     *
     C*           places are wrong.                                   *
     C*                                                               *
     C*  Input  : @@ALPH - 16A field containing the field to validate *
     C*           @@IDP  - number of decimal places                   *
     C*           @@IINT - number of integers                         *
      *           @@MTID - Millions/Thousands id (Y = function on)    *   E17279
     C*                                                               *
     C*  Output : @@ALPH - 16A field for display                      *
     C*           @@AMT  - 15N field for calculation                  *
     C*           @@ERCD - 1N error code                              *
     C*                                                               *
     C*  Uses   : @F     - array of 16 elements 1 character long      *
     C*           @G     - array of 16 elements 1 character long      *
     C*           @@CADP - calculated number of decimal places        *
     C*           @@CINT - calculated number of integers              *
     C*           @@PIDP - position of dp in input array              *
     C*           @@PODP - position of dp in output array             *
     C*           @@C    - index for array @F                         *
     C*           @@D    - index for array @G                         *
     C*           @@WK7  - workfield used for converting array element*
     C*                    to a 1N number.                            *
     C*           @H     - array containing powers of 10              *
     C*           @@E    - index to array @H                          *
     C*           @@WK5  - work field                                 *
     C*           @@ALP1 - feild used to right align 0 decimal places *
      *           @@MIEA - maximum input elements allowed             *   E17279
      *           @@FEL  - first integer element of array @F          *   E17279
      *           @@MTF  - millions or thousands (M or T) flag        *   E17279
      *           @@S    - counter                                    *   E17279
      *           @@S1   - number of decimals after the decimal place *   E17279
      *           @@S2   - counter                                    *   E17279
      *           @@MRTS - tests decimal elements for M or T          *   E17279
     C*****************************************************************
     C*
     C           ZA0840    BEGSR
     C*
     C** initialize the fields and the arrays
     C                     MOVE '0'       *IN81
     C                     MOVE '0'       *IN82
     C                     MOVE 'N'       @@MTF   1                       E17279
     C                     MOVE 'N'       @@MRT   1                       E17279
     C                     MOVE ' '       @@MRTS  1                       E17279
     C                     Z-ADD0         @@ERCD  10
     C                     Z-ADD0         @@AMT  150
     C                     MOVEA*BLANKS   @G
     C                     MOVEA@@ALPH    @F
     C                     MOVE *BLANKS   @@ALPH 16
     C                     Z-ADD0         @@WK7   10
     C                     Z-ADD0         @@CADP  30
     C                     Z-ADD0         @@CINT  30
     C                     Z-ADD0         @@PIDP  30
     C                     Z-ADD0         @@PODP  30
     C                     Z-ADD0         @@C     20
     C                     Z-ADD0         @@D     20
     C                     Z-ADD0         @@E     20
     C                     Z-ADD0         @@K     20                      E17279
     C*
     C** define the input fields
     C           *LIKE     DEFN @@CADP    @@IDP
     C           *LIKE     DEFN @@CINT    @@IINT
     C*
     C** first check that the number input will not produce a number
     C** output with more than 15 figures.
     C           @@IDP     ADD  @@IINT    @@WK2   20
     C           @@WK2     IFGT 15                         B1
     C                     Z-ADD2         @@ERCD           *1
     C                     GOTO ZA0849                     *1
     C                     END                             E1
     C*
     C** work through input array, ignoring leading zeros and blanks,
     C** also blanking the leading zeros in the input array.
     C                     MOVE '0'       *IN83
     C                     ADD  1         @@C
     C           @@C       DOWLE16                         B1
     C           *IN83     ANDEQ'0'                        *1
     C           @F,@@C    IFNE ' '                        B*2
     C           @F,@@C    ANDNE'0'                        **2
     C                     MOVE '1'       *IN83            **2
     C                     SUB  1         @@C              **2
     C                     END                             E*2
     C                     ADD  1         @@C              **2
     C                     END                             E1
      * Following code removed. As the code above ignores 0 then @@C      E23032
      * currently contains the first non-zero element.                    E23032
      **If*first*integer*is*a*zero*subtract*1*from*@@C*to*provide   E17279E23032
      **correct*first*integer*element*of*the*array.                 E17279E23032
     C***********@@C       IFNE 1                                   E17279E23032
     C***********          SUB  1         @@C                       E17279E23032
     C***********@F,@@C    IFNE '0'                                 E17279E23032
     C***********          ADD  1         @@C                       E17279E23032
     C***********          END                                      E17279E23032
     C***********          END                                      E17279E23032
     C                     Z-ADD@@C       @@FEL   20                      E17279
     C*
     C** check the integer part of the number for valid characters.
     C           @@C       DOWLE16                         B1
     C***********@F,@@C****ANDNE'.'                        *1             073516
     C           @F,@@C    ANDNEBNDCSP                     *1             073516
     C           @F,@@C    ANDNE' '                        *1
     C*
     C** check for non numeric characters
      ** If @@MTID = Y ,allow M or T - for millions and thousands         E17279
      ** processing.                                                      E17279
     C           @F,@@C    IFGT '9'                        B*2
     C           @F,@@C    ORLT '0'                        **2
     C           @F,@@C    IFEQ 'M'                        **2            E17279
     C           @@MTID    ANDNE'Y'                                       E17279
     C           @F,@@C    OREQ 'T'                        **2            E17279
     C           @@MTID    ANDNE'Y'                                       E17279
     C           @F,@@C    ORNE 'M'                        **2            E17279
     C           @F,@@C    ANDNE'T'                                       E17279
     C                     Z-ADD0         @@AMT            **2
     C                     Z-ADD1         @@ERCD           **2
     C                     GOTO ZA0849                     **2
     C                     END                                            E17279
     C*
     C                     ELSE                            X*2
     C*
     C           @F,@@C    IFNE 'M'                                       E17279
     C           @F,@@C    ANDNE'T'                                       E17279
     C                     ADD  1         @@CINT           **2
     C                     END                                            E17279
     C*
     C** check number of integers is not greater than that required
     C           @@CINT    IFGT @@IINT                     B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD2         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C** multiply the output amount by 10 then add the number in
     C** the input array element being processed.
     C           @F,@@C    IFNE 'M'                                       E17279
     C           @F,@@C    ANDNE'T'                                       E17279
     C           @@AMT     MULT 10        @@AMT            **2
     C                     MOVE @F,@@C    @@WK7            **2
     C           @@AMT     ADD  @@WK7     @@AMT            **2
     C                     END                                            E17279
     C                     END                             E*2
      *  MT or TM etc not allowed.                                        E17279
     C           @@MTF     IFEQ 'Y'                                       E17279
     C           @F,@@C    IFEQ 'M'                                       E17279
     C           @F,@@C    OREQ 'T'                                       E17279
     C                     Z-ADD0         @@AMT                           E17279
     C                     Z-ADD1         @@ERCD                          E17279
     C                     GOTO ZA0849                                    E17279
     C                     END                                            E17279
     C                     END                                            E17279
      *                                                                   E17279
     C           @F,@@C    IFEQ 'M'                                       E17279
     C                     MOVE 'Y'       @@MTF                           E17279
     C           @@C       SUB  1         @@K                             E17279
      * If M entered alone add 1 @@amt.                                   E17279
     C           @@AMT     IFEQ 0                                         E17279
     C           @F,@@K    ANDNE'0'                                       E17279
     C                     Z-ADD1         @@AMT                           E17279
     C                     END                                            E17279
     C           @@AMT     MULT 1000000   @@AMT                           E17279
     C                     Z-ADD6         @@MIEA  20                      E17279
     C                     END                                            E17279
      *                                                                   E17279
     C           @F,@@C    IFEQ 'T'                                       E17279
     C                     MOVE 'Y'       @@MTF                           E17279
     C           @@C       SUB  1         @@K                             E17279
      * If T entered alone add 1 @@amt.                                   E17279
     C           @@AMT     IFEQ 0                                         E17279
     C           @F,@@K    ANDNE'0'                                       E17279
     C                     Z-ADD1         @@AMT                           E17279
     C                     END                                            E17279
     C           @@AMT     MULT 1000      @@AMT                           E17279
     C                     Z-ADD3         @@MIEA                          E17279
     C                     END                                            E17279
     C*
     C** increase array index
     C                     ADD  1         @@C              *1
     C                     END                             E1
     C*
     C** set up position of decimal point in input array
     C                     Z-ADD@@C       @@PIDP
     C*
     C** if the character pointed to is a decimal point add 1 to the
     C** index
     C           @@C       IFLE 16                         B1
     C*********  @F,@@C    ANDEQ'.'                        *1            076272
     C           @F,@@C    ANDEQBNDCSP                     *1            076272
     C                     ADD  1         @@C              *1
     C                     MOVE '1'       *IN82            *1
     C                     END                             E1
      * Set Maximum input elements allowed to the correct figure.         E17279
     C           @@MTF     IFEQ 'Y'                                       E17279
     C           @@C       SUB  @@FEL     @@FEL                           E17279
     C           @@FEL     ADD  @@MIEA    @@MIEA                          E17279
     C                     ELSE                                           E17279
     C           @@C       SUB  @@FEL     @@MIEA                          E17279
     C                     END                                            E17279
      *                                                                   E17279
      ** Read through array checking to see if there is an M or T.        E17279
     C                     Z-ADD@@C       @@S     20                      E17279
     C                     Z-ADD@@C       @@S1    20                      E17279
     C           @@S       DOWLE16                                        E17279
     C           @F,@@S    IFEQ 'M'                                       E17279
     C           @F,@@S    OREQ 'T'                                       E17279
     C                     MOVEA@F,@@S    @@MRTS                          E17279
     C                     MOVE 'Y'       @@MRT                           E17279
     C                     Z-ADD@@S       @@S2    20                      E17279
     C                     END                                            E17279
     C                     ADD  1         @@S                             E17279
     C                     END                                            E17279
      * Calculate the number of decimals after the decimal point.         E17279
     C           @@S2      SUB  @@S1      @@S1                            E17279
      * In thousands - only 3 decimal places allowed.                     E17279
     C           @@MRTS    IFEQ 'T'                                       E17279
     C           @@S1      IFGT 3                                         E17279
     C                     Z-ADD0         @@AMT                           E17279
     C                     Z-ADD1         @@ERCD                          E17279
     C                     GOTO ZA0849                     ***3           E17279
     C                     END                             E**3           E17279
     C                     END                             E**3           E17279
      * In millions  - only 6 decimal places allowed.                     E17279
     C           @@MRTS    IFEQ 'M'                                       E17279
     C           @@S1      IFGT 6                                         E17279
     C                     Z-ADD0         @@AMT            ***3           E17279
     C                     Z-ADD1         @@ERCD                          E17279
     C                     GOTO ZA0849                     ***3           E17279
     C                     END                             E**3           E17279
     C                     END                             E**3           E17279
     C*
     C** now validate the decimal part of the number
     C           @@C       DOWLE16                         B1
     C*
     C** if a blank is found set on the blank input indicator
     C           @F,@@C    IFEQ ' '                        B*2
     C                     MOVE '1'       *IN81            **2
     C                     END                             E*2
     C*
     C** if the figure is numeric, check that the number of decimal
     C** places does not exceed that specified, and that no blanks
     C** have been entered.
     C           @F,@@C    IFGE '0'                        B*2
     C           @F,@@C    ANDLE'9'                        **2
     C           @F,@@C    OREQ 'T'                        **2            E17279
     C           @@MTID    ANDEQ'Y'                                       E17279
     C           @F,@@C    OREQ 'M'                        **2            E17279
     C           @@MTID    ANDEQ'Y'                                       E17279
      *                                                                   E17279
     C           @@MRT     IFNE 'Y'                                       E17279
     C                     ADD  1         @@CADP           **2
     C                     END                                            E17279
     C*
     C           @@CADP    IFGT @@IDP                      B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD2         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C           *IN81     IFEQ '1'                        B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD1         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C** update output amount
     C           @F,@@C    IFNE 'M'                                       E17279
     C           @F,@@C    ANDNE'T'                                       E17279
     C           @@AMT     MULT 10        @@AMT            **2
     C                     MOVE @F,@@C    @@WK7            **2
     C                     ADD  @@WK7     @@AMT            **2
     C                     END                                            E17279
      * MT or TM etc not allowed.                                         E17279
     C           @@MTF     IFEQ 'Y'                                       E17279
     C           @F,@@C    IFEQ 'M'                                       E17279
     C           @F,@@C    OREQ 'T'                                       E17279
     C                     Z-ADD0         @@AMT            ***3           E17279
     C                     Z-ADD1         @@ERCD                          E17279
     C                     GOTO ZA0849                                    E17279
     C                     END                                            E17279
     C                     END                                            E17279
      *                                                                   E17279
     C           @F,@@C    IFEQ 'M'                                       E17279
     C                     MOVE 'Y'       @@MTF                           E17279
      * Multiply @@amt by the correct factor and add the number           E17279
      * digits to @@MIEA.                                                 E17279
     C           @@S1      IFEQ 1                                         E17279
     C           @@AMT     MULT 1000000   @@AMT                           E17279
     C                     ADD  6         @@MIEA                          E17279
     C                     END                                            E17279
     C           @@S1      IFEQ 2                                         E17279
     C           @@AMT     MULT 100000    @@AMT                           E17279
     C                     ADD  5         @@MIEA                          E17279
     C                     END                                            E17279
     C           @@S1      IFEQ 3                                         E17279
     C           @@AMT     MULT 10000     @@AMT                           E17279
     C                     ADD  4         @@MIEA                          E17279
     C                     END                                            E17279
     C           @@S1      IFEQ 4                                         E17279
     C           @@AMT     MULT 1000      @@AMT                           E17279
     C                     ADD  3         @@MIEA                          E17279
     C                     END                                            E17279
     C           @@S1      IFEQ 5                                         E17279
     C           @@AMT     MULT 100       @@AMT                           E17279
     C                     ADD  2         @@MIEA                          E17279
     C                     END                                            E17279
     C           @@S1      IFEQ 6                                         E17279
     C           @@AMT     MULT 10        @@AMT                           E17279
     C                     ADD  1         @@MIEA                          E17279
     C                     END                                            E17279
      *                                                                   E17279
     C                     END                                            E17279
      *                                                                   E17279
     C           @F,@@C    IFEQ 'T'                                       E17279
     C                     MOVE 'Y'       @@MTF                           E17279
      * Multiply @@amt by the correct factor and add the number           E17279
      * digits to @@MIEA.                                                 E17279
     C           @@S1      IFEQ 1                                         E17279
     C           @@AMT     MULT 1000      @@AMT                           E17279
     C                     ADD  3         @@MIEA                          E17279
     C                     END                                            E17279
     C           @@S1      IFEQ 2                                         E17279
     C           @@AMT     MULT 100       @@AMT                           E17279
     C                     ADD  2         @@MIEA                          E17279
     C                     END                                            E17279
     C           @@S1      IFEQ 3                                         E17279
     C           @@AMT     MULT 10        @@AMT                           E17279
     C                     ADD  1         @@MIEA                          E17279
     C                     END                                            E17279
      *                                                                   E17279
     C                     END                                            E17279
     C*
     C                     ELSE                            X*2
     C*
     C** if the character is not numeric and not a blank then it is
     C** invalid
     C           @F,@@C    IFNE ' '                        B**3
     C                     Z-ADD0         @@AMT            ***3
     C                     Z-ADD1         @@ERCD           ***3
     C                     GOTO ZA0849                     ***3
     C                     END                             E**3
     C*
     C                     END                             E*2
     C*
     C** increase index
     C                     ADD  1         @@C              *1
     C*
     C                     END                             E1
      * Check that the number of elements input does not exceed allowed   E17279
     C           @@MIEA    ADD  @@IDP     @@MIEA                          E17279
     C           @@MIEA    IFGT 14                         B1             E17279
     C                     Z-ADD2         @@ERCD           *1             E17279
     C                     GOTO ZA0849                     *1             E17279
     C                     END                             E1             E17279
     C*
     C** correct the output number for any decimal places not input
     C** in the alpha field.
     C           @@IDP     SUB  @@CADP    @@E
     C*
     C** increase the index by one to get correct array entry
      ** If @@IDP = 0 add 1 to @@E to prevent array index error.          E17279
     C           @@MRT     IFEQ 'N'                                       E17279
     C           @@IDP     OREQ 0                                         E17279
     C                     ADD  1         @@E
     C                     END                                            E17279
     C           @@AMT     MULT @H,@@E    @@AMT
      *                                                                   E17279
     C           @@MRT     IFEQ 'Y'                                       E17279
     C           @@IDP     ANDEQ0                                         E17279
     C           @@AMT     DIV  10        @@AMT                           E17279
     C                     END                                            E17279
     C*
     C** now format the output alpha field, first calculate where
     C** the decimal point goes
     C           16        SUB  @@IDP     @@PODP
     C           @@PODP    SUB  1         @@PIDP
     C*
     C** if there are no decimal points set the position to 17
     C           @@IDP     IFEQ 0                          B1
     C                     Z-ADD17        @@PODP           *1
     C                     END                             E1
     C*
     C** move the output number into the input array
     C                     MOVEA*BLANKS   @F
     C                     MOVE @@AMT     @@AMTA 15
     C                     MOVEA@@AMTA    @F
     C*
     C** set up indexes
     C                     Z-ADD1         @@C
     C                     Z-ADD1         @@D
     C                     MOVE '0'       *IN80
     C*
     C** now fill up the output array
     C           @@D       DOWLE16                         B1
     C*
     C** insert decimal point if the position is found
     C           @@D       IFEQ @@PODP                     B*2
     C*********************MOVE '.'       @G,@@D           **2            073516
     C                     MOVE BNDCSP    @G,@@D           **2            073516
     C                     ADD  1         @@D              **2
     C                     END                             E*2
     C*
     C** insert the zero before the decimal point
     C           *IN80     IFEQ '0'                        B*2
     C           @@D       ANDEQ@@PIDP                     **2
     C           @F,@@C    ANDEQ'0'                        **2
     C                     MOVE '1'       *IN80            **2
     C                     MOVE '0'       @G,@@D           **2
     C                     END                             E*2
     C*
     C** blank leading zeros
     C           *IN80     IFEQ '0'                        B*2
     C           @F,@@C    ANDEQ'0'                        **2
     C                     MOVE ' '       @G,@@D           **2
     C                     END                             E*2
     C*
     C** move a normal character
     C           @F,@@C    IFGE '1'                        B*2
     C           @F,@@C    ANDLE'9'                        **2
     C                     MOVE @F,@@C    @G,@@D           **2
     C                     MOVE '1'       *IN80            **2
     C                     END                             E*2
     C*
     C** non blanked zero
     C           @F,@@C    IFEQ '0'                        B*2
     C           *IN80     ANDEQ'1'                        **2
     C                     MOVE '0'       @G,@@D           **2
     C                     END                             E*2
     C*
     C                     ADD  1         @@C              *1
     C                     ADD  1         @@D              *1
     C                     END                             E1
     C*
     C*
     C** put output array into output amount
     C                     MOVEA@G        @@ALPH
     C*
     C** align figure with zero decimal places.
     C           @@IDP     IFEQ 0                          B1
     C                     MOVE *BLANKS   @@ALP1 17        *1
     C                     MOVE @@ALPH    @@ALP1           *1
     C                     MOVEL@@ALP1    @@ALPH           *1
     C                     END                             E1
     C*
     C           ZA0849    ENDSR                           ZA0849 TAG
     C*
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*       TITLE:BACK OFFICE AMOUNT EDITOR .                       *
     C*                                                               *
     C*       SUBROUTINE ZA0920 ACCEPTS AN AMOUNT FIELD (13N) AND     *
     C*       A FIELD (1N) SPECIFYING NO. OF DECIMALS AND WITH THIS   *
     C*       CONVERTS THE AMOUNT INTO AN ALPHAMERIC FIELD (14A)      *
     C*       WITH THE REQUIRED DECIMAL PLACE.                        *
     C*                                                               *
     C*                                                               *
     C* INPUT  :@@AMTW AMOUNT      FORMAT(13N)                        *
     C*         @@QECN DECIMAL NO. FORMAT(1N)                         *
     C*                                                               *
     C* OUTPUT :@@AMTD AMOUNT WITH DECIMAL FORMAT(14A)                *
     C*                                                               *
     C* USES :  @@AMTW AMOUNT FIELD PASSED                            *
     C*         @@QECN NO. OF DECIMAL FIELD                           *
     C*         @@QECW POSITION ON ARRAY @Z  FOR A DECIMAL POINT     *
     C*         @@SIG  POSITION ON ARRAY THAT CANNOT BE BLANK         *
     C*         @@Z    INDEX FOR ARRAY @Z                             *
     C*         @@Q    INDEX FOR ARRAY @Q                             *
     C*         @@SWT  SWITCH SAYING ZERO HAS BEEN SUPPRESSED         *
     C*         @@SWT1 SWITCH SAYING ZERO SUPPRESSION OVER            *
     C*                                                               *
     C* ARRAYS:  @Z ARRAY USED FOR DECIMAL ALIGNMENT                  *
     C*          @Q ARRAY USED FOR STORING AMOUNT PASSED TO THE SR    *
     C*                                                               *
     C*****************************************************************
     C*                                                               *
     C           ZA0920    BEGSR
     C*
     C* INITIALIZATION
     C                     MOVE '0'       @@SWT1  1
     C*
     C* FINDING WHERE DECIMAL POSITION IS
     C*
     C           14        SUB  @@QECN    @@QECW  20
     C*
     C* FINDING OUT MOST SIGNIFICANT POSITION
     C*
     C           @@QECW    SUB  1         @@SIG   20
     C                     MOVEA*BLANKS   @Z
     C                     Z-ADD1         @@Q     20
     C*
     C* CHECK TO SEE IF NO.OF DECIMAL PLACES IS ZERO. IF ZERO
     C* THEN SIGNIFICANT POSITION IS 14 AND POSITION 1 IS BLANK
     C           @@QECW    IFEQ 14
     C                     Z-ADD14        @@SIG
     C                     Z-ADD2         @@Z     20
     C                     ELSE
     C                     Z-ADD1         @@Z     20
     C                     END
     C*
     C* PERFORMING ACTUAL MOVEMENT
     C           @@Z       DOWLT15
     C           @@Q       ANDLT14
     C*
     C* SWITCH FOR ZERO SUPPRESSION
     C                     MOVE '0'       @@SWT
     C*
     C* IF ELEMENT OF ARRAY @Q  IS ZERO AND INDEX @@Z FOR ARRAY @Z
     C* IS *LT SIG.POSITION AND ALSO *LT DECIMAL POSITION THEN ZERO
     C* CAN BE SUPPRESSED AND ZERO SUPPRESSION SWITCH IS SETON
     C*
     C           @Q,@@Q    IFEQ 0
     C           @@SWT1    ANDEQ'0'
     C           @@Z       ANDLT@@SIG
     C           @@Z       ANDLT@@QECW
     C                     MOVE *BLANK    @Z,@@Z
     C                     MOVE '1'       @@SWT   1
     C                     END
     C*
     C* IF INDEX @@Z FOR ARRAY @Z IS EQUAL TO THE DECIMAL POSITION
     C* AND NOT EQUAL TO THE LENGTH OF THE ARRAY @Z(14) THEN MOVE
     C* DECIMAL POSITION AND INCREMENT @@Z BY 1
     C*
     C           @@Z       IFEQ @@QECW
     C           @@Z       ANDNE14
     C*********************MOVE '.'       @Z,@@Z                          073516
     C                     MOVE BNDCSP    @Z,@@Z                          073516
     C                     ADD  1         @@Z
     C                     END
     C*
     C* IF ZERO HAS NOT BEEN SUPPRESSED THEN MOVE ELEMENT FROM ARRAY
     C* @Q TO @Z.SETON ZERO SUPPRESSION SWITCH OVER(@@SWT1)
     C           @@SWT     IFEQ '0'
     C                     MOVE @Q,@@Q    @Z,@@Z
     C                     MOVE '1'       @@SWT1
     C                     END
     C*
     C                     ADD  1         @@Q
     C                     ADD  1         @@Z
     C*
     C                     END
      *
      * Dummy moves for definition of work fields.
     C                     GOTO ZA0929
     C                     MOVE @@QECN    @@QECN  10
      *
     C           ZA0929    ENDSR
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*            #ZJ    - Set up Standard deal                      *
     C*                                                               *
     C**CALLS****ZA0710***-*MIDAS*day*number*to*YYYYMMDD***************   056095
     C* CALLS    ZDATE9   - MIDAS day number to YYYYMMDD              *   056095
     C*          ZA0840   - Validate/reformat input amount            *
     C*                                                               *
     C* CALLED BY  #BDAA    - Calls new record update routines.       *
     C*            #ZG      - Calls update routines.                  *
     C*                                                               *
     C* FLDS USED  @USER  - User i.d. from prog.status data structure *
     C*            @STS   - next status of deal                       *
     C*            @@ALPH - 16A field containing field to validate    *
     C*            @@IDP  - number of decimal places                  *
     C*            @@IINT - number of integers                        *
     C*            @@ALPH - 16A field for display                     *
     C*            @@AMT  - 15N field for calculation                 *
     C*            @@ERCD - 1N error code                             *
     C*            @@DAYN - Day no.                                   *
     C*            @DAY   - dd days for conversion to YYYYMMDD        *
     C*            @DATE  - YYYYMMDD date for separation              *
     C*            @VDAT  - stored value date                         *
     C*            @YEAR  - Format date to YYYYMMDD : year            *
     C*            @MNTH  - Format date to YYYYMMDD : month           *
     C*            @DAY   - dd days for conversion to YYYYMMDD        *
     C*            @TYP   - Deal type                                 *
     C*            @METHD - Pay/recieve method text                   *
     C*            @KEY   - key for table files                       *
     C*            @KEY1  -     "     "                               *
     C*            @5     - Key workfield                             *
     C*            @2     - Key workfield                             *
     C*            @8     - Key workfield                             *
     C*************@CNUM**-********************************************   S01319
     C*************@CNUM**-*key*to*CLINT*******************************   S01319
     C*************@CLTKY*-*key*to*CLINT*******************************   S01319
     C*            @MCHDT - Machine date                              *
     C*            @MCHD  -    "     "                                *
     C*                                                               *
     C*****************************************************************
     C           #ZJ       BEGSR
     C*                                                                   044740
     C** Retrieve true shortname for customer.                            044740
     C*                                                                   044740
     C/COPY WNCPYSRC,MM0028C106
     C                     MOVELHNCNUM    @CUSNO 10                       044740
     C/COPY WNCPYSRC,MM0028C107
     C                     CALL 'AOCUSTR0'                                044740
     C                     PARM '       ' @RTCD                           044740
     C                     PARM '*KEY   ' @OPTN                           044740
     C                     PARM @CUSNO    @CLKEY                          044740
     C                     PARM '       ' @KYST                           044740
     C           SDCUST    PARM SDCUST    DSSDY                           044740
     C*                                                                   044740
     C           @RTCD     IFNE *BLANK                                    044740
     C           @KYST     OREQ '*ERROR'                                  044740
     C                     MOVE '1'       *IN65                           044740
     C                     MOVE '1'       *IN10                           044740
     C                     MOVE '1'       *IN41                           044740
     C                     MOVEL'MMM0205' @MSGID                          044740
     C                     CALL 'ZA0240'                                  044740
     C                     PARM           @MSGID                          044740
     C                     ELSE                                           044740
     C                     MOVE BBCSSN    HNCSNM                          044740
     C                     MOVE BBCSSN    H@CSNM                          044740
     C                     END                                            044740
     C*
     C*  *--------------------------------------------------*
     C*  * Set up standard deal for action codes 'X' & 'D'  *
     C*  *--------------------------------------------------*
     C*
     C** Move fields from the deals file MMDEAMPP.
     C           DDACTN    IFEQ 'X'                        B1
     C           DDACTN    OREQ 'D'                        *1
     C                     Z-ADDHNDS38    IGDS38           *1
     C                     MOVE 'IG'      IGRCID           *1
     C                     MOVE HNDLTF    IGDLTF           *1
     C                     Z-ADDHNDLUP    IGDLUP           *1
     C                     MOVE HNMLUP    IGMLUP           *1
     C                     Z-ADDHNYLUP    IGYLUP           *1
     C                     Z-ADDHNTLUP    IGTLUP           *1
     C                     MOVE HNCHTP    IGCHTP           *1
     C                     Z-ADDHNLCD     IGLCD            *1
     C                     MOVE HNLUID    IGLUID           *1
     C                     MOVE HNDMAD    IGDMAD           *1
     C                     Z-ADDHNDA38    IGDA38           *1
     C                     MOVE HNDMSQ    IGDMSQ           *1
     C                     MOVE HNCCY     IGCCY            *1
     C                     Z-ADDHNCYDP    IGCYDP           *1
     C                     Z-ADDHNVDYY    IGVDYY           *1
     C                     Z-ADDHNVDMM    IGVDMM           *1
     C                     Z-ADDHNVDDD    IGVDDD           *1
     C                     Z-ADDHNDTYY    IGDTYY           *1
     C                     Z-ADDHNDTMM    IGDTMM           *1
     C                     Z-ADDHNDTDD    IGDTDD           *1
     C*
     C           DDACTN    IFEQ 'X'                        B*2
     C*
     C** Deam authorization officer
     C                     MOVEL@USER     IGAOFR           **2
     C*
     C** Midas action : from table MMT0044.
     C           HNDSTS    IFEQ 'C'                        B**3
     C                     MOVE 'I'       IGMACT           ***3
     C                     END                             E**3
     C           HNDSTS    IFEQ 'R'                        B**3
     C                     MOVE 'A'       IGMACT           ***3
     C                     END                             E**3
     C                     MOVE HNDDLT    IGDDLT           **2
     C*
     C                     ELSE                            X*2
     C*
     C** If current status is 'C' no output to field       B**3
     C           HNDSTS    IFEQ 'A'                        B**3
     C           HNDSTS    OREQ 'R'                        ***3
     C                     MOVE 'R'       IGMACT           ***3
     C                     ELSE                            ***3
     C                     MOVE ' '       IGMACT           ***3
     C                     END                             E**3
     C*
     C                     MOVE 'D'       IGDDLT           **2
     C                     MOVELHNAOFR    IGAOFR           **2
     C                     END                             E*2
     C*
     C                     MOVE @STS      IGDSTS           *1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP11                                           S01408
     C*                                                                   S01408
     C                     MOVE HNMTYP    IGMTYP           *1
     C                     MOVE HNORBS    IGORBS           *1
     C                     MOVE HNTYPE    IGTYPE           *1
     C                     Z-ADDHNDMDY    IGDMDY           *1
     C                     Z-ADDHNDMDM    IGDMDM           *1
     C                     Z-ADDHNDMDD    IGDMDD           *1
     C                     Z-ADDHNAMNP    IGAMNP           *1
     C                     Z-ADDHNINTR    IGINTR           *1
      *                                                                   CAC001
      **  If Anal Acctg is installed, update funding info fields          CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
     C                     Z-ADDHNFSRP    IGFSRP                          CAC001
     C                     MOVE HNIRCF    IGIRCF                          CAC001
     C                     MOVE HNFRCF    IGFRCF                          CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C                     MOVE HNDORM    IGDORM           *1
     C                     Z-ADDHNORCM    IGORCM           *1
     C                     MOVE HNDORI    IGDORI           *1
     C                     MOVE HNMORI    IGMORI           *1
     C                     MOVE HNDCPI    IGDCPI           *1
     C                     MOVE HNMCPI    IGMCPI           *1
     C                     MOVE HNDOPM    IGDOPM           *1
     C                     Z-ADDHNMOPM    IGMOPM           *1
     C                     MOVE HNDOPI    IGDOPI           *1
     C                     MOVE HNMOPI    IGMOPI           *1
     C                     MOVE HNDCRI    IGDCRI           *1
     C                     MOVE HNMCRI    IGMCRI           *1
     C                     MOVE HNDFAC    IGDFAC           *1
     C                     MOVE HNMFAO    IGMFAO           *1
     C                     MOVE HNSPEC    IGSPEC           *1
     C                     MOVE HNRSTM    IGRSTM           *1             S01177
     C                     MOVE HNRONS    IGRONS           *1             S01177
     C                     MOVE HNRIBN    IGRIBN           *1             S01177
     C                     MOVE HNRIBA    IGRIBA           *1             S01177
     C                     MOVE HNROBN    IGROBN           *1             S01177
     C                     MOVE HNROCN    IGROCN           *1             S01177
     C                     MOVE HNPSTM    IGPSTM           *1             S01177
     C                     MOVE HNPONS    IGPONS           *1             S01177
     C                     MOVE HNPIBN    IGPIBN           *1             S01177
     C                     MOVE HNPIBA    IGPIBA           *1             S01177
     C                     MOVE HNPOBN    IGPOBN           *1             S01177
     C                     MOVE HNPOCN    IGPOCN           *1             S01177
     C                     MOVE HNRCRN    IGRCRN           *1             S01177
     C                     MOVE HNRCRA    IGRCRA           *1             S01177
     C                     MOVE HNRVNO    IGRVNO           *1             S01177
     C                     MOVE HNAWBN    IGAWBN           *1             S01177
     C                     MOVE HNAWBA    IGAWBA           *1             S01177
     C                     MOVE HNBENN    IGBENN           *1             S01177
     C                     MOVE HNBENA    IGBENA           *1             S01177
     C                     MOVE HNDTP1    IGDTP1           *1             S01177
     C                     MOVE HNDTP2    IGDTP2           *1             S01177
     C                     MOVE HNDTP3    IGDTP3           *1             S01177
     C                     MOVE HNDTP4    IGDTP4           *1             S01177
     C                     MOVE HNDCHG    IGDCHG           *1             S01177
     C                     MOVE HNBTB1    IGBTB1           *1             S01177
     C                     MOVE HNBTB2    IGBTB2           *1             S01177
     C                     MOVE HNBTB3    IGBTB3           *1             S01177
     C                     MOVE HNBTB4    IGBTB4           *1             S01177
     C                     MOVE HNBTB5    IGBTB5           *1             S01177
     C                     MOVE HNBTB6    IGBTB6           *1             S01177
     C                     MOVE HNCVMR    IGCVMR           *1             E22405
     C                     MOVE HNOSBR    IGOSBR           *1             LN0822
     C                     MOVE HNBRCA    IGBRCA           *1             E49965
     C                     MOVE HNOGDT    IGOGDT           *1
     C                     MOVE HNOMDT    IGOMDT           *1
     C                     MOVE HNCSNM    IGCSNM           *1
     C**********           Z-ADDHNCNUM    IGCNUM           *1                                 CSD027
     C                     MOVE HNCNUM    IGCNUM           *1                                 CSD027
     C                     Z-ADDHNPCTN    IGPCTN           *1
     C                     MOVE HNCDRP    IGCDRP           *1
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP12                                           S01408
     C*                                                                   S01408
     C                     MOVE DDACTN    IGLACT           *1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP16                                           S01408
     C*                                                                   S01408
     C*
     C                     Z-ADDHNTIME    IGTIME           *1
     C                     MOVE HNDUSC    IGDUSC           *1
     C                     MOVE HNAOFR    IGAOFR           *1
     C                     Z-ADDHNLDAT    IGLDAT           *1
     C                     MOVELHNSTCY    IGSTCY                          CEU003
     C                     MOVELHNIC72    IGIC72                          CEU003
      *                                                                   CEU003
     C                     END                             E1
     C*
     C*  *--------------------------------------------------*
     C*  * Set up standard deal for action codes 'I' & 'A'  *
     C*  *--------------------------------------------------*
     C*
     C           DDACTN    IFEQ 'A'                        B1
     C           DDACTN    OREQ 'I'                        *1
     C*
     C*
     C**  Key fields
     C                     Z-ADDHNDA38    IGDA38           *1
     C                     Z-ADDHNDS38    IGDS38           *1
     C                     Z-ADDHNVDMM    IGVDMM           *1
     C                     Z-ADDHNVDDD    IGVDDD           *1
     C                     Z-ADDHNVDYY    IGVDYY           *1
     C*
     C**  If deal currently accessed is not the deal on which this deam
     C**  is being made then access deals file
     C           IGDA38    IFNE H@DN38                     B*2
     C                     MOVE '0'       *IN65            **2
     C           IGDA38    CHAINMMDEALLL             65
     C           *IN65     IFEQ '1'                        B**3
     C                     MOVE '1'       *INLR            ***3
     C                     MOVE '1'       *INU7            ***3
     C                     MOVE '1'       *INU8            ***3
     C                     MOVE '1'       *INKC            ***************
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 007 *
     C                     MOVELIGDA38    DBKEY            ***************
     C                     MOVE '007'     DBASE            ***3
     C                     EXSR #C                         ***3
     C                     END                             E**3
     C                     END                             E*2
     C*
     C*  Initialise fields
     C** Last update fields are set to zeroes or blanks other fields
     C** not affected by screen entry will be the same as for deal
     C** on which the deam is based
     C*  ( Note: Fields Affected by screen entry are initialised in #ZI )
     C*
     C                     MOVE 'IG'      IGRCID           *1
     C                     MOVE ' '       IGDLTF           *1
     C                     Z-ADDHNDLUP    IGDLUP           *1
     C                     MOVE HNMLUP    IGMLUP           *1
     C                     Z-ADDHNYLUP    IGYLUP           *1
     C                     Z-ADDHNTLUP    IGTLUP           *1
     C                     MOVE HNCHTP    IGCHTP           *1
     C                     Z-ADDHNLCD     IGLCD            *1
     C                     MOVE HNLUID    IGLUID           *1
     C*
     C** Convert transaction date to YYYYMMDD from day number RUND
     C*****                Z-ADDRUND      @@DAYN  50       *1     *****   S01194
     C                     Z-ADDBJRDNB    @@DAYN  50       *1             S01194
     C***********          EXSR ZA0710                     *1             056095
     C                     EXSR ZDATE9                     *1             056095
     C                     Z-ADD@@VDT     @DATE            *1
     C                     Z-ADD@DATE     IGLDAT           *1
     C                     Z-ADD@YEAR     IGDTYY           *1
     C                     Z-ADD@MNTH     IGDTMM           *1
     C                     Z-ADD@DAY      IGDTDD           *1
     C*
     C*** Initialise Deam deal date to same as transaction date
     C                     Z-ADD@YEAR     IGDMDY           *1
     C                     Z-ADD@MNTH     IGDMDM           *1
     C                     Z-ADD@DAY      IGDMDD           *1
     C                     MOVE *BLANK    IGDDLT           *1
     C                     MOVE @STS      IGDSTS           *1
     C                     MOVE @STS      HNDSTS           *1
     C                     MOVE H@BRCA    IGBRCA                          E49965
     C*
     C           DDACTN    IFEQ 'I'                        B*2
     C*
     C** Midas action : from table MMT0044.
     C** If authorization is required no output to field
     C** Unless Internal Funding Deal                                     S01354
     C***********H1BOAR****IFEQ*'N'************************B**3***********S01319
     C           BNMMAU    IFEQ 'N'                        B**3           S01319
     C           H@MTYP    OREQ 'IL'                                      S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C                     MOVE 'I'       IGMACT           ***3
     C                     END                             E**3
     C*
     C** Deam associated deal nunmber(PC) blank if insert
     C                     MOVE *BLANKS   IGDMAD           **2
     C                     MOVE *BLANKS   IGDMSQ           **2
     C*
     C                     ELSE                            X*2
     C*
     C** If current status is 'C' no output to field
     C           HNDSTS    IFNE 'C'                        B**3
     C                     MOVE 'A'       IGMACT           ***3
     C                     END                             E**3
     C*
     C                     MOVE HNDMAD    IGDMAD           **2
     C                     MOVE HNDMSQ    IGDMSQ           **2
     C*
     C                     END                             E*2
     C*
     C*  Determine DRS Deal type IGTYPE.
     C           DDMTYP    IFEQ 'PI'                       B*2
     C           DDMTYP    OREQ 'PD'                       **2
     C           DDMTYP    OREQ 'CI'                       **2
     C           DDMTYP    OREQ 'SI'                       **2
     C                     MOVE DDMTYP    IGTYPE           **2
     C                     END                             E*2
     C           DDMTYP    IFEQ 'SC'                       B*2
     C                     MOVE 'RC'      IGTYPE           **2
     C                     END                             E*2
     C                     MOVE DDMTYP    IGMTYP           *1
     C*
     C** Signed amount : If pay -ve , recieve +ve.
     C           @PRI      IFEQ 'R'                        B1
     C                     Z-ADDIGAMNP    IGAMNP           *1
     C                     END                             E1
     C           @PRI      IFEQ 'P'                        B1
     C                     Z-SUBIGAMNP    IGAMNP           *1
     C                     END                             E1
     C*                                                                   S01354
     C** Set Amount and Settle Brch, for Internal Funding deals           S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                       B*2            S01354
     C                     MOVE H@ROBR    PMPOBR           **2            S01354
     C           DDMTYP    IFEQ 'PI'                       B**3           S01354
     C                     Z-SUBIGAMNP    IGAMNP           ***3           S01354
     C                     END                             E**3           S01354
     C                     END                             E*2            S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'ID'                       B*2            S01354
     C                     MOVE H@ROBR    PMPOBR           **2            S01354
     C           DDMTYP    IFEQ 'PD'                       B**3           S01354
     C           DDMTYP    OREQ 'SI'                                      S01354
     C                     Z-SUBIGAMNP    IGAMNP           ***2           S01354
     C                     END                             E**3           S01354
     C                     END                             E*2            S01354
     C*
     C*
     C** Translate our receive or pay method
     C*****      DDORCM    IFEQ '00'                       B*2            S01177
     C           PMRSTM    IFEQ 00                         B*2            S01177
     C           PMPSTM    OREQ 00                         B*2            S01177
     C                     MOVE *BLANKS   @METHD  5        **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '01'                       B*2            S01177
     C           PMRSTM    IFEQ 01                         B*2            S01177
     C           PMPSTM    OREQ 01                         B*2            S01177
     C                     MOVE 'TELX '   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '07'                       B*2            S01177
     C           PMRSTM    IFEQ 07                         B*2            S01177
     C           PMPSTM    OREQ 07                         B*2            S01177
     C                     MOVE 'CHIPS'   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '08'                       B*2            S01177
     C           PMRSTM    IFEQ 08                         B*2            S01177
     C           PMPSTM    OREQ 08                         B*2            S01177
     C                     MOVE 'SWIFT'   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '12'                       B*2            S01177
     C           PMRSTM    IFEQ 12                         B*2            S01177
     C           PMPSTM    OREQ 12                         B*2            S01177
     C                     MOVE 'CCOLL'   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '03'                       B*2            S01177
     C           PMRSTM    IFEQ 03                         B*2            S01177
     C           PMPSTM    OREQ 03                         B*2            S01177
     C                     MOVE 'COMP '   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '04'                       B*2            S01177
     C           PMRSTM    IFEQ 04                         B*2            S01177
     C           PMPSTM    OREQ 04                         B*2            S01177
     C                     MOVE 'PCURR'   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '14'                       B*2            S01177
     C           PMRSTM    IFEQ 14                         B*2            S01177
     C           PMPSTM    OREQ 14                         B*2            S01177
     C                     MOVE 'CURR '   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '05'                       B*2            S01177
     C           PMRSTM    IFEQ 05                         B*2            S01177
     C           PMPSTM    OREQ 05                         B*2            S01177
     C                     MOVE 'MACC '   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '06'                       B*2            S01177
     C           PMRSTM    IFEQ 06                         B*2            S01177
     C           PMPSTM    OREQ 06                         B*2            S01177
     C                     MOVE 'SUSP '   @METHD           **2
     C                     END                             E*2
     C*****      DDORCM    IFEQ '02'                       B*2            S01177
     C           PMRSTM    IFEQ 02                         B*2            S01177
     C           PMPSTM    OREQ 02                         B*2            S01177
     C                     MOVE 'CSENT'   @METHD           **2
     C                     END                             E*2
     C*
     C           @PRI      IFEQ 'R'                        B*2
     C***********          MOVE @METHD    IGDOPM           **2            LN0822
     C                     MOVE @METHD    IGDORM           **2            LN0822
     C                     MOVE PMROBR    IGOSBR           **2            LN0822
     C                     MOVELPMRSCY    IGSTCY                          CEU003
     C                     ELSE                            X*2            S01177
     C                     MOVE @METHD    IGDOPM           **2            S01177
     C                     MOVE PMPOBR    IGOSBR           **2            LN0822
     C                     MOVELPMPSCY    IGSTCY                          CEU003
     C                     MOVELPMIC72    IGIC72                          CEU003
     C                     END                             E*2
     C*****                MOVE DDORCM    IGORCM           **2            S01177
     C*****                MOVE DDMORI    IGMORI           **2            S01177
     C*****                MOVE DDMCPI    IGMCPI           **2            S01177
     C                     MOVELPMRSTM    IGORCM                          S01177
     C                     MOVELPMRONS    IGMORI                          S01177
     C                     MOVELPARIBN    IGMCPI                          S01177
     C                     MOVELPMRSTM    IGRSTM                          S01177
     C                     MOVELPMRONS    IGRONS                          S01177
     C                     MOVELPARIBN    IGRIBN                          S01177
     C*****                MOVE DDORCM    IGMOPM           **2            S01177
     C*****                MOVE DDMORI    IGMOPI           **2            S01177
     C*****                MOVE DDMCPI    IGMCRI           **2            S01177
     C                     MOVELPMPSTM    IGMOPM                          S01177
     C                     MOVELPMPONS    IGMOPI                          S01177
     C                     MOVELPAAWBN    IGMCRI                          S01177
     C                     MOVELPMPSTM    IGPSTM                          S01177
     C                     MOVELPMPONS    IGPONS                          S01177
     C                     MOVELPAAWBN    IGAWBN                          S01177
     C*
     C** Deam our recieve/pay instructions
     C                     MOVE *BLANKS   IGDORI           *1
     C                     MOVE *BLANKS   IGDOPI           *1
     C*****      DDMORI    IFNE *BLANKS                    B*2            S01177
     C*****      DDORCM    IFEQ '01'                       B**3           S01177
     C*****      DDORCM    OREQ '02'                       ***3           S01177
     C*****      DDORCM    OREQ '12'                       ***3           S01177
     C*****      DDORCM    OREQ '07'                       ***3           S01177
     C*****      DDORCM    OREQ '08'                       ***3           S01177
     C           PMRONS    IFNE *BLANKS                    B*2            S01177
     C           PMRSTM    IFEQ 01                         B**3           S01177
     C           PMRSTM    OREQ 02                         ***3           S01177
     C           PMRSTM    OREQ 12                         ***3           S01177
     C           PMRSTM    OREQ 07                         ***3           S01177
     C           PMRSTM    OREQ 08                         ***3           S01177
     C*
     C** set up key to nostro table
     C*****                MOVE *BLANKS   @KEY             ***3   *****   S01194
     C*****                MOVE '70'      @KEY1            ***3   *****   S01194
     C*****                MOVELDDCCY     @5      5        ***3   *****   S01194
     C*****                MOVELDDMORI    @2      2        ***3           S01177
     C                     MOVELPMRONS    @2      2        ***3           S01177
     C/COPY WNCPYSRC,MM0028C134
     C*****                MOVE @2        @5               ***3   *****   S01194
     C*****                MOVE @5        @KEY             ***3   *****   S01194
     C*
     C** Bypass validation of Nostro No. if it is 00. This is
     C**   always valid.
     C           @2        IFNE '00'                       B***4
     C*****      @KEY      CHAINFDTBLILL             65    ****4  *****   S01194
     C*****      *IN65     IFEQ '1'                        B****5 *****   S01194
     C*****      RECI      ORNE 'D'                        *****5 *****   S01194
032  C* CALL ACCESS PROG. FOR NOSTROS DETAILS.                            S01194
     C                     CALL 'AONOSTR0'                                S01194
     C*********************PARM '*DBERR ' @RTCD   7                S01194 E47225
     C                     PARM '*MSG   ' @RTCD   7                       E47225
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM *BLANKS   @NSKYA  6                       S01194
     C***********          PARM DDCCY     @NSKYB  3                S01194 CEU003
     C/COPY WNCPYSRC,MM0028C135
     C                     PARM WEFCY     @NSKYB  3                       CEU003
     C/COPY WNCPYSRC,MM0028C136
     C**********           PARM *BLANKS   @NSKYC  4                                    S01194 CGL029
     C                     PARM *BLANKS   @NSKYC                                              CGL029
     C                     PARM *BLANKS   @NSKYD  2                       S01194
     C                     PARM @2        @NSKYE  2                       S01194
     C                     PARM *BLANKS   @KEYF                           S01194
     C                     PARM *BLANKS   @KEYG                           S01194
     C                     PARM *BLANKS   @KEYH                           S01194
     C           SDNOST    PARM SDNOST    DSFDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *INLR            *****5
     C                     MOVE '1'       *INKC            *****5
     C                     MOVE '1'       *INU7            ***************
     C                     MOVE '1'       *INU8            *             *
     C*****                MOVEL'FDTBLILL'DBFILE           * DB ERROR 004*S01194
     C*****                MOVEL@KEY      DBKEY            *             *S01194
     C                     MOVEL'SDNOSTPD'DBFILE           * DB ERROR 004*S01194
     C                     MOVEL@NSKYB    DBKEY            *             *S01194
     C                     MOVE @NSKYE    DBKEY            *             *S01194
     C                     MOVE '004'     DBASE            ***************
     C                     EXSR #C                         *****5
     C                     END                             E****5
     C*****      @PRI      IFEQ 'R'                        B****5         S01177
     C*****                MOVELCSNM      IGDORI           *****5 *****   S01194
     C*********************MOVELA7CSSN    IGDORI           *****5         S01194
     C                     MOVELA7NOSN    IGDORI           *****5         S01194
     C*****                ELSE                            X****5         S01177
     C*****                MOVELCSNM      IGDOPI           *****5         S01177
     C*****                END                             E****5         S01177
     C                     END                             E***4
     C                     ELSE                            X**3
     C*****      @PRI      IFEQ 'R'                        B***4          S01177
     C*****                MOVE DDMORI    IGDORI           ****4          S01177
     C                     MOVE PMRONS    IGDORI           ****4          S01177
     C*****                ELSE                            X***4          S01177
     C*****                MOVE DDMORI    IGDOPI           ****4          S01177
     C*****                END                             E***4          S01177
     C                     END                             E**3
     C                     ELSE                            X*2
     C                     MOVE *BLANKS   IGDORI           **2
     C*****                MOVE *BLANKS   IGDOPI           **2            S01177
     C                     END                             E*2
     C*
     C           PMPONS    IFNE *BLANKS                    B*2            S01177
     C           PMPSTM    IFEQ 01                         B**3           S01177
     C           PMPSTM    OREQ 02                         ***3           S01177
     C           PMPSTM    OREQ 12                         ***3           S01177
     C           PMPSTM    OREQ 07                         ***3           S01177
     C           PMPSTM    OREQ 08                         ***3           S01177
     C*****                                                       S01177  S01194
     C****et up key to nostro table                               S01177  S01194
     C*****                MOVE *BLANKS   @KEY             ***3   S01177  S01194
     C*****                MOVE '70'      @KEY1            ***3   S01177  S01194
     C*****                MOVELDDCCY     @5      5        ***3   S01177  S01194
     C                     MOVELPMPONS    @2      2        ***3           S01177
     C/COPY WNCPYSRC,MM0028C137
     C*****                MOVE @2        @5               ***3   S01177  S01194
     C*****                MOVE @5        @KEY             ***3   S01177  S01194
     C*                                                                   S01177
     C** Bypass validation of Nostro No. if it is 00. This is             S01177
     C**   always valid.                                                  S01177
     C           @2        IFNE '00'                       B***4          S01177
     C*****      @KEY      CHAINFDTBLILL             65    ****4  S01177  S01194
     C*****      *IN65     IFEQ '1'                        B****5 S01177  S01194
     C*****      RECI      ORNE 'D'                        *****5 S01177  S01194
032  C* CALL ACCESS PROG. FOR NOSTROS DETAILS.                            S01194
     C                     CALL 'AONOSTR0'                                S01194
     C*********************PARM '*DBERR ' @RTCD   7                S01194 E47225
     C                     PARM '*MSG   ' @RTCD   7                       E47225
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM *BLANK    @NSKEA  6                       S01194
     C***********          PARM DDCCY     @NSKYB  3                S01194 CEU003
     C/COPY WNCPYSRC,MM0028C138
     C                     PARM WEFCY     @NSKYB  3                       CEU003
     C/COPY WNCPYSRC,MM0028C139
     C**********           PARM *BLANK    @NSKYC  4                                    S01194 CGL029
     C                     PARM *BLANK    @NSKYC                                              CGL029
     C                     PARM *BLANK    @NSKYD  2                       S01194
     C                     PARM @2        @NSKYE  2                       S01194
     C                     PARM *BLANKS   @KEYF   3                       S01194
     C                     PARM *BLANKS   @KEYG  10                       S01194
     C                     PARM *BLANKS   @KEYH   1                       S01194
     C           SDNOST    PARM SDNOST    DSFDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *INLR            *****5         S01177
     C                     MOVE '1'       *INKC            *****5         S01177
     C                     MOVE '1'       *INU7            ***************S01177
     C                     MOVE '1'       *INU8            *             *S01177
     C*****                MOVEL'FDTBLILL'DBFILE           * DB E*S01177  S01194
     C*****                MOVEL@KEY      DBKEY            *     *S01177  S01194
     C                     MOVEL'SDNOSTPD'DBFILE           * DB ERROR 004*S01194
     C                     MOVEL@NSKYB    DBKEY            *             *S01194
     C                     MOVE @NSKYE    DBKEY            *             *S01194
     C                     MOVE '004'     DBASE            ***************S01177
     C                     EXSR #C                         *****5         S01177
     C                     END                             E****5         S01177
     C*****                MOVELCSNM      IGDOPI           ****4  S01177  S01194
     C*********************MOVELA7CSSN    IGDOPI           ****4          S01194
     C                     MOVELA7NOSN    IGDOPI           ****4          S01194
     C                     END                             E***4          S01177
     C                     ELSE                            X**3           S01177
     C                     MOVE PMPONS    IGDOPI           ***3           S01177
     C                     END                             E**3           S01177
     C                     ELSE                            X*2            S01177
     C                     MOVE *BLANKS   IGDOPI           **2            S01177
     C                     END                             E*2            S01177
     C*
     C** set up customer pay/recieve instructions
     C*
     C** if it is a customer number then convert it to a shortname
     C                     MOVE *BLANKS   IGDCRI           *1
     C                     MOVE *BLANKS   IGDCPI           *1
     C*****      DDMCPI    IFNE *BLANKS                    B*2            S01177
     C*****      PARIBN    IFNE *BLANKS                    B*2    S01177  S01194
     C           PARIBN    IFNE *BLANKS                    B*2            E279
     C*****                Z-ADD0         @@IDP            **2    *****   S01194
     C*****                Z-ADD6         @@IINT           **2    *****   S01194
     C*****                MOVE *BLANKS   @@ALPH           **2    *****   S01194
     C*****                MOVE DDMCPI    @@ALPH           **2    S01177  S01194
     C*****                MOVE PARIBN    @@ALPH           **2    S01177  S01194
     C*****                EXSR ZA0840                     **2    *****   S01194
     C*****      @@ERCD    IFEQ 0                          B**3   *****   S01194
     C*****                Z-ADD@@AMT     @CNUM            ***3   *****   S01194
     C*****      @CLTKY    CHAINCLINT                65    ***3   *****   S01194
     C*****      *IN65     IFEQ '0'                        B***4  *****   S01194
     C*****      RECI      ANDNE'D'                        ****4  *****   S01194
032  C* CALL ACCESS PROG. FOR CLIENT  DETAILS.                            S01194
     C                     CALL 'AOCUSTR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM PARIBN    @CLKEY 10                       S01194
     C                     PARM *BLANKS   @KYST   7                       E70
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
032  C*                                                                   S01194
     C                     MOVE '0'       *IN65            ****4          104599
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65            ****4
     C                     END                             E***4
     C           *IN65     IFEQ '0'                        B***4
     C*****      @PRI      IFEQ 'R'                        B****5         S01177
     C*****                MOVE CSNM      IGDCPI           *****5 *****   S01194
     C                     MOVE BBCSSN    IGDCPI           *****5         S01194
     C*****                ELSE                            X****5 S01177  S01194
     C*****                MOVE CSNM      IGDCRI           *****5 S01177  S01194
     C*****                END                             E****5 S01177  S01194
     C*****                END                             E***4          BHF635
     C                     ELSE                                           BHF635
     C*****                END                             E**3   *****   S01194
     C*****      @@ERCD    IFNE 0                          B**3           S01177
     C*****      *IN65     OREQ '1'                        ***3           S01177
     C*****                                                       *****   S01194
     C*****ttempt to access SNAME to find if a customer shortname *****   S01194
     C*****      DDMCPI    CHAINSNAME                65    ***3           S01177
     C*****      *IN65     IFEQ '1'                        B***4
     C*****      RECI      ORNE 'D'                        ****4  *****   S01194
     C*****                MOVE *BLANKS   @KEY             ****4  *****   S01194
     C*****                MOVE '71'      @KEY1            ****4  *****   S01194
     C*****                MOVELDDMCPI    @8               ****4          S01177
     C*****                MOVELPARIBN    @8      8        ****4  S01177  S01194
     C*****                MOVE @8        @KEY             ****4  *****   S01194
     C*****      @KEY      CHAINFDCPTILL             65    ****4  *****   S01194
     C*****      *IN65     IFEQ '1'                        B****5 *****   S01194
     C*****      RECI      ORNE 'D'                        *****5 *****   S01194
032  C* CALL ACCESS PROG. FOR COUNTERPARTY NOSTROS DETAIL                 S01194
     C                     CALL 'AOCNSTR0'                                S01194
     C*********************PARM '*DBERR ' @RTCD   7                S01194 E47225
     C                     PARM '*MSG   ' @RTCD   7                       E47225
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM PARIBN    @CNKEY  8                       S01194
     C           SDCNST    PARM SDCNST    DSFDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *INLR            *****5
     C                     MOVE '1'       *INKC            *****5
     C                     MOVE '1'       *INU7            ***************
     C                     MOVE '1'       *INU8            *             *
     C*****                MOVEL'FDCPTILL'DBFILE           * DB ER*****   S01194
     C*****                MOVEL@KEY      DBKEY            *      *****   S01194
     C                     MOVEL'AOCNSTR0'DBFILE           * DB ERROR 005*S01194
     C                     MOVEL@CNKEY    DBKEY            *             *S01194
     C                     MOVE '005'     DBASE            ***************
     C                     EXSR #C                         *****5
     C                     ELSE                            X****5
     C*****      @PRI      IFEQ 'R'                        B*****6        S01177
     C*****                MOVELCSN1      IGDCPI           ******6*****   S01194
     C***********          MOVELAWCSN1    IGDCPI           ******6 S01194 062436
     C*****                MOVE CSN2      IGDCPI           ******6*****   S01194
     C***********          MOVE AWCSN2    IGDCPI           ******6 S01194 062436
     C                     MOVELPARIBN    IGDCPI           ******6        062436
     C*****                ELSE                            X*****6        S01177
     C*****                MOVELCSN1      IGDCRI           ******6        S01177
     C*****                MOVE CSN2      IGDCRI           ******6        S01177
     C*****                END                             E*****6        S01177
     C                     END                             E****5
     C*****                ELSE                            X***4          S01177
     C*****      @PRI      IFEQ 'R'                        B****5         S01177
     C*****                MOVE DDMCPI    IGDCPI           *****5         S01177
     C*****                MOVE *BLANKS   IGDCRI           *****5         S01177
     C*****                ELSE                            X****5         S01177
     C*****                MOVE DDMCPI    IGDCRI           *****5         S01177
     C*****                MOVE *BLANKS   IGDCPI           *****5         S01177
     C*****                END                             E****5         S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3   *****   S01194
     C*****                END                             E*2    *****   S01194
     C                     END                             E*2            E279
     C                     END                                            BHF635
     C*
     C** if it is a customer number then convert it to a shortname        S01177
     C*****      PAAWBN    IFNE *BLANKS                    B*2    S01177  S01194
     C           PAAWBN    IFNE *BLANKS                    B*2            E279
     C*****                Z-ADD0         @@IDP            **2    S01177  S01194
     C*****                Z-ADD6         @@IINT           **2    S01177  S01194
     C*****                MOVE *BLANKS   @@ALPH           **2    S01177  S01194
     C*****                MOVE PAAWBN    @@ALPH           **2    S01177  S01194
     C*****                EXSR ZA0840                     **2    S01177  S01194
     C*****      @@ERCD    IFEQ 0                          B**3   S01177  S01194
     C*****                Z-ADD@@AMT     @CNUM            ***3   S01177  S01194
     C*****      @CLTKY    CHAINCLINT                65    ***3   S01177  S01194
     C*****      *IN65     IFEQ '0'                        B***4  S01177  S01194
     C*****      RECI      ANDNE'D'                        ****4  S01177  S01194
     C* RESET WORK INDICATOR BEFORE THIS SECTION OTHERWISE                E29463
     C* COUNTERPARTY NOSTRO ACCESS PROGRAM CAN BE CALLED IN ERROR         E29463
     C                     SETOF                     65                   E29463
032  C* CALL ACCESS PROG. FOR CUSTOMER DETAIL                             S01194
     C                     CALL 'AOCUSTR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM PAAWBN    @CLKEY 10                       S01194
     C                     PARM *BLANKS   @KYST   7                       E70
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
032  C*                                                                   S01194
     C                     MOVE '0'       *IN65            ****4          104599
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65            ****4          S01177
     C                     END                             E***4          S01177
     C           *IN65     IFEQ '0'                        B***4          S01177
     C*****                MOVE CSNM      IGDCRI           ****4  S01177  S01194
     C                     MOVE BBCSSN    IGDCRI           ****4          S01194
     C                     END                             E***4          S01177
     C*****                END                             E**3           S01177
     C           *IN65     IFEQ '1'                        B**3   S01177  S01194
     C*****      RECI      ORNE 'D'                        ***3   S01177  S01194
     C*****                MOVE *BLANKS   @KEY             ***3   S01177  S01194
     C*****                MOVE '71'      @KEY1            ***3   S01177  S01194
     C*****                MOVELPAAWBN    @8               ***3   S01177  S01194
     C*****                MOVE @8        @KEY             ***3   S01177  S01194
     C*****      @KEY      CHAINFDCPTILL             65    ***3   S01177  S01194
     C*****      *IN65     IFEQ '1'                        B***4  S01177  S01194
     C*****      RECI      ORNE 'D'                        ****4  S01177  S01194
032  C* CALL ACCESS PROG. FOR COUNTERPARTY NOSTROS DETAIL                 S01194
     C                     CALL 'AOCNSTR0'                                S01194
     C*********************PARM '*DBERR ' @RTCD   7                S01194 E47225
     C                     PARM '*MSG   ' @RTCD   7                       E47225
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM PAAWBN    @CNKEY  8                       S01194
     C           SDCNST    PARM SDCNST    DSFDY                           S01194
032  C*                                                                   S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     MOVE '1'       *INLR            ****4          S01177
     C                     MOVE '1'       *INKC            ****4          S01177
     C                     MOVE '1'       *INU7            ***************S01177
     C                     MOVE '1'       *INU8            *             *S01177
     C*****                MOVEL'FDCPTILL'DBFILE           * DB ERS01177  S01194
     C*****                MOVEL@KEY      DBKEY            *      S01177  S01194
     C                     MOVEL'AOCNSTR0'DBFILE           * DB ERROR 005*S01194
     C*********************MOVEL@KEY      DBKEY            *       *S01194E276
     C                     MOVEL@CNKEY    DBKEY            *             *E276
     C                     MOVE '005'     DBASE            ***************S01177
     C                     EXSR #C                         ****4          S01177
     C                     ELSE                            X***4          S01177
     C*****                MOVELCSN1      IGDCRI           ****4  S01177  S01194
     C***********          MOVELAWCSN1    IGDCRI           ****4  S01194  062436
     C*****                MOVE CSN2      IGDCRI           ****4  S01177  S01194
     C***********          MOVE AWCSN2    IGDCRI           ****4  S01194  062436
     C                     MOVELPAAWBN    IGDCRI           ****4          062436
     C                     END                             E***4          S01177
     C                     END                             E**3           S01177
     C*****                END                             E*2    S01177  S01194
     C                     END                             E*2            E279
     C*                                                                   S01177
     C** set up for account of
     C*****                MOVE DDMFAO    IGMFAO           *1             S01177
     C*********************MOVE PABENN    IGMFAO           *1       S01177E24031
     C                     MOVELPABENN    IGMFAO           *1             E24031
     C*
     C** if it is a customer number then convert it to a shortname
     C*****      DDMFAO    IFNE *BLANKS                    B*2            S01177
     C           PABENN    IFNE *BLANKS                    B*2            S01177
     C*****                Z-ADD0         @@IDP            **2    *****   S01194
     C*****                Z-ADD6         @@IINT           **2    *****   S01194
     C*****                MOVE *BLANKS   @@ALPH           **2    *****   S01194
     C*****                MOVE DDMFAO    @@ALPH           **2            S01177
     C*****                MOVE PABENN    @@ALPH           **2    S01177  S01194
     C*****                EXSR ZA0840                     **2    *****   S01194
     C*****      @@ERCD    IFEQ 0                          B**3   *****   S01194
     C*****                Z-ADD@@AMT     @CNUM            ***3   *****   S01194
     C*****      @CLTKY    CHAINCLINT                65    ***3   *****   S01194
     C*****      *IN65     IFEQ '0'                        B***4  *****   S01194
     C*****      RECI      ANDNE'D'                        ****4  *****   S01194
032  C* CALL ACCESS PROG. FOR CUSTOMER DETAILS.                           S01194
     C                     CALL 'AOCUSTR0'                                S01194
     C                     PARM '       ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM PABENN    @CLKEY 10                       S01194
     C                     PARM *BLANKS   @KYST   7                       E70
     C           SDCUST    PARM SDCUST    DSSDY                           S01194
032  C*                                                                   S01194
     C                     MOVE '0'       *IN65            ***3           BHF946
     C           @RTCD     IFNE *BLANK                     B***4          S01194
     C                     MOVE '1'       *IN65                           S01194
     C                     END                             E***4
     C**  IF LIVE RECORD FOUND
     C           *IN65     IFEQ '0'                        B***4
     C*****                MOVE CSNM      IGDFAC           ****4  *****   S01194
     C*****                MOVE DRSN      IGDFAC           ****4          E16027
     C                     MOVELBBDRCS    IGDFAC           ****4          S01194
     C                     MOVE BBLCCD    IGDFAC           ****4          S01194
     C                     END                             E***4
     C*****                ELSE                            X**3           S01177
     C*****      DDMFAO    CHAINSNAME                65    ***3           S01177
     C*****      *IN65     IFEQ '0'                        B***4          S01177
     C*****                MOVE CSNM      IGDFAC           ****4          S01177
     C*****                END                             E***4          S01177
     C*****                END                             E**3   *****   S01194
     C*****      *IN65     IFEQ '1'                        B**3   *****   S01194
     C*****      RECI      ORNE 'D'                        ***3   *****   S01194
     C*****                MOVE '1'       *INLR            ***3   *****   S01194
     C*****                MOVE '1'       *INKC            ***3   *****   S01194
     C*****                MOVE '1'       *INU7            ************   S01194
     C*****                MOVE '1'       *INU8            *      *****   S01194
     C*****                MOVEL'CLINT   'DBFILE           * DB ER*****   S01194
     C*****                MOVEL@KEY      DBKEY            *      *****   S01194
     C*****                MOVE '006'     DBASE            ************   S01194
     C*****                EXSR #C                         ***3   *****   S01194
     C*****                END                             E**3   *****   S01194
     C*
     C** If up to this point the for account of cannot be found, try to   E16027
     C** search the counter party nostros.                                E16027
     C           @RTCD     IFNE *BLANK                                    E16027
     C*
     C* CALL ACCESS PROG. FOR COUNTERPARTY NOSTROS DETAIL                 E16027
     C                     CALL 'AOCNSTR0'                                E16027
     C*********************PARM '*DBERR ' @RTCD   7                E16027 E47225
     C                     PARM '*MSG   ' @RTCD   7                       E47225
     C                     PARM '*KEY   ' @OPTN   7                       E16027
     C                     PARM PABENN    @CNKEY  8                       E16027
     C           SDCNST    PARM SDCNST    DSFDY                           S01194
     C*                                                                   E16027
     C           @RTCD     IFNE *BLANK                                    E16027
     C                     MOVE '1'       *IN65                           E16027
     C                     ELSE                                           087924
     C                     MOVE '0'       *IN65                           087924
     C                     END                                            E16027
     C*
     C************         MOVELDDMFAO    @FAC8            ***3           E16027
     C************         MOVEL'71  '    @FACK            ***3           E16027
     C************         MOVE @FAC8     @FACK            ***3           E16027
     C***********@FACK     CHAINFDCPTILL             65    ***3           E16027
     C           *IN65     IFEQ '0'                        B***4          E16027
     C***********          MOVELAWCSN1    IGDFAC           ****4   E16027 062436
     C***********          MOVE AWCSN2    IGDFAC           ****4   E16027 062436
     C                     MOVELPABENN    IGDFAC           ****4          062436
     C                     ELSE                            X***4          E16027
     C************IN65     IFEQ '1'                        B**3           E16027
     C***********RECI      ORNE 'D'                        ***3           E16027
     C                     MOVE '1'       *INLR            ****4
     C                     MOVE '1'       *INKC            ****4
     C                     MOVE '1'       *INU7            ***************
     C                     MOVE '1'       *INU8            *             *
     C*********************MOVEL'CLINT   'DBFILE           * DB ERROR 006*E16027
     C                     MOVEL'SDCNSTPD'DBFILE           * DB ERROR 006*E16027
     C*********************MOVEL@KEY      DBKEY            *             *E16027
     C                     MOVELPABENN    DBKEY            *             *E16027
     C                     MOVE '006'     DBASE            ***************
     C                     EXSR #C                         ****4
     C                     END                             E***4          E16027
     C                     END
     C*
     C                     ELSE                            X*2
     C                     MOVE *BLANKS   IGDFAC           **2
     C                     END                             E*2
     C*
     C                     MOVE H@TYPE    IGOGDT           *1
     C*
     C                     MOVE H@MTYP    IGOMDT           *1
     C                     MOVE H@CSNM    IGCSNM                          S01354
     C**********           Z-ADDH@CNUM    IGCNUM                                       S01354 CSD027
     C                     MOVE H@CNUM    IGCNUM                                              CSD027
     C*
     C** RBSI of original deal
     C                     MOVE H@RBSI    IGORBS           *1
     C*
     C                     Z-ADD0         IGPCTN           *1
     C                     MOVE H@CDRP    IGCDRP           *1
     C                     MOVE DDACTN    IGLACT           *1
     C*
     C           DDACTN    IFEQ 'I'                        B*2
     C                     MOVE DDTIME    IGTIME           **2
     C                     MOVEL@USER     IGDUSC           **2
     C/COPY WNCPYSRC,MM0028CP49                                           S01408
     C                     ELSE                            X*2
     C                     Z-ADD0         IGTIME           **2
     C                     MOVE H@DUSC    IGDUSC           **2
     C                     END                             E*2
     C*
     C*****                MOVE DDSPEC    IGSPEC           *1             S01177
     C                     MOVE PMBTB1    IGSPEC           *1             S01177
     C                     MOVE PMBTB1    IGBTB1           *1             S01177
     C                     MOVE PMBTB2    IGBTB2           *1             S01177
     C                     MOVE PMBTB3    IGBTB3           *1             S01177
     C                     MOVE PMBTB4    IGBTB4           *1             S01177
     C                     MOVE PMBTB5    IGBTB5           *1             S01177
     C                     MOVE PMBTB6    IGBTB6           *1             S01177
     C                     MOVE PMCVMR    IGCVMR           *1             E22405
     C                     MOVELH@AOFR    IGAOFR           *1
     C                     TIME           @MCHDT           *1
     C                     Z-ADD@MCHD     IGMCHD           *1
     C*****                Z-ADDRUND      IGDDLD           *1     *****   S01194
     C                     Z-ADDBJRDNB    IGDDLD           *1             S01194
     C*****                Z-ADDRUND      IGDLAD           *1     *****   S01194
     C                     Z-ADDBJRDNB    IGDLAD           *1             S01194
     C*
     C** setup the NEW standard deal fields                               S01177
     C                     MOVELPMRSTM    IGRSTM           *1             S01177
     C                     MOVELPMRONS    IGRONS           *1             S01177
     C                     MOVELPARIBN    IGRIBN           *1             S01177
     C                     MOVELPMPSTM    IGPSTM           *1             S01177
     C                     MOVELPMPONS    IGPONS           *1             S01177
     C                     MOVELPAAWBN    IGAWBN           *1             S01177
     C                     MOVELPABENN    IGBENN           *1             S01177
     C                     MOVELPMRIBA    IGRIBA           *1             S01177
     C                     MOVELPAROBN    IGROBN           *1             S01177
     C                     MOVELPAROCN    IGROCN           *1             S01177
     C                     MOVELPAPIBN    IGPIBN           *1             S01177
     C                     MOVELPMPIBA    IGPIBA           *1             S01177
     C                     MOVELPAPOBN    IGPOBN           *1             S01177
     C                     MOVELPAPOCN    IGPOCN           *1             S01177
     C                     MOVELPARCRN    IGRCRN           *1             S01177
     C                     MOVELPMRCRA    IGRCRA           *1             S01177
     C                     MOVELPARVNO    IGRVNO           *1             S01177
     C                     MOVELPMAWBA    IGAWBA           *1             S01177
     C                     MOVELPMBENA    IGBENA           *1             S01177
     C                     MOVELPMDTP1    IGDTP1           *1             S01177
     C                     MOVELPMDTP2    IGDTP2           *1             S01177
     C                     MOVELPMDTP3    IGDTP3           *1             S01177
     C                     MOVELPMDTP4    IGDTP4           *1             S01177
     C                     MOVELPMDCHG    IGDCHG           *1             S01177
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028CP50                                           S01408
     C*
     C           #ZJ9      ENDSR                           **#ZJ9**
     C*****************************************************************
     C/EJECT                                                              S01354
     C*****************************************************************   S01354
     C*                                                               *   S01354
     C*            #ZT    - Set up Standard deal for Internal Deals   *   S01354
     C*                                                               *   S01354
     C**CALLS****ZA0710***-*MIDAS*day*number*to*YYYYMMDD************S01354056095
     C* CALLS    ZDATE9   - MIDAS day number to YYYYMMDD              *   056095
     C*          ZA0840   - Validate/reformat input amount            *   S01354
     C*                                                               *   S01354
     C* CALLED BY  #BDAA    - Calls new record update routines.       *   S01354
     C*            #ZG      - Calls update routines.                  *   S01354
     C*                                                               *   S01354
     C* FLDS USED                                                     *   S01354
     C*                                                               *   S01354
     C*****************************************************************   S01354
     C           #ZT       BEGSR                                          S01354
     C*                                                                   S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  * Set up standard deal for action code 'D'         *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C** Move fields from the deals file MMDEAMPP.                        S01354
     C           IGLACT    IFEQ 'D'                        B1             S01354
     C                     Z-ADDHNDS38    IGDS38           *1             S01354
     C                     MOVE 'IG'      IGRCID           *1             S01354
     C                     MOVE HNDLTF    IGDLTF           *1             S01354
     C                     Z-ADDHNDLUP    IGDLUP           *1             S01354
     C                     MOVE HNMLUP    IGMLUP           *1             S01354
     C                     Z-ADDHNYLUP    IGYLUP           *1             S01354
     C                     Z-ADDHNTLUP    IGTLUP           *1             S01354
     C                     MOVE HNCHTP    IGCHTP           *1             S01354
     C                     Z-ADDHNLCD     IGLCD            *1             S01354
     C                     MOVE HNLUID    IGLUID           *1             S01354
     C                     MOVE HNDMAD    IGDMAD           *1             S01354
     C                     Z-ADDHNDA38    IGDA38           *1             S01354
     C                     MOVE HNDMSQ    IGDMSQ           *1             S01354
     C                     MOVE HNCCY     IGCCY            *1             S01354
     C                     Z-ADDHNCYDP    IGCYDP           *1             S01354
     C                     Z-ADDHNVDYY    IGVDYY           *1             S01354
     C                     Z-ADDHNVDMM    IGVDMM           *1             S01354
     C                     Z-ADDHNVDDD    IGVDDD           *1             S01354
     C                     Z-ADDHNDTYY    IGDTYY           *1             S01354
     C                     Z-ADDHNDTMM    IGDTMM           *1             S01354
     C                     Z-ADDHNDTDD    IGDTDD           *1             S01354
     C                     MOVE HNOSBR    IGOSBR           *1             S01354
     C                     MOVE HNBRCA    IGBRCA           *1             E49965
     C                     MOVE HNOGDT    IGOGDT           *1             S01354
     C                     MOVE HNOMDT    IGOMDT           *1             S01354
     C                     MOVE HNCSNM    IGCSNM           *1             S01354
     C**********           Z-ADDHNCNUM    IGCNUM           *1                          S01354 CSD027
     C                     MOVE HNCNUM    IGCNUM           *1                                 CSD027
     C                     MOVELHNSTCY    IGSTCY                          CEU003
     C                     MOVELHNIC72    IGIC72                          CEU003
     C                     END                             E1             S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  * Set up standard deal for action codes 'I' & 'A'  *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C           IGLACT    IFEQ 'A'                        B1             S01354
     C           IGLACT    OREQ 'I'                        *1             S01354
     C*                                                                   S01354
     C**  Key fields                                                      S01354
     C                     MOVE H@DADN    IGDA38           *1             S01354
     C                     MOVE HNDS38    IGDS38           *1             S01354
     C*                                                                   S01354
     C**  Access Linked Internal Deal                                     S01354
     C*                                                                   S01354
     C                     MOVE '0'       *IN65                           S01354
     C           IGDA38    CHAINMMDEALLL             65                   S01354
     C           *IN65     IFEQ '1'                        B*2            S01354
     C                     MOVE '1'       *INLR            **2            S01354
     C                     MOVE '1'       *INU7            **2            S01354
     C                     MOVE '1'       *INU8            **2            S01354
     C                     MOVE '1'       *INKC            ***************S01354
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 010 *S01354
     C                     MOVELIGDA38    DBKEY            ***************S01354
     C                     MOVE '010'     DBASE            **2            S01354
     C                     EXSR #C                         **2            S01354
     C                     END                             E*2            S01354
     C*                                                                   S01354
     C*  Initialise fields                                                S01354
     C** on which the deam is based                                       S01354
     C*                                                                   S01354
     C*                                                                   S01354
     C           IGLACT    IFEQ 'I'                        B*2            S01354
     C                     MOVE 'I'       IGMACT           **2            S01354
     C                     MOVE *BLANKS   IGDMAD           **2            S01354
     C                     MOVE *BLANKS   IGDMSQ           **2            S01354
     C*                                                                   S01354
     C                     ELSE                            X*2            S01354
     C                     MOVE 'A'       IGMACT           **2            S01354
     C                     MOVE HNDMAD    IGDMAD           **2            S01354
     C                     MOVE HNDMSQ    IGDMSQ           **2            S01354
     C                     END                             E*2            S01354
     C*                                                                   S01354
     C** Signed amount : If pay -ve , recieve +ve.                        S01354
     C                     Z-SUBIGAMNP    IGAMNP           *1             S01354
     C*                                                                   S01354
     C                     MOVE H@POBR    IGOSBR           *1             S01354
     C                     MOVE H@BRCA    IGBRCA           *1             E49965
     C                     MOVE H@TYPE    IGOGDT           *1             S01354
     C                     MOVE H@MTYP    IGOMDT           *1             S01354
     C                     MOVE H@CSNM    IGCSNM           *1             S01354
     C**********           Z-ADDH@CNUM    IGCNUM           *1                          S01354 CSD027
     C                     MOVE H@CNUM    IGCNUM           *1                                 CSD027
     C*                                                                   S01354
     C                     MOVELHNSTCY    IGSTCY                          CEU003
     C                     MOVELHNIC72    IGIC72                          CEU003
     C                     END                             E1             S01354
     C*                                                                   S01354
     C           #ZT9      ENDSR                           **#ZT9**       S01354
     C*****************************************************************   S01354
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*      #ZG      - calls update routines                         *
     C*                                                               *
     C* CALLS    #ZD      - Move file to screen.                      *
     C*          #ZE      - clear screen                              *
     C*          #ZEA     - Clear standard deal                       *   E18139
     C*          #ZA      - Resets screen error indicators and msgq   *
     C*          ZA0440   - Send message with data.                   *
     C*          #ZJ      - Set up Standard deal                      *
     C*          #ZT      - Set up Standard Deal for Linked Deal      *   S01354
     C*          ZA0250   - Clears message queue.                     *
     C*          MM0078   - Update MM database                        *
     C***********MM0082***-*Update*midas*data*base                    *   082738
     C*          MM0083   - Update midas data base                    *   082738
     C*                                                               *
     C* CALLED BY  #ZC    - Enter processing for action code A.       *
     C*                                                               *
     C* FLDS USED  @DLKEY - deal file key                             *
     C*            @KVALD - Key field  : value date                   *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @DSPM  - Month frm screen field : value date       *
     C*            @DSPD  - Year from screen field : value date       *
     C*            @VDYY  - Value date : year                         *
     C*            @VDMM  - Value date : month                        *
     C*            @VDDD  - Value date : day                          *
     C*            @KSEQN - Sequence number key field                 *
     C*            @DMKEY - Key to deams file                         *
     C*            @KEY   - key for table files                       *
     C*            @VYEAR - Year numeric field                        *
     C*            @MSGID - message id                                *
     C*            @DLUP  - day of last update                        *
     C*            @MLUP  - month of last update                      *
     C*            @YLUP  - year of last update                       *
     C*            @TLUP  - time of last update                       *
     C*            @RLSFL - Release locked deams record               *
     C*            @DATAA - Authorized text                           *
     C*            @TERM  - Termination parameter                     *
     C*************@FBOI**-*Front*or*back*office*indicator*************   S01319
     C*            @THSDL - This deal type indicator                  *
     C*            @STDDL - Standard deal format : loans/deposits     *
     C*            @STDDB -   "       "     "    : N/A's bought       *
     C*            @STDDS -   "       "     "    : N/A's sold         *
     C*            @STDDA -   "       "     "    : DEAMS              *
     C*                                                               *
     C*****************************************************************
     C           #ZG       BEGSR
     C*
     C/COPY WNCPYSRC,MM0028C026
     C*  *--------------------------------------------------*
     C*  * Check for update by another user                 *
     C*  *--------------------------------------------------*
     C*
     C**  - *IN72 set on if the record is not found.
     C**  - *IN79 set on if the record is locked.
     C*
     C                     MOVE DDDLNO    @DLKEY
     C*
     C** Load value date to numeric keyfield,in YYYYMMDD format
     C                     Z-ADD0         @KVALD
     C                     MOVE @DSPY     @VYEAR
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPD     @VDDD
     C                     ELSE                                           BHF183
     C                     MOVE @DSPD     @VDMM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPM     @VDMM
     C                     ELSE                                           BHF183
     C                     MOVE @DSPM     @VDDD                           BHF183
     C                     END                                            BHF183
     C*
     C** Century
     C           @VYEAR    IFGE 72                         B1
     C           @VDYY     ADD  1900      @VDYY            *1
     C                     ELSE                            X1
     C           @VDYY     ADD  2000      @VDYY            *1
     C                     END                             E1
     C                     MOVE DDDS38    @KSEQN  30
     C*
     C           @DMKEY    CHAINMMDAMULL             7279
     C/COPY WNCPYSRC,MM0028C146
     C*
     C**  If no record for that key exists, *IN72 is set on.
     C           *IN72     IFEQ '1'                        B1
     C*
     C                     MOVELDDDLNO    DBKEY            ***************
     C                     MOVEL'MMDAMULL'DBFILE           *             *
     C                     MOVEL'008'     DBASE            * DB ERROR 008*
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INKC            *1
     C*
     C**  By-pass further update processing.
     C                     EXSR #C                         *1
     C*
     C                     END                             E1
     C*
     C**  If *IN79 is on then the record is locked.
     C           *IN79     IFEQ '1'                        B1
     C*
     C**  Clear the screen error message queue.
     C                     EXSR #ZA                        *1
     C*
     C**  Set up error output to screen.
     C*****                MOVE *BLANKS   @DATA            *1     *****   S01177
     C                     MOVE *BLANKS   @DATA  45        *1             S01177
     C                     MOVE DDVDAT    @ERVDT           *1
     C                     MOVEL@TXT,1    @DATA1
     C                     MOVELDDDLNO    @DATA2           *1             S01354
     C                     MOVE @DMDTA    @DATA            *1
     C                     MOVEL'MMM1011' @MSGID           *1
     C                     CALL 'ZA0440'                   *1
     C                     PARM           @MSGID           *1
     C                     PARM           @DATA            *1
     C*
     C**  By-pass further update processing.
     C                     GOTO #ZG9                       *1
     C*
     C                     END                             E1
     C*
     C**  If any of the date and time fields have changed since
     C**  the file was initially read, then the record has been
     C**  updated by another workstation.
     C           @DLUP     IFNE HNDLUP                     B1
     C           @MLUP     ORNE HNMLUP                     *1
     C           @YLUP     ORNE HNYLUP                     *1
     C           @TLUP     ORNE HNTLUP                     *1
     C*
     C**  - If last change type is A, update was an amendment.
     C           HNLACT    IFEQ 'A'                        B*2
     C*
     C                     MOVEL'MMM1013' @MSGID           **2
     C*
     C**  Set on indicator to show that an external transaction has
     C**  taken place - used to prevent new field values from being
     C**  blanked at the end of select processing.
     C                     MOVE '1'       *IN78            **2
     C*
     C                     END                             E*2
     C*
     C**  - If last change type is D, update was an deletion.
     C           HNLACT    IFEQ 'D'                        B*2
     C*
     C                     MOVEL'MMM1014' @MSGID           **2
     C*
     C**  Set on indicator to show that an external transaction has
     C**  taken place - used to prevent new field values from being
     C**  blanked at the end of select processing.
     C                     MOVE '1'       *IN78            **2
     C*
     C                     END                             E*2
     C*
     C**  - If last change type is X, update was an authorization
     C           HNLACT    IFEQ 'X'                        B*2
     C*
     C                     MOVEL'MMM1035' @MSGID           **2
     C*
     C**  Set on indicator to show that an external transaction has
     C**  taken place - used to prevent new field values from being
     C**  blanked at the end of select processing.
     C                     MOVE '1'       *IN78            **2
     C*
     C                     END                             E*2
     C*
     C**  Set up error output to screen.
     C                     MOVE *BLANKS   @DATA            *1
     C                     MOVE DDVDAT    @ERVDT           *1
     C                     MOVEL@TXT,2    @DATA1           *1
     C                     MOVELDDDLNO    @DATA2           *1             S01354
     C                     MOVE @DMDTA    @DATA            *1
     C                     CALL 'ZA0440'                   *1
     C                     PARM           @MSGID           *1
     C                     PARM           @DATA            *1
     C*
     C**  - If last change type is I or A, display new field values.
     C           HNLACT    IFEQ 'X'                        B*2
     C           HNLACT    OREQ 'A'                        X*2
     C*
     C**  Set up screen and work fields with newly changed values (i.e.
     C**  from chain to update file).
     C                     EXSR #ZD                        **2
     C           DDACTN    IFNE 'X'                        B**3
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP7                                           S01408
     C*                                                                   S01408
     C                     MOVE 'E'       DDACTN           ***3
     C                     END                             E**3
     C*
     C                     END                             E*2
     C*
     C**  - If last change type is D update was an deletion.
     C           HNLACT    IFEQ 'D'                        B*2
     C*
     C**  Clear screen fields.
     C                     EXSR #ZE                        **2
      *                                                                   E18139
      **  And standard deal fields                                        E18139
     C                     EXSR #ZEA                       **2            E18139
     C*
     C                     END                             E*2
     C*
     C**  Release locked record.
     C                     EXCPT@RLSFL                     *1
     C*
     C**  By-pass further update processing.
     C                     GOTO #ZG9                       *1
     C*
     C                     END                             E1
     C*********************                                         BHF298BHF439
     C****Release*record*to prevent lock error in MM0078.  This is  BHF298BHF439
     C****necessary*because MMDAMULL is an update file in both prog BHF298BHF439
     C*********************EXCPT@RLSFL                              BHF298BHF439
     C*
     C**  Retrieve the MIDAS date and set up the file fields.
     C*
     C*  *--------------------------------------------------*
     C*  *  Set up Standard deal for updates                *
     C*  *--------------------------------------------------*
     C*
     C                     EXSR #ZJ
     C*
     C*  *--------------------------------------------------*             S01354
     C*  * Check for update of Linked Internal Deal         *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                       B1             S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C*                                                                   S01354
     C**  - *IN72 set on if the record is not found.                      S01354
     C**  - *IN79 set on if the record is locked.                         S01354
     C*                                                                   S01354
     C                     MOVE H@DADN    @DLKEY                          S01354
     C           @DMKEY    CHAINMMDAMULL             7279                 S01354
     C*                                                                   S01354
     C**  If no record for that key exists, *IN72 is set on.              S01354
     C           *IN72     IFEQ '1'                        B*2            S01354
     C*                                                                   S01354
     C                     MOVELH@DADN    DBKEY            ***************S01354
     C                     MOVEL'MMDAMULL'DBFILE           *             *S01354
     C                     MOVEL'011'     DBASE            * DB ERROR 011*S01354
     C                     MOVE '1'       *INU7            *             *S01354
     C                     MOVE '1'       *INU8            ***************S01354
     C                     MOVE '1'       *INKC            **2            S01354
     C*                                                                   S01354
     C**  By-pass further update processing.                              S01354
     C                     EXSR #C                         **2            S01354
     C                     END                             E*2            S01354
     C*                                                                   S01354
     C**  If *IN79 is on then the record is locked.                       S01354
     C           *IN79     IFEQ '1'                        B*2            S01354
     C*                                                                   S01354
     C**  Set up error output to screen.                                  S01354
     C                     MOVE *BLANKS   @DATA  45        **2            S01354
     C                     MOVE DDVDAT    @ERVDT           **2            S01354
     C                     MOVEL@TXT,1    @DATA1           **2            S01354
     C                     MOVELH@DADN    @DATA2           **2            S01354
     C                     MOVE @DMDTA    @DATA            **2            S01354
     C                     MOVEL'MMM1011' @MSGID           **2            S01354
     C                     CALL 'ZA0440'                   **2            S01354
     C                     PARM           @MSGID           **2            S01354
     C                     PARM           @DATA            **2            S01354
     C*                                                                   S01354
     C**  By-pass further update processing.                              S01354
     C                     GOTO #ZG9                       **2            S01354
     C*                                                                   S01354
     C                     END                             E*2            S01354
     C                     END                             E1             S01354
      *                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP64                                           S01408
      *                                                                   S01408
     C*                                                                   S01354
     C*  *--------------------------------------------------*
     C*  *  Set up Confirmation Message                     *
     C*  *--------------------------------------------------*
     C*
     C           DDACTN    IFNE 'D'                        B1
     C/COPY WNCPYSRC,MM0028C144
     C***********@NOPMS    ANDNE5                          *1             E20031
     C                     MOVE *BLANKS   @DATA            *1
     C           DDACTN    IFEQ 'A'                        B*2
     C                     MOVEL'amend'   @DATA            **2
     C                     END                             E*2
     C           DDACTN    IFEQ 'I'                        B*2
     C                     MOVEL'insert'  @DATA            **2
     C** Do not display FEEDBACK information (or DELETED)                 S01184
     C                     MOVE '1'       *IN35                           S01184
     C                     MOVE '0'       *IN39                           S01184
     C                     END                             E*2
     C           DDACTN    IFEQ 'X'                        B*2
     C                     MOVEL'authoriz'@DATAA  9        **2
     C                     MOVE 'e'       @DATAA           **2
     C                     MOVEL@DATAA    @DATA            **2
     C                     END                             E*2
     C***********          MOVEL'MMM1037' @MSGID           *1             059667
     C                     MOVEL'MMX1036' @MSGID                          059667
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDBU                                           S01408
     C*
     C*
     C** If warning indicator is on do not clear warning messages.        E14379
     C           *IN55     IFEQ '0'                        B*2            E14379
     C*****                CALL 'ZA0250'                   *1     *****   S01177
     C                     CALL 'ZA0250'                   **2            S01177
     C                     END                             E*2            E14379
     C                     CALL 'ZA0440'                   *1
     C                     PARM           @MSGID           *1
     C                     PARM           @DATA            *1
     C                     MOVE '1'       *IN50            *1
     C** Do not display FEEDBACK information (or DELETED)                 S01184
     C                     MOVE '1'       *IN35                           S01184
     C                     MOVE '0'       *IN39                           S01184
     C/COPY WNCPYSRC,MM0028C027
     C                     WRITEMM0028S0                   *1
     C                     WRITEMM0028D2                   *1             S01199
     C                     WRITEMM0028D0                   *1
     C*********************READ MM0028S0                 60*1             S01199
     C                     READ MM0028D2                 60*1             S01199
     C/COPY WNCPYSRC,MM0028C003
     C                     CALL 'ZA0250'                   *1
     C/COPY WNCPYSRC,MM0028C028
     C                     MOVE '0'       *IN50            *1
     C/COPY WNCPYSRC,MM0028C056
     C                     MOVE '1'       *IN41            *1
     C           *INKL     IFEQ '1'                        B*2
     C                     MOVE '0'       *INKL            **2
     C*                                                                   S01177
     C**  if this SR was called via SELECT processing and F12 has been    S01177
     C**  pressed in response to auth. prompt, reset ACTION CODE to 'E'   S01177
     C*                                                                   S01177
     C************IN15     IFEQ '1'                        B**3    S01177 E20897
     C           *IN17     IFEQ '1'                        B**3           E20897
     C                     MOVE 'E'       DDACTN           ***3           S01177
     C*********************SETOF                     15            S01177 E20897
     C                     SETOF                     17                   E20897
     C                     END                             E**3           S01177
     C*                                                                   S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB1                                           S01408
     C*
     C                     GOTO #ZG9                       **2
     C*                                                                   059667
     C                     ELSE                                           059667
     C/COPY WNCPYSRC,MM0028C029
     C           DDACTN    IFEQ 'X'                                       059667
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB2                                           S01408
     C*                                                                   S01408
     C                     EXSR #BG                                       059667
     C/COPY WNCPYSRC,MM0028C067
     C           *IN55     IFEQ '1'                                       059667
     C                     MOVEL'MMM1030' @MSGID                          059667
     C                     CALL 'ZA0440'                                  059667
     C                     PARM           @MSGID                          059667
     C                     PARM           @DATA                           059667
     C                     ELSE                                           059667
     C                     MOVEL'MMM1036' @MSGID                          059667
     C                     CALL 'ZA0250'                                  059667
     C                     CALL 'ZA0440'                                  059667
     C                     PARM           @MSGID                          059667
     C                     PARM           @DATA                           059667
     C                     END                                            059667
     C/COPY WNCPYSRC,MM0028C075
     C                     WRITEMM0028S0                                  059667
     C                     WRITEMM0028D2                                  059667
     C                     WRITEMM0028D0                                  059667
     C                     READ MM0028D0                 60               059667
     C/COPY WNCPYSRC,MM0028C068
     C                     CALL 'ZA0250'                                  059667
     C/COPY WNCPYSRC,MM0028C108
     C                     MOVE '0'       *IN50                           059667
     C                     MOVE '1'       *IN41                           059667
     C/COPY WNCPYSRC,MM0028C030
     C           *INKL     IFEQ '1'                                       059667
     C                     MOVE '0'       *INKL                           059667
     C*                                                                   059667
     C** If this subroutine was called via select processing              059667
     C** and F12 has been pressed in response to auth. prompt,            059667
     C** reset action code to 'E'.                                        059667
     C*                                                                   059667
     C           *IN35     IFEQ '1'                                       059667
     C                     MOVE 'E'       DDACTN                          059667
     C                     SETOF                     35                   059667
     C                     END                                            059667
     C*                                                                   059667
     C                     GOTO #ZG9                                      059667
     C                     END                                            059667
     C                     END                                            059667
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP32                                           S01408
     C*                                                                   S01408
     C*                                                                   059667
     C                     END                             E*2
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP33                                           S01408
     C*                                                                   S01408
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028C132
     C*
     C*  *-------------------------------------------------------------*  E18139
      *  *Enable user to input next deal details while files are being *  E18139
      *  *updated for deal just entered                                *  E18139
     C*  *-------------------------------------------------------------*  E18139
      *                                                                   E18139
      **  Blank screen fields                                             E18139
     C                     EXSR #ZE                                       E18139
      *                                                                   E18139
      **  Reset error processing                                          E18139
     C                     EXSR #ZA                                       E18139
      *                                                                   E18139
      **  Write input screen                                              E18139
     C*                                                                   E20031
     C*   Bypass if in range authorisation or if called through F15       E20031
     C* processing (@@@BPS = 'Y')                                         E20031
     C           @@@BPS    IFNE 'Y'                                       E20031
     C/COPY WNCPYSRC,MM0028C109
      *                                                                   E20031
      **  Retrieve time and place in screen field.                        E20031
     C                     TIME           DDTIME                          E20031
     C                     WRITEMM0028S0                                  E18139
     C                     WRITEMM0028D2                                  S01199
     C                     WRITEMM0028D0                                  E18139
     C/COPY WNCPYSRC,MM0028C110
      *                                                                   E18139
     C                     SETON                     57                   E18139
     C                     END                                            E20031
     C                     MOVE *BLANKS   @@@BPS  1                       E20031
      *                                                                   E18139
     C*  *--------------------------------------------------*
     C*  *  Update MM Data Base                             *
     C*  *--------------------------------------------------*
     C*
     C                     EXSR ZTNLU1
     C*
     C** Core hook for externalisation.                                   S01408
     C/COPY WNCPYSRC,MM0028CBDU                                           S01408
     C*
     C                     CALL 'MM0078'
     C                     PARM           @TERM   1
     C*********************PARM*'B'*******@FBOI***************************S01319
     C                     PARM 'A'       @THSDL  1
     C                     PARM           @STDDL
     C                     PARM           @STDDB
     C                     PARM           @STDDS
     C                     PARM           @STDDA
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C*                                                                   082738
     C           @TERM     IFEQ 'E'                        B1
     C                     ROLBK                           *1
     C                     MOVE '1'       *INKC            *1
     C                     GOTO #ZG9                       *1
     C                     END                             E1
     C*                                                                   E14354
     C**  Remove COMIT so that DRS-MIDAS updates done in same comit cycle E14354
     C***********                                                         E14354
     C****Commit the file updates.                                        E14354
     C***********CMTTXT    COMIT
     C*
     C*  *--------------------------------------------------*
     C*  *  Update Midas Data Base                          *
     C*  *--------------------------------------------------*
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB3                                           S01408
     C*                                                                   S01408
     C*********************CALL 'MM0082'                                  082738
     C                     CALL 'MM0083'                                  082738
     C                     PARM           @TERM
     C                     PARM 'A'       @THSDL  1                       S01319
     C                     PARM           @STDDL                          S01319
     C                     PARM           @STDDB                          S01319
     C                     PARM           @STDDS                          S01319
     C                     PARM           @STDDA                          S01319
     C                     PARM ' '       RACD    1                       AUS007
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C                     PARM *BLANKS   @@AURO  1                       082738
     C/COPY WNCPYSRC,MM0028CP51                                           S01408
     C*
     C           @TERM     IFEQ 'E'                        B1
     C                     ROLBK                           *1
     C                     MOVE '1'       *INKC            *1
     C                     GOTO #ZG9                       *1
     C                     END                             E1
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB4                                           S01408
     C*                                                                   S01408
     C*                                                                   S01354
     C*** FOR INTERNAL FUNDING DEALS - REPEAT UPDATE                      S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                       B1             S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  *  Set up Standard deal for Internal Funding Deal  *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C                     EXSR #ZT                        *1             S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  *  Update MM Data Base                             *             S01354
     C*  *--------------------------------------------------*             S01354
     C*
     C** Core hook for externalisation.                                   S01408
     C/COPY WNCPYSRC,MM0028CCBU                                           S01408
     C*                                                                   S01177
     C*                                                                   S01354
     C*                                                                   S01354
     C                     CALL 'MM0078'                   *1             S01354
     C                     PARM           @TERM   1                       S01354
     C                     PARM 'A'       @THSDL  1                       S01354
     C                     PARM           @STDDL                          S01354
     C                     PARM           @STDDB                          S01354
     C                     PARM           @STDDS                          S01354
     C                     PARM           @STDDA                          S01354
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C           @TERM     IFEQ 'E'                        B*2            S01354
     C                     ROLBK                           **2            S01354
     C                     MOVE '1'       *INKC            **2            S01354
     C                     GOTO #ZG9                       **2            S01354
     C                     END                             E*2            S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  *  Update Midas Data Base                          *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB3                                           S01408
     C*                                                                   S01408
     C*********************CALL 'MM0082'                   *1      S01354 082738
     C                     CALL 'MM0083'                                  082738
     C                     PARM           @TERM                           S01354
     C                     PARM 'A'       @THSDL  1                       S01354
     C                     PARM           @STDDL                          S01354
     C                     PARM           @STDDB                          S01354
     C                     PARM           @STDDS                          S01354
     C                     PARM           @STDDA                          S01354
     C                     PARM ' '       RACD    1                       AUS007
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C                     PARM *BLANKS   @@AURO                          082738
     C/COPY WNCPYSRC,MM0028CP52                                           S01408
     C*                                                                   S01354
     C           @TERM     IFEQ 'E'                        B*2            S01354
     C                     ROLBK                           **2            S01354
     C                     MOVE '1'       *INKC            **2            S01354
     C                     GOTO #ZG9                       **2            S01354
     C                     END                             E*2            S01354
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB4                                           S01408
     C*                                                                   S01408
     C*                                                                   S01354
     C                     END                             E1             S01354
     C*                                                                   S01354
     C**  Commit the file updates.
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCB1                                           S01408
     C*
     C           CMTTXT    COMIT
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCB2                                           S01408
     C*
     C*
     C*  *--------------------------------------------------*
     C*  * Set up successful file maintenance message       *
     C*  *--------------------------------------------------*
     C*
     C******               MOVE *BLANKS   @DATA                           E18139
     C******               MOVE DDVDAT    @ERVDT           *1             E18139
     C******               MOVEL@TXT,1    @DATA1           *1             E18139
     C******               MOVE @DMDTA    @DATA            *1             E18139
     C******                                                              E18139
     C**  If action code is A, record has been amended.                   E18139
     C******     DDACTN    IFEQ 'A'                        B1             E18139
     C******                                                              E18139
     C******               MOVEL'MMM1016' @MSGID           *1             E18139
     C******                                                              E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C**  If action code is D, record has been deleted.                   E18139
     C******     DDACTN    IFEQ 'D'                        B1             E18139
     C******                                                              E18139
     C******               MOVEL'MMM1017' @MSGID           *1             E18139
     C******                                                              E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C**  If action code is I, record has been inserted.                  E18139
     C******     DDACTN    IFEQ 'I'                        B1             E18139
     C******                                                              E18139
     C******               MOVEL'MMM1018' @MSGID           *1             E18139
     C******               MOVE @LSQN     DDDS38           *1             E18139
     C******                                                              E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C**  If action code is X, record has been authorized                 E18139
     C******     DDACTN    IFEQ 'X'                        B1             E18139
     C******                                                              E18139
     C******               MOVEL'MMM1027' @MSGID           *1             E18139
     C******                                                              E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C**  Blank screen fields.                                            E18139
     C******               EXSR #ZE                                       E18139
     C******                                                              E18139
     C**  Reset error processing.                                         E18139
     C******               EXSR #ZA                                       E18139
      *                                                                   E18139
      **  Blank standard deal fields                                      E18139
     C                     EXSR #ZEA                                      E18139
     C*                                                                   E18139
     C**  Send successful file maintenance message.                       E18139
     C******               CALL 'ZA0440'                                  E18139
     C******               PARM           @MSGID                          E18139
     C******               PARM           @DATA                           E18139
     C*
     C*
     C/COPY WNCPYSRC,MM0028C057
     C           #ZG9      ENDSR                           **#ZG9**
     C*****************************************************************
     C/COPY WNCPYSRC,MM0028CP23                                           S01408
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #BDAA    - Calls new record update routines.         *
     C*                                                               *
     C* CALLS    ZA0440   - Send message with data.                   *
     C*          #ZJ      - Set up Standard deal                      *
     C*          #ZT      - Set up Standard Deal for Linked Deal      *   S01354
     C*          ZA0250   - Clears message queue.                     *
     C*          MM0078   - Update MM database                        *
     C***********MM0082***-*Update midas data base                    *   082738
     C*          MM0083   - Update midas data base                    *   082738
     C*          ZA0250   - Clears message queue.                     *
     C*          #ZE      - clear screen                              *
     C*          #ZEA     - Clear standard deal                       *   E18139
     C*          #ZA      - Resets screen error indicators and msgq   *
     C*                                                               *
     C* CALLED BY  #BDA   - Enter processing for action code I.       *
     C*                                                               *
     C* FLDS USED  @DATA  - Data passed to ZA0440                     *
     C*            @MSGID - message id                                *
     C*            @DEAM  - Deam data structure                       *
     C*            @PDYY  - Validated value date                      *
     C*            @PDMM  -     "       "     "                       *
     C*            @PDDD  -     "       "     "                       *
     C*            @TERM  - Termination parameter                     *
     C*************@FBOI**-*Front*or*back*office*indicator*************   S01319
     C*            @THSDL - This deal type indicator                  *
     C*            @STDDL - Standard deal format : loans/deposits     *
     C*            @STDDB -   "       "     "    : N/A's bought       *
     C*            @STDDS -   "       "     "    : N/A's sold         *
     C*            @STDDA -   "       "     "    : DEAMS              *
     C*                                                               *
     C*****************************************************************
     C           #BDAA     BEGSR
     C*
     C** call for confirmation messages
     C                     MOVE *BLANKS   @DATA
     C                     MOVEL'insert'  @DATA
     C                     MOVEL'MMM1037' @MSGID
     C*
     C/COPY WNCPYSRC,MM0028C076
     C** If warning indicator is on do not clear warning messages.        E14379
     C           *IN55     IFEQ '0'                        B1             E14379
     C*****                CALL 'ZA0250'                          *****   S01177
     C                     CALL 'ZA0250'                   *1             S01177
     C                     END                             E1             E14379
     C                     CALL 'ZA0440'
     C                     PARM           @MSGID
     C                     PARM           @DATA
     C                     MOVE '1'       *IN50
     C*                                                               *
     C**  Set on last sequence no. present indicator.                     051307
     C*                                                                   051307
     C                     MOVE '1'       *IN40                           051307
     C*
     C                     WRITEMM0028S0
     C                     WRITEMM0028D2                                  S01199
     C                     WRITEMM0028D0
     C*********************READ MM0028S0                 60               S01199
     C                     READ MM0028D2                 60               S01199
     C/COPY WNCPYSRC,MM0028C004
     C                     CALL 'ZA0250'
     C/COPY WNCPYSRC,MM0028C058
     C                     MOVE '0'       *IN50
     C/COPY WNCPYSRC,MM0028C059
     C                     MOVE '0'       *IN35                           S01184
     C           *INKL     CABEQ'1'       #BDAA9
     C*
     C**  Clear the standard deal format.
     C**  First fill standard deal format data structure with blanks,
     C**  then zeroise numeric fields.
     C                     MOVE *BLANKS   @DEAM
     C                     Z-ADD0         HNDLUP
     C                     Z-ADD0         HNYLUP
     C                     Z-ADD0         HNTLUP
     C                     Z-ADD0         HNLCD
     C                     Z-ADD0         HNDA38
     C                     Z-ADD0         HNDS38
     C                     Z-ADD0         HNCYDP
     C                     Z-ADD0         HNVDYY
     C                     Z-ADD0         HNVDMM
     C                     Z-ADD0         HNVDDD
     C                     Z-ADD0         HNDTYY
     C                     Z-ADD0         HNDTMM
     C                     Z-ADD0         HNDTDD
     C                     Z-ADD0         HNDMDY
     C                     Z-ADD0         HNDMDM
     C                     Z-ADD0         HNDMDD
     C                     Z-ADD0         HNAMNP
     C                     Z-ADD0         HNINTR
     C                     Z-ADD0         HNFSRP                          CAC001
     C                     Z-ADD0         HNORCM
     C                     Z-ADD0         HNMOPM
     C**********           Z-ADD0         HNCNUM                                              CSD027
     C                     MOVE *BLANKS   HNCNUM                                              CSD027
     C                     Z-ADD0         HNPCTN
     C                     Z-ADD0         HNTIME
     C                     Z-ADD0         HNLDAT
     C                     Z-ADD0         HNRSTM                          S01177
     C**********           Z-ADD0         HNROBN                                       S01177 CSD027
     C**********           Z-ADD0         HNROCN                                       S01177 CSD027
     C                     MOVE *BLANKS   HNROBN                                              CSD027
     C                     MOVE *BLANKS   HNROCN                                              CSD027
     C                     Z-ADD0         HNPSTM                          S01177
     C**********           Z-ADD0         HNPOBN                                       S01177 CSD027
     C**********           Z-ADD0         HNPOCN                                       S01177 CSD027
     C                     MOVE *BLANKS   HNPOBN                                              CSD027
     C                     MOVE *BLANKS   HNPOCN                                              CSD027
     C*
     C**  Move '*' into the logical delete flag.
     C                     MOVE '*'       HNDLTF
     C*
     C/COPY WNCPYSRC,MM0028CP31                                           S01408
     C** insert the key fields
     C                     MOVE DDDLNO    HNDA38
     C                     MOVE DDDLNO    @DLKEY                          S01354
     C                     MOVE DDLSQN    HNDS38
     C*
     C** Load validated value date into deam
     C                     Z-ADD@PDYY     HNVDYY
     C                     Z-ADD@PDMM     HNVDMM
     C                     Z-ADD@PDDD     HNVDDD
     C                     MOVEASTAMP,1   HNTMST                                              CPK014
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP34                                           S01408
     C*                                                                   S01408
     C*
     C**  Write the new record to reserve one position in the file
     C**  ( * AND DEAL NUMBER ONLY *)
     C                     WRITEMMDEAMP3
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  * Check for update of Linked Internal Deal         *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                       B1             S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C*                                                                   S01354
     C                     MOVE H@DADN    HNDA38                          S01354
     C                     MOVE H@DADN    @DLKEY                          S01354
     C/COPY WNCPYSRC,MM0028C133
     C**  Write the new record to reserve one position in the file        S01354
     C**  ( * AND DEAL NUMBER ONLY *)                                     S01354
     C                     WRITEMMDEAMP3                                  S01354
     C                     MOVE DDDLNO    HNDA38                          S01354
     C                     END                             E1             S01354
     C/COPY WNCPYSRC,MM0028C069
     C*                                                                   S01354
     C*
     C*  *--------------------------------------------------*
     C*  *  Set up Standard deal for updates by MMOO78/MM0082  *
     C*  *-----------------------------------------------------*
     C*
     C                     EXSR #ZJ
     C*
     C*
     C*  *------------------------------------------------------*         E18139
      *  *  Enable user to input next deal details while files  *         E18139
      *  *  are being updated for deal just entered             *         E18139
     C*  *------------------------------------------------------*         E18139
      *                                                                   E18139
     C/COPY WNCPYSRC,MM0028C070
      **  Blank screen fields                                             E18139
     C                     EXSR #ZE                                       E18139
     C/COPY WNCPYSRC,MM0028C071
      *                                                                   E18139
      **  Reset error processing                                          E18139
     C                     EXSR #ZA                                       E18139
     C/COPY WNCPYSRC,MM0028C072
      *                                                                   E18139
      **  Write input screen                                              E18139
     C*   Bypass if in range authorisation or if called through F15       E20031
     C* processing (@@@BPS = 'Y')                                         E20031
     C           @@@BPS    IFNE 'Y'                                       E20031
     C/COPY WNCPYSRC,MM0028C111
      *                                                                   E20031
      **  Retrieve time and place in screen field.                        E20031
     C                     TIME           DDTIME                          E20031
     C                     WRITEMM0028S0                                  E18139
     C                     WRITEMM0028D2                                  S01199
     C                     WRITEMM0028D0                                  E18139
     C/COPY WNCPYSRC,MM0028C112
      *                                                                   E18139
     C                     SETON                     57                   E18139
     C/COPY WNCPYSRC,MM0028CP53                                           S01408
     C                     END                                            E20031
     C                     MOVE *BLANKS   @@@BPS                          E20031
      *                                                                   E18139
     C*  *--------------------------------------------------*
     C*  *  Update MM Data Base                             *
     C*  *--------------------------------------------------*
     C*
     C** Core hook for externalisation.                                   S01408
     C/COPY WNCPYSRC,MM0028CCBW                                           S01408
     C*                                                                   S01177
     C*
     C                     CALL 'MM0078'
     C                     PARM           @TERM
     C*********************PARM*'B'*******@FBOI***1***********************S01319
     C                     PARM 'A'       @THSDL
     C                     PARM           @STDDL
     C                     PARM           @STDDB
     C                     PARM           @STDDS
     C                     PARM           @STDDA
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C*                                                                   082738
     C           @TERM     IFEQ 'E'                        B1
     C                     ROLBK                           *1
     C                     MOVE '1'       *INKC            *1
     C                     GOTO #BDAA9                     *1
     C                     END                             E1
     C*
     C**  REMOVE COMIT SO THAT MIDAS/DRS UPDATED IN SAME COMIT CYCLE.     E17021
     C****Commit*the*file*updates.                                        E17021
     C******     CMTTXT    COMIT                                          E17021
     C*
     C*  *--------------------------------------------------*
     C*  *  Update Midas Data Base                          *
     C*  *--------------------------------------------------*
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB3                                           S01408
     C*                                                                   S01408
     C*********************CALL 'MM0082'                                  082738
     C                     CALL 'MM0083'                                  082738
     C                     PARM           @TERM
     C                     PARM 'A'       @THSDL                          S01319
     C                     PARM           @STDDL                          S01319
     C                     PARM           @STDDB                          S01319
     C                     PARM           @STDDS                          S01319
     C                     PARM           @STDDA                          S01319
     C                     PARM ' '       RACD    1                       AUS007
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C                     PARM *BLANKS   @@AURO                          082738
     C/COPY WNCPYSRC,MM0028CP54                                           S01408
     C*
     C           @TERM     IFEQ 'E'                        B1
     C                     ROLBK                           *1
     C                     MOVE '1'       *INKC            *1
     C                     GOTO #BDAA9                     *1
     C                     END                             E1
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB4                                           S01408
     C*                                                                   S01408
     C*                                                                   S01354
     C*** FOR INTERNAL FUNDING DEALS - REPEAT UPDATE                      S01354
     C*                                                                   S01354
     C           H@MTYP    IFEQ 'IL'                       B1             S01354
     C           H@MTYP    OREQ 'ID'                                      S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  *  Set up Standard deal for Internal Funding Deal  *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C                     EXSR #ZT                        *1             S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  *  Update MM Data Base                             *             S01354
     C*  *--------------------------------------------------*             S01354
     C*
     C** Core hook for externalisation.                                   S01408
     C/COPY WNCPYSRC,MM0028CBUW                                           S01408
     C*                                                                   S01177
     C*                                                                   S01354
     C                     CALL 'MM0078'                                  S01354
     C                     PARM           @TERM   1                       S01354
     C                     PARM 'A'       @THSDL  1                       S01354
     C                     PARM           @STDDL                          S01354
     C                     PARM           @STDDB                          S01354
     C                     PARM           @STDDS                          S01354
     C                     PARM           @STDDA                          S01354
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C*                                                                   082738
     C           @TERM     IFEQ 'E'                        B*2            S01354
     C                     ROLBK                           **2            S01354
     C                     MOVE '1'       *INKC            **2            S01354
     C                     GOTO #BDAA9                     **2            S01354
     C                     END                             E*2            S01354
     C*                                                                   S01354
     C*  *--------------------------------------------------*             S01354
     C*  *  Update Midas Data Base                          *             S01354
     C*  *--------------------------------------------------*             S01354
     C*                                                                   S01354
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB3                                           S01408
     C*                                                                   S01408
     C*********************CALL 'MM0082'                           S01354 082738
     C                     CALL 'MM0083'                                  082738
     C                     PARM           @TERM                           S01354
     C                     PARM 'A'       @THSDL  1                       S01354
     C                     PARM           @STDDL                          S01354
     C                     PARM           @STDDB                          S01354
     C                     PARM           @STDDS                          S01354
     C                     PARM           @STDDA                          S01354
     C                     PARM ' '       RACD    1                       AUS007
     C                     PARM           Z#BSTS                          082738
     C                     PARM           Z#ASTS                          082738
     C                     PARM           Z#WSTS                          082738
     C                     PARM *BLANKS   @@AURO                          082738
     C/COPY WNCPYSRC,MM0028CP55                                           S01408
     C*                                                                   S01354
     C           @TERM     IFEQ 'E'                        B*2            S01354
     C                     ROLBK                           **2            S01354
     C                     MOVE '1'       *INKC            **2            S01354
     C                     GOTO #BDAA9                     **2            S01354
     C                     END                             E*2            S01354
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CDB4                                           S01408
     C*                                                                   S01408
     C*                                                                   S01354
     C                     END                             E1             S01354
     C*                                                                   S01354
     C**  Commit the file updates.
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCB1                                           S01408
     C*
     C           CMTTXT    COMIT
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCB2                                           S01408
     C*
     C*
     C*  *--------------------------------------------------*
     C*  * Set up successful file insert message            *
     C*  *--------------------------------------------------*
     C*
     C******               MOVE *BLANKS   @DATA                           E18139
     C******               MOVE DDVDAT    @ERVDT           *1             E18139
     C******               MOVEL@TXT,1    @DATA1           *1             E18139
     C******               MOVE @LSQN     DDDS38           *1      E12314 E18139
     C******               MOVE @DMDTA    @DATA            *1             E18139
     C******               MOVEL'MMM1018' @MSGID                          E18139
     C************         MOVE @LSQN     DDDS38           *1      S01136 E12314
     C*
     C**  Blank screen fields.                                            E18139
     C******               EXSR #ZE                                       E18139
     C******                                                              E18139
     C**  Reset error processing.                                         E18139
     C******               EXSR #ZA                                       E18139
     C*                                                                   E18139
      **  Blank standard deal fields                                      E18139
     C                     EXSR #ZEA                                      E18139
      *                                                                   E18139
     C**  Set on last sequence no. present indicator.                     051307
     C***********          MOVE '1'       *IN40                           051307
     C*
     C**  Display screen with last sequence                               E18139
     C******               WRITEMM0028S0                                  E18139
     C******                                                              E18139
     C**  Send successful maintenance message to screen.                  E18139
     C******               CALL 'ZA0440'                                  E18139
     C******               PARM           @MSGID                          E18139
     C******               PARM           @DATA                           E18139
     C*
     C/COPY WNCPYSRC,MM0028C060
     C           #BDAA9    ENDSR                           **#BDAA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*      ZTNLU1   - locks and updates trans no data area          *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           ZTNLU1    BEGSR
     C*
     C**  Set up comit text
     C                     MOVE 'MM'      MDID
     C                     MOVEL'MM0028'  PGMN
     C                     MOVE DDWID     WSIDX
     C                     TIME           MTIME
     C                     MOVE DDACTN    ACTCDX
     C*
     C**  Increment transaction number of last update.
     C           *NAMVAR   DEFN MNATN     DNATN
     C           *LOCK     IN   DNATN
     C                     MOVE FNATN     NATN    50
     C                     MOVE FNATN     ZZWK05  50
     C                     ADD  1         ZZWK05
     C                     MOVE ZZWK05    FNATN
     C                     OUT  DNATN
     C*
     C           ZTNLU9    ENDSR                           **ZTNLU9**
     C*****************************************************************
     C/COPY WNCPYSRC,MM0028CP56                                           S01408
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #ZB      - Enter processing for action code D.       *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          #ZK      - Retrieves a record and displays it.       *
     C*          #ZF      - Move store to screen.                     *
     C*                                                               *
     C* CALLED BY  #BD    - enter processing                          *
     C*            #BFB   - F15  DELETE                               *   S01177
     C*                                                               *
     C* FLDS USED  @MSGID - message id                                *
     C*            @DLNO  - stored deal number                        *
     C*            @MTYP  - Stored deal type                          *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @INTR  - stored spread rate                        *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C******       @ORCM  - stored rec. settlement method             *   S01177
     C******       @MORI  - stored our rec. bank a/c debit            *   S01177
     C******       @MCPI  - stored c'party paying bank                *   S01177
     C******       @MFAO  - stored for a/c of                         *   S01177
     C******       @SPEC  - stored special instructions               *   S01177
     C*            @RSTM  - stored rcpt settlement method             *   S01177
     C*            @RONS  - stored rcpt our nostro                    *   S01177
     C*            @RIBN  - stored rcpt intermed bank no.             *   S01177
     C*            @RIBA  - stored rcpt intermed bank a/c line        *   S01177
     C*            @ROBN  - stored rcpt ordering bank no.             *   S01177
     C*            @ROCN  - stored rcpt ordering customer no.         *   S01177
     C*            @PSTM  - stored pay settlement method              *   S01177
     C*            @PONS  - stored pay our nostro                     *   S01177
     C*            @PIBN  - stored pay intermed bank no.              *   S01177
     C*            @PIBA  - stored pay intermed bank a/c line         *   S01177
     C*            @POBN  - stored pay ordering bank no.              *   S01177
     C*            @POCN  - stored pay ordering customer no.          *   S01177
     C*            @RCRN  - stored receiver correspondant no.         *   S01177
     C*            @RCRA  - stored receiver corr a/c line             *   S01177
     C*            @RVNO  - stored receiver no.                       *   S01177
     C*            @AWBN  - stored a/c with bank no.                  *   S01177
     C*            @AWBA  - stored a/c with bank a/c line             *   S01177
     C*            @BENN  - stored beneficiary no.                    *   S01177
     C*            @BENA  - stored beneficiary a/c line               *   S01177
     C*            @DTP1  - stored details of payment 1               *   S01177
     C*            @DTP2  - stored details of payment 2               *   S01177
     C*            @DTP3  - stored details of payment 3               *   S01177
     C*            @DTP4  - stored details of payment 4               *   S01177
     C*            @DCHG  - stored details of charges                 *   S01177
     C*            @BTB1  - stored bank to bank info 1                *   S01177
     C*            @BTB2  - stored bank to bank info 2                *   S01177
     C*            @BTB3  - stored bank to bank info 3                *   S01177
     C*            @BTB4  - stored bank to bank info 4                *   S01177
     C*            @BTB5  - stored bank to bank info 5                *   S01177
     C*            @BTB6  - stored bank to bank info 6                *   S01177
     C*            @CVMR  - cover MT202 required                      *   E22405
     C*            @LSQN  - last sequence no. of deam                 *
     C*                                                               *
     C*****************************************************************
     C           #ZB       BEGSR
     C/COPY WNCPYSRC,MM0028C005
     C*
     C**  If key work fields are not the same as screen fields, then
     C**  the record is not already being displayed.
     C           DDDLNO    IFNE @DLNO                      B1
     C           DDDLNO    OREQ *BLANKS                    *1
     C*
     C           @ACTN     ORNE DDACTN                     *1
     C           @ACTN     OREQ *BLANKS                    *1
     C*
     C           @VDAT     ORNE DDVDAT                     *1
     C           @VDAT     OREQ *BLANKS                    *1
     C*
     C           DDDS38    ORNE @DS38                      *1
     C           @DS38     OREQ *BLANKS                    *1
     C*
     C**  Chain to file and display on screen.
     C                     EXSR #ZK                        *1
     C*
     C                     ELSE                            X1
     C*
     C**  If the action code is not D, it is invalid.
     C           DDACTN    IFNE 'D'                        B*2
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP10                                           S01408
     C*                                                                   S01408
     C*
     C**  Set up error output for screen.
     C***                  MOVE '1'       *IN10            **2            S01177
     C                     MOVE '1'       *IN01            **2            S01177
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM1005' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*
     C**  Restore former field values.
     C                     EXSR #ZF                        **2
     C*
     C**  By-pass further Delete processing.
     C                     GOTO #ZB9                       **2
     C*
     C                     END                             E*2
     C*
     C**  Record was displayed last cycle: check that no amendments to
     C**  fields have been made.
     C           DDDLNO    IFNE @DLNO                      B1
     C           DDMTYP    ORNE @MTYP                      B1
     C           DDCSNM    ORNE @CSNM                      B1
     C           DDVDAT    ORNE @VDAT                      B1
     C           DDDS38    ORNE @DS38                      B1
     C           DDCCY     ORNE @CCY                       B1
     C           DDAMNP    ORNE @AMNP                      B1
     C           DDINTR    ORNE @INTR                      B1
     C           DDFSRP    ORNE @FSRP                                     CAC001
     C           DDLSQN    ORNE @LSQN                      B1
     C/COPY WNCPYSRC,MM0028CP57                                           S01408
     C*****      DDORCM    ORNE @ORCM                      B1             S01177
     C*****      DDMORI    ORNE @MORI                      B1             S01177
     C*****      DDMCPI    ORNE @MCPI                      B1             S01177
     C*****      DDMFAO    ORNE @MFAO                      B1             S01177
     C*****      DDSPEC    ORNE @SPEC                      B1             S01177
     C*                                                                   S01177
     C** also check second screen parms                                   S01177
     C           PMRSTM    ORNE @RSTM                      **2            S01177
     C           PMRONS    ORNE @RONS                      **2            S01177
     C           PARIBN    ORNE @RIBN                      **2            S01177
     C           PMRIBA    ORNE @RIBA                      **2            S01177
     C           PAROBN    ORNE @ROBN                      **2            S01177
     C           PAROCN    ORNE @ROCN                      **2            S01177
     C           PMPSTM    ORNE @PSTM                      **2            S01177
     C           PMPONS    ORNE @PONS                      **2            S01177
     C           PAPIBN    ORNE @PIBN                      **2            S01177
     C           PMPIBA    ORNE @PIBA                      **2            S01177
     C           PAPOBN    ORNE @POBN                      **2            S01177
     C           PAPOCN    ORNE @POCN                      **2            S01177
     C           PARCRN    ORNE @RCRN                      **2            S01177
     C           PMRCRA    ORNE @RCRA                      **2            S01177
     C           PARVNO    ORNE @RVNO                      **2            S01177
     C           PAAWBN    ORNE @AWBN                      **2            S01177
     C           PMAWBA    ORNE @AWBA                      **2            S01177
     C           PABENN    ORNE @BENN                      **2            S01177
     C           PMBENA    ORNE @BENA                      **2            S01177
     C           PMDTP1    ORNE @DTP1                      **2            S01177
     C           PMDTP2    ORNE @DTP2                      **2            S01177
     C           PMDTP3    ORNE @DTP3                      **2            S01177
     C           PMDTP4    ORNE @DTP4                      **2            S01177
     C           PMDCHG    ORNE @DCHG                      **2            S01177
     C           PMBTB1    ORNE @BTB1                      **2            S01177
     C           PMBTB2    ORNE @BTB2                      **2            S01177
     C           PMBTB3    ORNE @BTB3                      **2            S01177
     C           PMBTB4    ORNE @BTB4                      **2            S01177
     C           PMBTB5    ORNE @BTB5                      **2            S01177
     C           PMBTB6    ORNE @BTB6                      **2            S01177
     C           PMCVMR    ORNE @CVMR                      **2            E22405
     C           PMROBR    ORNE @ROBR                      **2            LN0822
     C           PMPOBR    ORNE @POBR                      **2            LN0822
     C           PMRSCY    ORNE @RSCY                                     CEU003
     C           PMPSCY    ORNE @PSCY                                     CEU003
     C           PMIC72    ORNE @IC72                                     CEU003
     C*
     C** set up error output
     C                     MOVE '1'       *IN01            **2
     C                     MOVE '1'       *IN41            **2
     C                     MOVEL'MMM1004' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*
     C** restore field values
     C                     EXSR #ZF                        **2
     C*
     C                     GOTO #ZB9                       **2
     C*
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C**  The entry must now be valid, enable the F10 processing.
     C/COPY WNCPYSRC,MM0028C073
     C                     MOVE '1'       *IN42
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CPCA                                           S01408
     C*
     C           #ZB9      ENDSR                           **#ZB9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*            #ZM    - F10  processing.                          *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          #ZF      - Move store to screen.                     *
     C*          #ZG      - Calls update routines.                    *
     C*                                                               *
     C* CALLED BY  #B     - Main processing                           *
     C*            #BFC   - F 15 delete                               *
     C*                                                               *
     C* FLDS USED  @MSGID - message id                                *
     C*            @CSNM  - stored customer                           *
     C*            @MTYP  - Stored deal type                          *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @DLNO  - stored deal number                        *
     C*            @MTYP  - Stored deal type                          *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Deam sequence no.                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @INTR  - stored spread rate                        *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C******       @ORCM  - stored rec. settlement method             *   S01177
     C******       @MORI  - stored our rec. bank a/c debit            *   S01177
     C******       @MCPI  - stored c'party paying bank                *   S01177
     C******       @MFAO  - stored for a/c of                         *   S01177
     C******       @SPEC  - stored special instructions               *   S01177
     C*            @RSTM  - stored rcpt settlement method             *   S01177
     C*            @RONS  - stored rcpt our nostro                    *   S01177
     C*            @RIBN  - stored rcpt intermed bank no.             *   S01177
     C*            @RIBA  - stored rcpt intermed bank a/c line        *   S01177
     C*            @ROBN  - stored rcpt ordering bank no.             *   S01177
     C*            @ROCN  - stored rcpt ordering customer no.         *   S01177
     C*            @PSTM  - stored pay settlement method              *   S01177
     C*            @PONS  - stored pay our nostro                     *   S01177
     C*            @PIBN  - stored pay intermed bank no.              *   S01177
     C*            @PIBA  - stored pay intermed bank a/c line         *   S01177
     C*            @POBN  - stored pay ordering bank no.              *   S01177
     C*            @POCN  - stored pay ordering customer no.          *   S01177
     C*            @RCRN  - stored receiver correspondant no.         *   S01177
     C*            @RCRA  - stored receiver corr a/c line             *   S01177
     C*            @RVNO  - stored receiver no.                       *   S01177
     C*            @AWBN  - stored a/c with bank no.                  *   S01177
     C*            @AWBA  - stored a/c with bank a/c line             *   S01177
     C*            @BENN  - stored beneficiary no.                    *   S01177
     C*            @BENA  - stored beneficiary a/c line               *   S01177
     C*            @DTP1  - stored details of payment 1               *   S01177
     C*            @DTP2  - stored details of payment 2               *   S01177
     C*            @DTP3  - stored details of payment 3               *   S01177
     C*            @DTP4  - stored details of payment 4               *   S01177
     C*            @DCHG  - stored details of charges                 *   S01177
     C*            @BTB1  - stored bank to bank info 1                *   S01177
     C*            @BTB2  - stored bank to bank info 2                *   S01177
     C*            @BTB3  - stored bank to bank info 3                *   S01177
     C*            @BTB4  - stored bank to bank info 4                *   S01177
     C*            @BTB5  - stored bank to bank info 5                *   S01177
     C*            @BTB6  - stored bank to bank info 6                *   S01177
     C*            @CVMR  - cover MT202 required                      *   E22405
     C*            @CSNM  - stored customer                           *
     C*            @TERM  -  Termination parameter                    *
     C*                                                               *
     C*****************************************************************
     C           #ZM       BEGSR
     C/COPY WNCPYSRC,MM0028C061
     C*
     C**  If the action code is not D, it is invalid.
     C           DDACTN    IFNE 'D'                        B1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP10                                           S01408
     C*                                                                   S01408
     C*
     C**  Set up error output for screen.
     C***                  MOVE '1'       *IN10            *1             S01177
     C                     MOVE '1'       *IN01            *1             S01177
     C                     MOVEL'MMM1005' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C*
     C**  Restore former field values.
     C                     EXSR #ZF                        *1
     C*
     C**  By-pass further F10 processing.
     C                     GOTO #ZM9                       *1
     C*
     C                     END                             E1
     C*
     C**  If any other fields have changed since the record was
     C**  displayed, delete processing is invalid.
     C           DDACTN    IFNE 'D'                        B1
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP10                                           S01408
     C*                                                                   S01408
     C           DDDLNO    ORNE @DLNO                      B1
     C           DDMTYP    ORNE @MTYP                      B1
     C           DDCSNM    ORNE @CSNM                      B1
     C           DDVDAT    ORNE @VDAT                      B1
     C           DDDS38    ORNE @DS38                      B1
     C           DDCCY     ORNE @CCY                       B1
     C           DDAMNP    ORNE @AMNP                      B1
     C           DDINTR    ORNE @INTR                      B1
     C           DDFSRP    ORNE @FSRP                                     CAC001
     C           DDLSQN    ORNE @LSQN                      B1
     C/COPY WNCPYSRC,MM0028CP58                                           S01408
     C*****      DDORCM    ORNE @ORCM                      B1             S01177
     C*****      DDMORI    ORNE @MORI                      B1             S01177
     C*****      DDMCPI    ORNE @MCPI                      B1             S01177
     C*****      DDMFAO    ORNE @MFAO                      B1             S01177
     C*****      DDSPEC    ORNE @SPEC                      B1             S01177
     C*
     C** also check second screen parms                                   S01177
     C           PMRSTM    ORNE @RSTM                      B1             S01177
     C           PMRONS    ORNE @RONS                      B1             S01177
     C           PARIBN    ORNE @RIBN                      B1             S01177
     C           PMRIBA    ORNE @RIBA                      B1             S01177
     C           PAROBN    ORNE @ROBN                      B1             S01177
     C           PAROCN    ORNE @ROCN                      B1             S01177
     C           PMPSTM    ORNE @PSTM                      B1             S01177
     C           PMPONS    ORNE @PONS                      B1             S01177
     C           PAPIBN    ORNE @PIBN                      B1             S01177
     C           PMPIBA    ORNE @PIBA                      B1             S01177
     C           PAPOBN    ORNE @POBN                      B1             S01177
     C           PAPOCN    ORNE @POCN                      B1             S01177
     C           PARCRN    ORNE @RCRN                      B1             S01177
     C           PMRCRA    ORNE @RCRA                      B1             S01177
     C           PARVNO    ORNE @RVNO                      B1             S01177
     C           PAAWBN    ORNE @AWBN                      B1             S01177
     C           PMAWBA    ORNE @AWBA                      B1             S01177
     C           PABENN    ORNE @BENN                      B1             S01177
     C           PMBENA    ORNE @BENA                      B1             S01177
     C           PMDTP1    ORNE @DTP1                      B1             S01177
     C           PMDTP2    ORNE @DTP2                      B1             S01177
     C           PMDTP3    ORNE @DTP3                      B1             S01177
     C           PMDTP4    ORNE @DTP4                      B1             S01177
     C           PMDCHG    ORNE @DCHG                      B1             S01177
     C           PMBTB1    ORNE @BTB1                      B1             S01177
     C           PMBTB2    ORNE @BTB2                      B1             S01177
     C           PMBTB3    ORNE @BTB3                      B1             S01177
     C           PMBTB4    ORNE @BTB4                      B1             S01177
     C           PMBTB5    ORNE @BTB5                      B1             S01177
     C           PMBTB6    ORNE @BTB6                      B1             S01177
     C           PMCVMR    ORNE @CVMR                      B1             E22405
     C           PMROBR    ORNE @ROBR                      B1             LN0822
     C           PMPOBR    ORNE @POBR                      B1             LN0822
     C           PMRSCY    ORNE @RSCY                                     CEU003
     C           PMPSCY    ORNE @PSCY                                     CEU003
     C           PMIC72    ORNE @IC72                                     CEU003
     C*
     C**  Set up error output for screen.
     C***                  MOVE '1'       *IN10            *1             S01177
     C                     MOVE '1'       *IN01            *1             S01177
     C*
     C**  Set up error output for screen.
     C***                  MOVE '1'       *IN10            *1             S01177
     C                     MOVE '1'       *IN01            *1             S01177
     C                     MOVEL'MMM1004' @MSGID           *1
     C                     CALL 'ZA0240'                   *1
     C                     PARM           @MSGID           *1
     C*
     C**  Restore former field values.
     C                     EXSR #ZF                        *1
     C*
     C**  Reset indicator allowing F10 processing.
     C                     MOVE '0'       *IN42            *1
     C*
     C**  By-pass further F10 processing.
     C                     GOTO #ZM9                       *1
     C*
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028C113
     C*
     C*
     C**  F10 processing must now be valid, update file.
     C                     EXSR #ZG
     C*
     C           #ZM9      ENDSR                           **#ZM9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*            #BF    - F15  processing.                          *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          #ZR      - Check that key fields are valid numeric   *
     C*          #ZA      - Resets screen error indicators and msgq   *
     C*          ZA0770   - Convert date YYYYMMDD to DDMMYY format    *
     C*          #ZK      - Retrieves a record and displays it.       *
     C*          #ZL      - Displays, reads and resets screen.        *
     C*          #ZO      - Validate deal number and action code      *
     C*          #BFA     - F15 processing amend.                     *
     C*          #BFB     - F15 processing delete.                    *
     C*          #BFC     - F15 authorize                             *
     C*          #ZE      - clear screen                              *
     C*          #ZEA     - Clear standard deal                       *   E18139
      *          #FEED    - Extract feedback information when         *   S01184
      *                     CONFIRMATION MATCHING module present      *   S01184
     C*                                                               *
     C* CALLED BY  #B     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @LIST  - Action code text                          *
     C*            @RRN   - Subfile relative record no.               *
     C*            @MSGID - message id                                *
     C*            @DMKEY - Key to deams file                         *
     C*            @COUNT - Count of records written to subfile page  *
     C*            @YEAR  - Format date to YYYYMMDD : year            *
     C*            @MNTH  - Format date to YYYYMMDD : month           *
     C*            @DATE  - YYYYMMDD date for separation              *
     C*            @@DTIN - Input date to ZA0770                      *
     C*            @@DTOU - Output date to ZA0770                     *
     C*            @@AMTW - AMOUNT  input to ZA0920                   *
     C*            @@QECN - DECIMAL NO. (ZA0920)                      *
     C*            @@AMTD - AMOUNT WITH DECIMAL FORMAT output (ZA0920)*
     C*                                                               *
     C*****************************************************************
     C           #BF       BEGSR
      *                                                                   S01117
      ** Must first check user is authorised to action code 'E' if        S01117
      ** @MBIN 'N'. (Even if action code is 'X' use 'E' b'cos CF15 is     S01117
      ** an enquiry.) Note @MBIN 'Y' checking done later in subroutine    S01117
     C           @MBIN     IFEQ 'N'                        B1             S01117
      *                                                                   S01117
     C                     CALL 'ZVACTU'                   *1             S01117
     C                     PARM 'E'       ZACTN            *1             S01117
     C                     PARM           ERR              *1             S01117
      *                                                                   S01117
     C           ERR       IFEQ 1                          B*2            S01117
     C                     MOVE '1'       *IN01            **2            S01117
     C                     MOVE '1'       *IN41            **2            S01117
     C                     MOVEL'FXM0292' @MSGID           **2            S01117
     C                     CALL 'ZA0240'                   **2            S01117
     C                     PARM           @MSGID           **2            S01117
     C                     GOTO #BF9                       **2            S01117
     C                     END                             E*2            S01117
      *                                                                   S01117
     C                     END                             E1             S01117
     C*
     C**  Clear "F10-CONFIRM" prompt if displayed before F15 pressed      S01177
     C                     MOVE '0'       *IN42                           S01177
     C*                                                                   S01184
     C**  Clear indicator which governs display of FEEDBACK on screen 1   S01184
     C**  on INSERTS                                                      S01184
     C                     MOVE '0'       *IN35                           S01184
     C*
     C**  Disable CMD/14 to prevent call to settlement screen             S01177
     C                     SETOF                     76                   S01177
     C*                                                                   S01177
     C**  Validate that key fields are numeric or blank.
     C                     EXSR #ZR
     C*
     C** If an error has been found exit routine
     C           *IN41     CABEQ'1'       #BF9
     C*
     C**  Initialisation for subfile processing.
     C*
     C**  Set on indicator to show that select processing is occurring.
     C                     MOVE '1'       *IN45
     C*
     C**  Initialise indicator showing end of selected records.
     C                     MOVE '0'       *IN58
     C*
     C**  Set up Action Code text for screen for select processing.
     C                     MOVE DDLIST    @LIST  11
     C                     MOVEL'( '      DDLIST
     C*
     C**  Initialise program field for subfile relative record number.
     C                     Z-ADD0         @RRN    50
     C*
     C**  Initialise screen and write main screen without displaying
     C**  to clear msgq.
     C                     EXSR #ZA
     C/COPY WNCPYSRC,MM0028C114
     C                     MOVE '1'       *IN47
     C                     WRITEMM0028S0
     C                     MOVE '0'       *IN47
     C*
     C**  Clear subfile before refilling by writing control record
     C**  with SFLCLR active.
     C                     MOVE '1'       *IN46
     C                     WRITEMM0028S2
     C                     MOVE '0'       *IN46
     C*
     C**  Write the select screen footer to the screen.
     C                     WRITEMM0028D1
     C*
     C**  Set on ROLLUP indicator to cause initial loop operation.
     C                     MOVE '1'       *IN51
     C/COPY WNCPYSRC,MM0028C115
     C*
     C**  Reset *IN70.
     C                     MOVE '0'       *IN70
     C*
     C**  Set file pointer on key displayed on screen.
     C           DDACTN    IFEQ 'X'                        B1
     C           @DMKEY    SETLLMMDEAMP0                   *1
     C                     ELSE                            X1
     C           @DMKEY    SETLLMMCARMLL                   *1
     C                     END                             E1
     C*
     C**  Reset *IN70.
     C                     MOVE '0'       *IN70
     C*
     C**  Read the file initially - if *IN70 is set on then the end of
     C**  the file has been reached.  Read until a valid record is
     C**  found or until no more records exist.
     C           *IN70     DOUEQ'1'                        B1
     C           HNDLTF    OREQ ' '                        *1
     C*
     C**  Read the file.
     C           DDACTN    IFEQ 'X'                        B*2
     C                     READ MMCMPLLL                 70**2
     C                     ELSE                            X*2
     C                     READ MMCARMLL                 70**2
     C                     END                             E*2
     C*
     C**  If *IN70 is on no more records exist - set up an error message.
     C           *IN70     IFEQ '1'                        B*2
     C*
     C                     MOVEL'MMM1007' @MSGID           **2
     C                     CALL 'ZA0240'                   **2
     C                     PARM           @MSGID           **2
     C*
     C*
     C**  Set file pointer on key displayed on screen.
     C           DDACTN    IFEQ 'X'                        B**3
     C           @DMKEY    SETLLMMDEAMP0                   ***3
     C                     ELSE                            X**3
     C           @DMKEY    SETLLMMCARMLL                   ***3
     C                     END                             E**3
     C*
     C**  Bypass further record handling for select processing.
     C                     GOTO #BF8                       **2
     C*
      *                                                                   S01117
     C                     ELSE                            X*2            S01117
      ** if system is multibranched check branch/user authorities         S01117
      ** for each deal which may be displayed                             S01117
      ** Must also check for user authority to branch in mb system        S01117
     C           @MBIN     IFEQ 'Y'                        B**3           S01117
      *                                                                   S01117
      ** check booking branch, always use action code of 'E'              S01117
     C                     CALL 'ZVACTBU'                  ***3           S01117
     C                     PARM 'E'       ZACTN            ***3           S01117
     C                     PARM           H@BRCA           ***3           S01117
     C                     PARM           ERR              ***3           S01117
     C                     END                             E**3           S01117
     C                     END                             E*2
     C*
     C/COPY WNCPYSRC,MM0028C077
     C                     END                             E1
     C*
     C**  Processing for the Select Screen itself.
     C*
     C**  Read records from the file into the subfile until a page has
     C**  been filled or there are no more records.
     C**   Repeat the process until either the end of file, ROLLUP
     C**  has not been entered or F3 or F12 is input.
     C           *IN70     DOWNE'1'                        B1
     C           *IN51     ANDEQ'1'                        X1
     C*
     C**  Initialise program field for counting records written to
     C**  subfile page.
     C                     Z-ADD0         @COUNT  30       *1
     C*
     C**  For each record read, write a record to the screen subfile.
     C**  do this until - End of file. *IN70.
     C**                - The subfile page has been filled.
     C           *IN70     DOWNE'1'                        B*2
     C           @COUNT    ANDLT14                         X*2
     C*
     C**  Increment the relative record no. and records written fields.
     C                     ADD  1         @RRN             **2
     C                     ADD  1         @COUNT           **2
     C*
     C**  Set up the subfile fields.
     C                     MOVE *BLANK    DDOPT            **2
     C                     Z-ADD@RRN      DDSFRN           **2
     C*
     C                     MOVE HNDA38    DDDLNO           **2
     C                     MOVE HNMTYP    DDMTYP           **2
     C                     MOVE HNCCY     DDCCY            **2
     C*
     C** set up value date
     C                     Z-ADDHNVDYY    @YEAR            **2
     C                     Z-ADDHNVDMM    @MNTH            **2
     C                     Z-ADDHNVDDD    @DAY             **2
     C                     Z-ADD@DATE     @@DTIN           **2
     C                     EXSR ZA0770                     **2
     C                     MOVE @@DTOU    DDVDAT           **2
     C*
     C**  Account Sequnce Number.
     C           HNDS38    IFEQ 0                          B**3
     C                     MOVE *BLANKS   DDDS38           ***3
     C                     ELSE                            X**3
     C                     MOVE HNDS38    DDDS38           ***3
     C                     END                             E**3
     C*
     C**  Interest Rate/spread.
     C*
     C**  Interest Rate.
     C**  - Execute ZA0920 to format the rate, using 8 decimal places
     C**    and adjusting the file figure to have only implied decimal
     C**    places.
     C           HNINTR    IFEQ 0                          B**3
     C                     MOVE *BLANKS   DDINTR           ***3
     C                     ELSE                            X**3
     C           HNINTR    MULT 10000000  @@AMTW           ***3
     C                     Z-ADD7         @@QECN           ***3
     C*
     C**  Reverse sign for display if amount -ve.
     C           @@AMTW    IFLT 0                          B*2
     C                     Z-SUB@@AMTW    @@AMTW           **2
     C                     END                             E*2
     C*
     C                     EXSR ZA0920                     ***3
     C                     MOVE @@AMTD    DDINTR           ***3
     C                     END                             E**3
     C*
     C**  Deal Amount.
     C**  - Execute ZA0920 to format Deal Amount, using Deal Ccy
     C**    decimal places.
     C           HNAMNP    IFEQ 0                          B**3
     C                     MOVE *BLANKS   DDAMNP           ***3
     C                     ELSE                            X**3
     C                     Z-ADDHNCYDP    @@QECN           ***3
     C*
     C**  Reverse sign for display if amount -ve.
     C           HNAMNP    IFGT 0                          B*2
     C                     Z-ADDHNAMNP    @@AMTW           **2
     C                     ELSE                            X*2
     C                     Z-SUBHNAMNP    @@AMTW           **2
     C                     END                             E*2
     C*
     C                     EXSR ZA0920                     ***3
     C                     MOVE *BLANKS   DDAMNP           ***3           054017
     C                     MOVE @@AMTD    DDAMNP           ***3
     C                     END                             E**3
     C*
     C** move deal status
     C                     MOVE HNDSTS    DDSTAT           **2
     C*
     C** if the deal has been deleted then set on *in39
     C           HNDDLT    IFEQ 'D'                        B**3
     C                     MOVE '1'       *IN39            ***3
     C*********************MOVE 'DELETED' DDTEXT                    S01184S01304
     C                     MOVEL'ZZGBMSGF'MSGNM                           S01304
     C***********          MOVEL'ZZM1607' MSGDNB                    S01304S01314
     C                     MOVEL'ZZM1614' MSGDNB                          S01314
     C                     CALL 'SDRTVTXT'                                S01304
     C                     PARM           MSGDNB  7                       S01304
     C                     PARM           MSGNM  10                       S01304
     C                     PARM           MSGTXT 80                       S01304
     C                     MOVELMSGTXT    DDTEXT                          S01304
     C                     MOVE DDTEXT    @TEXT                           S01184
     C                     ELSE                            X**3
     C                     MOVE '0'       *IN39            ***3
     C                     MOVE *BLANKS   DDTEXT                          S01184
     C                     MOVE *BLANKS   @TEXT                           S01184
      *                                                                   S01184
      ** if CONFIRMATION MATCHING present get match status feedback       S01184
     C           BGCFMT    IFEQ 'Y'                                       S01184
     C                     EXSR #FEED                                     S01184
     C                     END                                            S01184
     C                     END                             E**3
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP19                                           S01408
     C*                                                                   S01408
     C*
     C**  Write the record to the subfile.
     C                     WRITEMM0028S3                   **2
     C/COPY WNCPYSRC,MM0028C116
     C*
     C**  Until a valid record is found or until no more records exist
     C**  on the file.
     C           *IN70     DOUEQ'1'                        B**3
     C           HNDLTF    OREQ ' '                        ***3
     C           ERR       ANDEQ*ZERO                      ***3           S01117
     C*
     C**  Read the file.
     C           DDACTN    IFEQ 'X'                        B***4
     C                     READ MMCMPLLL                 70****4
     C                     ELSE                            X***4
     C                     READ MMCARMLL                 70****4
     C                     END                             E***4
     C*
      ** if system is multibranched check branch/user authorities         S01117
      ** for each deal which may be displayed                             S01117
      ** Must also check for user authority to branch in mb system        S01117
     C**                                                                  LN0356
     C*  Access file for deal associated  branch code for validation      LN0356
     C           HNDA38    CHAINMMDEALLL             65                   LN0356
     C*                                                                   LN0356
     C*                                                                   LN0356
     C           @MBIN     IFEQ 'Y'                        B***4          S01117
      *                                                                   S01117
      ** check booking branch, always use action code of 'E'              S01117
     C                     CALL 'ZVACTBU'                  ****4          S01117
     C                     PARM 'E'       ZACTN            ****4          S01117
     C                     PARM           H@BRCA           ****4          S01117
     C                     PARM           ERR              ****4          S01117
     C                     END                             E***4          S01117
     C/COPY WNCPYSRC,MM0028C078
     C                     END                             E**3
     C*
     C                     END                             E*2
     C*
     C**  Retrieve time and place in screen field.
     C                     TIME           DDTIME           *1
     C*                                                                   S01184
     C** if CONFIRMATION MATCHING present SET ON *IN31                    S01184
     C           BGCFMT    IFEQ 'Y'                                       S01184
     C                     MOVE '1'       *IN31                           S01184
     C                     END                                            S01184
     C*
     C**  Write the subfile control record to the screen to display
     C**  the subfile.
     C/COPY WNCPYSRC,MM0028C117
     C                     WRITEMM0028S2                   *1
     C*
     C**  Read the subfile control record to determine which records
     C**  have been selected and whether ROLLUP is required.
     C                     READ MM0028S2                 60*1
     C*
     C**  If F3 has been pressed, bypass further select processing.
     C           *INKC     CABEQ'1'       #BF9             *1
     C*
     C**  If F12 has been pressed, go to select processing termination.
     C*****      *INKB     CABEQ'1'       #BF8             *1             S01177
     C           *INKL     CABEQ'1'       #BF8             *1             S01177
     C/COPY WNCPYSRC,MM0028C118
     C*
     C                     END                             E1
     C*
     C**  Processing for selected records.
     C*
     C**  Each selected record, is displayed and allowed to be amended
     C**  or deleted.
     C           *IN58     DOWNE'1'                        B1
     C*
     C**  Read the subfile for changed records - these are those that
     C**  have been selected.
     C**  Only process those for which the option field is blank.
     C           *IN58     DOUEQ'1'                        B*2
     C           DDOPT     ORNE *BLANK                     **2
     C*
     C                     READCMM0028S3                 58**2
     C*
     C                     END                             E*2
     C*
     C**  If *IN58 is not on then changed records exist.
     C           *IN58     IFEQ '0'                        B*2
      *                                                                   136653
      **  Move DDACTN to @@ACTN. Introduced new field @@ACTN to save      136653
      **  previous DDACTN when it is 'X'.                                 136653
      *                                                                   136653
     C           DDACTN    IFEQ 'X'                                       136653
     C                     MOVE DDACTN    @@ACTN  1                       136653
     C                     END                                            136653
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CLD1                                           S01408
     C*
     C**  Move Action code E into screen field.
     C           DDACTN    IFNE 'X'                        B**3
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP7                                           S01408
     C*                                                                   S01408
      *                                                                   136653
      **  Before moving 'E' to screen field, check @@ACTN if 'X'.         136653
      **  If yes, move 'X' to DDACTN. If no, move 'E' to DDACTN.          136653
      *                                                                   136653
     C           @@ACTN    IFEQ 'X'                                       136653
     C                     MOVE 'X'       DDACTN                          136653
     C                     ELSE                                           136653
     C                     MOVE 'E'       DDACTN           ***3
     C                     END                                            136653
     C                     END                             E**3
     C*
     C* Set on indicator to show that #ZD (from within #ZK) called        S01184
     C* by F15 processing (for use by SR #FEED which is called by #ZD)    S01184
     C                     MOVE '1'       *IN19                           S01184
     C*                                                                   S01184
     C**  Move the subfile screen fields into program work fields.
     C**  & display screen.
     C                     EXSR #ZK                        **2
     C*                                                                   S01177
     C*     if user has changed the ACTION CODE and pressed ENTER         S01177
     C*     during 'X' or 'A' or 'D' processing then re-validate the      S01177
     C*     action code and process again (when action code changed       S01177
     C*     in #BFA, #BFB or #BFC control is returned to the start        S01177
     C*     of this loop)                                                 S01177
     C*                                                                   S01177
     C           *IN14     DOUEQ'0'                                       S01177
     C*                                                                   S01177
     C*     if F12 pressed on screen 2 redisplay deal (AMEND,AUTH)        S01177
     C           *IN13     DOUEQ'0'                                       S01177
     C                     SETOF                     13                   S01177
     C**  Process this loop until a valid action code has been entered.
     C***        *IN10     DOUEQ'0'                        B**3           S01177
     C           *IN01     DOUEQ'0'                        B**3           S01177
     C           *IN41     ANDEQ'0'                        ***3
     C*
     C**  Ensure that screen 1 is displayed at least once in loop         S01177
     C                     SETON                     12                   S01177
     C*                                                                   S01177
     C**  Allow switching between screen 1 and screen 2                   S01177
     C           *IN12     DOWEQ'1'                                       S01177
     C                     SETOF                     12                   S01177
     C*                                                                   S01177
     C**  Process the screen.
     C*                                                                   S01177
     C**  no need to re-display screen when action code changed and       S01177
     C**  ENTER pressed in #BFA, #BFB or #BFC                             S01177
     C           *IN14     IFNE '1'                                       S01177
     C           *IN41     OREQ '1'                                       E20829
     C                     EXSR #ZL                        ***3
     C                     END                                            S01177
     C*
     C**  If F3 is input exit main processing immediately.
     C           *INKC     CABEQ'1'       #BF9             ***3
     C*
     C****If F12 is input go to select processing termination.    *****   S01177
     C**  If F12  (from screen 1) go to select processing                 S01177
     C**  termination.                                                    S01177
     C           *INKL     CABEQ'1'       #BF8             ***3
     C*                                                                   S01177
     C**  If F14 is input display settlement screen (unless we            S01177
     C**  have just returned from screen 2 having changed action code     S01177
     C**  and pressed F14 in #BFA,#BFB or #BFC)                           S01177
     C           *IN14     IFNE '1'                        B****5         S01177
     C           *INKN     IFEQ '1'                        B*****6        S01177
     C                     EXSR #BG                        ******6        S01177
     C           *INKC     CABEQ'1'       #BF9             ******6        S01177
     C*   F12 taken from screen 2                                      ng S01177
     C           *INKL     COMP '1'                      12               S01177
     C                     MOVE '0'       *INKL                           S01177
     C                     ELSE                                           S01177
     C*   ENTER: allow next selected deal to be displayed              ng S01177
     C                     SETOF                     12                   S01177
     C                     END                                            S01177
     C                     END                                            S01177
     C                     END                             E***4          S01177
     C*
     C* ENTER pressed                                                     S01177
     C*
     C**  Process screen input - depending upon input type.
     C*
     C**  If DDACTN is not A,D,E, it is invalid for select proc.
     C           DDACTN    IFNE 'A'                        B***4
     C           DDACTN    ANDNE'D'                        ****4
     C           DDACTN    ANDNE'E'                        ****4
     C           DDACTN    ANDNE'X'                        ****4
     C*
     C**  Set up error output for screen.
     C                     MOVE '1'       *IN01            ****4
     C                     MOVE '1'       *IN41            ****4          E20829
     C                     MOVEL'MMM1001' @MSGID           ****4
     C                     CALL 'ZA0240'                   ****4
     C                     PARM           @MSGID           ****4
     C*
     C***                  END                             E***4          S01177
     C*
     C                     ELSE                            X***4          S01177
     C** validate action and deal no
     C                     EXSR #ZO                        ***3
     C/COPY WNCPYSRC,MM0028C079
     C*
     C                     END                             E**3
     C*                                                                   S01177
     C                     END                                            S01177
     C*
     C*   Force bypass of scrren write during file update                 E20031
     C*   so as to return to the F15 Loop                                 E20031
     C                     MOVE 'Y'       @@@BPS                          E20031
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP14                                           S01408
     C*                                                                   S01408
     C**  If DDACTN is A, amend the record.
     C           DDACTN    CASEQ'A'       #BFA             B**3
     C**  If DDACTN is X, authorize the record
     C           DDACTN    CASEQ'X'       #BFC             ***3
     C**  If DDACTN is D, delete the record.
     C           DDACTN    CASEQ'D'       #BFB             ***3
     C*
     C                     END                             E**3
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP15                                           S01408
     C*                                                                   S01408
     C                     MOVE *BLANKS   @@@BPS                          E20031
     C*                                                                   S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C                     END                                            S01177
     C*
     C**  If F3 is input exit main processing immediately.
     C           *INKC     CABEQ'1'       #BF9             **2
     C*
     C**  If F12 is input go to select processing termination.
     C           *INKL     CABEQ'1'       #BF8             **2
     C*
      *                                                                   136653
      ** If *IN58 is on, reset @@ACTN to blanks.                          136653
      *                                                                   136653
     C***********          END                             E*2            136653
     C                     ELSE                                           136653
     C                     MOVE *BLANKS   @@ACTN                          136653
     C                     END                                            136653
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP35                                           S01408
     C*                                                                   S01408
     C*
     C                     END                             E1
     C*
     C**  Tag #BF8.
     C           #BF8      TAG                             #BF8 TAG
     C*
     C**  Termination of select processing.
     C*
     C**  Reset indicator showing whether select processing is in progress
     C                     MOVE '0'       *IN45
     C*
     C**  Reset Action Code text for screen.
     C                     MOVE @LIST     DDLIST
     C*
     C**  if values should remain on the screen to indicate an external
     C**  transaction, do not blank screen fields.
     C           *IN78     CABEQ'1'       #BF9
     C*
     C**  Blank out screen fields.
     C                     EXSR #ZE
      *                                                                   E18139
      **  And standard deal fields                                        E18139
     C                     EXSR #ZEA                                      E18139
     C*
     C**  Disable CMD/14 to prevent call to settlement screen             S01177
     C                     MOVE *BLANKS   @PRI                            S01177
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CLD2                                           S01408
     C*
     C           #BF9      ENDSR                           **#BF9**
     C*****************************************************************
     C/EJECT
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCPG                                           S01408
     C*                                                                   S01408
     C*****************************************************************
     C*                                                               *
     C*          #BFA     - F15  processing amend.                    *
     C*                                                               *
     C* CALLS    #ZL      - Displays, reads and resets screen.        *
     C***********ZA0240   - sends message to screen                   *   S01177
     C*          #ZC      - Enter processing for action code A.       *
     C*                                                               *
     C* CALLED BY  #BF    - F15  processing.                          *
     C*                                                               *
     C* FLDS USED  @MSGID - message id                                *
     C*                                                               *
     C*****************************************************************
     C           #BFA      BEGSR
     C*
     C**  Carry out processing until a valid input has been received.
     C           *IN41     DOUEQ'0'                        B1
     C           *INKC     OREQ '1'                        *1
     C*
     C**  If *IN41 is on then an amend error has occurred.
     C           *IN41     IFEQ '1'                        B*2
     C*
     C**  Process the screen.
     C                     EXSR #ZL                        **2
     C*
     C**  If F3 is input exit main processing immediately.
     C           *INKC     CABEQ'1'       #BFA9            **2
     C*
     C**  If F12 is input go to select processing termination.
     C           *INKL     CABEQ'1'       #BFA9            **2
     C**  If F14  is input display settlement screen                      S01177
     C           *INKN     IFEQ '1'                                       S01177
     C                     EXSR #BG                                       S01177
     C*                                                                   S01177
     C*   If F3 was pressed in settlements screen return to #BF           S01177
     C**  where the program will be terminated                            S01177
     C           *INKC     CABEQ'1'       #BFA9                           S01177
     C*                                                                   S01177
     C*   F12 pressed on screen 2                                         S01177
     C                     SETON                     13                   S01177
     C                     GOTO #BFA9                                     S01177
     C*                                                                   S01177
     C                     END                             E**3           S01177
     C*   ENTER                                                           S01177
     C*                                                                   S01177
     C**  If the action code is now E, cease amend processing
     C**  for this record and display the next selected deal, if any      S01177
     C           DDACTN    CABEQ'E'       #BFA9            **2
     C*                                                                   S01177
     C**  If the action code is has been changed from 'A' seton *IN14     S01177
     C**  so that it can be re-validated in the #BF loop and if valid     S01177
     C**  (i.e. it has been changed to 'X' or 'D') the appropriate        S01177
     C**  authorise or delete sub-routine will be executed                S01177
     C*
     C****If*the*action*code*is*not*A,*it*is*invalid.***************      S01177
     C           DDACTN    IFNE 'A'                        B**3
     C                     SETON                     14                   S01177
     C                     GOTO #BFA9                                     S01177
     C*
     C****SET*up*error*output*for*screen.                                 S01177
     C***                  MOVE '1'       *IN01            ***3           S01177
     C***                  MOVE '1'       *IN41            ***3           S01177
     C***                  MOVEL'MMM1008' @MSGID           ***3           S01177
     C***                  CALL 'ZA0240'                   ***3           S01177
     C***                  PARM           @MSGID           ***3           S01177
     C*
     C                     END                             E**3
     C*
     C                     END                             E*2
     C*                                                    *1
     C**  Process the input to the screen - amend processing.
     C                     EXSR #ZC                        *1
     C                     MOVE '0'       *IN11            *1
     C*
     C                     END                             E1
     C*
     C           #BFA9     ENDSR                           **#BFA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #BFB     - F15  processing delete.                   *
     C*                                                               *
     C* CALLS    #ZL    - Displays, reads and resets screen.          *
     C*          #ZB    - Enter processing for action code D.         *
     C*          #ZM    - F10  processing.                            *
     C*                                                               *
     C* CALLED BY  #BF    - F15  processing                           *   S01177
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           #BFB      BEGSR
     C*
     C**  If an error occurred in the preliminary validation, display
     C**  the error message, and proceed with the next selected record.
     C           *IN41     IFEQ '1'                        B1
     C                     EXSR #ZL                        *1
     C                     GOTO #BFB9                      *1
     C                     END                             E1
     C*
     C**  Carry out processing until a valid input has been received.
     C           *IN42     DOUEQ'1'                        B1
     C*
     C           *IN42     IFNE '1'                                       S01177
     C*
     C**  Process the input to the screen - delete processing.
     C                     EXSR #ZB                        *1
     C*
     C**  Process the screen.
     C                     EXSR #ZL                        *1
     C*                                                                   S01177
     C                     END                                            S01177
     C*
     C**  If F3 is input exit main processing immediately.
     C           *INKC     CABEQ'1'       #BFB9            *1
     C*
     C**  If F12 is input go to select processing termination.
     C           *INKL     CABEQ'1'       #BFB9            *1
     C**  If F14  is input display settlement screen                      S01177
     C           *INKN     IFEQ '1'                                       S01177
     C                     EXSR #BG                                       S01177
     C*                                                                   S01177
     C*   If F3 was pressed in settlements screen return to #BF           S01177
     C**  where the program is terminated                                 S01177
     C*                                                                   S01177
     C           *INKC     CABEQ'1'       #BFB9                           S01177
     C*                                                                   S01177
     C*   F12 pressed on screen 2 - RE-DISPLAY SCREEN 1 WITH PROMPT       S01177
     C                     SETON                     13                   S01177
     C                     GOTO #BFB9                                     S01177
     C*                                                                   S01177
     C                     END                                            S01177
     C*
     C**  If F10 is input carry out F10 processing.   .
     C           *INKJ     IFEQ '1'                        B*2
     C*
     C**  Process F10.
     C                     EXSR #ZM                        **2
     C*
     C*** If *IN10 is*off,*the*deletion*has*been*successful.********      S01177
     C***        *IN10     CABEQ'0'       #BFB9            **2            S01177
     C*                                                                   S01177
     C**  If *IN01 is off, the deletion has been successful.              S01177
     C           *IN01     CABEQ'0'       #BFB9            **2            S01177
     C*
     C**  Process the screen.
     C                     EXSR #ZL                        **2
     C*
     C**  If F3 is input exit main processing immediately.
     C           *INKC     CABEQ'1'       #BFB9            **2
     C*
     C**  If F12 is input go to select processing termination.
     C           *INKL     CABEQ'1'       #BFB9            **2
     C*
     C                     END                             E*2
     C*
     C*                                                                   S01177
     C**  If the action code is has been changed from 'D' seton *IN14     S01177
     C**  so that it can be re-validated in the #BF loop and if valid     S01177
     C**  (i.e. it has been changed to 'A' or 'X' or 'E' the              S01177
     C**  appropriate amend or authorise sub-routine will be executed     S01177
     C**  or the next selected deal (if any) will be displayed            S01177
     C*                                                                   S01177
     C***        DDACTN    CABEQ'E'       #BFB9            *1             S01177
     C           DDACTN    IFNE 'D'                                       S01177
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CP10                                           S01408
     C*                                                                   S01408
     C                     SETON                     14                   S01177
     C                     MOVE '0'       *IN42                           S01177
     C                     GOTO #BFB9                                     S01177
     C                     END                                            S01177
     C*
     C                     END                             E1
     C*                                                                   S01177
     C                     MOVE '0'       *IN42                           S01177
     C*
     C           #BFB9     ENDSR                           **#BFB9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #BFC     - F15  authorize                            *
     C*                                                               *
     C* CALLS    ZA0240   - sends message to screen                   *
     C*          #ZL      - Displays, reads and resets screen.        *
     C*          #ZP      - Authorize processing.                     *
     C*                                                               *
     C* CALLED BY                                                     *
     C*                                                               *
     C* FLDS USED  @MSGID - message id                                *
     C*                                                               *
     C*****************************************************************
     C           #BFC      BEGSR
     C*
     C****use**IN15*to*show*that*confirmation*prompting*has*been*  S01177 E20897
     C**  use *IN17 to show that confirmation prompting has been called   E20897
     C**  from SELECT processing. If F12 is pressed in response to a      S01177
     C**  confirmation request the deal will be redisplayed with an       S01177
     C**  action code of 'E' (authorise only).                            S01177
     C*********************SETON                     15            S01177 E20897
     C                     SETON                     17                   E20897
     C*                                                                   S01177
     C**  If an error occurred in the prelininary validation, display     S01177
     C**  the error message and proceed with the next selected record     S01177
     C           *IN41     IFEQ '1'                        B1             S01177
     C                     EXSR #ZL                        *1             S01177
     C                     GOTO #BFC9                      *1             S01177
     C                     END                             E1             S01177
     C**  Carry out processing until a valid input has been received.
     C           *IN41     DOUEQ'0'                        B1
     C           *INKC     OREQ '1'                        *1
     C*
     C**  If *IN41 is on then an amend error has occurred.
     C           *IN41     IFEQ '1'                        B*2
     C*
     C**  Process the screen.
     C                     EXSR #ZL                        **2
     C*
     C**  If F3 is input exit main processing immediately.
     C           *INKC     CABEQ'1'       #BFC9            **2
     C*
     C**  If F12 is input go to select processing termination.
     C           *INKL     CABEQ'1'       #BFC9            **2
     C*
     C**  If F14 is input display settlement screen                       S01177
     C           *INKN     IFEQ '1'                        B*2            S01177
     C                     EXSR #BG                        **2            S01177
     C*                                                                   S01177
     C*   If F3 was pressed in settlements screen, exit                   S01177
     C           *INKC     CABEQ'1'       #BFC9            **2            S01177
     C*                                                                   S01177
     C*   F12 pressed on screen 2                                         S01177
     C                     SETON                     13                   S01177
     C                     GOTO #BFC9                                     S01177
     C*                                                                   S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C* ENTER pressed (or F12 from settlements screen)                    S01177
     C*                                                                   S01177
     C**  If the action code is now E, cease authorize processing
     C**  for this record.
     C           DDACTN    CABEQ'E'       #BFC9            **2
     C*
     C**  If the action code is not X, it is invalid.
     C**  If the action code is has been changed from 'X' seton *IN14     S01177
     C**  so that it can be re-validated in the #BF loop and if valid     S01177
     C**  (i.e. it has been changed to 'A' or 'D') the appropriate        S01177
     C**  amend or delete sub-routine will be executed                    S01177
     C*                                                                   S01177
     C****If*the*action*code*is*not*X,*it*is*invalid.*************        S01177
     C           DDACTN    IFNE 'X'                        B**3
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP7                                           S01408
     C*                                                                   S01408
     C                     SETON                     14                   S01177
     C                     GOTO #BFC9                                     S01177
     C*
     C****Set*up*error*output*for*screen.*************************        S01177
     C*
     C***                  MOVE '1'       *IN10            ***3           S01177
     C***                  MOVE '1'       *IN41            ***3           S01177
     C***                  MOVEL'MMM1008' @MSGID           ***3           S01177
     C***                  CALL 'ZA0240'                   ***3           S01177
     C***                  PARM           @MSGID           ***3           S01177
     C*
     C*
     C                     END                             E**3
     C*
     C                     END                             E*2
     C*
     C**  Process the input to the screen - authorize processing.
     C                     EXSR #ZP                        *1
     C                     MOVE '0'       *IN11            *1
     C*
     C                     END                             E1
     C*
     C           #BFC9     ENDSR                           **#BFC9**
     C*****************************************************************
      /EJECT                                                              S01184
      *****************************************************************   S01184
      *                                                               *   S01184
      * #FEED    - Extract feedback information when CONFIRMATION     *   S01184
      *            MATCHING module present                            *   S01184
      *                                                               *   S01184
      * CALLS             - None                                      *   S01184
      *                                                               *   S01184
      * CALLED BY  #ZD    - move file to store                        *   S01184
      *            #BF    - F15 processing                            *   S01184
      *                                                               *   S01184
      * FLDS USED         -                                           *   S01184
      *                                                               *   S01184
      *****************************************************************   S01184
     C           #FEED     BEGSR                                          S01184
     C*                                                                   S01184
     C* Set on CONFIRMATION MATCHING present indicator                    S01184
     C                     MOVE '1'       *IN31                           S01184
     C*                                                                   S01184
     C* Set off Broker involved indicator                                 S01184
     C                     MOVE '0'       *IN36                           S01184
     C*                                                                   S01184
     C* Get BROKER from related deal                                      S01184
     C                     MOVE DDDLNO    @DLKEY                          S01184
     C           @DLKEY    CHAINMMDEALLL             65                   S01184
     C*                                                                   S01184
     C           *IN65     IFEQ '1'                                       S01184
     C                     MOVE '1'       *INLR                           S01184
     C                     MOVE '1'       *INU7                           S01184
     C                     MOVE '1'       *INU8                           S01184
     C                     MOVE '1'       *INKC                           S01184
     C                     MOVEL'MMDEALLL'DBFILE                          S01184
     C                     MOVEL@DLKEY    DBKEY            ***************S01184
     C                     MOVE '017'     DBASE            * DB ERROR 17 *S01184
     C                     EXSR #C                         ***************S01184
     C                     END                                            S01184
     C*                                                                   S01184
     C* Broker involved?                                                  S01184
     C           H@BKCD    IFEQ 'PHON'                                    S01184
     C           H@BKCD    OREQ 'TELX'                                    S01184
     C           H@BKCD    OREQ 'MAIL'                                    S01184
     C           H@BKCD    OREQ 'SWAP'                                    S01184
     C                     MOVE '1'       *IN36                           S01184
     C                     END                                            S01184
     C*                                                                   S01184
     C                     MOVE *BLANKS   @CTXT  15                       S01184
     C                     MOVE *BLANKS   @BTXT  15                       S01184
     C***********          MOVE *BLANKS   @WRK7   7                S01184 060779
     C***********          MOVE *BLANKS   @WRK10 10                S01184 060779
     C                     MOVE *BLANKS   @WRK8   8                       060779
     C                     MOVE *BLANKS   @WRK11 11                       060779
     C*                                                                   S01184
     C* Get most recent FEEDBACK record for deal                          S01184
     C***********          MOVEL'D'       @WRK7                    S01184 060779
     C***********          MOVE DDDLNO    @WRK7                    S01184 060779
     C***********          MOVEL@WRK7     @WRK10                   S01184 060779
     C***********          MOVE '999'     @WRK10                   S01184 060779
     C***********          MOVEL@WRK10    @REF   16                S01184 060779
     C*                                                                   060779
     C                     MOVEL'DL'      @WRK8                           060779
     C                     MOVE DDDLNO    @WRK8                           060779
     C                     MOVEL@WRK8     @WRK11                          060779
     C                     MOVE '999'     @WRK11                          060779
     C                     MOVEL@WRK11    @REF   16                       060779
     C           @REF      SETGTCFFEEDL0                                  S01184
     C                     READPCFFEEDL0                 37               S01184
     C           *IN37     IFEQ '0'                                       S01184
     C***********          MOVELIMRF      @@7     7                S01184 060779
     C***********@WRK7     COMP @@7                  3737          S01184 060779
     C                     MOVELIMRF      @@8     8                       060779
     C           @WRK8     COMP @@8                  3737                 060779
     C                     END                                            S01184
     C*                                                                   S01184
     C* if no record with DEAL key SET STATUSES TO 00 NO FEEDBACK YET     S01184
     C           *IN37     IFEQ '1'                                       S01184
     C                     MOVE '00'      @CPST   2                       S01184
     C                     MOVE '00'      @BKST   2                       S01184
     C                     ELSE                                           S01184
     C                     MOVE CPSX      @CPST                           S01184
     C                     MOVE BKSX      @BKST                           S01184
     C                     END                                            S01184
     C*                                                                   S01184
     C* F15 (and #ZD not called by F15), set up STATUS CODES ONLY, exit   S01184
     C           *IN45     IFEQ '1'                                       S01184
     C           *IN19     ANDEQ'0'                                       S01184
     C                     MOVE *BLANKS   @WRK5   5                       S01184
     C                     MOVE *BLANKS   @WRK6   6                       S01184
     C                     MOVEL@CPST     @WRK5                           S01184
     C           *IN36     IFEQ '1'                                       S01184
     C                     MOVE *BLANKS   @BKST                           S01184
     C                     END                                            S01184
     C                     MOVE @BKST     @WRK5                           S01184
     C                     MOVE *BLANKS   DDTEXT                          S01184
     C                     MOVE @WRK5     @WRK6                           S01184
     C                     MOVEL@WRK6     DDTEXT                          S01184
     C                     MOVE DDTEXT    @TEXT                           S01184
     C                     GOTO #FEED9                                    S01184
     C                     END                                            S01184
     C*                                                                   S01184
     C* Not F15 so find associated STATUS TEXT for counterparty           S01184
     C           @CPST     LOKUPTABA      TABB           05               S01184
     C                     MOVELTABB      DDCPTY                          S01184
     C                     MOVELDDCPTY    @CPTY                           S01184
     C*                                                                   S01184
     C* IF Broker involved                                                S01184
     C           *IN36     IFEQ '0'                                       S01184
     C           @BKST     LOKUPTABA      TABB           05               S01184
     C                     MOVELTABB      DDBROK                          S01184
     C                     MOVELDDBROK    @BROK                           S01184
     C                     END                                            S01184
     C*                                                                   S01184
     C                     MOVE '0'       *IN19                           S01184
     C*                                                                   S01184
     C           #FEED9    ENDSR                           #FEED TAG      S01184
     C*****************************************************************   S01184
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*      #A       - initial processing                            *
     C*                                                               *
     C* CALLS    #ZE      - Clear screen.                             *
     C*          #ZEA     - Clear standard deal                       *   E18139
     C*          ZA0150   - access tabtb10                            *
     C*          #ZK      - Retrieves a record and displays it.       *
     C***********MM0031***-*Add*member*to*Standard*deal*format.***********S01319
     C***********QCAEXEC**-*Execute*CL*command*from*within*program.****   E20774
     C***********QCMDEXC**-*Execute*CL*command*from*within*program.**E2077401319
     C*                                                               *
     C* CALLED BY  MAIN     -  Controls main processing               *
     C*                                                               *
     C* FLDS USED  @DLNO  - stored deal number                        *
     C*            @VDAT  - stored value date                         *
     C*            @DS38  - Stored deam sequence number               *
     C*            @ACTN  - stored action code                        *
     C*            @CSNM  - stored customer                           *
     C*            @MTYP  - Stored deal type                          *
     C*            @VDAT  - stored value date                         *
     C*            @CCY   - stored currency                           *
     C*            @AMNP  - stored purchase price                     *
     C*            @INTR  - stored spread rate                        *
     C*            @FSRP  - stored funding spread/rate                *   CAC001
     C******       @ORCM  - stored rec. settlement method             *   S01177
     C******       @MORI  - stored our rec. bank a/c debit            *   S01177
     C******       @MCPI  - stored c'party paying bank                *   S01177
     C******       @MFAO  - stored for a/c of                         *   S01177
     C******       @SPEC  - stored special instructions               *   S01177
     C*            @RSTM  - stored rcpt settlement method             *   S01177
     C*            @RONS  - stored rcpt our nostro                    *   S01177
     C*            @RIBN  - stored rcpt intermed bank no.             *   S01177
     C*            @RIBA  - stored rcpt intermed bank a/c line        *   S01177
     C*            @ROBN  - stored rcpt ordering bank no.             *   S01177
     C*            @ROCN  - stored rcpt ordering customer no.         *   S01177
     C*            @PSTM  - stored pay settlement method              *   S01177
     C*            @PONS  - stored pay our nostro                     *   S01177
     C*            @PIBN  - stored pay intermed bank no.              *   S01177
     C*            @PIBA  - stored pay intermed bank a/c line         *   S01177
     C*            @POBN  - stored pay ordering bank no.              *   S01177
     C*            @POCN  - stored pay ordering customer no.          *   S01177
     C*            @RCRN  - stored receiver correspondant no.         *   S01177
     C*            @RCRA  - stored receiver corr a/c line             *   S01177
     C*            @RVNO  - stored receiver no.                       *   S01177
     C*            @AWBN  - stored a/c with bank no.                  *   S01177
     C*            @AWBA  - stored a/c with bank a/c line             *   S01177
     C*            @BENN  - stored beneficiary no.                    *   S01177
     C*            @BENA  - stored beneficiary a/c line               *   S01177
     C*            @DTP1  - stored details of payment 1               *   S01177
     C*            @DTP2  - stored details of payment 2               *   S01177
     C*            @DTP3  - stored details of payment 3               *   S01177
     C*            @DTP4  - stored details of payment 4               *   S01177
     C*            @DCHG  - stored details of charges                 *   S01177
     C*            @BTB1  - stored bank to bank info 1                *   S01177
     C*            @BTB2  - stored bank to bank info 2                *   S01177
     C*            @BTB3  - stored bank to bank info 3                *   S01177
     C*            @BTB4  - stored bank to bank info 4                *   S01177
     C*            @BTB5  - stored bank to bank info 5                *   S01177
     C*            @BTB6  - stored bank to bank info 6                *   S01177
     C*            @CVMR  - cover MT202 required                      *   E22405
     C*            @TXT   - Data passed to ZA0440                     *
     C*            @DATA1 -   "    "         "                        *
     C*            @DATA2 -   "    "         "                        *
     C*            @T11   - work field                                *
     C*            @WK25  -  "     "                                  *
     C*            @WK35  -  "     "                                  *
     C*            @WK30  -  "     "                                  *
     C*            @WK10  -  "     "                                  *
     C*            @JOB   -  Workstation i.d.                         *
     C*            @KEY   - key for table files                       *
     C*            @USER  -  User i.d.                                *
     C*************@USRKY*-**Key*to*user*file**************************   S01319
     C*************@CLTKY*-**key*to*LF/CLINT***************************   S01319
     C*************@CNUM**-**customer*no.******************************   S01319
     C*************@RCDT**-**key*field*constant************************   S01319
     C*************@CYCNM*-*Customer*currency*defaults*key.************   S01319
     C*************@CYKEY*-*Customer*currency*defaults*key.************   S01319
     C*************@CYCCY*-*Customer*currency*defaults*key.************   S01319
     C*************@NSCCY*-*Nostro*key.********************************   E13747
     C*************@NSKEY*-*Nostro*key.********************************   E13747
     C*************@NSCNO*-*Nostro*key.********************************   E13747
     C*************@NSP***-***"*****"**********************************   E13747
     C*************@ACKEY*-*ACCNT*key**********************************   S01319
     C*************@ACCNM*-**"*****"***********************************   S01319
     C*************@ACCCY*-**"*****"***********************************   S01319
     C*************@ACCDE*-**"*****"***********************************   S01319
     C*************@ACSEQ*-**"*****"***********************************   S01319
     C*************@SNKEY*-**Shortname*key*****************************   E13747
     C*************@SNNM1*-*****"*******"******************************   E13747
     C*************@SNNM2*-*****"*******"******************************   E13747
     C*            @TERM1 -  Termination parameter                    *
     C*            @RDLN  -  Related deal deal no. parameter          *
     C*            @RVDT  -  deal value date parameter                *
     C*            @RSQN  -  Sequence no. parameter                   *
     C*            @ERR   -  Error parameter                          *
     C*            @NOPMS -  Number of parameters passed to program   *
     C*            @RADMK - Range authorisation key to deams file.    *
     C*            @TERM  -  Termination parameter                    *
     C*************@CUID**-**Overide*command*workfield********************S01319
     C*************@JOBNO*-*****"*******"********"************************S01319
     C*************@CJON**-*****"*******"********"************************S01319
     C*************@CEND**-*****"*******"********"************************S01319
     C*************@CMDV**-*****"*******"********"************************S01319
     C*************@CMD***-**Command*passed*to*QCAEXEC*****************   E20774
     C*************@CMD***-**Command*passed*to*QCMDEXC**************E20774S01319
     C*************@LNTH**-**Length*of*command*passed*to*QCAEXEC*******   E20774
     C*************@LNTH**-**Length*of*command*passed*to*QCMDEXC****E20774S01319
     C*                                                               *
     C*****************************************************************
     C           #A        BEGSR
     C*
     C                     MOVEACPY@      BIS@   80                       S01194
     C/COPY WNCPYSRC,MM0028C016
     C**  Call #ZE to initialise the standard deal etc.
     C                     EXSR #ZE
     C                     EXSR #ZEA                                      E18139
     C*
     C**  GET ZMUSER to access default branch.                            S01117
     C**                                                                  S01117
     C/COPY WNCPYSRC,MM0028C119
     C           *NAMVAR   DEFN           ZMUSER                          S01117
     C                     IN   ZMUSER                                    S01117
     C                     UNLCKZMUSER                                    S01117
     C/COPY WNCPYSRC,MM0028C120
     C**                                                                  S01117
     C**  GET RUNDAT to access MULTI-BRANCHING flag.                      S01117
     C**                                                                  S01117
     C           *NAMVAR   DEFN           RUNDAT                          S01117
     C                     IN   RUNDAT                                    S01117
     C           @MBIN     IFEQ 'Y'                                       S01117
     C                     MOVE '1'       *IN36                           S01117
     C************         MOVE '1'       *IN76                     S01117114485
     C                     ELSE                                           S01117
     C                     MOVE '0'       *IN36                           S01117
     C************         MOVE '0'       *IN76                     S01117114485
     C                     END                                            S01117
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CCP1                                           S01408
     C*                                                                   S01408
     C*
     C**  Define program work fields.
     C                     MOVE *BLANKS   @MSGID 10
     C                     MOVE *BLANKS   @T11   15
     C                     MOVE *BLANKS   @WK25  25
     C                     MOVE *BLANKS   @WK35  35
     C                     MOVE *BLANKS   @WK30  30
     C                     MOVE *BLANKS   @WK10  10
     C*
     C**  IF this is not the first call to the program, by-pass first
     C**  time processing.
     C           @FTMI     IFEQ 'N'                        B1
     C                     GOTO #A8                        *1
     C                     END                             E1
     C                     MOVE 'N'       @FTMI   1
     C*
     C**  Initialise screen msg queue.
     C                     MOVEL'*'       DDPGMQ
     C*
     C**  Set on Message Subfile end indicator.
     C                     MOVE '1'       *IN59
     C*
     C**  Move workstation ID to screen field.
     C                     MOVEL@JOB      DDWID
     C*
     C**  Move program name into *LDA field.
     C                     MOVEL'MM0028'  DBPGM
     C*
     C**  Initialise fields in message.
     C                     MOVE '/'       @DASH1
     C                     MOVE '/'       @DASH2
     C*********************OPEN*MMSSTSLL****************************E22161S01319
     C**************************************************************E22161S01319
     C****Read*the*first*and*only*record*on*MMSSTSLL.***************E22161S01319
     C***********1*********CHAINMMSSTSLL*************60*************E22161S01319
     C**************************************************************E22161S01319
     C****If*no*valid*record*found*then*it*is*a*data*base*error.****E22161S01319
     C************IN60*****IFEQ*'1'************************B1*******E22161S01319
     C***********H1DLTF****OREQ*'*'************************X1*******E22161S01319
     C*********************MOVE*'1'********INU7*************1*******E22161S01319
     C*********************MOVE*'1'********INU8*********************E22161S01319
     C*********************MOVEL'MMSSTSLL'DBFILE*************DBERRORE22161S01319
     C*********************MOVEL*BLANKS***DBKEY*********************E22161S01319
     C*********************MOVE*'015'*****DBASE*************1*******E22161S01319
     C*********************MOVE*'1'********INLR*************1*******E22161S01319
     C*********************MOVE*'1'********INKC*************1*******E22161S01319
     C**************************************************************E22161S01319
     C*********************EXSR*#C**************************1*******E22161S01319
     C*********************END*****************************E1*******E22161S01319
      *                                                                   CAC001
      **  Access MIDAS Modules details via access program                 CAC001
      *   (database error handling done in access program)                CAC001
     C                     CALL 'AOMMODR0'                                CAC001
     C                     PARM '*DBERR ' @RTCD   7                       CAC001
     C                     PARM '*FIRST ' @OPTN   7                       CAC001
     C           SDMMOD    PARM SDMMOD    DSFDY                           CAC001
      *                                                                   CAC001
      **  If Analytical Accounting is installed, display Funding          CAC001
      **  Spread/Rate field                                               CAC001
      *                                                                   CAC001
     C           BGN0ST    IFEQ 'Y'                                       CAC001
     C                     MOVE '1'       *IN21                           CAC001
     C                     ENDIF                                          CAC001
      *                                                                   CAC001
     C**********           CALL 'AODEALR0'                                                    CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01319
     C                     PARM '*FIRST ' @OPTN   7                       S01319
     C********** SDDEAL    PARM SDDEAL    DSFDY                                               CGL029
     C           SDDEAL    PARM SDDEAL    DSSDY                                               CGL029
     C*
      *                                                                   E18139
      **  Setup user details here and write input screen while files are  E18139
      *   being opened.                                                   E18139
      *                                                                   E18139
      **  Open display and user details files                             E18139
     C/COPY WNCPYSRC,MM0028C121
     C                     OPEN MM0028DD                                  E18139
     C/COPY WNCPYSRC,MM0028C122
     C*********************OPEN*MMUSERLL****************************E18139S01319
      **************************************************************E18139S01319
     C****Get*the*user*id*from*PSDS*and*use*this*to*chain*to*the***E18139*S01319
     C****user*details.*********************************************E18139S01319
     C*********************MOVEL@USER*****@USRKY**3*****************E18139S01319
     C***********@USRKY****CHAINMMUSERLL*************60*************E18139S01319
     C**************************************************************E18139S01319
     C****If*the*user*is*not*on*file*treat*user*as*if*they*are******E18139S01319
     C****not*a*Settlement*Officer*or*Authorization*Officer*********E18139S01319
     C************IN60*****IFEQ*'1'************************B1*******E18139S01319
     C***********IQDLTF****ORNE**BLANKS*********************1*******E18139S01319
     C*********************MOVE*'N'*******IQMMSO************1*******E18139S01319
     C*********************MOVE*'N'*******IQMMAO************1*******E18139S01319
     C*********************END*****************************E1*******E18139S01319
     C*                                                                   E18139
     C**  Set up Action Code text for screen.                             E18139
     C*                                                                   E18139
     C                     MOVEL'(I,A'    DDLIST                          S01319
     C                     MOVE ',D,E,X)' DDLIST                          S01319
     C****If*the*user*is*a*settlement*officer*and*not*an*authorizatiE18139S01319
     C****officer.**************************************************E18139S01319
     C***********IQMMSO****IFEQ*'Y'************************B1*******E18139S01319
     C***********IQMMAO****ANDEQ'N'*************************1*******E18139S01319
     C*********************MOVEL'(I,A'****DDLIST************1*******E18139S01319
     C*********************MOVE*',D,E,*)'*DDLIST************1*******E18139S01319
     C*********************END*****************************E1*******E18139S01319
     C**************************************************************E18139S01319
     C****If*the*user*is*an*authorization*officer*and*not*a*settlemeE18139S01319
     C****officer.**************************************************E18139S01319
     C***********IQMMSO****IFEQ*'N'************************B1*******E18139S01319
     C***********IQMMAO****ANDEQ'Y'*************************1*******E18139S01319
     C*********************MOVEL'(*,*'****DDLIST************1*******E18139S01319
     C*********************MOVE*',*,E,X)'*DDLIST************1*******E18139S01319
     C*********************END*****************************E1*******E18139S01319
     C**************************************************************E18139S01319
     C****If*the*user*is*an*authorization*officer*and*a*settlements*E18139S01319
     C****officer.**************************************************E18139S01319
     C***********IQMMSO****IFEQ*'Y'************************B1*******E18139S01319
     C***********IQMMAO****ANDEQ'Y'*************************1*******E18139S01319
     C*********************MOVEL'(I,A'****DDLIST************1*******E18139S01319
     C*********************MOVE*',D,E,X)'*DDLIST************1*******E18139S01319
     C*********************END*****************************E1*******E18139S01319
     C**************************************************************E18139S01319
     C****If*the*user*is*neither*an*authorization*or*settlements****E18139S01319
     C****officer.**************************************************E18139S01319
     C***********IQMMSO****IFEQ*'N'************************B1*******E18139S01319
     C***********IQMMAO****ANDEQ'N'*************************1*******E18139S01319
     C*********************MOVEL'(*,*'****DDLIST************1*******E18139S01319
     C*********************MOVE*',*,E,*)'*DDLIST************1*******E18139S01319
     C*********************END*****************************E1*******E18139S01319
     C*                                                                   E18139
     C**  If the back office authorization is not required, omit type     E18139
     C**  X.                                                              E18139
     C***********H1BOAR****IFEQ*'N'************************B1*******E18139S01319
     C           BNMMAU    IFEQ 'N'                        B1             S01319
     C                     MOVE ' )'      DDLIST           *1             E18139
     C                     END                             E1             E18139
     C/COPY WNCPYSRC,MM0028C123
     C*                                                                   E18139
      *                                                                   E18139
      **  Retrieve time and place in screen field.                        E18139
     C                     TIME           DDTIME                          E18139
      *                                                                   LN0367
      **  Do not write input screen until details have been passed if     LN0367
      **  program is being called via the Range Authorization program     LN0367
      *                                                                   LN0367
     C           @NOPMS    IFNE 5                          B1             LN0367
     C/COPY WNCPYSRC,MM0028C006
      *                                                    *1             E18139
      *                                                    *1             E18139
      **  Write input screen                               *1             E18139
     C                     WRITEMM0028S0                   *1             E18139
     C                     WRITEMM0028D2                   *1             S01199
     C                     WRITEMM0028D0                   *1             E18139
     C/COPY WNCPYSRC,MM0028C124
      *                                                    *1             E18139
     C                     SETON                     57    *1             E18139
     C/COPY WNCPYSRC,MM0028C062
      *                                                    *1             LN0367
     C                     END                             E1             LN0367
      *                                                                   E18139
     C*
     C**  Open all the files
     C*****                OPEN ACCNT                                     S01177
     C*****                OPEN CLINT
     C*********************OPEN*FDINSTLL**********************************S01319
     C*****                OPEN FDLCY1LL                          E14363  S01177
     C*****                OPEN FXTB40LL
     C*****                OPEN FDCCYTLL
     C*****                OPEN FDCPTILL
     C*****                OPEN FDICDRLL
     C                     OPEN DEALSH                                    E42414
     C                     OPEN MMMCOMLL
     C**********           OPEN FDNOSTLL                                  E13747
     C**********           OPEN FDCCCYLL                                  E13747
     C*****                OPEN FDRETALL                                  S01177
     C**********           OPEN FDSNAMLL                                  E13747
     C**********           OPEN FDTABJLL
     C*****                OPEN FDTBLILL
     C                     OPEN MMCARMLL
     C                     OPEN MMCMPLLL
     C                     OPEN MMLVDMLL
     C                     OPEN MMDEALLL
     C                     OPEN MMDEAMLL
     C                     OPEN MMDAMULL
     C******               OPEN MMSSTSLL                                  E22161
     C*********************OPEN*MMUAUTLL**********************************S01319
     C******               OPEN MMUSERLL                                  E18139
     C*****                OPEN SNAME
     C*****                OPEN STDSI                              E13747 S01177
     C******               OPEN MM0028DD                                  E18139
     C/COPY WNCPYSRC,MM0028CP59                                           S01408
     C*
     C****Call subroutine to access ICD file for MIDAS run date.
     C*****                EXSR ZA0150
     C*
032  C* CALL ACCESS PROG. FOR BANK DETAILS.                               S01194
     C                     CALL 'AOBANKR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
032  C*                                                                   S01194
     C**  Check for data base error.
     C           @RTCD     IFNE *BLANK                     B1             S01194
     C*****      *IN80     IFEQ '1'                        B1
     C*
     C                     MOVEL'SDBANKPD'DBFILE           ***************S01194
     C                     MOVEL'900'     DBASE   3        * DBERROR 900 *S01194
     C                     MOVEL@OPTN     DBOPTN  7        ***************S01194
     C                     MOVEL'*FIRST ' DBKEY  29        *1             S01194
     C                     MOVE '1'       *INU7            *1
     C                     MOVE '1'       *INU8            *1
     C                     MOVE '1'       *INKC            *1
     C*
     C                     EXSR #C                         *1
     C*
     C                     END                             E1
032  C* CALL ACCESS PROG. FOR GENERAL DETAILS.                            S01194
     C**********           CALL 'AOGELRR0'                                             S01194 CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C********** SDGELR    PARM SDGELR    DSFDY                                        S01194 CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
032  C*                                                                   S01194
     C**  Check for data base error.                                      S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C*                                                                   S01194
     C                     MOVEL'SDGELRPD'DBFILE                          S01194
     C                     MOVEL@OPTN     DBOPTN  7        ***************S01194
     C                     MOVEL'*FIRST ' DBKEY  29        * DBERROR 901 *S01194
     C                     MOVE '1'       *INU7            ***************S01194
     C                     MOVE '1'       *INU8            *1             S01194
     C                     MOVE '1'       *INKC            *1             S01194
     C*                                                                   S01194
     C                     EXSR #C                         *1             S01194
     C*                                                                   S01194
     C                     END                             E1             S01194
     C*
     C****Read*the*first*and*only*record*on*FDINSTLL.*********************S01319
     C***********1*********CHAINFDINSTLL*************60*******************S01319
     C********************************************************************S01319
     C****If*no*valid*record*found*then*it*is*a*data*base*error.**********S01319
     C************IN60*****IFEQ*'1'************************B1*************S01319
     C***********IDDLTF****OREQ*'*'************************X1*************S01319
     C*********************MOVE*'1'********INU7*************1*************S01319
     C*********************MOVE*'1'********INU8***************************S01319
     C*********************MOVEL'FDINSTLL'DBFILE*************DBERROR*010**S01319
     C*********************MOVEL*BLANKS***DBKEY***************************S01319
     C*********************MOVE*'010'*****DBASE*************1*************S01319
     C*********************MOVE*'1'********INLR*************1*************S01319
     C*********************MOVE*'1'********INKC*************1*************S01319
     C********************************************************************S01319
     C*********************EXSR*#C**************************1*************S01319
     C*********************END*****************************E1*************S01319
     C*****                                                       *****   S01194
     C*****ead file FXTB40LL, format TABTB40.                     *****   S01194
     C*****                MOVE *BLANKS   @KEY                    *****   S01194
     C*****                MOVEL'01'      @KEY                    *****   S01194
     C*****                MOVE '40'      @KEY                    *****   S01194
     C*****      @KEY      CHAINFXTB40LL             60           *****   S01194
     C*****                                                       *****   S01194
     C*****f the chain fails or RECI is not 'D' then a database error**   S01194
     C*****ccurred.                                               *****   S01194
     C*****      *IN60     IFEQ '1'                        B1     *****   S01194
     C*****      RECI      ORNE 'D'                        *1     *****   S01194
     C*****                MOVE '1'       *INU7            *1     *****   S01194
     C*****                MOVE '1'       *INU8            ************   S01194
     C*****                MOVEL'FXTB40LL'DBFILE           **DBERROR*011**S01194
     C*****                MOVEL@KEY      DBKEY            ***************S01194
     C*****                MOVE '011'     DBASE            *1     *****   S01194
     C*****                MOVE '1'       *INLR            *1     *****   S01194
     C*****                MOVE '1'       *INKC            *1     *****   S01194
     C*****                                                       *****   S01194
     C*****                EXSR #C                         *1     *****   S01194
     C*****                END                             E1     *****   S01194
     C* CHECK MULTI-BRANCH INDICATOR FOR DISPLAY OF BKG/ORG BRANCH.       S01117
     C           @MBIN     IFEQ 'N'                        B1             S01117
     C                     MOVE '0'       *IN74            *1             S01117
     C                     MOVE '0'       *IN75            *1             S01117
     C                     ELSE                            X1             S01117
     C*****      OBIN      IFEQ 'Y'                        B*2    S01117  S01194
     C           BKOBRU    IFEQ 'Y'                        B*2            S01194
     C                     MOVE '1'       *IN74            **2            S01117
     C                     ELSE                            X*2            S01117
     C                     MOVE '0'       *IN74            **2            S01117
     C                     END                             E*2            S01117
     C                     MOVE '1'       *IN75            *1             S01117
     C                     END                             E1             S01117
     C*
     C* FIND OUT IF PROFIT CENTRE USED FLAG IS ON TO ALLOW DISPLAY.       S01117
     C*****      PFUS      IFEQ 'Y'                        B1     S01117  S01194
     C           BKPRCU    IFEQ 'Y'                        B1             S01194
     C                     MOVE '1'       *IN37            *1             S01117
     C                     ELSE                            X1             S01117
     C                     MOVE '0'       *IN37            *1             S01117
     C                     END                             E1             S01117
     C*
     C**  Read the first and only record on MMMCOMLL.
     C           1         CHAINMMMCOMLL             60
     C*
     C**
     C           *IN60     IFEQ '1'                        B1
     C           ICDLTF    OREQ '*'                        X1
     C                     MOVE '1'       *INU7            *1
     C                     MOVE '1'       *INU8            ***************
     C                     MOVEL'MMMCOMLL'DBFILE           * DBERROR 012 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     MOVE '012'     DBASE            *1
     C                     MOVE '1'       *INLR            *1
     C                     MOVE '1'       *INKC            *1
     C*
     C                     EXSR #C                         *1
     C                     END                             E1
     C*****                                                       *****   S01194
     C*****ead file FDICDRLL, format TABTB11.                     *****   S01194
     C*****                MOVE *BLANKS   @KEY                    *****   S01194
     C*****                MOVEL'01'      @KEY                    *****   S01194
     C*****                MOVE '11'      @KEY                    *****   S01194
     C*****      @KEY      CHAINFDICDRLL             60           *****   S01194
     C*****                                                       *****   S01194
     C*****f the chain fails or RECI is not 'D' then it is a data*base*   S01194
     C*****rror.                                                  *****   S01194
     C*****      *IN60     IFEQ '1'                        B1     *****   S01194
     C*****      RECI      ORNE 'D'                        *1     *****   S01194
     C*****                MOVE '1'       *INU7            *1     *****   S01194
     C*****                MOVE '1'       *INU8            ************   S01194
     C*****                MOVEL'FDICDRLL'DBFILE           **DBERROR*013**S01194
     C*****                MOVEL@KEY      DBKEY            ***************S01194
     C*****                MOVE '013'     DBASE            *1     *****   S01194
     C*****                MOVE '1'       *INLR            *1     *****   S01194
     C*****                MOVE '1'       *INKC            *1     *****   S01194
     C*****                                                       *****   S01194
     C*****                EXSR #C                         *1     *****   S01194
     C*****                END                             E1     *****   S01194
     C*****                                                       *****   S01194
     C*****ead file FDICDRLL, format TABTB20.                     *****   S01194
     C*****                MOVE *BLANKS   @KEY                    *****   S01194
     C*****                MOVEL'01'      @KEY                    *****   S01194
     C*****                MOVE '20'      @KEY                    *****   S01194
     C*****      @KEY      CHAINFDICDRLL             60           *****   S01194
     C*****                                                       *****   S01194
     C*****f the chain fails or RECI is not 'D' then a data base error*   S01194
     C*****as occurred.                                           *****   S01194
     C*****      *IN60     IFEQ '1'                        B1     *****   S01194
     C*****      RECI      ORNE 'D'                        *1     *****   S01194
     C**                                                                  LN0637
     C***Access*MIDAS*Modules*details*via*access*program***********LN0637 CAC001
      ***(database*error*handling*done*in*access*program)**********LN0637 CAC001
     C***********          CALL 'AOMMODR0'                         LN0637 CAC001
     C***********          PARM '*DBERR ' @RTCD   7                LN0637 CAC001
     C***********          PARM '*FIRST ' @OPTN   7                LN0637 CAC001
     C***********SDMMOD    PARM SDMMOD    DSFDY                    LN0637 CAC001
      *                                                                   LN0637
032  C* CALL ACCESS PROG. FOR RETAIL DETAILS.                             S01194
     C           BGRTBN    IFEQ 'Y'                                       E47225
     C           BGIOAC    OREQ 'Y'                                       E47225
     C                     CALL 'AORETLR0'                                S01194
     C                     PARM '*DBERR ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDRETL    PARM SDRETL    DSFDY                           S01194
032  C*                                                                   S01194
     C**  Check for data base error.                                      S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVE '1'       *INU7            *1
     C                     MOVE '1'       *INU8            ***************
     C*****                MOVEL'FDICDRLL'DBFILE           **DBERROR*014**S01194
     C                     MOVEL'SDRETLPD'DBFILE           * DBERROR 014 *S01194
     C*****                MOVEL@KEY      DBKEY            ************   S01194
     C                     MOVEL'*FIRST ' DBKEY  29        ***************S01194
     C                     MOVE '014'     DBASE            *1
     C                     MOVE '1'       *INLR            *1
     C                     MOVE '1'       *INKC            *1
     C*
     C                     EXSR #C                         *1
     C                     END                             E1
     C                     END                                            E47225
      *                                                                   CEU003
      ** Determine if SAR CEU003 EMU Dealing Settlement Ccy Conversion    CEU003
      ** is installed.                                                    CEU003
      *                                                                   CEU003
     C                     CALL 'AOSARDR0'                                CEU003
     C                     PARM *BLANKS   P@RTCD  7                       CEU003
     C                     PARM '*KEY   ' P@OPTN  7                       CEU003
     C                     PARM 'CEU003'  P@SARD  6                       CEU003
     C           SCSARD    PARM SCSARD    DSFDY                           CEU003
     C           P@RTCD    IFEQ *BLANKS                                   CEU003
     C                     MOVE 'Y'       CEU003  1                       CEU003
     C                     ELSE                                           CEU003
     C                     MOVE 'N'       CEU003                          CEU003
      *                                                                   CEU003
     C           P@RTCD    IFNE '*NRF   '                                 CEU003
     C                     MOVEL'SDSARDPD'DBFILE                          CEU003
     C                     MOVEL'CEU003 ' DBKEY                           CEU003
     C                     MOVE '20'      DBASE                           CEU003
     C                     MOVE '1'       *INLR                           CEU003
     C                     MOVE '1'       *INKC                           CEU003
     C                     MOVE '1'       *INU7                           CEU003
     C                     MOVE '1'       *INU8                           CEU003
      *                                                                   CEU003
     C                     EXSR #C                                        CEU003
     C                     ENDIF                                          CEU003
      *                                                                   CEU003
     C                     ENDIF                                          CEU003
     C*
     C****Read the first and only record on MMSSTSLL.                     E22161
     C***********1         CHAINMMSSTSLL             60                   E22161
     C***********                                                         E22161
     C****If*no*valid record found then it is a data base error.          E22161
     C************IN60     IFEQ '1'                        B1             E22161
     C***********H1DLTF    OREQ '*'                        X1             E22161
     C***********          MOVE '1'       *INU7            *1             E22161
     C***********          MOVE '1'       *INU8            ***************E22161
     C***********          MOVEL'MMSSTSLL'DBFILE           * DBERROR 015 *E22161
     C***********          MOVEL*BLANKS   DBKEY            ***************E22161
     C***********          MOVE '015'     DBASE            *1             E22161
     C***********          MOVE '1'       *INLR            *1             E22161
     C***********          MOVE '1'       *INKC            *1             E22161
     C***********                                                         E22161
     C***********          EXSR #C                         *1             E22161
     C***********          END                             E1             E22161
     C*
     C****Read*the*first*and*only*record*on*MMUAUTLL.*********************S01319
     C***********1*********CHAINMMUAUTLL*************60*******************S01319
     C********************************************************************S01319
     C****If*no*valid*record*found*then*it*is*a*data*base*error.**********S01319
     C************IN60*****IFEQ*'1'************************B1*************S01319
     C***********IPDLTF****OREQ*'*'************************X1*************S01319
     C*********************MOVE*'1'********INU7*************1*************S01319
     C*********************MOVE*'1'********INU8***************************S01319
     C*********************MOVEL'MMUAUTLL'DBFILE*************DBERROR*016**S01319
     C*********************MOVEL*BLANKS***DBKEY***************************S01319
     C*********************MOVE*'016'*****DBASE*************1*************S01319
     C*********************MOVE*'1'********INLR*************1*************S01319
     C*********************MOVE*'1'********INKC*************1*************S01319
     C********************************************************************S01319
     C*********************EXSR*#C**************************1*************S01319
     C*********************END*****************************E1*************S01319
     C********************************************************************S01319
     C****Get the user id from PSDS and use this to chain to the          E18139
     C****user details.                                                   E18139
     C******               MOVEL@USER     @USRKY  3                       E18139
     C******     @USRKY    CHAINMMUSERLL             60                   E18139
     C******                                                              E18139
     C****If the user is not on file treat user as if they are            E18139
     C****not a Settlement Officer or Authorization Officer               E18139
     C******     *IN60     IFEQ '1'                        B1             E18139
     C******     IQDLTF    ORNE *BLANKS                    *1             E18139
     C******               MOVE 'N'       IQMMSO           *1             E18139
     C******               MOVE 'N'       IQMMAO           *1             E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C****Set up Action Code text for screen.                             E18139
     C******                                                              E18139
     C****If the user is a settlement officer and not an authorization    E18139
     C****officer.                                                        E18139
     C******     IQMMSO    IFEQ 'Y'                        B1             E18139
     C******     IQMMAO    ANDEQ'N'                        *1             E18139
     C******               MOVEL'(I,A'    DDLIST           *1             E18139
     C******               MOVE ',D,E, )' DDLIST           *1             E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C****If the user is an authorization officer and not a settlements   E18139
     C****officer.                                                        E18139
     C******     IQMMSO    IFEQ 'N'                        B1             E18139
     C******     IQMMAO    ANDEQ'Y'                        *1             E18139
     C******               MOVEL'( , '    DDLIST           *1             E18139
     C******               MOVE ', ,E,X)' DDLIST           *1             E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C****If the user is an authorization officer and a settlements       E18139
     C****officer.                                                        E18139
     C******     IQMMSO    IFEQ 'Y'                        B1             E18139
     C******     IQMMAO    ANDEQ'Y'                        *1             E18139
     C******               MOVEL'(I,A'    DDLIST           *1             E18139
     C******               MOVE ',D,E,X)' DDLIST           *1             E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C****If the user is neither an authorization or settlements          E18139
     C****officer.                                                        E18139
     C******     IQMMSO    IFEQ 'N'                        B1             E18139
     C******     IQMMAO    ANDEQ'N'                        *1             E18139
     C******               MOVEL'( , '    DDLIST           *1             E18139
     C******               MOVE ', ,E, )' DDLIST           *1             E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C****If the back office authorization is not required, omit type     E18139
     C****X.                                                              E18139
     C***********H1BOAR****IFEQ*'N'************************B1*******E18139S01319
     C******     BNMMAU    IFEQ 'N'                        B1             S01319
     C******               MOVE ' )'      DDLIST           *1             E18139
     C******               END                             E1             E18139
     C******                                                              E18139
     C** Set up settlement screen parameters from standing files:         S01177
     C*                                                                   S01177
     C**   Retail present indicator                                       S01177
     C*****                TESTB'7'       MODI2          65       S01177  S01194
     C*****      *IN65     IFEQ '1'                               S01177  S01194
     C           BGRTBN    IFEQ 'Y'                                       S01194
     C           BGIOAC    OREQ 'Y'                                       E23406
     C                     MOVE 'Y'       PMRETP                          S01177
     C                     ELSE                                           S01177
     C                     MOVE 'N'       PMRETP                          S01177
     C                     END                                            S01177
     C*                                                                   S01177
     C**   Retail account numbers supported                               S01177
     C*****                MOVE RACN      PMRETS                  S01177  S01194
     C                     MOVE BMRANR    PMRETS                          S01194
     C*                                                                   S01177
     C**   Prime current a/c code                                         S01177
     C*****                Z-ADDCADC      PMPCYA                  S01177  S01194
     C                     MOVE BMACCD    PMPCYA                          S01194
     C*                                                                   S01177
     C**   Chips module indicators                                        S01177
     C*****                MOVE CHIM      PMCHIM                  S01177  S01194
     C                     MOVE BGCHDL    PMCHIM                          S01194
     C*                                                                   S01177
     C**   Back value period                                              S01177
     C*****                Z-ADDBVLP      PMBVPD                  S01177  S01194
     C                     Z-ADDBJBVPD    PMBVPD                          S01194
     C*                                                                   S01177
     C**   Run date in midas day no. format                               S01177
     C*****                Z-ADDRUND      PMRUND                  S01177  S01194
     C                     Z-ADDBJRDNB    PMRUND                          S01194
     C*                                                                   S01177
     C*
     C**  Close single record files.
     C*****                CLOSEFDICDRLL
     C*****                CLOSEFXTB40LL
     C*********************CLOSEFDINSTLL**********************************S01319
     C*********************CLOSEMMSSTSLL**********************************S01319
     C*********************CLOSEMMUAUTLL**********************************S01319
     C*********************CLOSEMMUSERLL**********************************S01319
     C*
     C**  Set up key sub-fields which are constant.
     C**********           MOVE 'P'       @NSP                            E13747
     C*********************MOVE*'A'*******@RCDT***************************S01319
     C*
     C/COPY WNCPYSRC,MM0028C125
     C           #A8       TAG                             **#A8**
     C*
     C****Attempt*to*add*member*to*MMSTDDPP*+*LL.****                     DT0010
     C***********          CALL 'MM0031'                                  DT0010
     C***********          PARM           @TERM                           DT0010
     C***********@TERM     IFEQ 'E'                        B1             DT0010
     C***********          MOVE '1'       *INKC            *1             DT0010
     C***********          GOTO #A9                        *1             DT0010
     C***********          END                             E1             DT0010
     C*
     C***Override*Standard*Deal*to*correct*member.************************S01319
     C*********************MOVEL@USER*****@CUID***************************S01319
     C*********************MOVE*@JOBNO****@CJON***************************S01319
     C*********************MOVE*')'*******@CEND***************************S01319
     C****E15515*-*Remove*any*embeded*BLANKS*in*@CMDV***************E15515S01319
     C*********************Z-ADD1*********@Y******20****************E15515S01319
     C*********************MOVEA*BLANKS***@EA***********************E15515S01319
     C*********************MOVEA*BLANKS***@IA***********************E15515S01319
     C*********************MOVEA@CMDV*****@IA***********************E15515S01319
     C***********1*********DO***10********@I******20****************E15515S01319
     C***********@IA,@I****IFNE*'*'*********************************E15515S01319
     C*********************MOVE*@IA,@I****@EA,@Y********************E15515S01319
     C*********************ADD**1*********@Y************************E15515S01319
     C*********************END**************************************E15515S01319
     C*********************END**************************************E15515S01319
     C*********************MOVEA@EA*******@CMDV*********************E15515S01319
     C*********************MOVE*@CMDV*****@CMD,1**************************S01319
     C*********************Z-ADD30********@LNTH***************************S01319
     C********************************************************************S01319
     C*********************CALL*'QCAEXEC'*********************************E20774
     C*********************CALL*'QCMDEXC'***************************E20774S01319
     C*********************PARM***********@CMD,1**************************S01319
     C*********************PARM***********@LNTH**155**********************S01319
     C*
     C/COPY WNCPYSRC,MM0028C080
     C           #A9       ENDSR                           **#A9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*          #C       -  Final processing                         *
     C*                                                               *
     C* CALLED BY  MAIN     -  Controls main processing               *
     C*                                                               *
     C* FLDS USED  @TERM  -  Termination parameter                    *
     C*            @ERR   -  Error parameter                          *
     C*            @NOPMS -  Number of parameters passed to program   *
     C*            @TERM1 -  Termination parameter                    *
     C*                                                               *
     C*****************************************************************
     C           #C        BEGSR
     C*
     C**  Call screen 2 with termination parameter to close programs      S01177
     C                     MOVE 'T'       PMTERM                          S01177
     C*****                CALL 'SDKTPVR'                          S01177 E214
     C/COPY WNCPYSRC,MM0028C007
     C                     CALL 'SD2400'                                  E214
     C                     PARM           @PARM1                          S01177
     C                     PARM           @PARM2                          S01177
     C                     PARM           @PARM3                          S01177
     C                     PARM           DDDLNO                          BHF488
     C                     PARM           WDUMMY                          CEU003
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CSFI                                           S01408
     C*                                                                   S01408
     C*                                                                   S01177
     C**  Terminate program unless program called from range
     C**  authorisation.
     C           @TERM     IFNE 'E'                        B1
     C           @NOPMS    ANDNE5                          B1
     C           @TERM1    OREQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028C063
     C*
     C**  If U7 or U8 are on, and the program was called from the
     C**  range authorisation program, then set on *INLR.
     C           *INU7     IFEQ '1'                        B1
     C           @TERM1    ANDNE'T'                        B1
     C           @TERM     OREQ 'E'                        B1
     C           @TERM1    ANDNE'T'                        B1
     C                     MOVE 'E'       @TERM1           *1
     C                     END                             E1
     C/COPY WNCPYSRC,MM0028C126
     C*
     C           *INU7     IFEQ '1'                        B1             E16041
     C                     DUMP                            *1             E16041
     C                     END                             E1             E16041
     C*
     C                     RETRN
     C*
     C           #C9       ENDSR                           **#C9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*      INFSR    - error checking sr for update files            *
     C*                                                               *
     C* CALLS    ZA0250   - Clears message queue.                     *
     C*          ZA0440   - Send message with data.                   *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @DLKEY - Deal key                                  *
     C*            @DSPY  - Year from screen field : value date       *
     C*            @DSPM  - Month frm screen field : value date       *
     C*            @DSPD  - Year from screen field : value date       *
     C*            @VDYY  - Value date : year                         *
     C*            @VDMM  - Value date : month                        *
     C*            @VDDD  - Value date : day                          *
     C*            @KVALD - Key field  : value date                   *
     C*            @KSEQN - Sequence number key field                 *
     C*            @DMKEY - Key to deams file                         *
     C*            @VYEAR - Year numeric field                        *
     C*            @DATA  - Data passed to ZA0440                     *
     C*            @MSGID - message id                                *
     C*                                                               *
     C*****************************************************************
     C           INFSR     BEGSR
     C*
     C           STATUS    IFEQ 01021                      B1
     C*
     C**  Chain to the file using the key, to see if it already exists.
     C**  - *IN72 set on if the record is not found.
     C*
     C**  Chain to the file using the key.
     C**  - *IN72 set on if the record is not found.
     C***********          MOVE DDDLNO    @DLKEY           *1             S01354
     C*
     C** Load value date to numeric keyfield,in YYYYMMDD format
     C                     Z-ADD0         @KVALD           *1
     C                     MOVE @DSPY     @VYEAR           *1
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPD     @VDDD            *1
     C                     ELSE                                           BHF183
     C                     MOVE @DSPD     @VDMM                           BHF183
     C                     END                                            BHF183
     C           BJDFIN    IFEQ 'D'                                       BHF183
     C                     MOVE @DSPM     @VDMM            *1
     C                     ELSE                                           BHF183
     C                     MOVE @DSPM     @VDDD                           BHF183
     C                     END                                            BHF183
     C*
     C** Century
     C           @VYEAR    IFGE 72                         B*2
     C           @VDYY     ADD  1900      @VDYY            **2
     C                     ELSE                            X*2
     C           @VDYY     ADD  2000      @VDYY            **2
     C                     END                             E*2
     C                     MOVE DDDS38    @KSEQN  30       *1
     C           @DMKEY    CHAINMMDAMULL             7279  *1
     C*
     C**  If *IN72 is not on a valid record
     C**  exists on file.
     C           *IN72     IFEQ '0'                        B*2
     C*
     C**  Clear program message queue.
     C                     CALL 'ZA0250'                   **2
     C                     ROLBK                           **2
     C*
     C** Send message - 'Record inserted by another workstation.'
     C                     MOVE *BLANKS   @DATA            *1
     C                     MOVE DDVDAT    @ERVDT           *1
     C                     MOVEL@TXT,2    @DATA1           *1
     C                     MOVEL@DLKEY    @DATA2           *1             S01354
     C                     MOVE @DMDTA    @DATA            *1
     C                     MOVEL'MMM1015' @MSGID           **2
     C                     CALL 'ZA0440'                   **2
     C                     PARM           @MSGID           **2
     C                     PARM           @DATA            **2
     C*
     C**  Set up screen and work fields with newly changed values (i.e.
     C**  from chain to update file).
     C                     EXSR #ZD                        *1
     C                     MOVE 'E'       DDACTN           *1
     C                     Z-ADD01021     STATUS           *1
     C                     MOVE '*DETC '  EXTTAG           **2
     C                     ELSE                            X*2
     C                     MOVE '*CANCL'  EXTTAG  6        **2
     C                     DUMP                            **2
     C                     END                             E*2
     C                     ELSE                            X1
     C                     MOVE '*CANCL'  EXTTAG  6        *1
     C                     DUMP                            *1
     C                     END                             E1
     C*
     C           INFSR9    ENDSREXTTAG                     **INFSR9**
      /EJECT
     C*****************************************************************   S01194
     C*****                                                       *****   S01194
     C*****   SUBROUTINE ZA0150 - THIS SUBROUTINE CHAINS TO FILE L*****   S01194
     C*****   FDICDRLL TO GET THE INSTALLATION CONTROL DETAILS REC*****   S01194
     C*****   1 (HELD ON PF/TABTB10)                              *****   S01194
     C*****   INDICATOR 80 IS SET ON IF THE CHAIN FAILS OR THE REC*****   S01194
     C*****   IS FLAGGED FOR DELETION.                            *****   S01194
     C*****   IF INDICATOR 80 IS SET ON DETAILS OF THE ATTEMPTED  *****   S01194
     C*****   ACCESS ARE PLACED IN THE LDA.                       *****   S01194
     C*****                                                       *****   S01194
     C*****   FIELDS USED : SS0150 - KEY USED TO ACCESS FDICDRLL  *****   S01194
     C*****                                                       *****   S01194
     C*****************************************************************   S01194
     C*****                                                       *****   S01194
     C*****      ZA0150    BEGSR                                  *****   S01194
     C*****                                                       *****   S01194
     C***SET UP KEY TO OBTAIN FORMAT TABTB10F '01        10'      *****   S01194
     C*****                MOVEL'01'      SS0150 12               *****   S01194
     C*****                MOVE '10'      SS0150                  *****   S01194
     C*****                                                       *****   S01194
     C***CHAIN TO FILE FDICDRLL                                   *****   S01194
     C*****      SS0150    CHAINFDICDRLL             80           *****   S01194
     C*****      RECI      IFNE 'D'                        B1     *****   S01194
     C*****                MOVE '1'       *IN80            *1     *****   S01194
     C*****                END                             E1     *****   S01194
     C*****                                                       *****   S01194
     C***DEAL WITH DATA BASE ERROR                                *****   S01194
     C*****      *IN80     IFEQ '1'                        ************   S01194
     C*****                MOVEL'FDICDRLL'DBFILE           *      *****   S01194
     C*****                MOVEL'900'     DBASE            * DBERROR 900**S01194
     C*****                MOVELSS0150    DBKEY            *      *****   S01194
     C*****                END                             ************   S01194
     C*****                                                       *****   S01194
     C*****      ZA0159    ENDSR                            ZA0159*****   S01194
     C*****************************************************************   S01194
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* *PSSR    - error handling SR                                  *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C           #PSSR9    ENDSR                            **PSSR9**
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #AB      - KLIST/PLIST,workfield definitions.                 *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -   None                                    *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           #AB       BEGSR
     C*
     C**  Parameters passed into the program
     C           *ENTRY    PLIST
     C                     PARM           @TERM1  1
     C                     PARM           @RDLN   60
     C                     PARM           @RVDT   80
     C                     PARM           @RSQN   30
     C                     PARM           @ERR    1
     C/COPY WNCPYSRC,MM0028C008
     C*
     C** Deam key fields
     C           @DMKEY    KLIST
     C                     KFLD           @DLKEY
     C                     KFLD           @VDYY
     C                     KFLD           @VDMM
     C                     KFLD           @VDDD
     C                     KFLD           @KSEQN
     C*
     C           @DMKY2    KLIST
     C                     KFLD           @DLKEY
     C                     KFLD           @VLY
     C                     KFLD           @VLM
     C                     KFLD           @VLD
     C                     KFLD           @SQ
     C*
     C*
     C**  Key lists.
     C*****      @CLTKY    KLIST                                  *****   S01194
     C*****                KFLD           @CNUM   60              *****   S01194
     C*****                KFLD           @RCDT   1               *****   S01194
     C***********@CYKEY****KLIST******************************************S01319
     C*********************KFLD***********@CYCNM**60**********************S01319
     C*********************KFLD***********@CYCCY**3***********************S01319
     C*********************KFLD***********@CTTP***2*****************E13747S01319
     C********** @NSKEY    KLIST                                          E13747
     C**********           KFLD           @NSCNO 10                       E13747
     C**********           KFLD           @NSCCY  3                       E13747
     C**********           KFLD           @NSP    1                       E13747
     C********** @NSPKY    KLIST                                          E13747
     C**********           KFLD           @NSCNO                          E13747
     C**********           KFLD           @NSCCY                          E13747
     C***********@ACKEY****KLIST******************************************S01319
     C*********************KFLD***********@ACCNM**60**********************S01319
     C*********************KFLD***********@ACCCY**3***********************S01319
     C*********************KFLD***********@ACCDE**40**********************S01319
     C*********************KFLD***********@ACSEQ**20**********************S01319
     C********** @SNKEY    KLIST                                          E13747
     C**********           KFLD           @SNNM1  7                       E13747
     C**********           KFLD           @SNNM2  3                       E13747
     C*
     C**  Define program work fields with reference to file fields.
     C************LIKE*****DEFN*@CLTDS****@CLTKY********************S01194S01319
     C           *LIKE     DEFN DDACTN    @ACTN
     C           *LIKE     DEFN DDDLNO    @DLNO
     C           *LIKE     DEFN DDMTYP    @MTYP
     C           *LIKE     DEFN DDCSNM    @CSNM
     C           *LIKE     DEFN DDVDAT    @VDAT
     C           *LIKE     DEFN DDDS38    @DS38
     C           *LIKE     DEFN DDCCY     @CCY
     C           *LIKE     DEFN DDAMNP    @AMNP
     C           *LIKE     DEFN DDINTR    @INTR
     C           *LIKE     DEFN DDFSRP    @FSRP                           CAC001
     C           *LIKE     DEFN DDCPTY    @CPTY                           S01184
     C           *LIKE     DEFN DDBROK    @BROK                           S01184
     C           *LIKE     DEFN DDTEXT    @TEXT                           S01184
     C/COPY WNCPYSRC,MM0028CP60                                           S01408
     C*****      *LIKE     DEFN DDORCM    @ORCM                           S01177
     C*****      *LIKE     DEFN DDMORI    @MORI                           S01177
     C*****      *LIKE     DEFN DDMCPI    @MCPI                           S01177
     C*****      *LIKE     DEFN DDMFAO    @MFAO                           S01177
     C*****      *LIKE     DEFN DDSPEC    @SPEC                           S01177
     C           *LIKE     DEFN PMRSTM    @RSTM                           S01177
     C           *LIKE     DEFN PMRONS    @RONS                           S01177
     C           *LIKE     DEFN PARIBN    @RIBN                           S01177
     C           *LIKE     DEFN PMRIBA    @RIBA                           S01177
     C           *LIKE     DEFN PAROBN    @ROBN                           S01177
     C           *LIKE     DEFN PAROCN    @ROCN                           S01177
     C           *LIKE     DEFN PMPSTM    @PSTM                           S01177
     C           *LIKE     DEFN PMPONS    @PONS                           S01177
     C           *LIKE     DEFN PAPIBN    @PIBN                           S01177
     C           *LIKE     DEFN PMPIBA    @PIBA                           S01177
     C           *LIKE     DEFN PAPOBN    @POBN                           S01177
     C           *LIKE     DEFN PAPOCN    @POCN                           S01177
     C           *LIKE     DEFN PARCRN    @RCRN                           S01177
     C           *LIKE     DEFN PMRCRA    @RCRA                           S01177
     C           *LIKE     DEFN PARVNO    @RVNO                           S01177
     C           *LIKE     DEFN PAAWBN    @AWBN                           S01177
     C           *LIKE     DEFN PMAWBA    @AWBA                           S01177
     C           *LIKE     DEFN PABENN    @BENN                           S01177
     C           *LIKE     DEFN PMBENA    @BENA                           S01177
     C           *LIKE     DEFN PMDTP1    @DTP1                           S01177
     C           *LIKE     DEFN PMDTP1    @DTP2                           S01177
     C           *LIKE     DEFN PMDTP1    @DTP3                           S01177
     C           *LIKE     DEFN PMDTP1    @DTP4                           S01177
     C           *LIKE     DEFN PMDCHG    @DCHG                           S01177
     C           *LIKE     DEFN PMBTB1    @BTB1                           S01177
     C           *LIKE     DEFN PMBTB1    @BTB2                           S01177
     C           *LIKE     DEFN PMBTB1    @BTB3                           S01177
     C           *LIKE     DEFN PMBTB1    @BTB4                           S01177
     C           *LIKE     DEFN PMBTB1    @BTB5                           S01177
     C           *LIKE     DEFN PMBTB1    @BTB6                           S01177
     C           *LIKE     DEFN PMCVMR    @CVMR                           E22405
     C           *LIKE     DEFN PMROBR    @ROBR                           LN0822
     C           *LIKE     DEFN PMPOBR    @POBR                           LN0822
      *                                                                   CEU003
     C           *LIKE     DEFN PMPSCY    @PSCY                           CEU003
     C           *LIKE     DEFN PMRSCY    @RSCY                           CEU003
     C           *LIKE     DEFN PMIC72    @IC72                           CEU003
     C*
     C           #AB9      ENDSR                            **#AB9**
     C*                                                                   S01408
     C/COPY WNCPYSRC,MM0028CEND                                           S01408
     C*
      /EJECT
     OMMDEAMP3E                @RLSFL
      /EJECT
      *****************************************************************   056095
      *   The array @YD and @MD are now being used by SR. ZDATE9      *   056095
      *   before they are being used by SR. ZA0710.  The actual       *   056095
      *   changes were only made on the text, ZA0710 was changed      *   056095
      *   to ZDATE9.                                                  *   056095
      *****************************************************************   056095
      ***** Array holding event date name for use in messages.
      ***** MIDAS Run Date
      ***** Value Date
      ***** Next Interest Date
      ***** Maturity Date
** CPY@   **      OBJECT COPYRIGHT
(c) Finastra International Limited 2001
** @TYP  LOOKUP OF DEAL TYPE                                              S01354
ITTDCIIPTLCLC1C2BOBICTCPDLILID
** @DT2  ARRAY OF POSSIBLE MIDAS DEAL TYPES : MMT0014                     S01354
ITIPTDTICILNCDCLDLC1C2BPBDILID
** TEXT FOR KEY FIELD NAME
Deal no/Val date/Seq no
Dl.amend
** TEXT FOR DEAL STATUS
COMPLETE
AUTHORIZED
REQUIRES REAUTHORIZATION
MATURED
** array of powers of 10 from 0 to 8  @@H
000000000000001
000000000000010
000000000000100
000000000001000
000000000010000
000000000100000
000000001000000
000000010000000
000000100000000
000001000000000
000010000000000
000100000000000
001000000000000
010000000000000
100000000000000
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
** TABA TABB (Counterparty/Broker status AND TEXT)
00NO FEEDBACK YET
01WAITING
02TIMED OUT
50PROPOSED PAIR
51PAIRED ERROR-O
52PAIRED ERROR-T
53PAIRED ERROR-B
54PROPOSED INVEST
97NONE EXPECTED
99PAIRED NO ERROR
** STAMP - Dummy timestamp                                                                    CPK014
0001-01-01-00.00.00.000000                                                                    CPK014
