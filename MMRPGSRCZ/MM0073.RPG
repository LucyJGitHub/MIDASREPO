     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MM Near dates summary')                          *
      ****************************************************************
      *                                                              *
      *  Midas - MM Dealer Module                                     *
      *                                                              *
      *          MM0073 - NEAR DATES SUMMARY                         *
      *                                                              *
      *   Function:   This program updates the Money Market near     *
      *   (I/C)       dates file (MMFNRDPP) and the ccy positions    *
      *               file (MMEPOSPP) during I/C.                    *
      *                                                              *
      *     Called by: MM0078  - Update MM database.                 *
      *                                                              *
      *     Calls    : ZA0270  - Convert date to Midas day number.   *
      *                                                              *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                              *
      *  Last Amend No. MD047993           Date 23Sep17               *
      *  Prev Amend No. MD035545           Date 11Sep15               *
      *                 CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 CDL093             Date 08Apr14               *
      *                 AR996895           Date 25Nov12               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246141             Date 26Mar07               *
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 11Jul06               *
      *                 CSD027             Date 09Dec05               *
      *                 CIR013             Date 25Apr05               *
      *                 CDL038             Date 10May05               *
      *                 CDL033             Date 10Feb05               *
      *                 CDL022             Date 03Feb04               *
      *                 CDL020             Date 03Feb04               *
      *                 CDL019             Date 03Feb04               *
      *                 CDL018             Date 03Feb04               *
      *                 CDL017             Date 03Feb04               *
      *                 CDL016             Date 03Feb04               *
      *                 CGL029             Date 01Sep03               *
      *                 222727             Date 05Nov03               *
      *                 CDL010             Date 02Aug02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CIR004             Date 20Jan00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *               . 163136             Date 07Jul99               *
      *                 CAP002             Date 23Feb98               *
     F*                 126017             DATE 18Nov97               *
     F*                 097885             DATE 03FEB97               *
     F*                 CAC001             Date 01FEB96               *
     F*                 095244             Date 01NOV95               *
     F*                 095238             Date 31OCT95               *
     F*                 S01486             DATE 28OCT93               *
     F*                 056121             DATE 04NOV93               *
     F*                 061426             DATE 30SEP93               *
     F*                 056095             DATE 07JUN93               *
     F*                 S01378             DATE 13APR92               *
     F*                 S01392             DATE 24AUG92               *
      *          AMEND NO. E30588 (BHF949)  DATE   28N0V89           *
      *          AMEND NO. RT0150    DATE   12JUN91                  *
      *          AMEND NO. DT0015    DATE   20MAR91                  *
      *          AMEND NO. S01227    DATE   21NOV89                  *
      *          AMEND NO. S01218    DATE   11/08/89                 *
      *          AMEND NO. S01195    DATE   12/07/89                 *
      *          AMEND NO. S01194    DATE   12/07/89                 *
      *          AMEND NO. E18380    DATE   18/05/89                 *
      *          AMEND NO. E17654    DATE   20/04/89                 *
      *          AMEND NO. E17051    DATE   08/03/89                 *
      *          AMEND NO. E12460    DATE   15/03/88                 *
      *          AMEND NO. S01136    DATE   04/01/88                 *
      *          AMEND NO. S01136    DATE   21/12/87                 *
      ****************************************************************
     F*                                                              *
      *  MD047993 - Modified MD035545. Removed dependency on Accrue   *
      *             on Last Day indicator.                            *
      *  MD035545 - LE: Interest Calculation in Leap year. Consider   *
      *             Accrue on Last Day Indicator for method 6.        *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CDL093 - MM Interest calculation type 9.                     *
      *  AR996895 - Incorrect accrual interest calculation            *
      *             (Child:AR996897) (Recompile)                      *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *           to Midas Plus                                       *
      *  246141 - Recompiled due to changes in ZINTDYZ2               *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over ZINTDY.                              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CDL033 - Floating Rate CDs Issued                            *
      *  CDL022 - Deal Amendment Changes (Recompile)                  *
      *  CDL020 - Apply Base Rate at Value Date (Recompile)           *
      *  CDL019 - Allow Base Rate Changes on Fixed Deposits/Loans     *
      *           (Recompile)                                         *
      *  CDL018 - Multiple Settlement Accounts on Loans/Deposits      *
      *           (Recompile)                                         *
      *  CDL017 - Penalty Fee & Early Maturity of Fixed Term Loan/Dep *
      *           (Recompile)                                         *
      *  CDL016 - Automatic rollover of Fixed Term Loans/Deposits     *
      *           (Recompile)                                         *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222727 - Release 5.0 errors  (Recompile)                     *
     F*  CDL010 - Prevent last user that actioned the trade from      *
     F*           authorising it.Recompile due to changes in MMDEAMPP *
     F*           , MMDELDPP, MMDENBPP AND MMDENSPP.                  *
      *  CIR004 - Dealing Calculation Method Change                   *
      *         - Recompiled due to ZINTDY changes                    *
     F*  163136 - Interest Calculation Method '6'  showing incorrect -*
     F*           ZERO - amount . Addition to Core #126017 which dealt*
     F*           with the issue. It introduced an additional  INT6DY *
     F*           field in s-routine ZINTDY in  /COPY ZSRSRC/ZINTDYZ2 *
     F*           which in turn is usually called from GLINTC s-routine
     F*           in /COPY  ZSRSRC/ GLINTCZ1 .  However, there are at *
     F*           least a dozen other pgms that use ZINTDY but do     *
     F*           GLINTC-processing within the pgms calculation specs *
     F*  CAP002 - Changed as part of the MM APIs creation to          *
     F*           switch *INU7 and *INU8 of before they are used.     *
     F*           They are used for internal communication
     F*           within this program, but in some circumstances
     F*           they can be on before this program starts, so       *
     F*           error conditions can be incorrectly reported.       *
     F*  126017 - Correction to interest calculation for calculation  *
     F*           basis 6 in SR/GLINTC - recompile program.           *
     F*  097885 - Recompiled for wrong calculation of number of day   *
     F*           interest (ZINTDYZ2).                                *
     F*  CAC001 - Profit Centre Accounting Development:               *
     F*           Recompiled only.                                    *
     F*  095244 - Recompiled for Calculation method 3                 *
     F*  095238 - Recompiled for Calculation method 3                 *
     F*  S01486 - Portfolio Management Upgrade to Release 10.         *
     F*           Recompile Only.                                     *
     F*  056121 - Increase size of work field to enable correct       *
     F*           calculation of interest on very large amounts.      *
     F*           (Similar to fix 049499 of MM0089 in MRSLIB1005)     *
      *  061426 - Recompile after ZDATE9 correction                  *
     F*  056095 - Interest not calculated consistently in MM.         *
     F*           SR. MM1009 was externally defined as ZINTDY,        *
     F*           while SR. ZA0710 and ZA0680 were replaced by        *
     F*           the externally defined standard SR. ZDATE9 and      *
     F*           ZDAT10, respectively.  Seventeen MM programs        *
     F*           were amended.                                       *
      *     S01378 - Facilitates the partial sale of a parcel        *
      *              of negotiable instruments which have been       *
      *              previously input to the system as a single      *
      *              transaction (was MOF53). Recompile over new     *
      *              standard deal entry parameter format AND for    *
      *              parcelled sales must consider partial sales.    *
      *     S01392 - JAP.SUB-MODULE INCORPORATION (CORE)             *
      *              a) Front-Up Interest - interest added/deducted  *
      *                 at value date rather than maturity.          *
      *              b) Interest rounded down (New version of MM1030)*
      *              c) First & Last day interest - int due for every*
      *                 day that deal is live.                       *
      *                                                              *
      *     E30588 - EMERGENCY FIX FOR DIVIDE BY ZERO ERROR          *
      *     RT0150 - RECOMPILE PROGRAM FOR CHANGE IN MMSTDSPP        *
      *                                                              *
      *     DT0015 - RECOMPILED                                      *
      *                                                              *
      *     S01227 - Recompiled for Extended Settlements.            *
      *                                                              *
      *     S01218 - Recompiled to include new file layouts for      *
      *              capital markets dealing interface               *
      *
      *     S01194 - REL. 10  NEW COPYRIGHT STATEMENTS                *
      *              AND NEW STANDING DATA FILES                     *
      *                                                              *
      *     S01195 - NEW HOLIDAY PROCESSING                          *
      *                                                              *
      *     E18380 - Program was recompiled with new formats for the *
      *              standard deal files. This stops the book code   *
      *              and linked reference number fields from being   *
      *              overwritten.                                    *
      *                                                              *
      *     E17654 - Remove validation of locations.                 *
      *                                                              *
      *     E17051 - Use MM1030 for interest calculations since it   *
      *              is more accurate than MM1007.                   *
      *     E12460 - UPDATE NOSTRO FIGURES ON FILE MMFNRDPP AT       *
      *              START OF DAY                                    *
      *                                                              *
      *     S01136 - 21/12/87 - PGM USES SYSTEM DATES. SHOULD USE    *
      *              DATES FROM PF/TABTB10 (RUND), PGM ALSO USES     *
      *              HARDCODED MONTH SHORTNAMES WHICH SHOULD NOT BE  *
      *              USED                                            *
      *                                                              *
      *                                                              *
      *  S01136-04/01/88-CORRECTION FOR LATER DEAM TESTING           *
      ****************************************************************
      /EJECT
      ****************************************************************
      *
      * ID F  C  H  L    FUNCTION OF INDICATORS
      *
      *       60         ADD TO NOSTRO
      *       76         READ/CHAIN FAIL
      *
      *       U6         PROGRAM ERROR
      *       U7         DATA BASE OR EXCEPTION ERROR
      *       U8         DATA BASE OR EXCEPTION ERROR
      *
      *****************************************************************
      /EJECT
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F/COPY WNCPYSRC,MM0073F002
     F*DTABJLLIF**E**         K        DISK         KINFSR INFSR  ****UC  S01194
     F**FDICDRLLIF**E           K        DISK         KINFSR INFSR   U C  S01194
     F*********** TABTB11F                          KIGNORE               S01194
     F*********** TABTB20F                          KIGNORE               S01194
     F**FDCCYTLLIF**E           K        DISK         KINFSR INFSR   U C  S01194
     FMMLVDMLLIF  E           K        DISK         KINFSR INFSR      UC
     FMMEPOULLUF  E           K        DISK         KINFSR INFSR A    UC
     F                                              KCOMIT
     FMMFNRULLUF  E           K        DISK         KINFSR INFSR A    UC
     F                                              KCOMIT
     F/COPY WNCPYSRC,MM0073F003
     FMMDEALLLIF  E           K        DISK         KINFSR INFSR      UC  S01378
     F/COPY WNCPYSRC,MM0073F001
      /EJECT
     E/COPY ZSRSRC,ZHOLE                                                  S01195
      *
     E                    CPY@    1   1 80                                S01194
      *
      ** Array of period start day numbers.
     E                    @S         10  5 0
      *
      ** Array of period end day numbers.
     E                    @E         10  5 0
      *
      ** Array of number of days in period.
     E                    @P         10  3 0
      *
      ** Array of net balances.
     E                    @A         10 15 0
      *
      ** Array of net interest accrued.
     E                    @I         10 15 0
      *
      ** Array of month names.  *****************************             S01136
     E******************  @M     12  12  3  *****************             S01136
      *
      ****ARRAY*FOR*SR.*ZA0680*-*CUMULATIVE*DAYS*IN*YEAR*FOR*4*YEAR*PERIOD056095
     E***********         @YD     4   4  5 0A                             056095
      *
      ****ARRAY*FOR*SR.*ZA0680*-*CUMULATIVE*DAYS*IN*YEAR*PER*MONTH*****   056095
     E***********         @MD    13  13  5 0A                             056095
     E*                                                                   056095
     E/COPY ZSRSRC,ZDATE9Z1                                               056095
     E**  Array for SR. ZDATE9                                            056095
      *
      ****USED BY SR. ZA0830 - CURRENCY RECORDS                   *****   S01195
     E*****               @CY        50  3                        *****   S01195
      /EJECT
      *
      ** Data structure of standard loan/deposit deal.
     I@STDL     E DSMMSTDLPP
      *
      ** Data structure of standard N/A bought deal.
     I@STDB     E DSMMSTDBPP
     I              QQDORI                          QQDOR1                                    CGL029
     I              QQMORI                          QQMOR1                                    CGL029
     I              QQDOPI                          QQDOP1                                    CGL029
     I              QQMOPI                          QQMOP1                                    CGL029
     I              QQBORI                          QQBOR1                                    CGL029
     I              QQBOPI                          QQBOP1                                    CGL029
     I              QQRONS                          QQRON1                                    CGL029
     I              QQPONS                          QQPON1                                    CGL029
      *
      ** Data structure of standard N/A sold deal.
     I@STDS     E DSMMSTDSPP
     I              QQDORI                          QQDOR2                                    CGL029
     I              QQMORI                          QQMOR2                                    CGL029
     I              QQBORI                          QQBOR2                                    CGL029
     I              QQBOPI                          QQBOP2                                    CGL029
     I              QQRORI                          QQROR2                                    CGL029
     I              QQROPI                          QQROP2                                    CGL029
     I              QQRONS                          QQRON2                                    CGL029
     I              QQPONS                          QQPON2                                    CGL029
      *
      ** Data structure of standard DEAM.
     I@STDA     E DSMMSTDAPP
     I              QQDORI                          QQDOR3                                    CGL029
     I              QQMORI                          QQMOR3                                    CGL029
     I              QQDOPI                          QQDOP3                                    CGL029
     I              QQMOPI                          QQMOP3                                    CGL029
     I              QQBORI                          QQBOR3                                    CGL029
     I              QQBOPI                          QQBOP3                                    CGL029
     I              QQRORI                          QQROR3                                    CGL029
     I              QQROPI                          QQROP3                                    CGL029
     I              QQPONS                          QQPON3                                    CGL029
     I              QQRONS                          QQRON3                                    CGL029
      *
      ** Define arrays across MMFNRULL & MMEPOULL fields.
     I            DS
      ** Net balances.
     I                                        1 150 @A
     I                                        1  150HRNBTD
     I                                       16  300HRNBD1
     I                                       31  450HRNBD2
     I                                       46  600HRNBD3
     I                                       61  750HRNBD4
     I                                       76  900HRNBW1
     I                                       91 1050HRNBM1
     I                                      106 1200HRNBM2
     I                                      121 1350HRNBM3
     I                                      136 1500H2NBSP
      ** Net interest accrued.
     I                                      151 300 @I
     I                                      151 1650HRIATD
     I                                      166 1800HRIAD1
     I                                      181 1950HRIAD2
     I                                      196 2100HRIAD3
     I                                      211 2250HRIAD4
     I                                      226 2400HRIAW1
     I                                      241 2550HRIAM1
     I                                      256 2700HRIAM2
     I                                      271 2850HRIAM3
     I                                      286 3000H2NIAS
      ** Number of days in period.
     I                                      301 330 @P
     I                                      301 3030HRDPTD
     I                                      304 3060HRDPD1
     I                                      307 3090HRDPD2
     I                                      310 3120HRDPD3
     I                                      313 3150HRDPD4
     I                                      316 3180HRDPW1
     I                                      319 3210HRDPM1
     I                                      322 3240HRDPM2
     I                                      325 3270HRDPM3
     I                                      328 3300H2NDPD
     ** Period end dates.
     I                                      331 380 @E
     I                                      331 3350HRPDTD
     I                                      336 3400HRPDD1
     I                                      341 3450HRPDD2
     I                                      346 3500HRPDD3
     I                                      351 3550HRPDD4
     I                                      356 3600HRPDW1
     I                                      361 3650HRPDM1
     I                                      366 3700HRPDM2
     I                                      371 3750HRPDM3
     I                                      376 3800H2SPPD
      *
      **  Data structure to concatenate dates.
     I            DS
     I                                        1   80@VDAT
     I                                        1   40@VDYY
     I                                        5   60@VDMM
     I                                        7   80@VDDD
     I                                        9  160@MDAT
     I                                        9  120@MDYY
     I                                       13  140@MDMM
     I                                       15  160@MDDD
     I                                       17  240@NIDT
     I                                       17  200@NIYY
     I                                       21  220@NIMM
     I                                       23  240@NIDD
     I                                       25  320@SLDT
     I                                       25  280@SLYY
     I                                       29  300@SLMM
     I                                       31  320@SLDD
     I                                       33  400@DMVD
     I                                       33  360HNVDYY
     I                                       37  380HNVDMM
     I                                       39  400HNVDDD
      *
      **  Program status data structure.
     IPSDS       SDS
     I/COPY WNCPYSRC,MM0073I002
     I                                      201 208 @FILE
     I                                      244 253 @JOB
     I                                      254 263 @USER
      *
      **  Local data area for data base error.
     I           UDS
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 183 DBASE
      *
      ****DATA*STRUCTURE*FOR*SR.*ZA0680*-*DATE*INPUT*TO*SUBROUTINE*****   056095
      **  Data structure for date in, to change format.                   056095
     I            DS
     I                                        1   80@@DTIN
     I***********                             1   40@@YYYY                056095
     I                                        3   40@@YY
     I***********                             1   20@@CC                  056095
     I***********                             5   60@@MTH                 056095
     I***********                             7   80@@DAY                 056095
     I                                        5   60@@MM
     I                                        7   80@@DD
     I*                                                                   056095
     I/COPY ZSRSRC,ZDAT10Z1                                               056095
     I**  Data structure for SR. ZDAT10                                   056095
      *
      ****DATA*STRUCTURE*FOR*SR.*ZA0710*-*FIELD*IS*@@Z71Y**************   056095
     I*********** DS                                                      056095
     I***********                             1   40@@Z71Y                056095
     I***********                             1   10@@SSY1                056095
     I***********                             2   20@@SSY2                056095
     I***********                             3   30@@SSY3                056095
     I***********                             4   40@@SSY4                056095
      *
      ****DATA*STRUCTURE*FOR*SR.*ZA0710*-*FIELD*IS*@@VDT***************   056095
     I*********** DS                                                      056095
     I***********                             1   80@@VDT                 056095
     I***********                             1   40@@YR                  056095
     I***********                             5   60@@Z71M                056095
     I***********                             7   80@@Z71D                056095
     I*                                                                   056095
     I/COPY ZSRSRC,ZDATE9Z2                                               056095
     I**  Data structure for SR. ZDATE9                                   056095
      *
      **  DATASTRUCTURE TO CHANGE FORMAT TO MMDDYY / DDMMYY
     I            DS                              6
     I                                        1   60@@DTOU
     I                                        1   20@@DAT1
     I                                        3   40@@DAT2
     I                                        5   60@@YYY
      *
     I*****       DS                                              *****   S01195
     I*****                                   1 150 @CY           *****   S01195
     I*****                                   1  75 @@CY1         *****   S01195
     I*****                                  76 150 @@CY2         *****   S01195
      *
      **  DATA STRUCTURE HOLDING STARTING POINT DATE
     I            DS
     I                                        1   80@@STRT
     I                                        1   40@@STYR
     I                                        5   60@@STMT
     I                                        7   80@@STDY
      *
      **  DATA STRUCTURE HOLDING SPOT DATE
     I            DS
     I                                        1   80@@SPDD
     I                                        1   40@@SPYR
     I                                        5   60@@SPMT
     I                                        7   80@@SPDY
      *
      **  DATA STRUCTURE DAYS FOR DATE FORMAT DDMMYY
     I            DS
     I                                        1   60@@DATE
     I                                        1   20@@DAY2
      *
      ****DATA*STRUCTURE*FOR*SR.*M1009*-*DATE*FIELD*YYYYMMDD***********   056095
     I*********** DS                                                      056095
     I***********                             1   80@@DATA                056095
     I***********                             1   40@@YY1                 056095
     I***********                             5   60@@MM1                 056095
     I***********                             7   80@@DD1                 056095
      *
      ****DATA*STRUCTURE*FOR*SR.*M1009*-*DATE*FIELD*YYYYMMDD***********   056095
     I*********** DS                                                      056095
     I***********                             1   80@@DATB                056095
     I***********                             1   40@@YY2                 056095
     I***********                             5   60@@MM2                 056095
     I***********                             7   80@@DD2                 056095
     I*                                                                   056095
     I/COPY ZSRSRC,ZINTDYZ1                                               056095
     I**  Data Structure for SR. ZINTDY                                   056095
      *                                                                   S01136
      **  DATA STRUCTURE FOR DATE FROM SDBANKPD                           S01136
     I            DS                                                      S01136
     I                                        1   7 RUNA                  S01136
     I                                        1   2 @RUNAD                S01136
     I                                        3   5 @RUNAM                S01136
     I                                        6   7 @RUNAY                S01136
     I*                                                                   S01194
     I              'LECalcBasis6LeapYear'C         WPARML                                  MD035545
     I* DATA STRUCTURES FOR USE WITH ACCESS PROGRAMS                      S01194
     I/COPY WNCPYSRC,MM0073I001
     I*                                                                   S01194
     ISDBANK    E DSSDBANKPD                                              S01194
     I* DATA STRUCTURE FOR BANK DETAILS                                   S01194
     I*                                                                   S01194
     ISDCURR    E DSSDCURRPD                                              S01194
     I* DATA STRUCTURE FOR CURRENCY DETAILS                               S01194
     I*                                                                   S01194
     I***SDGELR*   E DSSDGELRPD                                                    MD035545 MD047993
     I**GENERAL*LEDGER*DETAILS*ACCESSED*VIA*ACCESS*PROGRAM*************            MD035545 MD047993
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   S01117
     IDSSDY     E DSDSSDY                                                 S01194
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE                S01194
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     ISCSARD    E DSSCSARDPD                                                                  CDL033
      /EJECT
     C*****************************************************************
     C/COPY WNCPYSRC,MM0073C130
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* MAIN     - Main Line process                                  *
     C*                                                               *
     C* CALLS    #A       - Initial Processing                        *
     C*          #B       - Control main processing                   *
     C*          #C       - Termination processing                    *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
      *
      **  Initial processing.
     C                     EXSR #A                         *1
      *
      **  Main processing.
     C/COPY WNCPYSRC,MM0073C127
     C                     EXSR #B
     C/COPY WNCPYSRC,MM0073C029
      *
      **  Final processing.
     C                     EXSR #C
      *
      *****************************************************************
     C/EJECT
     C*****************************************************************
     C* SUBROUTINES USED                                              *
     C*                                                               *
     C*  01  #ZA      - Calculate number of days in period            *
     C*  02  #ZB      - Update balance array                          *
     C*  03  #ZC      - Update interest accruals array                *
     C***04**ZA0680***-*Convert*date*format*to*midas*day*number********   056095
     C*  04  ZDAT10   - Convert date format to midas day number       *   056095
     C***05**MM1007***- Calculate interest**********                  *   E17051
     C*  05  MM1030   - Calculate interest                            *   E17051
     C***06**MM1009***-*Calculate*the*number*of*interest*days**********   056095
     C***07**ZA0710***-*Convert*midas*day*no*to*date*format************   056095
     C*  06  ZINTDY   - Calculate the number of interest days         *   056095
     C*  07  ZDATE9   - Convert midas day no to date format           *   056095
     C*  08  #ZD      - Check for change if amendments                *
     C*  09  #B       - Control main processing                       *
     C*  10  #BB      - Initialise period start date array            *
     C*  11  #BC      - Update time loans/deposits balances           *
     C*  12  #BD      - Update CD's Bought Balances                   *
     C*  13  #BE      - Update Bills Bought balances                  *
     C*  14  #BF      - Update CD's Sold Balances                     *
     C*  15  #BG      - Update Bills sold balances                    *
     C*  16  #BH      - Update SI deam balances                       *
     C*  17  #BI      - Update Funds in Nostro at start of day        *
     C*  18  #ZE      - Update NAB's amendments NAS balances          *
     C*  19  #BA      - Initialise new records                        *
     C*  20  ZA0730   - Determine next working day                    *
     C*  21  ZA0770   - Format date field                             *
     C***22**ZA0830***-*Determine if day is a working day         *****   S01195
     C*  23  MM1003   - Calculate period date                         *
     C*  24  #A       - Initial Processing                            *
     C*  25  #C       - Termination processing                        *
     C*  26  *PSSR    - Program error handling subroutine             *
     C*  27  INFSR    - File Exception/error subroutine               *
     C*                                                               *
     C* EXTERNAL ROUTINE                                              *
     C*                                                               *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZA      - Calculate number of days in period                 *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  #ZB    - Update balance array                      *
     C*            #ZC    - Update interest accruals array            *
     C*                                                               *
     C* FLDS USED  @P     - Array to hold number of days in period    *
     C*            @DIPA  - number of active days for deal in period  *
     C*            @SDAT  - Period Start date                         *
     C*            @S     - Array to hold period start dates          *
     C*            @WK50  - work field for active days in period      *
     C*            @EDAT  - Period end date                           *
     C*            @E     - Array to hold period end dates            *
     C*****************************************************************
     C           #ZA       BEGSR
      *
      **  Initialise with number of days in entire period.
     C                     Z-ADD@P,X      @DIPA   30
      *
      **  If start date after period start date, subtract difference.
     C           @SDAT     IFGT @S,X                       B1
     C           @SDAT     SUB  @S,X      @WK50   50       *1
     C           @DIPA     SUB  @WK50     @DIPA            *1
     C                     END                             E1
      *
      **  If end date before period end date, subtract difference.
     C           @EDAT     IFLT @E,X                       B1
     C           @E,X      SUB  @EDAT     @WK50            *1
     C           @DIPA     SUB  @WK50     @DIPA            *1
     C                     END                             E1
      *
     C           #ZA9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZB      - Update balance array                               *
     C*                                                               *
     C* CALLS    #ZA      - Calculate number of days in period        *
     C*                                                               *
     C* CALLED BY  #ZD    - Check for change if amendments            *
     C*            #B     - Control main processing                   *
     C*            #BB    - Initialise period start date array        *
     C*            #BC    - Update time loans/deposits balances       *
     C*            #BD    - Update CD's Bought Balances               *
     C*            #BF    - Update CD's Sold Balances                 *
     C*                                                               *
     C* FLDS USED  @SDAT  - Period Start date                         *
     C*            @E     - Array to hold period end dates            *
     C*            @EDAT  - Period end date                           *
     C*            @S     - Array to hold period start dates          *
     C*            @AMNT  - Work field for amount                     *
     C*            @DIPA  - number of active days for deal in period  *
     C*            @WK150 - Work field for balance                    *
     C*            @P     - Array to hold number of days in period    *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @A     - Array to hold net balances                *
     C*                                                               *
     C*****************************************************************
     C           #ZB       BEGSR
      *
     C                     DO   10        X       30       B1
      *
      **  If deal active in this period...
     C           @SDAT     IFLE @E,X                       B*2
     C           @EDAT     ANDGE@S,X                       X*2
      *
      **  ...calculate number of days active...
     C                     EXSR #ZA                        **2
      *
      **  ...and update balances array.
     C           @AMNT     MULT @DIPA     @WK150 150       **2
     C           @P,X      IFGT 0                                         E30588
     C           @WK150    DIV  @P,X      @WK150    H      **2
     C                     ELSE                                           E30588
     C                     Z-ADD0         @WK150                          E30588
     C                     END                                            E30588
     C           @ADSUB    IFEQ '+'                        B**3
     C                     ADD  @WK150    @A,X             ***3
     C                     ELSE                            X**3
     C                     SUB  @WK150    @A,X             ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #ZB9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZC      - Update interest accruals array                     *
     C*                                                               *
     C* CALLS    #ZA      - Calculate number of days in period        *
     C*                                                               *
     C* CALLED BY  #ZD    - Check for change if amendments            *
     C*            #B     - Control main processing                   *
     C*            #BB    - Initialise period start date array        *
     C*            #BC    - Update time loans/deposits balances       *
     C*                                                               *
     C* FLDS USED  @SDAT  - Period Start date                         *
     C*            @E     - Array to hold period end dates            *
     C*            @EDAT  - Period end date                           *
     C*            @S     - Array to hold period start dates          *
     C*            @CALC  - Work field for interest cal method        *
     C*            @DAYS  - Work field for days in year               *
     C*            @AMNT  - Work field for amount                     *
     C*            @RATE  - work field for interest rate              *
     C*******      @WK155 - Work field for balance                    *   ME2110
     C*            @WK152 - Work field for balance                    *   ME2110
     C*            @DIPA  - number of active days for deal in period  *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @I     - Array for net Interest accrued            *
     C*                                                               *
     C*****************************************************************
     C           #ZC       BEGSR
      *
     C/COPY WNCPYSRC,MM0073C004
     C                     DO   10        X                B1
      *
      **  If deal active in this period...
     C           @SDAT     IFLE @E,X                       B*2
     C           @EDAT     ANDGT@S,X                       X*2
      *                                                                                       CDL093
      ** set Start and End Date for calculation type 9                                        CDL093
      *                                                                                       CDL093
     C           @CALC     IFEQ '9'                                                           CDL093
     C                     Z-ADD@S,X      ZZBEG9  50                                          CDL093
     C           @SDAT     IFGT @S,X                                                          CDL093
     C                     Z-ADD@SDAT     ZZBEG9                                              CDL093
     C                     END                                                                CDL093
      *                                                                                       CDL093
     C                     Z-ADD@E,X      ZZEND9  50                                          CDL093
     C           @EDAT     IFLT @E,X                                                          CDL093
     C                     Z-ADD@EDAT     ZZEND9                                              CDL093
     C                     END                                                                CDL093
      *                                                                                       CDL093
      ** Convert start date to YYYYMMDD format                                                CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZBEG9    @@DAYN  50                                          CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATA  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY1   40                                          CDL093
      *                                                                                       CDL093
      ** Convert end date to YYYYMMDD format                                                  CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZEND9    @@DAYN                                              CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATB  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY2   40                                          CDL093
      *                                                                                       CDL093
     C                     EXSR #FEB29                                                        CDL093
      *                                                                                       CDL093
     C                     ENDIF                                                              CDL093
      *
      **  ...determine divisor dependent on interest calculation method
     C           @CALC     IFEQ '1'                        B**3
     C           @CALC     OREQ '4'                        X**3
     C           @CALC     OREQ '9'                                                           CDL093
     C           #29FEB    ANDNE'Y'                                                           CDL093
     C                     Z-ADD365       @DAYS   30       ***3
     C                     END                             E**3
      *
     C           @CALC     IFEQ '2'                        B**3
     C           @CALC     OREQ '3'                        X**3
     C           @CALC     OREQ '5'                        X**3
     C                     Z-ADD360       @DAYS            ***3
     C                     END                             E**3
      *
     C           @CALC     IFEQ '6'                        B**3
     C           @CALC     OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C                     Z-ADD366       @DAYS            ***3
     C                     END                             E**3
      *
     C/COPY WNCPYSRC,MM0073C032
      **  ...calculate number of days active...
     C                     EXSR #ZA                        **2
      *
      **  ...and update balances array.
     C*******    @AMNT     MULT @RATE     @WK155 155       **2            ME2110
     C*******              DIV  100       @WK155    H      **2            ME2110
     C*******              MULT @DIPA     @WK155           **2            ME2110
     C*******              DIV  @DAYS     @WK155    H      **2            ME2110
     C*******              MULT -1        @WK155           **2            ME2110
     C           @AMNT     MULT @RATE     @WK152 152       **2            ME2110
     C                     MULT @DIPA     @WK152           **2            ME2110
     C                     DIV  @DAYS     @WK152    H      **2            ME2110
     C                     MULT -1        @WK152           **2            ME2110
      *
     C           @ADSUB    IFEQ '+'                        B**3
     C                     ADD  @WK152    @I,X      H      ***3
     C                     ELSE                            X**3
     C                     SUB  @WK152    @I,X      H      ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C/COPY WNCPYSRC,MM0073C005
     C           #ZC9      ENDSR
      *****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDAT10Z2                                               056095
      *******************************************************************
     C***********                                                         056095
     C**ZA0680*-*THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO         056095
     C***********MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)         056095
     C***********                                                         056095
     C**CALLED*BY :                                                       056095
     C***********                                                         056095
     C**CALLS*:**                                                         056095
     C***********                                                         056095
     C**INPUT**:*@@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)   056095
     C***********                                                         056095
     C**OUTPUT*:*@@MDNO MIDAS DAY NUMBER  (SIZE : 5N)                     056095
     C***********                                                         056095
     C**USES*:***@@CC   NUMBER OF CENTURIES IN DATE                       056095
     C***********@@DAY  DAY NUMBER                                        056095
     C***********@@REM  REMAINDER FROM DIVIDE                             056095
     C***********@@MTH  MONTH NUMBER                                      056095
     C***********@MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       MONTH                                             056095
     C***********@@WK2  WORK FIELD (2,0)                                  056095
     C***********@@WK5  WORK FIELD (5,0)                                  056095
     C***********@@YYYY YEAR (4 CHARACTER)                                056095
     C***********@@YY   YEAR (2 CHARACTER)                                056095
     C***********@YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       A FOUR YEAR PERIOD                                056095
     C***********                                                         056095
     C******************************************************************* 056095
     C***********                                                         056095
     C***********ZA0680    BEGSR                                          056095
     C***********                                                         056095
     C****CLEAR*OUT ANY 'OLD' DATA IN FIELD                               056095
     C***********          Z-ADD0         @@MDNO  50                      056095
     C***********                                                         056095
     C***********@@DTIN    CABEQ0         ZA0689                    ME1257056095
     C***********                                                         056095
     C*****IF*DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING          056095
     C*****WORK*OUT THE NUMBER OF CENTURIES PASSED SINCE 1971,            056095
     C*****BY*SUBTRACTING 1972 FROM THE YEAR FIELD.                       056095
     C***********@@YYYY    IFGE 2072                       B1             056095
     C***********@@YYYY    SUB  1972      @@YYYY           *1             056095
     C***********                                                         056095
     C*****MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)             056095
     C*****THEN*RESTORE THE YEAR WHICH WAS INPUT BACK TO THE              056095
     C*****ORIGINAL VALUE BEFORE CONTINUING WITH NORMAL CALCULATIONS.     056095
     C***********                                                         056095
     C***********@@CC      MULT 36524     @@MDNO           *1             056095
     C***********@@YYYY    ADD  1972      @@YYYY           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C***********@@YYYY    ADD  28        @@WK2   20                      056095
     C***********                                                         056095
     C***********@@WK2     DIV  4         @@WK2                           056095
     C***********          MVR            @@REM   10                      056095
     C***********                                                         056095
     C******MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD                056095
     C***********@@WK2     MULT 1461      @@WK5   50                      056095
     C***********          ADD  @@WK5     @@MDNO                          056095
     C***********                                                         056095
     C****CHECK*REMAINDER AND MONTH NUMBER                                056095
     C***********@@REM     IFEQ 0                          B1             056095
     C***********@@MTH     ANDGT2                          B1             056095
     C***********          ADD  1         @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****YEAR*NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR               056095
     C***********@@REM     IFNE 0                          B1             056095
     C***********          ADD  @YD,@@REM @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****ADD*MONTHS THIS YEAR                                            056095
     C***********          ADD  @MD,@@MTH @@MDNO                          056095
     C***********                                                         056095
     C****ADD*DAYS THIS MONTH                                             056095
     C***********          ADD  @@DAY     @@MDNO                          056095
     C***********                                                         056095
     C***********ZA0689    ENDSR                           **ZA0689 TAG** 056095
      *****************************************************************
      /EJECT
      ************************************************************ ME2110 E17051
      ****MM1007*-*CALCULATE INTEREST                              ME2110 E17051
      ***********                                                  ME2110 E17051
      ***CALLED*BY*   -                                            ME2110 E17051
      ***********                                                  ME2110 E17051
      ***CALLS***     -   MM1009 CALCULATE NO. OF INTEREST DAYS    ME2110 E17051
      ***********                                                  ME2110 E17051
      ***FIELDS*INPUT*@@BEG  - START DATE OF PERIOD                ME2110 E17051
      ***********     @@END  - END DATE OF PERIOD                  ME2110 E17051
      ***********     @@CALC - INTEREST CALCULATION METHOD         ME2110 E17051
      ***********     @@AMT  - PRINCIPAL AMOUNT  15N               ME2110 E17051
      ***********     @@RATE - INTEREST RATE 11,7                  ME2110 E17051
      ***********                                                  ME2110 E17051
      ***FIELDS*OUTPUT @@INTR - INTEREST 15,0                      ME2110 E17051
      ***********                                                  ME2110 E17051
      ***WORK*FIELDS   @@W155 - 15,5                               ME2110 E17051
      ***********                                                  ME2110 E17051
      *************************************************************ME2110 E17051
     C********** MM1007    BEGSR                                   ME2110 E17051
      ***********                                                  ME2110 E17051
      ****CALCULATE NUMBER OF INTEREST DAYS                        ME2110 E17051
     C**********           EXSR MM1009                             ME2110 E17051
      ***********                                                  ME2110 E17051
     C********** @@CALC    IFEQ '2'                        *** B 1 ME2110 E17051
     C********** @@CALC    OREQ '3'                                ME2110 E17051
     C********** @@CALC    OREQ '5'                                ME2110 E17051
     C********** @@AMT     DIV  36000     @@W155 155               ME2110 E17051
     C**********           END                             *** E 1 ME2110 E17051
      **********                                                   ME2110 E17051
     C********** @@CALC    IFEQ '1'                        *** B 1 ME2110 E17051
     C********** @@CALC    OREQ '4'                                ME2110 E17051
     C********** @@AMT     DIV  36500     @@W155                   ME2110 E17051
     C**********           END                              *** E 1ME2110 E17051
      **********                                                   ME2110 E17051
     C********** @@CALC    IFEQ '6'                         *** B 1ME2110 E17051
     C********** @@AMT     DIV  36600     @@W155                   ME2110 E17051
     C**********           END                              *** E 1ME2110 E17051
      **********                                                   ME2110 E17051
     C**********           MULT @@RATE    @@W155                   ME2110 E17051
     C********** @@W155    MULT @@INDY    @@INTR 150H              ME2110 E17051
      **********                                                   ME2110 E17051
     C**********           GOTO M10079                             ME2110 E17051
     C**********           Z-ADD0         @@AMT  150               ME2110 E17051
     C**********           Z-ADD0         @@RATE 117               ME2110 E17051
      **********                                                   ME2110 E17051
     C********** M10079    ENDSR                                   ME2110 E17051
      *************************************************************ME2110 E17051
      *************************************************************ME2110 E17051
     C/EJECT                                                              E17051
     C**********************************************************   E17051 S01392
     C****MM1030 - CALCULATE INTEREST                              E17051 S01392
     C******       (MM1030 INCLUDES ADJUSTMENT FOR ERROR IN DIVISIOE17051 S01392
     C******                                                       E17051 S01392
     C***CALLED BY    -                                            E17051 S01392
     C******                                                       E17051 S01392
     C***CALLS        -   MM1009 CALCULATE NO. OF INTEREST DAYS    E17051 S01392
     C******                                                       E17051 S01392
     C***FIELDS INPUT @@BEG  - START DATE OF PERIOD                E17051 S01392
     C******          @@END  - END DATE OF PERIOD                  E17051 S01392
     C******          @@CALC - INTEREST CALCULATION METHOD         E17051 S01392
     C******          @@AMT  - PRINCIPAL AMOUNT  15N               E17051 S01392
     C******          @@RATE - INTEREST RATE 11,7                  E17051 S01392
     C******                                                       E17051 S01392
     C***FIELDS OUTPUT @@INTR - INTEREST 15,0                      E17051 S01392
     C******                                                       E17051 S01392
     C***WORK FIELDS   @@W155 - 15,5                               E17051 S01392
     C******           @@YEAR - (NUMBER OF DAYS IN YEAR) x 100     E17051 S01392
     C******           @@WDIV - 15,5  HOLDS RESULT OF DIVISION     E17051 S01392
     C******           @@ERR  - 15,9  ROUNDING ERROR               E17051 S01392
     C******           @@AMTR - 15,1  AMOUNT FROM ROUNDING ERROR CAE17051 S01392
     C******                    CAN BE 15,1 SINCE IT IS NOT POSSIBLE17051 S01392
     C******                    TO INPUT 15 BYTE FIELDS IN DRS.    E17051 S01392
     C******                                                       E17051 S01392
     C*************************************************************E17051 S01392
     C******     MM1030    BEGSR                                   E17051 S01392
     C******                                                       E17051 S01392
     C****CALCULATE NUMBER OF INTEREST DAYS                        E17051 S01392
     C******               EXSR MM1009                             E17051 S01392
     C******                                                       E17051 S01392
     C******     @@CALC    IFEQ '2'                        *** B 1 E17051 S01392
     C******     @@CALC    OREQ '3'                                E17051 S01392
     C******     @@CALC    OREQ '5'                                E17051 S01392
     C******     @@AMT     DIV  36000     @@WDIV 155               E17051 S01392
     C******               Z-ADD36000     @@YEAR  50               E17051 S01392
     C******               END                             *** E 1 E17051 S01392
     C******                                                       E17051 S01392
     C******     @@CALC    IFEQ '1'                        *** B 1 E17051 S01392
     C******     @@CALC    OREQ '4'                                E17051 S01392
     C******     @@AMT     DIV  36500     @@WDIV                   E17051 S01392
     C******               Z-ADD36500     @@YEAR                   E17051 S01392
     C******               END                              *** E 1E17051 S01392
     C******                                                       E17051 S01392
     C******     @@CALC    IFEQ '6'                         *** B 1E17051 S01392
     C******     @@AMT     DIV  36600     @@WDIV                   E17051 S01392
     C******               Z-ADD36600     @@YEAR                   E17051 S01392
     C******               END                              *** E 1E17051 S01392
     C******                                                       E17051 S01392
     C******     @@WDIV    MULT @@RATE    @@W155 155               E17051 S01392
     C******                                                       E17051 S01392
     C****MULTIPLY @@WDIV BY @@YEAR TO GET ORIGINAL AMOUNT. THE RESE17051 S01392
     C****COULD DIFFER FROM THE ORIGINAL DUE TO ROUNDING ERROR ON  E17051 S01392
     C****DIVISION.                                                E17051 S01392
     C******     @@WDIV    MULT @@YEAR    @@AMTR 151               E17051 S01392
     C******                                                       E17051 S01392
     C****CALCULATE THE ERROR AND DO SAME ARITHMETICAL OPERATIONS AE17051 S01392
     C****@@AMT ABOVE.                                             E17051 S01392
     C******     @@AMT     SUB  @@AMTR    @@ERR  159               E17051 S01392
     C******               MULT @@RATE    @@ERR                    E17051 S01392
     C******               DIV  @@YEAR    @@ERR                    E17051 S01392
     C******                                                       E17051 S01392
     C****ADD RESULT FROM ERROR CALCULATIONS BACK TO THE RESULT FROE17051 S01392
     C****CALCULATIONS ON PRINCIPAL AMOUNT.                        E17051 S01392
     C******               ADD  @@ERR     @@W155                   E17051 S01392
     C******                                                       E17051 S01392
     C****MULTIPLY BY THE PERIOD TO OBTAIN THE INTEREST.           E17051 S01392
     C******     @@W155    MULT @@INDY    @@INTR 150H              E17051 S01392
     C******                                                       E17051 S01392
     C******     M10309    ENDSR                                   E17051 S01392
     C*************************************************************E17051 S01392
      /EJECT
     C*****************************************************************   S01392
     C*                                                               *   S01392
     C*   MM1030 - CALCULATE INTEREST                                 *   S01392
     C*                                                               *   S01392
      *  (c) Misys International Banking Systems Ltd. 2001            *
     C*  CALLED BY    -                                               *   S01392
     C*                                                               *   S01392
     C***CALLS********-***MM1009*CALCULATE*NO.*OF*INTEREST*DAYS*****S01392056095
     C*  CALLS        -   ZINTDY CALCULATE NO. OF INTEREST DAYS       *   056095
     C*                                                               *   S01392
     C***FIELDS*INPUT*@@BEG**-*START*DATE*OF*PERIOD*****************S01392056095
     C****************@@END**-*END*DATE*OF*PERIOD*******************S01392056095
     C****************@@CALC*-*INTEREST*CALCULATION*METHOD**********S01392056095
     C*  FIELDS INPUT ZZBEG  - START DATE OF PERIOD                   *   056095
     C*               ZZEND  - END DATE OF PERIOD                     *   056095
     C*               ZZCALC - INTEREST CALCULATION METHOD            *   056095
     C*               @@AMT  - PRINCIPAL AMOUNT  15N                  *   S01392
     C*               @@RATE - INTEREST RATE 11,7                     *   S01392
     C*               @@RDFC - ROUND DOWN FACILITY IND 1              *   S01392
     C*                                                               *   S01392
     C*  FIELDS OUTPUT @@INTR - INTEREST 15,0                         *   S01392
     C*                                                               *   S01392
     C*  WORK FIELDS   @@W157 - 15,5                                  *   S01392
     C*****************@@W150*-*15,0*******************************S01392 056121
     C*                @@W210 - 21,0                                  *   056121
     C*                @@YEAR - (NUMBER OF DAYS IN YEAR) x 100        *   S01392
     C*                                                               *   S01392
     C*****************************************************************   S01392
     C           MM1030    BEGSR                                          S01392
     C*                                                                   S01392
     C*   CALCULATE NUMBER OF INTEREST DAYS                               S01392
     C/COPY WNCPYSRC,MM0073C001
     C*                                                                   S01392
     C***********          EXSR MM1009                              S01392056095
     C                     Z-ADDZZBEG     ZZBEG9  50                                          CDL093
     C                     Z-ADDZZEND     ZZEND9  50                                          CDL093
      *                                                                                       CDL093
      ** check if 29th Feb is included                                                        CDL093
      *                                                                                       CDL093
     C           ZZCALC    IFEQ '9'                                                           CDL093
      *                                                                                       CDL093
      ** Convert start date to YYYYMMDD format                                                CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZBEG9    @@DAYN  50                                          CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATA  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY1   40                                          CDL093
      *                                                                                       CDL093
      ** Convert end date to YYYYMMDD format                                                  CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZEND9    @@DAYN                                              CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATB  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY2   40                                          CDL093
      *                                                                                       CDL093
     C                     EXSR #FEB29                                                        CDL093
      *                                                                                       CDL093
     C                     ENDIF                                                              CDL093
      *                                                                                       CDL093
     C           ZZCALC    IFEQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C           @NIDT5    ANDNE*ZERO                                                         CDL093
     C           @NIDT5    ANDLTZZEND                                                         CDL093
      *                                                                                       CDL093
     C                     Z-ADDHKIPDM    @@IPDM  20                                          CDL093
     C                     CALL 'MM001031'                                                    CDL093
     C                     PARM           ZZBEG                                               CDL093
     C                     PARM           ZZEND                                               CDL093
     C                     PARM           @NIDT5                                              CDL093
     C                     PARM           ZZCALC                                              CDL093
     C                     PARM           HKIPFQ                                              CDL093
     C                     PARM           @@AMT                                               CDL093
     C                     PARM           @@RATE                                              CDL093
     C                     PARM           HKRDFC                                              CDL093
     C                     PARM           HKFLID                                              CDL093
     C                     PARM           @@IPDM                                              CDL093
     C                     PARM           WINTR                                               CDL093
      *                                                                                       CDL093
     C                     Z-ADDWINTR     @@INTR                                              CDL093
     C           *LIKE     DEFN @@INTR    WINTR                                               CDL093
      *                                                                                       CDL093
     C                     GOTO INTCLC                                                        CDL093
      *                                                                                       CDL093
     C                     ENDIF                                                              CDL093
      *                                                                                       CDL093
     C                     EXSR ZINTDY                                    056095
     C*                                                                   S01392
     C***********@@CALC    IFEQ '2'                        *** B 1  S01392056095
     C***********@@CALC    OREQ '3'                                 S01392056095
     C***********@@CALC    OREQ '5'                                 S01392056095
     C           ZZCALC    IFEQ '2'                        *** B 1        056095
     C           ZZCALC    OREQ '3'                                       056095
     C           ZZCALC    OREQ '5'                                       056095
     C           ZZCALC    OREQ '0'                                                          CER016A
     C                     Z-ADD36000     @@YEAR  50                      S01392
     C                     END                             *** E 1        S01392
     C*                                                                   S01392
     C***********@@CALC    IFEQ '1'                        *** B 1  S01392056095
     C***********@@CALC    OREQ '4'                                 S01392056095
     C           ZZCALC    IFEQ '1'                        *** B 1        056095
     C           ZZCALC    OREQ '4'                                       056095
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDNE'Y'                                                           CDL093
     C                     Z-ADD36500     @@YEAR                          S01392
     C                     END                              *** E 1       S01392
     C*                                                                   S01392
     C***********@@CALC    IFEQ '6'                         *** B 1 S01392056095
     C           ZZCALC    IFEQ '6'                         *** B 1       056095
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C                     Z-ADD36600     @@YEAR                          S01392
     C                     END                              *** E 1       S01392
     C*                                                                   S01392
     C           ZZCALC    IFEQ '6'                                       163136
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C           INT6DY    MULT @@RATE    @@W157                          163136
     C                     ELSE                                           163136
      *                                                                   163136
     C***********@@INDY    MULT @@RATE    @@W157 157                S01392056095
     C           ZZINDY    MULT @@RATE    @@W157 157                      056095
      *                                                                   163136
     C                     END                                            163136
      *                                                                   163136
     C***********@@W157    MULT @@AMT     @@W150 150H              S01392 056121
     C           @@W157    MULT @@AMT     @@W210 210H                     056121
     C*                                                                   S01392
     C**  ROUND DOWN IF ROUND DOWN INDICATOR IS 'Y'                       S01392
     C*                                                                   S01392
     C           @@RDFC    IFEQ 'Y'                                       S01392
     C***********@@W150    DIV  @@YEAR    @@INTR                   S01392 056121
     C           @@W210    DIV  @@YEAR    @@INTR                          056121
     C                     ELSE                                           S01392
     C***********@@W150    DIV  @@YEAR    @@INTR 150H              S01392 056121
     C           @@W210    DIV  @@YEAR    @@INTR 150H                     056121
     C                     END                                            S01392
     C*                                                                   S01392
     C                     MOVE *BLANK    @@RDFC                          S01392
     C/COPY WNCPYSRC,MM0073C002
     C*                                                                   S01392
      * Interest has been calculated                                                          CDL093
     C           INTCLC    TAG                                                                CDL093
     C           M10309    ENDSR                                          S01392
     C*****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZINTDYZ2                                               056095
      *****************************************************************   ME2110
      /EJECT
     C****MM1009*- CALCULATE THE NUMBER OF INTEREST DAYS              *   056095
     C***********                                                     *   056095
     C***CALLED*BY    -                                               *   056095
     C***********                                                     *   056095
     C***CALLS***     -   ZA0710 CONVERT MIDAS DAY NUMBER TO YMD DATE *   056095
     C***********                                                     *   056095
     C***FIELDS*INPUT @@BEG  - START DATE OF PERIOD                   *   056095
     C***********     @@END  - END DATE OF PERIOD                     *   056095
     C***********     @@CALC - INTEREST CALCULATION METHOD            *   056095
     C***********                                                     *   056095
     C***FIELDS*OUTPUT @@INDY - NO. OF INTEREST DAYS                  *   056095
     C***********                                                     *   056095
     C***WORKFIELDS   @@WN5   - WORK FIELD 5N                         *   056095
     C***********     @@WN5A  - WORK FIELD 5N                         *   056095
     C***********     @@WDAT  - WORK FIELD 5N                         *   056095
     C***********     @@DAYN  - WORK FIELD 5N                         *   056095
     C***********     @@P1    - WORK FIELD 5N                         *   056095
     C***********     @@P2    - WORK FIELD 5N                         *   056095
     C***********     @@P3    - WORK FIELD 5N                         *   056095
     C***********     @@LPNM  - WORKFIELD USED IN SETTING UP @@TG10   *   056095
     C***********                                                     *   056095
     C*****************************************************************   056095
     C***********MM1009    BEGSR                                          056095
     C***********                                                         056095
     C***********          MOVE @@BEG     @@BEG   50                      056095
     C***********          MOVE @@END     @@END   50                      056095
     C***********          MOVE @@CALC    @@CALC  1                       056095
     C***********          Z-ADD*ZEROS    @@INDY                          056095
     C***********          Z-ADD*ZEROS    @@LPNM                          056095
     C***********                                                         056095
     C***FIND*NUMBER OF DAYS DIFFERENCE BETWEEN DATES                     056095
     C***********                                                         056095
     C***********@@END     SUB  @@BEG     @@WDAT  50                      056095
     C***********                                                         056095
     C*****FOR*CALCULATION METHODS 3,4 OR 5.                              056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '3'                        **** B 1       056095
     C***********@@CALC    OREQ '4'                                       056095
     C***********@@CALC    OREQ '5'                                       056095
     C***********                                                         056095
     C***********          Z-ADD@@BEG     @@DAYN  50                      056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DATA                          056095
     C***********                                                         056095
     C***********          Z-ADD@@END     @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DATB                          056095
     C***IF*IN*SAME MONTH                                                 056095
     C***********@@YY1     IFEQ @@YY2                      **** B 2       056095
     C***********@@MM1     IFEQ @@MM2                      **** B 3       056095
     C***********@@DD2     SUB  @@DD1     @@INDY                          056095
     C***********          GOTO M10099                     --------->     056095
     C***********          END                             **** E 3       056095
     C***********          END                             **** E 2       056095
     C***********                                                         056095
     C***********          ELSE                            **** X         056095
     C**IF*NOT*3,4 OR 5    ****                                           056095
     C**EXIT*PROCESSING                                                   056095
     C***********          Z-ADD@@WDAT    @@INDY  50       - LOAD OUTPT   056095
     C***********          GOTO M10099                     ----------->   056095
     C***********          END                             **** E 1       056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '3'                        **** B 1       056095
     C***CALC*NO. DAYS IN FIRST MONTH                                     056095
     C***********@@MM1     IFNE 2                          **** B 2       056095
     C***********30        SUB  @@DD1     @@P1    50   80                 056095
     C***IF*<*0,*INITIALISE TO 0                                          056095
     C***80******          Z-ADD*ZEROS    @@P1                            056095
     C***********                                                         056095
     C***********          ELSE                            **** X         056095
     C***TEST*IF*LEAP      ****                                           056095
     C***YEAR****                                                         056095
     C***********@@YY1     DIV  4         @@WN5                           056095
     C***********          MVR            @@WN5          80               056095
     C***********                                                         056095
     C************IN80     IFEQ '1'                        **** B 3       056095
     C***********29        SUB  @@DD1     @@P1    50                      056095
     C***********          ELSE                                           056095
     C***IF*NOT*LEAP       ++++                                           056095
     C***********28        SUB  @@DD1     @@P1    50                      056095
     C***********          END                             **** E 3       056095
     C***********          END                             **** E 2       056095
     C***CALC.*NO. DAYS IN LAST MONTH                                     056095
     C***********@@DD2     IFLE 30                         **** B 2       056095
     C***********          Z-ADD@@DD2     @@P2    50                      056095
     C***********          ELSE                            **** X         056095
     C***********          ****                                           056095
     C***********          Z-ADD30        @@P2                            056095
     C***********          END                             **** E 2       056095
     C***CALC*NO. DAYS IN INTERVENING MONTHS                              056095
     C***********@@YY2     IFEQ @@YY1                      **** B 2       056095
     C***********@@MM2     SUB  @@MM1     @@P3    50                      056095
     C***********          SUB  1         @@P3                            056095
     C***********          MULT 30        @@P3                            056095
     C***********          ELSE                            **** X         056095
     C***********          ****                                           056095
     C***********@@YY2     SUB  @@YY1     @@P3                            056095
     C***********          SUB  1         @@P3                            056095
     C***********          MULT 360       @@P3                            056095
     C***********                                                         056095
     C**FIND*NO.*OF MONTHS FOR THE TWO PARTIAL YEARS                      056095
     C***********12        SUB  @@MM1     @@WN5A  50                      056095
     C***********          MULT 30        @@WN5A                          056095
     C***********                                                         056095
     C***********@@MM2     SUB  1         @@WN5                           056095
     C***********@@WN5     MULT 30        @@WN5                           056095
     C***ACCUMULATE                                                       056095
     C***********@@WN5A    ADD  @@WN5     @@WN5A                          056095
     C***********@@P3      ADD  @@WN5A    @@P3                            056095
     C***********          END                             **** E 2       056095
     C***FINAL*SUM                                                        056095
     C***********                                                         056095
     C***********@@P1      ADD  @@P2      @@INDY                          056095
     C***********          ADD  @@P3      @@INDY                          056095
     C***********          END                             **** E 1       056095
     C***FOR*METHODS 4 AND 5                                              056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '4'                        **** B 1       056095
     C***********@@CALC    OREQ '5'                                       056095
     C****CALCULATE NUMBER OF LEAP YEARS BETWEEN START AND END DATES      056095
     C***********@@MM1     IFLE 2                          **** B 2       056095
     C***********@@YY1     DIV  4         @@WN5   50                   YR 056095
     C***********          MVR            @@WN5          80               056095
     C***ADD*1*IF LEAP YEAR                                               056095
     C***80******          ADD  1         @@LPNM  50                      056095
     C***********          END                             **** E 3       056095
     C***BYPASS*IF YEARS ARE THE SAME                                     056095
     C***********@@YY1     IFEQ @@YY2                      **** B 3       056095
     C***********@@WDAT    SUB  @@LPNM    @@INDY                          056095
     C***********          GOTO M10099                     ---------->    056095
     C***********          END                             **** E 2       056095
     C***LOOP*TO*CALCULATE NO. LEAP YEARS                                 056095
     C***********@@YY1     DOWNE@@YY2                      **** B 2       056095
     C***INCREMENT START YEAR                                             056095
     C***********          ADD  1         @@YY1                           056095
     C***********                                                         056095
     C***********@@YY1     IFEQ @@YY2                      **** B 3       056095
     C***********@@MM2     IFGT 2                          **** B 4       056095
     C***********@@YY2     DIV  4         @@WN5                        YR 056095
     C***********          MVR            @@WN5          80               056095
     C***INCREMENT IF LEAP YEAR                                           056095
     C***80******          ADD  1         @@LPNM                          056095
     C***********          END                              **** E 4      056095
     C***********@@WDAT    SUB  @@LPNM    @@INDY                          056095
     C***********          END                              **** E 3      056095
     C***********@@YY1     IFNE @@YY2                       **** B 3      056095
     C***********@@YY1     DIV  4         @@WN5                        YR 056095
     C***********          MVR            @@WN5          80               056095
     C***ADD*1*IF LEAP YEAR                                               056095
     C***80******          ADD  1         @@LPNM                          056095
     C***********          END                              **** E 3      056095
     C***********          END                              **** E 2      056095
     C***********          END                              **** E 1      056095
     C***********                                                         056095
     C***********M10099    ENDSR                           ***M10099***   056095
      *****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDATE9Z3                                               056095
     C/COPY ZSRSRC,ZFEB29                                                                     CDL093
      *****************************************************************
     C***********                                                     *   056095
     C********TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *   056095
     C***********                                                     *   056095
     C********SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *   056095
     C********PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *   056095
     C********THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *   056095
     C********SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *   056095
     C********IF*'@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *   056095
     C********'@@VDT'  IN 'YYYYMMDD' FORMAT.                          *   056095
     C***********                                                     *   056095
     C**NOTE:*FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS                  056095
     C***********                                                     *   056095
     C********1)*@@DAYN   LENGTH 5,0.                                 *   056095
     C***********                                                     *   056095
     C********FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *   056095
     C***********                                                     *   056095
     C********1)*@@VDT    LENGTH 8,0 DEFINED BY A DS.                 *   056095
     C********2)*@@RTN    LENGTH 1,0.                                 *   056095
     C********3)*@@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *   056095
     C********4)*@@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *   056095
     C********5)*@@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *   056095
     C********6)*@@RDAY   LENGTH 5,0.                                 *   056095
     C********7)*@@LEAP   LENGTH 1,0.                                     056095
     C***********                                                     *   056095
     C********INDICATORS USED ARE:                                    *   056095
     C***********                                                     *   056095
     C********1)*80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *   056095
     C********2)*81       CHECK FOR LOW ON ARRAY @MD.                 *   056095
     C***********                                                     *   056095
     C**INPUT*FIELD:       @@DAYN                                     *   056095
     C***********                                                     *   056095
     C**OUTPUT*FIELD:      @@VDT                                      *   056095
     C***********                                                     *   056095
     C**WORK*FIELDS:       @@RTN                                      *   056095
     C***********          @@Z71Y                                     *   056095
     C***********          @@RDAY                                     *   056095
     C***********          @@LEAP                                     *   056095
     C***********          @@I                                        *   056095
     C***********          @@J                                        *   056095
     C***********                                                     *   056095
     C**ARRAYS*USED:       @YD COMPILE TIME ARRAY.                        056095
     C***********          @MD COMPILE TIME ARRAY.                        056095
     C***********                                                         056095
     C*****************************************************************   056095
     C***********                                                         056095
     C***********ZA0710    BEGSR                                          056095
     C***********                                                         056095
     C***********          SETOF                     8081                 056095
     C***********          Z-ADD0         @@RTN   10                      056095
     C***********          Z-ADD0         @@VDT                           056095
     C***********          Z-ADD1         @@I     20                      056095
     C***********          Z-ADD1         @@J     20                      056095
     C***********          Z-ADD1         @@LEAP  10                      056095
     C***********                                                         056095
     C***********@@DAYN    CABEQ0         ZA0719                    ME1257056095
     C***********                                                         056095
     C***********@@DAYN    IFLT 1                                         056095
     C***********          Z-ADD1         @@RTN                           056095
     C***********          GOTO ZA0719                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**DIVISION*TO DETERMINE WETHER LEAP YEAR.                           056095
     C***********                                                         056095
     C***********@@DAYN    DIV  1461      @@Z71Y                          056095
     C***********          MVR            @@RDAY  50                      056095
     C***********                                                         056095
     C**CALCULATING YEAR.                                                 056095
     C***********                                                         056095
     C***********@@Z71Y    MULT 4         @@Z71Y                          056095
     C***********          ADD  1972      @@Z71Y                          056095
     C***********                                                         056095
     C**CHECKING*IF YEAR IS GREATER THAN OR EQUAL TO 2100                 056095
     C***********                                                         056095
     C***********@@Z71Y    IFGE 2100                                      056095
     C***********          ADD  @@SSY2    @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOKUP*ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE        056095
     C**HAVE*PASSED.                                                      056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@YD,@@I                8080               056095
     C***********                                                         056095
     C**IF*YEAR*IS A LEAP YEAR SSLEAP IS SET TO ZERO.                     056095
     C***********                                                         056095
     C************IN80     IFEQ '0'                                       056095
     C***********          Z-ADD0         @@LEAP                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**ADD*INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 1                                         056095
     C***********@@RDAY    SUB  @YD,@@I   @@RDAY                          056095
     C***********          ADD  @@I       @@Z71Y                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**PROCESSING FOR A LEAP YEAR.                                       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 0                                         056095
     C***********                                                         056095
     C**IF*'@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.                   056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 60                                        056095
     C***********          Z-ADD29        @@Z71D                          056095
     C***********          Z-ADD2         @@Z71M                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*'@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN    056095
     C**PROCEED*AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP     056095
     C**YEAR.*NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.          056095
     C***********                                                         056095
     C***********@@RDAY    IFGT 60                                        056095
     C***********@@RDAY    SUB  1         @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*DAY*'@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS      056095
     C**IN*4*YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR      056095
     C**GROUP.***                                                         056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 0                                         056095
     C***********          Z-ADD31        @@Z71D                          056095
     C***********          Z-ADD12        @@Z71M                          056095
     C***********          SUB  1         @@Z71Y                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOOK*UP*ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'         056095
     C**OCCURS*IN                                                         056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@MD,@@J                81                 056095
     C***********          Z-ADD@@J       @@Z71M                          056095
     C***********@@RDAY    SUB  @MD,@@J   @@Z71D                          056095
     C***********                                                         056095
     C**DS*@@VDT* IS RETURNED IN YYYYMMDD FORMAT                          056095
     C***********                                                         056095
     C***********ZA0711    TAG                                            056095
     C***********                                                         056095
     C***********          MOVE @@Z71Y    @@YR                            056095
     C***********                                                         056095
     C***********ZA0719    ENDSR                                          056095
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZD      - Check for change if amendments                     *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  #ZD    - Check for change if amendments            *
     C*            #B     - Control main processing                   *
     C*            #BB    - Initialise period start date array        *
     C*            #BC    - Update time loans/deposits balances       *
     C*                                                               *
     C* FLDS USED  @CHG   - Work field to check for changes if AMEND  *
     C*            @AMNP  - Work field for amount                     *
     C*            @BAMT  - Work field for before amount              *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @NIDT  - Work field for next int date              *
     C*            @BNID  - Work field for before next int date       *
     C*            @MDAT  - Work field for maturity date              *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @BLID  - Work field for before start last int date *
     C*            @INTR  - Work field for interest rate              *
     C*            @BIRT  - Work field for Before int rate            *
     C*            @ICMT  - Work field for Cal Method                 *
     C*            @BICM  - Work field for Before Cal method          *
     C*            @FRAT  - Work field for Face rate                  *
     C*            @BFRT  - Work field for Before face rate           *
     C*            @FVAL  - Work field for Face value                 *
     C*            @BFVL  - Work field for Before face value          *
     C*            @FUID  - Work field for Front-up interest indicator*   S01392
     C*            @FLID  - Work field for First/Last day interest    *   S01392
     C*            @RDFC  - Work field for Round down interest        *   S01392
     C*            @BFUI  - Work field for Before Front-up int. ind   *   S01392
     C*            @BFLI  - Work field for Before First/Last day int. *   S01392
     C*            @BRDF  - Work field for Before Round down interest *   S01392
     C*                                                               *
     C*****************************************************************
     C           #ZD       BEGSR
      *
     C                     MOVE 'N'       @CHG    1
      *
     C           @AMNP     IFNE @BAMT                      B1
     C           @VDAT     ORNE @BVDT                      X1
     C           @NIDT     ORNE @BNID                      X1
     C           @MDAT     ORNE @BMTD                      X1
     C           @SLDT     ORNE @BLID                      X1
     C           @INTR     ORNE @BIRT                      X1
     C           @ICMT     ORNE @BICM                      X1
     C           @FRAT     ORNE @BFRT                      X1
     C           @FVAL     ORNE @BFVL                      X1
     C           @FUID     ORNE @BFUI                      X1             S01392
     C           @FLID     ORNE @BFLI                      X1             S01392
     C           @RDFC     ORNE @BRDF                      X1             S01392
     C                     MOVE 'Y'       @CHG             *1
     C                     END                             E1
      *
     C           #ZD9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #B       - Control main processing                            *
     C*                                                               *
     C* CALLS    #BA      - Initialise new records                    *
     C*          #BB      - Initialise period start date array        *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*          #BC      - Update time loans/deposits balances       *
     C*          #BD      - Update CD's Bought Balances               *
     C*          #BE      - Update Bills Bought balances              *
     C*          #BF      - Update CD's Sold Balances                 *
     C*          #BG      - Update Bills sold balances                *
     C*          #BH      - Update SI deam balances                   *
     C*          #BI      - Update Funds in Nostro at start of day    *
     C*                                                               *
     C* CALLED BY  MAIN   - Main Line process                         *
     C*                                                               *
     C* FLDS USED  @TERM  - Termination parameter                     *
     C*            @DCAT  - Work field for Format read                *
     C*            @TYPE  - Work field for deal type                  *
     C*            @CCY   - Work field for currency                   *
     C*            @VDAT  - Work filed for Deal value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @VDAT5 - Work field for value date                 *
     C*            @MDAT  - Work field for maturity date              *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @NIDT  - Work field for next int date              *
     C*            @NIDT5 - Work field for Next int date              *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @BVDT5 - Work field for before value date          *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*            @BMTD5 - Work field for before Maturity date       *
     C*            @BNID  - Work field for before next int date       *
     C*            @BNID5 - Work field for before next int date       *
     C*            @BLID  - Work field for before start last int date *
     C*            @BLID5 - Work field for before start last int date *
     C*            @RBSI  - Work field for BOUGHT or sold             *
     C*            @RVDT5 - Work field for related value date         *
     C*            @RMTD5 - Work field for related maturity date      *
     C*            @RLID5 - Work field for related start last date    *
     C*            @RNID5 - Work field for related next int date      *
     C*            @MPHAS - Data structure status of system           *
     C*                                                               *
     C*****************************************************************
     C           #B        BEGSR
      *
      **  If termination parameter set to 'T', no further processing.
     C           @TERM     CABEQ'T'       #B9
     C           *INU7     CABEQ'1'       #B9
      *
      **  Check whether deal type is to be processed.
     C           @DCAT     IFEQ 'A'                        B1
     C           @TYPE     CABNE'SI'      #B9              *1
      *
     C                     ELSE                            X1
      *
     C           @TYPE     IFEQ 'CP'                       B*2
     C           @TYPE     OREQ 'CT'                       X*2
     C           @TYPE     OREQ 'DL'                       X*2
     C                     GOTO #B9                        **2
     C                     END                             E*2
      *
     C                     END                             E1
     C/COPY WNCPYSRC,MM0073C030
      *
      **  Access update files via currency.
     C           @CCY      CHAINMMFNRULL             60
     C           @CCY      CHAINMMEPOULL             60
      *
      **  Initialise new records.
     C           *IN60     IFEQ '1'                        B1
     C                     EXSR #BA                        *1
     C           @CCY      CHAINMMFNRULL             60    *1
     C           @CCY      CHAINMMEPOULL             60    *1
     C                     END                             E1
      *
     C           *INU7     CABEQ'1'       #B9
      *
      **  Initialise periods start dates arrays.
     C                     EXSR #BB
      *
      **  Convert date fields from file YYYYMMDD to MIDAS day numbers.
     C           @VDAT     IFNE *ZEROS                     B1
     C***********          Z-ADD@VDAT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @VDAT5  50       *1             056095
     C                     Z-ADD@VDAT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @VDAT5  50       *1             056095
     C                     END                             E1
      *
     C           @MDAT     IFNE *ZEROS                     B1
     C***********          Z-ADD@MDAT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @MDAT5  50       *1             056095
     C                     Z-ADD@MDAT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @MDAT5  50       *1             056095
     C                     END                             E1
      *
     C           @NIDT     IFNE *ZEROS                     B1
     C***********          Z-ADD@NIDT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @NIDT5  50       *1             056095
     C                     Z-ADD@NIDT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @NIDT5  50       *1             056095
     C/COPY WNCPYSRC,MM0073C031
     C                     END                             E1
      *
     C           @SLDT     IFNE *ZEROS                     B1
     C***********          Z-ADD@SLDT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @SLDT5  50       *1             056095
     C                     Z-ADD@SLDT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @SLDT5  50       *1             056095
     C                     END                             E1
      *
     C           @BVDT     IFNE *ZEROS                     B1
     C***********          Z-ADD@BVDT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @BVDT5  50       *1             056095
     C                     Z-ADD@BVDT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @BVDT5  50       *1             056095
     C                     END                             E1
      *
     C           @BMTD     IFNE *ZEROS                     B1
     C***********          Z-ADD@BMTD     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @BMTD5  50       *1             056095
     C                     Z-ADD@BMTD     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @BMTD5  50       *1             056095
     C                     END                             E1
      *
     C           @BNID     IFNE *ZEROS                     B1
     C***********          Z-ADD@BNID     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @BNID5  50       *1             056095
     C                     Z-ADD@BNID     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @BNID5  50       *1             056095
     C                     END                             E1
      *
     C           @BLID     IFNE *ZEROS                     B1
     C***********          Z-ADD@BLID     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @BLID5  50       *1             056095
     C                     Z-ADD@BLID     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @BLID5  50       *1             056095
     C                     END                             E1
      *
      **  Update balances and interest accruals.
     C           @TYPE     IFEQ 'IT'                       B1
     C           @TYPE     OREQ 'IP'                       X1
     C           @TYPE     OREQ 'TD'                       X1
     C           @TYPE     OREQ 'TL'                       X1
     C           @TYPE     OREQ 'CI'                       X1
     C           @TYPE     OREQ 'CL'                       X1
     C/COPY WNCPYSRC,MM0073C128
      *                                                                                       CDL033
     C           @TYPE     OREQ 'CF'                                                          CDL033
     C           CDL033    ANDEQ'Y'                                                           CDL033
      *                                                                                       CDL033
     C                     EXSR #BC                        *1
     C                     END                             E1
      *
     C           @RBSI     IFEQ 'B'                        B1
      *
     C           IHRVDT    IFNE *ZEROS                     B*2
     C***********          Z-ADDIHRVDT    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @RVDT5  50       **2            056095
     C                     Z-ADDIHRVDT    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @RVDT5  50       **2            056095
     C                     END                             E*2
      *
     C           @TYPE     IFEQ 'C1'                       B*2
     C           @TYPE     OREQ 'C2'                       X*2
     C           @TYPE     OREQ 'BO'                       X*2
     C           @TYPE     OREQ 'BI'                       X*2
     C                     EXSR #BD                        **2
     C                     END                             E*2
      *
     C           @TYPE     IFEQ 'TA'                       B*2
     C           @TYPE     OREQ 'TB'                       X*2
     C           @TYPE     OREQ 'BA'                       X*2
     C                     EXSR #BE                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           @RBSI     IFEQ 'S'                        B1
      *
      ** If the NA is parcelled need to consider possible partial sale    S01378
      ** of a NAB. ILRBAT, related bought amount, is the purchase price   S01378
      ** of the whole NA bought. If partial sale must overwrite this to   S01378
      ** contain bought price for the number of parcels being sold.       S01378
      ** Also overwrite ILRFVL, related face value, in same manner.       S01378
      ** Must obtain parcel size for the bought amount from NAB rcd.      S01378
      ** (Note that during CoB (ie DL0280) HLAMNP, HLPSZE, HLFVAL are     S01378
      ** reduced to reflect NA's sold, but they stay in synch.)           S01378
     C           ILPCLI    IFEQ 'P'                                       S01378
     C                     MOVE ILDADN    @NABKY  60                      S01378
     C           @NABKY    CHAINMMDENBP0             51                   S01378
      *                                                                   S01378
      ** obtain purchase price per parcel from NAB rcd                    S01378
     C           HLAMNP    DIV  HLPSZE    ILRBAT    H                     S01378
      *                                                                   S01378
      ** derive purchase price of the sold NA's                           S01378
     C           ILRBAT    MULT ILPSZE    ILRBAT                          S01378
      *                                                                   S01378
      ** obtain face value per parcel from NAB rcd                        S01378
     C           HLFVAL    DIV  HLPSZE    ILRFVL    H                     S01378
      *                                                                   S01378
      ** derive face value of the sold NA's                               S01378
     C           ILRFVL    MULT ILPSZE    ILRFVL                          S01378
     C                     END                                            S01378
      *                                                                   S01378
     C           ILRMTD    IFNE *ZEROS                     B*2
     C***********          Z-ADDILRMTD    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @RMTD5  50       **2            056095
     C                     Z-ADDILRMTD    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @RMTD5  50       **2            056095
     C                     END                             E*2
      *
     C           @TYPE     IFEQ 'C1'                       B*2
     C           @TYPE     OREQ 'C2'                       X*2
     C           @TYPE     OREQ 'BO'                       X*2
     C           @TYPE     OREQ 'BI'                       X*2
      *
     C           ILRLID    IFNE *ZEROS                     B*2
     C***********          Z-ADDILRLID    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @RLID5  50       **2            056095
     C                     Z-ADDILRLID    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @RLID5  50       **2            056095
     C                     END                             E*2
      *
     C           ILRNID    IFNE *ZEROS                     B*2
     C***********          Z-ADDILRNID    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @RNID5  50       **2            056095
     C                     Z-ADDILRNID    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @RNID5  50       **2            056095
     C                     END                             E*2
      *
     C                     EXSR #BF                        **2
     C                     END                             E*2
      *
     C           @TYPE     IFEQ 'TA'                       B*2
     C           @TYPE     OREQ 'TB'                       X*2
     C           @TYPE     OREQ 'BA'                       X*2
     C                     EXSR #BG                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           @TYPE     IFEQ 'SI'                       B1
     C                     EXSR #BH                        *1
     C                     END                             E1
     C*                                                                   E12460
     C**  Update nostro figure on file MMFNRDPP at start of day.          E12460
     C           @MDAT5    IFGE BJRDNB                     B1             S01194
     C           @VDAT5    ANDLTBJRDNB                     X1             S01194
     C*********  @MDAT5    IFGE RUND                       B1       E12460S01194
     C*********  @VDAT5    ANDLTRUND                       X1       E12460S01194
     C                     EXSR #BI                        *1             E12460
     C                     END                             E1             E12460
      *
      *
      **  Update files.
     C                     UPDATMMFNRDP0
     C                     UPDATMMEPOSP0
      *
     C           #B9       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BB      - Initialise period start date array                 *
     C*                                                               *
     C**CALLS****ZA0680***-**Convert*date*format*to*midas*day*number***   056095
     C* CALLS    ZDAT10   -  Convert date format to midas day number  *   056095
     C*                                                               *
     C* CALLED BY  BB     -  Main processing                          *
     C*                                                               *
     C* FLDS USED  @S     - Array to hold period start dates          *
     C*            @CCY   - Work field for currency                   *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*                                                               *
     C*****************************************************************
     C           #BB       BEGSR
      *
     C           HRPDTD    SUB  HRDPTD    @S,1
     C                     ADD  1         @S,1
     C           HRPDD1    SUB  HRDPD1    @S,2
     C                     ADD  1         @S,2
     C           HRPDD2    SUB  HRDPD2    @S,3
     C                     ADD  1         @S,3
     C           HRPDD3    SUB  HRDPD3    @S,4
     C                     ADD  1         @S,4
     C           HRPDD4    SUB  HRDPD4    @S,5
     C                     ADD  1         @S,5
     C           HRPDW1    SUB  HRDPW1    @S,6
     C                     ADD  1         @S,6
     C           HRPDM1    SUB  HRDPM1    @S,7
     C                     ADD  1         @S,7
     C           HRPDM2    SUB  HRDPM2    @S,8
     C                     ADD  1         @S,8
     C           HRPDM3    SUB  HRDPM3    @S,9
     C                     ADD  1         @S,9
      *
      ****Access*FDCCYTLL to get MM spot date.                            S01194
     C*********            MOVE *BLANKS   KEY                             S01194
     C*********            MOVEL'20'      KEY                             S01194
     C*********            MOVEL@CCY      KEY912  4                       S01194
     C*********            MOVE '1'       KEY912                          S01194
     C*********            MOVE KEY912    KEY                             S01194
     C*********  KEY       CHAINFDCCYTLL             60                   S01194
      *
      ** get MM spot date.                                                S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*MSG   ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM @CCY      @WRK3   3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*                                                                   S01194
     C*********  @@KEY     CHAINFDCCYTLL             61                   S01194
     C*
     C**  CHECK FOR DATA BASE ERROR
     C           @RTCD     IFNE *BLANK                     B1             S01194
     C*********  *IN60     IFEQ '1'                        B1             S01194
     C                     MOVE '003'     DBASE            ***************
     C*********            MOVEL'FDCCYTLL'DBFILE           *             *S01194
     C*********            MOVELKEY       DBKEY            *              S01194
     C                     MOVEL'SDCURRPD'DBFILE           *             *S01194
     C                     MOVEL@CCY      DBKEY            * DBERROR 003 *S01194
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE @OPTN     DBOPTN  7        *             *S01194
     C                     MOVE '1'       *INU8            ***************
     C                     GOTO #BB9                       *1
     C                     END                             E1
      *
     C*********            Z-ADDMSPD      @@DTIN                          S01194
     C***********          Z-ADDA6MMSD    @@DTIN                    S01194056095
     C***********          EXSR ZA0680                                    056095
     C***********          Z-ADD@@MDNO    @S,10                           056095
     C                     Z-ADDA6MMSD    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C                     Z-ADDZZMDNO    @S,10                           056095
      *
     C           #BB9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BC      - Update time loans/deposits balances                *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*          #ZD      - Check for change if amendments            *
     C***********MM1007   - Calculate interest                        *   E17051
     C*          MM1030   - Calculate interest                        *   E17051
     C***********ZA0680***-*Convert*date*formate*to*midas*day*number***   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     -  Main processing                          *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @MDAT  - Work field for maturity date              *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*            @BVDT5 - Work field for before value date          *
     C*            @BMTD5 - Work field for before Maturity date       *
     C*            @BAMT  - Work field for before amount              *
     C*            @NIDT  - Work field for next int date              *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*************@@END**-*work*field*for*End*date********************   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            @ICMT  - Work field for Cal Method                 *
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @@AMT  - Work field for amount                     *
     C*            @INTR  - Work field for interest rate              *
     C*            @@RATE - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @NIDT5 - Work field for Next int date              *
     C*            @BNID  - Work field for before next int date       *
     C*            @BLID  - Work field for before start last int date *
     C*            @BLID5 - Work field for before start last int date *
     C*            @BICM  - Work field for Before Cal method          *
     C*            @BIRT  - Work field for Before int rate            *
     C*            @BNID5 - Work field for before next int date       *
     C*            @DMVD  - Work field for deam value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*            @FUID  - Work field for Front-up interest indicator*   S01392
     C*            @FLID  - Work field for First/Last day interest    *   S01392
     C*            @RDFC  - Work field for Round down interest        *   S01392
     C*            @BFUI  - Work field for Before Front-up int. ind   *   S01392
     C*            @BFLI  - Work field for Before First/Last day int. *   S01392
     C*            @BRDF  - Work field for Before Round down interest *   S01392
     C*            @@RDFC - Work field used by MM1030                 *   S01392
     C*                                                               *
     C*****************************************************************
     C           #BC       BEGSR
      *
     C/COPY WNCPYSRC,MM0073C007
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG   10
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT   50       *1
     C           @MDAT5    SUB  1         @EDAT   50       *1
     C                     Z-ADD@AMNP     @AMNT  150       *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           IKLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB  1        *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           IKLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           IKLACT    IFEQ 'A'                        B1
     C                     EXSR #ZD                        *1
      *
      **  Deal has been changed.
     C           @CHG      IFEQ 'Y'                        B*2
      *
      **  Add new amount...
     C           @FLAG     IFEQ 1                          B**3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
      **  ...and remove previous amount.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           @BMTD     ANDNE*ZEROS                     X**3
     C                     Z-ADD@BVDT5    @SDAT            ***3
     C           @BMTD5    SUB  1         @EDAT            ***3
     C                     Z-ADD@BAMT     @AMNT            ***3
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Update balances with interest due.
     C           @NIDT     IFEQ *ZEROS                     B1
      *
     C                     Z-ADD*ZEROS    @FLAG            *1
      *
      **  Calculate interest due at maturity.
     C           @SLDT     IFNE *ZEROS                     B*2
     C           @MDAT     ANDNE*ZEROS                     X*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@MDAT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@MDAT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C                     Z-ADD@AMNP     @@AMT  150       **2
     C                     Z-ADD@INTR     @@RATE 117       **2
     C                     MOVE @RDFC     @@RDFC  1        **2            S01392
     C*                                                                   S01392
     C** If First & Last Day Interest indicator on add an extra           S01392
     C/COPY WNCPYSRC,MM0073C127
     C** day's interest.                                                  S01392
     C/COPY WNCPYSRC,MM0073C033
     C           @FLID     IFEQ 'Y'                        B**3           S01392
     C***********          ADD  1         @@END            ***3     S01392056095
     C                     ADD  1         ZZEND            ***3           056095
     C                     END                             E**3           S01392
     C**                                                                  S01392
     C******************** EXSR MM1007                     **2            E17051
     C/COPY WNCPYSRC,MM0073C008
     C                     EXSR MM1030                     **2            E17051
     C/COPY WNCPYSRC,MM0073C009
      *
      **  Update balances with interest due at maturity.
     C                     Z-SUB@@INTR    @AMNT            **2
     C*                                                                   S01392
     C** If Front-up Interest indicator on interest is added/deducted     S01392
     C** at value date.                                                   S01392
     C           @FUID     IFEQ 'Y'                        B**3           S01392
     C                     Z-ADD@VDAT5    @SDAT            ***3           S01392
     C                     ELSE                            X**3           S01392
     C                     Z-ADD@MDAT5    @SDAT            ***3
     C                     END                             E**3           S01392
     C*                                                                   S01392
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     ELSE                            X1
      *
      **  Calculate interest due at next interest date.
     C           @SLDT     IFNE *ZEROS                     B*2
     C/COPY WNCPYSRC,MM0073C034
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C/COPY WNCPYSRC,MM0073C035
     C***********          Z-ADD@NIDT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@NIDT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C                     Z-ADD@AMNP     @@AMT            **2
     C                     Z-ADD@INTR     @@RATE           **2
     C******************** EXSR MM1007                     **2            E17051
     C/COPY WNCPYSRC,MM0073C010
     C                     EXSR MM1030                     **2            E17051
     C/COPY WNCPYSRC,MM0073C011
      *
      **  Update balances with interest due at next interest date.
     C                     Z-SUB@@INTR    @AMNT            **2
     C                     Z-ADD@NIDT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Insert, so add interest due.
     C           IKLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove interest due.
     C           IKLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           IKLACT    IFEQ 'A'                        B1
     C           @CHG      ANDEQ'Y'                        *1
      *
      **  Access DEAM's file.
     C           IKDN38    SETLLMMLVDMLL                   *1
     C           IKDN38    READEMMLVDMLL                 76*1
      *
      **  If no settle interest DEAM exists...
     C           *IN76     IFEQ '1'                        B*2
      *
      **  ...add new interest due...
     C           @FLAG     IFEQ 1                          B**3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
      **  ...calculate interest due before update...
     C           @BNID     IFEQ *ZEROS                     B**3
      *
     C                     Z-ADD*ZEROS    @FLAG            ***3
      *
      **  Calculate interest due at before update maturity date.
     C           @BLID     IFNE *ZEROS                     B***4
     C           @BMTD     ANDNE*ZEROS                     X***4
     C***********          Z-ADD@BLID5    @@BEG            ****4          056095
     C***********          Z-ADD@BMTD5    @@END            ****4          056095
     C***********          MOVE @BICM     @@CALC           ****4          056095
     C                     Z-ADD@BLID5    ZZBEG            ****4          056095
     C                     Z-ADD@BMTD5    ZZEND            ****4          056095
     C                     MOVE @BICM     ZZCALC           ****4          056095
     C                     Z-ADD@BAMT     @@AMT            ****4
     C/COPY WNCPYSRC,MM0073C036
     C                     Z-ADD@BIRT     @@RATE           ****4
     C/COPY WNCPYSRC,MM0073C037
     C                     MOVE @BRDF     @@RDFC           ****4          S01392
     C*                                                                   S01392
     C** If Before Update First & Last day Interest indicator on          S01392
     C** add an extra day's interest.                                     S01392
     C           @BFLI     IFEQ 'Y'                                       S01392
     C***********          ADD  1         @@END                     S01392056095
     C                     ADD  1         ZZEND                           056095
     C                     END                                            S01392
     C**                                                                  S01392
     C******************** EXSR MM1007                     ****4          E17051
     C/COPY WNCPYSRC,MM0073C012
     C                     EXSR MM1030                     ****4          E17051
     C/COPY WNCPYSRC,MM0073C013
      *
      **  Update balances with interest due at before update maturity.
     C                     Z-SUB@@INTR    @AMNT            ****4
     C*                                                                   S01392
     C** If BU deal was 'Front-up Interest' then need to                  S01392
     C** back out interest at VALUE date, else back out                   S01392
     C** interest at MATURITY date.                                       S01392
     C           @BFUI     IFEQ 'Y'                        B****5         S01392
     C                     Z-ADD@BVDT5    @SDAT            *****5         S01392
     C                     ELSE                            X****5         S01392
     C                     Z-ADD@BMTD5    @SDAT            *****5
     C                     END                             E****5         S01392
     C*                                                                   S01392
     C                     Z-ADD99999     @EDAT            ****4
     C                     Z-ADD1         @FLAG            ****4
     C                     END                             E***4
      *
     C/COPY WNCPYSRC,MM0073C038
     C                     ELSE                            X**3
     C/COPY WNCPYSRC,MM0073C039
      *
      **  Calculate interest due at before update next interest date.
     C           @BLID     IFNE *ZEROS                     B***4
     C***********          Z-ADD@BLID5    @@BEG            ****4          056095
     C***********          Z-ADD@BNID5    @@END            ****4          056095
     C***********          MOVE @BICM     @@CALC           ****4          056095
     C                     Z-ADD@BLID5    ZZBEG            ****4          056095
     C                     Z-ADD@BNID5    ZZEND            ****4          056095
     C                     MOVE @BICM     ZZCALC           ****4          056095
     C                     Z-ADD@BAMT     @@AMT            ****4
     C                     Z-ADD@BIRT     @@RATE           ****4
     C******************** EXSR MM1007                     ****4          E17051
     C/COPY WNCPYSRC,MM0073C014
     C                     EXSR MM1030                     ****4          E17051
     C/COPY WNCPYSRC,MM0073C015
      *
      **  Update balances with interest due at before update next interest date.
     C                     Z-SUB@@INTR    @AMNT            ****4
     C                     Z-ADD@BNID5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C                     Z-ADD1         @FLAG            ****4
     C                     END                             E***4
      *
     C                     END                             E**3
      *
      **  ...and backout interest due before update.
     C           @FLAG     IFEQ 1                          B**3
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
     C                     ELSE                            X*2
      *
      **  Calculate interest due from before update value date.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           @DMVD     ANDNE*ZEROS                     X**3
     C***********          Z-ADD@DMVD     @@DTIN           ***3           056095
     C/COPY WNCPYSRC,MM0073C040
     C***********          EXSR ZA0680                     ***3           056095
     C/COPY WNCPYSRC,MM0073C041
     C***********          Z-ADD@@MDNO    @DMVD5  50       ***3           056095
     C                     Z-ADD@DMVD     ZZDTIN           ***3           056095
     C                     EXSR ZDAT10                     ***3           056095
     C                     Z-ADDZZMDNO    @DMVD5  50       ***3           056095
      *
     C***********          Z-ADD@BVDT5    @@BEG            ***3           056095
     C***********          Z-ADD@DMVD5    @@END            ***3           056095
     C***********          MOVE @BICM     @@CALC           ***3           056095
     C                     Z-ADD@BVDT5    ZZBEG            ***3           056095
     C                     Z-ADD@DMVD5    ZZEND            ***3           056095
     C                     MOVE @BICM     ZZCALC           ***3           056095
     C                     Z-ADD@BAMT     @@AMT            ***3
     C                     Z-ADD@BIRT     @@RATE           ***3
     C******************** EXSR MM1007                     ***3           E17051
     C/COPY WNCPYSRC,MM0073C016
     C                     EXSR MM1030                     ***3           E17051
     C/COPY WNCPYSRC,MM0073C017
      *
      **  Backout interest due from DEAM value date to end of book.
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@DMVD5    @SDAT            ***3
     C/COPY WNCPYSRC,MM0073C042
     C                     Z-ADD99999     @EDAT            ***3
     C/COPY WNCPYSRC,MM0073C043
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
      **  Calculate interest due at DEAM value date.
     C           @VDAT     IFNE *ZEROS                     B**3
     C           @DMVD     ANDNE*ZEROS                     X**3
     C***********          Z-ADD@VDAT5    @@BEG            ***3           056095
     C***********          Z-ADD@DMVD5    @@END            ***3           056095
     C***********          MOVE @ICMT     @@CALC           ***3           056095
     C                     Z-ADD@VDAT5    ZZBEG            ***3           056095
     C                     Z-ADD@DMVD5    ZZEND            ***3           056095
     C                     MOVE @ICMT     ZZCALC           ***3           056095
     C                     Z-ADD@AMNP     @@AMT            ***3
     C                     Z-ADD@INTR     @@RATE           ***3
     C******************** EXSR MM1007                     ***3           E17051
     C/COPY WNCPYSRC,MM0073C018
     C                     EXSR MM1030                     ***3           E17051
     C/COPY WNCPYSRC,MM0073C019
      *
      **  Add interest due from DEAM value date to end of book.
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@DMVD5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C/COPY WNCPYSRC,MM0073C044
     C                     END                             E1
     C/COPY WNCPYSRC,MM0073C045
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C/COPY WNCPYSRC,MM0073C046
     C                     Z-ADD@VDAT5    @SDAT            *1
     C/COPY WNCPYSRC,MM0073C047
     C                     Z-ADD@MDAT5    @EDAT            *1
     C                     MOVE @ICMT     @CALC   1        *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD@INTR     @RATE  117       *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add interest accrued.
     C/COPY WNCPYSRC,MM0073C048
     C           IKLACT    IFEQ 'I'                        B1
     C/COPY WNCPYSRC,MM0073C049
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0073C020
     C                     EXSR #ZC                        *1
     C/COPY WNCPYSRC,MM0073C021
     C                     END                             E1
      *
      **  Deletion, so remove interest accrued.
     C           IKLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0073C050
     C/COPY WNCPYSRC,MM0073C022
     C/COPY WNCPYSRC,MM0073C051
     C                     EXSR #ZC                        *1
     C/COPY WNCPYSRC,MM0073C023
     C                     END                             E1
      *
      **  Amendment.
     C           IKLACT    IFEQ 'A'                        B1
      *
      **  Add interest accrued.
     C           @FLAG     IFEQ 1                          B*2
     C                     MOVE '+'       @ADSUB           **2
     C/COPY WNCPYSRC,MM0073C024
     C                     EXSR #ZC                        **2
     C/COPY WNCPYSRC,MM0073C025
     C                     END                             E*2
      *
      **  Remove interest accrued before update.
     C           @BVDT     IFNE *ZEROS                     B*2
     C           @BMTD     ANDNE*ZEROS                     X*2
     C                     Z-ADD@BVDT5    @SDAT            **2
     C                     Z-ADD@BMTD5    @EDAT            **2
     C                     MOVE @BICM     @CALC            **2
     C                     Z-ADD@BAMT     @AMNT            **2
     C                     Z-ADD@BIRT     @RATE            **2
     C                     MOVE '-'       @ADSUB           **2
     C/COPY WNCPYSRC,MM0073C026
     C                     EXSR #ZC                        **2
     C/COPY WNCPYSRC,MM0073C027
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BC9      ENDSR
     C*****************************************************************
     C/COPY WNCPYSRC,MM0073C028
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BD      - Update CD's Bought Balances                        *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*          #ZD      - Check for change if amendments            *
     C*          #ZE      - Update NAB's amendments NAS balances      *
     C********** MM1007   - Calculate interest                        *   E17051
     C*          MM1030   - Calculate interest                        *   E17051
     C***********ZA0680***-*Convert*date*format************************   056095
     C*          ZDAT10   - Convert date format                       *   056095
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @MDAT  - Work field for maturity date              *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @FVAL  - Work field for Face value                 *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*            @BVDT5 - Work field for before value date          *
     C*            @BMTD5 - Work field for before Maturity date       *
     C*            @BAMT  - Work field for before amount              *
     C*            @BFVL  - Work field for Before face value          *
     C*            @RVDT5 - Work field for related value date         *
     C*            @NIDT  - Work field for next int date              *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*************@@END**-*work*field*for*End*date********************   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            @ICMT  - Work field for Cal Method                 *
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @@AMT  - Work field for amount                     *
     C*            @FRAT  - Work field for Face rate                  *
     C*            @@RATE - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @NIDT5 - Work field for Next int date              *
     C*            @BNID  - Work field for before next int date       *
     C*            @DMVD  - Work field for deam value date            *
     C*            @BLID  - Work field for before start last int date *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*            @BLID5 - Work field for before start last int date *
     C*            @BICM  - Work field for Before Cal method          *
     C*            @BFRT  - Work field for Before face rate           *
     C*            @BIRT  - Work field for before yield rate          *
     C*            @BNID5 - Work field for before next int date       *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*                                                               *
     C*****************************************************************
     C           #BD       BEGSR
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @MDAT5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           IHLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           IHLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and face value.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @MDAT     IFNE *ZEROS                     B1
     C                     Z-ADD@MDAT5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @FVAL     ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           IHLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           IHLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           IHLACT    IFEQ 'A'                        B1
     C                     EXSR #ZD                        *1
      *
      **  Deal has been changed.
     C           @CHG      IFEQ 'Y'                        B*2
      *
      **  If no related NAS exists.
     C           IHDADN    IFEQ *BLANKS                    B**3
      *
      **  Add new amount...
     C           @VDAT     IFNE *ZEROS                     B***4
     C           @MDAT     ANDNE*ZEROS                     X***4
     C                     Z-ADD@VDAT5    @SDAT            ****4
     C           @MDAT5    SUB  1         @EDAT            ****4
     C                     Z-ADD@AMNP     @AMNT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  ...remove previous amount.
     C           @BVDT     IFNE *ZEROS                     B***4
     C           @BMTD     ANDNE*ZEROS                     X***4
     C                     Z-ADD@BVDT5    @SDAT            ****4
     C           @BMTD5    SUB  1         @EDAT            ****4
     C                     Z-ADD@BAMT     @AMNT            ****4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  Update balances with difference between purchase price and face value.
      **  Add new amount...
     C           @MDAT     IFNE *ZEROS                     B***4
     C                     Z-ADD@MDAT5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C           @FVAL     ADD  @AMNP     @AMNT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  ...and remove previous amount.
     C           @BMTD     IFNE *ZEROS                     B***4
     C                     Z-ADD@BMTD5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C           @BFVL     ADD  @BAMT     @AMNT            ****4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
     C                     ELSE                            X**3
      *
      **  If related NAS does exist, add new amount up to NAS value date...
     C           @VDAT     IFNE *ZEROS                     B***4
     C           IHRVDT    ANDNE*ZEROS                     X***4
     C                     Z-ADD@VDAT5    @SDAT            ****4
     C                     Z-ADD@RVDT5    @EDAT            ****4
     C                     Z-ADD@AMNP     @AMNT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  ...and remove previous amount from NAS value date.
     C           @BVDT     IFNE *ZEROS                     B***4
     C           IHRVDT    ANDNE*ZEROS                     X***4
     C                     Z-ADD@BVDT5    @SDAT            ****4
     C                     Z-ADD@RVDT5    @EDAT            ****4
     C                     Z-ADD@BAMT     @AMNT            ****4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  Update balances with difference between purchase prices.
     C           IHRVDT    IFNE *ZEROS                     B***4
     C                     Z-ADD@RVDT5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C           @AMNP     SUB  @BAMT     @AMNT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C/COPY WNCPYSRC,MM0073C052
     C                     END                             E***4
     C/COPY WNCPYSRC,MM0073C053
      *
      **  Update NAB's sold amendments NAS balances
     C                     EXSR #ZE
      *
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Update balances with interest due.
     C           @NIDT     IFEQ *ZEROS                     B1
      *
     C                     Z-ADD*ZEROS    @FLAG            *1
      *
      **  Calculate interest due at maturity.
     C           @SLDT     IFNE *ZEROS                     B*2
     C           @MDAT     ANDNE*ZEROS                     X*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@MDAT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C/COPY WNCPYSRC,MM0073C054
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C/COPY WNCPYSRC,MM0073C055
     C                     Z-ADD@MDAT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C                     Z-SUB@AMNP     @@AMT            **2
     C                     Z-ADD@INTR     @@RATE           **2
     C******************** EXSR MM1007                     **2            E17051
     C                     EXSR MM1030                     **2            E17051
      *
      **  Update balances with interest due at maturity.
     C                     Z-ADD@@INTR    @AMNT            **2
     C                     Z-ADD@MDAT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     ELSE                            X1
      *
      **  Calculate interest due at next interest date.
     C           @SLDT     IFNE *ZEROS                     B*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@NIDT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@NIDT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C                     Z-SUB@AMNP     @@AMT            **2
     C                     Z-ADD@INTR     @@RATE           **2
     C******************** EXSR MM1007                     **2            E17051
     C                     EXSR MM1030                     **2            E17051
      *
      **  Update balances with interest due at next interest date.
     C                     Z-ADD@@INTR    @AMNT            **2
     C                     Z-ADD@NIDT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Insert, so add interest due.
     C           IHLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove interest due.
     C           IHLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           IHLACT    IFEQ 'A'                        B1
     C           @CHG      ANDEQ'Y'                        X1
      *
     C           @BNID     IFEQ *ZEROS                     B*2
      *
      **  Access DEAM's file.
     C           IHDN38    SETLLMMLVDMLL                   **2
     C/COPY WNCPYSRC,MM0073C056
     C           IHDN38    READEMMLVDMLL                 76**2
     C/COPY WNCPYSRC,MM0073C057
      *
      **  If settle interest DEAM exists.
     C           *IN76     IFEQ '0'                        B**3
      *
      **  If related NAS exists after DEAM.
     C           IHDADN    IFNE *BLANKS                    B***4
     C           IHRVDT    ANDGT@DMVD                      X***4
      *
      **  Calculate interest due from before update last interest date.
     C           @BLID     IFNE *ZEROS                     B****5
     C           @DMVD     ANDNE*ZEROS                     X****5
     C***********          Z-ADD@DMVD     @@DTIN           *****5         056095
     C***********          EXSR ZA0680                     *****5         056095
     C***********          Z-ADD@@MDNO    @DMVD5           *****5         056095
     C                     Z-ADD@DMVD     ZZDTIN           *****5         056095
     C                     EXSR ZDAT10                     *****5         056095
     C                     Z-ADDZZMDNO    @DMVD5           *****5         056095
      *
     C***********          Z-ADD@BLID5    @@BEG            *****5         056095
     C***********          Z-ADD@DMVD5    @@END            *****5         056095
     C***********          MOVE @BICM     @@CALC           *****5         056095
     C/COPY WNCPYSRC,MM0073C058
     C                     Z-ADD@BLID5    ZZBEG            *****5         056095
     C/COPY WNCPYSRC,MM0073C059
     C                     Z-ADD@DMVD5    ZZEND            *****5         056095
     C                     MOVE @BICM     ZZCALC           *****5         056095
     C                     Z-SUB@BAMT     @@AMT            *****5
     C                     Z-ADD@BIRT     @@RATE           *****5
     C******************** EXSR MM1007                     *****5         E17051
     C                     EXSR MM1030                     *****5         E17051
      *
      **  Backout interest due from DEAM value date to end of book.
     C                     Z-ADD@@INTR    @AMNT            *****5
     C                     Z-ADD@DMVD5    @SDAT            *****5
     C                     Z-ADD99999     @EDAT            *****5
     C                     MOVE '-'       @ADSUB           *****5
     C                     EXSR #ZB                        *****5
     C                     END                             E****5
      *
      **  Calculate interest due from start/last interest date.
     C           @SLDT     IFNE *ZEROS                     B****5
     C           @DMVD     ANDNE*ZEROS                     X****5
     C***********          Z-ADD@SLDT5    @@BEG            *****5         056095
     C***********          Z-ADD@DMVD5    @@END            *****5         056095
     C***********          MOVE @ICMT     @@CALC           *****5         056095
     C                     Z-ADD@SLDT5    ZZBEG            *****5         056095
     C                     Z-ADD@DMVD5    ZZEND            *****5         056095
     C                     MOVE @ICMT     ZZCALC           *****5         056095
     C                     Z-SUB@AMNP     @@AMT            *****5
     C                     Z-ADD@INTR     @@RATE           *****5
     C/COPY WNCPYSRC,MM0073C060
     C******************** EXSR MM1007                     *****5         E17051
     C/COPY WNCPYSRC,MM0073C061
     C                     EXSR MM1030                     *****5         E17051
      *
      **  Add interest due from DEAM value date to end of book.
     C                     Z-ADD@@INTR    @AMNT            *****5
     C                     Z-ADD@DMVD5    @SDAT            *****5
     C                     Z-ADD99999     @EDAT            *****5
     C                     MOVE '+'       @ADSUB           *****5
     C                     EXSR #ZB                        *****5
     C                     END                             E****5
      *
     C                     END                             E***4
      *
      **  If no related NAS exists.
     C           IHDADN    IFEQ *BLANKS                    B***4
      *
      **  Calculate interest due from before update value date.
     C           @BVDT     IFNE *ZEROS                     B****5
     C           @BMTD     ANDNE*ZEROS                     X****5
     C***********          Z-ADD@BVDT5    @@BEG            *****5         056095
     C***********          Z-ADD@BMTD5    @@END            *****5         056095
     C***********          MOVE @BICM     @@CALC           *****5         056095
     C/COPY WNCPYSRC,MM0073C062
     C                     Z-ADD@BVDT5    ZZBEG            *****5         056095
     C/COPY WNCPYSRC,MM0073C063
     C                     Z-ADD@BMTD5    ZZEND            *****5         056095
     C                     MOVE @BICM     ZZCALC           *****5         056095
     C                     Z-SUB@BAMT     @@AMT            *****5
     C                     Z-ADD@BIRT     @@RATE           *****5
     C******************** EXSR MM1007                     *****5         E17051
     C                     EXSR MM1030                     *****5         E17051
      *
      **  Backout interest due from before update maturity date.
     C                     Z-ADD@@INTR    @AMNT            *****5
     C                     Z-ADD@BMTD5    @SDAT            *****5
     C                     Z-ADD99999     @EDAT            *****5
     C                     MOVE '-'       @ADSUB           *****5
     C                     EXSR #ZB                        *****5
     C                     END                             E****5
      *
      **  Calculate interest due at maturity.
     C           @VDAT     IFNE *ZEROS                     B****5
     C           @MDAT     ANDNE*ZEROS                     X****5
     C***********          Z-ADD@VDAT5    @@BEG            *****5         056095
     C***********          Z-ADD@MDAT5    @@END            *****5         056095
     C***********          MOVE @ICMT     @@CALC           *****5         056095
     C                     Z-ADD@VDAT5    ZZBEG            *****5         056095
     C                     Z-ADD@MDAT5    ZZEND            *****5         056095
     C                     MOVE @ICMT     ZZCALC           *****5         056095
     C                     Z-SUB@AMNP     @@AMT            *****5
     C                     Z-ADD@INTR     @@RATE           *****5
     C******************** EXSR MM1007                     *****5         E17051
     C                     EXSR MM1030                     *****5         E17051
      *
      **  Add interest due to maturity date.
     C                     Z-ADD@@INTR    @AMNT            *****5
     C                     Z-ADD@MDAT5    @SDAT            *****5
     C                     Z-ADD99999     @EDAT            *****5
     C                     MOVE '+'       @ADSUB           *****5
     C                     EXSR #ZB                        *****5
     C                     END                             E****5
     C/COPY WNCPYSRC,MM0073C064
      *
     C/COPY WNCPYSRC,MM0073C065
     C                     END                             E***4
      *
     C                     END                             E**3
      *
     C                     ELSE                            X*2
      *
      **  If related NAS exists.
     C           IHDADN    IFNE *BLANKS                    B**3
      *
      **  If before update next interest date before NAS value date.
     C           @BNID     IFLT IHRVDT                     B***4
      *
      **  If next interest date before NAS value date.
     C           @NIDT     IFLT IHRVDT                     B****5
      *
      **  Calculate interest due at before update next interest date.
     C           @BLID     IFNE *ZEROS                     B*****6
     C           @BNID     ANDNE*ZEROS                     X*****6
     C***********          Z-ADD@BLID5    @@BEG            ******6        056095
     C***********          Z-ADD@BNID5    @@END            ******6        056095
     C***********          MOVE @BICM     @@CALC           ******6        056095
     C/COPY WNCPYSRC,MM0073C066
     C                     Z-ADD@BLID5    ZZBEG            ******6        056095
     C/COPY WNCPYSRC,MM0073C067
     C                     Z-ADD@BNID5    ZZEND            ******6        056095
     C                     MOVE @BICM     ZZCALC           ******6        056095
     C                     Z-SUB@BAMT     @@AMT            ******6
     C                     Z-ADD@BIRT     @@RATE           ******6
     C******************** EXSR MM1007                     ******6        E17051
     C                     EXSR MM1030                     ******6        E17051
      *
      **  Backout interest due from before update next interest date.
     C                     Z-ADD@@INTR    @AMNT            ******6
     C                     Z-ADD@BNID5    @SDAT            ******6
     C                     Z-ADD99999     @EDAT            ******6
     C                     MOVE '-'       @ADSUB           ******6
     C                     EXSR #ZB                        ******6
     C                     END                             E*****6
      *
      **  Calculate interest due at next interest date.
     C           @SLDT     IFNE *ZEROS                     B*****6
     C           @NIDT     ANDNE*ZEROS                     X*****6
     C***********          Z-ADD@SLDT5    @@BEG            ******6        056095
     C***********          Z-ADD@NIDT5    @@END            ******6        056095
     C***********          MOVE @ICMT     @@CALC           ******6        056095
     C                     Z-ADD@SLDT5    ZZBEG            ******6        056095
     C                     Z-ADD@NIDT5    ZZEND            ******6        056095
     C/COPY WNCPYSRC,MM0073C068
     C                     MOVE @ICMT     ZZCALC           ******6        056095
     C/COPY WNCPYSRC,MM0073C069
     C                     Z-SUB@AMNP     @@AMT            ******6
     C                     Z-ADD@INTR     @@RATE           ******6
     C******************** EXSR MM1007                     ******6        E17051
     C                     EXSR MM1030                     ******6        E17051
      *
      **  Add interest due to next interest date.
     C                     Z-ADD@@INTR    @AMNT            ******6
     C                     Z-ADD@NIDT5    @SDAT            ******6
     C                     Z-ADD99999     @EDAT            ******6
     C                     MOVE '+'       @ADSUB           ******6
     C                     EXSR #ZB                        ******6
     C                     END                             E*****6
      *
     C                     ELSE                            X****5
      *
      **  Calculate interest due at before update next interest date.
     C           @BLID     IFNE *ZEROS                     B*****6
     C           @BNID     ANDNE*ZEROS                     X*****6
     C***********          Z-ADD@BLID5    @@BEG            ******6        056095
     C***********          Z-ADD@BNID5    @@END            ******6        056095
     C***********          MOVE @BICM     @@CALC           ******6        056095
     C                     Z-ADD@BLID5    ZZBEG            ******6        056095
     C                     Z-ADD@BNID5    ZZEND            ******6        056095
     C                     MOVE @BICM     ZZCALC           ******6        056095
     C                     Z-SUB@BAMT     @@AMT            ******6
     C                     Z-ADD@BIRT     @@RATE           ******6
     C******************** EXSR MM1007                     ******6        E17051
     C                     EXSR MM1030                     ******6        E17051
     C/COPY WNCPYSRC,MM0073C070
      *
     C/COPY WNCPYSRC,MM0073C071
      **  Backout interest due from before update next interest date.
     C                     Z-ADD@@INTR    @AMNT            ******6
     C                     Z-ADD@BNID5    @SDAT            ******6
     C                     Z-ADD99999     @EDAT            ******6
     C                     MOVE '-'       @ADSUB           ******6
     C                     EXSR #ZB                        ******6
     C                     END                             E*****6
      *
     C                     END                             E****5
      *
     C                     ELSE                            X***4
      *
      **  If next interest date before NAS value date.
     C           @NIDT     IFLT IHRVDT                     B****5
      *
      **  Calculate interest due at next interest date.
     C           @SLDT     IFNE *ZEROS                     B*****6
     C           @NIDT     ANDNE*ZEROS                     X*****6
     C***********          Z-ADD@SLDT5    @@BEG            ******6        056095
     C***********          Z-ADD@NIDT5    @@END            ******6        056095
     C***********          MOVE @ICMT     @@CALC           ******6        056095
     C                     Z-ADD@SLDT5    ZZBEG            ******6        056095
     C                     Z-ADD@NIDT5    ZZEND            ******6        056095
     C                     MOVE @ICMT     ZZCALC           ******6        056095
     C                     Z-SUB@AMNP     @@AMT            ******6
     C                     Z-ADD@INTR     @@RATE           ******6
     C******************** EXSR MM1007                     ******6        E17051
     C/COPY WNCPYSRC,MM0073C072
     C                     EXSR MM1030                     ******6        E17051
     C/COPY WNCPYSRC,MM0073C073
      *
      **  Add interest due to next interest date.
     C                     Z-ADD@@INTR    @AMNT            ******6
     C                     Z-ADD@NIDT5    @SDAT            ******6
     C                     Z-ADD99999     @EDAT            ******6
     C                     MOVE '+'       @ADSUB           ******6
     C                     EXSR #ZB                        ******6
     C                     END                             E*****6
      *
     C                     END                             E****5
      *
     C                     END                             E***4
      *
     C                     ELSE                            E**3
      *
      **  Calculate interest due at before update next interest date.
     C           @BLID     IFNE *ZEROS                     B***4
     C           @BNID     ANDNE*ZEROS                     X***4
     C***********          Z-ADD@BLID5    @@BEG            ****4          056095
     C***********          Z-ADD@BNID5    @@END            ****4          056095
     C***********          MOVE @BICM     @@CALC           ****4          056095
     C/COPY WNCPYSRC,MM0073C074
     C                     Z-ADD@BLID5    ZZBEG            ****4          056095
     C/COPY WNCPYSRC,MM0073C075
     C                     Z-ADD@BNID5    ZZEND            ****4          056095
     C                     MOVE @BICM     ZZCALC           ****4          056095
     C                     Z-SUB@BAMT     @@AMT            ****4
     C                     Z-ADD@BIRT     @@RATE           ****4
     C******************** EXSR MM1007                     ****4          E17051
     C                     EXSR MM1030                     ****4          E17051
      *
      **  Backout interest due from before update next interest date.
     C                     Z-ADD@@INTR    @AMNT            ****4
     C                     Z-ADD@BNID5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  Calculate interest due at next interest date.
     C           @SLDT     IFNE *ZEROS                     B***4
     C           @NIDT     ANDNE*ZEROS                     X***4
     C***********          Z-ADD@SLDT5    @@BEG            ****4          056095
     C***********          Z-ADD@NIDT5    @@END            ****4          056095
     C***********          MOVE @ICMT     @@CALC           ****4          056095
     C                     Z-ADD@SLDT5    ZZBEG            ****4          056095
     C                     Z-ADD@NIDT5    ZZEND            ****4          056095
     C                     MOVE @ICMT     ZZCALC           ****4          056095
     C                     Z-SUB@AMNP     @@AMT            ****4
     C                     Z-ADD@INTR     @@RATE           ****4
     C******************** EXSR MM1007                     ****4          E17051
     C                     EXSR MM1030                     ****4          E17051
      *
      **  Add interest due to next interest date.
     C                     Z-ADD@@INTR    @AMNT            ****4
     C                     Z-ADD@NIDT5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C/COPY WNCPYSRC,MM0073C076
     C                     END                             E***4
     C/COPY WNCPYSRC,MM0073C077
      *
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
     C/COPY WNCPYSRC,MM0073C078
      *
     C/COPY WNCPYSRC,MM0073C079
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@MDAT5    @EDAT            *1
     C                     MOVE @ICMT     @CALC            *1
     C                     Z-SUB@AMNP     @AMNT            *1
     C                     Z-ADD@INTR     @RATE            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  But as interest calculated will be '-' IN #ZC so need
      **  to change the sign
     C/COPY WNCPYSRC,MM0073C080
      *
     C/COPY WNCPYSRC,MM0073C081
      **  Insert, so add interest accrued.
     C           IHLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
      **  Deletion, so remove interest accrued.
     C           IHLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0073C082
     C                     EXSR #ZC                        *1
     C/COPY WNCPYSRC,MM0073C083
     C                     END                             E1
      *
      **  Amendment.
     C           IHLACT    IFEQ 'A'                        B1
     C           @CHG      ANDEQ'Y'                        X1
      *
      **  But as interest calculated will be '-' in #ZC so need to
      **  change the sign
      *
      **  If no related NAS exists.
     C           IHDADN    IFEQ *BLANKS                    B*2
      *
      **  Add interest accrued.
     C/COPY WNCPYSRC,MM0073C084
     C           @FLAG     IFEQ 1                          B**3
     C/COPY WNCPYSRC,MM0073C085
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
      **  Remove interest accrued before update.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           @BMTD     ANDNE*ZEROS                     X**3
     C                     Z-ADD@BVDT5    @SDAT            ***3
     C                     Z-ADD@BMTD5    @EDAT            ***3
     C                     MOVE @BICM     @CALC            ***3
     C                     Z-SUB@BAMT     @AMNT            ***3
     C/COPY WNCPYSRC,MM0073C086
     C                     Z-ADD@BIRT     @RATE            ***3
     C/COPY WNCPYSRC,MM0073C087
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
     C                     ELSE                            X*2
      *
      **  Add interest accrued.
     C           @VDAT     IFNE *ZEROS                     B**3
     C           @MDAT     ANDNE*ZEROS                     X**3
     C                     Z-ADD@VDAT5    @SDAT            ***3
     C                     Z-ADD@RVDT5    @EDAT            ***3
     C                     MOVE @ICMT     @CALC            ***3
     C                     Z-SUB@AMNP     @AMNT            ***3
     C                     Z-ADD@INTR     @RATE            ***3
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
      **  Remove interest accrued before update.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           @BMTD     ANDNE*ZEROS                     X**3
     C                     Z-ADD@BVDT5    @SDAT            ***3
     C                     Z-ADD@RVDT5    @EDAT            ***3
     C                     MOVE @BICM     @CALC            ***3
     C                     Z-SUB@BAMT     @AMNT            ***3
     C                     Z-ADD@BIRT     @RATE            ***3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BD9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BE      - Update Bills Bought balances                       *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*          #ZD      - Check for change if amendments            *
     C*          #ZE      - Update NAB's amendments NAS balances      *
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @MDAT  - Work field for maturity date              *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @FVAL  - Work field for Face value                 *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*            @BVDT5 - Work field for before value date          *
     C*            @BMTD5 - Work field for before Maturity date       *
     C*            @BAMT  - Work field for before amount              *
     C*            @BFVL  - Work field for Before face value          *
     C*            @RVDT5 - Work field for related value date         *
     C*            @ICMT  - Work field for Cal Method                 *
     C*            @CALC  - Work field for interest cal method        *
     C*            @INTR  - Work field for interest rate              *
     C*            @RATE  - work field for interest rate              *
     C*            @BICM  - Work field for Before Cal method          *
     C*            @BIRT  - Work field for Before int rate            *
     C*                                                               *
     C*****************************************************************
     C           #BE       BEGSR
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @MDAT5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           IHLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB  1        *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           IHLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and
      **  face value.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @MDAT     IFNE *ZEROS                     B1
     C                     Z-ADD@MDAT5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @FVAL     ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           IHLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           IHLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           IHLACT    IFEQ 'A'                        B1
     C                     EXSR #ZD                        *1
      *
      **  Deal has been changed.
     C           @CHG      IFEQ 'Y'                        B*2
      *
      **  If no related NAS exists.
     C           IHDADN    IFEQ *BLANKS                    B**3
      *
      **  Add new amount...
     C           @VDAT     IFNE *ZEROS                     B***4
     C           @MDAT     ANDNE*ZEROS                     X***4
     C                     Z-ADD@VDAT5    @SDAT            ****4
     C           @MDAT5    SUB  1         @EDAT            ****4
     C                     Z-ADD@AMNP     @AMNT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  ...remove previous amount.
     C           @BVDT     IFNE *ZEROS                     B***4
     C           @BMTD     ANDNE*ZEROS                     X***4
     C                     Z-ADD@BVDT5    @SDAT            ****4
     C           @BMTD5    SUB  1         @EDAT            ****4
     C                     Z-ADD@BAMT     @AMNT            ****4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  Update balances with difference between purchase price and face value.
      **  Add new amount...
     C           @MDAT     IFNE *ZEROS                     B***4
     C                     Z-ADD@MDAT5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C           @FVAL     ADD  @AMNP     @AMNT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  ...and remove previous amount.
     C           @MDAT     IFNE *ZEROS                     B***4
     C                     Z-ADD@BMTD5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C           @BFVL     ADD  @BAMT     @AMNT            ****4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
     C                     ELSE                            X**3
      *
      **  If related NAS does exist, add new amount up to NAS value date...
     C           @VDAT     IFNE *ZEROS                     B***4
     C           IHRVDT    ANDNE*ZEROS                     X***4
     C                     Z-ADD@VDAT5    @SDAT            ****4
     C                     Z-ADD@RVDT5    @EDAT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  ...and remove previous amount from NAS value date.
     C           @BVDT     IFNE *ZEROS                     B***4
     C           IHRVDT    ANDNE*ZEROS                     X***4
     C                     Z-ADD@BVDT5    @SDAT            ****4
     C                     Z-ADD@RVDT5    @EDAT            ****4
     C                     Z-ADD@BAMT     @AMNT            ****4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  Update balances with difference between purchase prices.
     C           IHRVDT    IFNE *ZEROS                     B***4
     C                     Z-ADD@RVDT5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C           @AMNP     SUB  @BAMT     @AMNT            ****4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C/COPY WNCPYSRC,MM0073C088
     C                     END                             E***4
     C/COPY WNCPYSRC,MM0073C089
      *
      **  Update NAB's sold amendments NAS balances
     C                     EXSR #ZE
      *
     C                     END                             E**3
      *
     C/COPY WNCPYSRC,MM0073C090
     C                     END                             E*2
     C/COPY WNCPYSRC,MM0073C091
      *
     C                     END                             E1
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@MDAT5    @EDAT            *1
     C                     MOVE @ICMT     @CALC            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C/COPY WNCPYSRC,MM0073C092
     C                     Z-ADD@INTR     @RATE            *1
     C/COPY WNCPYSRC,MM0073C093
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add interest accrued.
     C           IHLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
      **  Deletion, so remove interest accrued.
     C/COPY WNCPYSRC,MM0073C094
     C           IHLACT    IFEQ 'D'                        B1
     C/COPY WNCPYSRC,MM0073C095
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           IHLACT    IFEQ 'A'                        B1
     C           @CHG      ANDEQ'Y'                        X1
      *
      **  If no related NAS exists.
     C           IHDADN    IFEQ *BLANKS                    B*2
      *
      **  Add interest accrued.
     C/COPY WNCPYSRC,MM0073C096
     C           @FLAG     IFEQ 1                          B**3
     C/COPY WNCPYSRC,MM0073C097
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
      **  Remove interest accrued before update.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           @BMTD     ANDNE*ZEROS                     X**3
     C                     Z-ADD@BVDT5    @SDAT            ***3
     C                     Z-ADD@BMTD5    @EDAT            ***3
     C                     MOVE @BICM     @CALC            ***3
     C                     Z-ADD@BAMT     @AMNT            ***3
     C/COPY WNCPYSRC,MM0073C098
     C                     Z-ADD@BIRT     @RATE            ***3
     C/COPY WNCPYSRC,MM0073C099
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
     C                     ELSE                            X*2
      *
      **  Add interest accrued.
     C           @VDAT     IFNE *ZEROS                     B**3
     C           IHRVDT    ANDNE*ZEROS                     X**3
     C                     Z-ADD@VDAT5    @SDAT            ***3
     C                     Z-ADD@RVDT5    @EDAT            ***3
     C                     MOVE @ICMT     @CALC            ***3
     C                     Z-ADD@AMNP     @AMNT            ***3
     C                     Z-ADD@INTR     @RATE            ***3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
      **  Remove interest accrued before update.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           IHRVDT    ANDNE*ZEROS                     X**3
     C                     Z-ADD@BVDT5    @SDAT            ***3
     C                     Z-ADD@RVDT5    @EDAT            ***3
     C                     MOVE @BICM     @CALC            ***3
     C                     Z-ADD@BAMT     @AMNT            ***3
     C                     Z-ADD@BIRT     @RATE            ***3
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZC                        ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BE9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BF      - Update CD's Sold Balances                          *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*          #ZD      - Check for change if amendments            *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C********** MM1007   - Calculate interest                        *   E17051
     C*          MM1030   - Calculate interest                        *   E17051
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @RMTD5 - Work field for related maturity date      *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @BVDT5 - Work field for before value date          *
     C*            @BAMT  - Work field for before amount              *
     C*            @WN60  - Key field for deams file                  *
     C*            @DMVD  - Work field for deam value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*            @RLID5 - Work field for related start last date    *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*************@@END**-*work*field*for*End*date********************   056095
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @@AMT  - Work field for amount                     *
     C*            @@RATE - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @RNID5 - Work field for related next int date      *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*                                                               *
     C*****************************************************************
     C           #BF       BEGSR
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           ILRMTD    ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @RMTD5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           ILLACT    IFEQ 'A'                        B1
     C                     EXSR #ZD                        *1
      *
      **  Deal has been changed, so add new amount...
     C           @CHG      IFEQ 'Y'                        B*2
      *
     C           @FLAG     IFEQ 1                          B**3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
      **  ...and remove previous amount.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           ILRMTD    ANDNE*ZEROS                     X**3
     C                     Z-ADD@BVDT5    @SDAT            ***3
     C           @RMTD5    SUB  1         @EDAT            ***3
     C                     Z-ADD@BAMT     @AMNT            ***3
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and
      **  sale price.
      **  In effect this is profit/loss. Note that if NA is parcelled     S01378
      **  ILRBAT is overwritten in this program so it contains the        S01378
      **  purchase price of the NA's being sold.                          S01378
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           ILRMTD    IFNE *ZEROS                     B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           ILRBAT    ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           ILLACT    IFEQ 'A'                        B1
     C           @CHG      ANDEQ'Y'                        X1
      *
      **  Add new amount...
     C           @FLAG     IFEQ 1                          B*2
     C                     MOVE '+'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
      *
      **  ...and remove previous amount.
     C           @FLAG     IFEQ 1                          B*2
     C                     Z-ADD@RMTD5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C           ILRBAT    ADD  @BAMT     @AMNT            **2
     C                     MOVE '-'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and face value.
      **  This is removing the expected profit/loss which was added       S01378
      **  when NA purchase was entered and it was expected that it        S01378
      **  stay on the book until maturity (where p/l is difference        S01378
      **  between what you paid and what you get back at maturity).       S01378
      **  Note that if NA is parcelled ILRBAT and ILRFVL are              S01378
      **  overwritten in this program so they contains the face value     S01378
      **  and purchase price of the NA's being sold.                      S01378
     C           @FLAG     IFEQ 1                          B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           ILRFVL    ADD  ILRBAT    @AMNT            *1
     C                     END                             E1
      *
      **  Insert, so subtract amount.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so add amount.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with interest.
     C                     Z-ADD*ZEROS    @FLAG
      *
      **  If related NAB next interest date is zero, access DEAM file.
     C           ILRNID    IFEQ *ZEROS                     B1
     C                     MOVE ILDADN    @WN60   60       *1
     C           @WN60     SETLLMMLVDMLL                   *1
     C/COPY WNCPYSRC,MM0073C100
     C           @WN60     READEMMLVDMLL                 76*1
     C/COPY WNCPYSRC,MM0073C101
      *
      **  If SI DEAM exists, and DEAM value date after NAS value date.
     C           *IN76     IFEQ '0'                        B*2
      *
     C           @DMVD     IFGE @VDAT                      B**3
      *
      **  Calculate interest due from related start/last interest date.
     C           ILRLID    ANDNE*ZEROS                     X**3
     C           @DMVD     ANDNE*ZEROS                     X**3
     C***********          Z-ADD@DMVD     @@DTIN           ***3           056095
     C***********          EXSR ZA0680                     ***3           056095
     C***********          Z-ADD@@MDNO    @DMVD5           ***3           056095
     C                     Z-ADD@DMVD     ZZDTIN           ***3           056095
     C                     EXSR ZDAT10                     ***3           056095
     C                     Z-ADDZZMDNO    @DMVD5           ***3           056095
      *
     C***********          Z-ADD@RLID5    @@BEG            ***3           056095
     C***********          Z-ADD@DMVD5    @@END            ***3           056095
     C***********          MOVE ILRICM    @@CALC           ***3           056095
     C                     Z-ADD@RLID5    ZZBEG            ***3           056095
     C                     Z-ADD@DMVD5    ZZEND            ***3           056095
     C                     MOVE ILRICM    ZZCALC           ***3           056095
     C*******              Z-ADDILRFVL    @@AMT            ***3           ME2057
     C*******              Z-ADDILRFRT    @@RATE           ***3           ME2057
     C/COPY WNCPYSRC,MM0073C102
     C                     Z-SUBILRBAT    @@AMT            ***3           ME2057
     C/COPY WNCPYSRC,MM0073C103
     C                     Z-ADDILRIRT    @@RATE           ***3           ME2057
     C******************** EXSR MM1007                     ***3           E17051
     C                     EXSR MM1030                     ***3           E17051
      *
      **  Backout interest due from DEAM value date to end of book.
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@DMVD5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     Z-ADD1         @FLAG            ***3
     C                     END                             E**3
      *
     C                     ELSE                            X*2
      *
      **  If no SI DEAM's, calculate interest due at related maturity date.
     C           ILRLID    IFNE *ZEROS                     B**3
     C           ILRMTD    ANDNE*ZEROS                     X**3
     C***********          Z-ADD@RLID5    @@BEG            ***3           056095
     C***********          Z-ADD@RMTD5    @@END            ***3           056095
     C***********          MOVE ILRICM    @@CALC           ***3           056095
     C                     Z-ADD@RLID5    ZZBEG            ***3           056095
     C                     Z-ADD@RMTD5    ZZEND            ***3           056095
     C                     MOVE ILRICM    ZZCALC           ***3           056095
     C*********            Z-ADDILRFVL    @@AMT            ***3
     C*********            Z-ADDILRFRT    @@RATE           ***3
     C                     Z-SUBILRBAT    @@AMT            ***3
     C                     Z-ADDILRIRT    @@RATE           ***3
     C******************** EXSR MM1007                     ***3           E17051
     C                     EXSR MM1030                     ***3           E17051
      *
     C/COPY WNCPYSRC,MM0073C104
      **  ...and remove interest due at NAB maturity date.
     C/COPY WNCPYSRC,MM0073C105
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@RMTD5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     Z-ADD1         @FLAG            ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     ELSE                            X1
      *
      **  If next NAB interest date is after NAS value date...
     C           ILRNID    IFGE @VDAT                      B*2
      *
      **  ...calculate interest due...
     C           ILRLID    IFNE *ZEROS                     B**3
     C           ILRNID    ANDNE*ZEROS                     X**3
     C***********          Z-ADD@RLID5    @@BEG            ***3           056095
     C***********          Z-ADD@RNID5    @@END            ***3           056095
     C***********          MOVE ILRICM    @@CALC           ***3           056095
     C                     Z-ADD@RLID5    ZZBEG            ***3           056095
     C                     Z-ADD@RNID5    ZZEND            ***3           056095
     C                     MOVE ILRICM    ZZCALC           ***3           056095
     C********             Z-ADDILRFVL    @@AMT            ***3           ME2057
     C********             Z-ADDILRFRT    @@RATE           ***3           ME2057
     C                     Z-SUBILRBAT    @@AMT            ***3           ME2057
     C                     Z-ADDILRIRT    @@RATE           ***3           ME2057
     C******************** EXSR MM1007                     ***3           E17051
     C                     EXSR MM1030                     ***3           E17051
      *
      **  ...and remove interest due at SI value date.
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@RNID5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     Z-ADD1         @FLAG            ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Insert, so subtract amount.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so add amount.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           ILLACT    IFEQ 'A'                        B1
     C           @FLAG     ANDEQ1                          X1
     C           @BVDT5    ANDNE@VDAT                      X1
      *
      ** CHECK WHETHER NAS VALUE DATE IS BEFORE OR AFTER NEXT
      ** INT PAYMENT
      *
      ** IF BEFORE NAS VALUE DATE <= NEXT INT <= AFTER NAS VALUE DATE
     C           @BVDT5    IFLE ILRNID                     B*2
     C           ILRNID    ANDGE@VDAT                      X*2
     C                     MOVE '+'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
      *
      ** IF AFTER  NAS VALUE DATE <= NEXT INT <= BEFORE NAS VALUE DATE
     C/COPY WNCPYSRC,MM0073C106
     C           @VDAT     IFLE ILRNID                     X*2
     C/COPY WNCPYSRC,MM0073C107
     C           ILRNID    ANDGE@BVDT5                     B*2
     C                     MOVE '-'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C/COPY WNCPYSRC,MM0073C108
      *
     C/COPY WNCPYSRC,MM0073C109
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           ILRMTD    ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@RMTD5    @EDAT            *1
     C                     MOVE ILRICM    @CALC            *1
     C/COPY WNCPYSRC,MM0073C110
     C                     Z-SUBILRBAT    @AMNT            *1
     C/COPY WNCPYSRC,MM0073C111
     C                     Z-ADDILRIRT    @RATE            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  But as interest calculated will be '-' in #ZC so need to
      **  change the sign
      *
      **  Insert, so subtract interest accrued.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0073C112
     C                     EXSR #ZC                        *1
     C/COPY WNCPYSRC,MM0073C113
     C                     END                             E1
      *
      **  Deletion, so add interest accrued.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           ILLACT    IFEQ 'A'                        B1
      *
      **  Subtract interest accrued.
     C           @FLAG     IFEQ 1                          B*2
     C                     MOVE '-'       @ADSUB           **2
     C                     EXSR #ZC                        **2
     C                     END                             E*2
      *
      **  Add interest accrued before update.
     C           @BVDT     IFNE *ZEROS                     B*2
     C           ILRMTD    ANDNE*ZEROS                     X*2
     C                     Z-ADD@BVDT5    @SDAT            **2
     C                     Z-ADD@RMTD5    @EDAT            **2
     C                     MOVE ILRICM    @CALC            **2
     C                     Z-SUBILRBAT    @AMNT            **2
     C                     Z-ADDILRIRT    @RATE            **2
     C                     MOVE '+'       @ADSUB           **2
     C                     EXSR #ZC                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BF9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BG      - Update Bills sold balances                         *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*          #ZD      - Check for change if amendments            *
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @RMTD5 - Work field for related maturity date      *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @BVDT5 - Work field for before value date          *
     C*            @BAMT  - Work field for before amount              *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*                                                               *
     C*****************************************************************
     C           #BG       BEGSR
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           ILRMTD    ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @RMTD5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           ILLACT    IFEQ 'A'                        B1
     C                     EXSR #ZD                        *1
      *
      **  Deal has been changed, so add new amount...
     C           @CHG      IFEQ 'Y'                        B*2
      *
     C           @FLAG     IFEQ 1                          B**3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
      **  ...and remove previous amount.
     C           @BVDT     IFNE *ZEROS                     B**3
     C           ILRMTD    ANDNE*ZEROS                     X**3
     C                     Z-ADD@BVDT5    @SDAT            ***3
     C           @RMTD5    SUB  1         @EDAT            ***3
     C                     Z-ADD@BAMT     @AMNT            ***3
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and
      **  sale price.
      **  In effect this is profit/loss. Note that if NA is parcelled     S01378
      **  ILRBAT is overwritten in this program so it contains the        S01378
      **  purchase price of the NA's being sold.                          S01378
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           ILRMTD    IFNE *ZEROS                     B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           ILRBAT    ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so remove amount.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           ILLACT    IFEQ 'A'                        B1
     C           @CHG      ANDEQ'Y'                        X1
      *
      **  Add new amount...
     C           @FLAG     IFEQ 1                          B*2
     C                     MOVE '+'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
      *
      **  ...and remove previous amount.
     C           @FLAG     IFEQ 1                          B*2
     C                     Z-ADD@RMTD5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C           ILRBAT    ADD  @BAMT     @AMNT            **2
     C                     MOVE '-'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and face value.
      **  This is removing the expected profit/loss which was added       S01378
      **  when NA purchase was entered and it was expected that it        S01378
      **  stay on the book until maturity (where p/l is difference        S01378
      **  between what you paid and what you get back at maturity).       S01378
      **  Note that if NA is parcelled ILRBAT and ILRFVL are              S01378
      **  overwritten in this program so they contains the face value     S01378
      **  and purchase price of the NA's being sold.                      S01378
     C           @FLAG     IFEQ 1                          B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           ILRFVL    ADD  ILRBAT    @AMNT            *1
     C                     END                             E1
      *
      **  Insert, so subtract amount.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C/COPY WNCPYSRC,MM0073C114
     C                     MOVE '-'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0073C115
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Deletion, so add amount.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C/COPY WNCPYSRC,MM0073C116
     C                     MOVE '+'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0073C117
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           ILRMTD    ANDNE*ZEROS                     X1
     C/COPY WNCPYSRC,MM0073C118
     C                     Z-ADD@VDAT5    @SDAT            *1
     C/COPY WNCPYSRC,MM0073C119
     C                     Z-ADD@RMTD5    @EDAT            *1
     C                     MOVE ILRICM    @CALC            *1
     C                     Z-ADDILRBAT    @AMNT            *1
     C                     Z-ADDILRIRT    @RATE            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so subtract interest accrued.
     C           ILLACT    IFEQ 'I'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '-'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0073C120
     C                     EXSR #ZC                        *1
     C/COPY WNCPYSRC,MM0073C121
     C                     END                             E1
      *
      **  Deletion, so add interest accrued.
     C           ILLACT    IFEQ 'D'                        B1
     C           @FLAG     ANDEQ1                          X1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
      **  Amendment.
     C           ILLACT    IFEQ 'A'                        B1
      *
      **  Subtract interest accrued.
     C           @FLAG     IFEQ 1                          B*2
     C                     MOVE '-'       @ADSUB           **2
     C                     EXSR #ZC                        **2
     C                     END                             E*2
      *
      **  Add interest accrued before update.
     C           @BVDT     IFNE *ZEROS                     B*2
     C           @BMTD     ANDNE*ZEROS                     X*2
     C                     Z-ADD@BVDT5    @SDAT            **2
     C                     Z-ADD@RMTD5    @EDAT            **2
     C                     MOVE ILRICM    @CALC            **2
     C                     Z-ADDILRFVL    @AMNT            **2
     C                     Z-ADDILRIRT    @RATE            **2
     C                     MOVE '+'       @ADSUB           **2
     C                     EXSR #ZC                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BG9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BH      - Update SI deam balances                            *
     C*                                                               *
     C* CALLS
     C*          #ZB      - Update balance array                      *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @MPHAS - Data structure status of system           *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            @VDAT5 - Work field for value date                 *
     C*************@@END**-*work*field*for*End*date********************   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            @ICMT  - Work field for Cal Method                 *
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @FVAL  - Work field for Face value                 *
     C*            @@AMT  - Work field for amount                     *
     C*            @FRAT  - Work field for Face rate                  *
     C*            @@RATE - Work field for interest rate              *
     C*            @AMNP  - Work field for amount                     *
     C*            @INTR  - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @AMNT  - Work field for amount                     *
     C*            @SDAT  - Period Start date                         *
     C*            @EDAT  - Period end date                           *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @MDAT  - Work field for maturity date              *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @VDYY  - Work field for value Year                 *
     C*            @VDMM  - Work field for Value month                *
     C*            @VDDD  - Work field for value day                  *
     C*            @FLAG  - Work field for update operation           *
     C*            @DMVD  - work field for deam value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*                                                               *
     C*****************************************************************
     C           #BH       BEGSR
      *
     C           IGAMNP    IFNE *ZEROS                     B*2
      *
      **  Determine whether DEAM with later value date exists.
     C           DMKEY     KLIST                           **2
     C                     KFLD           IGDA38           **2
     C                     KFLD           IGVDYY                          S01136
     C                     KFLD           IGVDMM                          S01136
     C                     KFLD           IGVDDD                          S01136
      *
     C********** DMKEY     SETLLMMLVDMLL                   **2            S01136
     C           DMKEY     SETGTMMLVDMLL                                  S01136
     C           IGDA38    READEMMLVDMLL                 76**2
      *
      **  If DEAM exists...
     C           *IN76     IFEQ '0'                        B**3
      *
      **  If DEAM with earlier date exist no processing to be done
      **  branch to end of subroutine
     C           @DMVD     CABLE@VDAT     #BH9             ***3
      *
     C/COPY WNCPYSRC,MM0073C122
     C                     Z-ADD*ZEROS    @FLAG            ***3
     C/COPY WNCPYSRC,MM0073C123
      *
      **  Calculate interest due from start/last interest date.
     C           @SLDT     IFNE *ZEROS                     B***4
     C           @DMVD     ANDNE*ZEROS                     X***4
     C***********          Z-ADD@DMVD     @@DTIN           ****4          056095
     C***********          EXSR ZA0680                     ****4          056095
     C***********          Z-ADD@@MDNO    @DMVD5           ****4          056095
     C                     Z-ADD@DMVD     ZZDTIN           ****4          056095
     C                     EXSR ZDAT10                     ****4          056095
     C                     Z-ADDZZMDNO    @DMVD5           ****4          056095
      *
     C***********          Z-ADD@SLDT5    @@BEG            ****4          056095
     C***********          Z-ADD@DMVD5    @@END            ****4          056095
     C***********          MOVE @ICMT     @@CALC           ****4          056095
     C                     Z-ADD@SLDT5    ZZBEG            ****4          056095
     C                     Z-ADD@DMVD5    ZZEND            ****4          056095
     C                     MOVE @ICMT     ZZCALC           ****4          056095
      *
     C           IGORBS    IFEQ 'B'                        B****5
     C                     Z-SUB@FVAL     @@AMT            *****5
     C                     Z-ADD@FRAT     @@RATE           *****5
     C                     ELSE                            X****5
     C                     Z-ADD@AMNP     @@AMT            *****5
     C                     Z-ADD@INTR     @@RATE           *****5
     C                     END                             E****5
      *
     C******************** EXSR MM1007                     ****4          E17051
     C                     EXSR MM1030                     ****4          E17051
      *
      **  ...and update balances.
     C                     Z-SUB@@INTR    @AMNT            ****4
     C                     Z-ADD@DMVD5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C                     Z-ADD1         @FLAG            ****4
     C                     END                             E***4
      *
      **  Insert, so remove amount.
     C           IGLACT    IFEQ 'I'                        B***4
     C           @FLAG     ANDEQ1                          X***4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  Deletion, so add amount.
     C           IGLACT    IFEQ 'D'                        B***4
     C/COPY WNCPYSRC,MM0073C124
     C           @FLAG     ANDEQ1                          X***4
     C/COPY WNCPYSRC,MM0073C125
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
     C                     ELSE                            X**3
      *
     C                     Z-ADD*ZEROS    @FLAG            ***3
      *
      **  Calculate interest due at maturity...
     C           @SLDT     IFNE *ZEROS                     B***4
     C           @MDAT     ANDNE*ZEROS                     X***4
     C***********          Z-ADD@SLDT5    @@BEG            ****4          056095
     C***********          Z-ADD@MDAT5    @@END            ****4          056095
     C***********          MOVE @ICMT     @@CALC           ****4          056095
     C                     Z-ADD@SLDT5    ZZBEG            ****4          056095
     C                     Z-ADD@MDAT5    ZZEND            ****4          056095
     C                     MOVE @ICMT     ZZCALC           ****4          056095
      *
     C           IGORBS    IFEQ 'B'                        B****5
     C                     Z-SUB@FVAL     @@AMT            *****5
     C                     Z-ADD@FRAT     @@RATE           *****5
     C                     ELSE                            X****5
     C                     Z-ADD@AMNP     @@AMT            *****5
     C                     Z-ADD@INTR     @@RATE           *****5
     C                     END                             E****5
      *
     C******************** EXSR MM1007                     ****4          E17051
     C                     EXSR MM1030                     ****4          E17051
      *
      **  ...and update balances.
     C                     Z-SUB@@INTR    @AMNT            ****4
     C                     Z-ADD@MDAT5    @SDAT            ****4
     C                     Z-ADD99999     @EDAT            ****4
     C                     Z-ADD1         @FLAG            ****4
     C                     END                             E***4
      *
      **  Insert, so remove amount.
     C           IGLACT    IFEQ 'I'                        B***4
     C           @FLAG     ANDEQ1                          X***4
     C                     MOVE '-'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
      **  Deletion, so add amount.
     C           IGLACT    IFEQ 'D'                        B***4
     C           @FLAG     ANDEQ1                          X***4
     C                     MOVE '+'       @ADSUB           ****4
     C                     EXSR #ZB                        ****4
     C                     END                             E***4
      *
     C                     END                             E**3
      *
      **  Update balances with DEAM amount.
     C                     Z-ADD*ZEROS    @FLAG            **2
      *
     C           @VDAT     IFNE *ZEROS                     B**3
     C                     Z-ADDIGAMNP    @AMNT            ***3
     C                     Z-ADD@VDAT5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     Z-ADD1         @FLAG            ***3
     C                     END                             E**3
      *
      **  Insert, so add amount.
     C           IGLACT    IFEQ 'I'                        B**3
     C           @FLAG     ANDEQ1                          X**3
     C                     MOVE '+'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
      **  Deletion, so remove amount.
     C           IGLACT    IFEQ 'D'                        B**3
     C           @FLAG     ANDEQ1                          X**3
     C                     MOVE '-'       @ADSUB           ***3
     C                     EXSR #ZB                        ***3
     C                     END                             E**3
      *
      **  NB no processing done for action code AMEND
      *
     C                     END                             E*2
      *
      *
     C           #BH9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BI      - Update Funds in Nostro at start of day             *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @TYPE  - Work field for deal type                  *
     C*            @RBSI  - Work field for BOUGHT or sold             *
     C*            @OPMT  - Work field for our pay method             *
     C*            @MTHD  - Work field for payment method             *
     C*            @ORMT  - Work field for our receive method         *
     C*            @LACT  - Work field for action code                *
     C*            @AMNP  - Work field for amount                     *
     C*            @BAMT  - Work field for before amount              *
     C*                                                               *
     C*****************************************************************
     C           #BI       BEGSR
      *
     C                     MOVE '0'       *IN60
      *
      **  Check for our pay method to be processed.
     C           @TYPE     IFEQ 'IP'                       B1
     C           @TYPE     OREQ 'TL'                       X1
     C           @TYPE     OREQ 'CL'                       X1
     C           @RBSI     OREQ 'B'                        X1
     C                     MOVE '1'       *IN60            *1
     C                     MOVE @OPMT     @MTHD   5        *1
     C                     END                             E1
      *
      **  Check for our receive method to be processed.
     C           @TYPE     IFEQ 'IT'                       B1
     C           @TYPE     OREQ 'TD'                       X1
     C           @TYPE     OREQ 'CI'                       X1
     C           @RBSI     OREQ 'S'                        X1
     C/COPY WNCPYSRC,MM0073C129
      *                                                                                       CDL033
     C           @TYPE     OREQ 'CF'                                                          CDL033
     C           CDL033    ANDEQ'Y'                                                           CDL033
      *                                                                                       CDL033
     C                     MOVE '1'       *IN60            *1
     C                     MOVE @ORMT     @MTHD            *1
     C                     END                             E1
      *
      **  Accumulate into nostro account.
     C           *IN60     IFEQ '1'                        B1
      *
     C           @MTHD     IFEQ 'TELX'                     B*2
     C           @MTHD     OREQ 'CHIPS'                    X*2
     C           @MTHD     OREQ 'SWIFT'                    X*2
     C           @MTHD     OREQ 'CSENT'                    X*2
     C           @MTHD     OREQ 'CCOLL'                    X*2
      *
      **  Insert, so add amount.
     C           @LACT     IFEQ 'I'                        B**3
     C                     ADD  @AMNP     HRNOSN           ***3
     C                     END                             E**3
      *
      **  Deletion, so remove amount.
     C           @LACT     IFEQ 'D'                        B**3
     C                     SUB  @AMNP     HRNOSN           ***3
     C                     END                             E**3
      *
      **  Amendment, so add amount, and remove original amount.
     C           @LACT     IFEQ 'A'                        B**3
     C                     ADD  @AMNP     HRNOSN           ***3
     C                     SUB  @BAMT     HRNOSN           ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BI9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZE      - Update NAB's amendments NAS balances               *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*                                                               *
     C* CALLED BY  #ZD    - Check for change if amendments            *
     C*            #B     - Control main processing                   *
     C*                                                               *
     C* FLDS USED  @BMTD  - Work field for Before Maturity date       *
     C*            @RVDT5 - Work field for related value date         *
     C*            @SDAT  - Period Start date                         *
     C*            @BMTD5 - Work field for before Maturity date       *
     C*            @EDAT  - Period end date                           *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @MDAT  - Work field for maturity date              *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @BAMT  - Work field for before amount              *
     C*            @AMNP  - Work field for amount                     *
     C*            @BFVL  - Work field for Before face value          *
     C*            @FVAL  - Work field for Face value                 *
     C*                                                               *
     C*****************************************************************
     C           #ZE       BEGSR
      *
      **  Subtract sale amount from before update maturity date-1.
     C           IHRVDT    IFNE *ZEROS                     B1
     C           @BMTD     ANDNE*ZEROS                     X1
     C                     Z-ADD@RVDT5    @SDAT            *1
     C           @BMTD5    SUB  1         @EDAT            *1
     C                     Z-ADDIHRBAT    @AMNT            *1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Add sale amount to maturity date-1.
     C           IHRVDT    IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C           @MDAT5    SUB  1         @EDAT            *1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Subtract difference between before update amount and sale price.
     C           @BMTD     IFNE *ZEROS                     B1
     C                     Z-ADD@BMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @BAMT     ADD  IHRBAT    @AMNT            *1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Add difference between purchase price and sale price.
     C           @MDAT     IFNE *ZEROS                     B1
     C                     Z-ADD@MDAT5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @AMNP     ADD  IHRBAT    @AMNT            *1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Subtract difference between before update amount and face value.
     C           @BMTD     IFNE *ZEROS                     B1
     C                     Z-ADD@BMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @BAMT     ADD  @BFVL     @AMNT            *1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Add difference between purchase price and face value.
     C           @MDAT     IFNE *ZEROS                     B1
     C                     Z-ADD@MDAT5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @AMNP     ADD  @FVAL     @AMNT            *1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
     C           #ZE9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BA      - Initialise new records                             *
     C*                                                               *
     C* CALLS    ZA0730   - Determine next working day                *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C***********ZA0710***-*Convert*midas*day*number*to*date*format****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*          ZDATE9   - Convert midas day number to date format   *   056095
     C*          MM1003   - Calculate period date                     *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @M     - Array to hold month names                 *
     C*            @USER  - work field for user                       *
     C*            @CCY   - Work field for currency                   *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            @@CCY  - work field for currency                   *
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @A     - Array to hold net balances                *
     C*            @I     - Array for net Interest accrued            *
     C*            @@DAYN - Work field for day number                 *
     C*            @@VDT  - Work field for period date                *
     C*            @@SPOT - Work field for spot date                  *
     C*            @@PNUM - Work field for period number (1,2,3 etc)  *
     C*            @@PTYP - Work field for period type (D, M or W)    *
     C*            @@PDAT - Work field for period end date            *
     C*                                                               *
     C*****************************************************************
     C           #BA       BEGSR
      *
      **  Create new record on MMEPOULL.
     C                     MOVE 'H2'      H2RCID
     C                     MOVE *BLANKS   H2DLTF
     C**********           Z-ADDUDAY      H2DLUP                          S01136
     C**********           MOVE @M,UMONTH H2MLUP                          S01136
     C**********           Z-ADDUYEAR     H2YLUP                          S01136
     C                     MOVE @RUNAD    H2DLUP                          S01136
     C                     MOVE @RUNAM    H2MLUP                          S01136
     C                     MOVE @RUNAY    H2YLUP                          S01136
     C                     TIME           H2TLUP
     C                     MOVE 'I'       H2CHTP
     C                     Z-ADDBJRDNB    H2LCD                           S01194
     C****************     Z-ADDRUND      H2LCD                           S01194
     C                     MOVEL@USER     H2LUID
     C                     MOVE @CCY      H2CCY
      *
      ****Access*FDCCYTLL to get default interest calculation method.     S01194
     C*********            MOVE *BLANKS   KEY                             S01194
     C*********            MOVEL'20'      KEY                             S01194
     C*********            MOVEL@CCY      KEY912  4                       S01194
     C*********            MOVE '1'       KEY912                          S01194
     C*********            MOVE KEY912    KEY                             S01194
     C*********  KEY       CHAINFDCCYTLL             60                   S01194
      *                                                                   S01194
      ** get default interest calculation method.                         S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*MSG   ' @RTCD                           S01194
     C                     PARM '*KEY   ' @OPTN                           S01194
     C                     PARM @CCY      @WRK3                           S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*                                                                   S01194
     C*********  @@KEY     CHAINFDCCYTLL             61                   S01194
      *
     C*********  *IN60     IFEQ '1'                        B1             S01194
     C           @RTCD     IFNE *BLANK                     B1             S01194
     C                     MOVE '003'     DBASE            ***************
     C*********            MOVEL'FDCCYTLL'DBFILE           *             *S01194
     C*********            MOVELKEY       DBKEY            * DBERROR 003 *S01194
     C                     MOVEL'SDCURRPD'DBFILE           *             *S01194
     C                     MOVEL@CCY      DBKEY            * DBERROR 003 *S01194
     C                     MOVE @OPTN     DBOPTN           *             *S01194
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     GOTO #BA9                       *1
     C                     END                             E1
      *
     C************         Z-ADDDICM      H2DICM                          S01194
     C                     MOVE A6DICB    H2DICM                          S01194
     C                     Z-ADD*ZEROS    H2NBSP
     C                     Z-ADD*ZEROS    H2NIAS
     C                     Z-ADD*ZEROS    H2CCPL
     C*************        Z-ADDMSPD      H2SPDT                          S01194
     C                     Z-ADDA6MMSD    H2SPDT                          S01194
      *
      ** Calculate spot date period date.
     C**************       Z-ADDMSPD      @@DTIN                          S01194
     C***********          Z-ADDA6MMSD    @@DTIN                    S01194056095
     C                     Z-ADDA6MMSD    ZZDTIN                          056095
     C*****                MOVE @CCY      @@CCY   3               *****   S01195
     C                     MOVE @CCY      ZCCY                            S01195
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         H2SPPD                          056095
     C           ZZMDNO    SUB  1         H2SPPD                          056095
      *
      ** Calculate number of days in period.
     C***********          Z-ADDMSPD      @@DTIN                          S01194
     C***********          Z-ADDA6MMSD    @@DTIN                    S01194056095
     C***********          EXSR ZA0680                                    056095
     C***********H2SPPD    SUB  @@MDNO    H2NDPD                          056095
     C                     Z-ADDA6MMSD    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           H2SPPD    SUB  ZZMDNO    H2NDPD                          056095
     C                     ADD  1         H2NDPD
      *
     C                     WRITEMMEPOSP0
      *
      **  Create new record on MMFNRULL.
     C                     MOVE 'HR'      HRRCID
     C                     MOVE *BLANKS   HRDLTF
     C**********           Z-ADDUDAY      HRDLUP                          S01136
     C**********           MOVE @M,UMONTH HRMLUP                          S01136
     C**********           Z-ADDUYEAR     HRYLUP                          S01136
     C                     MOVE @RUNAD    HRDLUP                          S01136
     C                     MOVE @RUNAM    HRMLUP                          S01136
     C                     MOVE @RUNAY    HRYLUP                          S01136
     C                     TIME           HRTLUP
     C                     MOVE 'I'       HRCHTP
     C                     Z-ADDBJRDNB    HRLCD                           S01194
     C***************      Z-ADDRUND      HRLCD                           S01194
     C                     MOVEL@USER     HRLUID
     C                     MOVE @CCY      HRCCY
     C***************      Z-ADDDICM      HRDICM                          S01194
     C                     MOVE A6DICB    HRDICM                          S01194
     C                     Z-ADD*ZEROS    HRNOSN
     C                     Z-ADD*ZEROS    @A
     C                     Z-ADD*ZEROS    @I
      *
      ** Calculate today period date.
     C************         Z-ADDRUND      @@DAYN                          S01194
     C                     Z-ADDBJRDNB    @@DAYN                          S01194
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C*****                MOVE @CCY      @@CCY                   *****   S01195
     C                     MOVE @CCY      ZCCY                            S01195
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDTD                          056095
     C           ZZMDNO    SUB  1         HRPDTD                          056095
      *
      ** Calculate D1 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD1                          056095
     C           ZZMDNO    SUB  1         HRPDD1                          056095
      *
      ** Calculate D2 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD2                          056095
     C           ZZMDNO    SUB  1         HRPDD2                          056095
      *
      ** Calculate D3 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD3                          056095
     C           ZZMDNO    SUB  1         HRPDD3                          056095
      *
      ** Calculate D4 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD4                          056095
     C           ZZMDNO    SUB  1         HRPDD4                          056095
      *
      ** Calculate W1 period date.
     C*****                MOVE @CCY      @@CCY                   *****   S01195
     C                     MOVE @CCY      ZCCY                            S01195
     C*************        MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD1         @@PNUM
     C                     MOVE 'W'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         HRPDW1                          056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDW1                          056095
      *
      ** Calculate M1 period date.
     C*************        MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD1         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         HRPDM1                          056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDM1                          056095
      *
      ** Calculate M2 period date.
     C**************       MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD2         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         HRPDM2                          056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDM2                          056095
      *
      ** Calculate M3 period date.
     C*************        MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD3         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         HRPDM3                          056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDM3                          056095
      *
      ** Calculate number of days in periods.
     C********** HRPDTD    SUB  RUND      HRDPTD                          S01194
     C           HRPDTD    SUB  BJRDNB    HRDPTD                          S01194
     C                     ADD  1         HRDPTD
     C           HRPDD1    SUB  HRPDTD    HRDPD1
     C           HRPDD2    SUB  HRPDD1    HRDPD2
     C           HRPDD3    SUB  HRPDD2    HRDPD3
     C           HRPDD4    SUB  HRPDD3    HRDPD4
     C           HRPDW1    SUB  HRPDD4    HRDPW1
     C           HRPDM1    SUB  HRPDW1    HRDPM1
     C           HRPDM2    SUB  HRPDM1    HRDPM2
     C           HRPDM3    SUB  HRPDM2    HRDPM3
      *
     C                     WRITEMMFNRDP0
      *
     C           #BA9      ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *       TITLE:DETERMINE NEXT WORKING DAY.                       *
      *                                                               *
      *       SUBROUTINE ZA0730 EXPECTS FIELD '@@DTIN' TO BE          *
      *       PASSED TO IT IN 'YYYYMMDD' FORMAT.IT THEN DETERMINES    *
      *       THE NEXT WORKING DAY AND RETURNS.                       *
      *                                                               *
      * INPUT  :@@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)*
      *         @@CCY  CURRENCY CODE   - IN FORMAT(3A)                *
      *                                                               *
      * OUTPUT :@@VDT  DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)*
      *                                                               *
      **USES*:***@@MDNO*MIDAS*DAY*NO*USED*BY*SR*ZA0680*****************   056095
      * USES :   ZZMDNO MIDAS DAY NO USED BY SR ZDAT10                *   056095
      *****      @@MNO  MIDAS DAY NO USED BY SR ZA0830            *****   S01195
      *          ZDAYNO MIDAS DAY NO USED BY SR ZCHKH                 *   S01195
      *****      @@HIND HOLIDAY IND.RETURNED BY ZA0830            *****   S01195
      *          ZIND HOLIDAY IND.RETURNED BY ZCHKH                   *   S01195
      *                                                               *
      *****************************************************************
     C           ZA0730    BEGSR
      *
      * CONVERT YYYYMMDD FORMAT TO MIDAS DAY NO.
      *
     C***********          EXSR ZA0680                                    056095
     C                     EXSR ZDAT10                                    056095
      *
     C           ZA0731    TAG
      *
     C***********          ADD  1         @@MDNO  50                      056095
     C                     ADD  1         ZZMDNO  50                      056095
      *
      * CHECK IF DAY NO. IS A HOLIDAY          .
      *
     C*****                Z-ADD@@MDNO    @@MNO   50              *****   S01195
     C***********          Z-ADD@@MDNO    ZDAYNO  50                S01195056095
     C                     Z-ADDZZMDNO    ZDAYNO  50                      056095
      *
     C*****                EXSR ZA0830                            *****   S01195
     C                     EXSR ZCHKH                                     S01195
      *
     C*****      @@HIND    IFEQ 'H'                               *****   S01195
     C           ZIND      IFEQ 'H'                                       S01195
     C                     GOTO ZA0731
     C                     END
      *
      * CONVERT MIDAS DAY NO. TO YYYYMMDD FORMAT.
      *
     C***********          Z-ADD@@MDNO    @@DAYN  50                      056095
     C                     Z-ADDZZMDNO    @@DAYN  50                      056095
      *
     C***********          EXSR ZA0710                                    056095
     C                     EXSR ZDATE9                                    056095
      *
     C           ZA0739    ENDSR                                       **
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUBROUTINE ZA0770 - THIS SUBROUTINE RECEIVES A 8/0 INPUT     *
      *                      DATE - FORMAT YYYYMMDD AND OUTPUTS A     *
      *                      6/0 DATE. IF FIELD DATF ON TABTB10 =     *
      *                      'M' OUTPUT FORMAT MMDDYY. IF FIELD       *
      *                      DATF = 'D' OUTPUT FORMAT DDMMYY.         *
      *                                                               *
      *  CALLED BY   :                                                *
      *                                                               *
      *  INPUT       : @@DTIN  - DATE INPUT (8,0)                     *
      *  OUTPUT      : @@DTOU  - DATE OUTPUT (6,0)                    *
      *                                                               *
      *  WORK FIELDS : @@YYY   - YEAR IN (2,0)                        *
      *              : @@MM    - MONTH IN (2,0)                       *
      *              : @@DD    - DAY IN (2,0)                         *
      *                                                               *
      *              : @@DAT1  - IF DATE DD/MM/YY DAY ELSE MONTH (2,0)*
      *              : @@DAT2  - IF DATE DD/MM/YY MONTH ELSE DAY (2,0)*
      *                                                               *
      *****************************************************************
     C           ZA0770    BEGSR
      *
     C                     Z-ADD@@YY      @@YYY
      *
      **  DATF = 'D' CONVERT TO MMDDYY FORMAT
     C********** DATF      IFEQ 'D'                        B1             S01194
     C           BJDFIN    IFEQ 'D'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT1           *1
     C                     Z-ADD@@MM      @@DAT2           *1
     C                     END                             E1
      *
      *
      **  DATF = 'M' CONVERT TO MMDDYY FORMAT
     C********** DATF      IFEQ 'M'                        B1             S01194
     C           BJDFIN    IFEQ 'M'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT2           *1
     C                     Z-ADD@@MM      @@DAT1           *1
     C                     END                             E1
      *
      **  MOVE YEAR PART OF DATA STRUCTURE
     C                     MOVE @@YYY     @@YY
      *
     C           ZA0779    ENDSR                           ***ZA0779***
      ***********************************************************************
      /EJECT
      ***********************************************************************
      *****                                                       *****   S01195
      **ZA0830 - THIS SUBROUTINE FINDS OUT WHETHER A PARTICULAR DAY****   S01195
      *****      IS A HOLIDAY IN A PARTICULAR CURRENCY            *****   S01195
      *****                                                       *****   S01195
      **CALLED BY :                                               *****   S01195
      *****                                                       *****   S01195
      **CALLS :                                                   *****   S01195
      *****                                                       *****   S01195
      **INPUT  : @@MNO  MIDAS DAY NUMBER 5N                       *****   S01195
      *****      @@CCY  CURRENCY CODE 3A                          *****   S01195
      *****                                                       *****   S01195
      **OUTPUT : @@HIND HOLIDAY/WORKING DAY INDICATOR 1A          *****   S01195
      *****                                                       *****   S01195
      **USES :   @@MNO  MIDAS DAY NUMBER                          *****   S01195
      *****      @@CCY  CURRENCY CODE                             *****   S01195
      *****      @@ONCE FIRST TIME THROUGH INDICATOR              *****   S01195
      *****      @@CY1  FIRST HALF OF CURRENCY ARRAY              *****   S01195
      *****      @@CY2  SECOND HALF OF CURRENCY ARRAY             *****   S01195
      *****      @@MNO6 MIDAS NUMBER WITH TRAILING BLANK          *****   S01195
      *****      @@HIND HOLIDAY/WORKING DAY INDICATOR             *****   S01195
      *****      @@INEX INCLUDE/EXCLUDE INDICATOR                 *****   S01195
      *****                                                       *****   S01195
      *****      INDICATORS                                       *****   S01195
      *****      80 RECORD NOT FOUND                              *****   S01195
      *****      81 CURRENCY NOT FOUND ON RECORD                  *****   S01195
      *****                                                       *****   S01195
      *****************************************************************   S01195
     C*****      ZA0830    BEGSR                                  *****   S01195
      *****                                                       *****   S01195
      ***OPEN CURRENCY/HOLIDAY FILE IF FIRST TIME THROUGH         *****   S01195
     C*****      @@ONCE    IFNE 'Y'                        B1     *****   S01195
     C*****                OPEN FDTABJLL                   *1     *****   S01195
     C*****                MOVE 'Y'       @@ONCE  1        *1     *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***BLANK OUT ARRAY                                          *****   S01195
     C*****                MOVE *BLANKS   @@CY1                   *****   S01195
     C*****                MOVE *BLANKS   @@CY2                   *****   S01195
      *****                                                       *****   S01195
      ***ACCESS TABLE ON FIRST KEY                                *****   S01195
     C*****                MOVEL@@MNO     @@MNO6  6               *****   S01195
     C*****                MOVE @@MNO6    @@0830 12               *****   S01195
     C*****                MOVEL'22    '  @@0830                  *****   S01195
     C*****                MOVE '1'       @@0830                  *****   S01195
     C*****      @@0830    CHAINTABLETJF             80           *****   S01195
      *****                                                       *****   S01195
      ***IF RECORD NOT FOUND OR DELETED                           *****   S01195
     C*****      *IN80     IFEQ '1'                        B1     *****   S01195
     C*****      RECI      OREQ '*'                        *1     *****   S01195
     C*****                MOVE 'W'       @@HIND           *1     *****   S01195
     C*****                GOTO ZA0839                     *1     *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***MOVE FIRST 25 CURRENCIES TO ARRAY                        *****   S01195
     C*****                MOVE HCCY      @@CY1                   *****   S01195
      *****                                                       *****   S01195
      ***ACCESS TABLE ON SECOND KEY                               *****   S01195
     C*****                MOVE '2'       @@0830                  *****   S01195
     C*****      @@0830    CHAINTABLETJF             80           *****   S01195
      *****                                                       *****   S01195
      ***IF SECOND RECORD FOUND AND NOT DELETED                   *****   S01195
     C*****      *IN80     IFEQ '0'                        B1     *****   S01195
     C*****      RECI      ANDNE'*'                        *1     *****   S01195
     C*****                MOVE HCCY      @@CY2            *1     *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***SEARCH ARRAY FOR INPUT CURRENCY                          *****   S01195
     C*****      @@CCY     LOKUP@CY                      81       *****   S01195
      *****                                                       *****   S01195
      ***IF INPUT CURRENCY IS IN ARRAY                            *****   S01195
     C*****      *IN81     IFEQ '1'                        B1     *****   S01195
      *****                                                       *****   S01195
      ***IF INCLUDE/EXCLUDE INDICATOR EQ 'E'                      *****   S01195
     C*****      INEX      IFEQ 'E'                        B*2    *****   S01195
     C*****                MOVE 'W'       @@HIND  1        **2    *****   S01195
     C*****                ELSE                            X*2    *****   S01195
     C*****                MOVE 'H'       @@HIND           **2    *****   S01195
     C*****                END                              *2    *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***IF INPUT CURRENCY IS NOT IN ARRAY                        *****   S01195
     C*****      *IN81     IFEQ '0'                        B1     *****   S01195
      *****                                                       *****   S01195
      ***IF INCLUDE/EXCLUDE INDICATOR EQ 'I'                      *****   S01195
     C*****      INEX      IFEQ 'I'                        B*2    *****   S01195
     C*****                MOVE 'W'       @@HIND           **2    *****   S01195
     C*****                ELSE                            X*2    *****   S01195
     C*****                MOVE 'H'       @@HIND           **2    *****   S01195
     C*****                END                              *2    *****   S01195
     C*****                END                             E1     *****   S01195
     C*****      ZA0839    ENDSR                                  *****   S01195
      *****************************************************************   S01195
     C/COPY ZSRSRC,ZCHKH                                                  S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
      *****************************************************************
      /EJECT
      *****************************************************************
      *   MM1003 - CALCULATE A PERIOD DATE                            *
      *                                                               *
      *   PERIOD DATES ARE CALCULATED FOR THE FOLLOWING PERIODS       *
      *      PERIOD TYPE       PERIOD NUMBER     PERIOD SHORTNAME     *
      *           D                 -1             OVERNIGHT          *
      *           D                  0             TOMORROW / NEXT    *
      *           D                  1             SPOT / NEXT        *
      *           W                  1             1 WEEK             *
      *           W                  2             2 WEEK             *
      *           W                  3             3 WEEK             *
      *           M                  1             1 MONTH            *
      *           M                  2             2 MONTH            *
      *           M                  3             3 MONTH            *
      *           M                  6             6 MONTH            *
      *           M                  9             9 MONTH            *
      *           Y                  1             1 YEAR             *
      *                                                               *
      *  CALLED BY    -                                               *
      *                                                               *
      *  CALLS        -                                               *
      *                                                               *
      *  ZA0770       - CONVERT DATE YYYYMMDD TO DDMMYY               *
      ***ZA0830*****  - CHECK IF DAY IS A WORKING DAY             *****   S01195
      *  ZA0730       - FIND NEXT WORKING DAY                         *
      ***ZA0710*******-*CONVERT*MIDAS*DAY*NO*TO*YYYYMMDD***************   056095
      ***ZA0680*******-*CONVERT*DATE*TO*MIDAS*DAY*NUMBER***************   056095
      *  ZDATE9       - CONVERT MIDAS DAY NO TO YYYYMMDD              *   056095
      *  ZDAT10       - CONVERT DATE TO MIDAS DAY NUMBER              *   056095
      *                                                               *
      *  CALLS PROGRAM ZA0270 CONVERT DATE TO MIDAS DAY NUMBER WITH   *
      *                VALIDATION CHECK                               *
      *                                                               *
      *  FIELDS INPUT -                                               *
      *                                                               *
      *  @@CCY   3    - CURRENCY                                      *
      *  @@SPOT  8    - MONEY MARKET SPOT DATE                        *
      *  @@PNUM  1,0  - PERIOD NUMBER                                 *
      *  @@PTYP  1    - PERIOD TYPE                                   *
      *  RUND    5,0  - MIDAS RUN DATE                                *
      *                                                               *
      *  FIELDS OUTPUT                                                *
      *                                                               *
      *  @@PDAT  8,0  - PERIOD DATE                                   *
      *                                                               *
      *  WORK FIELDS                                                  *
      *                                                               *
      *  @@DTIN  8,0  - DATE INPUT TO ZA0770 IN YYYYMMDD FORMAT       *
      *  ZZDTIN  8,0  - DATE INPUT TO ZA0730 IN YYYYMMDD FORMAT       *   056095
      *  @@DFMT  1    - DATE FORMAT                                   *
      *  @@RTNC  1    - RETURN INDICATOR FROM ZA0270                  *
      *  @@DAYN  5,0  - MIDAS DAY NUMBER                              *
      ***@@MNO   5,0  - MIDAS DAY NUMBER                          *****   S01195
      ***@@HIND  1    - HOLIDAY INDICATOR H OR W                  *****   S01195
      *  @@ADD   3,0  - CALCULATION WORK FIELD                        *
      ***@@VDT***8,0**-*DATE*OUTPUT*FROM*ZA0710************************   056095
      *  @@VDT   8,0  - DATE OUTPUT FROM ZDATE9                       *   056095
      *  @@RUND  8    - RUN DATE IN YYYYMMDD FORMAT                   *
      *                                                               *
      *****************************************************************
      *
     C           MM1003    BEGSR
      *
     C                     Z-ADD*ZERO     @@STRT
     C                     Z-ADD*ZERO     @@DTIN
     C                     Z-ADD*ZERO     @@SPDD
     C                     Z-ADD*ZERO     @@DATE
     C                     Z-ADD*ZERO     @@DTOU
     C                     Z-ADD*ZERO     @@Z71Y
     C                     Z-ADD*ZERO     @@VDT
      *
     C                     MOVE @@SPOT    @@SPDD
      **  SET UP STARTING POINT DATE AS SPOT DATE
     C                     Z-ADD@@SPDD    @@STRT
      *
      **  ADD PERIOD NUMBERS TO DATE
     C           @@PTYP    IFEQ 'M'                        B1
     C                     ADD  @@PNUM    @@STMT           *1
     C           @@STMT    IFGT 12                         B*2
     C                     SUB  12        @@STMT           **2
     C                     ADD  1         @@STYR           **2
     C                     END                              *2
     C                     END                             E1
      *
     C           @@PTYP    IFEQ 'Y'                        B1
     C                     ADD  1         @@STYR           *1
     C                     END                             E1
      *
      **  CONVERT DATE FORMAT FROM YYYYMMDD TO DDMMYY
     C                     Z-ADD@@STRT    @@DTIN
     C                     EXSR ZA0770
     C                     Z-ADD@@DTOU    @@DATE
      *
     C           *LIKE     DEFN @@VDT     @@RUND
     C           @@RUND    IFEQ *ZERO                      B1
     C******************   Z-ADDRUND      @@DTIN           *1             S01194
     C***********          Z-ADDBJRDNB    @@DTIN           *1       S01194056095
     C***********          EXSR ZA0710                     *1             056095
     C                     Z-ADDBJRDNB    @@DAYN           *1             056095
     C                     EXSR ZDATE9                     *1             056095
     C                     Z-ADD@@VDT     @@RUND           *1
     C                     END                             E1
      *
     C                     MOVEL'D'       @@DFMT  1
     C                     MOVE @@DATE    @@DATC  60
      *
      **  CONVERT STARTING DATE TO MIDAS DAY NUMBER FORMAT
     C           @@RTNC    DOUEQ'0'                        B1
     C                     CALL 'ZA0270'                   *1
     C                     PARM           @@DATC           *1
     C***************      PARM           DATF             *1             S01194
     C                     PARM           BJDFIN           *1             S01194
     C           @@RTNC    PARM           @@RTNC  1        *1
     C           @@DAYN    PARM           @@DAYN  50       *1
      *
     C                     SUB  1         @@DAY2           *1
     C                     MOVE @@DATE    @@DATC           *1
      *
     C                     END                             E1
      *
     C*****                Z-ADD@@DAYN    @@MNO                   *****   S01195
     C                     Z-ADD@@DAYN    ZDAYNO                          S01195
     C                     MOVEL@@RTNC    @@RTN
     C*
     C**  RESET STARTING POINT
     C***********          EXSR ZA0710                              ME1161056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     @@STRT                    ME1161
      *                                                                   E17654
      * CALCULATE 1W AS 7D                                                E17654
     C           @@PTYP    IFEQ 'W'                                       E17654
     C           @@PNUM    ANDEQ1                                         E17654
     C                     MOVE 'D'       @@PTYP                          E17654
     C                     Z-ADD7         @@PNUM                          E17654
     C           1         DO   7                                         E17654
     C********** @@HIND    DOUEQ'W'**********              B**3    E17654 S01195
     C           ZIND      DOUEQ'W'                        B**3    E17654 S01195
     C**********           ADD  1  *******@@MNO            ***3    E17654 S01195
     C                     ADD  1         ZDAYNO           ***3    E17654 S01195
     C**********           EXSR ZA0830**********           ***3    E17654 S01195
     C                     EXSR ZCHKH                      ***3    E17654 S01195
     C                     END                              **3           E17654
     C                     END                              **3           E17654
     C                     END                                            E17654
      *
      **  PROCESS PERIOD TYPE 'D'
     C           @@PTYP    IFEQ 'D'                        B1
      *
      **  IF PERIOD NUMBER = 1 FIND NEXT WORKING DAY
     C           @@PNUM    IFEQ 1                          B*2
     C*****      @@HIND    DOUEQ'W'                        B**3   *****   S01195
     C           ZIND      DOUEQ'W'                        B**3           S01195
     C*****                ADD  1         @@MNO            ***3   *****   S01195
     C                     ADD  1         ZDAYNO           ***3           S01195
     C*****                EXSR ZA0830                     ***3   *****   S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              **3
     C                     END                              *2
      *
      **  IF PERIOD NUMBER NE 1 FIND TOMORROW/NEXT DAY (AND OVERNIGHT)
      **  IE FIND NEXT WORKING DAY BEYOND RUND
     C           @@PNUM    IFLT 1                          B*2
     C***********          Z-ADD@@RUND    @@DTIN           **2            056095
     C                     Z-ADD@@RUND    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
     C                     Z-ADD@@VDT     @@PDAT           **2
     C                     END                              *2
      *
      **  IF PERIOD NUMBER IS -1 FIND NEXT WORKING DAY TOMM/NEXT.
      **  IE FIND NEXT WORKING DAY BEYOND RUND
     C           @@PNUM    IFEQ 0                          B*2
     C***********          Z-ADD@@PDAT    @@DTIN           **2            056095
     C                     Z-ADD@@PDAT    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
     C                     Z-ADD@@VDT     @@PDAT           **2
     C                     END                              *2
      *
     C                     END                             E1
      *
      **  PROCESS PERIOD TYPE 'W'
     C           @@PTYP    IFEQ 'W'                        B1
      *
      **  INCREMENT DAY NUMBER
     C           @@PNUM    MULT 7         @@ADD   30       *1
     C*****                ADD  @@ADD     @@MNO            *1     *****   S01195
     C                     ADD  @@ADD     ZDAYNO           *1             S01195
      *
      **  FIND NEXT WORKING DAY
     C*****                EXSR ZA0830                     *1     *****   S01195
     C                     EXSR ZCHKH                      *1             S01195
     C*****      @@HIND    DOWEQ'H'                        B*2    *****   S01195
     C           ZIND      DOWEQ'H'                        B*2            S01195
     C*****                ADD  1         @@MNO            **2    *****   S01195
     C                     ADD  1         ZDAYNO           **2            S01195
     C*****                EXSR ZA0830                     **2    *****   S01195
     C                     EXSR ZCHKH                      **2            S01195
     C                     END                              *2
     C                     END                             E1
      *
      **  PROCESS PERIOD TYPE 'M' OR 'Y'
     C           @@PTYP    IFEQ 'M'                        B1
     C           @@PTYP    OREQ 'Y'                        *1
      *
      **  IS SPOT LAST WORKING DAY IN MONTH
     C***********          Z-ADD@@SPDD    @@DTIN           *1             056095
     C                     Z-ADD@@SPDD    ZZDTIN           *1             056095
     C                     EXSR ZA0730                     *1
     C           @@SPMT    IFNE @@Z71M                     B*2
     C                     Z-ADD1         @@STDY           **2
     C           @@STMT    IFEQ 12                         B**3
     C                     Z-ADD1         @@STMT           ***3
     C                     ADD  1         @@STYR           ***3
     C                     ELSE                            X**3
     C                     ADD  1         @@STMT           ***3
     C                     END                              **3
      *
      **  CONVERT STARTING DATE TO MIDAS DAY NUMBER FORMAT
     C***********          Z-ADD@@STRT    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C*****                Z-ADD@@MDNO    @@MNO            **2    *****   S01195
     C***********          Z-ADD@@MDNO    ZDAYNO           **2      S01195056095
     C                     Z-ADD@@STRT    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    ZDAYNO           **2            056095
     C*****      @@HIND    DOUEQ'W'                        B**3   *****   S01195
     C           ZIND      DOUEQ'W'                        B**3           S01195
     C*****                SUB  1         @@MNO            ***3   *****   S01195
     C                     SUB  1         ZDAYNO           ***3           S01195
     C*****                EXSR ZA0830                     ***3   *****   S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              **3
     C                     GOTO M10038                     **2
     C                     END                              *2
      *
      **  IF THE STARTING POINT DAY IS A NON WORKING DAY AND THE NEXT
      **  WORKING DAY FALLS IN THE NEXT MONTH  FIND LAST WORKING DAY
      **  IN STARTING MONTH.
     C***********          Z-ADD@@STRT    @@DTIN           *1       ME1161056095
     C***********          EXSR ZA0680                     *1       ME1161056095
     C*****                Z-ADD@@MDNO    @@MNO            **2    **ME1161S01195
     C***********          Z-ADD@@MDNO    ZDAYNO           **2      S01195056095
     C                     Z-ADD@@STRT    ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    ZDAYNO           **2            056095
     C*****                EXSR ZA0830                     *1     *****   S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C*****      @@HIND    IFEQ 'H'                        B*2    *****   S01195
     C           ZIND      IFEQ 'H'                        B*2            S01195
     C***********          Z-ADD@@STRT    @@DTIN           **2            056095
     C                     Z-ADD@@STRT    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
      *
     C           @@STMT    IFNE @@Z71M                     B**3
     C*****      @@HIND    DOUEQ'W'                        B***4  *****   S01195
     C           ZIND      DOUEQ'W'                        B***4          S01195
     C*****                SUB  1         @@MNO            ****4  *****   S01195
     C                     SUB  1         ZDAYNO           ****4          S01195
     C*****                EXSR ZA0830                     *1     *****   S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              ***4
     C*******              GOTO M10038                     ***3     ME1161
     C                     END                              **3
     C                     GOTO M10038                     ***3     ME1161
     C                     END                              *2
      *
      **  IF STARTING DATE IS A WORKING DAY IN CURRENCY & SPOT DATE
      **  IS NOT LAST WORKING DAY IN MONTH PERIOD DATE IS STARTING DAY
     C                     Z-ADD@@STRT    @@PDAT           *1
     C                     GOTO M10039                     *1
      *
     C                     END                             E1
      *
     C           M10038    TAG
      *
      **  CONVERT DATE TO YYYYMMDD FORMAT
     C*****                Z-ADD@@MNO     @@DAYN                  *****   S01195
     C                     Z-ADDZDAYNO    @@DAYN                          S01195
     C***********          EXSR ZA0710                                    056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     @@PDAT  80
      *
     C                     GOTO M10039
      *
     C                     Z-ADD0         @@PNUM  10
     C                     MOVE *BLANKS   @@PTYP  1
     C                     MOVE *BLANKS   @@SPOT  8
      *
     C           M10039    ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #A       - Initial Processing                                 *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  MAIN   - Main Line process                         *
     C*                                                               *
     C* FLDS USED  @FCYC  - Work field for first cycle processing     *
     C*            @TERM  - Termination parameter                     *
     C*            @DCAT  - Work field for Format read                *
     C*            @STDL  - Data structure for loan/deposit record    *
     C*            @STDB  - Data structure for NAB record             *
     C*            @STDS  - Data structure for NAS record             *
     C*            @STDA  - Data structure for DEAMs record           *
     C*            @MPHAS - Data structure status of system           *
     C*            @TYPE  - Work field for deal type                  *
     C*            @CCY   - Work field for currency                   *
     C*            @LACT  - Work field for action code                *
     C*            @RBSI  - Work field for BOUGHT or sold             *
     C*            @AMNP  - Work field for amount                     *
     C*            @BAMT  - Work field for before amount              *
     C*            @BVDT  - Work filed for Before deal value date     *
     C*            @BNID  - Work field for before next int date       *
     C*            @BMTD  - Work field for Before Maturity date       *
     C*            @BLID  - Work field for before start last int date *
     C*            @INTR  - Work field for interest rate              *
     C*            @BIRT  - Work field for Before int rate            *
     C*            @ICMT  - Work field for Cal Method                 *
     C*            @BICM  - Work field for Before Cal method          *
     C*            @FVAL  - Work field for Face value                 *
     C*            @BFVL  - Work field for Before face value          *
     C*            @FRAT  - Work field for Face rate                  *
     C*            @BFRT  - Work field for Before face rate           *
     C*            @ORMT  - Work field for our receive method         *
     C*            @OPMT  - Work field for our pay method             *
     C*            @VDYY  - Work field for value Year                 *
     C*            @VDMM  - Work field for Value month                *
     C*            @VDDD  - Work field for value day                  *
     C*            @NIYY  - Work field for next int year              *
     C*            @NIMM  - Work field for next int month             *
     C*            @NIDD  - Work field for Next int DAy               *
     C*            @MDYY  - Work field for maturity year              *
     C*            @MDMM  - Work field for maturity month             *
     C*            @MDDD  - Work field for Maturity Day               *
     C*            @SLYY  - Work field for Start last int year        *
     C*            @SLMM  - Work field for Start last Int month       *
     C*            @SLDD  - Work field for Start last int day         *
     C*            @FUID  - Work field for Front-up interest indicator*   S01392
     C*            @FLID  - Work field for First/Last day interest    *   S01392
     C*            @RDFC  - Work field for Round down interest        *   S01392
     C*            @BFUI  - Work field for Before Front-up int. ind   *   S01392
     C*            @BFLI  - Work field for Before First/Last day int. *   S01392
     C*            @BRDF  - Work field for Before Round down interest *   S01392
     C*                                                               *
     C*****************************************************************
     C           #A        BEGSR
      *
      ** Switch off *INU7 and *INU8, in case they have been left on       CAP002
      ** by a program elsewhere in the structure.                         CAP002
     C                     CLEAR*INU7                                     CAP002
     C                     CLEAR*INU8                                     CAP002
      *                                                                   CAP002
     C                     MOVEACPY@      BIS@   80                       S01194
     C           @FCYC     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @FCYC   1        *1
      *
      **  Receive input parameters.
     C           *ENTRY    PLIST                           *1
     C                     PARM           @TERM   1        *1
     C                     PARM           @DCAT   1        *1
     C                     PARM           @STDL            *1
     C                     PARM           @STDB            *1
     C                     PARM           @STDS            *1
     C                     PARM           @STDA            *1
      *
      **  If termination parameter is 'T', no further processing.
     C           @TERM     CABEQ'T'       #A9              *1
      *
      **  Set up program name in *LDA in case of database error.
     C                     MOVEL'MM0073'  DBPGM            *1
      *
      **  Open files.
     C*************        OPEN FDICDRLL                   *1             S01194
     C*************        OPEN FDCCYTLL                   *1             S01194
     C                     OPEN MMLVDMLL                   *1
     C                     OPEN MMEPOULL                   *1
     C                     OPEN MMFNRULL                   *1
     C                     OPEN MMDEALLL                   *1             S01378
      *
      ****Access FDICDRLL to get MIDAS run date.                          S01194
     C*********            MOVE *BLANKS   KEY              *1             S01194
     C*********            MOVEL'01'      KEY    12        *1             S01194
     C*********            MOVE '10'      KEY              *1             S01194
     C*********  KEY       CHAINFDICDRLL             60    *1             S01194
      *********                                                           S01194
     C                     CALL 'AOBANKR0'                 *1             S01194
     C                     PARM '*MSG    '@RTCD            *1             S01194
     C                     PARM '*FIRST  '@OPTN            *1             S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C*                                                                   S01194
     C*********  *IN60     IFEQ '1'                        B*2            S01194
     C           @RTCD     IFNE *BLANK                     B*2            S01194
     C                     MOVEL'SDBANKPD'DBFILE           *************  S01194
     C                     MOVE '001'     DBASE            ***************S01194
     C*********            MOVEL'FDICDRLL'DBFILE           *             *S01194
     C*********            MOVELKEY       DBKEY            * DBERROR 001 *S01194
     C                     MOVEL@OPTN     DBOPTN           * DBERROR 001 *S01194
     C                     MOVEL@OPTN     DBKEY            *              S01194
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     GOTO #A9                        **2
     C                     END                             E*2
      *
      ** MOVE RUN DATE INTO DATA STRUCTURE TO SPLIT UP FIELDS             S01194
     C                     MOVE BJMRDT    RUNA                            S01194
     C/COPY WNCPYSRC,MM0073C003
      *
      **  Extract file fields.
     C           *LIKE     DEFN IKTYPE    @TYPE            *1
     C           *LIKE     DEFN IKCCY     @CCY             *1
     C           *LIKE     DEFN IKLACT    @LACT            *1
     C           *LIKE     DEFN IKRBSI    @RBSI            *1
     C           *LIKE     DEFN IKAMNP    @AMNP            *1
     C           *LIKE     DEFN IKBAMT    @BAMT            *1
     C           *LIKE     DEFN IKBVDT    @BVDT            *1
     C           *LIKE     DEFN IKBNID    @BNID            *1
     C           *LIKE     DEFN IKBMTD    @BMTD            *1
     C           *LIKE     DEFN IKBLID    @BLID            *1
     C           *LIKE     DEFN IKINTR    @INTR            *1
     C           *LIKE     DEFN IKBIRT    @BIRT            *1
     C           *LIKE     DEFN IKICMT    @ICMT            *1
     C           *LIKE     DEFN IKBICM    @BICM            *1
     C           *LIKE     DEFN IHFVAL    @FVAL            *1
     C           *LIKE     DEFN IHBFVL    @BFVL            *1
     C           *LIKE     DEFN IHFRAT    @FRAT            *1
     C           *LIKE     DEFN IHBFRT    @BFRT            *1
     C           *LIKE     DEFN IHDORM    @ORMT            *1
     C           *LIKE     DEFN IHDOPM    @OPMT            *1
     C           *LIKE     DEFN IKBRDF    @BRDF            *1             S01392
     C           *LIKE     DEFN IKBFLI    @BFLI            *1             S01392
     C           *LIKE     DEFN IKBFUI    @BFUI            *1             S01392
     C           *LIKE     DEFN IKRDFC    @RDFC            *1             S01392
     C           *LIKE     DEFN IKFLID    @FLID            *1             S01392
     C           *LIKE     DEFN IKFUID    @FUID            *1             S01392
      *
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'L'                        B1
     C                     MOVE IKTYPE    @TYPE            *1
     C                     MOVE IKCCY     @CCY             *1
     C                     MOVE IKLACT    @LACT            *1
     C                     MOVE IKRBSI    @RBSI            *1
     C                     Z-ADDIKAMNP    @AMNP            *1
     C                     Z-ADDIKBAMT    @BAMT            *1
     C                     Z-ADDIKVDYY    @VDYY            *1
     C                     Z-ADDIKVDMM    @VDMM            *1
     C                     Z-ADDIKVDDD    @VDDD            *1
     C                     Z-ADDIKBVDT    @BVDT            *1
     C                     Z-ADDIKNIYY    @NIYY            *1
     C                     Z-ADDIKNIMM    @NIMM            *1
     C                     Z-ADDIKNIDD    @NIDD            *1
     C                     Z-ADDIKBNID    @BNID            *1
     C                     Z-ADDIKMDYY    @MDYY            *1
     C                     Z-ADDIKMDMM    @MDMM            *1
     C                     Z-ADDIKMDDD    @MDDD            *1
     C                     Z-ADDIKBMTD    @BMTD            *1
     C                     Z-ADDIKSLYY    @SLYY            *1
     C                     Z-ADDIKSLMM    @SLMM            *1
     C                     Z-ADDIKSLDD    @SLDD            *1
     C                     Z-ADDIKBLID    @BLID            *1
     C                     Z-ADDIKINTR    @INTR            *1
     C                     Z-ADDIKBIRT    @BIRT            *1
     C                     MOVE IKICMT    @ICMT            *1
     C                     MOVE IKBICM    @BICM            *1
     C                     Z-ADD*ZEROS    @FVAL            *1
     C                     Z-ADD*ZEROS    @BFVL            *1
     C                     Z-ADD*ZEROS    @FRAT            *1
     C                     Z-ADD*ZEROS    @BFRT            *1
     C                     MOVE IKDORM    @ORMT            *1
     C                     MOVE IKDOPM    @OPMT            *1
     C                     MOVE IKBRDF    @BRDF            *1             S01392
     C                     MOVE IKBFLI    @BFLI            *1             S01392
     C                     MOVE IKBFUI    @BFUI            *1             S01392
     C                     MOVE IKRDFC    @RDFC            *1             S01392
     C                     MOVE IKFLID    @FLID            *1             S01392
     C                     MOVE IKFUID    @FUID            *1             S01392
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'B'                        B1
     C                     MOVE IHTYPE    @TYPE            *1
     C                     MOVE IHCCY     @CCY             *1
     C                     MOVE IHLACT    @LACT            *1
     C                     MOVE IHRBSI    @RBSI            *1
     C                     Z-ADDIHAMNP    @AMNP            *1
     C                     Z-ADDIHBAMT    @BAMT            *1
     C                     Z-ADDIHVDYY    @VDYY            *1
     C                     Z-ADDIHVDMM    @VDMM            *1
     C                     Z-ADDIHVDDD    @VDDD            *1
     C                     Z-ADDIHBVDT    @BVDT            *1
     C                     Z-ADDIHNIYY    @NIYY            *1
     C                     Z-ADDIHNIMM    @NIMM            *1
     C                     Z-ADDIHNIDD    @NIDD            *1
     C                     Z-ADDIHBNID    @BNID            *1
     C                     Z-ADDIHMDYY    @MDYY            *1
     C                     Z-ADDIHMDMM    @MDMM            *1
     C                     Z-ADDIHMDDD    @MDDD            *1
     C                     Z-ADDIHBMTD    @BMTD            *1
     C                     Z-ADDIHLIYY    @SLYY            *1
     C                     Z-ADDIHLIMM    @SLMM            *1
     C                     Z-ADDIHLIDD    @SLDD            *1
     C                     Z-ADDIHBLID    @BLID            *1
     C                     Z-ADDIHINTR    @INTR            *1
     C                     Z-ADDIHBIRT    @BIRT            *1
     C                     MOVE IHICMT    @ICMT            *1
     C                     MOVE IHBICM    @BICM            *1
     C                     Z-ADDIHFVAL    @FVAL            *1
     C                     Z-ADDIHBFVL    @BFVL            *1
     C                     Z-ADDIHFRAT    @FRAT            *1
     C                     Z-ADDIHBFRT    @BFRT            *1
     C                     Z-ADDIHBIRT    @BIRT            *1
     C                     MOVE IHDORM    @ORMT            *1
     C                     MOVE IHDOPM    @OPMT            *1
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'S'                        B1
     C                     MOVE ILTYPE    @TYPE            *1
     C                     MOVE ILCCY     @CCY             *1
     C                     MOVE ILLACT    @LACT            *1
     C                     MOVE ILRBSI    @RBSI            *1
     C                     Z-ADDILAMNP    @AMNP            *1
     C                     Z-ADDILBAMT    @BAMT            *1
     C                     Z-ADDILVDYY    @VDYY            *1
     C                     Z-ADDILVDMM    @VDMM            *1
     C                     Z-ADDILVDDD    @VDDD            *1
     C                     Z-ADDILBVDT    @BVDT            *1
     C                     Z-ADDILNIYY    @NIYY            *1
     C                     Z-ADDILNIMM    @NIMM            *1
     C                     Z-ADDILNIDD    @NIDD            *1
     C                     Z-ADDILBNID    @BNID            *1
     C                     Z-ADDILMDYY    @MDYY            *1
     C                     Z-ADDILMDMM    @MDMM            *1
     C                     Z-ADDILMDDD    @MDDD            *1
     C                     Z-ADDILBMTD    @BMTD            *1
     C                     Z-ADDILLIYY    @SLYY            *1
     C                     Z-ADDILLIMM    @SLMM            *1
     C                     Z-ADDILLIDD    @SLDD            *1
     C                     Z-ADDILBLID    @BLID            *1
     C                     Z-ADDILINTR    @INTR            *1
     C                     Z-ADDILBIRT    @BIRT            *1
     C                     MOVE ILICMT    @ICMT            *1
     C                     MOVE ILBICM    @BICM            *1
     C                     Z-ADDILFVAL    @FVAL            *1
     C                     Z-ADDILBFVL    @BFVL            *1
     C                     Z-ADDILFRAT    @FRAT            *1
     C/COPY WNCPYSRC,MM0073C126
     C                     Z-ADDILBFRT    @BFRT            *1
     C                     MOVE ILDORM    @ORMT            *1
     C                     MOVE *BLANKS   @OPMT            *1
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'A'                        B1
     C                     MOVE IGTYPE    @TYPE            *1
     C                     MOVE IGCCY     @CCY             *1
     C                     MOVE IGLACT    @LACT            *1
     C                     Z-ADDIGRBAT    @AMNP            *1
     C                     Z-ADDIGBAMT    @BAMT            *1
     C                     Z-ADDIGVDYY    @VDYY            *1
     C                     Z-ADDIGVDMM    @VDMM            *1
     C                     Z-ADDIGVDDD    @VDDD            *1
     C                     Z-ADDIGOMYY    @MDYY            *1
     C                     Z-ADDIGOMMM    @MDMM            *1
     C                     Z-ADDIGOMDD    @MDDD            *1
     C                     Z-ADDIGBVDT    @BVDT            *1
     C                     Z-ADDIGRIRT    @INTR            *1
     C                     Z-ADDIGOSYY    @SLYY            *1
     C                     Z-ADDIGOSMM    @SLMM            *1
     C                     Z-ADDIGOSDD    @SLDD            *1
     C                     Z-ADDIGOGDA    @FVAL            *1
     C                     Z-ADDIGORAT    @FRAT            *1
     C                     MOVE IGRICM    @ICMT            *1
     C                     Z-ADD*ZEROS    @NIDT            *1
     C                     END                             E1
      *
     C/COPY WNCPYSRC,MM0073C006
      *
     C                     MOVE *BLANK    CDL033  1                                           CDL033
     C                     CALL 'AOSARDR0'                                                    CDL033
     C                     PARM *BLANKS   @RTCD                                               CDL033
     C                     PARM '*VERIFY' @OPTN                                               CDL033
     C                     PARM 'CDL033'  PSARD   6                                           CDL033
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL033
      *                                                                                       CDL033
     C           @RTCD     IFEQ *BLANKS                                                       CDL033
     C                     MOVE 'Y'       CDL033                                              CDL033
     C                     ELSE                                                               CDL033
     C           @RTCD     IFNE '*NRF   '                                                     CDL033
     C                     MOVE '004'     DBASE                                               CDL033
     C                     MOVEL'CDL033  'DBKEY                                               CDL033
     C                     MOVEL'SCSARDPD'DBFILE                                              CDL033
     C                     EXSR *PSSR                                                         CDL033
     C                     ENDIF                                                              CDL033
     C                     ENDIF                                                              CDL033
      *                                                                                       CDL033
      ***Call*access*program*for*General*Ledger*details.***************            MD035545 MD047993
      *****************************************************************            MD035545 MD047993
     C**********           CALL 'AOGELRR1'                                         MD035545 MD047993
     C**********           PARM '*MSG   ' @RTCD   7                                MD035545 MD047993
     C**********           PARM '*FIRST ' @OPTN   7                                MD035545 MD047993
     C********** SDGELR    PARM SDGELR    DSSDY                                    MD035545 MD047993
      *                                                                                     MD035545
     C********** @RTCD     IFNE *BLANK                                             MD035545 MD047993
     C**********           MOVEL'SDGELRPD'DBFILE                                   MD035545 MD047993
     C**********           MOVEL'062'     DBASE                                    MD035545 MD047993
     C**********           MOVEL@OPTN     DBKEY                                    MD035545 MD047993
     C**********           EXSR *PSSR                                              MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
      *                                                                                     MD035545
      ** Retrieve system value setting                                                      MD035545
      *                                                                                     MD035545
     C                     MOVELWPARML    P@OP01                                            MD035545
     C                     CALL 'AOSVALR0'                                                  MD035545
     C                     PARM *BLANKS   W0RTCD  7                                         MD035545
     C                     PARM           P@OP01 20                                         MD035545
     C                     PARM           P@VL01200                                         MD035545
     C                     PARM           P@OP02 20                                         MD035545
     C                     PARM           P@VL02200                                         MD035545
     C                     PARM           P@OP03 20                                         MD035545
     C                     PARM           P@VL03200                                         MD035545
     C                     PARM           P@OP04 20                                         MD035545
     C                     PARM           P@VL04200                                         MD035545
     C                     PARM           P@OP05 20                                         MD035545
     C                     PARM           P@VL05200                                         MD035545
     C                     PARM           P@OP06 20                                         MD035545
     C                     PARM           P@VL06200                                         MD035545
     C                     PARM           P@OP07 20                                         MD035545
     C                     PARM           P@VL07200                                         MD035545
     C                     PARM           P@OP08 20                                         MD035545
     C                     PARM           P@VL08200                                         MD035545
     C                     PARM           P@OP09 20                                         MD035545
     C                     PARM           P@VL09200                                         MD035545
     C                     PARM           P@OP10 20                                         MD035545
     C                     PARM           P@VL10200                                         MD035545
      *                                                                                     MD035545
      ** If system value is not found then default value to 'N'                             MD035545
      *                                                                                     MD035545
     C           W0RTCD    IFNE '       '                                                   MD035545
     C                     MOVE 'N'       WCALC6                                            MD035545
     C                     ELSE                                                             MD035545
     C                     MOVELP@VL01    WCALC6                                            MD035545
     C********** WCALC6    IFEQ 'Y'                                                MD035545 MD047993
     C********** BKALDI    ANDEQ'Y'                                                MD035545 MD047993
     C**********           MOVE 'Y'       WCALC6                                   MD035545 MD047993
     C**********           ELSE                                                    MD035545 MD047993
     C**********           MOVE 'N'       WCALC6                                   MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
     C                     ENDIF                                                            MD035545
      *                                                                                     MD035545
     C           #A9       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #C       - Termination processing                             *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  MAIN   - Main Line process                         *
     C*                                                               *
     C* FLDS USED  @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           #C        BEGSR
      *
      **  If termination parameter set to 'T', terminate program.
     C           @TERM     IFEQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     GOTO #C9                        *1
     C                     END                             E1
      *
      **  If database error, terminate program.
     C           *INU7     IFEQ '1'                        B1
     C                     MOVE 'E'       @TERM            *1
     C                     MOVE '1'       *INLR            *1
     C                     GOTO #C9                        *1
     C                     END                             E1
      *
      **  Return to calling program.
     C                     RETRN
      *
     C           #C9       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* *PSSR    - Program error handling subroutine                  *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @ERR1  - Work field for error to prevent looping   *
     C*            @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           *PSSR     BEGSR
      *
      ** SET @ERR1 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR1     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR1   1        *1
     C                     MOVE '1'       *INU6            *1
      *                                                    *1
      ** SET UP FIELDS IN LOCAL DATA AREA                  *1
     C                     MOVEL'MM0073'  DBPGM            *1
     C                     MOVE '991'     DBASE            *1
      *                                                    *1
      ** DUMP THE PROGRAM                                  *1
     C                     DUMP                            *1
     C                     MOVE 'E'       @TERM
     C                     END                             E1
      *
      ** TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* INFSR    - File Exception/error subroutine                    *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @ERR2  - Work field for error 2                    *
     C*            @FILE  - Work field for file processed             *
     C*            @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           INFSR     BEGSR
      *
      ** SET @ERR2 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR2     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR2   1        *1
     C                     MOVE '1'       *INU7            *1
     C                     MOVE '1'       *INU8            *1
      *                                                    *1
      ** SET UP FIELDS IN LOCAL DATA AREA                  *1
     C                     MOVEL@FILE     DBFILE           *1
     C                     MOVE '992'     DBASE            *1
      *                                                    *1
      ** DUMP THE PROGRAM                                  *1
     C                     DUMP                            *1
     C                     MOVE 'E'       @TERM
     C                     END                             E1
      *
      ** TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************   056095
      *   The array @YD and @MD are now being used by SR. ZDATE9      *   056095
      *   before they are being used by SR. ZA0680.  The actual       *   056095
      *   changes were only made on the text, ZA0680 was changed      *   056095
      *   to ZDATE9.                                                  *   056095
      *****************************************************************   056095
** CPY@   **      OBJECT COPYRIGHT
(c) Misys International Banking Systems Ltd. 2001
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
