     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MM Start of day rebuild - near dates/posns')     *
     F*****************************************************************
     F*                                                               *
     F*                                                               *
     F*  Midas - MM Dealer Module                                     *
     F*                                                               *
     F*  MM0173 - Start of Day Enquiry Data Rebuild                   *
     F*           NEAR DATES SUMMARY                                  *
     F*           CURRENCY POSITIONS                                  *
     F*                                                               *
     F*  Function:   This program rebuilds the Money Market near      *
     F*  (I/C INIT)  dates file (MMFNRDPP) and the ccy positions      *
     F*              file (MMEPOSPP) during I/C initiation.           *
     F*                                                               *
     F*  Called by: MM0101  - Start of day reorganisation.            *
     F*        via: MM0112  - File setup control.                     *
     F*                                                               *
     F*  Calls    : ZA0270  - Convert date to Midas day number.       *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD053295           Date 13Apr19               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      *                 MD047993           Date 23Sep17               *
      *                 MD035545           Date 11Sep15               *
      *                 CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 01Sep14               *
      *                 MD027384           Date 10Jun14               *
      *                 CDL093             Date 08Apr14               *
      *                 AR996895           Date 25Nov12               *
      *                 AR792994           Date 27Jun11               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 11Jul06               *
      *                 CDL038             Date 10May05               *
      *                 CSD027             Date 09Dec05               *
      *                 CIR013             Date 25Apr05               *
      *                 CDL033             Date 10Feb05               *
      *                 CDL022             Date 03Feb04               *
      *                 CDL020             Date 03Feb04               *
      *                 CDL019             Date 03Feb04               *
      *                 CDL018             Date 03Feb04               *
      *                 CDL017             Date 03Feb04               *
      *                 CDL016             Date 03Feb04               *
      *                 222727             Date 05Nov03               *
      *                 CAS006             Date 21Jan03               *
      *                 CAS005             Date 16Dec02               *
      *                 CDL010             Date 02Aug02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CIR004             Date 20Jan00               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 CDL006             Date 26Apr99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 163136             Date 07Jul99               *
      *                 126017             Date 18Nov97               *
     F*                 097885             Date 03Feb97               *
     F*                 095244             Date 01Nov95               *
     F*                 095238             DATE 31OCT95               *
     F*                 061426             DATE 30SEP93               *
     F*                 056121             DATE 04NOV93               *
     F*                 056095             DATE 07JUN93               *
     F*                 S01378             DATE 23APR92               *
     F*                 S01392             DATE 01SEP92               *
     F*                 DT0149             DATE 01MAY91               *
     F*                 E20774             DATE 15MAR90               *
     F*                 E20775             DATE 27FEB90               *
     F*                 S01195             DATE 12JAN90               *
     F*                 S01194             DATE 11JAN90               *
     F*                 E19981             DATE 27NOV89               *
     F*                 S01218             DATE 11/08/89              *
     F*                 E17654             DATE 03/04/89              *
     F*                 E14042             DATE 20/07/88              *
     F*                 E13323             DATE 14/05/88              *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  MD053295 - Lending loan with Interest Calculation Basis      *
      *             method 3 (30/360) has wrong interest payment      *
      *             amount for month of March (Recompile)             *
      *  MD046248 - Finastra Rebranding                               *
      *  MD047993 - Modified MD035545. Removed dependency on Accrue   *
      *             on Last Day indicator.                            *
      *  MD035545 - LE: Interest Calculation in Leap year. Consider   *
      *             Accrue on Last Day Indicator for method 6.        *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  MD027384 - incorrect location of CDL093 change in MM1030 subr*
      *  CDL093 - MM Interest calculation type 9.                     *
      *  AR996895 - Incorrect accrual interest calculation            *
      *             (Child:AR996897) (Recompile)                      *
      *  AR792994 - SCC0411 failed - Tried to divide by zero          *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *           to Midas Plus                                       *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over ZINTDY.                              *
      *  CDL033 - Floating Rate CDs Issued.                           *
      *  CDL022 - Deal Amendment Changes (Recompile)                  *
      *  CDL020 - Apply Base Rate at Value Date (Recompile)           *
      *  CDL019 - Allow Base Rate Changes on Fixed Deposits/Loans     *
      *           (Recompile)                                         *
      *  CDL018 - Multiple Settlement Accounts on Loans/Deposits      *
      *           (Recompile)                                         *
      *  CDL017 - Penalty Fee & Early Maturity of Fixed Term Loan/Dep *
      *           (Recompile)                                         *
      *  CDL016 - Automatic rollover of Fixed Term Loans/Deposits     *
      *           (Recompile)                                         *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  CAS005 - Enhancements to CAS001, CAS002 and CAS004           *
      *           (Recompile)                                         *
     F*  CDL010 - Prevent last user that actioned the trade from      *
     F*           authorising it.Recompile due to changes in MMDEAMPP *
     F*           , MMDELDPP , MMDENBPP AND MMDENSPP.                 *
      *  CIR004 - Dealing Calculation Method Change                   *
      *  CDL006 - Fiduciary Dealing.                                  *
     F*  163136 - Interest Calculation Method '6'  showing incorrect -*
     F*           ZERO - amount . Addition to Core #126017 which dealt*
     F*           with the issue. It introduced an additional  INT6DY *
     F*           field in s-routine ZINTDY in  /COPY ZSRSRC/ZINTDYZ2 *
     F*           which in turn is usually called from GLINTC s-routine
     F*           in /COPY  ZSRSRC/ GLINTCZ1 .  However, there are at *
     F*           least a dozen other pgms that use ZINTDY but do     *
     F*           GLINTC-processing within the pgms calculation specs *
     F*  126017 - Correction to interest calculation for calculation  *
     F*           basis 6 in SR/GLINTC - recompile program.           *
     F*  097885 - Recompiled for wrong calculation of number of day   *
     F*           interest (ZINTDYZ2).                                *
     F*  095244 - Recompiled for Calculation method 3                 *
     F*  095238 - Recompiled for Calculation method 3                 *
     F*  061426 - Recompile after ZDATE9 correction                   *
     F*  056121 - Increase size of work field to enable correct       *
     F*           calculation of interest on very large amounts.      *
     F*           (Similar to fix 049499 of MM0089 in MRSLIB1005)     *
     F*  056095 - Interest not calculated consistently in MM.         *
     F*           SR. MM1009 was externally defined as ZINTDY,        *
     F*           while SR. ZA0710 and ZA0680 were replaced by        *
     F*           the externally defined standard SR. ZDATE9 and      *
     F*           ZDAT10, respectively.  Seventeen MM programs        *
     F*           were amended.                                       *
     F*  S01378 - Facilitates the partial sale of a parcel            *
     F*           of negotiable instruments which have been           *
     F*           previously input to the system as a single          *
     F*           transaction (was MOF53). Recompile over new         *
     F*           NA bought and NA sold formats.                      *
     F*  S01392 - JAP.SUB-MODULE INCORPORATION (CORE)                 *
     F*           a) Front-Up Interest - interest added/deducted      *
     F*              at value date rather than maturity.              *
     F*           b) Interest rounded down (Replace MM1007 with       *
     F*              customised version of MM1030)                    *
     F*           c) First & Last day interest - int due for every    *
     F*              day that deal is live.                           *
     F*  DT0149 - Prevent division by zero error (based on emergency  *
     F*           fix EMERG1 from BHF).                               *
     F*  E20774 - Replace QCAEXEC with QCMDEXC                        *   E20774
     F*  E20775 - In the conversion from date to MIDAS day number,    *
     F*           the program has not made provision for the          *
     F*           difference in the date format when decreasing the   *
     F*           number of date by 1.                                *
     F*  S01195 - NEW HOLIDAY PROCESSING                              *
     F*  S01194 - REL. 10 NEW COPYRIGHT STATEMENTS AND                *
     F*           NEW STANDING DATA CHANGES - ADD ACCESS PROGRAMS     *
     F*  E19981 - FUNDS IN NOSTRO IS NOT BEING CALCULATED BECAUSE     *
     F*           UPDATE SUBROUTINE #BI IS USING WRONG FIELDS.        *
     F*  S01218 - Recompiled to include new file layouts for          *
     F*           capital markets dealing interface                   *
     F*  E14042 - MULTISTREAMING START OF DAY PERFORMANCE MODIFICATION*
     F*  E13323 - Program changed so that no WRITEs are performed     *
     F*           if there are no deals in the system.                *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F*                                                               *
     F* ID F  C  H  L    FUNCTION OF INDICATORS                       *
     F*                                                               *
     F*       01        Loan/Deposit record                           *
     F*       02        NA Bought record                              *
     F*                                                               *
     F*       60         ADD TO NOSTRO                                *
     F*       76         READ/CHAIN FAIL                              *
     F*                                                               *
     F*       U6         PROGRAM ERROR                                *
     F*       U7         DATA BASE OR EXCEPTION ERROR                 *
     F*       U8         DATA BASE OR EXCEPTION ERROR                 *
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*FDTABJLLIF**E**        K        DISK         KINFSR INFSR******UC  S01194
     F*FDICDRLLIF**E**        K        DISK         KINFSR INFSR******UC  S01194
     F**********  TABTB11F                          KIGNORE               S01194
     F**********  TABTB20F                          KIGNORE               S01194
     F*FDCCYTLLIF**E**        K        DISK         KINFSR INFSR******UC  S01194
     FMMLVDMLLIF  E           K        DISK         KINFSR INFSR      UC
     FMMEPOULLO   E           K        DISK         KINFSR INFSR      UC
     FMMFNRULLO   E           K        DISK         KINFSR INFSR      UC
      *
     FMMSDNNLLIS  E           K        DISK
     FMMSDFVLLIP  E           K        DISK
     F            MMDENBP0                          KIGNORE
     F            MMDENSP0                          KIGNORE
     F            MMDEAMP0                          KIGNORE
     F/COPY WNCPYSRC,MM0173F001
      /EJECT
     E/COPY ZSRSRC,ZHOLE                                                  S01195
      *
     E                    CPY@    1   1 80                                S01194
      *
      ** Array of period start day numbers.
     E                    @S         10  5 0
      *
      ** Array of period end day numbers.
     E                    @E         10  5 0
      *
      ** Array of number of days in period.
     E                    @P         10  3 0
      *
      ** Array of net balances.
     E                    @A         10 15 0
      *
      ** Array of net interest accrued.
     E                    @I         10 15 0
     E/COPY WNCPYSRC,MM0173E001
      *
      ** Array of month names.
     E                    @M     12  12  3
      *
      ****ARRAY*FOR*SR.*ZA0680*-*CUMULATIVE*DAYS*IN*YEAR*FOR*4*YEAR*PERIOD056095
     E***********         @YD     4   4  5 0A                             056095
      *
      ****ARRAY*FOR*SR.*ZA0680*-*CUMULATIVE*DAYS*IN*YEAR*PER*MONTH*****   056095
     E***********         @MD    13  13  5 0A                             056095
     E*                                                                   056095
     E/COPY ZSRSRC,ZDATE9Z1                                               056095
     E**  Array for SR. ZDATE9                                            056095
      *
      ****USED*BY*SR.*ZA0830*-*CURRENCY RECORDS*****                      S01195
     E***********         @CY        50  3                                S01195
      **  Command for sending error messages, etc.                E14042
     E                    @CM     1   1 80                        E14042
      /EJECT
      ****************************************************************
      *
      *   Loan/Deps
     IMMDELDP0    01
     I                                              HKCCY L1M1
      *
      *   NA Buy
     IMMSDNNP0    02
     I                                              HLCCY L1M1
      *
      ****************************************************************
      /EJECT
      ** Define arrays across MMFNRULL & MMEPOULL fields.
     I            DS
      ** Net balances.
     I                                        1 150 @A
     I                                        1  150HRNBTD
     I                                       16  300HRNBD1
     I                                       31  450HRNBD2
     I                                       46  600HRNBD3
     I                                       61  750HRNBD4
     I                                       76  900HRNBW1
     I                                       91 1050HRNBM1
     I                                      106 1200HRNBM2
     I                                      121 1350HRNBM3
     I                                      136 1500H2NBSP
      ** Net interest accrued.
     I                                      151 300 @I
     I                                      151 1650HRIATD
     I                                      166 1800HRIAD1
     I                                      181 1950HRIAD2
     I                                      196 2100HRIAD3
     I                                      211 2250HRIAD4
     I                                      226 2400HRIAW1
     I                                      241 2550HRIAM1
     I                                      256 2700HRIAM2
     I                                      271 2850HRIAM3
     I                                      286 3000H2NIAS
      ** Number of days in period.
     I                                      301 330 @P
     I                                      301 3030HRDPTD
     I                                      304 3060HRDPD1
     I                                      307 3090HRDPD2
     I                                      310 3120HRDPD3
     I                                      313 3150HRDPD4
     I                                      316 3180HRDPW1
     I                                      319 3210HRDPM1
     I                                      322 3240HRDPM2
     I                                      325 3270HRDPM3
     I                                      328 3300H2NDPD
     ** Period end dates.
     I                                      331 380 @E
     I                                      331 3350HRPDTD
     I                                      336 3400HRPDD1
     I                                      341 3450HRPDD2
     I                                      346 3500HRPDD3
     I                                      351 3550HRPDD4
     I                                      356 3600HRPDW1
     I                                      361 3650HRPDM1
     I                                      366 3700HRPDM2
     I                                      371 3750HRPDM3
     I                                      376 3800H2SPPD
      *
      **  Data structure to concatenate dates.
     I            DS
     I                                        1   80@VDAT
     I                                        1   40@VDYY
     I                                        5   60@VDMM
     I                                        7   80@VDDD
     I                                        9  160@MDAT
     I                                        9  120@MDYY
     I                                       13  140@MDMM
     I                                       15  160@MDDD
     I                                       17  240@NIDT
     I                                       17  200@NIYY
     I                                       21  220@NIMM
     I                                       23  240@NIDD
     I                                       25  320@SLDT
     I                                       25  280@SLYY
     I                                       29  300@SLMM
     I                                       31  320@SLDD
     I                                       33  400@DMVD
     I                                       33  360HNVDYY
     I                                       37  380HNVDMM
     I                                       39  400HNVDDD
      *
      **  Program status data structure.
     IPSDS       SDS
     I/COPY WNCPYSRC,MM0173I002
     I                                      201 208 @FILE
     I                                      254 263 @USER
      *
      **  Local data area for data base error.
     I********** UDS                                                                          CDL033
     ILDA         DS                            256                                           CDL033
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 183 DBASE
      *
      ****DATA*STRUCTURE*FOR*SR.*ZA0680*-*DATE*INPUT*TO*SUBROUTINE*****   056095
      **  DATA STRUCTURE FOR DATE INPUT TO VARIOUS SUBROUTINES            056095
     I            DS
     I                                        1   80@@DTIN
     I***********                             1   40@@YYYY                056095
     I                                        3   40@@YY
     I***********                             1   20@@CC                  056095
     I***********                             5   60@@MTH                 056095
     I***********                             7   80@@DAY                 056095
     I                                        5   60@@MM
     I                                        7   80@@DD
     I*                                                                   056095
     I/COPY ZSRSRC,ZDAT10Z1                                               056095
     I**  Data structure for SR. ZDAT10                                   056095
      *
      ****DATA*STRUCTURE*FOR*SR.*ZA0710*-*FIELD*IS*@@Z71Y**************   056095
     I*********** DS                                                      056095
     I***********                             1   40@@Z71Y                056095
     I***********                             1   10@@SSY1                056095
     I***********                             2   20@@SSY2                056095
     I***********                             3   30@@SSY3                056095
     I***********                             4   40@@SSY4                056095
      *
      ****DATA*STRUCTURE*FOR*SR.*ZA0710*-*FIELD*IS*@@VDT***************   056095
     I*********** DS                                                      056095
     I***********                             1   80@@VDT                 056095
     I***********                             1   40@@YR                  056095
     I***********                             5   60@@Z71M                056095
     I***********                             7   80@@Z71D                056095
     I*                                                                   056095
     I/COPY ZSRSRC,ZDATE9Z2                                               056095
     I**  Data structure for SR. ZDATE9                                   056095
      *
      **  DATASTRUCTURE TO CHANGE FORMAT TO MMDDYY / DDMMYY
     I            DS                              6
     I                                        1   60@@DTOU
     I                                        1   20@@DAT1
     I                                        3   40@@DAT2
     I                                        5   60@@YYY
      *
      ****USED*BY*SR.*ZA0830*-*ARRAY*DATA*STRUCTURE********               S01195
     I************DS                                                      S01195
     I************                            1 150 @CY                   S01195
     I************                            1  75 @@CY1                 S01195
     I************                           76 150 @@CY2                 S01195
      *
      **  DATA STRUCTURE HOLDING STARTING POINT DATE
     I            DS
     I                                        1   80@@STRT
     I                                        1   40@@STYR
     I                                        5   60@@STMT
     I                                        7   80@@STDY
      *
      **  DATA STRUCTURE HOLDING SPOT DATE
     I            DS
     I                                        1   80@@SPDD
     I                                        1   40@@SPYR
     I                                        5   60@@SPMT
     I                                        7   80@@SPDY
      *
      **  DATA STRUCTURE DAYS FOR DATE FORMAT DDMMYY
     I            DS
     I                                        1   60@@DATE
     I                                        1   20@@DAY2
     I**  E20775 - Provision for date format MMDDYY                       E20775
     I                                        3   40@@DAY1                E20775
      *
      ****DATA*STRUCTURE*FOR*SR.*M1009*-*DATE*FIELD*YYYYMMDD***********   056095
     I*********** DS                                                      056095
     I***********                             1   80@@DATA                056095
     I***********                             1   40@@YY1                 056095
     I***********                             5   60@@MM1                 056095
     I***********                             7   80@@DD1                 056095
      *
      ****DATA*STRUCTURE*FOR*SR.*M1009*-*DATE*FIELD*YYYYMMDD***********   056095
     I*********** DS                                                      056095
     I***********                             1   80@@DATB                056095
     I***********                             1   40@@YY2                 056095
     I***********                             5   60@@MM2                 056095
     I***********                             7   80@@DD2                 056095
     I*                                                                   056095
     I/COPY ZSRSRC,ZINTDYZ1                                               056095
     I**  Data Structure for SR. ZINTDY                                   056095
      *                                                                   E14042
      **  DATA STRUCTURE FOR STATUS                                       E14042
     I@STATS      DS                            256                       E14042
     I                                      102 102 @SUBMN                E14042
     I                                      103 103 @STRM2                E14042
     I*                                                                   S01194
     I              'LECalcBasis6LeapYear'C         WPARML                                  MD035545
     I* DATA STRUCTURES FOR USE WITH ACCESS PROGRAMS                      S01194
     I*                                                                   S01194
     I/COPY WNCPYSRC,MM0173I001
     ISDBANK    E DSSDBANKPD                                              S01194
     I* DATA STRUCTURE FOR BANK DETAILS                                   S01194
     I*                                                                   S01194
     ISCSARD    E DSSCSARDPD                                              CDL006
      **  Data structure for Switchable Features file                     CDL006
      *                                                                   CDL006
     ISDCURR    E DSSDCURRPD                                              S01194
     I* DATA STRUCTURE FOR CURRENCY DETAILS                               S01194
     I*                                                                   S01194
     I***SDGELR*   E DSSDGELRPD                                                    MD035545 MD047993
     I**GENERAL*LEDGER*DETAILS*ACCESSED*VIA*ACCESS*PROGRAM*************            MD035545 MD047993
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   S01117
     IDSSDY     E DSDSSDY                                                 S01194
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE                S01194
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* MAIN     - Main Line process                                  *
     C*                                                               *
     C* CALLS    #A       - Initial Processing                        *
     C*          #B       - Control main processing                   *
     C*          #C       - Termination processing                    *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C/COPY WNCPYSRC,MM0173C028
      *
      *  For each record presented to the program by the RPG cycle,
      *   a related SI Deam may also be read and passed through the
      *   control process here. If the deal is a NA buy, a NA sell may
      *   be joined onto the Buy record, which is also passed through
      *   the control process.   1st.Deal   2nd.Sell  3rd.SI Deam
      *
      *   Loan/Deposit
     C           *IN01     IFEQ '1'
     C                     MOVE 'L'       @PEND
     C                     END
      *   NA Bought
     C           *IN02     IFEQ '1'
     C                     MOVE 'B'       @PEND
     C                     END
      *
      *  For each Input Do up to 3 times, until no Pending Deal/Sell/Am
      *                     Deal or Sell or Amendment(SI)
      *
     C           @PEND     DOWNE*BLANK                     B1
     C           @PENDS    ORNE *BLANK                     B1
     C           @PENDA    ORNE *BLANK                     B1
      *
      **  Initial processing.
     C                     EXSR #A                         *1
      **  Main processing.
     C/COPY WNCPYSRC,MM0173C013
     C                     EXSR #B                         *1
     C/COPY WNCPYSRC,MM0173C014
      **  Final processing.
     C******************** EXSR #C *********************** *1 **          E14042
      *
     C                     END                             E1
      *
      ** Do not perform WRITEs if no deals in system.                     E13323
     C**L1****** @FCYC *** IFNE 'Y' ********************** B1      E13323 E14042
     CL1         @FCYC     IFEQ 'Y'                        B1             E14042
      *
      * Write on change of currency.                                      E13323
     CL1                   WRITEMMFNRDP0                   *1             E13323
     CL1                   WRITEMMEPOSP0                   *1             E13323
     C/COPY WNCPYSRC,MM0173C015
      *
     CL1                   END                             E1             E13323
      *
      **  Final processing.
     CLR                   EXSR #C                             E14042
      *
      *****************************************************************
      /EJECT
     C*****************************************************************
     C* SUBROUTINES USED                                              *
     C*                                                               *
     C*  01  #ZA      - Calculate number of days in period            *
     C*  02  #ZB      - Update balance array                          *
     C*  03  #ZC      - Update interest accruals array                *
     C***04**ZA0680***-*Convert*date*format*to*midas*day*number********   056095
     C*  04  ZDAT10   - Convert date format to midas day number       *   056095
     C***05**MM1007   - Calculate interest                            *   S01392
     C*  05  MM1030   - Calculate interest                            *   S01392
     C***06**MM1009***-*Calculate*the*number*of*interest*days**********   056095
     C***07**ZA0710***-*Convert*midas*day*no*to*date*format************   056095
     C*  06  ZINTDY   - Calculate the number of interest days         *   056095
     C*  07  ZDATE9   - Convert midas day no to date format           *   056095
     C*                                                               *
     C*  09  #B       - Control main processing                       *
     C*                                                               *
     C*  11  #BC      - Update time loans/deposits balances           *
     C*  12  #BD      - Update CD's Bought Balances                   *
     C*  13  #BE      - Update Bills Bought balances                  *
     C*  14  #BF      - Update CD's Sold Balances                     *
     C*  15  #BG      - Update Bills sold balances                    *
     C*  16  #BH      - Update SI deam balances                       *
     C*                                                               *
     C*                                                               *
     C*  19  #BA      - Initialise new records                        *
     C*  20  ZA0730   - Determine next working day                    *
     C*  21  ZA0770   - Format date field                             *
     C***22**ZA0830***-*Determine if day is a working day**************   S01195
     C*  23  MM1003   - Calculate period date                         *
     C*  24  #A       - Initial Processing                            *
     C*  25  #C       - Termination processing                        *
     C*  26  *PSSR    - Program error handling subroutine             *
     C*  27  INFSR    - File Exception/error subroutine               *
     C*                                                               *
     C* EXTERNAL ROUTINE                                              *
     C*                                                               *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZA      - Calculate number of days in period                 *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  #ZB    - Update balance array                      *
     C*            #ZC    - Update interest accruals array            *
     C*                                                               *
     C* FLDS USED  @P     - Array to hold number of days in period    *
     C*            @DIPA  - number of active days for deal in period  *
     C*            @SDAT  - Period Start date                         *
     C*            @S     - Array to hold period start dates          *
     C*            @WK50  - work field for active days in period      *
     C*            @EDAT  - Period end date                           *
     C*            @E     - Array to hold period end dates            *
     C*****************************************************************
     C           #ZA       BEGSR
      *
      **  Initialise with number of days in entire period.
     C                     Z-ADD@P,X      @DIPA   30
      *
      **  If start date after period start date, subtract difference.
     C           @SDAT     IFGT @S,X                       B1
     C           @SDAT     SUB  @S,X      @WK50   50       *1
     C           @DIPA     SUB  @WK50     @DIPA            *1
     C                     END                             E1
      *
      **  If end date before period end date, subtract difference.
     C           @EDAT     IFLT @E,X                       B1
     C           @E,X      SUB  @EDAT     @WK50            *1
     C           @DIPA     SUB  @WK50     @DIPA            *1
     C                     END                             E1
      *
     C           #ZA9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZB      - Update balance array                               *
     C*                                                               *
     C* CALLS    #ZA      - Calculate number of days in period        *
     C*                                                               *
     C* CALLED BY                                                     *
     C*            #B     - Control main processing                   *
     C*            #BC    - Update time loans/deposits balances       *
     C*            #BD    - Update CD's Bought Balances               *
     C*            #BF    - Update CD's Sold Balances                 *
     C*                                                               *
     C* FLDS USED  @SDAT  - Period Start date                         *
     C*            @E     - Array to hold period end dates            *
     C*            @EDAT  - Period end date                           *
     C*            @S     - Array to hold period start dates          *
     C*            @AMNT  - Work field for amount                     *
     C*            @DIPA  - number of active days for deal in period  *
     C*            @WK150 - Work field for balance                    *
     C*            @P     - Array to hold number of days in period    *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @A     - Array to hold net balances                *
     C*                                                               *
     C*****************************************************************
     C           #ZB       BEGSR
      *
     C                     DO   10        X       30       B1
      *
      **  If deal active in this period...
     C           @SDAT     IFLE @E,X                       B*2
     C           @EDAT     ANDGE@S,X                       X*2
      *
      **  ...calculate number of days active...
     C                     EXSR #ZA                        **2
      *
      **  ...and update balances array.
     C           @AMNT     MULT @DIPA     @WK150 150       **2
     C           @P,X      IFGT 0                          B**3           DT0149
     C           @WK150    DIV  @P,X      @WK150    H      ***3           DT0149
     C                     ELSE                            X**3           DT0149
     C                     Z-ADD0         @WK150           ***3           DT0149
     C                     END                             E**3           DT0149
     C           @ADSUB    IFEQ '+'                        B**3
     C/COPY WNCPYSRC,MM0173C016
     C                     ADD  @WK150    @A,X             ***3
     C/COPY WNCPYSRC,MM0173C017
     C                     ELSE                            X**3
     C/COPY WNCPYSRC,MM0173C018
     C                     SUB  @WK150    @A,X             ***3
     C/COPY WNCPYSRC,MM0173C019
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #ZB9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #ZC      - Update interest accruals array                     *
     C*                                                               *
     C* CALLS    #ZA      - Calculate number of days in period        *
     C*                                                               *
     C* CALLED BY                                                     *
     C*            #B     - Control main processing                   *
     C*            #BC    - Update time loans/deposits balances       *
     C*                                                               *
     C* FLDS USED  @SDAT  - Period Start date                         *
     C*            @E     - Array to hold period end dates            *
     C*            @EDAT  - Period end date                           *
     C*            @S     - Array to hold period start dates          *
     C*            @CALC  - Work field for interest cal method        *
     C*            @DAYS  - Work field for days in year               *
     C*            @AMNT  - Work field for amount                     *
     C*            @RATE  - work field for interest rate              *
     C*******      @WK155 - Work field for balance                    *   ME2110
     C*            @WK152 - Work field for balance                    *   ME2110
     C*            @DIPA  - number of active days for deal in period  *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @I     - Array for net Interest accrued            *
     C*                                                               *
     C*****************************************************************
     C           #ZC       BEGSR
      *
     C                     DO   10        X                B1
      *
      **  If deal active in this period...
     C           @SDAT     IFLE @E,X                       B*2
     C*******    @EDAT     ANDGE@S,X                       X*2            ME2063
     C           @EDAT     ANDGT@S,X                       X*2            ME2063
      *                                                                                       CDL093
      ** Set Start and End Date for calculation type 9                                        CDL093
      *                                                                                       CDL093
     C           @CALC     IFEQ '9'                                                           CDL093
     C                     Z-ADD@S,X      ZZBEG9  50                                          CDL093
     C           @SDAT     IFGT @S,X                                                          CDL093
     C                     Z-ADD@SDAT     ZZBEG9                                              CDL093
     C                     END                                                                CDL093
      *                                                                                       CDL093
     C                     Z-ADD@E,X      ZZEND9  50                                          CDL093
     C           @EDAT     IFLT @E,X                                                          CDL093
     C                     Z-ADD@EDAT     ZZEND9                                              CDL093
     C                     END                                                                CDL093
      *                                                                                       CDL093
      ** Convert start date to YYYYMMDD format                                                CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZBEG9    @@DAYN  50                                          CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATA  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY1   40                                          CDL093
      *                                                                                       CDL093
      ** Convert end date to YYYYMMDD format                                                  CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZEND9    @@DAYN                                              CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATB  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY2   40                                          CDL093
      *                                                                                       CDL093
     C                     EXSR #FEB29                                                        CDL093
      *                                                                                       CDL093
     C                     ENDIF                                                              CDL093
      *
      **  ...determine divisor dependent on interest calculation method
     C           @CALC     IFEQ '1'                        B**3
     C           @CALC     OREQ '4'                        X**3
     C           @CALC     OREQ '9'                                                           CDL093
     C           #29FEB    ANDNE'Y'                                                           CDL093
     C                     Z-ADD365       @DAYS   30       ***3
     C                     END                             E**3
      *
     C           @CALC     IFEQ '2'                        B**3
     C           @CALC     OREQ '3'                        X**3
     C           @CALC     OREQ '5'                        X**3
     C           @CALC     OREQ '0'                                                         AR792994
     C                     Z-ADD360       @DAYS            ***3
     C                     END                             E**3
      *
     C           @CALC     IFEQ '6'                        B**3
     C           @CALC     OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C                     Z-ADD366       @DAYS            ***3
     C                     END                             E**3
      *
     C/COPY WNCPYSRC,MM0173C025
      **  ...calculate number of days active...
     C                     EXSR #ZA                        **2
      *
      **  ...and update balances array.
     C*******    @AMNT     MULT @RATE     @WK155 155       **2            ME2110
     C*******              DIV  100       @WK155    H      **2            ME2110
     C*******              MULT @DIPA     @WK155           **2            ME2110
     C*******              DIV  @DAYS     @WK155    H      **2            ME2110
     C*******              MULT -1        @WK155           **2            ME2110
     C           @AMNT     MULT @RATE     @WK152 152       **2            ME2110
     C                     MULT @DIPA     @WK152           **2            ME2110
     C                     DIV  @DAYS     @WK152    H      **2            ME2110
     C                     MULT -1        @WK152           **2            ME2110
      *
     C           @ADSUB    IFEQ '+'                        B**3
     C/COPY WNCPYSRC,MM0173C020
     C                     ADD  @WK152    @I,X      H      ***3
     C/COPY WNCPYSRC,MM0173C021
     C                     ELSE                            X**3
     C/COPY WNCPYSRC,MM0173C022
     C                     SUB  @WK152    @I,X      H      ***3
     C/COPY WNCPYSRC,MM0173C023
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #ZC9      ENDSR
      *****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDAT10Z2                                               056095
      *******************************************************************
     C***********                                                         056095
     C**ZA0680*-*THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO         056095
     C***********MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)         056095
     C***********                                                         056095
     C**CALLED*BY :                                                       056095
     C***********                                                         056095
     C**CALLS*:**                                                         056095
     C***********                                                         056095
     C**INPUT**:*@@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)   056095
     C***********                                                         056095
     C**OUTPUT*:*@@MDNO MIDAS DAY NUMBER  (SIZE : 5N)                     056095
     C***********                                                         056095
     C**USES*:***@@CC   NUMBER OF CENTURIES IN DATE                       056095
     C***********@@DAY  DAY NUMBER                                        056095
     C***********@@REM  REMAINDER FROM DIVIDE                             056095
     C***********@@MTH  MONTH NUMBER                                      056095
     C***********@MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       MONTH                                             056095
     C***********@@WK2  WORK FIELD (2,0)                                  056095
     C***********@@WK5  WORK FIELD (5,0)                                  056095
     C***********@@YYYY YEAR (4 CHARACTER)                                056095
     C***********@@YY   YEAR (2 CHARACTER)                                056095
     C***********@YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       A FOUR YEAR PERIOD                                056095
     C***********                                                         056095
     C******************************************************************* 056095
     C***********                                                         056095
     C***********ZA0680    BEGSR                                          056095
     C***********                                                         056095
     C****CLEAR*OUT ANY 'OLD' DATA IN FIELD                               056095
     C***********          Z-ADD0         @@MDNO  50                      056095
     C***********                                                         056095
     C***********@@DTIN    CABEQ0         ZA0689                    ME1257056095
     C***********                                                         056095
     C*****IF*DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING          056095
     C*****WORK*OUT THE NUMBER OF CENTURIES PASSED SINCE 1971,            056095
     C*****BY*SUBTRACTING 1972 FROM THE YEAR FIELD.                       056095
     C***********@@YYYY    IFGE 2072                       B1             056095
     C***********@@YYYY    SUB  1972      @@YYYY           *1             056095
     C***********                                                         056095
     C*****MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)             056095
     C*****THEN*RESTORE THE YEAR WHICH WAS INPUT BACK TO THE              056095
     C*****ORIGINAL VALUE BEFORE CONTINUING WITH NORMAL CALCULATIONS.     056095
     C***********                                                         056095
     C***********@@CC      MULT 36524     @@MDNO           *1             056095
     C***********@@YYYY    ADD  1972      @@YYYY           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C***********@@YYYY    ADD  28        @@WK2   20                      056095
     C***********                                                         056095
     C***********@@WK2     DIV  4         @@WK2                           056095
     C***********          MVR            @@REM   10                      056095
     C***********                                                         056095
     C******MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD                056095
     C***********@@WK2     MULT 1461      @@WK5   50                      056095
     C***********          ADD  @@WK5     @@MDNO                          056095
     C***********                                                         056095
     C****CHECK*REMAINDER AND MONTH NUMBER                                056095
     C***********@@REM     IFEQ 0                          B1             056095
     C***********@@MTH     ANDGT2                          B1             056095
     C***********          ADD  1         @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****YEAR*NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR               056095
     C***********@@REM     IFNE 0                          B1             056095
     C***********          ADD  @YD,@@REM @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****ADD*MONTHS THIS YEAR                                            056095
     C***********          ADD  @MD,@@MTH @@MDNO                          056095
     C***********                                                         056095
     C****ADD*DAYS THIS MONTH                                             056095
     C***********          ADD  @@DAY     @@MDNO                          056095
     C***********                                                         056095
     C***********ZA0689    ENDSR                           **ZA0689 TAG** 056095
      *****************************************************************
      /EJECT
     C******
      ************************************************************ ME2110 S01392
     C****MM1007 - CALCULATE INTEREST                              ME2110 S01392
     C******                                                       ME2110 S01392
     C***CALLED BY    -                                            ME2110 S01392
     C******                                                       ME2110 S01392
     C***CALLS        -   MM1009 CALCULATE NO. OF INTEREST DAYS    ME2110 S01392
     C******                                                       ME2110 S01392
     C***FIELDS INPUT @@BEG  - START DATE OF PERIOD                ME2110 S01392
     C******          @@END  - END DATE OF PERIOD                  ME2110 S01392
     C******          @@CALC - INTEREST CALCULATION METHOD         ME2110 S01392
     C******          @@AMT  - PRINCIPAL AMOUNT  15N               ME2110 S01392
     C******          @@RATE - INTEREST RATE 11,7                  ME2110 S01392
     C******                                                       ME2110 S01392
     C***FIELDS OUTPUT @@INTR - INTEREST 15,0                      ME2110 S01392
     C******                                                       ME2110 S01392
     C***WORK FIELDS   @@W155 - 15,5                               ME2110 S01392
     C******                                                       ME2110 S01392
     C*************************************************************ME2110 S01392
     C******     MM1007    BEGSR                                   ME2110 S01392
     C******                                                       ME2110 S01392
     C****CALCULATE NUMBER OF INTEREST DAYS                        ME2110 S01392
     C******               EXSR MM1009                             ME2110 S01392
     C******                                                       ME2110 S01392
     C******     @@CALC    IFEQ '2'                        *** B 1 ME2110 S01392
     C******     @@CALC    OREQ '3'                                ME2110 S01392
     C******     @@CALC    OREQ '5'                                ME2110 S01392
     C******     @@AMT     DIV  36000     @@W155 155               ME2110 S01392
     C******               END                             *** E 1 ME2110 S01392
     C******                                                       ME2110 S01392
     C******     @@CALC    IFEQ '1'                        *** B 1 ME2110 S01392
     C******     @@CALC    OREQ '4'                                ME2110 S01392
     C******     @@AMT     DIV  36500     @@W155                   ME2110 S01392
     C******               END                              *** E 1ME2110 S01392
     C******                                                       ME2110 S01392
     C******     @@CALC    IFEQ '6'                         *** B 1ME2110 S01392
     C******     @@AMT     DIV  36600     @@W155                   ME2110 S01392
     C******               END                              *** E 1ME2110 S01392
     C******                                                       ME2110 S01392
     C******               MULT @@RATE    @@W155                   ME2110 S01392
     C******     @@W155    MULT @@INDY    @@INTR 150H              ME2110 S01392
     C******                                                       ME2110 S01392
     C******               GOTO M10079                             ME2110 S01392
     C******               Z-ADD0         @@AMT  150               ME2110 S01392
     C******               Z-ADD0         @@RATE 117               ME2110 S01392
     C******                                                       ME2110 S01392
     C******     M10079    ENDSR                                   ME2110 S01392
      *************************************************************ME2110 S01392
      /EJECT
     C*****************************************************************   S01392
     C*                                                               *   S01392
     C*   MM1030 - CALCULATE INTEREST                                 *   S01392
     C*                                                               *   S01392
     C*  CALLED BY    -                                               *   S01392
     C*                                                               *   S01392
     C***CALLS********-***MM1009*CALCULATE*NO.*OF*INTEREST*DAYS*****S01392056095
     C*  CALLS        -   ZINTDY CALCULATE NO. OF INTEREST DAYS       *   056095
     C*                                                               *   S01392
     C***FIELDS*INPUT*@@BEG**-*START*DATE*OF*PERIOD*****************S01392056095
     C****************@@END**-*END*DATE*OF*PERIOD*******************S01392056095
     C****************@@CALC*-*INTEREST*CALCULATION*METHOD**********S01392056095
     C*  FIELDS INPUT ZZBEG  - START DATE OF PERIOD                   *   056095
     C*               ZZEND  - END DATE OF PERIOD                     *   056095
     C*               ZZCALC - INTEREST CALCULATION METHOD            *   056095
     C*               @@AMT  - PRINCIPAL AMOUNT  15N                  *   S01392
     C*               @@RATE - INTEREST RATE 11,7                     *   S01392
     C*               @@RDFC - ROUND DOWN FACILITY IND 1              *   S01392
     C*                                                               *   S01392
     C*  FIELDS OUTPUT @@INTR - INTEREST 15,0                         *   S01392
     C*                                                               *   S01392
     C*  WORK FIELDS   @@W157 - 15,5                                  *   S01392
     C*****************@@W150*-*15,0*******************************S01392 056121
     C*                @@W210 - 21,0                                  *   056121
     C*                @@YEAR - (NUMBER OF DAYS IN YEAR) x 100        *   S01392
     C*                                                               *   S01392
     C*****************************************************************   S01392
     C           MM1030    BEGSR                                          S01392
     C*                                                                   S01392
     C*   CALCULATE NUMBER OF INTEREST DAYS                               S01392
     C*                                                                   S01392
     C/COPY WNCPYSRC,MM0173C001
     C***********          EXSR MM1009                              S01392056095
     C                     Z-ADDZZBEG     ZZBEG9  50                                          CDL093
     C                     Z-ADDZZEND     ZZEND9  50                                          CDL093
      *                                                                                     MD027384
      ** Check if 29th Feb is included                                                      MD027384
      *                                                                                     MD027384
     C           ZZCALC    IFEQ '9'                                                         MD027384
      *                                                                                     MD027384
      ** Convert start date to YYYYMMDD format                                              MD027384
      *                                                                                     MD027384
     C                     Z-ADDZZBEG9    @@DAYN  50                                        MD027384
     C                     EXSR ZDATE9                                                      MD027384
     C                     Z-ADD@@VDT     ZZDATA  80                                        MD027384
     C                     Z-ADD@@YR      ZZYY1   40                                        MD027384
      *                                                                                     MD027384
      ** Convert end date to YYYYMMDD format                                                MD027384
      *                                                                                     MD027384
     C                     Z-ADDZZEND9    @@DAYN                                            MD027384
     C                     EXSR ZDATE9                                                      MD027384
     C                     Z-ADD@@VDT     ZZDATB  80                                        MD027384
     C                     Z-ADD@@YR      ZZYY2   40                                        MD027384
      *                                                                                     MD027384
     C                     EXSR #FEB29                                                      MD027384
      *                                                                                     MD027384
     C                     ENDIF                                                            MD027384
      *                                                                                     MD027384
      *                                                                                     MD027384
     C           ZZCALC    IFEQ '9'                                                         MD027384
     C           #29FEB    ANDEQ'Y'                                                         MD027384
     C           HKNIPD    ANDNE*ZERO                                                       MD027384
     C           HKNIPD    ANDLTZZEND                                                       MD027384
      *                                                                                     MD027384
     C                     Z-ADDHKIPDM    @@IPDM  20                                        MD027384
     C                     CALL 'MM001031'                                                  MD027384
     C                     PARM           ZZBEG                                             MD027384
     C                     PARM           ZZEND                                             MD027384
     C                     PARM           HKNIPD                                            MD027384
     C                     PARM '9'       ZZCALC                                            MD027384
     C                     PARM           HKIPFQ                                            MD027384
     C                     PARM           @@AMT                                             MD027384
     C                     PARM           @@RATE                                            MD027384
     C                     PARM 'N'       RNDDWN  1                                         MD027384
     C                     PARM 'N'       FRSLST  1                                         MD027384
     C                     PARM           @@IPDM                                            MD027384
     C                     PARM           WINTR                                             MD027384
      *                                                                                     MD027384
     C                     Z-ADDWINTR     @@INTR                                            MD027384
     C           *LIKE     DEFN @@INTR    WINTR                                             MD027384
      *                                                                                     MD027384
     C                     GOTO INTCLC                                                      MD027384
      *                                                                                     MD027384
     C                     ENDIF                                                            MD027384
      *                                                                                     MD027384
     C                     EXSR ZINTDY                                    056095
      **********                                                                     CDL093 MD027384
      ***Check*if 29th Feb is included                                               CDL093 MD027384
      **********                                                                     CDL093 MD027384
     C********** ZZCALC    IFEQ '9'                                                  CDL093 MD027384
      **********                                                                     CDL093 MD027384
      ** *onvert*start date to YYYYMMDD format                                       CDL093 MD027384
      **********                                                                     CDL093 MD027384
     C**********           Z-ADDZZBEG9    @@DAYN  50                                 CDL093 MD027384
     C**********           EXSR ZDATE9                                               CDL093 MD027384
     C**********           Z-ADD@@VDT     ZZDATA  80                                 CDL093 MD027384
     C**********           Z-ADD@@YR      ZZYY1   40                                 CDL093 MD027384
      ***********                                                                    CDL093 MD027384
      ***Convert*end date to YYYYMMDD format                                         CDL093 MD027384
      **********                                                                     CDL093 MD027384
     C**********           Z-ADDZZEND9    @@DAYN                                     CDL093 MD027384
     C**********           EXSR ZDATE9                                               CDL093 MD027384
     C**********           Z-ADD@@VDT     ZZDATB  80                                 CDL093 MD027384
     C**********           Z-ADD@@YR      ZZYY2   40                                 CDL093 MD027384
      **********                                                                     CDL093 MD027384
     C**********           EXSR #FEB29                                               CDL093 MD027384
      **********                                                                     CDL093 MD027384
     C**********           ENDIF                                                     CDL093 MD027384
      **********                                                                     CDL093 MD027384
     C*                                                                   S01392
     C***********@@CALC    IFEQ '2'                        *** B 1  S01392056095
     C***********@@CALC    OREQ '3'                                 S01392056095
     C***********@@CALC    OREQ '5'                                 S01392056095
     C           ZZCALC    IFEQ '2'                        *** B 1        056095
     C           ZZCALC    OREQ '3'                                       056095
     C           ZZCALC    OREQ '5'                                       056095
     C           ZZCALC    OREQ '7'                                       CIR004
     C           CIR004    ANDEQ'Y'                                       CIR004
     C           ZZCALC    OREQ '0'                                                          CER016A
     C                     Z-ADD36000     @@YEAR  50                      S01392
     C                     END                             *** E 1        S01392
     C*                                                                   S01392
     C***********@@CALC    IFEQ '1'                        *** B 1  S01392056095
     C***********@@CALC    OREQ '4'                                 S01392056095
     C           ZZCALC    IFEQ '1'                        *** B 1        056095
     C           ZZCALC    OREQ '4'                                       056095
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDNE'Y'                                                           CDL093
     C                     Z-ADD36500     @@YEAR                          S01392
     C                     END                              *** E 1       S01392
     C*                                                                   S01392
     C***********@@CALC    IFEQ '6'                         *** B 1 S01392056095
     C           ZZCALC    IFEQ '6'                         *** B 1       056095
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C                     Z-ADD36600     @@YEAR                          S01392
     C                     END                              *** E 1       S01392
     C*                                                                   S01392
     C           ZZCALC    IFEQ '6'                                       163136
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C           INT6DY    MULT @@RATE    @@W157                          163136
     C                     ELSE                                           163136
      *                                                                   163136
     C***********@@INDY    MULT @@RATE    @@W157 157                S01392056095
     C           ZZINDY    MULT @@RATE    @@W157 157                      056095
      *                                                                   163136
     C                     END                                            163136
      *                                                                   163136
     C***********@@W157    MULT @@AMT     @@W150 150H              S01392 056121
     C           @@W157    MULT @@AMT     @@W210 210H                     056121
     C*                                                                   S01392
     C**  ROUND DOWN IF ROUND DOWN INDICATOR IS 'Y'                       S01392
     C*                                                                   S01392
     C           @@RDFC    IFEQ 'Y'                                       S01392
     C***********@@W150    DIV  @@YEAR    @@INTR                   S01392 056121
     C           @@W210    DIV  @@YEAR    @@INTR                          056121
     C                     ELSE                                           S01392
     C***********@@W150    DIV  @@YEAR    @@INTR 150H              S01392 056121
     C           @@W210    DIV  @@YEAR    @@INTR 150H                     056121
     C                     END                                            S01392
     C*                                                                   S01392
     C                     MOVE *BLANK    @@RDFC                          S01392
     C/COPY WNCPYSRC,MM0173C002
      * Interest has been calculated                                                          CDL093
     C           INTCLC    TAG                                                                CDL093
     C*                                                                   S01392
     C           M10309    ENDSR                                          S01392
     C*****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZINTDYZ2                                               056095
      *****************************************************************   ME2110
     C****MM1009*- CALCULATE THE NUMBER OF INTEREST DAYS              *   056095
     C***********                                                     *   056095
     C***CALLED*BY    -                                               *   056095
     C***********                                                     *   056095
     C***CALLS***     -   ZA0710 CONVERT MIDAS DAY NUMBER TO YMD DATE *   056095
     C***********                                                     *   056095
     C***FIELDS*INPUT @@BEG  - START DATE OF PERIOD                   *   056095
     C***********     @@END  - END DATE OF PERIOD                     *   056095
     C***********     @@CALC - INTEREST CALCULATION METHOD            *   056095
     C***********                                                     *   056095
     C***FIELDS*OUTPUT @@INDY - NO. OF INTEREST DAYS                  *   056095
     C***********                                                     *   056095
     C***WORKFIELDS   @@WN5   - WORK FIELD 5N                         *   056095
     C***********     @@WN5A  - WORK FIELD 5N                         *   056095
     C***********     @@WDAT  - WORK FIELD 5N                         *   056095
     C***********     @@DAYN  - WORK FIELD 5N                         *   056095
     C***********     @@P1    - WORK FIELD 5N                         *   056095
     C***********     @@P2    - WORK FIELD 5N                         *   056095
     C***********     @@P3    - WORK FIELD 5N                         *   056095
     C***********     @@LPNM  - WORKFIELD USED IN SETTING UP @@TG10   *   056095
     C***********                                                     *   056095
     C*****************************************************************   056095
     C***********MM1009    BEGSR                                          056095
     C***********                                                         056095
     C***********          MOVE @@BEG     @@BEG   50                      056095
     C***********          MOVE @@END     @@END   50                      056095
     C***********          MOVE @@CALC    @@CALC  1                       056095
     C***********          Z-ADD*ZEROS    @@INDY                          056095
     C***********          Z-ADD*ZEROS    @@LPNM                          056095
     C***********                                                         056095
     C***FIND*NUMBER OF DAYS DIFFERENCE BETWEEN DATES                     056095
     C***********                                                         056095
     C***********@@END     SUB  @@BEG     @@WDAT  50                      056095
     C***********                                                         056095
     C*****FOR*CALCULATION METHODS 3,4 OR 5.                              056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '3'                        **** B 1       056095
     C***********@@CALC    OREQ '4'                                       056095
     C***********@@CALC    OREQ '5'                                       056095
     C***********                                                         056095
     C***********          Z-ADD@@BEG     @@DAYN  50                      056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DATA                          056095
     C***********                                                         056095
     C***********          Z-ADD@@END     @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DATB                          056095
     C***IF*IN*SAME MONTH                                                 056095
     C***********@@YY1     IFEQ @@YY2                      **** B 2       056095
     C***********@@MM1     IFEQ @@MM2                      **** B 3       056095
     C***********@@DD2     SUB  @@DD1     @@INDY                          056095
     C***********          GOTO M10099                     --------->     056095
     C***********          END                             **** E 3       056095
     C***********          END                             **** E 2       056095
     C***********                                                         056095
     C***********          ELSE                            **** X         056095
     C**IF*NOT*3,4 OR 5    ****                                           056095
     C**EXIT*PROCESSING                                                   056095
     C***********          Z-ADD@@WDAT    @@INDY  50       - LOAD OUTPT   056095
     C***********          GOTO M10099                     ----------->   056095
     C***********          END                             **** E 1       056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '3'                        **** B 1       056095
     C***CALC*NO. DAYS IN FIRST MONTH                                     056095
     C***********@@MM1     IFNE 2                          **** B 2       056095
     C***********30        SUB  @@DD1     @@P1    50   80                 056095
     C***IF*<*0,*INITIALISE TO 0                                          056095
     C***80******          Z-ADD*ZEROS    @@P1                            056095
     C***********                                                         056095
     C***********          ELSE                            **** X         056095
     C***TEST*IF*LEAP      ****                                           056095
     C***YEAR****                                                         056095
     C***********@@YY1     DIV  4         @@WN5                           056095
     C***********          MVR            @@WN5          80               056095
     C***********                                                         056095
     C************IN80     IFEQ '1'                        **** B 3       056095
     C***********29        SUB  @@DD1     @@P1    50                      056095
     C***********          ELSE                                           056095
     C***IF*NOT*LEAP       ++++                                           056095
     C***********28        SUB  @@DD1     @@P1    50                      056095
     C***********          END                             **** E 3       056095
     C***********          END                             **** E 2       056095
     C***CALC.*NO. DAYS IN LAST MONTH                                     056095
     C***********@@DD2     IFLE 30                         **** B 2       056095
     C***********          Z-ADD@@DD2     @@P2    50                      056095
     C***********          ELSE                            **** X         056095
     C***********          ****                                           056095
     C***********          Z-ADD30        @@P2                            056095
     C***********          END                             **** E 2       056095
     C***CALC*NO. DAYS IN INTERVENING MONTHS                              056095
     C***********@@YY2     IFEQ @@YY1                      **** B 2       056095
     C***********@@MM2     SUB  @@MM1     @@P3    50                      056095
     C***********          SUB  1         @@P3                            056095
     C***********          MULT 30        @@P3                            056095
     C***********          ELSE                            **** X         056095
     C***********          ****                                           056095
     C***********@@YY2     SUB  @@YY1     @@P3                            056095
     C***********          SUB  1         @@P3                            056095
     C***********          MULT 360       @@P3                            056095
     C***********                                                         056095
     C**FIND*NO.*OF MONTHS FOR THE TWO PARTIAL YEARS                      056095
     C***********12        SUB  @@MM1     @@WN5A  50                      056095
     C***********          MULT 30        @@WN5A                          056095
     C***********                                                         056095
     C***********@@MM2     SUB  1         @@WN5                           056095
     C***********@@WN5     MULT 30        @@WN5                           056095
     C***ACCUMULATE                                                       056095
     C***********@@WN5A    ADD  @@WN5     @@WN5A                          056095
     C***********@@P3      ADD  @@WN5A    @@P3                            056095
     C***********          END                             **** E 2       056095
     C***FINAL*SUM                                                        056095
     C***********                                                         056095
     C***********@@P1      ADD  @@P2      @@INDY                          056095
     C***********          ADD  @@P3      @@INDY                          056095
     C***********          END                             **** E 1       056095
     C***FOR*METHODS 4 AND 5                                              056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '4'                        **** B 1       056095
     C***********@@CALC    OREQ '5'                                       056095
     C****CALCULATE NUMBER OF LEAP YEARS BETWEEN START AND END DATES      056095
     C***********@@MM1     IFLE 2                          **** B 2       056095
     C***********@@YY1     DIV  4         @@WN5   50                   YR 056095
     C***********          MVR            @@WN5          80               056095
     C***ADD*1*IF LEAP YEAR                                               056095
     C***80******          ADD  1         @@LPNM  50                      056095
     C***********          END                             **** E 3       056095
     C***BYPASS*IF YEARS ARE THE SAME                                     056095
     C***********@@YY1     IFEQ @@YY2                      **** B 3       056095
     C***********@@WDAT    SUB  @@LPNM    @@INDY                          056095
     C***********          GOTO M10099                     ---------->    056095
     C***********          END                             **** E 2       056095
     C***LOOP*TO*CALCULATE NO. LEAP YEARS                                 056095
     C***********@@YY1     DOWNE@@YY2                      **** B 2       056095
     C***INCREMENT START YEAR                                             056095
     C***********          ADD  1         @@YY1                           056095
     C***********                                                         056095
     C***********@@YY1     IFEQ @@YY2                      **** B 3       056095
     C***********@@MM2     IFGT 2                          **** B 4       056095
     C***********@@YY2     DIV  4         @@WN5                        YR 056095
     C***********          MVR            @@WN5          80               056095
     C***INCREMENT IF LEAP YEAR                                           056095
     C***80******          ADD  1         @@LPNM                          056095
     C***********          END                              **** E 4      056095
     C***********@@WDAT    SUB  @@LPNM    @@INDY                          056095
     C***********          END                              **** E 3      056095
     C***********@@YY1     IFNE @@YY2                       **** B 3      056095
     C***********@@YY1     DIV  4         @@WN5                        YR 056095
     C***********          MVR            @@WN5          80               056095
     C***ADD*1*IF LEAP YEAR                                               056095
     C***80******          ADD  1         @@LPNM                          056095
     C***********          END                              **** E 3      056095
     C***********          END                              **** E 2      056095
     C***********          END                              **** E 1      056095
     C***********                                                         056095
     C***********M10099    ENDSR                           ***M10099***   056095
      *****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDATE9Z3                                               056095
     C/COPY ZSRSRC,ZFEB29                                                                     CDL093
      *****************************************************************
     C***********                                                     *   056095
     C********TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *   056095
     C***********                                                     *   056095
     C********SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *   056095
     C********PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *   056095
     C********THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *   056095
     C********SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *   056095
     C********IF*'@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *   056095
     C********'@@VDT'  IN 'YYYYMMDD' FORMAT.                          *   056095
     C***********                                                     *   056095
     C**NOTE:*FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS                  056095
     C***********                                                     *   056095
     C********1)*@@DAYN   LENGTH 5,0.                                 *   056095
     C***********                                                     *   056095
     C********FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *   056095
     C***********                                                     *   056095
     C********1)*@@VDT    LENGTH 8,0 DEFINED BY A DS.                 *   056095
     C********2)*@@RTN    LENGTH 1,0.                                 *   056095
     C********3)*@@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *   056095
     C********4)*@@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *   056095
     C********5)*@@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *   056095
     C********6)*@@RDAY   LENGTH 5,0.                                 *   056095
     C********7)*@@LEAP   LENGTH 1,0.                                     056095
     C***********                                                     *   056095
     C********INDICATORS USED ARE:                                    *   056095
     C***********                                                     *   056095
     C********1)*80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *   056095
     C********2)*81       CHECK FOR LOW ON ARRAY @MD.                 *   056095
     C***********                                                     *   056095
     C**INPUT*FIELD:       @@DAYN                                     *   056095
     C***********                                                     *   056095
     C**OUTPUT*FIELD:      @@VDT                                      *   056095
     C***********                                                     *   056095
     C**WORK*FIELDS:       @@RTN                                      *   056095
     C***********          @@Z71Y                                     *   056095
     C***********          @@RDAY                                     *   056095
     C***********          @@LEAP                                     *   056095
     C***********          @@I                                        *   056095
     C***********          @@J                                        *   056095
     C***********                                                     *   056095
     C**ARRAYS*USED:       @YD COMPILE TIME ARRAY.                        056095
     C***********          @MD COMPILE TIME ARRAY.                        056095
     C***********                                                         056095
     C*****************************************************************   056095
     C***********                                                         056095
     C***********ZA0710    BEGSR                                          056095
     C***********                                                         056095
     C***********          SETOF                     8081                 056095
     C***********          Z-ADD0         @@RTN   10                      056095
     C***********          Z-ADD0         @@VDT                           056095
     C***********          Z-ADD1         @@I     20                      056095
     C***********          Z-ADD1         @@J     20                      056095
     C***********          Z-ADD1         @@LEAP  10                      056095
     C***********                                                         056095
     C***********@@DAYN    CABEQ0         ZA0719                    ME1257056095
     C***********                                                         056095
     C***********@@DAYN    IFLT 1                                         056095
     C***********          Z-ADD1         @@RTN                           056095
     C***********          GOTO ZA0719                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**DIVISION*TO DETERMINE WETHER LEAP YEAR.                           056095
     C***********                                                         056095
     C***********@@DAYN    DIV  1461      @@Z71Y                          056095
     C***********          MVR            @@RDAY  50                      056095
     C***********                                                         056095
     C**CALCULATING YEAR.                                                 056095
     C***********                                                         056095
     C***********@@Z71Y    MULT 4         @@Z71Y                          056095
     C***********          ADD  1972      @@Z71Y                          056095
     C***********                                                         056095
     C**CHECKING*IF YEAR IS GREATER THAN OR EQUAL TO 2100                 056095
     C***********                                                         056095
     C***********@@Z71Y    IFGE 2100                                      056095
     C***********          ADD  @@SSY2    @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOKUP*ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE        056095
     C**HAVE*PASSED.                                                      056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@YD,@@I                8080               056095
     C***********                                                         056095
     C**IF*YEAR*IS A LEAP YEAR SSLEAP IS SET TO ZERO.                     056095
     C***********                                                         056095
     C************IN80     IFEQ '0'                                       056095
     C***********          Z-ADD0         @@LEAP                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**ADD*INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 1                                         056095
     C***********@@RDAY    SUB  @YD,@@I   @@RDAY                          056095
     C***********          ADD  @@I       @@Z71Y                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**PROCESSING FOR A LEAP YEAR.                                       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 0                                         056095
     C***********                                                         056095
     C**IF*'@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.                   056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 60                                        056095
     C***********          Z-ADD29        @@Z71D                          056095
     C***********          Z-ADD2         @@Z71M                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*'@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN    056095
     C**PROCEED*AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP     056095
     C**YEAR.*NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.          056095
     C***********                                                         056095
     C***********@@RDAY    IFGT 60                                        056095
     C***********@@RDAY    SUB  1         @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*DAY*'@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS      056095
     C**IN*4*YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR      056095
     C**GROUP.***                                                         056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 0                                         056095
     C***********          Z-ADD31        @@Z71D                          056095
     C***********          Z-ADD12        @@Z71M                          056095
     C***********          SUB  1         @@Z71Y                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOOK*UP*ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'         056095
     C**OCCURS*IN                                                         056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@MD,@@J                81                 056095
     C***********          Z-ADD@@J       @@Z71M                          056095
     C***********@@RDAY    SUB  @MD,@@J   @@Z71D                          056095
     C***********                                                         056095
     C**DS*@@VDT* IS RETURNED IN YYYYMMDD FORMAT                          056095
     C***********                                                         056095
     C***********ZA0711    TAG                                            056095
     C***********                                                         056095
     C***********          MOVE @@Z71Y    @@YR                            056095
     C***********                                                         056095
     C***********ZA0719    ENDSR                                          056095
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #B       - Control main processing                            *
     C*                                                               *
     C* CALLS    #BA      - Initialise new records                    *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*          #BC      - Update time loans/deposits balances       *
     C*          #BD      - Update CD's Bought Balances               *
     C*          #BE      - Update Bills Bought balances              *
     C*          #BF      - Update CD's Sold Balances                 *
     C*          #BG      - Update Bills sold balances                *
     C*          #BH      - Update SI deam balances                   *
     C*                                                               *
     C* CALLED BY  MAIN   - Main Line process                         *
     C*                                                               *
     C* FLDS USED  @TERM  - Termination parameter                     *
     C*            @DCAT  - Work field for Format read                *
     C*            @TYPE  - Work field for deal type                  *
     C*            @CCY   - Work field for currency                   *
     C*            @VDAT  - Work filed for Deal value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @VDAT5 - Work field for value date                 *
     C*            @MDAT  - Work field for maturity date              *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @NIDT  - Work field for next int date              *
     C*            @NIDT5 - Work field for Next int date              *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*            @RBSI  - Work field for BOUGHT or sold             *
     C*            @RMTD5 - Work field for related maturity date      *
     C*            @RLID5 - Work field for related start last date    *
     C*            @RNID5 - Work field for related next int date      *
     C*                                                               *
     C*****************************************************************
     C           #B        BEGSR
      *
     C           *INU7     CABEQ'1'       #B9
      *
      **  Initialise new records on change of Currency
     C           *INL1     IFEQ '1'                        B1
     C                     EXSR #BA                        *1
     C                     MOVE '0'       *INL1            *1
     C           *INU7     CABEQ'1'       #B9              *1
     C                     END                             E1
      *
      **  Check whether deal type is to be processed.
     C           @DCAT     IFEQ 'A'                        B1
     C           @TYPE     CABNE'SI'      #B9              *1
      *
     C                     ELSE                            X1
      *
     C           @TYPE     IFEQ 'CP'                       B*2
     C           @TYPE     OREQ 'CT'                       X*2
     C           @TYPE     OREQ 'DL'                       X*2
     C                     GOTO #B9                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Convert date fields from file YYYYMMDD to MIDAS day numbers.
     C           @VDAT     IFNE *ZEROS                     B1
     C***********          Z-ADD@VDAT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @VDAT5  50       *1             056095
     C                     Z-ADD@VDAT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @VDAT5  50       *1             056095
     C                     END                             E1
      *
     C           @MDAT     IFNE *ZEROS                     B1
     C***********          Z-ADD@MDAT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @MDAT5  50       *1             056095
     C                     Z-ADD@MDAT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @MDAT5  50       *1             056095
     C                     END                             E1
      *
     C           @NIDT     IFNE *ZEROS                     B1
     C***********          Z-ADD@NIDT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @NIDT5  50       *1             056095
     C                     Z-ADD@NIDT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @NIDT5  50       *1             056095
     C/COPY WNCPYSRC,MM0173C012
     C                     END                             E1
      *
     C           @SLDT     IFNE *ZEROS                     B1
     C***********          Z-ADD@SLDT     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @SLDT5  50       *1             056095
     C                     Z-ADD@SLDT     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @SLDT5  50       *1             056095
     C                     END                             E1
      *
      **  Update balances and interest accruals.
     C           @TYPE     IFEQ 'IT'                       B1
     C           @TYPE     OREQ 'IP'                       X1
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'FL'                                      CDL006
     C           @TYPE     OREQ 'TD'                       X1
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'FT'                                      CDL006
     C           @TYPE     OREQ 'TL'                       X1
     C           @TYPE     OREQ 'CI'                       X1
     C           @TYPE     OREQ 'CL'                       X1
     C/COPY WNCPYSRC,MM0173C026
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DP'                                      CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LP'                                      CDL006
     C           @TYPE     OREQ 'CF'                                                          CDL033
     C           CDL033    ANDEQ'Y'                                                           CDL033
     C                     EXSR #BC                        *1
     C                     END                             E1
      *
     C           @RBSI     IFEQ 'B'                        B1
      *
     C           @TYPE     IFEQ 'C1'                       B*2
     C           @TYPE     OREQ 'C2'                       X*2
     C           @TYPE     OREQ 'BO'                       X*2
     C           @TYPE     OREQ 'BI'                       X*2
     C                     EXSR #BD                        **2
     C                     END                             E*2
      *
     C           @TYPE     IFEQ 'TA'                       B*2
     C           @TYPE     OREQ 'TB'                       X*2
     C           @TYPE     OREQ 'BA'                       X*2
     C                     EXSR #BE                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           @RBSI     IFEQ 'S'                        B1
      *
     C           @RLMAD    IFNE *ZEROS                     B*2
     C***********          Z-ADD@RLMAD    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @RMTD5  50       **2            056095
     C                     Z-ADD@RLMAD    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @RMTD5  50       **2            056095
     C                     END                             E*2
      *
     C           @TYPE     IFEQ 'C1'                       B*2
     C           @TYPE     OREQ 'C2'                       X*2
     C           @TYPE     OREQ 'BO'                       X*2
     C           @TYPE     OREQ 'BI'                       X*2
      *
     C           @RLSLD    IFNE *ZEROS                     B*2
     C***********          Z-ADD@RLSLD    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @RLID5  50       **2            056095
     C                     Z-ADD@RLSLD    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @RLID5  50       **2            056095
     C                     END                             E*2
      *
     C           @NBNID    IFNE *ZEROS                     B*2
     C***********          Z-ADD@NBNID    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @RNID5  50       **2            056095
     C                     Z-ADD@NBNID    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @RNID5  50       **2            056095
     C                     END                             E*2
      *
     C                     EXSR #BF                        **2
     C                     END                             E*2
      *
     C           @TYPE     IFEQ 'TA'                       B*2
     C           @TYPE     OREQ 'TB'                       X*2
     C           @TYPE     OREQ 'BA'                       X*2
     C                     EXSR #BG                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           @TYPE     IFEQ 'SI'                       B1
     C                     EXSR #BH                        *1
     C                     END                             E1
      *
      **  Update funds in nostro at start of day.                         FA0006
     C***********@MDAT5    IFGE RUND                       B1      FA0341 S01194
     C***********@VDAT5    ANDLTRUND                       X1      FA0341 S01194
     C           @MDAT5    IFGE BJRDNB                     B1             S01194
     C           @VDAT5    ANDLTBJRDNB                     X1             S01194
     C                     EXSR #BI                        *1             FA0341
     C                     END                             E1             FA0341
      *
     C           #B9       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BC      - Update time loans/deposits balances                *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*******    MM1007   - Calculate interest                        *   S01392
     C*          MM1030   - Calculate interest                        *   S01392
     C***********ZA0680***-*Convert*date*formate*to*midas*day*number***   056095
     C*          ZDAT10   - Convert date formate to midas day number  *   056095
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     -  Main processing                          *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @MDAT  - Work field for maturity date              *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @NIDT  - Work field for next int date              *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*************@@END**-*work*field*for*End*date********************   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            @ICMT  - Work field for Cal Method                 *
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @@AMT  - Work field for amount                     *
     C*            @INTR  - Work field for interest rate              *
     C*            @@RATE - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @NIDT5 - Work field for Next int date              *
     C*            @DMVD  - Work field for deam value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*            @FUID  - Work field for Front-up interest indicator*   S01392
     C*            @FLID  - Work field for First/Last day interest    *   S01392
     C*            @RDFC  - Work field for Round down interest        *   S01392
     C*            @@RDFC - Work field used by MM1030                 *   S01392
     C*                                                               *
     C*****************************************************************
     C           #BC       BEGSR
      *
     C/COPY WNCPYSRC,MM0173C004
      * Get the first related SI deam if it exists
     C           HKDN38    CHAINMMLVDMLL             76
     C           *IN76     IFEQ '0'
     C                     MOVE 'Y'       @PENDA
     C                     END
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG   10
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT   50       *1
     C           @MDAT5    SUB  1         @EDAT   50       *1
     C                     Z-ADD@AMNP     @AMNT  150       *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB  1        *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      *
      **  Update balances with interest due.
     C           @NIDT     IFEQ *ZEROS                     B1
      *
     C                     Z-ADD*ZEROS    @FLAG            *1
      *
      **  Calculate interest due at maturity.
     C           @SLDT     IFNE *ZEROS                     B*2
     C           @MDAT     ANDNE*ZEROS                     X*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@MDAT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@MDAT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C******               Z-ADD@AMNP     @@AMT            **2            S01392
     C******               Z-ADD@INTR     @@RATE           **2            S01392
     C                     Z-ADD@AMNP     @@AMT  150       **2            S01392
     C                     Z-ADD@INTR     @@RATE 117       **2            S01392
     C                     MOVE @RDFC     @@RDFC  1        **2            S01392
     C*                                                                   S01392
     C** If First & Last Day Interest indicator on add an extra           S01392
     C** day's interest.                                                  S01392
     C           @FLID     IFEQ 'Y'                        B**3           S01392
     C***********          ADD  1         @@END            ***3     S01392056095
     C                     ADD  1         ZZEND            ***3           056095
     C                     END                             E**3           S01392
     C*                                                                   S01392
     C******               EXSR MM1007                     **2            S01392
     C/COPY WNCPYSRC,MM0173C005
     C                     EXSR MM1030                     **2            S01392
     C/COPY WNCPYSRC,MM0173C006
      *
      **  Update balances with interest due at maturity.
     C                     Z-SUB@@INTR    @AMNT            **2
     C*                                                                   S01392
     C** If Front-up Interest indicator on interest is added/deducted     S01392
     C** at value date.                                                   S01392
     C           @FUID     IFEQ 'Y'                        B**3           S01392
     C                     Z-ADD@VDAT5    @SDAT            ***3           S01392
     C                     ELSE                            X**3           S01392
     C                     Z-ADD@MDAT5    @SDAT            ***3
     C                     END                             E**3           S01392
     C*                                                                   S01392
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     ELSE                            X1
      *
      **  Calculate interest due at next interest date.
     C           @SLDT     IFNE *ZEROS                     B*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@NIDT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@NIDT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C                     Z-ADD@AMNP     @@AMT            **2
     C                     Z-ADD@INTR     @@RATE           **2
     C******               EXSR MM1007                     **2            S01392
     C/COPY WNCPYSRC,MM0173C007
     C                     EXSR MM1030                     **2            S01392
     C/COPY WNCPYSRC,MM0173C008
      *
      **  Update balances with interest due at next interest date.
     C                     Z-SUB@@INTR    @AMNT            **2
     C                     Z-ADD@NIDT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Insert, so add interest due.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@MDAT5    @EDAT            *1
     C                     MOVE @ICMT     @CALC   1        *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD@INTR     @RATE  117       *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add interest accrued.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C/COPY WNCPYSRC,MM0173C009
     C                     EXSR #ZC                        *1
     C/COPY WNCPYSRC,MM0173C010
     C                     END                             E1
      *
     C           #BC9      ENDSR
     C*****************************************************************
     C/COPY WNCPYSRC,MM0173C011
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BD      - Update CD's Bought Balances                        *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*******    MM1007   - Calculate interest                        *   S01392
     C*          MM1030   - Calculate interest                        *   S01392
     C***********ZA0680***-*Convert*date*format************************   056095
     C*          ZDAT10   - Convert date format                       *   056095
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @MDAT  - Work field for maturity date              *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @FVAL  - Work field for Face value                 *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @NIDT  - Work field for next int date              *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*************@@END**-*work*field*for*End*date********************   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            @ICMT  - Work field for Cal Method                 *
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @@AMT  - Work field for amount                     *
     C*            @FRAT  - Work field for Face rate                  *
     C*            @@RATE - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @NIDT5 - Work field for Next int date              *
     C*            @DMVD  - Work field for deam value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*                                                               *
     C*****************************************************************
     C           #BD       BEGSR
      *
      * Get the first related SI deam if it exists
     C           HLDN38    CHAINMMLVDMLL             76
     C           *IN76     IFEQ '0'
     C                     MOVE 'Y'       @PENDA
     C                     END
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @MDAT5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and face value.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @MDAT     IFNE *ZEROS                     B1
     C                     Z-ADD@MDAT5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @FVAL     ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      *
      **  Update balances with interest due.
     C           @NIDT     IFEQ *ZEROS                     B1
      *
     C                     Z-ADD*ZEROS    @FLAG            *1
      *
      **  Calculate interest due at maturity.
     C           @SLDT     IFNE *ZEROS                     B*2
     C           @MDAT     ANDNE*ZEROS                     X*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@MDAT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@MDAT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C*******              Z-ADD@FVAL     @@AMT            **2            ME2072
     C*******              Z-ADD@FRAT     @@RATE           **2            ME2072
     C                     Z-SUB@AMNP     @@AMT            **2            ME2072
     C                     Z-ADD@INTR     @@RATE           **2            ME2072
     C******               EXSR MM1007                     **2            S01392
     C                     EXSR MM1030                     **2            S01392
      *
      **  Update balances with interest due at maturity.
     C                     Z-ADD@@INTR    @AMNT            **2
     C                     Z-ADD@MDAT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     ELSE                            X1
      *
      **  Calculate interest due at next interest date.
     C           @SLDT     IFNE *ZEROS                     B*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@NIDT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@NIDT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
     C*******              Z-ADD@FVAL     @@AMT            **2            ME2072
     C*******              Z-ADD@FRAT     @@RATE           **2            ME2072
     C                     Z-SUB@AMNP     @@AMT            **2            ME2072
     C                     Z-ADD@INTR     @@RATE           **2            ME2072
     C******               EXSR MM1007                     **2            S01392
     C                     EXSR MM1030                     **2            S01392
      *
      **  Update balances with interest due at next interest date.
     C                     Z-ADD@@INTR    @AMNT            **2
     C                     Z-ADD@NIDT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Insert, so add interest due.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@MDAT5    @EDAT            *1
     C                     MOVE @ICMT     @CALC            *1
     C*******              Z-ADD@FVAL     @AMNT            *1             ME2072
     C*******              Z-ADD@FRAT     @RATE            *1             ME2072
     C                     Z-SUB@AMNP     @AMNT            *1             ME2072
     C                     Z-ADD@INTR     @RATE            *1             ME2072
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  But as interest calculated will be '-' IN #ZC so need
      **  to change the sign
      *
      **  Insert, so add interest accrued.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
     C           #BD9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BE      - Update Bills Bought balances                       *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @MDAT  - Work field for maturity date              *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @FVAL  - Work field for Face value                 *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @ICMT  - Work field for Cal Method                 *
     C*            @CALC  - Work field for interest cal method        *
     C*            @INTR  - Work field for interest rate              *
     C*            @RATE  - work field for interest rate              *
     C*                                                               *
     C*****************************************************************
     C           #BE       BEGSR
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @MDAT5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB  1        *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and
      **  face value.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @MDAT     IFNE *ZEROS                     B1
     C                     Z-ADD@MDAT5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           @FVAL     ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @MDAT     ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@MDAT5    @EDAT            *1
     C                     MOVE @ICMT     @CALC            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD@INTR     @RATE            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add interest accrued.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
     C           #BE9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BF      - Update CD's Sold Balances                          *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*******    MM1007   - Calculate interest                        *   S01392
     C*          MM1030   - Calculate interest                        *   S01392
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @RMTD5 - Work field for related maturity date      *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @WN60  - Key field for deams file                  *
     C*            @DMVD  - Work field for deam value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*            @RLID5 - Work field for related start last date    *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*************@@END**-*work*field*for*End*date********************   056095
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @@AMT  - Work field for amount                     *
     C*            @@RATE - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @RNID5 - Work field for related next int date      *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*                                                               *
     C*****************************************************************
     C           #BF       BEGSR
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @RLMAD    ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @RMTD5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and
      **  sale price.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @RLMAD    IFNE *ZEROS                     B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           HLAMNP    ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and face value.
     C           @FLAG     IFEQ 1                          B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           HLFVAL    ADD  HLAMNP    @AMNT            *1
     C                     END                             E1
      *
      **  Insert, so subtract amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with interest.
     C                     Z-ADD*ZEROS    @FLAG
      *
      **  If related NAB next interest date is zero, does DEAM exist?
     C           @NBNID    IFEQ *ZEROS                     B1
      *
      **  If SI DEAM exists, and DEAM value date after NAS value date.
     C           @PENDA    IFEQ 'Y'                        B*2
      *
     C           @DMVD     IFGE @VDAT                      B**3
      *
      **  Calculate interest due from related start/last interest date.
     C           @RLSLD    ANDNE*ZEROS                     X**3
     C           @DMVD     ANDNE*ZEROS                     X**3
     C***********          Z-ADD@DMVD     @@DTIN           ***3           056095
     C***********          EXSR ZA0680                     ***3           056095
     C***********          Z-ADD@@MDNO    @DMVD5  50       ***3           056095
     C                     Z-ADD@DMVD     ZZDTIN           ***3           056095
     C                     EXSR ZDAT10                     ***3           056095
     C                     Z-ADDZZMDNO    @DMVD5  50       ***3           056095
      *
     C***********          Z-ADD@RLID5    @@BEG            ***3           056095
     C***********          Z-ADD@DMVD5    @@END            ***3           056095
     C***********          MOVE HLICMT    @@CALC           ***3           056095
     C                     Z-ADD@RLID5    ZZBEG            ***3           056095
     C                     Z-ADD@DMVD5    ZZEND            ***3           056095
     C                     MOVE HLICMT    ZZCALC           ***3           056095
     C                     Z-SUBHLAMNP    @@AMT            ***3           ME2057
     C                     Z-ADDHLINTR    @@RATE           ***3           ME2057
     C******               EXSR MM1007                     ***3           S01392
     C                     EXSR MM1030                     ***3           S01392
      *
      **  Backout interest due from DEAM value date to end of book.
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@DMVD5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     Z-ADD1         @FLAG            ***3
     C                     END                             E**3
      *
     C                     ELSE                            X*2
      *
      **  If no SI DEAM's, calculate interest due at related maturity date.
     C           @RLSLD    IFNE *ZEROS                     B**3
     C           @RLMAD    ANDNE*ZEROS                     X**3
     C***********          Z-ADD@RLID5    @@BEG            ***3           056095
     C***********          Z-ADD@RMTD5    @@END            ***3           056095
     C***********          MOVE HLICMT    @@CALC           ***3           056095
     C                     Z-ADD@RLID5    ZZBEG            ***3           056095
     C                     Z-ADD@RMTD5    ZZEND            ***3           056095
     C                     MOVE HLICMT    ZZCALC           ***3           056095
     C                     Z-SUBHLAMNP    @@AMT            ***3
     C                     Z-ADDHLINTR    @@RATE           ***3
     C******               EXSR MM1007                     ***3           S01392
     C                     EXSR MM1030                     ***3           S01392
      *
      **  ...and remove interest due at NAB maturity date.
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@RMTD5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     Z-ADD1         @FLAG            ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     ELSE                            X1
      *
      **  If next NAB interest date is after NAS value date...
     C           @NBNID    IFGE @VDAT                      B*2
      *
      **  ...calculate interest due...
     C           @RLSLD    IFNE *ZEROS                     B**3
     C           @NBNID    ANDNE*ZEROS                     X**3
     C***********          Z-ADD@RLID5    @@BEG            ***3           056095
     C***********          Z-ADD@RNID5    @@END            ***3           056095
     C***********          MOVE HLICMT    @@CALC           ***3           056095
     C                     Z-ADD@RLID5    ZZBEG            ***3           056095
     C                     Z-ADD@RNID5    ZZEND            ***3           056095
     C                     MOVE HLICMT    ZZCALC           ***3           056095
     C                     Z-SUBHLAMNP    @@AMT            ***3           ME2057
     C                     Z-ADDHLINTR    @@RATE           ***3           ME2057
     C******               EXSR MM1007                     ***3           S01392
     C                     EXSR MM1030                     ***3           S01392
      *
      **  ...and remove interest due at SI value date.
     C                     Z-SUB@@INTR    @AMNT            ***3
     C                     Z-ADD@RNID5    @SDAT            ***3
     C                     Z-ADD99999     @EDAT            ***3
     C                     Z-ADD1         @FLAG            ***3
     C                     END                             E**3
      *
     C                     END                             E*2
      *
     C                     END                             E1
      *
      **  Insert, so subtract amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @RLMAD    ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@RMTD5    @EDAT            *1
     C                     MOVE HLICMT    @CALC            *1
     C*********            Z-ADDILRFVL    @AMNT            *1             ME2267
     C*********            Z-ADDILRFRT    @RATE            *1             ME2267
     C                     Z-SUBHLAMNP    @AMNT            *1             ME2267
     C                     Z-ADDHLINTR    @RATE            *1             ME2267
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  But as interest calculated will be '-' in #ZC so need to
      **  change the sign
      *
      **  Insert, so subtract interest accrued.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
     C           #BF9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BG      - Update Bills sold balances                         *
     C*                                                               *
     C* CALLS    #ZB      - Update balance array                      *
     C*          #ZC      - Update interest accruals array            *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @FLAG  - Work field for update operation           *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @VDAT5 - Work field for value date                 *
     C*            @SDAT  - Period Start date                         *
     C*            @RMTD5 - Work field for related maturity date      *
     C*            @EDAT  - Period end date                           *
     C*            @AMNP  - Work field for amount                     *
     C*            @AMNT  - Work field for amount                     *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @CHG   - Work field to check for changes if AMEND  *
     C*            @CALC  - Work field for interest cal method        *
     C*            @RATE  - work field for interest rate              *
     C*                                                               *
     C*****************************************************************
     C           #BG       BEGSR
      *
      **  Update balances with deal amount.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @RLMAD    ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C           @RMTD5    SUB  1         @EDAT            *1
     C                     Z-ADD@AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and
      **  sale price.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @RLMAD    IFNE *ZEROS                     B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           HLAMNP    ADD  @AMNP     @AMNT            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '+'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with difference between purchase price and face value.
     C           @FLAG     IFEQ 1                          B1
     C                     Z-ADD@RMTD5    @SDAT            *1
     C                     Z-ADD99999     @EDAT            *1
     C           HLFVAL    ADD  HLAMNP    @AMNT            *1
     C                     END                             E1
      *
      **  Insert, so subtract amount.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZB                        *1
     C                     END                             E1
      *
      **  Update balances with interest accrued.
     C                     Z-ADD*ZEROS    @FLAG
      *
     C           @VDAT     IFNE *ZEROS                     B1
     C           @RLMAD    ANDNE*ZEROS                     X1
     C                     Z-ADD@VDAT5    @SDAT            *1
     C                     Z-ADD@RMTD5    @EDAT            *1
     C                     MOVE HLICMT    @CALC            *1
     C******               Z-ADDILRFVL    @AMNT            *1             ME1432
     C                     Z-ADDHLAMNP    @AMNT            *1             ME1432
     C                     Z-ADDHLINTR    @RATE            *1
     C                     Z-ADD1         @FLAG            *1
     C                     END                             E1
      *
      **  Insert, so subtract interest accrued.
     C           @FLAG     IFEQ 1                          B1
     C                     MOVE '-'       @ADSUB           *1
     C                     EXSR #ZC                        *1
     C                     END                             E1
      *
     C           #BG9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BH      - Update SI deam balances                            *
     C*                                                               *
     C* CALLS
     C*          #ZB      - Update balance array                      *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @MPHAS - Data structure status of system           *
     C*            @SLDT  - Work field for Start last int date        *
     C*            @VDAT  - Work filed for Deal value date            *
     C*            @SLDT5 - Work field for Start last Int date        *
     C*************@@BEG**-*Work*field*for*start*date******************   056095
     C*            ZZBEG  - Work field for start date                 *   056095
     C*            @VDAT5 - Work field for value date                 *
     C*************@@END**-*work*field*for*End*date********************   056095
     C*            ZZEND  - work field for End date                   *   056095
     C*            @ICMT  - Work field for Cal Method                 *
     C*************@@CALC*-*Work*field*for*calculation*method**********   056095
     C*            ZZCALC - Work field for calculation method         *   056095
     C*            @FVAL  - Work field for Face value                 *
     C*            @@AMT  - Work field for amount                     *
     C*            @FRAT  - Work field for Face rate                  *
     C*            @@RATE - Work field for interest rate              *
     C*            @AMNP  - Work field for amount                     *
     C*            @INTR  - Work field for interest rate              *
     C*            @@INTR - Work field for interest                   *
     C*            @AMNT  - Work field for amount                     *
     C*            @SDAT  - Period Start date                         *
     C*            @EDAT  - Period end date                           *
     C*            @ADSUB - Work field for add or sub operation       *
     C*            @MDAT  - Work field for maturity date              *
     C*            @MDAT5 - Work field for maturity date              *
     C*            @VDYY  - Work field for value Year                 *
     C*            @VDMM  - Work field for Value month                *
     C*            @VDDD  - Work field for value day                  *
     C*            @FLAG  - Work field for update operation           *
     C*            @DMVD  - work field for deam value date            *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @DMVD5 - Work field for deam value date            *
     C*                                                               *
     C*****************************************************************
     C           #BH       BEGSR
      *
     C           HNAMNP    IFNE *ZEROS                     B1
      *
     C                     Z-ADD*ZEROS    @FLAG            *1
      *
      **  Calculate interest due at maturity...
     C           @SLDT     IFNE *ZEROS                     B*2
     C           @MDAT     ANDNE*ZEROS                     B*2
     C***********          Z-ADD@SLDT5    @@BEG            **2            056095
     C***********          Z-ADD@MDAT5    @@END            **2            056095
     C***********          MOVE @ICMT     @@CALC           **2            056095
     C                     Z-ADD@SLDT5    ZZBEG            **2            056095
     C                     Z-ADD@MDAT5    ZZEND            **2            056095
     C                     MOVE @ICMT     ZZCALC           **2            056095
      *
     C           HNORBS    IFEQ 'B'                        B**3
     C                     Z-SUB@FVAL     @@AMT            ***3
     C                     Z-ADD@FRAT     @@RATE           ***3
     C                     ELSE                            X**3
     C                     Z-ADD@AMNP     @@AMT            ***3
     C                     Z-ADD@INTR     @@RATE           ***3
     C                     END                             E**3
      *
     C******               EXSR MM1007                     **2            S01392
     C                     EXSR MM1030                     **2            S01392
      *
      **  ...and update balances.
     C                     Z-SUB@@INTR    @AMNT            **2
     C                     Z-ADD@MDAT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
      **  Insert, so remove amount.
     C           @FLAG     IFEQ 1                          B*2
     C                     MOVE '-'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
      *
      **  Update balances with DEAM amount.
     C                     Z-ADD*ZEROS    @FLAG            *1
      *
     C           @VDAT     IFNE *ZEROS                     B*2
     C           HNAMNP    IFLT 0                          B**3
     C                     Z-SUBHNAMNP    @AMNT            ***3
     C                     ELSE                            X**3
     C                     Z-ADDHNAMNP    @AMNT            ***3
     C                     END                             E**3
     C                     Z-ADD@VDAT5    @SDAT            **2
     C                     Z-ADD99999     @EDAT            **2
     C                     Z-ADD1         @FLAG            **2
     C                     END                             E*2
      *
      **  Insert, so add amount.
     C           @FLAG     IFEQ 1                          B*2
     C                     MOVE '+'       @ADSUB           **2
     C                     EXSR #ZB                        **2
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BH9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BI      - Update Funds in Nostro at start of day             *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @TYPE  - Work field for deal type                  *
     C*            @RBSI  - Work field for BOUGHT or sold             *
     C*            @OPMT  - Work field for our pay method             *
     C*            @MTHD  - Work field for payment method             *
     C*            @ORMT  - Work field for our receive method         *
     C*            @LACT  - Work field for action code                *
     C*            @AMNP  - Work field for amount                     *
     C*            @BAMT  - Work field for before amount              *
     C*                                                               *
     C*****************************************************************
     C           #BI       BEGSR
      *
     C**  E19981 - CHECK ON INDICATOR 01 IS NOT NEEDED BECAUSE L/D        E19981
     C**           CAN ALSO SETTLE THROUGH NOSTRO.                        E19981
     C********** *IN01     CABEQ'1'       #BI9                            E19981
     C                     MOVE '0'       *IN60
      *
      **  Check for our pay method to be processed.
     C**  E19981 - CHECKING ON THE WRONG FIELDS, BOTH L/D AND N/A         E19981
     C**           CAN BE SETTLE THROUGH NOSTRO.                          E19981
     C********** HKTYPE    IFEQ 'IP'                       B1             E19981
     C********** HKTYPE    OREQ 'TL'                       X1             E19981
     C********** HKTYPE    OREQ 'CL'                       X1             E19981
     C********** HKRBSI    OREQ 'B'                        X1             E19981
     C**********           MOVE '1'       *IN60            *1             E19981
     C**********           MOVE HKDOPM    @MTHD   5        *1             E19981
     C**********           END                             E1             E19981
     C           @TYPE     IFEQ 'IP'                       B1             E19981
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'FL'                                      CDL006
     C           @TYPE     OREQ 'TL'                       X1             E19981
     C           @TYPE     OREQ 'CL'                       X1             E19981
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DP'                                      CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LP'                                      CDL006
     C           @RBSI     OREQ 'B'                        X1             E19981
     C                     MOVE '1'       *IN60            *1             E19981
     C                     MOVE @OPMT     @MTHD   5        *1             E19981
     C                     END                             E1             E19981
      *
      **  Check for our receive method to be processed.
     C**  E19981 - CHECKING ON THE WRONG FIELDS, BOTH L/D AND N/A         E19981
     C**           CAN BE SETTLE THROUGH NOSTRO.                          E19981
     C********** HKTYPE    IFEQ 'IT'                       B1             E19981
     C********** HKTYPE    OREQ 'TD'                       X1             E19981
     C********** HKTYPE    OREQ 'CI'                       X1             E19981
     C********** HKRBSI    OREQ 'S'                        X1             E19981
     C**********           MOVE '1'       *IN60            *1             E19981
     C**********           MOVE HKDORM    @MTHD            *1             E19981
     C**********           END                             E1             E19981
     C           @TYPE     IFEQ 'IT'                       B1             E19981
     C           @TYPE     OREQ 'TD'                       X1             E19981
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'FT'                                      CDL006
     C           @TYPE     OREQ 'CI'                       X1             E19981
     C           @RBSI     OREQ 'S'                        X1             E19981
     C/COPY WNCPYSRC,MM0173C027
     C           @TYPE     OREQ 'CF'                                                          CDL033
     C           CDL033    ANDEQ'Y'                                                           CDL033
     C                     MOVE '1'       *IN60            *1             E19981
     C                     MOVE @ORMT     @MTHD            *1             E19981
     C                     END                             E1             E19981
      *
      **  Accumulate into nostro account.
     C           *IN60     IFEQ '1'                        B1
      *
     C           @MTHD     IFEQ 'TELX'                     B*2
     C           @MTHD     OREQ 'CHIPS'                    X*2
     C           @MTHD     OREQ 'SWIFT'                    X*2
     C**  E19981 - CSENT AND CCOLL ARE NOT NOSTRO                         E19981
     C********** @MTHD     OREQ 'CSENT'                    X*2            E19981
     C********** @MTHD     OREQ 'CCOLL'                    X*2            E19981
     C**  E19981 - USING THE WRONG AMOUNT FIELD, BOTH L/D AND N/A         E19981
     C**           CAN BE SETTLE THROUGH NOSTRO.                          E19981
     C**********           ADD  HKAMNP    HRNOSN           **2            E19981
     C                     ADD  @AMNP     HRNOSN           **2            E19981
     C                     END                             E*2
      *
     C                     END                             E1
      *
     C           #BI9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BA      - Initialise new records                             *
     C*                                                               *
     C* CALLS    ZA0730   - Determine next working day                *
     C***********ZA0680***-*Convert*date*format*to*midas*day*number****   056095
     C***********ZA0710***-*Convert*midas*day*number*to*date*format****   056095
     C*          ZDAT10   - Convert date format to midas day number   *   056095
     C*          ZDATE9   - Convert midas day number to date format   *   056095
     C*          MM1003   - Calculate period date                     *
     C*                                                               *
     C* CALLED BY  BB     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @M     - Array to hold month names                 *
     C*            @USER  - work field for user                       *
     C*            @CCY   - Work field for currency                   *
     C*************@@DTIN*-*Data*structure*to*hold*date****************   056095
     C*            ZZDTIN - Data structure to hold date               *   056095
     C*************@@CCY**-*work*field*for*currency********************   S01194
     C*            ZCCY   - work field for currency                   *   S01194
     C*************@@MDNO*-*Work*field*for*number*of*days*in*month*****   056095
     C*            ZZMDNO - Work field for number of days in month    *   056095
     C*            @A     - Array to hold net balances                *
     C*            @I     - Array for net Interest accrued            *
     C*            @@DAYN - Work field for day number                 *
     C*            @@VDT  - Work field for period date                *
     C*            @@SPOT - Work field for spot date                  *
     C*            @@PNUM - Work field for period number (1,2,3 etc)  *
     C*            @@PTYP - Work field for period type (D, M or W)    *
     C*            @@PDAT - Work field for period end date            *
     C*                                                               *
     C*****************************************************************
     C           #BA       BEGSR
      *
      **  Set up fields for new MMEPOULL.
     C                     MOVE 'H2'      H2RCID
     C                     MOVE *BLANKS   H2DLTF
     C                     Z-ADDUDAY      H2DLUP
     C                     MOVE @M,UMONTH H2MLUP
     C                     Z-ADDUYEAR     H2YLUP
     C                     TIME           H2TLUP
     C                     MOVE 'I'       H2CHTP
     C*********            Z-ADDRUND      H2LCD                           S01194
     C                     Z-ADDBJRDNB    H2LCD                           S01194
     C                     MOVEL@USER     H2LUID
     C                     MOVE @CCY      H2CCY
      *
      ****Access*FDCCYTLL*to get default interest calculation method.     S01194
     C*********            MOVE *BLANKS   KEY                             S01194
     C*********            MOVEL'20'      KEY                             S01194
     C*********            MOVEL@CCY      KEY912  4                       S01194
     C*********            MOVE '1'       KEY912                          S01194
     C*********            MOVE KEY912    KEY                             S01194
     C*********  KEY       CHAINFDCCYTLL             60                   S01194
      *                                                                   S01194
      ** get default interest calculation method.                         S01194
     C                     CALL 'AOCURRR0'                                S01194
     C                     PARM '*MSG   ' @RTCD   7                       S01194
     C                     PARM '*KEY   ' @OPTN   7                       S01194
     C                     PARM @CCY      @WRK3   3                       S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*                                                                   S01194
     C*********  *IN60     IFEQ '1'                        B1             S01194
     C           @RTCD     IFNE *BLANK                     B1             S01194
     C                     MOVE '003'     DBASE            ***************
     C*********            MOVEL'FDCCYTLL'DBFILE           *             *S01194
     C*********            MOVELKEY       DBKEY            * DBERROR 003 *S01194
     C                     MOVEL'SDCURRPD'DBFILE           *             *S01194
     C                     MOVEL@CCY      DBKEY            * DBERROR 003 *S01194
     C                     MOVE @OPTN     DBOPTN  7        *             *S01194
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR                E14042
     C                     EXSR *PSSR                                     S01194
     C                     GOTO #BA9                       *1
     C                     END                             E1
      *
     C*********            Z-ADDDICM      H2DICM                          S01194
     C                     MOVE A6DICB    H2DICM                          S01194
     C                     Z-ADD*ZEROS    H2NBSP
     C                     Z-ADD*ZEROS    H2NIAS
     C                     Z-ADD*ZEROS    H2CCPL
     C*********            Z-ADDMSPD      H2SPDT                          S01194
     C                     Z-ADDA6MMSD    H2SPDT                          S01194
      *
      ** Calculate spot date period date.
     C*********            Z-ADDMSPD      @@DTIN                          S01194
     C***********          Z-ADDA6MMSD    @@DTIN                    S01194056095
     C*********            MOVE @CCY      @@CCY   3                       S01194
     C                     Z-ADDA6MMSD    ZZDTIN                          056095
     C                     MOVE @CCY      ZCCY    3                       S01194
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         H2SPPD                          056095
     C           ZZMDNO    SUB  1         H2SPPD                          056095
      *
      ** Calculate number of days in period.
     C*********            Z-ADDMSPD      @@DTIN                          S01194
     C***********          Z-ADDA6MMSD    @@DTIN                    S01194056095
     C***********          EXSR ZA0680                                    056095
     C***********H2SPPD    SUB  @@MDNO    H2NDPD                          056095
     C                     Z-ADDA6MMSD    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           H2SPPD    SUB  ZZMDNO    H2NDPD                          056095
     C                     ADD  1         H2NDPD
      *
      **  Set up new fields for MMFNRULL.
     C                     MOVE 'HR'      HRRCID
     C                     MOVE *BLANKS   HRDLTF
     C                     Z-ADDUDAY      HRDLUP
     C                     MOVE @M,UMONTH HRMLUP
     C                     Z-ADDUYEAR     HRYLUP
     C                     TIME           HRTLUP
     C                     MOVE 'I'       HRCHTP
     C*********            Z-ADDRUND      HRLCD                           S01194
     C                     Z-ADDBJRDNB    HRLCD                           S01194
     C                     MOVEL@USER     HRLUID
     C                     MOVE @CCY      HRCCY
     C*********************Z-ADDDICM      HRDICM                          S01194
     C                     MOVE A6DICB    HRDICM                          S01194
     C                     Z-ADD*ZEROS    HRNOSN
     C                     Z-ADD*ZEROS    @A
     C                     Z-ADD*ZEROS    @I
     C/COPY WNCPYSRC,MM0173C024
      *
      ** Calculate today period date.
     C*********            Z-ADDRUND      @@DAYN                          S01194
     C                     Z-ADDBJRDNB    @@DAYN                          S01194
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C*********            MOVE @CCY      @@CCY                           S01194
     C                     MOVE @CCY      ZCCY                            S01194
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDTD                          056095
     C           ZZMDNO    SUB  1         HRPDTD                          056095
      *
      ** Calculate D1 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD1                          056095
     C           ZZMDNO    SUB  1         HRPDD1                          056095
      *
      ** Calculate D2 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD2                          056095
     C           ZZMDNO    SUB  1         HRPDD2                          056095
      *
      ** Calculate D3 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD3                          056095
     C           ZZMDNO    SUB  1         HRPDD3                          056095
      *
      ** Calculate D4 period date.
     C***********          Z-ADD@@MDNO    @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADDZZMDNO    @@DAYN                          056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         HRPDD4                          056095
     C           ZZMDNO    SUB  1         HRPDD4                          056095
      *
      ** Calculate W1 period date.
     C*********            MOVE @CCY      @@CCY                           S01194
     C                     MOVE @CCY      ZCCY                            S01194
     C*********            MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD1         @@PNUM
     C                     MOVE 'W'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C*******              Z-ADD@@MDNO    HRPDW1                          ME2063
     C***********@@MDNO    SUB  1         HRPDW1                    ME2063056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDW1                          056095
      *
      ** Calculate M1 period date.
     C*********            MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD1         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C*******              Z-ADD@@MDNO    HRPDM1                          ME2063
     C***********@@MDNO    SUB  1         HRPDM1                    ME2063056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDM1                          056095
      *
      ** Calculate M2 period date.
     C*********            MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD2         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C*******              Z-ADD@@MDNO    HRPDM2                          ME2063
     C***********@@MDNO    SUB  1         HRPDM2                    ME2063056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDM2                          056095
      *
      ** Calculate M3 period date.
     C*********            MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD3         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C*******              Z-ADD@@MDNO    HRPDM3                          ME2063
     C***********@@MDNO    SUB  1         HRPDM3                    ME2063056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         HRPDM3                          056095
      *
      ** Calculate number of days in periods.
     C*******    HRPDTD    SUB  RUND      HRDPTD                          S01194
     C           HRPDTD    SUB  BJRDNB    HRDPTD                          S01194
     C                     ADD  1         HRDPTD
     C           HRPDD1    SUB  HRPDTD    HRDPD1
     C           HRPDD2    SUB  HRPDD1    HRDPD2
     C           HRPDD3    SUB  HRPDD2    HRDPD3
     C           HRPDD4    SUB  HRPDD3    HRDPD4
     C           HRPDW1    SUB  HRPDD4    HRDPW1
     C           HRPDM1    SUB  HRPDW1    HRDPM1
     C           HRPDM2    SUB  HRPDM1    HRDPM2
     C           HRPDM3    SUB  HRPDM2    HRDPM3
      *
     C           HRPDTD    SUB  HRDPTD    @S,1
     C           HRPDD1    SUB  HRDPD1    @S,2
     C           HRPDD2    SUB  HRDPD2    @S,3
     C           HRPDD3    SUB  HRDPD3    @S,4
     C           HRPDD4    SUB  HRDPD4    @S,5
     C           HRPDW1    SUB  HRDPW1    @S,6
     C           HRPDM1    SUB  HRDPM1    @S,7
     C           HRPDM2    SUB  HRDPM2    @S,8
     C           HRPDM3    SUB  HRDPM3    @S,9
     C                     ADD  1         @S
      *
     C*********            Z-ADDMSPD      @@DTIN                          S01194
     C***********          Z-ADDA6MMSD    @@DTIN                    S01194056095
     C***********          EXSR ZA0680                                    056095
     C***********          Z-ADD@@MDNO    @S,10                           056095
     C                     Z-ADDA6MMSD    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C                     Z-ADDZZMDNO    @S,10                           056095
      *
     C           #BA9      ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *       TITLE:DETERMINE NEXT WORKING DAY.                       *
      *                                                               *
      ********SUBROUTINE*ZA0730*EXPECTS*FIELD*'@@DTIN'*TO*BE***********   056095
      *       SUBROUTINE ZA0730 EXPECTS FIELD 'ZZDTIN' TO BE          *   056095
      *       PASSED TO IT IN 'YYYYMMDD' FORMAT.IT THEN DETERMINES    *
      *       THE NEXT WORKING DAY AND RETURNS.                       *
      *                                                               *
      **INPUT**:@@DTIN*DATE*(YYYYMMDD)*-*IN*DATA*STRUCTURE*(SIZE*:*8N)*   056095
      **********@@CCY**CURRENCY*CODE***-*IN*FORMAT(3A)*****************   S01194
      * INPUT  :ZZDTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)*   056095
      *         ZCCY   CURRENCY CODE   - IN FORMAT(3A)                *   S01194
      *                                                               *
      * OUTPUT :@@VDT  DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)*
      *                                                               *
      **USES*:***@@MDNO*MIDAS*DAY*NO*USED*BY*SR*ZA0680*****************   056095
      ***********@@DAYN*MIDAS*DAY*NO*USED*BY*SR*ZA0710*****************   056095
      * USES :   ZZMDNO MIDAS DAY NO USED BY SR ZDAT10                *   056095
      *          @@DAYN MIDAS DAY NO USED BY SR ZDATE9                *   056095
      ***********@@MNO  MIDAS DAY NO USED BY SR ZA0830        *********   S01195
      *          ZDAYNO MIDAS DAY NO USED BY SR ZCHKH                 *   S01195
      ***********@@HIND HOLIDAY IND.RETURNED BY ZA0830        *********   S01195
      *          ZIND HOLIDAY IND.RETURNED BY ZCHKH                   *   S01195
      *                                                               *
      *****************************************************************
     C           ZA0730    BEGSR
      *
      * CONVERT YYYYMMDD FORMAT TO MIDAS DAY NO.
      *
     C***********          EXSR ZA0680                                    056095
     C                     EXSR ZDATE9                                    056095
      *
     C           ZA0731    TAG
      *
     C***********          ADD  1         @@MDNO  50                      056095
     C                     ADD  1         ZZMDNO  50                      056095
      *
      * CHECK IF DAY NO. IS A HOLIDAY          .
      *
     C*********************Z-ADD@@MDNO    @@MNO   50                      S01195
     C***********          Z-ADD@@MDNO    ZDAYNO  50                S01195056095
     C                     Z-ADDZZMDNO    ZDAYNO  50                      056095
      *
     C*********************EXSR ZA0830                                    S01195
     C                     EXSR ZCHKH                                     S01195
      *
     C***********@@HIND    IFEQ 'H'                                       S01195
     C           ZIND      IFEQ 'H'                                       S01195
     C                     GOTO ZA0731
     C                     END
      *
      * CONVERT MIDAS DAY NO. TO YYYYMMDD FORMAT.
      *
     C***********          Z-ADD@@MDNO    @@DAYN  50                      056095
     C                     Z-ADDZZMDNO    @@DAYN  50                      056095
      *
     C***********          EXSR ZA0710                                    056095
     C                     EXSR ZDATE9                                    056095
      *
     C           ZA0739    ENDSR                                       **
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUBROUTINE ZA0770 - THIS SUBROUTINE RECEIVES A 8/0 INPUT     *
      *                      DATE - FORMAT YYYYMMDD AND OUTPUTS A     *
      *                      6/0 DATE. IF FIELD DATF ON TABTB10 =     *
      *                      'M' OUTPUT FORMAT MMDDYY. IF FIELD       *
      *                      DATF = 'D' OUTPUT FORMAT DDMMYY.         *
      *                                                               *
      *  CALLED BY   :                                                *
      *                                                               *
      *  INPUT       : @@DTIN  - DATE INPUT (8,0)                     *
      *  OUTPUT      : @@DTOU  - DATE OUTPUT (6,0)                    *
      *                                                               *
      *  WORK FIELDS : @@YYY   - YEAR IN (2,0)                        *
      *              : @@MM    - MONTH IN (2,0)                       *
      *              : @@DD    - DAY IN (2,0)                         *
      *                                                               *
      *              : @@DAT1  - IF DATE DD/MM/YY DAY ELSE MONTH (2,0)*
      *              : @@DAT2  - IF DATE DD/MM/YY MONTH ELSE DAY (2,0)*
      *                                                               *
      *****************************************************************
     C/EJECT
     C           ZA0770    BEGSR
      *
     C                     Z-ADD@@YY      @@YYY
      *
      **  DATF = 'D' CONVERT TO MMDDYY FORMAT
     C***********DATF      IFEQ 'D'                        B1             S01194
     C           BJDFIN    IFEQ 'D'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT1           *1
     C                     Z-ADD@@MM      @@DAT2           *1
     C                     END                             E1
      *
      *
      **  DATF = 'M' CONVERT TO MMDDYY FORMAT
     C***********DATF      IFEQ 'M'                        B1             S01194
     C           BJDFIN    IFEQ 'M'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT2           *1
     C                     Z-ADD@@MM      @@DAT1           *1
     C                     END                             E1
      *
      **  MOVE YEAR PART OF DATA STRUCTURE
     C                     MOVE @@YYY     @@YY
      *
     C           ZA0779    ENDSR                           ***ZA0779***
      ***********************************************************************
      /EJECT
      ***********************************************************************
      *****                                                       *****   S01195
      **ZA0830*-*THIS SUBROUTINE FINDS OUT WHETHER A PARTICULAR DAY****   S01195
      *****      IS A HOLIDAY IN A PARTICULAR CURRENCY            *****   S01195
      *****                                                       *****   S01195
      **CALLED*BY :                                               *****   S01195
      *****                                                       *****   S01195
      **CALLS :                                                   *****   S01195
      *****                                                       *****   S01195
      **INPUT**: @@MNO  MIDAS DAY NUMBER 5N                       *****   S01195
      *****      @@CCY  CURRENCY CODE 3A                          *****   S01195
      *****                                                       *****   S01195
      **OUTPUT*: @@HIND HOLIDAY/WORKING DAY INDICATOR 1A          *****   S01195
      *****                                                       *****   S01195
      **USES :   @@MNO  MIDAS DAY NUMBER                          *****   S01195
      *****      @@CCY  CURRENCY CODE                             *****   S01195
      *****      @@ONCE FIRST TIME THROUGH INDICATOR              *****   S01195
      *****      @@CY1  FIRST HALF OF CURRENCY ARRAY              *****   S01195
      *****      @@CY2  SECOND HALF OF CURRENCY ARRAY             *****   S01195
      *****      @@MNO6 MIDAS NUMBER WITH TRAILING BLANK          *****   S01195
      *****      @@HIND HOLIDAY/WORKING DAY INDICATOR             *****   S01195
      *****      @@INEX INCLUDE/EXCLUDE INDICATOR                 *****   S01195
      *****                                                       *****   S01195
      *****      INDICATORS                                       *****   S01195
      *****      80 RECORD NOT FOUND                              *****   S01195
      *****      81 CURRENCY NOT FOUND ON RECORD                  *****   S01195
      *****                                                       *****   S01195
      *****************************************************************   S01195
     C*****      ZA0830    BEGSR                                  *****   S01195
      *****                                                       *****   S01195
      ***OPEN*CURRENCY/HOLIDAY FILE IF FIRST TIME THROUGH         *****   S01195
     C*****      @@ONCE    IFNE 'Y'                        B1     *****   S01195
     C*****                OPEN FDTABJLL                   *1     *****   S01195
     C*****                MOVE 'Y'       @@ONCE  1        *1     *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***BLANK*OUT ARRAY                                          *****   S01195
     C*****                MOVE *BLANKS   @@CY1                   *****   S01195
     C*****                MOVE *BLANKS   @@CY2                   *****   S01195
      *****                                                       *****   S01195
      ***ACCESS*TABLE ON FIRST KEY                                *****   S01195
     C*****                MOVEL@@MNO     @@MNO6  6               *****   S01195
     C*****                MOVE @@MNO6    @@0830 12               *****   S01195
     C*****                MOVEL'22    '  @@0830                  *****   S01195
     C*****                MOVE '1'       @@0830                  *****   S01195
     C*****      @@0830    CHAINTABLETJF             80           *****   S01195
      *****                                                       *****   S01195
      ***IF*RECORD NOT FOUND OR DELETED                           *****   S01195
     C*****      *IN80     IFEQ '1'                        B1     *****   S01195
     C*****      RECI      OREQ '*'                        *1     *****   S01195
     C*****                MOVE 'W'       @@HIND           *1     *****   S01195
     C*****                GOTO ZA0839                     *1     *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***MOVE*FIRST 25 CURRENCIES TO ARRAY                        *****   S01195
     C*****                MOVE HCCY      @@CY1                   *****   S01195
      *****                                                       *****   S01195
      ***ACCESS TABLE ON SECOND KEY                               *****   S01195
     C*****                MOVE '2'       @@0830                  *****   S01195
     C*****      @@0830    CHAINTABLETJF             80           *****   S01195
      *****                                                       *****   S01195
      ***IF*SECOND RECORD FOUND AND NOT DELETED                   *****   S01195
     C*****      *IN80     IFEQ '0'                        B1     *****   S01195
     C*****      RECI      ANDNE'*'                        *1     *****   S01195
     C*****                MOVE HCCY      @@CY2            *1     *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***SEARCH*ARRAY FOR INPUT CURRENCY                          *****   S01195
     C*****      @@CCY     LOKUP@CY                      81       *****   S01195
      *****                                                       *****   S01195
      ***IF*INPUT CURRENCY IS IN ARRAY                            *****   S01195
     C*****      *IN81     IFEQ '1'                        B1     *****   S01195
      *****                                                       *****   S01195
      ***IF*INCLUDE/EXCLUDE INDICATOR EQ 'E'                      *****   S01195
     C*****      INEX      IFEQ 'E'                        B*2    *****   S01195
     C*****                MOVE 'W'       @@HIND  1        **2    *****   S01195
     C*****                ELSE                            X*2    *****   S01195
     C*****                MOVE 'H'       @@HIND           **2    *****   S01195
     C*****                END                              *2    *****   S01195
     C*****                END                             E1     *****   S01195
      *****                                                       *****   S01195
      ***IF*INPUT CURRENCY IS NOT IN ARRAY                        *****   S01195
     C*****      *IN81     IFEQ '0'                        B1     *****   S01195
      *****                                                       *****   S01195
      ** IF INCLUDE/EXCLUDE INDICATOR EQ 'I'                      *****   S01195
     C*****      INEX      IFEQ 'I'                        B*2    *****   S01195
     C*****                MOVE 'W'       @@HIND           **2    *****   S01195
     C*****                ELSE                            X*2    *****   S01195
     C*****                MOVE 'H'       @@HIND           **2    *****   S01195
     C*****                END                              *2    *****   S01195
     C*****                END                             E1     *****   S01195
     C*****      ZA0839    ENDSR                                  *****   S01195
      *****************************************************************   S01195
     C/COPY ZSRSRC,ZCHKH                                                  S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
      *****************************************************************
      /EJECT
      *****************************************************************
      *   MM1003 - CALCULATE A PERIOD DATE                            *
      *                                                               *
      *   PERIOD DATES ARE CALCULATED FOR THE FOLLOWING PERIODS       *
      *      PERIOD TYPE       PERIOD NUMBER     PERIOD SHORTNAME     *
      *           D                 -1             OVERNIGHT          *
      *           D                  0             TOMORROW / NEXT    *
      *           D                  1             SPOT / NEXT        *
      *           W                  1             1 WEEK             *
      *           W                  2             2 WEEK             *
      *           W                  3             3 WEEK             *
      *           M                  1             1 MONTH            *
      *           M                  2             2 MONTH            *
      *           M                  3             3 MONTH            *
      *           M                  6             6 MONTH            *
      *           M                  9             9 MONTH            *
      *           Y                  1             1 YEAR             *
      *                                                               *
      *  CALLED BY    -                                               *
      *                                                               *
      *  CALLS        -                                               *
      *                                                               *
      *  ZA0770       - CONVERT DATE YYYYMMDD TO DDMMYY               *
      ***ZA0830*******-*CHECK*IF*DAY*IS*A*WORKING*DAY******************   S01195
      *  ZA0730       - FIND NEXT WORKING DAY                         *
      ***ZA0710*******-*CONVERT*MIDAS*DAY*NO*TO*YYYYMMDD***************   056095
      ***ZA0680*******-*CONVERT*DATE*TO*MIDAS*DAY*NUMBER***************   056095
      *  ZDATE9       - CONVERT MIDAS DAY NO TO YYYYMMDD              *   056095
      *  ZDAT10       - CONVERT DATE TO MIDAS DAY NUMBER              *   056095
      *                                                               *
      *  CALLS PROGRAM ZA0270 CONVERT DATE TO MIDAS DAY NUMBER WITH   *
      *                VALIDATION CHECK                               *
      *                                                               *
      *  FIELDS INPUT -                                               *
      *                                                               *
      ***@@CCY***3****-*CURRENCY***************************************   S01194
      *  ZCCY    3    - CURRENCY                                      *   S01194
      *  @@SPOT  8    - MONEY MARKET SPOT DATE                        *
      *  @@PNUM  1,0  - PERIOD NUMBER                                 *
      *  @@PTYP  1    - PERIOD TYPE                                   *
      ***RUND****5,0**-*MIDAS*RUN*DATE                                *   S01194
      *  BJRDNB  5,0  - MIDAS RUN DATE                                *   S01194
      *                                                               *
      *  FIELDS OUTPUT                                                *
      *                                                               *
      *  @@PDAT  8,0  - PERIOD DATE                                   *
      *                                                               *
      *  WORK FIELDS                                                  *
      *                                                               *
      *  @@DTIN  8,0  - DATE INPUT TO ZA0770 IN YYYYMMDD FORMAT       *
      *  ZZDTIN  8,0  - DATE INPUT TO ZDAT10 IN YYYYMMDD FORMAT       *   056095
      *  @@DFMT  1    - DATE FORMAT                                   *
      *  @@RTNC  1    - RETURN INDICATOR FROM ZA0270                  *
      *  @@DAYN  5,0  - MIDAS DAY NUMBER                              *
      ***@@MNO***5,0**-*MIDAS*DAY*NUMBER*******************************   S01195
      ***@@HIND**1****-*HOLIDAY*INDICATOR*H*OR*W***********************   S01195
      *  @@ADD   3,0  - CALCULATION WORK FIELD                        *
      ***@@VDT***8,0**-*DATE*OUTPUT*FROM*ZA0710************************   056095
      *  @@VDT   8,0  - DATE OUTPUT FROM ZDATE9                       *   056095
      *  @@RUND  8    - RUN DATE IN YYYYMMDD FORMAT                   *
      *                                                               *
      *****************************************************************
      *
     C           MM1003    BEGSR
      *
     C                     Z-ADD*ZERO     @@STRT
     C                     Z-ADD*ZERO     @@DTIN
     C                     Z-ADD*ZERO     ZZDTIN                          056095
     C                     Z-ADD*ZERO     @@SPDD
     C                     Z-ADD*ZERO     @@DATE
     C                     Z-ADD*ZERO     @@DTOU
     C                     Z-ADD*ZERO     @@Z71Y
     C                     Z-ADD*ZERO     @@VDT
      *
     C                     MOVE @@SPOT    @@SPDD
      **  SET UP STARTING POINT DATE AS SPOT DATE
     C                     Z-ADD@@SPDD    @@STRT
      *
      **  ADD PERIOD NUMBERS TO DATE
     C           @@PTYP    IFEQ 'M'                        B1
     C                     ADD  @@PNUM    @@STMT           *1
     C           @@STMT    IFGT 12                         B*2
     C                     SUB  12        @@STMT           **2
     C                     ADD  1         @@STYR           **2
     C                     END                              *2
     C                     END                             E1
      *
     C           @@PTYP    IFEQ 'Y'                        B1
     C                     ADD  1         @@STYR           *1
     C                     END                             E1
      *
      **  CONVERT DATE FORMAT FROM YYYYMMDD TO DDMMYY
     C                     Z-ADD@@STRT    @@DTIN
     C                     EXSR ZA0770
     C                     Z-ADD@@DTOU    @@DATE
      *
     C           *LIKE     DEFN @@VDT     @@RUND
     C           @@RUND    IFEQ *ZERO                      B1
     C*********            Z-ADDRUND      @@DTIN           *1             S01194
     C***********          Z-ADDBJRDNB    @@DTIN           *1       S01194056095
     C***********          EXSR ZA0710                     *1             056095
     C                     Z-ADDBJRDNB    @@DAYN           *1             056095
     C                     EXSR ZDATE9                     *1             056095
     C                     Z-ADD@@VDT     @@RUND           *1
     C                     END                             E1
      *
     C                     MOVEL'D'       @@DFMT  1
     C                     MOVE @@DATE    @@DATC  60
      *
      **  CONVERT STARTING DATE TO MIDAS DAY NUMBER FORMAT
     C           @@RTNC    DOUEQ'0'                        B1
     C                     CALL 'ZA0270'                   *1
     C                     PARM           @@DATC           *1
     C*********************PARM           DATF             *1             S01194
     C                     PARM           BJDFIN           *1             S01194
     C           @@RTNC    PARM           @@RTNC  1        *1
     C           @@DAYN    PARM           @@DAYN  50       *1
      *
     C**  E20775 - Make provision for the difference in date format       E20775
     C**           when decrease the date by 1 day.                       E20775
     C**********           SUB  1         @@DAY2           *1             E20775
     C           BJDFIN    IFEQ 'D'                        B*2            E20775
     C                     SUB  1         @@DAY2           **2            E20775
     C                     ELSE                            X*2            E20775
     C                     SUB  1         @@DAY1           **2            E20775
     C                     END                             E*2            E20775
     C*                                                                   E20775
     C                     MOVE @@DATE    @@DATC           *1
      *
     C                     END                             E1
      *
     C*********************Z-ADD@@DAYN    @@MNO                           S01195
     C                     Z-ADD@@DAYN    ZDAYNO                          S01195
     C                     MOVEL@@RTNC    @@RTN
     C*
     C**  RESET STARTING POINT
     C***********          EXSR ZA0710                              ME1161056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     @@STRT                    ME1161
      * CALCULATE 1W AS 7D                                                E17654
     C           @@PTYP    IFEQ 'W'                                       E17654
     C           @@PNUM    ANDEQ1                                         E17654
     C                     MOVE 'D'       @@PTYP                          E17654
     C                     Z-ADD7         @@PNUM                          E17654
     C           1         DO   7                                         E17654
     C***********@@HIND****DOUEQ'W'***********             B**3    E17654 S01195
     C           ZIND      DOUEQ'W'                        B**3           S01195
     C*********************ADD  1         @@MNO            ***3    E17654 S01195
     C                     ADD  1         ZDAYNO           ***3           S01195
     C*********************EXSR ZA0830                     ***3    E17654 S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              **3           E17654
     C                     END                              **3           E17654
     C                     END                                            E17654
      *
      **  PROCESS PERIOD TYPE 'D'
     C           @@PTYP    IFEQ 'D'                        B1
      *
      **  IF PERIOD NUMBER = 1 FIND NEXT WORKING DAY
     C           @@PNUM    IFEQ 1                          B*2
     C***********@@HIND****DOUEQ'W'**********              B**3           S01195
     C           ZIND      DOUEQ'W'                        B**3           S01195
     C*********************ADD  1         @@MNO            ***3           S01195
     C                     ADD  1         ZDAYNO           ***3           S01195
     C*********************EXSR ZA0830                     ***3           S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              **3
     C                     END                              *2
      *
      **  IF PERIOD NUMBER NE 1 FIND TOMORROW/NEXT DAY (AND OVERNIGHT)
      **  IE FIND NEXT WORKING DAY BEYOND RUND
     C           @@PNUM    IFLT 1                          B*2
     C***********          Z-ADD@@RUND    @@DTIN           **2            056095
     C                     Z-ADD@@RUND    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
     C                     Z-ADD@@VDT     @@PDAT           **2
     C                     END                              *2
      *
      **  IF PERIOD NUMBER IS -1 FIND NEXT WORKING DAY TOMM/NEXT.
      **  IE FIND NEXT WORKING DAY BEYOND RUND
     C           @@PNUM    IFEQ 0                          B*2
     C***********          Z-ADD@@PDAT    @@DTIN           **2            056095
     C                     Z-ADD@@PDAT    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
     C                     Z-ADD@@VDT     @@PDAT           **2
     C                     END                              *2
      *
     C                     END                             E1
      *
      **  PROCESS PERIOD TYPE 'W'
     C           @@PTYP    IFEQ 'W'                        B1
      *
      **  INCREMENT DAY NUMBER
     C           @@PNUM    MULT 7         @@ADD   30       *1
     C*********************ADD  @@ADD     @@MNO            *1             S01195
     C                     ADD  @@ADD     ZDAYNO           *1             S01195
      *
      **  FIND NEXT WORKING DAY
     C*********************EXSR ZA0830                     *1             S01195
     C                     EXSR ZCHKH                      *1             S01195
     C***********@@HIND****DOWEQ'H'***********             B*2            S01195
     C           ZIND      DOWEQ'H'                        B*2            S01195
     C*********************ADD  1         @@MNO            **2            S01195
     C                     ADD  1         ZDAYNO           **2            S01195
     C*********************EXSR ZA0830                     **2            S01195
     C                     EXSR ZCHKH                      **2            S01195
     C                     END                              *2
     C                     END                             E1
      *
      **  PROCESS PERIOD TYPE 'M' OR 'Y'
     C           @@PTYP    IFEQ 'M'                        B1
     C           @@PTYP    OREQ 'Y'                        *1
      *
      **  IS SPOT LAST WORKING DAY IN MONTH
     C***********          Z-ADD@@SPDD    @@DTIN           *1             056095
     C                     Z-ADD@@SPDD    ZZDTIN           *1             056095
     C                     EXSR ZA0730                     *1
     C           @@SPMT    IFNE @@Z71M                     B*2
     C                     Z-ADD1         @@STDY           **2
     C           @@STMT    IFEQ 12                         B**3
     C                     Z-ADD1         @@STMT           ***3
     C                     ADD  1         @@STYR           ***3
     C                     ELSE                            X**3
     C                     ADD  1         @@STMT           ***3
     C                     END                              **3
      *
      **  CONVERT STARTING DATE TO MIDAS DAY NUMBER FORMAT
     C***********          Z-ADD@@STRT    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C*********************Z-ADD@@MDNO    @@MNO            **2            S01195
     C***********          Z-ADD@@MDNO    ZDAYNO           **2      S01195056095
     C                     Z-ADD@@STRT    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    ZDAYNO           **2            056095
     C***********@@HIND****DOUEQ'W'***********             B**3           S01195
     C           ZIND      DOUEQ'W'                        B**3           S01195
     C*********************SUB  1         @@MNO            ***3           S01195
     C                     SUB  1         ZDAYNO           ***3           S01195
     C*********************EXSR ZA0830                     ***3           S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              **3
     C                     GOTO M10038                     **2
     C                     END                              *2
      *
      **  IF THE STARTING POINT DAY IS A NON WORKING DAY AND THE NEXT
      **  WORKING DAY FALLS IN THE NEXT MONTH  FIND LAST WORKING DAY
      **  IN STARTING MONTH.
     C***********          Z-ADD@@STRT    @@DTIN           *1       ME1161056095
     C***********          EXSR ZA0680                     *1       ME1161056095
     C*********************Z-ADD@@MDNO    @@MNO            *1       ME1161S01195
     C***********          Z-ADD@@MDNO    ZDAYNO           *1       S01195056095
     C                     Z-ADD@@STRT    ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    ZDAYNO           *1             056095
     C*********************EXSR ZA0830                     *1             S01195
     C                     EXSR ZCHKH                      *1             S01195
     C***********@@HIND****IFEQ 'H'***********             B*2            S01195
     C           ZIND      IFEQ 'H'                        B*2            S01195
     C***********          Z-ADD@@STRT    @@DTIN           **2            056095
     C                     Z-ADD@@STRT    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
      *
     C           @@STMT    IFNE @@Z71M                     B**3
     C***********@@HIND****DOUEQ'W'************            B***4          S01195
     C           ZIND      DOUEQ'W'                        B***4          S01195
     C*********************SUB  1         @@MNO            ****4          S01195
     C                     SUB  1         ZDAYNO           ****4          S01195
     C*********************EXSR ZA0830                     ****4          S01195
     C                     EXSR ZCHKH                      ****4          S01195
     C                     END                              ***4
     C*******              GOTO M10038                     ***3     ME1161
     C                     END                              **3
     C                     GOTO M10038                     ***3     ME1161
     C                     END                              *2
      *
      **  IF STARTING DATE IS A WORKING DAY IN CURRENCY & SPOT DATE
      **  IS NOT LAST WORKING DAY IN MONTH PERIOD DATE IS STARTING DAY
     C                     Z-ADD@@STRT    @@PDAT           *1
     C                     GOTO M10039                     *1
      *
     C                     END                             E1
      *
     C           M10038    TAG
      *
      **  CONVERT DATE TO YYYYMMDD FORMAT
     C*********************Z-ADD@@MNO     @@DAYN                          S01194
     C                     Z-ADDZDAYNO    @@DAYN                          S01194
     C***********          EXSR ZA0710                                    056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     @@PDAT  80
      *
     C                     GOTO M10039
      *
     C                     Z-ADD0         @@PNUM  10
     C                     MOVE *BLANKS   @@PTYP  1
     C                     MOVE *BLANKS   @@SPOT  8
      *
     C           M10039    ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #A       - Initial Processing                                 *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  MAIN   - Main Line process                         *
     C*                                                               *
     C* FLDS USED  @FCYC  - Work field for first cycle processing     *
     C*            @TERM  - Termination parameter                     *
     C*            @DCAT  - Work field for Format read                *
     C*            @STDL  - Data structure for loan/deposit record    *
     C*            @STDB  - Data structure for NAB record             *
     C*            @STDS  - Data structure for NAS record             *
     C*            @STDA  - Data structure for DEAMs record           *
     C*            @MPHAS - Data structure status of system           *
     C*            @TYPE  - Work field for deal type                  *
     C*            @CCY   - Work field for currency                   *
     C*            @RBSI  - Work field for BOUGHT or sold             *
     C*            @AMNP  - Work field for amount                     *
     C*            @INTR  - Work field for interest rate              *
     C*            @ICMT  - Work field for Cal Method                 *
     C*            @FVAL  - Work field for Face value                 *
     C*            @FRAT  - Work field for Face rate                  *
     C*            @VDYY  - Work field for value Year                 *
     C*            @VDMM  - Work field for Value month                *
     C*            @VDDD  - Work field for value day                  *
     C*            @NIYY  - Work field for next int year              *
     C*            @NIMM  - Work field for next int month             *
     C*            @NIDD  - Work field for Next int DAy               *
     C*            @MDYY  - Work field for maturity year              *
     C*            @MDMM  - Work field for maturity month             *
     C*            @MDDD  - Work field for Maturity Day               *
     C*            @SLYY  - Work field for Start last int year        *
     C*            @SLMM  - Work field for Start last Int month       *
     C*            @SLDD  - Work field for Start last int day         *
     C*            @FUID  - Work field for Front-up interest indicator*   S01392
     C*            @FLID  - Work field for First/Last day interest    *   S01392
     C*            @RDFC  - Work field for Round down interest        *   S01392
     C*                                                               *
     C*****************************************************************
     C           #A        BEGSR
      *
     C                     MOVEACPY@      BIS@   80                       S01194
      *
      * Define local data area                                                                CDL033
     C           *NAMVAR   DEFN           LDA                                                 CDL033
      *                                                                                       CDL033
     C           @FCYC     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @FCYC   1        *1
      *
      **  Receive input parameters.
     C           *ENTRY    PLIST                           *1
     C                     PARM           @TERM   1        *1
      *
      **  Set up program name in *LDA in case of database error.
     C                     MOVEL'MM0173'  DBPGM            *1
      *                                                         E14042
     C           *NAMVAR   DEFN SDSTAT    @STATS                E14042
      *
      **  Open files.
     C*************        OPEN FDICDRLL                   *1             S01194
     C*************        OPEN FDCCYTLL                   *1             S01194
     C                     OPEN MMLVDMLL
     C                     OPEN MMEPOULL                   *1
     C                     OPEN MMFNRULL                   *1
      *
      ****Access*FDICDRLL*to*get*MIDAS*run*date.*****                     S01194
     C*********            MOVE *BLANKS   KEY              *1             S01194
     C*********            MOVEL'01'      KEY    12        *1             S01194
     C*********            MOVE '10'      KEY              *1             S01194
     C*********  KEY       CHAINFDICDRLL             60    *1             S01194
      *
     C* Use Access Object To Get MIDAS Run Date                           S01194
     C                     CALL 'AOBANKR0'                 *1             S01194
     C                     PARM '*MSG    '@RTCD            *1             S01194
     C                     PARM '*FIRST  '@OPTN            *1             S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C*                                                                   S01194
     C*********  *IN60     IFEQ '1'                        B*2            S01194
     C           @RTCD     IFNE *BLANK                     B*2            S01194
     C                     MOVE '001'     DBASE            ***************
     C*********            MOVEL'FDICDRLL'DBFILE           *             *S01194
     C*********            MOVELKEY       DBKEY            * DBERROR 001 *S01194
     C                     MOVEL'SDBANKPD'DBFILE           *************  S01194
     C                     MOVEL@OPTN     DBOPTN           * DBERROR 001 *S01194
     C                     MOVEL@OPTN     DBKEY            *              S01194
     C                     MOVE '1'       *INU7            *             *
     C                     MOVE '1'       *INU8            ***************
     C                     MOVE '1'       *INLR            **2 E14042
     C                     EXSR *PSSR                                     S01194
     C                     GOTO #A9                        **2
     C                     END                             E*2
      *                                                                                       CDL033
      ** Access Switchable Features file and check if CDL033                                  CDL033
      ** is switched on or not.                                                               CDL033
      *                                                                                       CDL033
     C                     CALL 'AOSARDR0'                                                    CDL033
     C                     PARM *BLANKS   PRTCD   7                                           CDL033
     C                     PARM '*VERIFY' POTPN   7                                           CDL033
     C                     PARM 'CDL033'  PSARD   6                                           CDL033
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL033
      *                                                                                       CDL033
     C           PRTCD     IFEQ *BLANKS                                                       CDL033
     C                     MOVE 'Y'       CDL033  1                                           CDL033
     C                     ELSE                                                               CDL033
     C                     MOVE 'N'       CDL033                                              CDL033
      *                                                                                       CDL033
      ** Database Error, if Return Code is not blanks or *NRF                                 CDL033
      *                                                                                       CDL033
     C           PRTCD     IFNE '*NRF   '                                                     CDL033
     C           *LOCK     IN   LDA                                                           CDL033
     C                     MOVEL'SCSARDPD'DBFILE                                              CDL033
     C                     MOVEL'009'     DBASE                                               CDL033
     C                     MOVEL'CDL033  'DBKEY                                               CDL033
     C                     OUT  LDA                                                           CDL033
     C                     EXSR *PSSR                                                         CDL033
     C                     ENDIF                                                              CDL033
      *                                                                                       CDL033
     C                     ENDIF                                                              CDL033
      *                                                                   CDL006
      ** Access Switchable Features file to check if Dealing Fiducia      CDL006
      ** ry is installed.                                                 CDL006
      *                                                                   CDL006
     C                     MOVE 'N'       CDL006  1                       CDL006
     C                     CALL 'AOSARDR0'                                CDL006
     C                     PARM *BLANKS   WRTCD   7                       CDL006
     C                     PARM '*VERIFY' WOPTN   7                       CDL006
     C                     PARM 'CDL006'  WSARD   6                       CDL006
     C           SCSARD    PARM SCSARD    DSFDY                           CDL006
      *                                                                   CDL006
     C           WRTCD     IFNE *BLANKS                                   CDL006
     C           WRTCD     ANDNE'*NRF   '                                 CDL006
     C                     MOVEL'002'     DBASE             ************* CDL006
     C                     MOVEL'SCSARDPD'DBFILE            * DBERR 002 * CDL006
     C                     MOVELWRTCD     DBKEY             ************* CDL006
     C                     MOVE *ON       *INU7                           CDL006
     C                     MOVE *ON       *INU8                           CDL006
     C                     MOVE *ON       *INLR                           CDL006
     C                     EXSR *PSSR                                     CDL006
     C                     ENDIF                                          CDL006
      *                                                                   CDL006
     C           WRTCD     IFEQ *BLANK                                    CDL006
     C                     MOVEL'Y'       CDL006                          CDL006
     C                     ENDIF                                          CDL006
      *                                                                   CIR004
      ** Check if Dealing Calculation Method Change is switched ON        CIR004
      *                                                                   CIR004
     C                     MOVE 'N'       CIR004  1                       CIR004
     C                     CALL 'AOSARDR0'                                CIR004
     C                     PARM *BLANKS   WRTCD                           CIR004
     C                     PARM '*VERIFY' WOPTN                           CIR004
     C                     PARM 'CIR004'  WSARD                           CIR004
     C           SCSARD    PARM SCSARD    DSFDY                           CIR004
      *                                                                   CIR004
     C           WRTCD     IFNE *BLANKS                                   CIR004
     C           WRTCD     ANDNE'*NRF   '                                 CIR004
     C                     MOVEL'004'     DBASE             ************* CIR004
     C                     MOVEL'SCSARDPD'DBFILE            * DBERR 004 * CIR004
     C                     MOVEL'CIR004  'DBKEY             ************* CIR004
     C                     MOVE *ON       *INU7                           CIR004
     C                     MOVE *ON       *INU8                           CIR004
     C                     EXSR *PSSR                                     CIR004
     C                     ENDIF                                          CIR004
      *                                                                   CIR004
     C           WRTCD     IFEQ *BLANK                                    CIR004
     C                     MOVEL'Y'       CIR004                          CIR004
     C                     ENDIF                                          CIR004
      *                                                                   CIR004
      ***Call*access*program*for*General*Ledger*details.***************            MD035545 MD047993
      *****************************************************************            MD035545 MD047993
     C**********           CALL 'AOGELRR1'                                         MD035545 MD047993
     C**********           PARM '*MSG   ' @RTCD   7                                MD035545 MD047993
     C**********           PARM '*FIRST ' @OPTN   7                                MD035545 MD047993
     C********** SDGELR    PARM SDGELR    DSSDY                                    MD035545 MD047993
      *                                                                                     MD035545
     C********** @RTCD     IFNE *BLANK                                             MD035545 MD047993
     C**********           MOVEL'SDGELRPD'DBFILE                                   MD035545 MD047993
     C**********           MOVEL'062'     DBASE                                    MD035545 MD047993
     C**********           MOVEL@OPTN     DBKEY                                    MD035545 MD047993
     C**********           EXSR *PSSR                                              MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
      *                                                                                     MD035545
      ** Retrieve system value setting                                                      MD035545
      *                                                                                     MD035545
     C                     MOVELWPARML    P@OP01                                            MD035545
     C                     CALL 'AOSVALR0'                                                  MD035545
     C                     PARM *BLANKS   W0RTCD  7                                         MD035545
     C                     PARM           P@OP01 20                                         MD035545
     C                     PARM           P@VL01200                                         MD035545
     C                     PARM           P@OP02 20                                         MD035545
     C                     PARM           P@VL02200                                         MD035545
     C                     PARM           P@OP03 20                                         MD035545
     C                     PARM           P@VL03200                                         MD035545
     C                     PARM           P@OP04 20                                         MD035545
     C                     PARM           P@VL04200                                         MD035545
     C                     PARM           P@OP05 20                                         MD035545
     C                     PARM           P@VL05200                                         MD035545
     C                     PARM           P@OP06 20                                         MD035545
     C                     PARM           P@VL06200                                         MD035545
     C                     PARM           P@OP07 20                                         MD035545
     C                     PARM           P@VL07200                                         MD035545
     C                     PARM           P@OP08 20                                         MD035545
     C                     PARM           P@VL08200                                         MD035545
     C                     PARM           P@OP09 20                                         MD035545
     C                     PARM           P@VL09200                                         MD035545
     C                     PARM           P@OP10 20                                         MD035545
     C                     PARM           P@VL10200                                         MD035545
      *                                                                                     MD035545
      ** If system value is not found then default value to 'N'                             MD035545
      *                                                                                     MD035545
     C           W0RTCD    IFNE '       '                                                   MD035545
     C                     MOVE 'N'       WCALC6                                            MD035545
     C                     ELSE                                                             MD035545
     C                     MOVELP@VL01    WCALC6                                            MD035545
     C********** WCALC6    IFEQ 'Y'                                                MD035545 MD047993
     C********** BKALDI    ANDEQ'Y'                                                MD035545 MD047993
     C**********           MOVE 'Y'       WCALC6                                   MD035545 MD047993
     C**********           ELSE                                                    MD035545 MD047993
     C**********           MOVE 'N'       WCALC6                                   MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
     C                     ENDIF                                                            MD035545
      *                                                                                     MD035545
     C/COPY WNCPYSRC,MM0173C003
      *
      **  Extract file fields.
     C           *LIKE     DEFN HKTYPE    @TYPE            *1
     C           *LIKE     DEFN HKCCY     @CCY             *1
     C           *LIKE     DEFN HKRBSI    @RBSI            *1
     C           *LIKE     DEFN HKAMNP    @AMNP            *1
     C           *LIKE     DEFN HKINTR    @INTR            *1
     C           *LIKE     DEFN HKICMT    @ICMT            *1
     C           *LIKE     DEFN HLFVAL    @FVAL            *1
     C           *LIKE     DEFN HLFRAT    @FRAT            *1
     C           *LIKE     DEFN HKRDFC    @RDFC            *1             S01392
     C           *LIKE     DEFN HKFLID    @FLID            *1             S01392
     C           *LIKE     DEFN HKFUID    @FUID            *1             S01392
      *
     C                     END                             E1
      *
      *  Reset 'Pending Process Indicator' and convert to @DCAT,
      *                                         'Current Process'
      *  Loan/Dep or NAB pending
     C           @PEND     IFNE *BLANK                     B1
     C                     MOVE @PEND     @DCAT   1        *1
     C                     MOVE *BLANK    @PEND   1        *1
     C                     ELSE                            X1
      *  NA sell pending
     C           @PENDS    IFNE *BLANK                     B*2
     C                     MOVE *BLANK    @PENDS  1        **2
     C                     MOVE 'S'       @DCAT            **2
     C                     ELSE                            X*2
      *  Deam SI pending
     C           @PENDA    IFNE *BLANK                     B**3
     C                     MOVE *BLANK    @PENDA  1        ***3
     C                     MOVE 'A'       @DCAT            ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'L'                        B1
     C                     MOVE HKTYPE    @TYPE            *1
     C                     MOVE HKCCY     @CCY             *1
     C                     MOVE HKRBSI    @RBSI            *1
     C                     Z-ADDHKAMNP    @AMNP            *1
     C                     Z-ADDHKVDYY    @VDYY            *1
     C                     Z-ADDHKVDMM    @VDMM            *1
     C                     Z-ADDHKVDDD    @VDDD            *1
     C                     Z-ADDHKNIYY    @NIYY            *1
     C                     Z-ADDHKNIMM    @NIMM            *1
     C                     Z-ADDHKNIDD    @NIDD            *1
     C                     Z-ADDHKMDYY    @MDYY            *1
     C                     Z-ADDHKMDMM    @MDMM            *1
     C                     Z-ADDHKMDDD    @MDDD            *1
     C                     MOVE @MDAT     @RLMAD  80       *1
     C                     Z-ADDHKSLYY    @SLYY            *1
     C                     Z-ADDHKSLMM    @SLMM            *1
     C                     Z-ADDHKSLDD    @SLDD            *1
     C                     MOVE @SLDT     @RLSLD  80       *1
     C                     Z-ADDHKINTR    @INTR            *1
     C                     MOVE HKICMT    @ICMT            *1
     C                     Z-ADD*ZEROS    @FVAL            *1
     C                     Z-ADD*ZEROS    @FRAT            *1
     C**  E19981 - SET UP PAYMENT/RECEIVE METHOD FOR L/D                  E19981
     C                     MOVE HKDOPM    @OPMT   5        *1             E19981
     C                     MOVE HKDORM    @ORMT   5        *1             E19981
     C                     MOVE HKRDFC    @RDFC            *1             S01392
     C                     MOVE HKFLID    @FLID            *1             S01392
     C                     MOVE HKFUID    @FUID            *1             S01392
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'B'                        B1
      * Is an NA sale joined on to this Buy ?
     C           HMDN38    IFNE *ZEROS                     B*2
     C                     MOVE 'Y'       @PENDS           **2
     C                     END                             E*2
      *
     C                     MOVE HLTYPE    @TYPE            *1
     C                     MOVE HLCCY     @CCY             *1
     C                     MOVE HLRBSI    @RBSI            *1
     C                     Z-ADDHLAMNP    @AMNP            *1
     C                     Z-ADDHLVDYY    @VDYY            *1
     C                     Z-ADDHLVDMM    @VDMM            *1
     C                     Z-ADDHLVDDD    @VDDD            *1
     C                     Z-ADDHLNIYY    @NIYY            *1
     C                     Z-ADDHLNIMM    @NIMM            *1
     C                     Z-ADDHLNIDD    @NIDD            *1
     C                     MOVE @NIDT     @NBNID  80       *1
     C                     Z-ADDHLMDYY    @MDYY            *1
     C                     Z-ADDHLMDMM    @MDMM            *1
     C                     Z-ADDHLMDDD    @MDDD            *1
     C                     MOVE @MDAT     @RLMAD  80       *1
     C                     Z-ADDHLLIYY    @SLYY            *1
     C                     Z-ADDHLLIMM    @SLMM            *1
     C                     Z-ADDHLLIDD    @SLDD            *1
     C                     MOVE @SLDT     @RLSLD  80       *1
     C                     Z-ADDHLINTR    @INTR            *1
     C                     MOVE HLICMT    @ICMT            *1
     C                     Z-ADDHLFVAL    @FVAL            *1
     C                     Z-ADDHLFRAT    @FRAT            *1
     C**  E19981 - SET UP PAYMENT/RECEIVE METHOD FOR N/A                  E19981
     C                     MOVE HLDOPM    @OPMT            *1             E19981
     C                     MOVE HLDORM    @ORMT            *1             E19981
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'S'                        B1
     C                     MOVE HMTYPE    @TYPE            *1
     C                     MOVE HMCCY     @CCY             *1
     C                     MOVE HMRBSI    @RBSI            *1
     C                     Z-ADDHMAMNP    @AMNP            *1
     C                     Z-ADDHMVDYY    @VDYY            *1
     C                     Z-ADDHMVDMM    @VDMM            *1
     C                     Z-ADDHMVDDD    @VDDD            *1
     C                     Z-ADDHMNIYY    @NIYY            *1
     C                     Z-ADDHMNIMM    @NIMM            *1
     C                     Z-ADDHMNIDD    @NIDD            *1
     C                     Z-ADDHMMDYY    @MDYY            *1
     C                     Z-ADDHMMDMM    @MDMM            *1
     C                     Z-ADDHMMDDD    @MDDD            *1
     C                     Z-ADDHMLIYY    @SLYY            *1
     C                     Z-ADDHMLIMM    @SLMM            *1
     C                     Z-ADDHMLIDD    @SLDD            *1
     C                     Z-ADDHMINTR    @INTR            *1
     C                     MOVE HMICMT    @ICMT            *1
     C                     Z-ADDHMFVAL    @FVAL            *1
     C                     Z-ADDHMFRAT    @FRAT            *1
     C                     END                             E1
      *
     C           @DCAT     IFEQ 'A'                        B1
      * Set up field from Loan or NA as required
     C           *IN01     IFEQ '1'                        B*2
     C                     Z-ADDHKAMNP    @AMNP            **2
     C                     MOVE HKICMT    @ICMT            **2            ME2245
     C                     Z-ADDHKINTR    @INTR            **2
     C                     ELSE                            X*2
     C                     Z-ADDHLAMNP    @AMNP            **2
     C                     MOVE HLICMT    @ICMT            **2            ME2245
     C                     Z-ADDHLINTR    @INTR            **2
     C                     END                             E*2
      *
     C                     MOVE HNTYPE    @TYPE            *1
     C                     MOVE HNCCY     @CCY             *1
     C                     Z-ADDHNVDYY    @VDYY            *1
     C                     Z-ADDHNVDMM    @VDMM            *1
     C                     Z-ADDHNVDDD    @VDDD            *1
     C                     MOVE @RLMAD    @MDAT            *1
     C                     MOVE @RLSLD    @SLDT            *1
     C                     Z-ADDHLFVAL    @FVAL            *1
     C                     Z-ADDHLFRAT    @FRAT            *1
     C                     Z-ADD*ZEROS    @NIDT            *1
     C                     END                             E1
      *
      *
     C           #A9       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #C       - Termination processing                             *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  MAIN   - Main Line process                         *
     C*                                                               *
     C* FLDS USED  @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           #C        BEGSR
      *
      **  If database error, terminate program.
     C           *LOCK     IN   @STATS                              E14042
     C                     MOVE @SUBMN    @SUBM1  10                E14042
     C                     SUB  1         @SUBM1                    E14042
     C                     MOVE @SUBM1    @SUBMN                    E14042
     C           *INU7     IFEQ '1'                        B1
     C                     MOVE 'E'       @TERM            *1
     C                     MOVE '1'       *INLR            *1
     C                     MOVE 'X'       @STRM2                    E14042
     C*********************CALL 'QCAEXEC'                  *1       E14042E20774
     C                     CALL 'QCMDEXC'                  *1             E20774
     C                     PARM           @CM,1            *1       E14042
     C                     PARM 80        @QCALN 155       *1       E14042
     C                     END                             E1
     C                     OUT  @STATS                              E14042
      *                                                             E14042
     C           *INU7     IFEQ '1'                        B1       E14042
     C                     DUMP                            *1       E14042
     C                     END                             E1       E14042
      *
     C           #C9       ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* *PSSR    - Program error handling subroutine                  *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @ERR1  - Work field for error to prevent looping   *
     C*            @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           *PSSR     BEGSR
      *
      ** SET @ERR1 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR1     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR1   1        *1
     C                     MOVE '1'       *INU6            *1
      *                                                    *1
      ** SET UP FIELDS IN LOCAL DATA AREA                  *1
     C                     MOVEL'MM0173'  DBPGM            *1
     C                     MOVE '991'     DBASE            *1
      *  Flag Stream in error, send Message                         E14042
     C           *LOCK     IN   @STATS                     *1       E14042
     C                     MOVE @SUBMN    @SUBM1  10       *1       E14042
     C                     SUB  1         @SUBM1           *1       E14042
     C                     MOVE @SUBM1    @SUBMN           *1       E14042
     C                     MOVE 'X'       @STRM2           *1       E14042
     C*********************CALL 'QCAEXEC'                  *1       E14042E20774
     C                     CALL 'QCMDEXC'                  *1             E20774
     C                     PARM           @CM,1            *1       E14042
     C                     PARM 80        @QCALN 155       *1       E14042
     C                     OUT  @STATS                     *1       E14042
      *                                                    *1
      ** DUMP THE PROGRAM                                  *1
     C                     DUMP                            *1
     C                     MOVE 'E'       @TERM
     C                     END                             E1
      *
      ** TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* INFSR    - File Exception/error subroutine                    *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @ERR2  - Work field for error 2                    *
     C*            @FILE  - Work field for file processed             *
     C*            @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           INFSR     BEGSR
      *
      ** SET @ERR2 TO 'Y' TO PREVENT LOOPING IF FURTHER ERRORS
     C           @ERR2     IFNE 'Y'                        B1
     C                     MOVE 'Y'       @ERR2   1        *1
     C                     MOVE '1'       *INU7            *1
     C                     MOVE '1'       *INU8            *1
      *                                                    *1
      ** SET UP FIELDS IN LOCAL DATA AREA                  *1
     C                     MOVEL@FILE     DBFILE           *1
     C                     MOVE '992'     DBASE            *1
      *  Flag Stream in error, send Message                         E14042
     C           *LOCK     IN   @STATS                     *1       E14042
     C                     MOVE @SUBMN    @SUBM1  10       *1       E14042
     C                     SUB  1         @SUBM1           *1       E14042
     C                     MOVE @SUBM1    @SUBMN           *1       E14042
     C                     MOVE 'X'       @STRM2           *1       E14042
     C*********************CALL 'QCAEXEC'                  *1       E14042E20774
     C                     CALL 'QCMDEXC'                  *1             E20774
     C                     PARM           @CM,1            *1       E14042
     C                     PARM 80        @QCALN 155       *1       E14042
     C                     OUT  @STATS                     *1       E14042
      *                                                    *1
      ** DUMP THE PROGRAM                                  *1
     C                     DUMP                            *1
     C                     MOVE 'E'       @TERM
     C                     END                             E1
      *
      ** TERMINATE THE PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      *   The array @YD and @MD are now being used by SR. ZDATE9      *   056095
      *   before they are being used by SR. ZA0710.  The actual       *   056095
      *   changes were only made on the text, ZA0710 was changed      *   056095
      *   to ZDATE9.                                                  *   056095
      *****************************************************************   056095
** CPY@   **      OBJECT COPYRIGHT
(c) Finastra International Limited 2001
** @M - Month names.
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
**       @CM      Messages when error                               E14042
SNDMSG  ('MM0173 has ended abnormally in batch.') TOMSGQ(MOPERQ)
