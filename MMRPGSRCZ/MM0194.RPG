     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas MM Start of day rebuild - liquidity exposure')   *
     F*****************************************************************
     F*                                                               *
     F*  Midas - MM Dealer Module                                     *
     F*                                                               *
     F*  MM0194 - UPDATE LIQUIDITY EXPOSURES FILE                     *
     F*                                                               *
     F*  Function:   This program rebuilds the MM liquidity exposure  *
     F*  (I/C INIT)  file (MMFLIQPP) during I/C initiation.           *
     F*    Based on MM0094 - processes deals & deams sequentially     *
     F*    to perform update rather than one call of programme per    *
     F*    deal/deam.                                                 *
     F*                                                               *
     F*  Called by: MM0101  - Start of day reorganisation.            *
     F*        via: MM0112  - File setup control.                     *
     F*                                                               *
     F*  Calls    : ZA0270  - Convert date to Midas day number.       *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. MD047993           Date 23Sep17               *
      *                 MD035545           Date 11Sep15               *
      *                 CGL165             Date 17Feb15               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 CDL093             Date 08Apr14               *
      *                 AR996895           Date 25Nov12               *
      *                 263666             Date 01Feb10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016A            Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246141             Date 26Mar07               *
      *                 164847             Date 30Nov06               *
      *                 BUG12990           Date 05Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 11Jul06               *
      *                 CDL038             Date 10May05               *
      *                 CSD027             Date 09Dec05               *
      *                 CIR013             Date 25Apr05               *
      *                 CDL033             Date 10Feb05               *
      *                 CDL022             Date 03Feb04               *
      *                 CDL020             Date 03Feb04               *
      *                 CDL019             Date 03Feb04               *
      *                 CDL018             Date 03Feb04               *
      *                 CDL017             Date 03Feb04               *
      *                 CDL016             Date 03Feb04               *
      *                 222727             Date 05Nov03               *
      *                 CAS006             Date 21Jan03               *
      *                 CAS005             Date 16Dec02               *
      *                 CDL010             Date 02Aug02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CIR004             Date 20Jan00               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 CDL006             Date 26Apr99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 163136             Date 07Jul99               *
      *                 126017             Date 18Nov97               *
     F*                 097885             Date 03Feb97               *
     F*                 095244             Date 01Nov95               *
     F*                 095238             DATE 31OCT95               *
     F*                 061426             DATE 30SEP93               *
     F*                 056121             DATE 04NOV93               *
     F*                 056095             DATE 07JUN93               *
     F*                 S01378             DATE 23APR92               *
     F*                 S01392             DATE 04SEP92               *
     F*                 E36300             DATE 24FEB92               *
     F*                 E28445             DATE 11SEP91               *
     F*                 S01319             DATE 19AUG91               *
     F*                 E20774             DATE 15MAR90               *
     F*                 LN0457             DATE 29JUN90               *
     F*                 S01194             DATE 15JAN90               *
     F*                 S01195             DATE 15JAN90               *
     F*                 S01218             DATE 11/08/89              *
     F*                 E14042             DATE 20/07/88              *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  MD047993 - Modified MD035545. Removed dependency on Accrue   *
      *             on Last Day indicator.                            *
      *  MD035545 - LE: Interest Calculation in Leap year. Consider   *
      *             Accrue on Last Day Indicator for method 6.        *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  CDL093 - MM Interest calculation type 9.                     *
      *  AR996895 - Incorrect accrual interest calculation            *
      *             (Child:AR996897) (Recompile)                      *
      *  263666 - Recompiled due to changes in ZINTDYZ2               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016A - German Interest Calculation: Upgarde of FGE059     *
      *           to Midas Plus                                       *
      *  246141 - Recompiled due to changes in ZINTDYZ2               *
      *  164847 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  BUG12990 - Recompiled due to changes in ZINTDYZ2/ZINTDYZ2LE  *
      *  242286 - Recompile over changes in /COPY ZINTDYZ2.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CIR013 - Additional Calculation Method for FRA/IRS/CCF       *
      *           Recompile over ZINTDY.                              *
      *  CDL033 - Floating Rate CDs Issued.                           *
      *  CDL022 - Deal Amendment Changes (Recompile)                  *
      *  CDL020 - Apply Base Rate at Value Date (Recompile)           *
      *  CDL019 - Allow Base Rate Changes on Fixed Deposits/Loans     *
      *           (Recompile)                                         *
      *  CDL018 - Multiple Settlement Accounts on Loans/Deposits      *
      *           (Recompile)                                         *
      *  CDL017 - Penalty Fee & Early Maturity of Fixed Term Loan/Dep *
      *           (Recompile)                                         *
      *  CDL016 - Automatic rollover of Fixed Term Loans/Deposits     *
      *           (Recompile)                                         *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  CAS005 - Enhancements to CAS001, CAS002 and CAS004           *
      *           (Recompile)                                         *
     F*  CDL010 - Prevent last user that actioned the trade from      *
     F*           authorising it.Recompile due to changes in MMDEAMPP *
     F*           , MMDELDPP, MMDENBPP AND MMDENSPP .                 *
      *  CIR004 - Dealing Calculation Method Change                   *
      *  CDL006 - Fiduciary Dealing.                                  *
     F*  163136 - Interest Calculation Method '6'  showing incorrect -*
     F*           ZERO - amount . Addition to Core #126017 which dealt*
     F*           with the issue. It introduced an additional  INT6DY *
     F*           field in s-routine ZINTDY in  /COPY ZSRSRC/ZINTDYZ2 *
     F*           which in turn is usually called from GLINTC s-routine
     F*           in /COPY  ZSRSRC/ GLINTCZ1 .  However, there are at *
     F*           least a dozen other pgms that use ZINTDY but do     *
     F*           GLINTC-processing within the pgms calculation specs *
     F*  126017 - Correction to interest calculation for calculation  *
     F*           basis 6 in SR/GLINTC - recompile program.           *
     F*  097885 - Recompiled for wrong calculation of number of day   *
     F*           interest (ZINTDYZ2).                                *
     F*  095244 - Recompiled for Calculation method 3                 *
     F*  095238 - Recompiled for Calculation method 3                 *
     F*  061426 - Recompile after ZDATE9 correction                   *
     F*  056121 - Increase size of work field to enable correct       *
     F*           calculation of interest on very large amounts.      *
     F*           (Similar to fix 049499 of MM0089 in MRSLIB1005)     *
     F*  056095 - Interest not calculated consistently in MM.         *
     F*           SR. MM1009 was externally defined as ZINTDY,        *
     F*           while SR. ZA0710 and ZA0680 were replaced by        *
     F*           the externally defined standard SR. ZDATE9 and      *
     F*           ZDAT10, respectively.  Seventeen MM programs        *
     F*           were amended.                                       *
     F*  S01378 - Facilitates the partial sale of a parcel            *
     F*           of negotiable instruments which have been           *
     F*           previously input to the system as a single          *
     F*           transaction (was MOF53). Recompile over new         *
     F*           NA bought and NA sold formats.                      *
     F*  S01392 - JAP.SUB-MODULE INCORPORATION (CORE)                 *
     F*           a) Front-Up Interest - interest added/deducted      *
     F*              at value date rather than maturity.              *
     F*           b) Interest rounded down (Replace MM1007 with       *
     F*              customised version of MM1030).                   *
     F*           c) First & Last day interest - int due for every    *
     F*              day that deal is live.                           *
     F*  E36300 - Maturity for notice deals calced as run date        *
     F*           plus working days instead of actual days.           *
     F*  E28445 - ARRAYES @CM AND CPY@ ARE WRONG WAY ROUND            *
     F*  S01319 - Remove references to FDINSTLL                       *
     F*  E20774 - Replace QCAEXEC with QCMDEXC                        *   E20774
     F*  LN0457 - RUN DATE NOT SET UP                                 *
     F*  S01194 - AMENDMENT TO USE ACCESS OBJECTS                     *
     F*  S01195 - NEW HOLIDAY PROCESSING                              *
     F*  S01218 - Recompiled to include new file layouts for          *
     F*           capital markets dealing interface                   *
     F*  E14042 - MULTISTREAMING START OF DAY PERFORMANCE MODIFICATION*
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F* ID F  C  H  L    FUNCTION OF INDICATORS                       *
     F*       01         MMDELDP0 current record                      *
     F*       02         MMDELSP0 current record                      *
     F*       03         MMDELBP0 current record                      *
     F*       04         MMDEAMP0 of LF/MMSDLALL current record       *
     F*       05         MMDEAMP0 of LF/MMSDLSLL current record       *
     F********60*********Chain*to*FDINSTLL*failed*if*on****************   S01319
     F*       61         No processing of last update fields required *
     F*                  if on                                        *
     F*       62         No processing of before fields required if on*
     F*       63         No record for currency on liquidities file   *
     F*       65         Interest calculation has been performed      *
     F*       66         Calculation of maturity date needed          *
     F*                  Value date + notice days                     *
     F********80*********Chain*to*installation*file*failed*************   S01194
     F*       U6         Program exception/error condition has        *
     F*                  occurred                                     *
     F*       U7         Set on with U8 to signify file handling error*
     F*       U8         Set on with U7 to signify file handling error*
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F*FDINSTLLIF**E*******************DISK***************************UC**S01319
     F*FDICDRLLIF**E**********K        DISK         KINFSR INFSR      UC  S01194
     F************TABTB20F                          KIGNORE               S01194
     F*FDTABJLLIF  E          K        DISK         KINFSR INFSR      UC  S01194
     F*FDCCYTLLIF**E**********K        DISK         KINFSR INFSR      UC  S01194
     FMMFLQULLO   E           K        DISK         KINFSR INFSR
     FMMDEALLLIF  E           K        DISK         KINFSR INFSR
     F            MMDENBP0                          KIGNORE
     F            MMDENSP0                          KIGNORE
     F            MMDELDP0                          KRENAMEMMDELDF
     FMMSDFVLLIP  E           K        DISK         KINFSR INFSR
     F            MMDEAMP0                          KIGNORE
     FMMSDLALLIS  E           K        DISK         KINFSR INFSR
     F            MMDEAMP0                          KRENAMEMMDEAMA
     FMMSDLSLLIS  E           K        DISK         KINFSR INFSR
     F            MMDEAMP0                          KRENAMEMMDEAMS
     F/COPY WNCPYSRC,MM0194F001
     E*
     E****USED*BY*SR.*ZA0830 - CURRENCY RECORDS                           S01195
     E********************@CY        50  3                                S01195
     E*
     E****ARRAY*FOR*SR.*ZA0710*-*CUMULATIVE*DAYS*IN*YEAR*FOR*4*YEAR*PERIOD056095
     E***********         @YD     4   4  5 0A                             056095
     E*
     E****ARRAY*FOR*SR.*ZA0710*-*CUMULATIVE*DAYS*IN*YEAR*PER*MONTH*****   056095
     E***********         @MD    13  13  5 0A                             056095
     E*                                                                   056095
     E/COPY ZSRSRC,ZDATE9Z1                                               056095
     E**  Array for SR. ZDATE9                                            056095
     E*
     E**  ARRAY OF PERIOD DATES CALCULATED
     E                    @PR        10  5 0
     E*
     E**  ARRAY OF LIQUIDITY VALUES FROM FILE
     E                    @L1        10 15 0
     E                    @L2         9 15 0
     E                    @L3        10 15 0
     E***********         CPY@    1   1 80                          S01194E28445
      *                                                           E14042
      **  Command for sending error messages, etc.                E14042
     E                    @CM     1   1 80                        E14042
     E                    CPY@    1   1 80                                E28445
     E/COPY ZSRSRC,ZHOLE                                                  S01195
     E*                                                                   S01195
     E/EJECT
     I*
     I** Level break and current record indicators and matching record
     I** definitions.
     IMMDELDP0    01
     I                                              HKCCY L1M1
     IMMDENSP0    02
     I                                              HMCCY L1M1
     IMMDENBP0    03
     I                                              HLCCY L1M1
     IMMDEAMA     04
     I                                              HNCCY L1M1
     IMMDEAMS     05
     I                                              HNCCY L1M1
     I*
     I/COPY WNCPYSRC,MM0194I001
     ISDBANK    E DSSDBANKPD                                              S01194
     I* DATA STRUCTURE FOR BANK DETAILS                                   S01194
     I*                                                                   S01194
     ISCSARD    E DSSCSARDPD                                              CDL006
      **  Data structure for Switchable Features file                     CDL006
      *                                                                   CDL006
     ISDCURR    E DSSDCURRPD                                              S01194
     I* DATA STRUCTURE FOR CURRENCY DETAILS                               S01194
     I*                                                                   S01194
     I***SDGELR*   E DSSDGELRPD                                                    MD035545 MD047993
     I**GENERAL*LEDGER*DETAILS*ACCESSED*VIA*ACCESS*PROGRAM*************            MD035545 MD047993
     IDSFDY     E DSDSFDY                                                 S01194
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01194
     I*                                                                   S01117
     IDSSDY     E DSDSSDY                                                 S01194
     I* SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE                S01194
     I****DATA*STRUCTURE*FOR*SR.*ZA0710*-*FIELD*IS*@@Z71Y**************   056095
     I*********** DS                                                      056095
     I***********                             1   40@@Z71Y                056095
     I***********                             1   10@@SSY1                056095
     I***********                             2   20@@SSY2                056095
     I***********                             3   30@@SSY3                056095
     I***********                             4   40@@SSY4                056095
     I****DATA*STRUCTURE*FOR*SR.*ZA0710*-*FIELD*IS*@@VDT***************   056095
     I*********** DS                                                      056095
     I***********                             1   80@@VDT                 056095
     I***********                             1   40@@YR                  056095
     I***********                             5   60@@Z71M                056095
     I***********                             7   80@@Z71D                056095
     I*                                                                   056095
     I/COPY ZSRSRC,ZDATE9Z2                                               056095
     I**  Data structure for SR. ZDATE9                                   056095
     I*
     I            DS
     I*
     I************DS                                                      S01195
     I************                                                        S01195
     I****USED*BY*SR. ZA0830 - ARRAY DATA STRUCTURE                       S01195
     I****DATA*STRUCTURE*FOR SR. ZA0680 - DATE INPUT TO SUBROUTINE        S01195
     I*********************                   1 150 @CY                   S01195
     I*********************                   1  75 @@CY1                 S01195
     I*********************                  76 150 @@CY2                 S01195
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     I*
     I*
     I            DS
     I                                        1   80@@DTIN
     I***********                             1   40@@YYYY                056095
     I***********                             3   40@@YY                  056095
     I                                        3   40@@YYY
     I                                        5   60@@MM
     I***********                             1   20@@CC                  056095
     I***********                             5   60@@MTH                 056095
     I***********                             7   80@@DAY                 056095
     I                                        7   80@@DD
     I*                                                                   056095
     I/COPY ZSRSRC,ZDAT10Z1                                               056095
     I**  Data structure for SR. ZDAT10                                   056095
     I*                                                                   056095
     I**  DATASTRUCTURE FOR DATE IN TO CHANGE FORMAT
     I*
     I            DS                              6
     I                                        1   60@@DTOU
     I                                        1   20@@DAT1
     I                                        3   40@@DAT2
     I                                        5   60@@YYYO
     I**  DATASTRUCTURE TO CHANGE FORMAT TO MMDDYY / DDMMYY
     I*
     I*
     I**  DATA STRUCTURE HOLDING STARTING POINT DATE
     I            DS
     I                                        1   80@@STRT
     I                                        1   40@@STYR
     I                                        5   60@@STMT
     I                                        7   80@@STDY
     I*
     I**  DATA STRUCTURE HOLDING SPOT DATE
     I            DS
     I                                        1   80@@SPDD
     I                                        1   40@@SPYR
     I                                        5   60@@SPMT
     I                                        7   80@@SPDY
     I*
     I**  DATA STRUCTURE DAYS FOR DATE FORMAT DDMMYY
     I            DS
     I                                        1   60@@DATE
     I                                        1   20@@DAY2
     I****DATA*STRUCTURE*FOR*SR.*M1009*-*DATE*FIELD*YYYYMMDD***********   056095
     I*********** DS                                                      056095
     I***********                             1   80@@DATA                056095
     I***********                             1   40@@YY1                 056095
     I***********                             5   60@@MM1                 056095
     I***********                             7   80@@DD1                 056095
     I****DATA*STRUCTURE*FOR*SR.*M1009*-*DATE*FIELD*YYYYMMDD***********   056095
     I*********** DS                                                      056095
     I***********                             1   80@@DATB                056095
     I***********                             1   40@@YY2                 056095
     I***********                             5   60@@MM2                 056095
     I***********                             7   80@@DD2                 056095
     I*                                                                   056095
     I/COPY ZSRSRC,ZINTDYZ1                                               056095
     I**  Data Structure for SR. ZINTDY                                   056095
     I*
     I***Key*to*access*currencies file FDCCYTLL                           S01194
     I************DS                                                      S01194
     I****************************************1  12 @KEY                  S01194
     I****************************************9  11 @CUR                  S01194
     I*
     I** Split input run date.
     I            DS
     I                                        1   7 RUNA
     I                                        1   20@DLUP
     I                                        3   5 @MLUP
     I                                        6   70@YLUP
     I*
     I** Combine input maturity date fields
     I            DS
     I                                        1   80@MATD
     I                                        1   40I@MDYY
     I                                        5   60I@MDMM
     I                                        7   80I@MDDD
     I*
     I** Combine input value date fields
     I            DS
     I                                        1   80@START
     I                                        1   40I@VDYY
     I                                        5   60I@VDMM
     I                                        7   80I@VDDD
     I*
     I** Combine input interest date fields
     I            DS
     I                                        1   80@SLINT
     I                                        1   40I@SLYY
     I                                        5   60I@SLMM
     I                                        7   80I@SLDD
     I*
     I** Combine next  interest date fields
     I            DS
     I                                        1   80@NXINT
     I                                        1   40I@NIYY
     I                                        5   60I@NIMM
     I                                        7   80I@NIDD
     I*
     I** Combine related deal value date fields
     I            DS
     I                                        1   80@RDVDT
     I                                        1   40HKVDYY
     I                                        5   60HKVDMM
     I                                        7   80HKVDDD
     I*
     I** Combine input deal done date fields
     I            DS
     I                                        1   80@DEALD
     I                                        1   40I@DDYY
     I                                        5   60I@DDMM
     I                                        7   80I@DDDD
     I*
     IPSDS       SDS
     I/COPY WNCPYSRC,MM0194I002
     I*
     I**  Program status data structure.
     I**  Field containing program in use.
     I                                      201 208 @FILE
     I**  Field containing workstation  ID.
     I                                      244 253 @JOB
     I**  Field containing user ID.
     I                                      254 263 @USER
     I*
     I********** UDS                                                                          CDL033
     ILDA         DS                            256                                           CDL033
     I**  Local data area for data base errors.
     I**  Field containing name of database file in error.
     I                                      134 141 DBFILE
     I**  Field containing key value causing database error.
     I                                      142 170 DBKEY
     I**  Field containing name of program causing database error.
     I                                      171 180 DBPGM
     I**  Field containing number of database error.
     I                                      181 183 DBASE
      *                                                                   E14042
      **  DATA STRUCTURE FOR SDSTAT                                       E14042
     I@STATS      DS                            256                       E14042
     I                                      102 102 @SUBMN                E14042
     I                                      103 103 @STRM2                E14042
     I              'LECalcBasis6LeapYear'C         WPARML                                  MD035545
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* MAIN     - Controls processing                                *
     C*                                                               *
     C* CALLS    #A       - Initial processing                        *
     C*          #B       - Main processing                           *
     C*          #C       - Final processing                          *
     C*          #D       - Level break processing                    *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C*
     C/COPY WNCPYSRC,MM0194C012
     C           @TERM     IFNE 'T'                        B1
     C                     EXSR #A                         *1
     C                     END                             E1
     C*
     C           @TERM     IFNE 'T'                        B1
     C           @TERM     ANDNE'E'                        *1
     C           *INU7     ANDNE'1'                        *1
     C                     EXSR #B                         *1
     C                     END                             E1
     C*
     C******************** EXSR #C ********************************* E14042
     C*
     C**  Currency level break
     CL1                   EXSR #D
     C*
     CLR                   EXSR #C                                   E14042
     C*
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C* SUBROUTINES USED                                              *
     C*                                                               *
     C*  01  #BAA     - Load amount into period for input date        *
     C*  02  #B       - Main processing                               *
     C*  03  #BA      - Process deal by type                          *
     C*  04  #BB      - Load last update flds into common workflds    *
     C*  05  #D       - Update LF/MMFLQULL file                       *
     C***06**ZA0830***-*Find if a day is a holiday for a currency     *   S01195
     C***07**MM1007   - Calculate interest amount                     *   S01392
     C*  07  MM1030   - Calculate interest amount                     *   S01392
     C***08**MM1009***-*Calculate*the*number*of*interest*days**********   056095
     C*  08  ZINTDY   - Calculate the number of interest days         *   056095
     C***09**MM1005***-*Find*number*of*working*days*forward************   E36300
     C*  10  #C       - Final processing                              *
     C*  11  #A       - Initial processing                            *
     C*  12  ZA0730   - Determine next working day                    *
     C*  13  MM1003   - Calculate a period date                       *
     C*  14  ZA0770   - Convert an 8 0 date to 6 0 format             *
     C***15**ZA0680***-*Convert*YYYYMMDD*to*a*midas*day*number*********   056095
     C***16**ZA0710***-*Convert*midas*day*no.*to*YYYYMMDD*format*******   056095
     C*  15  ZDAT10   - Convert YYYYMMDD to a midas day number        *   056095
     C*  16  ZDATE9   - Convert midas day no. to YYYYMMDD format      *   056095
     C*  17  #BC      - Load period dates array                       *
     C*  18  ZA0150   - Access installation file                      *
     C*  19  INFSR    - Unmonitored file error                        *
     C*  20  *PSSR    - Unmonitored program error                     *
     C*                                                               *
     C* EXTERNAL ROUTINE                                              *
     C*                                                               *
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BAA     - Load amount into period for input date             *
     C*                                                               *
     C**CALLS****ZA0680***-*Convert*YYYYMMDD*to*a*midas*day*number*****   056095
     C***********MM1005***-*Find*number*of*working*days*forward********   E36300
     C* CALLS    ZDAT10   - Convert YYYYMMDD to a midas day number    *   056095
     C*                                                               *
     C* CALLED BY  #BA    - Process deal by type                      *
     C*                                                               *
     C* FLDS USED  @@INTR - Interest amount                           *
     C*            @AMT   - Amount                                    *
     C*************@@END**-*Maturity*date******************************   056095
     C*            ZZEND  - Maturity date                             *   056095
     C*            @DATEM - Date (midas day number)                   *
     C*            @DATE  - Date (YYYYMMDD)                           *
     C*************@@DTIN*-*Input*date*********************************   056095
     C*************@@MDNO*-*Midas*day*number*workfield*****************   056095
     C*            ZZDTIN - Input date                                *   056095
     C*            ZZMDNO - Midas day number workfield                *   056095
     C*            @NTCE  - Notice days                               *
     C*************@@MNO  - Midas day number workfield                *   S01195
     C*************ZDAYNO - Midas day number workfield                *   S01195
     C*            @CCY   - Currency                                  *
     C*            @@CCY  - Currency                                  *
     C*            @@FWD  - No. of working days forward               *
     C*            @@FDAT - Forward date                              *
     C*            @D     - Work field                                *
     C*            @PR    - Period dates array                        *
     C*            @ADSB  - Add or subtract indicator                 *
     C*            @COLUM - Column ind.(taken,placed or fixed)        *
     C*
     C*            @L1    - Taken liquidities array                   *
     C*            @L3    - Placed array                              *
     C*                                                               *
     C*****************************************************************
     C           #BAA      BEGSR
     C*
     C** Load interest amount & midas date if interest calculation
     C** has just been performed.
     C           *IN65     IFEQ '1'                        B1
     C                     Z-ADD@@INTR    @AMT             *1
     C*                                                                   S01392
     C** If Front-up Interest indicator on interest is added/deducted     S01392
     C** at value date.                                                   S01392
     C           @FUID     IFEQ 'Y'                        B*2            S01392
     C***********          Z-ADD@@BEG     @DATEM           **2      S01392056095
     C                     Z-ADDZZBEG     @DATEM           **2            056095
     C                     ELSE                            X*2            S01392
     C***********          Z-ADD@@END     @DATEM  50       **2            056095
     C                     Z-ADDZZEND     @DATEM  50       **2            056095
     C                     END                             E*2            S01392
     C*                                                                   S01392
     C                     MOVE '0'       *IN65            *1
     C                     ELSE                            X1
     C*
     C** Convert date to midas day number for comparison with period
     C** dates or exit if not entered.
     C           @DATE     CABEQ0         #BAA9            *1
     C*
     C***********          Z-ADD@DATE     @@DTIN           *1             056095
     C***********          EXSR ZA0680                     *1             056095
     C***********          Z-ADD@@MDNO    @DATEM           *1             056095
     C                     Z-ADD@DATE     ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @DATEM           *1             056095
     C                     END                             E1
     C*
     C** If this is an uncalled call/notice deal calculate date
     C** of period to be updated : this is DEAL DONE date + notice
     C** (working) days.
     C           *IN66     IFEQ '1'                        B1
     C*
     C** Determine'maturity date'if not present
     C** This is the earliest possible date on which funds can be
     C** called for call/notice deals.
     C***********RUND******IFGT @DATEM                     B*2            S01194
     C           BJRDNB    IFGT @DATEM                     B*2            S01194
     C*
     C*********************Z-ADDRUND      @DATEM           **2            S01194
     C                     Z-ADDBJRDNB    @DATEM           **2            S01194
     C                     END                             E*2
     C*
     C***Find*number*of*working*days*forward*represented*by*notice*days   E36300
     C** Find earliest maturity date for notice deals                     E36300
     C           @NTCE     IFNE 0                          B*2
     C                     ADD  @NTCE     @DATEM                          E36300
     C*********************Z-ADD@DATEM    @@MNO            **2            S01195
     C*********************MOVE @CCY      @@CCY            **2            S01195
     C************         Z-ADD@DATEM    ZDAYNO           **2     S01195 E36300
     C************         MOVE @CCY      ZCCY             **2     S01195 E36300
     C************         Z-ADD@NTCE     @@FWD   50       **2            E36300
     C************         EXSR MM1005                     **2            E36300
     C************         Z-ADD@@FDAT    @DATEM           **2            E36300
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If  date input is before todays date it will not affect
     C**  liquidities movements
     C***********@DATEM****CABLTRUND      #BAA9                           S01194
     C           @DATEM    CABLTBJRDNB    #BAA9                           S01194
     C*
     C**  If value date is after today then this will not affect          FA0338
     C**  liquidities movements for taken and placed columns.             FA0338
     C***********@@MDNO****IFGT RUND                       B1       FA0338S01194
     C***********@@MDNO    IFGT BJRDNB                     B1 FA0338S01194056095
     C           ZZMDNO    IFGT BJRDNB                     B1             056095
     C           @COLUM    ANDNE'F'                        B1             FA0338
     C***********@@MDNO****ORGT RUND                       B1       FA0338S01194
     C***********@@MDNO    ORGT BJRDNB                     B1 FA0338S01194056095
     C           ZZMDNO    ORGT BJRDNB                     B1             056095
     C           @COLUM    ANDNE'F'                        B1             FA0338
     C                     GOTO #BAA9                      *1             FA0338
     C                     END                             E1             FA0338
     C*
     C** Determine period into which date falls
     C*
     C** Find dates position in array this corresponds to the
     C** field on the liquidities array which requires updating.
     C                     Z-ADD1         @D      20
     C           @PR,@D    DOWLT@DATEM                     B1
     C           @D        ANDLT10                         *1
     C                     ADD  1         @D               *1
     C                     END                             E1
     C*
     C** Appropriate field in liquidities totals array is updated
     C** Decide which liquidities totals array to update.
     C**********
     C** FIXED *
     C**********
     C           @COLUM    IFEQ 'F'                        B1
     C*
     C** If > 3 months then do not adjust file for fixed deals
     C           @D        IFLT 10                         B*2
     C*
     C           @ADSB     IFEQ '+'                        B**3
     C           @L2,@D    ADD  @AMT      @L2,@D           ***3
     C                     ELSE                            X**3
     C** Subtract
     C           @L2,@D    SUB  @AMT      @L2,@D           ***3
     C                     END                             E**3
     C*
     C                     END                             E*2
     C                     END                             E1
     C*
     C**********
     C** TAKEN *
     C**********
     C           @COLUM    IFEQ 'T'                        B1
     C*
     C           @ADSB     IFEQ '+'                        B*2
     C           @L1,@D    ADD  @AMT      @L1,@D           **2
     C                     ELSE                            X*2
     C** Subtract
     C           @L1,@D    SUB  @AMT      @L1,@D           **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C***********
     C** PLACED *
     C***********
     C           @COLUM    IFEQ 'P'                        B1
     C*
     C           @ADSB     IFEQ '+'                        B*2
     C           @L3,@D    ADD  @AMT      @L3,@D           **2
     C                     ELSE                            X*2
     C** Subtract
     C           @L3,@D    SUB  @AMT      @L3,@D           **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C           #BAA9     ENDSR                           **#BAA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #B       - Main processing                                    *
     C*                                                               *
     C* CALLS    #BB      - Load last update flds into common workflds*
     C*          #BC      - Load period dates array                   *
     C*          #BA      - Process deal by type                      *
     C*                                                               *
     C* CALLED BY  MAIN   - Controls program                          *
     C*                                                               *
     C* FLDS USED  @THDL  - Deal format passed to program             *
     C*            @LACT  - Last action                               *
     C*            @CCY   - Currency                                  *
     C*            @L1    - Taken liquidities array                   *
     C*            @L2    - Fixed term liquidities array              *
     C*            @L3    - Placed array                              *
     C*            @PR    - Period dates array                        *
     C*            @DLUP  - Day of last update                        *
     C*            @MLUP  - Month of last update                      *
     C*            @YLUP  - Year of last update                       *
     C*            @USER  - User i.d.                                 *
     C*            @LDA   - Last SI deam associated deal number       *
     C*                                                               *
     C*****************************************************************
     C           #B        BEGSR
     C*
     C** Ensure only first SI deam is processed for a deal
     C*          *IN05     IFEQ '1'
     C*          HNDA38    IFEQ @LDN
     C*                    GOTO #B9
     C*                    ELSE
     C*                    MOVE HNDA38    @LDN
     C*                    END
     C*                    END
     C*
     C** Determine record format passed to program & load fields
     C** used so that they can be treated as common.
     C                     EXSR #BB
     C*
     C***************************************
     C* VALIDATE DEAL TYPE IS OK FOR UPDATE *
     C***************************************
     C*
     C** Rate change amendments do not update liquidity exposure
     C*
     C           @THDL     IFEQ 'A'                        B1
     C           HNTYPE    ANDEQ'RC'                       B1
     C                     GOTO #B9                        *1
     C                     END                             E1
     C*
     C*************************
     C* Update liquidity file *
     C*************************
     C*
     C** If period dates for this currency have not yet been calculated
     C** today then calculate them & load into the liquidities file.
     C           HQDLUP    IFNE @DLUP                      B1
     C           HQMLUP    ORNE @MLUP                      *1
     C           HQYLUP    ORNE @YLUP                      *1
     C                     EXSR #BC                        *1
     C           *INU7     IFEQ '1'                        B*2
     C                     GOTO #B9                        **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C** Process deals by type.
     C                     EXSR #BA
     C*
     C           #B9       ENDSR                           **#B9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BA      - Process deal by type                               *
     C*                                                               *
     C* CALLS    #BAA     - Load amount into period for input date    *
     C*******    MM1007   - Calculate interest amount                 *   S01392
     C*          MM1030   - Calculate interest amount                 *   S01392
     C*                                                               *
     C* CALLED BY  #B     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @THDL  - Deal format passed to program             *
     C*            @TYPE  - Midas deal type                           *
     C*            @MATD  - Maturity date                             *
     C*            @COLUM - Column ind.(taken,placed or fixed)        *
     C*            @ADSB  - Add or subtract indicator                 *
     C*            @START - Value date                                *
     C*            @DATE  - Date (YYYYMMDD)                           *
     C*************@@BEG**-*Last*interest*date*or*maturity*if*sooner***   056095
     C*************@@END**-*Maturity*date******************************   056095
     C*            ZZBEG  - Last interest date or maturity if sooner  *   056095
     C*            ZZEND  - Maturity date                             *   056095
     C*            @DNWD  - Date of next working day                  *
     C*            @AMT   - Amount                                    *
     C*            @FUID  - Work field for Front-up interest indicator*   S01392
     C*            @FLID  - Work field for First/Last day interest    *   S01392
     C*            @RDFC  - Work field for Round down interest        *   S01392
     C*            @@RDFC - Work field used by MM1030 for RDI         *   S01392
     C*            @ENDSV - Work field used to save value of MDATE    *   S01392
     C*                                                               *
     C*****************************************************************
     C           #BA       BEGSR
     C*
     C/COPY WNCPYSRC,MM0194C004
     C** Process deals by type.
     C*
     C** Set off interest amount indicator
     C                     MOVE '0'       *IN65
     C** Set off uncalled call/notice indicator
     C                     MOVE '0'       *IN66
     C*******************************
     C** 1. LOAN/DEPOSIT CD ISSUED. *
     C*******************************
     C           @THDL     IFEQ 'L'                        B1
     C****************************************************
     C**  I/BANK TAKING;TIME DEPOSIT;C/N DEPOSIT(called) *
     C****************************************************
     C           @TYPE     IFEQ 'IT'                       B*2
     C           @TYPE     OREQ 'TD'                       **2
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'FT'                                      CDL006
     C*
     C           @TYPE     OREQ 'CD'                       **2
     C/COPY WNCPYSRC,MM0194C009
     C           @MATD     ANDNE0                          **2
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DT'                                      CDL006
     C           @MATD     ANDNE0                                         CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LT'                                      CDL006
     C           @MATD     ANDNE0                                         CDL006
     C*
     C**************************************************
     C***I/BANK*PLACING;TIME LOAN;CD ISSUED;           *                  CDL006
      ** I/bank placing; time loan;CD,DT,LT issued;                       CDL006
     C** C/N DEPOSIT TAKEN(called);DEMAND LOAN(called) *
     C**************************************************
     C           @TYPE     OREQ 'IP'                       B*2
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'FL'                                      CDL006
     C           @TYPE     OREQ 'TI'                       **2
     C           @TYPE     OREQ 'CI'                       **2
     C/COPY WNCPYSRC,MM0194C010
     C*
     C           @TYPE     OREQ 'CF'                                                          CDL033
     C           CDL033    ANDEQ'Y'                                                           CDL033
     C           @TYPE     OREQ 'CL'                       **2
     C           @MATD     ANDNE0                          **2
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DP'                                      CDL006
     C           @MATD     ANDNE0                                         CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LP'                                      CDL006
     C           @MATD     ANDNE0                                         CDL006
     C*
     C           @TYPE     OREQ 'DL'                       **2
     C           @MATD     ANDNE0                          **2
     C*
     C**  Add principle amount at value date subtract principle at
     C**  maturity & interest at next interest date from fixed column.
     C                     MOVE 'F'       @COLUM  1        **2
     C                     MOVE '+'       @ADSB   1        **2
     C                     Z-ADD@START    @DATE   80       **2
     C*
     C**  Process principle
     C                     EXSR #BAA                       **2
     C*
     C                     MOVE '-'       @ADSB            **2
     C                     Z-ADD@MATD     @DATE            **2
     C                     EXSR #BAA                       **2
     C*
     C**  Process interest IF date details entered
     C***********@@BEG     IFNE 0                          B**3           056095
     C***********@@END     ANDNE0                          ***3           056095
     C           ZZBEG     IFNE 0                          B**3           056095
     C           ZZEND     ANDNE0                          ***3           056095
     C                     MOVE '-'       @ADSB            **2
     C                     MOVE @RDFC     @@RDFC  1        ***3           S01392
     C**                                                                  S01392
     C** If First & Last Day Interest indicator on add an extra           S01392
     C** day's interest. (First save maturity date as it is used          S01392
     C** elsewhere)                                                       S01392
     C*                                                                   S01392
     C***********          Z-ADD@@END     @ENDSV  50       ***3     S01392056095
     C                     Z-ADDZZEND     @ENDSV  50       ***3           056095
     C           @FLID     IFEQ 'Y'                        B***4          S01392
     C***********          ADD  1         @@END            ****4    S01392056095
     C                     ADD  1         ZZEND            ****4          056095
     C                     END                             E***4          S01392
     C*                                                                   S01392
     C******               EXSR MM1007                     ***3           S01392
     C/COPY WNCPYSRC,MM0194C005
     C                     EXSR MM1030                     ***3           S01392
     C/COPY WNCPYSRC,MM0194C006
     C                     MOVE '1'       *IN65            ***3
     C***********          Z-ADD@ENDSV    @@END            ***3     S01392056095
     C                     Z-ADD@ENDSV    ZZEND            ***3           056095
     C*                                                                   S01392
     C                     EXSR #BAA                       ***3
     C                     END                             E**3
     C                     END                             E*2
     C*
     C*********************************
     C** C/N DEPOSIT PLACED(uncalled) *
     C*********************************
     C******************************************************
     C** C/N DEPOSIT TAKEN(uncalled);DEMAND LOAN(uncalled) *
     C******************************************************
     C           @TYPE     IFEQ 'CD'                       B*2
     C           @MATD     ANDEQ0                          **2
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DT'                                      CDL006
     C           @MATD     ANDEQ0                                         CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LT'                                      CDL006
     C           @MATD     ANDEQ0                                         CDL006
     C*
     C           @TYPE     OREQ 'CL'                       **2
     C           @MATD     ANDEQ0                          **2
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DP'                                      CDL006
     C           @MATD     ANDEQ0                                         CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LP'                                      CDL006
     C           @MATD     ANDEQ0                                         CDL006
     C*
     C           @TYPE     OREQ 'DL'                       **2
     C           @MATD     ANDEQ0                          **2
     C*
     C**  Add principle to takings column
     C**  at calculated maturity of Deal
     C****for*CD*or placing column for CL or DL                           CDL006
      ** for CD,DT,LT or placing column for CL,DP,LP or DL                CDL006
     C**  & to fixed column at value date.
     C*
     C****************************************************************
     C**  CALCULATED MATURITY DATE OF DEAL :-  The date on which deal*
     C**  is made (deal done date) or run date if this is greater    *
     C**  + number of working days forward represented by the        *
     C**  notice days.                                               *
     C****************************************************************
     C*
     C           @TYPE     IFEQ 'CD'                       B**3
     C           @MATD     ANDEQ0                          ***3
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DT'                                      CDL006
     C           @MATD     ANDEQ0                                         CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LT'                                      CDL006
     C           @MATD     ANDEQ0                                         CDL006
     C*
     C                     MOVE 'T'       @COLUM           ***3
     C                     ELSE                            X**3
     C                     MOVE 'P'       @COLUM           ***3
     C                     END                             E**3
     C*
     C                     MOVE '1'       *IN66            **2
     C*
     C                     MOVE '+'       @ADSB            **2
     C                     Z-ADD@START    @DATE            **2
     C*
     C**  Process principle
     C                     EXSR #BAA                       **2
     C*
     C                     MOVE '0'       *IN66
     C                     MOVE 'F'       @COLUM           **2
     C                     MOVE '+'       @ADSB            **2
     C                     Z-ADD@START    @DATE            **2
     C*
     C**  Process principle
     C                     EXSR #BAA                       **2
     C*
     C                     END                             E*2
     C                     END                             E1
     C*
     C************************
     C** 2. DEAL AMENDMENTS. *
     C************************
     C           @THDL     IFEQ 'A'                        B1
     C********************
     C** SETTLE INTEREST *
     C********************
     C           @TYPE     IFEQ 'SI'                       B*2
     C*
     C** Interest settled on value date of 'SI' sign dependent
     C** on type of deal on which deam is made.
     C*
     C                     MOVE '+'       @ADSB            **2
     C                     Z-ADD@START    @DATE            **2
     C*
     C                     MOVE 'F'       @COLUM           **2
     C                     EXSR #BAA                       **2
     C                     END                             E*2
     C*
     C************************
     C** CAPITALISE INTEREST *
     C************************
     C           @TYPE     IFEQ 'CI'                       B*2
     C/COPY WNCPYSRC,MM0194C011
     C*
     C           @TYPE     OREQ 'CF'                                                          CDL033
     C           CDL033    ANDEQ'Y'                                                           CDL033
     C** Interest added at calculated maturity of deal,column dependent
     C** on type of deal on which deam is made.
     C                     MOVE '1'       *IN66
     C           HNOMDT    IFEQ 'CL'                       B**3
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DP'                                      CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LP'                                      CDL006
     C           HNOMDT    OREQ 'DL'                       ***3
     C*
     C                     MOVE 'P'       @COLUM           ***3
     C                     ELSE                            X**3
     C                     MOVE 'T'       @COLUM           ***3
     C                     END                             E**3
     C*                                                                   FT0026
     C** Calculate interest amount.                                       FT0026
     C***********          Z-ADD@START    @@DTIN           *1       FT0026056095
     C***********          EXSR ZA0680                     *1       FT0026056095
     C***********          Z-ADD@@MDNO    @DMVDT  50       *1       FT0026056095
     C                     Z-ADD@START    ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @DMVDT  50       *1             056095
     C*                                                                   FT0026
     C***********@DMVDT****IFGE RUND                       B*2      FT0026S01194
     C           @DMVDT    IFGE BJRDNB                     B*2      FT0026S01194
     C           HNDA38    CHAINMMDEALLL             60    **2            FT0026
     C           *IN60     IFEQ '1'                        B**3           FT0026
     C                     MOVE '1'       *INU7            ***3           FT0026
     C                     MOVE '1'       *INU8            ***************FT0026
     C                     MOVEL'MMDEALLL'DBFILE           * DBERROR 008 *FT0026
     C                     MOVELHNDA38    DBKEY            ***************FT0026
     C                     MOVE '008'     DBASE            ***3           FT0026
     C                     MOVE '1'       *INLR            ***3           FT0026
     C                     GOTO #BA9                       ***3           FT0026
     C                     END                             E**3           FT0026
     C***********          MOVE HKICMT    @@CALC           **2      FT0026056095
     C                     MOVE HKICMT    ZZCALC           **2            056095
     C                     Z-ADDHKINTR    @@RATE           **2            FT0026
     C                     Z-ADDHKAMNP    @@AMT            **2            FT0026
     C*                                                                   FT0026
     C***********          Z-ADD@RDVDT    @@DTIN           *1       FT0026056095
     C***********          EXSR ZA0680                     *1       FT0026056095
     C***********          Z-ADD@@MDNO    @DLVDT  50       *1       FT0026056095
     C                     Z-ADD@RDVDT    ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    @DLVDT  50       *1             056095
     C*                                                                   FT0026
     C***********          Z-ADD@DLVDT    @@BEG            **2      FT0026056095
     C***********          Z-ADD@DMVDT    @@END            **2      FT0026056095
     C                     Z-ADD@DLVDT    ZZBEG            **2            056095
     C                     Z-ADD@DMVDT    ZZEND            **2            056095
     C******               EXSR MM1007                     **2     FT0026 S01392
     C/COPY WNCPYSRC,MM0194C007
     C                     EXSR MM1030                     **2            S01392
     C/COPY WNCPYSRC,MM0194C008
     C                     Z-ADD@@INTR    @AMT             **2            FT0026
     C                     END                             E*2            FT0026
     C*
     C                     Z-ADD@RDVDT    @DATE            **2
     C                     MOVE '+'       @ADSB            **2
     C                     EXSR #BAA                       **2
     C                     END                             E*2
     C*
     C******************************************
     C** PRINCIPLE INCREASE/PRINCIPLE DECREASE *
     C******************************************
     C           @TYPE     IFEQ 'PI'                       B*2
     C           @TYPE     OREQ 'PD'                       **2
     C*
     C** Principle added/subtracted at calculated mat. date,column,sign
     C** dependent on type of deal on which deam is made.
     C                     MOVE '+'       @ADSB            ***3
     C           HNOMDT    IFEQ 'CD'                       B**3
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'DT'                                      CDL006
     C           CDL006    OREQ 'Y'                                       CDL006
     C           @TYPE     ANDEQ'LT'                                      CDL006
     C                     MOVE 'T'       @COLUM           ***3
     C                     ELSE                            X**3
     C*
     C** CL/DL Original deal
     C                     MOVE 'P'       @COLUM           ***3
     C                     END                             E**3
     C*
     C**  If uncalled place principle into taking/placing column at
     C**  at calculated maturity of RELATED deal
     C*
     C****************************************************************
     C**  CALCULATED MATURITY DATE OF DEAL :-  The date on which deal*
     C**  is made (deal done date) or run date if this is greater    *
     C**  + number of working days forward represented by the        *
     C**  notice days.                                               *
     C****************************************************************
     C*
     C           @MATD     IFEQ 0                          B**3
     C*
     C**  Load principle
     C                     MOVE '1'       *IN66            ***3
     C                     Z-ADD@DEALR    @DATE            ***3
     C                     EXSR #BAA                       ***3
     C                     END                             E**3
     C*
     C**  Place principle into fixed term column at deam value date
     C**  Load principle
     C*                    MOVE 'F'       @COLUM           **2
     C*                    MOVE '0'       *IN66            **2
     C*                    Z-ADD@START    @DATE            **2
     C*                    EXSR #BAA                       **2
     C                     END                             E*2
     C                     END                             E1
     C*
     C*********************************
     C** 3. NEGOTIABLE ASSETS BOUGHT  *
     C*********************************
     C           @THDL     IFEQ 'B'                        B1
     C*
     C                     MOVE 'F'       @COLUM           *1
     C**************************************
     C** PRIMARY CD;SECONDARY CD;BOND;BILL **************
     C** TREASURY BILL;BANK ACCEPTANCE TRADE ACCEPTANCE *
     C***************************************************
     C*
     C*  For types C1,C2,BP & BD
     C** Subtract purchase price at value date,add interest at first
     C** date due  & when the maturity date is the next working day
     C** add face value at maturity.
     C*
     C** For types TB,DA & TA Subtract purchase price at value date,
     C** & when the maturity date is the next working day
     C** add face value at maturity.
     C                     MOVE '+'       @ADSB            *1
     C                     Z-ADD@START    @DATE            *1
     C*
     C**  Process principle
     C                     EXSR #BAA                       *1
     C*
     C**  Face value only added when the next working day is also
     C**  the maturity date
     C           @MATD     IFEQ @DNWD                      B*2
     C                     MOVE '-'       @ADSB            **2
     C                     Z-ADD@MATD     @DATE            **2
     C                     Z-ADDHLFVAL    @AMT             **2
     C                     EXSR #BAA                       **2
     C                     END                             E*2
     C*
     C           @TYPE     IFEQ 'C1'                       B*2
     C           @TYPE     OREQ 'C2'                       **2
     C           @TYPE     OREQ 'BP'                       **2
     C           @TYPE     OREQ 'BD'                       **2
     C*
     C**  Process interest IF date details entered
     C***********@@BEG     IFNE 0                          B**3           056095
     C***********@@END     ANDNE0                          ***3           056095
     C           ZZBEG     IFNE 0                          B**3           056095
     C           ZZEND     ANDNE0                          ***3           056095
     C                     MOVE '-'       @ADSB            **2
     C******               EXSR MM1007                     ***3           S01392
     C                     EXSR MM1030                     ***3           S01392
     C                     MOVE '1'       *IN65            ***3
     C                     EXSR #BAA                       ***3
     C                     END                             E**3
     C                     END                             E*2
     C                     END                             E1
     C*
     C*
     C*******************************
     C** 4. NEGOTIABLE ASSETS SOLD  *
     C*******************************
     C           @THDL     IFEQ 'S'                        B1
     C*
     C                     MOVE 'F'       @COLUM           *1
     C**************************************
     C** PRIMARY CD;SECONDARY CD;BOND;BILL **************
     C** TREASURY BILL;BANK ACCEPTANCE TRADE ACCEPTANCE *
     C***************************************************
     C*
     C** Add sale price at value date.
     C                     MOVE '+'       @ADSB            *1
     C                     Z-ADD@START    @DATE            *1
     C*
     C**  Process principle
     C                     EXSR #BAA                       *1
     C                     END                             E1
     C*
     C           #BA9      ENDSR                           **#BA9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BB      - Load last update flds into common workflds         *
     C*                                                               *
     C**CALLS****ZA0680***-*Convert*YYYYMMDD*to*a*midas*day*number*****   056095
     C* CALLS    ZDAT10   - Convert YYYYMMDD to a midas day number    *   056095
     C*                                                               *
     C* CALLED BY  #B     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @THDL  - Deal format passed to program             *
     C*            @TYPE  - Midas deal type                           *
     C*            @LACT  - Last action                               *
     C*            @CCY   - Currency                                  *
     C*            @CUR   - Field in key to access currencies file    *
     C*            @AMT   - Amount                                    *
     C*            @NTCE  - Notice days                               *
     C*************@@CALC*-*Calculation*method*************************   056095
     C*            ZZCALC - Calculation method                        *   056095
     C*            @@AMT  - Amount                                    *
     C*            @@RATE - Interest rate                             *
     C*            @FVAL  - Face value                                *
     C*            @SLINT - Start/last interest date                  *
     C*************@@DTIN*-*Input*date*********************************   056095
     C*************@@MDNO*-*Midas*day*number*workfield*****************   056095
     C*************@@BEG**-*Last*interest*date*or*maturity*if*sooner***   056095
     C*            ZZDTIN - Input date                                *   056095
     C*            ZZMDNO - Midas day number workfield                *   056095
     C*            ZZBEG  - Last interest date or maturity if sooner  *   056095
     C*            @NXINT - Next interest date                        *
     C*            @MATD  - Maturity date                             *
     C*************@@END**-*Maturity*date******************************   056095
     C*            ZZEND  - Maturity date                             *   056095
     C*            @START - Value date                                *
     C*            @MNINT  - Next int.date (day no.)                  *
     C*            @MMATD  - Maturity date (day no.)                  *
     C*            @FUID  - Work field for Front-up interest indicator*   S01392
     C*            @FLID  - Work field for First/Last day interest    *   S01392
     C*            @RDFC  - Work field for Round down interest        *   S01392
     C*                                                               *
     C*****************************************************************
     C           #BB       BEGSR
     C*
     C** Set @THDL according to current record format type.
     C           *IN01     IFEQ '1'
     C                     MOVE 'L'       @THDL   1
     C                     END
     C*
     C           *IN02     IFEQ '1'
     C                     MOVE 'S'       @THDL
     C                     END
     C*
     C           *IN03     IFEQ '1'
     C                     MOVE 'B'       @THDL
     C                     END
     C*
     C           *IN04     IFEQ '1'
     C                     MOVE 'A'       @THDL
     C                     END
     C*
     C           *IN05     IFEQ '1'
     C                     MOVE 'A'       @THDL
     C                     END
     C*
     C** Initialise Japanese Sub-Module fields.                           S01392
     C                     MOVE *BLANK    @RDFC   1                       S01392
     C                     MOVE *BLANK    @FLID   1                       S01392
     C                     MOVE *BLANK    @FUID   1                       S01392
     C*                                                                   S01392
     C** DEAM.
     C           @THDL     IFEQ 'A'                        B1
     C                     MOVE HNMTYP    @TYPE   2        *1
     C                     MOVE HNLACT    @LACT   1        *1
     C                     MOVE HNCCY     @CCY    3        *1
     C           HNAMNP    IFLT *ZEROS                     B*2
     C                     Z-SUBHNAMNP    @AMT             **2
     C                     ELSE                            X*2
     C                     Z-ADDHNAMNP    @AMT   150       **2
     C                     END                             E*2
     C*
     C** Value & date
     C                     Z-ADDHNVDYY    I@VDYY           *1
     C                     Z-ADDHNVDMM    I@VDMM           *1
     C                     Z-ADDHNVDDD    I@VDDD           *1
     C*
     C                     Z-ADDHKNTCE    @NTCE   30       *1
     C                     END                             E1
     C*
     C           @THDL     IFEQ 'L'                        B1
     C                     MOVE HKMTYP    @TYPE            *1
     C                     MOVE HKCCY     @CCY             *1
     C                     MOVE HKLACT    @LACT            *1
     C                     Z-ADDHKAMNP    @AMT             *1
     C*
     C** Value & maturity date
     C** Start of deal : value date
     C                     Z-ADDHKVDYY    I@VDYY           *1
     C                     Z-ADDHKVDMM    I@VDMM           *1
     C                     Z-ADDHKVDDD    I@VDDD           *1
     C*
     C                     Z-ADDHKMDYY    I@MDYY           *1
     C                     Z-ADDHKMDMM    I@MDMM           *1
     C                     Z-ADDHKMDDD    I@MDDD           *1
     C*
     C***Load*fields*required*by*MM1007*for*calculation*of*interest.      S01392
     C** Load fields required by MM1030 for calculation of interest.      S01392
     C** Start/last interest date
     C                     Z-ADDHKSLYY    I@SLYY           *1
     C                     Z-ADDHKSLMM    I@SLMM           *1
     C                     Z-ADDHKSLDD    I@SLDD           *1
     C** Next interest date
     C                     Z-ADDHKNIYY    I@NIYY           *1
     C                     Z-ADDHKNIMM    I@NIMM           *1
     C                     Z-ADDHKNIDD    I@NIDD           *1
     C** Deal done date
     C                     Z-ADDHKDDYY    I@DDYY           *1
     C                     Z-ADDHKDDMM    I@DDMM           *1
     C                     Z-ADDHKDDDD    I@DDDD           *1
     C*
     C                     Z-ADDHKNTCE    @NTCE            *1
     C***********          MOVE HKICMT    @@CALC           *1             056095
     C                     MOVE HKICMT    ZZCALC           *1             056095
     C                     Z-ADD@AMT      @@AMT  150       *1
     C                     Z-ADDHKINTR    @@RATE 117       *1
     C** Japanese Sub-Module fields.                                      S01392
     C                     MOVE HKRDFC    @RDFC            *1             S01392
     C                     MOVE HKFLID    @FLID            *1             S01392
     C                     MOVE HKFUID    @FUID            *1             S01392
     C                     END                             E1
     C*
     C** Negotiable assets bought
     C*
     C** Type, currency, and amount
     C*
     C           @THDL     IFEQ 'B'                        B1
     C*
     C                     MOVE HLMTYP    @TYPE            *1
     C                     MOVE HLLACT    @LACT            *1
     C                     MOVE HLCCY     @CCY             *1
     C                     Z-ADDHLAMNP    @AMT             *1
     C                     Z-ADDHLFVAL    @FVAL  150       *1
     C* Dates
     C                     Z-ADDHLVDYY    I@VDYY           *1
     C                     Z-ADDHLVDMM    I@VDMM           *1
     C                     Z-ADDHLVDDD    I@VDDD           *1
     C*
     C                     Z-ADDHLMDYY    I@MDYY           *1
     C                     Z-ADDHLMDMM    I@MDMM           *1
     C                     Z-ADDHLMDDD    I@MDDD           *1
     C*
     C                     Z-ADDHLLIYY    I@SLYY           *1
     C                     Z-ADDHLLIMM    I@SLMM           *1
     C                     Z-ADDHLLIDD    I@SLDD           *1
     C*
     C                     Z-ADDHLNIYY    I@NIYY           *1
     C                     Z-ADDHLNIMM    I@NIMM           *1
     C                     Z-ADDHLNIDD    I@NIDD           *1
     C*
     C***********          MOVE HLICMT    @@CALC           *1             056095
     C                     MOVE HLICMT    ZZCALC           *1             056095
     C                     Z-ADDHLFVAL    @@AMT            *1
     C                     Z-ADDHLFRAT    @@RATE           *1
     C                     END                             E1
     C*
     C**  Negotiable assets sold
     C*
     C           @THDL     IFEQ 'S'                        B1
     C*
     C**  Type, currency, and amount
     C*
     C                     MOVE HMMTYP    @TYPE            *1
     C                     MOVE HMLACT    @LACT            *1
     C                     MOVE HMCCY     @CCY             *1
     C                     MOVE HMAMNP    @AMT             *1
     C*   Dates
     C                     Z-ADDHMVDYY    I@VDYY           *1
     C                     Z-ADDHMVDMM    I@VDMM           *1
     C                     Z-ADDHMVDDD    I@VDDD           *1
     C*
     C                     END                             E1
     C*
     C           @THDL     IFEQ 'L'                        B1
     C           @THDL     OREQ 'B'                        B1
     C*
     C** Convert dates to midas day number
     C           @SLINT    IFNE *ZEROS                     B*2
     C***********          Z-ADD@SLINT    @@DTIN           **2            056095
     C                     Z-ADD@SLINT    ZZDTIN           **2            056095
     C           @SLINT    IFLT @START                     B**3
     C***********          Z-ADD@START    @@DTIN           ***3           056095
     C                     Z-ADD@START    ZZDTIN           ***3           056095
     C                     END                             E**3
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @@BEG            **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    ZZBEG            **2            056095
     C                     ELSE                            X*2
     C***********          Z-ADD0         @@BEG            **2            056095
     C                     Z-ADD0         ZZBEG            **2            056095
     C                     END                             E*2
     C                     END                             E1
     C*
     C           @THDL     IFEQ 'L'                        B1
     C           @THDL     OREQ 'B'                        B1
     C*
     C***Load*earlier*of*NIDT*and*MDAT*to*midas*day*number*@@END*******   056095
     C** Load earlier of NIDT and MDAT to midas day number ZZEND          056095
     C*
     C           @NXINT    IFNE *ZEROS                     B*2
     C***********          Z-ADD@NXINT    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @@END            **2            056095
     C                     Z-ADD@NXINT    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    ZZEND            **2            056095
     C                     ELSE                            **2
     C***********          Z-ADD0         @@END            **2            056095
     C                     Z-ADD0         ZZEND            **2            056095
     C                     END                             E*2
     C*
     C***********          Z-ADD@@END     @MNINT  50       *1             056095
     C                     Z-ADDZZEND     @MNINT  50       *1             056095
     C*
     C           @MATD     IFNE *ZEROS                     B*2
     C***********          Z-ADD@MATD     @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C***********          Z-ADD@@MDNO    @DATEM           **2            056095
     C                     Z-ADD@MATD     ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    @DATEM           **2            056095
     C                     ELSE                            X*2
     C                     Z-ADD0         @DATEM           **2
     C                     END                             E*2
     C*
     C                     Z-ADD@DATEM    @MMATD  50       *1
     C*
     C***********@DATEM    IFLT @@END                      B*2            056095
     C***********@@END     OREQ 0                          **2            056095
     C***********          Z-ADD@DATEM    @@END            **2            056095
     C           @DATEM    IFLT ZZEND                      B*2            056095
     C           ZZEND     OREQ 0                          **2            056095
     C                     Z-ADD@DATEM    ZZEND            **2            056095
     C                     END                             E*2
     C                     END                             E1
     C*
     C**  If new currency initialise liquidity fields & access
     C**  currency file
     C           *INL1     IFEQ '1'                        B1
     C*
     C                     MOVE @CCY      HQCCY            *1          ***
     C                     MOVE 'HQ'      HQRCID           *1
     C                     MOVE ' '       HQDLTF           *1
     C*
     C**  Set date of last update to zeroes to ensure that period dates
     C**  will be calculated
     C                     Z-ADD0         HQDLUP           *1
     C                     MOVE *BLANKS   HQMLUP           *1
     C                     Z-ADD0         HQYLUP           *1
     C                     Z-ADD0         HQTLUP           *1
     C                     MOVE 'I'       HQCHTP           *1
     C                     Z-ADD0         @L1              *1
     C                     Z-ADD0         @L2              *1
     C                     Z-ADD0         @L3              *1
     C                     Z-ADD0         @PR              *1
     C*
     C** Access currency file
     C*********************MOVE @CCY      @CUR             *1             S01194
     C***********@KEY******CHAINFDCCYTLL             60    *1          *3 S01194
     C                     CALL 'AOCURRR0'                 **2            S01194
     C                     PARM '*MSG   ' @RTCD   7        **2            S01194
     C                     PARM '*KEY   ' @OPTN   7        **2            S01194
     C                     PARM @CCY      @AJCD   3        **2            S01194
     C           SDCURR    PARM SDCURR    DSSDY                           S01194
     C*
     C** Deal with database error
     C************IN60*****IFEQ '1'                        ***************S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C*********************MOVEL'FDCCYTLL'DBFILE           *             *S01194
     C                     MOVEL'SDCURRPD'DBFILE           *             *S01194
     C                     MOVEL'004'     DBASE            * DBERROR 004 *
     C*********************MOVEL@KEY      DBKEY            *             *S01194
     C                     MOVEL@CCY      DBKEY            *             *S01194
     C                     MOVE @OPTN     DBOPTN  7        *             *S01194
     C                     MOVE '1'       *INU7            ***************
     C                     MOVE '1'       *INU8            **2
     C                     MOVE '1'       *INLR            **2         E14042
     C                     EXSR *PSSR                      **2            S01194
     C                     GOTO #BB9                       **2
     C                     END                             E*2
     C*
     C                     END                             E1
     C*
     C           #BB9      ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #D       - Update LF/MMFLQULL                                 *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         - Main processing                           *
     C*                                                               *
     C* FLDS USED  @L1    - Taken liquidities array                   *
     C*            @L2    - Fixed term liquidities array              *
     C*            @L3    - Placed array                              *
     C*            @PR    - Period dates array                        *
     C*            @DLUP  - Day of last update                        *
     C*            @MLUP  - Month of last update                      *
     C*            @YLUP  - Year of last update                       *
     C*            @USER  - User i.d.                                 *
     C*                                                               *
     C*****************************************************************
     C           #D        BEGSR
      *                                                     E14042
     C           @FIRST    CABNE'Y'       #D9               E14042
     C*
     C**  Update liquidity fields from arrays
     C                     Z-ADD@L1,1     HQLTCE
     C                     Z-ADD@L1,2     HQLTD1
     C                     Z-ADD@L1,3     HQLTD2
     C                     Z-ADD@L1,4     HQLTD3
     C                     Z-ADD@L1,5     HQLTD4
     C                     Z-ADD@L1,6     HQLTW1
     C                     Z-ADD@L1,7     HQLTM1
     C                     Z-ADD@L1,8     HQLTM2
     C                     Z-ADD@L1,9     HQLTM3
     C                     Z-ADD@L1,10    HQLTRM
     C*
     C                     Z-ADD@L3,1     HQLPCE
     C                     Z-ADD@L3,2     HQLPD1
     C                     Z-ADD@L3,3     HQLPD2
     C                     Z-ADD@L3,4     HQLPD3
     C                     Z-ADD@L3,5     HQLPD4
     C                     Z-ADD@L3,6     HQLPW1
     C                     Z-ADD@L3,7     HQLPM1
     C                     Z-ADD@L3,8     HQLPM2
     C                     Z-ADD@L3,9     HQLPM3
     C                     Z-ADD@L3,10    HQLPRM
     C*
     C                     Z-ADD@L2,1     HQCFIX
     C                     Z-ADD@L2,2     HQFXD1
     C                     Z-ADD@L2,3     HQFXD2
     C                     Z-ADD@L2,4     HQFXD3
     C                     Z-ADD@L2,5     HQFXD4
     C                     Z-ADD@L2,6     HQFXW1
     C                     Z-ADD@L2,7     HQFXM1
     C                     Z-ADD@L2,8     HQFXM2
     C                     Z-ADD@L2,9     HQFXM3
     C*
     C                     Z-ADD@PR,1     HQPDTD
     C                     Z-ADD@PR,2     HQPDD1
     C                     Z-ADD@PR,3     HQPDD2
     C                     Z-ADD@PR,4     HQPDD3
     C                     Z-ADD@PR,5     HQPDD4
     C                     Z-ADD@PR,6     HQPDW1
     C                     Z-ADD@PR,7     HQPDM1
     C                     Z-ADD@PR,8     HQPDM2
     C                     Z-ADD@PR,9     HQPDM3
     C*
     C** Load date & time of last update fields
     C                     TIME           HQTLUP
     C*********************Z-ADDRUND      HQLCD                           S01194
     C                     Z-ADDBJRDNB    HQLCD                           S01194
     C                     MOVE @USER     HQLUID
     C                     Z-ADD@DLUP     HQDLUP
     C                     MOVE @MLUP     HQMLUP
     C                     Z-ADD@YLUP     HQYLUP
     C*
     C** Write liquidity record
     C                     WRITEMMFLIQP0
     C*
     C           #D9       ENDSR
     C***********************************************************************
     C/EJECT
     C***********************************************************************
     C****                                                                S01195
     C**ZA0830 - THIS SUBROUTINE FINDS OUT WHETHER A PARTICULAR DAY       S01195
     C****       IS A HOLIDAY IN A PARTICULAR CURRENCY                    S01195
     C****                                                                S01195
     C**CALLED BY :                                                       S01195
     C****                                                                S01195
     C**CALLS :                                                           S01195
     C**                                                                  S01195
     C**INPUT  : @@MNO  MIDAS DAY NUMBER 5N                               S01195
     C****       @@CCY  CURRENCY CODE 3A                                  S01195
     C****                                                                S01195
     C**OUTPUT : @@HIND HOLIDAY/WORKING DAY INDICATOR 1A                  S01195
     C*****                                                               S01195
     C**USES :   @@MNO  MIDAS DAY NUMBER                                  S01195
     C****       @@CCY  CURRENCY CODE                                     S01195
     C****       @@ONCE FIRST TIME THROUGH INDICATOR                      S01195
     C****       @@CY1  FIRST HALF OF CURRENCY ARRAY                      S01195
     C****       @@CY2  SECOND HALF OF CURRENCY ARRAY                     S01195
     C****       @@MNO6 MIDAS NUMBER WITH TRAILING BLANK                  S01195
     C****       @@HIND HOLIDAY/WORKING DAY INDICATOR                     S01195
     C****       @@INEX INCLUDE/EXCLUDE INDICATOR                         S01195
     C****                                                                S01195
     C****       INDICATORS                                               S01195
     C****       80 RECORD NOT FOUND                                      S01195
     C****       81 CURRENCY NOT FOUND ON RECORD                          S01195
     C****                                                                S01195
     C********************************************************************S01195
     C****       ZA0830    BEGSR                                          S01195
     C****                                                                S01195
     C*****   CURRENCY/HOLIDAY FILE IF FIRST TIME THROUGH                 S01195
     C****       @@ONCE    IFNE 'Y'                        B1             S01195
     C****                  *   FDTABJLL                   *1             S01195
     C****                 MOVE 'Y'       @@ONCE  1        *1             S01195
     C****                 END                             E1             S01195
     C****                                                                S01195
     C***BLANK OUT ARRAY                                                  S01195
     C****                 MOVE *BLANKS   @@CY1                           S01195
     C****                 MOVE *BLANKS   @@CY2                           S01195
     C****                                                                S01195
     C***ACCESS TABLE ON FIRST KEY                                        S01195
     C****                 MOVEL@@MNO     @@MNO6  6                       S01195
     C****                 MOVE @@MNO6    SS0830 12                       S01195
     C****                 MOVEL'22    '  SS0830                          S01195
     C****                 MOVE '1'       SS0830                          S01195
     C****       SS0830    CHAINTABLETJF             80                   S01195
     C****                                                                S01195
     C***IF RECORD NOT FOUND OR DELETED                                   S01195
     C****       *IN80     IFEQ '1'                        B1             S01195
     C****       RECI      OREQ '*'                        *1             S01195
     C****                 MOVE 'W'       @@HIND           *1             S01195
     C****                 GOTO ZA0839                     *1             S01195
     C****                 END                             E1             S01195
     C****                                                                S01195
     C***MOVE FIRST 25 CURRENCIES TO ARRAY                                S01195
     C****                 MOVE HCCY      @@CY1                           S01195
     C****                                                                S01195
     C***ACCESS TABLE ON SECOND KEY                                       S01195
     C****                 MOVE '2'       SS0830                          S01195
     C****       SS0830    CHAINTABLETJF             80                   S01195
     C****                                                                S01195
     C***IF SECOND RECORD FOUND AND NOT DELETED                           S01195
     C****       *IN80     IFEQ '0'                        B1             S01195
     C****       RECI      ANDNE'*'                        *1             S01195
     C****                 MOVE HCCY      @@CY2            *1             S01195
     C****                 END                             E1             S01195
     C****                                                                S01195
     C***SEARCH ARRAY FOR INPUT CURRENCY                                  S01195
     C****       @@CCY     LOKUP@CY                      81               S01195
     C****                                                                S01195
     C***IF INPUT CURRENCY IS IN ARRAY                                    S01195
     C****       *IN81     IFEQ '1'                        B1             S01195
     C****                                                                S01195
     C***IF INCLUDE/EXCLUDE INDICATOR EQ 'E'                              S01195
     C****       INEX      IFEQ 'E'                        B*2            S01195
     C****                 MOVE 'W'       @@HIND  1        **2            S01195
     C****                 ELSE                            X*2            S01195
     C****                 MOVE 'H'       @@HIND           **2            S01195
     C****                 END                             E*2            S01195
     C****                 END                             E1             S01195
     C****                                                                S01195
     C***IF INPUT CURRENCY IS NOT IN ARRAY                                S01195
     C****       *IN81     IFEQ '0'                        B1             S01195
     C****                                                                S01195
     C***IF INCLUDE/EXCLUDE INDICATOR EQ 'I'                              S01195
     C****       INEX      IFEQ 'I'                        B*2            S01195
     C****                 MOVE 'W'       @@HIND           **2            S01195
     C****                 ELSE                            X*2            S01195
     C****                 MOVE 'H'       @@HIND           **2            S01195
     C****                 END                             E*2            S01195
     C****                 END                             E1             S01195
     C****       ZA0839    ENDSR                                          S01195
     C/EJECT
     C/COPY ZSRSRC,ZCHKH                                                  S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
     C*****************************************************************   S01392
     C****MM1007 - CALCULATE INTEREST                                 *   S01392
     C******                                                          *   S01392
     C***CALLED BY    -                                               *   S01392
     C******                                                          *   S01392
     C***CALLS        -   MM1009 CALCULATE NO. OF INTEREST DAYS       *   S01392
     C******                                                          *   S01392
     C***FIELDS INPUT @@BEG  - START DATE OF PERIOD                   *   S01392
     C******          @@END  - END DATE OF PERIOD                     *   S01392
     C******          @@CALC - INTEREST CALCULATION METHOD            *   S01392
     C******          @@AMT  - PRINCIPAL AMOUNT  15N                  *   S01392
     C******          @@RATE - INTEREST RATE 11,7                     *   S01392
     C******                                                          *   S01392
     C***FIELDS OUTPUT @@INTR - INTEREST 15,0                         *   S01392
     C******                                                          *   S01392
     C***WORK FIELDS   @@W155 - 15,5                                      S01392
     C******                                                          *   S01392
     C*****************************************************************   S01392
     C******     MM1007    BEGSR                                          S01392
     C******                                                              S01392
     C****CALCULATE NUMBER OF INTEREST DAYS                               S01392
     C******               EXSR MM1009                                    S01392
     C******                                                              S01392
     C******     @@CALC    IFEQ '2'                        *** B 1        S01392
     C******     @@CALC    OREQ '3'                                       S01392
     C******     @@CALC    OREQ '5'                                       S01392
     C******     @@AMT     DIV  36000     @@W155 155                      S01392
     C******               END                             *** E 1        S01392
     C******                                                              S01392
     C******     @@CALC    IFEQ '1'                        *** B 1        S01392
     C******     @@CALC    OREQ '4'                                       S01392
     C******     @@AMT     DIV  36500     @@W155                          S01392
     C******               END                              *** E 1       S01392
     C******                                                              S01392
     C******     @@CALC    IFEQ '6'                         *** B 1       S01392
     C******     @@AMT     DIV  36600     @@W155                          S01392
     C******               END                              *** E 1       S01392
     C******                                                              S01392
     C******               MULT @@RATE    @@W155                          S01392
     C******     @@W155    MULT @@INDY    @@INTR 150H                     S01392
     C******                                                              S01392
     C******     M10079    ENDSR                                          S01392
     C*****************************************************************   S01392
     C/EJECT
     C*****************************************************************   S01392
     C*                                                               *   S01392
     C*   MM1030 - CALCULATE INTEREST                                 *   S01392
     C*                                                               *   S01392
     C*  CALLED BY    -                                               *   S01392
     C*                                                               *   S01392
     C***CALLS********-***MM1009*CALCULATE*NO.*OF*INTEREST*DAYS*****S01392056095
     C*  CALLS        -   ZINTDY CALCULATE NO. OF INTEREST DAYS       *   056095
     C*                                                               *   S01392
     C***FIELDS*INPUT*@@BEG**-*START*DATE*OF*PERIOD*****************S01392056095
     C****************@@END**-*END*DATE*OF*PERIOD*******************S01392056095
     C****************@@CALC*-*INTEREST*CALCULATION*METHOD**********S01392056095
     C*  FIELDS INPUT ZZBEG  - START DATE OF PERIOD                   *   056095
     C*               ZZEND  - END DATE OF PERIOD                     *   056095
     C*               ZZCALC - INTEREST CALCULATION METHOD            *   056095
     C*               @@AMT  - PRINCIPAL AMOUNT  15N                  *   S01392
     C*               @@RATE - INTEREST RATE 11,7                     *   S01392
     C*               @@RDFC - ROUND DOWN FACILITY IND 1              *   S01392
     C*                                                               *   S01392
     C*  FIELDS OUTPUT @@INTR - INTEREST 15,0                         *   S01392
     C*                                                               *   S01392
     C*  WORK FIELDS   @@W157 - 15,5                                  *   S01392
     C*****************@@W150*-*15,0*******************************S01392 056121
     C*                @@W210 - 21,0                                  *   056121
     C*                @@YEAR - (NUMBER OF DAYS IN YEAR) x 100        *   S01392
     C*                                                               *   S01392
     C*****************************************************************   S01392
     C           MM1030    BEGSR                                          S01392
     C*                                                                   S01392
     C*   CALCULATE NUMBER OF INTEREST DAYS                               S01392
     C/COPY WNCPYSRC,MM0194C001
     C*                                                                   S01392
     C***********          EXSR MM1009                              S01392056095
     C                     Z-ADDZZBEG     ZZBEG9  50                                          CDL093
     C                     Z-ADDZZEND     ZZEND9  50                                          CDL093
      *                                                                                       CDL093
      ** Check if 29th Feb is included                                                        CDL093
      *                                                                                       CDL093
     C           ZZCALC    IFEQ '9'                                                           CDL093
      *                                                                                       CDL093
      ** Convert start date to YYYYMMDD format                                                CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZBEG9    @@DAYN  50                                          CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATA  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY1   40                                          CDL093
      *                                                                                       CDL093
      ** Convert end date to YYYYMMDD format                                                  CDL093
      *                                                                                       CDL093
     C                     Z-ADDZZEND9    @@DAYN                                              CDL093
     C                     EXSR ZDATE9                                                        CDL093
     C                     Z-ADD@@VDT     ZZDATB  80                                          CDL093
     C                     Z-ADD@@YR      ZZYY2   40                                          CDL093
      *                                                                                       CDL093
     C                     EXSR #FEB29                                                        CDL093
      *                                                                                       CDL093
     C                     ENDIF                                                              CDL093
      *                                                                                       CDL093
     C           ZZCALC    IFEQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C           HKNIPD    ANDNE*ZERO                                                         CDL093
     C           HKNIPD    ANDLTZZEND                                                         CDL093
      *                                                                                       CDL093
     C                     Z-ADDHKIPDM    @@IPDM  20                                          CDL093
     C                     CALL 'MM001031'                                                    CDL093
     C                     PARM           ZZBEG                                               CDL093
     C                     PARM           ZZEND                                               CDL093
     C                     PARM           HKNIPD                                              CDL093
     C                     PARM '9'       ZZCALC                                              CDL093
     C                     PARM           HKIPFQ                                              CDL093
     C                     PARM           @@AMT                                               CDL093
     C                     PARM           @@RATE                                              CDL093
     C                     PARM 'N'       RNDDWN  1                                           CDL093
     C                     PARM 'N'       FRSLST  1                                           CDL093
     C                     PARM           @@IPDM                                              CDL093
     C                     PARM           WINTR                                               CDL093
      *                                                                                       CDL093
     C                     Z-ADDWINTR     @@INTR                                              CDL093
     C           *LIKE     DEFN @@INTR    WINTR                                               CDL093
      *                                                                                       CDL093
     C                     GOTO INTCLC                                                        CDL093
      *                                                                                       CDL093
     C                     ENDIF                                                              CDL093
      *                                                                                       CDL093
     C                     EXSR ZINTDY                                    056095
     C*                                                                   S01392
     C***********@@CALC    IFEQ '2'                        *** B 1  S01392056095
     C***********@@CALC    OREQ '3'                                 S01392056095
     C***********@@CALC    OREQ '5'                                 S01392056095
     C           ZZCALC    IFEQ '2'                        *** B 1        056095
     C           ZZCALC    OREQ '3'                                       056095
     C           ZZCALC    OREQ '5'                                       056095
     C           ZZCALC    OREQ '7'                                       CIR004
     C           CIR004    ANDEQ'Y'                                       CIR004
     C           ZZCALC    OREQ '0'                                                          CER016A
     C                     Z-ADD36000     @@YEAR  50                      S01392
     C                     END                             *** E 1        S01392
     C*                                                                   S01392
     C***********@@CALC    IFEQ '1'                        *** B 1  S01392056095
     C***********@@CALC    OREQ '4'                                 S01392056095
     C           ZZCALC    IFEQ '1'                        *** B 1        056095
     C           ZZCALC    OREQ '4'                                       056095
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDNE'Y'                                                           CDL093
     C                     Z-ADD36500     @@YEAR                          S01392
     C                     END                              *** E 1       S01392
     C*                                                                   S01392
     C***********@@CALC    IFEQ '6'                         *** B 1 S01392056095
     C           ZZCALC    IFEQ '6'                         *** B 1       056095
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C                     Z-ADD36600     @@YEAR                          S01392
     C                     END                              *** E 1       S01392
     C*                                                                   S01392
     C           ZZCALC    IFEQ '6'                                       163136
     C           ZZCALC    OREQ '9'                                                           CDL093
     C           #29FEB    ANDEQ'Y'                                                           CDL093
     C           INT6DY    MULT @@RATE    @@W157                          163136
     C                     ELSE                                           163136
      *                                                                   163136
     C***********@@INDY    MULT @@RATE    @@W157 157                S01392056095
     C           ZZINDY    MULT @@RATE    @@W157 157                      056095
      *                                                                   163136
     C                     END                                            163136
      *                                                                   163136
     C***********@@W157    MULT @@AMT     @@W150 150H              S01392 056121
     C           @@W157    MULT @@AMT     @@W210 210H                     056121
     C*                                                                   S01392
     C**  ROUND DOWN IF ROUND DOWN INDICATOR IS 'Y'                       S01392
     C*                                                                   S01392
     C           @@RDFC    IFEQ 'Y'                                       S01392
     C***********@@W150    DIV  @@YEAR    @@INTR                   S01392 056121
     C           @@W210    DIV  @@YEAR    @@INTR                          056121
     C                     ELSE                                           S01392
     C***********@@W150    DIV  @@YEAR    @@INTR 150H              S01392 056121
     C           @@W210    DIV  @@YEAR    @@INTR 150H                     056121
     C                     END                                            S01392
     C*                                                                   S01392
      * Interest has been calculated                                                          CDL093
     C           INTCLC    TAG                                                                CDL093
     C                     MOVE *BLANK    @@RDFC                          S01392
     C/COPY WNCPYSRC,MM0194C002
     C*                                                                   S01392
     C           M10309    ENDSR                                          S01392
     C*****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZINTDYZ2                                               056095
     C*****************************************************************
     C****MM1009*- CALCULATE THE NUMBER OF INTEREST DAYS              *   056095
     C***********                                                     *   056095
     C***CALLED*BY    -                                               *   056095
     C***********                                                     *   056095
     C***CALLS***     -   ZA0710 CONVERT MIDAS DAY NUMBER TO YMD DATE *   056095
     C***********                                                     *   056095
     C***FIELDS*INPUT @@BEG  - START DATE OF PERIOD                   *   056095
     C***********     @@END  - END DATE OF PERIOD                     *   056095
     C***********     @@CALC - INTEREST CALCULATION METHOD            *   056095
     C***********                                                     *   056095
     C***FIELDS*OUTPUT @@INDY - NO. OF INTEREST DAYS                  *   056095
     C***********                                                     *   056095
     C***WORKFIELDS   @@WN5   - WORK FIELD 5N                         *   056095
     C***********     @@WN5A  - WORK FIELD 5N                         *   056095
     C***********     @@WDAT  - WORK FIELD 5N                         *   056095
     C***********     @@DAYN  - WORK FIELD 5N                         *   056095
     C***********     @@P1    - WORK FIELD 5N                         *   056095
     C***********     @@P2    - WORK FIELD 5N                         *   056095
     C***********     @@P3    - WORK FIELD 5N                         *   056095
     C***********     @@LPNM  - WORKFIELD USED IN SETTING UP @@TG10   *   056095
     C***********                                                     *   056095
     C*****************************************************************   056095
     C***********MM1009    BEGSR                                          056095
     C***********                                                         056095
     C***********          MOVE @@BEG     @@BEG   50                      056095
     C***********          MOVE @@END     @@END   50                      056095
     C***********          MOVE @@CALC    @@CALC  1                       056095
     C***********          Z-ADD*ZEROS    @@INDY                          056095
     C***********          Z-ADD*ZEROS    @@LPNM                          056095
     C***********                                                         056095
     C***FIND*NUMBER OF DAYS DIFFERENCE BETWEEN DATES                     056095
     C***********                                                         056095
     C***********@@END     SUB  @@BEG     @@WDAT  50                      056095
     C***********                                                         056095
     C*****FOR*CALCULATION METHODS 3,4 OR 5.                              056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '3'                        **** B 1       056095
     C***********@@CALC    OREQ '4'                                       056095
     C***********@@CALC    OREQ '5'                                       056095
     C***********                                                         056095
     C***********          Z-ADD@@BEG     @@DAYN  50                      056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DATA                          056095
     C***********                                                         056095
     C***********          Z-ADD@@END     @@DAYN                          056095
     C***********          EXSR ZA0710                                    056095
     C***********          Z-ADD@@VDT     @@DATB                          056095
     C***IF*IN*SAME MONTH                                                 056095
     C***********@@YY1     IFEQ @@YY2                      **** B 2       056095
     C***********@@MM1     IFEQ @@MM2                      **** B 3       056095
     C***********@@DD2     SUB  @@DD1     @@INDY                          056095
     C***********          GOTO M10099                     --------->     056095
     C***********          END                             **** E 3       056095
     C***********          END                             **** E 2       056095
     C***********                                                         056095
     C***********          ELSE                            **** X         056095
     C**IF*NOT*3,4 OR 5    ****                                           056095
     C**EXIT*PROCESSING                                                   056095
     C***********          Z-ADD@@WDAT    @@INDY  50       - LOAD OUTPT   056095
     C***********          GOTO M10099                     ----------->   056095
     C***********          END                             **** E 1       056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '3'                        **** B 1       056095
     C***CALC*NO. DAYS IN FIRST MONTH                                     056095
     C***********@@MM1     IFNE 2                          **** B 2       056095
     C***********30        SUB  @@DD1     @@P1    50   80                 056095
     C***IF*<*0,*INITIALISE TO 0                                          056095
     C***80******          Z-ADD*ZEROS    @@P1                            056095
     C***********                                                         056095
     C***********          ELSE                            **** X         056095
     C***TEST*IF*LEAP      ****                                           056095
     C***YEAR****                                                         056095
     C***********@@YY1     DIV  4         @@WN5                           056095
     C***********          MVR            @@WN5          80               056095
     C***********                                                         056095
     C************IN80     IFEQ '1'                        **** B 3       056095
     C***********29        SUB  @@DD1     @@P1    50                      056095
     C***********          ELSE                                           056095
     C***IF*NOT*LEAP       ++++                                           056095
     C***********28        SUB  @@DD1     @@P1    50                      056095
     C***********          END                             **** E 3       056095
     C***********          END                             **** E 2       056095
     C***CALC.*NO. DAYS IN LAST MONTH                                     056095
     C***********@@DD2     IFLE 30                         **** B 2       056095
     C***********          Z-ADD@@DD2     @@P2    50                      056095
     C***********          ELSE                            **** X         056095
     C***********          ****                                           056095
     C***********          Z-ADD30        @@P2                            056095
     C***********          END                             **** E 2       056095
     C***CALC*NO. DAYS IN INTERVENING MONTHS                              056095
     C***********@@YY2     IFEQ @@YY1                      **** B 2       056095
     C***********@@MM2     SUB  @@MM1     @@P3    50                      056095
     C***********          SUB  1         @@P3                            056095
     C***********          MULT 30        @@P3                            056095
     C***********          ELSE                            **** X         056095
     C***********          ****                                           056095
     C***********@@YY2     SUB  @@YY1     @@P3                            056095
     C***********          SUB  1         @@P3                            056095
     C***********          MULT 360       @@P3                            056095
     C***********                                                         056095
     C**FIND*NO.*OF MONTHS FOR THE TWO PARTIAL YEARS                      056095
     C***********12        SUB  @@MM1     @@WN5A  50                      056095
     C***********          MULT 30        @@WN5A                          056095
     C***********                                                         056095
     C***********@@MM2     SUB  1         @@WN5                           056095
     C***********@@WN5     MULT 30        @@WN5                           056095
     C***ACCUMULATE                                                       056095
     C***********@@WN5A    ADD  @@WN5     @@WN5A                          056095
     C***********@@P3      ADD  @@WN5A    @@P3                            056095
     C***********          END                             **** E 2       056095
     C***FINAL*SUM                                                        056095
     C***********                                                         056095
     C***********@@P1      ADD  @@P2      @@INDY                          056095
     C***********          ADD  @@P3      @@INDY                          056095
     C***********          END                             **** E 1       056095
     C***FOR*METHODS 4 AND 5                                              056095
     C***********                                                         056095
     C***********@@CALC    IFEQ '4'                        **** B 1       056095
     C***********@@CALC    OREQ '5'                                       056095
     C****CALCULATE NUMBER OF LEAP YEARS BETWEEN START AND END DATES      056095
     C***********@@MM1     IFLE 2                          **** B 2       056095
     C***********@@YY1     DIV  4         @@WN5   50                   YR 056095
     C***********          MVR            @@WN5          80               056095
     C***ADD*1*IF LEAP YEAR                                               056095
     C***80******          ADD  1         @@LPNM  50                      056095
     C***********          END                             **** E 3       056095
     C***BYPASS*IF YEARS ARE THE SAME                                     056095
     C***********@@YY1     IFEQ @@YY2                      **** B 3       056095
     C***********@@WDAT    SUB  @@LPNM    @@INDY                          056095
     C***********          GOTO M10099                     ---------->    056095
     C***********          END                             **** E 2       056095
     C***LOOP*TO*CALCULATE NO. LEAP YEARS                                 056095
     C***********@@YY1     DOWNE@@YY2                      **** B 2       056095
     C***INCREMENT START YEAR                                             056095
     C***********          ADD  1         @@YY1                           056095
     C***********                                                         056095
     C***********@@YY1     IFEQ @@YY2                      **** B 3       056095
     C***********@@MM2     IFGT 2                          **** B 4       056095
     C***********@@YY2     DIV  4         @@WN5                        YR 056095
     C***********          MVR            @@WN5          80               056095
     C***INCREMENT IF LEAP YEAR                                           056095
     C***80******          ADD  1         @@LPNM                          056095
     C***********          END                              **** E 4      056095
     C***********@@WDAT    SUB  @@LPNM    @@INDY                          056095
     C***********          END                              **** E 3      056095
     C***********@@YY1     IFNE @@YY2                       **** B 3      056095
     C***********@@YY1     DIV  4         @@WN5                        YR 056095
     C***********          MVR            @@WN5          80               056095
     C***ADD*1*IF LEAP YEAR                                               056095
     C***80******          ADD  1         @@LPNM                          056095
     C***********          END                              **** E 3      056095
     C***********          END                              **** E 2      056095
     C***********          END                              **** E 1      056095
     C***********                                                         056095
     C***********M10099    ENDSR                           ***M10099***   056095
     C***********                                                         056095
     C/EJECT
     C***********************************************************************
     C****************************************************************    E36300
     C**MM1005*-*THIS*SUBROUTINE*FINDS*OUT*THE*NUMBER*OF*WORKING*DAYS*    E36300
     C***********FORWARD*FOR*A*SPECIFIC*CURRENCY*AGAINST*A*LOCAL******    E36300
     C***********CURRENCY.********************************************    E36300
     C****************************************************************    E36300
     C**CALLED*BY*:***************************************************    E36300
     C****************************************************************    E36300
     C**CALLS*:**ZA0830,*A*COMMON*ROUTINE*TO*DETERMINE*WHETHER*A*DATE1195 E36300
     C**CALLS*:**ZCHKH*,*A*COMMON*ROUTINE*TO*DETERMINE*WHETHER*A*DATE1195 E36300
     C***********IS*A*WORKING*DAY*OR*A*HOLIDAY.***********************    E36300
     C****************************************************************    E36300
     C**INPUT**:*@@MNO**MIDAS*DAY*NUMBER*5N************************S01195 E36300
     C***********@@CCY**CURRENCY*CODE*3A***************************S01195 E36300
     C**INPUT**:*ZDAYNO*MIDAS*DAY*NUMBER*5N************************S01195 E36300
     C***********ZCCY***CURRENCY*CODE*3A***************************S01195 E36300
     C***********@@FWD**NO.*OF*WORKING*DAYS*FORWARD*5N****************    E36300
     C****************************************************************    E36300
     C**OUTPUT*:*@@FDAT*FORWARD*DATE*(MIDAS*DAY*NUMBER)*5N************    E36300
     C****************************************************************    E36300
     C**USES*:***@@MNO**MIDAS*DAY*NUMBER***************************S01195 E36300
     C***********@@CCY**CURRENCY*CODE******************************S01195 E36300
     C**USES*:***ZDAYNO*MIDAS*DAY*NUMBER***************************S01195 E36300
     C***********ZCCY***CURRENCY*CODE******************************S01195 E36300
     C***********@@WF2**WORK*FIELD*5N*********************************    E36300
     C***********@@HIND*HOLIDAY/WORKING*DAY*INDICATOR**1A**********S01195 E36300
     C***********ZIND***HOLIDAY/WORKING*DAY*INDICATOR**1A**********S01195 E36300
     C***********@@FWD**NUMBER*OF*WORKING*DAYS*FORWARD*TO*LOOK*5N*****    E36300
     C****************************************************************    E36300
     C**FILES*:*THIS*PROGRAM*EXPECTS*FILE*FCICDRLL*TO*HAVE*BEEN*******    E36300
     C**********DEFINED*AND*ALREADY*ACCESSED*WITH*A*KEY*OF************    E36300
     C**********'01********11'.***************************************    E36300
     C****************************************************************    E36300
     C***********************************************************************
     C***********MM1005    BEGSR                                          E36300
     C***INITIALISE FIELDS                                                E36300
     C*********************Z-ADD@@MNO     @@MNO   50                      S01195
     C************         Z-ADDZDAYNO    ZDAYNO  50               S01195 E36300
     C************         Z-ADD*ZEROS    @@WF2   50                      E36300
     C************                                                        E36300
     C****LOOP*TO*PROCESS*INPUT*PARAMETERS****************************    E36300
     C************                                                        E36300
     C***********@@WF2     DOWLT@@FWD                      *** B 1        E36300
     C***INCREMENT*NUMBER*OF*WORK*DAYS********************************    E36300
     C************         ADD  1         @@WF2                           E36300
     C***INCREMENT*DATE***********************************************    E36300
     C*********************ADD  1         @@MNO                           S01195
     C************         ADD  1         ZDAYNO                   S01195 E36300
     C***LOOP*TO*OBTAIN*FIRST*WORKING*DAY*****************************    E36300
     C***********@@HIND****DOUEQ'W'*************************** B 2        S01195
     C***********ZIND      DOUEQ'W'                         ** B 2 S01195 E36300
     C***CALL*COMMON*ROUTINE*TO*DETERMINE*IF*WORKING*DAY**************    E36300
     C*********************EXSR ZA0830                                    S01195
     C************         EXSR ZCHKH                      ***3    S01195 E36300
     C***INCREMENT*NUMBER*OF*WORK*DAYS*-*IF*FOUND*TO*BE*HOLIDAY*******    E36300
     C***********@@HIND    IFEQ 'H'                        *** B 3        S01195
     C*********************ADD  1         @@MNO                           S01195
     C***********ZIND      IFEQ 'H'                        *** B 3 S01195 E36300
     C************         ADD  1         ZDAYNO                   S01195 E36300
     C************         END                             *** E 3        E36300
     C************         +                                              E36300
     C************         END                             *** E 2        E36300
     C************         ++                                             E36300
     C***TEST*IF*WORKING*DAY*FOR*LOCALS*******************************    E36300
     C*********************MOVE @@CCY     @@WA3   3                       S01195
     C*********************MOVE LCCY      @@CCY   3                       S01195
     C*********************MOVE *BLANKS   @@HIND  1                       S01195
     C************         MOVE ZCCY      @@WA3   3                S01195 E36300
     C************         MOVE BJLCCY    ZCCY    3                S01195 E36300
     C************         MOVE *BLANKS   ZIND    1                S01195 E36300
     C************                                                        E36300
     C***CALL*COMMON*ROUTINE*AGAIN************************************    E36300
     C*********************EXSR ZA0830                                    S01195
     C************         EXSR ZCHKH                      ***3    S01195 E36300
     C***RESTORE*FIELD*TO*ORIGINAL*VALUE******************************    E36300
     C*********************MOVE @@WA3     @@CCY   3                       S01195
     C************         MOVE @@WA3     ZCCY    3                       S01195
     C***IF*LOCAL*HOLIDAY*DECREMENT*COUNTER***************************    E36300
     C***********@@HIND****IFEQ 'H'                        *** B 2 S01195 E36300
     C***********ZIND      IFEQ 'H'                        *** B 2 S01195 E36300
     C************         SUB  1         @@WF2                           E36300
     C************         END                             *** E 2        E36300
     C************         +                                              E36300
     C************         END                             *** E 1        E36300
     C************         ++                                             E36300
     C***LOAD*OUTPUT*FIELD********************************************    E36300
     C*********************Z-ADD@@MNO     @@FDAT  50                      S01195
     C************         Z-ADDZDAYNO    @@FDAT  50               S01195 E36300
     C************                                                        E36300
     C***********M10059    ENDSR                                          E36300
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #C       - Final processing                                   *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY  MAIN   - Controls program                          *
     C*                                                               *
     C* FLDS USED  @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           #C        BEGSR
     C           *LOCK     IN   @STATS                              E14042
     C                     MOVE @SUBMN    @SUBM1  10                E14042
     C                     SUB  1         @SUBM1                    E14042
     C                     MOVE @SUBM1    @SUBMN                    E14042
     C*                                                             E14042
     C** Set stream flag for successful completion or failure       E14042
     C           @TERM     IFEQ 'T'                        B1       E14042
     C           @TERM     OREQ 'E'                        B1       E14042
     C           *INU7     OREQ '1'                        B1       E14042
     C                     MOVE 'X'       @STRM2                    E14042
     C*********************CALL 'QCAEXEC'                  *1       E14042E20774
     C                     CALL 'QCMDEXC'                  *1             E20774
     C                     PARM           @CM,1            *1       E14042
     C                     PARM 80        @QCALN 155       *1       E14042
     C                     END                             E1       E14042
     C                     OUT  @STATS                              E14042
     C*
     C** Set on LR & exit if termination parmater is 'T'
     C           @TERM     IFEQ 'T'                        B1
     C                     MOVE '1'       *INLR            *1
     C                     RETRN
     C                     GOTO #C9                        *1
     C                     END                             E1
     C*
     C**  If a data base error has occurred in one of the called
     C**  programs return without setting on
     C**  *INLR or closing the files.
     C           @TERM     IFEQ 'E'                        B1
     C                     RETRN                           *1
     C                     END                             E1
     C*
     C**  If a data base error has occurred in the program, set
     C**  termination parameter to 'E' & exit program
     C**  setting on *inLR
     C           *INU7     IFEQ '1'                        B1
     C                     DUMP                            *1     E14042
     C                     MOVE 'E'       @TERM            *1
     C                     MOVE '1'       *INLR            *1
     C                     RETRN                           *1
     C                     GOTO #C9                        *1
     C                     END                             E1
     C*
     C           #C9       ENDSR                           **#C9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #A       - Initial processing                                 *
     C*                                                               *
     C* CALLS    ZA0150   - Access installation file                  *
     C***********ZA0710***-*Convert*midas*day*no.*to*YYYYMMDD*format***   056095
     C*          ZDATE9   - Convert midas day no. to YYYYMMDD format  *   056095
     C*                                                               *
     C* CALLED BY  MAIN   - Controls program                          *
     C*                                                               *
     C* FLDS USED  @TERM  - Termination parameter                     *
     C*            @THDL  - Deal format passed to program             *
     C*            @STDL  - Standard deal d.s. : loans & deposits     *
     C*            @STDB  - Standard deal d.s. : N/A's bought         *
     C*            @STDS  - Standard deal d.s. : N/A's sold           *
     C*            @STDA  - Standard deal d.s. : deal amendments      *
     C*            @FIRST - Program has been called before indicator  *
     C*            @@RUND - Run date YYYYMMDD                         *
     C*            @KEY   - Key to currencies file                    *
     C*            @@DAYN - Midas day number                          *
     C*************@@VDT**-*Date*output*from*ZA0710********************   056095
     C*            @@VDT  - Date output from ZDATE9                   *   056095
     C*            @DNWD  - Date of next working day                  *
     C*                                                               *
     C*****************************************************************
     C           #A        BEGSR
     C*
     C                     MOVEACPY@      BIS@   80                       S01194
      *                                                                                       CDL033
      * Define local data area                                                                CDL033
     C           *NAMVAR   DEFN           LDA                                                 CDL033
      *                                                                                       CDL033
     C**  Parameter list .
     C           @FIRST    IFNE 'Y'                        B1
     C           *ENTRY    PLIST                           *1
     C                     PARM           @TERM   1        *1
     C*
     C**  Move program name into *LDA field.
     C                     MOVEL'MM0194'  DBPGM            *1
     C                     END                             E1
      *
     C           *NAMVAR   DEFN SDSTAT    @STATS                    E14042
      *                                                             E14042
      **  If stream already failed, exit program                    E14042
     C                     IN   @STATS                              E14042
     C           @STRM2    IFEQ 'X'                                 E14042
     C                     SETON                     U7             E14042
     C                     MOVE '1'       *INLR                     E14042
     C                     GOTO #A9                                 E14042
     C                     END                                      E14042
     C*
     C** INITIALISE INDICATORS & WORKFIELDS
     C*
     C                     MOVE '0'       *IN60
     C                     MOVE '0'       *IN63
     C                     MOVE '0'       *IN61
     C                     MOVE '0'       *IN62
     C                     MOVE '0'       *IN64
     C*
     C***********          Z-ADD0         @@BEG                           056095
     C***********          Z-ADD0         @@END                           056095
     C                     Z-ADD0         ZZBEG                           056095
     C                     Z-ADD0         ZZEND                           056095
     C                     Z-ADD0         @@AMT
     C                     Z-ADD0         @@RATE
     C                     Z-ADD0         @AMT
     C                     Z-ADD0         @FVAL
     C                     Z-ADD0         @SLINT
     C                     Z-ADD0         @NXINT
     C                     Z-ADD0         @MATD
     C                     Z-ADD0         @START
     C                     Z-ADD0         @NTCE
     C                     MOVE *BLANKS   @TYPE
     C***********          MOVE *BLANK    @@CALC                          056095
     C                     MOVE *BLANK    ZZCALC                          056095
     C                     MOVE *BLANKS   @CCY
     C*
     C**  Open files if first run
     C           @FIRST    IFNE 'Y'                        B1
     C                     MOVE 'Y'       @FIRST  1        *1
     C                     Z-ADD0         @@RUND           *1
     C                     Z-ADD0         @LDN    60       *1
     C*********************OPEN FDICDRLL                   *1             S01194
     C*********************OPEN FDCCYTLL                   *1             S01194
     C*********************OPEN*FDINSTLL********************1*************S01319
     C*
     C****Access*TABTB10******                                            S01194
     C*********************EXSR ZA0150                     *1             S01194
     C** Access Bank details via access program                           S01194
     C                     CALL 'AOBANKR0'                                S01194
     C                     PARM '*MSG   ' @RTCD   7                       S01194
     C                     PARM '*FIRST ' @OPTN   7                       S01194
     C           SDBANK    PARM SDBANK    DSFDY                           S01194
     C** DEAL WITH DATA BASE ERROR                                        S01194
     C           @RTCD     IFNE *BLANK                                    S01194
     C                     MOVEL'SDBANKPD'DBFILE           ***************S01194
     C                     MOVEL'900'     DBASE            * DBERROR 900 *S01194
     C                     MOVEL@OPTN     DBKEY            *             *S01194
     C                     MOVEL@OPTN     DBOPTN           *             *S01194
     C                     MOVE '1'       *INU7            ***************S01194
     C                     MOVE '1'       *INU8            *1             S01194
     C                     MOVE '1'       *INLR                     E14042S01194
     C                     EXSR *PSSR                                     S01194
     C                     GOTO #A9                                       S01194
     C                     END                             E1             S01194
      *                                                                                       CDL033
      ** Access Switchable Features file and check if CDL033                                  CDL033
      ** is switched on or not.                                                               CDL033
      *                                                                                       CDL033
     C                     CALL 'AOSARDR0'                                                    CDL033
     C                     PARM *BLANKS   PRTCD   7                                           CDL033
     C                     PARM '*VERIFY' POTPN   7                                           CDL033
     C                     PARM 'CDL033'  PSARD   6                                           CDL033
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL033
      *                                                                                       CDL033
     C           PRTCD     IFEQ *BLANKS                                                       CDL033
     C                     MOVE 'Y'       CDL033  1                                           CDL033
     C                     ELSE                                                               CDL033
     C                     MOVE 'N'       CDL033                                              CDL033
      *                                                                                       CDL033
      ** Database Error, if Return Code is not blanks or *NRF                                 CDL033
      *                                                                                       CDL033
     C           PRTCD     IFNE '*NRF   '                                                     CDL033
     C           *LOCK     IN   LDA                                                           CDL033
     C                     MOVEL'SCSARDPD'DBFILE                                              CDL033
     C                     MOVEL'010'     DBASE                                               CDL033
     C                     MOVEL'CDL033  'DBKEY                                               CDL033
     C                     OUT  LDA                                                           CDL033
     C                     EXSR *PSSR                                                         CDL033
     C                     ENDIF                                                              CDL033
      *                                                                                       CDL033
     C                     ENDIF                                                              CDL033
      *                                                                   CDL006
      ** Access Switchable Features file to check if Dealing Fiducia      CDL006
      ** ry is installed.                                                 CDL006
      *                                                                   CDL006
     C                     MOVE 'N'       CDL006  1                       CDL006
     C                     CALL 'AOSARDR0'                                CDL006
     C                     PARM *BLANKS   WRTCD   7                       CDL006
     C                     PARM '*VERIFY' WOPTN   7                       CDL006
     C                     PARM 'CDL006'  WSARD   6                       CDL006
     C           SCSARD    PARM SCSARD    DSFDY                           CDL006
      *                                                                   CDL006
     C           WRTCD     IFNE *BLANKS                                   CDL006
     C           WRTCD     ANDNE'*NRF   '                                 CDL006
     C                     MOVEL'009'     DBASE             ************* CDL006
     C                     MOVEL'SCSARDPD'DBFILE            * DBERR 009 * CDL006
     C                     MOVELWRTCD     DBKEY             ************* CDL006
     C                     MOVE *ON       *INU7                           CDL006
     C                     MOVE *ON       *INU8                           CDL006
     C                     MOVE *ON       *INLR                           CDL006
     C                     EXSR *PSSR                                     CDL006
     C                     ENDIF                                          CDL006
      *                                                                   CDL006
     C           WRTCD     IFEQ *BLANK                                    CDL006
     C                     MOVEL'Y'       CDL006                          CDL006
     C                     ENDIF                                          CDL006
      *                                                                   CIR004
      ** Check if Dealing Calculation Method Change is switched ON        CIR004
      *                                                                   CIR004
     C                     MOVE 'N'       CIR004  1                       CIR004
     C                     CALL 'AOSARDR0'                                CIR004
     C                     PARM *BLANKS   WRTCD                           CIR004
     C                     PARM '*VERIFY' WOPTN                           CIR004
     C                     PARM 'CIR004'  WSARD                           CIR004
     C           SCSARD    PARM SCSARD    DSFDY                           CIR004
      *                                                                   CIR004
     C           WRTCD     IFNE *BLANKS                                   CIR004
     C           WRTCD     ANDNE'*NRF   '                                 CIR004
     C                     MOVEL'005'     DBASE             ************* CIR004
     C                     MOVEL'SCSARDPD'DBFILE            * DBERR 005 * CIR004
     C                     MOVEL'CIR004  'DBKEY             ************* CIR004
     C                     MOVE *ON       *INU7                           CIR004
     C                     MOVE *ON       *INU8                           CIR004
     C                     EXSR *PSSR                                     CIR004
     C                     ENDIF                                          CIR004
      *                                                                   CIR004
     C           WRTCD     IFEQ *BLANK                                    CIR004
     C                     MOVEL'Y'       CIR004                          CIR004
     C                     ENDIF                                          CIR004
      *                                                                   CIR004
      ***Call*access*program*for*General*Ledger*details.***************            MD035545 MD047993
      *****************************************************************            MD035545 MD047993
     C**********           CALL 'AOGELRR1'                                         MD035545 MD047993
     C**********           PARM '*MSG   ' @RTCD   7                                MD035545 MD047993
     C**********           PARM '*FIRST ' @OPTN   7                                MD035545 MD047993
     C********** SDGELR    PARM SDGELR    DSSDY                                    MD035545 MD047993
      *                                                                                     MD035545
     C********** @RTCD     IFNE *BLANK                                             MD035545 MD047993
     C**********           MOVEL'SDGELRPD'DBFILE                                   MD035545 MD047993
     C**********           MOVEL'062'     DBASE                                    MD035545 MD047993
     C**********           MOVEL@OPTN     DBKEY                                    MD035545 MD047993
     C**********           EXSR *PSSR                                              MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
      *                                                                                     MD035545
      ** Retrieve system value setting                                                      MD035545
      *                                                                                     MD035545
     C                     MOVELWPARML    P@OP01                                            MD035545
     C                     CALL 'AOSVALR0'                                                  MD035545
     C                     PARM *BLANKS   W0RTCD  7                                         MD035545
     C                     PARM           P@OP01 20                                         MD035545
     C                     PARM           P@VL01200                                         MD035545
     C                     PARM           P@OP02 20                                         MD035545
     C                     PARM           P@VL02200                                         MD035545
     C                     PARM           P@OP03 20                                         MD035545
     C                     PARM           P@VL03200                                         MD035545
     C                     PARM           P@OP04 20                                         MD035545
     C                     PARM           P@VL04200                                         MD035545
     C                     PARM           P@OP05 20                                         MD035545
     C                     PARM           P@VL05200                                         MD035545
     C                     PARM           P@OP06 20                                         MD035545
     C                     PARM           P@VL06200                                         MD035545
     C                     PARM           P@OP07 20                                         MD035545
     C                     PARM           P@VL07200                                         MD035545
     C                     PARM           P@OP08 20                                         MD035545
     C                     PARM           P@VL08200                                         MD035545
     C                     PARM           P@OP09 20                                         MD035545
     C                     PARM           P@VL09200                                         MD035545
     C                     PARM           P@OP10 20                                         MD035545
     C                     PARM           P@VL10200                                         MD035545
      *                                                                                     MD035545
      ** If system value is not found then default value to 'N'                             MD035545
      *                                                                                     MD035545
     C           W0RTCD    IFNE '       '                                                   MD035545
     C                     MOVE 'N'       WCALC6                                            MD035545
     C                     ELSE                                                             MD035545
     C                     MOVELP@VL01    WCALC6                                            MD035545
     C********** WCALC6    IFEQ 'Y'                                                MD035545 MD047993
     C********** BKALDI    ANDEQ'Y'                                                MD035545 MD047993
     C**********           MOVE 'Y'       WCALC6                                   MD035545 MD047993
     C**********           ELSE                                                    MD035545 MD047993
     C**********           MOVE 'N'       WCALC6                                   MD035545 MD047993
     C**********           ENDIF                                                   MD035545 MD047993
     C                     ENDIF                                                            MD035545
      *                                                                                     MD035545
     C/COPY WNCPYSRC,MM0194C003
     C*
     C** MOVE RUN DATE INTO RUNA TO SPLIT INTO FIELDS IN DATA STRUCTURE   LN0457
     C                     MOVELBJMRDT    RUNA                            LN0457
     C*
     C**  Convert run date to YYYYMMDD for deal done date
     C*********************Z-ADDRUND      @@DAYN           *1             S01194
     C                     Z-ADDBJRDNB    @@DAYN           *1             S01194
     C***********          EXSR ZA0710                     *1             056095
     C                     EXSR ZDATE9                     *1             056095
     C                     Z-ADD@@VDT     @DEALR  80       *1
     C*
     C****Read*file*FDICDRLL, format TABTB11.                             S01194
     C*********************MOVE *BLANKS   @KEY             *1             S01194
     C*********************MOVEL'01'      @KEY             *1             S01194
     C*********************MOVE '11'      @KEY             *1             S01194
     C***********@KEY******CHAINFDICDRLL             60    *1             S01194
     C*
     C****If*the*chain*fails*or*RECI*is not 'D' then it is a data base    S01194
     C****error.***********************                                   S01194
     C************IN60*****IFEQ '1'                        B*2            S01194
     C***********RECI******ORNE 'D'                        **2            S01194
     C*********************MOVE '1'       *INU7            **2            S01194
     C*********************MOVE '1'       *INU8            ***************S01194
     C*********************MOVEL'FDICDRLL'DBFILE           * DBERROR 001 *S01194
     C*********************MOVEL@KEY      DBKEY            ***************S01194
     C*********************MOVE '001'     DBASE            **2            S01194
     C*********************MOVE '1'       *INLR            **2            S01194
     C*********************MOVE '1'       *INKA            **2            S01194
     C*********************GOTO #A9                        **2            S01194
     C*********************END                             E*2            S01194
     C*
     C** Convert date of next working day to DDMMYYYY format
     C** for comparison with other dates
     C*********************Z-ADDDNWD      @@DAYN           *1             S01194
     C                     Z-ADDBJDNWD    @@DAYN           *1             S01194
     C***********          EXSR ZA0710                     *1             056095
     C                     EXSR ZDATE9                     *1             056095
     C                     Z-ADD@@VDT     @DNWD   80       *1
     C*
     C***ACCESS*FDINSTLL**************************************************S01319
     C***********1*********CHAINFDINSTLL*************60*****1*************S01319
     C********************************************************************S01319
     C***NO*LIVE*RECORD*ON*PF/FDINSTPP*THEN*DATABASE*ERROR****************S01319
     C************IN60*****IFEQ*'1'************************B*2************S01319
     C***********IDDLTF****OREQ*'*'**************************2************S01319
     C*********************MOVE*'005'*****DBASE***************************S01319
     C*********************MOVE*'FDINSTLL'DBFILE**************************S01319
     C*********************MOVE**BLANKS***DBKEY**************DBERROR*005**S01319
     C*********************MOVE*'1'********INU7***************************S01319
     C*********************MOVE*'1'********INU8***************************S01319
     C*********************MOVE*'1'********INLR*********************E14042S01319
     C*********************GOTO*#A9**************************2************S01319
     C*********************END*****************************E*2************S01319
     C*
     C***Load*key*used*to*access currencies file.                         S01194
     C*********************MOVE *BLANKS   @KEY             *1             S01194
     C*********************MOVEL'20'      @KEY             *1             S01194
     C*********************MOVE '1'       @KEY             *1             S01194
     C                     END                             E1
     C*
     C           #A9       ENDSR                           **#A9**
     C*
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*       TITLE:DETERMINE NEXT WORKING DAY.                       *
     C*                                                               *
     C********SUBROUTINE*ZA0730*EXPECTS*FIELD*'@@DTIN'*TO*BE***********   056095
     C*       SUBROUTINE ZA0730 EXPECTS FIELD 'ZZDTIN' TO BE          *   056095
     C*       PASSED TO IT IN 'YYYYMMDD' FORMAT.IT THEN DETERMINES    *
     C*       THE NEXT WORKING DAY AND RETURNS.                       *
     C*                                                               *
     C**INPUT**:@@DTIN*DATE*(YYYYMMDD)*-*IN*DATA*STRUCTURE*(SIZE*:*8N)*   056095
     C**********@@CCY  CURRENCY CODE   - IN FORMAT(3A)                *   S01195
     C* INPUT  :ZZDTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)*   056095
     C*                                                               *
     C* OUTPUT :@@VDT  DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)*
     C*                                                               *
     C**USES*:***@@MDNO*MIDAS*DAY*NO*USED*BY*SR*ZA0680*****************   056095
     C***********@@DAYN*MIDAS*DAY*NO*USED*BY*SR*ZA0710*****************   056095
     C***********@@MNO  MIDAS DAY NO USED BY SR ZA0830                *   S01195
     C***********@@HIND HOLIDAY IND.RETURNED BY ZA0830                *   S01195
     C* USES :   ZZMDNO MIDAS DAY NO USED BY SR ZDAT10                *   056095
     C*          @@DAYN MIDAS DAY NO USED BY SR ZDATE9                *   056095
     C*                                                               *
     C*****************************************************************
     C           ZA0730    BEGSR
     C*
     C* CONVERT YYYYMMDD FORMAT TO MIDAS DAY NO.
     C*
     C***********          EXSR ZA0680                                    056095
     C                     EXSR ZDAT10                                    056095
     C*
     C           ZA0731    TAG
     C*
     C***********          ADD  1         @@MDNO  50                      056095
     C                     ADD  1         ZZMDNO  50                      056095
     C*
     C* CHECK IF DAY NO. IS A HOLIDAY          .
     C*
     C*********************Z-ADD@@MDNO    @@MNO   50                      S01195
     C***********          Z-ADD@@MDNO    ZDAYNO  50                S01195056095
     C                     Z-ADDZZMDNO    ZDAYNO  50                      056095
     C*
     C*********************EXSR ZA0830                                    S01195
     C                     EXSR ZCHKH                                     S01195
     C*
     C***********@@HIND****IFEQ 'H'                                       S01195
     C           ZIND      IFEQ 'H'                                       S01195
     C                     GOTO ZA0731
     C                     END
     C*
     C* CONVERT MIDAS DAY NO. TO YYYYMMDD FORMAT.
     C*
     C***********          Z-ADD@@MDNO    @@DAYN  50                      056095
     C                     Z-ADDZZMDNO    @@DAYN  50                      056095
     C*
     C***********          EXSR ZA0710                                    056095
     C                     EXSR ZDATE9                                    056095
     C*
     C           ZA0739    ENDSR                                       **
      /EJECT
     C*****************************************************************
     C*   MM1003 - CALCULATE A PERIOD DATE                            *
     C*                                                               *
     C*   PERIOD DATES ARE CALCULATED FOR THE FOLLOWING PERIODS       *
     C*      PERIOD TYPE       PERIOD NUMBER     PERIOD SHORTNAME     *
     C*           D                 -1             OVERNIGHT          *
     C*           D                  0             TOMORROW / NEXT    *
     C*           D                  1             SPOT / NEXT        *
     C*           W                  1             1 WEEK             *
     C*           W                  2             2 WEEK             *
     C*           W                  3             3 WEEK             *
     C*           M                  1             1 MONTH            *
     C*           M                  2             2 MONTH            *
     C*           M                  3             3 MONTH            *
     C*           M                  6             6 MONTH            *
     C*           M                  9             9 MONTH            *
     C*           Y                  1             1 YEAR             *
     C*                                                               *
     C*  CALLED BY    -                                               *
     C*                                                               *
     C*  CALLS        -                                               *
     C*                                                               *
     C*  ZA0770       - CONVERT DATE YYYYMMDD TO DDMMYY               *
     C***ZA0830*******-*CHECK*IF*DAY IS A WORKING DAY                 *   S01195
     C*  ZA0730       - FIND NEXT WORKING DAY                         *
     C***ZA0710*******-*CONVERT*MIDAS*DAY*NO*TO*YYYYMMDD***************   056095
     C***ZA0680*******-*CONVERT*DATE*TO*MIDAS*DAY*NUMBER***************   056095
     C*  ZDATE9       - CONVERT MIDAS DAY NO TO YYYYMMDD              *   056095
     C*  ZDAT10       - CONVERT DATE TO MIDAS DAY NUMBER              *   056095
     C*                                                               *
     C*  CALLS PROGRAM ZA0270 CONVERT DATE TO MIDAS DAY NUMBER WITH   *
     C*                VALIDATION CHECK                               *
     C*                                                               *
     C*  FIELDS INPUT -                                               *
     C*                                                               *
     C*  @@CCY   3    - CURRENCY                                      *
     C*  @@SPOT  8    - MONEY MARKET SPOT DATE                        *
     C*  @@PNUM  1,0  - PERIOD NUMBER                                 *
     C*  @@PTYP  1    - PERIOD TYPE                                   *
     C*  RUND    5,0  - MIDAS RUN DATE                                *
     C*                                                               *
     C*  FIELDS OUTPUT                                                *
     C*                                                               *
     C*  @@PDAT  8,0  - PERIOD DATE                                   *
     C*                                                               *
     C*  WORK FIELDS                                                  *
     C*                                                               *
     C*  @@DTIN  8,0  - DATE INPUT TO ZA0770 IN YYYYMMDD FORMAT       *
     C*  ZZDTIN  8,0  - DATE INPUT TO ZDAT10 IN YYYYMMDD FORMAT       *   056095
     C*  @@DFMT  1    - DATE FORMAT                                   *
     C*  @@RTNC  1    - RETURN INDICATOR FROM ZA0270                  *
     C*  @@DAYN  5,0  - MIDAS DAY NUMBER                              *
     C***@@MNO***5,0  - MIDAS DAY NUMBER                              *   S01195
     C***@@HIND**1    - HOLIDAY INDICATOR H OR W                      *   S01195
     C*  @@ADD   3,0  - CALCULATION WORK FIELD                        *
     C***@@VDT***8,0**-*DATE*OUTPUT*FROM*ZA0710************************   056095
     C*  @@VDT   8,0  - DATE OUTPUT FROM ZDATE9                       *   056095
     C*  @@RUND  8    - RUN DATE IN YYYYMMDD FORMAT                   *
     C*                                                               *
     C*****************************************************************
     C*
     C           MM1003    BEGSR
     C*
     C                     Z-ADD*ZERO     @@STRT
     C                     Z-ADD*ZERO     @@DTIN
     C                     Z-ADD*ZERO     ZZDTIN                          056095
     C                     Z-ADD*ZERO     @@SPDD
     C                     Z-ADD*ZERO     @@DATE
     C                     Z-ADD*ZERO     @@DTOU
     C                     Z-ADD*ZERO     @@Z71Y
     C                     Z-ADD*ZERO     @@VDT
     C*
     C                     MOVE @@SPOT    @@SPDD
     C**  SET UP STARTING POINT DATE AS SPOT DATE
     C                     Z-ADD@@SPDD    @@STRT
     C*
     C**  ADD PERIOD NUMBERS TO DATE
     C           @@PTYP    IFEQ 'M'                        B1
     C                     ADD  @@PNUM    @@STMT           *1
     C           @@STMT    IFGT 12                         B*2
     C                     SUB  12        @@STMT           **2
     C                     ADD  1         @@STYR           **2
     C                     END                              *2
     C                     END                             E1
     C*
     C           @@PTYP    IFEQ 'Y'                        B1
     C                     ADD  1         @@STYR           *1
     C                     END                             E1
     C*
     C**  CONVERT DATE FORMAT FROM YYYYMMDD TO DDMMYY
     C                     Z-ADD@@STRT    @@DTIN
     C                     EXSR ZA0770
     C                     Z-ADD@@DTOU    @@DATE
     C*
     C           *LIKE     DEFN @@VDT     @@RUND
     C           @@RUND    IFEQ *ZERO                      B1
     C*********************Z-ADDRUND      @@DTIN           *1             S01194
     C***********          Z-ADDBJRDNB    @@DTIN           *1       S01194056095
     C***********          EXSR ZA0710                     *1             056095
     C                     Z-ADDBJRDNB    @@DAYN           *1             056095
     C                     EXSR ZDATE9                     *1             056095
     C                     Z-ADD@@VDT     @@RUND           *1
     C                     END                             E1
     C*
     C                     MOVEL'D'       @@DFMT  1
     C                     MOVE @@DATE    @@DATC  60
     C*
     C**  CONVERT STARTING DATE TO MIDAS DAY NUMBER FORMAT
     C           @@RTNC    DOUEQ'0'                        B1
     C                     CALL 'ZA0270'                   *1
     C                     PARM           @@DATC           *1
     C*********************PARM           DATF             *1             S01194
     C                     PARM           BJDFIN           *1             S01194
     C           @@RTNC    PARM           @@RTNC  1        *1
     C           @@DAYN    PARM           @@DAYN  50       *1
     C*
     C                     SUB  1         @@DAY2           *1
     C                     MOVE @@DATE    @@DATC           *1
     C*
     C                     END                             E1
     C*
     C*********************Z-ADD@@DAYN    @@MNO                           S01195
     C                     Z-ADD@@DAYN    ZDAYNO                          S01195
     C                     MOVEL@@RTNC    @@RTN
     C*
     C**  RESET STARTING POINT
     C***********          EXSR ZA0710                              ME1161056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     @@STRT                    ME1161
     C*
     C**  PROCESS PERIOD TYPE 'D'
     C           @@PTYP    IFEQ 'D'                        B1
     C*
     C**  IF PERIOD NUMBER = 1 FIND NEXT WORKING DAY
     C           @@PNUM    IFEQ 1                          B*2
     C***********@@HIND****DOUEQ'W'                        B**3           S01195
     C           ZIND      DOUEQ'W'                        B**3           S01195
     C*********************ADD  1         @@MNO            ***3           S01195
     C                     ADD  1         ZDAYNO           ***3           S01195
     C*********************EXSR ZA0830                     ***3           S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              **3
     C                     END                              *2
     C*
     C**  IF PERIOD NUMBER NE 1 FIND TOMORROW/NEXT DAY (AND OVERNIGHT)
     C**  IE FIND NEXT WORKING DAY BEYOND RUND
     C           @@PNUM    IFLT 1                          B*2
     C***********          Z-ADD@@RUND    @@DTIN           **2            056095
     C                     Z-ADD@@RUND    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
     C                     Z-ADD@@VDT     @@PDAT           **2
     C                     END                              *2
     C*
     C**  IF PERIOD NUMBER IS -1 FIND NEXT WORKING DAY TOMM/NEXT.
     C**  IE FIND NEXT WORKING DAY BEYOND RUND
     C           @@PNUM    IFEQ 0                          B*2
     C***********          Z-ADD@@PDAT    @@DTIN           **2            056095
     C                     Z-ADD@@PDAT    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
     C                     Z-ADD@@VDT     @@PDAT           **2
     C                     END                              *2
     C*
     C                     END                             E1
     C*
     C**  PROCESS PERIOD TYPE 'W'
     C           @@PTYP    IFEQ 'W'                        B1
     C*
     C**  INCREMENT DAY NUMBER
     C           @@PNUM    MULT 7         @@ADD   30       *1
     C*********************ADD  @@ADD     @@MNO            *1             S01195
     C                     ADD  @@ADD     ZDAYNO           *1             S01195
     C*
     C**  FIND NEXT WORKING DAY
     C*********************EXSR ZA0830                     *1             S01195
     C                     EXSR ZCHKH                      *1             S01195
     C***********@@HIND****DOWEQ'H'                        B*2            S01195
     C           ZIND      DOWEQ'H'                        B*2            S01195
     C*********#***********ADD  1         @@MNO            **2            S01195
     C                     ADD  1         ZDAYNO           ***3           S01195
     C*********************EXSR ZA0830                     **2            S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              *2
     C                     END                             E1
     C*
     C**  PROCESS PERIOD TYPE 'M' OR 'Y'
     C           @@PTYP    IFEQ 'M'                        B1
     C           @@PTYP    OREQ 'Y'                        *1
     C*
     C**  IS SPOT LAST WORKING DAY IN MONTH
     C***********          Z-ADD@@SPDD    @@DTIN           *1             056095
     C                     Z-ADD@@SPDD    ZZDTIN           *1             056095
     C                     EXSR ZA0730                     *1
     C           @@SPMT    IFNE @@Z71M                     B*2
     C                     Z-ADD1         @@STDY           **2
     C           @@STMT    IFEQ 12                         B**3
     C                     Z-ADD1         @@STMT           ***3
     C                     ADD  1         @@STYR           ***3
     C                     ELSE                            X**3
     C                     ADD  1         @@STMT           ***3
     C                     END                              **3
     C*
     C**  CONVERT STARTING DATE TO MIDAS DAY NUMBER FORMAT
     C***********          Z-ADD@@STRT    @@DTIN           **2            056095
     C***********          EXSR ZA0680                     **2            056095
     C*********************Z-ADD@@MDNO    @@MNO            **2            S01195
     C***********@@HIND****DOUEQ'W'                        B**3           S01195
     C*********************SUB  1         @@MNO            ***3           S01195
     C*********************EXSR ZA0830                     ***3           S01195
     C***********          Z-ADD@@MDNO    ZDAYNO           **2      S01195056095
     C                     Z-ADD@@STRT    ZZDTIN           **2            056095
     C                     EXSR ZDAT10                     **2            056095
     C                     Z-ADDZZMDNO    ZDAYNO           **2            056095
     C           ZIND      DOUEQ'W'                        B**3           S01195
     C                     SUB  1         ZDAYNO           ***3           S01195
     C                     EXSR ZCHKH                      ***3           S01195
     C                     END                              **3
     C                     GOTO M10038                     **2
     C                     END                              *2
     C*
     C**  IF THE STARTING POINT DAY IS A NON WORKING DAY AND THE NEXT
     C**  WORKING DAY FALLS IN THE NEXT MONTH  FIND LAST WORKING DAY
     C**  IN STARTING MONTH.
     C***********          Z-ADD@@STRT    @@DTIN           *1       ME1161056095
     C***********          EXSR ZA0680                     *1       ME1161056095
     C*********************Z-ADD@@MDNO    @@MNO            *1       ME1161S01195
     C*********************EXSR ZA0830                     *1             S01195
     C***********@@HIND****IFEQ 'H'                        B*2            S01195
     C***********          Z-ADD@@MDNO    ZDAYNO           *1 ME1161S01195056095
     C                     Z-ADD@@STRT    ZZDTIN           *1             056095
     C                     EXSR ZDAT10                     *1             056095
     C                     Z-ADDZZMDNO    ZDAYNO           *1             056095
     C                     EXSR ZCHKH                      *1             S01195
     C           ZIND      IFEQ 'H'                        B*2            S01195
     C***********          Z-ADD@@STRT    @@DTIN           **2            056095
     C                     Z-ADD@@STRT    ZZDTIN           **2            056095
     C                     EXSR ZA0730                     **2
     C*
     C           @@STMT    IFNE @@Z71M                     B**3
     C***********@@HIND****DOUEQ'W'                        B***4          S01195
     C*********************SUB  1         @@MNO            ****4          S01195
     C*********************EXSR ZA0830                     ****4          S01195
     C           ZIND      DOUEQ'W'                        B***4          S01195
     C                     SUB  1         ZDAYNO           ****4          S01195
     C                     EXSR ZCHKH                      ****4          S01195
     C                     END                              ***4
     C                     END                              **3
     C                     GOTO M10038                     ***3     ME1161
     C                     END                              *2
     C*
     C**  IF STARTING DATE IS A WORKING DAY IN CURRENCY & SPOT DATE
     C**  IS NOT LAST WORKING DAY IN MONTH PERIOD DATE IS STARTING DAY
     C                     Z-ADD@@STRT    @@PDAT           *1
     C                     GOTO M10039                     *1
     C*
     C                     END                             E1
     C*
     C           M10038    TAG
     C*
     C**  CONVERT DATE TO YYYYMMDD FORMAT
     C*********************Z-ADD@@MNO     @@DAYN                          S01195
     C                     Z-ADDZDAYNO    @@DAYN                          S01195
     C***********          EXSR ZA0710                                    056095
     C                     EXSR ZDATE9                                    056095
     C                     Z-ADD@@VDT     @@PDAT  80
     C*
     C                     GOTO M10039
     C*
     C                     Z-ADD0         @@PNUM  10
     C                     MOVE *BLANKS   @@PTYP  1
     C                     MOVE *BLANKS   @@SPOT  8
     C*
     C           M10039    ENDSR
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*  SUBROUTINE ZA0770 - THIS SUBROUTINE RECEIVES A 8/0 INPUT     *
     C*                      DATE - FORMAT YYYYMMDD AND OUTPUTS A     *
     C*                      6/0 DATE. IF FIELD DATF ON TABTB10 =     *
     C*                      'M' OUTPUT FORMAT MMDDYY. IF FIELD       *
     C*                      DATF = 'D' OUTPUT FORMAT DDMMYY.         *
     C*                                                               *
     C*  CALLED BY   :                                                *
     C*                                                               *
     C*  INPUT       : @@DTIN  - DATE INPUT (8,0)                     *
     C*  OUTPUT      : @@DTOU  - DATE OUTPUT (6,0)                    *
     C*                                                               *
     C*  WORK FIELDS : @@YYY   - YEAR IN (2,0)                        *
     C*              : @@MM    - MONTH IN (2,0)                       *
     C*              : @@DD    - DAY IN (2,0)                         *
     C*                                                               *
     C*              : @@DAT1  - IF DATE DD/MM/YY DAY ELSE MONTH (2,0)*
     C*              : @@DAT2  - IF DATE DD/MM/YY MONTH ELSE DAY (2,0)*
     C*                                                               *
     C*****************************************************************
     C           ZA0770    BEGSR
     C*
     C**  DATF = 'D' CONVERT TO MMDDYY FORMAT
     C***********DATF******IFEQ 'D'                        B1             S01194
     C           BJDFIN    IFEQ 'D'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT1           *1
     C                     Z-ADD@@MM      @@DAT2           *1
     C                     END                             E1
     C*
     C*
     C**  DATF = 'M' CONVERT TO MMDDYY FORMAT
     C***********DATF******IFEQ 'M'                        B1             S01194
     C           BJDFIN    IFEQ 'M'                        B1             S01194
     C                     Z-ADD@@DD      @@DAT2           *1
     C                     Z-ADD@@MM      @@DAT1           *1
     C                     END                             E1
     C*
     C                     Z-ADD@@YYY     @@YYYO
     C*
     C           ZA0779    ENDSR                           ***ZA0779***
     C/EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDAT10Z2                                               056095
     C*******************************************************************
     C***********                                                         056095
     C**ZA0680*-*THIS SUBROUTINE CONVERTS YYYYMMDD FORMAT DATE TO         056095
     C***********MIDAS DAY NUMBER FORMAT (NO. DAYS FROM 31/12/71)         056095
     C***********                                                         056095
     C**CALLED*BY :                                                       056095
     C***********                                                         056095
     C**CALLS*:**                                                         056095
     C***********                                                         056095
     C**INPUT**:*@@DTIN DATE (YYYYMMDD) - IN DATA STRUCTURE (SIZE : 8N)   056095
     C***********                                                         056095
     C**OUTPUT*:*@@MDNO MIDAS DAY NUMBER  (SIZE : 5N)                     056095
     C***********                                                         056095
     C**USES*:***@@CC   NUMBER OF CENTURIES IN DATE                       056095
     C***********@@DAY  DAY NUMBER                                        056095
     C***********@@REM  REMAINDER FROM DIVIDE                             056095
     C***********@@MTH  MONTH NUMBER                                      056095
     C***********@MD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       MONTH                                             056095
     C***********@@WK2  WORK FIELD (2,0)                                  056095
     C***********@@WK5  WORK FIELD (5,0)                                  056095
     C***********@@YYYY YEAR (4 CHARACTER)                                056095
     C***********@@YY   YEAR (2 CHARACTER)                                056095
     C***********@YD    COMPILATION TIME ARRAY FOR CUMULATIVE DAYS IN     056095
     C***********       A FOUR YEAR PERIOD                                056095
     C***********                                                         056095
     C******LAST*AMEND NO. ME1257              DATE 02/04/87            * 056095
     C******When*date input is zero set output date to zeroes           * 056095
     C***********                                                         056095
     C******************************************************************* 056095
     C***********                                                         056095
     C***********ZA0680    BEGSR                                          056095
     C***********                                                         056095
     C****CLEAR*OUT ANY 'OLD' DATA IN FIELD                               056095
     C***********          Z-ADD0         @@MDNO  50                      056095
     C***********                                                         056095
     C***********@@DTIN    CABEQ0         ZA0689                          056095
     C***********                                                         056095
     C*****IF*DATE GREATER THAN 31/12/2071 NEED EXTRA PROCESSING          056095
     C*****WORK*OUT THE NUMBER OF CENTURIES PASSED SINCE 1971,            056095
     C*****BY*SUBTRACTING 1972 FROM THE YEAR FIELD.                       056095
     C***********@@YYYY    IFGE 2072                       B1             056095
     C***********@@YYYY    SUB  1972      @@YYYY           *1             056095
     C***********                                                         056095
     C*****MULTIPLY BY NUMBER OF DAYS IN CENTURY (SINCE 1971)             056095
     C*****THEN*RESTORE THE YEAR WHICH WAS INPUT BACK TO THE              056095
     C*****ORIGINAL VALUE BEFORE CONTINUING WITH NORMAL CALCULATIONS.     056095
     C***********                                                         056095
     C***********@@CC      MULT 36524     @@MDNO           *1             056095
     C***********@@YYYY    ADD  1972      @@YYYY           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C***********@@YYYY    ADD  28        @@WK2   20                      056095
     C***********                                                         056095
     C***********@@WK2     DIV  4         @@WK2                           056095
     C***********          MVR            @@REM   10                      056095
     C***********                                                         056095
     C******MULTIPLY BY NUMBER OF DAYS IN FOUR YEAR PERIOD                056095
     C***********@@WK2     MULT 1461      @@WK5   50                      056095
     C***********          ADD  @@WK5     @@MDNO                          056095
     C***********                                                         056095
     C****CHECK*REMAINDER AND MONTH NUMBER                                056095
     C***********@@REM     IFEQ 0                          B1             056095
     C***********@@MTH     ANDGT2                          B1             056095
     C***********          ADD  1         @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****YEAR*NOT LEAP YEAR,  ADD CUMULATIVE DAYS FOR YEAR               056095
     C***********@@REM     IFNE 0                          B1             056095
     C***********          ADD  @YD,@@REM @@MDNO           *1             056095
     C***********          END                             E1             056095
     C***********                                                         056095
     C****ADD*MONTHS THIS YEAR                                            056095
     C***********          ADD  @MD,@@MTH @@MDNO                          056095
     C***********                                                         056095
     C****ADD*DAYS THIS MONTH                                             056095
     C***********          ADD  @@DAY     @@MDNO                          056095
     C***********                                                         056095
     C***********ZA0689    ENDSR                           **ZA0689 TAG** 056095
     C*****************************************************************
      /EJECT
     C*                                                                   056095
     C/COPY ZSRSRC,ZDATE9Z3                                               056095
     C/COPY ZSRSRC,ZFEB29                                                                     CDL093
     C*****************************************************************
     C***********                                                     *   056095
     C********TITLE:CALCULATE MIDAS DAY NO. TO DRS (YYYYMMDD) FORMAT. *   056095
     C***********                                                     *   056095
     C********SUBROUTINE ZA0710 EXPECTS FIELD '@@DAYN' TO BE          *   056095
     C********PASSED TO IT IN 5,0 FORMAT.IF THE ABOVE FIELD IS LESS   *   056095
     C********THAN 1 IT RETURNS 1 IN FIELD '@@RTN'.THE MAIN PROGRAM   *   056095
     C********SHOULD CHECK FOR THIS CONDITION AND DO THE NECESSARY.   *   056095
     C********IF*'@@RTN' IS NOT EQUAL TO 1 IT RETURNS THE FIELD       *   056095
     C********'@@VDT'  IN 'YYYYMMDD' FORMAT.                          *   056095
     C***********                                                     *   056095
     C**NOTE:*FIELD TO BE DEFINED BY EXTERNAL ROUTINE IS                  056095
     C***********                                                     *   056095
     C********1)*@@DAYN   LENGTH 5,0.                                 *   056095
     C***********                                                     *   056095
     C********FIELDS USED AND ALREADY DEFINED IN THE ROUTINE ARE:     *   056095
     C***********                                                     *   056095
     C********1)*@@VDT    LENGTH 8,0 DEFINED BY A DS.                 *   056095
     C********2)*@@RTN    LENGTH 1,0.                                 *   056095
     C********3)*@@I      LENGTH 2,0 USED TO ACCESS ARRAY @YD         *   056095
     C********4)*@@J      LENGTH 2,0 USED TO ACCESS ARRAY @MD         *   056095
     C********5)*@@Z71Y   LENGTH 4,0 DEFINED BY A DS.                 *   056095
     C********6)*@@RDAY   LENGTH 5,0.                                 *   056095
     C********7)*@@LEAP   LENGTH 1,0.                                     056095
     C***********                                                     *   056095
     C********INDICATORS USED ARE:                                    *   056095
     C***********                                                     *   056095
     C********1)*80       CHECK FOR LOW AND EQUAL ON ARRAY @YD        *   056095
     C********2)*81       CHECK FOR LOW ON ARRAY @MD.                 *   056095
     C***********                                                     *   056095
     C**INPUT*FIELD:       @@DAYN                                     *   056095
     C***********                                                     *   056095
     C**OUTPUT*FIELD:      @@VDT                                      *   056095
     C***********                                                     *   056095
     C**WORK*FIELDS:       @@RTN                                      *   056095
     C***********          @@Z71Y                                     *   056095
     C***********          @@RDAY                                     *   056095
     C***********          @@LEAP                                     *   056095
     C***********          @@I                                        *   056095
     C***********          @@J                                        *   056095
     C***********                                                     *   056095
     C**ARRAYS*USED:       @YD COMPILE TIME ARRAY.                        056095
     C***********          @MD COMPILE TIME ARRAY.                        056095
     C***********                                                         056095
     C******LAST*AMEND NO. ME1257              DATE 02/04/87          *   056095
     C******When*date input is zero set output date to zeroes         *   056095
     C***********                                                     *   056095
     C*****************************************************************   056095
     C***********                                                         056095
     C***********ZA0710    BEGSR                                          056095
     C***********                                                         056095
     C***********          SETOF                     8081                 056095
     C***********          Z-ADD0         @@RTN   10                      056095
     C***********          Z-ADD0         @@VDT                           056095
     C***********          Z-ADD1         @@I     20                      056095
     C***********          Z-ADD1         @@J     20                      056095
     C***********          Z-ADD1         @@LEAP  10                      056095
     C***********                                                         056095
     C***********@@DAYN    CABEQ0         ZA0719                          056095
     C***********                                                         056095
     C***********@@DAYN    IFLT 1                                         056095
     C***********          Z-ADD1         @@RTN                           056095
     C***********          GOTO ZA0719                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**DIVISION*TO DETERMINE WETHER LEAP YEAR.                           056095
     C***********                                                         056095
     C***********@@DAYN    DIV  1461      @@Z71Y                          056095
     C***********          MVR            @@RDAY  50                      056095
     C***********                                                         056095
     C**CALCULATING YEAR.                                                 056095
     C***********                                                         056095
     C***********@@Z71Y    MULT 4         @@Z71Y                          056095
     C***********          ADD  1972      @@Z71Y                          056095
     C***********                                                         056095
     C**CHECKING*IF YEAR IS GREATER THAN OR EQUAL TO 2100                 056095
     C***********                                                         056095
     C***********@@Z71Y    IFGE 2100                                      056095
     C***********          ADD  @@SSY2    @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOKUP*ARRAY @YD TO SEE HOW MANY YEARS OF A FOUR YEAR CYCLE        056095
     C**HAVE*PASSED.                                                      056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@YD,@@I                8080               056095
     C***********                                                         056095
     C**IF*YEAR*IS A LEAP YEAR SSLEAP IS SET TO ZERO.                     056095
     C***********                                                         056095
     C************IN80     IFEQ '0'                                       056095
     C***********          Z-ADD0         @@LEAP                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**ADD*INDEX TO YEAR TO GIVE CORRECT YEAR AND ADJUST '@@RDAY'.       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 1                                         056095
     C***********@@RDAY    SUB  @YD,@@I   @@RDAY                          056095
     C***********          ADD  @@I       @@Z71Y                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C**PROCESSING FOR A LEAP YEAR.                                       056095
     C***********                                                         056095
     C***********@@LEAP    IFEQ 0                                         056095
     C***********                                                         056095
     C**IF*'@@RDAY' = 60 DATE MUST BE 29TH OF FEBRUARY.                   056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 60                                        056095
     C***********          Z-ADD29        @@Z71D                          056095
     C***********          Z-ADD2         @@Z71M                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*'@@RDAY' > 60 DATE IS AFTER 29TH OF FEBRUARY,CONVERSION CAN    056095
     C**PROCEED*AS USUAL AFTER SUBTRACTING THE EXTRA DAY FOR THE LEAP     056095
     C**YEAR.*NOTE : '@@RDAY' < 60 CONVERSION PROCEEDS AS USUAL.          056095
     C***********                                                         056095
     C***********@@RDAY    IFGT 60                                        056095
     C***********@@RDAY    SUB  1         @@RDAY                          056095
     C***********          END                                            056095
     C***********                                                         056095
     C***********          END                                            056095
     C***********                                                         056095
     C**IF*DAY*'@@DAYN' IS EXACTLY DIVISIBLE BY 1461 (NUMBER OF DAYS      056095
     C**IN*4*YEARS) THEN DATE MUST BE LAST DAY OF PREVIOUS FOUR YEAR      056095
     C**GROUP.***                                                         056095
     C***********                                                         056095
     C***********@@RDAY    IFEQ 0                                         056095
     C***********          Z-ADD31        @@Z71D                          056095
     C***********          Z-ADD12        @@Z71M                          056095
     C***********          SUB  1         @@Z71Y                          056095
     C***********          GOTO ZA0711                                    056095
     C***********          END                                            056095
     C***********                                                         056095
     C**LOOK*UP*ARRAY ARRAY @MD TO DETERMINE WHICH MONTH '@@RDAY'         056095
     C**OCCURS*IN                                                         056095
     C***********                                                         056095
     C***********@@RDAY    LOKUP@MD,@@J                81                 056095
     C***********          Z-ADD@@J       @@Z71M                          056095
     C***********@@RDAY    SUB  @MD,@@J   @@Z71D                          056095
     C***********                                                         056095
     C**DS*@@VDT* IS RETURNED IN YYYYMMDD FORMAT                          056095
     C***********                                                         056095
     C***********ZA0711    TAG                                            056095
     C***********                                                         056095
     C***********          MOVE @@Z71Y    @@YR                            056095
     C***********                                                         056095
     C***********ZA0719    ENDSR                                          056095
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* #BC      - Load period dates array                            *
     C*                                                               *
     C**CALLS****ZA0710***-*Convert*midas*day*no.*to*YYYYMMDD*format***   056095
     C* CALLS    ZDATE9   - Convert midas day no. to YYYYMMDD format  *   056095
     C*          ZA0730   - Determine next working day                *
     C*          MM1003   - Calculate a period date                   *
     C***********ZA0680***-*Convert*YYYYMMDD*to*a*midas*day*number*****   056095
     C*          ZDAT10   - Convert YYYYMMDD to a midas day number    *   056095
     C*                                                               *
     C* CALLED BY  #B     - Main processing                           *
     C*                                                               *
     C* FLDS USED  @CCY   - Currency                                  *
     C*            @KEY   - Key to currencies file                    *
     C*            @@SPOT - MM spot date YYYYMMDD                     *
     C*            @@RUND - Run date YYYYMMDD                         *
     C*            @@DAYN - Midas day number                          *
     C*************@@VDT**-*Date*output*from*ZA0710********************   056095
     C*************@@DTIN*-*Input*date*********************************   056095
     C*            @@VDT  - Date output from ZDATE9                   *   056095
     C*            ZZDTIN - Input date                                *   056095
     C*            @@CCY  - Currency                                  *
     C*************@@MDNO*-*Midas*day*number*workfield*****************   056095
     C*            ZZMDNO - Midas day number workfield                *   056095
     C*            @PR    - Period dates array                        *
     C*            @@PNUM - Period number                             *
     C*            @@PTYP - Period type                               *
     C*            @@PDAT - Period date                               *
     C*                                                               *
     C*****************************************************************
     C           #BC       BEGSR
     C*
     C** Details required by MM1013 calculate period dates
     C*
     C*********************MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C*
     C** If period dates have not been calculated for this currency,
     C** then load period dates array
     C           @@RUND    IFEQ *ZERO                      B1
     C*********************Z-ADDRUND      @@DAYN           *1             S01194
     C                     Z-ADDBJRDNB    @@DAYN           *1             S01194
     C***********          EXSR ZA0710                     *1             056095
     C                     EXSR ZDATE9                     *1             056095
     C                     Z-ADD@@VDT     @@RUND           *1
     C                     END                             E1
     C*
     C** Calculate today period date.
     C***********          Z-ADD@@RUND    @@DTIN                          056095
     C                     Z-ADD@@RUND    ZZDTIN                          056095
     C*********************MOVE @CCY      @@CCY                           S01195
     C                     MOVE @CCY      ZCCY                            S01195
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         @PR,1                           056095
     C           ZZMDNO    SUB  1         @PR,1                           056095
     C*
     C** Calculate D1 period date.
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         @PR,2                           056095
     C           ZZMDNO    SUB  1         @PR,2                           056095
     C*
     C** Calculate D2 period date.
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         @PR,3                           056095
     C           ZZMDNO    SUB  1         @PR,3                           056095
     C*
     C** Calculate D3 period date.
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         @PR,4                           056095
     C           ZZMDNO    SUB  1         @PR,4                           056095
     C*
     C** Calculate D4 period date.
     C***********          Z-ADD@@VDT     @@DTIN                          056095
     C                     Z-ADD@@VDT     ZZDTIN                          056095
     C                     EXSR ZA0730
     C***********@@MDNO    SUB  1         @PR,5                           056095
     C           ZZMDNO    SUB  1         @PR,5                           056095
     C*
     C** Calculate W1 period date.
     C                     Z-ADD1         @@PNUM  10
     C                     MOVE 'W'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         @PR,6                           056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         @PR,6                           056095
     C*
     C** Calculate M1 period date.
     C                     Z-ADD1         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         @PR,7                           056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         @PR,7                           056095
     C*
     C** Calculate M2 period date.
     C*********************MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD2         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         @PR,8                           056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         @PR,8                           056095
     C*
     C** Calculate M3 period date.
     C*********************MOVE MSPD      @@SPOT                          S01194
     C                     MOVE A6MMSD    @@SPOT                          S01194
     C                     Z-ADD3         @@PNUM
     C                     MOVE 'M'       @@PTYP
     C                     EXSR MM1003
     C***********          Z-ADD@@PDAT    @@DTIN                          056095
     C***********          EXSR ZA0680                                    056095
     C***********@@MDNO    SUB  1         @PR,9                           056095
     C                     Z-ADD@@PDAT    ZZDTIN                          056095
     C                     EXSR ZDAT10                                    056095
     C           ZZMDNO    SUB  1         @PR,9                           056095
     C*
     C           #BC9      ENDSR                           **#BC9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C********                                                        *
     C********SUBROUTINE ZA0150 - THIS SUBROUTINE CHAINS TO FILE LF/  *   S01194
     C********FDICDRLL TO GET THE INSTALLATION CONTROL DETAILS RECORD *   S01194
     C********1 (HELD ON PF/TABTB10)                                  *   S01194
     C********INDICATOR 80 IS SET ON IF THE CHAIN FAILS OR THE RECORD *   S01194
     C********IS FLAGGED FOR DELETION.                                *   S01194
     C********IF INDICATOR 80 IS SET ON DETAILS OF THE ATTEMPTED      *   S01194
     C********ACCESS ARE PLACED IN THE LDA.                           *   S01194
     C*********                                                       *   S01194
     C********FIELDS USED : SS0150 - KEY USED TO ACCESS FDICDRLL      *   S01194
     C***********                                                     *   S01194
     C*****************************************************************   S01194
     C***********                                                         S01194
     C***********ZA0150    BEGSR                                          S01194
     C***********                                                         S01194
     C** SET*UP*KEY*TO*OBTAIN*FORMAT TABTB10F '01        10'              S01194
     C*********************MOVEL'01'      SS0150 12                       S01194
     C*********************MOVE '10'      SS0150                          S01194
     C************                                                        S01194
     C***CHAIN*TO*FILE*FDICDRLL                                           S01194
     C***********SS0150****CHAINFDICDRLL             80                   S01194
     C***********RECI******IFNE 'D'                        B1             S01194
     C*********************MOVE '1'       *IN80            *1             S01194
     C*********************END                             E1             S01194
     C*                                                                   S01194
     C** DEAL WITH DATA BASE ERROR                                        S01194
     C************IN80*****IFEQ '1'                        ***************S01194
     C*********************MOVEL'FDICDRLL'DBFILE           *             *S01194
     C*********************MOVEL'900'     DBASE            * DBERROR 900 *S01194
     C*********************MOVELSS0150    DBKEY            *             *S01194
     C*********************MOVE '1'       *INU7            ***************S01194
     C*********************MOVE '1'       *INU8            *1             S01194
     C*********************MOVE '1'       *INLR                     E14042S01194
     C*********************END                             E1             S01194
     C*********************                                               S01194
     C***********ZA0159****ENDSR                                          S01194
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* INFSR    - Unmonitored file error                             *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @ERR2  - Error routine performed indicator         *
     C*            @TERM  - Termination parameter                     *
     C*            @FILE  - File in error                             *
     C*                                                               *
     C*****************************************************************
     C           INFSR     BEGSR
     C*
     C**  Set @ERR2 to 'Y' to prevent looping if further errors occur.
     C           @ERR2     IFNE 'Y'                        B1
     C*
     C                     MOVE 'Y'       @ERR2   1        *1
     C                     MOVE '1'       *INU7            *1
     C                     MOVE '1'       *INU8            *1
     C                     MOVE 'E'       @TERM            *1
     C*
     C**  Set up fields in local data area.
     C                     MOVEL@FILE     DBFILE           *1
     C                     MOVEL'MM0194'  DBPGM            *1
     C                     MOVEL'992'     DBASE            *1
      *  Flag Stream in error, send Message                         E14042
     C           *LOCK     IN   @STATS                     *1       E14042
     C                     MOVE @SUBMN    @SUBM1  10       *1       E14042
     C                     SUB  1         @SUBM1           *1       E14042
     C                     MOVE @SUBM1    @SUBMN           *1       E14042
     C                     MOVE 'X'       @STRM2                    E14042
     C*********************CALL 'QCAEXEC'                  *1       E14042E20774
     C                     CALL 'QCMDEXC'                  *1             E20774
     C                     PARM           @CM,1            *1       E14042
     C                     PARM 80        @QCALN 155       *1       E14042
     C                     OUT  @STATS                              E14042
      *                                                             E14042
     C                     DUMP                            *1
     C*
     C                     END                             E1
     C*
     C**  Terminate processing immediately.
     C                     MOVE '1'       *INLR
     C*
     C                     RETRN
     C*
     C           INFSR9    ENDSR                           **INFSR9**
     C*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C* *PSSR    - Unmonitored program error                          *
     C*                                                               *
     C* CALLS             -                                           *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED  @ERR1  - Error routine performed indicator         *
     C*            @TERM  - Termination parameter                     *
     C*                                                               *
     C*****************************************************************
     C           *PSSR     BEGSR
     C*
     C**  Set @ERR1 to 'Y' to prevent looping if further errors occur.
     C           @ERR1     IFNE 'Y'                        B1
     C*
     C                     MOVE 'Y'       @ERR1   1        *1
     C                     MOVE '1'       *INU6            *1
     C                     MOVE 'E'       @TERM            *1
     C*
     C**  Set up fields in local data area.
     C                     MOVEL'MM0194'  DBPGM            *1
     C*****                MOVEL'991'     DBASE            *1             S01194
      *  Flag Stream in error, send Message                         E14042
     C           *LOCK     IN   @STATS                     *1       E14042
     C                     MOVE @SUBMN    @SUBM1  10       *1       E14042
     C                     SUB  1         @SUBM1           *1       E14042
     C                     MOVE @SUBM1    @SUBMN           *1       E14042
     C                     MOVE 'X'       @STRM2                    E14042
     C*********************CALL 'QCAEXEC'                  *1       E14042E20774
     C                     CALL 'QCMDEXC'                  *1             E20774
     C                     PARM           @CM,1            *1       E14042
     C                     PARM 80        @QCALN 155       *1       E14042
     C                     OUT  @STATS                              E14042
      *                                                             E14042
     C                     DUMP                            *1
     C*
     C                     END                             E1
     C*
     C**  Terminate processing immediately.
     C                     MOVE '1'       *INLR
     C*
     C                     RETRN
     C*
     C           #PSSR9    ENDSR                            ***PSSR9**
     C*
     C/EJECT
      *****************************************************************   056095
      *   The array @YD and @MD are now being used by SR. ZDATE9      *   056095
      *   before they are being used by SR. ZA0710.  The actual       *   056095
      *   changes were only made on the text, ZA0710 was changed      *   056095
      *   to ZDATE9.                                                  *   056095
      *****************************************************************   056095
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
**       @CM      Messages when error                                 E14042
SNDMSG  ('MM0194 has ended abnormally in batch.') TOMSGQ(MOPERQ)
** CPY@   **      OBJECT COPYRIGHT
(c) Finastra International Limited 2001
