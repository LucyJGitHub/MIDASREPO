000100220214/*********************************************************************/
000200220214/*STD    CLPBASEBND                                                  */
000300220214/*EXI *  TEXT('Midas MS Midas/SWIFT Meridian communication')         */
000400220214/*********************************************************************/
000500220214/*                                                                   */
000600220214/*       Midas - Midas SWIFT                                         */
000700220214/*                                                                   */
000800220214/*       MSC200221B - Midas/SWIFT MX Meridian communications         */
000900220214/*                                                                   */
001000220214/*       (c) Finastra International Limited 2021                     */
001100220214/*                                                                   */
001200220214/*       Last Amend No. CSW122  *CREATE    Date 04Oct21              */
001300220214/*                                                                   */
001400220214/*-------------------------------------------------------------------*/
001500220214/*                                                                   */
001600220214/*       CSW122 - SWIFT ISO 20022 Changes                            */
001700220214/*                                                                   */
001800220214/*********************************************************************/
001900220214
002000220214             PGM        PARM(&MCID &IO &ACCP &EOD)
002100220214
002200220214             DCL        VAR(&IO)   TYPE(*CHAR) LEN(1)
002300220214             DCL        VAR(&MCID) TYPE(*CHAR) LEN(26)
002400220214             DCL        VAR(&ACCP) TYPE(*CHAR) LEN(10)
002500220214             DCL        VAR(&EOD)  TYPE(*CHAR) LEN(4)
002600220214
002700220214             DCL        VAR(&PREFIX) TYPE(*CHAR) LEN(2)
002800220214             DCL        VAR(&XLIB)   TYPE(*CHAR) LEN(10)
002900220214             DCL        VAR(&DPLIB) TYPE(*CHAR) LEN(10)
003000220214             DCL        VAR(&DTANAM) TYPE(*CHAR) LEN(10)
003100220214             DCL        VAR(&DTQM) TYPE(*CHAR) LEN(10)
003200220214             DCL        VAR(&DTQC) TYPE(*CHAR) LEN(10)
003300220214             DCL        VAR(&CNUM) TYPE(*CHAR) LEN(6)
003400220214
003500220214             DCL        VAR(&JOBTYPE) TYPE(*CHAR) LEN(1)
003600220214             DCL        VAR(&MEM) TYPE(*CHAR) LEN(50)
003700220214
003800220214             DCL        VAR(&REPLY) TYPE(*CHAR) LEN(1)
003900220214
004000220214             DCL        VAR(&CMTRTN) TYPE(*CHAR) LEN(10)
004100220214
004200220214             COPYRIGHT  TEXT('(c) Finastra International Limited 2021')
004300220214
004400220214/** Global monitor message */
004500220214
004600220214             MONMSG     MSGID(CPF0000 MCH0000 RPG0000) EXEC(GOTO CMDLBL(ABNOR))
004700220214
004800220214/** Create LDA */
004900220214
005000220214             CRTDTAARA  DTAARA(QTEMP/LDA) TYPE(*CHAR) LEN(256)
005100220214             MONMSG     MSGID(CPF0000)
005200220214
005300220214/** Initialisation */
005400220214
005500220214             RTVJOBA    TYPE(&JOBTYPE)
005600220214             RTVJOBA    NBR(&CNUM) TYPE(&JOBTYPE)
005700220214             CHGDTAARA  DTAARA(LDA) VALUE(' ')
005800220214             CHGJOB     SWS(00000000)
005900220214
006000220214/** Create and lock data area to prove we are active */
006100220214
006200220214             RTVDTAARA  DTAARA(SDSTAT (6 2)) RTNVAR(&PREFIX)
006300220214             CHGVAR     VAR(&XLIB) VALUE(&PREFIX *CAT 'XLIB')
006400220214             CHGVAR     VAR(&DPLIB) VALUE(&PREFIX *CAT 'DPLIB') /*CPK015*/
006500220214             CHGVAR     VAR(&DTANAM) VALUE('MSMX' *CAT &CNUM)
006600220214             CRTDTAARA  DTAARA(&XLIB/&DTANAM) TYPE(*CHAR) LEN(1)
006700220214             ALCOBJ     OBJ((&XLIB/&DTANAM *DTAARA *EXCL))
006800220214
006900220214/** Start commitment control (unless run interactively) */
007000220214
007100220214             IF         COND(&JOBTYPE = '0') THEN(DO)
007200220214                CALL       PGM(SCCMTCTL) PARM('S' &CMTRTN) /*CPK016*/
007300220214             ENDDO
007400220214
007500220214/** Start compression server for outgoing (Tx) session */
007600220214
007700220214             IF         COND(&IO *EQ 'O') THEN(DO)
007800220214                CHGVAR     VAR(&DTQM) VALUE('MSQM' *CAT &CNUM)
007900220214                CHGVAR     VAR(&DTQC) VALUE('MSQC' *CAT &CNUM)
008000220214                CRTDTAQ    DTAQ(&DPLIB/&DTQM) MAXLEN(12050)
008100220214                CRTDTAQ    DTAQ(&DPLIB/&DTQC) MAXLEN(50)
008200220214             ENDDO
008300220214
008400220214             CHGJOB     LOGCLPGM(*NO)
008500220214
008600220214             CALL       PGM(MS20022B) PARM(&MCID &DTQM &DTQC &IO &EOD)
008700220214
008800220214/** Database error processing */
008900220214
009000220214             IF         COND(%SWITCH(XXXXXX11)) THEN(DO)
009100220214                RTVDTAARA  DTAARA(LDA (134 50)) RTNVAR(&MEM)
009200220214                ROLLBACK
009300220214                SNDPGMMSG  MSGID(MEM0001) MSGF(MIDAS) MSGDTA(&MEM) +
009400220214                             TOPGMQ(*EXT) TOMSGQ(MOPERQ)
009500220214                GOTO       CMDLBL(END)
009600220214             ENDDO
009700220214
009800220214/** Normal end */
009900220214
010000220214             GOTO       CMDLBL(END)
010100220214
010200220214/** Abnormal end */
010300220214
010400220214 ABNOR:
010500220214             CHGJOB     SWS(XXXXXX11)
010600220214             IF         COND(&JOBTYPE = '0') THEN(DO)
010700220214               SNDPGMMSG MSGID(CPF9898) MSGF(QCPFMSG) MSGDTA('Program +
010800220214                            MSC200221B ended abnormally - see job log') +
010900220214                            TOMSGQ(MOPERQ)
011000220214               MONMSG     MSGID(CPF0000 MCH0000)
011100220214             ENDDO
011200220214
011300220214/** Delete 'active' data area here --- just in case called */
011400220214/** interactively. */
011500220214
011600220214 END:        DLTDTAARA  DTAARA(&DTANAM)
011700220214             MONMSG     MSGID(CPF0000)
011800220214
011900220214                ENDPGM
